{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU5MzMxMjg3", "number": 2645, "title": "Add FilePropertiesStack helper class", "bodyText": "This keeps track of the various cascading properties of file\nlayers at different levels. Allows pushing and popping, but its\ntrue value is calculating and providing the various file permissions\nand properties to whatever bit of code is populating a layer.", "createdAt": "2020-07-30T15:51:46Z", "url": "https://github.com/GoogleContainerTools/jib/pull/2645", "merged": true, "mergeCommit": {"oid": "6b6e622f768d433984d75599f552eade4877d376"}, "closed": true, "closedAt": "2020-08-06T17:04:11Z", "author": {"login": "loosebazooka"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5Zs7eAH2gAyNDU5MzMxMjg3OmM4OWU3NmZiOTAzNTdhMGQyZWQ5ZDM5ZDc5NTY4NGQ4ODA5NWJmZTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7uPhWAFqTQ2MTIxNjA3Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c89e76fb90357a0d2ed9d39d795684d88095bfe3", "author": {"user": {"login": "loosebazooka", "name": "Appu"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/c89e76fb90357a0d2ed9d39d795684d88095bfe3", "committedDate": "2020-07-28T17:16:28Z", "message": "Add FilePropertiesStack helper class\n\nThis keeps track of the various cascading properties of file\nlayers at different levels. Allows pushing and popping, but its\ntrue value is calculating and providing the various file permissions\nand properties to whatever bit of code is populating a layer."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NjI2NTE4", "url": "https://github.com/GoogleContainerTools/jib/pull/2645#pullrequestreview-458626518", "createdAt": "2020-07-30T17:50:23Z", "commit": {"oid": "c89e76fb90357a0d2ed9d39d795684d88095bfe3"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNzo1MDoyM1rOG5tmFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxOToyMTo1MFrOG5wm1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE2OTA0Nw==", "bodyText": "final", "url": "https://github.com/GoogleContainerTools/jib/pull/2645#discussion_r463169047", "createdAt": "2020-07-30T17:50:23Z", "author": {"login": "chanseokoh"}, "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/FilePropertiesStack.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.buildfile;\n+\n+import com.google.cloud.tools.jib.api.buildplan.FilePermissions;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.base.Preconditions;\n+import java.time.Instant;\n+import java.util.ArrayList;\n+import java.util.List;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * A class that keeps track of permissions for various stacking file permissions settings in {@link\n+ * LayerSpec}.\n+ */\n+@VisibleForTesting\n+class FilePropertiesStack {\n+\n+  // TODO perhaps use a fixed size list here\n+  private List<FilePropertiesSpec> stack = new ArrayList<>(3);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c89e76fb90357a0d2ed9d39d795684d88095bfe3"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIxMTYyOQ==", "bodyText": "How about permissions = properties.getFilePermissions.orElse(permissions)? Or, how about just declaring the field as Optional and assign them directly? (The getter return types can remain @Nullable though.)", "url": "https://github.com/GoogleContainerTools/jib/pull/2645#discussion_r463211629", "createdAt": "2020-07-30T19:08:42Z", "author": {"login": "chanseokoh"}, "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/FilePropertiesStack.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.buildfile;\n+\n+import com.google.cloud.tools.jib.api.buildplan.FilePermissions;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.base.Preconditions;\n+import java.time.Instant;\n+import java.util.ArrayList;\n+import java.util.List;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * A class that keeps track of permissions for various stacking file permissions settings in {@link\n+ * LayerSpec}.\n+ */\n+@VisibleForTesting\n+class FilePropertiesStack {\n+\n+  // TODO perhaps use a fixed size list here\n+  private List<FilePropertiesSpec> stack = new ArrayList<>(3);\n+\n+  @Nullable private FilePermissions filePermissions;\n+  @Nullable private FilePermissions directoryPermissions;\n+  @Nullable private Instant modificationTime;\n+  @Nullable private String ownership;\n+\n+  // intermediate values\n+  @Nullable private String user;\n+  @Nullable private String group;\n+\n+  /**\n+   * Add a new layer to the file properties stack. When adding a new layer, it is given highest\n+   * priority when resolving properties. All values are recalculated.\n+   */\n+  public void push(FilePropertiesSpec filePropertiesSpec) {\n+    Preconditions.checkState(\n+        stack.size() < 3, \"Error in file properties stack push, stacking over 3\");\n+    stack.add(filePropertiesSpec);\n+    updateProperties();\n+  }\n+\n+  /** Remove the last layer from the stack. All values are recalculated. */\n+  public void pop() {\n+    Preconditions.checkState(stack.size() > 0, \"Error in file properties stack pop, popping at 0\");\n+    stack.remove(stack.size() - 1);\n+    updateProperties();\n+  }\n+\n+  private void updateProperties() {\n+    // clear existing permissions before recalculating\n+    filePermissions = null;\n+    directoryPermissions = null;\n+    modificationTime = null;\n+    ownership = null;\n+    user = null;\n+    group = null;\n+\n+    // the item with the lowest index has the lowest priority\n+    for (FilePropertiesSpec properties : stack) {\n+      properties.getFilePermissions().ifPresent(permissions -> filePermissions = permissions);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c89e76fb90357a0d2ed9d39d795684d88095bfe3"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIxMjgzMw==", "bodyText": "I usually pay special attention to String or collections when combined with Optional, as they can be empty. Is it guaranteed that user is a non-empty string (if present)? Otherwise, it's possible that a lower stack has, say, \"1234\" and a higher \"\" (empty string), resulting in clearing \"1234\".", "url": "https://github.com/GoogleContainerTools/jib/pull/2645#discussion_r463212833", "createdAt": "2020-07-30T19:11:01Z", "author": {"login": "chanseokoh"}, "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/FilePropertiesStack.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.buildfile;\n+\n+import com.google.cloud.tools.jib.api.buildplan.FilePermissions;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.base.Preconditions;\n+import java.time.Instant;\n+import java.util.ArrayList;\n+import java.util.List;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * A class that keeps track of permissions for various stacking file permissions settings in {@link\n+ * LayerSpec}.\n+ */\n+@VisibleForTesting\n+class FilePropertiesStack {\n+\n+  // TODO perhaps use a fixed size list here\n+  private List<FilePropertiesSpec> stack = new ArrayList<>(3);\n+\n+  @Nullable private FilePermissions filePermissions;\n+  @Nullable private FilePermissions directoryPermissions;\n+  @Nullable private Instant modificationTime;\n+  @Nullable private String ownership;\n+\n+  // intermediate values\n+  @Nullable private String user;\n+  @Nullable private String group;\n+\n+  /**\n+   * Add a new layer to the file properties stack. When adding a new layer, it is given highest\n+   * priority when resolving properties. All values are recalculated.\n+   */\n+  public void push(FilePropertiesSpec filePropertiesSpec) {\n+    Preconditions.checkState(\n+        stack.size() < 3, \"Error in file properties stack push, stacking over 3\");\n+    stack.add(filePropertiesSpec);\n+    updateProperties();\n+  }\n+\n+  /** Remove the last layer from the stack. All values are recalculated. */\n+  public void pop() {\n+    Preconditions.checkState(stack.size() > 0, \"Error in file properties stack pop, popping at 0\");\n+    stack.remove(stack.size() - 1);\n+    updateProperties();\n+  }\n+\n+  private void updateProperties() {\n+    // clear existing permissions before recalculating\n+    filePermissions = null;\n+    directoryPermissions = null;\n+    modificationTime = null;\n+    ownership = null;\n+    user = null;\n+    group = null;\n+\n+    // the item with the lowest index has the lowest priority\n+    for (FilePropertiesSpec properties : stack) {\n+      properties.getFilePermissions().ifPresent(permissions -> filePermissions = permissions);\n+      properties\n+          .getDirectoryPermissions()\n+          .ifPresent(permissions -> directoryPermissions = permissions);\n+      properties.getTimestamp().ifPresent(timestamp -> modificationTime = timestamp);\n+      properties.getUser().ifPresent(user -> this.user = user);\n+      properties.getGroup().ifPresent(group -> this.group = group);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c89e76fb90357a0d2ed9d39d795684d88095bfe3"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIxNjA3Mg==", "bodyText": "So if a lower stack had user=1234 but a higher stack group=5678, it will lose 1234. Probably this is what we intend, but I just wanted to confirm. Maybe good to have a test to formalize the intention.", "url": "https://github.com/GoogleContainerTools/jib/pull/2645#discussion_r463216072", "createdAt": "2020-07-30T19:17:15Z", "author": {"login": "chanseokoh"}, "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/FilePropertiesStack.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.buildfile;\n+\n+import com.google.cloud.tools.jib.api.buildplan.FilePermissions;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.base.Preconditions;\n+import java.time.Instant;\n+import java.util.ArrayList;\n+import java.util.List;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * A class that keeps track of permissions for various stacking file permissions settings in {@link\n+ * LayerSpec}.\n+ */\n+@VisibleForTesting\n+class FilePropertiesStack {\n+\n+  // TODO perhaps use a fixed size list here\n+  private List<FilePropertiesSpec> stack = new ArrayList<>(3);\n+\n+  @Nullable private FilePermissions filePermissions;\n+  @Nullable private FilePermissions directoryPermissions;\n+  @Nullable private Instant modificationTime;\n+  @Nullable private String ownership;\n+\n+  // intermediate values\n+  @Nullable private String user;\n+  @Nullable private String group;\n+\n+  /**\n+   * Add a new layer to the file properties stack. When adding a new layer, it is given highest\n+   * priority when resolving properties. All values are recalculated.\n+   */\n+  public void push(FilePropertiesSpec filePropertiesSpec) {\n+    Preconditions.checkState(\n+        stack.size() < 3, \"Error in file properties stack push, stacking over 3\");\n+    stack.add(filePropertiesSpec);\n+    updateProperties();\n+  }\n+\n+  /** Remove the last layer from the stack. All values are recalculated. */\n+  public void pop() {\n+    Preconditions.checkState(stack.size() > 0, \"Error in file properties stack pop, popping at 0\");\n+    stack.remove(stack.size() - 1);\n+    updateProperties();\n+  }\n+\n+  private void updateProperties() {\n+    // clear existing permissions before recalculating\n+    filePermissions = null;\n+    directoryPermissions = null;\n+    modificationTime = null;\n+    ownership = null;\n+    user = null;\n+    group = null;\n+\n+    // the item with the lowest index has the lowest priority\n+    for (FilePropertiesSpec properties : stack) {\n+      properties.getFilePermissions().ifPresent(permissions -> filePermissions = permissions);\n+      properties\n+          .getDirectoryPermissions()\n+          .ifPresent(permissions -> directoryPermissions = permissions);\n+      properties.getTimestamp().ifPresent(timestamp -> modificationTime = timestamp);\n+      properties.getUser().ifPresent(user -> this.user = user);\n+      properties.getGroup().ifPresent(group -> this.group = group);\n+    }\n+    // ownership calculations\n+    if (group == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c89e76fb90357a0d2ed9d39d795684d88095bfe3"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIxNjY4Nw==", "bodyText": "To me, the following is more readable in this case.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                } else {\n          \n          \n            \n                  if (user == null) {\n          \n          \n            \n                    ownership = \":\" + group;\n          \n          \n            \n                  } else {\n          \n          \n            \n                    ownership = user + \":\" + group;\n          \n          \n            \n                  }\n          \n          \n            \n                }\n          \n          \n            \n                } else if (user == null) {\n          \n          \n            \n                  ownership = \":\" + group;\n          \n          \n            \n                } else {\n          \n          \n            \n                  ownership = user + \":\" + group;\n          \n          \n            \n                }", "url": "https://github.com/GoogleContainerTools/jib/pull/2645#discussion_r463216687", "createdAt": "2020-07-30T19:18:34Z", "author": {"login": "chanseokoh"}, "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/FilePropertiesStack.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.buildfile;\n+\n+import com.google.cloud.tools.jib.api.buildplan.FilePermissions;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.base.Preconditions;\n+import java.time.Instant;\n+import java.util.ArrayList;\n+import java.util.List;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * A class that keeps track of permissions for various stacking file permissions settings in {@link\n+ * LayerSpec}.\n+ */\n+@VisibleForTesting\n+class FilePropertiesStack {\n+\n+  // TODO perhaps use a fixed size list here\n+  private List<FilePropertiesSpec> stack = new ArrayList<>(3);\n+\n+  @Nullable private FilePermissions filePermissions;\n+  @Nullable private FilePermissions directoryPermissions;\n+  @Nullable private Instant modificationTime;\n+  @Nullable private String ownership;\n+\n+  // intermediate values\n+  @Nullable private String user;\n+  @Nullable private String group;\n+\n+  /**\n+   * Add a new layer to the file properties stack. When adding a new layer, it is given highest\n+   * priority when resolving properties. All values are recalculated.\n+   */\n+  public void push(FilePropertiesSpec filePropertiesSpec) {\n+    Preconditions.checkState(\n+        stack.size() < 3, \"Error in file properties stack push, stacking over 3\");\n+    stack.add(filePropertiesSpec);\n+    updateProperties();\n+  }\n+\n+  /** Remove the last layer from the stack. All values are recalculated. */\n+  public void pop() {\n+    Preconditions.checkState(stack.size() > 0, \"Error in file properties stack pop, popping at 0\");\n+    stack.remove(stack.size() - 1);\n+    updateProperties();\n+  }\n+\n+  private void updateProperties() {\n+    // clear existing permissions before recalculating\n+    filePermissions = null;\n+    directoryPermissions = null;\n+    modificationTime = null;\n+    ownership = null;\n+    user = null;\n+    group = null;\n+\n+    // the item with the lowest index has the lowest priority\n+    for (FilePropertiesSpec properties : stack) {\n+      properties.getFilePermissions().ifPresent(permissions -> filePermissions = permissions);\n+      properties\n+          .getDirectoryPermissions()\n+          .ifPresent(permissions -> directoryPermissions = permissions);\n+      properties.getTimestamp().ifPresent(timestamp -> modificationTime = timestamp);\n+      properties.getUser().ifPresent(user -> this.user = user);\n+      properties.getGroup().ifPresent(group -> this.group = group);\n+    }\n+    // ownership calculations\n+    if (group == null) {\n+      ownership = user;\n+    } else {\n+      if (user == null) {\n+        ownership = \":\" + group;\n+      } else {\n+        ownership = user + \":\" + group;\n+      }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c89e76fb90357a0d2ed9d39d795684d88095bfe3"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIxODM5MQ==", "bodyText": "These don't seem necessary. In updateProperties(), you always start with null. These can be local to the method.", "url": "https://github.com/GoogleContainerTools/jib/pull/2645#discussion_r463218391", "createdAt": "2020-07-30T19:21:50Z", "author": {"login": "chanseokoh"}, "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/FilePropertiesStack.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.buildfile;\n+\n+import com.google.cloud.tools.jib.api.buildplan.FilePermissions;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.base.Preconditions;\n+import java.time.Instant;\n+import java.util.ArrayList;\n+import java.util.List;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * A class that keeps track of permissions for various stacking file permissions settings in {@link\n+ * LayerSpec}.\n+ */\n+@VisibleForTesting\n+class FilePropertiesStack {\n+\n+  // TODO perhaps use a fixed size list here\n+  private List<FilePropertiesSpec> stack = new ArrayList<>(3);\n+\n+  @Nullable private FilePermissions filePermissions;\n+  @Nullable private FilePermissions directoryPermissions;\n+  @Nullable private Instant modificationTime;\n+  @Nullable private String ownership;\n+\n+  // intermediate values\n+  @Nullable private String user;\n+  @Nullable private String group;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c89e76fb90357a0d2ed9d39d795684d88095bfe3"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cc3e318b65c28bad75ce6b4d8e3ab22025cc537", "author": {"user": {"login": "loosebazooka", "name": "Appu"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/4cc3e318b65c28bad75ce6b4d8e3ab22025cc537", "committedDate": "2020-07-30T22:04:56Z", "message": "review fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba8c3f154800f1c4af0e6e663d8f3cf4ac38a1cd", "author": {"user": {"login": "loosebazooka", "name": "Appu"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/ba8c3f154800f1c4af0e6e663d8f3cf4ac38a1cd", "committedDate": "2020-07-30T22:06:46Z", "message": "oops, file from another branch"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4ODA5OTUx", "url": "https://github.com/GoogleContainerTools/jib/pull/2645#pullrequestreview-458809951", "createdAt": "2020-07-30T22:35:29Z", "commit": {"oid": "ba8c3f154800f1c4af0e6e663d8f3cf4ac38a1cd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjozNToyOVrOG52LCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjozNToyOVrOG52LCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMwOTU3OQ==", "bodyText": "Ah, I misunderstood. Yeah, the calculation is outside the loop.\nJust so you know, jib-core will probably accept : (a single colon) as an ownership string, but I think it makes sense to return null as done here when both user and group are null.", "url": "https://github.com/GoogleContainerTools/jib/pull/2645#discussion_r463309579", "createdAt": "2020-07-30T22:35:29Z", "author": {"login": "chanseokoh"}, "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/FilePropertiesStack.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.buildfile;\n+\n+import com.google.cloud.tools.jib.api.buildplan.FilePermissions;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.base.Preconditions;\n+import java.time.Instant;\n+import java.util.ArrayList;\n+import java.util.List;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * A class that keeps track of permissions for various stacking file permissions settings in {@link\n+ * LayerSpec}.\n+ */\n+@VisibleForTesting\n+class FilePropertiesStack {\n+\n+  // TODO perhaps use a fixed size list here\n+  private List<FilePropertiesSpec> stack = new ArrayList<>(3);\n+\n+  @Nullable private FilePermissions filePermissions;\n+  @Nullable private FilePermissions directoryPermissions;\n+  @Nullable private Instant modificationTime;\n+  @Nullable private String ownership;\n+\n+  // intermediate values\n+  @Nullable private String user;\n+  @Nullable private String group;\n+\n+  /**\n+   * Add a new layer to the file properties stack. When adding a new layer, it is given highest\n+   * priority when resolving properties. All values are recalculated.\n+   */\n+  public void push(FilePropertiesSpec filePropertiesSpec) {\n+    Preconditions.checkState(\n+        stack.size() < 3, \"Error in file properties stack push, stacking over 3\");\n+    stack.add(filePropertiesSpec);\n+    updateProperties();\n+  }\n+\n+  /** Remove the last layer from the stack. All values are recalculated. */\n+  public void pop() {\n+    Preconditions.checkState(stack.size() > 0, \"Error in file properties stack pop, popping at 0\");\n+    stack.remove(stack.size() - 1);\n+    updateProperties();\n+  }\n+\n+  private void updateProperties() {\n+    // clear existing permissions before recalculating\n+    filePermissions = null;\n+    directoryPermissions = null;\n+    modificationTime = null;\n+    ownership = null;\n+    user = null;\n+    group = null;\n+\n+    // the item with the lowest index has the lowest priority\n+    for (FilePropertiesSpec properties : stack) {\n+      properties.getFilePermissions().ifPresent(permissions -> filePermissions = permissions);\n+      properties\n+          .getDirectoryPermissions()\n+          .ifPresent(permissions -> directoryPermissions = permissions);\n+      properties.getTimestamp().ifPresent(timestamp -> modificationTime = timestamp);\n+      properties.getUser().ifPresent(user -> this.user = user);\n+      properties.getGroup().ifPresent(group -> this.group = group);\n+    }\n+    // ownership calculations\n+    if (group == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIxNjA3Mg=="}, "originalCommit": {"oid": "c89e76fb90357a0d2ed9d39d795684d88095bfe3"}, "originalPosition": 84}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMjE2MDc2", "url": "https://github.com/GoogleContainerTools/jib/pull/2645#pullrequestreview-461216076", "createdAt": "2020-08-04T22:19:54Z", "commit": {"oid": "ba8c3f154800f1c4af0e6e663d8f3cf4ac38a1cd"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMjoxOTo1NFrOG7zeRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMjoxOTo1NFrOG7zeRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM2MjUwMg==", "bodyText": "super nit: could be useful to add inline comments for these parameters? like /*filePermissions=*/ etc.", "url": "https://github.com/GoogleContainerTools/jib/pull/2645#discussion_r465362502", "createdAt": "2020-08-04T22:19:54Z", "author": {"login": "mpeddada1"}, "path": "jib-cli/src/test/java/com/google/cloud/tools/jib/cli/buildfile/FilePropertiesStackTest.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.buildfile;\n+\n+import com.google.cloud.tools.jib.api.buildplan.FilePermissions;\n+import java.time.Instant;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+public class FilePropertiesStackTest {\n+\n+  @Test\n+  public void testPush_simple() {\n+    FilePropertiesStack testStack = new FilePropertiesStack();\n+\n+    testStack.push(new FilePropertiesSpec(\"111\", \"111\", \"1\", \"1\", \"1\"));\n+\n+    Assert.assertEquals(FilePermissions.fromOctalString(\"111\"), testStack.getFilePermissions());\n+    Assert.assertEquals(\n+        FilePermissions.fromOctalString(\"111\"), testStack.getDirectoryPermissions());\n+    Assert.assertEquals(\"1:1\", testStack.getOwnership());\n+    Assert.assertEquals(Instant.ofEpochMilli(1), testStack.getModificationTime());\n+  }\n+\n+  @Test\n+  public void testPush_stacking() {\n+    FilePropertiesStack testStack = new FilePropertiesStack();\n+\n+    testStack.push(new FilePropertiesSpec(\"111\", \"111\", \"1\", \"1\", \"1\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba8c3f154800f1c4af0e6e663d8f3cf4ac38a1cd"}, "originalPosition": 43}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4911, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}