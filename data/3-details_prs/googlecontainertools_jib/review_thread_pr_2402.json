{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzMjcxNDU5", "number": 2402, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNTo1NzoxMlrODxtnig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxOTo0MDo0MVrODxy3RA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzNDU0MjE4OnYy", "diffSide": "RIGHT", "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/DefaultCredentialRetrievers.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNTo1NzoxMlrOGFVm_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNTo1NzoxMlrOGFVm_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1MDExMA==", "bodyText": "should \".docker\" be a const?", "url": "https://github.com/GoogleContainerTools/jib/pull/2402#discussion_r408250110", "createdAt": "2020-04-14T15:57:12Z", "author": {"login": "loosebazooka"}, "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/DefaultCredentialRetrievers.java", "diffHunk": "@@ -166,10 +166,23 @@ public DefaultCredentialRetrievers setCredentialHelper(@Nullable String credenti\n       credentialRetrievers.add(inferredCredentialRetriever);\n     }\n \n+    String dockerConfigEnv = environment.get(\"DOCKER_CONFIG\");\n+    if (dockerConfigEnv != null) {\n+      Path dockerConfigsPath = Paths.get(dockerConfigEnv);\n+      credentialRetrievers.add(\n+          credentialRetrieverFactory.dockerConfig(dockerConfigsPath.resolve(DOCKER_CONFIG_FILE)));\n+      credentialRetrievers.add(\n+          credentialRetrieverFactory.dockerConfig(\n+              dockerConfigsPath.resolve(KUBERNETES_DOCKER_CONFIG_FILE)));\n+      credentialRetrievers.add(\n+          credentialRetrieverFactory.legacyDockerConfig(\n+              dockerConfigsPath.resolve(LEGACY_DOCKER_CONFIG_FILE)));\n+    }\n+\n     String homeProperty = systemProperties.getProperty(\"user.home\");\n     String homeEnvVar = environment.get(\"HOME\");\n     if (homeProperty != null) {\n-      Path home = Paths.get(homeProperty);\n+      Path home = Paths.get(homeProperty).resolve(\".docker\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89ef61fb56930af7d35be05c5ff114d5995672e7"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzNDU1NDE4OnYy", "diffSide": "RIGHT", "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/DefaultCredentialRetrievers.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNTo1OTo0OFrOGFVugg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNjowOToxNFrOGFWI9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1MjAzNA==", "bodyText": "can we share this code by determining the dockerConfigsPath once by analyzing:\n\ndockerConfigEvn\nhomeProperty\nhomeEnvVar\n\nand then run this block of code for the value of dockerConfigsPath?", "url": "https://github.com/GoogleContainerTools/jib/pull/2402#discussion_r408252034", "createdAt": "2020-04-14T15:59:48Z", "author": {"login": "loosebazooka"}, "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/DefaultCredentialRetrievers.java", "diffHunk": "@@ -166,10 +166,23 @@ public DefaultCredentialRetrievers setCredentialHelper(@Nullable String credenti\n       credentialRetrievers.add(inferredCredentialRetriever);\n     }\n \n+    String dockerConfigEnv = environment.get(\"DOCKER_CONFIG\");\n+    if (dockerConfigEnv != null) {\n+      Path dockerConfigsPath = Paths.get(dockerConfigEnv);\n+      credentialRetrievers.add(\n+          credentialRetrieverFactory.dockerConfig(dockerConfigsPath.resolve(DOCKER_CONFIG_FILE)));\n+      credentialRetrievers.add(\n+          credentialRetrieverFactory.dockerConfig(\n+              dockerConfigsPath.resolve(KUBERNETES_DOCKER_CONFIG_FILE)));\n+      credentialRetrievers.add(\n+          credentialRetrieverFactory.legacyDockerConfig(\n+              dockerConfigsPath.resolve(LEGACY_DOCKER_CONFIG_FILE)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89ef61fb56930af7d35be05c5ff114d5995672e7"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1NTY2Ng==", "bodyText": "I could pull some of this out into a helper method probably, but I think we do want to add all 9 paths to the credential retriever list, since we want to fall back to as many options as possible if retrieving the credentials fails on one source.", "url": "https://github.com/GoogleContainerTools/jib/pull/2402#discussion_r408255666", "createdAt": "2020-04-14T16:04:48Z", "author": {"login": "TadCordle"}, "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/DefaultCredentialRetrievers.java", "diffHunk": "@@ -166,10 +166,23 @@ public DefaultCredentialRetrievers setCredentialHelper(@Nullable String credenti\n       credentialRetrievers.add(inferredCredentialRetriever);\n     }\n \n+    String dockerConfigEnv = environment.get(\"DOCKER_CONFIG\");\n+    if (dockerConfigEnv != null) {\n+      Path dockerConfigsPath = Paths.get(dockerConfigEnv);\n+      credentialRetrievers.add(\n+          credentialRetrieverFactory.dockerConfig(dockerConfigsPath.resolve(DOCKER_CONFIG_FILE)));\n+      credentialRetrievers.add(\n+          credentialRetrieverFactory.dockerConfig(\n+              dockerConfigsPath.resolve(KUBERNETES_DOCKER_CONFIG_FILE)));\n+      credentialRetrievers.add(\n+          credentialRetrieverFactory.legacyDockerConfig(\n+              dockerConfigsPath.resolve(LEGACY_DOCKER_CONFIG_FILE)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1MjAzNA=="}, "originalCommit": {"oid": "89ef61fb56930af7d35be05c5ff114d5995672e7"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1ODgwNA==", "bodyText": "oh yeah you're right, I didn't realize we could add them all.", "url": "https://github.com/GoogleContainerTools/jib/pull/2402#discussion_r408258804", "createdAt": "2020-04-14T16:09:14Z", "author": {"login": "loosebazooka"}, "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/DefaultCredentialRetrievers.java", "diffHunk": "@@ -166,10 +166,23 @@ public DefaultCredentialRetrievers setCredentialHelper(@Nullable String credenti\n       credentialRetrievers.add(inferredCredentialRetriever);\n     }\n \n+    String dockerConfigEnv = environment.get(\"DOCKER_CONFIG\");\n+    if (dockerConfigEnv != null) {\n+      Path dockerConfigsPath = Paths.get(dockerConfigEnv);\n+      credentialRetrievers.add(\n+          credentialRetrieverFactory.dockerConfig(dockerConfigsPath.resolve(DOCKER_CONFIG_FILE)));\n+      credentialRetrievers.add(\n+          credentialRetrieverFactory.dockerConfig(\n+              dockerConfigsPath.resolve(KUBERNETES_DOCKER_CONFIG_FILE)));\n+      credentialRetrievers.add(\n+          credentialRetrieverFactory.legacyDockerConfig(\n+              dockerConfigsPath.resolve(LEGACY_DOCKER_CONFIG_FILE)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1MjAzNA=="}, "originalCommit": {"oid": "89ef61fb56930af7d35be05c5ff114d5995672e7"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzNDY1MjQ1OnYy", "diffSide": "RIGHT", "path": "jib-gradle-plugin/CHANGELOG.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNjoyMjozNFrOGFWsxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNjoyMjozNFrOGFWsxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI2Nzk3NQ==", "bodyText": "How about elaborate on this to message that DOCKER_CONFIG should be a directory containing a Docker config file?", "url": "https://github.com/GoogleContainerTools/jib/pull/2402#discussion_r408267975", "createdAt": "2020-04-14T16:22:34Z", "author": {"login": "chanseokoh"}, "path": "jib-gradle-plugin/CHANGELOG.md", "diffHunk": "@@ -7,6 +7,7 @@ All notable changes to this project will be documented in this file.\n \n - Glob pattern support for `jib.extraDirectories.permissions`. ([#1200](https://github.com/GoogleContainerTools/jib/issues/1200))\n - Support for image references with both a tag and a digest. ([#1481](https://github.com/GoogleContainerTools/jib/issues/1481))\n+- The `DOCKER_CONFIG` environment variable is now checked for retrieving credentials from the docker config. ([#1618](https://github.com/GoogleContainerTools/jib/issues/1618))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd2b5819efd4eaaff7ffca502d9a94fa78da6d5f"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzNDY5ODI3OnYy", "diffSide": "RIGHT", "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/DefaultCredentialRetrievers.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNjozMjo1NFrOGFXJWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNzoxMDoyNVrOGFYoBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI3NTI4OA==", "bodyText": "Do you think it's worth avoiding duplicates by checking if Paths.get(homeProperty).resolve(DOCKER_DIRECTORY) is same as Paths.get(dockerConfigEnv)? Or not? We've been comparing homeEnvVar and homeProperty. I just want some consistency for future readers of the code who might assume there is a reason for the inconsistency.", "url": "https://github.com/GoogleContainerTools/jib/pull/2402#discussion_r408275288", "createdAt": "2020-04-14T16:32:54Z", "author": {"login": "chanseokoh"}, "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/DefaultCredentialRetrievers.java", "diffHunk": "@@ -166,29 +166,33 @@ public DefaultCredentialRetrievers setCredentialHelper(@Nullable String credenti\n       credentialRetrievers.add(inferredCredentialRetriever);\n     }\n \n+    String dockerConfigEnv = environment.get(\"DOCKER_CONFIG\");\n+    if (dockerConfigEnv != null) {\n+      addDockerFiles(credentialRetrievers, Paths.get(dockerConfigEnv));\n+    }\n+\n     String homeProperty = systemProperties.getProperty(\"user.home\");\n-    String homeEnvVar = environment.get(\"HOME\");\n     if (homeProperty != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd2b5819efd4eaaff7ffca502d9a94fa78da6d5f"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI5OTUyNw==", "bodyText": "I think we can do it. It adds a little extra complexity but it's still straightforward enough.", "url": "https://github.com/GoogleContainerTools/jib/pull/2402#discussion_r408299527", "createdAt": "2020-04-14T17:10:25Z", "author": {"login": "TadCordle"}, "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/DefaultCredentialRetrievers.java", "diffHunk": "@@ -166,29 +166,33 @@ public DefaultCredentialRetrievers setCredentialHelper(@Nullable String credenti\n       credentialRetrievers.add(inferredCredentialRetriever);\n     }\n \n+    String dockerConfigEnv = environment.get(\"DOCKER_CONFIG\");\n+    if (dockerConfigEnv != null) {\n+      addDockerFiles(credentialRetrievers, Paths.get(dockerConfigEnv));\n+    }\n+\n     String homeProperty = systemProperties.getProperty(\"user.home\");\n-    String homeEnvVar = environment.get(\"HOME\");\n     if (homeProperty != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI3NTI4OA=="}, "originalCommit": {"oid": "cd2b5819efd4eaaff7ffca502d9a94fa78da6d5f"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzNTQwMTY0OnYy", "diffSide": "RIGHT", "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/DefaultCredentialRetrievers.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxOTo0MDo0MVrOGFeELg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxOTo0MDo0MVrOGFeELg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM4ODY1NA==", "bodyText": "With checkedDockerDirs, I think this can be just if (homeEnvVar) {?", "url": "https://github.com/GoogleContainerTools/jib/pull/2402#discussion_r408388654", "createdAt": "2020-04-14T19:40:41Z", "author": {"login": "chanseokoh"}, "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/DefaultCredentialRetrievers.java", "diffHunk": "@@ -166,29 +166,43 @@ public DefaultCredentialRetrievers setCredentialHelper(@Nullable String credenti\n       credentialRetrievers.add(inferredCredentialRetriever);\n     }\n \n+    List<Path> checkedDockerDirs = new ArrayList<>();\n+    String dockerConfigEnv = environment.get(\"DOCKER_CONFIG\");\n+    if (dockerConfigEnv != null) {\n+      Path dockerConfigEnvPath = Paths.get(dockerConfigEnv);\n+      addDockerFiles(credentialRetrievers, Paths.get(dockerConfigEnv));\n+      checkedDockerDirs.add(dockerConfigEnvPath);\n+    }\n+\n     String homeProperty = systemProperties.getProperty(\"user.home\");\n-    String homeEnvVar = environment.get(\"HOME\");\n     if (homeProperty != null) {\n-      Path home = Paths.get(homeProperty);\n-      credentialRetrievers.add(\n-          credentialRetrieverFactory.dockerConfig(home.resolve(DOCKER_CONFIG_FILE)));\n-      credentialRetrievers.add(\n-          credentialRetrieverFactory.dockerConfig(home.resolve(KUBERNETES_DOCKER_CONFIG_FILE)));\n-      credentialRetrievers.add(\n-          credentialRetrieverFactory.legacyDockerConfig(home.resolve(LEGACY_DOCKER_CONFIG_FILE)));\n+      Path homePropertyPath = Paths.get(homeProperty).resolve(DOCKER_DIRECTORY);\n+      if (!checkedDockerDirs.contains(homePropertyPath)) {\n+        addDockerFiles(credentialRetrievers, homePropertyPath);\n+        checkedDockerDirs.add(homePropertyPath);\n+      }\n     }\n+\n+    String homeEnvVar = environment.get(\"HOME\");\n     if (homeEnvVar != null && !homeEnvVar.equals(homeProperty)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7855ef3e0ac3cd958f6ee4a3d619ff28d23a4630"}, "originalPosition": 66}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 366, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}