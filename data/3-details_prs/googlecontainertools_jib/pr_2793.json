{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1NzQ0NDY5", "number": 2793, "title": "Check configured platforms for single image building", "bodyText": "Fixes #2746. Fixes #2745.\nWhen the base image is not a manifest list (including a local Docker and tar image), logs a warning in the follow cases.\n\nMultiple platforms are configured.\nThe configured platform doesn't match the actual platform, unless the \"configured\" platform is amd64/linux.\n\nAbout 2): Currently we cannot distinguish between explicitly configured amd64/linux and the implicit amd64/linux default when omitted, so unfortunately sometimes we need to suppress logging even if the platforms don't match.", "createdAt": "2020-09-30T19:42:36Z", "url": "https://github.com/GoogleContainerTools/jib/pull/2793", "merged": true, "mergeCommit": {"oid": "7d299599f7ff000f82987eede4c233d7d4a11e66"}, "closed": true, "closedAt": "2020-10-05T15:29:54Z", "author": {"login": "chanseokoh"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOB7c4gH2gAyNDk1NzQ0NDY5OmNlYjZlMjkwY2Q5NTQ2MzRlZTNiYTcyOTJjM2NlNjI0N2RmMmRlNTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPlcOcgFqTUwMjE2ODQ5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ceb6e290cd954634ee3ba7292c3ce6247df2de58", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/ceb6e290cd954634ee3ba7292c3ce6247df2de58", "committedDate": "2020-09-30T19:27:01Z", "message": "Check configured platforms for single image building"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d64ba0fecb4881363efd45237327664933702167", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/d64ba0fecb4881363efd45237327664933702167", "committedDate": "2020-09-30T19:41:46Z", "message": "Fix copyright header"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29196821dbc9b8ccc4ed4065195e9b9d2d99f190", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/29196821dbc9b8ccc4ed4065195e9b9d2d99f190", "committedDate": "2020-10-01T14:16:27Z", "message": "Check cached manifest too"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e89e511b917f4d0fd80c2b90c83e02ffc60cc056", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/e89e511b917f4d0fd80c2b90c83e02ffc60cc056", "committedDate": "2020-10-01T16:09:04Z", "message": "Log when using cached local image too"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNTEwNTYy", "url": "https://github.com/GoogleContainerTools/jib/pull/2793#pullrequestreview-500510562", "createdAt": "2020-10-01T16:14:45Z", "commit": {"oid": "e89e511b917f4d0fd80c2b90c83e02ffc60cc056"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNjoxNDo0NVrOHbRwTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNjoxNjozOVrOHbR1EA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM2NDQ5Mg==", "bodyText": "This is when a local docker:// base image is cached.", "url": "https://github.com/GoogleContainerTools/jib/pull/2793#discussion_r498364492", "createdAt": "2020-10-01T16:14:45Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/LocalBaseImageSteps.java", "diffHunk": "@@ -111,6 +111,8 @@ static boolean isGzipped(Path path) throws IOException {\n         Optional<LocalImage> cachedImage =\n             getCachedDockerImage(buildContext.getBaseImageLayersCache(), dockerImageDetails);\n         if (cachedImage.isPresent()) {\n+          PlatformChecker.checkManifestPlatform(\n+              buildContext, cachedImage.get().configurationTemplate);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e89e511b917f4d0fd80c2b90c83e02ffc60cc056"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM2NDgwNg==", "bodyText": "When using a local docker:// image that has not been cached.", "url": "https://github.com/GoogleContainerTools/jib/pull/2793#discussion_r498364806", "createdAt": "2020-10-01T16:15:15Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/LocalBaseImageSteps.java", "diffHunk": "@@ -125,11 +127,14 @@ static boolean isGzipped(Path path) throws IOException {\n           dockerClient.save(imageReference, tarPath, throttledProgressReporter);\n         }\n \n-        return cacheDockerImageTar(\n-            buildContext,\n-            tarPath,\n-            progressEventDispatcher.newChildProducer(),\n-            tempDirectoryProvider);\n+        LocalImage localImage =\n+            cacheDockerImageTar(\n+                buildContext,\n+                tarPath,\n+                progressEventDispatcher.newChildProducer(),\n+                tempDirectoryProvider);\n+        PlatformChecker.checkManifestPlatform(buildContext, localImage.configurationTemplate);\n+        return localImage;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e89e511b917f4d0fd80c2b90c83e02ffc60cc056"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM2NTIxOA==", "bodyText": "When tar:// (covers both cached and fresh cases).", "url": "https://github.com/GoogleContainerTools/jib/pull/2793#discussion_r498365218", "createdAt": "2020-10-01T16:15:51Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/LocalBaseImageSteps.java", "diffHunk": "@@ -139,9 +144,13 @@ static boolean isGzipped(Path path) throws IOException {\n       ProgressEventDispatcher.Factory progressEventDispatcherFactory,\n       Path tarPath,\n       TempDirectoryProvider tempDirectoryProvider) {\n-    return () ->\n-        cacheDockerImageTar(\n-            buildContext, tarPath, progressEventDispatcherFactory, tempDirectoryProvider);\n+    return () -> {\n+      LocalImage localImage =\n+          cacheDockerImageTar(\n+              buildContext, tarPath, progressEventDispatcherFactory, tempDirectoryProvider);\n+      PlatformChecker.checkManifestPlatform(buildContext, localImage.configurationTemplate);\n+      return localImage;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e89e511b917f4d0fd80c2b90c83e02ffc60cc056"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM2NTU3MQ==", "bodyText": "When pulling a remote manifest (not cached).", "url": "https://github.com/GoogleContainerTools/jib/pull/2793#discussion_r498365571", "createdAt": "2020-10-01T16:16:26Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStep.java", "diffHunk": "@@ -233,6 +233,7 @@ public ImagesAndRegistryClient call()\n       BuildableManifestTemplate imageManifest = (BuildableManifestTemplate) manifestTemplate;\n       ContainerConfigurationTemplate containerConfig =\n           pullContainerConfigJson(manifestAndDigest, registryClient, progressEventDispatcher);\n+      PlatformChecker.checkManifestPlatform(buildContext, containerConfig);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e89e511b917f4d0fd80c2b90c83e02ffc60cc056"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM2NTcxMg==", "bodyText": "When using a cached manifest for a remote base image.", "url": "https://github.com/GoogleContainerTools/jib/pull/2793#discussion_r498365712", "createdAt": "2020-10-01T16:16:39Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStep.java", "diffHunk": "@@ -379,10 +380,14 @@ private ContainerConfigurationTemplate pullContainerConfigJson(\n         return Collections.singletonList(\n             JsonToImageTranslator.toImage((V21ManifestTemplate) manifest));\n       }\n+\n+      ContainerConfigurationTemplate containerConfig =\n+          Verify.verifyNotNull(manifestsAndConfigs.get(0).getConfig());\n+      PlatformChecker.checkManifestPlatform(buildContext, containerConfig);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e89e511b917f4d0fd80c2b90c83e02ffc60cc056"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70a3897d3af47db4fae5e918522c74201a9f4b64", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/70a3897d3af47db4fae5e918522c74201a9f4b64", "committedDate": "2020-10-01T16:18:17Z", "message": "Fix style violation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ed7661cd1ced00f7792b0826e8590b01c01fe47", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/5ed7661cd1ced00f7792b0826e8590b01c01fe47", "committedDate": "2020-10-01T16:26:08Z", "message": "Fix path separater issue in tests on Windows"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNjI5MDAw", "url": "https://github.com/GoogleContainerTools/jib/pull/2793#pullrequestreview-500629000", "createdAt": "2020-10-01T18:52:20Z", "commit": {"oid": "5ed7661cd1ced00f7792b0826e8590b01c01fe47"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxODo1MjoyMFrOHbW_dg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxODo1MjoyMFrOHbW_dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ1MDI5NA==", "bodyText": "Just making sure I'm understanding this correctly, so this check needs to be included because we don't have a way to differentiate between implicitly or explicitly configured platforms?", "url": "https://github.com/GoogleContainerTools/jib/pull/2793#discussion_r498450294", "createdAt": "2020-10-01T18:52:20Z", "author": {"login": "mpeddada1"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/PlatformChecker.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.builder.steps;\n+\n+import com.google.cloud.tools.jib.api.LogEvent;\n+import com.google.cloud.tools.jib.api.buildplan.Platform;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.event.EventHandlers;\n+import com.google.cloud.tools.jib.image.json.ContainerConfigurationTemplate;\n+import com.google.common.base.Verify;\n+import java.util.Set;\n+\n+/** Provides helper methods to check platforms. */\n+public class PlatformChecker {\n+\n+  /**\n+   * Assuming the base image is not a manifest list, checks and warns misconfigured platforms.\n+   *\n+   * @param buildContext the {@link BuildContext}\n+   * @param containerConfig container configuration JSON of the base image\n+   */\n+  static void checkManifestPlatform(\n+      BuildContext buildContext, ContainerConfigurationTemplate containerConfig) {\n+    EventHandlers eventHandlers = buildContext.getEventHandlers();\n+    String baseImageName =\n+        buildContext.getBaseImageConfiguration().getTarPath().isPresent()\n+            ? buildContext.getBaseImageConfiguration().getTarPath().get().toString()\n+            : buildContext.getBaseImageConfiguration().getImage().toString();\n+\n+    Set<Platform> platforms = buildContext.getContainerConfiguration().getPlatforms();\n+    Verify.verify(!platforms.isEmpty());\n+\n+    if (platforms.size() != 1) {\n+      eventHandlers.dispatch(\n+          LogEvent.warn(\n+              \"platforms configured, but '\" + baseImageName + \"' is not a manifest list\"));\n+    } else {\n+      Platform platform = platforms.iterator().next();\n+      if (!platform.getArchitecture().equals(containerConfig.getArchitecture())\n+          || !platform.getOs().equals(containerConfig.getOs())) {\n+\n+        // Unfortunately, \"platforms\" has amd64/linux by default even if the user didn't explicitly\n+        // configure it. Skip reporting to suppress false alarm.\n+        if (!(platform.getArchitecture().equals(\"amd64\") && platform.getOs().equals(\"linux\"))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ed7661cd1ced00f7792b0826e8590b01c01fe47"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNjM2MzU5", "url": "https://github.com/GoogleContainerTools/jib/pull/2793#pullrequestreview-500636359", "createdAt": "2020-10-01T19:02:40Z", "commit": {"oid": "5ed7661cd1ced00f7792b0826e8590b01c01fe47"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxOTowMjo0MFrOHbXUKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxOTowMjo0MFrOHbXUKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ1NTU5NA==", "bodyText": "Is there a way to check that the base image is in fact not a manifest list in this method, before we proceed to doing the other checks?", "url": "https://github.com/GoogleContainerTools/jib/pull/2793#discussion_r498455594", "createdAt": "2020-10-01T19:02:40Z", "author": {"login": "mpeddada1"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/PlatformChecker.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.builder.steps;\n+\n+import com.google.cloud.tools.jib.api.LogEvent;\n+import com.google.cloud.tools.jib.api.buildplan.Platform;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.event.EventHandlers;\n+import com.google.cloud.tools.jib.image.json.ContainerConfigurationTemplate;\n+import com.google.common.base.Verify;\n+import java.util.Set;\n+\n+/** Provides helper methods to check platforms. */\n+public class PlatformChecker {\n+\n+  /**\n+   * Assuming the base image is not a manifest list, checks and warns misconfigured platforms.\n+   *\n+   * @param buildContext the {@link BuildContext}\n+   * @param containerConfig container configuration JSON of the base image\n+   */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ed7661cd1ced00f7792b0826e8590b01c01fe47"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNzE5ODI3", "url": "https://github.com/GoogleContainerTools/jib/pull/2793#pullrequestreview-500719827", "createdAt": "2020-10-01T21:08:49Z", "commit": {"oid": "5ed7661cd1ced00f7792b0826e8590b01c01fe47"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMTY4NDk3", "url": "https://github.com/GoogleContainerTools/jib/pull/2793#pullrequestreview-502168497", "createdAt": "2020-10-05T15:23:25Z", "commit": {"oid": "5ed7661cd1ced00f7792b0826e8590b01c01fe47"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4790, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}