{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc0MTU0MDgz", "number": 2730, "title": "Implement new manifest cache fully capable of multi-platform image building", "bodyText": "Follow-up to #2711 to complete the new cache design to support multi-platform image building.\n\nAdds UnlistedPlatformInManifestListException.\nNo platform verification of a cached manifest any more. getCachedBaseImages() returns cached images only when Jib has cached all the manifests matching the configured platforms.\nWhen caching a manifest list and manifests, PullBaseImageStep also stores additional information of manifest digests. This is to enable looking up a manifest from a manifest list by digest. For example,\n\n{\n  \"manifestList\": {  # manifest list content\n    \"manifests\": [\n      {  # manifest descriptor 1\n        \"digest\": \"sha256:a157906...\",\n        \"platform\": { ... },\n        ...\n      },\n      {\n        \"digest\": \"sha256:...\",\n        \"platform\": { ... },\n        ...\n      }\n    ]\n  },\n\n  \"manifestsAndConfigs\": [\n    {\n      \"manifestDigest\": \"sha256:a1579064....\",  <-- manifest digest for lookup\n      \"manifest\": { ... },\n      \"config\": { ... }\n    },\n    { ... },\n    ...\n  ]", "createdAt": "2020-08-26T21:08:40Z", "url": "https://github.com/GoogleContainerTools/jib/pull/2730", "merged": true, "mergeCommit": {"oid": "a4028d51cf022cb03852e3e4fe41465921f5a72a"}, "closed": true, "closedAt": "2020-08-31T20:11:33Z", "author": {"login": "chanseokoh"}, "timelineItems": {"totalCount": 46, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-k-NTgH2gAyNDc0MTU0MDgzOjRmOWMxYmM1MzZiZWU5M2EwZjBkMzAzOGNhNWI5ODFiNmQzODkyYzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdDcdZ2AFqTQ3ODA0OTcyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4f9c1bc536bee93a0f0d3038ca5b981b6d3892c2", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/4f9c1bc536bee93a0f0d3038ca5b981b6d3892c2", "committedDate": "2020-08-13T19:13:55Z", "message": "Implement new manifests_configs.json cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f480cf1829789d97493b0e05326c409ac0486440", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/f480cf1829789d97493b0e05326c409ac0486440", "committedDate": "2020-08-13T19:18:29Z", "message": "Merge branch 'master' into manifest-cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abeb080a2f9d0606a7ada30ae15d9a7e8b35d0de", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/abeb080a2f9d0606a7ada30ae15d9a7e8b35d0de", "committedDate": "2020-08-13T19:30:39Z", "message": "wip"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e643c543e1604983c46b480e399ef2652abff6f1", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/e643c543e1604983c46b480e399ef2652abff6f1", "committedDate": "2020-08-16T15:45:54Z", "message": "Implement new manfiest+container config cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1682e3b3bbba37351105ea41755f7e56a4d583f5", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/1682e3b3bbba37351105ea41755f7e56a4d583f5", "committedDate": "2020-08-17T13:07:45Z", "message": "Revert unnecessary code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "999125ef6906c4334612496b77f54e16f1f755bc", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/999125ef6906c4334612496b77f54e16f1f755bc", "committedDate": "2020-08-17T16:20:01Z", "message": "Revert filter(...) to original code to avoid false NullAway positives"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2166d2bf3b631b71dc2653a0aa93314eea3af668", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/2166d2bf3b631b71dc2653a0aa93314eea3af668", "committedDate": "2020-08-18T14:18:55Z", "message": "Convert to polymorphic JSON de-/serialization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "595bd1962921f5b59ea5ecf1049b12a6e5610860", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/595bd1962921f5b59ea5ecf1049b12a6e5610860", "committedDate": "2020-08-18T14:29:48Z", "message": "Add manifest+config cache JSON template"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e2c6bcf688b5df766f6535fd950a7655196a404", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/5e2c6bcf688b5df766f6535fd950a7655196a404", "committedDate": "2020-08-18T14:44:31Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a53417dd8f1fc9808d3b0edae23f2b09001582e0", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/a53417dd8f1fc9808d3b0edae23f2b09001582e0", "committedDate": "2020-08-18T17:36:54Z", "message": "Update code comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "126d30d0204d6544c7a58071884f77060cf139f0", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/126d30d0204d6544c7a58071884f77060cf139f0", "committedDate": "2020-08-18T21:55:05Z", "message": "Merge branch 'prepare-manifest-cache' into manifest-cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be8d91fadc60cb601c3d39d4b699de9d964ef0dd", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/be8d91fadc60cb601c3d39d4b699de9d964ef0dd", "committedDate": "2020-08-18T22:11:42Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6bada415e26d5dd179e7ce663c8575d909bdc5c", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/c6bada415e26d5dd179e7ce663c8575d909bdc5c", "committedDate": "2020-08-19T14:23:53Z", "message": "Fix wrong cache validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38e00c976b11780285428f5f8393998da6ff52df", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/38e00c976b11780285428f5f8393998da6ff52df", "committedDate": "2020-08-19T14:42:12Z", "message": "Simplify test code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca69545e40e2adb2cde5fa9cb701ae3b1eca7c51", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/ca69545e40e2adb2cde5fa9cb701ae3b1eca7c51", "committedDate": "2020-08-19T15:22:08Z", "message": "Add CacheStorageReader tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "badb776f62e45c82885e05055657b73bcb95c2bc", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/badb776f62e45c82885e05055657b73bcb95c2bc", "committedDate": "2020-08-19T15:40:55Z", "message": "Add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8ad480f29198f1b5d87a391c84f60192ed4bf26", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/c8ad480f29198f1b5d87a391c84f60192ed4bf26", "committedDate": "2020-08-19T15:42:16Z", "message": "Revert unintended debug code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e20a8367cc8da6e76bad540c994a77dd91e5dfe4", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/e20a8367cc8da6e76bad540c994a77dd91e5dfe4", "committedDate": "2020-08-19T16:21:05Z", "message": "Fix bug in writing metadata cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bfe4ef3c58d55393d688b6d2004b4aa77db1560", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/4bfe4ef3c58d55393d688b6d2004b4aa77db1560", "committedDate": "2020-08-19T16:25:28Z", "message": "Add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5cadf8c6bd0a25cc45bb929385faf13de8a67f36", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/5cadf8c6bd0a25cc45bb929385faf13de8a67f36", "committedDate": "2020-08-19T17:43:23Z", "message": "Add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bcd17f4be005730a6e5b1ba2d737595dee53b867", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/bcd17f4be005730a6e5b1ba2d737595dee53b867", "committedDate": "2020-08-19T18:21:17Z", "message": "Update comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfab7ce329f1dc31e152e30c7296b706828fb487", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/dfab7ce329f1dc31e152e30c7296b706828fb487", "committedDate": "2020-08-19T18:39:03Z", "message": "Update Javadocs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c52ebb8523d7cc071c718e2583085ae911ea1df0", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/c52ebb8523d7cc071c718e2583085ae911ea1df0", "committedDate": "2020-08-19T18:42:49Z", "message": "Rename variables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0a920374f3dac6c50302d1bc8ed477269df2ee2", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/f0a920374f3dac6c50302d1bc8ed477269df2ee2", "committedDate": "2020-08-20T14:49:08Z", "message": "Merge branch 'master' of https://github.com/GoogleContainerTools/jib into manifest-cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb0c901c4930a84230800ec17fe5735e6d1c34e8", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/bb0c901c4930a84230800ec17fe5735e6d1c34e8", "committedDate": "2020-08-21T19:39:12Z", "message": "Refactor code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c5c7a36d4a3df504e466d2e9701fe5c0d238193", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/1c5c7a36d4a3df504e466d2e9701fe5c0d238193", "committedDate": "2020-08-21T19:59:39Z", "message": "Refactor code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0908e25e6c0a384acf5d6d0917b576751b96f372", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/0908e25e6c0a384acf5d6d0917b576751b96f372", "committedDate": "2020-08-21T20:01:52Z", "message": "Merge branch 'manifest-cache' of https://github.com/GoogleContainerTools/jib into manifest-cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3a0c893335555a0aeb63c704e24bad4ae192476", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/b3a0c893335555a0aeb63c704e24bad4ae192476", "committedDate": "2020-08-24T14:11:03Z", "message": "Decrease log level (lifecycle -> info)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a57ce21b8b6a27899220d268c5caab0bddd01a5", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/8a57ce21b8b6a27899220d268c5caab0bddd01a5", "committedDate": "2020-08-24T16:12:27Z", "message": "New cache API / refactor code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "783c5bfa005522073574e9b1689dce944b086e9e", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/783c5bfa005522073574e9b1689dce944b086e9e", "committedDate": "2020-08-24T19:15:51Z", "message": "Add unlisted manfiest excception"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "064bb85e5f8a117bfe35c5529c7a7a32a6e81a0e", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/064bb85e5f8a117bfe35c5529c7a7a32a6e81a0e", "committedDate": "2020-08-24T19:35:13Z", "message": "Refactor code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1e6b9d3aaf7dff0d48d0013763789ad56c1c824", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/a1e6b9d3aaf7dff0d48d0013763789ad56c1c824", "committedDate": "2020-08-25T01:04:33Z", "message": "Merge branch 'master' into manifest-cache-multi-platform-part1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17282e14c0394346022da8281a6b384eedeb1934", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/17282e14c0394346022da8281a6b384eedeb1934", "committedDate": "2020-08-25T17:24:49Z", "message": "Add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d7ffb8f5d2417cf986818cebac5138bfc01aaf4", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/3d7ffb8f5d2417cf986818cebac5138bfc01aaf4", "committedDate": "2020-08-26T00:23:37Z", "message": "Merge branch 'master' into manifest-cache-multi-platform-part1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9d44b8ac17cbab6b9131e2df5a8090dbcb3b31c", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/a9d44b8ac17cbab6b9131e2df5a8090dbcb3b31c", "committedDate": "2020-08-26T21:10:58Z", "message": "Javadoc placeholder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1464c0e802d8c8772bc18303261314af816c730f", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/1464c0e802d8c8772bc18303261314af816c730f", "committedDate": "2020-08-26T21:18:56Z", "message": "Fix Javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27e620b1743f8acf355caf1627ef462b099ba042", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/27e620b1743f8acf355caf1627ef462b099ba042", "committedDate": "2020-08-26T22:27:00Z", "message": "Add and fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cb21d22d0e40dc8cd2ba1dc37d42e5f32aa4ec4", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/0cb21d22d0e40dc8cd2ba1dc37d42e5f32aa4ec4", "committedDate": "2020-08-26T22:29:41Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c01c470fcc2106783f163fb9ae23e5573e5ed96d", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/c01c470fcc2106783f163fb9ae23e5573e5ed96d", "committedDate": "2020-08-26T22:41:33Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfeefb24bce181f10ea94b21f143637830fe6163", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/cfeefb24bce181f10ea94b21f143637830fe6163", "committedDate": "2020-08-27T15:53:09Z", "message": "Clean up code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6426994e5e7a5c8a77b7aa6dd39e4f133c51fe16", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/6426994e5e7a5c8a77b7aa6dd39e4f133c51fe16", "committedDate": "2020-08-27T16:23:58Z", "message": "Update Javadoc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2ODE1NTc0", "url": "https://github.com/GoogleContainerTools/jib/pull/2730#pullrequestreview-476815574", "createdAt": "2020-08-27T15:06:08Z", "commit": {"oid": "c01c470fcc2106783f163fb9ae23e5573e5ed96d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxNTowNjowOFrOHIUujw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxNzowODoyM1rOHIZk5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQ5MDI1NQ==", "bodyText": "I thought we could still run into an issue where we don't have all the necessary platform information for an image/platform that wasn't previously referenced?\nI assume downloading all the image layers for all the images is impractical?", "url": "https://github.com/GoogleContainerTools/jib/pull/2730#discussion_r478490255", "createdAt": "2020-08-27T15:06:08Z", "author": {"login": "loosebazooka"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStep.java", "diffHunk": "@@ -105,28 +106,21 @@ public ImagesAndRegistryClient call()\n         LogEvent.progress(\"Getting manifest for base image \" + imageReference + \"...\"));\n \n     if (buildContext.isOffline()) {\n-      Optional<Image> image = getCachedBaseImage();\n-      if (image.isPresent()) {\n-        if (!checkImagePlatform(image.get())) {\n-          throw new IllegalStateException(\n-              \"The cached base image manifest does not match the configured platform due to the \"\n-                  + \"current implementation of limited platform support. As a workaround, re-run \"\n-                  + \"Jib online once to re-cache the right image manifest.\");\n-        }\n-        return new ImagesAndRegistryClient(Collections.singletonList(image.get()), null);\n+      List<Image> images = getCachedBaseImages();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c01c470fcc2106783f163fb9ae23e5573e5ed96d"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU2OTcwMQ==", "bodyText": "maybe \"the registry manifest\"?", "url": "https://github.com/GoogleContainerTools/jib/pull/2730#discussion_r478569701", "createdAt": "2020-08-27T17:08:23Z", "author": {"login": "loosebazooka"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/ManifestAndConfigTemplate.java", "diffHunk": "@@ -43,13 +43,36 @@\n   @SuppressWarnings(\"unused\")\n   private ManifestAndConfigTemplate() {}\n \n+  /**\n+   * Creates an instance.\n+   *\n+   * @param manifest the manifest", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6426994e5e7a5c8a77b7aa6dd39e4f133c51fe16"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e170f76f600c57753f3b19e7cca38c93fa89084a", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/e170f76f600c57753f3b19e7cca38c93fa89084a", "committedDate": "2020-08-27T19:01:03Z", "message": "Update Javadocs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3MDE2MzI3", "url": "https://github.com/GoogleContainerTools/jib/pull/2730#pullrequestreview-477016327", "createdAt": "2020-08-27T19:26:06Z", "commit": {"oid": "e170f76f600c57753f3b19e7cca38c93fa89084a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxOToyNjowNlrOHIeK6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxOTozMDozM1rOHIeT-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY0NDk3MQ==", "bodyText": "So this section is for when the base image reference is a single manifest?", "url": "https://github.com/GoogleContainerTools/jib/pull/2730#discussion_r478644971", "createdAt": "2020-08-27T19:26:06Z", "author": {"login": "mpeddada1"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStep.java", "diffHunk": "@@ -351,35 +330,67 @@ private ContainerConfigurationTemplate pullContainerConfigJson(\n   }\n \n   /**\n-   * Retrieves the cached base image.\n+   * Retrieves the cached base images. If a base image reference is not a manifest list, returns a\n+   * single image (if cached). If a manifest list, returns all the images matching the configured\n+   * platforms in the manifest list but only when all of the images are cached.\n    *\n-   * @return the cached image, if found\n+   * @return the cached images, if found\n    * @throws IOException when an I/O exception occurs\n    * @throws CacheCorruptedException if the cache is corrupted\n    * @throws LayerPropertyNotFoundException if adding image layers fails\n    * @throws BadContainerConfigurationFormatException if the container configuration is in a bad\n    *     format\n+   * @throws UnlistedPlatformInManifestListException if a cached manifest list has no manifests\n+   *     matching the configured platform\n    */\n-  private Optional<Image> getCachedBaseImage()\n+  @VisibleForTesting\n+  List<Image> getCachedBaseImages()\n       throws IOException, CacheCorruptedException, BadContainerConfigurationFormatException,\n-          LayerCountMismatchException {\n+          LayerCountMismatchException, UnlistedPlatformInManifestListException {\n     ImageReference baseImage = buildContext.getBaseImageConfiguration().getImage();\n     Optional<ImageMetadataTemplate> metadata =\n         buildContext.getBaseImageLayersCache().retrieveMetadata(baseImage);\n     if (!metadata.isPresent()) {\n-      return Optional.empty();\n+      return Collections.emptyList();\n     }\n \n+    ManifestTemplate manifestList = metadata.get().getManifestList();\n     List<ManifestAndConfigTemplate> manifestsAndConfigs = metadata.get().getManifestsAndConfigs();\n-    Verify.verify(manifestsAndConfigs.size() == 1);\n-    ManifestTemplate manifest = Verify.verifyNotNull(manifestsAndConfigs.get(0).getManifest());\n-    if (manifest instanceof V21ManifestTemplate) {\n-      return Optional.of(JsonToImageTranslator.toImage((V21ManifestTemplate) manifest));\n+\n+    if (manifestList == null) {\n+      Verify.verify(manifestsAndConfigs.size() == 1);\n+      ManifestTemplate manifest = manifestsAndConfigs.get(0).getManifest();\n+      if (manifest instanceof V21ManifestTemplate) {\n+        return Collections.singletonList(\n+            JsonToImageTranslator.toImage((V21ManifestTemplate) manifest));\n+      }\n+      return Collections.singletonList(\n+          JsonToImageTranslator.toImage(\n+              (BuildableManifestTemplate) Verify.verifyNotNull(manifest),\n+              Verify.verifyNotNull(manifestsAndConfigs.get(0).getConfig())));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e170f76f600c57753f3b19e7cca38c93fa89084a"}, "originalPosition": 174}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY0NzI5MQ==", "bodyText": "Why do we make sure to return the images matching the configured platforms in the manifest list only if all the images are cached?", "url": "https://github.com/GoogleContainerTools/jib/pull/2730#discussion_r478647291", "createdAt": "2020-08-27T19:30:33Z", "author": {"login": "mpeddada1"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStep.java", "diffHunk": "@@ -351,35 +330,67 @@ private ContainerConfigurationTemplate pullContainerConfigJson(\n   }\n \n   /**\n-   * Retrieves the cached base image.\n+   * Retrieves the cached base images. If a base image reference is not a manifest list, returns a\n+   * single image (if cached). If a manifest list, returns all the images matching the configured\n+   * platforms in the manifest list but only when all of the images are cached.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e170f76f600c57753f3b19e7cca38c93fa89084a"}, "originalPosition": 131}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3MDI1ODY5", "url": "https://github.com/GoogleContainerTools/jib/pull/2730#pullrequestreview-477025869", "createdAt": "2020-08-27T19:40:57Z", "commit": {"oid": "e170f76f600c57753f3b19e7cca38c93fa89084a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxOTo0MDo1N1rOHIeoew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxOTo0MDo1N1rOHIeoew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY1MjUzOQ==", "bodyText": "I may be missing something here but what's the reasoning behind checking if these values are null?/ When would they be null?", "url": "https://github.com/GoogleContainerTools/jib/pull/2730#discussion_r478652539", "createdAt": "2020-08-27T19:40:57Z", "author": {"login": "mpeddada1"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStep.java", "diffHunk": "@@ -351,35 +330,67 @@ private ContainerConfigurationTemplate pullContainerConfigJson(\n   }\n \n   /**\n-   * Retrieves the cached base image.\n+   * Retrieves the cached base images. If a base image reference is not a manifest list, returns a\n+   * single image (if cached). If a manifest list, returns all the images matching the configured\n+   * platforms in the manifest list but only when all of the images are cached.\n    *\n-   * @return the cached image, if found\n+   * @return the cached images, if found\n    * @throws IOException when an I/O exception occurs\n    * @throws CacheCorruptedException if the cache is corrupted\n    * @throws LayerPropertyNotFoundException if adding image layers fails\n    * @throws BadContainerConfigurationFormatException if the container configuration is in a bad\n    *     format\n+   * @throws UnlistedPlatformInManifestListException if a cached manifest list has no manifests\n+   *     matching the configured platform\n    */\n-  private Optional<Image> getCachedBaseImage()\n+  @VisibleForTesting\n+  List<Image> getCachedBaseImages()\n       throws IOException, CacheCorruptedException, BadContainerConfigurationFormatException,\n-          LayerCountMismatchException {\n+          LayerCountMismatchException, UnlistedPlatformInManifestListException {\n     ImageReference baseImage = buildContext.getBaseImageConfiguration().getImage();\n     Optional<ImageMetadataTemplate> metadata =\n         buildContext.getBaseImageLayersCache().retrieveMetadata(baseImage);\n     if (!metadata.isPresent()) {\n-      return Optional.empty();\n+      return Collections.emptyList();\n     }\n \n+    ManifestTemplate manifestList = metadata.get().getManifestList();\n     List<ManifestAndConfigTemplate> manifestsAndConfigs = metadata.get().getManifestsAndConfigs();\n-    Verify.verify(manifestsAndConfigs.size() == 1);\n-    ManifestTemplate manifest = Verify.verifyNotNull(manifestsAndConfigs.get(0).getManifest());\n-    if (manifest instanceof V21ManifestTemplate) {\n-      return Optional.of(JsonToImageTranslator.toImage((V21ManifestTemplate) manifest));\n+\n+    if (manifestList == null) {\n+      Verify.verify(manifestsAndConfigs.size() == 1);\n+      ManifestTemplate manifest = manifestsAndConfigs.get(0).getManifest();\n+      if (manifest instanceof V21ManifestTemplate) {\n+        return Collections.singletonList(\n+            JsonToImageTranslator.toImage((V21ManifestTemplate) manifest));\n+      }\n+      return Collections.singletonList(\n+          JsonToImageTranslator.toImage(\n+              (BuildableManifestTemplate) Verify.verifyNotNull(manifest),\n+              Verify.verifyNotNull(manifestsAndConfigs.get(0).getConfig())));\n     }\n \n-    return Optional.of(\n-        JsonToImageTranslator.toImage(\n-            (BuildableManifestTemplate) manifest,\n-            Verify.verifyNotNull(manifestsAndConfigs.get(0).getConfig())));\n+    // Manifest list cached. Identify matching platforms and check if all of them are cached.\n+    ImmutableList.Builder<Image> images = ImmutableList.builder();\n+    for (Platform platform : buildContext.getContainerConfiguration().getPlatforms()) {\n+      String manifestDigest =\n+          lookUpPlatformSpecificImageManifest((V22ManifestListTemplate) manifestList, platform);\n+\n+      Optional<ManifestAndConfigTemplate> manifestAndConfigFound =\n+          manifestsAndConfigs\n+              .stream()\n+              .filter(entry -> manifestDigest.equals(entry.getManifestDigest()))\n+              .findFirst();\n+      if (!manifestAndConfigFound.isPresent()) {\n+        return Collections.emptyList();\n+      }\n+\n+      ManifestTemplate manifest = Verify.verifyNotNull(manifestAndConfigFound.get().getManifest());\n+      ContainerConfigurationTemplate containerConfig =\n+          Verify.verifyNotNull(manifestAndConfigFound.get().getConfig());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e170f76f600c57753f3b19e7cca38c93fa89084a"}, "originalPosition": 198}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MDQ5NzI0", "url": "https://github.com/GoogleContainerTools/jib/pull/2730#pullrequestreview-478049724", "createdAt": "2020-08-28T22:08:28Z", "commit": {"oid": "e170f76f600c57753f3b19e7cca38c93fa89084a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4994, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}