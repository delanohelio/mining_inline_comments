{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4MDE1ODUz", "number": 2701, "title": "Adding functionality to create a manifest list from a list of built images", "bodyText": "This PR adds the ability to build a manifest list from a list of images\nThis PR also adds the additional testing required to ensure the functionality of the added features.", "createdAt": "2020-08-14T14:29:28Z", "url": "https://github.com/GoogleContainerTools/jib/pull/2701", "merged": true, "mergeCommit": {"oid": "900ed0122434b78c313616d0729d5b0e14dda022"}, "closed": true, "closedAt": "2020-08-19T18:01:04Z", "author": {"login": "louismurerwa"}, "timelineItems": {"totalCount": 37, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-PVOogH2gAyNDY4MDE1ODUzOjFlOTJhZDIzNjg3YjJjMzViYTcxYTY1ZTRlZDI5ZmQyMGM3MzEzM2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAfF-SgFqTQ3MDY5MDU5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1e92ad23687b2c35ba71a65e4ed29fd20c73133a", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/1e92ad23687b2c35ba71a65e4ed29fd20c73133a", "committedDate": "2020-08-12T18:01:09Z", "message": "Adding fnctionality to build a manifest list"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f43bebaf5bf3e107f2635c4b9bfa453fc8206e5", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/6f43bebaf5bf3e107f2635c4b9bfa453fc8206e5", "committedDate": "2020-08-12T19:28:46Z", "message": "Removing one platform restriction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c24f34496a8181ddd90985f15d4ef1f90d5b225", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/6c24f34496a8181ddd90985f15d4ef1f90d5b225", "committedDate": "2020-08-13T15:18:59Z", "message": "Progress Dispatcher has been fixed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfe28d970934e016de7177ab25ce6af4129b527d", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/dfe28d970934e016de7177ab25ce6af4129b527d", "committedDate": "2020-08-13T15:27:06Z", "message": "Fix child progress dispatcher factory (#2699)\n\n* Fixing concurrent progress dispatcher\r\n\r\n* Removing un-related changes\r\n\r\n* Add multiple progress dispatchers for concurrent build processes\r\n\r\n* Progress Dispatcher Fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1771c269ec62b894123bbe0a14833a84f95443a7", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/1771c269ec62b894123bbe0a14833a84f95443a7", "committedDate": "2020-08-13T19:29:37Z", "message": "Commit for debugging Java I/O error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55c7e640ac989644e5891804644eee8fd524beb9", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/55c7e640ac989644e5891804644eee8fd524beb9", "committedDate": "2020-08-13T23:17:47Z", "message": " manifest creation done"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "206da0192feed33d263b1090fea60b519047395b", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/206da0192feed33d263b1090fea60b519047395b", "committedDate": "2020-08-14T14:26:45Z", "message": "Style Fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cff0915ffb64493451daf466450c802861677187", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/cff0915ffb64493451daf466450c802861677187", "committedDate": "2020-08-14T14:37:42Z", "message": "Removing Pom.xml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca9d2653fee8ac7c6cfdfa3a1d757fcf53c3b44f", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/ca9d2653fee8ac7c6cfdfa3a1d757fcf53c3b44f", "committedDate": "2020-08-14T14:41:51Z", "message": "Merge remote-tracking branch 'origin' into createManifestList"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4a2edb918a899be3b6340969d02eff027efe262", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/b4a2edb918a899be3b6340969d02eff027efe262", "committedDate": "2020-08-14T15:00:54Z", "message": "Extending Jib to support multiple archs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36c3fe0636e3bd2348d3bf7ea62adf50b6abc8ad", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/36c3fe0636e3bd2348d3bf7ea62adf50b6abc8ad", "committedDate": "2020-08-14T15:29:50Z", "message": "Adding Javadoc Comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c381c7d62050ccc60f404ccfb2d14a2bc7a3e2b", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/6c381c7d62050ccc60f404ccfb2d14a2bc7a3e2b", "committedDate": "2020-08-14T16:11:21Z", "message": "Adding Javadocs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "776ab69e584661fd266050642b921a6962dccfa1", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/776ab69e584661fd266050642b921a6962dccfa1", "committedDate": "2020-08-14T17:03:22Z", "message": "Fix Styles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3713769ec829da396cde013398252c46e95ea7c6", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/3713769ec829da396cde013398252c46e95ea7c6", "committedDate": "2020-08-14T17:11:11Z", "message": "Style Fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17b63bdbdb6497a3c35566e074f28761024ce5f6", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/17b63bdbdb6497a3c35566e074f28761024ce5f6", "committedDate": "2020-08-14T18:08:09Z", "message": "Return the one platform specification restriction"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NzY5ODc2", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#pullrequestreview-467769876", "createdAt": "2020-08-14T18:04:32Z", "commit": {"oid": "3713769ec829da396cde013398252c46e95ea7c6"}, "state": "COMMENTED", "comments": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxODowNDozMlrOHA93rA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxODozNjoxN1rOHA_TUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc3NTcyNA==", "bodyText": "super-nit: we've been saying \"Building ...\" for others. Let's go for consistency.", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470775724", "createdAt": "2020-08-14T18:04:32Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/BuildManifestListStep.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.builder.steps;\n+\n+import com.google.cloud.tools.jib.api.LogEvent;\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.blob.Blobs;\n+import com.google.cloud.tools.jib.builder.ProgressEventDispatcher;\n+import com.google.cloud.tools.jib.builder.TimerEventDispatcher;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.event.EventHandlers;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.ImageToJsonTranslator;\n+import com.google.cloud.tools.jib.image.json.ManifestListGenerator;\n+import com.google.cloud.tools.jib.image.json.ManifestTemplate;\n+import com.google.cloud.tools.jib.json.JsonTemplate;\n+import com.google.common.io.ByteStreams;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.concurrent.Callable;\n+\n+/** Creates a manifest list. */\n+class BuildManifestListStep implements Callable<ManifestTemplate> {\n+\n+  private static final String DESCRIPTION = \"Creating a manifest list\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3713769ec829da396cde013398252c46e95ea7c6"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc3NTk3NA==", "bodyText": "\"building ...\"", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470775974", "createdAt": "2020-08-14T18:05:04Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/BuildManifestListStep.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.builder.steps;\n+\n+import com.google.cloud.tools.jib.api.LogEvent;\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.blob.Blobs;\n+import com.google.cloud.tools.jib.builder.ProgressEventDispatcher;\n+import com.google.cloud.tools.jib.builder.TimerEventDispatcher;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.event.EventHandlers;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.ImageToJsonTranslator;\n+import com.google.cloud.tools.jib.image.json.ManifestListGenerator;\n+import com.google.cloud.tools.jib.image.json.ManifestTemplate;\n+import com.google.cloud.tools.jib.json.JsonTemplate;\n+import com.google.common.io.ByteStreams;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.concurrent.Callable;\n+\n+/** Creates a manifest list. */\n+class BuildManifestListStep implements Callable<ManifestTemplate> {\n+\n+  private static final String DESCRIPTION = \"Creating a manifest list\";\n+\n+  private final BuildContext buildContext;\n+  private final ProgressEventDispatcher.Factory progressEventDispatcherFactory;\n+  private final List<Image> builtImages;\n+\n+  BuildManifestListStep(\n+      BuildContext buildContext,\n+      ProgressEventDispatcher.Factory progressEventDispatcherFactory,\n+      List<Image> builtImages) {\n+    this.buildContext = buildContext;\n+    this.progressEventDispatcherFactory = progressEventDispatcherFactory;\n+    this.builtImages = builtImages;\n+  }\n+\n+  @Override\n+  public ManifestTemplate call() throws IOException {\n+\n+    EventHandlers eventHandlers = buildContext.getEventHandlers();\n+    try (TimerEventDispatcher ignored = new TimerEventDispatcher(eventHandlers, DESCRIPTION);\n+        ProgressEventDispatcher ignored2 =\n+            progressEventDispatcherFactory.create(\"creating a manifest list\", 1)) {\n+      eventHandlers.dispatch(LogEvent.info(\"Creating a manifest list\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3713769ec829da396cde013398252c46e95ea7c6"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc3NjUwNw==", "bodyText": "Put everything into the try-resources block.\n  try (TimerEventDispatcher ...) {\n    ...\n    return new ManifestListGenator(...);\n  }\nAnd actually, I think we can use\nBlobDescriptor configDescriptor = Digests.computeDigest(containerConfig);\ninstead of Blobs.from(...).writeTo(). I am not sure why we used it that way in other places.\nAnd I think we can simply this to\n    if (builtImages.size() == 1) {\n      ImageToJsonTranslator imageTranslator = new ImageToJsonTranslator(builtImages.get(0));\n      BlobDescriptor configDescriptor =\n          Digests.computeDigest(imageTranslator.getContainerConfiguration());\n      return imageTranslator.getManifestTemplate(buildContext.getTargetFormat(), configDescriptor);\n    }\n\n    return new ManifestListGenerator(...);", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470776507", "createdAt": "2020-08-14T18:06:17Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/BuildManifestListStep.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.builder.steps;\n+\n+import com.google.cloud.tools.jib.api.LogEvent;\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.blob.Blobs;\n+import com.google.cloud.tools.jib.builder.ProgressEventDispatcher;\n+import com.google.cloud.tools.jib.builder.TimerEventDispatcher;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.event.EventHandlers;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.ImageToJsonTranslator;\n+import com.google.cloud.tools.jib.image.json.ManifestListGenerator;\n+import com.google.cloud.tools.jib.image.json.ManifestTemplate;\n+import com.google.cloud.tools.jib.json.JsonTemplate;\n+import com.google.common.io.ByteStreams;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.concurrent.Callable;\n+\n+/** Creates a manifest list. */\n+class BuildManifestListStep implements Callable<ManifestTemplate> {\n+\n+  private static final String DESCRIPTION = \"Creating a manifest list\";\n+\n+  private final BuildContext buildContext;\n+  private final ProgressEventDispatcher.Factory progressEventDispatcherFactory;\n+  private final List<Image> builtImages;\n+\n+  BuildManifestListStep(\n+      BuildContext buildContext,\n+      ProgressEventDispatcher.Factory progressEventDispatcherFactory,\n+      List<Image> builtImages) {\n+    this.buildContext = buildContext;\n+    this.progressEventDispatcherFactory = progressEventDispatcherFactory;\n+    this.builtImages = builtImages;\n+  }\n+\n+  @Override\n+  public ManifestTemplate call() throws IOException {\n+\n+    EventHandlers eventHandlers = buildContext.getEventHandlers();\n+    try (TimerEventDispatcher ignored = new TimerEventDispatcher(eventHandlers, DESCRIPTION);\n+        ProgressEventDispatcher ignored2 =\n+            progressEventDispatcherFactory.create(\"creating a manifest list\", 1)) {\n+      eventHandlers.dispatch(LogEvent.info(\"Creating a manifest list\"));\n+    }\n+    if (builtImages.size() == 1) {\n+      JsonTemplate containerConfiguration =\n+          new ImageToJsonTranslator(builtImages.get(0)).getContainerConfiguration();\n+      BlobDescriptor configDescriptor =\n+          Blobs.from(containerConfiguration).writeTo(ByteStreams.nullOutputStream());\n+\n+      return new ImageToJsonTranslator(builtImages.get(0))\n+          .getManifestTemplate(buildContext.getTargetFormat(), configDescriptor);\n+    }\n+\n+    return new ManifestListGenerator(this.buildContext, this.builtImages).getManifestListTemplate();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3713769ec829da396cde013398252c46e95ea7c6"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc4Mzc5OQ==", "bodyText": "buildManifestListOrSingleManifest", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470783799", "createdAt": "2020-08-14T18:18:10Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -423,6 +426,21 @@ private void buildImages() {\n             });\n   }\n \n+  private void buildManifestList() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17b63bdbdb6497a3c35566e074f28761024ce5f6"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc4NjAzMA==", "bodyText": "This is confusing\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        () -> {\n          \n          \n            \n                          List<Future<Image>> builtImages = new ArrayList<>();\n          \n          \n            \n                          builtImages.addAll(results.builtImagesAndBaseImages.get().keySet());\n          \n          \n            \n                          return new BuildManifestListStep(\n          \n          \n            \n                                  buildContext, childProgressDispatcherFactory, realizeFutures(builtImages))\n          \n          \n            \n                              .call();\n          \n          \n            \n                        });\n          \n          \n            \n                        () ->\n          \n          \n            \n                          new BuildManifestListStep(\n          \n          \n            \n                                  buildContext,\n          \n          \n            \n                                  childProgressDispatcherFactory,\n          \n          \n            \n                                  realizeFutures(results.builtImagesAndBaseImages.get().keySet()))\n          \n          \n            \n                              .call());", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470786030", "createdAt": "2020-08-14T18:20:47Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -423,6 +426,21 @@ private void buildImages() {\n             });\n   }\n \n+  private void buildManifestList() {\n+    ProgressEventDispatcher.Factory childProgressDispatcherFactory =\n+        Verify.verifyNotNull(rootProgressDispatcher).newChildProducer();\n+\n+    results.manifestListOrSingleManifest =\n+        executorService.submit(\n+            () -> {\n+              List<Future<Image>> builtImages = new ArrayList<>();\n+              builtImages.addAll(results.builtImagesAndBaseImages.get().keySet());\n+              return new BuildManifestListStep(\n+                      buildContext, childProgressDispatcherFactory, realizeFutures(builtImages))\n+                  .call();\n+            });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17b63bdbdb6497a3c35566e074f28761024ce5f6"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc4NjczMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            /** Translates a list of {@link Image} into a manifest list. */\n          \n          \n            \n            /** Generator a manifest list for {@link Image}s. */", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470786730", "createdAt": "2020-08-14T18:21:37Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/ManifestListGenerator.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.blob.Blobs;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate.ManifestDescriptorTemplate;\n+import com.google.cloud.tools.jib.json.JsonTemplate;\n+import com.google.common.io.ByteStreams;\n+import java.io.IOException;\n+import java.util.List;\n+\n+/** Translates a list of {@link Image} into a manifest list. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17b63bdbdb6497a3c35566e074f28761024ce5f6"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc4OTA0Ng==", "bodyText": "ManifestListGenerator doesn't and shouldn't care what the images are. It's an isolated class.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private final List<Image> builtImages;\n          \n          \n            \n              private final List<Image> images;", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470789046", "createdAt": "2020-08-14T18:24:24Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/ManifestListGenerator.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.blob.Blobs;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate.ManifestDescriptorTemplate;\n+import com.google.cloud.tools.jib.json.JsonTemplate;\n+import com.google.common.io.ByteStreams;\n+import java.io.IOException;\n+import java.util.List;\n+\n+/** Translates a list of {@link Image} into a manifest list. */\n+public class ManifestListGenerator {\n+\n+  private final BuildContext buildContext;\n+  private final List<Image> builtImages;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17b63bdbdb6497a3c35566e074f28761024ce5f6"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc4OTE2OA==", "bodyText": "From the API design perspective, it shouldn't know anything about BuildContext. It's an isolated class and shouldn't be coupled.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public ManifestListGenerator(BuildContext buildContext, List<Image> builtImages) {\n          \n          \n            \n              public ManifestListGenerator(... imageFormat, List<Image> images) {", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470789168", "createdAt": "2020-08-14T18:24:33Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/ManifestListGenerator.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.blob.Blobs;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate.ManifestDescriptorTemplate;\n+import com.google.cloud.tools.jib.json.JsonTemplate;\n+import com.google.common.io.ByteStreams;\n+import java.io.IOException;\n+import java.util.List;\n+\n+/** Translates a list of {@link Image} into a manifest list. */\n+public class ManifestListGenerator {\n+\n+  private final BuildContext buildContext;\n+  private final List<Image> builtImages;\n+\n+  public ManifestListGenerator(BuildContext buildContext, List<Image> builtImages) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17b63bdbdb6497a3c35566e074f28761024ce5f6"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc5MTE0NQ==", "bodyText": "No period at the end\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * @return ManifestTemplate a JSON representation of list of {@link Image}.\n          \n          \n            \n               * @return a manifest list JSON", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470791145", "createdAt": "2020-08-14T18:26:51Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/ManifestListGenerator.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.blob.Blobs;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate.ManifestDescriptorTemplate;\n+import com.google.cloud.tools.jib.json.JsonTemplate;\n+import com.google.common.io.ByteStreams;\n+import java.io.IOException;\n+import java.util.List;\n+\n+/** Translates a list of {@link Image} into a manifest list. */\n+public class ManifestListGenerator {\n+\n+  private final BuildContext buildContext;\n+  private final List<Image> builtImages;\n+\n+  public ManifestListGenerator(BuildContext buildContext, List<Image> builtImages) {\n+    this.buildContext = buildContext;\n+    this.builtImages = builtImages;\n+  }\n+\n+  /**\n+   * Translates a list of {@link Image} into a manifestTemplate.\n+   *\n+   * @return ManifestTemplate a JSON representation of list of {@link Image}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17b63bdbdb6497a3c35566e074f28761024ce5f6"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc5MTkyNg==", "bodyText": "Generates a manifest list JSON for the given {@link Image}s.", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470791926", "createdAt": "2020-08-14T18:27:45Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/ManifestListGenerator.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.blob.Blobs;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate.ManifestDescriptorTemplate;\n+import com.google.cloud.tools.jib.json.JsonTemplate;\n+import com.google.common.io.ByteStreams;\n+import java.io.IOException;\n+import java.util.List;\n+\n+/** Translates a list of {@link Image} into a manifest list. */\n+public class ManifestListGenerator {\n+\n+  private final BuildContext buildContext;\n+  private final List<Image> builtImages;\n+\n+  public ManifestListGenerator(BuildContext buildContext, List<Image> builtImages) {\n+    this.buildContext = buildContext;\n+    this.builtImages = builtImages;\n+  }\n+\n+  /**\n+   * Translates a list of {@link Image} into a manifestTemplate.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17b63bdbdb6497a3c35566e074f28761024ce5f6"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc5MjU4OQ==", "bodyText": "ditto", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470792589", "createdAt": "2020-08-14T18:28:36Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/ManifestListGenerator.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.blob.Blobs;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate.ManifestDescriptorTemplate;\n+import com.google.cloud.tools.jib.json.JsonTemplate;\n+import com.google.common.io.ByteStreams;\n+import java.io.IOException;\n+import java.util.List;\n+\n+/** Translates a list of {@link Image} into a manifest list. */\n+public class ManifestListGenerator {\n+\n+  private final BuildContext buildContext;\n+  private final List<Image> builtImages;\n+\n+  public ManifestListGenerator(BuildContext buildContext, List<Image> builtImages) {\n+    this.buildContext = buildContext;\n+    this.builtImages = builtImages;\n+  }\n+\n+  /**\n+   * Translates a list of {@link Image} into a manifestTemplate.\n+   *\n+   * @return ManifestTemplate a JSON representation of list of {@link Image}.\n+   */\n+  public ManifestTemplate getManifestListTemplate() {\n+\n+    try {\n+      V22ManifestListTemplate manifestList = new V22ManifestListTemplate();\n+\n+      for (Image builtImage : builtImages) {\n+        JsonTemplate containerConfiguration =\n+            new ImageToJsonTranslator(builtImage).getContainerConfiguration();\n+        BlobDescriptor configDescriptor =\n+            Blobs.from(containerConfiguration).writeTo(ByteStreams.nullOutputStream());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17b63bdbdb6497a3c35566e074f28761024ce5f6"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc5MzYzNA==", "bodyText": "I need to think about this. Probably not the right way.", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470793634", "createdAt": "2020-08-14T18:29:49Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/ManifestListGenerator.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.blob.Blobs;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate.ManifestDescriptorTemplate;\n+import com.google.cloud.tools.jib.json.JsonTemplate;\n+import com.google.common.io.ByteStreams;\n+import java.io.IOException;\n+import java.util.List;\n+\n+/** Translates a list of {@link Image} into a manifest list. */\n+public class ManifestListGenerator {\n+\n+  private final BuildContext buildContext;\n+  private final List<Image> builtImages;\n+\n+  public ManifestListGenerator(BuildContext buildContext, List<Image> builtImages) {\n+    this.buildContext = buildContext;\n+    this.builtImages = builtImages;\n+  }\n+\n+  /**\n+   * Translates a list of {@link Image} into a manifestTemplate.\n+   *\n+   * @return ManifestTemplate a JSON representation of list of {@link Image}.\n+   */\n+  public ManifestTemplate getManifestListTemplate() {\n+\n+    try {\n+      V22ManifestListTemplate manifestList = new V22ManifestListTemplate();\n+\n+      for (Image builtImage : builtImages) {\n+        JsonTemplate containerConfiguration =\n+            new ImageToJsonTranslator(builtImage).getContainerConfiguration();\n+        BlobDescriptor configDescriptor =\n+            Blobs.from(containerConfiguration).writeTo(ByteStreams.nullOutputStream());\n+\n+        BuildableManifestTemplate manifestTemplate =\n+            new ImageToJsonTranslator(builtImage)\n+                .getManifestTemplate(buildContext.getTargetFormat(), configDescriptor);\n+        BlobDescriptor manifestDescriptor =\n+            Blobs.from(manifestTemplate).writeTo(ByteStreams.nullOutputStream());\n+\n+        ManifestDescriptorTemplate manifest = new ManifestDescriptorTemplate();\n+        manifest.setMediaType(manifestTemplate.getManifestMediaType());\n+        manifest.setSize(manifestDescriptor.getSize());\n+        manifest.setDigest(manifestDescriptor.getDigest().toString());\n+        manifest.setPlatform(builtImage.getArchitecture(), builtImage.getOs());\n+        manifestList.addManifest(manifest);\n+      }\n+      return manifestList;\n+\n+    } catch (IOException ex) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17b63bdbdb6497a3c35566e074f28761024ce5f6"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc5NDE1MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Adds a manifest to the manifestList.\n          \n          \n            \n               * Adds a manifest.", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470794151", "createdAt": "2020-08-14T18:30:21Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/V22ManifestListTemplate.java", "diffHunk": "@@ -68,13 +70,32 @@\n       \"application/vnd.docker.distribution.manifest.list.v2+json\";\n   private static final int SCHEMA_VERSION = 2;\n \n+  private final int schemaVersion = SCHEMA_VERSION;\n+  private final String mediaType = MANIFEST_MEDIA_TYPE;\n+\n   @Override\n   public int getSchemaVersion() {\n-    return SCHEMA_VERSION;\n+    return schemaVersion;\n+  }\n+\n+  public String getMediaType() {\n+    return mediaType;\n   }\n \n   @Nullable private List<ManifestDescriptorTemplate> manifests;\n \n+  /**\n+   * Adds a manifest to the manifestList.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17b63bdbdb6497a3c35566e074f28761024ce5f6"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc5OTE4Nw==", "bodyText": "This class shouldn't mention Image. The class is totally unrelated. I think we can just go with\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * @param manifest a JSON representation of an {@link Image}\n          \n          \n            \n               * @param manifest a manifest descriptor", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470799187", "createdAt": "2020-08-14T18:36:17Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/V22ManifestListTemplate.java", "diffHunk": "@@ -68,13 +70,32 @@\n       \"application/vnd.docker.distribution.manifest.list.v2+json\";\n   private static final int SCHEMA_VERSION = 2;\n \n+  private final int schemaVersion = SCHEMA_VERSION;\n+  private final String mediaType = MANIFEST_MEDIA_TYPE;\n+\n   @Override\n   public int getSchemaVersion() {\n-    return SCHEMA_VERSION;\n+    return schemaVersion;\n+  }\n+\n+  public String getMediaType() {\n+    return mediaType;\n   }\n \n   @Nullable private List<ManifestDescriptorTemplate> manifests;\n \n+  /**\n+   * Adds a manifest to the manifestList.\n+   *\n+   * @param manifest a JSON representation of an {@link Image}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17b63bdbdb6497a3c35566e074f28761024ce5f6"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33ab89abacf5b1b0ce3c246297c189e2f1e2e66b", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/33ab89abacf5b1b0ce3c246297c189e2f1e2e66b", "committedDate": "2020-08-14T20:34:42Z", "message": "Fixing Styles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d65f6847a80d174e45f5dfc8dfd347ee84b93f0", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/5d65f6847a80d174e45f5dfc8dfd347ee84b93f0", "committedDate": "2020-08-14T20:38:38Z", "message": "Fixing Javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9274896a89afd09c98d71a8319496bc1bf10ed98", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/9274896a89afd09c98d71a8319496bc1bf10ed98", "committedDate": "2020-08-14T20:43:24Z", "message": "Adding missing file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47f91a393f0129af5e4f39bb04d1d36170d7ef25", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/47f91a393f0129af5e4f39bb04d1d36170d7ef25", "committedDate": "2020-08-14T23:16:41Z", "message": "Minor Style Fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7b908a69615f410936dc02f0b9a35ecb142cd41", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/d7b908a69615f410936dc02f0b9a35ecb142cd41", "committedDate": "2020-08-17T17:26:29Z", "message": "Adding tests for BuildManifestListOrSingleManifestStepTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MDY5MjUw", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#pullrequestreview-468069250", "createdAt": "2020-08-16T14:32:58Z", "commit": {"oid": "47f91a393f0129af5e4f39bb04d1d36170d7ef25"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNlQxNDozMjo1OFrOHBS4Qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNlQxNDozMjo1OFrOHBS4Qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTExOTkzOQ==", "bodyText": "Let's not add this here. I think we will have it in a different place when everything is properly implemented.", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r471119939", "createdAt": "2020-08-16T14:32:58Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -206,6 +209,7 @@ public BuildResult run() throws ExecutionException, InterruptedException {\n       rootProgressDispatcher = progressEventDispatcher;\n \n       stepsToRun.forEach(Runnable::run);\n+      realizeFutures(results.buildResults.get());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47f91a393f0129af5e4f39bb04d1d36170d7ef25"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NzU1NDc1", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#pullrequestreview-468755475", "createdAt": "2020-08-17T18:59:07Z", "commit": {"oid": "47f91a393f0129af5e4f39bb04d1d36170d7ef25"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxODo1OTowN1rOHB3Gsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxODo1OTowN1rOHB3Gsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcxMzQ1OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  return new ManifestListGenerator(this.builtImages)\n          \n          \n            \n                      .getManifestListTemplate(this.buildContext.getTargetFormat());\n          \n          \n            \n                  return new ManifestListGenerator(builtImages)\n          \n          \n            \n                      .getManifestListTemplate(buildContext.getTargetFormat());", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r471713458", "createdAt": "2020-08-17T18:59:07Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/BuildManifestListOrSingleManifestStep.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.builder.steps;\n+\n+import com.google.cloud.tools.jib.api.LogEvent;\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.builder.ProgressEventDispatcher;\n+import com.google.cloud.tools.jib.builder.TimerEventDispatcher;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.event.EventHandlers;\n+import com.google.cloud.tools.jib.hash.Digests;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.ImageToJsonTranslator;\n+import com.google.cloud.tools.jib.image.json.ManifestListGenerator;\n+import com.google.cloud.tools.jib.image.json.ManifestTemplate;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.concurrent.Callable;\n+\n+/** Builds a manifest list or a single manifest. */\n+class BuildManifestListOrSingleManifestStep implements Callable<ManifestTemplate> {\n+\n+  private static final String DESCRIPTION = \"Building a manifest list or a single manifest\";\n+\n+  private final BuildContext buildContext;\n+  private final ProgressEventDispatcher.Factory progressEventDispatcherFactory;\n+  private final List<Image> builtImages;\n+\n+  BuildManifestListOrSingleManifestStep(\n+      BuildContext buildContext,\n+      ProgressEventDispatcher.Factory progressEventDispatcherFactory,\n+      List<Image> builtImages) {\n+    this.buildContext = buildContext;\n+    this.progressEventDispatcherFactory = progressEventDispatcherFactory;\n+    this.builtImages = builtImages;\n+  }\n+\n+  @Override\n+  public ManifestTemplate call() throws IOException {\n+\n+    EventHandlers eventHandlers = buildContext.getEventHandlers();\n+    try (TimerEventDispatcher ignored = new TimerEventDispatcher(eventHandlers, DESCRIPTION);\n+        ProgressEventDispatcher ignored2 =\n+            progressEventDispatcherFactory.create(\n+                \"building a manifest list or a single manifest\", 1)) {\n+\n+      if (builtImages.size() == 1) {\n+        eventHandlers.dispatch(LogEvent.info(\"Building a single manifest\"));\n+        ImageToJsonTranslator imageTranslator = new ImageToJsonTranslator(builtImages.get(0));\n+        BlobDescriptor configDescriptor =\n+            Digests.computeDigest(imageTranslator.getContainerConfiguration());\n+        return imageTranslator.getManifestTemplate(\n+            buildContext.getTargetFormat(), configDescriptor);\n+      }\n+\n+      eventHandlers.dispatch(LogEvent.info(\"Building a manifest list\"));\n+      return new ManifestListGenerator(this.builtImages)\n+          .getManifestListTemplate(this.buildContext.getTargetFormat());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47f91a393f0129af5e4f39bb04d1d36170d7ef25"}, "originalPosition": 72}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1028972f006c08dd6c6003a1e9e3d8628e96fc4e", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/1028972f006c08dd6c6003a1e9e3d8628e96fc4e", "committedDate": "2020-08-17T22:53:48Z", "message": "Create manifest list test chanseok (#2706)\n\n* Clean up code\r\n\r\n* Rename test methods\r\n\r\nCo-authored-by: Chanseok Oh <chanseok@google.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2452f176adf83eb0be648a9a30835f54646db070", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/2452f176adf83eb0be648a9a30835f54646db070", "committedDate": "2020-08-18T14:59:01Z", "message": "Fixing BuildManifestList test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23d977907a3da24fa64f5429f10a4a217a70d7db", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/23d977907a3da24fa64f5429f10a4a217a70d7db", "committedDate": "2020-08-18T15:02:03Z", "message": "Fixing Json Templates"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NTUwMjM2", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#pullrequestreview-469550236", "createdAt": "2020-08-18T15:06:56Z", "commit": {"oid": "23d977907a3da24fa64f5429f10a4a217a70d7db"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNTowNjo1NlrOHCZB1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNToyMTozNVrOHCZqKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI2OTI2OA==", "bodyText": "Javadoc comments (starting with /** using double asterisks) are basically for machine processing to generate a nice-looking manual for external users using a library. This is an internal code comment, so we should use // code comment. And no HTML formatting, and no need to follow the Javadoc convention. I also suggest proper indentation for readability.\n// Expected manifest JSON:\n// {\n//   \"schemaVersion\":2,\n//   \"mediaType\":\"application/vnd.docker.distribution.manifest.v2+json\",", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472269268", "createdAt": "2020-08-18T15:06:56Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/test/java/com/google/cloud/tools/jib/builder/steps/BuildManifestListOrSingleManifestStepTest.java", "diffHunk": "@@ -0,0 +1,157 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.builder.steps;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.builder.ProgressEventDispatcher;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.event.EventHandlers;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.Layer;\n+import com.google.cloud.tools.jib.image.json.ManifestTemplate;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate;\n+import com.google.cloud.tools.jib.image.json.V22ManifestTemplate;\n+import java.io.IOException;\n+import java.util.Arrays;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+/** Tests for {@link BuildManifestListOrSingleManifest}. */\n+@RunWith(MockitoJUnitRunner.class)\n+public class BuildManifestListOrSingleManifestStepTest {\n+\n+  @Mock private ProgressEventDispatcher.Factory progressDispatcherFactory;\n+  @Mock private BuildContext buildContext;\n+  @Mock private Layer layer;\n+\n+  private Image image1;\n+  private Image image2;\n+\n+  @Before\n+  public void setUp() {\n+    Mockito.when(buildContext.getEventHandlers()).thenReturn(EventHandlers.NONE);\n+    Mockito.doReturn(V22ManifestTemplate.class).when(buildContext).getTargetFormat();\n+    Mockito.when(layer.getBlobDescriptor()).thenReturn(new BlobDescriptor(0, null));\n+\n+    image1 =\n+        Image.builder(V22ManifestTemplate.class)\n+            .setArchitecture(\"amd64\")\n+            .setOs(\"linux\")\n+            .addLayer(new PreparedLayer.Builder(layer).setName(\"resources\").build())\n+            .build();\n+    image2 =\n+        Image.builder(V22ManifestTemplate.class)\n+            .setArchitecture(\"arm64\")\n+            .setOs(\"ubuntu\")\n+            .addLayer(new PreparedLayer.Builder(layer).setName(\"classes\").build())\n+            .build();\n+  }\n+\n+  @Test\n+  public void testCall_singleManifest() throws IOException {\n+    /**\n+     * Expected manifest JSON:\n+     *\n+     * <pre>{@code\n+     * {\n+     * \"schemaVersion\":2,\n+     * \"mediaType\":\"application/vnd.docker.distribution.manifest.v2+json\",\n+     * \"config\":{\n+     * \"mediaType\":\"application/vnd.docker.container.image.v1+json\",\n+     * \"digest\":\"sha256:1b2ff280940537177565443144a81319ad48528fd35d1cdc38cbde07f24f6912\",\n+     * \"size\":158\n+     * },\n+     * \"layers\":[\n+     * {\n+     * \"mediaType\":\"application/vnd.docker.image.rootfs.diff.tar.gzip\",\n+     * \"size\":0\n+     * }\n+     * ]\n+     * }\n+     * }</pre>\n+     */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23d977907a3da24fa64f5429f10a4a217a70d7db"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI3MjE1Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        .addLayer(new PreparedLayer.Builder(layer).setName(\"resources\").build())\n          \n          \n            \n                        .addLayer(layer)", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472272157", "createdAt": "2020-08-18T15:11:08Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/test/java/com/google/cloud/tools/jib/builder/steps/BuildManifestListOrSingleManifestStepTest.java", "diffHunk": "@@ -0,0 +1,157 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.builder.steps;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.builder.ProgressEventDispatcher;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.event.EventHandlers;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.Layer;\n+import com.google.cloud.tools.jib.image.json.ManifestTemplate;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate;\n+import com.google.cloud.tools.jib.image.json.V22ManifestTemplate;\n+import java.io.IOException;\n+import java.util.Arrays;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+/** Tests for {@link BuildManifestListOrSingleManifest}. */\n+@RunWith(MockitoJUnitRunner.class)\n+public class BuildManifestListOrSingleManifestStepTest {\n+\n+  @Mock private ProgressEventDispatcher.Factory progressDispatcherFactory;\n+  @Mock private BuildContext buildContext;\n+  @Mock private Layer layer;\n+\n+  private Image image1;\n+  private Image image2;\n+\n+  @Before\n+  public void setUp() {\n+    Mockito.when(buildContext.getEventHandlers()).thenReturn(EventHandlers.NONE);\n+    Mockito.doReturn(V22ManifestTemplate.class).when(buildContext).getTargetFormat();\n+    Mockito.when(layer.getBlobDescriptor()).thenReturn(new BlobDescriptor(0, null));\n+\n+    image1 =\n+        Image.builder(V22ManifestTemplate.class)\n+            .setArchitecture(\"amd64\")\n+            .setOs(\"linux\")\n+            .addLayer(new PreparedLayer.Builder(layer).setName(\"resources\").build())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23d977907a3da24fa64f5429f10a4a217a70d7db"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI3MjE4OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        .addLayer(new PreparedLayer.Builder(layer).setName(\"classes\").build())\n          \n          \n            \n                        .addLayer(layer)", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472272189", "createdAt": "2020-08-18T15:11:11Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/test/java/com/google/cloud/tools/jib/builder/steps/BuildManifestListOrSingleManifestStepTest.java", "diffHunk": "@@ -0,0 +1,157 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.builder.steps;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.builder.ProgressEventDispatcher;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.event.EventHandlers;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.Layer;\n+import com.google.cloud.tools.jib.image.json.ManifestTemplate;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate;\n+import com.google.cloud.tools.jib.image.json.V22ManifestTemplate;\n+import java.io.IOException;\n+import java.util.Arrays;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+/** Tests for {@link BuildManifestListOrSingleManifest}. */\n+@RunWith(MockitoJUnitRunner.class)\n+public class BuildManifestListOrSingleManifestStepTest {\n+\n+  @Mock private ProgressEventDispatcher.Factory progressDispatcherFactory;\n+  @Mock private BuildContext buildContext;\n+  @Mock private Layer layer;\n+\n+  private Image image1;\n+  private Image image2;\n+\n+  @Before\n+  public void setUp() {\n+    Mockito.when(buildContext.getEventHandlers()).thenReturn(EventHandlers.NONE);\n+    Mockito.doReturn(V22ManifestTemplate.class).when(buildContext).getTargetFormat();\n+    Mockito.when(layer.getBlobDescriptor()).thenReturn(new BlobDescriptor(0, null));\n+\n+    image1 =\n+        Image.builder(V22ManifestTemplate.class)\n+            .setArchitecture(\"amd64\")\n+            .setOs(\"linux\")\n+            .addLayer(new PreparedLayer.Builder(layer).setName(\"resources\").build())\n+            .build();\n+    image2 =\n+        Image.builder(V22ManifestTemplate.class)\n+            .setArchitecture(\"arm64\")\n+            .setOs(\"ubuntu\")\n+            .addLayer(new PreparedLayer.Builder(layer).setName(\"classes\").build())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23d977907a3da24fa64f5429f10a4a217a70d7db"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI3OTU5Mw==", "bodyText": "I see we always create a Docker manifest list, which is another limitation of multi-platform image building. Note that there are 2 avenues for considering OCI vs Docker format.\n\nBase image: we take care of this automatically, and the format is transparent to the user.\nTarget image(s): user-configurable with <format>OCI or <format>Docker.\n\nThat is, Jib will be broken when <format>OCI is specified (because we will build OCI manifests while a Docker manifest). We should add another item to fix. Please add this to your tracking list.", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472279593", "createdAt": "2020-08-18T15:21:35Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/ManifestListGenerator.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.hash.Digests;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate.ManifestDescriptorTemplate;\n+import java.io.IOException;\n+import java.util.List;\n+\n+/** Generates a manifest list for {@link Image}s. */\n+public class ManifestListGenerator {\n+\n+  private final List<Image> images;\n+\n+  public ManifestListGenerator(List<Image> images) {\n+    this.images = images;\n+  }\n+\n+  /**\n+   * Generates a manifest list JSON for the given {@link Image}s.\n+   *\n+   * @param <T> child type of {@link BuildableManifestTemplate}\n+   * @param manifestTemplateClass the JSON template to translate the image to\n+   * @return a manifest list JSON\n+   */\n+  public <T extends BuildableManifestTemplate> ManifestTemplate getManifestListTemplate(\n+      Class<T> manifestTemplateClass) {\n+    try {\n+      V22ManifestListTemplate manifestList = new V22ManifestListTemplate();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23d977907a3da24fa64f5429f10a4a217a70d7db"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NTcwMDE2", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#pullrequestreview-469570016", "createdAt": "2020-08-18T15:27:30Z", "commit": {"oid": "23d977907a3da24fa64f5429f10a4a217a70d7db"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNToyNzozMVrOHCZ7vQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNToyNzozMVrOHCZ7vQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI4NDA5Mw==", "bodyText": "nit: let's say \"windows\" to eliminate any potential misunderstanding. (Ubuntu is linux).", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472284093", "createdAt": "2020-08-18T15:27:31Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/test/java/com/google/cloud/tools/jib/builder/steps/BuildManifestListOrSingleManifestStepTest.java", "diffHunk": "@@ -0,0 +1,157 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.builder.steps;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.builder.ProgressEventDispatcher;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.event.EventHandlers;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.Layer;\n+import com.google.cloud.tools.jib.image.json.ManifestTemplate;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate;\n+import com.google.cloud.tools.jib.image.json.V22ManifestTemplate;\n+import java.io.IOException;\n+import java.util.Arrays;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+/** Tests for {@link BuildManifestListOrSingleManifest}. */\n+@RunWith(MockitoJUnitRunner.class)\n+public class BuildManifestListOrSingleManifestStepTest {\n+\n+  @Mock private ProgressEventDispatcher.Factory progressDispatcherFactory;\n+  @Mock private BuildContext buildContext;\n+  @Mock private Layer layer;\n+\n+  private Image image1;\n+  private Image image2;\n+\n+  @Before\n+  public void setUp() {\n+    Mockito.when(buildContext.getEventHandlers()).thenReturn(EventHandlers.NONE);\n+    Mockito.doReturn(V22ManifestTemplate.class).when(buildContext).getTargetFormat();\n+    Mockito.when(layer.getBlobDescriptor()).thenReturn(new BlobDescriptor(0, null));\n+\n+    image1 =\n+        Image.builder(V22ManifestTemplate.class)\n+            .setArchitecture(\"amd64\")\n+            .setOs(\"linux\")\n+            .addLayer(new PreparedLayer.Builder(layer).setName(\"resources\").build())\n+            .build();\n+    image2 =\n+        Image.builder(V22ManifestTemplate.class)\n+            .setArchitecture(\"arm64\")\n+            .setOs(\"ubuntu\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23d977907a3da24fa64f5429f10a4a217a70d7db"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d94db6403996845dbc373f13426536635dcba24", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/2d94db6403996845dbc373f13426536635dcba24", "committedDate": "2020-08-18T15:34:53Z", "message": "Testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f93d87b8d6e45437322d072ff30be35d3314628", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/3f93d87b8d6e45437322d072ff30be35d3314628", "committedDate": "2020-08-18T17:39:19Z", "message": "Respond to feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82408256cfa12b4794fd099a43407efa89e53800", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/82408256cfa12b4794fd099a43407efa89e53800", "committedDate": "2020-08-18T17:47:16Z", "message": "Removing a file"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NjkzNDgy", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#pullrequestreview-469693482", "createdAt": "2020-08-18T17:54:20Z", "commit": {"oid": "82408256cfa12b4794fd099a43407efa89e53800"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNzo1NDoyMFrOHCftDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxODowMzo1MlrOHCgCpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM3ODYzNg==", "bodyText": "We should keep this. Will be handy going forward.", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472378636", "createdAt": "2020-08-18T17:54:20Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -481,7 +498,6 @@ private void checkImageInTargetRegistry() {\n     results.manifestCheckResult =\n         executorService.submit(\n             () -> {\n-              Verify.verify(results.builtImagesAndBaseImages.get().size() == 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82408256cfa12b4794fd099a43407efa89e53800"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM3OTc3MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * @throws IOException IOException\n          \n          \n            \n               * @throws IOException if generating a manifest list fails due to an I/O error when computing digests", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472379770", "createdAt": "2020-08-18T17:56:08Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/ManifestListGenerator.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.hash.Digests;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate.ManifestDescriptorTemplate;\n+import java.io.IOException;\n+import java.util.List;\n+\n+/** Generates a manifest list for {@link Image}s. */\n+public class ManifestListGenerator {\n+\n+  private final List<Image> images;\n+\n+  public ManifestListGenerator(List<Image> images) {\n+    this.images = images;\n+  }\n+\n+  /**\n+   * Generates a manifest list JSON for the given {@link Image}s.\n+   *\n+   * @param <T> child type of {@link BuildableManifestTemplate}\n+   * @param manifestTemplateClass the JSON template to translate the image to\n+   * @return a manifest list JSON\n+   * @throws IOException IOException", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82408256cfa12b4794fd099a43407efa89e53800"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM4MTg1OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \n          \n          \n            \n                Preconditions.checkArgument(manifestTemplateClass == V22ManifestTemplate.class, \"Build an OCI image index is not yet supported\"); \n          \n      \n    \n    \n  \n\nAnd super-nit: I see you often put a blank line when starting a method, but we've not been doing that in our repo.", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472381859", "createdAt": "2020-08-18T17:59:39Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/ManifestListGenerator.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.hash.Digests;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate.ManifestDescriptorTemplate;\n+import java.io.IOException;\n+import java.util.List;\n+\n+/** Generates a manifest list for {@link Image}s. */\n+public class ManifestListGenerator {\n+\n+  private final List<Image> images;\n+\n+  public ManifestListGenerator(List<Image> images) {\n+    this.images = images;\n+  }\n+\n+  /**\n+   * Generates a manifest list JSON for the given {@link Image}s.\n+   *\n+   * @param <T> child type of {@link BuildableManifestTemplate}\n+   * @param manifestTemplateClass the JSON template to translate the image to\n+   * @return a manifest list JSON\n+   * @throws IOException IOException\n+   */\n+  public <T extends BuildableManifestTemplate> ManifestTemplate getManifestListTemplate(\n+      Class<T> manifestTemplateClass) throws IOException {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82408256cfa12b4794fd099a43407efa89e53800"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM4MjcxOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // \"schemaVersion\":2,\n          \n          \n            \n                //  \"schemaVersion\":2,", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472382718", "createdAt": "2020-08-18T18:01:11Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/test/java/com/google/cloud/tools/jib/builder/steps/BuildManifestListOrSingleManifestStepTest.java", "diffHunk": "@@ -0,0 +1,150 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.builder.steps;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.builder.ProgressEventDispatcher;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.event.EventHandlers;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.Layer;\n+import com.google.cloud.tools.jib.image.json.ManifestTemplate;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate;\n+import com.google.cloud.tools.jib.image.json.V22ManifestTemplate;\n+import java.io.IOException;\n+import java.util.Arrays;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+/** Tests for {@link BuildManifestListOrSingleManifest}. */\n+@RunWith(MockitoJUnitRunner.class)\n+public class BuildManifestListOrSingleManifestStepTest {\n+\n+  @Mock private ProgressEventDispatcher.Factory progressDispatcherFactory;\n+  @Mock private BuildContext buildContext;\n+  @Mock private Layer layer;\n+\n+  private Image image1;\n+  private Image image2;\n+\n+  @Before\n+  public void setUp() {\n+    Mockito.when(buildContext.getEventHandlers()).thenReturn(EventHandlers.NONE);\n+    Mockito.doReturn(V22ManifestTemplate.class).when(buildContext).getTargetFormat();\n+    Mockito.when(layer.getBlobDescriptor()).thenReturn(new BlobDescriptor(0, null));\n+\n+    image1 =\n+        Image.builder(V22ManifestTemplate.class)\n+            .setArchitecture(\"amd64\")\n+            .setOs(\"linux\")\n+            .addLayer(layer)\n+            .build();\n+    image2 =\n+        Image.builder(V22ManifestTemplate.class)\n+            .setArchitecture(\"arm64\")\n+            .setOs(\"windows\")\n+            .addLayer(layer)\n+            .build();\n+  }\n+\n+  @Test\n+  public void testCall_singleManifest() throws IOException {\n+\n+    // Expected manifest JSON\n+    //  {\n+    // \"schemaVersion\":2,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82408256cfa12b4794fd099a43407efa89e53800"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM4Mjg4MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // \"schemaVersion\":2,\n          \n          \n            \n                //  \"schemaVersion\":2,", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472382880", "createdAt": "2020-08-18T18:01:29Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/test/java/com/google/cloud/tools/jib/builder/steps/BuildManifestListOrSingleManifestStepTest.java", "diffHunk": "@@ -0,0 +1,150 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.builder.steps;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.builder.ProgressEventDispatcher;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.event.EventHandlers;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.Layer;\n+import com.google.cloud.tools.jib.image.json.ManifestTemplate;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate;\n+import com.google.cloud.tools.jib.image.json.V22ManifestTemplate;\n+import java.io.IOException;\n+import java.util.Arrays;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+/** Tests for {@link BuildManifestListOrSingleManifest}. */\n+@RunWith(MockitoJUnitRunner.class)\n+public class BuildManifestListOrSingleManifestStepTest {\n+\n+  @Mock private ProgressEventDispatcher.Factory progressDispatcherFactory;\n+  @Mock private BuildContext buildContext;\n+  @Mock private Layer layer;\n+\n+  private Image image1;\n+  private Image image2;\n+\n+  @Before\n+  public void setUp() {\n+    Mockito.when(buildContext.getEventHandlers()).thenReturn(EventHandlers.NONE);\n+    Mockito.doReturn(V22ManifestTemplate.class).when(buildContext).getTargetFormat();\n+    Mockito.when(layer.getBlobDescriptor()).thenReturn(new BlobDescriptor(0, null));\n+\n+    image1 =\n+        Image.builder(V22ManifestTemplate.class)\n+            .setArchitecture(\"amd64\")\n+            .setOs(\"linux\")\n+            .addLayer(layer)\n+            .build();\n+    image2 =\n+        Image.builder(V22ManifestTemplate.class)\n+            .setArchitecture(\"arm64\")\n+            .setOs(\"windows\")\n+            .addLayer(layer)\n+            .build();\n+  }\n+\n+  @Test\n+  public void testCall_singleManifest() throws IOException {\n+\n+    // Expected manifest JSON\n+    //  {\n+    // \"schemaVersion\":2,\n+    //  \"mediaType\":\"application/vnd.docker.distribution.manifest.v2+json\",\n+    //  \"config\":{\n+    //    \"mediaType\":\"application/vnd.docker.container.image.v1+json\",\n+    //    \"digest\":\"sha256:1b2ff280940537177565443144a81319ad48528fd35d1cdc38cbde07f24f6912\",\n+    //    \"size\":158\n+    //  },\n+    //  \"layers\":[\n+    //    {\n+    //      \"mediaType\":\"application/vnd.docker.image.rootfs.diff.tar.gzip\",\n+    //      \"size\":0\n+    //    }\n+    //  ]\n+    // }\n+\n+    ManifestTemplate manifestTemplate =\n+        new BuildManifestListOrSingleManifestStep(\n+                buildContext, progressDispatcherFactory, Arrays.asList(image1))\n+            .call();\n+\n+    Assert.assertTrue(manifestTemplate instanceof V22ManifestTemplate);\n+    V22ManifestTemplate manifest = (V22ManifestTemplate) manifestTemplate;\n+    Assert.assertEquals(2, manifest.getSchemaVersion());\n+    Assert.assertEquals(\n+        \"application/vnd.docker.distribution.manifest.v2+json\", manifest.getManifestMediaType());\n+    Assert.assertEquals(\n+        \"sha256:1b2ff280940537177565443144a81319ad48528fd35d1cdc38cbde07f24f6912\",\n+        manifest.getContainerConfiguration().getDigest().toString());\n+    Assert.assertEquals(0, manifest.getLayers().get(0).getSize());\n+    Assert.assertEquals(158, manifest.getContainerConfiguration().getSize());\n+  }\n+\n+  @Test\n+  public void testCall_manifestList() throws IOException {\n+\n+    // Expected Manifest List JSON\n+    //  {\n+    // \"schemaVersion\":2,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82408256cfa12b4794fd099a43407efa89e53800"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM4MzI0NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // \"schemaVersion\":2,\n          \n          \n            \n                //  \"schemaVersion\":2,", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472383245", "createdAt": "2020-08-18T18:02:10Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/test/java/com/google/cloud/tools/jib/image/json/ManifestListGeneratorTest.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.cloud.tools.jib.image.Image;\n+import java.io.IOException;\n+import java.util.Arrays;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+/** Tests for {@link ManifestListGenerator}. */\n+public class ManifestListGeneratorTest {\n+\n+  private Image image1;\n+  private Image image2;\n+  private ManifestListGenerator manifestListGenerator;\n+\n+  private void setUp(Class<? extends BuildableManifestTemplate> imageFormat) {\n+    image1 = Image.builder(imageFormat).setArchitecture(\"amd64\").setOs(\"linux\").build();\n+    image2 = Image.builder(imageFormat).setArchitecture(\"arm64\").setOs(\"windows\").build();\n+    manifestListGenerator = new ManifestListGenerator(Arrays.asList(image1, image2));\n+  }\n+\n+  @Test\n+  public void testGetManifest_v22() throws IOException {\n+    setUp(V22ManifestTemplate.class);\n+    testGetManifestListTemplate(V22ManifestTemplate.class);\n+  }\n+\n+  /** Tests translation of image to {@link BuildableManifestTemplate}. */\n+  private <T extends BuildableManifestTemplate> void testGetManifestListTemplate(\n+      Class<T> manifestTemplateClass) throws IOException {\n+\n+    // Expected Manifest List JSON\n+    //  {\n+    // \"schemaVersion\":2,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82408256cfa12b4794fd099a43407efa89e53800"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM4MzUyNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private void setUp(Class<? extends BuildableManifestTemplate> imageFormat) {\n          \n          \n            \n              @Before\n          \n          \n            \n              private void setUp() {", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472383524", "createdAt": "2020-08-18T18:02:38Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/test/java/com/google/cloud/tools/jib/image/json/ManifestListGeneratorTest.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.cloud.tools.jib.image.Image;\n+import java.io.IOException;\n+import java.util.Arrays;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+/** Tests for {@link ManifestListGenerator}. */\n+public class ManifestListGeneratorTest {\n+\n+  private Image image1;\n+  private Image image2;\n+  private ManifestListGenerator manifestListGenerator;\n+\n+  private void setUp(Class<? extends BuildableManifestTemplate> imageFormat) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82408256cfa12b4794fd099a43407efa89e53800"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM4Mzk2Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              @Test\n          \n          \n            \n              public void testGetManifest_v22() throws IOException {\n          \n          \n            \n                setUp(V22ManifestTemplate.class);\n          \n          \n            \n                testGetManifestListTemplate(V22ManifestTemplate.class);\n          \n          \n            \n              }\n          \n          \n            \n            \n          \n          \n            \n              /** Tests translation of image to {@link BuildableManifestTemplate}. */\n          \n          \n            \n              private <T extends BuildableManifestTemplate> void testGetManifestListTemplate(\n          \n          \n            \n              @Test\n          \n          \n            \n              public void testGetManifestListTemplate(", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472383966", "createdAt": "2020-08-18T18:03:31Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/test/java/com/google/cloud/tools/jib/image/json/ManifestListGeneratorTest.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.cloud.tools.jib.image.Image;\n+import java.io.IOException;\n+import java.util.Arrays;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+/** Tests for {@link ManifestListGenerator}. */\n+public class ManifestListGeneratorTest {\n+\n+  private Image image1;\n+  private Image image2;\n+  private ManifestListGenerator manifestListGenerator;\n+\n+  private void setUp(Class<? extends BuildableManifestTemplate> imageFormat) {\n+    image1 = Image.builder(imageFormat).setArchitecture(\"amd64\").setOs(\"linux\").build();\n+    image2 = Image.builder(imageFormat).setArchitecture(\"arm64\").setOs(\"windows\").build();\n+    manifestListGenerator = new ManifestListGenerator(Arrays.asList(image1, image2));\n+  }\n+\n+  @Test\n+  public void testGetManifest_v22() throws IOException {\n+    setUp(V22ManifestTemplate.class);\n+    testGetManifestListTemplate(V22ManifestTemplate.class);\n+  }\n+\n+  /** Tests translation of image to {@link BuildableManifestTemplate}. */\n+  private <T extends BuildableManifestTemplate> void testGetManifestListTemplate(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82408256cfa12b4794fd099a43407efa89e53800"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM4NDE2Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                //  ]\n          \n          \n            \n                //   ]", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472384166", "createdAt": "2020-08-18T18:03:52Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/test/java/com/google/cloud/tools/jib/image/json/ManifestListGeneratorTest.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.cloud.tools.jib.image.Image;\n+import java.io.IOException;\n+import java.util.Arrays;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+/** Tests for {@link ManifestListGenerator}. */\n+public class ManifestListGeneratorTest {\n+\n+  private Image image1;\n+  private Image image2;\n+  private ManifestListGenerator manifestListGenerator;\n+\n+  private void setUp(Class<? extends BuildableManifestTemplate> imageFormat) {\n+    image1 = Image.builder(imageFormat).setArchitecture(\"amd64\").setOs(\"linux\").build();\n+    image2 = Image.builder(imageFormat).setArchitecture(\"arm64\").setOs(\"windows\").build();\n+    manifestListGenerator = new ManifestListGenerator(Arrays.asList(image1, image2));\n+  }\n+\n+  @Test\n+  public void testGetManifest_v22() throws IOException {\n+    setUp(V22ManifestTemplate.class);\n+    testGetManifestListTemplate(V22ManifestTemplate.class);\n+  }\n+\n+  /** Tests translation of image to {@link BuildableManifestTemplate}. */\n+  private <T extends BuildableManifestTemplate> void testGetManifestListTemplate(\n+      Class<T> manifestTemplateClass) throws IOException {\n+\n+    // Expected Manifest List JSON\n+    //  {\n+    // \"schemaVersion\":2,\n+    //  \"mediaType\":\"application/vnd.docker.distribution.manifest.list.v2+json\",\n+    //  \"manifests\":[\n+    //    {\n+    //      \"mediaType\":\"application/vnd.docker.distribution.manifest.v2+json\",\n+    //      \"digest\":\"sha256:1f25787aab4669d252bdae09a72b9c345d2a7b8c64c8dbfba4c82af4834dbccc\",\n+    //      \"size\":264,\n+    //      \"platform\":{\n+    //        \"architecture\":\"amd64\",\n+    //        \"os\":\"linux\"\n+    //      }\n+    //    },\n+    //    {\n+    //      \"mediaType\":\"application/vnd.docker.distribution.manifest.v2+json\",\n+    //      \"digest\":\"sha256:51038a7a91c0e8f747e05dd84c3b0393a7016ec312ce384fc945356778497ae3\",\n+    //      \"size\":264,\n+    //      \"platform\":{\n+    //        \"architecture\":\"arm64\",\n+    //        \"os\":\"windows\"\n+    //      }\n+    //    }\n+    //  ]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82408256cfa12b4794fd099a43407efa89e53800"}, "originalPosition": 71}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07c1d84cd6a153827ebcd123ab41cafead5b5234", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/07c1d84cd6a153827ebcd123ab41cafead5b5234", "committedDate": "2020-08-18T19:15:39Z", "message": "Style Fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NzkxNjEw", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#pullrequestreview-469791610", "createdAt": "2020-08-18T20:04:25Z", "commit": {"oid": "07c1d84cd6a153827ebcd123ab41cafead5b5234"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMDowNDoyNVrOHCkAHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMDowNDoyNVrOHCkAHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ0OTA1Mg==", "bodyText": "Oh, we should consider the boundary condition when images is empty. I think it makes sense to just fail\nPreconditions.checkState(!images.isEmpty(), \"no images given\");\n\nand add a test for this. (It's important to test boundary conditions.) It also makes sense to add the same test in BuildManifestListOrSingleManifestStepTest to see if the exception is properly propagated to that level too.", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472449052", "createdAt": "2020-08-18T20:04:25Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/ManifestListGenerator.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.api.client.util.Preconditions;\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.hash.Digests;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate.ManifestDescriptorTemplate;\n+import java.io.IOException;\n+import java.util.List;\n+\n+/** Generates a manifest list for {@link Image}s. */\n+public class ManifestListGenerator {\n+\n+  private final List<Image> images;\n+\n+  public ManifestListGenerator(List<Image> images) {\n+    this.images = images;\n+  }\n+\n+  /**\n+   * Generates a manifest list JSON for the given {@link Image}s.\n+   *\n+   * @param <T> child type of {@link BuildableManifestTemplate}\n+   * @param manifestTemplateClass the JSON template to translate the image to\n+   * @return a manifest list JSON\n+   * @throws IOException if generating a manifest list fails due to an I/O error when computing\n+   *     digests\n+   */\n+  public <T extends BuildableManifestTemplate> ManifestTemplate getManifestListTemplate(\n+      Class<T> manifestTemplateClass) throws IOException {\n+    Preconditions.checkArgument(\n+        manifestTemplateClass == V22ManifestTemplate.class,\n+        \"Build an OCI image index is not yet supported\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c1d84cd6a153827ebcd123ab41cafead5b5234"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "566e155b17d3ab9394f562bbefc2704c285fb48d", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/566e155b17d3ab9394f562bbefc2704c285fb48d", "committedDate": "2020-08-19T15:05:31Z", "message": "Adding Testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "743933c5f1fe6ec53a371d74191808082c7cd03b", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/743933c5f1fe6ec53a371d74191808082c7cd03b", "committedDate": "2020-08-19T15:35:53Z", "message": "Triggering Tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNjkwNTk3", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#pullrequestreview-470690597", "createdAt": "2020-08-19T17:30:49Z", "commit": {"oid": "743933c5f1fe6ec53a371d74191808082c7cd03b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4961, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}