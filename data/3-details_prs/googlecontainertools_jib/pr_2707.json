{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5NTU3NjU4", "number": 2707, "title": "Prepare JSON template classes for new manifest cache design", "bodyText": "Renaming ManifestAndConfig to ManifestAndConfigTemplate.\n\nThe class is a simple pair of manifest and config. In the new design, it will be used as a JSON template for de-/serialization.\nAs a JSON template, converted Optional<> to @Nullable.\n\n\n\nNew class: ImageMetadataTemplate.\n\nHolds\n\na manifest list (if not Docker schema 1). Can be null (when a base image reference is not a manifest list).\na list of manifest+config pairs (List<ManifestAndConfigTemplate>).\nFor example,\n\n\n\n{\n  \"manifestList\": {  # manifest list content\n    \"@class\": \"com.google.cloud.tools.jib.image.json.V22ManifestListTemplate\",\n    \"manifests\": [ { ... }, { ... }, { ... }, ... ]\n  },\n\n  \"manifestsAndConfigs\": [\n    {\n      \"manifest\": {\n        \"@class\": \"com.google.cloud.tools.jib.image.json.V22ManifestTemplate\",\n        \"schemaVersion\": 2,\n        \"mediaType\": \"application/vnd.docker.distribution.manifest.v2+json\",\n        \"config\": { ... }\n        ...\n      },\n      \"config\": { ... }\n    },\n    { ... },\n    ...\n  ]\n\n\n\nOciImageIndex now inherits ManifestTemplate (previously JsonTemplate). This is to have a slightly more specialized class as a common super class of OciImageIndex and V22ManifestListTemplate.\n\nNote currently ManfiestTemplate is also a super class of OciManifestTemplate, V21ManifestTemplate and V22ManifestTemplate. It does make sense to consider all of these manifest list classes and manifest classes as ManifestTemplate.\n\n\n\n@louismurerwa", "createdAt": "2020-08-18T15:02:40Z", "url": "https://github.com/GoogleContainerTools/jib/pull/2707", "merged": true, "mergeCommit": {"oid": "0a144f7fd382c131fff2dc3d85986e832cd7507e"}, "closed": true, "closedAt": "2020-08-20T14:45:40Z", "author": {"login": "chanseokoh"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAH542AH2gAyNDY5NTU3NjU4OjU5NWJkMTk2MjkyMWY1YjU5ZWE1ZWNmMTA0OWIxMmE2ZTU2MTA4NjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAxKlugFqTQ3MTY3NzI0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "595bd1962921f5b59ea5ecf1049b12a6e5610860", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/595bd1962921f5b59ea5ecf1049b12a6e5610860", "committedDate": "2020-08-18T14:29:48Z", "message": "Add manifest+config cache JSON template"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e2c6bcf688b5df766f6535fd950a7655196a404", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/5e2c6bcf688b5df766f6535fd950a7655196a404", "committedDate": "2020-08-18T14:44:31Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a53417dd8f1fc9808d3b0edae23f2b09001582e0", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/a53417dd8f1fc9808d3b0edae23f2b09001582e0", "committedDate": "2020-08-18T17:36:54Z", "message": "Update code comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMDU4MDIz", "url": "https://github.com/GoogleContainerTools/jib/pull/2707#pullrequestreview-471058023", "createdAt": "2020-08-20T00:56:16Z", "commit": {"oid": "a53417dd8f1fc9808d3b0edae23f2b09001582e0"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMDo1NjoxNlrOHDjhyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMToxMDo1NVrOHDkG1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ4OTg2Ng==", "bodyText": "Do we need to persist a V21 manifest? Don't we do conversions of this to V22?", "url": "https://github.com/GoogleContainerTools/jib/pull/2707#discussion_r473489866", "createdAt": "2020-08-20T00:56:16Z", "author": {"login": "loosebazooka"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/ManifestAndConfigTemplate.java", "diffHunk": "@@ -16,16 +16,32 @@\n \n package com.google.cloud.tools.jib.image.json;\n \n-import java.util.Optional;\n+import com.fasterxml.jackson.annotation.JsonSubTypes;\n+import com.fasterxml.jackson.annotation.JsonTypeInfo;\n+import com.google.cloud.tools.jib.json.JsonTemplate;\n import javax.annotation.Nullable;\n \n /** Stores a manifest and container config. */\n-public class ManifestAndConfig {\n+public class ManifestAndConfigTemplate implements JsonTemplate {\n \n-  private final ManifestTemplate manifest;\n-  @Nullable private final ContainerConfigurationTemplate config;\n+  @JsonTypeInfo(\n+      use = JsonTypeInfo.Id.CLASS,\n+      include = JsonTypeInfo.As.PROPERTY,\n+      property = \"@class\")\n+  @JsonSubTypes({\n+    @JsonSubTypes.Type(value = OciManifestTemplate.class),\n+    @JsonSubTypes.Type(value = V21ManifestTemplate.class),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a53417dd8f1fc9808d3b0edae23f2b09001582e0"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ5OTM0OA==", "bodyText": "It seems strange that we would generate a JsonTemplate type from separately parsed out jsonTemplates? Is this something that we would need to change eventually?\nCan we go directly to ManifestAndConfigTemplate directly from file?", "url": "https://github.com/GoogleContainerTools/jib/pull/2707#discussion_r473499348", "createdAt": "2020-08-20T01:10:55Z", "author": {"login": "loosebazooka"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/cache/CacheStorageReader.java", "diffHunk": "@@ -110,7 +110,7 @@\n \n       if (schemaVersion == 1) {\n         return Optional.of(\n-            new ManifestAndConfig(\n+            new ManifestAndConfigTemplate(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a53417dd8f1fc9808d3b0edae23f2b09001582e0"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxNjc3MjQx", "url": "https://github.com/GoogleContainerTools/jib/pull/2707#pullrequestreview-471677241", "createdAt": "2020-08-20T14:34:09Z", "commit": {"oid": "a53417dd8f1fc9808d3b0edae23f2b09001582e0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4967, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}