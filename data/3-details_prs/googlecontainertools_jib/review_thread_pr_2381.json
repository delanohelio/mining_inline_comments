{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3NzAxMTcx", "number": 2381, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxODo0MTowNVrODuFRFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMzoxMDozOVrODvVoiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5NjQ3MzgyOnYy", "diffSide": "RIGHT", "path": "jib-core/CHANGELOG.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxODo0MTowNVrOF_4mPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxODo0MTowNVrOF_4mPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzMTkwMQ==", "bodyText": "\"... from a tag and digest\"?", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r402531901", "createdAt": "2020-04-02T18:41:05Z", "author": {"login": "chanseokoh"}, "path": "jib-core/CHANGELOG.md", "diffHunk": "@@ -5,7 +5,14 @@ All notable changes to this project will be documented in this file.\n \n ### Added\n \n+- Multiple additions to `ImageReference` to separate `tag` and `digest`. ([#1481](https://github.com/GoogleContainerTools/jib/issues/1481))\n+    - `of(registry, repository, tag, digest)` to create an image from a digest", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1564136ef0bc6769020180e96a63c8f221950646"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5NjQ3ODIzOnYy", "diffSide": "RIGHT", "path": "jib-core/CHANGELOG.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxODo0MjoyNFrOF_4pEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxODo0MjoyNFrOF_4pEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzMjYyNg==", "bodyText": "nit: newline before this line", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r402532626", "createdAt": "2020-04-02T18:42:24Z", "author": {"login": "chanseokoh"}, "path": "jib-core/CHANGELOG.md", "diffHunk": "@@ -5,7 +5,14 @@ All notable changes to this project will be documented in this file.\n \n ### Added\n \n+- Multiple additions to `ImageReference` to separate `tag` and `digest`. ([#1481](https://github.com/GoogleContainerTools/jib/issues/1481))\n+    - `of(registry, repository, tag, digest)` to create an image from a digest\n+    - `isValidDigest(digest)` to check if a string is a valid digest\n+    - `getDigest()` to get the digest\n+    - `parse()` now supports image reference strings containing both a tag and a digest\n+\n ### Changed\n+- `ImageReference#isTagDigest` is now deprecated.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1564136ef0bc6769020180e96a63c8f221950646"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5NjQ5MDM5OnYy", "diffSide": "RIGHT", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "isResolved": true, "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxODo0NTo0M1rOF_4wrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNzoxNzozMlrOGBh8Hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzNDU3NA==", "bodyText": "I think the purpose of this method is to ensure :latest is added. I don't think toString() will add :latest.", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r402534574", "createdAt": "2020-04-02T18:45:43Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -346,6 +387,10 @@ public String toString() {\n    * @return the image reference in Docker-readable format, without hiding the tag\n    */\n   public String toStringWithTag() {\n+    // Insert tag before digest\n+    if (!Strings.isNullOrEmpty(digest)) {\n+      return toString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1564136ef0bc6769020180e96a63c8f221950646"}, "originalPosition": 174}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU0MTIwNg==", "bodyText": "I'll have to check how it's used in the rest of the codebase, but this is used for the offline mode cache directory structure. So if we add \"latest\" here, people may need to repopulate their cache.", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r402541206", "createdAt": "2020-04-02T18:56:47Z", "author": {"login": "TadCordle"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -346,6 +387,10 @@ public String toString() {\n    * @return the image reference in Docker-readable format, without hiding the tag\n    */\n   public String toStringWithTag() {\n+    // Insert tag before digest\n+    if (!Strings.isNullOrEmpty(digest)) {\n+      return toString();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzNDU3NA=="}, "originalCommit": {"oid": "1564136ef0bc6769020180e96a63c8f221950646"}, "originalPosition": 174}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU0OTk2OQ==", "bodyText": "Ugh, the offline manifest caching! So we want this to be more like toStringWithTagOrDigest() where a digest takes precedence, right? The naming is a bit unfortunate. toStringWithTag doesn't make sense and is confusing. Should we just create a new method? I wish we could create an internal-only method for the offline caching.", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r402549969", "createdAt": "2020-04-02T19:11:53Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -346,6 +387,10 @@ public String toString() {\n    * @return the image reference in Docker-readable format, without hiding the tag\n    */\n   public String toStringWithTag() {\n+    // Insert tag before digest\n+    if (!Strings.isNullOrEmpty(digest)) {\n+      return toString();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzNDU3NA=="}, "originalCommit": {"oid": "1564136ef0bc6769020180e96a63c8f221950646"}, "originalPosition": 174}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU4OTEzOA==", "bodyText": "Maybe I'll deprecate this and copy it into a method with a new name. I'm not sure about toStringWithTagOrDigest() though. Is there a word that covers both tag and digest? Maybe toStringWithIdentifier() or something along those lines?", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r402589138", "createdAt": "2020-04-02T20:27:08Z", "author": {"login": "TadCordle"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -346,6 +387,10 @@ public String toString() {\n    * @return the image reference in Docker-readable format, without hiding the tag\n    */\n   public String toStringWithTag() {\n+    // Insert tag before digest\n+    if (!Strings.isNullOrEmpty(digest)) {\n+      return toString();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzNDU3NA=="}, "originalCommit": {"oid": "1564136ef0bc6769020180e96a63c8f221950646"}, "originalPosition": 174}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA0Mzg1OA==", "bodyText": "Whether or not we deprecate this method, I think this method should be updated to fulfill the documented contract so that it returns registry/repository:latest@sha256... when both a tag and a digest are given. Given the name toStringWithTag(), returning registry/repository@sha256... doesn't look right to me.\nI'm struggling with the name for the new method too. I don't think there's a good name to cover both tag and digest. This grammar description may be worth checking, although I don't know where the description came from. At least toStringWithQualifier sounds better than \"identifier\".\nAnyways, maybe we should mark the new method as \"internal\"\u2013the purpose is too specific to our use-case. @loosebazooka had some discussions around how we could add internal methods to our public API, but we couldn't find a good solution. The best I could do was to document it.", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r403043858", "createdAt": "2020-04-03T14:26:33Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -346,6 +387,10 @@ public String toString() {\n    * @return the image reference in Docker-readable format, without hiding the tag\n    */\n   public String toStringWithTag() {\n+    // Insert tag before digest\n+    if (!Strings.isNullOrEmpty(digest)) {\n+      return toString();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzNDU3NA=="}, "originalCommit": {"oid": "1564136ef0bc6769020180e96a63c8f221950646"}, "originalPosition": 174}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA1NDg5Ng==", "bodyText": "Given the name toStringWithTag(), returning registry/repository@sha256... doesn't look right to me.\n\nThe problem is that this was what the old behavior was, regardless of whether or not the naming was correct, since we were treating digests as tags. Is it more important to preserve old behavior in this case or change the behavior to better match the name?", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r403054896", "createdAt": "2020-04-03T14:42:04Z", "author": {"login": "TadCordle"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -346,6 +387,10 @@ public String toString() {\n    * @return the image reference in Docker-readable format, without hiding the tag\n    */\n   public String toStringWithTag() {\n+    // Insert tag before digest\n+    if (!Strings.isNullOrEmpty(digest)) {\n+      return toString();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzNDU3NA=="}, "originalCommit": {"oid": "1564136ef0bc6769020180e96a63c8f221950646"}, "originalPosition": 174}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI1MzA4NQ==", "bodyText": "For preserving the old behavior, we can create a new method, as we have been discussing? In other words, it's basically like we don't touch toStringWithTag() but change the name to something else.\nAnd I think it was really a mistake that we treated digest as \"tag.\" Really, this isn't right. A tag is a tag. Looks like it's about time to make things correct, as we enable both tag and digest. I see a sentence like \"uses a SHA-256 digest as its tag\" or \"When the tag is a digest\" and in Javadocs. They don't make sense. The method isTagDigest doesn't make sense either, so I feel like we should deprecate (rename) it. Given that we will now treat tag and digest differently in the constructor, which surfaces our mishandling of these elements, I think it is important to have consistency and correctness.\nWDYT?", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r403253085", "createdAt": "2020-04-03T19:07:30Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -346,6 +387,10 @@ public String toString() {\n    * @return the image reference in Docker-readable format, without hiding the tag\n    */\n   public String toStringWithTag() {\n+    // Insert tag before digest\n+    if (!Strings.isNullOrEmpty(digest)) {\n+      return toString();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzNDU3NA=="}, "originalCommit": {"oid": "1564136ef0bc6769020180e96a63c8f221950646"}, "originalPosition": 174}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI1NzgyMg==", "bodyText": "Ok, I think given jib-core still isn't GA, we can just rename the method now instead of having to deprecate.", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r404257822", "createdAt": "2020-04-06T17:17:32Z", "author": {"login": "TadCordle"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -346,6 +387,10 @@ public String toString() {\n    * @return the image reference in Docker-readable format, without hiding the tag\n    */\n   public String toStringWithTag() {\n+    // Insert tag before digest\n+    if (!Strings.isNullOrEmpty(digest)) {\n+      return toString();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzNDU3NA=="}, "originalCommit": {"oid": "1564136ef0bc6769020180e96a63c8f221950646"}, "originalPosition": 174}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5NjQ5NTI1OnYy", "diffSide": "RIGHT", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxODo0NzowOVrOF_4zwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxODo1NzoyN1rOF_5MAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzNTM2MQ==", "bodyText": "I know digest is of Optional, but is this different from digest.equals(otherImageReference.digest)?", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r402535361", "createdAt": "2020-04-02T18:47:09Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -360,11 +405,12 @@ public boolean equals(Object other) {\n     ImageReference otherImageReference = (ImageReference) other;\n     return registry.equals(otherImageReference.registry)\n         && repository.equals(otherImageReference.repository)\n-        && tag.equals(otherImageReference.tag);\n+        && tag.equals(otherImageReference.tag)\n+        && Objects.equals(digest, otherImageReference.digest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1564136ef0bc6769020180e96a63c8f221950646"}, "originalPosition": 185}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU0MTU2OA==", "bodyText": "digest is a @Nullable string, so Objects.equals is used here to avoid NPE", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r402541568", "createdAt": "2020-04-02T18:57:27Z", "author": {"login": "TadCordle"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -360,11 +405,12 @@ public boolean equals(Object other) {\n     ImageReference otherImageReference = (ImageReference) other;\n     return registry.equals(otherImageReference.registry)\n         && repository.equals(otherImageReference.repository)\n-        && tag.equals(otherImageReference.tag);\n+        && tag.equals(otherImageReference.tag)\n+        && Objects.equals(digest, otherImageReference.digest);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzNTM2MQ=="}, "originalCommit": {"oid": "1564136ef0bc6769020180e96a63c8f221950646"}, "originalPosition": 185}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5NjUxMzcxOnYy", "diffSide": "RIGHT", "path": "jib-gradle-plugin/CHANGELOG.md", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxODo1MjowN1rOF_4_iA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMzoxNToyMlrOGBtTug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzODM3Ng==", "bodyText": "I'm curious how Jib will work and respond if there's an error for a base image, e.g.,\n\ntag exists but digest doesn't match\ndigest exists but tag doesn't\n\nWill they work? If they fail, will the error message make sense and be helpful?", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r402538376", "createdAt": "2020-04-02T18:52:07Z", "author": {"login": "chanseokoh"}, "path": "jib-gradle-plugin/CHANGELOG.md", "diffHunk": "@@ -6,6 +6,7 @@ All notable changes to this project will be documented in this file.\n ### Added\n \n - Glob pattern support for `jib.extraDirectories.permissions`. ([#1200](https://github.com/GoogleContainerTools/jib/issues/1200))\n+- Support for image references with both a tag and a digest. ([#1481](https://github.com/GoogleContainerTools/jib/issues/1481))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1564136ef0bc6769020180e96a63c8f221950646"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU2MTY5MQ==", "bodyText": "I can test to be sure, but what I think happens is:\n\ntag exists but digest doesn't match - this will cause of() to fail since it does a Preconditions check on the format of the tag and digest, and parse should throw an InvalidImageReferenceException since the regex won't match\ndigest exists but tag doesn't - this will succeed, I modified the test to loop through every combination of registry/repository/tag/digest we have instead of separating tag and digest, which means it covers null tag + existent digest.", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r402561691", "createdAt": "2020-04-02T19:32:58Z", "author": {"login": "TadCordle"}, "path": "jib-gradle-plugin/CHANGELOG.md", "diffHunk": "@@ -6,6 +6,7 @@ All notable changes to this project will be documented in this file.\n ### Added\n \n - Glob pattern support for `jib.extraDirectories.permissions`. ([#1200](https://github.com/GoogleContainerTools/jib/issues/1200))\n+- Support for image references with both a tag and a digest. ([#1481](https://github.com/GoogleContainerTools/jib/issues/1481))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzODM3Ng=="}, "originalCommit": {"oid": "1564136ef0bc6769020180e96a63c8f221950646"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU2NzczMw==", "bodyText": "Sorry, I should have been clear: I am talking about referring a base image in a remote registry. For example, I say <from><image>openjdk:8@sha256:aaaaaa... </image></from> (i.e., the digest sha256:aaaa... is not the right digest of the actual openjdk:8 image.", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r402567733", "createdAt": "2020-04-02T19:44:12Z", "author": {"login": "chanseokoh"}, "path": "jib-gradle-plugin/CHANGELOG.md", "diffHunk": "@@ -6,6 +6,7 @@ All notable changes to this project will be documented in this file.\n ### Added\n \n - Glob pattern support for `jib.extraDirectories.permissions`. ([#1200](https://github.com/GoogleContainerTools/jib/issues/1200))\n+- Support for image references with both a tag and a digest. ([#1481](https://github.com/GoogleContainerTools/jib/issues/1481))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzODM3Ng=="}, "originalCommit": {"oid": "1564136ef0bc6769020180e96a63c8f221950646"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0NDA5MA==", "bodyText": "I'd like to check this behavior.", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r404444090", "createdAt": "2020-04-06T23:15:22Z", "author": {"login": "chanseokoh"}, "path": "jib-gradle-plugin/CHANGELOG.md", "diffHunk": "@@ -6,6 +6,7 @@ All notable changes to this project will be documented in this file.\n ### Added\n \n - Glob pattern support for `jib.extraDirectories.permissions`. ([#1200](https://github.com/GoogleContainerTools/jib/issues/1200))\n+- Support for image references with both a tag and a digest. ([#1481](https://github.com/GoogleContainerTools/jib/issues/1481))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzODM3Ng=="}, "originalCommit": {"oid": "1564136ef0bc6769020180e96a63c8f221950646"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwOTYwNTg0OnYy", "diffSide": "RIGHT", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMjo1NjowMFrOGBs4JQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMjo1NjowMFrOGBs4JQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQzNzAyOQ==", "bodyText": "I think we should call this qualifier, considering the new constructor that accepts both tag and digest. I am OK with tagOrDigest too. And the doc could be \"the image tag, digest, or null to use the default tag latest\". We can then remove the part \"If tag is a valid digest string...\". I really think we should not call a digest \"tag\".", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r404437029", "createdAt": "2020-04-06T22:56:00Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -157,22 +151,42 @@ public static ImageReference parse(String reference) throws InvalidImageReferenc\n    *\n    * @param registry the image registry, or {@code null} to use the default registry (Docker Hub)\n    * @param repository the image repository\n-   * @param tag the image tag, or {@code null} to use the default tag ({@code latest})\n+   * @param tag the image tag, or {@code null} to use the default tag ({@code latest}). If {@code", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7636641ec50195b638633c441451b3d428a3b4e4"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwOTYxMTczOnYy", "diffSide": "RIGHT", "path": "jib-core/CHANGELOG.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMjo1ODo1MVrOGBs7xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMjo1ODo1MVrOGBs7xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQzNzk1OQ==", "bodyText": "isValidTag has changed its behavior too.", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r404437959", "createdAt": "2020-04-06T22:58:51Z", "author": {"login": "chanseokoh"}, "path": "jib-core/CHANGELOG.md", "diffHunk": "@@ -5,8 +5,17 @@ All notable changes to this project will be documented in this file.\n \n ### Added\n \n+- Multiple additions to `ImageReference` to separate `tag` and `digest`. ([#1481](https://github.com/GoogleContainerTools/jib/issues/1481))\n+    - `of(registry, repository, tag, digest)` to create an image from a tag and digest.\n+    - `isValidDigest(digest)` to check if a string is a valid digest.\n+    - `getDigest()` to get the digest.\n+    - `parse()` now supports image reference strings containing both a tag and a digest.\n+\n ### Changed\n \n+- `ImageReference#toStringWithTag` has been renamed to `toStringWithQualifier`.\n+- `ImageReference#isTagDigest` has been removed; use `#getDigest` with `Optional#isPresent()` to check if an `ImageReference` uses a digest.\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7636641ec50195b638633c441451b3d428a3b4e4"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwOTYyNDE4OnYy", "diffSide": "RIGHT", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMzowMzozOFrOGBtDMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMzowMzozOFrOGBtDMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQzOTg1OQ==", "bodyText": "I actually think we can call of(registry, repository, tag, digest) here and get rid of some if checks in this method, as parse() and of() duplicate some logic. But let's not touch this method anymore in this PR to be on the safe side.", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r404439859", "createdAt": "2020-04-06T23:03:38Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -137,18 +138,11 @@ public static ImageReference parse(String reference) throws InvalidImageReferenc\n       repository = LIBRARY_REPOSITORY_PREFIX + repository;\n     }\n \n-    if (!Strings.isNullOrEmpty(tag)) {\n-      if (!Strings.isNullOrEmpty(digest)) {\n-        // Cannot have matched both tag and digest.\n-        throw new InvalidImageReferenceException(reference);\n-      }\n-    } else if (!Strings.isNullOrEmpty(digest)) {\n-      tag = digest;\n-    } else {\n+    if (Strings.isNullOrEmpty(tag)) {\n       tag = DEFAULT_TAG;\n     }\n \n-    return new ImageReference(registry, repository, tag);\n+    return new ImageReference(registry, repository, tag, digest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7636641ec50195b638633c441451b3d428a3b4e4"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwOTYzMjAyOnYy", "diffSide": "RIGHT", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMzowNjo0NFrOGBtHxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMzowNjo0NFrOGBtHxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0MTAyOA==", "bodyText": "Remove this comment.\nBTW, I think it is correct that this method prints both a (non-default) tag and a digest.", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r404441028", "createdAt": "2020-04-06T23:06:44Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -334,18 +360,27 @@ public String toString() {\n     // Use tag if not the default tag.\n     if (!DEFAULT_TAG.equals(tag)) {\n       // Append with \"@tag\" instead of \":tag\" if tag is a digest", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7636641ec50195b638633c441451b3d428a3b4e4"}, "originalPosition": 164}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwOTY0MTA3OnYy", "diffSide": "RIGHT", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "isResolved": false, "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMzoxMDozOVrOGBtNHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxODoxMjo0N1rOGCQFjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0MjM5OA==", "bodyText": "Hmm... so if both a digest and a non-default tag are given, now toStringWithQualifier() will print both. Are we good with that?", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r404442398", "createdAt": "2020-04-06T23:10:39Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -334,18 +360,27 @@ public String toString() {\n     // Use tag if not the default tag.\n     if (!DEFAULT_TAG.equals(tag)) {\n       // Append with \"@tag\" instead of \":tag\" if tag is a digest\n-      referenceString.append(isTagDigest() ? '@' : ':').append(tag);\n+      referenceString.append(':').append(tag);\n+    }\n+\n+    if (!Strings.isNullOrEmpty(digest)) {\n+      referenceString.append('@').append(digest);\n     }\n \n     return referenceString.toString();\n   }\n \n   /**\n-   * Stringifies the {@link ImageReference}, without hiding the tag.\n+   * Stringifies the {@link ImageReference}, including the default tag if no tag or digest is set.\n    *\n-   * @return the image reference in Docker-readable format, without hiding the tag\n+   * @return the image reference in Docker-readable format, including the default tag if no tag or\n+   *     digest is set.\n    */\n-  public String toStringWithTag() {\n+  public String toStringWithQualifier() {\n+    // Insert tag before digest\n+    if (!Strings.isNullOrEmpty(digest)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7636641ec50195b638633c441451b3d428a3b4e4"}, "originalPosition": 187}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg5NDAzMQ==", "bodyText": "Yes, I think this is correct.", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r404894031", "createdAt": "2020-04-07T15:19:41Z", "author": {"login": "TadCordle"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -334,18 +360,27 @@ public String toString() {\n     // Use tag if not the default tag.\n     if (!DEFAULT_TAG.equals(tag)) {\n       // Append with \"@tag\" instead of \":tag\" if tag is a digest\n-      referenceString.append(isTagDigest() ? '@' : ':').append(tag);\n+      referenceString.append(':').append(tag);\n+    }\n+\n+    if (!Strings.isNullOrEmpty(digest)) {\n+      referenceString.append('@').append(digest);\n     }\n \n     return referenceString.toString();\n   }\n \n   /**\n-   * Stringifies the {@link ImageReference}, without hiding the tag.\n+   * Stringifies the {@link ImageReference}, including the default tag if no tag or digest is set.\n    *\n-   * @return the image reference in Docker-readable format, without hiding the tag\n+   * @return the image reference in Docker-readable format, including the default tag if no tag or\n+   *     digest is set.\n    */\n-  public String toStringWithTag() {\n+  public String toStringWithQualifier() {\n+    // Insert tag before digest\n+    if (!Strings.isNullOrEmpty(digest)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0MjM5OA=="}, "originalCommit": {"oid": "7636641ec50195b638633c441451b3d428a3b4e4"}, "originalPosition": 187}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkxMjQ3NQ==", "bodyText": "Just confirming: if so (e.g., returning image:sometag@sha256...), isn't it more natural for this method to consistently return image:latest@sha256... when the tag is latest? Currently, it returns image@sha256.... But if the intention is to make it return at least a tag or a digest, I can live with that. However, it's hard to predict the behavior just by reading the Javadoc.", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r404912475", "createdAt": "2020-04-07T15:43:03Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -334,18 +360,27 @@ public String toString() {\n     // Use tag if not the default tag.\n     if (!DEFAULT_TAG.equals(tag)) {\n       // Append with \"@tag\" instead of \":tag\" if tag is a digest\n-      referenceString.append(isTagDigest() ? '@' : ':').append(tag);\n+      referenceString.append(':').append(tag);\n+    }\n+\n+    if (!Strings.isNullOrEmpty(digest)) {\n+      referenceString.append('@').append(digest);\n     }\n \n     return referenceString.toString();\n   }\n \n   /**\n-   * Stringifies the {@link ImageReference}, without hiding the tag.\n+   * Stringifies the {@link ImageReference}, including the default tag if no tag or digest is set.\n    *\n-   * @return the image reference in Docker-readable format, without hiding the tag\n+   * @return the image reference in Docker-readable format, including the default tag if no tag or\n+   *     digest is set.\n    */\n-  public String toStringWithTag() {\n+  public String toStringWithQualifier() {\n+    // Insert tag before digest\n+    if (!Strings.isNullOrEmpty(digest)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0MjM5OA=="}, "originalCommit": {"oid": "7636641ec50195b638633c441451b3d428a3b4e4"}, "originalPosition": 187}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkyMzU5OQ==", "bodyText": "Yes, this is intended. Maybe always returning a tag would be more consistent, but again this is used in offline mode and we don't want to start returning image:latest@sha256 or people will need to repopulate the cache.\nimage:sometag@sha256 wasn't possible before this PR, so in this case we could go either way. Maybe digest should just take precedence over tag instead of returning both?", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r404923599", "createdAt": "2020-04-07T15:57:40Z", "author": {"login": "TadCordle"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -334,18 +360,27 @@ public String toString() {\n     // Use tag if not the default tag.\n     if (!DEFAULT_TAG.equals(tag)) {\n       // Append with \"@tag\" instead of \":tag\" if tag is a digest\n-      referenceString.append(isTagDigest() ? '@' : ':').append(tag);\n+      referenceString.append(':').append(tag);\n+    }\n+\n+    if (!Strings.isNullOrEmpty(digest)) {\n+      referenceString.append('@').append(digest);\n     }\n \n     return referenceString.toString();\n   }\n \n   /**\n-   * Stringifies the {@link ImageReference}, without hiding the tag.\n+   * Stringifies the {@link ImageReference}, including the default tag if no tag or digest is set.\n    *\n-   * @return the image reference in Docker-readable format, without hiding the tag\n+   * @return the image reference in Docker-readable format, including the default tag if no tag or\n+   *     digest is set.\n    */\n-  public String toStringWithTag() {\n+  public String toStringWithQualifier() {\n+    // Insert tag before digest\n+    if (!Strings.isNullOrEmpty(digest)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0MjM5OA=="}, "originalCommit": {"oid": "7636641ec50195b638633c441451b3d428a3b4e4"}, "originalPosition": 187}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk1MTk3OA==", "bodyText": "Maybe digest should just take precedence over tag instead of returning both?\n\nI actually liked this. That is, this method appends a digest (image@sha256) if (and only if) it's set; otherwise, it appends a tag, including latest.\nThat said, I just realized some issue with our assumption with latest. It is indeed true that latest is assumed when no tag or digest is given. And so tar, we were okay, as it was not possible to have a digest and a tag at the same time. But what if the user simply referred to a base image only by a digest? In many cases, on an actual repository, the manifest would not be attached a latest tag. The question is then, would it make sense for toString() to append an unwarranted :latest that is possibly incorrect in practice? Perhaps if a digest is given but not a tag, we shouldn't assume the tag is latest?", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r404951978", "createdAt": "2020-04-07T16:36:51Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -334,18 +360,27 @@ public String toString() {\n     // Use tag if not the default tag.\n     if (!DEFAULT_TAG.equals(tag)) {\n       // Append with \"@tag\" instead of \":tag\" if tag is a digest\n-      referenceString.append(isTagDigest() ? '@' : ':').append(tag);\n+      referenceString.append(':').append(tag);\n+    }\n+\n+    if (!Strings.isNullOrEmpty(digest)) {\n+      referenceString.append('@').append(digest);\n     }\n \n     return referenceString.toString();\n   }\n \n   /**\n-   * Stringifies the {@link ImageReference}, without hiding the tag.\n+   * Stringifies the {@link ImageReference}, including the default tag if no tag or digest is set.\n    *\n-   * @return the image reference in Docker-readable format, without hiding the tag\n+   * @return the image reference in Docker-readable format, including the default tag if no tag or\n+   *     digest is set.\n    */\n-  public String toStringWithTag() {\n+  public String toStringWithQualifier() {\n+    // Insert tag before digest\n+    if (!Strings.isNullOrEmpty(digest)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0MjM5OA=="}, "originalCommit": {"oid": "7636641ec50195b638633c441451b3d428a3b4e4"}, "originalPosition": 187}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk1NzE5Nw==", "bodyText": "In that case should tag be null if a digest is set? Seems like it will need more changes outside of this method.", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r404957197", "createdAt": "2020-04-07T16:44:38Z", "author": {"login": "TadCordle"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -334,18 +360,27 @@ public String toString() {\n     // Use tag if not the default tag.\n     if (!DEFAULT_TAG.equals(tag)) {\n       // Append with \"@tag\" instead of \":tag\" if tag is a digest\n-      referenceString.append(isTagDigest() ? '@' : ':').append(tag);\n+      referenceString.append(':').append(tag);\n+    }\n+\n+    if (!Strings.isNullOrEmpty(digest)) {\n+      referenceString.append('@').append(digest);\n     }\n \n     return referenceString.toString();\n   }\n \n   /**\n-   * Stringifies the {@link ImageReference}, without hiding the tag.\n+   * Stringifies the {@link ImageReference}, including the default tag if no tag or digest is set.\n    *\n-   * @return the image reference in Docker-readable format, without hiding the tag\n+   * @return the image reference in Docker-readable format, including the default tag if no tag or\n+   *     digest is set.\n    */\n-  public String toStringWithTag() {\n+  public String toStringWithQualifier() {\n+    // Insert tag before digest\n+    if (!Strings.isNullOrEmpty(digest)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0MjM5OA=="}, "originalCommit": {"oid": "7636641ec50195b638633c441451b3d428a3b4e4"}, "originalPosition": 187}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk5NzE3NA==", "bodyText": "Agreed. I'm more convinced that latest is the default value only when nothing is given. When a digest is given, it doesn't make sense to add latest.", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r404997174", "createdAt": "2020-04-07T17:45:52Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -334,18 +360,27 @@ public String toString() {\n     // Use tag if not the default tag.\n     if (!DEFAULT_TAG.equals(tag)) {\n       // Append with \"@tag\" instead of \":tag\" if tag is a digest\n-      referenceString.append(isTagDigest() ? '@' : ':').append(tag);\n+      referenceString.append(':').append(tag);\n+    }\n+\n+    if (!Strings.isNullOrEmpty(digest)) {\n+      referenceString.append('@').append(digest);\n     }\n \n     return referenceString.toString();\n   }\n \n   /**\n-   * Stringifies the {@link ImageReference}, without hiding the tag.\n+   * Stringifies the {@link ImageReference}, including the default tag if no tag or digest is set.\n    *\n-   * @return the image reference in Docker-readable format, without hiding the tag\n+   * @return the image reference in Docker-readable format, including the default tag if no tag or\n+   *     digest is set.\n    */\n-  public String toStringWithTag() {\n+  public String toStringWithQualifier() {\n+    // Insert tag before digest\n+    if (!Strings.isNullOrEmpty(digest)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0MjM5OA=="}, "originalCommit": {"oid": "7636641ec50195b638633c441451b3d428a3b4e4"}, "originalPosition": 187}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk5OTUxNQ==", "bodyText": "Ok. Do you think we should make tag null when the digest is set in this PR, or wait for a followup? I'm not yet sure how many extra changes making tag nullable might involve.", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r404999515", "createdAt": "2020-04-07T17:49:38Z", "author": {"login": "TadCordle"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -334,18 +360,27 @@ public String toString() {\n     // Use tag if not the default tag.\n     if (!DEFAULT_TAG.equals(tag)) {\n       // Append with \"@tag\" instead of \":tag\" if tag is a digest\n-      referenceString.append(isTagDigest() ? '@' : ':').append(tag);\n+      referenceString.append(':').append(tag);\n+    }\n+\n+    if (!Strings.isNullOrEmpty(digest)) {\n+      referenceString.append('@').append(digest);\n     }\n \n     return referenceString.toString();\n   }\n \n   /**\n-   * Stringifies the {@link ImageReference}, without hiding the tag.\n+   * Stringifies the {@link ImageReference}, including the default tag if no tag or digest is set.\n    *\n-   * @return the image reference in Docker-readable format, without hiding the tag\n+   * @return the image reference in Docker-readable format, including the default tag if no tag or\n+   *     digest is set.\n    */\n-  public String toStringWithTag() {\n+  public String toStringWithQualifier() {\n+    // Insert tag before digest\n+    if (!Strings.isNullOrEmpty(digest)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0MjM5OA=="}, "originalCommit": {"oid": "7636641ec50195b638633c441451b3d428a3b4e4"}, "originalPosition": 187}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAwNjY2NQ==", "bodyText": "If you are committed to fix all these in a quick succession, I am fine with a follow-up. At least it should be fixed before we can make a new release. Do you think this PR is ready for merging?", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r405006665", "createdAt": "2020-04-07T18:00:55Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -334,18 +360,27 @@ public String toString() {\n     // Use tag if not the default tag.\n     if (!DEFAULT_TAG.equals(tag)) {\n       // Append with \"@tag\" instead of \":tag\" if tag is a digest\n-      referenceString.append(isTagDigest() ? '@' : ':').append(tag);\n+      referenceString.append(':').append(tag);\n+    }\n+\n+    if (!Strings.isNullOrEmpty(digest)) {\n+      referenceString.append('@').append(digest);\n     }\n \n     return referenceString.toString();\n   }\n \n   /**\n-   * Stringifies the {@link ImageReference}, without hiding the tag.\n+   * Stringifies the {@link ImageReference}, including the default tag if no tag or digest is set.\n    *\n-   * @return the image reference in Docker-readable format, without hiding the tag\n+   * @return the image reference in Docker-readable format, including the default tag if no tag or\n+   *     digest is set.\n    */\n-  public String toStringWithTag() {\n+  public String toStringWithQualifier() {\n+    // Insert tag before digest\n+    if (!Strings.isNullOrEmpty(digest)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0MjM5OA=="}, "originalCommit": {"oid": "7636641ec50195b638633c441451b3d428a3b4e4"}, "originalPosition": 187}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAwNzYxMw==", "bodyText": "I haven't checked this yet, but other than that, yeah I think it's ready.", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r405007613", "createdAt": "2020-04-07T18:02:23Z", "author": {"login": "TadCordle"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -334,18 +360,27 @@ public String toString() {\n     // Use tag if not the default tag.\n     if (!DEFAULT_TAG.equals(tag)) {\n       // Append with \"@tag\" instead of \":tag\" if tag is a digest\n-      referenceString.append(isTagDigest() ? '@' : ':').append(tag);\n+      referenceString.append(':').append(tag);\n+    }\n+\n+    if (!Strings.isNullOrEmpty(digest)) {\n+      referenceString.append('@').append(digest);\n     }\n \n     return referenceString.toString();\n   }\n \n   /**\n-   * Stringifies the {@link ImageReference}, without hiding the tag.\n+   * Stringifies the {@link ImageReference}, including the default tag if no tag or digest is set.\n    *\n-   * @return the image reference in Docker-readable format, without hiding the tag\n+   * @return the image reference in Docker-readable format, including the default tag if no tag or\n+   *     digest is set.\n    */\n-  public String toStringWithTag() {\n+  public String toStringWithQualifier() {\n+    // Insert tag before digest\n+    if (!Strings.isNullOrEmpty(digest)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0MjM5OA=="}, "originalCommit": {"oid": "7636641ec50195b638633c441451b3d428a3b4e4"}, "originalPosition": 187}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAxMzkwMA==", "bodyText": "Alright. I think checking that also depends on how we assume latest, so we can check it in a follow-up.", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r405013900", "createdAt": "2020-04-07T18:12:47Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -334,18 +360,27 @@ public String toString() {\n     // Use tag if not the default tag.\n     if (!DEFAULT_TAG.equals(tag)) {\n       // Append with \"@tag\" instead of \":tag\" if tag is a digest\n-      referenceString.append(isTagDigest() ? '@' : ':').append(tag);\n+      referenceString.append(':').append(tag);\n+    }\n+\n+    if (!Strings.isNullOrEmpty(digest)) {\n+      referenceString.append('@').append(digest);\n     }\n \n     return referenceString.toString();\n   }\n \n   /**\n-   * Stringifies the {@link ImageReference}, without hiding the tag.\n+   * Stringifies the {@link ImageReference}, including the default tag if no tag or digest is set.\n    *\n-   * @return the image reference in Docker-readable format, without hiding the tag\n+   * @return the image reference in Docker-readable format, including the default tag if no tag or\n+   *     digest is set.\n    */\n-  public String toStringWithTag() {\n+  public String toStringWithQualifier() {\n+    // Insert tag before digest\n+    if (!Strings.isNullOrEmpty(digest)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0MjM5OA=="}, "originalCommit": {"oid": "7636641ec50195b638633c441451b3d428a3b4e4"}, "originalPosition": 187}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 352, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}