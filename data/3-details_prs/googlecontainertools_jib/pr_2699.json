{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2OTY4OTY1", "number": 2699, "title": "Fix child progress dispatcher factory", "bodyText": "This PR fixes the java.lang.IllegalStateException resulting from the multiple use of a single progress dispatcher factory.", "createdAt": "2020-08-12T19:41:38Z", "url": "https://github.com/GoogleContainerTools/jib/pull/2699", "merged": true, "mergeCommit": {"oid": "3ba06f929cb1e6a77603d13f220c5d77d869aa78"}, "closed": true, "closedAt": "2020-08-13T15:15:10Z", "author": {"login": "louismurerwa"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-QtzlAH2gAyNDY2OTY4OTY1Ojc3Yjk4N2NjNzY4ZTU0M2ZiZjkzMmVjZTEyZTk5MjYzYTYxYjM5MTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-hceCgFqTQ2Njg1NDE2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "77b987cc768e543fbf932ece12e99263a61b3919", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/77b987cc768e543fbf932ece12e99263a61b3919", "committedDate": "2020-08-12T19:37:54Z", "message": "Fixing concurrent progress dispatcher"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fd2b8d530c956ea4814989aff77ae250d219eae", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/7fd2b8d530c956ea4814989aff77ae250d219eae", "committedDate": "2020-08-12T19:39:22Z", "message": "Fixing progress reporting pullBaseimageLayer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8011fadccacc0f30e3e0549edfbfda4b8936b909", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/8011fadccacc0f30e3e0549edfbfda4b8936b909", "committedDate": "2020-08-12T19:44:02Z", "message": "Fixing Style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "616b5a3198cc91d79e589297b14e76882cc5baa2", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/616b5a3198cc91d79e589297b14e76882cc5baa2", "committedDate": "2020-08-12T19:46:29Z", "message": "Removing un-related changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MjI3Mzg4", "url": "https://github.com/GoogleContainerTools/jib/pull/2699#pullrequestreview-466227388", "createdAt": "2020-08-12T19:55:58Z", "commit": {"oid": "616b5a3198cc91d79e589297b14e76882cc5baa2"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxOTo1NTo1OFrOG_wRNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxOTo1Njo0NVrOG_wS5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUwNDMxMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                  \"scheduling pushing base image layers\",\n          \n          \n            \n                                  \"scheduling obtaining base image layers\",", "url": "https://github.com/GoogleContainerTools/jib/pull/2699#discussion_r469504311", "createdAt": "2020-08-12T19:55:58Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -304,22 +304,28 @@ private void pullBaseImages() {\n   private void obtainBaseImageLayers(boolean layersRequiredLocally) {\n     ProgressEventDispatcher.Factory childProgressDispatcherFactory =\n         Verify.verifyNotNull(rootProgressDispatcher).newChildProducer();\n+\n     results.baseImagesAndLayers =\n         executorService.submit(\n             () -> {\n+              ProgressEventDispatcher progressDispatcher =\n+                  childProgressDispatcherFactory.create(\n+                      \"scheduling pushing base image layers\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "616b5a3198cc91d79e589297b14e76882cc5baa2"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUwNDc0Mw==", "bodyText": "You are looping over baseImagesAndRegistryClient. The allocation for this ProgressEventDispatcher should match the number of times newChildProducer() will be called.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                  results.baseImagesAndLayers.get().size());\n          \n          \n            \n                                  results.baseImagesAndRegistryClient.get().size());", "url": "https://github.com/GoogleContainerTools/jib/pull/2699#discussion_r469504743", "createdAt": "2020-08-12T19:56:45Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -304,22 +304,28 @@ private void pullBaseImages() {\n   private void obtainBaseImageLayers(boolean layersRequiredLocally) {\n     ProgressEventDispatcher.Factory childProgressDispatcherFactory =\n         Verify.verifyNotNull(rootProgressDispatcher).newChildProducer();\n+\n     results.baseImagesAndLayers =\n         executorService.submit(\n             () -> {\n+              ProgressEventDispatcher progressDispatcher =\n+                  childProgressDispatcherFactory.create(\n+                      \"scheduling pushing base image layers\",\n+                      results.baseImagesAndLayers.get().size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "616b5a3198cc91d79e589297b14e76882cc5baa2"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MjM4NjQz", "url": "https://github.com/GoogleContainerTools/jib/pull/2699#pullrequestreview-466238643", "createdAt": "2020-08-12T20:13:33Z", "commit": {"oid": "616b5a3198cc91d79e589297b14e76882cc5baa2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQyMDoxMzozM1rOG_wz0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQyMDoxMzozM1rOG_wz0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUxMzE3MQ==", "bodyText": "This is a temporary workaround to overcome the runtime failure. But I can accept this to move forward. Eventually, we should implement a permanent fix. Please keep track of this issue too.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          ProgressEventDispatcher progressDispatcher =\n          \n          \n            \n                          // TODO: ideally, progressDispatcher should be closed at the right moment, after the scheduled threads have completed. However, it can be tricky and cumbersome to track completion, so it may just be better to delay closing until everything ends. At least, we must ensure that it's not closed prematurely. (Garbage collection doesn't auto-close it wit the current implementation.)\n          \n          \n            \n                          ProgressEventDispatcher progressDispatcher =", "url": "https://github.com/GoogleContainerTools/jib/pull/2699#discussion_r469513171", "createdAt": "2020-08-12T20:13:33Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -304,22 +304,28 @@ private void pullBaseImages() {\n   private void obtainBaseImageLayers(boolean layersRequiredLocally) {\n     ProgressEventDispatcher.Factory childProgressDispatcherFactory =\n         Verify.verifyNotNull(rootProgressDispatcher).newChildProducer();\n+\n     results.baseImagesAndLayers =\n         executorService.submit(\n             () -> {\n+              ProgressEventDispatcher progressDispatcher =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "616b5a3198cc91d79e589297b14e76882cc5baa2"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61134225fd03fa94711697635ab8227b17ca88d5", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/61134225fd03fa94711697635ab8227b17ca88d5", "committedDate": "2020-08-12T22:05:24Z", "message": "Add multiple pregress dispatchers for concuireent processes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MzIyMzIx", "url": "https://github.com/GoogleContainerTools/jib/pull/2699#pullrequestreview-466322321", "createdAt": "2020-08-12T22:33:53Z", "commit": {"oid": "61134225fd03fa94711697635ab8227b17ca88d5"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQyMjozMzo1NFrOG_1IvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQyMjozNDo1NVrOG_1KVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU4NDA2MQ==", "bodyText": "\"building manifests\" sounds more informative to the user.", "url": "https://github.com/GoogleContainerTools/jib/pull/2699#discussion_r469584061", "createdAt": "2020-08-12T22:33:54Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -377,6 +392,15 @@ private void buildImages() {\n     results.builtImagesAndBaseImages =\n         executorService.submit(\n             () -> {\n+              // TODO: ideally, progressDispatcher should be closed at the right moment, after the\n+              // scheduled threads have completed. However, it can be tricky and cumbersome to track\n+              // completion, so it may just be better to delay closing until everything ends. At\n+              // least, we must ensure that it's not closed prematurely. (Garbage collection doesn't\n+              // auto-close it wit the current implementation.)\n+              ProgressEventDispatcher progressDispatcher =\n+                  childProgressDispatcherFactory.create(\n+                      \"scheduling building images\", results.baseImagesAndLayers.get().size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61134225fd03fa94711697635ab8227b17ca88d5"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU4NDE5NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                  results.builtImagesAndBaseImages.get().keySet().size());\n          \n          \n            \n                                  results.builtImagesAndBaseImages.get().size());", "url": "https://github.com/GoogleContainerTools/jib/pull/2699#discussion_r469584195", "createdAt": "2020-08-12T22:34:16Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -404,14 +428,24 @@ private void pushContainerConfigurations() {\n     results.builtImagesAndContainerConfigurationPushResults =\n         executorService.submit(\n             () -> {\n+              // TODO: ideally, progressDispatcher should be closed at the right moment, after the\n+              // scheduled threads have completed. However, it can be tricky and cumbersome to track\n+              // completion, so it may just be better to delay closing until everything ends. At\n+              // least, we must ensure that it's not closed prematurely. (Garbage collection doesn't\n+              // auto-close it wit the current implementation.)\n+              ProgressEventDispatcher progressDispatcher =\n+                  childProgressDispatcherFactory.create(\n+                      \"scheduling pushing container configurations\",\n+                      results.builtImagesAndBaseImages.get().keySet().size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61134225fd03fa94711697635ab8227b17ca88d5"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU4NDI4NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                  results.builtImagesAndBaseImages.get().keySet().size());\n          \n          \n            \n                                  results.builtImagesAndBaseImages.get().size());", "url": "https://github.com/GoogleContainerTools/jib/pull/2699#discussion_r469584285", "createdAt": "2020-08-12T22:34:30Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -465,13 +499,24 @@ private void pushImages() {\n     results.buildResults =\n         executorService.submit(\n             () -> {\n+              // TODO: ideally, progressDispatcher should be closed at the right moment, after the\n+              // scheduled threads have completed. However, it can be tricky and cumbersome to track\n+              // completion, so it may just be better to delay closing until everything ends. At\n+              // least, we must ensure that it's not closed prematurely. (Garbage collection doesn't\n+              // auto-close it wit the current implementation.)\n+              ProgressEventDispatcher progressDispatcher =\n+                  childProgressDispatcherFactory.create(\n+                      \"scheduling pushing images\",\n+                      results.builtImagesAndBaseImages.get().keySet().size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61134225fd03fa94711697635ab8227b17ca88d5"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU4NDQ2OQ==", "bodyText": "pushing manifests", "url": "https://github.com/GoogleContainerTools/jib/pull/2699#discussion_r469584469", "createdAt": "2020-08-12T22:34:55Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -465,13 +499,24 @@ private void pushImages() {\n     results.buildResults =\n         executorService.submit(\n             () -> {\n+              // TODO: ideally, progressDispatcher should be closed at the right moment, after the\n+              // scheduled threads have completed. However, it can be tricky and cumbersome to track\n+              // completion, so it may just be better to delay closing until everything ends. At\n+              // least, we must ensure that it's not closed prematurely. (Garbage collection doesn't\n+              // auto-close it wit the current implementation.)\n+              ProgressEventDispatcher progressDispatcher =\n+                  childProgressDispatcherFactory.create(\n+                      \"scheduling pushing images\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61134225fd03fa94711697635ab8227b17ca88d5"}, "originalPosition": 106}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4aed13dd7c56b2bef9d7bf93b1fe80851757daf1", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/4aed13dd7c56b2bef9d7bf93b1fe80851757daf1", "committedDate": "2020-08-13T01:34:44Z", "message": "Style Fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2ODEwODM1", "url": "https://github.com/GoogleContainerTools/jib/pull/2699#pullrequestreview-466810835", "createdAt": "2020-08-13T14:22:02Z", "commit": {"oid": "4aed13dd7c56b2bef9d7bf93b1fe80851757daf1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxNDoyMjowMlrOHAN3LQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxNDoyMjowMlrOHAN3LQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk4OTE2NQ==", "bodyText": "#2699 (comment)\nAlmost all of our classes are immutable, so we didn't have to think about synchronization when accessing instances in the multi-threaded environment. However, progressDispatcher is an exception (understandably as a class to report progress updates to the user). And progressDispatcher is not designed to be thread-safe either.\nSo, it is unsafe to access progressDispatcher from multiple threads. That is, calling newChildProducer() here needs synchronization; it's being called in multiple threads launched through the loop.\nThe simplest solution I think is to call newChildProducer() outside executorService.submit() on line 408.", "url": "https://github.com/GoogleContainerTools/jib/pull/2699#discussion_r469989165", "createdAt": "2020-08-13T14:22:02Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -379,7 +409,7 @@ private void buildImages() {\n                         () ->\n                             new BuildImageStep(\n                                     buildContext,\n-                                    childProgressDispatcherFactory,\n+                                    progressDispatcher.newChildProducer(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4aed13dd7c56b2bef9d7bf93b1fe80851757daf1"}, "originalPosition": 83}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3c7b619fd33ca6a64d725dcb6f45a8990af54ae", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/b3c7b619fd33ca6a64d725dcb6f45a8990af54ae", "committedDate": "2020-08-13T14:40:47Z", "message": "Style Fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2ODMwODI0", "url": "https://github.com/GoogleContainerTools/jib/pull/2699#pullrequestreview-466830824", "createdAt": "2020-08-13T14:42:53Z", "commit": {"oid": "b3c7b619fd33ca6a64d725dcb6f45a8990af54ae"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxNDo0Mjo1M1rOHAO0lQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxNDo0NDozOFrOHAO5mA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDAwNDg4NQ==", "bodyText": "It's ok as long as you are not accessing progressDispatcher concurrently. Let's keep the previous code.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                pushImage(entry.getKey(), entry.getValue(), progressDispatcherFactory));\n          \n          \n            \n                                pushImage(entry.getKey(), entry.getValue(), progressDispatcherFactory.newChildProducer()));", "url": "https://github.com/GoogleContainerTools/jib/pull/2699#discussion_r470004885", "createdAt": "2020-08-13T14:42:53Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -459,13 +503,24 @@ private void pushImages() {\n     results.buildResults =\n         executorService.submit(\n             () -> {\n+              // TODO: ideally, progressDispatcher should be closed at the right moment, after the\n+              // scheduled threads have completed. However, it can be tricky and cumbersome to track\n+              // completion, so it may just be better to delay closing until everything ends. At\n+              // least, we must ensure that it's not closed prematurely. (Garbage collection doesn't\n+              // auto-close it wit the current implementation.)\n+              ProgressEventDispatcher progressDispatcher =\n+                  childProgressDispatcherFactory.create(\n+                      \"scheduling pushing manifests\",\n+                      results.builtImagesAndBaseImages.get().size());\n+\n               realizeFutures(results.applicationLayerPushResults.get());\n \n               List<Future<BuildResult>> buildResults = new ArrayList<>();\n               for (Map.Entry<Future<Image>, Image> entry :\n                   results.builtImagesAndBaseImages.get().entrySet()) {\n+                Factory progressDispatcherFactory = progressDispatcher.newChildProducer();\n                 buildResults.add(\n-                    pushImage(entry.getKey(), entry.getValue(), childProgressDispatcherFactory));\n+                    pushImage(entry.getKey(), entry.getValue(), progressDispatcherFactory));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3c7b619fd33ca6a64d725dcb6f45a8990af54ae"}, "originalPosition": 143}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDAwNTI1NA==", "bodyText": "Ditto, for simplicity, just progressDispatcher.newChildProducer().", "url": "https://github.com/GoogleContainerTools/jib/pull/2699#discussion_r470005254", "createdAt": "2020-08-13T14:43:24Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -336,17 +348,28 @@ private void pushBaseImageLayers() {\n     results.baseImagesAndLayerPushResults =\n         executorService.submit(\n             () -> {\n+              // TODO: ideally, progressDispatcher should be closed at the right moment, after the\n+              // scheduled threads have completed. However, it can be tricky and cumbersome to track\n+              // completion, so it may just be better to delay closing until everything ends. At\n+              // least, we must ensure that it's not closed prematurely. (Garbage collection doesn't\n+              // auto-close it wit the current implementation.)\n+              ProgressEventDispatcher progressDispatcher =\n+                  childProgressDispatcherFactory.create(\n+                      \"scheduling pushing base image layers\",\n+                      results.baseImagesAndLayers.get().size());\n+\n               Map<Image, List<Future<BlobDescriptor>>> pushResults = new HashMap<>();\n               for (Map.Entry<Image, List<Future<PreparedLayer>>> entry :\n                   results.baseImagesAndLayers.get().entrySet()) {\n+                Factory progressDispatcherFactory = progressDispatcher.newChildProducer();\n                 Image baseImage = entry.getKey();\n                 List<Future<PreparedLayer>> baseImageLayers = entry.getValue();\n \n                 List<Future<BlobDescriptor>> baseImageLayerPushResult =\n                     scheduleCallables(\n                         PushLayerStep.makeList(\n                             buildContext,\n-                            childProgressDispatcherFactory,\n+                            progressDispatcherFactory,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3c7b619fd33ca6a64d725dcb6f45a8990af54ae"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDAwNTM5MQ==", "bodyText": "ditto", "url": "https://github.com/GoogleContainerTools/jib/pull/2699#discussion_r470005391", "createdAt": "2020-08-13T14:43:33Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -304,22 +304,34 @@ private void pullBaseImages() {\n   private void obtainBaseImageLayers(boolean layersRequiredLocally) {\n     ProgressEventDispatcher.Factory childProgressDispatcherFactory =\n         Verify.verifyNotNull(rootProgressDispatcher).newChildProducer();\n+\n     results.baseImagesAndLayers =\n         executorService.submit(\n             () -> {\n+              // TODO: ideally, progressDispatcher should be closed at the right moment, after the\n+              // scheduled threads have completed. However, it can be tricky and cumbersome to track\n+              // completion, so it may just be better to delay closing until everything ends. At\n+              // least, we must ensure that it's not closed prematurely. (Garbage collection doesn't\n+              // auto-close it wit the current implementation.)\n+              ProgressEventDispatcher progressDispatcher =\n+                  childProgressDispatcherFactory.create(\n+                      \"scheduling obtaining base image layers\",\n+                      results.baseImagesAndRegistryClient.get().images.size());\n+\n               Map<Image, List<Future<PreparedLayer>>> baseImagesAndLayers = new HashMap<>();\n               for (Image image : results.baseImagesAndRegistryClient.get().images) {\n+                Factory progressDispatcherFactory = progressDispatcher.newChildProducer();\n                 List<Future<PreparedLayer>> layers =\n                     scheduleCallables(\n                         layersRequiredLocally\n                             ? ObtainBaseImageLayerStep.makeListForForcedDownload(\n                                 buildContext,\n-                                childProgressDispatcherFactory,\n+                                progressDispatcherFactory,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3c7b619fd33ca6a64d725dcb6f45a8990af54ae"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDAwNjE2OA==", "bodyText": "ProgressEventDispatcher.Factory progress... = ...\nError Prone usually complains if an inner class name is too generic.", "url": "https://github.com/GoogleContainerTools/jib/pull/2699#discussion_r470006168", "createdAt": "2020-08-13T14:44:38Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -371,15 +394,25 @@ private void buildImages() {\n     results.builtImagesAndBaseImages =\n         executorService.submit(\n             () -> {\n+              // TODO: ideally, progressDispatcher should be closed at the right moment, after the\n+              // scheduled threads have completed. However, it can be tricky and cumbersome to track\n+              // completion, so it may just be better to delay closing until everything ends. At\n+              // least, we must ensure that it's not closed prematurely. (Garbage collection doesn't\n+              // auto-close it wit the current implementation.)\n+              ProgressEventDispatcher progressDispatcher =\n+                  childProgressDispatcherFactory.create(\n+                      \"scheduling building manifests\", results.baseImagesAndLayers.get().size());\n+\n               Map<Future<Image>, Image> builtImagesAndBaseImages = new HashMap<>();\n               for (Map.Entry<Image, List<Future<PreparedLayer>>> entry :\n                   results.baseImagesAndLayers.get().entrySet()) {\n+                Factory progressDispatcherFactory = progressDispatcher.newChildProducer();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3c7b619fd33ca6a64d725dcb6f45a8990af54ae"}, "originalPosition": 83}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe5b67662260a7bb433f176c3342261897009e67", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/fe5b67662260a7bb433f176c3342261897009e67", "committedDate": "2020-08-13T14:55:42Z", "message": "Progress Dispatcher Fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25b40635d100d2cb8f57c63d846e675427dab91d", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/25b40635d100d2cb8f57c63d846e675427dab91d", "committedDate": "2020-08-13T15:01:12Z", "message": "Style Fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2ODU0MTYw", "url": "https://github.com/GoogleContainerTools/jib/pull/2699#pullrequestreview-466854160", "createdAt": "2020-08-13T15:07:21Z", "commit": {"oid": "25b40635d100d2cb8f57c63d846e675427dab91d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4952, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}