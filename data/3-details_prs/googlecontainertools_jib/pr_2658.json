{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyODgwMjkw", "number": 2658, "title": "Check if cached manifest matches configured platform", "bodyText": "Added a guard for #2655. Basically checks if a previously cached manifest doesn't match the configured platform. If so, raise an error with an actionable message.\n\n\nUpdates CHANGELOG in jib-core, jib-maven-plugin, and jib-gradle-plugin.\n\n\nAlso, there was a warning that pullBaseImages sometimes returns a mutable list and other times immutable, so I've addressed it by always returning an immutable list.\n.../jib/jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStep.java:217: warning:\n[MixedMutabilityReturnType]\nThis method returns both mutable and immutable collections or maps from different paths. This may be confusing for users of the method.\n  private List<Image> pullBaseImages(\n\n\n\nIn the meantime, I will continue to do some actual end-to-end tests.", "createdAt": "2020-08-04T16:40:18Z", "url": "https://github.com/GoogleContainerTools/jib/pull/2658", "merged": true, "mergeCommit": {"oid": "5d2024988a8eb9189f10683b9749ec426a0ca9fd"}, "closed": true, "closedAt": "2020-08-05T14:06:05Z", "author": {"login": "chanseokoh"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7ouT4AH2gAyNDYyODgwMjkwOmM3NGU5NDBmZThiMzRiMGQ4NTkzNDVkODdmZDk2YzM1MzFmZTZlYjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7xU3OgFqTQ2MTI4NzY3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c74e940fe8b34b0d859345d87fd96c3531fe6eb4", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/c74e940fe8b34b0d859345d87fd96c3531fe6eb4", "committedDate": "2020-08-04T15:54:24Z", "message": "Guard mismatched cached manifest and show suggestion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f80cb05d6c189f32aade765987b9d35dc3d7a87c", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/f80cb05d6c189f32aade765987b9d35dc3d7a87c", "committedDate": "2020-08-04T16:35:24Z", "message": "Update CHANGELOG"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMTA4NDM3", "url": "https://github.com/GoogleContainerTools/jib/pull/2658#pullrequestreview-461108437", "createdAt": "2020-08-04T19:25:17Z", "commit": {"oid": "f80cb05d6c189f32aade765987b9d35dc3d7a87c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxOToyNToxN1rOG7uQMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxOToyNToxN1rOG7uQMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI3Njk3Ng==", "bodyText": "Have we built the feature to support an OCI image index yet?", "url": "https://github.com/GoogleContainerTools/jib/pull/2658#discussion_r465276976", "createdAt": "2020-08-04T19:25:17Z", "author": {"login": "louismurerwa"}, "path": "jib-gradle-plugin/CHANGELOG.md", "diffHunk": "@@ -7,6 +7,18 @@ All notable changes to this project will be documented in this file.\n \n - Also tries `.exe` file extension for credential helpers on Windows. ([#2527](https://github.com/GoogleContainerTools/jib/issues/2527))\n - New system property `jib.skipExistingImages` (false by default) to skip pushing images (manifests) if the image already exists in the registry. ([#2360](https://github.com/GoogleContainerTools/jib/issues/2360)\n+- _Incubating feature_: can now configure desired platform (architecture and OS) to select the matching manifest from a Docker manifest list or an OCI image index for a base image. Currently supports building only one image. ([#1567](https://github.com/GoogleContainerTools/jib/issues/1567))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f80cb05d6c189f32aade765987b9d35dc3d7a87c"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMTEwMTcz", "url": "https://github.com/GoogleContainerTools/jib/pull/2658#pullrequestreview-461110173", "createdAt": "2020-08-04T19:28:05Z", "commit": {"oid": "f80cb05d6c189f32aade765987b9d35dc3d7a87c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxOToyODowNVrOG7uZMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxOToyODowNVrOG7uZMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI3OTI4Mg==", "bodyText": "thenReturn(ImmutableSet.of(new Platform(\"testArch\", \"testOS\")));", "url": "https://github.com/GoogleContainerTools/jib/pull/2658#discussion_r465279282", "createdAt": "2020-08-04T19:28:05Z", "author": {"login": "louismurerwa"}, "path": "jib-core/src/test/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStepTest.java", "diffHunk": "@@ -130,6 +137,56 @@ public void testCall_offlineMode_cached()\n     Mockito.verify(buildContext, Mockito.never()).newBaseImageRegistryClientFactory();\n   }\n \n+  @Test\n+  public void testCall_mismatchedPlatformOfCachedManifest_offlineMode()\n+      throws LayerPropertyNotFoundException, IOException, RegistryException,\n+          LayerCountMismatchException, BadContainerConfigurationFormatException,\n+          CacheCorruptedException, CredentialRetrievalException, InvalidImageReferenceException {\n+    ImageReference imageReference = ImageReference.parse(\"cat\");\n+    Mockito.when(imageConfiguration.getImage()).thenReturn(imageReference);\n+    Mockito.when(cache.retrieveMetadata(imageReference)).thenReturn(Optional.of(manifestAndConfig));\n+    Mockito.when(buildContext.isOffline()).thenReturn(true);\n+    Mockito.when(containerConfig.getPlatforms())\n+        .thenReturn(ImmutableSet.of(new Platform(\"foo arch\", \"bar OS\")));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f80cb05d6c189f32aade765987b9d35dc3d7a87c"}, "originalPosition": 68}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMTExMDE2", "url": "https://github.com/GoogleContainerTools/jib/pull/2658#pullrequestreview-461111016", "createdAt": "2020-08-04T19:29:23Z", "commit": {"oid": "f80cb05d6c189f32aade765987b9d35dc3d7a87c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxOToyOToyM1rOG7udjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxOToyOToyM1rOG7udjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI4MDM5Ng==", "bodyText": "ditoo", "url": "https://github.com/GoogleContainerTools/jib/pull/2658#discussion_r465280396", "createdAt": "2020-08-04T19:29:23Z", "author": {"login": "louismurerwa"}, "path": "jib-core/src/test/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStepTest.java", "diffHunk": "@@ -130,6 +137,56 @@ public void testCall_offlineMode_cached()\n     Mockito.verify(buildContext, Mockito.never()).newBaseImageRegistryClientFactory();\n   }\n \n+  @Test\n+  public void testCall_mismatchedPlatformOfCachedManifest_offlineMode()\n+      throws LayerPropertyNotFoundException, IOException, RegistryException,\n+          LayerCountMismatchException, BadContainerConfigurationFormatException,\n+          CacheCorruptedException, CredentialRetrievalException, InvalidImageReferenceException {\n+    ImageReference imageReference = ImageReference.parse(\"cat\");\n+    Mockito.when(imageConfiguration.getImage()).thenReturn(imageReference);\n+    Mockito.when(cache.retrieveMetadata(imageReference)).thenReturn(Optional.of(manifestAndConfig));\n+    Mockito.when(buildContext.isOffline()).thenReturn(true);\n+    Mockito.when(containerConfig.getPlatforms())\n+        .thenReturn(ImmutableSet.of(new Platform(\"foo arch\", \"bar OS\")));\n+\n+    try {\n+      pullBaseImageStep.call();\n+      Assert.fail();\n+    } catch (IllegalStateException ex) {\n+      Assert.assertEquals(\n+          \"The cached base image manifest does not match the configured platform due to the \"\n+              + \"current implementation of limited platform support. As a workaround, re-run Jib \"\n+              + \"online once to re-cache the right image manifest.\",\n+          ex.getMessage());\n+    }\n+  }\n+\n+  @Test\n+  public void testCall_mismatchedPlatformOfCachedManifest_baseImageDigest()\n+      throws LayerPropertyNotFoundException, IOException, RegistryException,\n+          LayerCountMismatchException, BadContainerConfigurationFormatException,\n+          CacheCorruptedException, CredentialRetrievalException, InvalidImageReferenceException {\n+    ImageReference imageReference =\n+        ImageReference.parse(\n+            \"awesome@sha256:aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\");\n+    Mockito.when(imageConfiguration.getImage()).thenReturn(imageReference);\n+    Mockito.when(cache.retrieveMetadata(imageReference)).thenReturn(Optional.of(manifestAndConfig));\n+    Mockito.when(containerConfig.getPlatforms())\n+        .thenReturn(ImmutableSet.of(new Platform(\"foo arch\", \"bar OS\")));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f80cb05d6c189f32aade765987b9d35dc3d7a87c"}, "originalPosition": 93}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1d38978b026c251be31d37c859b542cb9244033", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/d1d38978b026c251be31d37c859b542cb9244033", "committedDate": "2020-08-04T19:30:52Z", "message": "Remove OCI image indices from CHANGELOG"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMTE1MTQ2", "url": "https://github.com/GoogleContainerTools/jib/pull/2658#pullrequestreview-461115146", "createdAt": "2020-08-04T19:35:46Z", "commit": {"oid": "d1d38978b026c251be31d37c859b542cb9244033"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMTI0MTky", "url": "https://github.com/GoogleContainerTools/jib/pull/2658#pullrequestreview-461124192", "createdAt": "2020-08-04T19:50:04Z", "commit": {"oid": "d1d38978b026c251be31d37c859b542cb9244033"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxOTo1MDowNFrOG7vJyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxOTo1MDowNFrOG7vJyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI5MTcyMQ==", "bodyText": "should this just trigger a redownload of the correct manifest?", "url": "https://github.com/GoogleContainerTools/jib/pull/2658#discussion_r465291721", "createdAt": "2020-08-04T19:50:04Z", "author": {"login": "loosebazooka"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStep.java", "diffHunk": "@@ -110,6 +113,7 @@ public ImagesAndRegistryClient call()\n     } else if (imageReference.getDigest().isPresent()) {\n       Optional<Image> image = getCachedBaseImage();\n       if (image.isPresent()) {\n+        verifyPlatformOfCachedManifest(image.get());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1d38978b026c251be31d37c859b542cb9244033"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc9cae706e2fdb2973445329221d5f5517e3697f", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/bc9cae706e2fdb2973445329221d5f5517e3697f", "committedDate": "2020-08-04T22:18:28Z", "message": "Download manifest if cached manifest platform mismatches"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMjg3Njc1", "url": "https://github.com/GoogleContainerTools/jib/pull/2658#pullrequestreview-461287675", "createdAt": "2020-08-05T01:55:45Z", "commit": {"oid": "bc9cae706e2fdb2973445329221d5f5517e3697f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4931, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}