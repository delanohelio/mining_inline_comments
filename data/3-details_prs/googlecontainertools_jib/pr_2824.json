{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzNjIzNjkw", "number": 2824, "title": "Handle OCI manifest and index with no mediaType", "bodyText": "Fixes #2819.\nAs explained in #2819, the Docker spec requires mediaType in a manifest or manifest list. OTOH, the OCI spec doesn't require it. Therefore, if mediaType is not present (when schema 2), assume it's OCI.\nAnd manifests and config are required in an OCI manifest or index, respectively.", "createdAt": "2020-10-14T20:31:25Z", "url": "https://github.com/GoogleContainerTools/jib/pull/2824", "merged": true, "mergeCommit": {"oid": "5d55c203687b39cc0337d675e9d9cb6c2104bd5d"}, "closed": true, "closedAt": "2020-10-15T14:56:45Z", "author": {"login": "chanseokoh"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSjJoQAH2gAyNTAzNjIzNjkwOjM3Y2Y4OTU5YjU5MmVhOGIzM2ZkMGE5Yzc1NGU3ZjhiZWQ2MzgwZGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSlSm2gFqTUwODgyNjY1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "37cf8959b592ea8b33fd0a9c754e7f8bed6380da", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/37cf8959b592ea8b33fd0a9c754e7f8bed6380da", "committedDate": "2020-10-14T20:25:04Z", "message": "Handle OCI manifest and index with no mediaType"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NzczNjQ3", "url": "https://github.com/GoogleContainerTools/jib/pull/2824#pullrequestreview-508773647", "createdAt": "2020-10-14T21:35:00Z", "commit": {"oid": "37cf8959b592ea8b33fd0a9c754e7f8bed6380da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMTozNTowMFrOHhl35A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMTozNTowMFrOHhl35A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk4NTU3Mg==", "bodyText": "Could we add a test for this exception?", "url": "https://github.com/GoogleContainerTools/jib/pull/2824#discussion_r504985572", "createdAt": "2020-10-14T21:35:00Z", "author": {"login": "mpeddada1"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/registry/AbstractManifestPuller.java", "diffHunk": "@@ -145,15 +147,29 @@ private T getManifestTemplateFromJson(String jsonString)\n     }\n     if (schemaVersion == 2) {\n       // 'schemaVersion' of 2 can be either Docker V2.2 or OCI.\n-      String mediaType = node.get(\"mediaType\").asText();\n-      if (V22ManifestTemplate.MANIFEST_MEDIA_TYPE.equals(mediaType)) {\n-        return manifestTemplateClass.cast(\n-            JsonTemplateMapper.readJson(jsonString, V22ManifestTemplate.class));\n+      JsonNode mediaTypeNode = node.get(\"mediaType\");\n+      if (mediaTypeNode == null) { // not Docker, hence OCI\n+        if (node.get(\"manifests\") != null) {\n+          return manifestTemplateClass.cast(\n+              JsonTemplateMapper.readJson(jsonString, OciIndexTemplate.class));\n+        }\n+        if (node.get(\"config\") != null) {\n+          return manifestTemplateClass.cast(\n+              JsonTemplateMapper.readJson(jsonString, OciManifestTemplate.class));\n+        }\n+        throw new UnknownManifestFormatException(\n+            \"'schemaVersion' is 2, but neither 'manifests' nor 'config' exists\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37cf8959b592ea8b33fd0a9c754e7f8bed6380da"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d8d3814a6c1b2ee64d0847e7c0f5dd5377bd2b4", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/2d8d3814a6c1b2ee64d0847e7c0f5dd5377bd2b4", "committedDate": "2020-10-14T21:59:27Z", "message": "Add test for invalid OCI manifest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4ODE3OTI4", "url": "https://github.com/GoogleContainerTools/jib/pull/2824#pullrequestreview-508817928", "createdAt": "2020-10-14T22:36:44Z", "commit": {"oid": "2d8d3814a6c1b2ee64d0847e7c0f5dd5377bd2b4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4ODI2NjUx", "url": "https://github.com/GoogleContainerTools/jib/pull/2824#pullrequestreview-508826651", "createdAt": "2020-10-14T22:54:40Z", "commit": {"oid": "2d8d3814a6c1b2ee64d0847e7c0f5dd5377bd2b4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMjo1NDo0MFrOHhpWfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMjo1NDo0MFrOHhpWfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA0MjU1OA==", "bodyText": "Do we even accept OciIndexTemplate?", "url": "https://github.com/GoogleContainerTools/jib/pull/2824#discussion_r505042558", "createdAt": "2020-10-14T22:54:40Z", "author": {"login": "loosebazooka"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/registry/AbstractManifestPuller.java", "diffHunk": "@@ -145,15 +147,29 @@ private T getManifestTemplateFromJson(String jsonString)\n     }\n     if (schemaVersion == 2) {\n       // 'schemaVersion' of 2 can be either Docker V2.2 or OCI.\n-      String mediaType = node.get(\"mediaType\").asText();\n-      if (V22ManifestTemplate.MANIFEST_MEDIA_TYPE.equals(mediaType)) {\n-        return manifestTemplateClass.cast(\n-            JsonTemplateMapper.readJson(jsonString, V22ManifestTemplate.class));\n+      JsonNode mediaTypeNode = node.get(\"mediaType\");\n+      if (mediaTypeNode == null) { // not Docker, hence OCI\n+        if (node.get(\"manifests\") != null) {\n+          return manifestTemplateClass.cast(\n+              JsonTemplateMapper.readJson(jsonString, OciIndexTemplate.class));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d8d3814a6c1b2ee64d0847e7c0f5dd5377bd2b4"}, "originalPosition": 28}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4817, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}