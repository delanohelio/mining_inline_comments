{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxMzU0NzU4", "number": 2910, "title": "Migrate away from Docker Hub in integration tests", "bodyText": "Due to the new Docker Hub rate limit, we are starting to see errors like\ncom.google.cloud.tools.jib.registry.BlobPullerIntegrationTest > classMethod FAILED\n    java.lang.RuntimeException: Command 'docker run --rm -d -p 5000:5000 --name registry-a8087b15-fa3c-401c-bcbe-09f2a5e52dc9 registry:2' failed: Unable to find image 'registry:2' locally\n    docker: Error response from daemon: toomanyrequests: You have reached your pull rate limit. You may increase the limit by authenticating and upgrading: https://www.docker.com/increase-rate-limit.\n    See 'docker run --help'.\n\nThis PR uses mirror.gcr.io when feasible.\nNote, normally, one shouldn't directly reference mirror.gcr.io, as the mirror is a pull-through cache and doesn't guarantee the existence of images. However, in practice I don't think busybox and registry:2 will ever fail on mirror.gcr.io.\nThe PR also does a lot of cleanups and improves performance by switching to use a local registry.", "createdAt": "2020-12-02T23:32:18Z", "url": "https://github.com/GoogleContainerTools/jib/pull/2910", "merged": true, "mergeCommit": {"oid": "38509d84a2d1d1a0e2fe790811dcf9895d0949a5"}, "closed": true, "closedAt": "2020-12-03T20:37:02Z", "author": {"login": "chanseokoh"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiW_IuAH2gAyNTMxMzU0NzU4OjIxMTgzNmY2NGMwNDczZmU0ZTQ0OTVmNzkyNDM0NTVmMGZjYmM4OGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdipQU2AFqTU0NDQwNTg2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "211836f64c0473fe4e4495f79243455f0fcbc88a", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/211836f64c0473fe4e4495f79243455f0fcbc88a", "committedDate": "2020-12-02T23:17:32Z", "message": "Migrate and clean up integration tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca55c19206e9d48146efe5218cb03689bf02c2b1", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/ca55c19206e9d48146efe5218cb03689bf02c2b1", "committedDate": "2020-12-02T23:29:02Z", "message": "cleanups"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4032d494ee3a9e55f8badd08159d49334bb740ad", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/4032d494ee3a9e55f8badd08159d49334bb740ad", "committedDate": "2020-12-02T23:32:04Z", "message": "cleanups"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0MDMwNDU4", "url": "https://github.com/GoogleContainerTools/jib/pull/2910#pullrequestreview-544030458", "createdAt": "2020-12-03T14:49:58Z", "commit": {"oid": "4032d494ee3a9e55f8badd08159d49334bb740ad"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNDo0OTo1OFrOH-f4rg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNToxMDoxMVrOH-hEtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI5NjE3NA==", "bodyText": "We can remove this?", "url": "https://github.com/GoogleContainerTools/jib/pull/2910#discussion_r535296174", "createdAt": "2020-12-03T14:49:58Z", "author": {"login": "mpeddada1"}, "path": "jib-core/src/integration-test/java/com/google/cloud/tools/jib/registry/ManifestPusherIntegrationTest.java", "diffHunk": "@@ -30,19 +30,13 @@\n import java.io.IOException;\n import java.security.DigestException;\n import org.junit.Assert;\n-import org.junit.BeforeClass;\n import org.junit.ClassRule;\n import org.junit.Test;\n \n /** Integration tests for {@link ManifestPusher}. */\n public class ManifestPusherIntegrationTest {\n \n-  @ClassRule public static LocalRegistry localRegistry = new LocalRegistry(5000);\n-\n-  @BeforeClass\n-  public static void setUp() throws IOException, InterruptedException {\n-    localRegistry.pullAndPushToLocal(\"busybox\", \"busybox\");\n-  }\n+  @ClassRule public static final LocalRegistry localRegistry = new LocalRegistry(5000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4032d494ee3a9e55f8badd08159d49334bb740ad"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMwNjU5OA==", "bodyText": "Can we keep the previous name? Or manifestListSha256", "url": "https://github.com/GoogleContainerTools/jib/pull/2910#discussion_r535306598", "createdAt": "2020-12-03T14:59:41Z", "author": {"login": "mpeddada1"}, "path": "jib-core/src/integration-test/java/com/google/cloud/tools/jib/registry/ManifestPullerIntegrationTest.java", "diffHunk": "@@ -74,38 +75,32 @@ public void testPull_v22() throws IOException, RegistryException {\n   @Test\n   public void testPull_v22ManifestList() throws IOException, RegistryException {\n     RegistryClient registryClient =\n-        RegistryClient.factory(\n-                EventHandlers.NONE, \"registry-1.docker.io\", \"library/openjdk\", httpClient)\n+        RegistryClient.factory(EventHandlers.NONE, \"gcr.io\", \"distroless/base\", httpClient)\n             .newRegistryClient();\n-    registryClient.doPullBearerAuth();\n-\n-    // Ensure 11-jre-slim is a manifest list\n-    V22ManifestListTemplate manifestListTemplate =\n-        registryClient.pullManifest(\"11-jre-slim\", V22ManifestListTemplate.class).getManifest();\n-    Assert.assertEquals(2, manifestListTemplate.getSchemaVersion());\n-    Assert.assertTrue(manifestListTemplate.getManifests().size() > 0);\n \n-    // Generic call to 11-jre-slim pulls a manifest list\n-    ManifestTemplate manifestTemplate = registryClient.pullManifest(\"11-jre-slim\").getManifest();\n-    Assert.assertEquals(2, manifestTemplate.getSchemaVersion());\n-    MatcherAssert.assertThat(\n-        manifestTemplate, CoreMatchers.instanceOf(V22ManifestListTemplate.class));\n+    // Ensure \":latest\" is a manifest list\n+    V22ManifestListTemplate manifestList1 =\n+        registryClient.pullManifest(\"latest\", V22ManifestListTemplate.class).getManifest();\n+    Assert.assertEquals(2, manifestList1.getSchemaVersion());\n+    Assert.assertTrue(manifestList1.getManifests().size() > 0);\n \n-    // Make sure we can't cast a v22ManifestTemplate to v22ManifestListTemplate in ManifestPuller\n-    try {\n-      registryClient.pullManifest(KNOWN_MANIFEST_LIST_SHA, V22ManifestTemplate.class);\n-      Assert.fail();\n-    } catch (ClassCastException ex) {\n-      // pass\n-    }\n+    // Generic call to \":latest\" pulls a manifest list\n+    ManifestTemplate manifestList2 = registryClient.pullManifest(\"latest\").getManifest();\n+    Assert.assertEquals(2, manifestList2.getSchemaVersion());\n+    MatcherAssert.assertThat(manifestList2, CoreMatchers.instanceOf(V22ManifestListTemplate.class));\n+    Assert.assertTrue(((V22ManifestListTemplate) manifestList2).getManifests().size() > 0);\n \n     // Referencing a manifest list by sha256, should return a manifest list\n-    ManifestTemplate sha256ManifestList =\n+    ManifestTemplate manifestList3 =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4032d494ee3a9e55f8badd08159d49334bb740ad"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMxNDMwNA==", "bodyText": "Perhaps a more descriptive name- for example, manifestListLatest.", "url": "https://github.com/GoogleContainerTools/jib/pull/2910#discussion_r535314304", "createdAt": "2020-12-03T15:08:38Z", "author": {"login": "mpeddada1"}, "path": "jib-core/src/integration-test/java/com/google/cloud/tools/jib/registry/ManifestPullerIntegrationTest.java", "diffHunk": "@@ -74,38 +75,32 @@ public void testPull_v22() throws IOException, RegistryException {\n   @Test\n   public void testPull_v22ManifestList() throws IOException, RegistryException {\n     RegistryClient registryClient =\n-        RegistryClient.factory(\n-                EventHandlers.NONE, \"registry-1.docker.io\", \"library/openjdk\", httpClient)\n+        RegistryClient.factory(EventHandlers.NONE, \"gcr.io\", \"distroless/base\", httpClient)\n             .newRegistryClient();\n-    registryClient.doPullBearerAuth();\n-\n-    // Ensure 11-jre-slim is a manifest list\n-    V22ManifestListTemplate manifestListTemplate =\n-        registryClient.pullManifest(\"11-jre-slim\", V22ManifestListTemplate.class).getManifest();\n-    Assert.assertEquals(2, manifestListTemplate.getSchemaVersion());\n-    Assert.assertTrue(manifestListTemplate.getManifests().size() > 0);\n \n-    // Generic call to 11-jre-slim pulls a manifest list\n-    ManifestTemplate manifestTemplate = registryClient.pullManifest(\"11-jre-slim\").getManifest();\n-    Assert.assertEquals(2, manifestTemplate.getSchemaVersion());\n-    MatcherAssert.assertThat(\n-        manifestTemplate, CoreMatchers.instanceOf(V22ManifestListTemplate.class));\n+    // Ensure \":latest\" is a manifest list\n+    V22ManifestListTemplate manifestList1 =\n+        registryClient.pullManifest(\"latest\", V22ManifestListTemplate.class).getManifest();\n+    Assert.assertEquals(2, manifestList1.getSchemaVersion());\n+    Assert.assertTrue(manifestList1.getManifests().size() > 0);\n \n-    // Make sure we can't cast a v22ManifestTemplate to v22ManifestListTemplate in ManifestPuller\n-    try {\n-      registryClient.pullManifest(KNOWN_MANIFEST_LIST_SHA, V22ManifestTemplate.class);\n-      Assert.fail();\n-    } catch (ClassCastException ex) {\n-      // pass\n-    }\n+    // Generic call to \":latest\" pulls a manifest list\n+    ManifestTemplate manifestList2 = registryClient.pullManifest(\"latest\").getManifest();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4032d494ee3a9e55f8badd08159d49334bb740ad"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMxNTYzOQ==", "bodyText": "Is this still needed?", "url": "https://github.com/GoogleContainerTools/jib/pull/2910#discussion_r535315639", "createdAt": "2020-12-03T15:10:11Z", "author": {"login": "mpeddada1"}, "path": "jib-core/src/integration-test/java/com/google/cloud/tools/jib/registry/BlobPusherIntegrationTest.java", "diffHunk": "@@ -31,14 +31,12 @@\n /** Integration tests for {@link BlobPusher}. */\n public class BlobPusherIntegrationTest {\n \n-  @ClassRule public static LocalRegistry localRegistry = new LocalRegistry(5000);\n+  @ClassRule public static final LocalRegistry localRegistry = new LocalRegistry(5000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4032d494ee3a9e55f8badd08159d49334bb740ad"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09c696a846a6a233603e58404aab696fc63355a9", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/09c696a846a6a233603e58404aab696fc63355a9", "committedDate": "2020-12-03T15:46:36Z", "message": "Rename variables in test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0MTA2ODUz", "url": "https://github.com/GoogleContainerTools/jib/pull/2910#pullrequestreview-544106853", "createdAt": "2020-12-03T15:53:04Z", "commit": {"oid": "09c696a846a6a233603e58404aab696fc63355a9"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NDA1ODYx", "url": "https://github.com/GoogleContainerTools/jib/pull/2910#pullrequestreview-544405861", "createdAt": "2020-12-03T20:34:36Z", "commit": {"oid": "09c696a846a6a233603e58404aab696fc63355a9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4878, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}