{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxNDk0MDI4", "number": 2396, "title": "Allow null tags", "bodyText": "Fixes #2390. If the digest is set, the tag may now be null, rather than taking on the default value of latest. If neither the tag nor digest is specified in the creation of the ImageReference, then it will use the default tag latest.\nWe used digest and tag interchangeably throughout the codebase before this change, so it's possible I maybe have missed something small. To make this easier, I added two methods: getQualifier() and withQualifier(), which use the old behavior of getTag() and withTag().", "createdAt": "2020-04-09T15:32:08Z", "url": "https://github.com/GoogleContainerTools/jib/pull/2396", "merged": true, "mergeCommit": {"oid": "023c01e9b61f9d5bb3e8b3caa5af05cbb4d662b4"}, "closed": true, "closedAt": "2020-04-10T20:22:38Z", "author": {"login": "TadCordle"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVte3aAH2gAyNDAxNDk0MDI4OjQxYzZlOWM0YTU4NTkwNTEwNTM0NjRlNzAwN2E5OTFhNjJkNWY1Mjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcWW2bvgH2gAyNDAxNDk0MDI4OjM4OGE0NzE1ODRhYWEwZWYzNmIwY2FjZGM5OTVjZTkxZTFhZTJlYjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "41c6e9c4a5859051053464e7007a991a62d5f529", "author": {"user": {"login": "TadCordle", "name": "Tad Cordle"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/41c6e9c4a5859051053464e7007a991a62d5f529", "committedDate": "2020-04-08T19:57:56Z", "message": "Allow null tags"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34474fd73675828bb66eaa77173969b5c9ee2a81", "author": {"user": {"login": "TadCordle", "name": "Tad Cordle"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/34474fd73675828bb66eaa77173969b5c9ee2a81", "committedDate": "2020-04-09T15:27:16Z", "message": "Changelog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8395a71fbe3f7bb359ccf9ccfe96d9cf352fc67", "author": {"user": {"login": "TadCordle", "name": "Tad Cordle"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/e8395a71fbe3f7bb359ccf9ccfe96d9cf352fc67", "committedDate": "2020-04-09T15:34:24Z", "message": "Changelog"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwOTYwMzYz", "url": "https://github.com/GoogleContainerTools/jib/pull/2396#pullrequestreview-390960363", "createdAt": "2020-04-09T16:45:09Z", "commit": {"oid": "e8395a71fbe3f7bb359ccf9ccfe96d9cf352fc67"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNjo0NToyM1rOGDg23A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMDo0MDo0MVrOGDonbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMzNzI0NA==", "bodyText": "Just documenting: I think there's a possibility that these are not necessary. Seems like the whole ImageReference code can cope with an empty tag or digest by always checking isNullOrEmpty(). For example, the of() method passes empty tag and digest without coercing null. But because tag and digest are given as a result of parsing here, I think it makes sense to force null unlike of().\nToo bad, I think it could have been simpler if we prevented passing an empty string at the first place.", "url": "https://github.com/GoogleContainerTools/jib/pull/2396#discussion_r406337244", "createdAt": "2020-04-09T16:45:23Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -138,9 +138,15 @@ public static ImageReference parse(String reference) throws InvalidImageReferenc\n       repository = LIBRARY_REPOSITORY_PREFIX + repository;\n     }\n \n-    if (Strings.isNullOrEmpty(tag)) {\n+    if (Strings.isNullOrEmpty(tag) && Strings.isNullOrEmpty(digest)) {\n       tag = DEFAULT_TAG;\n     }\n+    if (Strings.isNullOrEmpty(tag)) {\n+      tag = null;\n+    }\n+    if (Strings.isNullOrEmpty(digest)) {\n+      digest = null;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8395a71fbe3f7bb359ccf9ccfe96d9cf352fc67"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM3NzE2MQ==", "bodyText": "I feel like it's cleaner to change\n\nincludeTagIfDigestPresent --> includeTagAndDigest (or noQualifier or onlyRegistryAndRepository). Then we can short-circuit if it doesn't have to print any tag or digest.\ntoString(boolean includeTagIfDigestPresent) -> toString(boolean includeTagAndDigest)\ntoString() is simply toString(true).\ntoStringWithQualifier() is simply toString(false) + getQualifier(). No conditionally needed in the method.\n\nWDYT?", "url": "https://github.com/GoogleContainerTools/jib/pull/2396#discussion_r406377161", "createdAt": "2020-04-09T17:55:05Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -380,7 +411,7 @@ private String toString(boolean includeTagIfDigestPresent) {\n \n     if (Strings.isNullOrEmpty(digest) || includeTagIfDigestPresent) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8395a71fbe3f7bb359ccf9ccfe96d9cf352fc67"}, "originalPosition": 151}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM3ODg0Mg==", "bodyText": "isDefaultTag() also works differently. And usesDefaultTag() too, because itjust callsisDefaultTag()`.", "url": "https://github.com/GoogleContainerTools/jib/pull/2396#discussion_r406378842", "createdAt": "2020-04-09T17:57:59Z", "author": {"login": "chanseokoh"}, "path": "jib-core/CHANGELOG.md", "diffHunk": "@@ -10,12 +10,15 @@ All notable changes to this project will be documented in this file.\n     - `isValidDigest(digest)` to check if a string is a valid digest.\n     - `getDigest()` to get the digest.\n     - `parse()` now supports image reference strings containing both a tag and a digest.\n+    - `getQualifier()` to return the digest, or the tag if no digest is set.\n+    - `withQualifier()` to change the image's tag or digest (old behavior of `withTag()`)\n \n ### Changed\n \n - `ImageReference#toStringWithTag` has been renamed to `toStringWithQualifier`.\n - `ImageReference#isValidTag` no longer returns `true` for digests.\n - `ImageReference#isTagDigest` has been removed; use `#getDigest` with `Optional#isPresent()` to check if an `ImageReference` uses a digest.\n+- `ImageReference#withTag` has been removed; use `withQualifier()` instead.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8395a71fbe3f7bb359ccf9ccfe96d9cf352fc67"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ2NDM2Nw==", "bodyText": "I think this answers some of my earlier questions. When given both a tag and a digest, the end result is to ignore a tag, right?\nIf so, since there's no point in specifying a tag in a Jib config, maybe we should print a warning. This doesn't have to be addressed in this PR.", "url": "https://github.com/GoogleContainerTools/jib/pull/2396#discussion_r406464367", "createdAt": "2020-04-09T20:40:41Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStep.java", "diffHunk": "@@ -191,7 +191,7 @@ private Image pullBaseImage(\n     EventHandlers eventHandlers = buildContext.getEventHandlers();\n \n     ManifestAndDigest<?> manifestAndDigest =\n-        registryClient.pullManifest(buildContext.getBaseImageConfiguration().getImageTag());\n+        registryClient.pullManifest(buildContext.getBaseImageConfiguration().getImageQualifier());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8395a71fbe3f7bb359ccf9ccfe96d9cf352fc67"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d2abf3ec54ace037dd4d7589abe0994c19b7350", "author": {"user": {"login": "TadCordle", "name": "Tad Cordle"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/7d2abf3ec54ace037dd4d7589abe0994c19b7350", "committedDate": "2020-04-10T16:57:13Z", "message": "Changelog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e23a97576f9f14387ba34c4dec0b60dc9677ad8f", "author": {"user": {"login": "TadCordle", "name": "Tad Cordle"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/e23a97576f9f14387ba34c4dec0b60dc9677ad8f", "committedDate": "2020-04-10T18:52:46Z", "message": "Maybe easier to understand"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNjA2ODIw", "url": "https://github.com/GoogleContainerTools/jib/pull/2396#pullrequestreview-391606820", "createdAt": "2020-04-10T18:58:52Z", "commit": {"oid": "e23a97576f9f14387ba34c4dec0b60dc9677ad8f"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxODo1ODo1MlrOGEDAzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxOTowMjo1MVrOGEDGhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg5Njg0NA==", "bodyText": "This check is probably unnecessary, much like in getQualifer()? We verify either tag or digest is set in the constructor.", "url": "https://github.com/GoogleContainerTools/jib/pull/2396#discussion_r406896844", "createdAt": "2020-04-10T18:58:52Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -378,13 +414,19 @@ private String toString(boolean includeTagIfDigestPresent) {\n       referenceString.append(repository);\n     }\n \n-    if (Strings.isNullOrEmpty(digest) || includeTagIfDigestPresent) {\n-      // Use tag if not the default tag.\n-      if (!DEFAULT_TAG.equals(tag)) {\n+    if (singleQualifier) {\n+      // Include the digest if set, else include the tag\n+      if (!Strings.isNullOrEmpty(digest)) {\n+        referenceString.append('@').append(digest);\n+      } else if (!Strings.isNullOrEmpty(tag)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e23a97576f9f14387ba34c4dec0b60dc9677ad8f"}, "originalPosition": 193}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg5ODMwOQ==", "bodyText": "I will file an issue around these questions. Ultimately, we should guard accidental misuse and confusion.\nUPDATE: filed #2398.", "url": "https://github.com/GoogleContainerTools/jib/pull/2396#discussion_r406898309", "createdAt": "2020-04-10T19:02:51Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStep.java", "diffHunk": "@@ -191,7 +191,7 @@ private Image pullBaseImage(\n     EventHandlers eventHandlers = buildContext.getEventHandlers();\n \n     ManifestAndDigest<?> manifestAndDigest =\n-        registryClient.pullManifest(buildContext.getBaseImageConfiguration().getImageTag());\n+        registryClient.pullManifest(buildContext.getBaseImageConfiguration().getImageQualifier());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ2NDM2Nw=="}, "originalCommit": {"oid": "e8395a71fbe3f7bb359ccf9ccfe96d9cf352fc67"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "388a471584aaa0ef36b0cacdc995ce91e1ae2eb6", "author": {"user": {"login": "TadCordle", "name": "Tad Cordle"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/388a471584aaa0ef36b0cacdc995ce91e1ae2eb6", "committedDate": "2020-04-10T20:09:47Z", "message": "Clarity"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 192, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}