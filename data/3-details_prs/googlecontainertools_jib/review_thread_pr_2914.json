{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyMTAxNzY4", "number": 2914, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMDozOTo0NlrOFAdq_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMzo1NToyMVrOFAjfEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MDMwNDYwOnYy", "diffSide": "RIGHT", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStep.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMDozOTo0NlrOH-xecA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMDozOTo0NlrOH-xecA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU4NDM2OA==", "bodyText": "BTW, looks like the current allocation units (2) isn't correct, but I'm not addressing this here.", "url": "https://github.com/GoogleContainerTools/jib/pull/2914#discussion_r535584368", "createdAt": "2020-12-03T20:39:46Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStep.java", "diffHunk": "@@ -95,47 +95,48 @@ public ImagesAndRegistryClient call()\n           LayerCountMismatchException, BadContainerConfigurationFormatException,\n           CacheCorruptedException, CredentialRetrievalException {\n     EventHandlers eventHandlers = buildContext.getEventHandlers();\n-    // Skip this step if this is a scratch image\n-    ImageReference imageReference = buildContext.getBaseImageConfiguration().getImage();\n-    if (imageReference.isScratch()) {\n-      Set<Platform> platforms = buildContext.getContainerConfiguration().getPlatforms();\n-      Verify.verify(!platforms.isEmpty());\n-\n-      eventHandlers.dispatch(LogEvent.progress(\"Getting scratch base image...\"));\n-      ImmutableList.Builder<Image> images = ImmutableList.builder();\n-      for (Platform platform : platforms) {\n-        Image.Builder imageBuilder = Image.builder(buildContext.getTargetFormat());\n-        imageBuilder.setArchitecture(platform.getArchitecture()).setOs(platform.getOs());\n-        images.add(imageBuilder.build());\n+    try (ProgressEventDispatcher progressEventDispatcher =\n+            progressEventDispatcherFactory.create(\"pulling base image manifest\", 2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33f89dd9a2f143317b7a1fe735ab449a6534f944"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MTI1NzE1OnYy", "diffSide": "RIGHT", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStep.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMzo1NToyMVrOH-6kcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMTo1NTowMFrOH-9TLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTczMzM2Mw==", "bodyText": "minor formatting: need to move line 136 up.", "url": "https://github.com/GoogleContainerTools/jib/pull/2914#discussion_r535733363", "createdAt": "2020-12-03T23:55:21Z", "author": {"login": "mpeddada1"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStep.java", "diffHunk": "@@ -95,47 +95,48 @@ public ImagesAndRegistryClient call()\n           LayerCountMismatchException, BadContainerConfigurationFormatException,\n           CacheCorruptedException, CredentialRetrievalException {\n     EventHandlers eventHandlers = buildContext.getEventHandlers();\n-    // Skip this step if this is a scratch image\n-    ImageReference imageReference = buildContext.getBaseImageConfiguration().getImage();\n-    if (imageReference.isScratch()) {\n-      Set<Platform> platforms = buildContext.getContainerConfiguration().getPlatforms();\n-      Verify.verify(!platforms.isEmpty());\n-\n-      eventHandlers.dispatch(LogEvent.progress(\"Getting scratch base image...\"));\n-      ImmutableList.Builder<Image> images = ImmutableList.builder();\n-      for (Platform platform : platforms) {\n-        Image.Builder imageBuilder = Image.builder(buildContext.getTargetFormat());\n-        imageBuilder.setArchitecture(platform.getArchitecture()).setOs(platform.getOs());\n-        images.add(imageBuilder.build());\n+    try (ProgressEventDispatcher progressEventDispatcher =\n+            progressEventDispatcherFactory.create(\"pulling base image manifest\", 2);\n+        TimerEventDispatcher ignored1 = new TimerEventDispatcher(eventHandlers, DESCRIPTION)) {\n+\n+      // Skip this step if this is a scratch image\n+      ImageReference imageReference = buildContext.getBaseImageConfiguration().getImage();\n+      if (imageReference.isScratch()) {\n+        Set<Platform> platforms = buildContext.getContainerConfiguration().getPlatforms();\n+        Verify.verify(!platforms.isEmpty());\n+\n+        eventHandlers.dispatch(LogEvent.progress(\"Getting scratch base image...\"));\n+        ImmutableList.Builder<Image> images = ImmutableList.builder();\n+        for (Platform platform : platforms) {\n+          Image.Builder imageBuilder = Image.builder(buildContext.getTargetFormat());\n+          imageBuilder.setArchitecture(platform.getArchitecture()).setOs(platform.getOs());\n+          images.add(imageBuilder.build());\n+        }\n+        return new ImagesAndRegistryClient(images.build(), null);\n       }\n-      return new ImagesAndRegistryClient(images.build(), null);\n-    }\n \n-    eventHandlers.dispatch(\n-        LogEvent.progress(\"Getting manifest for base image \" + imageReference + \"...\"));\n+      eventHandlers.dispatch(\n+          LogEvent.progress(\"Getting manifest for base image \" + imageReference + \"...\"));\n \n-    if (buildContext.isOffline()) {\n-      List<Image> images = getCachedBaseImages();\n-      if (!images.isEmpty()) {\n-        return new ImagesAndRegistryClient(images, null);\n-      }\n-      throw new IOException(\n-          \"Cannot run Jib in offline mode; \" + imageReference + \" not found in local Jib cache\");\n-\n-    } else if (imageReference.getDigest().isPresent()) {\n-      List<Image> images = getCachedBaseImages();\n-      if (!images.isEmpty()) {\n-        RegistryClient noAuthRegistryClient =\n-            buildContext.newBaseImageRegistryClientFactory().newRegistryClient();\n-        // TODO: passing noAuthRegistryClient may be problematic. It may return 401 unauthorized if\n-        // layers have to be downloaded. https://github.com/GoogleContainerTools/jib/issues/2220\n-        return new ImagesAndRegistryClient(images, noAuthRegistryClient);\n+      if (buildContext.isOffline()) {\n+        List<Image> images = getCachedBaseImages();\n+        if (!images.isEmpty()) {\n+          return new ImagesAndRegistryClient(images, null);\n+        }\n+        throw new IOException(\n+            \"Cannot run Jib in offline mode; \" + imageReference + \" not found in local Jib cache\");\n+\n+      } else if (imageReference.getDigest().isPresent()) {\n+        List<Image> images = getCachedBaseImages();\n+        if (!images.isEmpty()) {\n+          RegistryClient noAuthRegistryClient =\n+              buildContext.newBaseImageRegistryClientFactory().newRegistryClient();\n+          // TODO: passing noAuthRegistryClient may be problematic. It may return 401 unauthorized\n+          // if\n+          // layers have to be downloaded. https://github.com/GoogleContainerTools/jib/issues/2220", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33f89dd9a2f143317b7a1fe735ab449a6534f944"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc3ODA5Mw==", "bodyText": "Done. The auto-formatter puts the link on the third line though.", "url": "https://github.com/GoogleContainerTools/jib/pull/2914#discussion_r535778093", "createdAt": "2020-12-04T01:55:00Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStep.java", "diffHunk": "@@ -95,47 +95,48 @@ public ImagesAndRegistryClient call()\n           LayerCountMismatchException, BadContainerConfigurationFormatException,\n           CacheCorruptedException, CredentialRetrievalException {\n     EventHandlers eventHandlers = buildContext.getEventHandlers();\n-    // Skip this step if this is a scratch image\n-    ImageReference imageReference = buildContext.getBaseImageConfiguration().getImage();\n-    if (imageReference.isScratch()) {\n-      Set<Platform> platforms = buildContext.getContainerConfiguration().getPlatforms();\n-      Verify.verify(!platforms.isEmpty());\n-\n-      eventHandlers.dispatch(LogEvent.progress(\"Getting scratch base image...\"));\n-      ImmutableList.Builder<Image> images = ImmutableList.builder();\n-      for (Platform platform : platforms) {\n-        Image.Builder imageBuilder = Image.builder(buildContext.getTargetFormat());\n-        imageBuilder.setArchitecture(platform.getArchitecture()).setOs(platform.getOs());\n-        images.add(imageBuilder.build());\n+    try (ProgressEventDispatcher progressEventDispatcher =\n+            progressEventDispatcherFactory.create(\"pulling base image manifest\", 2);\n+        TimerEventDispatcher ignored1 = new TimerEventDispatcher(eventHandlers, DESCRIPTION)) {\n+\n+      // Skip this step if this is a scratch image\n+      ImageReference imageReference = buildContext.getBaseImageConfiguration().getImage();\n+      if (imageReference.isScratch()) {\n+        Set<Platform> platforms = buildContext.getContainerConfiguration().getPlatforms();\n+        Verify.verify(!platforms.isEmpty());\n+\n+        eventHandlers.dispatch(LogEvent.progress(\"Getting scratch base image...\"));\n+        ImmutableList.Builder<Image> images = ImmutableList.builder();\n+        for (Platform platform : platforms) {\n+          Image.Builder imageBuilder = Image.builder(buildContext.getTargetFormat());\n+          imageBuilder.setArchitecture(platform.getArchitecture()).setOs(platform.getOs());\n+          images.add(imageBuilder.build());\n+        }\n+        return new ImagesAndRegistryClient(images.build(), null);\n       }\n-      return new ImagesAndRegistryClient(images.build(), null);\n-    }\n \n-    eventHandlers.dispatch(\n-        LogEvent.progress(\"Getting manifest for base image \" + imageReference + \"...\"));\n+      eventHandlers.dispatch(\n+          LogEvent.progress(\"Getting manifest for base image \" + imageReference + \"...\"));\n \n-    if (buildContext.isOffline()) {\n-      List<Image> images = getCachedBaseImages();\n-      if (!images.isEmpty()) {\n-        return new ImagesAndRegistryClient(images, null);\n-      }\n-      throw new IOException(\n-          \"Cannot run Jib in offline mode; \" + imageReference + \" not found in local Jib cache\");\n-\n-    } else if (imageReference.getDigest().isPresent()) {\n-      List<Image> images = getCachedBaseImages();\n-      if (!images.isEmpty()) {\n-        RegistryClient noAuthRegistryClient =\n-            buildContext.newBaseImageRegistryClientFactory().newRegistryClient();\n-        // TODO: passing noAuthRegistryClient may be problematic. It may return 401 unauthorized if\n-        // layers have to be downloaded. https://github.com/GoogleContainerTools/jib/issues/2220\n-        return new ImagesAndRegistryClient(images, noAuthRegistryClient);\n+      if (buildContext.isOffline()) {\n+        List<Image> images = getCachedBaseImages();\n+        if (!images.isEmpty()) {\n+          return new ImagesAndRegistryClient(images, null);\n+        }\n+        throw new IOException(\n+            \"Cannot run Jib in offline mode; \" + imageReference + \" not found in local Jib cache\");\n+\n+      } else if (imageReference.getDigest().isPresent()) {\n+        List<Image> images = getCachedBaseImages();\n+        if (!images.isEmpty()) {\n+          RegistryClient noAuthRegistryClient =\n+              buildContext.newBaseImageRegistryClientFactory().newRegistryClient();\n+          // TODO: passing noAuthRegistryClient may be problematic. It may return 401 unauthorized\n+          // if\n+          // layers have to be downloaded. https://github.com/GoogleContainerTools/jib/issues/2220", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTczMzM2Mw=="}, "originalCommit": {"oid": "33f89dd9a2f143317b7a1fe735ab449a6534f944"}, "originalPosition": 74}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 46, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}