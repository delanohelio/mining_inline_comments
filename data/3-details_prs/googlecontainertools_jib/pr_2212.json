{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5MTU2ODg0", "number": 2212, "title": "Ignore registry port when inferring auth from maven settings", "bodyText": "This PR is a suggestion to fix #2135\nIt changes the lookup of the server information from the Maven settings to ignore the port information from the registry.\nIt splits the registry information at the (last) colon and extracts the substring before it:\ndocker.example.com:12345 would match with the server id docker.example.com\nI've tried to run as many integration tests as possible (but those working with the docker daemon didn't run on my Fedora 31 with podman).", "createdAt": "2020-01-03T23:41:44Z", "url": "https://github.com/GoogleContainerTools/jib/pull/2212", "merged": true, "mergeCommit": {"oid": "72a26cbeed3287172d4c07d61695210dbf278ffc"}, "closed": true, "closedAt": "2020-01-15T17:19:25Z", "author": {"login": "padyx"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb3zv8CgFqTMzODkzMDA3OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4J6q3gFqTMzOTU4Mzc4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4OTMwMDc5", "url": "https://github.com/GoogleContainerTools/jib/pull/2212#pullrequestreview-338930079", "createdAt": "2020-01-06T22:17:53Z", "commit": {"oid": "86324f93e634e5363a36f9b0036510837e7d6dd1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMjoxNzo1M1rOFaq4vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMjoxNzo1M1rOFaq4vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUwOTk1MA==", "bodyText": "It'd be nice if this server == null code could go into getServerFromMavenSettings", "url": "https://github.com/GoogleContainerTools/jib/pull/2212#discussion_r363509950", "createdAt": "2020-01-06T22:17:53Z", "author": {"login": "loosebazooka"}, "path": "jib-maven-plugin/src/main/java/com/google/cloud/tools/jib/maven/MavenSettingsServerCredentials.java", "diffHunk": "@@ -58,7 +59,7 @@\n   @Override\n   public Optional<AuthProperty> inferAuth(String registry) throws InferredAuthException {\n \n-    Server server = settings.getServer(registry);\n+    Server server = getServerFromMavenSettings(registry);\n     if (server == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86324f93e634e5363a36f9b0036510837e7d6dd1"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NDc4NzU3", "url": "https://github.com/GoogleContainerTools/jib/pull/2212#pullrequestreview-339478757", "createdAt": "2020-01-07T20:10:31Z", "commit": {"oid": "b792049b2b01adb4504a9790e0d8587f62a430f9"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QyMDoxMDozMVrOFbEf2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QyMDoxOToxNVrOFbEsrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzkyOTU2MQ==", "bodyText": "You don't need this null check. We check nullability with NullAway, and unless the argument is marked with @Nullable, it is never null.", "url": "https://github.com/GoogleContainerTools/jib/pull/2212#discussion_r363929561", "createdAt": "2020-01-07T20:10:31Z", "author": {"login": "chanseokoh"}, "path": "jib-maven-plugin/src/main/java/com/google/cloud/tools/jib/maven/MavenSettingsServerCredentials.java", "diffHunk": "@@ -108,4 +109,23 @@ public String getPasswordDescriptor() {\n           }\n         });\n   }\n+\n+  @Nullable\n+  Server getServerFromMavenSettings(String registry) {\n+    // Find and remove port (if present)\n+    if (registry == null) {\n+      return null;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b792049b2b01adb4504a9790e0d8587f62a430f9"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzkyOTYzMQ==", "bodyText": "Please add @VisibleForTesting.", "url": "https://github.com/GoogleContainerTools/jib/pull/2212#discussion_r363929631", "createdAt": "2020-01-07T20:10:42Z", "author": {"login": "chanseokoh"}, "path": "jib-maven-plugin/src/main/java/com/google/cloud/tools/jib/maven/MavenSettingsServerCredentials.java", "diffHunk": "@@ -108,4 +109,23 @@ public String getPasswordDescriptor() {\n           }\n         });\n   }\n+\n+  @Nullable", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b792049b2b01adb4504a9790e0d8587f62a430f9"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzkzMjE4Nw==", "bodyText": "I suggest\n    int index = registry.lastIndexOf(':');\n    if (index != -1) {\n      return settings.getServer(registry.substring(0, index));\n    }\n    return null;\nNo need to call settings.getServer() twice if nothing is configured.", "url": "https://github.com/GoogleContainerTools/jib/pull/2212#discussion_r363932187", "createdAt": "2020-01-07T20:17:28Z", "author": {"login": "chanseokoh"}, "path": "jib-maven-plugin/src/main/java/com/google/cloud/tools/jib/maven/MavenSettingsServerCredentials.java", "diffHunk": "@@ -108,4 +109,23 @@ public String getPasswordDescriptor() {\n           }\n         });\n   }\n+\n+  @Nullable\n+  Server getServerFromMavenSettings(String registry) {\n+    // Find and remove port (if present)\n+    if (registry == null) {\n+      return null;\n+    }\n+\n+    Server server = settings.getServer(registry);\n+    if (server != null) {\n+      return server;\n+    }\n+\n+    int index = registry.lastIndexOf(':');\n+    if (index != -1) {\n+      registry = registry.substring(0, index);\n+    }\n+    return settings.getServer(registry);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "165a9b2270c062066dca2fb786c5320780619ae8"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzkzMjg0NQ==", "bodyText": "Makes sense. I think we can leave this null check here.", "url": "https://github.com/GoogleContainerTools/jib/pull/2212#discussion_r363932845", "createdAt": "2020-01-07T20:19:15Z", "author": {"login": "chanseokoh"}, "path": "jib-maven-plugin/src/main/java/com/google/cloud/tools/jib/maven/MavenSettingsServerCredentials.java", "diffHunk": "@@ -58,7 +59,7 @@\n   @Override\n   public Optional<AuthProperty> inferAuth(String registry) throws InferredAuthException {\n \n-    Server server = settings.getServer(registry);\n+    Server server = getServerFromMavenSettings(registry);\n     if (server == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUwOTk1MA=="}, "originalCommit": {"oid": "86324f93e634e5363a36f9b0036510837e7d6dd1"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c694ae17754b986ee13ac8df1c5bbce7856558b5", "author": {"user": {"login": "padyx", "name": "Patrick B\u00e4nziger"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/c694ae17754b986ee13ac8df1c5bbce7856558b5", "committedDate": "2020-01-07T21:01:24Z", "message": "Ignore port as fallback when inferring registry auth from maven settings\n\nFixes #2135"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NTA5Nzc3", "url": "https://github.com/GoogleContainerTools/jib/pull/2212#pullrequestreview-339509777", "createdAt": "2020-01-07T21:11:53Z", "commit": {"oid": "c694ae17754b986ee13ac8df1c5bbce7856558b5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QyMToxMTo1M1rOFbF6zQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QyMToxMTo1M1rOFbF6zQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk1Mjg0NQ==", "bodyText": "Oh, this comment is now confusing. Let's update and move this to line 123:\n// try without port\nint index = registry.lastIndexOf(':');\n(Sorry, I should have caught this earlier.)", "url": "https://github.com/GoogleContainerTools/jib/pull/2212#discussion_r363952845", "createdAt": "2020-01-07T21:11:53Z", "author": {"login": "chanseokoh"}, "path": "jib-maven-plugin/src/main/java/com/google/cloud/tools/jib/maven/MavenSettingsServerCredentials.java", "diffHunk": "@@ -108,4 +110,20 @@ public String getPasswordDescriptor() {\n           }\n         });\n   }\n+\n+  @Nullable\n+  @VisibleForTesting\n+  Server getServerFromMavenSettings(String registry) {\n+    // Find and remove port (if present)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c694ae17754b986ee13ac8df1c5bbce7856558b5"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e274d996d89963c21ac8ddea87f6a2efde935dc", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/8e274d996d89963c21ac8ddea87f6a2efde935dc", "committedDate": "2020-01-08T00:06:42Z", "message": "Update comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NTgzNzg1", "url": "https://github.com/GoogleContainerTools/jib/pull/2212#pullrequestreview-339583785", "createdAt": "2020-01-08T00:07:55Z", "commit": {"oid": "8e274d996d89963c21ac8ddea87f6a2efde935dc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 274, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}