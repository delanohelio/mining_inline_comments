{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzMjExODc2", "number": 2876, "title": "Fix broken Jib CLI logging", "bodyText": "Jib CLI logging was misbehaving, swallowing messages and unnecessarily outputting blank lines:\n$ jib --target=docker://foo build\nBase image 'ubuntu' does not use a specific image digest - build may not be reproducible\n\nThe base image requires auth. Trying again for ubuntu...\n\nUsing credentials from Docker config (/home/chanseok/.docker/config.json) for ubuntu\n\n\nUsing base image with digest: sha256:fff16eea1a8ae92867721d90c59a75652ea66d29c05294e6e2f898704bdb8cf1\n\n\nContainer entrypoint set to [sh, hello.sh]\n\nExecuting tasks:\n[==============================] 100.0% complete\n\nWe should be adding message consumers to ConsoleLoggerBuilder only when the corresponding log levels should be consumed.\nOutput after the fix:\n$ jib --target=docker://foo build\nBase image 'ubuntu' does not use a specific image digest - build may not be reproducible\nThe base image requires auth. Trying again for ubuntu...\nUsing credentials from Docker config (/home/chanseok/.docker/config.json) for ubuntu\nUsing base image with digest: sha256:fff16eea1a8ae92867721d90c59a75652ea66d29c05294e6e2f898704bdb8cf1\n\nContainer entrypoint set to [sh, hello.sh]\nExecuting tasks:\n[==============================] 100.0% complete", "createdAt": "2020-10-30T18:40:43Z", "url": "https://github.com/GoogleContainerTools/jib/pull/2876", "merged": true, "mergeCommit": {"oid": "83ce15c27e8cd92361baa6f62bb1bd36c7269783"}, "closed": true, "closedAt": "2020-11-02T14:19:58Z", "author": {"login": "chanseokoh"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXrI2ugH2gAyNTEzMjExODc2OjExZWQyYjUyNmNlZTM3YzIxNjc4OWUyNzBjYTY4NTczYTlhMjNjYTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXrYOIAFqTUyMDk0NzAyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "11ed2b526cee37c216789e270ca68573a9a23ca9", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/11ed2b526cee37c216789e270ca68573a9a23ca9", "committedDate": "2020-10-30T18:33:05Z", "message": "Fix Jib CLI logger"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bf65ee5a4b2d3df70da679208e99e45ab4bfa49", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/7bf65ee5a4b2d3df70da679208e99e45ab4bfa49", "committedDate": "2020-10-30T18:33:31Z", "message": "minor cleanups"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8930bc314b3bceb28c676f3f662a8f4c5205dcf9", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/8930bc314b3bceb28c676f3f662a8f4c5205dcf9", "committedDate": "2020-10-30T18:37:28Z", "message": "Flip twoCursorUpJumping"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwOTQyMjAy", "url": "https://github.com/GoogleContainerTools/jib/pull/2876#pullrequestreview-520942202", "createdAt": "2020-10-30T18:42:25Z", "commit": {"oid": "8930bc314b3bceb28c676f3f662a8f4c5205dcf9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxODo0MjoyNVrOHrb1uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxODo0MjoyNVrOHrb1uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMwNjkzOQ==", "bodyText": "Flipping enableTwoCursorUpJump doesn't effectively change output and is not required to fix the issue. However, since there's no need to employ the two-cursor-up-jump trick (was only necessary for Maven), I'm turning it off.", "url": "https://github.com/GoogleContainerTools/jib/pull/2876#discussion_r515306939", "createdAt": "2020-10-30T18:42:25Z", "author": {"login": "chanseokoh"}, "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/cli2/logging/CliLogger.java", "diffHunk": "@@ -22,36 +22,54 @@\n import com.google.common.annotations.VisibleForTesting;\n import java.io.PrintStream;\n \n-/** A simple cli logger that logs to the command line based on the configured log level. */\n+/** A simple CLI logger that logs to the command line based on the configured log level. */\n public class CliLogger {\n \n   /**\n-   * Create a new logger for the cli.\n+   * Create a new logger for the CLI.\n    *\n    * @param verbosity the configure verbosity\n    * @param consoleOutput the configured consoleOutput format\n    * @return a new ConsoleLogger instance\n    */\n   public static ConsoleLogger newLogger(Verbosity verbosity, ConsoleOutput consoleOutput) {\n-    CliLogger cliLogger = new CliLogger(verbosity, System.out, System.err);\n-    boolean isRichConsole = isRichConsole(consoleOutput);\n-\n-    return newLogger(cliLogger, isRichConsole, new SingleThreadedExecutor());\n+    return newLogger(\n+        verbosity, consoleOutput, System.out, System.err, new SingleThreadedExecutor());\n   }\n \n   @VisibleForTesting\n   static ConsoleLogger newLogger(\n-      CliLogger cliLogger, boolean isRichConsole, SingleThreadedExecutor executor) {\n-    // rich logger will use an explicit progress event handler\n+      Verbosity verbosity,\n+      ConsoleOutput consoleOutput,\n+      PrintStream stdout,\n+      PrintStream stderr,\n+      SingleThreadedExecutor executor) {\n+    boolean enableRichProgress =\n+        isRichConsole(consoleOutput) && verbosity.atLeast(Verbosity.lifecycle);\n     ConsoleLoggerBuilder builder =\n-        isRichConsole\n-            ? ConsoleLoggerBuilder.rich(executor, true)\n-            : ConsoleLoggerBuilder.plain(executor).progress(cliLogger::lifecycle);\n-    builder.error(cliLogger::error);\n-    builder.warn(cliLogger::warn);\n-    builder.lifecycle(cliLogger::lifecycle);\n-    builder.info(cliLogger::info);\n-    builder.debug(cliLogger::debug);\n+        enableRichProgress\n+            ? ConsoleLoggerBuilder.rich(executor, false)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8930bc314b3bceb28c676f3f662a8f4c5205dcf9"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwOTQ3MDI0", "url": "https://github.com/GoogleContainerTools/jib/pull/2876#pullrequestreview-520947024", "createdAt": "2020-10-30T18:49:52Z", "commit": {"oid": "8930bc314b3bceb28c676f3f662a8f4c5205dcf9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4859, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}