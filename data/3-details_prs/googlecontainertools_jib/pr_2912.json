{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxOTQ5OTQ1", "number": 2912, "title": "Improve integration tests", "bodyText": "Each test took a lot of time because it needed to download the base image over and over because we set a temporary cache directory. The reason was to check consecutive build times in one test. No need to start from a clean state in every test. This will significantly boost the speed of this class.\nRemoved testBuildToDockerDaemon as it's a strict subset of testBuildToDockerDaemon_multipleTags. Normally we should have both if they were unit tests, but since these are integration tests, I think it's fine to have only the larger test for performance.\nUsing openjdk:8-jre-slim instead of openjdk:8-jre-alpine as a base image in testBuildToDockerRegistry_dockerHubBaseImage, as it causes the following error locally. (Maybe the error depends on a certain platform?)\n\ncom.google.cloud.tools.jib.api.ContainerizerIntegrationTest > testBuildToDockerRegistry_dockerHubBaseImage FAILED\n    java.lang.RuntimeException: Command 'docker run --rm localhost:5000/testimage:testtag' failed: Error loading shared library libjli.so: No such file or directory (needed by /usr/bin/java)\n    Error relocating /usr/bin/java: JLI_Launch: symbol not found\n        at com.google.cloud.tools.jib.Command.run(Command.java:68)\n        at com.google.cloud.tools.jib.Command.run(Command.java:45)\n        at com.google.cloud.tools.jib.api.ContainerizerIntegrationTest.testBuildToDockerRegistry_dockerHubBaseImage(ContainerizerIntegrationTest.java:282)", "createdAt": "2020-12-03T17:27:51Z", "url": "https://github.com/GoogleContainerTools/jib/pull/2912", "merged": true, "mergeCommit": {"oid": "37e37b67a65d8ff00a4106d14315757c1e6d27ee"}, "closed": true, "closedAt": "2020-12-08T22:14:32Z", "author": {"login": "chanseokoh"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdimfIBgH2gAyNTMxOTQ5OTQ1OjcwOGJiMmEzNmNhNzBiMzRhOTc3M2JjZjc4YzZjYzBjZTVhNzZmYzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkRhMUgFqTU0NzY3MDA5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "708bb2a36ca70b34a9773bcf78c6cc0ce5a76fc0", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/708bb2a36ca70b34a9773bcf78c6cc0ce5a76fc0", "committedDate": "2020-12-03T17:21:03Z", "message": "Improve tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "faf3c9410dcc7ca4fe0a790be71d3018471c8abf", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/faf3c9410dcc7ca4fe0a790be71d3018471c8abf", "committedDate": "2020-12-03T20:33:18Z", "message": "Fix incomplete progress"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33f89dd9a2f143317b7a1fe735ab449a6534f944", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/33f89dd9a2f143317b7a1fe735ab449a6534f944", "committedDate": "2020-12-03T20:37:42Z", "message": "Merge branch 'master' into fix-progress-completion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "581188b3f094757dea4f92c03f3d6b21ee27784f", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/581188b3f094757dea4f92c03f3d6b21ee27784f", "committedDate": "2020-12-03T20:40:05Z", "message": "Merge branch 'master' into improve-integ-tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "055bd8c71b62a8269362ad00974775e03346673e", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/055bd8c71b62a8269362ad00974775e03346673e", "committedDate": "2020-12-03T20:40:17Z", "message": "Merge branch 'fix-progress-completion' into improve-integ-tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a2fd37648fa73af212fc59550315f231d09ff2c", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/4a2fd37648fa73af212fc59550315f231d09ff2c", "committedDate": "2020-12-04T15:12:07Z", "message": "Merge branch 'master' into improve-integ-tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34d86a5b7ae0ec24dbb6e256090f5d75e9159284", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/34d86a5b7ae0ec24dbb6e256090f5d75e9159284", "committedDate": "2020-12-04T15:37:07Z", "message": "cleanups"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NDk3NzAy", "url": "https://github.com/GoogleContainerTools/jib/pull/2912#pullrequestreview-547497702", "createdAt": "2020-12-08T18:10:40Z", "commit": {"oid": "34d86a5b7ae0ec24dbb6e256090f5d75e9159284"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxODoxMDo0MFrOIBuX3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxODoxOTo1NFrOIBu8-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODY3OTI2Mg==", "bodyText": "Do we want to enable caching for the other tests as well?", "url": "https://github.com/GoogleContainerTools/jib/pull/2912#discussion_r538679262", "createdAt": "2020-12-08T18:10:40Z", "author": {"login": "mpeddada1"}, "path": "jib-core/src/integration-test/java/com/google/cloud/tools/jib/api/ContainerizerIntegrationTest.java", "diffHunk": "@@ -149,35 +149,43 @@ private static void assertLayerSize(int expected, String imageReference)\n \n   @Rule public final TemporaryFolder temporaryFolder = new TemporaryFolder();\n \n-  private final ProgressChecker progressChecker = new ProgressChecker();\n+  private ProgressChecker progressChecker = new ProgressChecker();\n \n   @Test\n   public void testSteps_forBuildToDockerRegistry()\n       throws IOException, InterruptedException, ExecutionException, RegistryException,\n-          CacheDirectoryCreationException {\n+          CacheDirectoryCreationException, InvalidImageReferenceException {\n+    System.setProperty(\"jib.alwaysCacheBaseImage\", \"true\");\n+    String imageReference = \"localhost:5000/testimage:testtag\";\n+    Path cacheDirectory = temporaryFolder.newFolder().toPath();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34d86a5b7ae0ec24dbb6e256090f5d75e9159284"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODY4NDE4Mw==", "bodyText": "I know these methods were not introduced in this PR but since we are using a helper for the assert statements, could we make the name a bit more detailed? Something along the lines of assertThatExpectedLayerSizeReturned or assertThatExpectedDockerInspectOutputReturned.", "url": "https://github.com/GoogleContainerTools/jib/pull/2912#discussion_r538684183", "createdAt": "2020-12-08T18:15:35Z", "author": {"login": "mpeddada1"}, "path": "jib-core/src/integration-test/java/com/google/cloud/tools/jib/api/ContainerizerIntegrationTest.java", "diffHunk": "@@ -283,54 +288,38 @@ public void testBuildToDockerRegistry_dockerHubBaseImage()\n   }\n \n   @Test\n-  public void testBuildToDockerDaemon()\n+  public void testBuildToDockerDaemon_multipleTags()\n       throws IOException, InterruptedException, ExecutionException, RegistryException,\n-          CacheDirectoryCreationException {\n-    buildDockerDaemonImage(\n+          CacheDirectoryCreationException, InvalidImageReferenceException {\n+    buildImage(\n         ImageReference.of(\"gcr.io\", \"distroless/java\", DISTROLESS_DIGEST),\n-        ImageReference.of(null, \"testdocker\", null),\n-        Collections.emptyList());\n+        Containerizer.to(DockerDaemonImage.named(\"testdocker\")),\n+        Arrays.asList(\"testtag2\", \"testtag3\"));\n \n     progressChecker.checkCompletion();\n \n-    assertDockerInspect(\"testdocker\");\n     assertLayerSize(7, \"testdocker\");\n+    assertDockerInspect(\"testdocker\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34d86a5b7ae0ec24dbb6e256090f5d75e9159284"}, "originalPosition": 135}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODY4NjcxNA==", "bodyText": "Nice, I'm guessing this fixes the compatibility issue and also results in a smaller image:)", "url": "https://github.com/GoogleContainerTools/jib/pull/2912#discussion_r538686714", "createdAt": "2020-12-08T18:18:03Z", "author": {"login": "mpeddada1"}, "path": "jib-core/src/integration-test/java/com/google/cloud/tools/jib/api/ContainerizerIntegrationTest.java", "diffHunk": "@@ -271,9 +276,9 @@ public void testSteps_forBuildToDockerRegistry_skipExistingDigest()\n   public void testBuildToDockerRegistry_dockerHubBaseImage()\n       throws InvalidImageReferenceException, IOException, InterruptedException, ExecutionException,\n           RegistryException, CacheDirectoryCreationException {\n-    buildRegistryImage(\n-        ImageReference.parse(\"openjdk:8-jre-alpine\"),\n-        ImageReference.of(\"localhost:5000\", \"testimage\", \"testtag\"),\n+    buildImage(\n+        ImageReference.parse(\"openjdk:8-jre-slim\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34d86a5b7ae0ec24dbb6e256090f5d75e9159284"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODY4ODc2Mw==", "bodyText": "Or make line 157 and line 160 part of setUp()", "url": "https://github.com/GoogleContainerTools/jib/pull/2912#discussion_r538688763", "createdAt": "2020-12-08T18:19:54Z", "author": {"login": "mpeddada1"}, "path": "jib-core/src/integration-test/java/com/google/cloud/tools/jib/api/ContainerizerIntegrationTest.java", "diffHunk": "@@ -149,35 +149,43 @@ private static void assertLayerSize(int expected, String imageReference)\n \n   @Rule public final TemporaryFolder temporaryFolder = new TemporaryFolder();\n \n-  private final ProgressChecker progressChecker = new ProgressChecker();\n+  private ProgressChecker progressChecker = new ProgressChecker();\n \n   @Test\n   public void testSteps_forBuildToDockerRegistry()\n       throws IOException, InterruptedException, ExecutionException, RegistryException,\n-          CacheDirectoryCreationException {\n+          CacheDirectoryCreationException, InvalidImageReferenceException {\n+    System.setProperty(\"jib.alwaysCacheBaseImage\", \"true\");\n+    String imageReference = \"localhost:5000/testimage:testtag\";\n+    Path cacheDirectory = temporaryFolder.newFolder().toPath();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODY3OTI2Mg=="}, "originalCommit": {"oid": "34d86a5b7ae0ec24dbb6e256090f5d75e9159284"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NjcwMDA3", "url": "https://github.com/GoogleContainerTools/jib/pull/2912#pullrequestreview-547670007", "createdAt": "2020-12-08T22:03:02Z", "commit": {"oid": "34d86a5b7ae0ec24dbb6e256090f5d75e9159284"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMjowMzowMlrOIB4Pow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMjowMzowMlrOIB4Pow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0MDk5NQ==", "bodyText": "so now we're just using the system default cache?", "url": "https://github.com/GoogleContainerTools/jib/pull/2912#discussion_r538840995", "createdAt": "2020-12-08T22:03:02Z", "author": {"login": "loosebazooka"}, "path": "jib-core/src/integration-test/java/com/google/cloud/tools/jib/api/ContainerizerIntegrationTest.java", "diffHunk": "@@ -383,10 +345,7 @@ private JibContainer buildImage(\n             .setLabels(ImmutableMap.of(\"key1\", \"value1\", \"key2\", \"value2\"))\n             .setFileEntriesLayers(fakeLayerConfigurations);\n \n-    Path cacheDirectory = temporaryFolder.newFolder().toPath();\n     containerizer", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34d86a5b7ae0ec24dbb6e256090f5d75e9159284"}, "originalPosition": 221}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NjcwMDk2", "url": "https://github.com/GoogleContainerTools/jib/pull/2912#pullrequestreview-547670096", "createdAt": "2020-12-08T22:03:09Z", "commit": {"oid": "34d86a5b7ae0ec24dbb6e256090f5d75e9159284"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4880, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}