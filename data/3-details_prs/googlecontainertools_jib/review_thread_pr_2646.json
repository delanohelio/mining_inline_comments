{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU5NTc1OTUw", "number": 2646, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMTowNDoyN1rOET2AXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxNzo0OTo1NFrOEUI_Eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MjQzMjI4OnYy", "diffSide": "RIGHT", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMTowNDoyN1rOG5zx7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxNDoxMDo1NlrOG6KAiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI3MDM4MQ==", "bodyText": "And probably you don't need { return ... } but keep the original syntactic sugar () -> expr.", "url": "https://github.com/GoogleContainerTools/jib/pull/2646#discussion_r463270381", "createdAt": "2020-07-30T21:04:27Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -271,14 +273,28 @@ private void extractTar() {\n   }\n \n   private void assignLocalImageResult(Future<LocalImage> localImage) {\n-    results.baseImageLayers = executorService.submit(() -> localImage.get().layers);\n+\n+    Future<List<Future<PreparedLayer>>> localBaseImageLayers =\n+        executorService.submit(() -> localImage.get().layers);\n+\n     results.baseImageAndRegistryClient =\n         executorService.submit(\n-            () ->\n-                LocalBaseImageSteps.returnImageAndRegistryClientStep(\n-                        realizeFutures(results.baseImageLayers.get()),\n-                        localImage.get().configurationTemplate)\n-                    .call());\n+            () -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "119ae86bccb1c83b8eee62e9259656c257dc9ab8"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzYzNDU3MQ==", "bodyText": "Adding back the sugar so that our code can be sweet again hahah . Done.", "url": "https://github.com/GoogleContainerTools/jib/pull/2646#discussion_r463634571", "createdAt": "2020-07-31T14:10:56Z", "author": {"login": "louismurerwa"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -271,14 +273,28 @@ private void extractTar() {\n   }\n \n   private void assignLocalImageResult(Future<LocalImage> localImage) {\n-    results.baseImageLayers = executorService.submit(() -> localImage.get().layers);\n+\n+    Future<List<Future<PreparedLayer>>> localBaseImageLayers =\n+        executorService.submit(() -> localImage.get().layers);\n+\n     results.baseImageAndRegistryClient =\n         executorService.submit(\n-            () ->\n-                LocalBaseImageSteps.returnImageAndRegistryClientStep(\n-                        realizeFutures(results.baseImageLayers.get()),\n-                        localImage.get().configurationTemplate)\n-                    .call());\n+            () -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI3MDM4MQ=="}, "originalCommit": {"oid": "119ae86bccb1c83b8eee62e9259656c257dc9ab8"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MjQ1ODgwOnYy", "diffSide": "RIGHT", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMToxMzoxNlrOG50CFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMToxMzoxNlrOG50CFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI3NDUxNg==", "bodyText": "localImage.get().layers should work. No need to defined localBaseImageLayers on line 277.\nand this will probably work:\n.submit( () -> Collections.singletonMap(\n            results.baseImageAndRegistryClient.get().images.get(0),\n            localImage.get().layers) );", "url": "https://github.com/GoogleContainerTools/jib/pull/2646#discussion_r463274516", "createdAt": "2020-07-30T21:13:16Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -271,14 +273,28 @@ private void extractTar() {\n   }\n \n   private void assignLocalImageResult(Future<LocalImage> localImage) {\n-    results.baseImageLayers = executorService.submit(() -> localImage.get().layers);\n+\n+    Future<List<Future<PreparedLayer>>> localBaseImageLayers =\n+        executorService.submit(() -> localImage.get().layers);\n+\n     results.baseImageAndRegistryClient =\n         executorService.submit(\n-            () ->\n-                LocalBaseImageSteps.returnImageAndRegistryClientStep(\n-                        realizeFutures(results.baseImageLayers.get()),\n-                        localImage.get().configurationTemplate)\n-                    .call());\n+            () -> {\n+              return LocalBaseImageSteps.returnImageAndRegistryClientStep(\n+                      realizeFutures(localBaseImageLayers.get()),\n+                      localImage.get().configurationTemplate)\n+                  .call();\n+            });\n+\n+    results.baseImageLayers =\n+        executorService.submit(\n+            () -> {\n+              Map<Image, List<Future<PreparedLayer>>> baseImageLayers = new HashMap<>();\n+              baseImageLayers.put(\n+                  results.baseImageAndRegistryClient.get().images.get(0),\n+                  localBaseImageLayers.get());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "119ae86bccb1c83b8eee62e9259656c257dc9ab8"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MjUzMTU5OnYy", "diffSide": "RIGHT", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMTozNzoxOFrOG50t3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxNDozMzowNVrOG6Kwrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI4NTcyNg==", "bodyText": "I realized we could have increased concurrency further. PullBaseImageStep is now designed to return all manifests all at once, meaning that downloading base image layers can start only after all manifests have been downloaded. Moreover, in PullBaseImageStep, we will probably end up having to download all manifests synchronously and sequentially. Theoretically and ideally we should be able to concurrently download manifests as well as start downloading base image layers while there are still pending manifest downloads. However, because this requires significant redesign of PullBaseImageStep (i.e., we should schedule multiple threads (multiple step instances) each downloading an assigned manifest, resulting in List<Future<Image>> instead of the current List<Image>) and because manifests are small and generally quick to download, I think the current implementation is reasonable. We just need to keep track of this issue so that we can eventually implement this.", "url": "https://github.com/GoogleContainerTools/jib/pull/2646#discussion_r463285726", "createdAt": "2020-07-30T21:37:18Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -292,23 +308,31 @@ private void pullBaseImage() {\n   private void obtainBaseImageLayers(boolean layersRequiredLocally) {\n     ProgressEventDispatcher.Factory childProgressDispatcherFactory =\n         Verify.verifyNotNull(rootProgressDispatcher).newChildProducer();\n-\n     results.baseImageLayers =\n         executorService.submit(\n-            () ->\n-                scheduleCallables(\n-                    layersRequiredLocally\n-                        ? ObtainBaseImageLayerStep.makeListForForcedDownload(\n-                            buildContext,\n-                            childProgressDispatcherFactory,\n-                            results.baseImageAndRegistryClient.get().images.get(0),\n-                            results.baseImageAndRegistryClient.get().registryClient)\n-                        : ObtainBaseImageLayerStep.makeListForSelectiveDownload(\n-                            buildContext,\n-                            childProgressDispatcherFactory,\n-                            results.baseImageAndRegistryClient.get().images.get(0),\n-                            results.baseImageAndRegistryClient.get().registryClient,\n-                            results.targetRegistryClient.get())));\n+            () -> {\n+              Map<Image, List<Future<PreparedLayer>>> baseImageLayers = new HashMap<>();\n+              for (Image image : results.baseImageAndRegistryClient.get().images) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "119ae86bccb1c83b8eee62e9259656c257dc9ab8"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzYzOTI4NQ==", "bodyText": "This is a very good point .I hadn't realized that we are using a future<List> instead of List<Future> . As you said the manifest files are really small and thus there is a lower chance of them slowing down the build process I support the fact that we can refactor this later.I have put this point on the list for items to be improved once a working multi-image is completed.\nIn the future we should be able to do this for (Image image : results.baseImageAndRegistryClient.images.get()) { which enables us to use Future objects", "url": "https://github.com/GoogleContainerTools/jib/pull/2646#discussion_r463639285", "createdAt": "2020-07-31T14:19:37Z", "author": {"login": "louismurerwa"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -292,23 +308,31 @@ private void pullBaseImage() {\n   private void obtainBaseImageLayers(boolean layersRequiredLocally) {\n     ProgressEventDispatcher.Factory childProgressDispatcherFactory =\n         Verify.verifyNotNull(rootProgressDispatcher).newChildProducer();\n-\n     results.baseImageLayers =\n         executorService.submit(\n-            () ->\n-                scheduleCallables(\n-                    layersRequiredLocally\n-                        ? ObtainBaseImageLayerStep.makeListForForcedDownload(\n-                            buildContext,\n-                            childProgressDispatcherFactory,\n-                            results.baseImageAndRegistryClient.get().images.get(0),\n-                            results.baseImageAndRegistryClient.get().registryClient)\n-                        : ObtainBaseImageLayerStep.makeListForSelectiveDownload(\n-                            buildContext,\n-                            childProgressDispatcherFactory,\n-                            results.baseImageAndRegistryClient.get().images.get(0),\n-                            results.baseImageAndRegistryClient.get().registryClient,\n-                            results.targetRegistryClient.get())));\n+            () -> {\n+              Map<Image, List<Future<PreparedLayer>>> baseImageLayers = new HashMap<>();\n+              for (Image image : results.baseImageAndRegistryClient.get().images) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI4NTcyNg=="}, "originalCommit": {"oid": "119ae86bccb1c83b8eee62e9259656c257dc9ab8"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY0Njg5NA==", "bodyText": "because manifests are small and generally quick to download, I think the current implementation is reasonable.\n\nFor your insight, this is somewhat acceptable, but we've seen many, many Jib users working in a slow network where it takes, e.g., 4~5 seconds to download a manifest. So, if you are sequentially downloading 3 manifests, they will add up to ~15 seconds. 15 seconds would still be a small fraction considering that the entire build would take far more time in such a slow network, but it will be a significant bottleneck, e.g., when not pushing to a remote registry.", "url": "https://github.com/GoogleContainerTools/jib/pull/2646#discussion_r463646894", "createdAt": "2020-07-31T14:33:05Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -292,23 +308,31 @@ private void pullBaseImage() {\n   private void obtainBaseImageLayers(boolean layersRequiredLocally) {\n     ProgressEventDispatcher.Factory childProgressDispatcherFactory =\n         Verify.verifyNotNull(rootProgressDispatcher).newChildProducer();\n-\n     results.baseImageLayers =\n         executorService.submit(\n-            () ->\n-                scheduleCallables(\n-                    layersRequiredLocally\n-                        ? ObtainBaseImageLayerStep.makeListForForcedDownload(\n-                            buildContext,\n-                            childProgressDispatcherFactory,\n-                            results.baseImageAndRegistryClient.get().images.get(0),\n-                            results.baseImageAndRegistryClient.get().registryClient)\n-                        : ObtainBaseImageLayerStep.makeListForSelectiveDownload(\n-                            buildContext,\n-                            childProgressDispatcherFactory,\n-                            results.baseImageAndRegistryClient.get().images.get(0),\n-                            results.baseImageAndRegistryClient.get().registryClient,\n-                            results.targetRegistryClient.get())));\n+            () -> {\n+              Map<Image, List<Future<PreparedLayer>>> baseImageLayers = new HashMap<>();\n+              for (Image image : results.baseImageAndRegistryClient.get().images) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI4NTcyNg=="}, "originalCommit": {"oid": "119ae86bccb1c83b8eee62e9259656c257dc9ab8"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5NDkyMzU1OnYy", "diffSide": "RIGHT", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxNDozNzoxOVrOG6K6Zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxNDo0NDoyOFrOG6LKyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY0OTM4Mw==", "bodyText": "What is the best name for this map object that maps Image - baseImageLayers ? I was thinking of  imageLayers or baseImagesAndLayers", "url": "https://github.com/GoogleContainerTools/jib/pull/2646#discussion_r463649383", "createdAt": "2020-07-31T14:37:19Z", "author": {"login": "louismurerwa"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -64,7 +66,7 @@\n     }\n \n     private Future<ImagesAndRegistryClient> baseImageAndRegistryClient = failedFuture();\n-    private Future<List<Future<PreparedLayer>>> baseImageLayers = failedFuture();\n+    private Future<Map<Image, List<Future<PreparedLayer>>>> baseImageLayers = failedFuture();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "119ae86bccb1c83b8eee62e9259656c257dc9ab8"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY1MzU3Nw==", "bodyText": "baseImagesAndLayers sounds good to me.", "url": "https://github.com/GoogleContainerTools/jib/pull/2646#discussion_r463653577", "createdAt": "2020-07-31T14:44:28Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -64,7 +66,7 @@\n     }\n \n     private Future<ImagesAndRegistryClient> baseImageAndRegistryClient = failedFuture();\n-    private Future<List<Future<PreparedLayer>>> baseImageLayers = failedFuture();\n+    private Future<Map<Image, List<Future<PreparedLayer>>>> baseImageLayers = failedFuture();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY0OTM4Mw=="}, "originalCommit": {"oid": "119ae86bccb1c83b8eee62e9259656c257dc9ab8"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5NTEyMDE4OnYy", "diffSide": "RIGHT", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxNTozMTo0MFrOG6MzBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxNTozMTo0MFrOG6MzBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY4MDI2MA==", "bodyText": "I didn't bother in the last PR as the overall implementation is in the transitioning state from a single image to multiple images, but given the current state, I think we should rename this to baseImagesAndRegistryClient to be consistent.", "url": "https://github.com/GoogleContainerTools/jib/pull/2646#discussion_r463680260", "createdAt": "2020-07-31T15:31:40Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -271,14 +273,22 @@ private void extractTar() {\n   }\n \n   private void assignLocalImageResult(Future<LocalImage> localImage) {\n-    results.baseImageLayers = executorService.submit(() -> localImage.get().layers);\n     results.baseImageAndRegistryClient =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6e956e65249fc09d98a0b7210e79ceb104b9cb8"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5NTEyMzY0OnYy", "diffSide": "RIGHT", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxNTozMjozM1rOG6M1NQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxNTo0Mjo0NVrOG6NLBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY4MDgyMQ==", "bodyText": "Collections.signletonMap (#2646 (comment))?", "url": "https://github.com/GoogleContainerTools/jib/pull/2646#discussion_r463680821", "createdAt": "2020-07-31T15:32:33Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -271,14 +273,22 @@ private void extractTar() {\n   }\n \n   private void assignLocalImageResult(Future<LocalImage> localImage) {\n-    results.baseImageLayers = executorService.submit(() -> localImage.get().layers);\n     results.baseImageAndRegistryClient =\n         executorService.submit(\n             () ->\n                 LocalBaseImageSteps.returnImageAndRegistryClientStep(\n-                        realizeFutures(results.baseImageLayers.get()),\n+                        realizeFutures(localImage.get().layers),\n                         localImage.get().configurationTemplate)\n                     .call());\n+\n+    results.baseImagesAndLayers =\n+        executorService.submit(\n+            () -> {\n+              Map<Image, List<Future<PreparedLayer>>> baseImageAndLayers = new HashMap<>();\n+              baseImageAndLayers.put(\n+                  results.baseImageAndRegistryClient.get().images.get(0), localImage.get().layers);\n+              return baseImageAndLayers;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6e956e65249fc09d98a0b7210e79ceb104b9cb8"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY4NjQwNA==", "bodyText": "I had missed this review", "url": "https://github.com/GoogleContainerTools/jib/pull/2646#discussion_r463686404", "createdAt": "2020-07-31T15:42:45Z", "author": {"login": "louismurerwa"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -271,14 +273,22 @@ private void extractTar() {\n   }\n \n   private void assignLocalImageResult(Future<LocalImage> localImage) {\n-    results.baseImageLayers = executorService.submit(() -> localImage.get().layers);\n     results.baseImageAndRegistryClient =\n         executorService.submit(\n             () ->\n                 LocalBaseImageSteps.returnImageAndRegistryClientStep(\n-                        realizeFutures(results.baseImageLayers.get()),\n+                        realizeFutures(localImage.get().layers),\n                         localImage.get().configurationTemplate)\n                     .call());\n+\n+    results.baseImagesAndLayers =\n+        executorService.submit(\n+            () -> {\n+              Map<Image, List<Future<PreparedLayer>>> baseImageAndLayers = new HashMap<>();\n+              baseImageAndLayers.put(\n+                  results.baseImageAndRegistryClient.get().images.get(0), localImage.get().layers);\n+              return baseImageAndLayers;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY4MDgyMQ=="}, "originalCommit": {"oid": "f6e956e65249fc09d98a0b7210e79ceb104b9cb8"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5NTU0MTk0OnYy", "diffSide": "RIGHT", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxNzo0OTo1NFrOG6Q6ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxNzo0OTo1NFrOG6Q6ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc0NzY5MA==", "bodyText": "baseImagesAndLayers", "url": "https://github.com/GoogleContainerTools/jib/pull/2646#discussion_r463747690", "createdAt": "2020-07-31T17:49:54Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -271,44 +274,56 @@ private void extractTar() {\n   }\n \n   private void assignLocalImageResult(Future<LocalImage> localImage) {\n-    results.baseImageLayers = executorService.submit(() -> localImage.get().layers);\n-    results.baseImageAndRegistryClient =\n+    results.baseImagesAndRegistryClient =\n         executorService.submit(\n             () ->\n                 LocalBaseImageSteps.returnImageAndRegistryClientStep(\n-                        realizeFutures(results.baseImageLayers.get()),\n+                        realizeFutures(localImage.get().layers),\n                         localImage.get().configurationTemplate)\n                     .call());\n+\n+    results.baseImagesAndLayers =\n+        executorService.submit(\n+            () ->\n+                Collections.singletonMap(\n+                    results.baseImagesAndRegistryClient.get().images.get(0),\n+                    localImage.get().layers));\n   }\n \n   private void pullBaseImage() {\n     ProgressEventDispatcher.Factory childProgressDispatcherFactory =\n         Verify.verifyNotNull(rootProgressDispatcher).newChildProducer();\n \n-    results.baseImageAndRegistryClient =\n+    results.baseImagesAndRegistryClient =\n         executorService.submit(new PullBaseImageStep(buildContext, childProgressDispatcherFactory));\n   }\n \n   private void obtainBaseImageLayers(boolean layersRequiredLocally) {\n     ProgressEventDispatcher.Factory childProgressDispatcherFactory =\n         Verify.verifyNotNull(rootProgressDispatcher).newChildProducer();\n-\n-    results.baseImageLayers =\n+    results.baseImagesAndLayers =\n         executorService.submit(\n-            () ->\n-                scheduleCallables(\n-                    layersRequiredLocally\n-                        ? ObtainBaseImageLayerStep.makeListForForcedDownload(\n-                            buildContext,\n-                            childProgressDispatcherFactory,\n-                            results.baseImageAndRegistryClient.get().images.get(0),\n-                            results.baseImageAndRegistryClient.get().registryClient)\n-                        : ObtainBaseImageLayerStep.makeListForSelectiveDownload(\n-                            buildContext,\n-                            childProgressDispatcherFactory,\n-                            results.baseImageAndRegistryClient.get().images.get(0),\n-                            results.baseImageAndRegistryClient.get().registryClient,\n-                            results.targetRegistryClient.get())));\n+            () -> {\n+              Map<Image, List<Future<PreparedLayer>>> baseImageAndLayers = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb761f1d80268b44e5b31faca9c60531fd621e83"}, "originalPosition": 76}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 76, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}