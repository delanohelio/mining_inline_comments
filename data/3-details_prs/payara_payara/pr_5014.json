{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4OTAwNjcy", "number": 5014, "title": "FISH-791 Update Hazelcast to 4.1, no tenant control", "bodyText": "Description\nDo what's necessary to upgrade to Hazelcast 4.1\nSome APIs changed significantly and some code needs to be reworked to take advantage\nImportant Info\nBlockers\n#5010\n#5012\nTesting\nNew tests\nExisting tests\nTesting Performed\nmanual testing, all test suites pass\nTesting Environment\nJDK 8, mac\nDocumentation\nNotes for Reviewers\nThis one seems big, but most changes are actually class renames\nThis PR does include the blocker PRs currently, because otherwise the tests don't pass.\nHowever, once the blocker PRs are merged, this will be rebased on master", "createdAt": "2020-11-28T06:31:13Z", "url": "https://github.com/payara/Payara/pull/5014", "merged": true, "mergeCommit": {"oid": "efb512eabc3f44b343ec9a9885dc4a1b5b78dbef"}, "closed": true, "closedAt": "2020-12-08T19:43:34Z", "author": {"login": "lprimak"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiomwsABqjQwNjkzNzY1NTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkPczqgFqTU0NzU0ODk1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3d5feea29ed662bc46f09dc6b682fc2b9110c526", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/3d5feea29ed662bc46f09dc6b682fc2b9110c526", "committedDate": "2020-12-03T19:29:19Z", "message": "Merge branch 'master' into Hz-Upgr-No-TC"}, "afterCommit": {"oid": "702af0073a00910630e06eb90bd7afd0ad0503f7", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/702af0073a00910630e06eb90bd7afd0ad0503f7", "committedDate": "2020-12-03T19:47:25Z", "message": "Disentangled - Upgrade Payara to Hazelcast 4.1"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aa1233367198d75109b0c63e6829580e9471df2b", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/aa1233367198d75109b0c63e6829580e9471df2b", "committedDate": "2020-12-03T22:00:56Z", "message": "Merge branch 'Fix-Clustered-Singleton-Bugs' into Hz-Upgr-No-TC"}, "afterCommit": {"oid": "e70cb90188a3fdb1b37a9c3bac8be36ac05339b0", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/e70cb90188a3fdb1b37a9c3bac8be36ac05339b0", "committedDate": "2020-12-03T22:03:52Z", "message": "Disentangled - Upgrade Payara to Hazelcast 4.1"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MTU5MDAx", "url": "https://github.com/payara/Payara/pull/5014#pullrequestreview-545159001", "createdAt": "2020-12-04T17:31:43Z", "commit": {"oid": "e70cb90188a3fdb1b37a9c3bac8be36ac05339b0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNzozMTo0M1rOH_ayEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNzozMTo0M1rOH_ayEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI2MTEzNg==", "bodyText": "Same recommendations as the other PR. Package needs changing, and to Lombok or not to Lombok", "url": "https://github.com/payara/Payara/pull/5014#discussion_r536261136", "createdAt": "2020-12-04T17:31:43Z", "author": {"login": "MattGill98"}, "path": "appserver/tests/payara-samples/samples/clustered-singleton/clustered-singleton-test/src/main/java/com/flowlogix/clust/singleton/ClusteredSingletonEjbXml.java", "diffHunk": "@@ -37,24 +37,25 @@\n  * only if the new code is made subject to such option by the copyright\n  * holder.\n  */\n-package fish.payara.nucleus.hazelcast;\n+package com.flowlogix.clust.singleton;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e70cb90188a3fdb1b37a9c3bac8be36ac05339b0"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1329329f204ae8d33bc9b938687823b370ff8db2", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/1329329f204ae8d33bc9b938687823b370ff8db2", "committedDate": "2020-12-04T22:29:55Z", "message": "Merge branch 'Fix-Clustered-Singleton-Bugs' into Hz-Upgr-No-TC"}, "afterCommit": {"oid": "c6ef8fa7f2474c30eb25fb95aef6018ef167146e", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/c6ef8fa7f2474c30eb25fb95aef6018ef167146e", "committedDate": "2020-12-05T05:37:44Z", "message": "Upgrade Payara to Hazelcast 4.1"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c6ef8fa7f2474c30eb25fb95aef6018ef167146e", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/c6ef8fa7f2474c30eb25fb95aef6018ef167146e", "committedDate": "2020-12-05T05:37:44Z", "message": "Upgrade Payara to Hazelcast 4.1"}, "afterCommit": {"oid": "fb81c7c8fad74ac0e1acc4a95acecdf294e6330a", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/fb81c7c8fad74ac0e1acc4a95acecdf294e6330a", "committedDate": "2020-12-05T05:43:56Z", "message": "Upgrade Payara to Hazelcast 4.1"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3Mjk1NjUw", "url": "https://github.com/payara/Payara/pull/5014#pullrequestreview-547295650", "createdAt": "2020-12-08T14:38:42Z", "commit": {"oid": "fb81c7c8fad74ac0e1acc4a95acecdf294e6330a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb81c7c8fad74ac0e1acc4a95acecdf294e6330a", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/fb81c7c8fad74ac0e1acc4a95acecdf294e6330a", "committedDate": "2020-12-05T05:43:56Z", "message": "Upgrade Payara to Hazelcast 4.1"}, "afterCommit": {"oid": "f4784f3fa724ce0029c23a7995f31c0b4c6bba5b", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/f4784f3fa724ce0029c23a7995f31c0b4c6bba5b", "committedDate": "2020-12-08T18:10:58Z", "message": "Upgrade Payara to Hazelcast 4.1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fcd8db2b9b707bd1bcb7f953e16036f44cf3453", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/9fcd8db2b9b707bd1bcb7f953e16036f44cf3453", "committedDate": "2020-12-08T18:29:14Z", "message": "Upgrade Payara to Hazelcast 4.1"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f4784f3fa724ce0029c23a7995f31c0b4c6bba5b", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/f4784f3fa724ce0029c23a7995f31c0b4c6bba5b", "committedDate": "2020-12-08T18:10:58Z", "message": "Upgrade Payara to Hazelcast 4.1"}, "afterCommit": {"oid": "9fcd8db2b9b707bd1bcb7f953e16036f44cf3453", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/9fcd8db2b9b707bd1bcb7f953e16036f44cf3453", "committedDate": "2020-12-08T18:29:14Z", "message": "Upgrade Payara to Hazelcast 4.1"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NTQ4OTU3", "url": "https://github.com/payara/Payara/pull/5014#pullrequestreview-547548957", "createdAt": "2020-12-08T19:12:40Z", "commit": {"oid": "9fcd8db2b9b707bd1bcb7f953e16036f44cf3453"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxOToxMjo0MVrOIBx1GA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxOTozMjowMVrOIBymWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODczNTg5Ng==", "bodyText": "Btw, could you kill all these comments?\n //To change body of generated methods, choose Tools | Templates.", "url": "https://github.com/payara/Payara/pull/5014#discussion_r538735896", "createdAt": "2020-12-08T19:12:41Z", "author": {"login": "dmatej"}, "path": "appserver/batch/hazelcast-jbatch-store/src/main/java/fish/payara/jbatch/persistence/hazelcast/HazelcastPersistenceService.java", "diffHunk": "@@ -56,8 +56,8 @@ and Distribution License(\"CDDL\") (collectively, the \"License\").  You\n     private IMap jobInstanceMap;\n     private IMap checkpointMAP;\n     private HazelcastInstance theInstance;\n-    private IdGenerator jobInstanceIdGenerator;\n-    private IdGenerator checkpointIdGenerator;\n+    private FlakeIdGenerator jobInstanceIdGenerator;\n+    private FlakeIdGenerator checkpointIdGenerator;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fcd8db2b9b707bd1bcb7f953e16036f44cf3453"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODczNzU1MQ==", "bodyText": "For other reviewers: getIdGenerator is deprecated, this is in it's javadoc:\n\nThe implementation can produce duplicate IDs in case of network split, even with split-brain protection enabled (during short window while split-brain is detected). Use getFlakeIdGenerator(String) for an alternative implementation which does not suffer from this problem.", "url": "https://github.com/payara/Payara/pull/5014#discussion_r538737551", "createdAt": "2020-12-08T19:15:16Z", "author": {"login": "dmatej"}, "path": "appserver/batch/hazelcast-jbatch-store/src/main/java/fish/payara/jbatch/persistence/hazelcast/HazelcastPersistenceService.java", "diffHunk": "@@ -274,8 +274,8 @@ public void init(IBatchConfig batchConfig) {\n             theInstance = HazelcastInstance.class.cast(ctx.lookup(hazelcastJNDIName));\n             jobInstanceMap = theInstance.getMap(JOB_INSTANCE_MAP);\n             checkpointMAP = theInstance.getMap(CHECKPOINTMAP);\n-            jobInstanceIdGenerator = theInstance.getIdGenerator(JOB_INSTANCE_MAP+\"ID\");\n-            checkpointIdGenerator = theInstance.getIdGenerator(CHECKPOINTMAP + \"ID\");\n+            jobInstanceIdGenerator = theInstance.getFlakeIdGenerator(JOB_INSTANCE_MAP+\"ID\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fcd8db2b9b707bd1bcb7f953e16036f44cf3453"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODczODA1MQ==", "bodyText": "Again, ILock is deprecated, FencedLock is used instead. Correct.", "url": "https://github.com/payara/Payara/pull/5014#discussion_r538738051", "createdAt": "2020-12-08T19:16:03Z", "author": {"login": "dmatej"}, "path": "appserver/common/container-common/src/main/java/com/sun/enterprise/container/common/impl/util/ClusteredSingletonLookupImplBase.java", "diffHunk": "@@ -63,7 +63,7 @@\n     private final String keyPrefix;\n     private final String mapKey;\n     private final AtomicReference<String> sessionHzKey = new AtomicReference<>();\n-    private final AtomicReference<ILock> lock = new AtomicReference<>();\n+    private final AtomicReference<FencedLock> lock = new AtomicReference<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fcd8db2b9b707bd1bcb7f953e16036f44cf3453"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc0MzU2NQ==", "bodyText": "Could you move those fields to the beginning of the class?", "url": "https://github.com/payara/Payara/pull/5014#discussion_r538743565", "createdAt": "2020-12-08T19:24:22Z", "author": {"login": "dmatej"}, "path": "nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/cluster/MemberEvent.java", "diffHunk": "@@ -39,31 +39,33 @@\n  */\n package fish.payara.nucleus.cluster;\n \n-import com.hazelcast.core.Member;\n+import com.hazelcast.cluster.Member;\n import fish.payara.nucleus.hazelcast.HazelcastCore;\n+import java.util.UUID;\n \n /**\n  *\n  * @author Steve Millidge (Payara Foundation)\n  */\n public class MemberEvent {\n     \n-    public MemberEvent(Member member) {\n+    public MemberEvent(HazelcastCore hzCore, Member member) {\n+        this.hzCore = hzCore;\n         this.member = member;\n     }\n     \n-    public String getUuid() {\n+    public UUID getUuid() {\n         return member.getUuid();\n     }\n     \n     public String getServer() {\n-        return member.getStringAttribute(HazelcastCore.INSTANCE_ATTRIBUTE);\n+        return hzCore.getAttribute(member.getUuid(), HazelcastCore.INSTANCE_ATTRIBUTE);\n     }\n     \n     public String getServerGroup() {\n-        return member.getStringAttribute(HazelcastCore.INSTANCE_GROUP_ATTRIBUTE);\n+        return member.getAttribute(HazelcastCore.INSTANCE_GROUP_ATTRIBUTE);\n     }\n     \n-    private Member member;\n-    \n+    private final HazelcastCore hzCore;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fcd8db2b9b707bd1bcb7f953e16036f44cf3453"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc0ODUwNw==", "bodyText": "Ok, seems this is related, it already did not work ...\nhazelcast/hazelcast#11867", "url": "https://github.com/payara/Payara/pull/5014#discussion_r538748507", "createdAt": "2020-12-08T19:32:01Z", "author": {"login": "dmatej"}, "path": "nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java", "diffHunk": "@@ -349,10 +368,7 @@ private Config buildConfiguration() {\n                 config.setLiteMember(Boolean.parseBoolean(nodeConfig.getLite()));\n \n \n-                // set group config\n-                GroupConfig gc = config.getGroupConfig();\n-                gc.setName(configuration.getClusterGroupName());\n-                gc.setPassword(configuration.getClusterGroupPassword());\n+                config.setClusterName(configuration.getClusterGroupName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fcd8db2b9b707bd1bcb7f953e16036f44cf3453"}, "originalPosition": 86}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 637, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}