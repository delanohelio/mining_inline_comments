{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4MTcyODEy", "number": 5009, "title": "FISH- 652 Fixed Error in MP JWT validation when retrieving JWKS key from remote location", "bodyText": "Fixes: #5017\nDescription\nWhen an application that is configured to use MP JWT authentication defines a remote public key location using the mp.jwt.verify.publickey.location MP configuration property, a parsing error of a public key in JWKS format will happen.\nThis fix properly gathers the contents of the remote key file.\nTesting Performed\nNo tests performed as there is no testing infrastructure for the MP JWT Authentication module\nDocumentation\nNo documentation needed", "createdAt": "2020-11-26T16:18:51Z", "url": "https://github.com/payara/Payara/pull/5009", "merged": true, "mergeCommit": {"oid": "c5a7c71ba9fead3f3bdd8daab756dc922109e6c1"}, "closed": true, "closedAt": "2020-12-15T09:24:19Z", "author": {"login": "fturizo"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgbZDmgFqTUzOTU3NTkyMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmW21pAFqTU1MjI1Mjk4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NTc1OTIx", "url": "https://github.com/payara/Payara/pull/5009#pullrequestreview-539575921", "createdAt": "2020-11-26T23:17:37Z", "commit": {"oid": "fde71f84d731e66a02045c5b7d706efc16f52985"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQyMzoxNzozN1rOH6o-Ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQyMzoxNzozN1rOH6o-Ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI1MDY5MA==", "bodyText": "Shouldn't you explicitly use a CharSet to read from the stream (using the InputStreamReader ctor with CharSet) instead of using the system default CharSet? You might be able to determine the correct encoding by using  getContentEncoding() before actually reading the content.", "url": "https://github.com/payara/Payara/pull/5009#discussion_r531250690", "createdAt": "2020-11-26T23:17:37Z", "author": {"login": "svendiedrichsen"}, "path": "appserver/payara-appserver-modules/microprofile/jwt-auth/src/main/java/fish/payara/microprofile/jwtauth/eesecurity/SignedJWTIdentityStore.java", "diffHunk": "@@ -211,10 +214,10 @@ public CredentialValidationResult validate(SignedJWTCredential signedJWTCredenti\n             return Optional.empty();\n         }\n \n-        byte[] byteBuffer = new byte[16384];\n-        try (InputStream inputStream = publicKeyURL.openStream()) {\n-            String key = new String(byteBuffer, 0, inputStream.read(byteBuffer));\n-            return createPublicKey(key, keyID);\n+        try (InputStream inputStream = publicKeyURL.openStream();\n+             BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream))){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fde71f84d731e66a02045c5b7d706efc16f52985"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NTY1Njg1", "url": "https://github.com/payara/Payara/pull/5009#pullrequestreview-544565685", "createdAt": "2020-12-04T00:15:13Z", "commit": {"oid": "9d0a249d3e0488950f7a520a3106cef2765a315e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMDoxNToxNFrOH-7Cpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMDoxNToxNFrOH-7Cpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc0MTA5NA==", "bodyText": "You might set the Accept-Charset header before opening the connection thus asking for a Charset. Charset.availableCharsets(), https://tools.ietf.org/html/rfc2616#page-102", "url": "https://github.com/payara/Payara/pull/5009#discussion_r535741094", "createdAt": "2020-12-04T00:15:14Z", "author": {"login": "svendiedrichsen"}, "path": "appserver/payara-appserver-modules/microprofile/jwt-auth/src/main/java/fish/payara/microprofile/jwtauth/eesecurity/SignedJWTIdentityStore.java", "diffHunk": "@@ -214,8 +223,12 @@ public CredentialValidationResult validate(SignedJWTCredential signedJWTCredenti\n             return Optional.empty();\n         }\n \n-        try (InputStream inputStream = publicKeyURL.openStream();\n-             BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream))){\n+        URLConnection urlConnection = publicKeyURL.openConnection();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d0a249d3e0488950f7a520a3106cef2765a315e"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NTcxNTEz", "url": "https://github.com/payara/Payara/pull/5009#pullrequestreview-544571513", "createdAt": "2020-12-04T00:30:28Z", "commit": {"oid": "9d0a249d3e0488950f7a520a3106cef2765a315e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMDozMDoyOFrOH-7aBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMDozMDoyOFrOH-7aBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc0NzA3Nw==", "bodyText": "You might want to check if the charset from the contentType is supported besides if the contentType contains one. Otherwise you might get an UnsupportedCharsetException here. Charset.isSupported()", "url": "https://github.com/payara/Payara/pull/5009#discussion_r535747077", "createdAt": "2020-12-04T00:30:28Z", "author": {"login": "svendiedrichsen"}, "path": "appserver/payara-appserver-modules/microprofile/jwt-auth/src/main/java/fish/payara/microprofile/jwtauth/eesecurity/SignedJWTIdentityStore.java", "diffHunk": "@@ -214,8 +223,12 @@ public CredentialValidationResult validate(SignedJWTCredential signedJWTCredenti\n             return Optional.empty();\n         }\n \n-        try (InputStream inputStream = publicKeyURL.openStream();\n-             BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream))){\n+        URLConnection urlConnection = publicKeyURL.openConnection();\n+        ContentType contentType = ContentType.newContentType(urlConnection.getContentType());\n+\n+        Charset charset = contentType.getCharacterEncoding() != null ? Charset.forName(contentType.getCharacterEncoding()) : Charset.defaultCharset();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d0a249d3e0488950f7a520a3106cef2765a315e"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NTcyNDU3", "url": "https://github.com/payara/Payara/pull/5009#pullrequestreview-544572457", "createdAt": "2020-12-04T00:32:54Z", "commit": {"oid": "9d0a249d3e0488950f7a520a3106cef2765a315e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMDozMjo1NVrOH-7dmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMDozMjo1NVrOH-7dmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc0Nzk5NA==", "bodyText": "ContentType may be NULL here.", "url": "https://github.com/payara/Payara/pull/5009#discussion_r535747994", "createdAt": "2020-12-04T00:32:55Z", "author": {"login": "svendiedrichsen"}, "path": "appserver/payara-appserver-modules/microprofile/jwt-auth/src/main/java/fish/payara/microprofile/jwtauth/eesecurity/SignedJWTIdentityStore.java", "diffHunk": "@@ -214,8 +223,12 @@ public CredentialValidationResult validate(SignedJWTCredential signedJWTCredenti\n             return Optional.empty();\n         }\n \n-        try (InputStream inputStream = publicKeyURL.openStream();\n-             BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream))){\n+        URLConnection urlConnection = publicKeyURL.openConnection();\n+        ContentType contentType = ContentType.newContentType(urlConnection.getContentType());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d0a249d3e0488950f7a520a3106cef2765a315e"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MTU4MDM4", "url": "https://github.com/payara/Payara/pull/5009#pullrequestreview-545158038", "createdAt": "2020-12-04T17:30:24Z", "commit": {"oid": "9d0a249d3e0488950f7a520a3106cef2765a315e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "deaad8c982922a04933262668523d9615307d88b", "author": {"user": {"login": "fturizo", "name": "Fabio Turizo"}}, "url": "https://github.com/payara/Payara/commit/deaad8c982922a04933262668523d9615307d88b", "committedDate": "2020-12-04T20:00:08Z", "message": "Fixed public key retrieval from remote URL"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9d0a249d3e0488950f7a520a3106cef2765a315e", "author": {"user": {"login": "fturizo", "name": "Fabio Turizo"}}, "url": "https://github.com/payara/Payara/commit/9d0a249d3e0488950f7a520a3106cef2765a315e", "committedDate": "2020-12-03T22:45:21Z", "message": "Merge remote-tracking branch 'origin/FISH-652_JWT_public_key_retrieval_jwks_fix' into FISH-652_JWT_public_key_retrieval_jwks_fix\n\n# Conflicts:\n#\tappserver/payara-appserver-modules/microprofile/jwt-auth/src/main/java/fish/payara/microprofile/jwtauth/eesecurity/SignedJWTIdentityStore.java"}, "afterCommit": {"oid": "deaad8c982922a04933262668523d9615307d88b", "author": {"user": {"login": "fturizo", "name": "Fabio Turizo"}}, "url": "https://github.com/payara/Payara/commit/deaad8c982922a04933262668523d9615307d88b", "committedDate": "2020-12-04T20:00:08Z", "message": "Fixed public key retrieval from remote URL"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc0f924090f4f32a0943db0ed501331f9178dfce", "author": {"user": {"login": "fturizo", "name": "Fabio Turizo"}}, "url": "https://github.com/payara/Payara/commit/bc0f924090f4f32a0943db0ed501331f9178dfce", "committedDate": "2020-12-04T21:23:34Z", "message": "Minor fixes to charset encoding usage"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1NzI4NDgw", "url": "https://github.com/payara/Payara/pull/5009#pullrequestreview-545728480", "createdAt": "2020-12-06T17:06:18Z", "commit": {"oid": "bc0f924090f4f32a0943db0ed501331f9178dfce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNlQxNzowNjoxOVrOIAM2rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNlQxNzowNjoxOVrOIAM2rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzA4MTUxOQ==", "bodyText": "Charset.isSupported() may throw exceptions if anything funny or NULL is provided. And if it is not supported it might rather be worth a warning than a severe message. Sorry for all the picky comments.", "url": "https://github.com/payara/Payara/pull/5009#discussion_r537081519", "createdAt": "2020-12-06T17:06:19Z", "author": {"login": "svendiedrichsen"}, "path": "appserver/payara-appserver-modules/microprofile/jwt-auth/src/main/java/fish/payara/microprofile/jwtauth/eesecurity/SignedJWTIdentityStore.java", "diffHunk": "@@ -217,10 +218,21 @@ public CredentialValidationResult validate(SignedJWTCredential signedJWTCredenti\n             return Optional.empty();\n         }\n \n-        byte[] byteBuffer = new byte[16384];\n-        try (InputStream inputStream = publicKeyURL.openStream()) {\n-            String key = new String(byteBuffer, 0, inputStream.read(byteBuffer));\n-            return createPublicKey(key, keyID);\n+        URLConnection urlConnection = publicKeyURL.openConnection();\n+        Charset charset = Charset.defaultCharset();\n+        ContentType contentType = ContentType.newContentType(urlConnection.getContentType());\n+        if(contentType != null) {\n+            String charEncoding = contentType.getCharacterEncoding();\n+            if(!Charset.isSupported(charEncoding)){\n+                LOGGER.severe(\"Charset \" + charEncoding + \" for remote public key not supported, using default charset instead\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc0f924090f4f32a0943db0ed501331f9178dfce"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53712e2d65f4be49eaff7ea2b6d5a3ddaed06b54", "author": {"user": {"login": "fturizo", "name": "Fabio Turizo"}}, "url": "https://github.com/payara/Payara/commit/53712e2d65f4be49eaff7ea2b6d5a3ddaed06b54", "committedDate": "2020-12-11T22:22:45Z", "message": "Minor fixes to charset encoding usage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcbf36f1522637d6964224213e004855afe79c48", "author": {"user": {"login": "fturizo", "name": "Fabio Turizo"}}, "url": "https://github.com/payara/Payara/commit/dcbf36f1522637d6964224213e004855afe79c48", "committedDate": "2020-12-11T22:29:03Z", "message": "Merge branch 'FISH-652_JWT_public_key_retrieval_jwks_fix' of https://github.com/fturizo/Payara into FISH-652_JWT_public_key_retrieval_jwks_fix\n\n\u0001 Conflicts:\n\u0001\tappserver/payara-appserver-modules/microprofile/jwt-auth/src/main/java/fish/payara/microprofile/jwtauth/eesecurity/SignedJWTIdentityStore.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxNzQ1OTQ4", "url": "https://github.com/payara/Payara/pull/5009#pullrequestreview-551745948", "createdAt": "2020-12-14T18:06:32Z", "commit": {"oid": "dcbf36f1522637d6964224213e004855afe79c48"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMjUyOTgx", "url": "https://github.com/payara/Payara/pull/5009#pullrequestreview-552252981", "createdAt": "2020-12-15T09:24:10Z", "commit": {"oid": "dcbf36f1522637d6964224213e004855afe79c48"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 627, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}