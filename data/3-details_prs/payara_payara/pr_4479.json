{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyODIxNjY5", "number": 4479, "title": " FISH-766 Improper session synchronization of session map", "bodyText": "Description\nThis is a bug fix of #4280\n\n\n\nImportant Info\nDependant PRs \n\nBlockers \n\nTesting\nNew tests\n\nnone\nTesting Performed\n\nnone\nTest suites executed\n\nnone\nTesting Environment\n\nDocumentation\n\nNotes for Reviewers\n\nReviewer should check the synchronization was incorrect (asymetric) and now each write attempt is locked to prevent readers to receive ConcurrentModificationException.", "createdAt": "2020-02-09T12:11:30Z", "url": "https://github.com/payara/Payara/pull/4479", "merged": true, "mergeCommit": {"oid": "0892dff883e46bf5b1203aed626e361c3ffe2a24"}, "closed": true, "closedAt": "2020-11-18T16:13:03Z", "author": {"login": "sgflt"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcCnXD4gH2gAyMzcyODIxNjY5OjVkNmU3Y2RlOWMyZjNiYzBhNmM0ZjIyOWVhZjQyOTBmMTBmYjljMjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc4JbU1AFqTQ1NTE0MzYxNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5d6e7cde9c2f3bc0a6c4f229eaf4290f10fb9c28", "author": {"user": {"login": "sgflt", "name": "Luk\u00e1\u0161 Kv\u00eddera"}}, "url": "https://github.com/payara/Payara/commit/5d6e7cde9c2f3bc0a6c4f229eaf4290f10fb9c28", "committedDate": "2020-02-09T12:05:25Z", "message": "#4280 Fixed synchronization issue\n\n- cache could be read by another thread and put caused ConcurrentModificationException"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3215ce90e977dbc79fa334fdb174056564e123ab", "author": {"user": {"login": "sgflt", "name": "Luk\u00e1\u0161 Kv\u00eddera"}}, "url": "https://github.com/payara/Payara/commit/3215ce90e977dbc79fa334fdb174056564e123ab", "committedDate": "2020-02-09T12:06:28Z", "message": "#4281 Added final modifier to field\n\n- synchronization object should be final, that is what Sonar said"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MTc1MDQz", "url": "https://github.com/payara/Payara/pull/4479#pullrequestreview-436175043", "createdAt": "2020-06-23T21:34:36Z", "commit": {"oid": "3215ce90e977dbc79fa334fdb174056564e123ab"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c64922eddf44cb95778c2944fab169ae49ba07a", "author": {"user": {"login": "sgflt", "name": "Luk\u00e1\u0161 Kv\u00eddera"}}, "url": "https://github.com/payara/Payara/commit/6c64922eddf44cb95778c2944fab169ae49ba07a", "committedDate": "2020-07-19T09:42:19Z", "message": "Merge remote-tracking branch 'upstream/master' into issue-4280-improper-session-synchronization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b298f292cd383ea3aab7ad244f0d4ce649a6a4e9", "author": {"user": {"login": "sgflt", "name": "Luk\u00e1\u0161 Kv\u00eddera"}}, "url": "https://github.com/payara/Payara/commit/b298f292cd383ea3aab7ad244f0d4ce649a6a4e9", "committedDate": "2020-07-19T14:36:06Z", "message": "#4280 Replaced HashMap by ConcurrentHashMap in SingleSignOn"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a00f8661257c07e46957518030db647cc9a2f5eb", "author": {"user": {"login": "sgflt", "name": "Luk\u00e1\u0161 Kv\u00eddera"}}, "url": "https://github.com/payara/Payara/commit/a00f8661257c07e46957518030db647cc9a2f5eb", "committedDate": "2020-07-19T14:51:07Z", "message": "#4280 clean up code in GlassFishSingleSignOn"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1754479be3492e23a792c72b09b5dc18fbef66b4", "author": {"user": {"login": "sgflt", "name": "Luk\u00e1\u0161 Kv\u00eddera"}}, "url": "https://github.com/payara/Payara/commit/1754479be3492e23a792c72b09b5dc18fbef66b4", "committedDate": "2020-07-19T16:41:43Z", "message": "#4280 Fixed unwanted double expiration\n\n- as found before isValid has expiration side effect\n- checkValid flag is meant to be short circuit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMTQ4NzE0", "url": "https://github.com/payara/Payara/pull/4479#pullrequestreview-451148714", "createdAt": "2020-07-19T17:19:16Z", "commit": {"oid": "b298f292cd383ea3aab7ad244f0d4ce649a6a4e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOVQxNzoxOToxNlrOGzw-bQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOVQxNzoxOToxNlrOGzw-bQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjkzMjk3Mw==", "bodyText": "There is a little change in behavior.\nOld implementation locked SSOs and created a list of expired SSOs. No one could create a new SSO.\nNew implementation uses what is available and does not block creation of a new SSO (which is not taken for expiration in given round). However probability of a new SSO being expired is so small so I think this change should be OK for a real world usage.", "url": "https://github.com/payara/Payara/pull/4479#discussion_r456932973", "createdAt": "2020-07-19T17:19:16Z", "author": {"login": "sgflt"}, "path": "appserver/web/web-glue/src/main/java/com/sun/enterprise/security/web/GlassFishSingleSignOn.java", "diffHunk": "@@ -464,44 +461,38 @@ private void processExpires() {\n         long tooOld = System.currentTimeMillis() - ssoMaxInactive * 1000L;\n         // S1AS8 6155481 START\n         if (logger.isLoggable(Level.FINE)) {\n-            logger.log(Level.FINE, LogFacade.SSO_EXPIRATION_STARTED, cache.size());\n+            logger.log(Level.FINE, LogFacade.SSO_EXPIRATION_STARTED, this.cache.size());\n         }\n         // S1AS8 6155481 END\n-        ArrayList<String> removals = new ArrayList<String>(cache.size() / 2);\n+        final ArrayList<String> removals = new ArrayList<>(this.cache.size() / 2);\n \n         // build list of removal targets\n \n         // Note that only those SSO entries which are NOT associated with\n-        // any session are elegible for removal here.\n+        // any session are eligible for removal here.\n         // Currently no session association ever happens so this covers all\n         // SSO entries. However, this should be addressed separately.\n \n         try {\n-            synchronized (cache) {\n-\n-                Iterator<String> it = cache.keySet().iterator();\n-                while (it.hasNext()) {\n-                    String key = it.next();\n-                    SingleSignOnEntry sso = (SingleSignOnEntry) cache.get(key);\n-                    if (sso.isEmpty() && sso.getLastAccessTime() < tooOld) {\n-                        removals.add(key);\n-                    }\n+            this.cache.forEach((ssoId, sso) -> {\n+                if (sso.isEmpty() && sso.getLastAccessTime() < tooOld) {\n+                    removals.add(ssoId);\n                 }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b298f292cd383ea3aab7ad244f0d4ce649a6a4e9"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc434539515df15138c4d743f91f744c8e843037", "author": {"user": {"login": "sgflt", "name": "Luk\u00e1\u0161 Kv\u00eddera"}}, "url": "https://github.com/payara/Payara/commit/dc434539515df15138c4d743f91f744c8e843037", "committedDate": "2020-07-19T18:04:04Z", "message": "#4280 Deleted unused variable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bef9a8250ea63bfbb8c6c5a03b5e85580bcad80b", "author": {"user": {"login": "sgflt", "name": "Luk\u00e1\u0161 Kv\u00eddera"}}, "url": "https://github.com/payara/Payara/commit/bef9a8250ea63bfbb8c6c5a03b5e85580bcad80b", "committedDate": "2020-07-19T18:07:08Z", "message": "#4280 Fixed contract violation of findSessions\n\n- no null is allowed, only empty collection"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMTUzMzcz", "url": "https://github.com/payara/Payara/pull/4479#pullrequestreview-451153373", "createdAt": "2020-07-19T18:32:32Z", "commit": {"oid": "bef9a8250ea63bfbb8c6c5a03b5e85580bcad80b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOVQxODozMjozMlrOGzxakA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOVQxODozMjozMlrOGzxakA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk0MDE3Ng==", "bodyText": "nullcheck for broken contract removed", "url": "https://github.com/payara/Payara/pull/4479#discussion_r456940176", "createdAt": "2020-07-19T18:32:32Z", "author": {"login": "sgflt"}, "path": "appserver/web/web-core/src/main/java/org/apache/catalina/session/StandardManager.java", "diffHunk": "@@ -985,16 +982,14 @@ public void processExpires() {\n \n         long timeNow = System.currentTimeMillis();\n \n-        Session[] sessions = findSessions();\n-        if (sessions != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bef9a8250ea63bfbb8c6c5a03b5e85580bcad80b"}, "originalPosition": 70}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMTUzMzk4", "url": "https://github.com/payara/Payara/pull/4479#pullrequestreview-451153398", "createdAt": "2020-07-19T18:32:44Z", "commit": {"oid": "bef9a8250ea63bfbb8c6c5a03b5e85580bcad80b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOVQxODozMjo0NVrOGzxaoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOVQxODozMjo0NVrOGzxaoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk0MDE5Mg==", "bodyText": "nullcheck for broken contract removed", "url": "https://github.com/payara/Payara/pull/4479#discussion_r456940192", "createdAt": "2020-07-19T18:32:45Z", "author": {"login": "sgflt"}, "path": "appserver/web/web-core/src/main/java/org/apache/catalina/session/StandardManager.java", "diffHunk": "@@ -882,21 +881,19 @@ public void stop(boolean isShutdown) throws LifecycleException {\n         }\n \n         // Expire all active sessions and notify their listeners\n-        Session sessions[] = findSessions();\n-        if (sessions != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bef9a8250ea63bfbb8c6c5a03b5e85580bcad80b"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMTUzNDI0", "url": "https://github.com/payara/Payara/pull/4479#pullrequestreview-451153424", "createdAt": "2020-07-19T18:33:06Z", "commit": {"oid": "bef9a8250ea63bfbb8c6c5a03b5e85580bcad80b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOVQxODozMzowNlrOGzxaxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOVQxODozMzowNlrOGzxaxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk0MDIzMQ==", "bodyText": "broken contract fixed", "url": "https://github.com/payara/Payara/pull/4479#discussion_r456940231", "createdAt": "2020-07-19T18:33:06Z", "author": {"login": "sgflt"}, "path": "appserver/web/web-core/src/main/java/org/apache/catalina/session/CookiePersistentManager.java", "diffHunk": "@@ -111,8 +111,8 @@ public void clearSessions() {\n     }\n \n     @Override\n-    public Session[] findSessions() {\n-        return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bef9a8250ea63bfbb8c6c5a03b5e85580bcad80b"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MTQzNjE2", "url": "https://github.com/payara/Payara/pull/4479#pullrequestreview-455143616", "createdAt": "2020-07-24T19:44:50Z", "commit": {"oid": "bef9a8250ea63bfbb8c6c5a03b5e85580bcad80b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 863, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}