{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2MTUzMjM0", "number": 4570, "title": "ECOSYS-118 OpenID Connect session timeout association with access and/or identity token expiry", "bodyText": "Description\nThis is a feature to validate the Access Token and/or Identity Token expiry and setting the correct expiry datatype.\nIt also provides the support for end_session_endpoint to redirect the User-Agent to the OP logout page after the log out from the RP application.\nTo enable the validation, add the @LogoutDefinition to @OpenIdAuthenticationDefinition or respective provider annotation:\n@OpenIdAuthenticationDefinition(\n        clientId = \"xxxxxxxxxxxxxxxxxxx\",\n        clientSecret = \"xxxxxxxxxxxxxxx\",\n        tokenAutoRefresh = true,\n       ........\n        logout = @LogoutDefinition(\n                notifyProvider = true,\n                redirectURI = \"${baseURL}/logout.html\",\n                accessTokenExpiry = false,\n                identityTokenExpiry = false\n        ),\n       ........\n)\n\n\n@LogoutDefinition#notifyProvider: Notify the OIDC provider (OP) that the user has logged out of the application and might want to log out of the OP as well. If true then after having logged out the user from RP, redirects the End-User's User Agent to the OP's logout endpoint URL end_session_endpoint.\n@LogoutDefinition#redirectURI: The post logout redirect URI to which the RP is requesting that the End-User's User Agent be redirected after a logout has been performed. If redirect URI is empty then redirect to OpenID connect provider authorization_endpoint for re-authentication.\n@LogoutDefinition#accessTokenExpiry:  Invalidates the session on the expiry of Access Token.\n@LogoutDefinition#identityTokenExpiry:  Invalidates the session on the expiry of Identity Token.\n\nProgrammatic logout:\nProgrammatic logout feature via OpenIdContext#logout() function which Invalidates the RP's active OpenId Connect session and if fish.payara.security.annotations.LogoutDefinition#notifyProvider set to true then redirects the End-User's User Agent to the end_session_endpoint to notify the OP that the user has logged out of the RP's application and ask the user whether they want to logout from the OP as well. After successful logout, the End-User's User Agent redirect back to the RP's post_redirect_uri  configured via fish.payara.security.annotations.LogoutDefinition#redirectURI\nRelated PRs\npayara/ecosystem-security-connectors#24\nTesting\nTesting Performed\nManual tested with Google and Azure OIDC provider\n@LogoutDefinition#notifyProvider feature tested on Azure OIDC provider as end_session_endpoint not available on Google OIDC provider metadata.", "createdAt": "2020-03-10T14:05:05Z", "url": "https://github.com/payara/Payara/pull/4570", "merged": true, "mergeCommit": {"oid": "94d766196f025373e08c8c7a178c524479ce0010"}, "closed": true, "closedAt": "2020-07-07T09:37:57Z", "author": {"login": "jGauravGupta"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMS-OjAH2gAyMzg2MTUzMjM0OjgzZjIzYWQ3NDVlMzg1MjRlNTMyZTVkYWNjZjQ3ZDZiMDBjZWU2OGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcw6V-ygFqTQ0MTQ0ODYzNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "83f23ad745e38524e532e5daccf47d6b00cee68f", "author": {"user": {"login": "jGauravGupta", "name": "Gaurav Gupta"}}, "url": "https://github.com/payara/Payara/commit/83f23ad745e38524e532e5daccf47d6b00cee68f", "committedDate": "2020-03-10T13:59:26Z", "message": "ECOSYS-118 Validate AccessToken expiry on each request"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1OTk2MDYy", "url": "https://github.com/payara/Payara/pull/4570#pullrequestreview-375996062", "createdAt": "2020-03-17T12:41:48Z", "commit": {"oid": "83f23ad745e38524e532e5daccf47d6b00cee68f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f660aa5a4b09f138fded6c0b985697e8a00b0163", "author": {"user": {"login": "jGauravGupta", "name": "Gaurav Gupta"}}, "url": "https://github.com/payara/Payara/commit/f660aa5a4b09f138fded6c0b985697e8a00b0163", "committedDate": "2020-03-23T11:37:18Z", "message": "ECOSYS-118 COPYRIGHT YEAR update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5Mzc1MDA5", "url": "https://github.com/payara/Payara/pull/4570#pullrequestreview-379375009", "createdAt": "2020-03-23T12:18:23Z", "commit": {"oid": "f660aa5a4b09f138fded6c0b985697e8a00b0163"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5a4900b3e1f812e240f54ee4b7ea6589e2fe66a", "author": {"user": {"login": "jGauravGupta", "name": "Gaurav Gupta"}}, "url": "https://github.com/payara/Payara/commit/c5a4900b3e1f812e240f54ee4b7ea6589e2fe66a", "committedDate": "2020-05-28T11:15:39Z", "message": "Fixes expires_in claim datatype\n\nSigned-off-by: Gaurav Gupta <gaurav.gupta@payara.fish>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55d4f549214950d3773b45e7808a579de791736d", "author": {"user": {"login": "jGauravGupta", "name": "Gaurav Gupta"}}, "url": "https://github.com/payara/Payara/commit/55d4f549214950d3773b45e7808a579de791736d", "committedDate": "2020-05-29T10:32:42Z", "message": "ECOSYS-118 OpenID Connect session timeout association with access and/or identity token expiry\n\nSigned-off-by: Gaurav Gupta <gaurav.gupta@payara.fish>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ee958716ac29b63fd7c623108732fec66fc5228", "author": {"user": {"login": "jGauravGupta", "name": "Gaurav Gupta"}}, "url": "https://github.com/payara/Payara/commit/5ee958716ac29b63fd7c623108732fec66fc5228", "committedDate": "2020-06-01T04:27:47Z", "message": "ECOSYS-118 OpenID Connect end_session_endpoint support\n\nSigned-off-by: Gaurav Gupta <gaurav.gupta@payara.fish>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyNzI5Mjcw", "url": "https://github.com/payara/Payara/pull/4570#pullrequestreview-422729270", "createdAt": "2020-06-02T14:20:54Z", "commit": {"oid": "5ee958716ac29b63fd7c623108732fec66fc5228"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NzEzNjUx", "url": "https://github.com/payara/Payara/pull/4570#pullrequestreview-425713651", "createdAt": "2020-06-06T04:51:20Z", "commit": {"oid": "5ee958716ac29b63fd7c623108732fec66fc5228"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQwNDo1MToyMVrOGgB2RQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQwNDo1MToyMVrOGgB2RQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIzNzg5Mw==", "bodyText": "They way you've nested this means that tokenAutoRefresh is ignored if at least one of accessTokenExpiry or identityTokenExpiry isn't true.\nOn one hand, I think this makes sense because if a user has set tokenAutoRefresh then logically the application requires a valid access token to function. On the other hand, maybe someone wants to automatically refresh tokens, but they don't want the user to be logged-out if the tokens expire.\nIf this is the intended behaviour, then the documentation should be clear that tokenAutoRefresh only works when at least one of accessTokenExpiry or identityTokenExpiry is set.", "url": "https://github.com/payara/Payara/pull/4570#discussion_r436237893", "createdAt": "2020-06-06T04:51:21Z", "author": {"login": "sharpedavid"}, "path": "appserver/payara-appserver-modules/security-openid/src/main/java/fish/payara/security/openid/OpenIdAuthenticationMechanism.java", "diffHunk": "@@ -214,9 +220,30 @@ public AuthenticationStatus validateRequest(\n                 throw new AuthenticationException(\"Failed to register CallerPrincipalCallback.\", ex);\n             }\n \n-            if (configuration.isTokenAutoRefresh()) {\n+            LogoutConfiguration logout = configuration.getLogoutConfiguration();\n+            boolean accessTokenExpired = this.context.getAccessToken().isExpired();\n+            boolean identityTokenExpired = this.context.getIdentityToken().isExpired();\n+            if (logout.isIdentityTokenExpiry()) {\n+                LOGGER.log(Level.FINE, \"UserPrincipal is set, check if Identity Token is valid.\");\n+            }\n+            if (logout.isAccessTokenExpiry()) {\n                 LOGGER.log(Level.FINE, \"UserPrincipal is set, check if Access Token is valid.\");\n-                return this.reAuthenticate(request, response, httpContext);\n+            }\n+\n+            if((logout.isAccessTokenExpiry() && accessTokenExpired)\n+                    || (logout.isIdentityTokenExpiry() && identityTokenExpired)) {\n+                if (configuration.isTokenAutoRefresh()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ee958716ac29b63fd7c623108732fec66fc5228"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90796d0f57137e588776d40b495a05c068be6c3c", "author": {"user": {"login": "jGauravGupta", "name": "Gaurav Gupta"}}, "url": "https://github.com/payara/Payara/commit/90796d0f57137e588776d40b495a05c068be6c3c", "committedDate": "2020-06-06T17:33:28Z", "message": "ECOSYS-118 OpenID Connect programmatic logout via OpenIdContext\n\nSigned-off-by: Gaurav Gupta <gaurav.gupta@payara.fish>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fc420e967ab3d5507d6bed1c991e81bcdf9d9c8", "author": {"user": {"login": "jGauravGupta", "name": "Gaurav Gupta"}}, "url": "https://github.com/payara/Payara/commit/4fc420e967ab3d5507d6bed1c991e81bcdf9d9c8", "committedDate": "2020-06-06T17:40:06Z", "message": "Merge branch 'master' into ECOSYS-118"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxNDQ4NjM1", "url": "https://github.com/payara/Payara/pull/4570#pullrequestreview-441448635", "createdAt": "2020-07-02T08:12:57Z", "commit": {"oid": "4fc420e967ab3d5507d6bed1c991e81bcdf9d9c8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 780, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}