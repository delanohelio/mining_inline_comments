{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3NDMxMDY0", "number": 4457, "title": "CUSTCOM-24 Restore Persistent EJB Timers on Payara Micro Restart", "bodyText": "Description\nThis is a bug fix. \nWhen stopping and starting a Payara Micro instance with a static name (--name) and an EJB timer running, the timer will be stored to be resumed, but won't actually run. This is caused by an inconsistent EJB container ID, which in turn is caused by an inconsistent application unique ID. This re-implements old functionality to remove the CDI event that fires to reconfigure the application unique ID from the clustered store.\n\nFixes #4103\n\n\nTesting\nNew tests\n\nTesting Performed\n\nReproducer in linked issue (just the application outside of docker).\nTo repeat: run two Payara Micro instances with:\njava -jar payara-micro-5.201-SNAPSHOT.jar --name micro1 --autobindhttp --deploy sample-service.war\n\njava -jar payara-micro-5.201-SNAPSHOT.jar --name micro2 --autobindhttp --deploy sample-service.war\n\nTrigger the timer on one of the instances:\ncurl -X GET localhost:8080/timers/start-timer\n\nRestart the instance with the timer running, and the timer should start again.\nTest suites executed\n\n\nJava EE7 Samples\n\nNotes for Reviewers\n\n\nThe commits reference several commits that introduced the bug, but they should be taken into account in the review.", "createdAt": "2020-01-27T11:04:18Z", "url": "https://github.com/payara/Payara/pull/4457", "merged": true, "mergeCommit": {"oid": "c9040f870d0478a8ed8bbe386c9dd772a33ab3d5"}, "closed": true, "closedAt": "2020-02-04T14:10:59Z", "author": {"login": "MattGill98"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-awihgBqjI5ODEzNzExNDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_cehJAH2gAyMzY3NDMxMDY0OmVmM2RjMWViZDljMGU5NzM3YzUzOGJiNTgyOTAyY2VjZjBjYzY0YzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8cf78c6d468c5451a716377b01c1584e5a341d48", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/8cf78c6d468c5451a716377b01c1584e5a341d48", "committedDate": "2020-01-27T10:32:20Z", "message": "Prevent NPE in JobCleanUpService\n\nWhen starting Payara Micro, the cleanup service will return a NPE due to\nthe executor also being null. This change allows the service to disable\nitself, and doing so will cause each method to be disabled.\n\nThis was a bug introduced in 5033d8edb3bb22d797cd8ddf0aa4b47380e1a227."}, "afterCommit": {"oid": "463bd2cef9e7be6de62ec4fea7e1af51d741971b", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/463bd2cef9e7be6de62ec4fea7e1af51d741971b", "committedDate": "2020-01-27T11:08:22Z", "message": "CUSTCOM-24 Prevent NPE in JobCleanUpService\n\nWhen starting Payara Micro, the cleanup service will return a NPE due to\nthe executor also being null. This change allows the service to disable\nitself, and doing so will cause each method to be disabled.\n\nThis was a bug introduced in 5033d8edb3bb22d797cd8ddf0aa4b47380e1a227.\n\nSigned-off-by: Matt Gill <matthew.gill@live.co.uk>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "463bd2cef9e7be6de62ec4fea7e1af51d741971b", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/463bd2cef9e7be6de62ec4fea7e1af51d741971b", "committedDate": "2020-01-27T11:08:22Z", "message": "CUSTCOM-24 Prevent NPE in JobCleanUpService\n\nWhen starting Payara Micro, the cleanup service will return a NPE due to\nthe executor also being null. This change allows the service to disable\nitself, and doing so will cause each method to be disabled.\n\nThis was a bug introduced in 5033d8edb3bb22d797cd8ddf0aa4b47380e1a227.\n\nSigned-off-by: Matt Gill <matthew.gill@live.co.uk>"}, "afterCommit": {"oid": "9e7fe2d38700121fb7b919fee0bdce89a5a45426", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/9e7fe2d38700121fb7b919fee0bdce89a5a45426", "committedDate": "2020-01-27T11:10:32Z", "message": "CUSTCOM-24 Prevent NPE in JobCleanUpService\n\nWhen starting Payara Micro, the cleanup service will return a NPE due to\nthe executor also being null. This change allows the service to disable\nitself, and doing so will cause each method to be disabled.\n\nThis was a bug introduced in 5033d8edb3bb22d797cd8ddf0aa4b47380e1a227.\n\nSigned-off-by: Matt Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b2dd2982411f98217848400337369dd286fbb5c", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/3b2dd2982411f98217848400337369dd286fbb5c", "committedDate": "2020-01-27T11:11:44Z", "message": "CUSTCOM-24 Save application unique ID on app load\n\nEJB timers firing rely on the container ID being consistent, which is\ndetermined in turn by the application unique ID. This change saves the\nunique ID of the first deployment to the clustered store, so be used on\nfuture redeployments.\n\nThis functionality was removed in Payara 5 with\n3cd40212ec11cbbe9a3740100a3ef3a5449364a9.\n\nSigned-off-by: Matt Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c908357e36037a3ccf939ea4172687ce23b6a7d1", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/c908357e36037a3ccf939ea4172687ce23b6a7d1", "committedDate": "2020-01-27T11:11:52Z", "message": "CUSTCOM-24 Reenable Micro clustered store access\n\nThe Payara Micro main thread didn't have access to the clustered store,\nbut this was required to save the application unique ID to the store on\ninitialisation.\n\nSigned-off-by: Matt Gill <matthew.gill@live.co.uk>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9e7fe2d38700121fb7b919fee0bdce89a5a45426", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/9e7fe2d38700121fb7b919fee0bdce89a5a45426", "committedDate": "2020-01-27T11:10:32Z", "message": "CUSTCOM-24 Prevent NPE in JobCleanUpService\n\nWhen starting Payara Micro, the cleanup service will return a NPE due to\nthe executor also being null. This change allows the service to disable\nitself, and doing so will cause each method to be disabled.\n\nThis was a bug introduced in 5033d8edb3bb22d797cd8ddf0aa4b47380e1a227.\n\nSigned-off-by: Matt Gill <matthew.gill@live.co.uk>"}, "afterCommit": {"oid": "8128054a32d9bb546b0e799726c8848236fdea3e", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/8128054a32d9bb546b0e799726c8848236fdea3e", "committedDate": "2020-01-27T11:11:55Z", "message": "CUSTCOM-24 Prevent NPE in JobCleanUpService\n\nWhen starting Payara Micro, the cleanup service will return a NPE due to\nthe executor also being null. This change allows the service to disable\nitself, and doing so will cause each method to be disabled.\n\nThis was a bug introduced in 5033d8edb3bb22d797cd8ddf0aa4b47380e1a227.\n\nSigned-off-by: Matt Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4NjE4NjYy", "url": "https://github.com/payara/Payara/pull/4457#pullrequestreview-348618662", "createdAt": "2020-01-27T12:13:53Z", "commit": {"oid": "8128054a32d9bb546b0e799726c8848236fdea3e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4NjUxNDUy", "url": "https://github.com/payara/Payara/pull/4457#pullrequestreview-348651452", "createdAt": "2020-01-27T13:14:51Z", "commit": {"oid": "8128054a32d9bb546b0e799726c8848236fdea3e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8128054a32d9bb546b0e799726c8848236fdea3e", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/8128054a32d9bb546b0e799726c8848236fdea3e", "committedDate": "2020-01-27T11:11:55Z", "message": "CUSTCOM-24 Prevent NPE in JobCleanUpService\n\nWhen starting Payara Micro, the cleanup service will return a NPE due to\nthe executor also being null. This change allows the service to disable\nitself, and doing so will cause each method to be disabled.\n\nThis was a bug introduced in 5033d8edb3bb22d797cd8ddf0aa4b47380e1a227.\n\nSigned-off-by: Matt Gill <matthew.gill@live.co.uk>"}, "afterCommit": {"oid": "c908357e36037a3ccf939ea4172687ce23b6a7d1", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/c908357e36037a3ccf939ea4172687ce23b6a7d1", "committedDate": "2020-01-27T11:11:52Z", "message": "CUSTCOM-24 Reenable Micro clustered store access\n\nThe Payara Micro main thread didn't have access to the clustered store,\nbut this was required to save the application unique ID to the store on\ninitialisation.\n\nSigned-off-by: Matt Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5OTEwNDQx", "url": "https://github.com/payara/Payara/pull/4457#pullrequestreview-349910441", "createdAt": "2020-01-29T07:43:13Z", "commit": {"oid": "c908357e36037a3ccf939ea4172687ce23b6a7d1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNzo0MzoxM1rOFi_Dyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNzo0MzoxM1rOFi_Dyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIyOTA2Ng==", "bodyText": "If this solves the issue and we agree, that this is how hazelcast bootstrap should work (pre-boot, rather than post boot), then entire code for handling \"threadlocaldisabled\" should be removed as well, as it has no other usage.", "url": "https://github.com/payara/Payara/pull/4457#discussion_r372229066", "createdAt": "2020-01-29T07:43:13Z", "author": {"login": "pdudits"}, "path": "appserver/extras/payara-micro/payara-micro-core/src/main/java/fish/payara/micro/impl/PayaraMicroImpl.java", "diffHunk": "@@ -1043,7 +1043,6 @@ public PayaraMicroRuntime bootStrap() throws BootstrapException {\n \n             // boot the server\n             preBootCommands.executeCommands(gf.getCommandRunner());\n-            HazelcastCore.setThreadLocalDisabled(true);\n             try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c908357e36037a3ccf939ea4172687ce23b6a7d1"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "674971a913648b81ba0f08dcdcbce599b2bfa45d", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/674971a913648b81ba0f08dcdcbce599b2bfa45d", "committedDate": "2020-01-29T14:41:52Z", "message": "Remove ThreadLocal disable for Hazelcast\n\nThe ThreadLocal variable used to restrict Hazelcast access to the Payara\nMicro main thread is no longer used, so can be removed.\n\nSigned-off-by: Matt Gill <matthew.gill@live.co.uk>"}, "afterCommit": {"oid": "3570a653fceb413ca04ea198e415206371e48592", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/3570a653fceb413ca04ea198e415206371e48592", "committedDate": "2020-01-29T14:42:44Z", "message": "CUSTCOM-24 Remove ThreadLocal Hazelcast disable\n\nThe ThreadLocal variable used to restrict Hazelcast access to the Payara\nMicro main thread is no longer used, so can be removed.\n\nSigned-off-by: Matt Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd07f55c8f6b0ce789b83f744fc16efb87d00648", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/dd07f55c8f6b0ce789b83f744fc16efb87d00648", "committedDate": "2020-01-29T15:32:14Z", "message": "CUSTCOM-24 Remove ThreadLocal Hazelcast disable\n\nThe ThreadLocal variable used to restrict Hazelcast access to the Payara\nMicro main thread is no longer used, so can be removed.\n\nSigned-off-by: Matt Gill <matthew.gill@live.co.uk>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3570a653fceb413ca04ea198e415206371e48592", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/3570a653fceb413ca04ea198e415206371e48592", "committedDate": "2020-01-29T14:42:44Z", "message": "CUSTCOM-24 Remove ThreadLocal Hazelcast disable\n\nThe ThreadLocal variable used to restrict Hazelcast access to the Payara\nMicro main thread is no longer used, so can be removed.\n\nSigned-off-by: Matt Gill <matthew.gill@live.co.uk>"}, "afterCommit": {"oid": "dd07f55c8f6b0ce789b83f744fc16efb87d00648", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/dd07f55c8f6b0ce789b83f744fc16efb87d00648", "committedDate": "2020-01-29T15:32:14Z", "message": "CUSTCOM-24 Remove ThreadLocal Hazelcast disable\n\nThe ThreadLocal variable used to restrict Hazelcast access to the Payara\nMicro main thread is no longer used, so can be removed.\n\nSigned-off-by: Matt Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84d1d5c366f720d0473f8a59ac00feb2c3550164", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/84d1d5c366f720d0473f8a59ac00feb2c3550164", "committedDate": "2020-01-29T15:51:16Z", "message": "Merge branch 'master' of github.com:payara/Payara into CUSTCOM-24"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNzU5Mzcy", "url": "https://github.com/payara/Payara/pull/4457#pullrequestreview-350759372", "createdAt": "2020-01-30T11:38:19Z", "commit": {"oid": "dd07f55c8f6b0ce789b83f744fc16efb87d00648"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxMTozODoxOVrOFjoC4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxMTozODoxOVrOFjoC4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjkwMDU3Nw==", "bodyText": "If all the reproducers we mentioned work with this configuration, would you let try swapping these two statements, finalizing config before deploy?", "url": "https://github.com/payara/Payara/pull/4457#discussion_r372900577", "createdAt": "2020-01-30T11:38:19Z", "author": {"login": "pdudits"}, "path": "appserver/extras/payara-micro/payara-micro-core/src/main/java/fish/payara/micro/impl/PayaraMicroImpl.java", "diffHunk": "@@ -1043,19 +1043,14 @@ public PayaraMicroRuntime bootStrap() throws BootstrapException {\n \n             // boot the server\n             preBootCommands.executeCommands(gf.getCommandRunner());\n-            HazelcastCore.setThreadLocalDisabled(true);\n-            try {\n-                gf.start();\n+            gf.start();\n \n-                // Execute post boot commands\n-                postBootCommands.executeCommands(gf.getCommandRunner());\n-                this.runtime = new PayaraMicroRuntimeImpl(gf, gfruntime);\n+            // Execute post boot commands\n+            postBootCommands.executeCommands(gf.getCommandRunner());\n+            this.runtime = new PayaraMicroRuntimeImpl(gf, gfruntime);\n \n-                // load all applications, but do not start them until Hazelcast gets a chance to initialize\n-                deployAll();\n-            } finally {\n-                HazelcastCore.setThreadLocalDisabled(false);\n-            }\n+            // load all applications, but do not start them until Hazelcast gets a chance to initialize\n+            deployAll();\n             if (!noCluster) {\n                 gf.getCommandRunner().run(\"set-hazelcast-configuration\", \"--enabled\", \"true\", \"--dynamic\", \"true\", \"--target\", \"server-config\", \"--hostawarepartitioning\", Boolean.toString(hostAware), \"--lite\", Boolean.toString(liteMember));\n             }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd07f55c8f6b0ce789b83f744fc16efb87d00648"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef3dc1ebd9c0e9737c538bb582902cecf0cc64c5", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/ef3dc1ebd9c0e9737c538bb582902cecf0cc64c5", "committedDate": "2020-01-30T15:42:50Z", "message": "CUSTCOM-24 Enable hazelcast before application load\n\nFixes have been made to Hazelcast that mean that it can be initialised\nearlier in the startup lifecycle. This should simplify the startup\nprocess which should, in turn, provide protection against future race\nconditions or complications caused by the complexity of Hazelcast\ninitialisation.\n\nSigned-off-by: Matt Gill <matthew.gill@live.co.uk>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 850, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}