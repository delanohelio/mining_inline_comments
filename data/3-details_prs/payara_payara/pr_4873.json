{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgwOTkzMzU4", "number": 4873, "title": "QACI-529 Refactor address picker and add wildcard binding", "bodyText": "Description\nRefactor Hazelcast address picker, make it a bit easier to understand\nTesting\nRan Payara and Payara Micro\nTesting Environment\nJDK 8\nquiicklook tests cover this scenario\nNotes for Reviewers\nNo new features, just refactoring.\nI did try to add wildcard bind for Hazelcast but it didn't work completely,\nbut still wildcard binding works better than single interface binding", "createdAt": "2020-09-07T02:43:24Z", "url": "https://github.com/payara/Payara/pull/4873", "merged": true, "mergeCommit": {"oid": "4d3cc54e0532dde3b6c69a69a6a67c23e94c3b94"}, "closed": true, "closedAt": "2020-11-18T16:31:11Z", "author": {"login": "lprimak"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDzCGyAH2gAyNDgwOTkzMzU4OjM3MWVjYzNkMDUwMDAzMzA5MjMwNmNiMGE4NTgxNmYzMzhjZGIzMjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddrOtAgFqTUzMzI4MjE0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "371ecc3d0500033092306cb0a85816f338cdb321", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/371ecc3d0500033092306cb0a85816f338cdb321", "committedDate": "2020-08-30T00:26:28Z", "message": "- Refactored MemberAddressPicker\n- Added ability to wildcard ('*') bind to all local interfaces for Hazelcast domain data grid bind"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c988617b1fef66b10b109cb092ce9487d21519b5", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/c988617b1fef66b10b109cb092ce9487d21519b5", "committedDate": "2020-09-07T02:24:25Z", "message": "Merge branch 'master' into Hazelcast-Bind-Wildcard"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a96ad9f1b7273f60ea3b5a85a835eb20fdc9037", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/4a96ad9f1b7273f60ea3b5a85a835eb20fdc9037", "committedDate": "2020-09-07T02:38:04Z", "message": "disabled wild card, cleanup and comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad2f4979d2df9772897d966a0493c1d6cd7e10dc", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/ad2f4979d2df9772897d966a0493c1d6cd7e10dc", "committedDate": "2020-09-16T01:34:52Z", "message": "Merge remote-tracking branch 'upstream/master' into Refactor-Address-Picker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "496280450b0ddb397494936e13e990b475fd90a9", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/496280450b0ddb397494936e13e990b475fd90a9", "committedDate": "2020-09-28T22:03:23Z", "message": "Merge branch 'master' into Refactor-Address-Picker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0277e8ed1d2b48961c9501cc0effb31b12d061d5", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/0277e8ed1d2b48961c9501cc0effb31b12d061d5", "committedDate": "2020-10-12T19:18:30Z", "message": "Merge remote-tracking branch 'upstream/master' into Refactor-Address-Picker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43ac6c8a4355676cb8f9954aea99400fe3858afb", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/43ac6c8a4355676cb8f9954aea99400fe3858afb", "committedDate": "2020-10-30T00:14:18Z", "message": "Merge branch 'master' into Refactor-Address-Picker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44b27052ca17b69421da71b0e97383cfc17a43a9", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/44b27052ca17b69421da71b0e97383cfc17a43a9", "committedDate": "2020-11-03T16:34:19Z", "message": "Merge remote-tracking branch 'upstream/master' into Refactor-Address-Picker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6078a5e636a9cb784c2635c071a60a8f3a2c4886", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/6078a5e636a9cb784c2635c071a60a8f3a2c4886", "committedDate": "2020-11-04T19:33:54Z", "message": "- point to point networks removed from the possible interfaces list\n- fixed quicklook failing tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1dd71b6238fdee76a5b3302a1518c8287b61fb59", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/1dd71b6238fdee76a5b3302a1518c8287b61fb59", "committedDate": "2020-11-05T02:43:06Z", "message": "even more refactoring, separated initPublicAddress() and initBindAddress() and made them even more self-describing and autonomous"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d64b7fa57802b5ca8b7fe7515b4763f765bedcb7", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/d64b7fa57802b5ca8b7fe7515b4763f765bedcb7", "committedDate": "2020-11-05T16:45:02Z", "message": "removed multiple nodes for each interfaces for localhost. Since we now have wildcard binding that's no longer necessary"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c00a8c1816fb6cabb502ce52ea4d1fff1a6cc3a", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/6c00a8c1816fb6cabb502ce52ea4d1fff1a6cc3a", "committedDate": "2020-11-12T16:14:00Z", "message": "Merge branch 'master' into Refactor-Address-Picker"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5OTQxNjE3", "url": "https://github.com/payara/Payara/pull/4873#pullrequestreview-529941617", "createdAt": "2020-11-13T10:20:32Z", "commit": {"oid": "6c00a8c1816fb6cabb502ce52ea4d1fff1a6cc3a"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7aa4ed0c9f8e88d46194b788edf5dd713301de53", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/7aa4ed0c9f8e88d46194b788edf5dd713301de53", "committedDate": "2020-11-15T01:08:24Z", "message": "multicast, non-DAS mode needs actual network address"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e51e4355354561083d1bed3018e4b0230648f43", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/2e51e4355354561083d1bed3018e4b0230648f43", "committedDate": "2020-11-15T01:11:26Z", "message": "missing comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNDA4NzA3", "url": "https://github.com/payara/Payara/pull/4873#pullrequestreview-532408707", "createdAt": "2020-11-17T14:20:26Z", "commit": {"oid": "2e51e4355354561083d1bed3018e4b0230648f43"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNDoyMDoyN1rOH03Emw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNDoyODozOFrOH03c4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE5MDI5OQ==", "bodyText": "Presumably docker0 is the default Linux interface name for the Docker network?\nOn Windows it appears to resolve to host.docker.internal, so I don't know if you need to account for that.", "url": "https://github.com/payara/Payara/pull/4873#discussion_r525190299", "createdAt": "2020-11-17T14:20:27Z", "author": {"login": "Pandrex247"}, "path": "nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/MemberAddressPicker.java", "diffHunk": "@@ -151,22 +189,21 @@ private void findAppropriateInterfaces() {\n             while (interfaces.hasMoreElements()) {\n                 NetworkInterface intf = interfaces.nextElement();\n                 logger.log(Level.FINE, \"Found Network Interface {0}\", new Object[]{intf.getName()});\n-                \n-                if (intf.isUp() && !intf.isLoopback() && !intf.isVirtual() && !intf.getName().contains(\"docker0\") &&!intf.getDisplayName().contains(\"Teredo\") && intf.getInterfaceAddresses().size()>0) {\n+\n+                if (intf.isUp() && !intf.isLoopback() && !intf.isVirtual() && !intf.isPointToPoint() && !intf.getName().contains(\"docker0\") &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e51e4355354561083d1bed3018e4b0230648f43"}, "originalPosition": 185}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE5MzAzOA==", "bodyText": "Slight wording change - the \"by searching\" bit is unnecessary and also irks me because you never say what or where you were searching \ud83d\ude1c\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        logger.log(Level.FINE, \"Could not find an appropriate address by searching falling back to local host\");\n          \n          \n            \n                        logger.log(Level.FINE, \"Could not find an appropriate address, falling back to local host\");", "url": "https://github.com/payara/Payara/pull/4873#discussion_r525193038", "createdAt": "2020-11-17T14:24:12Z", "author": {"login": "Pandrex247"}, "path": "nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/MemberAddressPicker.java", "diffHunk": "@@ -97,52 +109,78 @@ public InetSocketAddress getBindAddress() {\n \n     @Override\n     public InetSocketAddress getPublicAddress() {\n-        if (publicAddress != null) {\n-            return publicAddress;\n+        return publicAddress;\n+    }\n+\n+    private InetSocketAddress initBindAddress() {\n+        InetSocketAddress address = new InetSocketAddress(0);\n+        if (env.isDas() && !env.isMicro() && !config.getDASBindAddress().isEmpty()) {\n+            int port = new Integer(config.getDasPort());\n+            address = initAddress(config.getDASBindAddress(), port);\n+            logger.log(Level.FINE, \"Bind address is specified in the configuration so we will use that {0}\", address);\n+        } else if (config.getDiscoveryMode().startsWith(\"multicast\")) {\n+            // in multicast mode, Hazelcast needs actual interface to bind, not wildcard\n+            address = ensureAddress(null, null, chosenAddress, 0);\n         } else {\n-            return bindAddress;\n+            logger.log(Level.FINE, \"Using Wildcard bind address\");\n         }\n+        return address;\n     }\n-    \n-    /**\n-     * This method picks an interface using the following rules\n-     * If there is only one interface that is not loopback choose that\n-     * If there is an interfaces element use that\n-     * For the DAS if there is a bind address specified use that\n-     * If none of those choose the one that isn't the default docker one\n-     * For a standalone if the DAS specifies a Bind or Public address choose the interface on the same net or subnet\n-     * If none of those choose the one that is not the default docker interface\n-     * For micro if domain discovery mode choose the network on the same subnet\n-     * If tcpip mode choose the interface which matches a subnet in the tcpip list\n-     * If none of those choose the first interface that is not the default docker one\n-     */\n-    private void findAppropriateInterfaces() {\n-        \n-        if (localConfig.getPublicAddress() != null && !localConfig.getPublicAddress().isEmpty()) {\n-            String address[] = localConfig.getPublicAddress().split(\":\");\n-            if (address.length > 1) {\n-                publicAddress = new InetSocketAddress(address[0], Integer.parseInt(address[1]));\n-            } else {\n-                publicAddress = new InetSocketAddress(address[0], Integer.parseInt(config.getStartPort()));\n-            }\n-        }\n-        \n+\n+    private InetSocketAddress initPublicAddress(InetSocketAddress bindAddress) {\n         logger.fine(\"Finding an appropriate address for Hazelcast to use\");\n+        InetSocketAddress address;\n         int port = 0;\n         if (env.isDas() && !env.isMicro()) {\n             port = new Integer(config.getDasPort());\n-            if (config.getDASPublicAddress() != null && !config.getDASPublicAddress().isEmpty()) {\n-                publicAddress = new InetSocketAddress(config.getDASPublicAddress(), port);\n+            // try setting public address from global Payara config\n+            address = initAddress(config.getDASPublicAddress(), port);\n+        } else {\n+            // try setting public address from configuration, Payara node config\n+            address = initAddress(localConfig.getPublicAddress(), Integer.parseInt(config.getStartPort()));\n+        }\n+        return ensureAddress(address, bindAddress, chosenAddress, port);\n+    }\n+\n+    static InetSocketAddress initAddress(String address, int port) {\n+        if (address != null && !address.isEmpty()) {\n+            String addressParts[] = address.split(\":\");\n+            if (addressParts.length > 1) {\n+                return new InetSocketAddress(addressParts[0], Integer.parseInt(addressParts[1]));\n+            } else {\n+                return new InetSocketAddress(addressParts[0], port);\n             }\n-            \n-            if (config.getDASBindAddress() != null && !config.getDASBindAddress().isEmpty()) {\n-                bindAddress = new InetSocketAddress(config.getDASBindAddress(), port);\n-                logger.log(Level.FINE, \"Bind address is specified in the configuration so we will use that {0}\", bindAddress);\n-                return;\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    private static InetSocketAddress ensureAddress(InetSocketAddress targetAddress, InetSocketAddress sourceAddress,\n+            LazyHolder<InetAddress> backupAddress, int port) {\n+        if (targetAddress == null) {\n+            if (sourceAddress != null && !sourceAddress.getAddress().isAnyLocalAddress()) {\n+                targetAddress = sourceAddress;\n+            } else if (backupAddress.get() != null) {\n+                targetAddress = new InetSocketAddress(backupAddress.get(), port);\n+            } else {\n+                targetAddress = tryLocalHostOrLoopback(port);\n             }\n         }\n-       \n-        \n+        return targetAddress;\n+    }\n+\n+    private static InetSocketAddress tryLocalHostOrLoopback(int port) {\n+        try {\n+            // ok do the easy thing\n+            logger.log(Level.FINE, \"Could not find an appropriate address by searching falling back to local host\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e51e4355354561083d1bed3018e4b0230648f43"}, "originalPosition": 166}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE5NDg3Nw==", "bodyText": "In future watch out for these. IDE's like to constantly add or remove these whitespace characters and it's mildly annoying having to filter them out, particularly when it's done to a file with no other changes!", "url": "https://github.com/payara/Payara/pull/4873#discussion_r525194877", "createdAt": "2020-11-17T14:26:31Z", "author": {"login": "Pandrex247"}, "path": "nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java", "diffHunk": "@@ -127,13 +127,13 @@\n \n     @Inject\n     ServerContext context;\n-    \n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e51e4355354561083d1bed3018e4b0230648f43"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE5NjE4NQ==", "bodyText": "Too high up to let me suggest it, but the copyright needs updating to 2020 rather than 2019", "url": "https://github.com/payara/Payara/pull/4873#discussion_r525196185", "createdAt": "2020-11-17T14:28:10Z", "author": {"login": "Pandrex247"}, "path": "nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/MemberAddressPicker.java", "diffHunk": "@@ -44,40 +44,52 @@\n import java.net.Inet4Address;\n import java.net.InetAddress;\n import java.net.InetSocketAddress;\n-import java.net.InterfaceAddress;\n import java.net.NetworkInterface;\n import java.net.SocketException;\n import java.net.UnknownHostException;\n-import java.util.Arrays;\n import java.util.Enumeration;\n import java.util.HashSet;\n-import java.util.List;\n import java.util.logging.Level;\n import org.glassfish.api.admin.ServerEnvironment;\n import java.util.logging.Logger;\n+import org.glassfish.grizzly.utils.Holder.LazyHolder;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e51e4355354561083d1bed3018e4b0230648f43"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE5NjUxMw==", "bodyText": "Too high up to let me suggest it, but the copyright needs updating to 2020 rather than 2018", "url": "https://github.com/payara/Payara/pull/4873#discussion_r525196513", "createdAt": "2020-11-17T14:28:38Z", "author": {"login": "Pandrex247"}, "path": "nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/DomainDiscoveryService.java", "diffHunk": "@@ -46,35 +46,34 @@\n import com.sun.enterprise.config.serverbeans.Domain;\n import com.sun.enterprise.config.serverbeans.Node;\n import com.sun.enterprise.util.io.InstanceDirs;\n+import static fish.payara.nucleus.hazelcast.MemberAddressPicker.initAddress;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e51e4355354561083d1bed3018e4b0230648f43"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "704436bc4d89921d0ba13c8fc35fce05d15884b4", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/704436bc4d89921d0ba13c8fc35fce05d15884b4", "committedDate": "2020-11-17T18:45:21Z", "message": "Update nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/MemberAddressPicker.java\n\nCo-authored-by: Andrew Pielage <pandrex247@hotmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb4c40aeee1dad27bd695969204d18c9a89ad42e", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/fb4c40aeee1dad27bd695969204d18c9a89ad42e", "committedDate": "2020-11-17T18:50:32Z", "message": "updated copyright year in headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b4aa79313ff60c305a26e1f27f9777434f3dd37", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/3b4aa79313ff60c305a26e1f27f9777434f3dd37", "committedDate": "2020-11-17T18:50:45Z", "message": "Merge branch 'Refactor-Address-Picker' of github.com:flowlogix/Payara into Refactor-Address-Picker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "060872513b11b5ad34f7ae40abbcc7a38492513f", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/060872513b11b5ad34f7ae40abbcc7a38492513f", "committedDate": "2020-11-17T18:50:56Z", "message": "Merge remote-tracking branch 'upstream/master' into Refactor-Address-Picker"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMjgyMTQw", "url": "https://github.com/payara/Payara/pull/4873#pullrequestreview-533282140", "createdAt": "2020-11-18T10:03:01Z", "commit": {"oid": "060872513b11b5ad34f7ae40abbcc7a38492513f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 661, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}