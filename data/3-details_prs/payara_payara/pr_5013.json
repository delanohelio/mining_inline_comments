{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4ODk5MjI2", "number": 5013, "title": "FISH-858 Upgrade to Hazelcast 4.2 from 4.1 and use Tenant Control APIs", "bodyText": "Description\nContext for this is hazelcast/hazelcast#10875 and all the issues mentioned within this issue as well.\nMain feature is that Hazelcast Cache / Map / Queue etc. now work with Java EE constructs, and CDI beans, in Payara Data Grid as well.\nfixes #5159\nImportant Info\nBlockers\nHz 4.2 needs to be released\nOld PR #4762\nTesting\nNew tests\nGot #759 / https://github.com/bgjug/jcache-workshop to work in clustered environment using Payara Micro and Server mix.\nMost of this PR is removing a whole bunch of Proxy classes that are no longer needed\nTesting Performed\nAll current test suites pass\nTesting Environment\nJDK 8, MacOS\nDocumentation\nThere are new classes introduced for TenantControl, documented via javadoc in payara-api\nNotes for Reviewers", "createdAt": "2020-11-28T06:15:04Z", "url": "https://github.com/payara/Payara/pull/5013", "merged": true, "mergeCommit": {"oid": "36e1f304dec29e2e48005a8f2ef596af3f989769"}, "closed": true, "closedAt": "2021-03-26T15:38:31Z", "author": {"login": "lprimak"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiqn4XABqjQwNjk5ODAxMTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABeG8v1QgFqTYyMjI4MDMwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "79af4610892f5a300f9b7ccd373008f06e9d7fcf", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/79af4610892f5a300f9b7ccd373008f06e9d7fcf", "committedDate": "2020-12-03T21:55:11Z", "message": "clustered singleton-related CP objects can't be destroyed"}, "afterCommit": {"oid": "45142e837f71a02f5d6b5d95581bb2bb4b2827c0", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/45142e837f71a02f5d6b5d95581bb2bb4b2827c0", "committedDate": "2020-12-03T22:09:58Z", "message": "introduce tenant control"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7f1975298995c3a62ee3647845d711d3f1e8ba71", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/7f1975298995c3a62ee3647845d711d3f1e8ba71", "committedDate": "2020-12-04T23:09:36Z", "message": "deleted old files"}, "afterCommit": {"oid": "b3b3527c7348e680292fcd3f9048886ca6a74288", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/b3b3527c7348e680292fcd3f9048886ca6a74288", "committedDate": "2020-12-05T05:59:31Z", "message": "introduce tenant control"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9067d0736c4e167118c9d2db9382fdaa50cf9ea0", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/9067d0736c4e167118c9d2db9382fdaa50cf9ea0", "committedDate": "2020-12-08T23:31:54Z", "message": "introduce tenant control"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ad90dea20b919a529bc5ed441c72a7cb7a2c897f", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/ad90dea20b919a529bc5ed441c72a7cb7a2c897f", "committedDate": "2020-12-05T07:10:33Z", "message": "fixed OSGi version in bundle"}, "afterCommit": {"oid": "9067d0736c4e167118c9d2db9382fdaa50cf9ea0", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/9067d0736c4e167118c9d2db9382fdaa50cf9ea0", "committedDate": "2020-12-08T23:31:54Z", "message": "introduce tenant control"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cea0fa5de4e4677a97624725ed18f4af6ffc9a1b", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/cea0fa5de4e4677a97624725ed18f4af6ffc9a1b", "committedDate": "2020-12-11T23:32:24Z", "message": "Merge branch 'master' into Hz-TC-Rebased-On-CtxUtil"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e221517c0cb118a7597ba904efce255ab7f4d1c8", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/e221517c0cb118a7597ba904efce255ab7f4d1c8", "committedDate": "2020-12-17T15:42:54Z", "message": "Merge branch 'master' into Hz-TC-Rebased-On-CtxUtil"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "175f7d471cd075c455d29f20a67fc8cf6a03f6f0", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/175f7d471cd075c455d29f20a67fc8cf6a03f6f0", "committedDate": "2020-12-22T06:05:32Z", "message": "Merge branch 'master' into Hz-TC-Rebased-On-CtxUtil"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3MTg5MDEw", "url": "https://github.com/payara/Payara/pull/5013#pullrequestreview-557189010", "createdAt": "2020-12-22T16:04:32Z", "commit": {"oid": "175f7d471cd075c455d29f20a67fc8cf6a03f6f0"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxNjowNjo1OFrOIKAY8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxNjowNjo1OFrOIKAY8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM2MzA1OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (!contextInstance.isLoaded()) {\n          \n          \n            \n                        if (!tenantable.requiresTenantContext() || tenantNotRequired(tenantable)) {\n          \n          \n            \n                            return true;\n          \n          \n            \n                        }\n          \n          \n            \n                        lock.lock();\n          \n          \n            \n                        try {\n          \n          \n            \n                            String componentId = contextInstance.getInstanceComponentId();\n          \n          \n            \n                            int unavailableCount = blockedCounts.compute(componentId, (k, v) -> v == null ? 0 : ++v);\n          \n          \n            \n                            log.log(unavailableCount > 100 ? Level.INFO : Level.FINEST,\n          \n          \n            \n                                    String.format(\"BLOCKED: tenant not available: %s, module %s, Operation: %s\",\n          \n          \n            \n                                            componentId, moduleName, tenantable.getClass().getName()));\n          \n          \n            \n                            if (unavailableCount > 100) {\n          \n          \n            \n                                blockedCounts.remove(componentId);\n          \n          \n            \n                            }\n          \n          \n            \n                            condition.await(100, TimeUnit.MILLISECONDS);\n          \n          \n            \n                        } catch (InterruptedException ex) {\n          \n          \n            \n                        } finally {\n          \n          \n            \n                            lock.unlock();\n          \n          \n            \n                        }\n          \n          \n            \n                        return false;\n          \n          \n            \n                    }\n          \n          \n            \n                    return true;\n          \n          \n            \n                    if (!contextInstance.isLoaded()) {\n          \n          \n            \n                        return true;\n          \n          \n            \n                    }\n          \n          \n            \n                    if (!tenantable.requiresTenantContext() || tenantNotRequired(tenantable)) {\n          \n          \n            \n                        return true;\n          \n          \n            \n                    }\n          \n          \n            \n                    lock.lock();\n          \n          \n            \n                    try {\n          \n          \n            \n                        String componentId = contextInstance.getInstanceComponentId();\n          \n          \n            \n                        int unavailableCount = blockedCounts.compute(componentId, (k, v) -> v == null ? 0 : ++v);\n          \n          \n            \n                        log.log(unavailableCount > 100 ? Level.INFO : Level.FINEST,\n          \n          \n            \n                                String.format(\"BLOCKED: tenant not available: %s, module %s, Operation: %s\",\n          \n          \n            \n                                        componentId, moduleName, tenantable.getClass().getName()));\n          \n          \n            \n                        if (unavailableCount > 100) {\n          \n          \n            \n                            blockedCounts.remove(componentId);\n          \n          \n            \n                        }\n          \n          \n            \n                        condition.await(100, TimeUnit.MILLISECONDS);\n          \n          \n            \n                    } catch (InterruptedException ex) {\n          \n          \n            \n                    } finally {\n          \n          \n            \n                        lock.unlock();\n          \n          \n            \n                    }\n          \n          \n            \n                    return false;", "url": "https://github.com/payara/Payara/pull/5013#discussion_r547363059", "createdAt": "2020-12-22T16:06:58Z", "author": {"login": "MarkWareham"}, "path": "nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/PayaraHazelcastTenant.java", "diffHunk": "@@ -0,0 +1,218 @@\n+/*\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.\n+ *\n+ * Copyright (c) [2016-2020] Payara Foundation and/or its affiliates. All rights reserved.\n+ *\n+ * The contents of this file are subject to the terms of either the GNU\n+ * General Public License Version 2 only (\"GPL\") or the Common Development\n+ * and Distribution License(\"CDDL\") (collectively, the \"License\").  You\n+ * may not use this file except in compliance with the License.  You can\n+ * obtain a copy of the License at\n+ * https://github.com/payara/Payara/blob/master/LICENSE.txt\n+ * See the License for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing the software, include this License Header Notice in each\n+ * file and include the License file at glassfish/legal/LICENSE.txt.\n+ *\n+ * GPL Classpath Exception:\n+ * The Payara Foundation designates this particular file as subject to the \"Classpath\"\n+ * exception as provided by the Payara Foundation in the GPL Version 2 section of the License\n+ * file that accompanied this code.\n+ *\n+ * Modifications:\n+ * If applicable, add the following below the License Header, with the fields\n+ * enclosed by brackets [] replaced by your own identifying information:\n+ * \"Portions Copyright [year] [name of copyright owner]\"\n+ *\n+ * Contributor(s):\n+ * If you wish your version of this file to be governed by only the CDDL or\n+ * only the GPL Version 2, indicate your decision by adding \"[Contributor]\n+ * elects to include this software in this distribution under the [CDDL or GPL\n+ * Version 2] license.\"  If you don't indicate a single choice of license, a\n+ * recipient has the option to distribute your version of this file under\n+ * either the CDDL, the GPL Version 2 or to extend the choice of license to\n+ * its licensees as provided above.  However, if you add GPL Version 2 code\n+ * and therefore, elected the GPL Version 2 license, then the option applies\n+ * only if the new code is made subject to such option by the copyright\n+ * holder.\n+ */\n+package fish.payara.nucleus.hazelcast;\n+\n+import com.hazelcast.nio.ObjectDataInput;\n+import com.hazelcast.nio.ObjectDataOutput;\n+import com.hazelcast.nio.serialization.DataSerializable;\n+import com.hazelcast.spi.tenantcontrol.DestroyEventContext;\n+import com.hazelcast.spi.tenantcontrol.TenantControl;\n+import com.hazelcast.spi.tenantcontrol.Tenantable;\n+import java.io.IOException;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.locks.Condition;\n+import java.util.concurrent.locks.Lock;\n+import java.util.concurrent.locks.ReentrantLock;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import org.glassfish.api.event.EventListener;\n+import org.glassfish.api.event.Events;\n+import org.glassfish.api.invocation.InvocationManager;\n+import org.glassfish.deployment.versioning.VersioningUtils;\n+import org.glassfish.internal.api.Globals;\n+import org.glassfish.internal.api.JavaEEContextUtil;\n+import org.glassfish.internal.data.ApplicationInfo;\n+import org.glassfish.internal.data.ModuleInfo;\n+import org.glassfish.internal.deployment.Deployment;\n+\n+/**\n+ * Java EE Context and class loading support for Hazelcast objects and thread-callbacks\n+ *\n+ * @author lprimak\n+ */\n+public class PayaraHazelcastTenant implements TenantControl, DataSerializable {\n+    private final JavaEEContextUtil ctxUtil = Globals.getDefaultHabitat().getService(JavaEEContextUtil.class);\n+    private final Events events = Globals.getDefaultHabitat().getService(Events.class);\n+    private final InvocationManager invMgr = Globals.getDefaultHabitat().getService(InvocationManager.class);\n+    private final Lock lock = new ReentrantLock();\n+    private final Condition condition = lock.newCondition();\n+    private static final Logger log = Logger.getLogger(PayaraHazelcastTenant.class.getName());\n+    private static final Map<String, Integer> blockedCounts = new ConcurrentHashMap<>();\n+\n+    // transient fields\n+    private EventListenerImpl destroyEventListener;\n+\n+    // serialized fields\n+    private JavaEEContextUtil.Instance contextInstance;\n+    private String moduleName;\n+\n+\n+    PayaraHazelcastTenant() {\n+        if (invMgr.getCurrentInvocation() != null) {\n+            contextInstance = ctxUtil.currentInvocation();\n+            moduleName = VersioningUtils.getUntaggedName(invMgr.getCurrentInvocation().getModuleName());\n+        } else {\n+            contextInstance = ctxUtil.empty();\n+        }\n+    }\n+\n+    @Override\n+    public void registerObject(DestroyEventContext destroyContext) {\n+        destroyEventListener = new EventListenerImpl(destroyContext);\n+        events.register(destroyEventListener);\n+    }\n+\n+    @Override\n+    public void unregisterObject() {\n+        // Hazelcast object has been destroyed\n+        events.unregister(destroyEventListener);\n+        destroyEventListener = null;\n+    }\n+\n+    @Override\n+    public Closeable setTenant() {\n+        try {\n+            return contextInstance.pushRequestContext()::close;\n+        } catch (IllegalStateException exc) {\n+            throw exc;\n+        }\n+    }\n+\n+    @Override\n+    public void writeData(ObjectDataOutput out) throws IOException {\n+        out.writeObject(contextInstance);\n+        out.writeUTF(moduleName);\n+    }\n+\n+    @Override\n+    public void readData(ObjectDataInput in) throws IOException {\n+        contextInstance = in.readObject();\n+        moduleName = in.readUTF();\n+    }\n+\n+    @Override\n+    public boolean isAvailable(Tenantable tenantable) {\n+        if (!contextInstance.isLoaded()) {\n+            if (!tenantable.requiresTenantContext() || tenantNotRequired(tenantable)) {\n+                return true;\n+            }\n+            lock.lock();\n+            try {\n+                String componentId = contextInstance.getInstanceComponentId();\n+                int unavailableCount = blockedCounts.compute(componentId, (k, v) -> v == null ? 0 : ++v);\n+                log.log(unavailableCount > 100 ? Level.INFO : Level.FINEST,\n+                        String.format(\"BLOCKED: tenant not available: %s, module %s, Operation: %s\",\n+                                componentId, moduleName, tenantable.getClass().getName()));\n+                if (unavailableCount > 100) {\n+                    blockedCounts.remove(componentId);\n+                }\n+                condition.await(100, TimeUnit.MILLISECONDS);\n+            } catch (InterruptedException ex) {\n+            } finally {\n+                lock.unlock();\n+            }\n+            return false;\n+        }\n+        return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "175f7d471cd075c455d29f20a67fc8cf6a03f6f0"}, "originalPosition": 155}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2676b412d62275930a457a215a1e3325878f8104", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/2676b412d62275930a457a215a1e3325878f8104", "committedDate": "2020-12-22T16:54:21Z", "message": "Update nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/PayaraHazelcastTenant.java\n\nCo-authored-by: Mark Wareham <37405236+MarkWareham@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfc4491094cd533ef28fbf42f9c178051d3f66e3", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/cfc4491094cd533ef28fbf42f9c178051d3f66e3", "committedDate": "2020-12-22T17:13:19Z", "message": "fixed logic in isAvailable()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d050a396733d1d93c764995ae9f8065968d3684", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/9d050a396733d1d93c764995ae9f8065968d3684", "committedDate": "2021-01-21T02:02:04Z", "message": "Merge branch 'master' into Hz-TC-Rebased-On-CtxUtil"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fb2d1e13233e1b32f76914987b3e33130f5158b", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/1fb2d1e13233e1b32f76914987b3e33130f5158b", "committedDate": "2021-01-24T22:54:13Z", "message": "Merge branch 'master' into Hz-TC-Rebased-On-CtxUtil"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b973a55dff9ae475f96a3ada691f32775a68c569", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/b973a55dff9ae475f96a3ada691f32775a68c569", "committedDate": "2021-03-18T18:03:04Z", "message": "Merge branch 'master' into Hz-TC-Rebased-On-CtxUtil"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e36c81b7ef2efe8fff92d9bd0cd0a4f22135d31a", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/e36c81b7ef2efe8fff92d9bd0cd0a4f22135d31a", "committedDate": "2021-03-25T17:09:49Z", "message": "Merge branch 'master' into Hz-TC-Rebased-On-CtxUtil"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31d909351e38862b9ba18088ade3f039c460341d", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/payara/Payara/commit/31d909351e38862b9ba18088ade3f039c460341d", "committedDate": "2021-03-25T18:04:05Z", "message": "CachePartitionIterator / ClusterWidePartition no longer necessary since tenant control takes care of class loading and context"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjIyMjgwMzAy", "url": "https://github.com/payara/Payara/pull/5013#pullrequestreview-622280302", "createdAt": "2021-03-26T15:38:29Z", "commit": {"oid": "31d909351e38862b9ba18088ade3f039c460341d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 635, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}