{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5NDY3NjAx", "number": 4614, "title": "APPSERV-141 Adds Caching to MicroProfile Config", "bodyText": "Summary\nThis PR adds basic caching to MP Config implementation. I also did clean and correct generics and types in the module and some other cleanup.\n\nadds caching to PayaraConfig\nadds a command to set the cache duration in seconds (default is 60s)\nadds or corrects generics in the module\nreplaces use of Type in connection with Converters with Class (it never was Type based and only actual values that would work needed to be Classes)\nsplits the automatic converter into a method based and a constructor based one (was one before that used one or the other)\nfixes extracting type a Converter implementation converts (it would just pick the first type parameter of the first implemented interface with ParameterizedType which could be something other than Converter)\ncleanup of existing tests (remove sysouts, unused and unnecessary methods)\nfixes potential NPE introduced by APPSERV-59 https://github.com/jbee/Payara/blob/a4cdc26fe6aaa895e558dee3e191451d9a309af2/nucleus/payara-modules/nucleus-microprofile/config-service/src/main/java/fish/payara/nucleus/microprofile/config/spi/ConfigSourceComparator.java (the implementation is not wrong but apparently MP Config TCK uses sources which return null for name)\n\nQ & A\nQ: Does changing the cache duration need a server restart to become effective\nA: It depends. As each application has its Config instance any change will have an effect for applications deployed after the change. Those deployed before will not change.\nQ: Is caching compliant with MP Config standard?\nA: Yes and No. The specification explicitly names that caching can be applied to individual ConfigSources. It also states that each time getValue is used all sources are considered which means that even with caching in some sources the work needed to be done is about the same and caching on source level is really just helpful for sources that involve particularly slow operations like looking up the property in a database. Given this situation I decided that the best we can do is cache properties for only a short time. Each property has its own TTL (default is 1 min). As this is strictly speaking no longer compliant with the specification the TTL can be configured 0 to disable caching. This way users can opt for better performance for price of small delay before value change in a source becomes effective or being standard compliant with worse performance. The default is caching enabled as users usually want good performance and usually are happy to wait up to 1 minute for changes to propagate. I also created eclipse/microprofile-config#552 where I suggest a similar solution be added to the spec.\nQ: Why would caching be needed?\nA: Numbers. A new MetricID does look up two configurations. A Metric lookup might do 1-3 of these. A FT method might involve 2-8 of these. Each looking in up to 10ish sources. Most sources being a map of some sorts. This multiplies to a worse case of 2 * 3 * 8 * 10 = 480 map lookups for a single FT method invocation. \ud83d\ude1f\nQ: What exactly is cached?\nA: Result values. The cache contains the values that are returned by calling getValue and alike. This means they also help avoid finding the appropriate converter and applying conversion each time the method is called.\nTesting\nThis PR adds tests that verify that the fixed Converter type extraction works correctly and that the PayaraConfig in general in specifically the added caching works correctly.\nTesting Performed\nBesides running the unit tests MP Config TCK is run against remote server.\n(also see payara/MicroProfile-TCK-Runners#108)\nexport my_int_property=45\nexport MY_BOOLEAN_PROPERTY=true\nexport my_string_property=haha\nexport MY_STRING_PROPERTY=woohoo\nexport MP_CONFIG_CACHE_DURATION=0\ncd {payara-bin-dir}\nasadmin start-domain\ncd {tck-dir}\nmvn clean install \"-Ppayara-server-remote\" \"-Dpayara.version=5.202\"\nand also as (requires being build before locally)\nmvn clean install \"-Dpayara.version=5.202-SNAPSHOT\"\nas well as MP Metrics TCK against remote:\nexport MP_METRICS_TAGS=tier=integration\n...\nasadmin start-domain\n...\nmvn clean install \"-Ppayara-server-remote\" \"-Dpayara.version=5.202\"\nand MP FaultTolerance TCK\nmvn clean install \"-Ppayara-server-remote\" \"-Dpayara.version=5.202\"\nDocumentation\npayara/Payara-Server-Documentation#730", "createdAt": "2020-04-06T08:25:25Z", "url": "https://github.com/payara/Payara/pull/4614", "merged": true, "mergeCommit": {"oid": "2431bf55cc5ae25c18ee8f646a0fbb2273f744fd"}, "closed": true, "closedAt": "2020-04-20T11:56:02Z", "author": {"login": "jbee"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcUAwrMAH2gAyMzk5NDY3NjAxOjQyYTc1MTE1NzRmMjQ2YWE4NjcyNzkwMzY3NjkxYmFiMmMxZmE0Yzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZdGPRgFqTM5NjM1NTI0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "42a7511574f246aa8672790367691bab2c1fa4c9", "author": {"user": {"login": "jbee", "name": "Jan Bernitt"}}, "url": "https://github.com/payara/Payara/commit/42a7511574f246aa8672790367691bab2c1fa4c9", "committedDate": "2020-04-03T13:17:44Z", "message": "cleanup; adding generics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e5e9db402fd00517548ef0b46aa038b73c19031", "author": {"user": {"login": "jbee", "name": "Jan Bernitt"}}, "url": "https://github.com/payara/Payara/commit/3e5e9db402fd00517548ef0b46aa038b73c19031", "committedDate": "2020-04-03T14:49:13Z", "message": "more cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52a2c6f492c32f8269f106eabf63ede83ca26650", "author": {"user": {"login": "jbee", "name": "Jan Bernitt"}}, "url": "https://github.com/payara/Payara/commit/52a2c6f492c32f8269f106eabf63ede83ca26650", "committedDate": "2020-04-04T14:45:25Z", "message": "adds caching to MP config implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1adde2c45ab7c465193eb4f0040ba02749fc7707", "author": {"user": {"login": "jbee", "name": "Jan Bernitt"}}, "url": "https://github.com/payara/Payara/commit/1adde2c45ab7c465193eb4f0040ba02749fc7707", "committedDate": "2020-04-06T08:08:03Z", "message": "APPSERV-141 adds tests and admin command for MP config cache"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4MDM2Mzc4", "url": "https://github.com/payara/Payara/pull/4614#pullrequestreview-388036378", "createdAt": "2020-04-06T08:32:35Z", "commit": {"oid": "1adde2c45ab7c465193eb4f0040ba02749fc7707"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQwODozMjozNVrOGBNGog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQwODozMjozNVrOGBNGog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkxNjQ1MA==", "bodyText": "NB. This was just working because of luck or probability.", "url": "https://github.com/payara/Payara/pull/4614#discussion_r403916450", "createdAt": "2020-04-06T08:32:35Z", "author": {"login": "jbee"}, "path": "nucleus/payara-modules/nucleus-microprofile/config-service/src/main/java/fish/payara/nucleus/microprofile/config/spi/PayaraConfigBuilder.java", "diffHunk": "@@ -130,44 +130,52 @@ public Config build() {\n         return this;\n     }\n \n-    public static Type getTypeForConverter(Converter converter) {\n-        // add each converter to the map for later lookup\n-        Type types[] = converter.getClass().getGenericInterfaces();\n+    public static Class<?> getTypeForConverter(Converter<?> converter) {\n+       return getTypeForConverter(converter.getClass());\n+    }\n+\n+    public static Class<?> getTypeForConverter(Class<?> converter) {\n+        Type types[] = converter.getGenericInterfaces();\n         for (Type type : types) {\n             if (type instanceof ParameterizedType) {\n-                Type args[] = ((ParameterizedType) type).getActualTypeArguments();\n-                if (args.length >= 1) {\n-                    // check if there is one there already\n-                    return args[0];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1adde2c45ab7c465193eb4f0040ba02749fc7707"}, "originalPosition": 84}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76931bd0db3929b999af3ec7bb294d10590aed8c", "author": {"user": {"login": "jbee", "name": "Jan Bernitt"}}, "url": "https://github.com/payara/Payara/commit/76931bd0db3929b999af3ec7bb294d10590aed8c", "committedDate": "2020-04-06T09:55:48Z", "message": "gitattributes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fe8271c7a35c9f992a58928a4e61af5ebaa9211", "author": {"user": {"login": "jbee", "name": "Jan Bernitt"}}, "url": "https://github.com/payara/Payara/commit/8fe8271c7a35c9f992a58928a4e61af5ebaa9211", "committedDate": "2020-04-06T13:02:00Z", "message": "APPSERV-114 fixes source comparator null names NPE; fixes getValue with default never throws NoSuchElementException"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf430077d6941d2446f8d056c66e9d1fbf0e29f6", "author": {"user": {"login": "jbee", "name": "Jan Bernitt"}}, "url": "https://github.com/payara/Payara/commit/bf430077d6941d2446f8d056c66e9d1fbf0e29f6", "committedDate": "2020-04-06T14:26:33Z", "message": "Merge branch 'master' into mp-config-caching-part2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ff676d3c04d0a46906e6e013ff8d376ed6a31f2", "author": {"user": {"login": "jbee", "name": "Jan Bernitt"}}, "url": "https://github.com/payara/Payara/commit/3ff676d3c04d0a46906e6e013ff8d376ed6a31f2", "committedDate": "2020-04-06T17:25:22Z", "message": "APPSERV-114 fixes cache key considers element type of collections"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c38a8eeb7d601bf00a6f8aac6e9956a8fff26210", "author": {"user": {"login": "jbee", "name": "Jan Bernitt"}}, "url": "https://github.com/payara/Payara/commit/c38a8eeb7d601bf00a6f8aac6e9956a8fff26210", "committedDate": "2020-04-07T07:30:52Z", "message": "APPSERV-114 updates copyright headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09c55d2821074d1efcc0fc6bd52ba549ad2d63b9", "author": {"user": {"login": "jbee", "name": "Jan Bernitt"}}, "url": "https://github.com/payara/Payara/commit/09c55d2821074d1efcc0fc6bd52ba549ad2d63b9", "committedDate": "2020-04-07T09:34:59Z", "message": "APPSERV-114 adds environment variable to set (override) cache duration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29d83bc2af5cc91135502483742678b808649df3", "author": {"user": {"login": "jbee", "name": "Jan Bernitt"}}, "url": "https://github.com/payara/Payara/commit/29d83bc2af5cc91135502483742678b808649df3", "committedDate": "2020-04-09T12:09:42Z", "message": "Merge branch 'master' into mp-config-caching-part2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NTM3NTQ0", "url": "https://github.com/payara/Payara/pull/4614#pullrequestreview-395537544", "createdAt": "2020-04-17T15:08:04Z", "commit": {"oid": "09c55d2821074d1efcc0fc6bd52ba549ad2d63b9"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "795063a8d83211daae1f4658fa2ad167bd34c049", "author": {"user": {"login": "jbee", "name": "Jan Bernitt"}}, "url": "https://github.com/payara/Payara/commit/795063a8d83211daae1f4658fa2ad167bd34c049", "committedDate": "2020-04-20T08:28:17Z", "message": "PAYARA-141 fixes NPE in splitValue of PayaraConfig"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d53d14fe2f87600b1cffb897e50c0cfeb950b79a", "author": {"user": {"login": "jbee", "name": "Jan Bernitt"}}, "url": "https://github.com/payara/Payara/commit/d53d14fe2f87600b1cffb897e50c0cfeb950b79a", "committedDate": "2020-04-20T08:29:23Z", "message": "Merge branch 'master' into mp-config-caching-part2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2MzU1MjQ0", "url": "https://github.com/payara/Payara/pull/4614#pullrequestreview-396355244", "createdAt": "2020-04-20T11:08:15Z", "commit": {"oid": "d53d14fe2f87600b1cffb897e50c0cfeb950b79a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 804, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}