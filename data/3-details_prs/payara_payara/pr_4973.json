{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzMTE4Mzcz", "number": 4973, "title": "FISH-676 JDBC Config Source Fixes", "bodyText": "Fixes errors found in JDBC config source testing where errors were being swallowed and resources were leaking.", "createdAt": "2020-10-30T16:19:54Z", "url": "https://github.com/payara/Payara/pull/4973", "merged": true, "mergeCommit": {"oid": "ed2b611b6bacc7f1ba8c872e8f9c5c39e37b5843"}, "closed": true, "closedAt": "2020-10-30T22:38:26Z", "author": {"login": "MattGill98"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXpMpggH2gAyNTEzMTE4MzczOjBhZmQyZGVhOGQ2Y2Q1ZmQyMjUxMzI4ZWUyMmVkN2NkY2M3MTEwNTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdYWUgwAFqTUyMTI1OTk3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0afd2dea8d6cd5fd2251328ee22ed7cdcc711050", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/0afd2dea8d6cd5fd2251328ee22ed7cdcc711050", "committedDate": "2020-10-30T16:17:25Z", "message": "FISH-676 Close Open JDBC Connections\n\nJDBC connections were leaking, this commit should ensure they are closed\nproperly.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "20cf45d321ffde397d58edb03f0f555a3803d2a3", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/20cf45d321ffde397d58edb03f0f555a3803d2a3", "committedDate": "2020-10-30T16:18:20Z", "message": "FISH-676 Log JDBC Config Source Errors\n\nErrors were being swallowed, but are now properly logged.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}, "afterCommit": {"oid": "a7259a925f466f67dd7aae0d1dabdff80b2d3bf8", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/a7259a925f466f67dd7aae0d1dabdff80b2d3bf8", "committedDate": "2020-10-30T16:36:35Z", "message": "FISH-676 Log JDBC Config Source Errors\n\nErrors were being swallowed, but are now properly logged.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09f8f1c04108ad03890c2b22434c85e553d0090d", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/09f8f1c04108ad03890c2b22434c85e553d0090d", "committedDate": "2020-10-30T16:38:51Z", "message": "FISH-676 Log JDBC Config Source Errors\n\nErrors were being swallowed, but are now properly logged.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a7259a925f466f67dd7aae0d1dabdff80b2d3bf8", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/a7259a925f466f67dd7aae0d1dabdff80b2d3bf8", "committedDate": "2020-10-30T16:36:35Z", "message": "FISH-676 Log JDBC Config Source Errors\n\nErrors were being swallowed, but are now properly logged.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}, "afterCommit": {"oid": "09f8f1c04108ad03890c2b22434c85e553d0090d", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/09f8f1c04108ad03890c2b22434c85e553d0090d", "committedDate": "2020-10-30T16:38:51Z", "message": "FISH-676 Log JDBC Config Source Errors\n\nErrors were being swallowed, but are now properly logged.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwODY1NTYz", "url": "https://github.com/payara/Payara/pull/4973#pullrequestreview-520865563", "createdAt": "2020-10-30T17:05:02Z", "commit": {"oid": "09f8f1c04108ad03890c2b22434c85e553d0090d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwODgzMzQ5", "url": "https://github.com/payara/Payara/pull/4973#pullrequestreview-520883349", "createdAt": "2020-10-30T17:26:33Z", "commit": {"oid": "09f8f1c04108ad03890c2b22434c85e553d0090d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMjU5OTA2", "url": "https://github.com/payara/Payara/pull/4973#pullrequestreview-521259906", "createdAt": "2020-11-01T20:50:50Z", "commit": {"oid": "09f8f1c04108ad03890c2b22434c85e553d0090d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMVQyMDo1MDo1MFrOHryBag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMVQyMDo1MDo1MFrOHryBag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY3MDM3OA==", "bodyText": "How about an Optional here?", "url": "https://github.com/payara/Payara/pull/4973#discussion_r515670378", "createdAt": "2020-11-01T20:50:50Z", "author": {"login": "svendiedrichsen"}, "path": "nucleus/payara-modules/nucleus-microprofile/config-service/src/main/java/fish/payara/nucleus/microprofile/config/source/JDBCConfigSource.java", "diffHunk": "@@ -64,17 +83,31 @@ public int getOrdinal() {\n \n     @Override\n     public String getValue(String propertyName) {\n-        return jdbcConfigHelper.getConfigValue(propertyName);\n+        JDBCConfigSourceHelper helper = getHelper();\n+        if (helper == null) {\n+            return null;\n+        }\n+        try {\n+            return helper.getConfigValue(propertyName);\n+        } finally {\n+            try {\n+                helper.close();\n+            } catch (IOException e) {\n+                LOGGER.log(Level.SEVERE, \"Error closing JDBC connection\", e);\n+            }\n+        }\n     }\n \n     @Override\n     public String getName() {\n         return \"JDBC\";\n     }\n \n-    private void init() {\n-        if (jdbcConfigHelper == null) {\n-            jdbcConfigHelper = new JDBCConfigSourceHelper(Globals.getDefaultHabitat().getService(JDBCConfigSourceConfiguration.class));\n+    private JDBCConfigSourceHelper getHelper() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09f8f1c04108ad03890c2b22434c85e553d0090d"}, "originalPosition": 74}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMjU5OTY0", "url": "https://github.com/payara/Payara/pull/4973#pullrequestreview-521259964", "createdAt": "2020-11-01T20:51:33Z", "commit": {"oid": "09f8f1c04108ad03890c2b22434c85e553d0090d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMVQyMDo1MTozM1rOHryBvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMVQyMDo1MTozM1rOHryBvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY3MDQ2MA==", "bodyText": "How about try-with-resources here?", "url": "https://github.com/payara/Payara/pull/4973#discussion_r515670460", "createdAt": "2020-11-01T20:51:33Z", "author": {"login": "svendiedrichsen"}, "path": "nucleus/payara-modules/nucleus-microprofile/config-service/src/main/java/fish/payara/nucleus/microprofile/config/source/JDBCConfigSource.java", "diffHunk": "@@ -64,17 +83,31 @@ public int getOrdinal() {\n \n     @Override\n     public String getValue(String propertyName) {\n-        return jdbcConfigHelper.getConfigValue(propertyName);\n+        JDBCConfigSourceHelper helper = getHelper();\n+        if (helper == null) {\n+            return null;\n+        }\n+        try {\n+            return helper.getConfigValue(propertyName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09f8f1c04108ad03890c2b22434c85e553d0090d"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMjU5OTc1", "url": "https://github.com/payara/Payara/pull/4973#pullrequestreview-521259975", "createdAt": "2020-11-01T20:51:43Z", "commit": {"oid": "09f8f1c04108ad03890c2b22434c85e553d0090d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMVQyMDo1MTo0M1rOHryByQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMVQyMDo1MTo0M1rOHryByQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY3MDQ3Mw==", "bodyText": "How about try-with-resources here?", "url": "https://github.com/payara/Payara/pull/4973#discussion_r515670473", "createdAt": "2020-11-01T20:51:43Z", "author": {"login": "svendiedrichsen"}, "path": "nucleus/payara-modules/nucleus-microprofile/config-service/src/main/java/fish/payara/nucleus/microprofile/config/source/JDBCConfigSource.java", "diffHunk": "@@ -39,22 +39,41 @@\n  */\n package fish.payara.nucleus.microprofile.config.source;\n \n-import fish.payara.nucleus.microprofile.config.spi.JDBCConfigSourceConfiguration;\n+import java.io.IOException;\n import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+\n import org.eclipse.microprofile.config.spi.ConfigSource;\n import org.glassfish.internal.api.Globals;\n \n+import fish.payara.nucleus.microprofile.config.spi.JDBCConfigSourceConfiguration;\n+\n public class JDBCConfigSource extends PayaraConfigSource implements ConfigSource {\n \n-    private JDBCConfigSourceHelper jdbcConfigHelper;\n+    private static final Logger LOGGER = Logger.getLogger(JDBCConfigSource.class.getName());\n+\n+    private final JDBCConfigSourceConfiguration config;\n \n     public JDBCConfigSource() {\n-      init();\n+        this.config = Globals.getDefaultHabitat().getService(JDBCConfigSourceConfiguration.class);\n     }\n \n     @Override\n     public Map<String, String> getProperties() {\n-        return jdbcConfigHelper.getAllConfigValues();\n+        JDBCConfigSourceHelper helper = getHelper();\n+        if (helper == null) {\n+            return null;\n+        }\n+        try {\n+            return helper.getAllConfigValues();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09f8f1c04108ad03890c2b22434c85e553d0090d"}, "originalPosition": 35}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 703, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}