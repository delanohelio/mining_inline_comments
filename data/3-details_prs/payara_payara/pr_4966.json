{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwNjQyNjE0", "number": 4966, "title": "FISH-327 Implement MicroProfile Sniffers", "bodyText": "Description\n\nThis is an improvement. MicroProfile servlets and CDI extensions are now hidden behind a sniffer engine. This should mean that they won't startup unnecessarily, and should be a decent performance improvement for applications not utilising any or all of the MP specs.\nImportant Info\nBlockers\nNeeds testing against large non-MP app.\nTesting Performed\n\nTested the test app for FISH-242.\nPasses MP TCKs.\nNotes for Reviewers\n\nShould also fix FISH-431.\nMake sure 1038060 is still relevant", "createdAt": "2020-10-27T10:30:12Z", "url": "https://github.com/payara/Payara/pull/4966", "merged": true, "mergeCommit": {"oid": "4b671dad1ca4bcca621e7b29ea80951238e210f7"}, "closed": true, "closedAt": "2020-11-20T10:54:10Z", "author": {"login": "MattGill98"}, "timelineItems": {"totalCount": 38, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWl5OtAH2gAyNTEwNjQyNjE0OjI4YjczYmQzMmZmMjA0MzdiNjc5ODU0YWYyZDVmNzEyNGJiOGI5MTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeVCdDgFqTUzNTMxODg0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "28b73bd32ff20437b679854af2d5f7124bb8b910", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/28b73bd32ff20437b679854af2d5f7124bb8b910", "committedDate": "2020-10-27T09:52:34Z", "message": "FISH-327 Implement MicroProfile Connector Module\n\nImplement a new base module for each MicroProfile implementation to\nextend to provide their sniffers.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0073114146ee03cfdcbe98fff84fe1d5367726a", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/d0073114146ee03cfdcbe98fff84fe1d5367726a", "committedDate": "2020-10-27T09:54:03Z", "message": "FISH-327 Implement MicroProfile OpenAPI Sniffer\n\nOpenAPI implementation now uses a sniffer to determine if the\napplication is appropriate for OpenAPI scanning.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "023866b60d4b3159652e73592f9f0607cbc39178", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/023866b60d4b3159652e73592f9f0607cbc39178", "committedDate": "2020-10-27T09:55:52Z", "message": "FISH-327 Implement MicroProfile Metrics Sniffer\n\nMetrics now uses a sniffer to determine if the servlet or CDI extensions\nare necessary to deploy.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "372c734ed5ae53a3a15e6a4de79faf41fa8b3748", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/372c734ed5ae53a3a15e6a4de79faf41fa8b3748", "committedDate": "2020-10-27T10:05:03Z", "message": "FISH-327 Implement MicroProfile Health Sniffer\n\nOnly run health CDI extension and servlet when the sniffer detects a MP\ncompatible application. Move CDI bean registration from the\nServletContextListener into its own CDI extension.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49ae71f3f270d167ae6664cc3229875dad2e5a72", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/49ae71f3f270d167ae6664cc3229875dad2e5a72", "committedDate": "2020-10-27T10:06:12Z", "message": "FISH-327 Implement MicroProfile Fault Tolerance Sniffer\n\nAdded a sniffer to only apply the CDI extension when the fault tolerance\nannotations have been detected.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d95d8fcce346a9deb2e24478b358f126f5528560", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/d95d8fcce346a9deb2e24478b358f126f5528560", "committedDate": "2020-10-27T10:07:06Z", "message": "FISH-327 Implement MicroProfile JWT Auth Sniffer\n\nMove the RolesDeclaredInitializer and CDI Extension behind the sniffer\nlogic, to improve startup performance.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4592003f2abd7720a90694a7d4f8de00fdff8061", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/4592003f2abd7720a90694a7d4f8de00fdff8061", "committedDate": "2020-10-27T10:07:44Z", "message": "FISH-327 Implement MicroProfile Config Sniffer\n\nOnly enable CDI extension when the @ConfigProperty annotation is\ndetected.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NjI5OTg5", "url": "https://github.com/payara/Payara/pull/4966#pullrequestreview-517629989", "createdAt": "2020-10-27T12:05:36Z", "commit": {"oid": "4592003f2abd7720a90694a7d4f8de00fdff8061"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMjowNTozNlrOHo46Zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMjowNzowNVrOHo49-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYzNzU0Mw==", "bodyText": "much nicer using an array literal, something like\nreturn { org.eclipse.microprofile.config.inject.ConfigProperty.class }\nMaybe also use a import for ConfigProperty?", "url": "https://github.com/payara/Payara/pull/4966#discussion_r512637543", "createdAt": "2020-10-27T12:05:36Z", "author": {"login": "jbee"}, "path": "appserver/payara-appserver-modules/microprofile/config/src/main/java/fish/payara/microprofile/config/ConfigSniffer.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.\n+ *\n+ * Copyright (c) [2020] Payara Foundation and/or its affiliates. All rights reserved.\n+ *\n+ * The contents of this file are subject to the terms of either the GNU\n+ * General Public License Version 2 only (\"GPL\") or the Common Development\n+ * and Distribution License(\"CDDL\") (collectively, the \"License\").  You\n+ * may not use this file except in compliance with the License.  You can\n+ * obtain a copy of the License at\n+ * https://github.com/payara/Payara/blob/master/LICENSE.txt\n+ * See the License for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing the software, include this License Header Notice in each\n+ * file and include the License file at glassfish/legal/LICENSE.txt.\n+ *\n+ * GPL Classpath Exception:\n+ * The Payara Foundation designates this particular file as subject to the \"Classpath\"\n+ * exception as provided by the Payara Foundation in the GPL Version 2 section of the License\n+ * file that accompanied this code.\n+ *\n+ * Modifications:\n+ * If applicable, add the following below the License Header, with the fields\n+ * enclosed by brackets [] replaced by your own identifying information:\n+ * \"Portions Copyright [year] [name of copyright owner]\"\n+ *\n+ * Contributor(s):\n+ * If you wish your version of this file to be governed by only the CDDL or\n+ * only the GPL Version 2, indicate your decision by adding \"[Contributor]\n+ * elects to include this software in this distribution under the [CDDL or GPL\n+ * Version 2] license.\"  If you don't indicate a single choice of license, a\n+ * recipient has the option to distribute your version of this file under\n+ * either the CDDL, the GPL Version 2 or to extend the choice of license to\n+ * its licensees as provided above.  However, if you add GPL Version 2 code\n+ * and therefore, elected the GPL Version 2 license, then the option applies\n+ * only if the new code is made subject to such option by the copyright\n+ * holder.\n+ */\n+package fish.payara.microprofile.config;\n+\n+import java.lang.annotation.Annotation;\n+\n+import org.glassfish.hk2.api.PerLookup;\n+import org.jvnet.hk2.annotations.Service;\n+\n+import fish.payara.microprofile.connector.MicroProfileSniffer;\n+\n+@Service\n+@PerLookup\n+public class ConfigSniffer extends MicroProfileSniffer {\n+\n+    @Override\n+    @SuppressWarnings(\"unchecked\")\n+    public Class<? extends Annotation>[] getAnnotationTypes() {\n+        Class<? extends Annotation>[] annotations = new Class[1];\n+\n+        // Search for ConfigProperty annotation used in the CDI extension\n+        annotations[0] = org.eclipse.microprofile.config.inject.ConfigProperty.class;\n+\n+        return annotations;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4592003f2abd7720a90694a7d4f8de00fdff8061"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYzODQ1Ng==", "bodyText": "Why override the methods identical to how they are implemented in the super class?", "url": "https://github.com/payara/Payara/pull/4966#discussion_r512638456", "createdAt": "2020-10-27T12:07:05Z", "author": {"login": "jbee"}, "path": "appserver/payara-appserver-modules/microprofile/fault-tolerance/src/main/java/fish/payara/microprofile/faulttolerance/FaultToleranceApplicationContainer.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.\n+ *\n+ * Copyright (c) [2020] Payara Foundation and/or its affiliates. All rights reserved.\n+ *\n+ * The contents of this file are subject to the terms of either the GNU\n+ * General Public License Version 2 only (\"GPL\") or the Common Development\n+ * and Distribution License(\"CDDL\") (collectively, the \"License\").  You\n+ * may not use this file except in compliance with the License.  You can\n+ * obtain a copy of the License at\n+ * https://github.com/payara/Payara/blob/master/LICENSE.txt\n+ * See the License for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing the software, include this License Header Notice in each\n+ * file and include the License file at glassfish/legal/LICENSE.txt.\n+ *\n+ * GPL Classpath Exception:\n+ * The Payara Foundation designates this particular file as subject to the \"Classpath\"\n+ * exception as provided by the Payara Foundation in the GPL Version 2 section of the License\n+ * file that accompanied this code.\n+ *\n+ * Modifications:\n+ * If applicable, add the following below the License Header, with the fields\n+ * enclosed by brackets [] replaced by your own identifying information:\n+ * \"Portions Copyright [year] [name of copyright owner]\"\n+ *\n+ * Contributor(s):\n+ * If you wish your version of this file to be governed by only the CDDL or\n+ * only the GPL Version 2, indicate your decision by adding \"[Contributor]\n+ * elects to include this software in this distribution under the [CDDL or GPL\n+ * Version 2] license.\"  If you don't indicate a single choice of license, a\n+ * recipient has the option to distribute your version of this file under\n+ * either the CDDL, the GPL Version 2 or to extend the choice of license to\n+ * its licensees as provided above.  However, if you add GPL Version 2 code\n+ * and therefore, elected the GPL Version 2 license, then the option applies\n+ * only if the new code is made subject to such option by the copyright\n+ * holder.\n+ */\n+package fish.payara.microprofile.faulttolerance;\n+\n+import org.glassfish.api.deployment.ApplicationContext;\n+import org.glassfish.api.deployment.DeploymentContext;\n+\n+import fish.payara.microprofile.connector.MicroProfileApplicationContainer;\n+\n+public class FaultToleranceApplicationContainer extends MicroProfileApplicationContainer {\n+\n+    protected FaultToleranceApplicationContainer(DeploymentContext deploymentContext) {\n+        super(deploymentContext);\n+    }\n+\n+    @Override\n+    public boolean start(ApplicationContext ctx) throws Exception {\n+        return true;\n+    }\n+\n+    @Override\n+    public boolean stop(ApplicationContext ctx) {\n+        return true;\n+    }\n+\n+    @Override\n+    public boolean resume() throws Exception {\n+        return true;\n+    }\n+\n+    @Override\n+    public boolean suspend() {\n+        return true;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4592003f2abd7720a90694a7d4f8de00fdff8061"}, "originalPosition": 71}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2f4e9cc90e408b3b0ff621fa848b1af5729ef3a", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/f2f4e9cc90e408b3b0ff621fa848b1af5729ef3a", "committedDate": "2020-10-27T13:00:31Z", "message": "FISH-327 Fix MP Connectors\n\nConnectors were incorrectly activating for all module types. This change\nchecks properly for a web activated module, and logs a proper message\nif this logic fails.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e038a3296f42c0e6cbab9e9c65a58e85e8b88e80", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/e038a3296f42c0e6cbab9e9c65a58e85e8b88e80", "committedDate": "2020-10-27T14:13:59Z", "message": "FISH-327 Fix MP Sniffer ClassLoading Issue\n\nThe updated connector module wasn't being used, and a ClassLoading issue\noccurred when trying to inject WarType. WarType has been moved into an\nexported OSGI module to be used by the MicroProfile sniffers, and the\ncorrect module has been referenced in the POM.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f33dee39fbe58e0092017f084c2fb37e69e4f52e", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/f33dee39fbe58e0092017f084c2fb37e69e4f52e", "committedDate": "2020-10-27T14:19:35Z", "message": "FISH-327 Rename Generic CDI Extension Classes\n\nJWT-Auth and Config had generic \"CdiExtension\" classes, which aren't\nidentifiable at runtime. This commit renames them appropriately.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1989ca4d26769f22412931083966d3f60f348f3", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/a1989ca4d26769f22412931083966d3f60f348f3", "committedDate": "2020-10-27T14:30:50Z", "message": "FISH-327 Code cleanup to use Array Literals\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b28880f705a831dd0ea273ec910655df87fc504f", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/b28880f705a831dd0ea273ec910655df87fc504f", "committedDate": "2020-10-27T17:05:43Z", "message": "FISH-327 Remove WarType injection\n\nMicroProfile sniffers were handling all WAR archives, which is incorrect\nbehaviour.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f95f02d279aed2bbeaea35fef4ee5dbc81b0c7cc", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/f95f02d279aed2bbeaea35fef4ee5dbc81b0c7cc", "committedDate": "2020-10-30T12:58:49Z", "message": "Merge branch 'master' of https://github.com/payara/Payara into FISH-327"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea94978f6de8897841eeae51fd1240a888a32b0e", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/ea94978f6de8897841eeae51fd1240a888a32b0e", "committedDate": "2020-10-30T14:55:07Z", "message": "Merge branch 'master' of https://github.com/payara/Payara into FISH-327"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14ea1c7be026cfc0b5afd7acf911682c562eaeb7", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/14ea1c7be026cfc0b5afd7acf911682c562eaeb7", "committedDate": "2020-11-05T11:19:45Z", "message": "Make Arquillian runners debuggable by default\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bba4a79c3dc9cd37adb5c3dd5779e562ed90a455", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/bba4a79c3dc9cd37adb5c3dd5779e562ed90a455", "committedDate": "2020-11-05T11:19:47Z", "message": "FISH-327 Fix MP Config Source Creation\n\nThe password alias store failed to be found when the OpenAPI container\ndidn't call ConfigProvider.getConfig(). This change calls\nConfigProvider.getConfig() in the config sniffer regardless of whether\nthe Config API annotations are detected or not.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b4efd98d4d5bf58e626009efbbf514845feae56", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/0b4efd98d4d5bf58e626009efbbf514845feae56", "committedDate": "2020-11-05T11:19:47Z", "message": "FISH-327 Remove unnecessary app container overrides\n\nEach MP container overrides methods unnecessarily, so they've been\nstubbed in the parent class to minimise boilerplate.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbc361a886e429762874a399e1d14e17a7354869", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/bbc361a886e429762874a399e1d14e17a7354869", "committedDate": "2020-11-05T11:19:47Z", "message": "Partial revert \"FISH-327 Implement MicroProfile OpenAPI Sniffer\"\n\nThis reverts a part of commit d0073114146ee03cfdcbe98fff84fe1d5367726a.\n\nThe ServletContainerInitializer is returned, as the\nServletContextListener caused the OpenAPI endpoint to use the app context\nroot. The OpenAPI endpoint is now always deployed, but the sniffer\ndetermines if the app should be read.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7ddab0e6e185123a2d08495812de4b2e9ed857f", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/b7ddab0e6e185123a2d08495812de4b2e9ed857f", "committedDate": "2020-11-05T11:19:47Z", "message": "Partial revert \"FISH-327 Implement MicroProfile Metrics Sniffer\"\n\nThis partially reverts commit 023866b60d4b3159652e73592f9f0607cbc39178.\n\nThe ServletContainerInitializer is returned, as the ServletContextListener\ncaused the metrics endpoint to use the app context root.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9c54c295c1e3f79dff0ff7402bf0e921fd70703", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/b9c54c295c1e3f79dff0ff7402bf0e921fd70703", "committedDate": "2020-11-05T11:19:47Z", "message": "Partial revert \"FISH-327 Implement MicroProfile Health Sniffer\"\n\nThis partially reverts commit 372c734ed5ae53a3a15e6a4de79faf41fa8b3748.\n\nThe ServletContainerInitializer is returned, as the ServletContextListener\ncased the health endpoint to use the app context root.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37c08ba672bfaa4e1f9891cc7e6ba0b887c069c3", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/37c08ba672bfaa4e1f9891cc7e6ba0b887c069c3", "committedDate": "2020-11-05T13:03:03Z", "message": "FISH-327 Add new 'activation' folders\n\nMoved the sniffer code for each module into their own folder for better\norganisation.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f522a59ce28713c29da358e6305eea2255b5172f", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/f522a59ce28713c29da358e6305eea2255b5172f", "committedDate": "2020-11-03T12:14:03Z", "message": "FISH-327 Remove unnecessary app container overrides\n\nEach MP container overrides methods unnecessarily, so they've been\nstubbed in the parent class to minimise boilerplate.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}, "afterCommit": {"oid": "37c08ba672bfaa4e1f9891cc7e6ba0b887c069c3", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/37c08ba672bfaa4e1f9891cc7e6ba0b887c069c3", "committedDate": "2020-11-05T13:03:03Z", "message": "FISH-327 Add new 'activation' folders\n\nMoved the sniffer code for each module into their own folder for better\norganisation.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8af6f292beebeb26073d645f018b7ba9f09979f5", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/8af6f292beebeb26073d645f018b7ba9f09979f5", "committedDate": "2020-11-09T09:18:16Z", "message": "FISH-327 Fix extensions loading twice\n\nExtensions now load only once, and sniffers now enable for EJB JARs.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aca874527daddd1df962be89ab73fca387f1c4be", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/aca874527daddd1df962be89ab73fca387f1c4be", "committedDate": "2020-11-09T09:24:19Z", "message": "FISH-327 Fix Health Extension\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MTM0NjEx", "url": "https://github.com/payara/Payara/pull/4966#pullrequestreview-526134611", "createdAt": "2020-11-09T10:52:47Z", "commit": {"oid": "aca874527daddd1df962be89ab73fca387f1c4be"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMDo1Mjo0N1rOHvpEow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMDo1Mjo0N1rOHvpEow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTcxODA1MQ==", "bodyText": "Does this work like as intended should an exception be thrown at some of the steps so that the document contains as much information as possible to that point?", "url": "https://github.com/payara/Payara/pull/4966#discussion_r519718051", "createdAt": "2020-11-09T10:52:47Z", "author": {"login": "jbee"}, "path": "appserver/payara-appserver-modules/microprofile/openapi/src/main/java/fish/payara/microprofile/openapi/impl/OpenAPISupplier.java", "diffHunk": "@@ -0,0 +1,264 @@\n+/*\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.\n+ *\n+ * Copyright (c) [2020] Payara Foundation and/or its affiliates. All rights reserved.\n+ *\n+ * The contents of this file are subject to the terms of either the GNU\n+ * General Public License Version 2 only (\"GPL\") or the Common Development\n+ * and Distribution License(\"CDDL\") (collectively, the \"License\").  You\n+ * may not use this file except in compliance with the License.  You can\n+ * obtain a copy of the License at\n+ * https://github.com/payara/Payara/blob/master/LICENSE.txt\n+ * See the License for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing the software, include this License Header Notice in each\n+ * file and include the License file at glassfish/legal/LICENSE.txt.\n+ *\n+ * GPL Classpath Exception:\n+ * The Payara Foundation designates this particular file as subject to the \"Classpath\"\n+ * exception as provided by the Payara Foundation in the GPL Version 2 section of the License\n+ * file that accompanied this code.\n+ *\n+ * Modifications:\n+ * If applicable, add the following below the License Header, with the fields\n+ * enclosed by brackets [] replaced by your own identifying information:\n+ * \"Portions Copyright [year] [name of copyright owner]\"\n+ *\n+ * Contributor(s):\n+ * If you wish your version of this file to be governed by only the CDDL or\n+ * only the GPL Version 2, indicate your decision by adding \"[Contributor]\n+ * elects to include this software in this distribution under the [CDDL or GPL\n+ * Version 2] license.\"  If you don't indicate a single choice of license, a\n+ * recipient has the option to distribute your version of this file under\n+ * either the CDDL, the GPL Version 2 or to extend the choice of license to\n+ * its licensees as provided above.  However, if you add GPL Version 2 code\n+ * and therefore, elected the GPL Version 2 license, then the option applies\n+ * only if the new code is made subject to such option by the copyright\n+ * holder.\n+ */\n+package fish.payara.microprofile.openapi.impl;\n+\n+import static java.util.stream.Collectors.toSet;\n+\n+import java.io.IOException;\n+import java.net.InetAddress;\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.net.UnknownHostException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.Enumeration;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Set;\n+import java.util.function.Supplier;\n+import java.util.logging.Logger;\n+\n+import com.sun.enterprise.v3.server.ApplicationLifecycle;\n+import com.sun.enterprise.v3.services.impl.GrizzlyService;\n+\n+import org.eclipse.microprofile.openapi.models.OpenAPI;\n+import org.glassfish.api.admin.ServerEnvironment;\n+import org.glassfish.api.deployment.archive.ReadableArchive;\n+import org.glassfish.grizzly.config.dom.NetworkListener;\n+import org.glassfish.hk2.api.MultiException;\n+import org.glassfish.hk2.classmodel.reflect.Parser;\n+import org.glassfish.hk2.classmodel.reflect.Type;\n+import org.glassfish.hk2.classmodel.reflect.Types;\n+import org.glassfish.internal.api.Globals;\n+import org.glassfish.internal.api.ServerContext;\n+import org.glassfish.internal.deployment.analysis.StructuredDeploymentTracing;\n+\n+import fish.payara.microprofile.openapi.impl.config.OpenApiConfiguration;\n+import fish.payara.microprofile.openapi.impl.model.OpenAPIImpl;\n+import fish.payara.microprofile.openapi.impl.processor.ApplicationProcessor;\n+import fish.payara.microprofile.openapi.impl.processor.BaseProcessor;\n+import fish.payara.microprofile.openapi.impl.processor.FileProcessor;\n+import fish.payara.microprofile.openapi.impl.processor.FilterProcessor;\n+import fish.payara.microprofile.openapi.impl.processor.ModelReaderProcessor;\n+\n+public class OpenAPISupplier implements Supplier<OpenAPI> {\n+\n+    private final OpenApiConfiguration config;\n+    private final String applicationId;\n+    private final String contextRoot;\n+    private final ReadableArchive archive;\n+    private final ClassLoader classLoader;\n+\n+    private volatile OpenAPI document;\n+\n+    private boolean enabled;\n+\n+    public OpenAPISupplier(String applicationId, String contextRoot,\n+            ReadableArchive archive, ClassLoader classLoader) {\n+        this.config = new OpenApiConfiguration(classLoader);\n+        this.applicationId = applicationId;\n+        this.contextRoot = contextRoot;\n+        this.archive = archive;\n+        this.classLoader = classLoader;\n+        this.enabled = true;\n+    }\n+\n+    public void setEnabled(boolean enabled) {\n+        this.enabled = enabled;\n+    }\n+\n+    @Override\n+    public synchronized OpenAPI get() {\n+        if (this.document != null) {\n+            return this.document;\n+        }\n+        if (!enabled) {\n+            return null;\n+        }\n+\n+        try {\n+            final Parser parser = Globals.get(ApplicationLifecycle.class).getDeployableParser(\n+                    archive,\n+                    true,\n+                    true,\n+                    StructuredDeploymentTracing.create(applicationId),\n+                    Logger.getLogger(OpenApiService.class.getName())\n+            );\n+            final Types types = parser.getContext().getTypes();\n+\n+            OpenAPI doc = new OpenAPIImpl();\n+            try {\n+                final List<URL> baseURLs = getServerURL(contextRoot);\n+                doc = new ModelReaderProcessor().process(doc, config);\n+                doc = new FileProcessor(classLoader).process(doc, config);\n+                doc = new ApplicationProcessor(\n+                        types,\n+                        filterTypes(archive, config, types),\n+                        classLoader\n+                ).process(doc, config);\n+                doc = new BaseProcessor(baseURLs).process(doc, config);\n+                doc = new FilterProcessor().process(doc, config);\n+            } finally {\n+                this.document = doc;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aca874527daddd1df962be89ab73fca387f1c4be"}, "originalPosition": 140}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8ce23f03050e04874f9579c9ce221cfe4f3c9eb", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/f8ce23f03050e04874f9579c9ce221cfe4f3c9eb", "committedDate": "2020-11-13T16:08:43Z", "message": "Merge branch 'master' of https://github.com/payara/Payara into FISH-327"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "467903bd743c709d6128a83e49d4542adef4c425", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/467903bd743c709d6128a83e49d4542adef4c425", "committedDate": "2020-11-13T15:15:26Z", "message": "Merge branch 'master' of https://github.com/payara/Payara into FISH-327"}, "afterCommit": {"oid": "f8ce23f03050e04874f9579c9ce221cfe4f3c9eb", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/f8ce23f03050e04874f9579c9ce221cfe4f3c9eb", "committedDate": "2020-11-13T16:08:43Z", "message": "Merge branch 'master' of https://github.com/payara/Payara into FISH-327"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2d687a406ab7e7532e3f34dd537af8906f82044", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/c2d687a406ab7e7532e3f34dd537af8906f82044", "committedDate": "2020-11-17T10:48:53Z", "message": "FISH-327 Add Sniffer Extention MetaData Earlier\n\nA race condition existed where the load() method of each MP sniffer\ndepended on the Weld load() method. If they ran in the wrong order, the\nMP CDI extensions wouldn't load. This makes sure that the Weld sniffer\ncreates this MetaData earlier in the deploy lifecycle.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b85f974ae185f0fbe95811140907a01f020795cf", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/b85f974ae185f0fbe95811140907a01f020795cf", "committedDate": "2020-11-18T11:20:18Z", "message": "FISH-327 Add OpenAPI YAML Files to Sniffer\n\nThe Static OpenAPI YAML file wasn't being scanned for by the sniffer.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "14a5ec6a0cfbafe767885ffb3c47fd67832bec78", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/14a5ec6a0cfbafe767885ffb3c47fd67832bec78", "committedDate": "2020-11-17T11:24:25Z", "message": "FISH-327 MP Sniffer Add Deployment Failures\n\nIf problems are found in the MP deployers they were previously ignored.\nThis change causes any metadata required but not found to make\ndeployment fail. This should expose any problems in MP deployment and\nmake debugging easier. It will also cause applications to completely\nfail when this happens, but I believe this is the correct behaviour.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}, "afterCommit": {"oid": "b85f974ae185f0fbe95811140907a01f020795cf", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/b85f974ae185f0fbe95811140907a01f020795cf", "committedDate": "2020-11-18T11:20:18Z", "message": "FISH-327 Add OpenAPI YAML Files to Sniffer\n\nThe Static OpenAPI YAML file wasn't being scanned for by the sniffer.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de0f8524c2c37c8ec996eda06260485b07bceaa2", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/de0f8524c2c37c8ec996eda06260485b07bceaa2", "committedDate": "2020-11-18T13:11:11Z", "message": "FISH-327 Fix Health CDI Extension\n\nThe extension logged errors about the creational context, so the\nhealthchecks are now registered later (once this can be created\ncorrectly). The extension also wasn't listening on all health check\ntypes, so the observer has been made more generic.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65178a0ee9152351e0d0a5b9c893812f4afaf637", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/65178a0ee9152351e0d0a5b9c893812f4afaf637", "committedDate": "2020-11-18T14:26:31Z", "message": "FISH-327 Fix Config Sniffer\n\nConfig applications that injected the Config type weren't previously\ndetected, but they now count as Config applications.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5af66d06d52befc2053cc56b4feefa7a6e51cf51", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/5af66d06d52befc2053cc56b4feefa7a6e51cf51", "committedDate": "2020-11-18T14:27:58Z", "message": "FISH-327 Fix Metrics TCK\n\nThe metrics TCK caused ClassCastExceptions casting from ParameterImpl to\nType. ParameterizedTypes such as ParameterImpl are now recognised and\nhandled correctly, and unrecognised types are logged and ignored.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5247791d6fcd99cb43d1ab81892b42adfe598b1c", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/5247791d6fcd99cb43d1ab81892b42adfe598b1c", "committedDate": "2020-11-19T10:35:51Z", "message": "FISH-327 Fix Metrics Sniffer\n\nAllow Metrics sniffer to deploy Metrics if any Metric is injected, as\nwell as the enabled annotations.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MzExOTE0", "url": "https://github.com/payara/Payara/pull/4966#pullrequestreview-535311914", "createdAt": "2020-11-20T10:35:30Z", "commit": {"oid": "5247791d6fcd99cb43d1ab81892b42adfe598b1c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMDozNTozMFrOH3KPuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMDozNTozMFrOH3KPuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYwMTU5Mg==", "bodyText": "Copyright year needs updating", "url": "https://github.com/payara/Payara/pull/4966#discussion_r527601592", "createdAt": "2020-11-20T10:35:30Z", "author": {"login": "Cousjava"}, "path": "appserver/payara-appserver-modules/microprofile/healthcheck/pom.xml", "diffHunk": "@@ -67,6 +67,11 @@\n             <groupId>org.eclipse.microprofile.health</groupId>\n             <artifactId>microprofile-health-api</artifactId>\n         </dependency>\n+        <dependency>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5247791d6fcd99cb43d1ab81892b42adfe598b1c"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "671da1949837273ee37ff4157c9b64ad0a83a812", "author": {"user": {"login": "MattGill98", "name": "Matthew Gill"}}, "url": "https://github.com/payara/Payara/commit/671da1949837273ee37ff4157c9b64ad0a83a812", "committedDate": "2020-11-20T10:44:13Z", "message": "FISH-327 Fix Missing Copyright Headers\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MzE4ODQ4", "url": "https://github.com/payara/Payara/pull/4966#pullrequestreview-535318848", "createdAt": "2020-11-20T10:45:39Z", "commit": {"oid": "671da1949837273ee37ff4157c9b64ad0a83a812"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 701, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}