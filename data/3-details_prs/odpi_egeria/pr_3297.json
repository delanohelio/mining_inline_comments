{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzOTgwMjM5", "number": 3297, "title": "Automation of Subject Area FVT", "bodyText": "This PR adds support for automation of the Subject Area FVT\n\nAdds JUnit5 wrapper around tests, failsafe to orchestrate, launches chassis before/after. Single server\nIntent is to demonstrate the principle  to allow component owners to extend tests as required\n\nDependencies\n\nJUnit5 for test definition\nfailsafe plugin for test orchestration\nprocess-exec-maven-plugin to launch/kill server chassis\ngroovy-maven-plugin to provide configuration for server\nSA FVTs are now dependent on the full egeria assembly being built\n\nCaveats/Todos -\n\nWhilst the Subject Area Tests are launched, and we check no exceptions occur, the actual results are not fully checked ..! This requires potential changes in the existing FVT code (question: this PR, or perhaps in a new PR, so we can get the base pattern more shared) - which can build on top of the basic framework\nThe groovy configuration script is an 'executable set of notes' - could do with some refactoring for clarity. Once the Admin Client API is sufficient (to launch an instance) this can be used instead of REST. When the security work is complete, or we use a client,  the SSL workaround may be removed. The error checking/reporting is rudimentary. More parameterization may help for other tests. The result may be a trivial groovy script (which is what it's useful for) and could even be inlined in maven pom if desired\nEffectiveDatesFVT is not run currently as the existing test structure is harder to add a simple JUnit5 test wrapper to\nCould consider full refactoring of these tests in future to be JUnit5 based - easier to report/identify behaviours\nwe could capture code coverage\nAdd documentation to developer guide, after the next set are integrated (to ensure we have a repeatable pattern)\n2-server tests are not included. These may belong in more complete scenario-based testing\nnot yet tested on windows/linux/in build environment\nbuild scripts need checking to tune defaults for PR vs merge vs sonar etc\nthere may be cases where if the test is aborted/maven killed, the child chassis process doesn't get killed, though I've not seen this in practice yet\nthough the environment for launching the chassis is parameterized, the actual JUnit5 tests are not. We could inject server name, baseURL as needed. via properties is probably the easiest for failsafe\nA variety of TODO: are left in place\n\nDespite ALL of these caveats, this moves us a step forward, so if we are happy nothing here is a backward step, or completely the wrong approach, then merging  would make it easier to experiment with this approach in other FVTs and evolve to a better solution.\nRecommendation for other FVTs\n\nUse JUnit5\nfollow pattern in the subject area POM\nkeep tests in the test folders/phases, but in an integration specific project\nRefactoring to add more to higher level POMs can follow - all the logic currently is in the subject area FVT pom\n\nSee the issue #426 for further discussion about some of the approaches tried to get here.", "createdAt": "2020-07-03T10:22:03Z", "url": "https://github.com/odpi/egeria/pull/3297", "merged": true, "mergeCommit": {"oid": "d8a17848f1d7b89a0c7cb1293a2ccbb167fbf539"}, "closed": true, "closedAt": "2020-07-07T13:54:08Z", "author": {"login": "planetf1"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcv9ax9gH2gAyNDQzOTgwMjM5OjNiOGIxNDAzYWJiZTA4MzM3NTMxNDM4OThlOTg4ZGQ0YTRjNzlhMTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyld7EAH2gAyNDQzOTgwMjM5OjRjODNjOTY3YTlmODdmYTQxOGM4NDEzOTU4ZmFjZTNhNTg1MDJkMjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3b8b1403abbe0833753143898e988dd4a4c79a11", "author": {"user": {"login": "planetf1", "name": "Nigel Jones"}}, "url": "https://github.com/odpi/egeria/commit/3b8b1403abbe0833753143898e988dd4a4c79a11", "committedDate": "2020-06-29T09:13:59Z", "message": "Correct spotbugs dependency versions\n\nSigned-off-by: Nigel Jones <nigel.l.jones+git@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1cc9a899a0e0bf40b7033b5bbdecaed84ef9b4f", "author": {"user": {"login": "planetf1", "name": "Nigel Jones"}}, "url": "https://github.com/odpi/egeria/commit/a1cc9a899a0e0bf40b7033b5bbdecaed84ef9b4f", "committedDate": "2020-06-29T09:17:27Z", "message": "Ensure new failsafe plugin, and previous git commit plugin, use properties for version\n\nSigned-off-by: Nigel Jones <nigel.l.jones+git@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79ec10ba2fdd8a91c954e58ffedce9f140693ae4", "author": {"user": {"login": "planetf1", "name": "Nigel Jones"}}, "url": "https://github.com/odpi/egeria/commit/79ec10ba2fdd8a91c954e58ffedce9f140693ae4", "committedDate": "2020-07-02T15:59:19Z", "message": "Add integration test framwework for subject area\n\nSigned-off-by: Nigel Jones <nigel.l.jones+git@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19568710b774571cf0cd35ebd36b7409fc070e75", "author": {"user": {"login": "planetf1", "name": "Nigel Jones"}}, "url": "https://github.com/odpi/egeria/commit/19568710b774571cf0cd35ebd36b7409fc070e75", "committedDate": "2020-07-03T09:49:45Z", "message": "Moved subject area FVTs to use JUnit5 via wrapper\n\nSigned-off-by: Nigel Jones <nigel.l.jones+git@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70ea5045c59deb71f9e52900276e2a54d0d86cb0", "author": {"user": {"login": "planetf1", "name": "Nigel Jones"}}, "url": "https://github.com/odpi/egeria/commit/70ea5045c59deb71f9e52900276e2a54d0d86cb0", "committedDate": "2020-07-03T09:56:40Z", "message": "Remove new test method added initially, now superfluous after mvoe to junit\n\nSigned-off-by: Nigel Jones <nigel.l.jones+git@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95849fa9352b3c0ea68192d2a53e78688b51468a", "author": {"user": {"login": "planetf1", "name": "Nigel Jones"}}, "url": "https://github.com/odpi/egeria/commit/95849fa9352b3c0ea68192d2a53e78688b51468a", "committedDate": "2020-07-03T10:04:01Z", "message": "Additional comments on integration tests\n\nSigned-off-by: Nigel Jones <nigel.l.jones+git@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7cc1465273de6580eb49881bd49ad555e271457", "author": {"user": {"login": "planetf1", "name": "Nigel Jones"}}, "url": "https://github.com/odpi/egeria/commit/d7cc1465273de6580eb49881bd49ad555e271457", "committedDate": "2020-07-03T10:20:41Z", "message": "Move version def of groovy plugin to top level pom;\n\nSigned-off-by: Nigel Jones <nigel.l.jones+git@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d17cbd9e4c35329892bf034fb5ac24e0bb42e44", "author": {"user": {"login": "planetf1", "name": "Nigel Jones"}}, "url": "https://github.com/odpi/egeria/commit/9d17cbd9e4c35329892bf034fb5ac24e0bb42e44", "committedDate": "2020-07-03T10:29:21Z", "message": "Merge/fix from master\n\nSigned-off-by: Nigel Jones <nigel.l.jones+git@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98907850d25658f902b924daa4137f3c21ad9410", "author": {"user": {"login": "planetf1", "name": "Nigel Jones"}}, "url": "https://github.com/odpi/egeria/commit/98907850d25658f902b924daa4137f3c21ad9410", "committedDate": "2020-07-06T08:22:36Z", "message": "Merge branch 'master' of https://github.com/odpi/egeria into issue426_groovy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyODg4OTM0", "url": "https://github.com/odpi/egeria/pull/3297#pullrequestreview-442888934", "createdAt": "2020-07-06T08:50:15Z", "commit": {"oid": "98907850d25658f902b924daa4137f3c21ad9410"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwODo1MDoxNVrOGtOeEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwODo1MDoxNVrOGtOeEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDA3NjE3OA==", "bodyText": "@planetf1 We do have junits that inline the in memory repo to run tests, which means we do not need to have a dependant server. I like being able to run against a real server as you can change the type of repo.  I wonder if we could run the FVTs against an in memory repo and then a graph repo (in case there are quirky differences, for example around search). I raise this as a consideration in case there is something in the current structure you might want to change to accommodate running it against multiple repositories.", "url": "https://github.com/odpi/egeria/pull/3297#discussion_r450076178", "createdAt": "2020-07-06T08:50:15Z", "author": {"login": "davidradl"}, "path": "open-metadata-test/open-metadata-fvt/access-services-fvt/subject-area-fvt/src/test/script/configureStartServer.groovy", "diffHunk": "@@ -0,0 +1,113 @@\n+#!/usr/local/bin/groovy\n+import javax.net.ssl.HttpsURLConnection\n+\n+// SPDX-License-Identifier: Apache-2.0\n+// Copyright Contributors to the ODPi Egeria project.\n+\n+// Function to convert array to String\n+\n+// Will configure a server chassis - which should already be running - for FVT testing\n+\n+import javax.net.ssl.SSLContext\n+import javax.net.ssl.TrustManager\n+import javax.net.ssl.X509TrustManager\n+\n+// Retrieve configuration - with defaults to aid in local testing (using default ports)\n+user=properties[\"user\"] ?: \"garygeeke\";\n+baseURL=properties[\"baseURL\"] ?: \"https://localhost:9443\";\n+server=properties[\"server\"] ?: \"server1\";\n+retries=properties[\"retries\"] ?: 12;\n+delay=properties[\"delay\"] ?: 10;\n+\n+// SSL setup to avoid self-signed errors for testing\n+TrustManager[] trustAllCerts = new TrustManager[]{\n+        new X509TrustManager() {\n+\n+            public java.security.cert.X509Certificate[] getAcceptedIssuers()\n+            {\n+                return null;\n+            }\n+            public void checkClientTrusted(java.security.cert.X509Certificate[] certs, String authType)\n+            {\n+                //No need to implement.\n+            }\n+            public void checkServerTrusted(java.security.cert.X509Certificate[] certs, String authType)\n+            {\n+                //No need to implement.\n+            }\n+        }\n+};\n+try\n+{\n+    SSLContext sc = SSLContext.getInstance(\"SSL\");\n+    sc.init(null, trustAllCerts, new java.security.SecureRandom());\n+    HttpsURLConnection.setDefaultSSLSocketFactory(sc.getSocketFactory());\n+}\n+catch (Exception e)\n+{\n+    System.out.println(e);\n+    System.exit(-1);\n+}\n+\n+// Wait until the platform is ready\n+connected=false;\n+i=retries;\n+while (!connected && i>0)\n+{\n+    try {\n+\n+        System.out.println(\"=== Checking platform at \" + baseURL + \" is available (\" + i + \" attempts remaining) ===\");\n+        post0 = new java.net.URL(baseURL + \"/open-metadata/platform-services/users/\" + user + \"/server-platform/origin\").openConnection();\n+        post0RC = post0.getResponseCode();\n+        println(post0RC);\n+        if (post0RC.equals(200)) {\n+            connected = true;\n+            println(post0.getInputStream().getText());\n+        } else {\n+            i--;\n+            Thread.sleep(1000 * delay);\n+        }\n+    } catch (Throwable t)\n+    {\n+        // TODO: look at whether some exceptions should be deemed irrecoverable rather than retry\n+        i--;\n+        Thread.sleep(1000 * delay);\n+    }\n+}\n+\n+// --- Configure the platform - any errors here and we exit\n+System.out.println(\"=== Configuring server: \" + server + \" ===\");\n+post1 = new URL(baseURL + \"/open-metadata/admin-services/users/\" + user + \"/servers/\" + server + \"/local-repository/mode/in-memory-repository\" ).openConnection()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98907850d25658f902b924daa4137f3c21ad9410"}, "originalPosition": 80}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0f44e3f296c19622356f69e4842bcac5c7db8e7", "author": {"user": {"login": "planetf1", "name": "Nigel Jones"}}, "url": "https://github.com/odpi/egeria/commit/a0f44e3f296c19622356f69e4842bcac5c7db8e7", "committedDate": "2020-07-06T12:02:32Z", "message": "Disable failing Subject Area tests\n\nSigned-off-by: Nigel Jones <nigel.l.jones+git@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cbfee7cd2e6f99354232f7394af04041f16fc81", "author": {"user": {"login": "planetf1", "name": "Nigel Jones"}}, "url": "https://github.com/odpi/egeria/commit/0cbfee7cd2e6f99354232f7394af04041f16fc81", "committedDate": "2020-07-06T12:09:39Z", "message": "Merge branch 'master' of https://github.com/odt push    pi/egeria into issue426_groovy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c83c967a9f87fa418c8413958face3a58502d24", "author": {"user": {"login": "planetf1", "name": "Nigel Jones"}}, "url": "https://github.com/odpi/egeria/commit/4c83c967a9f87fa418c8413958face3a58502d24", "committedDate": "2020-07-07T13:01:28Z", "message": "Merge branch 'master' of https://github.com/odpi/egeria into issue426_groovy"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3967, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}