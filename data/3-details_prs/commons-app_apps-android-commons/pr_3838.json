{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4MDU4MjIz", "number": 3838, "title": "Set Media legend for wikidata entity", "bodyText": "Fixes #1831", "createdAt": "2020-06-22T16:39:48Z", "url": "https://github.com/commons-app/apps-android-commons/pull/3838", "merged": true, "mergeCommit": {"oid": "f26784e9c371816ec4ee301f525e6813d905e567"}, "closed": true, "closedAt": "2020-06-30T12:11:28Z", "author": {"login": "maskaravivek"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsvVa0gH2gAyNDM4MDU4MjIzOjdlZDZlMGQwZTdlOTZjMWQwNTM3ZGZiZmVmODI2OTczYzY1YTA3N2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcu1DYyAH2gAyNDM4MDU4MjIzOjk2NzI4ZTlmZDg2YzBhY2UxNGE3NTcyN2Y2ZjUzMjEwYjI0YmE0ZDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7ed6e0d0e7e96c1d0537dfbfef826973c65a077b", "author": {"user": {"login": "maskaravivek", "name": "Vivek Maskara"}}, "url": "https://github.com/commons-app/apps-android-commons/commit/7ed6e0d0e7e96c1d0537dfbfef826973c65a077b", "committedDate": "2020-06-19T09:07:41Z", "message": "Set media legends and P18"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cbf38e4243e5ea263d3e21017f574da0df48435", "author": {"user": {"login": "maskaravivek", "name": "Vivek Maskara"}}, "url": "https://github.com/commons-app/apps-android-commons/commit/1cbf38e4243e5ea263d3e21017f574da0df48435", "committedDate": "2020-06-22T16:39:05Z", "message": "Minor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MDk3NzI4", "url": "https://github.com/commons-app/apps-android-commons/pull/3838#pullrequestreview-435097728", "createdAt": "2020-06-22T16:39:51Z", "commit": {"oid": "1cbf38e4243e5ea263d3e21017f574da0df48435"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b49c71bfeedaabf69dfbb1028ace5dcb1ea4741", "author": {"user": {"login": "maskaravivek", "name": "Vivek Maskara"}}, "url": "https://github.com/commons-app/apps-android-commons/commit/8b49c71bfeedaabf69dfbb1028ace5dcb1ea4741", "committedDate": "2020-06-23T06:03:32Z", "message": "Make media legends work"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01dda047543c159de6d13d736bdc11ffeda20201", "author": {"user": {"login": "maskaravivek", "name": "Vivek Maskara"}}, "url": "https://github.com/commons-app/apps-android-commons/commit/01dda047543c159de6d13d736bdc11ffeda20201", "committedDate": "2020-06-23T06:51:22Z", "message": "Add test cases"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NjUxMTk4", "url": "https://github.com/commons-app/apps-android-commons/pull/3838#pullrequestreview-435651198", "createdAt": "2020-06-23T10:30:35Z", "commit": {"oid": "01dda047543c159de6d13d736bdc11ffeda20201"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMDozMDozNVrOGnjN0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMDozMDozNVrOGnjN0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEyNDYyNw==", "bodyText": "This is a Statement_partial though not as partial", "url": "https://github.com/commons-app/apps-android-commons/pull/3838#discussion_r444124627", "createdAt": "2020-06-23T10:30:35Z", "author": {"login": "macgills"}, "path": "app/src/main/java/fr/free/nrw/commons/wikidata/model/WikidataSetClaim.kt", "diffHunk": "@@ -0,0 +1,30 @@\n+package fr.free.nrw.commons.wikidata.model\n+\n+import com.google.gson.annotations.SerializedName\n+import fr.free.nrw.commons.wikidata.WikidataProperties\n+import org.wikipedia.wikidata.Snak_partial\n+\n+data class WikidataSetClaim(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01dda047543c159de6d13d736bdc11ffeda20201"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NjUxMzc1", "url": "https://github.com/commons-app/apps-android-commons/pull/3838#pullrequestreview-435651375", "createdAt": "2020-06-23T10:30:50Z", "commit": {"oid": "01dda047543c159de6d13d736bdc11ffeda20201"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMDozMDo1MFrOGnjOYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMDozMDo1MFrOGnjOYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEyNDc3MA==", "bodyText": "revert", "url": "https://github.com/commons-app/apps-android-commons/pull/3838#discussion_r444124770", "createdAt": "2020-06-23T10:30:50Z", "author": {"login": "macgills"}, "path": "app/src/main/java/fr/free/nrw/commons/OkHttpConnectionFactory.java", "diffHunk": "@@ -41,7 +41,7 @@ private static OkHttpClient createClient() {\n \n     private static HttpLoggingInterceptor getLoggingInterceptor() {\n         final HttpLoggingInterceptor httpLoggingInterceptor = new HttpLoggingInterceptor()\n-            .setLevel(Level.BASIC);\n+            .setLevel(Level.BODY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01dda047543c159de6d13d736bdc11ffeda20201"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NjUzNDAx", "url": "https://github.com/commons-app/apps-android-commons/pull/3838#pullrequestreview-435653401", "createdAt": "2020-06-23T10:34:05Z", "commit": {"oid": "01dda047543c159de6d13d736bdc11ffeda20201"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMDozNDowNVrOGnjUZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMDozNDowNVrOGnjUZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEyNjMwOQ==", "bodyText": "We can delete this log", "url": "https://github.com/commons-app/apps-android-commons/pull/3838#discussion_r444126309", "createdAt": "2020-06-23T10:34:05Z", "author": {"login": "macgills"}, "path": "app/src/main/java/fr/free/nrw/commons/wikidata/WikidataEditService.java", "diffHunk": "@@ -127,29 +135,40 @@ private void onAddCaptionResponse(Long fileEntityId, MwPostResponse response) {\n     }\n   }\n \n-  public void createImageClaim(@Nullable final WikidataPlace wikidataPlace, final UploadResult imageUpload) {\n+  public void createClaim(@Nullable final WikidataPlace wikidataPlace, final String fileName, final\n+  HashMap<String, String> captions) {\n     if (!(directKvStore.getBoolean(\"Picture_Has_Correct_Location\", true))) {\n-      Timber.d(\"Image location and nearby place location mismatched, so Wikidata item won't be edited\");\n+      Timber\n+          .d(\"Image location and nearby place location mismatched, so Wikidata item won't be edited\");\n       return;\n     }\n-    editWikidataImageProperty(wikidataPlace, imageUpload);\n+    addImageAndMediaLegends(wikidataPlace, fileName, captions);\n   }\n \n-  @SuppressLint(\"CheckResult\")\n-  private void editWikidataImageProperty(final WikidataItem wikidataItem, final UploadResult imageUpload) {\n-    wikidataClient.createImageClaim(wikidataItem, String.format(\"\\\"%s\\\"\", imageUpload.getFilename()))\n-        .flatMap(revisionId -> {\n-          if (revisionId != -1) {\n-            return wikidataClient.addEditTag(revisionId, COMMONS_APP_TAG, COMMONS_APP_EDIT_REASON);\n-          }\n-          throw new RuntimeException(\"Unable to edit wikidata item\");\n-        })\n-        .subscribeOn(Schedulers.io())\n+  public void addImageAndMediaLegends(final WikidataItem wikidataItem, final String fileName,\n+      HashMap<String, String> captions) {\n+    Snak_partial p18 = new Snak_partial(\"value\", WikidataProperties.IMAGE.getPropertyName(),\n+        new ValueString(fileName.replace(\"File:\", \"\")));\n+\n+    List<Snak_partial> snaks = new ArrayList<>();\n+    for (String key : captions.keySet()) {\n+      snaks.add(new Snak_partial(\"value\",\n+          WikidataProperties.MEDIA_LEGENDS.getPropertyName(), new DataValue.MonoLingualText_partial(\n+          new WikiBaseMonolingualTextValue(captions.get(key), key))));\n+    }\n+\n+    String id = wikidataItem.getId() + \"$\" + UUID.randomUUID().toString();\n+    WikidataSetClaim claim = new WikidataSetClaim(p18, id, snaks);\n+\n+    Timber.d(\"Claim object is %s\", gson.toJson(claim));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01dda047543c159de6d13d736bdc11ffeda20201"}, "originalPosition": 204}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NjYxOTU5", "url": "https://github.com/commons-app/apps-android-commons/pull/3838#pullrequestreview-435661959", "createdAt": "2020-06-23T10:46:32Z", "commit": {"oid": "01dda047543c159de6d13d736bdc11ffeda20201"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMDo0NjozMlrOGnjtlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMDo0NjozMlrOGnjtlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEzMjc1Ng==", "bodyText": "inside the loop the value in the map is used so iterating the entryset would be better.\nThis could also be made to more resemble how EditClaim works where the construction of the object bears resemblance to the json but y'know optional", "url": "https://github.com/commons-app/apps-android-commons/pull/3838#discussion_r444132756", "createdAt": "2020-06-23T10:46:32Z", "author": {"login": "macgills"}, "path": "app/src/main/java/fr/free/nrw/commons/wikidata/WikidataEditService.java", "diffHunk": "@@ -127,29 +135,40 @@ private void onAddCaptionResponse(Long fileEntityId, MwPostResponse response) {\n     }\n   }\n \n-  public void createImageClaim(@Nullable final WikidataPlace wikidataPlace, final UploadResult imageUpload) {\n+  public void createClaim(@Nullable final WikidataPlace wikidataPlace, final String fileName, final\n+  HashMap<String, String> captions) {\n     if (!(directKvStore.getBoolean(\"Picture_Has_Correct_Location\", true))) {\n-      Timber.d(\"Image location and nearby place location mismatched, so Wikidata item won't be edited\");\n+      Timber\n+          .d(\"Image location and nearby place location mismatched, so Wikidata item won't be edited\");\n       return;\n     }\n-    editWikidataImageProperty(wikidataPlace, imageUpload);\n+    addImageAndMediaLegends(wikidataPlace, fileName, captions);\n   }\n \n-  @SuppressLint(\"CheckResult\")\n-  private void editWikidataImageProperty(final WikidataItem wikidataItem, final UploadResult imageUpload) {\n-    wikidataClient.createImageClaim(wikidataItem, String.format(\"\\\"%s\\\"\", imageUpload.getFilename()))\n-        .flatMap(revisionId -> {\n-          if (revisionId != -1) {\n-            return wikidataClient.addEditTag(revisionId, COMMONS_APP_TAG, COMMONS_APP_EDIT_REASON);\n-          }\n-          throw new RuntimeException(\"Unable to edit wikidata item\");\n-        })\n-        .subscribeOn(Schedulers.io())\n+  public void addImageAndMediaLegends(final WikidataItem wikidataItem, final String fileName,\n+      HashMap<String, String> captions) {\n+    Snak_partial p18 = new Snak_partial(\"value\", WikidataProperties.IMAGE.getPropertyName(),\n+        new ValueString(fileName.replace(\"File:\", \"\")));\n+\n+    List<Snak_partial> snaks = new ArrayList<>();\n+    for (String key : captions.keySet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01dda047543c159de6d13d736bdc11ffeda20201"}, "originalPosition": 195}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67bdc9e87668ccef0272d8224bf1989fa71768a0", "author": {"user": {"login": "maskaravivek", "name": "Vivek Maskara"}}, "url": "https://github.com/commons-app/apps-android-commons/commit/67bdc9e87668ccef0272d8224bf1989fa71768a0", "committedDate": "2020-06-23T16:09:08Z", "message": "Use statement partial"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NDE0MTAy", "url": "https://github.com/commons-app/apps-android-commons/pull/3838#pullrequestreview-437414102", "createdAt": "2020-06-25T11:46:15Z", "commit": {"oid": "67bdc9e87668ccef0272d8224bf1989fa71768a0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMTo0NjoxNlrOGo3C2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMTo0NjoxNlrOGo3C2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ5ODA3Mw==", "bodyText": "If we have achieved full mapping of this data value then we can get rid of the _partial suffix, my intention with them was \"I have no idea if this is absolutely the true network model\"", "url": "https://github.com/commons-app/apps-android-commons/pull/3838#discussion_r445498073", "createdAt": "2020-06-25T11:46:16Z", "author": {"login": "macgills"}, "path": "data-client/src/main/java/org/wikipedia/wikidata/DataValue.kt", "diffHunk": "@@ -87,7 +87,7 @@ sealed class DataValue(val type: String) {\n     //        \"language\": \"ko\"\n     //    }\n     //    }\n-    class MonoLingualText_partial() : DataValue(TYPE) {\n+    class MonoLingualText_partial(val value: WikiBaseMonolingualTextValue) : DataValue(TYPE) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67bdc9e87668ccef0272d8224bf1989fa71768a0"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "696981685232a061f77dab327f50bc4bc5ec8b9a", "author": {"user": {"login": "maskaravivek", "name": "Vivek Maskara"}}, "url": "https://github.com/commons-app/apps-android-commons/commit/696981685232a061f77dab327f50bc4bc5ec8b9a", "committedDate": "2020-06-25T17:04:41Z", "message": "With minor refactoring"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96728e9fd86c0ace14a75727f6f53210b24ba4d6", "author": {"user": {"login": "maskaravivek", "name": "Vivek Maskara"}}, "url": "https://github.com/commons-app/apps-android-commons/commit/96728e9fd86c0ace14a75727f6f53210b24ba4d6", "committedDate": "2020-06-25T20:55:16Z", "message": "Fix build"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 627, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}