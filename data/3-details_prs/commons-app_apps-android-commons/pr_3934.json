{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwODQwNTMx", "number": 3934, "title": "With changes for limited connection mode", "bodyText": "Description (required)\nFixes #746", "createdAt": "2020-09-22T10:27:22Z", "url": "https://github.com/commons-app/apps-android-commons/pull/3934", "merged": true, "mergeCommit": {"oid": "66f6e2e64854fd5aed1af6c3f493c5d507e8c8f8"}, "closed": true, "closedAt": "2020-09-25T12:57:23Z", "author": {"login": "maskaravivek"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLVZt_AH2gAyNDkwODQwNTMxOmM2MGM2OWJhYzU5OWI0MmEwZjhjMDkwYTZiZWEzZDAxZjY1YTIwNGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMGouDAH2gAyNDkwODQwNTMxOjc0NDg1YjI2ZmY2ZDdkMzE1ZjE3NmMxYWQ4ZjhjOGY2YWJhM2I4MjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c60c69bac599b42a0f8c090a6bea3d01f65a204b", "author": {"user": {"login": "maskaravivek", "name": "Vivek Maskara"}}, "url": "https://github.com/commons-app/apps-android-commons/commit/c60c69bac599b42a0f8c090a6bea3d01f65a204b", "committedDate": "2020-09-22T10:26:30Z", "message": "With changed for limited connection mode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55bea73ed97648dc0fb23ec63f899611bfc423db", "author": {"user": {"login": "maskaravivek", "name": "Vivek Maskara"}}, "url": "https://github.com/commons-app/apps-android-commons/commit/55bea73ed97648dc0fb23ec63f899611bfc423db", "committedDate": "2020-09-22T10:29:30Z", "message": "Java docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a1bca98e103bfb9a4e018a6f1c3d479ca286130", "author": {"user": {"login": "maskaravivek", "name": "Vivek Maskara"}}, "url": "https://github.com/commons-app/apps-android-commons/commit/6a1bca98e103bfb9a4e018a6f1c3d479ca286130", "committedDate": "2020-09-23T05:19:30Z", "message": "With minor fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0MjAzNDk1", "url": "https://github.com/commons-app/apps-android-commons/pull/3934#pullrequestreview-494203495", "createdAt": "2020-09-23T06:05:34Z", "commit": {"oid": "6a1bca98e103bfb9a4e018a6f1c3d479ca286130"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NjEwOTk3", "url": "https://github.com/commons-app/apps-android-commons/pull/3934#pullrequestreview-495610997", "createdAt": "2020-09-24T14:06:25Z", "commit": {"oid": "6a1bca98e103bfb9a4e018a6f1c3d479ca286130"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNDowNjoyNlrOHXcqGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNDowNjoyNlrOHXcqGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM0ODgyNQ==", "bodyText": "Could we get Javadocs for these methods please?", "url": "https://github.com/commons-app/apps-android-commons/pull/3934#discussion_r494348825", "createdAt": "2020-09-24T14:06:26Z", "author": {"login": "misaochan"}, "path": "app/src/main/java/fr/free/nrw/commons/media/CustomOkHttpNetworkFetcher.java", "diffHunk": "@@ -0,0 +1,229 @@\n+package fr.free.nrw.commons.media;\n+\n+import android.net.Uri;\n+import android.os.Looper;\n+import android.os.SystemClock;\n+import androidx.annotation.Nullable;\n+import com.facebook.imagepipeline.common.BytesRange;\n+import com.facebook.imagepipeline.image.EncodedImage;\n+import com.facebook.imagepipeline.producers.BaseNetworkFetcher;\n+import com.facebook.imagepipeline.producers.BaseProducerContextCallbacks;\n+import com.facebook.imagepipeline.producers.Consumer;\n+import com.facebook.imagepipeline.producers.FetchState;\n+import com.facebook.imagepipeline.producers.NetworkFetcher;\n+import com.facebook.imagepipeline.producers.ProducerContext;\n+import fr.free.nrw.commons.CommonsApplication;\n+import fr.free.nrw.commons.kvstore.JsonKvStore;\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.Executor;\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+import javax.inject.Singleton;\n+import okhttp3.CacheControl;\n+import okhttp3.Call;\n+import okhttp3.OkHttpClient;\n+import okhttp3.Request;\n+import okhttp3.Response;\n+import okhttp3.ResponseBody;\n+import timber.log.Timber;\n+\n+// Custom implementation of Fresco's Network fetcher to skip downloading of images when limited connection mode is enabled\n+// https://github.com/facebook/fresco/blob/master/imagepipeline-backends/imagepipeline-okhttp3/src/main/java/com/facebook/imagepipeline/backends/okhttp3/OkHttpNetworkFetcher.java\n+@Singleton\n+public class CustomOkHttpNetworkFetcher\n+    extends BaseNetworkFetcher<CustomOkHttpNetworkFetcher.OkHttpNetworkFetchState> {\n+\n+  private static final String QUEUE_TIME = \"queue_time\";\n+  private static final String FETCH_TIME = \"fetch_time\";\n+  private static final String TOTAL_TIME = \"total_time\";\n+  private static final String IMAGE_SIZE = \"image_size\";\n+  private final Call.Factory mCallFactory;\n+  private final @Nullable\n+  CacheControl mCacheControl;\n+  private Executor mCancellationExecutor;\n+  private JsonKvStore defaultKvStore;\n+\n+  /**\n+   * @param okHttpClient client to use\n+   */\n+  @Inject\n+  public CustomOkHttpNetworkFetcher(OkHttpClient okHttpClient,\n+      @Named(\"default_preferences\") JsonKvStore defaultKvStore) {\n+    this(okHttpClient, okHttpClient.dispatcher().executorService(), defaultKvStore);\n+  }\n+\n+  /**\n+   * @param callFactory          custom {@link Call.Factory} for fetching image from the network\n+   * @param cancellationExecutor executor on which fetching cancellation is performed if\n+   *                             cancellation is requested from the UI Thread\n+   */\n+  public CustomOkHttpNetworkFetcher(Call.Factory callFactory, Executor cancellationExecutor,\n+      JsonKvStore defaultKvStore) {\n+    this(callFactory, cancellationExecutor, defaultKvStore, true);\n+  }\n+\n+  /**\n+   * @param callFactory          custom {@link Call.Factory} for fetching image from the network\n+   * @param cancellationExecutor executor on which fetching cancellation is performed if\n+   *                             cancellation is requested from the UI Thread\n+   * @param disableOkHttpCache   true if network requests should not be cached by OkHttp\n+   */\n+  public CustomOkHttpNetworkFetcher(\n+      Call.Factory callFactory, Executor cancellationExecutor, JsonKvStore defaultKvStore,\n+      boolean disableOkHttpCache) {\n+    this.defaultKvStore = defaultKvStore;\n+    mCallFactory = callFactory;\n+    mCancellationExecutor = cancellationExecutor;\n+    mCacheControl = disableOkHttpCache ? new CacheControl.Builder().noStore().build() : null;\n+  }\n+\n+  @Override\n+  public OkHttpNetworkFetchState createFetchState(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a1bca98e103bfb9a4e018a6f1c3d479ca286130"}, "originalPosition": 83}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74fef78da9e85a79259b87933456c0e08b07fc03", "author": {"user": {"login": "maskaravivek", "name": "Vivek Maskara"}}, "url": "https://github.com/commons-app/apps-android-commons/commit/74fef78da9e85a79259b87933456c0e08b07fc03", "committedDate": "2020-09-24T17:24:25Z", "message": "Fix cosmetic issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94f5fa84c33e929ecc27023aec02b7f71a705721", "author": {"user": {"login": "maskaravivek", "name": "Vivek Maskara"}}, "url": "https://github.com/commons-app/apps-android-commons/commit/94f5fa84c33e929ecc27023aec02b7f71a705721", "committedDate": "2020-09-24T19:30:05Z", "message": "Fix ANR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74485b26ff6d7d315f176c1ad8f8c8f6aba3b822", "author": {"user": {"login": "maskaravivek", "name": "Vivek Maskara"}}, "url": "https://github.com/commons-app/apps-android-commons/commit/74485b26ff6d7d315f176c1ad8f8c8f6aba3b822", "committedDate": "2020-09-24T19:48:14Z", "message": "Add Unit test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 539, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}