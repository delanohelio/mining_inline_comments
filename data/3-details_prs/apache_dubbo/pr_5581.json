{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU4OTIxMjEw", "number": 5581, "title": "Registry protocol listener", "bodyText": "What is the purpose of the change\nXXXXX\nBrief changelog\nXXXXX\nVerifying this change\nXXXXX\nFollow this checklist to help us incorporate your contribution quickly and easily:\n\n Make sure there is a GITHUB_issue field for the change (usually before you start working on it). Trivial changes like typos do not require a GITHUB issue. Your pull request should address just this issue, without pulling in other changes - one PR resolves one issue.\n Format the pull request title like [Dubbo-XXX] Fix UnknownException when host config not exist #XXX. Each commit in the pull request should have a meaningful subject line and body.\n Write a pull request description that is detailed enough to understand what the pull request does, how, and why.\n Write necessary unit-test to verify your logic correction, more mock a little better when cross module dependency exist. If the new feature or significant change is committed, please remember to add sample in dubbo samples project.\n Run mvn clean install -DskipTests=false & mvn clean test-compile failsafe:integration-test to make sure unit-test and integration-test pass.\n If this contribution is large, please follow the Software Donation Guide.", "createdAt": "2020-01-03T09:18:46Z", "url": "https://github.com/apache/dubbo/pull/5581", "merged": true, "mergeCommit": {"oid": "ce8b6e8972ddf8a78652d49f3ecde546420f46fa"}, "closed": true, "closedAt": "2020-02-04T09:43:54Z", "author": {"login": "beiwei30"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb2ZP9hAH2gAyMzU4OTIxMjEwOmI0NDc3NjgzOThjYTYxYmQ4ZjA5YWZlY2RkMGEzNzYyYTExNTI4MGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb62nOJgH2gAyMzU4OTIxMjEwOjM4MWQ5Mzg0OGI5MGYyYjc3YTI3OGEzMWZmOWQyOGMyZTEzYjIzNDA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b447768398ca61bd8f09afecdd0a3762a115280c", "author": {"user": {"login": "beiwei30", "name": "Ian Luo"}}, "url": "https://github.com/apache/dubbo/commit/b447768398ca61bd8f09afecdd0a3762a115280c", "committedDate": "2020-01-02T12:51:54Z", "message": "introduce RegistryProtocolListener, and reRefer method on RegistryProtocol"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67db4fa581bfd026760e497c763b8b7d71f9a7e3", "author": {"user": {"login": "beiwei30", "name": "Ian Luo"}}, "url": "https://github.com/apache/dubbo/commit/67db4fa581bfd026760e497c763b8b7d71f9a7e3", "committedDate": "2020-01-03T07:41:24Z", "message": "make interface cleaner"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "201f7a57e0507ccbc9b4bce019af95cf57850dda", "author": {"user": {"login": "beiwei30", "name": "Ian Luo"}}, "url": "https://github.com/apache/dubbo/commit/201f7a57e0507ccbc9b4bce019af95cf57850dda", "committedDate": "2020-01-03T16:35:20Z", "message": "re-register consumer model and provider model if necessary"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b817b299a692cefd37564b6fee94b87a8e892a64", "author": {"user": {"login": "beiwei30", "name": "Ian Luo"}}, "url": "https://github.com/apache/dubbo/commit/b817b299a692cefd37564b6fee94b87a8e892a64", "committedDate": "2020-01-03T16:36:23Z", "message": "Merge branch 'master' of https://github.com/apache/dubbo into registry-protocol-listener"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93809ff11c51d0a639e95b16ca430ba5067bdc9a", "author": {"user": {"login": "beiwei30", "name": "Ian Luo"}}, "url": "https://github.com/apache/dubbo/commit/93809ff11c51d0a639e95b16ca430ba5067bdc9a", "committedDate": "2020-01-03T18:06:19Z", "message": "make sure provider-model's servicekey changes before protocol's export, also update service metadata if necessary"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bcd1d63f3c180ffb3653c379e6ae89e17211113", "author": {"user": {"login": "beiwei30", "name": "Ian Luo"}}, "url": "https://github.com/apache/dubbo/commit/6bcd1d63f3c180ffb3653c379e6ae89e17211113", "committedDate": "2020-01-06T11:30:01Z", "message": "also shallow copy method model"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MDUxNzk5", "url": "https://github.com/apache/dubbo/pull/5581#pullrequestreview-339051799", "createdAt": "2020-01-07T06:33:03Z", "commit": {"oid": "6bcd1d63f3c180ffb3653c379e6ae89e17211113"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNjozMzowNFrOFaw3jA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNjozMzowNFrOFaw3jA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzYwNzk0OA==", "bodyText": "Please delete unused import, otherwise you can't pass ci check.", "url": "https://github.com/apache/dubbo/pull/5581#discussion_r363607948", "createdAt": "2020-01-07T06:33:04Z", "author": {"login": "InstallingB"}, "path": "dubbo-common/src/main/java/org/apache/dubbo/rpc/model/ConsumerModel.java", "diffHunk": "@@ -18,6 +18,7 @@\n \n import org.apache.dubbo.common.utils.Assert;\n import org.apache.dubbo.config.ReferenceConfigBase;\n+import org.apache.dubbo.config.annotation.Service;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bcd1d63f3c180ffb3653c379e6ae89e17211113"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "756660fa7496e1a06d937c0e89994901db11ecf0", "author": {"user": {"login": "beiwei30", "name": "Ian Luo"}}, "url": "https://github.com/apache/dubbo/commit/756660fa7496e1a06d937c0e89994901db11ecf0", "committedDate": "2020-01-07T11:47:10Z", "message": "enhance consumer model and provider model"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "268360f067e9cd384d5ec4ecca7e4923c7a9c8d8", "author": {"user": {"login": "beiwei30", "name": "Ian Luo"}}, "url": "https://github.com/apache/dubbo/commit/268360f067e9cd384d5ec4ecca7e4923c7a9c8d8", "committedDate": "2020-01-07T11:48:17Z", "message": "Merge branch 'master' of https://github.com/apache/dubbo into registry-protocol-listener"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d739b515d98787dec2e6f5018b668a612eb1446b", "author": {"user": {"login": "beiwei30", "name": "Ian Luo"}}, "url": "https://github.com/apache/dubbo/commit/d739b515d98787dec2e6f5018b668a612eb1446b", "committedDate": "2020-01-07T18:40:20Z", "message": "fix minor issue when regiter consumer model wihtout group, and no need to re-build router chain"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2d9d5ad1d5fc4595b5e5c8e560416fcd3746806", "author": {"user": {"login": "beiwei30", "name": "Ian Luo"}}, "url": "https://github.com/apache/dubbo/commit/e2d9d5ad1d5fc4595b5e5c8e560416fcd3746806", "committedDate": "2020-01-08T06:25:37Z", "message": "rebuild router chain, also clean up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a2d74a2ad987731f544cda550bdb784dbe4c7fd", "author": {"user": {"login": "beiwei30", "name": "Ian Luo"}}, "url": "https://github.com/apache/dubbo/commit/1a2d74a2ad987731f544cda550bdb784dbe4c7fd", "committedDate": "2020-01-08T06:32:50Z", "message": "optimize imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e918e3f936fcabd823533f70f398df902a92ad8d", "author": {"user": {"login": "beiwei30", "name": "Ian Luo"}}, "url": "https://github.com/apache/dubbo/commit/e918e3f936fcabd823533f70f398df902a92ad8d", "committedDate": "2020-01-09T02:42:23Z", "message": "avoid NPE"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5641a8b53e47323879d4bcb4588ea0e36bb62f6", "author": {"user": {"login": "beiwei30", "name": "Ian Luo"}}, "url": "https://github.com/apache/dubbo/commit/e5641a8b53e47323879d4bcb4588ea0e36bb62f6", "committedDate": "2020-01-14T03:20:02Z", "message": "introduce onDestroy method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d2948077065693764bff2c6293ef006905d560f", "author": {"user": {"login": "beiwei30", "name": "Ian Luo"}}, "url": "https://github.com/apache/dubbo/commit/8d2948077065693764bff2c6293ef006905d560f", "committedDate": "2020-01-14T03:24:31Z", "message": "remove unused imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNzM4NjY2", "url": "https://github.com/apache/dubbo/pull/5581#pullrequestreview-343738666", "createdAt": "2020-01-16T08:25:35Z", "commit": {"oid": "8d2948077065693764bff2c6293ef006905d560f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwODoyNTozNVrOFeRQ3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwODoyNTozNVrOFeRQ3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzI4NDQ0Ng==", "bodyText": "if newServiceKey equals serviceKey,then ProviderModel would be remove", "url": "https://github.com/apache/dubbo/pull/5581#discussion_r367284446", "createdAt": "2020-01-16T08:25:35Z", "author": {"login": "qinliujie"}, "path": "dubbo-common/src/main/java/org/apache/dubbo/rpc/model/ServiceRepository.java", "diffHunk": "@@ -84,33 +90,39 @@ public void registerConsumer(String serviceKey,\n                                  ReferenceConfigBase<?> rc,\n                                  Object proxy,\n                                  ServiceMetadata serviceMetadata) {\n-        consumers.computeIfAbsent(\n-                serviceKey,\n-                _k -> new ConsumerModel(\n-                        serviceMetadata.getServiceKey(),\n-                        proxy,\n-                        serviceDescriptor,\n-                        rc,\n-                        serviceMetadata\n-                )\n-        );\n+        ConsumerModel consumerModel = new ConsumerModel(serviceMetadata.getServiceKey(), proxy, serviceDescriptor, rc,\n+                serviceMetadata);\n+        consumers.putIfAbsent(serviceKey, consumerModel);\n+    }\n+\n+    public void reRegisterConsumer(String newServiceKey, String serviceKey) {\n+        ConsumerModel consumerModel = consumers.get(serviceKey);\n+        consumerModel.setServiceKey(newServiceKey);\n+        consumers.putIfAbsent(newServiceKey, consumerModel);\n+        consumers.remove(serviceKey);\n+\n     }\n \n     public void registerProvider(String serviceKey,\n                                  Object serviceInstance,\n                                  ServiceDescriptor serviceModel,\n                                  ServiceConfigBase<?> serviceConfig,\n                                  ServiceMetadata serviceMetadata) {\n-        providers.computeIfAbsent(\n-                serviceKey,\n-                _k -> new ProviderModel(\n-                        serviceKey,\n-                        serviceInstance,\n-                        serviceModel,\n-                        serviceConfig,\n-                        serviceMetadata\n-                )\n-        );\n+        ProviderModel providerModel = new ProviderModel(serviceKey, serviceInstance, serviceModel, serviceConfig,\n+                serviceMetadata);\n+        providers.putIfAbsent(serviceKey, providerModel);\n+        providersWithoutGroup.putIfAbsent(keyWithoutGroup(serviceKey), providerModel);\n+    }\n+\n+    private static String keyWithoutGroup(String serviceKey) {\n+        return interfaceFromServiceKey(serviceKey) + \":\" + versionFromServiceKey(serviceKey);\n+    }\n+\n+    public void reRegisterProvider(String newServiceKey, String serviceKey) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d2948077065693764bff2c6293ef006905d560f"}, "originalPosition": 72}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNzQzMDU0", "url": "https://github.com/apache/dubbo/pull/5581#pullrequestreview-343743054", "createdAt": "2020-01-16T08:33:48Z", "commit": {"oid": "8d2948077065693764bff2c6293ef006905d560f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwODozMzo0OFrOFeReig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwODozMzo0OFrOFeReig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzI4Nzk0Ng==", "bodyText": "is it should be if (shouldSimplified)", "url": "https://github.com/apache/dubbo/pull/5581#discussion_r367287946", "createdAt": "2020-01-16T08:33:48Z", "author": {"login": "qinliujie"}, "path": "dubbo-registry/dubbo-registry-api/src/main/java/org/apache/dubbo/registry/integration/RegistryDirectory.java", "diffHunk": "@@ -616,8 +641,14 @@ public URL getRegisteredConsumerUrl() {\n         return registeredConsumerUrl;\r\n     }\r\n \r\n-    public void setRegisteredConsumerUrl(URL registeredConsumerUrl) {\r\n-        this.registeredConsumerUrl = registeredConsumerUrl;\r\n+    public void setRegisteredConsumerUrl(URL url) {\r\n+        if (!shouldSimplified) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d2948077065693764bff2c6293ef006905d560f"}, "originalPosition": 83}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "381d93848b90f2b77a278a31ff9d28c2e13b2340", "author": {"user": {"login": "qinliujie", "name": null}}, "url": "https://github.com/apache/dubbo/commit/381d93848b90f2b77a278a31ff9d28c2e13b2340", "committedDate": "2020-01-16T09:20:15Z", "message": "Merge branch 'master' into registry-protocol-listener"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2197, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}