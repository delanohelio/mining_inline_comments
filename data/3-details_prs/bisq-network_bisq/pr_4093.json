{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzMDM4MDcz", "number": 4093, "title": "Prevent dust outputs from being created during withdraw from wallet", "bodyText": "This change fixes an issue whereby dust change outputs are inadvertently created when users make withdrawals from their wallets.  (Funds -> Send Funds)\nThe solution taken here is to detect a dust TXO during the withdrawal fee estimation process and add that amount to the fee thus eliminating the dust output.\nFor example if the user has 1 BTC and goes to withdraw 0.99999900 BTC it will detect a change TXO of 100 sats which is below the dust limit, increase the fee by 100 sats and therefore withdraw 1 BTC.\nThis fix only applies to user withdrawals from their wallet.  Other use cases such as P2P trading, deposits and fees will be handled separately.\nRelated to #4039", "createdAt": "2020-03-24T14:50:52Z", "url": "https://github.com/bisq-network/bisq/pull/4093", "merged": true, "mergeCommit": {"oid": "d0a8890c0976eff127cd9f46df43f70bfba43940"}, "closed": true, "closedAt": "2020-04-03T13:56:05Z", "author": {"login": "jmacxx"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQztuDAH2gAyMzkzMDM4MDczOjA1N2UyYzVlN2NiYjdjMTNjZmUzYjM2ZGYyNTgzMzM4Y2JmMjk4MmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcUBTrbAFqTM4NzI3ODg1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "057e2c5e7cbb7c13cfe3b36df2583338cbf2982c", "author": {"user": {"login": "jmacxx", "name": null}}, "url": "https://github.com/bisq-network/bisq/commit/057e2c5e7cbb7c13cfe3b36df2583338cbf2982c", "committedDate": "2020-03-24T14:23:58Z", "message": "Remove dust outputs created during withdraw from wallet\n\nThis change fixes an issue whereby dust change outputs are\ninadvertently created when users make withdrawals from their\nwallets.  (Funds -> Send Funds)\n\nThe solution taken here is to detect a dust TXO during the withdrawal\nfee estimation process and add that amount to the fee thus eliminating\nthe dust output.\n\nFor example if the user has 1 BTC and goes to withdraw 0.99999900 BTC\nit will detect a change TXO of 100 sats which is below the dust limit,\nincrease the fee by 100 sats and therefore withdraw 1 BTC.\n\nThis fix only applies to user withdrawals from their wallet.  Other\nuse cases such as P2P trading, deposits and fees will be handled\nseparately.\n\nRelated to #4039"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxOTcxODE3", "url": "https://github.com/bisq-network/bisq/pull/4093#pullrequestreview-381971817", "createdAt": "2020-03-26T12:45:50Z", "commit": {"oid": "057e2c5e7cbb7c13cfe3b36df2583338cbf2982c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjo0NTo1MFrOF8FJYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMzoxNTowMVrOF8GQ8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU0MzIwMg==", "bodyText": "Better use a constant for values like the dust limit.", "url": "https://github.com/bisq-network/bisq/pull/4093#discussion_r398543202", "createdAt": "2020-03-26T12:45:50Z", "author": {"login": "sqrrm"}, "path": "desktop/src/main/java/bisq/desktop/main/funds/withdrawal/WithdrawalView.java", "diffHunk": "@@ -629,6 +631,17 @@ public void updateItem(final WithdrawalListItem item, boolean empty) {\n                     }\n                 });\n     }\n+\n+    private Coin getDust(Transaction tx) {\n+        Coin dust = Coin.ZERO;\n+        for (TransactionOutput txo: tx.getOutputs()) {\n+            if (txo.getValue().value < 546) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "057e2c5e7cbb7c13cfe3b36df2583338cbf2982c"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU2MDY1Mg==", "bodyText": "The added complexity of the dust on top of the fee makes this code really hard to read. It's not transparent to neither the developer nor the user what will happen here. The dust amount is so low that it's unlikely to cause monetary damage, but users expect a certain amount to be sent and when the dust is added it might cause confusion. (If I got it right,the dust is added as fee or sent amount depending on whether feeExcluded is set or not)\nI suggest making this code easier to follow, and adding a notice to the user that dust might be padded to the fee and make sure it's only padding the fee.", "url": "https://github.com/bisq-network/bisq/pull/4093#discussion_r398560652", "createdAt": "2020-03-26T13:13:37Z", "author": {"login": "sqrrm"}, "path": "desktop/src/main/java/bisq/desktop/main/funds/withdrawal/WithdrawalView.java", "diffHunk": "@@ -330,8 +331,9 @@ private void onWithdraw() {\n                     feeEstimationTransaction = walletService.getFeeEstimationTransactionForMultipleAddresses(fromAddresses, sendersAmount);\n                 }\n                 checkNotNull(feeEstimationTransaction, \"feeEstimationTransaction must not be null\");\n-                Coin fee = feeEstimationTransaction.getFee();\n-                sendersAmount = feeExcluded ? amountAsCoin.add(fee) : amountAsCoin;\n+                Coin dust = getDust(feeEstimationTransaction);\n+                Coin fee = feeEstimationTransaction.getFee().add(dust);\n+                sendersAmount = feeExcluded ? amountAsCoin.add(fee) : amountAsCoin.add(dust);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "057e2c5e7cbb7c13cfe3b36df2583338cbf2982c"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU2MTUyMw==", "bodyText": "As an avid log reader, a bit more context will really help understand what's going on here.", "url": "https://github.com/bisq-network/bisq/pull/4093#discussion_r398561523", "createdAt": "2020-03-26T13:15:01Z", "author": {"login": "sqrrm"}, "path": "desktop/src/main/java/bisq/desktop/main/funds/withdrawal/WithdrawalView.java", "diffHunk": "@@ -629,6 +631,17 @@ public void updateItem(final WithdrawalListItem item, boolean empty) {\n                     }\n                 });\n     }\n+\n+    private Coin getDust(Transaction tx) {\n+        Coin dust = Coin.ZERO;\n+        for (TransactionOutput txo: tx.getOutputs()) {\n+            if (txo.getValue().value < 546) {\n+                dust = dust.add(txo.getValue());\n+                log.info(\"dust TXO = {}\", txo.getValue().toFriendlyString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "057e2c5e7cbb7c13cfe3b36df2583338cbf2982c"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "378c57492b5653bb0ce576d3fa3329718fd094c8", "author": {"user": {"login": "jmacxx", "name": null}}, "url": "https://github.com/bisq-network/bisq/commit/378c57492b5653bb0ce576d3fa3329718fd094c8", "committedDate": "2020-03-29T02:22:40Z", "message": "Address issues raised in review by sqrrm on 2020-03-26\n\n- added a comment describing the `removeDust` method and its effects.\n- use more descriptive variable names.\n- made the logging more verbose to help log readers.\n- use a constant for the dust limit\n- add a notice to the user when dust is padded to the fee"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea8b327f7be087299420db2011ddc5ee4cc9d1fc", "author": {"user": {"login": "jmacxx", "name": null}}, "url": "https://github.com/bisq-network/bisq/commit/ea8b327f7be087299420db2011ddc5ee4cc9d1fc", "committedDate": "2020-03-29T23:23:48Z", "message": "Change the constant used to determine what amount is considered dust\n\nNow using `Restrictions.getMinNonDustOutput()` which equates to 546 sats"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1de0799013ada943cb2f498d3d402977d25b4a7", "author": {"user": {"login": "jmacxx", "name": null}}, "url": "https://github.com/bisq-network/bisq/commit/f1de0799013ada943cb2f498d3d402977d25b4a7", "committedDate": "2020-03-31T02:09:19Z", "message": "Change wording of the dust informative message per review by m52go\n\nMoved message text into displaystrings.properties"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3Mjc4ODU3", "url": "https://github.com/bisq-network/bisq/pull/4093#pullrequestreview-387278857", "createdAt": "2020-04-03T13:55:58Z", "commit": {"oid": "f1de0799013ada943cb2f498d3d402977d25b4a7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3366, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}