{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwMzcwMjA4", "number": 4710, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxOTo0Mzo1MVrOEy-SHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxOTo0ODoxOFrOEy-YMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxODg0NzAzOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/bisq/core/btc/wallet/BtcWalletService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxOTo0Mzo1MVrOHp6qBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxOTo0Mzo1MVrOHp6qBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzcxNDY5NQ==", "bodyText": "I assume the motivation for treating the connectedOutput == null as legacyInput is that if we dont know the inputs we use the potentially higher fee estimation. If correct, maybe a comment could help to make it more clear.", "url": "https://github.com/bisq-network/bisq/pull/4710#discussion_r513714695", "createdAt": "2020-10-28T19:43:51Z", "author": {"login": "chimp1984"}, "path": "core/src/main/java/bisq/core/btc/wallet/BtcWalletService.java", "diffHunk": "@@ -548,6 +577,23 @@ public Transaction completePreparedBsqTx(Transaction preparedBsqTx,\n         return resultTx;\n     }\n \n+    private Tuple2<Integer, Integer> getNumInputs(Transaction tx) {\n+        int numLegacyInputs = 0;\n+        int numSegwitInputs = 0;\n+        for (TransactionInput input : tx.getInputs()) {\n+            TransactionOutput connectedOutput = input.getConnectedOutput();\n+            if (connectedOutput == null || ScriptPattern.isP2PKH(connectedOutput.getScriptPubKey()) ||", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e823db2c86d8e24474dfbf1d28290d1ed4fcb12b"}, "originalPosition": 142}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxODg1Mzk5OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/bisq/core/btc/TxFeeEstimationService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxOTo0NTo0N1rOHp6uRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMToyMDozMFrOHp960w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzcxNTc4MA==", "bodyText": "PAYOUT_TX_SIZE is not used anymore and can be deleted.", "url": "https://github.com/bisq-network/bisq/pull/4710#discussion_r513715780", "createdAt": "2020-10-28T19:45:47Z", "author": {"login": "chimp1984"}, "path": "core/src/main/java/bisq/core/btc/TxFeeEstimationService.java", "diffHunk": "@@ -41,9 +41,24 @@\n  */\n @Slf4j\n public class TxFeeEstimationService {\n-    public static int TYPICAL_TX_WITH_1_INPUT_SIZE = 260;\n-    private static int DEPOSIT_TX_SIZE = 320;\n-    private static int PAYOUT_TX_SIZE = 380;\n+\n+//  Size/vsize of typical trade txs\n+//  Real txs size/vsize may vary in 1 or 2 bytes from the estimated values.\n+//  Values calculated with https://gist.github.com/oscarguindzberg/3d1349cb65d9fd9af9de0feaa3fd27ac\n+//  legacy fee tx with 1 input, maker/taker fee paid in btc size/vsize = 258\n+//  legacy deposit tx without change size/vsize = 381\n+//  legacy deposit tx with change size/vsize = 414\n+//  legacy payout tx size/vsize = 337\n+//  legacy delayed payout tx size/vsize = 302\n+//  segwit fee tx with 1 input, maker/taker fee paid in btc vsize = 173\n+//  segwit deposit tx without change vsize = 232\n+//  segwit deposit tx with change vsize = 263\n+//  segwit payout tx vsize = 169\n+//  segwit delayed payout tx vsize = 139\n+    public static int TYPICAL_TX_WITH_1_INPUT_SIZE = 175;\n+    private static int DEPOSIT_TX_SIZE = 233;\n+    private static int PAYOUT_TX_SIZE = 169;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "511137f0b9b3facefe34733b7b3c59f8e38ae9f3"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc2ODE0Nw==", "bodyText": "Done", "url": "https://github.com/bisq-network/bisq/pull/4710#discussion_r513768147", "createdAt": "2020-10-28T21:20:30Z", "author": {"login": "oscarguindzberg"}, "path": "core/src/main/java/bisq/core/btc/TxFeeEstimationService.java", "diffHunk": "@@ -41,9 +41,24 @@\n  */\n @Slf4j\n public class TxFeeEstimationService {\n-    public static int TYPICAL_TX_WITH_1_INPUT_SIZE = 260;\n-    private static int DEPOSIT_TX_SIZE = 320;\n-    private static int PAYOUT_TX_SIZE = 380;\n+\n+//  Size/vsize of typical trade txs\n+//  Real txs size/vsize may vary in 1 or 2 bytes from the estimated values.\n+//  Values calculated with https://gist.github.com/oscarguindzberg/3d1349cb65d9fd9af9de0feaa3fd27ac\n+//  legacy fee tx with 1 input, maker/taker fee paid in btc size/vsize = 258\n+//  legacy deposit tx without change size/vsize = 381\n+//  legacy deposit tx with change size/vsize = 414\n+//  legacy payout tx size/vsize = 337\n+//  legacy delayed payout tx size/vsize = 302\n+//  segwit fee tx with 1 input, maker/taker fee paid in btc vsize = 173\n+//  segwit deposit tx without change vsize = 232\n+//  segwit deposit tx with change vsize = 263\n+//  segwit payout tx vsize = 169\n+//  segwit delayed payout tx vsize = 139\n+    public static int TYPICAL_TX_WITH_1_INPUT_SIZE = 175;\n+    private static int DEPOSIT_TX_SIZE = 233;\n+    private static int PAYOUT_TX_SIZE = 169;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzcxNTc4MA=="}, "originalCommit": {"oid": "511137f0b9b3facefe34733b7b3c59f8e38ae9f3"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxODg2MjU3OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/bisq/core/btc/TxFeeEstimationService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxOTo0ODoxOFrOHp6zmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMToyMDo0MFrOHp97Hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzcxNzE0Nw==", "bodyText": "Maybe change comment to: \"if we cannot do the estimation we use the largest of our txs which is the deposit tx", "url": "https://github.com/bisq-network/bisq/pull/4710#discussion_r513717147", "createdAt": "2020-10-28T19:48:18Z", "author": {"login": "chimp1984"}, "path": "core/src/main/java/bisq/core/btc/TxFeeEstimationService.java", "diffHunk": "@@ -87,14 +102,14 @@ public TxFeeEstimationService(FeeService feeService,\n                                                            BtcWalletService btcWalletService,\n                                                            Preferences preferences) {\n         Coin txFeePerByte = feeService.getTxFeePerByte();\n-        // We start with min taker fee size of 260\n+        // We start with min taker fee size of 175\n         int estimatedTxSize = TYPICAL_TX_WITH_1_INPUT_SIZE;\n         try {\n             estimatedTxSize = getEstimatedTxSize(List.of(tradeFee, amount), estimatedTxSize, txFeePerByte, btcWalletService);\n         } catch (InsufficientMoneyException e) {\n             if (isTaker) {\n-                // if we cannot do the estimation we use the payout tx size\n-                estimatedTxSize = PAYOUT_TX_SIZE;\n+                // if we cannot do the estimation we use the deposit tx size", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "511137f0b9b3facefe34733b7b3c59f8e38ae9f3"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc2ODIyMg==", "bodyText": "Done", "url": "https://github.com/bisq-network/bisq/pull/4710#discussion_r513768222", "createdAt": "2020-10-28T21:20:40Z", "author": {"login": "oscarguindzberg"}, "path": "core/src/main/java/bisq/core/btc/TxFeeEstimationService.java", "diffHunk": "@@ -87,14 +102,14 @@ public TxFeeEstimationService(FeeService feeService,\n                                                            BtcWalletService btcWalletService,\n                                                            Preferences preferences) {\n         Coin txFeePerByte = feeService.getTxFeePerByte();\n-        // We start with min taker fee size of 260\n+        // We start with min taker fee size of 175\n         int estimatedTxSize = TYPICAL_TX_WITH_1_INPUT_SIZE;\n         try {\n             estimatedTxSize = getEstimatedTxSize(List.of(tradeFee, amount), estimatedTxSize, txFeePerByte, btcWalletService);\n         } catch (InsufficientMoneyException e) {\n             if (isTaker) {\n-                // if we cannot do the estimation we use the payout tx size\n-                estimatedTxSize = PAYOUT_TX_SIZE;\n+                // if we cannot do the estimation we use the deposit tx size", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzcxNzE0Nw=="}, "originalCommit": {"oid": "511137f0b9b3facefe34733b7b3c59f8e38ae9f3"}, "originalPosition": 41}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2676, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}