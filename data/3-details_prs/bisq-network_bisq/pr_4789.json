{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwNDQyMzA2", "number": 4789, "title": "Fix remaining blackmail vulnerabilities", "bodyText": "This PR attempts to take advantage of the SegWit trade protocol upgrade (hard fork), to fix all the remaining cases where a buyer or seller can publish a deposit tx without their peer having a valid delayed payout tx (at least in the fully SegWit case, when taking an offer created in v1.5.0+). When taking pre-1.5.0 offers, the deposit tx inputs will be of mixed type, which makes it malleable and thus impossible to completely prevent either trader from altering its ID and thus rendering their peer's delayed payout tx invalid. In that case, the buyer should still fully validate their delayed payout tx anyway, against the agreed deposit tx, so that if the latter changes before confirming, the trade hopefully fails before the buyer makes payment. The PR additionally fixes a bug where (it appears) the buyer fails to check the signature of the final delayed payout tx.\nThese changes are intended to prevent blackmail attacks (or reduce the risk of them in not-fully-SegWit cases where the deposit tx is malleable).", "createdAt": "2020-11-13T08:48:38Z", "url": "https://github.com/bisq-network/bisq/pull/4789", "merged": true, "mergeCommit": {"oid": "741425fad8513ea6587e919e954664b2eefbe5cd"}, "closed": true, "closedAt": "2020-11-19T18:01:07Z", "author": {"login": "stejbac"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdcN9evAFqTUzMDQyMDY5MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeGoE1AFqTUzNDcwODg3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNDIwNjkw", "url": "https://github.com/bisq-network/bisq/pull/4789#pullrequestreview-530420690", "createdAt": "2020-11-13T21:16:16Z", "commit": {"oid": "5762701f99b3f5f499aa04f5a7945a237062977e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToxNjoxN1rOHy_0cA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToxNjoxN1rOHy_0cA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzNjQ2NA==", "bodyText": "The Transaction.bitcoinSerializeToStream method does use that flag not only for adding segwit data but also for writing a flag:\n // marker, flag\n        if (useSegwit) {\n            stream.write(0);\n            stream.write(1);\n        }\n\nI don't know which function this flag has, but maybe its more safe to remove the segwit data in a different way. Maybe @oscarguindzberg can add his input here...", "url": "https://github.com/bisq-network/bisq/pull/4789#discussion_r523236464", "createdAt": "2020-11-13T21:16:17Z", "author": {"login": "chimp1984"}, "path": "core/src/main/java/bisq/core/trade/protocol/tasks/buyer_as_maker/BuyerAsMakerSendsInputsForDepositTxResponse.java", "diffHunk": "@@ -32,6 +34,9 @@ public BuyerAsMakerSendsInputsForDepositTxResponse(TaskRunner<Trade> taskHandler\n \n     @Override\n     protected byte[] getPreparedDepositTx() {\n-        return processModel.getPreparedDepositTx();\n+        Transaction preparedDepositTx = processModel.getBtcWalletService().getTxFromSerializedTx(processModel.getPreparedDepositTx());\n+        // Remove witnesses from preparedDepositTx, so that the seller can still compute the final\n+        // tx id, but cannot publish it before providing the buyer with a signed delayed payout tx.\n+        return preparedDepositTx.bitcoinSerialize(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5762701f99b3f5f499aa04f5a7945a237062977e"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNjAzNzM2", "url": "https://github.com/bisq-network/bisq/pull/4789#pullrequestreview-530603736", "createdAt": "2020-11-14T20:47:27Z", "commit": {"oid": "06578cbc653fc1a7ed3cd55a324a10c40506dd17"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNjEzODg0", "url": "https://github.com/bisq-network/bisq/pull/4789#pullrequestreview-530613884", "createdAt": "2020-11-14T23:11:15Z", "commit": {"oid": "593f51ac5f678669bc5685e680c1223eb3c182c5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79fa21953348f2ec8dbc9318a193c05c6d583e53", "author": {"user": {"login": "stejbac", "name": "Steven Barclay"}}, "url": "https://github.com/bisq-network/bisq/commit/79fa21953348f2ec8dbc9318a193c05c6d583e53", "committedDate": "2020-11-19T17:19:07Z", "message": "Fix missing segwit case when sanitising preparedDepositTx\n\nMake sure witness data is stripped from the seller's prepared deposit\ntx, in addition to ScriptSig data, to prevent the buyer from being able\nto publish it prematurely (before having signed the delayed payout tx)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f02d5ee2167ad1d6743996acfef846b4b2f87562", "author": {"user": {"login": "stejbac", "name": "Steven Barclay"}}, "url": "https://github.com/bisq-network/bisq/commit/f02d5ee2167ad1d6743996acfef846b4b2f87562", "committedDate": "2020-11-19T17:19:12Z", "message": "Send seller's delayedPayoutTx signature to peer ASAP\n\nInclude a new 'delayedPayoutTxSellerSignature' field with the prepared\ndelayed payout tx sent to the buyer, in DelayedPayoutTxSignatureRequest.\nThis will allow the buyer to compute the final, signed delayedPayoutTx\nas early as possible and withhold their deposit tx witness from the\nseller until they know they have a valid delayedPayoutTx, preventing its\npremature publishing in the fully segwit case. (To be done in a later\ncommit - for now just save the seller's delayedPayoutTx signature.)\n\nAs part of this, run the SellerSignsDelayedPayoutTx trade task at an\nearlier step (just after payout tx creation) to make its signature\navailable to the seller ASAP. Also rename 'delayedPayoutTxSignature' to\n'delayedPayoutTxBuyerSignature' in DelayedPayoutTxSignatureResponse."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "803035bdbbb4976521b1f23829371731a59d60d4", "author": {"user": {"login": "stejbac", "name": "Steven Barclay"}}, "url": "https://github.com/bisq-network/bisq/commit/803035bdbbb4976521b1f23829371731a59d60d4", "committedDate": "2020-11-19T17:19:13Z", "message": "Add new BuyerFinalizesDelayedPayoutTx task\n\nImprove validation of the buyer's delayed payout tx (both before & after\nthey get the final DepositTxAndDelayedPayoutTxMessage from the peer), by\nfinalising it independently of the seller. This is now possible since\ntheir 2-of-2 signature is included in the DelayedPayoutSignatureRequest.\nCheck that the final delayedPayoutTx received from the seller matches it\nbyte-for-byte (which actually makes its receipt redundant now).\n\nThis also fixes an apparent security bug, where the final validation of\nthe delayedPayoutTx appears to skip any kind of signature check (only a\ndeposit tx hash check, which is still necessary).\n\nFinally, optimistically check the deposit tx against the input of the\nprepared delayedPayoutTx received from the seller, in the case that the\nformer is non-malleable (that is, the fully segwit case) and thus has a\nstable ID given by the hash of the buyer's preparedDepositTx."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a3b0726920e072692cab30aca42b1b09573968b", "author": {"user": {"login": "stejbac", "name": "Steven Barclay"}}, "url": "https://github.com/bisq-network/bisq/commit/5a3b0726920e072692cab30aca42b1b09573968b", "committedDate": "2020-11-19T17:19:13Z", "message": "Withhold witnesses in buyer->seller depositTx data, until last step\n\nStrip all input witnesses from the depositTx message fields sent from\nthe buyer, until the last (DelayedPayoutTxSignatureResponse) message is\nsent, where they can be bundled in as an extra field. Since the witness\ndata doesn't affect the final deposit tx id, the seller does not need to\nknow it until actually publishing the tx.\n\nIn the (fully) segwit case, this allows the buyer to prevent the seller\nfrom publishing the deposit tx until the buyer has a valid, fully signed\ndelayedPayoutTx. Provide the final witness data in an extra 'depositTx'\nfield in DelayedPayoutTxSignatureResponse, which the seller can merge\nwith his depositTx witness block (for his own input signatures)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69d1e16f5e59441dfc34a66969a1ec7d35330331", "author": {"user": {"login": "stejbac", "name": "Steven Barclay"}}, "url": "https://github.com/bisq-network/bisq/commit/69d1e16f5e59441dfc34a66969a1ec7d35330331", "committedDate": "2020-11-19T17:19:14Z", "message": "Prevent takers from using non-segwit deposit tx inputs\n\nDisallow non-P2WH depositTx inputs from the taker, while continuing to\nallow them from the maker, so that offers created pre-v1.5.0 can still\nbe taken. (After some time, those inputs could be disallowed too.)\n\nThis is mainly to prevent mass blackmail attacks, where more victims'\nmoney could be locked up than the DAO could possibly compensate them all\nfor. (This is probably only an attractive attack for a buyer anyway, at\nleast with the earlier commits.)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3574204e7d2959c1c071102f41695b4ec44a4c37", "author": {"user": {"login": "stejbac", "name": "Steven Barclay"}}, "url": "https://github.com/bisq-network/bisq/commit/3574204e7d2959c1c071102f41695b4ec44a4c37", "committedDate": "2020-11-19T17:19:14Z", "message": "Fix faulty signature check in finalizeDelayedPayoutTx\n\nMake sure to use the segwit version of Script.correctlySpends in\nTradeWalletService.finalizeDelayedPayoutTx, which requires the input\nvalue and witness to be passed explicitly (as the latter holds the\nactual signature). This was causing BuyerFinalizesDelayedPayoutTx to\nfail to do any kind of signature check.\n\nAlso refactor the method slightly and remove a redundant call to\nWalletService.checkScriptSig (which does the same thing as\nTransactionInput.verify) in the branch used by the seller."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd798952e8655ce07fcd07e80c2cf7fbb03dee45", "author": {"user": {"login": "stejbac", "name": "Steven Barclay"}}, "url": "https://github.com/bisq-network/bisq/commit/fd798952e8655ce07fcd07e80c2cf7fbb03dee45", "committedDate": "2020-11-18T11:17:11Z", "message": "Fix failing OpenOfferManagerTest & PeerManagerTest\n\nThese are failing on the tip of release/1.5.0 currently due to extra\nvalidation added to PersistenceManager, causing the build to fail upon\nmerging upstream. Add missing PersistenceManager.shutDown calls to the\ntearDown methods of the affected tests to fix."}, "afterCommit": {"oid": "3574204e7d2959c1c071102f41695b4ec44a4c37", "author": {"user": {"login": "stejbac", "name": "Steven Barclay"}}, "url": "https://github.com/bisq-network/bisq/commit/3574204e7d2959c1c071102f41695b4ec44a4c37", "committedDate": "2020-11-19T17:19:14Z", "message": "Fix faulty signature check in finalizeDelayedPayoutTx\n\nMake sure to use the segwit version of Script.correctlySpends in\nTradeWalletService.finalizeDelayedPayoutTx, which requires the input\nvalue and witness to be passed explicitly (as the latter holds the\nactual signature). This was causing BuyerFinalizesDelayedPayoutTx to\nfail to do any kind of signature check.\n\nAlso refactor the method slightly and remove a redundant call to\nWalletService.checkScriptSig (which does the same thing as\nTransactionInput.verify) in the branch used by the seller."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "345426fb50b7e80042ab6df2b8cd994ea9530658", "author": {"user": {"login": "stejbac", "name": "Steven Barclay"}}, "url": "https://github.com/bisq-network/bisq/commit/345426fb50b7e80042ab6df2b8cd994ea9530658", "committedDate": "2020-11-19T17:30:16Z", "message": "Add further validation checks for delayed payout tx\n\nDo some extra sanity checks like tx.outputSum < tx.inputSum, to rule out\nany edge cases where an invalid delayed payout tx might still arise."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0NzA4ODcw", "url": "https://github.com/bisq-network/bisq/pull/4789#pullrequestreview-534708870", "createdAt": "2020-11-19T17:58:10Z", "commit": {"oid": "345426fb50b7e80042ab6df2b8cd994ea9530658"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3531, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}