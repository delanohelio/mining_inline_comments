{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwMzcwMjA4", "number": 4710, "title": "Segwit fee estimation", "bodyText": "Users reduce btc miner fees for segwit txs.\nPre-segwit miners used to evaluate tx fee and tx size. Txs were selected by their fee/byte.\nSegwit brought the concept of \"virtual size\".\nvirtual size of a tx = tx serialized without witness data size + witness size (i.e. pub keys and signatures) / 4.\nThe virtual size of a legacy tx is the same as its size.\nSegwit txs have similar sizes compared to legacy txs, but their virtual size is smaller.\nNew terms are now used such as vsize, vbyte, fee/vbyte, etc.\nMiners now compare txs by its fee/vbyte (This is not entirely true, since they use tx weight, but we can do our math using fee/vbyte which is roughly equivalent)\nSee https://github.com/bitcoin/bips/blob/master/bip-0141.mediawiki#additional-definitions for more info.\nThis PR does not include renaming size to vsize, feePerByte to feePerVbyte, etc.\nI expect this PR won't be merged to master for quite some time.\nThe renames will introduce hundreds of changes all over the code, leading to merging hell.\nI plan to do the renames either when merging date is closer or as an independent PR.\nI suggest to use this link oscarguindzberg/bisq@segwit...oscarguindzberg:fee-estimation to understand the content of this PR until #4612 is merged. Otherwise you will find here the content for both PRs making understanding this PR more difficult", "createdAt": "2020-10-26T23:40:49Z", "url": "https://github.com/bisq-network/bisq/pull/4710", "merged": true, "mergeCommit": {"oid": "93806e9c2f2decca8332e2f0368c8595b5332a24"}, "closed": true, "closedAt": "2020-11-05T20:18:55Z", "author": {"login": "oscarguindzberg"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXDEhigFqTUxOTAyNDUyMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZnDMuAFqTUyNDU2ODc2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5MDI0NTIz", "url": "https://github.com/bisq-network/bisq/pull/4710#pullrequestreview-519024523", "createdAt": "2020-10-28T19:43:50Z", "commit": {"oid": "e823db2c86d8e24474dfbf1d28290d1ed4fcb12b"}, "state": "DISMISSED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxOTo0Mzo1MVrOHp6qBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxOTo0ODoxOFrOHp6zmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzcxNDY5NQ==", "bodyText": "I assume the motivation for treating the connectedOutput == null as legacyInput is that if we dont know the inputs we use the potentially higher fee estimation. If correct, maybe a comment could help to make it more clear.", "url": "https://github.com/bisq-network/bisq/pull/4710#discussion_r513714695", "createdAt": "2020-10-28T19:43:51Z", "author": {"login": "chimp1984"}, "path": "core/src/main/java/bisq/core/btc/wallet/BtcWalletService.java", "diffHunk": "@@ -548,6 +577,23 @@ public Transaction completePreparedBsqTx(Transaction preparedBsqTx,\n         return resultTx;\n     }\n \n+    private Tuple2<Integer, Integer> getNumInputs(Transaction tx) {\n+        int numLegacyInputs = 0;\n+        int numSegwitInputs = 0;\n+        for (TransactionInput input : tx.getInputs()) {\n+            TransactionOutput connectedOutput = input.getConnectedOutput();\n+            if (connectedOutput == null || ScriptPattern.isP2PKH(connectedOutput.getScriptPubKey()) ||", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e823db2c86d8e24474dfbf1d28290d1ed4fcb12b"}, "originalPosition": 142}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzcxNTc4MA==", "bodyText": "PAYOUT_TX_SIZE is not used anymore and can be deleted.", "url": "https://github.com/bisq-network/bisq/pull/4710#discussion_r513715780", "createdAt": "2020-10-28T19:45:47Z", "author": {"login": "chimp1984"}, "path": "core/src/main/java/bisq/core/btc/TxFeeEstimationService.java", "diffHunk": "@@ -41,9 +41,24 @@\n  */\n @Slf4j\n public class TxFeeEstimationService {\n-    public static int TYPICAL_TX_WITH_1_INPUT_SIZE = 260;\n-    private static int DEPOSIT_TX_SIZE = 320;\n-    private static int PAYOUT_TX_SIZE = 380;\n+\n+//  Size/vsize of typical trade txs\n+//  Real txs size/vsize may vary in 1 or 2 bytes from the estimated values.\n+//  Values calculated with https://gist.github.com/oscarguindzberg/3d1349cb65d9fd9af9de0feaa3fd27ac\n+//  legacy fee tx with 1 input, maker/taker fee paid in btc size/vsize = 258\n+//  legacy deposit tx without change size/vsize = 381\n+//  legacy deposit tx with change size/vsize = 414\n+//  legacy payout tx size/vsize = 337\n+//  legacy delayed payout tx size/vsize = 302\n+//  segwit fee tx with 1 input, maker/taker fee paid in btc vsize = 173\n+//  segwit deposit tx without change vsize = 232\n+//  segwit deposit tx with change vsize = 263\n+//  segwit payout tx vsize = 169\n+//  segwit delayed payout tx vsize = 139\n+    public static int TYPICAL_TX_WITH_1_INPUT_SIZE = 175;\n+    private static int DEPOSIT_TX_SIZE = 233;\n+    private static int PAYOUT_TX_SIZE = 169;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "511137f0b9b3facefe34733b7b3c59f8e38ae9f3"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzcxNzE0Nw==", "bodyText": "Maybe change comment to: \"if we cannot do the estimation we use the largest of our txs which is the deposit tx", "url": "https://github.com/bisq-network/bisq/pull/4710#discussion_r513717147", "createdAt": "2020-10-28T19:48:18Z", "author": {"login": "chimp1984"}, "path": "core/src/main/java/bisq/core/btc/TxFeeEstimationService.java", "diffHunk": "@@ -87,14 +102,14 @@ public TxFeeEstimationService(FeeService feeService,\n                                                            BtcWalletService btcWalletService,\n                                                            Preferences preferences) {\n         Coin txFeePerByte = feeService.getTxFeePerByte();\n-        // We start with min taker fee size of 260\n+        // We start with min taker fee size of 175\n         int estimatedTxSize = TYPICAL_TX_WITH_1_INPUT_SIZE;\n         try {\n             estimatedTxSize = getEstimatedTxSize(List.of(tradeFee, amount), estimatedTxSize, txFeePerByte, btcWalletService);\n         } catch (InsufficientMoneyException e) {\n             if (isTaker) {\n-                // if we cannot do the estimation we use the payout tx size\n-                estimatedTxSize = PAYOUT_TX_SIZE;\n+                // if we cannot do the estimation we use the deposit tx size", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "511137f0b9b3facefe34733b7b3c59f8e38ae9f3"}, "originalPosition": 41}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e823db2c86d8e24474dfbf1d28290d1ed4fcb12b", "author": {"user": {"login": "oscarguindzberg", "name": "Oscar Guindzberg"}}, "url": "https://github.com/bisq-network/bisq/commit/e823db2c86d8e24474dfbf1d28290d1ed4fcb12b", "committedDate": "2020-10-26T23:26:49Z", "message": "Split segwit from legacy inputs\n\nGoal: Have a more accurate fee calculation"}, "afterCommit": {"oid": "46f0a9e45e58e141135bdeabd9522401005bc3a2", "author": {"user": {"login": "oscarguindzberg", "name": "Oscar Guindzberg"}}, "url": "https://github.com/bisq-network/bisq/commit/46f0a9e45e58e141135bdeabd9522401005bc3a2", "committedDate": "2020-10-28T21:17:18Z", "message": "Fix comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef97daac8998da2ae72ef6a6ac209c33a4c2223a", "author": {"user": {"login": "oscarguindzberg", "name": "Oscar Guindzberg"}}, "url": "https://github.com/bisq-network/bisq/commit/ef97daac8998da2ae72ef6a6ac209c33a4c2223a", "committedDate": "2020-11-05T14:47:38Z", "message": "Use bitcoinj 0.15.8 (commit fcec3da)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "161e220a4f5464f263639e93fdbb89f468f0106f", "author": {"user": {"login": "oscarguindzberg", "name": "Oscar Guindzberg"}}, "url": "https://github.com/bisq-network/bisq/commit/161e220a4f5464f263639e93fdbb89f468f0106f", "committedDate": "2020-11-05T14:47:40Z", "message": "BtcWalletService: Use segwit addresses"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06e5091f79024e5739e8b496f2aad79cf5795483", "author": {"user": {"login": "oscarguindzberg", "name": "Oscar Guindzberg"}}, "url": "https://github.com/bisq-network/bisq/commit/06e5091f79024e5739e8b496f2aad79cf5795483", "committedDate": "2020-11-05T14:47:40Z", "message": "TradeWalletService use P2WSH"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a05b6d6d5ef1175f4a3918ed500b580c186ef9e", "author": {"user": {"login": "oscarguindzberg", "name": "Oscar Guindzberg"}}, "url": "https://github.com/bisq-network/bisq/commit/4a05b6d6d5ef1175f4a3918ed500b580c186ef9e", "committedDate": "2020-11-05T14:47:40Z", "message": "Revert \"Construct dummy outputs with LegacyAddress\"\n\nThis reverts commit b8f5c6e970fc29b705478aac8a655a73bed52a7e."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22ba9a898b5ad4db64f4cc1f3089347afbb5a6c0", "author": {"user": {"login": "oscarguindzberg", "name": "Oscar Guindzberg"}}, "url": "https://github.com/bisq-network/bisq/commit/22ba9a898b5ad4db64f4cc1f3089347afbb5a6c0", "committedDate": "2020-11-05T14:47:41Z", "message": "Explain why bitcoinSerialize(false) is used"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3585dc95fcda1ef27ade1bd832ee35b7ab0b222c", "author": {"user": {"login": "oscarguindzberg", "name": "Oscar Guindzberg"}}, "url": "https://github.com/bisq-network/bisq/commit/3585dc95fcda1ef27ade1bd832ee35b7ab0b222c", "committedDate": "2020-11-05T14:47:41Z", "message": "Create the scriptCode the right way"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "953a5f0bb547c8c390af49c6c8dd74a55aa62bd6", "author": {"user": {"login": "oscarguindzberg", "name": "Oscar Guindzberg"}}, "url": "https://github.com/bisq-network/bisq/commit/953a5f0bb547c8c390af49c6c8dd74a55aa62bd6", "committedDate": "2020-11-05T14:47:41Z", "message": "Deal with P2WPKH has empty scriptSig"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1620c4fd76f7024d40a503c2b1eabea8a786134", "author": {"user": {"login": "oscarguindzberg", "name": "Oscar Guindzberg"}}, "url": "https://github.com/bisq-network/bisq/commit/d1620c4fd76f7024d40a503c2b1eabea8a786134", "committedDate": "2020-11-05T14:47:41Z", "message": "Revert \"Validate AddressEntry.segwit\"\n\nThis reverts commit e49c56527825a443b794ab74cee24b12d5b9eb45."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3d7c71410f0ad0f6aa7476e6d2deba9c29dda5b", "author": {"user": {"login": "oscarguindzberg", "name": "Oscar Guindzberg"}}, "url": "https://github.com/bisq-network/bisq/commit/a3d7c71410f0ad0f6aa7476e6d2deba9c29dda5b", "committedDate": "2020-11-05T14:47:41Z", "message": "Set TRADE_PROTOCOL_VERSION to 3"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dffa251e1dc160b7b1bfe334b759d2b08de2c3d9", "author": {"user": {"login": "oscarguindzberg", "name": "Oscar Guindzberg"}}, "url": "https://github.com/bisq-network/bisq/commit/dffa251e1dc160b7b1bfe334b759d2b08de2c3d9", "committedDate": "2020-11-05T14:47:41Z", "message": "Remove unused imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bba6a526f0404701cce7c33a1a75961e64df2f1", "author": {"user": {"login": "oscarguindzberg", "name": "Oscar Guindzberg"}}, "url": "https://github.com/bisq-network/bisq/commit/6bba6a526f0404701cce7c33a1a75961e64df2f1", "committedDate": "2020-11-05T14:51:43Z", "message": "Use bitcoinj 0.15.8 (commit 60b4f2f)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2023e236692e6ad77afd6f9379de4e275393928", "author": {"user": {"login": "oscarguindzberg", "name": "Oscar Guindzberg"}}, "url": "https://github.com/bisq-network/bisq/commit/b2023e236692e6ad77afd6f9379de4e275393928", "committedDate": "2020-11-05T14:51:43Z", "message": "Use tx.getVsize()\n\nReplace tx.bitcoinSerialize().length"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a58bfbafa19fd155ae95ba5daf12fb4fe58ce12", "author": {"user": {"login": "oscarguindzberg", "name": "Oscar Guindzberg"}}, "url": "https://github.com/bisq-network/bisq/commit/7a58bfbafa19fd155ae95ba5daf12fb4fe58ce12", "committedDate": "2020-11-05T14:51:43Z", "message": "Use SegwitAddress for fee estimation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29f23fe50c6727f8784f3af7c8de3d988ba517ac", "author": {"user": {"login": "oscarguindzberg", "name": "Oscar Guindzberg"}}, "url": "https://github.com/bisq-network/bisq/commit/29f23fe50c6727f8784f3af7c8de3d988ba517ac", "committedDate": "2020-11-05T14:51:43Z", "message": "Use segwit tx sizes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "327a3584463d0cb4dbe4b529441f7f893c543687", "author": {"user": {"login": "oscarguindzberg", "name": "Oscar Guindzberg"}}, "url": "https://github.com/bisq-network/bisq/commit/327a3584463d0cb4dbe4b529441f7f893c543687", "committedDate": "2020-11-05T14:51:43Z", "message": "Split segwit from legacy inputs\n\nGoal: Have a more accurate fee calculation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f0009e1a4ef1100ed35f0311e530b4c21416d40", "author": {"user": {"login": "oscarguindzberg", "name": "Oscar Guindzberg"}}, "url": "https://github.com/bisq-network/bisq/commit/5f0009e1a4ef1100ed35f0311e530b4c21416d40", "committedDate": "2020-11-05T14:51:43Z", "message": "Explain why legacy is used by default"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d59d5e8725cc3241e8370b3f755e7df05c4f1ec", "author": {"user": {"login": "oscarguindzberg", "name": "Oscar Guindzberg"}}, "url": "https://github.com/bisq-network/bisq/commit/0d59d5e8725cc3241e8370b3f755e7df05c4f1ec", "committedDate": "2020-11-05T14:51:44Z", "message": "Remove unused PAYOUT_TX_SIZE"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7740e3e56d397e94434460ad36eec6f482c1d3e8", "author": {"user": {"login": "oscarguindzberg", "name": "Oscar Guindzberg"}}, "url": "https://github.com/bisq-network/bisq/commit/7740e3e56d397e94434460ad36eec6f482c1d3e8", "committedDate": "2020-11-05T14:51:44Z", "message": "Fix comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "46f0a9e45e58e141135bdeabd9522401005bc3a2", "author": {"user": {"login": "oscarguindzberg", "name": "Oscar Guindzberg"}}, "url": "https://github.com/bisq-network/bisq/commit/46f0a9e45e58e141135bdeabd9522401005bc3a2", "committedDate": "2020-10-28T21:17:18Z", "message": "Fix comment"}, "afterCommit": {"oid": "7740e3e56d397e94434460ad36eec6f482c1d3e8", "author": {"user": {"login": "oscarguindzberg", "name": "Oscar Guindzberg"}}, "url": "https://github.com/bisq-network/bisq/commit/7740e3e56d397e94434460ad36eec6f482c1d3e8", "committedDate": "2020-11-05T14:51:44Z", "message": "Fix comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NTY4NzYx", "url": "https://github.com/bisq-network/bisq/pull/4710#pullrequestreview-524568761", "createdAt": "2020-11-05T18:55:08Z", "commit": {"oid": "7740e3e56d397e94434460ad36eec6f482c1d3e8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3490, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}