{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3MjAzNzI1", "number": 4592, "title": "Improve bisq setup", "bodyText": "Provides a new AppStartupState class for listening for combined startup states.\nExtract domain startup code to a new class to avoid that BisqSetup gets overloaded.\nWe often need to wait until network and wallet is ready or other combination of startup states.\nTo avoid those repeated checks for the state or setting of listeners on different domains we provide here a\ncollection of useful states.\nI did not use listeners as we want to query the state as well, so we needed fields keeping the state. Using a BooleanProperty provides both a field for keeping the state as well as a convenient way to add a listener.\nE.g.:\nappStartupState.walletAndNetworkReadyProperty().addListener((observable, oldValue, newValue) -> {\n            if (newValue) {\n                ....\n            }\n        });", "createdAt": "2020-10-03T02:58:47Z", "url": "https://github.com/bisq-network/bisq/pull/4592", "merged": true, "mergeCommit": {"oid": "723a1f5cf99b63d11b7d6be2d194ff2b35cff864"}, "closed": true, "closedAt": "2020-10-07T12:08:11Z", "author": {"login": "chimp1984"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPW297gH2gAyNDk3MjAzNzI1OmQ2YzNjY2Q2MDVjNWI0MDg2NTYzY2E4NmFiNDRlNzgyNGM5ZmZjMWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQL0pYgFqTUwMzgwNjgyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d6c3ccd605c5b4086563ca86ab44e7824c9ffc1c", "author": {"user": {"login": "chimp1984", "name": null}}, "url": "https://github.com/bisq-network/bisq/commit/d6c3ccd605c5b4086563ca86ab44e7824c9ffc1c", "committedDate": "2020-10-04T22:24:03Z", "message": "Add AppStartupState and DomainInitialisation.accountAgeWitnessService\nSee comments to classes for reasoning."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52f5f2f064c1f18e2e6b2e924c84f3bf0103ead9", "author": {"user": {"login": "chimp1984", "name": null}}, "url": "https://github.com/bisq-network/bisq/commit/52f5f2f064c1f18e2e6b2e924c84f3bf0103ead9", "committedDate": "2020-10-04T22:24:03Z", "message": "Extract domain initialisation to domainInitialisation class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "474c4138d2d9e3f05d522a7dffdf100b216d043a", "author": {"user": {"login": "chimp1984", "name": null}}, "url": "https://github.com/bisq-network/bisq/commit/474c4138d2d9e3f05d522a7dffdf100b216d043a", "committedDate": "2020-10-04T22:24:03Z", "message": "Refactor: rearrange methods"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c161cdc3ccde7b37d94c4583dc537c6b397508e1", "author": {"user": {"login": "chimp1984", "name": null}}, "url": "https://github.com/bisq-network/bisq/commit/c161cdc3ccde7b37d94c4583dc537c6b397508e1", "committedDate": "2020-10-03T02:56:12Z", "message": "Refactor: rearrange methods"}, "afterCommit": {"oid": "474c4138d2d9e3f05d522a7dffdf100b216d043a", "author": {"user": {"login": "chimp1984", "name": null}}, "url": "https://github.com/bisq-network/bisq/commit/474c4138d2d9e3f05d522a7dffdf100b216d043a", "committedDate": "2020-10-04T22:24:03Z", "message": "Refactor: rearrange methods"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMDE4MTY2", "url": "https://github.com/bisq-network/bisq/pull/4592#pullrequestreview-502018166", "createdAt": "2020-10-05T12:46:56Z", "commit": {"oid": "c161cdc3ccde7b37d94c4583dc537c6b397508e1"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMjo0NzoxOFrOHcba1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNDo0NTozMlrOHcgcjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU3MTQxMw==", "bodyText": "Why is this check excluding allDomainServicesInitialized? I couldn't figure the use for this walletAndNetworkReady and it seems to be not used. Is there a plan for future usage or could it be removed?", "url": "https://github.com/bisq-network/bisq/pull/4592#discussion_r499571413", "createdAt": "2020-10-05T12:47:18Z", "author": {"login": "sqrrm"}, "path": "core/src/main/java/bisq/core/app/AppStartupState.java", "diffHunk": "@@ -0,0 +1,149 @@\n+/*\n+ * This file is part of Bisq.\n+ *\n+ * Bisq is free software: you can redistribute it and/or modify it\n+ * under the terms of the GNU Affero General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or (at\n+ * your option) any later version.\n+ *\n+ * Bisq is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public\n+ * License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with Bisq. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package bisq.core.app;\n+\n+import bisq.core.btc.setup.WalletsSetup;\n+\n+import bisq.network.p2p.BootstrapListener;\n+import bisq.network.p2p.P2PService;\n+\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+import org.fxmisc.easybind.EasyBind;\n+import org.fxmisc.easybind.monadic.MonadicBinding;\n+\n+import javafx.beans.property.BooleanProperty;\n+import javafx.beans.property.ReadOnlyBooleanProperty;\n+import javafx.beans.property.SimpleBooleanProperty;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+/**\n+ * We often need to wait until network and wallet is ready or other combination of startup states.\n+ * To avoid those repeated checks for the state or setting of listeners on different domains we provide here a\n+ * collection of useful states.\n+ */\n+@Slf4j\n+@Singleton\n+public class AppStartupState {\n+    // Do not convert to local field as there have been issues observed that the object got GC'ed.\n+    private final MonadicBinding<Boolean> p2pNetworkAndWalletInitialized;\n+\n+    private final BooleanProperty walletAndNetworkReady = new SimpleBooleanProperty();\n+    private final BooleanProperty allDomainServicesInitialized = new SimpleBooleanProperty();\n+    private final BooleanProperty applicationFullyInitialized = new SimpleBooleanProperty();\n+    private final BooleanProperty updatedDataReceived = new SimpleBooleanProperty();\n+    private final BooleanProperty isBlockDownloadComplete = new SimpleBooleanProperty();\n+    private final BooleanProperty hasSufficientPeersForBroadcast = new SimpleBooleanProperty();\n+\n+    @Inject\n+    public AppStartupState(WalletsSetup walletsSetup, P2PService p2PService) {\n+\n+        p2PService.addP2PServiceListener(new BootstrapListener() {\n+            @Override\n+            public void onUpdatedDataReceived() {\n+                updatedDataReceived.set(true);\n+            }\n+        });\n+\n+        walletsSetup.downloadPercentageProperty().addListener((observable, oldValue, newValue) -> {\n+            if (walletsSetup.isDownloadComplete())\n+                isBlockDownloadComplete.set(true);\n+        });\n+\n+        walletsSetup.numPeersProperty().addListener((observable, oldValue, newValue) -> {\n+            if (walletsSetup.hasSufficientPeersForBroadcast())\n+                hasSufficientPeersForBroadcast.set(true);\n+        });\n+\n+        p2pNetworkAndWalletInitialized = EasyBind.combine(updatedDataReceived,\n+                isBlockDownloadComplete,\n+                hasSufficientPeersForBroadcast,\n+                allDomainServicesInitialized,\n+                (a, b, c, d) -> {\n+                    if (a && b && c) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "474c4138d2d9e3f05d522a7dffdf100b216d043a"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY1Mzc3NQ==", "bodyText": "These look unused. Am I missing something,", "url": "https://github.com/bisq-network/bisq/pull/4592#discussion_r499653775", "createdAt": "2020-10-05T14:45:32Z", "author": {"login": "sqrrm"}, "path": "core/src/main/java/bisq/core/app/AppStartupState.java", "diffHunk": "@@ -0,0 +1,149 @@\n+/*\n+ * This file is part of Bisq.\n+ *\n+ * Bisq is free software: you can redistribute it and/or modify it\n+ * under the terms of the GNU Affero General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or (at\n+ * your option) any later version.\n+ *\n+ * Bisq is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public\n+ * License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with Bisq. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package bisq.core.app;\n+\n+import bisq.core.btc.setup.WalletsSetup;\n+\n+import bisq.network.p2p.BootstrapListener;\n+import bisq.network.p2p.P2PService;\n+\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+import org.fxmisc.easybind.EasyBind;\n+import org.fxmisc.easybind.monadic.MonadicBinding;\n+\n+import javafx.beans.property.BooleanProperty;\n+import javafx.beans.property.ReadOnlyBooleanProperty;\n+import javafx.beans.property.SimpleBooleanProperty;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+/**\n+ * We often need to wait until network and wallet is ready or other combination of startup states.\n+ * To avoid those repeated checks for the state or setting of listeners on different domains we provide here a\n+ * collection of useful states.\n+ */\n+@Slf4j\n+@Singleton\n+public class AppStartupState {\n+    // Do not convert to local field as there have been issues observed that the object got GC'ed.\n+    private final MonadicBinding<Boolean> p2pNetworkAndWalletInitialized;\n+\n+    private final BooleanProperty walletAndNetworkReady = new SimpleBooleanProperty();\n+    private final BooleanProperty allDomainServicesInitialized = new SimpleBooleanProperty();\n+    private final BooleanProperty applicationFullyInitialized = new SimpleBooleanProperty();\n+    private final BooleanProperty updatedDataReceived = new SimpleBooleanProperty();\n+    private final BooleanProperty isBlockDownloadComplete = new SimpleBooleanProperty();\n+    private final BooleanProperty hasSufficientPeersForBroadcast = new SimpleBooleanProperty();\n+\n+    @Inject\n+    public AppStartupState(WalletsSetup walletsSetup, P2PService p2PService) {\n+\n+        p2PService.addP2PServiceListener(new BootstrapListener() {\n+            @Override\n+            public void onUpdatedDataReceived() {\n+                updatedDataReceived.set(true);\n+            }\n+        });\n+\n+        walletsSetup.downloadPercentageProperty().addListener((observable, oldValue, newValue) -> {\n+            if (walletsSetup.isDownloadComplete())\n+                isBlockDownloadComplete.set(true);\n+        });\n+\n+        walletsSetup.numPeersProperty().addListener((observable, oldValue, newValue) -> {\n+            if (walletsSetup.hasSufficientPeersForBroadcast())\n+                hasSufficientPeersForBroadcast.set(true);\n+        });\n+\n+        p2pNetworkAndWalletInitialized = EasyBind.combine(updatedDataReceived,\n+                isBlockDownloadComplete,\n+                hasSufficientPeersForBroadcast,\n+                allDomainServicesInitialized,\n+                (a, b, c, d) -> {\n+                    if (a && b && c) {\n+                        walletAndNetworkReady.set(true);\n+                    }\n+                    return a && b && c && d;\n+                });\n+        p2pNetworkAndWalletInitialized.subscribe((observable, oldValue, newValue) -> {\n+            if (newValue) {\n+                applicationFullyInitialized.set(true);\n+            }\n+        });\n+    }\n+\n+    public void onDomainServicesInitialized() {\n+        allDomainServicesInitialized.set(true);\n+    }\n+\n+\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+    // Getters\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+\n+    public boolean isWalletAndNetworkReady() {\n+        return walletAndNetworkReady.get();\n+    }\n+\n+    public ReadOnlyBooleanProperty walletAndNetworkReadyProperty() {\n+        return walletAndNetworkReady;\n+    }\n+\n+    public boolean isAllDomainServicesInitialized() {\n+        return allDomainServicesInitialized.get();\n+    }\n+\n+    public ReadOnlyBooleanProperty allDomainServicesInitializedProperty() {\n+        return allDomainServicesInitialized;\n+    }\n+\n+    public boolean isApplicationFullyInitialized() {\n+        return applicationFullyInitialized.get();\n+    }\n+\n+    public ReadOnlyBooleanProperty applicationFullyInitializedProperty() {\n+        return applicationFullyInitialized;\n+    }\n+\n+    public boolean isUpdatedDataReceived() {\n+        return updatedDataReceived.get();\n+    }\n+\n+    public ReadOnlyBooleanProperty updatedDataReceivedProperty() {\n+        return updatedDataReceived;\n+    }\n+\n+    public boolean isIsBlockDownloadComplete() {\n+        return isBlockDownloadComplete.get();\n+    }\n+\n+    public ReadOnlyBooleanProperty isBlockDownloadCompleteProperty() {\n+        return isBlockDownloadComplete;\n+    }\n+\n+    public boolean isHasSufficientPeersForBroadcast() {\n+        return hasSufficientPeersForBroadcast.get();\n+    }\n+\n+    public ReadOnlyBooleanProperty hasSufficientPeersForBroadcastProperty() {\n+        return hasSufficientPeersForBroadcast;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "474c4138d2d9e3f05d522a7dffdf100b216d043a"}, "originalPosition": 147}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzODA2ODIy", "url": "https://github.com/bisq-network/bisq/pull/4592#pullrequestreview-503806822", "createdAt": "2020-10-07T12:06:29Z", "commit": {"oid": "474c4138d2d9e3f05d522a7dffdf100b216d043a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3096, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}