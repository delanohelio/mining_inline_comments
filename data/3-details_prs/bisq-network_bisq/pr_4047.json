{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2NjcxODc1", "number": 4047, "title": "Added graceful shutdown hook", "bodyText": "Fixes #3884, fixes #2465\nGraceful shutdown has only been done in case of an error or when\nusing the GUI. A regular eg. seednode shutdown is not covered\nthough.\nNow, a kill -TERM ... or a kill -INT or [Ctrl+C] triggers a graceful shutdown procedure.\nTested on a Bisq app and seednode service launch by firing up and then\n\nkill -TERM javapid\nkill -INT javapid\nrun from terminal followed by hitting [Ctrl+C]", "createdAt": "2020-03-11T12:53:20Z", "url": "https://github.com/bisq-network/bisq/pull/4047", "merged": true, "mergeCommit": {"oid": "9891e58f2c98c1968ffc1dc4f6b5c61fbcf57736"}, "closed": true, "closedAt": "2020-03-31T13:20:59Z", "author": {"login": "freimair"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMojBpAFqTM3Mjg0ODUzNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTDAAfAFqTM4NDcyNDIwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyODQ4NTM2", "url": "https://github.com/bisq-network/bisq/pull/4047#pullrequestreview-372848536", "createdAt": "2020-03-11T15:07:37Z", "commit": {"oid": "6d1f266debe7c07636e816ba206f2d7aeb6105de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNTowNzozN1rOF07OAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNTowNzozN1rOF07OAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTA0MDUxNQ==", "bodyText": "Is there a reason why you labeled it Monitor Shutdown Hook ?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            }, \"Monitor Shutdown Hook \")\n          \n          \n            \n                            }, \"BisqExecutable Shutdown Hook\")", "url": "https://github.com/bisq-network/bisq/pull/4047#discussion_r391040515", "createdAt": "2020-03-11T15:07:37Z", "author": {"login": "ripcurlx"}, "path": "core/src/main/java/bisq/core/app/BisqExecutable.java", "diffHunk": "@@ -100,6 +101,12 @@ protected void doExecute() {\n         CoreSetup.setup(config);\n         addCapabilities();\n \n+        // exit gracefully on shutdown\n+        Runtime.getRuntime().addShutdownHook(new Thread(() -> {\n+                    gracefulShutDown(() -> log.info(\"gracefulShutDown complete\"));\n+                }, \"Monitor Shutdown Hook \")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d1f266debe7c07636e816ba206f2d7aeb6105de"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MTAxNTU5", "url": "https://github.com/bisq-network/bisq/pull/4047#pullrequestreview-377101559", "createdAt": "2020-03-18T17:49:36Z", "commit": {"oid": "e241eb0231e57f32b57277119b651b46d9b60297"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NTcxMjg1", "url": "https://github.com/bisq-network/bisq/pull/4047#pullrequestreview-378571285", "createdAt": "2020-03-20T15:14:37Z", "commit": {"oid": "e241eb0231e57f32b57277119b651b46d9b60297"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bf1ae43777d44c82566693aea7c49d7f7f0ae96", "author": {"user": {"login": "freimair", "name": "Florian Reimair"}}, "url": "https://github.com/bisq-network/bisq/commit/1bf1ae43777d44c82566693aea7c49d7f7f0ae96", "committedDate": "2020-03-26T16:09:29Z", "message": "Added graceful shutdown hook\n\nGraceful shutdown has only be done in case of an error or when\nusing the GUI. A regular eg. seednode shutdown is not covered\nthough.\n\nNow, SIGTERM and SIGINT triggers a graceful shutdown procedure."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53752f852226fd485541d22ec40627bb5a96baf0", "author": {"user": {"login": "freimair", "name": "Florian Reimair"}}, "url": "https://github.com/bisq-network/bisq/commit/53752f852226fd485541d22ec40627bb5a96baf0", "committedDate": "2020-03-26T16:27:12Z", "message": "Fix shutdown order"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c20c4b63ac56e1f6b1ff4071f2129d4554a8ceb2", "author": {"user": {"login": "freimair", "name": "Florian Reimair"}}, "url": "https://github.com/bisq-network/bisq/commit/c20c4b63ac56e1f6b1ff4071f2129d4554a8ceb2", "committedDate": "2020-03-26T16:27:41Z", "message": "Wait for connections to be closed\n\nThe close connection process did fire up worker threads to actually\nclose the connections. Yet, once all threads have been spawned,\nthe code proceeds assuming that there are no connections left open\nwithout checking.\nThis lead to situations where tor has been shutdown already but\nopen connections. These connections tried to gracefully close but\nwithout tor, that only caused a wall of exceptions."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e1868d775e022154cf9d5eb30a30068dcb5ea386", "author": {"user": {"login": "freimair", "name": "Florian Reimair"}}, "url": "https://github.com/bisq-network/bisq/commit/e1868d775e022154cf9d5eb30a30068dcb5ea386", "committedDate": "2020-03-24T18:57:44Z", "message": "Fix shutdown order"}, "afterCommit": {"oid": "2e7483dff63d77ecc1f8bcf6afc1143db0a7a285", "author": {"user": {"login": "freimair", "name": "Florian Reimair"}}, "url": "https://github.com/bisq-network/bisq/commit/2e7483dff63d77ecc1f8bcf6afc1143db0a7a285", "committedDate": "2020-03-26T16:27:42Z", "message": "Only send message bundle if not stopped"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNzA2NDc4", "url": "https://github.com/bisq-network/bisq/pull/4047#pullrequestreview-382706478", "createdAt": "2020-03-27T09:42:14Z", "commit": {"oid": "f0678fc9c62c4f0abdf544da019c0a09422c5b92"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwOTo0MjoxNVrOF8pujg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwOTo0MjoxNVrOF8pujg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE0MjU0Mg==", "bodyText": "Is there a specific reason why you used 10 milliseconds before triggering the complete handler?", "url": "https://github.com/bisq-network/bisq/pull/4047#discussion_r399142542", "createdAt": "2020-03-27T09:42:15Z", "author": {"login": "ripcurlx"}, "path": "core/src/main/java/bisq/core/offer/OpenOfferManager.java", "diffHunk": "@@ -221,8 +224,25 @@ public void shutDown(@Nullable Runnable completeHandler) {\n         log.info(\"Remove open offers at shutDown. Number of open offers: {}\", size);\n         if (offerBookService.isBootstrapped() && size > 0) {\n             openOffers.forEach(openOffer -> offerBookService.removeOfferAtShutDown(openOffer.getOffer().getOfferPayload()));\n+\n+            // wait for offers to be removed, offerBookService::removeOfferAtShutdown may create threads to remove offers...\n+            LocalTime timeout = LocalTime.now().plus(Duration.ofSeconds(15));\n+            while (!openOffers.getList().isEmpty()) {\n+                // check timeout\n+                if (timeout.isBefore(LocalTime.now())) {\n+                    log.error(\"Could not remove all offers within timeout (\" + openOffers.size() + \" offers remaining). Moving on.\");\n+                    break;\n+                }\n+                try {\n+                    // reduce system load\n+                    Thread.sleep(10);\n+                } catch (InterruptedException e) {\n+                    // ignore\n+                }\n+            }\n+\n             if (completeHandler != null)\n-                UserThread.runAfter(completeHandler, size * 200 + 500, TimeUnit.MILLISECONDS);\n+                UserThread.runAfter(completeHandler, 10, TimeUnit.MILLISECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0678fc9c62c4f0abdf544da019c0a09422c5b92"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNzA3MzE5", "url": "https://github.com/bisq-network/bisq/pull/4047#pullrequestreview-382707319", "createdAt": "2020-03-27T09:43:27Z", "commit": {"oid": "1e4af51a1bd1514aeb5b6af3fe51f2c883f21e56"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwOTo0MzoyN1rOF8pxHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwOTo0MzoyN1rOF8pxHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE0MzE5OQ==", "bodyText": "NIT: I think we decided at some point not to use conditionals within one line anymore", "url": "https://github.com/bisq-network/bisq/pull/4047#discussion_r399143199", "createdAt": "2020-03-27T09:43:27Z", "author": {"login": "ripcurlx"}, "path": "p2p/src/main/java/bisq/network/p2p/network/TorNetworkNode.java", "diffHunk": "@@ -187,6 +187,7 @@ private BooleanProperty torNetworkNodeShutDown() {\n                 long ts = System.currentTimeMillis();\n                 log.debug(\"Shutdown torNetworkNode\");\n                 try {\n+                    if (tor == null) tor = Tor.getDefault();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e4af51a1bd1514aeb5b6af3fe51f2c883f21e56"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNzEyMjEw", "url": "https://github.com/bisq-network/bisq/pull/4047#pullrequestreview-382712210", "createdAt": "2020-03-27T09:50:28Z", "commit": {"oid": "546719deadc658775761a98f50fac75647d27aa4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwOTo1MDoyOVrOF8qBNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwOTo1MDoyOVrOF8qBNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE0NzMxNg==", "bodyText": "Is there a specific reason why we don't want to have this in our logs anymore?", "url": "https://github.com/bisq-network/bisq/pull/4047#discussion_r399147316", "createdAt": "2020-03-27T09:50:29Z", "author": {"login": "ripcurlx"}, "path": "p2p/src/main/java/bisq/network/p2p/network/NetworkNode.java", "diffHunk": "@@ -225,7 +225,7 @@ public void onSuccess(Connection connection) {\n                 }\n \n                 public void onFailure(@NotNull Throwable throwable) {\n-                    log.info(\"onFailure at sendMessage: peersNodeAddress={}\\n\\tmessage={}\\n\\tthrowable={}\", peersNodeAddress, networkEnvelope.getClass().getSimpleName(), throwable.toString());\n+                    log.debug(\"onFailure at sendMessage: peersNodeAddress={}\\n\\tmessage={}\\n\\tthrowable={}\", peersNodeAddress, networkEnvelope.getClass().getSimpleName(), throwable.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "546719deadc658775761a98f50fac75647d27aa4"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bab25ac177b7b56863e2eecb4f4a83b02955e42", "author": {"user": {"login": "freimair", "name": "Florian Reimair"}}, "url": "https://github.com/bisq-network/bisq/commit/8bab25ac177b7b56863e2eecb4f4a83b02955e42", "committedDate": "2020-03-28T10:27:25Z", "message": "Make sure to shut down tor\n\nHere, the tor object is a member variable and there are cases where\nthis member variable is not set yet.\nSituation arose where a sigterm/sigint shutdown is requested and due\nto the member variable not set tor was left running."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bbb8e69523eac6fe77906d45683ccc1b6ac8b1d", "author": {"user": {"login": "freimair", "name": "Florian Reimair"}}, "url": "https://github.com/bisq-network/bisq/commit/0bbb8e69523eac6fe77906d45683ccc1b6ac8b1d", "committedDate": "2020-03-28T10:27:36Z", "message": "Harmonize System::exit usage\n\nThe actual System::exit commands have been scattered around various\nplaces in the code. Sometimes, actual system exit depended on the\ncalling code to reach its end of execution."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fb4f13319351bdf81de0619d22b414e4fef5b24", "author": {"user": {"login": "freimair", "name": "Florian Reimair"}}, "url": "https://github.com/bisq-network/bisq/commit/0fb4f13319351bdf81de0619d22b414e4fef5b24", "committedDate": "2020-03-28T10:27:37Z", "message": "Fix closing the app by gui exit\n\nBefore, the graceful shutdown procedures have been executed in the\nuser thread. However, the sync mechanics for connections/offers\ncaused a lockup, as some little parts of the code do execute on the\nuser thread as well."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c588b19074856d4b29f9b9e48a82c07103912349", "author": {"user": {"login": "freimair", "name": "Florian Reimair"}}, "url": "https://github.com/bisq-network/bisq/commit/c588b19074856d4b29f9b9e48a82c07103912349", "committedDate": "2020-03-28T10:27:37Z", "message": "Log output shows graceful shutdown message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ff4801e5c296109917448eabec03b8e3cfb0ef8", "author": {"user": {"login": "freimair", "name": "Florian Reimair"}}, "url": "https://github.com/bisq-network/bisq/commit/4ff4801e5c296109917448eabec03b8e3cfb0ef8", "committedDate": "2020-03-28T10:27:37Z", "message": "Cleanup logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50ba2cd74050a36d33115fc540a09d1ccd985592", "author": {"user": {"login": "freimair", "name": "Florian Reimair"}}, "url": "https://github.com/bisq-network/bisq/commit/50ba2cd74050a36d33115fc540a09d1ccd985592", "committedDate": "2020-03-28T10:27:37Z", "message": "Only send message bundle if not stopped"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2e7483dff63d77ecc1f8bcf6afc1143db0a7a285", "author": {"user": {"login": "freimair", "name": "Florian Reimair"}}, "url": "https://github.com/bisq-network/bisq/commit/2e7483dff63d77ecc1f8bcf6afc1143db0a7a285", "committedDate": "2020-03-26T16:27:42Z", "message": "Only send message bundle if not stopped"}, "afterCommit": {"oid": "50ba2cd74050a36d33115fc540a09d1ccd985592", "author": {"user": {"login": "freimair", "name": "Florian Reimair"}}, "url": "https://github.com/bisq-network/bisq/commit/50ba2cd74050a36d33115fc540a09d1ccd985592", "committedDate": "2020-03-28T10:27:37Z", "message": "Only send message bundle if not stopped"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NzI0MjAz", "url": "https://github.com/bisq-network/bisq/pull/4047#pullrequestreview-384724203", "createdAt": "2020-03-31T13:20:22Z", "commit": {"oid": "50ba2cd74050a36d33115fc540a09d1ccd985592"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3347, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}