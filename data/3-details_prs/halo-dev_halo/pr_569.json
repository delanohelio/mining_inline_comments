{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1MjY4NDEz", "number": 569, "title": "feat: add basic functions of demo mode", "bodyText": "", "createdAt": "2020-02-14T08:27:27Z", "url": "https://github.com/halo-dev/halo/pull/569", "merged": true, "mergeCommit": {"oid": "b78e2161e5b21061ce209ccca98d740123c43714"}, "closed": true, "closedAt": "2020-02-14T14:08:38Z", "author": {"login": "guqing"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcELND2AH2gAyMzc1MjY4NDEzOjc5MzNiYzE3MjA1OGFlZTUzYWRhNjFmMjNiNWU4YTkzZGE4NDhlMTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcEQHHdAFqTM1ODk2MzQxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7933bc172058aee53ada61f23b5e8a93da848e13", "author": {"user": {"login": "guqing", "name": "guqing"}}, "url": "https://github.com/halo-dev/halo/commit/7933bc172058aee53ada61f23b5e8a93da848e13", "committedDate": "2020-02-14T08:25:00Z", "message": "feat: add basic functions of demo mode"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4Nzc3Nzg1", "url": "https://github.com/halo-dev/halo/pull/569#pullrequestreview-358777785", "createdAt": "2020-02-14T08:30:44Z", "commit": {"oid": "7933bc172058aee53ada61f23b5e8a93da848e13"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwODozMDo0NFrOFpu0yA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwODozMjo1MFrOFpu31Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwMzExMg==", "bodyText": "\u53ef\u4ee5\u5220\u6389\u4e86", "url": "https://github.com/halo-dev/halo/pull/569#discussion_r379303112", "createdAt": "2020-02-14T08:30:44Z", "author": {"login": "ruibaby"}, "path": "src/main/java/run/halo/app/handler/aspect/DisableApiAspect.java", "diffHunk": "@@ -0,0 +1,49 @@\n+package run.halo.app.handler.aspect;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.aspectj.lang.ProceedingJoinPoint;\n+import org.aspectj.lang.annotation.Around;\n+import org.aspectj.lang.annotation.Aspect;\n+import org.aspectj.lang.annotation.Pointcut;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.ApplicationContext;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.stereotype.Component;\n+import run.halo.app.Application;\n+import run.halo.app.model.annotation.DisableApi;\n+import run.halo.app.model.enums.Mode;\n+import run.halo.app.model.support.BaseResponse;\n+\n+/**\n+ * \u81ea\u5b9a\u4e49\u6ce8\u89e3DisableApi\u7684\u5207\u9762\n+ * @author guqing\n+ * @date 2020-02-14 14:08\n+ */\n+@Aspect\n+@Component\n+public class DisableApiAspect {\n+    @Value(\"${spring.profiles.active:prod}\")\n+    private String activeProfile;\n+\n+    @Pointcut(\"@annotation(run.halo.app.model.annotation.DisableApi)\")\n+    public void pointcut(){}\n+\n+    @Around(\"pointcut() && @annotation(disableApi)\")\n+    public Object around(ProceedingJoinPoint joinPoint,\n+                         DisableApi disableApi){\n+        Mode mode = disableApi.mode();\n+        System.out.println(activeProfile);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7933bc172058aee53ada61f23b5e8a93da848e13"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwMzYwOA==", "bodyText": "\u4e0d\u6b62\u5bc6\u7801\uff0c\u8fd8\u6709\u4fee\u6539\u7cfb\u7edf\u8bbe\u7f6e", "url": "https://github.com/halo-dev/halo/pull/569#discussion_r379303608", "createdAt": "2020-02-14T08:32:02Z", "author": {"login": "ruibaby"}, "path": "src/main/java/run/halo/app/controller/admin/api/UserController.java", "diffHunk": "@@ -49,6 +50,7 @@ public UserDTO updateProfile(@RequestBody UserParam userParam, User user) {\n     }\n \n     @PutMapping(\"profiles/password\")\n+    @DisableApi", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7933bc172058aee53ada61f23b5e8a93da848e13"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwMzg5Mw==", "bodyText": "\u8fd8\u6709\u5f00\u53d1\u8005\u9009\u9879\u91cc\u9762\u7684\u4e00\u4e9b API", "url": "https://github.com/halo-dev/halo/pull/569#discussion_r379303893", "createdAt": "2020-02-14T08:32:50Z", "author": {"login": "ruibaby"}, "path": "src/main/java/run/halo/app/controller/admin/api/UserController.java", "diffHunk": "@@ -49,6 +50,7 @@ public UserDTO updateProfile(@RequestBody UserParam userParam, User user) {\n     }\n \n     @PutMapping(\"profiles/password\")\n+    @DisableApi", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwMzYwOA=="}, "originalCommit": {"oid": "7933bc172058aee53ada61f23b5e8a93da848e13"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4Nzg0Mjgx", "url": "https://github.com/halo-dev/halo/pull/569#pullrequestreview-358784281", "createdAt": "2020-02-14T08:44:05Z", "commit": {"oid": "7933bc172058aee53ada61f23b5e8a93da848e13"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwODo0NDowNVrOFpvIoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwODo0NDowNVrOFpvIoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMwODE5Mg==", "bodyText": "\u8fd9\u91cc\u53ef\u4ee5\u76f4\u63a5\u629b\u51fa ForbiddenException", "url": "https://github.com/halo-dev/halo/pull/569#discussion_r379308192", "createdAt": "2020-02-14T08:44:05Z", "author": {"login": "ruibaby"}, "path": "src/main/java/run/halo/app/handler/aspect/DisableApiAspect.java", "diffHunk": "@@ -0,0 +1,49 @@\n+package run.halo.app.handler.aspect;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.aspectj.lang.ProceedingJoinPoint;\n+import org.aspectj.lang.annotation.Around;\n+import org.aspectj.lang.annotation.Aspect;\n+import org.aspectj.lang.annotation.Pointcut;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.ApplicationContext;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.stereotype.Component;\n+import run.halo.app.Application;\n+import run.halo.app.model.annotation.DisableApi;\n+import run.halo.app.model.enums.Mode;\n+import run.halo.app.model.support.BaseResponse;\n+\n+/**\n+ * \u81ea\u5b9a\u4e49\u6ce8\u89e3DisableApi\u7684\u5207\u9762\n+ * @author guqing\n+ * @date 2020-02-14 14:08\n+ */\n+@Aspect\n+@Component\n+public class DisableApiAspect {\n+    @Value(\"${spring.profiles.active:prod}\")\n+    private String activeProfile;\n+\n+    @Pointcut(\"@annotation(run.halo.app.model.annotation.DisableApi)\")\n+    public void pointcut(){}\n+\n+    @Around(\"pointcut() && @annotation(disableApi)\")\n+    public Object around(ProceedingJoinPoint joinPoint,\n+                         DisableApi disableApi){\n+        Mode mode = disableApi.mode();\n+        System.out.println(activeProfile);\n+        System.out.println(mode.name());\n+        if(StringUtils.equalsIgnoreCase(mode.name(), activeProfile)) {\n+            return new BaseResponse<>(HttpStatus.FORBIDDEN.value(), \"\u7981\u6b62\u8bbf\u95ee\",null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7933bc172058aee53ada61f23b5e8a93da848e13"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5143ed9d1736dc40b9edd6e935b09a3a7ff0bfdf", "author": {"user": {"login": "guqing", "name": "guqing"}}, "url": "https://github.com/halo-dev/halo/commit/5143ed9d1736dc40b9edd6e935b09a3a7ff0bfdf", "committedDate": "2020-02-14T08:57:03Z", "message": "feat: add @disableApi annotation to some API that should be disabled"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NzkyNzc2", "url": "https://github.com/halo-dev/halo/pull/569#pullrequestreview-358792776", "createdAt": "2020-02-14T09:00:03Z", "commit": {"oid": "7933bc172058aee53ada61f23b5e8a93da848e13"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwOTowMDowM1rOFpvjHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwOTowMzowNFrOFpvoyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMxNDk3NQ==", "bodyText": "\u5efa\u8bae\u7528 log \u8fdb\u884c\u6253\u5370\u65e5\u5fd7\uff0c\u5c3d\u53ef\u80fd\u4e0d\u8981\u4f7f\u7528 System.out\u3002", "url": "https://github.com/halo-dev/halo/pull/569#discussion_r379314975", "createdAt": "2020-02-14T09:00:03Z", "author": {"login": "JohnNiang"}, "path": "src/main/java/run/halo/app/handler/aspect/DisableApiAspect.java", "diffHunk": "@@ -0,0 +1,49 @@\n+package run.halo.app.handler.aspect;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.aspectj.lang.ProceedingJoinPoint;\n+import org.aspectj.lang.annotation.Around;\n+import org.aspectj.lang.annotation.Aspect;\n+import org.aspectj.lang.annotation.Pointcut;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.ApplicationContext;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.stereotype.Component;\n+import run.halo.app.Application;\n+import run.halo.app.model.annotation.DisableApi;\n+import run.halo.app.model.enums.Mode;\n+import run.halo.app.model.support.BaseResponse;\n+\n+/**\n+ * \u81ea\u5b9a\u4e49\u6ce8\u89e3DisableApi\u7684\u5207\u9762\n+ * @author guqing\n+ * @date 2020-02-14 14:08\n+ */\n+@Aspect\n+@Component\n+public class DisableApiAspect {\n+    @Value(\"${spring.profiles.active:prod}\")\n+    private String activeProfile;\n+\n+    @Pointcut(\"@annotation(run.halo.app.model.annotation.DisableApi)\")\n+    public void pointcut(){}\n+\n+    @Around(\"pointcut() && @annotation(disableApi)\")\n+    public Object around(ProceedingJoinPoint joinPoint,\n+                         DisableApi disableApi){\n+        Mode mode = disableApi.mode();\n+        System.out.println(activeProfile);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7933bc172058aee53ada61f23b5e8a93da848e13"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMxNjQyNg==", "bodyText": "\u4e0d\u8981\u76f4\u63a5 printStackTrace()\uff0c\u7528  log.error \u66ff\u4ee3\u3002\u800c\u4e14\uff0c\u5982\u679c\u8fd9\u91cc\u5ffd\u7565\u4e86\u5f02\u5e38\uff0c\u90a3\u4e48\u5728 Filter \u540e\u9762\u5c31\u65e0\u6cd5\u6355\u6349\u5230\u5f02\u5e38\u4e86\uff0c\u5bfc\u81f4 Service\uff0cDao \u4e2d\u629b\u51fa\u7684\u5f02\u5e38\u90fd\u5c06\u5931\u6548\u3002", "url": "https://github.com/halo-dev/halo/pull/569#discussion_r379316426", "createdAt": "2020-02-14T09:03:04Z", "author": {"login": "JohnNiang"}, "path": "src/main/java/run/halo/app/handler/aspect/DisableApiAspect.java", "diffHunk": "@@ -0,0 +1,49 @@\n+package run.halo.app.handler.aspect;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.aspectj.lang.ProceedingJoinPoint;\n+import org.aspectj.lang.annotation.Around;\n+import org.aspectj.lang.annotation.Aspect;\n+import org.aspectj.lang.annotation.Pointcut;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.ApplicationContext;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.stereotype.Component;\n+import run.halo.app.Application;\n+import run.halo.app.model.annotation.DisableApi;\n+import run.halo.app.model.enums.Mode;\n+import run.halo.app.model.support.BaseResponse;\n+\n+/**\n+ * \u81ea\u5b9a\u4e49\u6ce8\u89e3DisableApi\u7684\u5207\u9762\n+ * @author guqing\n+ * @date 2020-02-14 14:08\n+ */\n+@Aspect\n+@Component\n+public class DisableApiAspect {\n+    @Value(\"${spring.profiles.active:prod}\")\n+    private String activeProfile;\n+\n+    @Pointcut(\"@annotation(run.halo.app.model.annotation.DisableApi)\")\n+    public void pointcut(){}\n+\n+    @Around(\"pointcut() && @annotation(disableApi)\")\n+    public Object around(ProceedingJoinPoint joinPoint,\n+                         DisableApi disableApi){\n+        Mode mode = disableApi.mode();\n+        System.out.println(activeProfile);\n+        System.out.println(mode.name());\n+        if(StringUtils.equalsIgnoreCase(mode.name(), activeProfile)) {\n+            return new BaseResponse<>(HttpStatus.FORBIDDEN.value(), \"\u7981\u6b62\u8bbf\u95ee\",null);\n+        }\n+        Object proceed = null;\n+        try {\n+            proceed = joinPoint.proceed();\n+        } catch (Throwable throwable) {\n+            throwable.printStackTrace();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7933bc172058aee53ada61f23b5e8a93da848e13"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1302ec33c251c56de8de5b279725f401e42dbefa", "author": {"user": {"login": "guqing", "name": "guqing"}}, "url": "https://github.com/halo-dev/halo/commit/1302ec33c251c56de8de5b279725f401e42dbefa", "committedDate": "2020-02-14T09:50:33Z", "message": "feat: add DisableApi test case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c93babea0291526c6c8d25184a184f6b8f3c134", "author": {"user": {"login": "guqing", "name": "guqing"}}, "url": "https://github.com/halo-dev/halo/commit/0c93babea0291526c6c8d25184a184f6b8f3c134", "committedDate": "2020-02-14T11:51:50Z", "message": "fix: change DisableApi annotation name to DisableOnConditation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f944330799fa8c82e42a7e52e90274781df6755", "author": {"user": {"login": "JohnNiang", "name": "John Niang"}}, "url": "https://github.com/halo-dev/halo/commit/7f944330799fa8c82e42a7e52e90274781df6755", "committedDate": "2020-02-14T12:58:52Z", "message": "Merge branch 'master' into demo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fd9f39fd02b8dcf03fedfdd6dd7cc6203243fbb", "author": {"user": {"login": "JohnNiang", "name": "John Niang"}}, "url": "https://github.com/halo-dev/halo/commit/8fd9f39fd02b8dcf03fedfdd6dd7cc6203243fbb", "committedDate": "2020-02-14T13:53:17Z", "message": "Fix test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0aa07c4f36681a44d0e4871d85f1a676933b2dea", "author": {"user": {"login": "JohnNiang", "name": "John Niang"}}, "url": "https://github.com/halo-dev/halo/commit/0aa07c4f36681a44d0e4871d85f1a676933b2dea", "committedDate": "2020-02-14T14:00:52Z", "message": "Add more strict test on failing case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbef42a13f36374d2faff59d865b42f36a3e5c45", "author": {"user": {"login": "guqing", "name": "guqing"}}, "url": "https://github.com/halo-dev/halo/commit/fbef42a13f36374d2faff59d865b42f36a3e5c45", "committedDate": "2020-02-14T14:03:14Z", "message": "Merge pull request #2 from JohnNiang/fix/disable-api-test-case\n\nFix test cases"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4OTYzNDEy", "url": "https://github.com/halo-dev/halo/pull/569#pullrequestreview-358963412", "createdAt": "2020-02-14T14:08:02Z", "commit": {"oid": "fbef42a13f36374d2faff59d865b42f36a3e5c45"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4223, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}