{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3NDg0MDM3", "number": 745, "title": "Support MFA-TOTP Auth", "bodyText": "\u767b\u9646\u65f6\u652f\u6301\u5f00\u542fMFA-TOTP\u9a8c\u8bc1\u65b9\u5f0f #712\n\u767b\u9646\u63a5\u53e3\u6709\u53d8\u5316 halo-admin \u4e5f\u5df2\u7ecf\u652f\u6301\nhalo-dev/halo-admin#124", "createdAt": "2020-04-02T10:16:59Z", "url": "https://github.com/halo-dev/halo/pull/745", "merged": true, "mergeCommit": {"oid": "3a45b7a5ed101c76e13907b0017c7c48613f22a4"}, "closed": true, "closedAt": "2020-04-04T11:41:23Z", "author": {"login": "xun404"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRvQQEgH2gAyMzk3NDg0MDM3Ojg0YWI0MTc3MDUyOGI4ZmNlNDk3MjFiZDQ3NGMxMmNhNThlYTBhYTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcUMijPAFqTM4NzY2MDcyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "84ab41770528b8fce49721bd474c12ca58ea0aa6", "author": {"user": {"login": "xun404", "name": "I'm xun."}}, "url": "https://github.com/halo-dev/halo/commit/84ab41770528b8fce49721bd474c12ca58ea0aa6", "committedDate": "2020-03-27T11:46:05Z", "message": "add tfa utils"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abe3b3696be9f24ce839352bf4106e4f4b4eb3dc", "author": {"user": {"login": "xun404", "name": "I'm xun."}}, "url": "https://github.com/halo-dev/halo/commit/abe3b3696be9f24ce839352bf4106e4f4b4eb3dc", "committedDate": "2020-03-30T02:25:43Z", "message": "Merge branch 'master' of github.com:halo-dev/halo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4ba9b120774f289c263079f95f07b6c7ff2f907", "author": {"user": {"login": "xun404", "name": "I'm xun."}}, "url": "https://github.com/halo-dev/halo/commit/f4ba9b120774f289c263079f95f07b6c7ff2f907", "committedDate": "2020-03-30T08:46:50Z", "message": "MFA check api completed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1a24d06b6eb7295749f0af07aa114b7834078cb", "author": {"user": {"login": "xun404", "name": "I'm xun."}}, "url": "https://github.com/halo-dev/halo/commit/a1a24d06b6eb7295749f0af07aa114b7834078cb", "committedDate": "2020-04-01T06:37:19Z", "message": "adminController add loginPreCheck api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3c8802814150449e602593bfe0d6dbe1ecd4a8f", "author": {"user": {"login": "xun404", "name": "I'm xun."}}, "url": "https://github.com/halo-dev/halo/commit/d3c8802814150449e602593bfe0d6dbe1ecd4a8f", "committedDate": "2020-04-02T10:05:06Z", "message": "halo-admin test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d21d8c93a9fde6aaad47e78377787506d9c10778", "author": {"user": {"login": "xun404", "name": "I'm xun."}}, "url": "https://github.com/halo-dev/halo/commit/d21d8c93a9fde6aaad47e78377787506d9c10778", "committedDate": "2020-04-02T10:28:47Z", "message": "checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NDcwNzEy", "url": "https://github.com/halo-dev/halo/pull/745#pullrequestreview-386470712", "createdAt": "2020-04-02T14:16:51Z", "commit": {"oid": "d21d8c93a9fde6aaad47e78377787506d9c10778"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNDoxNjo1MlrOF_tYMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNDoxNzoxOVrOF_tZig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM0ODA4Mw==", "bodyText": "\u8fd9\u4e2a\u63a5\u53e3\u9700\u8981\u5728 https://github.com/halo-dev/halo/blob/master/src/main/java/run/halo/app/security/filter/AdminAuthenticationFilter.java#L59 \u8fd9\u91cc\u5f00\u653e\u3002", "url": "https://github.com/halo-dev/halo/pull/745#discussion_r402348083", "createdAt": "2020-04-02T14:16:52Z", "author": {"login": "ruibaby"}, "path": "src/main/java/run/halo/app/controller/admin/api/AdminController.java", "diffHunk": "@@ -46,11 +49,19 @@ public boolean isInstall() {\n         return optionService.getByPropertyOrDefault(PrimaryProperties.IS_INSTALLED, Boolean.class, false);\n     }\n \n+    @PostMapping(\"login/precheck\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d21d8c93a9fde6aaad47e78377787506d9c10778"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM0ODQyNg==", "bodyText": "\u4e2d\u82f1\u6587\u95f4\u7528\u7a7a\u683c\u9694\u5f00\u3002", "url": "https://github.com/halo-dev/halo/pull/745#discussion_r402348426", "createdAt": "2020-04-02T14:17:19Z", "author": {"login": "ruibaby"}, "path": "src/main/java/run/halo/app/controller/admin/api/UserController.java", "diffHunk": "@@ -57,4 +66,42 @@ public UserDTO updateProfile(@RequestBody UserParam userParam, User user) {\n         userService.updatePassword(passwordParam.getOldPassword(), passwordParam.getNewPassword(), user.getId());\n         return BaseResponse.ok(\"\u5bc6\u7801\u4fee\u6539\u6210\u529f\");\n     }\n+\n+    @PutMapping(\"mfa/generate\")\n+    @ApiOperation(\"Generate Multi-Factor Auth qr image\")\n+    @DisableOnCondition\n+    public MultiFactorAuthVO generateMFAQrImage(@RequestBody MultiFactorAuthParam multiFactorAuthParam, User user) {\n+        if (MFAType.NONE == user.getMfaType()) {\n+            if (MFAType.TFA_TOTP == multiFactorAuthParam.getMfaType()) {\n+                String mfaKey = TwoFactorAuthUtils.generateTFAKey();\n+                String optAuthUrl = TwoFactorAuthUtils.generateOtpAuthUrl(user.getNickname(), mfaKey);\n+                String qrImageBase64 = \"data:image/png;base64,\" +\n+                        Base64.encode(QrCodeUtil.generatePng(optAuthUrl, 128, 128));\n+                return new MultiFactorAuthVO(qrImageBase64, optAuthUrl, mfaKey, MFAType.TFA_TOTP);\n+            } else {\n+                throw new BadRequestException(\"\u6682\u4e0d\u652f\u6301\u7684MFA\u8ba4\u8bc1\u7684\u65b9\u5f0f\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d21d8c93a9fde6aaad47e78377787506d9c10778"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a8a897b75b3050bb0e90c2fb03e96b63b3cc312", "author": {"user": {"login": "xun404", "name": "I'm xun."}}, "url": "https://github.com/halo-dev/halo/commit/0a8a897b75b3050bb0e90c2fb03e96b63b3cc312", "committedDate": "2020-04-03T02:24:27Z", "message": "add unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0029dc46a11163a89a10c6e6dbca3d07a4d5f121", "author": {"user": {"login": "xun404", "name": "I'm xun."}}, "url": "https://github.com/halo-dev/halo/commit/0029dc46a11163a89a10c6e6dbca3d07a4d5f121", "committedDate": "2020-04-03T16:54:25Z", "message": "reset MFA"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NjYwNzIx", "url": "https://github.com/halo-dev/halo/pull/745#pullrequestreview-387660721", "createdAt": "2020-04-04T03:01:10Z", "commit": {"oid": "0029dc46a11163a89a10c6e6dbca3d07a4d5f121"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4171, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}