{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5MjM0ODc3", "number": 465, "title": "feat:(add comment blacklist)", "bodyText": "\u65b0\u589e\u8bc4\u8bba\u9ed1\u540d\u5355\u529f\u80fd\uff0c\u9488\u5bf9\u6076\u610f\u653b\u51fb\u8005\u65b0\u589e\u7684\u529f\u80fd\u3002", "createdAt": "2020-01-04T18:22:17Z", "url": "https://github.com/halo-dev/halo/pull/465", "merged": true, "mergeCommit": {"oid": "11c32ffdca996b19421ce007eac25ee6052a8e15"}, "closed": true, "closedAt": "2020-01-15T14:43:55Z", "author": {"login": "NGLSL"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb3Hj38gH2gAyMzU5MjM0ODc3OjQ0ZTQzYjRhNTkwMjVhNzgyYmRkOWMyMTk2Y2NlZGQ3OTBhZDFjZjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6mmWWgFqTM0MzI2NTg2Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "44e43b4a59025a782bdd9c2196ccedd790ad1cf5", "author": {"user": {"login": "NGLSL", "name": "Leixinxin"}}, "url": "https://github.com/halo-dev/halo/commit/44e43b4a59025a782bdd9c2196ccedd790ad1cf5", "committedDate": "2020-01-04T18:49:17Z", "message": "feat:(add comment blacklist)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c600093323cf65256a95169444e96d690ca00f80", "author": {"user": {"login": "NGLSL", "name": "Leixinxin"}}, "url": "https://github.com/halo-dev/halo/commit/c600093323cf65256a95169444e96d690ca00f80", "committedDate": "2020-01-04T18:53:15Z", "message": "update enum name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "735463dfdcd0a7ce9d262616f91424d5e320a0d1", "author": {"user": {"login": "NGLSL", "name": "Leixinxin"}}, "url": "https://github.com/halo-dev/halo/commit/735463dfdcd0a7ce9d262616f91424d5e320a0d1", "committedDate": "2020-01-04T18:54:59Z", "message": "update enum"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2476dccfa6ee0b6d1508d85dd8535f8e30114902", "author": {"user": {"login": "NGLSL", "name": "Leixinxin"}}, "url": "https://github.com/halo-dev/halo/commit/2476dccfa6ee0b6d1508d85dd8535f8e30114902", "committedDate": "2020-01-04T18:56:26Z", "message": "fix:(update pom)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNTMzNTQz", "url": "https://github.com/halo-dev/halo/pull/465#pullrequestreview-341533543", "createdAt": "2020-01-11T17:47:28Z", "commit": {"oid": "2476dccfa6ee0b6d1508d85dd8535f8e30114902"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMVQxNzo0NzoyOFrOFcmZVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMVQxNzo1NzowMlrOFcmbCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMzUyNw==", "bodyText": "\u8fd9\u91cc\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u7ea6\u5b9a\u7684\u89c4\u5219\u5199\u51fd\u6570\u540d\u79f0\u5373\u53ef\uff0c\u4e0d\u9700\u8981\u5199 JPQL\uff1b", "url": "https://github.com/halo-dev/halo/pull/465#discussion_r365533527", "createdAt": "2020-01-11T17:47:28Z", "author": {"login": "JohnNiang"}, "path": "src/main/java/run/halo/app/repository/CommentBlackListRepository.java", "diffHunk": "@@ -0,0 +1,37 @@\n+package run.halo.app.repository;\n+\n+import org.springframework.data.jpa.repository.Modifying;\n+import org.springframework.data.jpa.repository.Query;\n+import org.springframework.data.repository.query.Param;\n+import org.springframework.transaction.annotation.Transactional;\n+import run.halo.app.model.entity.CommentBlackList;\n+import run.halo.app.repository.base.BaseRepository;\n+\n+/**\n+ * \u8bc4\u8bba\u9ed1\u540d\u5355Repository\n+ *\n+ * @author Lei XinXin\n+ * @date 2020/1/3\n+ */\n+public interface CommentBlackListRepository extends BaseRepository<CommentBlackList, Long> {\n+\n+    /**\n+     * \u6839\u636eIP\u5730\u5740\u83b7\u53d6\u6570\u636e\n+     *\n+     * @param ipAddress\n+     * @return\n+     */\n+    @Query(\"SELECT commentBlackList FROM CommentBlackList commentBlackList WHERE commentBlackList.ipAddress=?1\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2476dccfa6ee0b6d1508d85dd8535f8e30114902"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMzU4Mw==", "bodyText": "\u8fd4\u56de\u503c\u5efa\u8bae\u4f7f\u7528 Optional<> \u5305\u88c5\u3002", "url": "https://github.com/halo-dev/halo/pull/465#discussion_r365533583", "createdAt": "2020-01-11T17:48:34Z", "author": {"login": "JohnNiang"}, "path": "src/main/java/run/halo/app/repository/CommentBlackListRepository.java", "diffHunk": "@@ -0,0 +1,37 @@\n+package run.halo.app.repository;\n+\n+import org.springframework.data.jpa.repository.Modifying;\n+import org.springframework.data.jpa.repository.Query;\n+import org.springframework.data.repository.query.Param;\n+import org.springframework.transaction.annotation.Transactional;\n+import run.halo.app.model.entity.CommentBlackList;\n+import run.halo.app.repository.base.BaseRepository;\n+\n+/**\n+ * \u8bc4\u8bba\u9ed1\u540d\u5355Repository\n+ *\n+ * @author Lei XinXin\n+ * @date 2020/1/3\n+ */\n+public interface CommentBlackListRepository extends BaseRepository<CommentBlackList, Long> {\n+\n+    /**\n+     * \u6839\u636eIP\u5730\u5740\u83b7\u53d6\u6570\u636e\n+     *\n+     * @param ipAddress\n+     * @return\n+     */\n+    @Query(\"SELECT commentBlackList FROM CommentBlackList commentBlackList WHERE commentBlackList.ipAddress=?1\")\n+    CommentBlackList getByIpAddress(String ipAddress);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2476dccfa6ee0b6d1508d85dd8535f8e30114902"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMzYyOQ==", "bodyText": "@Transactional \u6ce8\u89e3\u4e00\u822c\u7528\u5728 Service \u4e2d\uff0c\u7528\u5728\u8fd9\u91cc\u6beb\u65e0\u4f5c\u7528\uff08\u56e0\u4e3a\u53ea\u6709\u4e00\u4e2a\u67e5\u8be2\uff0c\u8981\u4e48\u6210\u529f\uff0c\u8981\u4e48\u5931\u8d25\uff09\u3002", "url": "https://github.com/halo-dev/halo/pull/465#discussion_r365533629", "createdAt": "2020-01-11T17:49:29Z", "author": {"login": "JohnNiang"}, "path": "src/main/java/run/halo/app/repository/CommentBlackListRepository.java", "diffHunk": "@@ -0,0 +1,37 @@\n+package run.halo.app.repository;\n+\n+import org.springframework.data.jpa.repository.Modifying;\n+import org.springframework.data.jpa.repository.Query;\n+import org.springframework.data.repository.query.Param;\n+import org.springframework.transaction.annotation.Transactional;\n+import run.halo.app.model.entity.CommentBlackList;\n+import run.halo.app.repository.base.BaseRepository;\n+\n+/**\n+ * \u8bc4\u8bba\u9ed1\u540d\u5355Repository\n+ *\n+ * @author Lei XinXin\n+ * @date 2020/1/3\n+ */\n+public interface CommentBlackListRepository extends BaseRepository<CommentBlackList, Long> {\n+\n+    /**\n+     * \u6839\u636eIP\u5730\u5740\u83b7\u53d6\u6570\u636e\n+     *\n+     * @param ipAddress\n+     * @return\n+     */\n+    @Query(\"SELECT commentBlackList FROM CommentBlackList commentBlackList WHERE commentBlackList.ipAddress=?1\")\n+    CommentBlackList getByIpAddress(String ipAddress);\n+\n+    /**\n+     * Update Comment BlackList By IPAddress\n+     *\n+     * @param commentBlackList\n+     * @return result\n+     */\n+    @Transactional(rollbackFor = Exception.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2476dccfa6ee0b6d1508d85dd8535f8e30114902"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMzg1Mg==", "bodyText": "\u53ef\u4ee5\u8003\u8651\u5728 run.halo.app.model.properties.CommentProperties \u4e2d\u914d\u7f6e\u3002", "url": "https://github.com/halo-dev/halo/pull/465#discussion_r365533852", "createdAt": "2020-01-11T17:54:31Z", "author": {"login": "JohnNiang"}, "path": "src/main/java/run/halo/app/service/impl/CommentBlackListServiceImpl.java", "diffHunk": "@@ -0,0 +1,79 @@\n+package run.halo.app.service.impl;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.stereotype.Service;\n+import run.halo.app.model.entity.CommentBlackList;\n+import run.halo.app.model.enums.CommentViolationTypeEnum;\n+import run.halo.app.repository.CommentBlackListRepository;\n+import run.halo.app.repository.PostCommentRepository;\n+import run.halo.app.service.CommentBlackListService;\n+import run.halo.app.service.base.AbstractCrudService;\n+\n+import java.time.LocalDateTime;\n+import java.time.ZoneId;\n+import java.util.Date;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+/**\n+ * Comment BlackList Service Implements\n+ *\n+ * @author Lei XinXin\n+ * @date 2020/1/3\n+ */\n+\n+@Service\n+@Slf4j\n+public class CommentBlackListServiceImpl extends AbstractCrudService<CommentBlackList, Long> implements CommentBlackListService {\n+    private static ZoneId zoneId = ZoneId.of(\"Asia/Shanghai\");\n+    private final CommentBlackListRepository commentBlackListRepository;\n+    private final PostCommentRepository postCommentRepository;\n+\n+\n+    public CommentBlackListServiceImpl(CommentBlackListRepository commentBlackListRepository, PostCommentRepository postCommentRepository) {\n+        super(commentBlackListRepository);\n+        this.commentBlackListRepository = commentBlackListRepository;\n+        this.postCommentRepository = postCommentRepository;\n+    }\n+\n+    @Override\n+    public CommentViolationTypeEnum commentsBanStatus(String ipAddress) {\n+        /*\n+        N=\u540e\u671f\u53ef\u914d\u7f6e\n+        1. \u83b7\u53d6\u8bc4\u8bba\u6b21\u6570\uff1b\n+        2. \u5224\u65adN\u5206\u949f\u5185\uff0c\u662f\u5426\u8d85\u8fc7\u89c4\u5b9a\u7684\u6b21\u6570\u9650\u5236\uff0c\u8d85\u8fc7\u540e\u9700\u8981\u6bcf\u9694N\u5206\u949f\u624d\u80fd\u518d\u6b21\u8bc4\u8bba\uff1b\n+        3. \u5982\u679c\u5728\u65f6\u9694N\u5206\u949f\u5185\uff0c\u8fd8\u6709\u591a\u6b21\u8bc4\u8bba\uff0c\u53ef\u88ab\u8ba4\u5b9a\u4e3a\u6076\u610f\u653b\u51fb\u8005\uff1b\n+        4. \u5bf9\u6076\u610f\u653b\u51fb\u8005\u8fdb\u884cN\u5206\u949f\u7684\u5c01\u7981\uff1b\n+        */\n+        CommentBlackList blackList = commentBlackListRepository.getByIpAddress(ipAddress);\n+        LocalDateTime now = LocalDateTime.now();\n+        Date endTime = new Date(now.atZone(zoneId).toInstant().toEpochMilli());\n+        Date startTime = new Date(now.minusMinutes(10).atZone(zoneId).toInstant().toEpochMilli());\n+        int range = 30;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2476dccfa6ee0b6d1508d85dd8535f8e30114902"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMzg3Nw==", "bodyText": "\u8fd9\u91cc\u7684\u65f6\u95f4\uff0c\u5efa\u8bae\u52a8\u6001\u8bbe\u7f6e\u3002", "url": "https://github.com/halo-dev/halo/pull/465#discussion_r365533877", "createdAt": "2020-01-11T17:55:11Z", "author": {"login": "JohnNiang"}, "path": "src/main/java/run/halo/app/service/impl/PostCommentServiceImpl.java", "diffHunk": "@@ -110,4 +117,13 @@ public void validateTarget(Integer postId) {\n             throw new BadRequestException(\"\u8be5\u6587\u7ae0\u5df2\u7ecf\u88ab\u7981\u6b62\u8bc4\u8bba\").setErrorData(postId);\n         }\n     }\n+\n+    @Override\n+    public void validateCommentBlackListStatus() {\n+        CommentViolationTypeEnum banStatus = commentBlackListService.commentsBanStatus(ServletUtils.getRequestIp());\n+        if (banStatus == CommentViolationTypeEnum.FREQUENTLY) {\n+            throw new BadRequestException(\"\u60a8\u7684\u8bc4\u8bba\u8fc7\u4e8e\u9891\u7e41\uff0c\u8bf710\u5206\u949f\u4e4b\u540e\u518d\u8bd5\u3002\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2476dccfa6ee0b6d1508d85dd8535f8e30114902"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMzk2Mw==", "bodyText": "\u540c\u65f6\uff0c\u4e5f\u5efa\u8bae\u629b\u51fa ForbbidenException \u5f02\u5e38\uff0c\u8bed\u4e49\u66f4\u52a0\u5408\u7406\u3002", "url": "https://github.com/halo-dev/halo/pull/465#discussion_r365533963", "createdAt": "2020-01-11T17:57:02Z", "author": {"login": "JohnNiang"}, "path": "src/main/java/run/halo/app/service/impl/PostCommentServiceImpl.java", "diffHunk": "@@ -110,4 +117,13 @@ public void validateTarget(Integer postId) {\n             throw new BadRequestException(\"\u8be5\u6587\u7ae0\u5df2\u7ecf\u88ab\u7981\u6b62\u8bc4\u8bba\").setErrorData(postId);\n         }\n     }\n+\n+    @Override\n+    public void validateCommentBlackListStatus() {\n+        CommentViolationTypeEnum banStatus = commentBlackListService.commentsBanStatus(ServletUtils.getRequestIp());\n+        if (banStatus == CommentViolationTypeEnum.FREQUENTLY) {\n+            throw new BadRequestException(\"\u60a8\u7684\u8bc4\u8bba\u8fc7\u4e8e\u9891\u7e41\uff0c\u8bf710\u5206\u949f\u4e4b\u540e\u518d\u8bd5\u3002\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMzg3Nw=="}, "originalCommit": {"oid": "2476dccfa6ee0b6d1508d85dd8535f8e30114902"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNTUxOTEw", "url": "https://github.com/halo-dev/halo/pull/465#pullrequestreview-341551910", "createdAt": "2020-01-12T03:21:23Z", "commit": {"oid": "2476dccfa6ee0b6d1508d85dd8535f8e30114902"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a77e98fdfa8198ecc572688204085b812cca858", "author": {"user": {"login": "NGLSL", "name": "Leixinxin"}}, "url": "https://github.com/halo-dev/halo/commit/0a77e98fdfa8198ecc572688204085b812cca858", "committedDate": "2020-01-14T07:00:45Z", "message": "Merge branch 'dev' of https://github.com/halo-dev/halo into dev"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e37915db52b2f49845f20424f025834076927899", "author": {"user": {"login": "NGLSL", "name": "Leixinxin"}}, "url": "https://github.com/halo-dev/halo/commit/e37915db52b2f49845f20424f025834076927899", "committedDate": "2020-01-15T14:35:45Z", "message": "\u4f18\u5316\u76f8\u5173\u7684\u7ec6\u8282"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzMjY1ODY2", "url": "https://github.com/halo-dev/halo/pull/465#pullrequestreview-343265866", "createdAt": "2020-01-15T14:40:49Z", "commit": {"oid": "e37915db52b2f49845f20424f025834076927899"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4250, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}