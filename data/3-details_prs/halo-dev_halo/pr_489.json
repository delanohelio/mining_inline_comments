{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxNzEwNzg5", "number": 489, "title": "fix: #489", "bodyText": "\u4fee\u6b63\u4e0a\u4e0b\u9875\u4e0e\u9996\u9875\u5217\u8868\u663e\u793a\u4e0d\u4e00\u81f4\u7684\u95ee\u9898\u3002\n\u4fee\u6539\u70b9\uff1a\n\n\u4fee\u6539\u4e86\u8ddf\u8def\u5f84\u7684controller\u7684\u83b7\u53d6List\u7684Sort\u3002\u81ea\u5b9a\u4e49\u4e86\u83b7\u53d6\u6587\u7ae0\u9ed8\u8ba4\u6392\u5e8f\u7684\u65b9\u6cd5\u3002\n\u589e\u52a0\u83b7\u53d6\u4e0a\u4e0b\u7bc7\u6587\u7ae0\u7684\u65b9\u6cd5\u3002\n\u589e\u52a0\u83b7\u53d6\u6587\u7ae0\u9ed8\u8ba4\u6392\u5e8f\u7684\u65b9\u6cd5\u3002\u7528\u6765\u83b7\u53d6\u7f6e\u9876\uff0c\u81ea\u5b9a\u4e49\uff0cid\u6392\u5e8f\u4e09\u79cd\u7684\u5408\u96c6\u7684\u6392\u5e8f\u3002\u7edf\u4e00\u9996\u9875\u5217\u8868\u548c\u6587\u7ae0\u4e0a\u4e0b\u7bc7\u4e2d\u7684\u903b\u8f91\u987a\u5e8f\u3002\n\n\u5f85\u6269\u5c55\uff1a\n\u652f\u6301\u5206\u7c7b\u548c\u6807\u7b7e\u9875\u4e0b\u8fdb\u5165\u6587\u7ae0\u9875\u7684\u4e0a\u4e0b\u7bc7\u987a\u5e8f\u3002", "createdAt": "2020-01-11T08:54:31Z", "url": "https://github.com/halo-dev/halo/pull/489", "merged": true, "mergeCommit": {"oid": "89086dd345d11ca5434df889af68edebbb22e630"}, "closed": true, "closedAt": "2020-01-16T10:00:35Z", "author": {"login": "le0zh0u"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb3Y0NrgH2gAyMzYxNzEwNzg5OjIyMDM4ODlmZTcwZTZjYTIxOTM3ZjFlMzhjOWIxYmNlN2VmMzY5MTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb63LvEAFqTM0Mzc5NDM0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2203889fe70e6ca21937f1e38c9b1bce7ef36910", "author": {"user": {"login": "ruibaby", "name": "Ryan Wang"}}, "url": "https://github.com/halo-dev/halo/commit/2203889fe70e6ca21937f1e38c9b1bce7ef36910", "committedDate": "2020-01-05T14:55:31Z", "message": "release: 1.2.0. (#467)\n\nrelease: 1.2.0.\r\n\r\nCo-authored-by: Jiahuan Shen <shenjiahuan@sjtu.edu.cn>\r\nCo-authored-by: John Niang <johnniang@foxmail.com>\r\nCo-authored-by: Ryan Wang <i@ryanc.cc>\r\nCo-authored-by: null <weiwensangsang@users.noreply.github.com>\r\nCo-authored-by: bobo <yabo_han@163.com>\r\nCo-authored-by: Lei XinXin <nglsl666@aliyun.com>\r\nCo-authored-by: \u5bd2\u5c71 <ms915818993@163.com>\r\nCo-authored-by: IJKZEN <ijkzen@outlook.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05a2ad14b1bd9503614dbed5731c95968d6b4e8c", "author": {"user": {"login": "ruibaby", "name": "Ryan Wang"}}, "url": "https://github.com/halo-dev/halo/commit/05a2ad14b1bd9503614dbed5731c95968d6b4e8c", "committedDate": "2020-01-06T06:52:37Z", "message": "Update FUNDING.yml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9752a4185c6655a12186a6145d88804541a6887e", "author": {"user": {"login": "le0zh0u", "name": "leozhou"}}, "url": "https://github.com/halo-dev/halo/commit/9752a4185c6655a12186a6145d88804541a6887e", "committedDate": "2020-01-09T10:52:02Z", "message": "Merge pull request #1 from halo-dev/master\n\nFork code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da0545798832e2865c942f79ae62a7d7ff1f9fa2", "author": {"user": null}, "url": "https://github.com/halo-dev/halo/commit/da0545798832e2865c942f79ae62a7d7ff1f9fa2", "committedDate": "2020-01-09T13:41:52Z", "message": "merge from master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d617130e902bd730af139377a075de9a1535af8a", "author": {"user": null}, "url": "https://github.com/halo-dev/halo/commit/d617130e902bd730af139377a075de9a1535af8a", "committedDate": "2020-01-11T08:36:02Z", "message": "feat: update page default sort && update the pre and next of posts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbc50f26adb92e7532736fa1a4667c554d6fad61", "author": {"user": {"login": "le0zh0u", "name": "leozhou"}}, "url": "https://github.com/halo-dev/halo/commit/cbc50f26adb92e7532736fa1a4667c554d6fad61", "committedDate": "2020-01-11T09:09:13Z", "message": "Merge pull request #3 from halo-dev/dev\n\nDev"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20ec040b5db62f5f022cff5eae08dd5c17e00549", "author": {"user": null}, "url": "https://github.com/halo-dev/halo/commit/20ec040b5db62f5f022cff5eae08dd5c17e00549", "committedDate": "2020-01-11T09:19:44Z", "message": "Merge branch 'dev' of github.com:le0zh0u/halo into issue/406_next_page_sort\n\n# Conflicts:\n#\tsrc/main/java/run/halo/app/controller/content/ContentArchiveController.java\n#\tsrc/main/java/run/halo/app/controller/content/ContentIndexController.java\n#\tsrc/main/java/run/halo/app/service/impl/PostServiceImpl.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c93dee615fefd5364be898adb4fc4f340d00ed2", "author": {"user": null}, "url": "https://github.com/halo-dev/halo/commit/3c93dee615fefd5364be898adb4fc4f340d00ed2", "committedDate": "2020-01-11T12:02:57Z", "message": "feat: adapter dev branch"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNTMwMzg1", "url": "https://github.com/halo-dev/halo/pull/489#pullrequestreview-341530385", "createdAt": "2020-01-11T16:33:17Z", "commit": {"oid": "3c93dee615fefd5364be898adb4fc4f340d00ed2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNTMxODMy", "url": "https://github.com/halo-dev/halo/pull/489#pullrequestreview-341531832", "createdAt": "2020-01-11T17:09:07Z", "commit": {"oid": "3c93dee615fefd5364be898adb4fc4f340d00ed2"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMVQxNzowOTowN1rOFcmShQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMVQxNzoxNDozNFrOFcmTgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMTc4MQ==", "bodyText": "\u8fd9\u91cc\u9700\u8981\u8be6\u7ec6\u8bf4\u660e\u8fd4\u56de\u503c\u5177\u4f53\u662f\u4ec0\u4e48\uff1b\n\u540c\u65f6\uff0c\u4e5f\u4e0d\u5efa\u8bae\u8fd9\u6837\u8fd4\u56de\u7ed3\u679c\u3002", "url": "https://github.com/halo-dev/halo/pull/489#discussion_r365531781", "createdAt": "2020-01-11T17:09:07Z", "author": {"login": "JohnNiang"}, "path": "src/main/java/run/halo/app/service/PostService.java", "diffHunk": "@@ -228,4 +230,20 @@\n      * @param postId postId must not be null\n      */\n     void publishVisitEvent(@NonNull Integer postId);\n+\n+    /**\n+     * Gets pre && next post.\n+     * @param currentPost post must not be null\n+     * @return\n+     */\n+    @NotNull\n+    List<Post> getAdjacentPostList(Post currentPost);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c93dee615fefd5364be898adb4fc4f340d00ed2"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMTk2OQ==", "bodyText": "\u65b9\u6cd5\u8fd4\u56de\u503c\u7684 adjacentPostDTOList \u4e0d\u591f\u660e\u786e\u3002\u4e5f\u4e0d\u5efa\u8bae\u8fd9\u6837\u505a\uff08\u5c3d\u7ba1\u80fd\u591f\u5b9e\u73b0\u6548\u679c\uff09\u3002", "url": "https://github.com/halo-dev/halo/pull/489#discussion_r365531969", "createdAt": "2020-01-11T17:13:19Z", "author": {"login": "JohnNiang"}, "path": "src/main/java/run/halo/app/controller/content/model/PostModel.java", "diffHunk": "@@ -75,21 +77,27 @@ public PostModel(PostService postService,\n     public String content(Post post, String token, Model model) {\n \n         if (post.getStatus().equals(PostStatus.INTIMATE) && StringUtils.isEmpty(token)) {\n-            String redirect = String.format(\"%s/archives/%s/password\", optionService.getBlogBaseUrl(), post.getUrl());\n+            String redirect = String\n+                    .format(\"%s/archives/%s/password\", optionService.getBlogBaseUrl(),\n+                            post.getUrl());\n             return \"redirect:\" + redirect;\n         }\n \n         if (!StringUtils.isEmpty(token)) {\n             // verify token\n-            String cachedToken = cacheStore.getAny(token, String.class).orElseThrow(() -> new ForbiddenException(\"\u60a8\u6ca1\u6709\u8be5\u6587\u7ae0\u7684\u8bbf\u95ee\u6743\u9650\"));\n+            String cachedToken = cacheStore.getAny(token, String.class)\n+                    .orElseThrow(() -> new ForbiddenException(\"\u60a8\u6ca1\u6709\u8be5\u6587\u7ae0\u7684\u8bbf\u95ee\u6743\u9650\"));\n             if (!cachedToken.equals(token)) {\n                 throw new ForbiddenException(\"\u60a8\u6ca1\u6709\u8be5\u6587\u7ae0\u7684\u8bbf\u95ee\u6743\u9650\");\n             }\n             post.setFormatContent(MarkdownUtils.renderHtml(post.getOriginalContent()));\n         }\n         postService.publishVisitEvent(post.getId());\n-        postService.getNextPost(post.getCreateTime()).ifPresent(nextPost -> model.addAttribute(\"nextPost\", nextPost));\n-        postService.getPrePost(post.getCreateTime()).ifPresent(prePost -> model.addAttribute(\"prePost\", prePost));\n+\n+        List<Post> adjacentPostList = postService.getAdjacentPostList(post);\n+        List<BasePostMinimalDTO> adjacentPostDTOList = postService.convertToMinimal(adjacentPostList);\n+        Optional.ofNullable(adjacentPostDTOList.get(0)).ifPresent(prePost -> model.addAttribute(\"prePost\", prePost));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c93dee615fefd5364be898adb4fc4f340d00ed2"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMjAzMw==", "bodyText": "\u53ef\u4ee5\u8003\u8651\u521b\u5efa\u4e00\u4e2a VO\uff0c\u6765\u4f20\u9012\u53c2\u6570\u3002", "url": "https://github.com/halo-dev/halo/pull/489#discussion_r365532033", "createdAt": "2020-01-11T17:14:34Z", "author": {"login": "JohnNiang"}, "path": "src/main/java/run/halo/app/service/impl/PostServiceImpl.java", "diffHunk": "@@ -698,4 +743,77 @@ private PostDetailVO createOrUpdate(@NonNull Post post, Set<Integer> tagIds, Set\n     public void publishVisitEvent(Integer postId) {\n         eventPublisher.publishEvent(new PostVisitEvent(this, postId));\n     }\n+\n+    @Override\n+    public @NotNull List<Post> getAdjacentPostList(Post currentPost) {\n+        Assert.notNull(currentPost, \"Post must not be null\");\n+\n+        // get pageable post list\n+        List<Post> postList = new ArrayList<>();\n+        // init fist page && default page size\n+        Integer page = 1;\n+        Integer defaultPageSize = 500;\n+        boolean needNext = true;\n+\n+        // get custom sort type\n+        Sort sort = getPostDefaultSort();\n+        Pageable pageable = null;\n+        PostStatus postStatus = PostStatus.PUBLISHED;\n+        long totalCount = countByStatus(postStatus);\n+\n+        while (needNext && totalCount > postList.size()) {\n+            pageable = PageRequest\n+                    .of(page >= 1 ? page - 1 : page, defaultPageSize, sort);\n+\n+            Page<Post> postPage = pageBy(postStatus, pageable);\n+            List<Post> pageablePostList = postPage.getContent();\n+            if (pageablePostList.size() == 0) {\n+                break;\n+            }\n+            postList.addAll(postPage.getContent());\n+            if (postList.stream().filter(it -> it.getId().equals(currentPost.getId())).count() == 1\n+                    && !postList.stream().reduce((first, second) -> second).get().getId()\n+                    .equals(currentPost.getId())) {\n+                // contains the post && the post is not in the end\n+                needNext = false;\n+            }\n+\n+            page++;\n+        }\n+\n+        List<Post> resultList = new ArrayList<>(2);\n+\n+        if (CollectionUtils.isEmpty(postList)) {\n+            return resultList;\n+        }\n+\n+        List<Integer> idList = postList.stream().map(Post::getId).collect(Collectors.toList());\n+        Integer index = idList.indexOf(currentPost.getId());\n+\n+        if (index == -1) {\n+            return resultList;\n+        }\n+\n+        //setup preContentArchiveController\n+        if (index > 0) {\n+            resultList.add(postList.get(index - 1));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c93dee615fefd5364be898adb4fc4f340d00ed2"}, "originalPosition": 365}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNTMyMTg2", "url": "https://github.com/halo-dev/halo/pull/489#pullrequestreview-341532186", "createdAt": "2020-01-11T17:17:07Z", "commit": {"oid": "3c93dee615fefd5364be898adb4fc4f340d00ed2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNTUyMTU2", "url": "https://github.com/halo-dev/halo/pull/489#pullrequestreview-341552156", "createdAt": "2020-01-12T03:31:55Z", "commit": {"oid": "3c93dee615fefd5364be898adb4fc4f340d00ed2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMlQwMzozMTo1NlrOFcnuAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMlQwMzozMTo1NlrOFcnuAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU1NTIwMQ==", "bodyText": "\u4e0d\u5efa\u8bae\u76f4\u63a5\u4f7f\u7528 get \u83b7\u53d6 List \u7684\u5143\u7d20\uff0c\u53ef\u80fd\u4f60 service \u65b9\u6cd5\u9700\u8981\u4fee\u6539\u4e00\u4e0b\uff0c\u5b9e\u5728\u4e0d\u884c\uff0c\u5efa\u8bae\u5199\u4e24\u4e2a\u3002\u4e00\u4e2a PrePost\uff0c\u4e00\u4e2a NextPost\u3002\u5e76\u4e14\u4f7f\u7528 Optional \u5305\u88c5\u3002", "url": "https://github.com/halo-dev/halo/pull/489#discussion_r365555201", "createdAt": "2020-01-12T03:31:56Z", "author": {"login": "ruibaby"}, "path": "src/main/java/run/halo/app/service/impl/StaticPageServiceImpl.java", "diffHunk": "@@ -329,8 +330,10 @@ private void generatePost() throws IOException, TemplateException {\n         for (Post post : posts) {\n             log.info(\"Generate archives/{}/index.html\", post.getUrl());\n             ModelMap model = new ModelMap();\n-            postService.getNextPost(post.getCreateTime()).ifPresent(nextPost -> model.addAttribute(\"nextPost\", nextPost));\n-            postService.getPrePost(post.getCreateTime()).ifPresent(prePost -> model.addAttribute(\"prePost\", prePost));\n+\n+            List<Post> adjacentPostList = postService.getAdjacentPostList(post);\n+            Optional.ofNullable(adjacentPostList.get(0)).ifPresent(prePost -> model.addAttribute(\"prePost\", prePost));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c93dee615fefd5364be898adb4fc4f340d00ed2"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "107885fcd44aeadf76076dc7a50fe055f375f78f", "author": {"user": null}, "url": "https://github.com/halo-dev/halo/commit/107885fcd44aeadf76076dc7a50fe055f375f78f", "committedDate": "2020-01-12T16:13:38Z", "message": "Feat: update getAdjacentPosts return && update post ftl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4609d4e8921c1a9aa3d9741f5f6122e8192eff45", "author": {"user": null}, "url": "https://github.com/halo-dev/halo/commit/4609d4e8921c1a9aa3d9741f5f6122e8192eff45", "committedDate": "2020-01-12T16:22:06Z", "message": "fix: revert gradle-wrapper.jar"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNjE1MTMz", "url": "https://github.com/halo-dev/halo/pull/489#pullrequestreview-341615133", "createdAt": "2020-01-13T01:15:55Z", "commit": {"oid": "4609d4e8921c1a9aa3d9741f5f6122e8192eff45"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNzk0MzQy", "url": "https://github.com/halo-dev/halo/pull/489#pullrequestreview-343794342", "createdAt": "2020-01-16T10:00:08Z", "commit": {"oid": "4609d4e8921c1a9aa3d9741f5f6122e8192eff45"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4201, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}