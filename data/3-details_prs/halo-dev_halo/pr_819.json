{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEyNjA3MjA5", "number": 819, "title": "feat: Support Rename and Edit Staitc Files (#573)", "bodyText": "\u52a0\u5165\u9759\u6001\u6587\u4ef6\u7684\u91cd\u547d\u540d\u548c\u7f16\u8f91\u7684API\uff0c\u4ee5\u53ca\u6d4b\u8bd5\u5355\u5143 #573\n\u524d\u7aef\u652f\u6301\u91cd\u547d\u540d\u6587\u4ef6\uff0c\u80fd\u591f\u7f16\u8f91CodeMirror\u652f\u6301\u6587\u4ef6\u683c\u5f0f\uff0c\u4e0d\u540c\u7684\u683c\u5f0f\u6709\u76f8\u5e94\u7684\u8bed\u6cd5\u9ad8\u4eae halo-admin #152", "createdAt": "2020-05-03T14:02:07Z", "url": "https://github.com/halo-dev/halo/pull/819", "merged": true, "mergeCommit": {"oid": "4197ca33d81d78d112198d3089fa07b377d5420a"}, "closed": true, "closedAt": "2020-05-11T14:25:09Z", "author": {"login": "Arexh"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcdgdKVAH2gAyNDEyNjA3MjA5OmI2ZTMwMzlhNzRhN2UyZjczMzNmMTc4NzVhNWVkOGQ4NDA4ODBhOWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABceNNPHAH2gAyNDEyNjA3MjA5OmIxMTc1ZmFiY2FiOTQyMjFiZjY1N2RkYzZmYzZmYzczZWRkMzRmY2Y=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b6e3039a74a7e2f7333f17875a5ed8d840880a9a", "author": {"user": {"login": "Arexh", "name": "Yqhg8Nt4tuu"}}, "url": "https://github.com/halo-dev/halo/commit/b6e3039a74a7e2f7333f17875a5ed8d840880a9a", "committedDate": "2020-05-03T01:18:42Z", "message": "Add rename API"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a310ff10dd9fbbf09aaab5645eda067d775a4a8", "author": {"user": {"login": "Arexh", "name": "Yqhg8Nt4tuu"}}, "url": "https://github.com/halo-dev/halo/commit/5a310ff10dd9fbbf09aaab5645eda067d775a4a8", "committedDate": "2020-05-03T11:51:44Z", "message": "Add save API"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "896be524214f3911911d6f546aaa100992dc1f27", "author": {"user": {"login": "Arexh", "name": "Yqhg8Nt4tuu"}}, "url": "https://github.com/halo-dev/halo/commit/896be524214f3911911d6f546aaa100992dc1f27", "committedDate": "2020-05-03T13:29:27Z", "message": "Add unit test for rename API"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d5bfddfae628bcdfed2d33e6bfc4201eb35723e", "author": {"user": {"login": "Arexh", "name": "Yqhg8Nt4tuu"}}, "url": "https://github.com/halo-dev/halo/commit/8d5bfddfae628bcdfed2d33e6bfc4201eb35723e", "committedDate": "2020-05-03T14:16:21Z", "message": "Fix an indentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41bb33d69eb56b08bf6509049147d961634ac45a", "author": {"user": {"login": "Arexh", "name": "Yqhg8Nt4tuu"}}, "url": "https://github.com/halo-dev/halo/commit/41bb33d69eb56b08bf6509049147d961634ac45a", "committedDate": "2020-05-03T14:22:04Z", "message": "Add a space before '{'"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0Njg0NDYz", "url": "https://github.com/halo-dev/halo/pull/819#pullrequestreview-404684463", "createdAt": "2020-05-04T02:10:22Z", "commit": {"oid": "41bb33d69eb56b08bf6509049147d961634ac45a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQwMjoxMDoyMlrOGPxYhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQwMjoxNToxMFrOGPxamA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5MDkxNg==", "bodyText": "\u8bf7\u81ea\u5b9a\u4e49 Param \u66ff\u4ee3 Map\u3002", "url": "https://github.com/halo-dev/halo/pull/819#discussion_r419190916", "createdAt": "2020-05-04T02:10:22Z", "author": {"login": "JohnNiang"}, "path": "src/main/java/run/halo/app/controller/admin/api/StaticStorageController.java", "diffHunk": "@@ -49,4 +50,17 @@ public void upload(String basePath,\n                        @RequestPart(\"file\") MultipartFile file) {\n         staticStorageService.upload(basePath, file);\n     }\n+\n+    @PostMapping(\"rename\")\n+    @ApiOperation(\"Renames static file\")\n+    public void rename(String basePath,\n+                       String newName) {\n+        staticStorageService.rename(basePath, newName);\n+    }\n+\n+    @PutMapping(\"save\")\n+    @ApiOperation(\"Save static file\")\n+    public void save(@RequestBody Map<String, String> data) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41bb33d69eb56b08bf6509049147d961634ac45a"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5MTE1MA==", "bodyText": "\u8fd9\u91cc\u5efa\u8bae\u66f4\u6539\u4e3a\uff1a@PostMapping(\"files\")", "url": "https://github.com/halo-dev/halo/pull/819#discussion_r419191150", "createdAt": "2020-05-04T02:12:25Z", "author": {"login": "JohnNiang"}, "path": "src/main/java/run/halo/app/controller/admin/api/StaticStorageController.java", "diffHunk": "@@ -49,4 +50,17 @@ public void upload(String basePath,\n                        @RequestPart(\"file\") MultipartFile file) {\n         staticStorageService.upload(basePath, file);\n     }\n+\n+    @PostMapping(\"rename\")\n+    @ApiOperation(\"Renames static file\")\n+    public void rename(String basePath,\n+                       String newName) {\n+        staticStorageService.rename(basePath, newName);\n+    }\n+\n+    @PutMapping(\"save\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41bb33d69eb56b08bf6509049147d961634ac45a"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5MTI1Ng==", "bodyText": "\u5199\u5165\u524d\u662f\u5426\u9700\u8981\u68c0\u67e5\u4e00\u4e0b\u8be5\u6587\u4ef6\u662f\u5426\u5b58\u5728\u5462\uff1f", "url": "https://github.com/halo-dev/halo/pull/819#discussion_r419191256", "createdAt": "2020-05-04T02:13:37Z", "author": {"login": "JohnNiang"}, "path": "src/main/java/run/halo/app/service/impl/StaticStorageServiceImpl.java", "diffHunk": "@@ -167,6 +166,42 @@ public void upload(String basePath, MultipartFile file) {\n         }\n     }\n \n+    @Override\n+    public void rename(String basePath, String newName) {\n+        Assert.notNull(basePath, \"Base path must not be null\");\n+        Assert.notNull(newName, \"New name must not be null\");\n+\n+        Path pathToRename;\n+\n+        if (StringUtils.startsWith(newName, API_FOLDER_NAME)) {\n+            throw new FileOperationException(\"\u91cd\u547d\u540d\u540d\u79f0 \" + newName + \" \u4e0d\u5408\u6cd5\");\n+        }\n+\n+        pathToRename = Paths.get(staticDir.toString(), basePath);\n+\n+        try {\n+            FileUtils.rename(pathToRename, newName);\n+            onChange();\n+        } catch (FileAlreadyExistsException e) {\n+            throw new FileOperationException(\"\u8be5\u8def\u5f84\u4e0b\u540d\u79f0 \" + newName + \" \u5df2\u5b58\u5728\");\n+        } catch (IOException e) {\n+            throw new FileOperationException(\"\u91cd\u547d\u540d \" + pathToRename.toString() + \" \u5931\u8d25\");\n+        }\n+    }\n+\n+    @Override\n+    public void save(String basePath, String content) {\n+        Assert.notNull(basePath, \"Base path must not be null\");\n+\n+        Path path = Paths.get(staticDir.toString(), basePath);\n+\n+        try {\n+            Files.write(path, content.getBytes(StandardCharsets.UTF_8));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41bb33d69eb56b08bf6509049147d961634ac45a"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5MTMyNQ==", "bodyText": "\u8fd9\u91cc\u662f\u5426\u5b58\u5728 Directory traversal \u98ce\u9669\u5462\uff1f", "url": "https://github.com/halo-dev/halo/pull/819#discussion_r419191325", "createdAt": "2020-05-04T02:14:06Z", "author": {"login": "JohnNiang"}, "path": "src/main/java/run/halo/app/service/impl/StaticStorageServiceImpl.java", "diffHunk": "@@ -167,6 +166,42 @@ public void upload(String basePath, MultipartFile file) {\n         }\n     }\n \n+    @Override\n+    public void rename(String basePath, String newName) {\n+        Assert.notNull(basePath, \"Base path must not be null\");\n+        Assert.notNull(newName, \"New name must not be null\");\n+\n+        Path pathToRename;\n+\n+        if (StringUtils.startsWith(newName, API_FOLDER_NAME)) {\n+            throw new FileOperationException(\"\u91cd\u547d\u540d\u540d\u79f0 \" + newName + \" \u4e0d\u5408\u6cd5\");\n+        }\n+\n+        pathToRename = Paths.get(staticDir.toString(), basePath);\n+\n+        try {\n+            FileUtils.rename(pathToRename, newName);\n+            onChange();\n+        } catch (FileAlreadyExistsException e) {\n+            throw new FileOperationException(\"\u8be5\u8def\u5f84\u4e0b\u540d\u79f0 \" + newName + \" \u5df2\u5b58\u5728\");\n+        } catch (IOException e) {\n+            throw new FileOperationException(\"\u91cd\u547d\u540d \" + pathToRename.toString() + \" \u5931\u8d25\");\n+        }\n+    }\n+\n+    @Override\n+    public void save(String basePath, String content) {\n+        Assert.notNull(basePath, \"Base path must not be null\");\n+\n+        Path path = Paths.get(staticDir.toString(), basePath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41bb33d69eb56b08bf6509049147d961634ac45a"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5MTQ0OA==", "bodyText": "\u53ef\u4ee5\u7701\u7565 toString() \u65b9\u6cd5\uff0c\u8fd9\u6837\u8fd8\u53ef\u80fd\u4f1a\u9020\u6210 NPE\u3002", "url": "https://github.com/halo-dev/halo/pull/819#discussion_r419191448", "createdAt": "2020-05-04T02:15:10Z", "author": {"login": "JohnNiang"}, "path": "src/main/java/run/halo/app/utils/FileUtils.java", "diffHunk": "@@ -77,6 +77,24 @@ public static void deleteFolder(@NonNull Path deletingPath) throws IOException {\n         log.info(\"Deleted [{}] successfully\", deletingPath);\n     }\n \n+    /**\n+     * Renames file or folder.\n+     *\n+     * @param pathToRename file path to rename must not be null\n+     * @param newName new name must not be null\n+     */\n+    public static void rename(@NonNull Path pathToRename, @NonNull String newName) throws IOException {\n+        Assert.notNull(pathToRename, \"File path to rename must not be null\");\n+        Assert.notNull(newName, \"New name must not be null\");\n+\n+        Path newPath = pathToRename.resolveSibling(newName);\n+        log.info(\"Rename [{}] to [{}]\", pathToRename.toString(), newPath.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41bb33d69eb56b08bf6509049147d961634ac45a"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0Njk5NTI0", "url": "https://github.com/halo-dev/halo/pull/819#pullrequestreview-404699524", "createdAt": "2020-05-04T03:57:43Z", "commit": {"oid": "41bb33d69eb56b08bf6509049147d961634ac45a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQwMzo1Nzo0M1rOGPyOUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQwMzo1Nzo0M1rOGPyOUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTIwNDY4OA==", "bodyText": "\u4ffa\u4e5f\u662f\uff01", "url": "https://github.com/halo-dev/halo/pull/819#discussion_r419204688", "createdAt": "2020-05-04T03:57:43Z", "author": {"login": "ruibaby"}, "path": "src/main/java/run/halo/app/controller/admin/api/StaticStorageController.java", "diffHunk": "@@ -49,4 +50,17 @@ public void upload(String basePath,\n                        @RequestPart(\"file\") MultipartFile file) {\n         staticStorageService.upload(basePath, file);\n     }\n+\n+    @PostMapping(\"rename\")\n+    @ApiOperation(\"Renames static file\")\n+    public void rename(String basePath,\n+                       String newName) {\n+        staticStorageService.rename(basePath, newName);\n+    }\n+\n+    @PutMapping(\"save\")\n+    @ApiOperation(\"Save static file\")\n+    public void save(@RequestBody Map<String, String> data) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5MDkxNg=="}, "originalCommit": {"oid": "41bb33d69eb56b08bf6509049147d961634ac45a"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cca4e83b241748108f7325044aada8d22082d22f", "author": {"user": {"login": "Arexh", "name": "Yqhg8Nt4tuu"}}, "url": "https://github.com/halo-dev/halo/commit/cca4e83b241748108f7325044aada8d22082d22f", "committedDate": "2020-05-04T04:02:32Z", "message": "Add a Param and some invalid checks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a1423301af0e987944a93485fc42dcf13a30c97", "author": {"user": {"login": "Arexh", "name": "Yqhg8Nt4tuu"}}, "url": "https://github.com/halo-dev/halo/commit/8a1423301af0e987944a93485fc42dcf13a30c97", "committedDate": "2020-05-04T04:15:16Z", "message": "Change comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06dc9556b7d17d6c112803640e16ab45eaf49b99", "author": {"user": {"login": "Arexh", "name": "Yqhg8Nt4tuu"}}, "url": "https://github.com/halo-dev/halo/commit/06dc9556b7d17d6c112803640e16ab45eaf49b99", "committedDate": "2020-05-04T05:21:14Z", "message": "Change test annotation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bb3c0184b621b670ac9ed90b246cae5f6485719", "author": {"user": {"login": "Arexh", "name": "Yqhg8Nt4tuu"}}, "url": "https://github.com/halo-dev/halo/commit/1bb3c0184b621b670ac9ed90b246cae5f6485719", "committedDate": "2020-05-04T05:25:20Z", "message": "Delete impl test unit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NDU0NzEz", "url": "https://github.com/halo-dev/halo/pull/819#pullrequestreview-405454713", "createdAt": "2020-05-05T01:54:37Z", "commit": {"oid": "1bb3c0184b621b670ac9ed90b246cae5f6485719"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwMTo1NDozN1rOGQYIAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwMTo1NjowOFrOGQYJIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgyNTY2NA==", "bodyText": "\u5efa\u8bae\u7528 run.halo.app.utils.FileUtils#checkDirectoryTraversal(String, String) \u6765\u68c0\u67e5\u8def\u5f84\u662f\u5426\u5408\u6cd5\u3002", "url": "https://github.com/halo-dev/halo/pull/819#discussion_r419825664", "createdAt": "2020-05-05T01:54:37Z", "author": {"login": "JohnNiang"}, "path": "src/main/java/run/halo/app/service/impl/StaticStorageServiceImpl.java", "diffHunk": "@@ -167,6 +166,50 @@ public void upload(String basePath, MultipartFile file) {\n         }\n     }\n \n+    @Override\n+    public void rename(String basePath, String newName) {\n+        Assert.notNull(basePath, \"Base path must not be null\");\n+        Assert.notNull(newName, \"New name must not be null\");\n+\n+        Path pathToRename;\n+\n+        if (StringUtils.startsWith(newName, API_FOLDER_NAME)) {\n+            throw new FileOperationException(\"\u91cd\u547d\u540d\u540d\u79f0 \" + newName + \" \u4e0d\u5408\u6cd5\");\n+        }\n+\n+        pathToRename = Paths.get(staticDir.toString(), basePath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1bb3c0184b621b670ac9ed90b246cae5f6485719"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgyNTk1Mg==", "bodyText": "\u4e5f\u8bb8\u5e94\u8be5\u518d\u589e\u52a0\u4e00\u4e2a\u5173\u4e8e directory traversal \u7684\u6d4b\u8bd5\u3002", "url": "https://github.com/halo-dev/halo/pull/819#discussion_r419825952", "createdAt": "2020-05-05T01:56:08Z", "author": {"login": "JohnNiang"}, "path": "src/test/java/run/halo/app/utils/FileUtilsTest.java", "diffHunk": "@@ -108,4 +109,90 @@ public void dbFileReadTest() throws IOException {\n             log.debug(\"Buffer String: [{}]\", bufString);\n         }\n     }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1bb3c0184b621b670ac9ed90b246cae5f6485719"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1175fabcab94221bf657ddc6fc6fc73edd34fcf", "author": {"user": {"login": "Arexh", "name": "Yqhg8Nt4tuu"}}, "url": "https://github.com/halo-dev/halo/commit/b1175fabcab94221bf657ddc6fc6fc73edd34fcf", "committedDate": "2020-05-05T05:27:02Z", "message": "Add directory traversal check for static file operations"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4186, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}