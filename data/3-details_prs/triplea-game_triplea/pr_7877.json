{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxMjE1NzA0", "number": 7877, "title": "Roll dice step", "bodyText": "This is a part of #7823.\nDuring the firing part of the battle, there are three steps that are performed (you can see the originals in Fire and FireAa).  This is the step that rolls the dice.  There are two different ways to roll dice: AA and Normal.  So, I moved that logic into BiFunctions that are passed into this object.  RollNormal is the normal version.  And AaFireAndCasualtyStep.RollAa is the Aa version.\nTesting\n\nScreens Shots\n\nAdditional Notes to Reviewer\n\nRelease Note", "createdAt": "2020-10-11T22:20:23Z", "url": "https://github.com/triplea-game/triplea/pull/7877", "merged": true, "mergeCommit": {"oid": "eaa43e5aa9a9487c41f384bed78fecfcd05b0a58"}, "closed": true, "closedAt": "2020-10-12T23:59:09Z", "author": {"login": "trevan"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdRm1K6gH2gAyNTAxMjE1NzA0OmZiMGIyM2RlN2IwYTFkMjIwMmY1NTg5YWI3MjI1MzNhY2FmYzM0MDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdR9AzXAFqTUwNjk4NjAzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fb0b23de7b0a1d2202f5589ab722533acafc3401", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/fb0b23de7b0a1d2202f5589ab722533acafc3401", "committedDate": "2020-10-11T22:08:25Z", "message": "Create the RollDice battle step"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be01d6f62befa45c7a13ddccbe9e2241abd97dec", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/be01d6f62befa45c7a13ddccbe9e2241abd97dec", "committedDate": "2020-10-11T22:19:40Z", "message": "Add dice roll battle step"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MjI2Nzc2", "url": "https://github.com/triplea-game/triplea/pull/7877#pullrequestreview-506226776", "createdAt": "2020-10-11T23:11:06Z", "commit": {"oid": "be01d6f62befa45c7a13ddccbe9e2241abd97dec"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMVQyMzoxMTowNlrOHfrZTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMVQyMzoxODo1MVrOHfrcbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk3ODg5Mw==", "bodyText": "Is the comment used to group the enums?\nA bit nitpicky, I'd recommend to avoid it. As a casual reader here, it does not make a ton of sense what the comment is delimiting. It's also a bit of an issue for maintenance, does every line break indicate a new group? Are the groups all up to date?\nIf needing to mark certain enum values, there should be other ways to do it. For example, one can add name patterns, like a prefix, add flags, or use additional enum types, or convert the enums to strings.", "url": "https://github.com/triplea-game/triplea/pull/7877#discussion_r502978893", "createdAt": "2020-10-11T23:11:06Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/steps/BattleStep.java", "diffHunk": "@@ -75,6 +75,9 @@\n     OFFENSIVE_GENERAL_RETREAT,\n     STALEMATE_BATTLE_END_CHECK,\n     SUB_DEFENSIVE_RETREAT_AFTER_BATTLE,\n+\n+    // Fire Round steps", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be01d6f62befa45c7a13ddccbe9e2241abd97dec"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk3OTA3Nw==", "bodyText": "The uncertainty in this comment is interesting  \"makes the text feel redundant\"\nYoda principle: \"do or do not, there is no try\"\nI recommend making this comment more direct, the code is deterministic, the comment should be as well.", "url": "https://github.com/triplea-game/triplea/pull/7877#discussion_r502979077", "createdAt": "2020-10-11T23:12:56Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/steps/fire/RollDice.java", "diffHunk": "@@ -0,0 +1,61 @@\n+package games.strategy.triplea.delegate.battle.steps.fire;\n+\n+import static games.strategy.triplea.delegate.battle.BattleState.UnitBattleFilter.ALIVE;\n+import static games.strategy.triplea.delegate.battle.BattleStepStrings.FIRE_SUFFIX;\n+import static games.strategy.triplea.delegate.battle.BattleStepStrings.UNITS;\n+\n+import games.strategy.engine.delegate.IDelegateBridge;\n+import games.strategy.triplea.delegate.DiceRoll;\n+import games.strategy.triplea.delegate.ExecutionStack;\n+import games.strategy.triplea.delegate.battle.BattleState;\n+import games.strategy.triplea.delegate.battle.steps.BattleStep;\n+import java.util.List;\n+import java.util.function.BiFunction;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+\n+/** Step where the dice are rolled for the firing units */\n+@RequiredArgsConstructor\n+public class RollDice implements BattleStep {\n+\n+  private static final long serialVersionUID = 3248059314449726590L;\n+\n+  @Getter private final BattleState battleState;\n+\n+  /** The side of the firing player */\n+  @Getter private final BattleState.Side side;\n+\n+  @Getter private final FiringGroup firingGroup;\n+\n+  private final FireRoundState fireRoundState;\n+\n+  private final BiFunction<IDelegateBridge, RollDice, DiceRoll> rollDice;\n+\n+  @Override\n+  public List<String> getNames() {\n+    return List.of(getName());\n+  }\n+\n+  private String getName() {\n+    return battleState.getPlayer(side).getName()\n+        // displaying UNITS makes the text feel redundant so hide it if that is the group name", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be01d6f62befa45c7a13ddccbe9e2241abd97dec"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk3OTIyMg==", "bodyText": "Not for this PR, but you considered making the display name an object? I wonder if there could be some brittleness with the comparison of strings here. It also seems like we are violating SRP, the display string is serving double duty to both indicate a type and also used for display purpose.", "url": "https://github.com/triplea-game/triplea/pull/7877#discussion_r502979222", "createdAt": "2020-10-11T23:14:32Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/steps/fire/RollDice.java", "diffHunk": "@@ -0,0 +1,61 @@\n+package games.strategy.triplea.delegate.battle.steps.fire;\n+\n+import static games.strategy.triplea.delegate.battle.BattleState.UnitBattleFilter.ALIVE;\n+import static games.strategy.triplea.delegate.battle.BattleStepStrings.FIRE_SUFFIX;\n+import static games.strategy.triplea.delegate.battle.BattleStepStrings.UNITS;\n+\n+import games.strategy.engine.delegate.IDelegateBridge;\n+import games.strategy.triplea.delegate.DiceRoll;\n+import games.strategy.triplea.delegate.ExecutionStack;\n+import games.strategy.triplea.delegate.battle.BattleState;\n+import games.strategy.triplea.delegate.battle.steps.BattleStep;\n+import java.util.List;\n+import java.util.function.BiFunction;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+\n+/** Step where the dice are rolled for the firing units */\n+@RequiredArgsConstructor\n+public class RollDice implements BattleStep {\n+\n+  private static final long serialVersionUID = 3248059314449726590L;\n+\n+  @Getter private final BattleState battleState;\n+\n+  /** The side of the firing player */\n+  @Getter private final BattleState.Side side;\n+\n+  @Getter private final FiringGroup firingGroup;\n+\n+  private final FireRoundState fireRoundState;\n+\n+  private final BiFunction<IDelegateBridge, RollDice, DiceRoll> rollDice;\n+\n+  @Override\n+  public List<String> getNames() {\n+    return List.of(getName());\n+  }\n+\n+  private String getName() {\n+    return battleState.getPlayer(side).getName()\n+        // displaying UNITS makes the text feel redundant so hide it if that is the group name\n+        + (firingGroup.getDisplayName().equals(UNITS) ? \"\" : \" \" + firingGroup.getDisplayName())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be01d6f62befa45c7a13ddccbe9e2241abd97dec"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk3OTQ4OA==", "bodyText": "Could we remove the comment by updating the name of the method? EG:\nfiringGroup.removeUnitsThatWereHit(....);\n\nWe might want to consider more than that. Offhand I'm not sure just reading this line makes sense. We are getting the alive units of the other side and keeping only those units from within the current firing group. The fact we are getting the other side and are operating on the current firing group seems confusing. WDYT?", "url": "https://github.com/triplea-game/triplea/pull/7877#discussion_r502979488", "createdAt": "2020-10-11T23:16:47Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/steps/fire/RollDice.java", "diffHunk": "@@ -0,0 +1,61 @@\n+package games.strategy.triplea.delegate.battle.steps.fire;\n+\n+import static games.strategy.triplea.delegate.battle.BattleState.UnitBattleFilter.ALIVE;\n+import static games.strategy.triplea.delegate.battle.BattleStepStrings.FIRE_SUFFIX;\n+import static games.strategy.triplea.delegate.battle.BattleStepStrings.UNITS;\n+\n+import games.strategy.engine.delegate.IDelegateBridge;\n+import games.strategy.triplea.delegate.DiceRoll;\n+import games.strategy.triplea.delegate.ExecutionStack;\n+import games.strategy.triplea.delegate.battle.BattleState;\n+import games.strategy.triplea.delegate.battle.steps.BattleStep;\n+import java.util.List;\n+import java.util.function.BiFunction;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+\n+/** Step where the dice are rolled for the firing units */\n+@RequiredArgsConstructor\n+public class RollDice implements BattleStep {\n+\n+  private static final long serialVersionUID = 3248059314449726590L;\n+\n+  @Getter private final BattleState battleState;\n+\n+  /** The side of the firing player */\n+  @Getter private final BattleState.Side side;\n+\n+  @Getter private final FiringGroup firingGroup;\n+\n+  private final FireRoundState fireRoundState;\n+\n+  private final BiFunction<IDelegateBridge, RollDice, DiceRoll> rollDice;\n+\n+  @Override\n+  public List<String> getNames() {\n+    return List.of(getName());\n+  }\n+\n+  private String getName() {\n+    return battleState.getPlayer(side).getName()\n+        // displaying UNITS makes the text feel redundant so hide it if that is the group name\n+        + (firingGroup.getDisplayName().equals(UNITS) ? \"\" : \" \" + firingGroup.getDisplayName())\n+        + FIRE_SUFFIX;\n+  }\n+\n+  @Override\n+  public Order getOrder() {\n+    return Order.ROLL_DICE;\n+  }\n+\n+  @Override\n+  public void execute(final ExecutionStack stack, final IDelegateBridge bridge) {\n+\n+    // remove any target unit that was hit by other units\n+    firingGroup.retainAliveTargets(battleState.filterUnits(ALIVE, side.getOpposite()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be01d6f62befa45c7a13ddccbe9e2241abd97dec"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk3OTU4Ng==", "bodyText": "Is RollNormal an equivalent thing to \"RollGeneralCombat\" ?\nI wonder if we are mixing \"normal\" and \"general\" as synonymous terms.", "url": "https://github.com/triplea-game/triplea/pull/7877#discussion_r502979586", "createdAt": "2020-10-11T23:17:44Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/steps/fire/RollNormal.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package games.strategy.triplea.delegate.battle.steps.fire;\n+\n+import static games.strategy.triplea.delegate.battle.BattleState.Side.DEFENSE;\n+import static games.strategy.triplea.delegate.battle.BattleState.UnitBattleFilter.ACTIVE;\n+\n+import games.strategy.engine.delegate.IDelegateBridge;\n+import games.strategy.triplea.delegate.DiceRoll;\n+import java.util.function.BiFunction;\n+\n+/** Rolls dice for normal (basically, anything that isn't AA) dice requests */\n+public class RollNormal implements BiFunction<IDelegateBridge, RollDice, DiceRoll> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be01d6f62befa45c7a13ddccbe9e2241abd97dec"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk3OTY5Mg==", "bodyText": "side-question, any plans to refactor the rollDice API in the future? Seemingly we should be able to pass a step and bridge to it and little else. It's a bit surprising there is enough data between the 2 or 3 variables to supply the nearly dozen parameters.", "url": "https://github.com/triplea-game/triplea/pull/7877#discussion_r502979692", "createdAt": "2020-10-11T23:18:51Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/steps/fire/RollNormal.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package games.strategy.triplea.delegate.battle.steps.fire;\n+\n+import static games.strategy.triplea.delegate.battle.BattleState.Side.DEFENSE;\n+import static games.strategy.triplea.delegate.battle.BattleState.UnitBattleFilter.ACTIVE;\n+\n+import games.strategy.engine.delegate.IDelegateBridge;\n+import games.strategy.triplea.delegate.DiceRoll;\n+import java.util.function.BiFunction;\n+\n+/** Rolls dice for normal (basically, anything that isn't AA) dice requests */\n+public class RollNormal implements BiFunction<IDelegateBridge, RollDice, DiceRoll> {\n+\n+  @Override\n+  public DiceRoll apply(final IDelegateBridge bridge, final RollDice step) {\n+    return DiceRoll.rollDice(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be01d6f62befa45c7a13ddccbe9e2241abd97dec"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4fa0cea7e39fe4374ecca63008b59fa84b7daf5", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/d4fa0cea7e39fe4374ecca63008b59fa84b7daf5", "committedDate": "2020-10-12T03:38:03Z", "message": "Improve comments and enum name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48eacb60f57d1d7ee5374e293c80fdad3f163192", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/48eacb60f57d1d7ee5374e293c80fdad3f163192", "committedDate": "2020-10-12T23:17:21Z", "message": "Rename Normal Roll to RollMainDice"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2OTg2MDMw", "url": "https://github.com/triplea-game/triplea/pull/7877#pullrequestreview-506986030", "createdAt": "2020-10-12T23:59:02Z", "commit": {"oid": "48eacb60f57d1d7ee5374e293c80fdad3f163192"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3878, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}