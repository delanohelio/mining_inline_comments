{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI5NTY4MTAy", "number": 6616, "title": "Local runnable prod deployment script", "bodyText": "Unify the name of the deployment scripts in 'infrastructure'.\nAfter this update we now have:\n\nrun_ansible_vagrant\nrun_ansible_prerelease\nrun_ansible_production\nEach is similar and can be run locally. The travis scripts\nare now updated to set up any preconditions, notably copying\nthe ansible vault secret variable to a vault file and then\nkicking off the respective 'run_ansible' script.\n\n\nFunctional Changes\n\n[] New map or map update\n[] New Feature\n[] Feature update or enhancement\n[] Feature Removal\n[x] Code Cleanup or refactor\n[] Configuration Change\n[] Problem fix:  \n[] Other:   \nTesting\n\n\n\n\nAdditional Review Notes\nThe only thing new in infrastructure/run_ansible_production is the check that the vault file exists. The rest of the script is migrated from the travis run script.", "createdAt": "2020-06-07T00:49:17Z", "url": "https://github.com/triplea-game/triplea/pull/6616", "merged": true, "mergeCommit": {"oid": "2cf1bd00a8d6e2ce1dc455e18f4e731784e43c2e"}, "closed": true, "closedAt": "2020-06-07T15:48:53Z", "author": {"login": "DanVanAtta"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcow98GgH2gAyNDI5NTY4MTAyOmMwNTkyZWJjZWE0ZGM4NTVhZWIzZTE4ODQ4YWUxMDFlNTFkNjJkMmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcozBCugH2gAyNDI5NTY4MTAyOmJlN2M1NzgzNzlkZGE2OTkyZjM0YTUwYzVkYWEyMThhMDRhOGFkNzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c0592ebcea4dc855aeb3e18848ae101e51d62d2a", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/c0592ebcea4dc855aeb3e18848ae101e51d62d2a", "committedDate": "2020-06-07T00:46:09Z", "message": "Locally runnable prod deployment script\n\nUnify the name of the deployment scripts in 'infrastructure'.\nAfter this update we now have:\n  - run_ansible_vagrant\n  - run_ansible_prerelease\n  - run_ansible_production\nEach is similar and can be run locally. The travis scripts\nare now updated to set up any preconditions, notably copying\nthe ansible vault secret variable to a vault file and then\nkicking off the respective 'run_ansible' script."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26ebb804e3a006e1da0e3d1fcb3f17255c8d2172", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/26ebb804e3a006e1da0e3d1fcb3f17255c8d2172", "committedDate": "2020-06-07T02:37:17Z", "message": "Allow parameters to be passed to the run_ansible_production_script\n\nEG: to run with tags, `./run_ansible_production -t certbot` to execute\nonly the certbot role."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NzgyNDUx", "url": "https://github.com/triplea-game/triplea/pull/6616#pullrequestreview-425782451", "createdAt": "2020-06-07T02:39:31Z", "commit": {"oid": "26ebb804e3a006e1da0e3d1fcb3f17255c8d2172"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wN1QwMjozOTozMVrOGgGxaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wN1QwMjozOTozMVrOGgGxaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMxODU3MQ==", "bodyText": "Double quote array expansions to avoid re-splitting elements.", "url": "https://github.com/triplea-game/triplea/pull/6616#discussion_r436318571", "createdAt": "2020-06-07T02:39:31Z", "author": {"login": "codeclimate"}, "path": "infrastructure/run_ansible_production", "diffHunk": "@@ -0,0 +1,30 @@\n+#!/bin/bash\n+\n+set -eEu\n+\n+if [ ! -f \"vault_password\" ]; then\n+  echo \"Error: vault_password file must exist at $(pwd)\"\n+  exit 1\n+fi\n+\n+# Start up ssh-agent\n+eval \"$(ssh-agent -s)\"\n+\n+# Decrypt SSH key and add it to ssh agent\n+# Once available to SSH agent, when making SSH connections\n+# this key will be offered by SSH for authentication.\n+# This allows ansible to SSH to target servers and run\n+# deployment commands. We assume servers have been created\n+# with the corresponding public key already installed.\n+ansible-vault view \\\n+    --vault-password-file=vault_password \\\n+    ansible_ssh_key.ed25519 \\\n+  | ssh-add -\n+\n+# Run deployment\n+ansible-playbook \\\n+    --vault-password-file vault_password \\\n+    $@ \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26ebb804e3a006e1da0e3d1fcb3f17255c8d2172"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NzgzMTE1", "url": "https://github.com/triplea-game/triplea/pull/6616#pullrequestreview-425783115", "createdAt": "2020-06-07T02:57:40Z", "commit": {"oid": "26ebb804e3a006e1da0e3d1fcb3f17255c8d2172"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be7c578379dda6992f34a50c5daa218a04a8ad70", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/be7c578379dda6992f34a50c5daa218a04a8ad70", "committedDate": "2020-06-07T03:09:21Z", "message": "Add double quotes to avoid element re-splitting (Fix shellcheck)"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3361, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}