{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA5MDAxNjkw", "number": 6334, "title": "Upload lobby game chat messages to lobby & store in DB", "bodyText": "Adds a table to store lobby game chat messages\nAdds a DAO to insert those messages\nAdds an upload module that will verify a given api-key and game-id\nare valid on each upload request, if so we insert a chat message\nAdds an endpoint controller to receive upload requests\nAdds a new http client to upload chat messages to the upload endpoint.\nUpdates ServerModel to chec if we have a game-to-lobby-connection, if\nso then we add a new chat listener that will use a background thread\nto upload messages to lobby\n\n\nFunctional Changes\n\n[] New map or map update\n[] New Feature\n[x] Feature update or enhancement\n[] Feature Removal\n[] Code Cleanup or refactor\n[] Configuration Change\n[] Problem fix:  \n[] Other:   \nTesting\n\nlaunched a local lobby\n\nhosted a game on that lobby, verified chat messages are uploaded into database\ndisconnected lobby, verified that failure to upload errors were silently handled (though we do print an info message about the failure)\n\n\nconnected a bot to a local lobby, joined, and verified messages are uploaded into database\nhosted a local network game, verified that it does not try to upload messages\n\nI did notice on the disconnect case we retry a number of times to do the upload. I think we'll want to follow up and tune the retry conditions and how many we do. Perhaps to just a single retry after a fixed back-off.", "createdAt": "2020-04-26T02:11:47Z", "url": "https://github.com/triplea-game/triplea/pull/6334", "merged": true, "mergeCommit": {"oid": "9ee2d1b298eb8e5031098f9ae8f0aad55263feb8"}, "closed": true, "closedAt": "2020-04-28T00:25:16Z", "author": {"login": "DanVanAtta"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcbRAiwgH2gAyNDA5MDAxNjkwOjkxN2JjN2FkODU0NGQxYjEwZTRlNmI3YWE5ZjQ1ZTA2NGUyNzQ2ZWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcb4UABAFqTQwMTQwNDU5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "917bc7ad8544d1b10e4e6b7aa9f45e064e2746ed", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/917bc7ad8544d1b10e4e6b7aa9f45e064e2746ed", "committedDate": "2020-04-26T02:11:01Z", "message": "Upload lobby game chat messages to lobby & store in DB\n\n- Adds a table to store lobby game chat messages\n- Adds a DAO to insert those messages\n- Adds an upload module that will verify a given api-key and game-id\n  are valid on each upload request, if so we insert a chat message\n- Adds an endpoint controller to receive upload requests\n- Adds a new http client to upload chat messages to the upload endpoint.\n- Updates ServerModel to chec if we have a game-to-lobby-connection, if\n  so then we add a new chat listener that will use a background thread\n  to upload messages to lobby"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNDQ5MjYy", "url": "https://github.com/triplea-game/triplea/pull/6334#pullrequestreview-400449262", "createdAt": "2020-04-26T02:13:20Z", "commit": {"oid": "917bc7ad8544d1b10e4e6b7aa9f45e064e2746ed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNlQwMjoxMzoyMFrOGL9SMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNlQwMjoxMzoyMFrOGL9SMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE5MTYwMw==", "bodyText": "Similar blocks of code found in 2 locations. Consider refactoring.", "url": "https://github.com/triplea-game/triplea/pull/6334#discussion_r415191603", "createdAt": "2020-04-26T02:13:20Z", "author": {"login": "codeclimate"}, "path": "http-clients/src/main/java/org/triplea/http/client/lobby/chat/upload/ChatMessageUpload.java", "diffHunk": "@@ -0,0 +1,21 @@\n+package org.triplea.http.client.lobby.chat.upload;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "917bc7ad8544d1b10e4e6b7aa9f45e064e2746ed"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3150d7cd0b73cdd4aea9187d0374174ee97d45a1", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/3150d7cd0b73cdd4aea9187d0374174ee97d45a1", "committedDate": "2020-04-26T20:19:29Z", "message": "Change DB tables to have lobby_game, game_chat_history & game_chat_history with FKs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e7cd9d105ed28e831b8a335bc451712084a9dcf", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/3e7cd9d105ed28e831b8a335bc451712084a9dcf", "committedDate": "2020-04-26T21:44:29Z", "message": "Rename class: GameChatHistoryDao->LobbyGameDao"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "363b24eca250becae3307efe0148b667f729c1fd", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/363b24eca250becae3307efe0148b667f729c1fd", "committedDate": "2020-04-26T21:55:34Z", "message": "Update chat upload DAO to lookup FK into lobby_games table."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f773049a8aa192892a84d487f3a1af8ba67782c0", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/f773049a8aa192892a84d487f3a1af8ba67782c0", "committedDate": "2020-04-26T22:09:34Z", "message": "Merge chat upload into lobby watcher and rename packages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "429f6255b44a4f028fb46abd25a18c3f783db8e1", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/429f6255b44a4f028fb46abd25a18c3f783db8e1", "committedDate": "2020-04-26T22:36:32Z", "message": "Verify chat insert row count - organize packages splitting game listing and lobby watcher"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b3a9e7b90e44b87f0c1286089a3a734c5995f25", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/7b3a9e7b90e44b87f0c1286089a3a734c5995f25", "committedDate": "2020-04-26T23:56:47Z", "message": "Add insert lobby game DAO code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac744c31e3e6ee5d8baa79750c3c517b14a0e7cb", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/ac744c31e3e6ee5d8baa79750c3c517b14a0e7cb", "committedDate": "2020-04-26T23:59:07Z", "message": "Merge remote-tracking branch 'origin/master' into game-chat-upload"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d25610f533078c94a3a616796913a70dea275e40", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/d25610f533078c94a3a616796913a70dea275e40", "committedDate": "2020-04-27T00:15:55Z", "message": "Insert lobby_game database record when game is posted"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5c332624ced8fd74ffc0468d22c3dade9192521", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/f5c332624ced8fd74ffc0468d22c3dade9192521", "committedDate": "2020-04-27T00:20:46Z", "message": "wip"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5682ac7239b863a2f957f5c296e037bd100ef50", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/d5682ac7239b863a2f957f5c296e037bd100ef50", "committedDate": "2020-04-27T01:00:32Z", "message": "Fix up tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9aca655016bba5c6d43e51b72dd71efea0029c33", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/9aca655016bba5c6d43e51b72dd71efea0029c33", "committedDate": "2020-04-27T01:05:34Z", "message": "Update new table SQL, add comments and indexes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e428cb27bef505146343b2826cefc2579dff66f", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/8e428cb27bef505146343b2826cefc2579dff66f", "committedDate": "2020-04-27T02:29:48Z", "message": "Fix sql"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNDA0NTk1", "url": "https://github.com/triplea-game/triplea/pull/6334#pullrequestreview-401404595", "createdAt": "2020-04-27T23:49:30Z", "commit": {"oid": "8e428cb27bef505146343b2826cefc2579dff66f"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMzo0OTozMVrOGM8bNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMzo1ODozMFrOGM8odA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyNjEwMA==", "bodyText": "Ok this formatting confused me for a second", "url": "https://github.com/triplea-game/triplea/pull/6334#discussion_r416226100", "createdAt": "2020-04-27T23:49:31Z", "author": {"login": "RoiEXLab"}, "path": "http-server/src/main/java/org/triplea/db/dao/lobby/games/LobbyGameDao.java", "diffHunk": "@@ -0,0 +1,60 @@\n+package org.triplea.db.dao.lobby.games;\n+\n+import com.google.common.base.Ascii;\n+import org.jdbi.v3.sqlobject.customizer.Bind;\n+import org.jdbi.v3.sqlobject.statement.SqlUpdate;\n+import org.triplea.db.dao.api.key.ApiKeyHasher;\n+import org.triplea.domain.data.ApiKey;\n+import org.triplea.http.client.lobby.game.lobby.watcher.ChatMessageUpload;\n+import org.triplea.http.client.lobby.game.lobby.watcher.LobbyGameListing;\n+import org.triplea.java.Postconditions;\n+\n+/**\n+ * Game chat history table stores chat messages that have happened in games. This data is upload by\n+ * game servers to the lobby and is then recorded in database.\n+ */\n+public interface LobbyGameDao {\n+  int MESSAGE_COLUMN_LENGTH = 240;\n+\n+  default void insertLobbyGame(ApiKey apiKey, LobbyGameListing lobbyGameListing) {\n+    final String hashedkey = new ApiKeyHasher().apply(apiKey);\n+    final int insertCount =\n+        insertLobbyGame(\n+            lobbyGameListing.getLobbyGame().getHostName(), //\n+            lobbyGameListing.getGameId(),\n+            hashedkey);\n+    Postconditions.assertState(\n+        insertCount == 1, \"Failed to insert lobby game: \" + lobbyGameListing);\n+  }\n+\n+  @SqlUpdate(\n+      \"insert into lobby_game(host_name, game_id, game_hosting_api_key_id) \"\n+          + \"values (\"\n+          + \"  :hostName,\"\n+          + \"  :gameId,\"\n+          + \"  (select id from game_hosting_api_key where key = :apiKey))\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e428cb27bef505146343b2826cefc2579dff66f"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyNjU5NQ==", "bodyText": "Is this to check if (select id from game_hosting_api_key where key = :apiKey) did actually return a single entry?\nMight be worth adding a comment to explain this.\nI don't think any other place in the code actually checks the insert count", "url": "https://github.com/triplea-game/triplea/pull/6334#discussion_r416226595", "createdAt": "2020-04-27T23:50:51Z", "author": {"login": "RoiEXLab"}, "path": "http-server/src/main/java/org/triplea/db/dao/lobby/games/LobbyGameDao.java", "diffHunk": "@@ -0,0 +1,60 @@\n+package org.triplea.db.dao.lobby.games;\n+\n+import com.google.common.base.Ascii;\n+import org.jdbi.v3.sqlobject.customizer.Bind;\n+import org.jdbi.v3.sqlobject.statement.SqlUpdate;\n+import org.triplea.db.dao.api.key.ApiKeyHasher;\n+import org.triplea.domain.data.ApiKey;\n+import org.triplea.http.client.lobby.game.lobby.watcher.ChatMessageUpload;\n+import org.triplea.http.client.lobby.game.lobby.watcher.LobbyGameListing;\n+import org.triplea.java.Postconditions;\n+\n+/**\n+ * Game chat history table stores chat messages that have happened in games. This data is upload by\n+ * game servers to the lobby and is then recorded in database.\n+ */\n+public interface LobbyGameDao {\n+  int MESSAGE_COLUMN_LENGTH = 240;\n+\n+  default void insertLobbyGame(ApiKey apiKey, LobbyGameListing lobbyGameListing) {\n+    final String hashedkey = new ApiKeyHasher().apply(apiKey);\n+    final int insertCount =\n+        insertLobbyGame(\n+            lobbyGameListing.getLobbyGame().getHostName(), //\n+            lobbyGameListing.getGameId(),\n+            hashedkey);\n+    Postconditions.assertState(\n+        insertCount == 1, \"Failed to insert lobby game: \" + lobbyGameListing);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e428cb27bef505146343b2826cefc2579dff66f"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyOTQ5Mg==", "bodyText": "I just noticed that the return value is used to potentially display  a warning message.\nWhy did you decide it's better to do the warning outside?", "url": "https://github.com/triplea-game/triplea/pull/6334#discussion_r416229492", "createdAt": "2020-04-27T23:58:30Z", "author": {"login": "RoiEXLab"}, "path": "http-server/src/main/java/org/triplea/modules/game/lobby/watcher/ChatUploadModule.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package org.triplea.modules.game.lobby.watcher;\n+\n+import java.util.function.BiPredicate;\n+import lombok.AllArgsConstructor;\n+import org.jdbi.v3.core.Jdbi;\n+import org.triplea.db.dao.lobby.games.LobbyGameDao;\n+import org.triplea.domain.data.ApiKey;\n+import org.triplea.http.client.lobby.game.lobby.watcher.ChatMessageUpload;\n+import org.triplea.modules.game.listing.GameListing;\n+\n+/**\n+ * Responsible for inserting chat messages into database. Validates that a given request has a\n+ * matching game-id and api-key pair, otherwise does a no-op. We need to be sure to validate an\n+ * API-key and game-id match otherwise an attacker with an http client could try to insert incorrect\n+ * data, game-id's are publicly known, but API-keys are not. Only the actual host should know the\n+ * api-key.\n+ *\n+ * <p>If the ID and API-Key pair are not valid, we will just drop the request and return a 200 If we\n+ * return a 400 or some other error, we'll give a potential attacker a way to try and guess\n+ * API-Keys.\n+ */\n+@AllArgsConstructor\n+class ChatUploadModule {\n+  private final LobbyGameDao lobbyGameDao;\n+  private final BiPredicate<ApiKey, String> gameIdValidator;\n+\n+  static ChatUploadModule build(final Jdbi jdbi, final GameListing gameListing) {\n+    return new ChatUploadModule(\n+        jdbi.onDemand(LobbyGameDao.class), gameListing::isValidApiKeyAndGameId);\n+  }\n+\n+  public boolean upload(final ChatMessageUpload chatMessageUpload) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e428cb27bef505146343b2826cefc2579dff66f"}, "originalPosition": 32}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3527, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}