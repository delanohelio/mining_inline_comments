{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg2MjIyMzgz", "number": 7640, "title": "Convert suicide casualties steps", "bodyText": "Testing\n\nLoaded old saves to verify save compatibility.  Played TWW with rockets to verify suicide units are still removed.\nScreens Shots\n\nAdditional Notes to Reviewer\n\nRelease Note", "createdAt": "2020-09-13T18:41:41Z", "url": "https://github.com/triplea-game/triplea/pull/7640", "merged": true, "mergeCommit": {"oid": "aff261b2a3807833b4ea4f752fd88ddcf40a36c4"}, "closed": true, "closedAt": "2020-09-13T21:53:37Z", "author": {"login": "trevan"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdIVSkVgH2gAyNDg2MjIyMzgzOjJjNjZkMjI2ZjY0NzVhNjRiZjM2NDE3ZTQ4MmE5YzdlMzkwZGI3M2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdIlNNsgH2gAyNDg2MjIyMzgzOmI5N2FkOGZiN2NjNWM2Nzc1YjQzMmQ1MDc0YjZlNDg3MzAxMDQ3NzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2c66d226f6475a64bf36417e482a9c7e390db73d", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/2c66d226f6475a64bf36417e482a9c7e390db73d", "committedDate": "2020-09-13T02:36:55Z", "message": "Convert suicide casualties steps"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MzM1MzY4", "url": "https://github.com/triplea-game/triplea/pull/7640#pullrequestreview-487335368", "createdAt": "2020-09-13T19:56:46Z", "commit": {"oid": "2c66d226f6475a64bf36417e482a9c7e390db73d"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QxOTo1Njo0NlrOHQ-8uQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QyMDowNDoyMFrOHQ-_kA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU3MDYxNw==", "bodyText": "Can we get this to be a String return value? Alternatively a domain-data object BattleId that wraps the type as a string?\nThese IDs used to be GUIDs which was a bit overly specified and creates difficult in test. IMO the battle id type is truly a string or a value object for battle-id, it just so happens to be generated via a UUID (so that's an implementation detail).", "url": "https://github.com/triplea-game/triplea/pull/7640#discussion_r487570617", "createdAt": "2020-09-13T19:56:46Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/BattleState.java", "diffHunk": "@@ -23,6 +24,8 @@ public Side getOpposite() {\n \n   Territory getBattleSite();\n \n+  UUID getBattleId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c66d226f6475a64bf36417e482a9c7e390db73d"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU3MDc3NA==", "bodyText": "Sorry for not checking this myself, could you verify if this can be demoted to 'default visibility'? Reducing scoping within a package is a very good thing. In part we have a coupling problem as most everything is raised to public and can see everything else (so there is a very weak module structure).", "url": "https://github.com/triplea-game/triplea/pull/7640#discussion_r487570774", "createdAt": "2020-09-13T19:58:54Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/steps/change/suicide/RemoveUnits.java", "diffHunk": "@@ -0,0 +1,61 @@\n+package games.strategy.triplea.delegate.battle.steps.change.suicide;\n+\n+import games.strategy.engine.data.Unit;\n+import games.strategy.engine.delegate.IDelegateBridge;\n+import games.strategy.triplea.delegate.Matches;\n+import games.strategy.triplea.delegate.battle.BattleActions;\n+import games.strategy.triplea.delegate.battle.BattleState;\n+import games.strategy.triplea.delegate.battle.steps.BattleStep;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Predicate;\n+import lombok.AllArgsConstructor;\n+import org.triplea.java.collections.CollectionUtils;\n+\n+@AllArgsConstructor\n+public abstract class RemoveUnits implements BattleStep {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c66d226f6475a64bf36417e482a9c7e390db73d"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU3MDg4OA==", "bodyText": "nit, would suicideAttackers be a bit more specified? 'deadAttackers' to be implies we are matching attackers that have already been taken as casualties and are no longer participating in the battle (IE: they were removed in a previous battle step round already).", "url": "https://github.com/triplea-game/triplea/pull/7640#discussion_r487570888", "createdAt": "2020-09-13T19:59:55Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/steps/change/suicide/RemoveUnits.java", "diffHunk": "@@ -0,0 +1,61 @@\n+package games.strategy.triplea.delegate.battle.steps.change.suicide;\n+\n+import games.strategy.engine.data.Unit;\n+import games.strategy.engine.delegate.IDelegateBridge;\n+import games.strategy.triplea.delegate.Matches;\n+import games.strategy.triplea.delegate.battle.BattleActions;\n+import games.strategy.triplea.delegate.battle.BattleState;\n+import games.strategy.triplea.delegate.battle.steps.BattleStep;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Predicate;\n+import lombok.AllArgsConstructor;\n+import org.triplea.java.collections.CollectionUtils;\n+\n+@AllArgsConstructor\n+public abstract class RemoveUnits implements BattleStep {\n+  private static final long serialVersionUID = 1322821208196377684L;\n+\n+  private final BattleState battleState;\n+\n+  private final BattleActions battleActions;\n+\n+  protected void removeUnits(final IDelegateBridge bridge, final Predicate<Unit> unitMatch) {\n+    final Collection<Unit> deadAttackers =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c66d226f6475a64bf36417e482a9c7e390db73d"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU3MTM0NA==", "bodyText": "I think we should convert battleActions to be a callback instead. That would remove the side effects.  So instead of having a BattleActions we would have a Consumer<Collection<Unit>> that would be a callback to do the removal. This would make it a bit more clear from the caller how the battle actions parameter is mutated. Otherwise, it's a bit difficult to follow to realize that we're storing a reference and are modifying the caller by modifying a reference passed to us here. If that is the case, then the abstraction of this class is arguably not that helpful, you still have to understand this entire class and its side effects to understand the caller, which loses all information hiding.", "url": "https://github.com/triplea-game/triplea/pull/7640#discussion_r487571344", "createdAt": "2020-09-13T20:04:20Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/steps/change/suicide/RemoveUnits.java", "diffHunk": "@@ -0,0 +1,61 @@\n+package games.strategy.triplea.delegate.battle.steps.change.suicide;\n+\n+import games.strategy.engine.data.Unit;\n+import games.strategy.engine.delegate.IDelegateBridge;\n+import games.strategy.triplea.delegate.Matches;\n+import games.strategy.triplea.delegate.battle.BattleActions;\n+import games.strategy.triplea.delegate.battle.BattleState;\n+import games.strategy.triplea.delegate.battle.steps.BattleStep;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Predicate;\n+import lombok.AllArgsConstructor;\n+import org.triplea.java.collections.CollectionUtils;\n+\n+@AllArgsConstructor\n+public abstract class RemoveUnits implements BattleStep {\n+  private static final long serialVersionUID = 1322821208196377684L;\n+\n+  private final BattleState battleState;\n+\n+  private final BattleActions battleActions;\n+\n+  protected void removeUnits(final IDelegateBridge bridge, final Predicate<Unit> unitMatch) {\n+    final Collection<Unit> deadAttackers =\n+        CollectionUtils.getMatches(\n+            battleState.getUnits(BattleState.Side.OFFENSE),\n+            unitMatch.and(Matches.unitIsSuicideOnAttack()));\n+    final Collection<Unit> deadDefenders =\n+        CollectionUtils.getMatches(\n+            battleState.getUnits(BattleState.Side.DEFENSE),\n+            unitMatch.and(Matches.unitIsSuicideOnDefense()));\n+    bridge\n+        .getDisplayChannelBroadcaster()\n+        .deadUnitNotification(\n+            battleState.getBattleId(),\n+            battleState.getAttacker(),\n+            deadAttackers,\n+            getDependents(deadAttackers));\n+    bridge\n+        .getDisplayChannelBroadcaster()\n+        .deadUnitNotification(\n+            battleState.getBattleId(),\n+            battleState.getDefender(),\n+            deadDefenders,\n+            getDependents(deadDefenders));\n+    final List<Unit> deadUnits = new ArrayList<>(deadAttackers);\n+    deadUnits.addAll(deadDefenders);\n+    battleActions.remove(deadUnits, bridge, battleState.getBattleSite(), null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c66d226f6475a64bf36417e482a9c7e390db73d"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b97ad8fb7cc5c6775b432d5074b6e48730104772", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/b97ad8fb7cc5c6775b432d5074b6e48730104772", "committedDate": "2020-09-13T21:09:33Z", "message": "Review feedback"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3916, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}