{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMwNzAxOTY2", "number": 6641, "title": "Improve deploy prerelease script", "bodyText": "Here we combine the run_prerelease script with the build_deployment artifact script. This is the first commit.\nSecond, we organize the run_prerelease script to be grouped by functions.\nOf note, the previous script asserted that files existed in the expected location in the ansible folder structure. Now the script asserts that the expected built files exist in the post-build location. We then use a function to copy those files into the ansible folder structure where they are then used for deployment.\n\nFunctional Changes\n\n[] New map or map update\n[] New Feature\n[] Feature update or enhancement\n[] Feature Removal\n[x] Code Cleanup or refactor\n[] Configuration Change\n[] Problem fix:  \n[] Other:   \nTesting", "createdAt": "2020-06-08T04:28:30Z", "url": "https://github.com/triplea-game/triplea/pull/6641", "merged": true, "mergeCommit": {"oid": "b6fb8ce0abeda1999d56110a2b9f4e981af33ab8"}, "closed": true, "closedAt": "2020-06-08T11:08:10Z", "author": {"login": "DanVanAtta"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpIqSAAH2gAyNDMwNzAxOTY2OmRiNDRhZTY5MzEyZjBiODI4NzgzZjY2ODY5NDFiZWFjOTEyYzk3ODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpOdplAFqTQyNjEyNjMzNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "db44ae69312f0b828783f6686941beac912c9786", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/db44ae69312f0b828783f6686941beac912c9786", "committedDate": "2020-06-08T04:22:24Z", "message": "Combine build_deployment_artifacts script with run_ansible_prerelease"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3df516da72a2ccd18366d96ce70569acd0a484ef", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/3df516da72a2ccd18366d96ce70569acd0a484ef", "committedDate": "2020-06-08T04:26:11Z", "message": "Group run_ansible_prerelease script tasks into functions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1OTA5MjM5", "url": "https://github.com/triplea-game/triplea/pull/6641#pullrequestreview-425909239", "createdAt": "2020-06-08T04:30:52Z", "commit": {"oid": "3df516da72a2ccd18366d96ce70569acd0a484ef"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwNDozMDo1MlrOGgO6dA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwNDozMDo1M1rOGgO6dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ1MTk1Ng==", "bodyText": "Use runDeployment \"$@\" if function's $1 should mean script's $1.", "url": "https://github.com/triplea-game/triplea/pull/6641#discussion_r436451956", "createdAt": "2020-06-08T04:30:52Z", "author": {"login": "codeclimate"}, "path": "infrastructure/run_ansible_prerelease", "diffHunk": "@@ -28,28 +28,45 @@ if [ ! -f \"$VAULT_PASSWORD_FILE\" ]; then\n   exit 1\n fi\n \n-HTTP_SERVER_JAR=\"ansible/roles/http_server/files/triplea-http-server-$VERSION.jar\"\n-if [ ! -f \"$HTTP_SERVER_JAR\" ]; then\n-  echo \"Error: File does not exist: $HTTP_SERVER_JAR\"\n-  exit 1\n-fi\n \n-BOT_JAR=\"ansible/roles/bot/files/triplea-game-headless-$VERSION.jar\"\n-if [ ! -f \"$BOT_JAR\" ]; then\n-  echo \"Error: File does not exist: $BOT_JAR\"\n-  exit 1\n-fi\n+function main() {\n+  buildArtifacts\n+  addPrivateSshKeyToAgent\n+  runDeployment", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3df516da72a2ccd18366d96ce70569acd0a484ef"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ1MTk1OA==", "bodyText": "runDeployment references arguments, but none are ever passed.", "url": "https://github.com/triplea-game/triplea/pull/6641#discussion_r436451958", "createdAt": "2020-06-08T04:30:53Z", "author": {"login": "codeclimate"}, "path": "infrastructure/run_ansible_prerelease", "diffHunk": "@@ -28,28 +28,45 @@ if [ ! -f \"$VAULT_PASSWORD_FILE\" ]; then\n   exit 1\n fi\n \n-HTTP_SERVER_JAR=\"ansible/roles/http_server/files/triplea-http-server-$VERSION.jar\"\n-if [ ! -f \"$HTTP_SERVER_JAR\" ]; then\n-  echo \"Error: File does not exist: $HTTP_SERVER_JAR\"\n-  exit 1\n-fi\n \n-BOT_JAR=\"ansible/roles/bot/files/triplea-game-headless-$VERSION.jar\"\n-if [ ! -f \"$BOT_JAR\" ]; then\n-  echo \"Error: File does not exist: $BOT_JAR\"\n-  exit 1\n-fi\n+function main() {\n+  buildArtifacts\n+  addPrivateSshKeyToAgent\n+  runDeployment\n+}\n \n-MIGRATIONS_ZIP=\"ansible/roles/flyway/files/migrations.zip\"\n-if [ ! -f \"$MIGRATIONS_ZIP\" ]; then\n-  echo \"Error: File does not exist: $MIGRATIONS_ZIP\"\n-  exit 1\n-fi\n+function buildArtifacts() {\n+  ../gradlew :http-server:shadowJar :game-headless:shadowJar :lobby-db:release\n+  copyBuildArtifact \"../lobby-db/build/artifacts/migrations.zip\" \"ansible/roles/database/flyway/files/\"\n+  copyBuildArtifact \"../http-server/build/artifacts/triplea-http-server-$VERSION.jar\" \"ansible/roles/http_server/files/\"\n+  copyBuildArtifact \"../game-headless/build/artifacts/triplea-game-headless-$VERSION.jar\" \"ansible/roles/bot/files/\"\n+}\n+\n+function copyBuildArtifact() {\n+  local -r artifactSource=\"$1\"\n+  local -r artifactDestinationPath=\"$2\"\n+\n+  if [ ! -f \"$artifactSource\" ]; then\n+    echo \"Error: File does not exist: $artifactSource\"\n+    exit 1\n+  fi\n+\n+  mkdir -p \"$artifactDestinationPath\"\n+  cp \"$artifactSource\" \"$artifactDestinationPath\"\n+}\n+\n+\n+function addPrivateSshKeyToAgent() {\n+  ansible-vault view --vault-password-file=\"$VAULT_PASSWORD_FILE\" ansible_ssh_key.ed25519 | ssh-add -\n+}\n+\n+function runDeployment() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3df516da72a2ccd18366d96ce70569acd0a484ef"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8dfef50e1b42acfe6596607479cf54b756346bcc", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/8dfef50e1b42acfe6596607479cf54b756346bcc", "committedDate": "2020-06-08T04:37:30Z", "message": "Pass script args to 'main'"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MTI2MzM0", "url": "https://github.com/triplea-game/triplea/pull/6641#pullrequestreview-426126334", "createdAt": "2020-06-08T11:08:02Z", "commit": {"oid": "8dfef50e1b42acfe6596607479cf54b756346bcc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3364, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}