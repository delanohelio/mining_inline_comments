{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyODIwODM4", "number": 6236, "title": "Add distinct callback for websocket terminated", "bodyText": "Currently we have only one callback whenever a websocket\nis closed. This update creates a distinction between\nwhen a websocket is 'terminated' (closed by server)\nvs 'closed' (standard close by client).\nThe 'closed' callback remains just a runnable and continues\nto be just for client side cleanup. The 'terminated' callback\nis invoked with the disconnect error reason, which for the\ncase of bans will be the ban message from the server.\nIf the server gives no message, then we default that message\nto a generic \"the server disconnected\" message.\nAfter this update users are given a notification when they\nare disconnected due to ban, before they were given no notification.\n\nFunctional Changes\n\n[] New map or map update\n[] New Feature\n[] Feature update or enhancement\n[] Feature Removal\n[] Code Cleanup or refactor\n[] Configuration Change\n[x] Problem fix: #6222 \n[] Other:   \nTesting\n\nverified before there was no message when a user is banned\nverified when banned there is a disconnect message\nverified when server is shutdown there is a disconnect message\nverified leaving lobby (normal disconnect) does not yield a disconnect message\n\n\n\nScreens Shots\nMessage when disconnected due to ban:\n\nMessage when disconnected due to server shutdown:", "createdAt": "2020-04-13T20:18:27Z", "url": "https://github.com/triplea-game/triplea/pull/6236", "merged": true, "mergeCommit": {"oid": "e945564cc1917172d86c5e471154faca257f5a4c"}, "closed": true, "closedAt": "2020-04-14T00:51:50Z", "author": {"login": "DanVanAtta"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXUnooAH2gAyNDAyODIwODM4OjYxYzIwNGUyMWNkN2Y2MDE5MThiOGFmYjE5MmY4NWRlMjg4ZDA1YWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXWGAqgFqTM5MjQ2NDg5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "61c204e21cd7f601918b8afb192f85de288d05ad", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/61c204e21cd7f601918b8afb192f85de288d05ad", "committedDate": "2020-04-13T20:07:44Z", "message": "Add distinct callback for websocket terminated\n\nCurrently we have only one callback whenever a websocket\nis closed. This update creates a distinction between\nwhen a websocket is 'terminated' (closed by server)\nvs 'closed' (standard close by client).\n\nThe 'closed' callback remains just a runnable and continues\nto be just for client side cleanup. The 'terminated' callback\nis invoked with the disconnect error reason, which for the\ncase of bans will be the ban message from the server.\n\nIf the server gives no message, then we default that message\nto a generic \"the server disconnected\" message.\n\nAfter this update users are given a notification when they\nare disconnected due to ban, before they were given no notification."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "475017d9315b8e9837424d4e2e3d2991524ea371", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/475017d9315b8e9837424d4e2e3d2991524ea371", "committedDate": "2020-04-13T20:25:22Z", "message": "Make playerChatId non-null\n\nAssigns a player-chat-id to chatters that are connected to java RMI\ngames. This satisfies an assumption/desire for player chat id to always\nbe non-null. For java RMI games this is not immediately helpful, players\nare still identified by their 'node' which contains IP address (security risk).\n\nWith player chat id, we have a unique, public, ID that can be used to\nrefer to players and could be used to replace 'node' as an identifier."}, "afterCommit": {"oid": "61c204e21cd7f601918b8afb192f85de288d05ad", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/61c204e21cd7f601918b8afb192f85de288d05ad", "committedDate": "2020-04-13T20:07:44Z", "message": "Add distinct callback for websocket terminated\n\nCurrently we have only one callback whenever a websocket\nis closed. This update creates a distinction between\nwhen a websocket is 'terminated' (closed by server)\nvs 'closed' (standard close by client).\n\nThe 'closed' callback remains just a runnable and continues\nto be just for client side cleanup. The 'terminated' callback\nis invoked with the disconnect error reason, which for the\ncase of bans will be the ban message from the server.\n\nIf the server gives no message, then we default that message\nto a generic \"the server disconnected\" message.\n\nAfter this update users are given a notification when they\nare disconnected due to ban, before they were given no notification."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNDY0ODkz", "url": "https://github.com/triplea-game/triplea/pull/6236#pullrequestreview-392464893", "createdAt": "2020-04-13T21:50:39Z", "commit": {"oid": "61c204e21cd7f601918b8afb192f85de288d05ad"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QyMTo1MDo0MFrOGE2m5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QyMTo1MDo0MFrOGE2m5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc0MjE4Mw==", "bodyText": "I don't know what the server side of the websocket implementation is capable of, but I think it would be a better idea to use a custom status code  for closing (it looks like codes 4000 - 4999 are reserved for application use) and make decisions based on that.", "url": "https://github.com/triplea-game/triplea/pull/6236#discussion_r407742183", "createdAt": "2020-04-13T21:50:40Z", "author": {"login": "RoiEXLab"}, "path": "http-clients/src/main/java/org/triplea/http/client/web/socket/WebSocketConnection.java", "diffHunk": "@@ -205,7 +205,11 @@ public void onOpen(final WebSocket webSocket) {\n     public CompletionStage<?> onClose(\n         final WebSocket webSocket, final int statusCode, final String reason) {\n       pingSender.cancel();\n-      listener.connectionClosed(reason);\n+      if (reason.equals(WebSocketConnection.CLIENT_DISCONNECT_MESSAGE)) {\n+        listener.connectionClosed();\n+      } else {\n+        listener.connectionTerminated(reason.isBlank() ? \"Server disconnected\" : reason);\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61c204e21cd7f601918b8afb192f85de288d05ad"}, "originalPosition": 18}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3485, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}