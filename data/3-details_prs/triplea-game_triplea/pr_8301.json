{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4Njk1NTM2", "number": 8301, "title": "Create UnitHitsChange that uses primitives", "bodyText": "The old UnitHitsChange is marked as deprecated and will stay\naround solely for loading old saves.\n\nTesting\n\nIn Global 40, fought a battle between two battleships.  Verified that the unit hit change was created correctly.\nScreens Shots\n\nAdditional Notes to Reviewer\n\nRelease Note", "createdAt": "2020-11-27T16:19:23Z", "url": "https://github.com/triplea-game/triplea/pull/8301", "merged": true, "mergeCommit": {"oid": "6ee0bb606637a21282dac8a1306cf7448b5220c7"}, "closed": true, "closedAt": "2020-11-29T00:34:04Z", "author": {"login": "trevan"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgp9F_gH2gAyNTI4Njk1NTM2OjE3MWI3NDRhMmM1YTcxZDNiM2Q1M2E4NTdiMjU3NTQyMmRhNWFlMWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhBuNjgH2gAyNTI4Njk1NTM2OjEwMGUzZmFiYTMzNDM4OWNhNzJlZTQyMWU2YWY1MzRmMmM3MTIzYTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "171b744a2c5a71d3b3d53a857b2575422da5ae1f", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/171b744a2c5a71d3b3d53a857b2575422da5ae1f", "committedDate": "2020-11-27T16:15:39Z", "message": "Create UnitHitsChange that uses primitives\n\nThe old UnitHitsChange is marked as deprecated and will stay\naround solely for loading old saves."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwMTIyNjE0", "url": "https://github.com/triplea-game/triplea/pull/8301#pullrequestreview-540122614", "createdAt": "2020-11-27T17:51:58Z", "commit": {"oid": "171b744a2c5a71d3b3d53a857b2575422da5ae1f"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxNzo1MTo1OFrOH7FbAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxODowMDo0MVrOH7FkYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTcxNjg2NQ==", "bodyText": "I think the name of this change object could be ambiguous. Notably, does this mean the number of hit points has changed on a unit, or is it the damage to the units that has changed? Second, would this be used to indicate a unit is only damaged, or is this how we determine if a unit is destroyed?\nPerhaps a more clear name would be something like UnitDamageReceivedChange. Does that make sense, can you come up with a better name? Hopefully the other questions about what the change object represents can be documented in the javadoc.", "url": "https://github.com/triplea-game/triplea/pull/8301#discussion_r531716865", "createdAt": "2020-11-27T17:51:58Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/engine/data/changefactory/units/UnitHitsChange.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package games.strategy.engine.data.changefactory.units;\n+\n+import games.strategy.engine.data.Change;\n+import games.strategy.engine.data.GameData;\n+import games.strategy.engine.data.Territory;\n+import games.strategy.engine.data.Unit;\n+import java.util.Collection;\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+import lombok.AccessLevel;\n+import lombok.AllArgsConstructor;\n+import org.triplea.java.collections.IntegerMap;\n+\n+/** A game data change that captures the damage done to a collection of units. */\n+@AllArgsConstructor(access = AccessLevel.PRIVATE)\n+public class UnitHitsChange extends Change {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "171b744a2c5a71d3b3d53a857b2575422da5ae1f"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTcxNzUxNA==", "bodyText": "Offhand, I'm not sure I'd call IntegerMap a primitive. I believe it's roots predate Java 1.5 where there was only a Map that was object to object. I've wondered if it makes sense to deprecate IntegerMap in favor of just having Map<T, Integer>", "url": "https://github.com/triplea-game/triplea/pull/8301#discussion_r531717514", "createdAt": "2020-11-27T17:54:18Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/engine/data/changefactory/units/UnitHitsChange.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package games.strategy.engine.data.changefactory.units;\n+\n+import games.strategy.engine.data.Change;\n+import games.strategy.engine.data.GameData;\n+import games.strategy.engine.data.Territory;\n+import games.strategy.engine.data.Unit;\n+import java.util.Collection;\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+import lombok.AccessLevel;\n+import lombok.AllArgsConstructor;\n+import org.triplea.java.collections.IntegerMap;\n+\n+/** A game data change that captures the damage done to a collection of units. */\n+@AllArgsConstructor(access = AccessLevel.PRIVATE)\n+public class UnitHitsChange extends Change {\n+  private static final long serialVersionUID = 2862726651812142713L;\n+\n+  private final IntegerMap<String> newHits;\n+  private final IntegerMap<String> oldHits;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "171b744a2c5a71d3b3d53a857b2575422da5ae1f"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTcxODU4NQ==", "bodyText": "If we have a save game, and the territories in the map change, are we going to be FUBAR here? Is there a way to instead find the territories from the units? In that case, we'd only need to keep track of the units.\nI don't know offhand if there is an efficient way to do the lookup of unit to territory, but I am thinking about the territory-name change case and it seems like that could be a problem here.", "url": "https://github.com/triplea-game/triplea/pull/8301#discussion_r531718585", "createdAt": "2020-11-27T17:58:03Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/engine/data/changefactory/units/UnitHitsChange.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package games.strategy.engine.data.changefactory.units;\n+\n+import games.strategy.engine.data.Change;\n+import games.strategy.engine.data.GameData;\n+import games.strategy.engine.data.Territory;\n+import games.strategy.engine.data.Unit;\n+import java.util.Collection;\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+import lombok.AccessLevel;\n+import lombok.AllArgsConstructor;\n+import org.triplea.java.collections.IntegerMap;\n+\n+/** A game data change that captures the damage done to a collection of units. */\n+@AllArgsConstructor(access = AccessLevel.PRIVATE)\n+public class UnitHitsChange extends Change {\n+  private static final long serialVersionUID = 2862726651812142713L;\n+\n+  private final IntegerMap<String> newHits;\n+  private final IntegerMap<String> oldHits;\n+  private final Collection<String> territoriesToNotify;\n+\n+  /**\n+   * @param hits The amount of hits that the unit should have. It is NOT the difference of the\n+   *     existing hits and the new hits.\n+   * @param territoriesToNotify The territories that contain all the units\n+   */\n+  public UnitHitsChange(\n+      final IntegerMap<Unit> hits, final Collection<Territory> territoriesToNotify) {\n+    this.newHits = new IntegerMap<>();\n+    this.oldHits = new IntegerMap<>();\n+    hits.entrySet()\n+        .forEach(\n+            entry -> {\n+              this.newHits.add(entry.getKey().getId().toString(), entry.getValue());\n+              this.oldHits.add(entry.getKey().getId().toString(), entry.getKey().getHits());\n+            });\n+    this.territoriesToNotify =\n+        territoriesToNotify.stream().map(Territory::getName).collect(Collectors.toList());\n+  }\n+\n+  @Override\n+  protected void perform(final GameData data) {\n+    for (final String unitId : newHits.keySet()) {\n+      final Unit unit = data.getUnits().get(UUID.fromString(unitId));\n+      unit.setHits(newHits.getInt(unitId));\n+    }\n+    for (final String territory : territoriesToNotify) {\n+      data.getMap().getTerritory(territory).notifyChanged();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "171b744a2c5a71d3b3d53a857b2575422da5ae1f"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTcxODU5Mg==", "bodyText": "A quick comment on the for loops and/or method would be valuable to give a quick summary of what is being done in this method. Would you mind adding it?\nIt could be something like // update units damage & // invoke territory change listeners", "url": "https://github.com/triplea-game/triplea/pull/8301#discussion_r531718592", "createdAt": "2020-11-27T17:58:04Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/engine/data/changefactory/units/UnitHitsChange.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package games.strategy.engine.data.changefactory.units;\n+\n+import games.strategy.engine.data.Change;\n+import games.strategy.engine.data.GameData;\n+import games.strategy.engine.data.Territory;\n+import games.strategy.engine.data.Unit;\n+import java.util.Collection;\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+import lombok.AccessLevel;\n+import lombok.AllArgsConstructor;\n+import org.triplea.java.collections.IntegerMap;\n+\n+/** A game data change that captures the damage done to a collection of units. */\n+@AllArgsConstructor(access = AccessLevel.PRIVATE)\n+public class UnitHitsChange extends Change {\n+  private static final long serialVersionUID = 2862726651812142713L;\n+\n+  private final IntegerMap<String> newHits;\n+  private final IntegerMap<String> oldHits;\n+  private final Collection<String> territoriesToNotify;\n+\n+  /**\n+   * @param hits The amount of hits that the unit should have. It is NOT the difference of the\n+   *     existing hits and the new hits.\n+   * @param territoriesToNotify The territories that contain all the units\n+   */\n+  public UnitHitsChange(\n+      final IntegerMap<Unit> hits, final Collection<Territory> territoriesToNotify) {\n+    this.newHits = new IntegerMap<>();\n+    this.oldHits = new IntegerMap<>();\n+    hits.entrySet()\n+        .forEach(\n+            entry -> {\n+              this.newHits.add(entry.getKey().getId().toString(), entry.getValue());\n+              this.oldHits.add(entry.getKey().getId().toString(), entry.getKey().getHits());\n+            });\n+    this.territoriesToNotify =\n+        territoriesToNotify.stream().map(Territory::getName).collect(Collectors.toList());\n+  }\n+\n+  @Override\n+  protected void perform(final GameData data) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "171b744a2c5a71d3b3d53a857b2575422da5ae1f"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTcxOTI2NQ==", "bodyText": "It's missing that the String represents a unit id. A quick comment like // unitId -> total damage taken could do the trick to document that. WDYT?", "url": "https://github.com/triplea-game/triplea/pull/8301#discussion_r531719265", "createdAt": "2020-11-27T18:00:41Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/engine/data/changefactory/units/UnitHitsChange.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package games.strategy.engine.data.changefactory.units;\n+\n+import games.strategy.engine.data.Change;\n+import games.strategy.engine.data.GameData;\n+import games.strategy.engine.data.Territory;\n+import games.strategy.engine.data.Unit;\n+import java.util.Collection;\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+import lombok.AccessLevel;\n+import lombok.AllArgsConstructor;\n+import org.triplea.java.collections.IntegerMap;\n+\n+/** A game data change that captures the damage done to a collection of units. */\n+@AllArgsConstructor(access = AccessLevel.PRIVATE)\n+public class UnitHitsChange extends Change {\n+  private static final long serialVersionUID = 2862726651812142713L;\n+\n+  private final IntegerMap<String> newHits;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "171b744a2c5a71d3b3d53a857b2575422da5ae1f"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "100e3faba334389ca72ee421e6af534f2c7123a3", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/100e3faba334389ca72ee421e6af534f2c7123a3", "committedDate": "2020-11-28T19:57:07Z", "message": "Rename UnitHitsChange -> UnitDamageReceivedChange\n\nAlso rename the variables to newTotalDamage and oldTotalDamage to be\nmore specific in what they hold.\n\nAdd comments to help explain parts of the code."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3785, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}