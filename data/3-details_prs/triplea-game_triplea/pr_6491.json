{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5ODg5OTMy", "number": 6491, "title": "Add lobby_user FK to access_log", "bodyText": "Overview\nLobby_user table last_login column was not being updated. This update drops that column and update access_log to have a FK column to lobby_user. We can then use the access_log table to determine last login time.\nCommits\ncommit 485d743\nUpdate access_log table, replace registered column with FK to lobby_user\n\nInstead of adding a 'true/false' value to a registered column\nin access_log, we can use a nullable foreign key to the lobby_user\ntable. We'll insert a null FK value if the user is anonymous,\notherwise we'll insert into the access_log table their lobby_user.id\n\ncommit 3df952b\nDrop last_login from lobby_user and replace with access_log.access_time\n\n- The value in lobby_user is buggy and is not being updated.\n- Access log table now has a FK to the lobby_user table which\n  give us the last login time. To know the last login time of a user\n  we can join lobby_user with access_log and select the max\n  access_time to know their last login.\n\n\nFunctional Changes\n\n[] New map or map update\n[] New Feature\n[] Feature update or enhancement\n[] Feature Removal\n[] Code Cleanup or refactor\n[] Configuration Change\n[x] Problem fix: #6453 \"moderator last access is missing in toolbox\"\n[] Other:   \nTesting\n\nverified in a local lobby\nautomated test coverage is good\n\n\n\nScreens Shots\nBefore\n\nAfter\n(Notice 'last_login' is now populated)", "createdAt": "2020-05-19T05:39:28Z", "url": "https://github.com/triplea-game/triplea/pull/6491", "merged": true, "mergeCommit": {"oid": "a7e79b945cd9ee91736ef1d72e960249252591bf"}, "closed": true, "closedAt": "2020-05-20T00:45:39Z", "author": {"login": "DanVanAtta"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcitSFHgH2gAyNDE5ODg5OTMyOjQ4NWQ3NDMzNTgzNzA2MTY2Yzc1OTgxM2Y0ZTQ0Mjg5MDBjMDhhZmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABci6bNJgFqTQxNDc5NDU2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "485d7433583706166c759813f4e4428900c08aff", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/485d7433583706166c759813f4e4428900c08aff", "committedDate": "2020-05-19T05:04:59Z", "message": "Update access_log table, replace registered column with FK to lobby_user\n\nInstead of adding a 'true/false' value to a registered column\nin access_log, we can use a nullable foreign key to the lobby_user\ntable. We'll insert a null FK value if the user is anonymous,\notherwise we'll insert into the access_log table their lobby_user.id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3df952b9a5e2837300e1dacb9084dca081f875f8", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/3df952b9a5e2837300e1dacb9084dca081f875f8", "committedDate": "2020-05-19T05:31:38Z", "message": "Drop last_login from lobby_user and replace with access_log.access_time\n\n- The value in lobby_user is buggy and is not being updated.\n- Access log table now has a FK to the lobby_user table which\n  give us the last login time. To know the last login time of a user\n  we can join lobby_user with access_log and select the max\n  access_time to know their last login."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebc7ef96421fb7fc1210faa76ab7793100848bc5", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/ebc7ef96421fb7fc1210faa76ab7793100848bc5", "committedDate": "2020-05-19T06:03:04Z", "message": "Update AccessLogDao.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0MTI0Njg2", "url": "https://github.com/triplea-game/triplea/pull/6491#pullrequestreview-414124686", "createdAt": "2020-05-19T06:03:39Z", "commit": {"oid": "ebc7ef96421fb7fc1210faa76ab7793100848bc5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwNjowMzozOVrOGXRA3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwNjowMzozOVrOGXRA3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA0OTE4Mw==", "bodyText": "These two constants were left-over from previous cleanups, not used.", "url": "https://github.com/triplea-game/triplea/pull/6491#discussion_r427049183", "createdAt": "2020-05-19T06:03:39Z", "author": {"login": "DanVanAtta"}, "path": "http-server/src/main/java/org/triplea/db/dao/moderator/ModeratorUserDaoData.java", "diffHunk": "@@ -14,9 +14,6 @@\n @NoArgsConstructor\n @Getter\n public class ModeratorUserDaoData {\n-  public static final String USERNAME_COLUMN = \"username\";\n-  public static final String LAST_LOGIN_COLUMN = \"last_login\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebc7ef96421fb7fc1210faa76ab7793100848bc5"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0MTI1MTU2", "url": "https://github.com/triplea-game/triplea/pull/6491#pullrequestreview-414125156", "createdAt": "2020-05-19T06:04:50Z", "commit": {"oid": "ebc7ef96421fb7fc1210faa76ab7793100848bc5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwNjowNDo1MFrOGXRCQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwNjowNDo1MFrOGXRCQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA0OTUzOQ==", "bodyText": "Nothing called this update method, it can be freely removed. It's a bug that we never invoked it. The fix here is a deeper one to get this same value from the access_log table rather than maintaining the last login in two places.", "url": "https://github.com/triplea-game/triplea/pull/6491#discussion_r427049539", "createdAt": "2020-05-19T06:04:50Z", "author": {"login": "DanVanAtta"}, "path": "http-server/src/main/java/org/triplea/db/dao/user/UserJdbiDao.java", "diffHunk": "@@ -15,9 +15,6 @@\n   @SqlQuery(\"select bcrypt_password from lobby_user where username = :username\")\n   Optional<String> getPassword(@Bind(\"username\") String username);\n \n-  @SqlUpdate(\"update lobby_user set last_login = now() where username = :username\")\n-  int updateLastLoginTime(@Bind(\"username\") String username);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebc7ef96421fb7fc1210faa76ab7793100848bc5"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0MTI1NDQ5", "url": "https://github.com/triplea-game/triplea/pull/6491#pullrequestreview-414125449", "createdAt": "2020-05-19T06:05:31Z", "commit": {"oid": "ebc7ef96421fb7fc1210faa76ab7793100848bc5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwNjowNTozMVrOGXRDNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwNjowNTozMVrOGXRDNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA0OTc4MQ==", "bodyText": "insertUserAccessRecord can now figure out on its own if a user is registered or not by selecting from the lobby_user table.", "url": "https://github.com/triplea-game/triplea/pull/6491#discussion_r427049781", "createdAt": "2020-05-19T06:05:31Z", "author": {"login": "DanVanAtta"}, "path": "http-server/src/main/java/org/triplea/modules/user/account/login/AccessLogUpdater.java", "diffHunk": "@@ -21,15 +21,10 @@ public static AccessLogUpdater build(final Jdbi jdbi) {\n   @Override\n   public void accept(final LoginRecord loginRecord) {\n     final int updateCount =\n-        loginRecord.isRegistered()\n-            ? accessLogDao.insertRegisteredUserRecord(\n-                loginRecord.getUserName().getValue(),\n-                loginRecord.getIp(),\n-                loginRecord.getSystemId().getValue())\n-            : accessLogDao.insertAnonymousUserRecord(\n-                loginRecord.getUserName().getValue(),\n-                loginRecord.getIp(),\n-                loginRecord.getSystemId().getValue());\n+        accessLogDao.insertUserAccessRecord(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebc7ef96421fb7fc1210faa76ab7793100848bc5"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0Nzk0NTYz", "url": "https://github.com/triplea-game/triplea/pull/6491#pullrequestreview-414794563", "createdAt": "2020-05-19T20:23:26Z", "commit": {"oid": "ebc7ef96421fb7fc1210faa76ab7793100848bc5"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMDoyMzoyNlrOGXxPMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMDoyMzoyNlrOGXxPMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3NzEzNg==", "bodyText": "Why is this one null when it was true before?", "url": "https://github.com/triplea-game/triplea/pull/6491#discussion_r427577136", "createdAt": "2020-05-19T20:23:26Z", "author": {"login": "RoiEXLab"}, "path": "lobby-db/sample_data.sql", "diffHunk": "@@ -24,12 +24,12 @@ values (1000, 'test', 'email@email.com', (select id from user_role where name =\n        (1001, 'user1', 'email@email.com', (select id from user_role where name = 'PLAYER'),\n         '$2a$10$C4rHfjK/seKexc6KlyknP.oFVBZ7Wi.kp91qUQFgmkKajwgczXzcS');\n \n-insert into access_log(access_time, username, ip, system_id, registered)\n-values (now() - interval '1 days', 'user1', '1.1.1.1', 'system-id1', false),\n-       (now() - interval '2 days', 'user2', '1.1.1.2', 'system-id2', false),\n-       (now() - interval '3 days', 'user3', '1.1.1.3', 'system-id3', true),\n-       (now() - interval '4 days', 'user1', '1.1.1.2', 'system-id4', false),\n-       (now() - interval '5 days', 'user2', '1.1.1.4', 'system-id5', false);\n+insert into access_log(access_time, username, ip, system_id, lobby_user_id)\n+values (now() - interval '1 days', 'user1', '1.1.1.1', 'system-id1', null),\n+       (now() - interval '2 days', 'user2', '1.1.1.2', 'system-id2', null),\n+       (now() - interval '3 days', 'user3', '1.1.1.3', 'system-id3', null),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebc7ef96421fb7fc1210faa76ab7793100848bc5"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3436, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}