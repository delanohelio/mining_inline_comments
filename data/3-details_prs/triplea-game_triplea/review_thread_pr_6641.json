{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMwNzAxOTY2", "number": 6641, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwNDozMDo1MlrOEDTBRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwNDozMDo1MlrOEDTBSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxODkyODA2OnYy", "diffSide": "RIGHT", "path": "infrastructure/run_ansible_prerelease", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwNDozMDo1MlrOGgO6dA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwNDozMDo1MlrOGgO6dA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ1MTk1Ng==", "bodyText": "Use runDeployment \"$@\" if function's $1 should mean script's $1.", "url": "https://github.com/triplea-game/triplea/pull/6641#discussion_r436451956", "createdAt": "2020-06-08T04:30:52Z", "author": {"login": "codeclimate"}, "path": "infrastructure/run_ansible_prerelease", "diffHunk": "@@ -28,28 +28,45 @@ if [ ! -f \"$VAULT_PASSWORD_FILE\" ]; then\n   exit 1\n fi\n \n-HTTP_SERVER_JAR=\"ansible/roles/http_server/files/triplea-http-server-$VERSION.jar\"\n-if [ ! -f \"$HTTP_SERVER_JAR\" ]; then\n-  echo \"Error: File does not exist: $HTTP_SERVER_JAR\"\n-  exit 1\n-fi\n \n-BOT_JAR=\"ansible/roles/bot/files/triplea-game-headless-$VERSION.jar\"\n-if [ ! -f \"$BOT_JAR\" ]; then\n-  echo \"Error: File does not exist: $BOT_JAR\"\n-  exit 1\n-fi\n+function main() {\n+  buildArtifacts\n+  addPrivateSshKeyToAgent\n+  runDeployment", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3df516da72a2ccd18366d96ce70569acd0a484ef"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxODkyODA4OnYy", "diffSide": "RIGHT", "path": "infrastructure/run_ansible_prerelease", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwNDozMDo1M1rOGgO6dg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwNDozMDo1M1rOGgO6dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ1MTk1OA==", "bodyText": "runDeployment references arguments, but none are ever passed.", "url": "https://github.com/triplea-game/triplea/pull/6641#discussion_r436451958", "createdAt": "2020-06-08T04:30:53Z", "author": {"login": "codeclimate"}, "path": "infrastructure/run_ansible_prerelease", "diffHunk": "@@ -28,28 +28,45 @@ if [ ! -f \"$VAULT_PASSWORD_FILE\" ]; then\n   exit 1\n fi\n \n-HTTP_SERVER_JAR=\"ansible/roles/http_server/files/triplea-http-server-$VERSION.jar\"\n-if [ ! -f \"$HTTP_SERVER_JAR\" ]; then\n-  echo \"Error: File does not exist: $HTTP_SERVER_JAR\"\n-  exit 1\n-fi\n \n-BOT_JAR=\"ansible/roles/bot/files/triplea-game-headless-$VERSION.jar\"\n-if [ ! -f \"$BOT_JAR\" ]; then\n-  echo \"Error: File does not exist: $BOT_JAR\"\n-  exit 1\n-fi\n+function main() {\n+  buildArtifacts\n+  addPrivateSshKeyToAgent\n+  runDeployment\n+}\n \n-MIGRATIONS_ZIP=\"ansible/roles/flyway/files/migrations.zip\"\n-if [ ! -f \"$MIGRATIONS_ZIP\" ]; then\n-  echo \"Error: File does not exist: $MIGRATIONS_ZIP\"\n-  exit 1\n-fi\n+function buildArtifacts() {\n+  ../gradlew :http-server:shadowJar :game-headless:shadowJar :lobby-db:release\n+  copyBuildArtifact \"../lobby-db/build/artifacts/migrations.zip\" \"ansible/roles/database/flyway/files/\"\n+  copyBuildArtifact \"../http-server/build/artifacts/triplea-http-server-$VERSION.jar\" \"ansible/roles/http_server/files/\"\n+  copyBuildArtifact \"../game-headless/build/artifacts/triplea-game-headless-$VERSION.jar\" \"ansible/roles/bot/files/\"\n+}\n+\n+function copyBuildArtifact() {\n+  local -r artifactSource=\"$1\"\n+  local -r artifactDestinationPath=\"$2\"\n+\n+  if [ ! -f \"$artifactSource\" ]; then\n+    echo \"Error: File does not exist: $artifactSource\"\n+    exit 1\n+  fi\n+\n+  mkdir -p \"$artifactDestinationPath\"\n+  cp \"$artifactSource\" \"$artifactDestinationPath\"\n+}\n+\n+\n+function addPrivateSshKeyToAgent() {\n+  ansible-vault view --vault-password-file=\"$VAULT_PASSWORD_FILE\" ansible_ssh_key.ed25519 | ssh-add -\n+}\n+\n+function runDeployment() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3df516da72a2ccd18366d96ce70569acd0a484ef"}, "originalPosition": 51}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2124, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}