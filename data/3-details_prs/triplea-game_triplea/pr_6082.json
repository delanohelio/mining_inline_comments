{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyNzc2MjEw", "number": 6082, "title": "Group backend services", "bodyText": "Review Notes\nRecommed to review commit by commit.\n\nFirst commit is largely file moves, to set up for combining controllers in a nicer way\nGoal: Overall trying to set up for a place where we can attach server side listeners to websocket messages. Essentially the goal will be to essentially have a websocket message bus where we can add callbacks to 'action' events. I'd like to break up the services a bit more into actual 'actions' but that could be more work than is really necessary.\n\nCommits\ncommit e82189e\nRe-group spitfire server packages\n\nFixes a few package organization issues that have been lingering\nand preps for design changes to server action handling.\n\n- group moderation package together\n- create a concept of 'modules', meant to represent the business domains.\n  We still will have strongly cohesive modules that contain all necessary\n  components to accomplish a functionality (controller+service)\n- move web.socket connection components to a new package\n\ncommit 94dbc2f26\nCombine moderator ban controllers\n\nThe first moderator ban controller was built to enable the moderator toolbox.\nWe had a second one come about to support the moderator right-click-ban menu\noption. This update combines the two.\n\nA bit forward looking, this update adds factory methods directly on the classes\nbeing instantiated. A follow-up update is planned to make this pattern of\nfactory insantiation to be consistent.\n\nFunctional Changes\n\n[] New map or map update\n[] New Feature\n[] Feature update or enhancement\n[] Feature Removal\n[x] Code Cleanup or refactor\n[] Configuration Change\n[] Problem fix:  \n[] Other:   \nTesting\n\njust automated testing, smoke test launched the server.\n\n\n\nScreens Shots\nBefore\n\nAfter", "createdAt": "2020-03-24T04:58:13Z", "url": "https://github.com/triplea-game/triplea/pull/6082", "merged": true, "mergeCommit": {"oid": "4da42fe5db7d762c6fef3180363ac1b3cea985ff"}, "closed": true, "closedAt": "2020-03-25T04:32:30Z", "author": {"login": "DanVanAtta"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQphNTgH2gAyMzkyNzc2MjEwOmU4MjE4OWUwZTI3MmYyYTQwMDQ1ZTZhYTJiMjhmYTljM2IzNDNmNjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQsI10gH2gAyMzkyNzc2MjEwOjlmNzA4ZTU1NDk1YmU4MjI5ZjZjNWE2Yzc5ZjExYjUxOTk3MzJjYTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e82189e0e272f2a40045e6aa2b28fa9c3b343f68", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/e82189e0e272f2a40045e6aa2b28fa9c3b343f68", "committedDate": "2020-03-24T02:31:15Z", "message": "Re-group spitfire server packages\n\nFixes a few package organization issues that have been lingering\nand preps for design changes to server action handling.\n\n- group moderation package together\n- create a concept of 'modules', meant to represent the business domains.\n  We still will have strongly cohesive modules that contain all necessary\n  components to accomplish a functionality (controller+service)\n- move web.socket connection components to a new package"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36e712c8ec7ac5f063ceb678ce2c3101bdf1e212", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/36e712c8ec7ac5f063ceb678ce2c3101bdf1e212", "committedDate": "2020-03-24T04:53:10Z", "message": "Combine moderator ban controllers\n\nThe first moderator ban controller was built to enable the moderator toolbox.\nWe had a second one come about to support the moderator right-click-ban menu\noption. This update combines the two.\n\nA bit forward looking, this update adds factory methods directly on the classes\nbeing instantiated. A follow-up update is planned to make this pattern of\nfactory insantiation to be consistent."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMDAwNzE5", "url": "https://github.com/triplea-game/triplea/pull/6082#pullrequestreview-380000719", "createdAt": "2020-03-24T04:59:39Z", "commit": {"oid": "36e712c8ec7ac5f063ceb678ce2c3101bdf1e212"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwNDo1OTozOVrOF6hCUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwNDo1OTo0MFrOF6hCVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwMjk5Mg==", "bodyText": "Similar blocks of code found in 2 locations. Consider refactoring.", "url": "https://github.com/triplea-game/triplea/pull/6082#discussion_r396902992", "createdAt": "2020-03-24T04:59:39Z", "author": {"login": "codeclimate"}, "path": "http-server/src/main/java/org/triplea/db/dao/username/ban/UsernameBanRecord.java", "diffHunk": "@@ -1,12 +1,12 @@\n-package org.triplea.lobby.server.db.dao.username.ban;\n+package org.triplea.db.dao.username.ban;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36e712c8ec7ac5f063ceb678ce2c3101bdf1e212"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwMjk5NQ==", "bodyText": "Similar blocks of code found in 2 locations. Consider refactoring.", "url": "https://github.com/triplea-game/triplea/pull/6082#discussion_r396902995", "createdAt": "2020-03-24T04:59:39Z", "author": {"login": "codeclimate"}, "path": "http-server/src/main/java/org/triplea/db/data/ModeratorUserDaoData.java", "diffHunk": "@@ -1,12 +1,12 @@\n-package org.triplea.lobby.server.db.data;\n+package org.triplea.db.data;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36e712c8ec7ac5f063ceb678ce2c3101bdf1e212"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwMjk5Ng==", "bodyText": "Method banUser has 28 lines of code (exceeds 25 allowed). Consider refactoring.", "url": "https://github.com/triplea-game/triplea/pull/6082#discussion_r396902996", "createdAt": "2020-03-24T04:59:39Z", "author": {"login": "codeclimate"}, "path": "http-server/src/main/java/org/triplea/modules/moderation/ban/user/UserBanService.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package org.triplea.modules.moderation.ban.user;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.UUID;\n+import java.util.function.BiConsumer;\n+import java.util.function.Supplier;\n+import java.util.stream.Collectors;\n+import javax.annotation.Nonnull;\n+import javax.websocket.Session;\n+import lombok.Builder;\n+import org.jdbi.v3.core.Jdbi;\n+import org.triplea.db.dao.ModeratorAuditHistoryDao;\n+import org.triplea.db.dao.api.key.ApiKeyDaoWrapper;\n+import org.triplea.db.dao.api.key.GamePlayerLookup;\n+import org.triplea.db.dao.user.ban.UserBanDao;\n+import org.triplea.domain.data.PlayerChatId;\n+import org.triplea.domain.data.UserName;\n+import org.triplea.http.client.IpAddressParser;\n+import org.triplea.http.client.lobby.chat.messages.server.ChatServerEnvelopeFactory;\n+import org.triplea.http.client.lobby.moderator.BanDurationFormatter;\n+import org.triplea.http.client.lobby.moderator.BanPlayerRequest;\n+import org.triplea.http.client.lobby.moderator.toolbox.banned.user.UserBanData;\n+import org.triplea.http.client.lobby.moderator.toolbox.banned.user.UserBanParams;\n+import org.triplea.http.client.web.socket.messages.ServerMessageEnvelope;\n+import org.triplea.modules.chat.event.processing.Chatters;\n+import org.triplea.modules.moderation.remote.actions.RemoteActionsEventQueue;\n+import org.triplea.web.socket.MessageBroadcaster;\n+\n+/**\n+ * Service layer for managing user bans, get bans, add and remove. User bans are done by MAC and IP\n+ * address, they are removed by the 'public ban id' that is assigned when a ban is issued.\n+ */\n+@Builder\n+public class UserBanService {\n+\n+  @Nonnull private final ModeratorAuditHistoryDao moderatorAuditHistoryDao;\n+  @Nonnull private final UserBanDao userBanDao;\n+  @Nonnull private final Supplier<String> publicIdSupplier;\n+  @Nonnull private final Chatters chatters;\n+  @Nonnull private final RemoteActionsEventQueue remoteActionsEventQueue;\n+  @Nonnull private final ApiKeyDaoWrapper apiKeyDaoWrapper;\n+  @Nonnull private final BiConsumer<Collection<Session>, ServerMessageEnvelope> messageBroadcaster;\n+\n+  public static UserBanService build(\n+      final Jdbi jdbi,\n+      final Chatters chatters,\n+      final RemoteActionsEventQueue remoteActionsEventQueue) {\n+\n+    return UserBanService.builder()\n+        .moderatorAuditHistoryDao(jdbi.onDemand(ModeratorAuditHistoryDao.class))\n+        .userBanDao(jdbi.onDemand(UserBanDao.class))\n+        .publicIdSupplier(() -> UUID.randomUUID().toString())\n+        .chatters(chatters)\n+        .remoteActionsEventQueue(remoteActionsEventQueue)\n+        .apiKeyDaoWrapper(ApiKeyDaoWrapper.build(jdbi))\n+        .messageBroadcaster(MessageBroadcaster.build())\n+        .build();\n+  }\n+\n+  List<UserBanData> getBannedUsers() {\n+    return userBanDao.lookupBans().stream()\n+        .map(\n+            daoData ->\n+                UserBanData.builder()\n+                    .banId(daoData.getPublicBanId())\n+                    .username(daoData.getUsername())\n+                    .hashedMac(daoData.getSystemId())\n+                    .ip(daoData.getIp())\n+                    .banDate(daoData.getDateCreated())\n+                    .banExpiry(daoData.getBanExpiry())\n+                    .build())\n+        .collect(Collectors.toList());\n+  }\n+\n+  boolean removeUserBan(final int moderatorId, final String banId) {\n+    final String unbanName = userBanDao.lookupUsernameByBanId(banId).orElse(null);\n+    if (userBanDao.removeBan(banId) != 1) {\n+      return false;\n+    }\n+    if (unbanName == null) {\n+      throw new IllegalStateException(\n+          \"Consistency error, unbanned \"\n+              + banId\n+              + \", but \"\n+              + \"there was no matching name for that ban.\");\n+    }\n+\n+    moderatorAuditHistoryDao.addAuditRecord(\n+        ModeratorAuditHistoryDao.AuditArgs.builder()\n+            .actionName(ModeratorAuditHistoryDao.AuditAction.REMOVE_USER_BAN)\n+            .actionTarget(unbanName)\n+            .moderatorUserId(moderatorId)\n+            .build());\n+    return true;\n+  }\n+\n+  boolean banUser(final int moderatorId, final BanPlayerRequest banPlayerRequest) {\n+    return apiKeyDaoWrapper\n+        .lookupPlayerByChatId(PlayerChatId.of(banPlayerRequest.getPlayerChatId()))\n+        .map(\n+            gamePlayerLookup -> toUserBanParams(gamePlayerLookup, banPlayerRequest.getBanMinutes()))\n+        .map(banUserParams -> banUser(moderatorId, banUserParams))\n+        .orElse(false);\n+  }\n+\n+  boolean banUser(final int moderatorId, final UserBanParams banUserParams) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36e712c8ec7ac5f063ceb678ce2c3101bdf1e212"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwMjk5Nw==", "bodyText": "Similar blocks of code found in 2 locations. Consider refactoring.", "url": "https://github.com/triplea-game/triplea/pull/6082#discussion_r396902997", "createdAt": "2020-03-24T04:59:40Z", "author": {"login": "codeclimate"}, "path": "http-server/src/main/java/org/triplea/modules/moderation/ban/user/UserBanService.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package org.triplea.modules.moderation.ban.user;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.UUID;\n+import java.util.function.BiConsumer;\n+import java.util.function.Supplier;\n+import java.util.stream.Collectors;\n+import javax.annotation.Nonnull;\n+import javax.websocket.Session;\n+import lombok.Builder;\n+import org.jdbi.v3.core.Jdbi;\n+import org.triplea.db.dao.ModeratorAuditHistoryDao;\n+import org.triplea.db.dao.api.key.ApiKeyDaoWrapper;\n+import org.triplea.db.dao.api.key.GamePlayerLookup;\n+import org.triplea.db.dao.user.ban.UserBanDao;\n+import org.triplea.domain.data.PlayerChatId;\n+import org.triplea.domain.data.UserName;\n+import org.triplea.http.client.IpAddressParser;\n+import org.triplea.http.client.lobby.chat.messages.server.ChatServerEnvelopeFactory;\n+import org.triplea.http.client.lobby.moderator.BanDurationFormatter;\n+import org.triplea.http.client.lobby.moderator.BanPlayerRequest;\n+import org.triplea.http.client.lobby.moderator.toolbox.banned.user.UserBanData;\n+import org.triplea.http.client.lobby.moderator.toolbox.banned.user.UserBanParams;\n+import org.triplea.http.client.web.socket.messages.ServerMessageEnvelope;\n+import org.triplea.modules.chat.event.processing.Chatters;\n+import org.triplea.modules.moderation.remote.actions.RemoteActionsEventQueue;\n+import org.triplea.web.socket.MessageBroadcaster;\n+\n+/**\n+ * Service layer for managing user bans, get bans, add and remove. User bans are done by MAC and IP\n+ * address, they are removed by the 'public ban id' that is assigned when a ban is issued.\n+ */\n+@Builder\n+public class UserBanService {\n+\n+  @Nonnull private final ModeratorAuditHistoryDao moderatorAuditHistoryDao;\n+  @Nonnull private final UserBanDao userBanDao;\n+  @Nonnull private final Supplier<String> publicIdSupplier;\n+  @Nonnull private final Chatters chatters;\n+  @Nonnull private final RemoteActionsEventQueue remoteActionsEventQueue;\n+  @Nonnull private final ApiKeyDaoWrapper apiKeyDaoWrapper;\n+  @Nonnull private final BiConsumer<Collection<Session>, ServerMessageEnvelope> messageBroadcaster;\n+\n+  public static UserBanService build(\n+      final Jdbi jdbi,\n+      final Chatters chatters,\n+      final RemoteActionsEventQueue remoteActionsEventQueue) {\n+\n+    return UserBanService.builder()\n+        .moderatorAuditHistoryDao(jdbi.onDemand(ModeratorAuditHistoryDao.class))\n+        .userBanDao(jdbi.onDemand(UserBanDao.class))\n+        .publicIdSupplier(() -> UUID.randomUUID().toString())\n+        .chatters(chatters)\n+        .remoteActionsEventQueue(remoteActionsEventQueue)\n+        .apiKeyDaoWrapper(ApiKeyDaoWrapper.build(jdbi))\n+        .messageBroadcaster(MessageBroadcaster.build())\n+        .build();\n+  }\n+\n+  List<UserBanData> getBannedUsers() {\n+    return userBanDao.lookupBans().stream()\n+        .map(\n+            daoData ->\n+                UserBanData.builder()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36e712c8ec7ac5f063ceb678ce2c3101bdf1e212"}, "originalPosition": 65}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f708e55495be8229f6c5a6c79f11b5199732ca9", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/9f708e55495be8229f6c5a6c79f11b5199732ca9", "committedDate": "2020-03-24T05:34:21Z", "message": "Update jar path to main class \"ServerApplication\""}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3593, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}