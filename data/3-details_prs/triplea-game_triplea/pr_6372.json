{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEyNTM5MjYx", "number": 6372, "title": "Simplify CasualtySelector and Fix EditMode casualty selection behavior", "bodyText": "Removes edit mode special case behavior in casualty selection.\nThe edit mode for casualty selection previously always had\nzero casualties being inflicted despite any dice roll. This has\na number of problems:\n\nnot intuitive, one would perhaps expect for any number of\ncasualties to be taken during edit mode rather than always\nzero\nnot intuitive, the combat UI still states how many hits\noccurred yet there are zero casualties to select\nnot comprehensive, the AA casualty selection does not have\na special case for edit mode, it handles casualties normally.\nThis is odd as an initial AA fire deals casualties and then\nthere are no more.\npossibly introduces a never-ending combat. In this situation,\nbecause edit mode cannot be turned off during a battle, the only\nway to end such a battle during edit mode is via retreat. If\nthere is no retreat option, then there will be no way to end\nthe battle whatsoever.\n\n\n\nSimplify: use ternaries\n\n\nSimplify/Performance: Remove arg and state checks that verify\nparameter and output collection contains. The contains checks\non lists is potentially O(n^2); furthermore given the amount\nof production testing we can be pretty confident these checks\nare not going to raise issues. We can for now remove them to\nsimplify slightly.\n\n\n\nFunctional Changes\n\n[] New map or map update\n[] New Feature\n[x] Feature update or enhancement\n[] Feature Removal\n[] Code Cleanup or refactor\n[] Configuration Change\n[] Problem fix:  \n[] Other:   \nTesting\n\ndid a battle in edit mode", "createdAt": "2020-05-03T02:48:07Z", "url": "https://github.com/triplea-game/triplea/pull/6372", "merged": true, "mergeCommit": {"oid": "5aded7658614df663eac251dc281161343d6d109"}, "closed": true, "closedAt": "2020-05-04T03:32:01Z", "author": {"login": "DanVanAtta"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcdhoQ-AH2gAyNDEyNTM5MjYxOjVjNjhhMzBkOGE0Mzk1ZDBjZDU0MDIxMmVjMzIzNjIxOWRhYWU1N2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcd238gAFqTQwNDY5NDg0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5c68a30d8a4395d0cd540212ec3236219daae57e", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/5c68a30d8a4395d0cd540212ec3236219daae57e", "committedDate": "2020-05-03T02:40:44Z", "message": "Simplify CasualtySelector and remove EditMode casualty selection behavior\n\n1. Removes edit mode special case behavior in casualty selection.\n   The edit mode for casualty selection previously always had\n   zero casualties being inflicted despite any dice roll. This has\n   a number of problems:\n    - not intuitive, one would perhaps expect for any number of\n      casualties to be taken during edit mode rather than always\n      zero\n    - not intuitive, the combat UI still states how many hits\n      occurred yet there are zero casualties to select\n    - not comprehensive, the AA casualty selection does not have\n      a special case for edit mode, it handles casualties normally.\n      This is odd as an initial AA fire deals casualties and then\n      there are no more.\n    - possibly introduces a never-ending combat. In this situation,\n      because edit mode cannot be turned off during a battle, the only\n      way to end such a battle during edit mode is via retreat. If\n      there is no retreat option, then there will be no way to end\n      the battle whatsoever.\n\n2. Simplify: use ternaries\n\n3. Simplify/Performance: Remove arg and state checks that verify\n   parameter and output collection contains. The contains checks\n   on lists is potentially O(n^2); furthermore given the amount\n   of production testing we can be pretty confident these checks\n   are not going to raise issues. We can for now remove them to\n   simplify slightly."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NTc2ODUz", "url": "https://github.com/triplea-game/triplea/pull/6372#pullrequestreview-404576853", "createdAt": "2020-05-03T02:50:03Z", "commit": {"oid": "5c68a30d8a4395d0cd540212ec3236219daae57e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wM1QwMjo1MDowM1rOGPoCcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wM1QwMjo1MDowM1rOGPoCcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAzNzgwOA==", "bodyText": "This zero is a hard-coding of the number of hits (which creates problems).\nWe could in theory have kept this behavior and simplified to set CasualtyDetails to be empty as the 'editSelection' result is always (and forced to be empty).\nPerhaps the original intent of this code was to prompt zero casualties and allow for selection of any number? Regardless if that was the intent or not,  you are forced to choose zero casualties which creates dead code paths in casualty selection (always returns empty).", "url": "https://github.com/triplea-game/triplea/pull/6372#discussion_r419037808", "createdAt": "2020-05-03T02:50:03Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/casualty/CasualtySelector.java", "diffHunk": "@@ -74,62 +73,22 @@ public static CasualtyDetails selectCasualties(\n     if (targetsToPickFrom.isEmpty()) {\n       return new CasualtyDetails();\n     }\n-    if (!friendlyUnits.containsAll(targetsToPickFrom)) {\n-      throw new IllegalStateException(\n-          \"friendlyUnits should but does not contain all units from targetsToPickFrom\"\n-              + \", battlesite: \"\n-              + battlesite\n-              + \", friendlyUnits: \"\n-              + friendlyUnits\n-              + \", targetsToPickFrom: \"\n-              + targetsToPickFrom);\n-    }\n     final GameData data = bridge.getData();\n-    final boolean isEditMode = BaseEditDelegate.getEditMode(data);\n     final Player tripleaPlayer =\n         player.isNull() ? new WeakAi(player.getName()) : bridge.getRemotePlayer(player);\n     final Map<Unit, Collection<Unit>> dependents =\n         headLess ? Map.of() : CasualtyUtil.getDependents(targetsToPickFrom);\n-    if (isEditMode && !headLess) {\n-      final CasualtyDetails editSelection =\n-          tripleaPlayer.selectCasualties(\n-              targetsToPickFrom,\n-              dependents,\n-              0,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c68a30d8a4395d0cd540212ec3236219daae57e"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NTc2ODY1", "url": "https://github.com/triplea-game/triplea/pull/6372#pullrequestreview-404576865", "createdAt": "2020-05-03T02:50:33Z", "commit": {"oid": "5c68a30d8a4395d0cd540212ec3236219daae57e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wM1QwMjo1MDozM1rOGPoCjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wM1QwMjo1MDozM1rOGPoCjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAzNzgzOA==", "bodyText": "This iterator was re-written to be a stream+limit+collect.", "url": "https://github.com/triplea-game/triplea/pull/6372#discussion_r419037838", "createdAt": "2020-05-03T02:50:33Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/casualty/CasualtySelector.java", "diffHunk": "@@ -74,62 +73,22 @@ public static CasualtyDetails selectCasualties(\n     if (targetsToPickFrom.isEmpty()) {\n       return new CasualtyDetails();\n     }\n-    if (!friendlyUnits.containsAll(targetsToPickFrom)) {\n-      throw new IllegalStateException(\n-          \"friendlyUnits should but does not contain all units from targetsToPickFrom\"\n-              + \", battlesite: \"\n-              + battlesite\n-              + \", friendlyUnits: \"\n-              + friendlyUnits\n-              + \", targetsToPickFrom: \"\n-              + targetsToPickFrom);\n-    }\n     final GameData data = bridge.getData();\n-    final boolean isEditMode = BaseEditDelegate.getEditMode(data);\n     final Player tripleaPlayer =\n         player.isNull() ? new WeakAi(player.getName()) : bridge.getRemotePlayer(player);\n     final Map<Unit, Collection<Unit>> dependents =\n         headLess ? Map.of() : CasualtyUtil.getDependents(targetsToPickFrom);\n-    if (isEditMode && !headLess) {\n-      final CasualtyDetails editSelection =\n-          tripleaPlayer.selectCasualties(\n-              targetsToPickFrom,\n-              dependents,\n-              0,\n-              text,\n-              dice,\n-              player,\n-              friendlyUnits,\n-              enemyUnits,\n-              amphibious,\n-              amphibiousLandAttackers,\n-              new CasualtyList(),\n-              battleId,\n-              battlesite,\n-              allowMultipleHitsPerUnit);\n-      final List<Unit> killed = editSelection.getKilled();\n-      // if partial retreat is possible, kill amphibious units first\n-      if (Properties.getPartialAmphibiousRetreat(data)) {\n-        killAmphibiousFirst(killed, targetsToPickFrom);\n-      }\n-      return editSelection;\n-    }\n     if (dice.getHits() == 0) {\n       return new CasualtyDetails(List.of(), List.of(), true);\n     }\n-    int hitsRemaining = dice.getHits();\n-    if (Properties.getTransportCasualtiesRestricted(data)) {\n-      hitsRemaining = extraHits;\n-    }\n-    if (!isEditMode && allTargetsOneTypeOneHitPoint(targetsToPickFrom, dependents)) {\n-      final List<Unit> killed = new ArrayList<>();\n-      final Iterator<Unit> iter = targetsToPickFrom.iterator();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c68a30d8a4395d0cd540212ec3236219daae57e"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NjQzMDQ4", "url": "https://github.com/triplea-game/triplea/pull/6372#pullrequestreview-404643048", "createdAt": "2020-05-03T18:05:15Z", "commit": {"oid": "5c68a30d8a4395d0cd540212ec3236219daae57e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wM1QxODowNToxNVrOGPuK-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wM1QxODowNToxNVrOGPuK-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEzODI5OQ==", "bodyText": "So if you want to simplify this code I'm good with that but I think we should keep the edit mode behavior.", "url": "https://github.com/triplea-game/triplea/pull/6372#discussion_r419138299", "createdAt": "2020-05-03T18:05:15Z", "author": {"login": "ron-murhammer"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/casualty/CasualtySelector.java", "diffHunk": "@@ -74,62 +73,22 @@ public static CasualtyDetails selectCasualties(\n     if (targetsToPickFrom.isEmpty()) {\n       return new CasualtyDetails();\n     }\n-    if (!friendlyUnits.containsAll(targetsToPickFrom)) {\n-      throw new IllegalStateException(\n-          \"friendlyUnits should but does not contain all units from targetsToPickFrom\"\n-              + \", battlesite: \"\n-              + battlesite\n-              + \", friendlyUnits: \"\n-              + friendlyUnits\n-              + \", targetsToPickFrom: \"\n-              + targetsToPickFrom);\n-    }\n     final GameData data = bridge.getData();\n-    final boolean isEditMode = BaseEditDelegate.getEditMode(data);\n     final Player tripleaPlayer =\n         player.isNull() ? new WeakAi(player.getName()) : bridge.getRemotePlayer(player);\n     final Map<Unit, Collection<Unit>> dependents =\n         headLess ? Map.of() : CasualtyUtil.getDependents(targetsToPickFrom);\n-    if (isEditMode && !headLess) {\n-      final CasualtyDetails editSelection =\n-          tripleaPlayer.selectCasualties(\n-              targetsToPickFrom,\n-              dependents,\n-              0,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAzNzgwOA=="}, "originalCommit": {"oid": "5c68a30d8a4395d0cd540212ec3236219daae57e"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d684a49a11f76500cc4ea726b4270f0f5bbda960", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/d684a49a11f76500cc4ea726b4270f0f5bbda960", "committedDate": "2020-05-03T22:55:40Z", "message": "Fix edit mode battles to allow arbitrary battles\n\nChanges most if not all battle sequences done during edit mode\nto allow for 0-n casualties to be selected where n is the number\nof opposing units.\n\nPreviously edit mode battle had a number of problems:\n- was not triggered in a number of code paths. This update should\n  fix that and have edit mode battle logic be triggered for all\n  battle casualties.\n- always required zero casualties. If unable to turn off edit mode\n  (EG: linux OS when battle window is open), and if in a battle\n  where there is no retreat, then the player had no ability to\n  exit the battle."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0Njk0ODQw", "url": "https://github.com/triplea-game/triplea/pull/6372#pullrequestreview-404694840", "createdAt": "2020-05-04T03:25:52Z", "commit": {"oid": "d684a49a11f76500cc4ea726b4270f0f5bbda960"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3549, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}