{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzMjAyMDcz", "number": 6385, "title": "Fix unit factory toctou", "bodyText": "Should address: #6338\nCommits\ncommit 9122685\nSimplify, avoid assigning to Optional type, instead use 'map' operation\n\ncommit fff8389\nFix TOCTOU when getting images from an image cache.\n\nThere exists a 'clear cache' method that can possibly remove\nthe data in 'images'. If a method call interleaving is just right\nthen we have a TOCTOU problem where we can detect an image exists,\nclear it, then try to retrieve it resulting in a NPE.\n\nThis is fixed by getting the image and checking if that is null,\nif not we use the image we retrieved.\n\ncommit 5da21d6\nRemove the need to clear image cache in UnitImageFactory by using a new instance\n\n- Change 'setResourceLoader' to instead to be a constructor. If we use UnitImageFactory\nbefore we have called 'setResourceLoader', we would get a NPE. This implies that it\nis safe to convert 'setResourceLoader' to be a constructor.\n\n- When changing scale factor, instead return a new UnitImageFactory that has a fresh\ncache.\n\nWith the two changes above we no longer need to clear cache.\n\n\nFunctional Changes\n\n[] New map or map update\n[] New Feature\n[] Feature update or enhancement\n[] Feature Removal\n[] Code Cleanup or refactor\n[] Configuration Change\n[x] Problem fix:  \n[] Other:   \nTesting\n\ndid a quick smoke test loading a game and changed unit scale.", "createdAt": "2020-05-04T21:45:31Z", "url": "https://github.com/triplea-game/triplea/pull/6385", "merged": true, "mergeCommit": {"oid": "6db6c245f747f93253b1000a6dd1c07cd0495f24"}, "closed": true, "closedAt": "2020-05-05T19:01:08Z", "author": {"login": "DanVanAtta"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABceGVFMAH2gAyNDEzMjAyMDczOjkxMjI2ODU1MTg0MzVjZjllZjY2Yzk4YmJhNTg4YTY5YzRhMWNmM2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABceX1D5gH2gAyNDEzMjAyMDczOmNjM2UwMjQwOWIxYTdlNGYxYTgwNzhjNDNlNTk4ZjE2NjNmZjQ3NGU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9122685518435cf9ef66c98bba588a69c4a1cf3b", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/9122685518435cf9ef66c98bba588a69c4a1cf3b", "committedDate": "2020-05-04T21:26:16Z", "message": "Simplify, avoid assigning to Optional type, instead use 'map' operation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fff83890bf707c3cfa4c638fc5d46a889d5b7e1b", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/fff83890bf707c3cfa4c638fc5d46a889d5b7e1b", "committedDate": "2020-05-04T21:27:25Z", "message": "Fix TOCTOU when getting images from an image cache.\n\nThere exists a 'clear cache' method that can possibly remove\nthe data in 'images'. If a method call interleaving is just right\nthen we have a TOCTOU problem where we can detect an image exists,\nclear it, then try to retrieve it resulting in a NPE.\n\nThis is fixed by getting the image and checking if that is null,\nif not we use the image we retrieved."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5da21d60eceea0029563baad07adeca6cd5880e1", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/5da21d60eceea0029563baad07adeca6cd5880e1", "committedDate": "2020-05-04T21:43:17Z", "message": "Remove the need to clear image cache in UnitImageFactory by using a new instance\n\n- Change 'setResourceLoader' to instead to be a constructor. If we use UnitImageFactory\nbefore we have called 'setResourceLoader', we would get a NPE. This implies that it\nis safe to convert 'setResourceLoader' to be a constructor.\n\n- When changing scale factor, instead return a new UnitImageFactory that has a fresh\ncache.\n\nWith the two changes above we no longer need to clear cache."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NzExOTAw", "url": "https://github.com/triplea-game/triplea/pull/6385#pullrequestreview-405711900", "createdAt": "2020-05-05T11:48:07Z", "commit": {"oid": "5da21d60eceea0029563baad07adeca6cd5880e1"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMTo0ODowOFrOGQluew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMjowMTo0OFrOGQmKBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA0ODUwNw==", "bodyText": "Can scaleFactor made final now?", "url": "https://github.com/triplea-game/triplea/pull/6385#discussion_r420048507", "createdAt": "2020-05-05T11:48:08Z", "author": {"login": "RoiEXLab"}, "path": "game-core/src/main/java/games/strategy/triplea/image/UnitImageFactory.java", "diffHunk": "@@ -55,30 +55,22 @@\n   private ResourceLoader resourceLoader;\n   private MapData mapData;\n \n-  public void setResourceLoader(\n-      final ResourceLoader loader,\n-      final double scaleFactor,\n-      final int initialUnitWidth,\n-      final int initialUnitHeight,\n-      final int initialUnitCounterOffsetWidth,\n-      final int initialUnitCounterOffsetHeight,\n-      final MapData mapData) {\n-    unitIconWidth = initialUnitWidth;\n-    unitIconHeight = initialUnitHeight;\n-    unitCounterOffsetWidth = initialUnitCounterOffsetWidth;\n-    unitCounterOffsetHeight = initialUnitCounterOffsetHeight;\n-    this.scaleFactor = scaleFactor;\n-    resourceLoader = loader;\n+  public UnitImageFactory(\n+      final ResourceLoader resourceLoader, final double unitScale, final MapData mapData) {\n+    unitIconWidth = mapData.getDefaultUnitWidth();\n+    unitIconHeight = mapData.getDefaultUnitHeight();\n+    unitCounterOffsetWidth = mapData.getDefaultUnitCounterOffsetWidth();\n+    unitCounterOffsetHeight = mapData.getDefaultUnitCounterOffsetHeight();\n+    this.scaleFactor = unitScale;\n+    this.resourceLoader = resourceLoader;\n     this.mapData = mapData;\n-    clearImageCache();\n   }\n \n   /** Set the unitScaling factor. */\n-  public void setScaleFactor(final double scaleFactor) {\n-    if (this.scaleFactor != scaleFactor) {\n-      this.scaleFactor = scaleFactor;\n-      clearImageCache();\n-    }\n+  public UnitImageFactory withScaleFactor(final double scaleFactor) {\n+    return this.scaleFactor == scaleFactor", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5da21d60eceea0029563baad07adeca6cd5880e1"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA1NTU1OA==", "bodyText": "Actually I'd go for Optional.ofNullable(images.computeIfAbsent(fullName, k -> {/* The lambda below*/})).\nHowever this change would no longer attempt to recompute an image if getTransformedImage(baseName, player, type) returned an empty optional, so maybe we need something like this instead:\nOptional.ofNullable(images.compute(fullName, (key, image) -> Optional.ofNullable(image).or(\n/* lambda below*/\n).orElse(null)));", "url": "https://github.com/triplea-game/triplea/pull/6385#discussion_r420055558", "createdAt": "2020-05-05T12:01:48Z", "author": {"login": "RoiEXLab"}, "path": "game-core/src/main/java/games/strategy/triplea/image/UnitImageFactory.java", "diffHunk": "@@ -120,26 +106,29 @@ public Image getImage(final UnitCategory unit) {\n       final UnitType type, final GamePlayer player, final boolean damaged, final boolean disabled) {\n     final String baseName = getBaseImageName(type, player, damaged, disabled);\n     final String fullName = baseName + player.getName();\n-    if (images.containsKey(fullName)) {\n-      return Optional.of(images.get(fullName));\n-    }\n-    final Optional<Image> image = getTransformedImage(baseName, player, type);\n-    if (image.isEmpty()) {\n-      return Optional.empty();\n-    }\n-    final Image baseImage = image.get();\n \n-    // We want to scale units according to the given scale factor.\n-    // We use smooth scaling since the images are cached to allow to take our time in doing the\n-    // scaling.\n-    // Image observer is null, since the image should have been guaranteed to be loaded.\n-    final int width = (int) (baseImage.getWidth(null) * scaleFactor);\n-    final int height = (int) (baseImage.getHeight(null) * scaleFactor);\n-    final Image scaledImage = baseImage.getScaledInstance(width, height, Image.SCALE_SMOOTH);\n-    // Ensure the scaling is completed.\n-    Util.ensureImageLoaded(scaledImage);\n-    images.put(fullName, scaledImage);\n-    return Optional.of(scaledImage);\n+    return Optional.ofNullable(images.get(fullName))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5da21d60eceea0029563baad07adeca6cd5880e1"}, "originalPosition": 80}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6b26852b294108a5c5b839b54c70896d7c8e09b", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/e6b26852b294108a5c5b839b54c70896d7c8e09b", "committedDate": "2020-05-05T17:36:06Z", "message": "Remove excess constructors from UnitImageFactory and convert static state to final local"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fdf91d4b345db9f2df2c4ae1a2ee8a94eb3c951", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/1fdf91d4b345db9f2df2c4ae1a2ee8a94eb3c951", "committedDate": "2020-05-05T17:46:38Z", "message": "Use computeIfAbsent to reduce optional chaining."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc3e02409b1a7e4f1a8078c43e598f1663ff474e", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/cc3e02409b1a7e4f1a8078c43e598f1663ff474e", "committedDate": "2020-05-05T17:49:35Z", "message": "Avoid concurrent modification exception - Revert \"Use computeIfAbsent to reduce optional chaining.\"\n\nThis reverts commit 1fdf91d4b345db9f2df2c4ae1a2ee8a94eb3c951."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3564, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}