{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ1NjIxNDkz", "number": 8510, "title": "Fix concurrent modification exception when setting player colors", "bodyText": "When launching the game, we can get a 'ConcurrentModificationException'\nwhen player colors are assigned.\nThis fix reverts to using a non-atomic add to the player color map\nand removes usage of 'computeIfAbsent' (which is not thread-safe).\nBecause we set the player color to the same value, but possibly doing\nso concurrently, we do not need a thread-safe nor atomic add of the\nplayer color (we just need it to work). By going to a non-atomic\nversion, we avoid code that would otherwise throw a\n'ConcurrentModificationException' on concurrent adds.\n\nTesting\n\nScreens Shots\n\nAdditional Notes to Reviewer\n\nRelease Note\n\nFIX|Fix rare game launch error 'ConcurrentModificationException' related to assigning default player colors.", "createdAt": "2020-12-25T18:37:34Z", "url": "https://github.com/triplea-game/triplea/pull/8510", "merged": true, "mergeCommit": {"oid": "d6816dcaf2b1dccc111918447dc1229a01b79428"}, "closed": true, "closedAt": "2020-12-27T00:46:16Z", "author": {"login": "DanVanAtta"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdpsuQwgH2gAyNTQ1NjIxNDkzOjgwNDg4Y2YwMTk0MzU5YjJlNDczMTQzMjlkNjJjNGYyNzFjZDY0NzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdsNJE7gFqTU2MDYzNjMxNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "80488cf0194359b2e47314329d62c4f271cd6474", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/80488cf0194359b2e47314329d62c4f271cd6474", "committedDate": "2020-12-25T18:34:29Z", "message": "Fix concurrent modification exception when setting player colors\n\nWhen launching the game, we can get a 'ConcurrentModificationException'\nwhen player colors are assigned.\n\nThis fix reverts to using a non-atomic add to the player color map\nand removes usage of 'computeIfAbsent' (which is not thread-safe).\n\nBecause we set the player color to the same value, but possibly doing\nso concurrently, we do not need a thread-safe nor atomic add of the\nplayer color (we just need it to work). By going to a non-atomic\nversion, we avoid code that would otherwise throw a\n'ConcurrentModificationException' on concurrent adds."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9aaabc346cddbad19e6d8b276b6361e13da50757", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/9aaabc346cddbad19e6d8b276b6361e13da50757", "committedDate": "2020-12-25T18:37:35Z", "message": "Merge 80488cf0194359b2e47314329d62c4f271cd6474 into 000bd8e884c645fe8f69def1bfb89dc8e25286bf"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f647694b8c822c9d1a7b99df0ce46c90b39398e1", "author": {"user": {"login": "tripleabuilderbot", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/f647694b8c822c9d1a7b99df0ce46c90b39398e1", "committedDate": "2020-12-25T18:39:15Z", "message": "Auto-Formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f1b90e23296be721cba7d8371e08e47a3cc79cf", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/7f1b90e23296be721cba7d8371e08e47a3cc79cf", "committedDate": "2020-12-26T19:08:16Z", "message": "Merge remote-tracking branch 'origin/master' into fix-concurrent-player-color"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwNjM2MzE3", "url": "https://github.com/triplea-game/triplea/pull/8510#pullrequestreview-560636317", "createdAt": "2021-01-02T13:28:34Z", "commit": {"oid": "7f1b90e23296be721cba7d8371e08e47a3cc79cf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wMlQxMzoyODozNVrOINXK_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wMlQxMzoyODozNVrOINXK_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDg4MjA0NA==", "bodyText": "Feel free to correct me if I'm wrong but isn't a ConcurrentModificationException a more correct behaviour?\nIf for example 2 Threads try to query the player name at the same time, with this code no exception would be thrown, but it could happen that the code computes 2 different colors, which are both returned, but only one of them is stored in the map.\nUnlikely scenario, but we might want to consider using a synchronized/concurrent Map instead", "url": "https://github.com/triplea-game/triplea/pull/8510#discussion_r550882044", "createdAt": "2021-01-02T13:28:35Z", "author": {"login": "RoiEXLab"}, "path": "game-core/src/main/java/games/strategy/triplea/ui/mapdata/PlayerColors.java", "diffHunk": "@@ -48,7 +48,14 @@ Color getPlayerColor(final String playerName) {\n         \"Illegal player name: %s, use the method 'getImpassableColor()' instead\",\n         playerName);\n \n-    return playerColors.computeIfAbsent(playerName, this::computePlayerColor);\n+    // NOTE: we do *not* use computeIfAbsent here to avoid\n+    // 'java.util.ConcurrentModificationException'\n+    Color playerColor = playerColors.get(playerName);\n+    if (playerColor == null) {\n+      playerColor = computePlayerColor(playerName);\n+      playerColors.put(playerName, playerColor);\n+    }\n+    return playerColor;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f1b90e23296be721cba7d8371e08e47a3cc79cf"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4011, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}