{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxMjA5MjQ1", "number": 7876, "title": "Update: Require newer save loads to upgrade engine", "bodyText": "Overview\n(1) Return an optional in GameDataManager load and do not throw exceptions. Of note, when we return an optional it means that any errors have been handled, the calling code only needs to deal with the empty optional (and does not need to message the user).\n(2) Change the yes/no confirmation of loading a newer save game to instead be a warning message that user should upgrade their game engine to play the save game\nCommits\ncommit 12e8549\nRemove unnecessary null check, new input stream will thrown NPE on the next line\n\ncommit 0e134e5\nReturn an optional instead of throwing an exception on game load\n\nRather than control-flow-by-exception, we return an optional and have\nthe lower layers take care of error handling and notifications.\n\ncommit 9c0967c\nFinish converting game loading to return an optional and handle thrown errors\n\ncommit 64a8c1d\nDo not load future save game versions, only prompt user to upgrade their engine\n\nThere are subtle risks with playing a *maybe* forward compatible version of TripleA\nwith a new save. To help ensure rule integrity, this update removes a yes/no prompt\nfor users to continue in such situations and instead instructs them to download\na newer game engine.\n\ncommit 98ef72e\nFix html formatting of load newer save game message\n\ncommit 0b5dd59\nRemove unused @Log annotation\n\n\nTesting\n\ngenerated artificial errors and loggings when loading a client game to verify interplay with game loading spinners\nmanually adjusted product version to verify newer save game message\n\n\nScreens Shots\n\nRelease Note\n\nUPDATE|Loading saves from newer game engine versions will require you to upgrade your game engine version. This is to avoid subtle errors and other rule problems that could occur.", "createdAt": "2020-10-11T21:29:12Z", "url": "https://github.com/triplea-game/triplea/pull/7876", "merged": true, "mergeCommit": {"oid": "a278e79348c6c5bcf857e78daf6cd89df272954b"}, "closed": true, "closedAt": "2020-10-13T00:15:08Z", "author": {"login": "DanVanAtta"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdRkA5zgH2gAyNTAxMjA5MjQ1OjEyZTg1NDk2NmEzYmZmMjU1MjY3YTRkZWU1MTBmZDlkNTFmZWM2OGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdR8-8OAH2gAyNTAxMjA5MjQ1OjIxYWIxY2YwNjg3YmRiMWJkZjcxNTYyYzg3YmJiYjNlYjFhMjYzMzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "12e854966a3bff255267a4dee510fd9d51fec68c", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/12e854966a3bff255267a4dee510fd9d51fec68c", "committedDate": "2020-10-11T18:51:31Z", "message": "Remove unnecessary null check, new input stream will thrown NPE on the next line"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e134e518b5b564951d135ec4fb6c5ad897ab179", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/0e134e518b5b564951d135ec4fb6c5ad897ab179", "committedDate": "2020-10-11T20:20:58Z", "message": "Return an optional instead of throwing an exception on game load\n\nRather than control-flow-by-exception, we return an optional and have\nthe lower layers take care of error handling and notifications."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c0967c0c31f15ceb519001b76928ddd4e9c5c2f", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/9c0967c0c31f15ceb519001b76928ddd4e9c5c2f", "committedDate": "2020-10-11T20:59:16Z", "message": "Finish converting game loading to return an optional and handle thrown errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64a8c1d435b3cba6e1d0c3a94dfe936c93c896ae", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/64a8c1d435b3cba6e1d0c3a94dfe936c93c896ae", "committedDate": "2020-10-11T21:04:27Z", "message": "Do not load future save game versions, only prompt user to upgrade their engine\n\nThere are subtle risks with playing a *maybe* forward compatible version of TripleA\nwith a new save. To help ensure rule integrity, this update removes a yes/no prompt\nfor users to continue in such situations and instead instructs them to download\na newer game engine."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98ef72ef32de73df9026c9bc51b30c5b5c400a6c", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/98ef72ef32de73df9026c9bc51b30c5b5c400a6c", "committedDate": "2020-10-11T21:21:25Z", "message": "Fix html formatting of load newer save game message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b5dd59d7da6b5236e5bfbb5658d9e3963a24308", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/0b5dd59d7da6b5236e5bfbb5658d9e3963a24308", "committedDate": "2020-10-11T21:26:15Z", "message": "Remove unused @Log annotation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MjIwMTQw", "url": "https://github.com/triplea-game/triplea/pull/7876#pullrequestreview-506220140", "createdAt": "2020-10-11T21:57:20Z", "commit": {"oid": "0b5dd59d7da6b5236e5bfbb5658d9e3963a24308"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMVQyMjowMjoxM1rOHfq8Xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMVQyMjowMjoxM1rOHfq8Xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk3MTQ4Nw==", "bodyText": "Should a log.error be added here as well?", "url": "https://github.com/triplea-game/triplea/pull/7876#discussion_r502971487", "createdAt": "2020-10-11T22:02:13Z", "author": {"login": "trevan"}, "path": "game-core/src/main/java/games/strategy/engine/framework/GameDataManager.java", "diffHunk": "@@ -93,39 +94,28 @@ public static GameData loadGame(final InputStream is) throws IOException {\n                 version,\n                 UrlConstants.DOWNLOAD_WEBSITE,\n                 UrlConstants.DOWNLOAD_WEBSITE));\n+        return Optional.empty();\n       } else if (!HeadlessGameServer.headless()\n           && ((Version) version).isGreaterThan(ClientContext.engineVersion())) {\n-        // we can still load it because our engine is compatible, however this save was made by a\n-        // newer engine, so prompt the user to upgrade\n-        promptToLoadNewerSaveGame();\n+        // Prompt the user to upgrade\n+        log.warn(\n+            \"This save was made by a newer version of TripleA.<br>\"\n+                + \"To load this save, download the latest version of TripleA: \"\n+                + \"<a href=\\\"{}\\\">{}</a>\",\n+            UrlConstants.DOWNLOAD_WEBSITE,\n+            UrlConstants.DOWNLOAD_WEBSITE);\n+        return Optional.empty();\n+      } else {\n+        final GameData data = (GameData) input.readObject();\n+        data.postDeSerialize();\n+        loadDelegates(input, data);\n+        return Optional.of(data);\n       }\n-\n-      final GameData data = (GameData) input.readObject();\n-      data.postDeSerialize();\n-      loadDelegates(input, data);\n-      return data;\n     } catch (final ClassNotFoundException cnfe) {\n-      throw new IOException(cnfe.getMessage());\n-    }\n-  }\n-\n-  private static void promptToLoadNewerSaveGame() throws IOException {\n-    // this is needed because a newer client might depend on variables that are part of the new\n-    // save but will be stripped by the old client. When the old client re-saves the data, the\n-    // new client will load the save game and be in odd state.\n-    final String messageString =\n-        \"This save was made by a newer version of TripleA.\"\n-            + \"\\nPlaying newer saves with an older engine can lead to unpredictable problems. \"\n-            + \"It is recommended that you upgrade to the latest version of TripleA before playing \"\n-            + \"this save game. To download the latest version of TripleA, Please visit \"\n-            + UrlConstants.DOWNLOAD_WEBSITE\n-            + \".\\n\"\n-            + \"\\n\\nDo you wish to continue and open this save with your current 'old' version?;\";\n-    final int answer =\n-        JOptionPane.showConfirmDialog(\n-            null, messageString, \"Open Newer Save Game?\", JOptionPane.YES_NO_OPTION);\n-    if (answer != JOptionPane.YES_OPTION) {\n-      throw new IOException(\"Loading the save game was aborted\");\n+      log.error(\"Error loading game data\", cnfe);\n+      return Optional.empty();\n+    } catch (final IOException e) {\n+      return Optional.empty();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b5dd59d7da6b5236e5bfbb5658d9e3963a24308"}, "originalPosition": 136}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7ae2cac366a66c8721f3616145a6b74e5cb140b", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/c7ae2cac366a66c8721f3616145a6b74e5cb140b", "committedDate": "2020-10-11T22:53:40Z", "message": "Log IOException on game data load"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53e697119819508c407656bd17fc08cd9962a477", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/53e697119819508c407656bd17fc08cd9962a477", "committedDate": "2020-10-12T01:51:31Z", "message": "Restore replacement of newlines with html line breaks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MjUyMzI5", "url": "https://github.com/triplea-game/triplea/pull/7876#pullrequestreview-506252329", "createdAt": "2020-10-12T02:09:32Z", "commit": {"oid": "53e697119819508c407656bd17fc08cd9962a477"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQwMjowOTozMlrOHfs8TQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQwMjowOTozM1rOHfs8UA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAwNDIzNw==", "bodyText": "Avoid too many return statements within this method.", "url": "https://github.com/triplea-game/triplea/pull/7876#discussion_r503004237", "createdAt": "2020-10-12T02:09:32Z", "author": {"login": "codeclimate"}, "path": "game-core/src/main/java/games/strategy/engine/framework/GameDataManager.java", "diffHunk": "@@ -77,13 +77,14 @@ public static GameData loadGame(final InputStream is) throws IOException {\n                 ((games.strategy.util.Version) version).getExactVersion(),\n                 UrlConstants.OLD_DOWNLOADS_WEBSITE,\n                 UrlConstants.OLD_DOWNLOADS_WEBSITE));\n-\n+        return Optional.empty();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53e697119819508c407656bd17fc08cd9962a477"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAwNDI0MA==", "bodyText": "Avoid too many return statements within this method.", "url": "https://github.com/triplea-game/triplea/pull/7876#discussion_r503004240", "createdAt": "2020-10-12T02:09:33Z", "author": {"login": "codeclimate"}, "path": "game-core/src/main/java/games/strategy/engine/framework/GameDataManager.java", "diffHunk": "@@ -93,39 +94,26 @@ public static GameData loadGame(final InputStream is) throws IOException {\n                 version,\n                 UrlConstants.DOWNLOAD_WEBSITE,\n                 UrlConstants.DOWNLOAD_WEBSITE));\n+        return Optional.empty();\n       } else if (!HeadlessGameServer.headless()\n           && ((Version) version).isGreaterThan(ClientContext.engineVersion())) {\n-        // we can still load it because our engine is compatible, however this save was made by a\n-        // newer engine, so prompt the user to upgrade\n-        promptToLoadNewerSaveGame();\n+        // Prompt the user to upgrade\n+        log.warn(\n+            \"This save was made by a newer version of TripleA.<br>\"\n+                + \"To load this save, download the latest version of TripleA: \"\n+                + \"<a href=\\\"{}\\\">{}</a>\",\n+            UrlConstants.DOWNLOAD_WEBSITE,\n+            UrlConstants.DOWNLOAD_WEBSITE);\n+        return Optional.empty();\n+      } else {\n+        final GameData data = (GameData) input.readObject();\n+        data.postDeSerialize();\n+        loadDelegates(input, data);\n+        return Optional.of(data);\n       }\n-\n-      final GameData data = (GameData) input.readObject();\n-      data.postDeSerialize();\n-      loadDelegates(input, data);\n-      return data;\n-    } catch (final ClassNotFoundException cnfe) {\n-      throw new IOException(cnfe.getMessage());\n-    }\n-  }\n-\n-  private static void promptToLoadNewerSaveGame() throws IOException {\n-    // this is needed because a newer client might depend on variables that are part of the new\n-    // save but will be stripped by the old client. When the old client re-saves the data, the\n-    // new client will load the save game and be in odd state.\n-    final String messageString =\n-        \"This save was made by a newer version of TripleA.\"\n-            + \"\\nPlaying newer saves with an older engine can lead to unpredictable problems. \"\n-            + \"It is recommended that you upgrade to the latest version of TripleA before playing \"\n-            + \"this save game. To download the latest version of TripleA, Please visit \"\n-            + UrlConstants.DOWNLOAD_WEBSITE\n-            + \".\\n\"\n-            + \"\\n\\nDo you wish to continue and open this save with your current 'old' version?;\";\n-    final int answer =\n-        JOptionPane.showConfirmDialog(\n-            null, messageString, \"Open Newer Save Game?\", JOptionPane.YES_NO_OPTION);\n-    if (answer != JOptionPane.YES_OPTION) {\n-      throw new IOException(\"Loading the save game was aborted\");\n+    } catch (final ClassNotFoundException | IOException e) {\n+      log.error(\"Error loading game data\", e);\n+      return Optional.empty();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53e697119819508c407656bd17fc08cd9962a477"}, "originalPosition": 135}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21ab1cf0687bdb1bdf71562c87bbbb3eb1a26335", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/21ab1cf0687bdb1bdf71562c87bbbb3eb1a26335", "committedDate": "2020-10-12T23:57:00Z", "message": "Update version matching to ignore point when comparing save game compatibility"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3877, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}