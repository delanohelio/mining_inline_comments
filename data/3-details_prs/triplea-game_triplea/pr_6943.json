{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxNzk2MTU2", "number": 6943, "title": "Save the owner of the new units in case another action changes the ownership", "bodyText": "Fixes #6439\nIn Warcraft War Heroes, units are transformed into \"loot\" that is then captured by the winner.  When the loot is first added to the battle, it is owned by the loser.  This causes a series of change commands:\n\nRemove Unit\nAdd Unit\nChange Unit's Owner\n\nWhen the AI is playing and the user is spectating, the history also sees these change commands and converts them to its local gameData.\nThe problem occurs when the steps happen in the following manner:\n\nGame - Add Unit\nGame - Change Unit's Owner\nHistory - Add Unit\nGame - Change Unit's Owner\n\nWhen 3 runs, it is using the unit that had its owner changed in 2.  So the change owner in 4 throws an error because the owner is different from what it is expecting.\nThis fix stores the original owner when the unit is added.  So when 3 runs, it can ensure that the unit has the original owner and not the new one.\nFunctional Changes\n\n[] New map or map update\n[] New Feature\n[] Feature update or enhancement\n[] Feature Removal\n[] Code Cleanup or refactor\n[] Configuration Change\n[x] Problem fix\n[] Other:   \nTesting\nLoaded a save that had the exception and ensured that the exception didn't happen.  Also checked that save games still loaded.\nScreens Shots\n\nAdditional Notes to Reviewer\n\nRelease Note\n\nFIX|PlayerOwnerChange exception in Warcraft War Heroes is fixed", "createdAt": "2020-06-30T05:43:34Z", "url": "https://github.com/triplea-game/triplea/pull/6943", "merged": true, "mergeCommit": {"oid": "9402b78ff27ec15d70654dcabe6dbe9ecc8beb3e"}, "closed": true, "closedAt": "2020-07-01T22:13:26Z", "author": {"login": "trevan"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwO3NIgH2gAyNDQxNzk2MTU2OmE2Njk0NjE5MTUwOTU2YzkwZDg3NTgyNGQxNDQ4Y2M0M2IyM2IwMGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwxjyUgFqTQ0MTIyMjQ0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a6694619150956c90d875824d1448cc43b23b00d", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/a6694619150956c90d875824d1448cc43b23b00d", "committedDate": "2020-06-30T05:33:25Z", "message": "Save the owner of the new units in case another action changes the ownership"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db68d72778490664400c527d55e8399ed6d4ce74", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/db68d72778490664400c527d55e8399ed6d4ce74", "committedDate": "2020-06-30T14:39:43Z", "message": "Handle case where unit isn't in the gameData yet"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59b252e3450e35fb03d2cfdf6d33cf2ff03f9720", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/59b252e3450e35fb03d2cfdf6d33cf2ff03f9720", "committedDate": "2020-06-30T15:25:52Z", "message": "Merge remote-tracking branch 'upstream/master' into player-owner-change-error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMTgxMzE2", "url": "https://github.com/triplea-game/triplea/pull/6943#pullrequestreview-441181316", "createdAt": "2020-07-01T20:39:08Z", "commit": {"oid": "59b252e3450e35fb03d2cfdf6d33cf2ff03f9720"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMDozOTowOFrOGr0nTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMDo0MjozNFrOGr0tUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwMzk4Mg==", "bodyText": "nit: 'get' methods usually are just 'getters'. If computation is done a different verb could be easier for future maintainers. Perhaps rewording this to buildUnitPlayerMap would help that. WDYT @trevan ?", "url": "https://github.com/triplea-game/triplea/pull/6943#discussion_r448603982", "createdAt": "2020-07-01T20:39:08Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java", "diffHunk": "@@ -15,19 +20,26 @@\n   private final String name;\n   private final Collection<Unit> units;\n   private final String type;\n+  private Map<UUID, String> unitPlayerMap;\n \n   AddUnits(final UnitCollection collection, final Collection<Unit> units) {\n-    this.units = new ArrayList<>(units);\n+    this.units = units;\n+    unitPlayerMap = getUnitPlayerMap(units);\n     name = collection.getHolder().getName();\n     type = collection.getHolder().getType();\n   }\n \n   AddUnits(final String name, final String type, final Collection<Unit> units) {\n-    this.units = new ArrayList<>(units);\n+    this.units = units;\n+    unitPlayerMap = getUnitPlayerMap(units);\n     this.type = type;\n     this.name = name;\n   }\n \n+  private Map<UUID, String> getUnitPlayerMap(final Collection<Unit> units) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59b252e3450e35fb03d2cfdf6d33cf2ff03f9720"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwNTQxNw==", "bodyText": "If we're iterating over the entry set of the unitPlayerMap, why do we need a map for this? Can we not just iterate over the set of units and avoid the map data structure altogether?", "url": "https://github.com/triplea-game/triplea/pull/6943#discussion_r448605417", "createdAt": "2020-07-01T20:42:19Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java", "diffHunk": "@@ -36,11 +48,36 @@ public Change invert() {\n   @Override\n   protected void perform(final GameData data) {\n     final UnitHolder holder = data.getUnitHolder(name, type);\n-    holder.getUnitCollection().addAll(units);\n+    final Collection<Unit> unitsWithCorrectOwner = getUnitsWithOwner(data);\n+    holder.getUnitCollection().addAll(unitsWithCorrectOwner);\n+  }\n+\n+  private Collection<Unit> getUnitsWithOwner(final GameData data) {\n+    final Map<UUID, Unit> uuidToUnits =\n+        units.stream().collect(Collectors.toMap(Unit::getId, unit -> unit));\n+    return unitPlayerMap.entrySet().stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59b252e3450e35fb03d2cfdf6d33cf2ff03f9720"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwNTUyMw==", "bodyText": "This could be a moot comment if it turns out we do not need a map.", "url": "https://github.com/triplea-game/triplea/pull/6943#discussion_r448605523", "createdAt": "2020-07-01T20:42:34Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java", "diffHunk": "@@ -15,19 +20,26 @@\n   private final String name;\n   private final Collection<Unit> units;\n   private final String type;\n+  private Map<UUID, String> unitPlayerMap;\n \n   AddUnits(final UnitCollection collection, final Collection<Unit> units) {\n-    this.units = new ArrayList<>(units);\n+    this.units = units;\n+    unitPlayerMap = getUnitPlayerMap(units);\n     name = collection.getHolder().getName();\n     type = collection.getHolder().getType();\n   }\n \n   AddUnits(final String name, final String type, final Collection<Unit> units) {\n-    this.units = new ArrayList<>(units);\n+    this.units = units;\n+    unitPlayerMap = getUnitPlayerMap(units);\n     this.type = type;\n     this.name = name;\n   }\n \n+  private Map<UUID, String> getUnitPlayerMap(final Collection<Unit> units) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwMzk4Mg=="}, "originalCommit": {"oid": "59b252e3450e35fb03d2cfdf6d33cf2ff03f9720"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d9e114af825a5d249f7bbf885ec0055ebd62238", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/9d9e114af825a5d249f7bbf885ec0055ebd62238", "committedDate": "2020-07-01T21:52:57Z", "message": "Improve naming and add documentation for the unit-owner map"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjIyNDQ0", "url": "https://github.com/triplea-game/triplea/pull/6943#pullrequestreview-441222444", "createdAt": "2020-07-01T21:57:11Z", "commit": {"oid": "9d9e114af825a5d249f7bbf885ec0055ebd62238"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMTo1NzoxMlrOGr2pyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMTo1ODoyMlrOGr2rjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzNzM4Ng==", "bodyText": "side-note / big nit, this method could be static. I think we need to try and see if we can share a config that turns on the static analysis warning that methods can be marked as static.\nFor me it's really helpful as I watch for private methods being static. If they are, I know they do not interact with the class state. If they are not static, I assume they cannot be static and hence interact with class state.", "url": "https://github.com/triplea-game/triplea/pull/6943#discussion_r448637386", "createdAt": "2020-07-01T21:57:12Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java", "diffHunk": "@@ -15,19 +20,31 @@\n   private final String name;\n   private final Collection<Unit> units;\n   private final String type;\n+  /**\n+   * The unit's owner can be modified sometime after this Change is created but before it is\n+   * performed. To ensure that the newly created units have the correct ownership, their original\n+   * owners are stored in this separate map.\n+   */\n+  private Map<UUID, String> unitOwnerMap;\n \n   AddUnits(final UnitCollection collection, final Collection<Unit> units) {\n-    this.units = new ArrayList<>(units);\n+    this.units = units;\n+    unitOwnerMap = buildUnitOwnerMap(units);\n     name = collection.getHolder().getName();\n     type = collection.getHolder().getType();\n   }\n \n   AddUnits(final String name, final String type, final Collection<Unit> units) {\n-    this.units = new ArrayList<>(units);\n+    this.units = units;\n+    unitOwnerMap = buildUnitOwnerMap(units);\n     this.type = type;\n     this.name = name;\n   }\n \n+  private Map<UUID, String> buildUnitOwnerMap(final Collection<Unit> units) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d9e114af825a5d249f7bbf885ec0055ebd62238"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzNzgzOA==", "bodyText": "A test of some sort to verify the right functionality would be a good thing to have. If we change & break this, we'll have the extra safety net. Testing is really good for ensuring correctness, which is a further safety net that would be good to have as well.", "url": "https://github.com/triplea-game/triplea/pull/6943#discussion_r448637838", "createdAt": "2020-07-01T21:58:22Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java", "diffHunk": "@@ -36,11 +53,36 @@ public Change invert() {\n   @Override\n   protected void perform(final GameData data) {\n     final UnitHolder holder = data.getUnitHolder(name, type);\n-    holder.getUnitCollection().addAll(units);\n+    final Collection<Unit> unitsWithCorrectOwner = buildUnitsWithOwner(data);\n+    holder.getUnitCollection().addAll(unitsWithCorrectOwner);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d9e114af825a5d249f7bbf885ec0055ebd62238"}, "originalPosition": 58}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3316, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}