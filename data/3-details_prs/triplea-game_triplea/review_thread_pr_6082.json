{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyNzc2MjEw", "number": 6082, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwNDo1OTozOVrODqpL6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwNDo1OTo0MFrODqpL7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2MDQxNTc4OnYy", "diffSide": "RIGHT", "path": "http-server/src/main/java/org/triplea/db/dao/username/ban/UsernameBanRecord.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwNDo1OTozOVrOF6hCUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwNDo1OTozOVrOF6hCUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwMjk5Mg==", "bodyText": "Similar blocks of code found in 2 locations. Consider refactoring.", "url": "https://github.com/triplea-game/triplea/pull/6082#discussion_r396902992", "createdAt": "2020-03-24T04:59:39Z", "author": {"login": "codeclimate"}, "path": "http-server/src/main/java/org/triplea/db/dao/username/ban/UsernameBanRecord.java", "diffHunk": "@@ -1,12 +1,12 @@\n-package org.triplea.lobby.server.db.dao.username.ban;\n+package org.triplea.db.dao.username.ban;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36e712c8ec7ac5f063ceb678ce2c3101bdf1e212"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2MDQxNTgxOnYy", "diffSide": "RIGHT", "path": "http-server/src/main/java/org/triplea/db/data/ModeratorUserDaoData.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwNDo1OTozOVrOF6hCUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwNDo1OTozOVrOF6hCUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwMjk5NQ==", "bodyText": "Similar blocks of code found in 2 locations. Consider refactoring.", "url": "https://github.com/triplea-game/triplea/pull/6082#discussion_r396902995", "createdAt": "2020-03-24T04:59:39Z", "author": {"login": "codeclimate"}, "path": "http-server/src/main/java/org/triplea/db/data/ModeratorUserDaoData.java", "diffHunk": "@@ -1,12 +1,12 @@\n-package org.triplea.lobby.server.db.data;\n+package org.triplea.db.data;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36e712c8ec7ac5f063ceb678ce2c3101bdf1e212"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2MDQxNTgyOnYy", "diffSide": "RIGHT", "path": "http-server/src/main/java/org/triplea/modules/moderation/ban/user/UserBanService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwNDo1OTozOVrOF6hCVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwNDo1OTozOVrOF6hCVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwMjk5Ng==", "bodyText": "Method banUser has 28 lines of code (exceeds 25 allowed). Consider refactoring.", "url": "https://github.com/triplea-game/triplea/pull/6082#discussion_r396902996", "createdAt": "2020-03-24T04:59:39Z", "author": {"login": "codeclimate"}, "path": "http-server/src/main/java/org/triplea/modules/moderation/ban/user/UserBanService.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package org.triplea.modules.moderation.ban.user;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.UUID;\n+import java.util.function.BiConsumer;\n+import java.util.function.Supplier;\n+import java.util.stream.Collectors;\n+import javax.annotation.Nonnull;\n+import javax.websocket.Session;\n+import lombok.Builder;\n+import org.jdbi.v3.core.Jdbi;\n+import org.triplea.db.dao.ModeratorAuditHistoryDao;\n+import org.triplea.db.dao.api.key.ApiKeyDaoWrapper;\n+import org.triplea.db.dao.api.key.GamePlayerLookup;\n+import org.triplea.db.dao.user.ban.UserBanDao;\n+import org.triplea.domain.data.PlayerChatId;\n+import org.triplea.domain.data.UserName;\n+import org.triplea.http.client.IpAddressParser;\n+import org.triplea.http.client.lobby.chat.messages.server.ChatServerEnvelopeFactory;\n+import org.triplea.http.client.lobby.moderator.BanDurationFormatter;\n+import org.triplea.http.client.lobby.moderator.BanPlayerRequest;\n+import org.triplea.http.client.lobby.moderator.toolbox.banned.user.UserBanData;\n+import org.triplea.http.client.lobby.moderator.toolbox.banned.user.UserBanParams;\n+import org.triplea.http.client.web.socket.messages.ServerMessageEnvelope;\n+import org.triplea.modules.chat.event.processing.Chatters;\n+import org.triplea.modules.moderation.remote.actions.RemoteActionsEventQueue;\n+import org.triplea.web.socket.MessageBroadcaster;\n+\n+/**\n+ * Service layer for managing user bans, get bans, add and remove. User bans are done by MAC and IP\n+ * address, they are removed by the 'public ban id' that is assigned when a ban is issued.\n+ */\n+@Builder\n+public class UserBanService {\n+\n+  @Nonnull private final ModeratorAuditHistoryDao moderatorAuditHistoryDao;\n+  @Nonnull private final UserBanDao userBanDao;\n+  @Nonnull private final Supplier<String> publicIdSupplier;\n+  @Nonnull private final Chatters chatters;\n+  @Nonnull private final RemoteActionsEventQueue remoteActionsEventQueue;\n+  @Nonnull private final ApiKeyDaoWrapper apiKeyDaoWrapper;\n+  @Nonnull private final BiConsumer<Collection<Session>, ServerMessageEnvelope> messageBroadcaster;\n+\n+  public static UserBanService build(\n+      final Jdbi jdbi,\n+      final Chatters chatters,\n+      final RemoteActionsEventQueue remoteActionsEventQueue) {\n+\n+    return UserBanService.builder()\n+        .moderatorAuditHistoryDao(jdbi.onDemand(ModeratorAuditHistoryDao.class))\n+        .userBanDao(jdbi.onDemand(UserBanDao.class))\n+        .publicIdSupplier(() -> UUID.randomUUID().toString())\n+        .chatters(chatters)\n+        .remoteActionsEventQueue(remoteActionsEventQueue)\n+        .apiKeyDaoWrapper(ApiKeyDaoWrapper.build(jdbi))\n+        .messageBroadcaster(MessageBroadcaster.build())\n+        .build();\n+  }\n+\n+  List<UserBanData> getBannedUsers() {\n+    return userBanDao.lookupBans().stream()\n+        .map(\n+            daoData ->\n+                UserBanData.builder()\n+                    .banId(daoData.getPublicBanId())\n+                    .username(daoData.getUsername())\n+                    .hashedMac(daoData.getSystemId())\n+                    .ip(daoData.getIp())\n+                    .banDate(daoData.getDateCreated())\n+                    .banExpiry(daoData.getBanExpiry())\n+                    .build())\n+        .collect(Collectors.toList());\n+  }\n+\n+  boolean removeUserBan(final int moderatorId, final String banId) {\n+    final String unbanName = userBanDao.lookupUsernameByBanId(banId).orElse(null);\n+    if (userBanDao.removeBan(banId) != 1) {\n+      return false;\n+    }\n+    if (unbanName == null) {\n+      throw new IllegalStateException(\n+          \"Consistency error, unbanned \"\n+              + banId\n+              + \", but \"\n+              + \"there was no matching name for that ban.\");\n+    }\n+\n+    moderatorAuditHistoryDao.addAuditRecord(\n+        ModeratorAuditHistoryDao.AuditArgs.builder()\n+            .actionName(ModeratorAuditHistoryDao.AuditAction.REMOVE_USER_BAN)\n+            .actionTarget(unbanName)\n+            .moderatorUserId(moderatorId)\n+            .build());\n+    return true;\n+  }\n+\n+  boolean banUser(final int moderatorId, final BanPlayerRequest banPlayerRequest) {\n+    return apiKeyDaoWrapper\n+        .lookupPlayerByChatId(PlayerChatId.of(banPlayerRequest.getPlayerChatId()))\n+        .map(\n+            gamePlayerLookup -> toUserBanParams(gamePlayerLookup, banPlayerRequest.getBanMinutes()))\n+        .map(banUserParams -> banUser(moderatorId, banUserParams))\n+        .orElse(false);\n+  }\n+\n+  boolean banUser(final int moderatorId, final UserBanParams banUserParams) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36e712c8ec7ac5f063ceb678ce2c3101bdf1e212"}, "originalPosition": 107}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2MDQxNTgzOnYy", "diffSide": "RIGHT", "path": "http-server/src/main/java/org/triplea/modules/moderation/ban/user/UserBanService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwNDo1OTo0MFrOF6hCVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwNDo1OTo0MFrOF6hCVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwMjk5Nw==", "bodyText": "Similar blocks of code found in 2 locations. Consider refactoring.", "url": "https://github.com/triplea-game/triplea/pull/6082#discussion_r396902997", "createdAt": "2020-03-24T04:59:40Z", "author": {"login": "codeclimate"}, "path": "http-server/src/main/java/org/triplea/modules/moderation/ban/user/UserBanService.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package org.triplea.modules.moderation.ban.user;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.UUID;\n+import java.util.function.BiConsumer;\n+import java.util.function.Supplier;\n+import java.util.stream.Collectors;\n+import javax.annotation.Nonnull;\n+import javax.websocket.Session;\n+import lombok.Builder;\n+import org.jdbi.v3.core.Jdbi;\n+import org.triplea.db.dao.ModeratorAuditHistoryDao;\n+import org.triplea.db.dao.api.key.ApiKeyDaoWrapper;\n+import org.triplea.db.dao.api.key.GamePlayerLookup;\n+import org.triplea.db.dao.user.ban.UserBanDao;\n+import org.triplea.domain.data.PlayerChatId;\n+import org.triplea.domain.data.UserName;\n+import org.triplea.http.client.IpAddressParser;\n+import org.triplea.http.client.lobby.chat.messages.server.ChatServerEnvelopeFactory;\n+import org.triplea.http.client.lobby.moderator.BanDurationFormatter;\n+import org.triplea.http.client.lobby.moderator.BanPlayerRequest;\n+import org.triplea.http.client.lobby.moderator.toolbox.banned.user.UserBanData;\n+import org.triplea.http.client.lobby.moderator.toolbox.banned.user.UserBanParams;\n+import org.triplea.http.client.web.socket.messages.ServerMessageEnvelope;\n+import org.triplea.modules.chat.event.processing.Chatters;\n+import org.triplea.modules.moderation.remote.actions.RemoteActionsEventQueue;\n+import org.triplea.web.socket.MessageBroadcaster;\n+\n+/**\n+ * Service layer for managing user bans, get bans, add and remove. User bans are done by MAC and IP\n+ * address, they are removed by the 'public ban id' that is assigned when a ban is issued.\n+ */\n+@Builder\n+public class UserBanService {\n+\n+  @Nonnull private final ModeratorAuditHistoryDao moderatorAuditHistoryDao;\n+  @Nonnull private final UserBanDao userBanDao;\n+  @Nonnull private final Supplier<String> publicIdSupplier;\n+  @Nonnull private final Chatters chatters;\n+  @Nonnull private final RemoteActionsEventQueue remoteActionsEventQueue;\n+  @Nonnull private final ApiKeyDaoWrapper apiKeyDaoWrapper;\n+  @Nonnull private final BiConsumer<Collection<Session>, ServerMessageEnvelope> messageBroadcaster;\n+\n+  public static UserBanService build(\n+      final Jdbi jdbi,\n+      final Chatters chatters,\n+      final RemoteActionsEventQueue remoteActionsEventQueue) {\n+\n+    return UserBanService.builder()\n+        .moderatorAuditHistoryDao(jdbi.onDemand(ModeratorAuditHistoryDao.class))\n+        .userBanDao(jdbi.onDemand(UserBanDao.class))\n+        .publicIdSupplier(() -> UUID.randomUUID().toString())\n+        .chatters(chatters)\n+        .remoteActionsEventQueue(remoteActionsEventQueue)\n+        .apiKeyDaoWrapper(ApiKeyDaoWrapper.build(jdbi))\n+        .messageBroadcaster(MessageBroadcaster.build())\n+        .build();\n+  }\n+\n+  List<UserBanData> getBannedUsers() {\n+    return userBanDao.lookupBans().stream()\n+        .map(\n+            daoData ->\n+                UserBanData.builder()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36e712c8ec7ac5f063ceb678ce2c3101bdf1e212"}, "originalPosition": 65}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2367, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}