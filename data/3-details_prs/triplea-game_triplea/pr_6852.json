{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwMTc5MDA5", "number": 6852, "title": "Fix UnsupportedOperationException trying to modify a collection.", "bodyText": "Fix UnsupportedOperationException trying to modify a collection.\nMake a copy of the collection when calling remove().\nFixes: #6818\n\nFunctional Changes\n\n[] New map or map update\n[] New Feature\n[] Feature update or enhancement\n[] Feature Removal\n[] Code Cleanup or refactor\n[] Configuration Change\n[X] Problem fix #6818\n[] Other:   \nTesting\n\nNone. Found the issue via the stack trace from the error report.\nScreens Shots\n\nAdditional Notes to Reviewer\n\nRelease Note", "createdAt": "2020-06-25T18:10:13Z", "url": "https://github.com/triplea-game/triplea/pull/6852", "merged": true, "mergeCommit": {"oid": "fd802dd3a867d6716d2432b20a590b5ebe5ff04f"}, "closed": true, "closedAt": "2020-06-28T23:50:29Z", "author": {"login": "asvitkine"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuyrBzgH2gAyNDQwMTc5MDA5OjViYjEwYTMxMzVlNWZlYjE0OTczZDU3M2Q1NWVjYWRmM2Y0Mjc0ODQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcv0H_jgH2gAyNDQwMTc5MDA5OmI4MGU4NDc5N2UxZmZiNDE1ZTM2YmY0ZDY1NWQ5MDExMThmMTczYWM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5bb10a3135e5feb14973d573d55ecadf3f427484", "author": {"user": {"login": "asvitkine", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/5bb10a3135e5feb14973d573d55ecadf3f427484", "committedDate": "2020-06-25T18:08:51Z", "message": "Fix UnsupportedOperationException trying to modify a collection.\n\nMake a copy of the collection when calling remove()."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4MDExNjI0", "url": "https://github.com/triplea-game/triplea/pull/6852#pullrequestreview-438011624", "createdAt": "2020-06-26T04:51:24Z", "commit": {"oid": "5bb10a3135e5feb14973d573d55ecadf3f427484"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwNDo1MToyNFrOGpTm5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwNDo1MToyNFrOGpTm5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk2NjA1Mg==", "bodyText": "I'm not sure if this is the best fix. Creating a copy probably should be the responsibility of the method, not the caller. Usually we would want APIs to be impossible to use and not have arcane contracts where just by using the API you break it.\nIt's also a bit odd as it's difficult to see what the side effect would be from either the parameters or the method name (yikes, the code here really could have used some improvements..)\nWhat's the cost to moving the copy to the method? Failing that, perhaps it should be commented here why we create a copy, but that leaves unresolved that we have a very brittle API that can break just by using it in a very reasonable way.", "url": "https://github.com/triplea-game/triplea/pull/6852#discussion_r445966052", "createdAt": "2020-06-26T04:51:24Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/MustFightBattle.java", "diffHunk": "@@ -639,7 +639,7 @@ private void removeFromNonCombatLandings(\n       if (landedTerritory == null) {\n         throw new IllegalStateException(\"not unloaded?:\" + units);\n       }\n-      remove(lost, bridge, landedTerritory, false);\n+      remove(new ArrayList<>(lost), bridge, landedTerritory, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bb10a3135e5feb14973d573d55ecadf3f427484"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcb9e22d163f1cb64675a7e6cc75e69bb0a29c69", "author": {"user": {"login": "asvitkine", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/fcb9e22d163f1cb64675a7e6cc75e69bb0a29c69", "committedDate": "2020-06-26T11:02:00Z", "message": "Make remove() do the copying if needed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92959c04358bedea07c7fb116040c0ca4efe56ad", "author": {"user": {"login": "asvitkine", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/92959c04358bedea07c7fb116040c0ca4efe56ad", "committedDate": "2020-06-26T11:02:59Z", "message": "unmodifiable return"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82662df34a398b74d1ccdb4a5218b5f22ccb9aff", "author": {"user": {"login": "asvitkine", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/82662df34a398b74d1ccdb4a5218b5f22ccb9aff", "committedDate": "2020-06-26T11:07:30Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "442aeed408f0d1cfb5a396106e317b15eca11d5d", "author": {"user": {"login": "asvitkine", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/442aeed408f0d1cfb5a396106e317b15eca11d5d", "committedDate": "2020-06-26T11:18:36Z", "message": "use a more concise construct"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4ODEwOTMx", "url": "https://github.com/triplea-game/triplea/pull/6852#pullrequestreview-438810931", "createdAt": "2020-06-28T20:31:53Z", "commit": {"oid": "442aeed408f0d1cfb5a396106e317b15eca11d5d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQyMDozMTo1M1rOGqAFyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQyMDozMzoyMFrOGqAGRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY5NDg1Ng==", "bodyText": "Does concat of a non-empty collection with an empty collection return just the non-empty collection? Perhaps we should just let the API do that for us?\nIn, part, it's strange that if you pass an mutable list to getWithDependents that is empty, you get a mutable list back from this method, but passing a non-empty mutable list returns an immutable collection. Generally a returned collection should always be mutable or immutable and not depend on its parameter.", "url": "https://github.com/triplea-game/triplea/pull/6852#discussion_r446694856", "createdAt": "2020-06-28T20:31:53Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/AbstractBattle.java", "diffHunk": "@@ -97,6 +98,14 @@\n     return Collections.unmodifiableList(dependentUnits);\n   }\n \n+  protected Collection<Unit> getWithDependents(final Collection<Unit> units) {\n+    final Collection<Unit> dependentUnits = getDependentUnits(units);\n+    if (dependentUnits.isEmpty()) {\n+      return units;\n+    }\n+    return ImmutableList.copyOf(Iterables.concat(units, dependentUnits));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "442aeed408f0d1cfb5a396106e317b15eca11d5d"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY5NDk4Mg==", "bodyText": "getWithDependents is notable to me as a method name. It makes me wonder 'get what?'\ngetUnitWithDependents makes perhaps more sense. Though, if we have a one-liner method, perhaps just in-lining this in the two places its used is just as well? WDYT?", "url": "https://github.com/triplea-game/triplea/pull/6852#discussion_r446694982", "createdAt": "2020-06-28T20:33:20Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/AbstractBattle.java", "diffHunk": "@@ -97,6 +98,14 @@\n     return Collections.unmodifiableList(dependentUnits);\n   }\n \n+  protected Collection<Unit> getWithDependents(final Collection<Unit> units) {\n+    final Collection<Unit> dependentUnits = getDependentUnits(units);\n+    if (dependentUnits.isEmpty()) {\n+      return units;\n+    }\n+    return ImmutableList.copyOf(Iterables.concat(units, dependentUnits));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY5NDg1Ng=="}, "originalCommit": {"oid": "442aeed408f0d1cfb5a396106e317b15eca11d5d"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b80e84797e1ffb415e36bf4d655d901118f173ac", "author": {"user": {"login": "asvitkine", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/b80e84797e1ffb415e36bf4d655d901118f173ac", "committedDate": "2020-06-28T22:24:19Z", "message": "Rename method and always return an unmodifiable collection."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3289, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}