{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxMTE0NzM4", "number": 6062, "title": "Remove websocket dependency", "bodyText": "When looking at #6027 it seems like the Java-WebSocket dependency introduced the SLF4J dependency according to gradle (gradle game-headless:dependencies).\nSo I decided to use the default JDK API for websockets instead. It works slightly different with some gotchas and more fine grained control, but I verified it actually works.\nFunctional Changes\n\n[] New map or map update\n[] New Feature\n[] Feature update or enhancement\n[] Feature Removal\n[x] Code Cleanup or refactor\n[] Configuration Change\n[] Problem fix:  #6027 (Haven't actually verified that, but it no longer has the dependency)\n[] Other:   \nTesting\n\nI verified I could join the lobby and send some chat messages (it uses the same code)", "createdAt": "2020-03-19T16:42:52Z", "url": "https://github.com/triplea-game/triplea/pull/6062", "merged": true, "mergeCommit": {"oid": "15355d398cc5f98c0b8deadc589a0714cbc46110"}, "closed": true, "closedAt": "2020-03-29T20:19:54Z", "author": {"login": "RoiEXLab"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPSnjBAFqTM3ODA5NDY4MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcSeuy3gH2gAyMzkxMTE0NzM4OmI5ZGU4NDc3MWU1MjExMjRmZjY1ZjNiZjMzN2NhNmE1ZDk2NjE0MTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4MDk0Njgx", "url": "https://github.com/triplea-game/triplea/pull/6062#pullrequestreview-378094681", "createdAt": "2020-03-19T21:08:30Z", "commit": {"oid": "b0390aa6121579fd8607c2558b45ed59ae694e3c"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMTowODozMVrOF5AcxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMToxMjowOFrOF5Ajrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMyMDUxNg==", "bodyText": "The server will disconnect banned clients, this is probably not a case where we want to do logging. Likely we want to show an info message, probably just let the connection closed listener handle it.", "url": "https://github.com/triplea-game/triplea/pull/6062#discussion_r395320516", "createdAt": "2020-03-19T21:08:31Z", "author": {"login": "DanVanAtta"}, "path": "http-clients/src/main/java/org/triplea/http/client/web/socket/WebSocketConnection.java", "diffHunk": "@@ -49,17 +58,67 @@\n       onMethod_ = {@VisibleForTesting})\n   private boolean connectionIsOpen = false;\n \n+  @Setter(\n+      value = AccessLevel.PACKAGE,\n+      onMethod_ = {@VisibleForTesting})\n+  private HttpClient httpClient = HttpClient.newHttpClient();\n+\n   private final URI serverUri;\n \n   private boolean closed = false;\n \n+  private WebSocket client;\n+\n   @Getter(\n       value = AccessLevel.PACKAGE,\n       onMethod_ = {@VisibleForTesting})\n-  @Setter(\n-      value = AccessLevel.PACKAGE,\n-      onMethod_ = {@VisibleForTesting})\n-  private WebSocketClient client;\n+  private final WebSocket.Listener webSocketListener =\n+      new Listener() {\n+        private final StringBuilder textAccumulator = new StringBuilder();\n+\n+        @Override\n+        public void onOpen(final WebSocket webSocket) {\n+          synchronized (queuedMessages) {\n+            client = webSocket;\n+            connectionIsOpen = true;\n+            queuedMessages.forEach(\n+                message ->\n+                    client\n+                        .sendText(message, true)\n+                        .exceptionally(logWebSocketError(\"Failed to send queued text.\")));\n+            queuedMessages.clear();\n+          }\n+          webSocket.request(1);\n+        }\n+\n+        @Override\n+        public CompletionStage<?> onText(\n+            final WebSocket webSocket, final CharSequence data, final boolean last) {\n+          textAccumulator.append(data);\n+          if (last) {\n+            listener.messageReceived(textAccumulator.toString());\n+            textAccumulator.setLength(0);\n+          }\n+          webSocket.request(1);\n+          return null;\n+        }\n+\n+        @Override\n+        public CompletionStage<?> onClose(\n+            final WebSocket webSocket, final int statusCode, final String reason) {\n+          if (!reason.equals(CLIENT_DISCONNECT_MESSAGE)) {\n+            log.severe(\"Connection to server closed: \" + reason);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0390aa6121579fd8607c2558b45ed59ae694e3c"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMyMTQyNQ==", "bodyText": "I like that we continue to abstract away the underlying API, though CharSequence and boolean last seem to be not as nice of an API. I think this websocket library loses points here.", "url": "https://github.com/triplea-game/triplea/pull/6062#discussion_r395321425", "createdAt": "2020-03-19T21:10:21Z", "author": {"login": "DanVanAtta"}, "path": "http-clients/src/main/java/org/triplea/http/client/web/socket/WebSocketConnection.java", "diffHunk": "@@ -49,17 +58,67 @@\n       onMethod_ = {@VisibleForTesting})\n   private boolean connectionIsOpen = false;\n \n+  @Setter(\n+      value = AccessLevel.PACKAGE,\n+      onMethod_ = {@VisibleForTesting})\n+  private HttpClient httpClient = HttpClient.newHttpClient();\n+\n   private final URI serverUri;\n \n   private boolean closed = false;\n \n+  private WebSocket client;\n+\n   @Getter(\n       value = AccessLevel.PACKAGE,\n       onMethod_ = {@VisibleForTesting})\n-  @Setter(\n-      value = AccessLevel.PACKAGE,\n-      onMethod_ = {@VisibleForTesting})\n-  private WebSocketClient client;\n+  private final WebSocket.Listener webSocketListener =\n+      new Listener() {\n+        private final StringBuilder textAccumulator = new StringBuilder();\n+\n+        @Override\n+        public void onOpen(final WebSocket webSocket) {\n+          synchronized (queuedMessages) {\n+            client = webSocket;\n+            connectionIsOpen = true;\n+            queuedMessages.forEach(\n+                message ->\n+                    client\n+                        .sendText(message, true)\n+                        .exceptionally(logWebSocketError(\"Failed to send queued text.\")));\n+            queuedMessages.clear();\n+          }\n+          webSocket.request(1);\n+        }\n+\n+        @Override\n+        public CompletionStage<?> onText(\n+            final WebSocket webSocket, final CharSequence data, final boolean last) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0390aa6121579fd8607c2558b45ed59ae694e3c"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMyMTkzNQ==", "bodyText": "If the ping cannot be sent, would it maybe mean the connection is already closed?\nWould we also want users to submit bug reports whenever this happens?\nI suspect we may want to no-op if the ping cannot be sent.", "url": "https://github.com/triplea-game/triplea/pull/6062#discussion_r395321935", "createdAt": "2020-03-19T21:11:21Z", "author": {"login": "DanVanAtta"}, "path": "http-clients/src/main/java/org/triplea/http/client/web/socket/WebSocketConnection.java", "diffHunk": "@@ -68,52 +127,28 @@\n \n   WebSocketConnection(final URI serverUri) {\n     this.serverUri = serverUri;\n-    client =\n-        new WebSocketClient(serverUri) {\n-          @Override\n-          public void onOpen(final ServerHandshake serverHandshake) {\n-            synchronized (queuedMessages) {\n-              connectionIsOpen = true;\n-              queuedMessages.forEach(this::send);\n-              queuedMessages.clear();\n-            }\n-          }\n-\n-          @Override\n-          public void onMessage(final String message) {\n-            listener.messageReceived(message);\n-          }\n-\n-          @Override\n-          public void onClose(final int code, final String reason, final boolean remote) {\n-            if (remote) {\n-              log.severe(\"Connection to server closed: \" + reason);\n-            }\n-            pingSender.cancel();\n-            listener.connectionClosed(reason);\n-          }\n-\n-          @Override\n-          public void onError(final Exception exception) {\n-            listener.handleError(exception);\n-          }\n-        };\n     pingSender =\n         Timers.fixedRateTimer(\"websocket-ping-sender\")\n             .period(45, TimeUnit.SECONDS)\n             .delay(45, TimeUnit.SECONDS)\n             .task(\n                 () -> {\n-                  if (client.isOpen()) {\n-                    client.sendPing();\n+                  if (!client.isOutputClosed()) {\n+                    client\n+                        .sendPing(ByteBuffer.wrap(\"Ping\".getBytes(StandardCharsets.UTF_8)))\n+                        .exceptionally(logWebSocketError(\"Failed to send ping.\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0390aa6121579fd8607c2558b45ed59ae694e3c"}, "originalPosition": 153}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMyMjI4Ng==", "bodyText": "This builder is kinda nice, this library gains a point IMO here for this.", "url": "https://github.com/triplea-game/triplea/pull/6062#discussion_r395322286", "createdAt": "2020-03-19T21:12:08Z", "author": {"login": "DanVanAtta"}, "path": "http-clients/src/main/java/org/triplea/http/client/web/socket/WebSocketConnection.java", "diffHunk": "@@ -123,39 +158,28 @@ void close() {\n    * @throws IllegalStateException Thrown if connection is already open (eg: connect called twice).\n    * @throws IllegalStateException Thrown if connection has been closed (ie: 'close()' was called)\n    */\n-  CompletableFuture<Boolean> connect(\n+  CompletableFuture<WebSocket> connect(\n       final WebSocketConnectionListener listener, final Consumer<String> errorHandler) {\n     this.listener = Preconditions.checkNotNull(listener);\n-    Preconditions.checkState(!client.isOpen());\n+    Preconditions.checkState(client == null);\n     Preconditions.checkState(!closed);\n \n     return connectAsync()\n         .whenComplete(\n-            (connected, throwable) -> {\n-              if (connected && throwable == null) {\n+            (webSocket, throwable) -> {\n+              if (webSocket != null && throwable == null) {\n                 pingSender.start();\n               } else {\n                 errorHandler.accept(\"Failed to connect to: \" + serverUri);\n               }\n             });\n   }\n \n-  private CompletableFuture<Boolean> connectAsync() {\n-    final CompletableFuture<Boolean> completableFuture = new CompletableFuture<>();\n-    // execute the connection attempt\n-    new Thread(\n-            () -> {\n-              boolean connected;\n-              try {\n-                connected =\n-                    client.connectBlocking(DEFAULT_CONNECT_TIMEOUT_MILLIS, TimeUnit.MILLISECONDS);\n-              } catch (final InterruptedException ignored) {\n-                connected = false;\n-              }\n-              completableFuture.complete(connected);\n-            })\n-        .start();\n-    return completableFuture;\n+  private CompletableFuture<WebSocket> connectAsync() {\n+    return httpClient\n+        .newWebSocketBuilder()\n+        .connectTimeout(Duration.ofMillis(DEFAULT_CONNECT_TIMEOUT_MILLIS))\n+        .buildAsync(serverUri, webSocketListener);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0390aa6121579fd8607c2558b45ed59ae694e3c"}, "originalPosition": 215}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4MjA4OTk5", "url": "https://github.com/triplea-game/triplea/pull/6062#pullrequestreview-378208999", "createdAt": "2020-03-20T02:48:20Z", "commit": {"oid": "b0390aa6121579fd8607c2558b45ed59ae694e3c"}, "state": "COMMENTED", "comments": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwMjo0ODoyMFrOF5GZfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwNDoyNzo1MFrOF5Havw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQxNzk4MA==", "bodyText": "We have to specify a ping message? Does this trigger the server 'onMessage'?\nI wonder at what point the jdk api implementation is truly worth it..", "url": "https://github.com/triplea-game/triplea/pull/6062#discussion_r395417980", "createdAt": "2020-03-20T02:48:20Z", "author": {"login": "DanVanAtta"}, "path": "http-clients/src/main/java/org/triplea/http/client/web/socket/WebSocketConnection.java", "diffHunk": "@@ -68,52 +127,28 @@\n \n   WebSocketConnection(final URI serverUri) {\n     this.serverUri = serverUri;\n-    client =\n-        new WebSocketClient(serverUri) {\n-          @Override\n-          public void onOpen(final ServerHandshake serverHandshake) {\n-            synchronized (queuedMessages) {\n-              connectionIsOpen = true;\n-              queuedMessages.forEach(this::send);\n-              queuedMessages.clear();\n-            }\n-          }\n-\n-          @Override\n-          public void onMessage(final String message) {\n-            listener.messageReceived(message);\n-          }\n-\n-          @Override\n-          public void onClose(final int code, final String reason, final boolean remote) {\n-            if (remote) {\n-              log.severe(\"Connection to server closed: \" + reason);\n-            }\n-            pingSender.cancel();\n-            listener.connectionClosed(reason);\n-          }\n-\n-          @Override\n-          public void onError(final Exception exception) {\n-            listener.handleError(exception);\n-          }\n-        };\n     pingSender =\n         Timers.fixedRateTimer(\"websocket-ping-sender\")\n             .period(45, TimeUnit.SECONDS)\n             .delay(45, TimeUnit.SECONDS)\n             .task(\n                 () -> {\n-                  if (client.isOpen()) {\n-                    client.sendPing();\n+                  if (!client.isOutputClosed()) {\n+                    client\n+                        .sendPing(ByteBuffer.wrap(\"Ping\".getBytes(StandardCharsets.UTF_8)))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0390aa6121579fd8607c2558b45ed59ae694e3c"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQxODE4OQ==", "bodyText": "If a websocket is not closed properly on client side, is that something that a user should send us a bug report over? Secondarily, a pop-up message that says \"failed to close\" may not be very helpful to a user. If we show an error message to a user, it would be best to inform them of what happened and what they should do about it. Given there is no real impact to them, I'm not sure if we really need to show them any message at all.", "url": "https://github.com/triplea-game/triplea/pull/6062#discussion_r395418189", "createdAt": "2020-03-20T02:49:44Z", "author": {"login": "DanVanAtta"}, "path": "http-clients/src/main/java/org/triplea/http/client/web/socket/WebSocketConnection.java", "diffHunk": "@@ -68,52 +127,28 @@\n \n   WebSocketConnection(final URI serverUri) {\n     this.serverUri = serverUri;\n-    client =\n-        new WebSocketClient(serverUri) {\n-          @Override\n-          public void onOpen(final ServerHandshake serverHandshake) {\n-            synchronized (queuedMessages) {\n-              connectionIsOpen = true;\n-              queuedMessages.forEach(this::send);\n-              queuedMessages.clear();\n-            }\n-          }\n-\n-          @Override\n-          public void onMessage(final String message) {\n-            listener.messageReceived(message);\n-          }\n-\n-          @Override\n-          public void onClose(final int code, final String reason, final boolean remote) {\n-            if (remote) {\n-              log.severe(\"Connection to server closed: \" + reason);\n-            }\n-            pingSender.cancel();\n-            listener.connectionClosed(reason);\n-          }\n-\n-          @Override\n-          public void onError(final Exception exception) {\n-            listener.handleError(exception);\n-          }\n-        };\n     pingSender =\n         Timers.fixedRateTimer(\"websocket-ping-sender\")\n             .period(45, TimeUnit.SECONDS)\n             .delay(45, TimeUnit.SECONDS)\n             .task(\n                 () -> {\n-                  if (client.isOpen()) {\n-                    client.sendPing();\n+                  if (!client.isOutputClosed()) {\n+                    client\n+                        .sendPing(ByteBuffer.wrap(\"Ping\".getBytes(StandardCharsets.UTF_8)))\n+                        .exceptionally(logWebSocketError(\"Failed to send ping.\"));\n                   }\n                 });\n   }\n \n   /** Does an async close of the current websocket connection. */\n   void close() {\n     closed = true;\n-    client.close();\n+    if (!client.isOutputClosed()) {\n+      client\n+          .sendClose(WebSocket.NORMAL_CLOSURE, CLIENT_DISCONNECT_MESSAGE)\n+          .exceptionally(logWebSocketError(\"Failed to close\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0390aa6121579fd8607c2558b45ed59ae694e3c"}, "originalPosition": 165}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQxODU3Ng==", "bodyText": "connected does not really make sense as a boolean parameter.\nassertThat(connected, is(webSocket)); is pretty odd.", "url": "https://github.com/triplea-game/triplea/pull/6062#discussion_r395418576", "createdAt": "2020-03-20T02:52:04Z", "author": {"login": "DanVanAtta"}, "path": "http-clients/src/test/java/org/triplea/http/client/web/socket/WebSocketConnectionTest.java", "diffHunk": "@@ -104,20 +148,29 @@ void tearDown() {\n     @Test\n     @DisplayName(\"Verify connect initiates connection and starts the pinger\")\n     void connectWillInitiateConnection() throws Exception {\n-      givenWebSocketConnects(true);\n-\n-      final boolean connected =\n+      final HttpClient httpClient = mockHttpClient();\n+      webSocketConnection.setHttpClient(httpClient);\n+      final WebSocket connected =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0390aa6121579fd8607c2558b45ed59ae694e3c"}, "originalPosition": 134}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQxOTk3NA==", "bodyText": "If we're receiving message concurrently, how do we know we'll have an in-order message stream?", "url": "https://github.com/triplea-game/triplea/pull/6062#discussion_r395419974", "createdAt": "2020-03-20T03:00:00Z", "author": {"login": "DanVanAtta"}, "path": "http-clients/src/main/java/org/triplea/http/client/web/socket/WebSocketConnection.java", "diffHunk": "@@ -49,17 +58,67 @@\n       onMethod_ = {@VisibleForTesting})\n   private boolean connectionIsOpen = false;\n \n+  @Setter(\n+      value = AccessLevel.PACKAGE,\n+      onMethod_ = {@VisibleForTesting})\n+  private HttpClient httpClient = HttpClient.newHttpClient();\n+\n   private final URI serverUri;\n \n   private boolean closed = false;\n \n+  private WebSocket client;\n+\n   @Getter(\n       value = AccessLevel.PACKAGE,\n       onMethod_ = {@VisibleForTesting})\n-  @Setter(\n-      value = AccessLevel.PACKAGE,\n-      onMethod_ = {@VisibleForTesting})\n-  private WebSocketClient client;\n+  private final WebSocket.Listener webSocketListener =\n+      new Listener() {\n+        private final StringBuilder textAccumulator = new StringBuilder();\n+\n+        @Override\n+        public void onOpen(final WebSocket webSocket) {\n+          synchronized (queuedMessages) {\n+            client = webSocket;\n+            connectionIsOpen = true;\n+            queuedMessages.forEach(\n+                message ->\n+                    client\n+                        .sendText(message, true)\n+                        .exceptionally(logWebSocketError(\"Failed to send queued text.\")));\n+            queuedMessages.clear();\n+          }\n+          webSocket.request(1);\n+        }\n+\n+        @Override\n+        public CompletionStage<?> onText(\n+            final WebSocket webSocket, final CharSequence data, final boolean last) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMyMTQyNQ=="}, "originalCommit": {"oid": "b0390aa6121579fd8607c2558b45ed59ae694e3c"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQzMzExNA==", "bodyText": "I'm seeing this test fail when run from IDE:\norg.opentest4j.AssertionFailedError: Expected java.util.concurrent.ExecutionException to be thrown, but nothing was thrown.\n\n\tat org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:71)\n\tat org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:37)\n\tat org.junit.jupiter.api.Assertions.assertThrows(Assertions.java:2952)\n\tat org.triplea.http.client.web.socket.WebSocketConnectionTest$SendMessageAndConnect.connectionFailure(WebSocketConnectionTest.java:186)\n\nI think I'd quibble a bit more with the test case otherwise. The @DisplayName message is not really accurate anymore. It's also very notable that we can/need to rely on exception handling.\nIt's also notable as well that the method does not document the ExecutionException as being a possibility for somethign to be thrown:\n   * @throws IllegalStateException Thrown if connection is already open (eg: connect called twice).\n   * @throws IllegalStateException Thrown if connection has been closed (ie: 'close()' was called)\n   */\n\nThird, we pass an error handler to the method, yet we also have an exception that is possible to be thrown. Part of the purpose of the error handler is to invoke that instead of throwing an exception.\nThe local IDE failure does need to be sorted out, we can't have tests being non-deterministic and breaking when run from one context and not another. I suspect getting back to a boolean returning only method and not allowing an exception to be thrown, returning false and invoking the error handler would be more inline with the original method contract.", "url": "https://github.com/triplea-game/triplea/pull/6062#discussion_r395433114", "createdAt": "2020-03-20T04:17:49Z", "author": {"login": "DanVanAtta"}, "path": "http-clients/src/test/java/org/triplea/http/client/web/socket/WebSocketConnectionTest.java", "diffHunk": "@@ -127,21 +180,13 @@ private void verifyPingerIsStarted() {\n           is(true));\n     }\n \n-    private void givenWebSocketConnects(final boolean connects) throws Exception {\n-      when(webSocketClient.connectBlocking(\n-              WebSocketConnection.DEFAULT_CONNECT_TIMEOUT_MILLIS, TimeUnit.MILLISECONDS))\n-          .thenReturn(connects);\n-    }\n-\n     @Test\n     @DisplayName(\"Verify connect failing invokes error handler and pinger is not running\")\n-    void connectionFailure() throws Exception {\n-      givenWebSocketConnects(false);\n-\n-      final boolean connected =\n-          webSocketConnection.connect(webSocketConnectionListener, errorHandler).get();\n+    void connectionFailure() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0390aa6121579fd8607c2558b45ed59ae694e3c"}, "originalPosition": 181}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQzMzIxMQ==", "bodyText": "Why is this test no longer applicable?", "url": "https://github.com/triplea-game/triplea/pull/6062#discussion_r395433211", "createdAt": "2020-03-20T04:18:26Z", "author": {"login": "DanVanAtta"}, "path": "http-clients/src/test/java/org/triplea/http/client/web/socket/WebSocketConnectionTest.java", "diffHunk": "@@ -154,52 +199,36 @@ private void verifyErrorHandlerWasCalled() {\n       verify(errorHandler).accept(any());\n     }\n \n-    @Test\n-    @DisplayName(\n-        \"Verify connect failing with exception invokes error handler and pinger is not running\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0390aa6121579fd8607c2558b45ed59ae694e3c"}, "originalPosition": 196}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQzMzM0NQ==", "bodyText": "It does not seem to matter what the disconnect message is, or does it? We probably do not need to assert a specific message.", "url": "https://github.com/triplea-game/triplea/pull/6062#discussion_r395433345", "createdAt": "2020-03-20T04:19:23Z", "author": {"login": "DanVanAtta"}, "path": "http-clients/src/test/java/org/triplea/http/client/web/socket/WebSocketConnectionTest.java", "diffHunk": "@@ -154,52 +199,36 @@ private void verifyErrorHandlerWasCalled() {\n       verify(errorHandler).accept(any());\n     }\n \n-    @Test\n-    @DisplayName(\n-        \"Verify connect failing with exception invokes error handler and pinger is not running\")\n-    void connectionFailureWithInterruptedException() throws Exception {\n-      givenConnectionAttemptThrows();\n-\n-      final boolean connected =\n-          webSocketConnection.connect(webSocketConnectionListener, errorHandler).get();\n-\n-      assertThat(connected, is(false));\n-      verifyPingerNotStarted();\n-      verifyErrorHandlerWasCalled();\n-    }\n-\n-    private void givenConnectionAttemptThrows() throws Exception {\n-      doThrow(new InterruptedException(\"test exception\"))\n-          .when(webSocketClient)\n-          .connectBlocking(\n-              WebSocketConnection.DEFAULT_CONNECT_TIMEOUT_MILLIS, TimeUnit.MILLISECONDS);\n-    }\n-\n     @Test\n     @DisplayName(\"Close will close the underlying socket and stops the pinger\")\n     void close() {\n+      webSocketConnection.getWebSocketListener().onOpen(webSocket);\n+      requiresCloseAction();\n       webSocketConnection.close();\n \n-      verify(webSocketClient).close();\n+      verify(webSocket)\n+          .sendClose(WebSocket.NORMAL_CLOSURE, WebSocketConnection.CLIENT_DISCONNECT_MESSAGE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0390aa6121579fd8607c2558b45ed59ae694e3c"}, "originalPosition": 224}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQzMzUwMg==", "bodyText": "This method seems out of order, it is invoked much further down in the test, right?\nSecond, why does this method make sense, what does requiring a close action mean and have to do with a send close returning a nullable future?", "url": "https://github.com/triplea-game/triplea/pull/6062#discussion_r395433502", "createdAt": "2020-03-20T04:20:29Z", "author": {"login": "DanVanAtta"}, "path": "http-clients/src/test/java/org/triplea/http/client/web/socket/WebSocketConnectionTest.java", "diffHunk": "@@ -93,7 +128,16 @@ void queuedMessagesAreFlushedOnConnectionOpen() {\n     @BeforeEach\n     void setup() {\n       webSocketConnection = new WebSocketConnection(INVALID_URI);\n-      webSocketConnection.setClient(webSocketClient);\n+    }\n+\n+    private void requiresSendTextAction() {\n+      when(webSocket.sendText(any(), anyBoolean()))\n+          .thenReturn(CompletableFuture.completedFuture(null));\n+    }\n+\n+    private void requiresCloseAction() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0390aa6121579fd8607c2558b45ed59ae694e3c"}, "originalPosition": 119}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQzMzg3Mg==", "bodyText": "Would we also want users to submit bug reports whenever this happens?\n\nMy implication with this was that given the current handling, we are offering users to submit bug reports. Severe logging means \"the application crashed, it should not have, the error is likely unrecoverable, the user should submit a bug report as the situation should never happen\"\nWe should not be getting bug reports where our response is: \"yeah, that's normal, we'll close this now.\"", "url": "https://github.com/triplea-game/triplea/pull/6062#discussion_r395433872", "createdAt": "2020-03-20T04:22:47Z", "author": {"login": "DanVanAtta"}, "path": "http-clients/src/main/java/org/triplea/http/client/web/socket/WebSocketConnection.java", "diffHunk": "@@ -68,52 +127,28 @@\n \n   WebSocketConnection(final URI serverUri) {\n     this.serverUri = serverUri;\n-    client =\n-        new WebSocketClient(serverUri) {\n-          @Override\n-          public void onOpen(final ServerHandshake serverHandshake) {\n-            synchronized (queuedMessages) {\n-              connectionIsOpen = true;\n-              queuedMessages.forEach(this::send);\n-              queuedMessages.clear();\n-            }\n-          }\n-\n-          @Override\n-          public void onMessage(final String message) {\n-            listener.messageReceived(message);\n-          }\n-\n-          @Override\n-          public void onClose(final int code, final String reason, final boolean remote) {\n-            if (remote) {\n-              log.severe(\"Connection to server closed: \" + reason);\n-            }\n-            pingSender.cancel();\n-            listener.connectionClosed(reason);\n-          }\n-\n-          @Override\n-          public void onError(final Exception exception) {\n-            listener.handleError(exception);\n-          }\n-        };\n     pingSender =\n         Timers.fixedRateTimer(\"websocket-ping-sender\")\n             .period(45, TimeUnit.SECONDS)\n             .delay(45, TimeUnit.SECONDS)\n             .task(\n                 () -> {\n-                  if (client.isOpen()) {\n-                    client.sendPing();\n+                  if (!client.isOutputClosed()) {\n+                    client\n+                        .sendPing(ByteBuffer.wrap(\"Ping\".getBytes(StandardCharsets.UTF_8)))\n+                        .exceptionally(logWebSocketError(\"Failed to send ping.\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMyMTkzNQ=="}, "originalCommit": {"oid": "b0390aa6121579fd8607c2558b45ed59ae694e3c"}, "originalPosition": 153}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQzNDEwOQ==", "bodyText": "Not sure if you're getting a bit over-paranoid with replaceFirst, the regex ^ really guarantees one match here.\nIt seems like we are defending against the protocol from being shttp? Otherwise the protocol string being equal to https was surefire already.\nDo we have to replace http protocol with ws?", "url": "https://github.com/triplea-game/triplea/pull/6062#discussion_r395434109", "createdAt": "2020-03-20T04:24:07Z", "author": {"login": "DanVanAtta"}, "path": "http-clients/src/main/java/org/triplea/http/client/web/socket/GenericWebSocketClient.java", "diffHunk": "@@ -43,9 +43,9 @@ public GenericWebSocketClient(final URI lobbyUri, final Consumer<String> errorHa\n   }\n \n   @VisibleForTesting\n-  static URI swapHttpsToWssProtocol(final URI uri) {\n-    return uri.getScheme().equals(\"https\")\n-        ? URI.create(uri.toString().replace(\"https\", \"wss\"))\n+  static URI swapHttpToWsProtocol(final URI uri) {\n+    return uri.getScheme().matches(\"^https?$\")\n+        ? URI.create(uri.toString().replaceFirst(\"^http\", \"ws\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0390aa6121579fd8607c2558b45ed59ae694e3c"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQzNDMxMg==", "bodyText": "This block is notable as the error handling is pretty screwed up to begin with. We have an error handler passed to the connect function, yet we still choose to have our own custom error handling on this out layer. Really the inner call connect should take care of the exceptionally case and invoke the error handler. As-is, it seems like the error-handler is a violation of DRY (expressing the same idea in multiple places) or arguably SRP.", "url": "https://github.com/triplea-game/triplea/pull/6062#discussion_r395434312", "createdAt": "2020-03-20T04:25:28Z", "author": {"login": "DanVanAtta"}, "path": "http-clients/src/main/java/org/triplea/http/client/web/socket/GenericWebSocketClient.java", "diffHunk": "@@ -57,7 +57,7 @@ public void registerListenerAndConnect(final Consumer<ServerMessageEnvelope> mes\n             throwable -> {\n               log.log(\n                   Level.SEVERE, \"Unexpected exception completing websocket connection\", throwable);\n-              return false;\n+              return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0390aa6121579fd8607c2558b45ed59ae694e3c"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQzNDUyNQ==", "bodyText": "I think we may need some additional test cases that exercise concurrency with multiple, broken up messages. I'm concerned about that scenario.", "url": "https://github.com/triplea-game/triplea/pull/6062#discussion_r395434525", "createdAt": "2020-03-20T04:26:47Z", "author": {"login": "DanVanAtta"}, "path": "http-clients/src/test/java/org/triplea/http/client/web/socket/WebSocketConnectionTest.java", "diffHunk": "@@ -52,39 +55,71 @@ void tearDown() {\n \n     @Test\n     void onMessage() {\n-      webSocketConnection.getClient().onMessage(MESSAGE);\n+      webSocketConnection.getWebSocketListener().onText(mock(WebSocket.class), MESSAGE, true);\n       verify(webSocketConnectionListener).messageReceived(MESSAGE);\n     }\n \n+    @Test\n+    void verifyListenerAccumulatesMessagesUntilLast() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0390aa6121579fd8607c2558b45ed59ae694e3c"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQzNDY4Nw==", "bodyText": "Have you considered making the websocket listener a stand-alone class? This kind of test is a smell, (law of demeter violation). It we simpliy injected the listener implementation we might be able to decompose the test cases more thoroughly.", "url": "https://github.com/triplea-game/triplea/pull/6062#discussion_r395434687", "createdAt": "2020-03-20T04:27:50Z", "author": {"login": "DanVanAtta"}, "path": "http-clients/src/test/java/org/triplea/http/client/web/socket/WebSocketConnectionTest.java", "diffHunk": "@@ -52,39 +55,71 @@ void tearDown() {\n \n     @Test\n     void onMessage() {\n-      webSocketConnection.getClient().onMessage(MESSAGE);\n+      webSocketConnection.getWebSocketListener().onText(mock(WebSocket.class), MESSAGE, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0390aa6121579fd8607c2558b45ed59ae694e3c"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8122e2debbf8a9a05b9116cb18fb81618626985d", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/8122e2debbf8a9a05b9116cb18fb81618626985d", "committedDate": "2020-03-28T22:47:06Z", "message": "Replace Java-Websocket with native JDK library"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ff157babc0f23113d2169aec479d3859aaa279c", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/4ff157babc0f23113d2169aec479d3859aaa279c", "committedDate": "2020-03-28T22:47:06Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "387c933adbf5bea254486d7b7b92c5dcf40aac85", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/387c933adbf5bea254486d7b7b92c5dcf40aac85", "committedDate": "2020-03-28T22:47:06Z", "message": "Add additional test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffe0e68bb42862389f4bf9a3a9ca096f63a8a103", "author": {"user": {"login": "tripleabuilderbot", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/ffe0e68bb42862389f4bf9a3a9ca096f63a8a103", "committedDate": "2020-03-28T22:47:06Z", "message": "Auto-Formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a16234508372bee0a0fc4eabdae4f1e6f8c378b", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/9a16234508372bee0a0fc4eabdae4f1e6f8c378b", "committedDate": "2020-03-28T22:47:06Z", "message": "Remove sl4j version variable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc0487589994f57eda00f071146099b928ddce01", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/cc0487589994f57eda00f071146099b928ddce01", "committedDate": "2020-03-28T22:47:06Z", "message": "Fix websocket protocol"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "400351a0c2d192d481cdfbb2988b5b87ccde1be8", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/400351a0c2d192d481cdfbb2988b5b87ccde1be8", "committedDate": "2020-03-28T22:47:06Z", "message": "Fix URI replacement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28d21bd6f915a11b42ce51a018e11fd289aeaa0a", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/28d21bd6f915a11b42ce51a018e11fd289aeaa0a", "committedDate": "2020-03-28T22:47:06Z", "message": "Fix unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bdafaf2bb376bf7eade4421d4e78b4dd53f1a09", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/6bdafaf2bb376bf7eade4421d4e78b4dd53f1a09", "committedDate": "2020-03-28T22:47:32Z", "message": "Update documentation and test case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23c855c0eebdbfc074b3b41e875a9e3c3da9c617", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/23c855c0eebdbfc074b3b41e875a9e3c3da9c617", "committedDate": "2020-03-28T23:16:41Z", "message": "Remove close reason handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52c2152fe8e3f55bdb65f96d425841a3186299ed", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/52c2152fe8e3f55bdb65f96d425841a3186299ed", "committedDate": "2020-03-28T23:16:54Z", "message": "Remove custom ping message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1e687cb006cd81723ef54f389a98a99233a968b", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/d1e687cb006cd81723ef54f389a98a99233a968b", "committedDate": "2020-03-28T23:21:23Z", "message": "Rename variable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0f236c179a973d8452a53f1c7de7caca6cadf59", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/a0f236c179a973d8452a53f1c7de7caca6cadf59", "committedDate": "2020-03-28T23:34:03Z", "message": "Inline method"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b0390aa6121579fd8607c2558b45ed59ae694e3c", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/b0390aa6121579fd8607c2558b45ed59ae694e3c", "committedDate": "2020-03-19T17:37:45Z", "message": "Fix unit test"}, "afterCommit": {"oid": "a0f236c179a973d8452a53f1c7de7caca6cadf59", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/a0f236c179a973d8452a53f1c7de7caca6cadf59", "committedDate": "2020-03-28T23:34:03Z", "message": "Inline method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82c9f2efb56cb53cc2f70397bce023c95a76eee7", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/82c9f2efb56cb53cc2f70397bce023c95a76eee7", "committedDate": "2020-03-28T23:57:47Z", "message": "Simplify error handling API"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59d03c7bb572527b9eaee9152f07e79e58d41ea3", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/59d03c7bb572527b9eaee9152f07e79e58d41ea3", "committedDate": "2020-03-29T00:03:33Z", "message": "Use lighter logging levels"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79b9756978d09bc2826b174a0a17f51555264b6c", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/79b9756978d09bc2826b174a0a17f51555264b6c", "committedDate": "2020-03-29T00:21:22Z", "message": "Make listener inner class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e9c9267142becd3521a26a99a3f0156b6dcf7bf", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/8e9c9267142becd3521a26a99a3f0156b6dcf7bf", "committedDate": "2020-03-29T00:53:29Z", "message": "Fix potential NPE"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMzY4MTU1", "url": "https://github.com/triplea-game/triplea/pull/6062#pullrequestreview-383368155", "createdAt": "2020-03-29T03:02:08Z", "commit": {"oid": "82c9f2efb56cb53cc2f70397bce023c95a76eee7"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOVQwMzowMjowOFrOF9OB_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOVQwMzoyODo1M1rOF9OJIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTczNzM0Mw==", "bodyText": "The error handler should be taking care of any logging that is needed, whether that is a message to a user or a message to the logs.", "url": "https://github.com/triplea-game/triplea/pull/6062#discussion_r399737343", "createdAt": "2020-03-29T03:02:08Z", "author": {"login": "DanVanAtta"}, "path": "http-clients/src/main/java/org/triplea/http/client/web/socket/WebSocketConnection.java", "diffHunk": "@@ -153,23 +153,27 @@ void close() {\n    * @param errorHandler Invoked if there is a failure to connect.\n    * @throws IllegalStateException Thrown if connection is already open (eg: connect called twice).\n    * @throws IllegalStateException Thrown if connection has been closed (ie: 'close()' was called)\n-   * @return A {@link CompletableFuture} behaving like the {@link CompletableFuture} returned by\n-   *     {@link WebSocket.Builder#buildAsync(URI, Listener)} in case of an error.\n    */\n-  CompletableFuture<WebSocket> connect(\n+  @SuppressWarnings(\"FutureReturnValueIgnored\")\n+  void connect(final WebSocketConnectionListener listener, final Consumer<String> errorHandler) {\n+    connectInternal(listener, errorHandler);\n+  }\n+\n+  @VisibleForTesting\n+  CompletableFuture<Void> connectInternal(\n       final WebSocketConnectionListener listener, final Consumer<String> errorHandler) {\n     this.listener = Preconditions.checkNotNull(listener);\n     Preconditions.checkState(client == null);\n     Preconditions.checkState(!closed);\n \n     return connectAsync()\n-        .whenComplete(\n-            (webSocket, throwable) -> {\n-              if (webSocket != null && throwable == null) {\n-                pingSender.start();\n-              } else {\n-                errorHandler.accept(\"Failed to connect to: \" + serverUri);\n-              }\n+        .thenRun(pingSender::start)\n+        .exceptionally(\n+            throwable -> {\n+              errorHandler.accept(\"Failed to connect to: \" + serverUri);\n+              log.log(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82c9f2efb56cb53cc2f70397bce023c95a76eee7"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTczNzQxNQ==", "bodyText": "Why are we returning a value here, just for testing maybe?", "url": "https://github.com/triplea-game/triplea/pull/6062#discussion_r399737415", "createdAt": "2020-03-29T03:03:15Z", "author": {"login": "DanVanAtta"}, "path": "http-clients/src/main/java/org/triplea/http/client/web/socket/WebSocketConnection.java", "diffHunk": "@@ -153,23 +153,27 @@ void close() {\n    * @param errorHandler Invoked if there is a failure to connect.\n    * @throws IllegalStateException Thrown if connection is already open (eg: connect called twice).\n    * @throws IllegalStateException Thrown if connection has been closed (ie: 'close()' was called)\n-   * @return A {@link CompletableFuture} behaving like the {@link CompletableFuture} returned by\n-   *     {@link WebSocket.Builder#buildAsync(URI, Listener)} in case of an error.\n    */\n-  CompletableFuture<WebSocket> connect(\n+  @SuppressWarnings(\"FutureReturnValueIgnored\")\n+  void connect(final WebSocketConnectionListener listener, final Consumer<String> errorHandler) {\n+    connectInternal(listener, errorHandler);\n+  }\n+\n+  @VisibleForTesting\n+  CompletableFuture<Void> connectInternal(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82c9f2efb56cb53cc2f70397bce023c95a76eee7"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTczODAyNQ==", "bodyText": "Why mockHttpClient() instead of using @Mock HttpClient httpClient?", "url": "https://github.com/triplea-game/triplea/pull/6062#discussion_r399738025", "createdAt": "2020-03-29T03:12:32Z", "author": {"login": "DanVanAtta"}, "path": "http-clients/src/test/java/org/triplea/http/client/web/socket/WebSocketConnectionTest.java", "diffHunk": "@@ -104,20 +142,27 @@ void tearDown() {\n     @Test\n     @DisplayName(\"Verify connect initiates connection and starts the pinger\")\n     void connectWillInitiateConnection() throws Exception {\n-      givenWebSocketConnects(true);\n-\n-      final boolean connected =\n-          webSocketConnection.connect(webSocketConnectionListener, errorHandler).get();\n+      final HttpClient httpClient = mockHttpClient();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e9c9267142becd3521a26a99a3f0156b6dcf7bf"}, "originalPosition": 142}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTczODYxMA==", "bodyText": "These two variables are named a bit too similarly, it's a bit difficult to keep them straight:\n  private WebSocketConnectionListener listener;\n  private final WebSocket.Listener webSocketListener = new WebSocketListener();\n\nCan they be renamed reasonably or restructured perhaps?", "url": "https://github.com/triplea-game/triplea/pull/6062#discussion_r399738610", "createdAt": "2020-03-29T03:20:50Z", "author": {"login": "DanVanAtta"}, "path": "http-clients/src/main/java/org/triplea/http/client/web/socket/WebSocketConnection.java", "diffHunk": "@@ -49,17 +57,21 @@\n       onMethod_ = {@VisibleForTesting})\n   private boolean connectionIsOpen = false;\n \n+  @Setter(\n+      value = AccessLevel.PACKAGE,\n+      onMethod_ = {@VisibleForTesting})\n+  private HttpClient httpClient = HttpClient.newHttpClient();\n+\n   private final URI serverUri;\n \n   private boolean closed = false;\n \n+  private WebSocket client;\n+\n   @Getter(\n       value = AccessLevel.PACKAGE,\n       onMethod_ = {@VisibleForTesting})\n-  @Setter(\n-      value = AccessLevel.PACKAGE,\n-      onMethod_ = {@VisibleForTesting})\n-  private WebSocketClient client;\n+  private final WebSocket.Listener webSocketListener = new WebSocketListener();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e9c9267142becd3521a26a99a3f0156b6dcf7bf"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTczODcxNQ==", "bodyText": "Is it very burdensome to keep client non-nullable? Also wondering why it's nullable now.", "url": "https://github.com/triplea-game/triplea/pull/6062#discussion_r399738715", "createdAt": "2020-03-29T03:22:36Z", "author": {"login": "DanVanAtta"}, "path": "http-clients/src/main/java/org/triplea/http/client/web/socket/WebSocketConnection.java", "diffHunk": "@@ -68,52 +80,28 @@\n \n   WebSocketConnection(final URI serverUri) {\n     this.serverUri = serverUri;\n-    client =\n-        new WebSocketClient(serverUri) {\n-          @Override\n-          public void onOpen(final ServerHandshake serverHandshake) {\n-            synchronized (queuedMessages) {\n-              connectionIsOpen = true;\n-              queuedMessages.forEach(this::send);\n-              queuedMessages.clear();\n-            }\n-          }\n-\n-          @Override\n-          public void onMessage(final String message) {\n-            listener.messageReceived(message);\n-          }\n-\n-          @Override\n-          public void onClose(final int code, final String reason, final boolean remote) {\n-            if (remote) {\n-              log.severe(\"Connection to server closed: \" + reason);\n-            }\n-            pingSender.cancel();\n-            listener.connectionClosed(reason);\n-          }\n-\n-          @Override\n-          public void onError(final Exception exception) {\n-            listener.handleError(exception);\n-          }\n-        };\n     pingSender =\n         Timers.fixedRateTimer(\"websocket-ping-sender\")\n             .period(45, TimeUnit.SECONDS)\n             .delay(45, TimeUnit.SECONDS)\n             .task(\n                 () -> {\n-                  if (client.isOpen()) {\n-                    client.sendPing();\n+                  if (!client.isOutputClosed()) {\n+                    client\n+                        .sendPing(ByteBuffer.allocate(0))\n+                        .exceptionally(logWebSocketError(Level.INFO, \"Failed to send ping.\"));\n                   }\n                 });\n   }\n \n   /** Does an async close of the current websocket connection. */\n   void close() {\n     closed = true;\n-    client.close();\n+    if (client != null && !client.isOutputClosed()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e9c9267142becd3521a26a99a3f0156b6dcf7bf"}, "originalPosition": 115}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTczOTExMw==", "bodyText": "It takes a lot of convincing that this is threadsafe. Messages coming in will be concurrent, ie: multiple chatters to server and those being handled on different threads then sending back messages concurrently to this listener.\nPerhaps a documentation reference and some commentary on why we are guaranteed to be threadsafe here would be useful for the future. A naive maintainer might look at this and decide we must have a sync lock or start to think the implementation is broken. It seems like an obvious problem if two 'onText' events come in at the same time and they are both not last, then we'll mix the messages together.", "url": "https://github.com/triplea-game/triplea/pull/6062#discussion_r399739113", "createdAt": "2020-03-29T03:28:20Z", "author": {"login": "DanVanAtta"}, "path": "http-clients/src/main/java/org/triplea/http/client/web/socket/WebSocketConnection.java", "diffHunk": "@@ -173,8 +156,63 @@ void sendMessage(final String message) {\n       if (!connectionIsOpen) {\n         queuedMessages.add(message);\n       } else {\n-        client.send(message);\n+        client\n+            .sendText(message, true)\n+            .exceptionally(logWebSocketError(Level.SEVERE, \"Failed to send text.\"));\n       }\n     }\n   }\n+\n+  private <T> Function<Throwable, T> logWebSocketError(\n+      final Level level, final String errorMessage) {\n+    return throwable -> {\n+      log.log(level, errorMessage, throwable);\n+      return null;\n+    };\n+  }\n+\n+  @VisibleForTesting\n+  class WebSocketListener implements Listener {\n+    private final StringBuilder textAccumulator = new StringBuilder();\n+\n+    @Override\n+    public void onOpen(final WebSocket webSocket) {\n+      synchronized (queuedMessages) {\n+        client = webSocket;\n+        connectionIsOpen = true;\n+        queuedMessages.forEach(\n+            message ->\n+                client\n+                    .sendText(message, true)\n+                    .exceptionally(logWebSocketError(Level.SEVERE, \"Failed to send queued text.\")));\n+        queuedMessages.clear();\n+      }\n+      webSocket.request(1);\n+    }\n+\n+    @Override\n+    public CompletionStage<?> onText(\n+        final WebSocket webSocket, final CharSequence data, final boolean last) {\n+      textAccumulator.append(data);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e9c9267142becd3521a26a99a3f0156b6dcf7bf"}, "originalPosition": 225}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTczOTE2OQ==", "bodyText": "This line perhaps could use a comment, why are we requesting to the websocket, and why 1?", "url": "https://github.com/triplea-game/triplea/pull/6062#discussion_r399739169", "createdAt": "2020-03-29T03:28:53Z", "author": {"login": "DanVanAtta"}, "path": "http-clients/src/main/java/org/triplea/http/client/web/socket/WebSocketConnection.java", "diffHunk": "@@ -173,8 +156,63 @@ void sendMessage(final String message) {\n       if (!connectionIsOpen) {\n         queuedMessages.add(message);\n       } else {\n-        client.send(message);\n+        client\n+            .sendText(message, true)\n+            .exceptionally(logWebSocketError(Level.SEVERE, \"Failed to send text.\"));\n       }\n     }\n   }\n+\n+  private <T> Function<Throwable, T> logWebSocketError(\n+      final Level level, final String errorMessage) {\n+    return throwable -> {\n+      log.log(level, errorMessage, throwable);\n+      return null;\n+    };\n+  }\n+\n+  @VisibleForTesting\n+  class WebSocketListener implements Listener {\n+    private final StringBuilder textAccumulator = new StringBuilder();\n+\n+    @Override\n+    public void onOpen(final WebSocket webSocket) {\n+      synchronized (queuedMessages) {\n+        client = webSocket;\n+        connectionIsOpen = true;\n+        queuedMessages.forEach(\n+            message ->\n+                client\n+                    .sendText(message, true)\n+                    .exceptionally(logWebSocketError(Level.SEVERE, \"Failed to send queued text.\")));\n+        queuedMessages.clear();\n+      }\n+      webSocket.request(1);\n+    }\n+\n+    @Override\n+    public CompletionStage<?> onText(\n+        final WebSocket webSocket, final CharSequence data, final boolean last) {\n+      textAccumulator.append(data);\n+      if (last) {\n+        listener.messageReceived(textAccumulator.toString());\n+        textAccumulator.setLength(0);\n+      }\n+      webSocket.request(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e9c9267142becd3521a26a99a3f0156b6dcf7bf"}, "originalPosition": 230}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ab79d7cd037a67dfb7506723d51cd27ce702cd9", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/5ab79d7cd037a67dfb7506723d51cd27ce702cd9", "committedDate": "2020-03-29T17:48:07Z", "message": "Add clarifying comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cf3a92b20f99042f3599665d4e2df298057a9d1", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/9cf3a92b20f99042f3599665d4e2df298057a9d1", "committedDate": "2020-03-29T17:56:16Z", "message": "Use nested class for testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1b6e4fb4d580a9d7a7287b1febd268a421a6c4f", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/e1b6e4fb4d580a9d7a7287b1febd268a421a6c4f", "committedDate": "2020-03-29T18:03:08Z", "message": "Rename variable and inner class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9de84771e521124ff65f3bf337ca6a5d9661414", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/b9de84771e521124ff65f3bf337ca6a5d9661414", "committedDate": "2020-03-29T19:04:59Z", "message": "Clarify NPE prevention"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3580, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}