{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzMDM3NDky", "number": 8349, "title": "Add a clear casualty step for naval bombardment", "bodyText": "All of the other battle parts (aa, sub, other) use a casualty removal\nstep to remove casualties that have been hit. This updates the\nbombardment to also have its own casualty removal step for the case\nwhere the map doesn't allow naval bombardment casualties to fire back.\n\nTesting\n\nPlayed World At War as it doesn't allow casualties of naval bombardment to fire back.  Modified it to allow selection of AA casualties.  I created a save of a battle at the point of selecting the AA casualties.  I then loaded that save in this branch and ensured that the naval bombardment casualties were removed correctly.  I also loaded a save just before the battle started to ensure that the initial battle setup would be correct as well.\nScreens Shots\n\nAdditional Notes to Reviewer\n\nI noticed that I had introduced a bug when I did the sub rework.  If a battle has both bombardment and a first strike unit, then the bombardment casualties will always be removed after the first strike fires, even if \"Naval Bombard Casualties Return Fire\" is true.  I'm not sure if there is a map that would be impacted by that bug.  I'm working on a fix for it but it will probably take a few PRs.\nRelease Note\n\nCHANGE|If 'Naval Bombard Casualties Return Fire' is false, then a new step is added to the battle ui to indicate when the casualties are removed from battle.", "createdAt": "2020-12-05T16:01:59Z", "url": "https://github.com/triplea-game/triplea/pull/8349", "merged": true, "mergeCommit": {"oid": "9affbcde357748261b1956f935ac64c55967de7b"}, "closed": true, "closedAt": "2020-12-06T21:39:35Z", "author": {"login": "trevan"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdjOfoGAH2gAyNTMzMDM3NDkyOjIyMTNmNTg2NmU4YzUzNTkyMDI5OTVjZjQ5MGUzZjA2YzUxNjRiNmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdjn-zmgFqTU0NTc1MDY1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2213f5866e8c5359202995cf490e3f06c5164b6a", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/2213f5866e8c5359202995cf490e3f06c5164b6a", "committedDate": "2020-12-05T15:57:48Z", "message": "Add a clear casualty step for naval bombardment\n\nAll of the other battle parts (aa, sub, other) use a casualty removal\nstep to remove casualties that have been hit. This updates the\nbombardment to also have its own casualty removal step for the case\nwhere the map doesn't allow naval bombardment casualties to fire back."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5637446fc28c683fc6555b5bd515de0787ef5da", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/c5637446fc28c683fc6555b5bd515de0787ef5da", "committedDate": "2020-12-05T16:14:21Z", "message": "Only add the clear bombardment step if bombarding is happening"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1Njc1NjY5", "url": "https://github.com/triplea-game/triplea/pull/8349#pullrequestreview-545675669", "createdAt": "2020-12-06T06:39:04Z", "commit": {"oid": "c5637446fc28c683fc6555b5bd515de0787ef5da"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNlQwNjozOTowNFrOIAGEMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNlQwNjo0MDozM1rOIAGFCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjk3MDI4OQ==", "bodyText": "nit, valid could be more descriptive. When reading the usage, I wondered \"what is valid?\"\nSome rename suggestions:\n\n\"isBombardmentRound\"\n\"bombardmentOccurred\"\n\"bombardUnitsWillFire\"\n\nSide-note, I wonder if it would make sense to create a BombardmentRules object so we can centralize logic like this, where we have one source  to detect, when/how/if bombardment should occur.", "url": "https://github.com/triplea-game/triplea/pull/8349#discussion_r536970289", "createdAt": "2020-12-06T06:39:04Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/steps/change/ClearBombardmentCasualties.java", "diffHunk": "@@ -0,0 +1,49 @@\n+package games.strategy.triplea.delegate.battle.steps.change;\n+\n+import static games.strategy.triplea.delegate.battle.BattleStepStrings.REMOVE_BOMBARDMENT_CASUALTIES;\n+\n+import games.strategy.engine.delegate.IDelegateBridge;\n+import games.strategy.triplea.Properties;\n+import games.strategy.triplea.delegate.ExecutionStack;\n+import games.strategy.triplea.delegate.battle.BattleActions;\n+import games.strategy.triplea.delegate.battle.BattleState;\n+import games.strategy.triplea.delegate.battle.steps.BattleStep;\n+import java.util.List;\n+import lombok.AllArgsConstructor;\n+\n+@AllArgsConstructor\n+public class ClearBombardmentCasualties implements BattleStep {\n+  private static final long serialVersionUID = -5723287846470464298L;\n+\n+  private final BattleState battleState;\n+\n+  private final BattleActions battleActions;\n+\n+  @Override\n+  public List<String> getNames() {\n+    return valid() && clearCasualties() ? List.of(REMOVE_BOMBARDMENT_CASUALTIES) : List.of();\n+  }\n+\n+  @Override\n+  public BattleStep.Order getOrder() {\n+    return Order.NAVAL_BOMBARDMENT_REMOVE_CASUALTIES;\n+  }\n+\n+  @Override\n+  public void execute(final ExecutionStack stack, final IDelegateBridge bridge) {\n+    if (valid() && clearCasualties()) {\n+      battleActions.clearWaitingToDieAndDamagedChangesInto(bridge);\n+    }\n+  }\n+\n+  private boolean clearCasualties() {\n+    return !Properties.getNavalBombardCasualtiesReturnFire(\n+        battleState.getGameData().getProperties());\n+  }\n+\n+  private boolean valid() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5637446fc28c683fc6555b5bd515de0787ef5da"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjk3MDUwNQ==", "bodyText": "side comment, just realized the existing comment does not quite make sense.\nSpecifically \"ALL for everything\" reads odd, without context it does not really make sense.\nIf ALL is an enum or a constant defined somewhere, perhaps fully qualifying it would remove any confusion.", "url": "https://github.com/triplea-game/triplea/pull/8349#discussion_r536970505", "createdAt": "2020-12-06T06:40:33Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/steps/fire/MarkCasualties.java", "diffHunk": "@@ -45,9 +44,7 @@\n \n   private final FireRoundState fireRoundState;\n \n-  @ChangeOnNextMajorRelease(\n-      \"returnFire is ALL for everything except NavalBombardment and old saves.\"\n-          + \"Rework so that returnFire isn't needed at all.\")\n+  @RemoveOnNextMajorRelease(\"returnFire is ALL for everything except old saves\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5637446fc28c683fc6555b5bd515de0787ef5da"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ebe6ac5b6e590abe5715da4f83b18ea6d51075b", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/2ebe6ac5b6e590abe5715da4f83b18ea6d51075b", "committedDate": "2020-12-06T19:17:13Z", "message": "Improve comment and method name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1NzUwNjU5", "url": "https://github.com/triplea-game/triplea/pull/8349#pullrequestreview-545750659", "createdAt": "2020-12-06T21:39:29Z", "commit": {"oid": "2ebe6ac5b6e590abe5715da4f83b18ea6d51075b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3806, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}