{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcxMzQzMzk3", "number": 7405, "title": "Add sub-project dropwizard common", "bodyText": "The sub-project is to allow for easier configuration\nof a drop wizard server and to reduce redundancy for when\nwe have multiple drop wizard servers\n\nTesting\n\nScreens Shots\n\nAdditional Notes to Reviewer\n\nI think there will be more to come to build on this sub-project more. Notably at least another drop wizard server \ud83d\ude01\nThis PR gets the sub-project started and perhaps the most interesting are two things:\n\nadd an API where you can invoke methods on the configuration to turn on features\nadd some utility around websocket endpoints to make those easier to config\n\nAny design suggestions certainly are really welcome here!\nRelease Note", "createdAt": "2020-08-21T02:49:24Z", "url": "https://github.com/triplea-game/triplea/pull/7405", "merged": true, "mergeCommit": {"oid": "d0f11b92af54c64df1ef4f9e8c681f96623ac091"}, "closed": true, "closedAt": "2020-08-22T00:41:56Z", "author": {"login": "DanVanAtta"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdA7rC1gH2gAyNDcxMzQzMzk3OmNmMDc3Njg1Mzg5MjI5MTI1MmRhNTk4OTQ0MWZlNWZhM2ZjYmEyNzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdBOV-bAH2gAyNDcxMzQzMzk3OjZhNWU5ZGEwYmQ0YzIyNzEwOTM5MjZhYzc1YTdmNmY2NzgzMjNiZDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cf0776853892291252da5989441fe5fa3fcba278", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/cf0776853892291252da5989441fe5fa3fcba278", "committedDate": "2020-08-21T02:48:39Z", "message": "Add sub-project dropwizard common\n\nThe sub-project is to allow for easier configuration\nof a drop wizard server and to reduce redundancy for when\nwe have multiple drop wizard servers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyNjAxNTAz", "url": "https://github.com/triplea-game/triplea/pull/7405#pullrequestreview-472601503", "createdAt": "2020-08-21T15:47:53Z", "commit": {"oid": "cf0776853892291252da5989441fe5fa3fcba278"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQxNTo0Nzo1M1rOHEyW3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQxNTo0OTo0MVrOHEyanQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc4MTQwNw==", "bodyText": "One thing to consider:\nRatelimitj has a release candidate out that supports dropwizard 2.0\nMight be worth migrating before actually doing any further work here? Maybe Release Candidate ist not stable enough though.", "url": "https://github.com/triplea-game/triplea/pull/7405#discussion_r474781407", "createdAt": "2020-08-21T15:47:53Z", "author": {"login": "RoiEXLab"}, "path": "dropwizard-common/build.gradle", "diffHunk": "@@ -0,0 +1,7 @@\n+dependencies {\n+    implementation \"com.liveperson:dropwizard-websockets:$dropwizardWebsocketsVersion\"\n+    implementation \"es.moki.ratelimitj:ratelimitj-dropwizard:$rateLimitjVersion\"\n+    implementation \"es.moki.ratelimitj:ratelimitj-inmemory:$rateLimitjVersion\"\n+    implementation \"io.dropwizard:dropwizard-core:$dropwizardVersion\"\n+    implementation \"io.dropwizard:dropwizard-jdbi3:$dropwizardVersion\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf0776853892291252da5989441fe5fa3fcba278"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc4MjM2NQ==", "bodyText": "That's a weird side-effect I didn't see coming. Maybe renaming the method to document this bahaviour in some way?", "url": "https://github.com/triplea-game/triplea/pull/7405#discussion_r474782365", "createdAt": "2020-08-21T15:49:41Z", "author": {"login": "RoiEXLab"}, "path": "dropwizard-common/src/main/java/org/triplea/dropwizard/common/ServerConfiguration.java", "diffHunk": "@@ -0,0 +1,139 @@\n+package org.triplea.dropwizard.common;\n+\n+import es.moki.ratelimij.dropwizard.RateLimitBundle;\n+import es.moki.ratelimitj.inmemory.InMemoryRateLimiterFactory;\n+import io.dropwizard.Configuration;\n+import io.dropwizard.configuration.EnvironmentVariableSubstitutor;\n+import io.dropwizard.configuration.SubstitutingSourceProvider;\n+import io.dropwizard.jdbi3.bundles.JdbiExceptionsBundle;\n+import io.dropwizard.setup.Bootstrap;\n+import io.dropwizard.setup.Environment;\n+import io.dropwizard.websockets.WebsocketBundle;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import javax.websocket.server.ServerEndpointConfig;\n+import javax.ws.rs.container.ContainerRequestFilter;\n+import lombok.AllArgsConstructor;\n+import org.glassfish.jersey.logging.LoggingFeature;\n+import org.glassfish.jersey.server.filter.RolesAllowedDynamicFeature;\n+\n+/**\n+ * Facilitates configuration for a dropwizard server Application class.\n+ *\n+ * @param <T> Configuration class type of the server.\n+ */\n+public class ServerConfiguration<T extends Configuration> {\n+\n+  private final Bootstrap<T> bootstrap;\n+  private final Map<Class<?>, ServerEndpointConfig> websockets = new HashMap<>();\n+\n+  @AllArgsConstructor\n+  public static class WebsocketConfig {\n+    private final Class<?> websocketClass;\n+    private final String path;\n+  }\n+\n+  public ServerConfiguration(\n+      final Bootstrap<T> bootstrap, final WebsocketConfig... websocketConfigs) {\n+    this.bootstrap = bootstrap;\n+\n+    final ServerEndpointConfig[] websockets = buildWebsockets(websocketConfigs);\n+    bootstrap.addBundle(new WebsocketBundle(websockets));\n+  }\n+\n+  private ServerEndpointConfig[] buildWebsockets(final WebsocketConfig... websocketConfigs) {\n+    return Arrays.stream(websocketConfigs)\n+        .map(\n+            websocketConfig -> {\n+              final var serverEndpointConfig =\n+                  ServerEndpointConfig.Builder.create(\n+                          websocketConfig.websocketClass, websocketConfig.path)\n+                      .build();\n+              websockets.put(websocketConfig.websocketClass, serverEndpointConfig);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf0776853892291252da5989441fe5fa3fcba278"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a5e9da0bd4c2271093926ac75a7f6f678323bd7", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/6a5e9da0bd4c2271093926ac75a7f6f678323bd7", "committedDate": "2020-08-22T00:33:50Z", "message": "Update method name 'buildWebsocket' -> 'addWebsocket'"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4006, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}