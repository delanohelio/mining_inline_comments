{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1MDU1MDI2", "number": 8087, "title": "Use new roll dice, select casualties, and remove casualties steps", "bodyText": "The Fire and FireAa classes are no longer used in building the 3 fire\nsub steps.\nThe AirVsNonSubs step is removed because that firing group is now named\nand will be displayed in the battle ui when it fires, selects, and\nremoves.\nThis is the last part of #7823\nThis will cause the step names in the battle UI to change because the new step classes generate slightly different names.  Here's an example of the old names:\n\nHere's what it looks now:\n\nNotice that there is a \"fire\", \"select\", and \"notify\" line for all of the firing groups.\nAnother change is how \"air vs subs\" is displayed in the Battle UI.  Previously, a single line was shown \"Air defend non subs\" or \"Air attack non subs\".  Here's an example:\n\nNow, that line is no longer going to be shown and instead each of the firing groups get their own set of \"fire\", \"select\", and \"remove\".  I've added special coding to detect the air vs subs to give it a better name.  Here's what it looks like now:\n\nIn addition to the new names, the Battle UI will actually highlight them.  So when there is different firing groups, each time the dice is rolled, it will highlight which firing group is doing it.  It previously worked this way only for AA firing groups.  If there were multiple other groups, it would just highlight the same \" fire\" line or \" select casualties\" until all the groups were done.\n\nTesting\n\nI've run a Hard AI run of WWII 1940 world for 12 rounds.  No errors were found.\nI ran multiple of my old saves to verify compatibility.  There is potentially some issues if some of the new step names don't match the old step names.  I've fixed most of them but there might be some really rare cases.  If these issues do happen, the UI will just say that \" wasn't found\" and continue.  And this will only affect the current round of the save game.  So it should be very minor.\nI ran AA flyover battles, strategic bombing battles, amphibious, land, sea, and sub battles.\nScreens Shots\n\nAdditional Notes to Reviewer\n\nRelease Note\n\nCHANGE|Battle step strings in Battle UI have been updated to indicate all of the possible offensive and defensive groups that are participating. Instead of one \"British fire\", there could be multiple \"British units fire\" depending on canNotTarget, canNotBeTargetedBy, subs, typeAA, etc", "createdAt": "2020-11-03T23:58:51Z", "url": "https://github.com/triplea-game/triplea/pull/8087", "merged": true, "mergeCommit": {"oid": "bf7a5367047e34f0f384f19176654a45d54a0048"}, "closed": true, "closedAt": "2020-11-05T02:50:35Z", "author": {"login": "trevan"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZCDclgH2gAyNTE1MDU1MDI2OmEzNjhjNTBmY2U4NWRkZjQ2NDg4ZWU2MmEwNmQ3OTkxOGZjNjQwNWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZZQCQgFqTUyMzg4OTI5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a368c50fce85ddf46488ee62a06d79918fc6405f", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/a368c50fce85ddf46488ee62a06d79918fc6405f", "committedDate": "2020-11-03T23:48:55Z", "message": "Use new roll dice, select casualties, and remove casualties steps\n\nThe Fire and FireAa classes are no longer used in building the 3 fire\nsub steps.\n\nThe AirVsNonSubs step is removed because that firing group is now named\nand will be displayed in the battle ui when it fires, selects, and\nremoves."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyOTY0MjA0", "url": "https://github.com/triplea-game/triplea/pull/8087#pullrequestreview-522964204", "createdAt": "2020-11-04T00:17:29Z", "commit": {"oid": "a368c50fce85ddf46488ee62a06d79918fc6405f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMDoxNzozMFrOHtE-Ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMDoxNzozMFrOHtE-Ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAyOTQ1OA==", "bodyText": "This method was moved from MustFightBattle without any changes.", "url": "https://github.com/triplea-game/triplea/pull/8087#discussion_r517029458", "createdAt": "2020-11-04T00:17:30Z", "author": {"login": "trevan"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/FireAa.java", "diffHunk": "@@ -182,77 +196,33 @@ public void execute(final ExecutionStack stack, final IDelegateBridge bridge) {\n     }\n   }\n \n-  private CasualtyDetails selectCasualties(\n-      final Collection<Unit> validAttackingUnitsForThisRoll,\n-      final Collection<Unit> defendingAa,\n-      final IDelegateBridge bridge,\n-      final String currentTypeAa) {\n-    // send defender the dice roll so he can see what the dice are while he waits for attacker to\n-    // select casualties\n-    bridge\n-        .getDisplayChannelBroadcaster()\n-        .notifyDice(\n-            dice,\n-            hitPlayer.getName()\n-                + BattleStepStrings.SELECT_PREFIX\n-                + currentTypeAa\n-                + BattleStepStrings.CASUALTIES_SUFFIX);\n-    return AaCasualtySelector.getAaCasualties(\n-        validAttackingUnitsForThisRoll,\n-        defendingAa,\n-        CombatValue.buildMainCombatValue(\n-            allFriendlyUnitsAliveOrWaitingToDie,\n-            allEnemyUnitsAliveOrWaitingToDie,\n-            !defending,\n-            bridge.getData(),\n-            battleSite,\n-            territoryEffects),\n-        CombatValue.buildAaCombatValue(\n-            allEnemyUnitsAliveOrWaitingToDie,\n-            allFriendlyUnitsAliveOrWaitingToDie,\n-            defending,\n-            bridge.getData()),\n-        \"Hits from \" + currentTypeAa + \", \",\n-        dice,\n-        bridge,\n-        hitPlayer,\n-        battleId,\n-        battleSite);\n-  }\n+  /**\n+   * Breaks list of units into groups of non suicide on hit units and each type of suicide on hit\n+   * units since each type of suicide on hit units need to roll separately to know which ones get\n+   * hits.\n+   */\n+  static List<Collection<Unit>> newFiringUnitGroups(final Collection<Unit> units) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a368c50fce85ddf46488ee62a06d79918fc6405f"}, "originalPosition": 208}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzODg5Mjk0", "url": "https://github.com/triplea-game/triplea/pull/8087#pullrequestreview-523889294", "createdAt": "2020-11-05T02:50:29Z", "commit": {"oid": "a368c50fce85ddf46488ee62a06d79918fc6405f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3842, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}