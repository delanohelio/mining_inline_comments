{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgxNzQ0NjA5", "number": 7573, "title": "Single docker database", "bodyText": "In short, instead of running two dockers for the two schemas which we eventually deploy to the same database, this update runs the two schemas on one dockers. It's very unlikely for us to ever have multiple physical databases. This update converts the 'maps-db' and 'lobby-db' subproject to a single one 'database' that can support multiple schemas. This helps avoid copy/paste of support scripts for working with database and very importantly avoids needing to fire up multiple docker databases (just need one now) before local testing or development can take place.\nThere are additional simplifications to configuration as we no longer need to override maps-server database port and can default the port consistently to always be 5432\n\nTesting\n\nScreens Shots\n\nAdditional Notes to Reviewer\n\nRelease Note", "createdAt": "2020-09-08T03:14:40Z", "url": "https://github.com/triplea-game/triplea/pull/7573", "merged": true, "mergeCommit": {"oid": "7c60f8cc4536da03b9507c1efeb7012cfd36e8ba"}, "closed": true, "closedAt": "2020-09-09T00:16:45Z", "author": {"login": "DanVanAtta"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdGuyuQgH2gAyNDgxNzQ0NjA5OjZmY2NjMzdhNTM4NGFlMWNlZDViYjhkNGQwZDdhMjdkNThhYjdkNzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdGxlhngH2gAyNDgxNzQ0NjA5OjRiMTkzMzcyODFkNmFhOWU5YjQ4NTYwYjg2ZGZjNmJmMDgxOWM3N2Y=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6fccc37a5384ae1ced5bb8d4d0d7a27d58ab7d77", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/6fccc37a5384ae1ced5bb8d4d0d7a27d58ab7d77", "committedDate": "2020-09-08T03:11:49Z", "message": "Consolidate databases to same server\n\n- Instead of running two dockers, run just one docker with different schemas\n- This first update consolidates maps-db migrations to lobby-db"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbec464f9784ccbda9ccd76b121c654333248ac9", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/fbec464f9784ccbda9ccd76b121c654333248ac9", "committedDate": "2020-09-08T03:12:11Z", "message": "Rename subproject: 'lobby-db' to 'database'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b804584117be55b3eb1c8666d3097efa45cdf4f1", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/b804584117be55b3eb1c8666d3097efa45cdf4f1", "committedDate": "2020-09-08T03:12:11Z", "message": "Update database readme file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "615ea6b17b85340ad60bf6668083c409f4d8ec04", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/615ea6b17b85340ad60bf6668083c409f4d8ec04", "committedDate": "2020-09-08T03:12:11Z", "message": "Update: infrastructure, Split apt_update and common package install"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78b8b78baf3c69986bf90b75f3d604524a1b6847", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/78b8b78baf3c69986bf90b75f3d604524a1b6847", "committedDate": "2020-09-08T03:12:11Z", "message": "Simplify database/build.gradle flyway config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2007f8b40a7b385b8cc69ef8d5247fd121b5b069", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/2007f8b40a7b385b8cc69ef8d5247fd121b5b069", "committedDate": "2020-09-08T03:12:11Z", "message": "Update infrastructure deployment to deploy from a single migrations file (same database, two schema)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6f28afc164d15d07959db0cfb93f89ef1749a4e", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/b6f28afc164d15d07959db0cfb93f89ef1749a4e", "committedDate": "2020-09-08T03:12:11Z", "message": "Update travis build to handle single database with both maps_db and lobby_db schema"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52af8f8fa7fc0fa506fa5a12779398cfd4af8cb1", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/52af8f8fa7fc0fa506fa5a12779398cfd4af8cb1", "committedDate": "2020-09-08T03:12:11Z", "message": "Remove start-databases script now that we have just one and update docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNzY5NzQz", "url": "https://github.com/triplea-game/triplea/pull/7573#pullrequestreview-483769743", "createdAt": "2020-09-08T03:16:19Z", "commit": {"oid": "52af8f8fa7fc0fa506fa5a12779398cfd4af8cb1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwMzoxNjoxOVrOHOLUtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwMzoxNjoxOVrOHOLUtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYyNzYzOA==", "bodyText": "Double quote to prevent globbing and word splitting.", "url": "https://github.com/triplea-game/triplea/pull/7573#discussion_r484627638", "createdAt": "2020-09-08T03:16:19Z", "author": {"login": "codeclimate"}, "path": "database/start_docker_db", "diffHunk": "@@ -0,0 +1,55 @@\n+#!/bin/bash\n+\n+set -eu\n+\n+bold=\"\\e[1m\"\n+bold_green=\"${bold}\\e[32m\"\n+normal=\"\\e[0m\"\n+\n+function main() {\n+  echo -e \"[${bold_green}STARTING DATABASE${normal}]\"\n+\n+  runDocker\n+  waitForDatabaseToStart\n+\n+  echo \"Deploying schema to lobby_db\"\n+  pwd\n+  \"$(dirname \"$0\")/../gradlew\" flywayMigrateAll\n+\n+  \"$(dirname \"$0\")\"/load_sample_data\n+  echo -e \"[${bold_green}DONE${normal}]\"\n+}\n+\n+function runDocker() {\n+  echo \"Stopping database..\"\n+  docker stop database || echo \"[OK] Database not running..\"\n+  docker run \\\n+    --rm  -d \\\n+    --name=\"database\" \\\n+    -p \"5432:5432\" \\\n+    -v \"$(pwd)/$(dirname $0)/sql/init/:/docker-entrypoint-initdb.d/\" \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52af8f8fa7fc0fa506fa5a12779398cfd4af8cb1"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc6d71260dbe403cfee07151eab9306d2a436991", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/fc6d71260dbe403cfee07151eab9306d2a436991", "committedDate": "2020-09-08T03:27:41Z", "message": "Run formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b688dd21de6b6d03f84fb2d04dd07cb2b135065", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/9b688dd21de6b6d03f84fb2d04dd07cb2b135065", "committedDate": "2020-09-08T03:29:57Z", "message": "Improve shell script quoting and MD file formatting."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6c58cd52af8cdfa6477d852ede2c491699a1cd8", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/c6c58cd52af8cdfa6477d852ede2c491699a1cd8", "committedDate": "2020-09-08T06:15:49Z", "message": "Remove Dockerfile and build script, we can use a 100% vanilla postgres image"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "252a95689b33ae1672c5e37379810a3ceda0b621", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/252a95689b33ae1672c5e37379810a3ceda0b621", "committedDate": "2020-09-08T06:19:18Z", "message": "Simplify and update database documentation further"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b19337281d6aa9e9b48560b86dfc6bf0819c77f", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/4b19337281d6aa9e9b48560b86dfc6bf0819c77f", "committedDate": "2020-09-08T06:27:07Z", "message": "Set postgres docker version to 10 to match travis\n\nSetting the version to 10 requires passwords to be set,\nset the database user password to be 'postgres' for all users."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3988, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}