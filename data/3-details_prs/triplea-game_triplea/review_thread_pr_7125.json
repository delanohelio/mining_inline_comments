{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3ODQ4NTk2", "number": 7125, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQwNDoyMDozM1rOENjrfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQyMDo0Mjo1OVrOENobtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNjUxNTE3OnYy", "diffSide": "RIGHT", "path": "infrastructure/ansible/roles/support/log_aggregation_sender/files/send_logs", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQwNDoyMDozM1rOGwRGvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQwNDoyMDozM1rOGwRGvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2NTA4Ng==", "bodyText": "Argument mixes string and array. Use * or separate argument.", "url": "https://github.com/triplea-game/triplea/pull/7125#discussion_r453265086", "createdAt": "2020-07-12T04:20:33Z", "author": {"login": "codeclimate"}, "path": "infrastructure/ansible/roles/support/log_aggregation_sender/files/send_logs", "diffHunk": "@@ -0,0 +1,48 @@\n+#!/bin/bash\n+###\n+### Sends the last hours worth of logs to a log aggregation server.\n+### \n+### Usage:\n+###    send_logs [journalctl_name] [log_server]\n+### Example:\n+###    send_logs bot@01 .ssh/logs_key_ed25519 logs@support01.triplea-game.org\n+###      \n+\n+app_name=\"$1\"\n+key_file=\"$2\"\n+log_server=\"$3\"\n+\n+function usage() {\n+  sed -rn 's/^### ?//;T;p' \"$0\"\n+}\n+\n+if [ -z \"$log_server\" ]; then\n+  echo \"Error: Missing arguments, received: '$@'\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ad517e7edbea4d5acb523d63cf4c891ee3f304a"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNjUxNTIwOnYy", "diffSide": "RIGHT", "path": "infrastructure/ansible/roles/support/log_aggregation_sender/files/send_logs", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQwNDoyMDozNFrOGwRGwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQwNDoyMDozNFrOGwRGwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2NTA4OQ==", "bodyText": "Double quote to prevent globbing and word splitting.", "url": "https://github.com/triplea-game/triplea/pull/7125#discussion_r453265089", "createdAt": "2020-07-12T04:20:34Z", "author": {"login": "codeclimate"}, "path": "infrastructure/ansible/roles/support/log_aggregation_sender/files/send_logs", "diffHunk": "@@ -0,0 +1,48 @@\n+#!/bin/bash\n+###\n+### Sends the last hours worth of logs to a log aggregation server.\n+### \n+### Usage:\n+###    send_logs [journalctl_name] [log_server]\n+### Example:\n+###    send_logs bot@01 .ssh/logs_key_ed25519 logs@support01.triplea-game.org\n+###      \n+\n+app_name=\"$1\"\n+key_file=\"$2\"\n+log_server=\"$3\"\n+\n+function usage() {\n+  sed -rn 's/^### ?//;T;p' \"$0\"\n+}\n+\n+if [ -z \"$log_server\" ]; then\n+  echo \"Error: Missing arguments, received: '$@'\"\n+  usage\n+  exit 1\n+fi\n+\n+\n+# This is the file where we will dump the last hours worth of logs\n+log_file=\"$(date -d '-1 hour ago' -u \"+%Y-%m-%d--%H\").$(hostname).$app_name.log\"\n+\n+# Touch the log file so that we have something to send always\n+touch /tmp/$log_file", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ad517e7edbea4d5acb523d63cf4c891ee3f304a"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNjUxNTIxOnYy", "diffSide": "RIGHT", "path": "infrastructure/ansible/roles/support/log_aggregation_sender/files/send_logs", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQwNDoyMDozNFrOGwRGwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQwNDoyMDozNFrOGwRGwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2NTA5MA==", "bodyText": "sudo doesn't affect redirects. Use ..| sudo tee file", "url": "https://github.com/triplea-game/triplea/pull/7125#discussion_r453265090", "createdAt": "2020-07-12T04:20:34Z", "author": {"login": "codeclimate"}, "path": "infrastructure/ansible/roles/support/log_aggregation_sender/files/send_logs", "diffHunk": "@@ -0,0 +1,48 @@\n+#!/bin/bash\n+###\n+### Sends the last hours worth of logs to a log aggregation server.\n+### \n+### Usage:\n+###    send_logs [journalctl_name] [log_server]\n+### Example:\n+###    send_logs bot@01 .ssh/logs_key_ed25519 logs@support01.triplea-game.org\n+###      \n+\n+app_name=\"$1\"\n+key_file=\"$2\"\n+log_server=\"$3\"\n+\n+function usage() {\n+  sed -rn 's/^### ?//;T;p' \"$0\"\n+}\n+\n+if [ -z \"$log_server\" ]; then\n+  echo \"Error: Missing arguments, received: '$@'\"\n+  usage\n+  exit 1\n+fi\n+\n+\n+# This is the file where we will dump the last hours worth of logs\n+log_file=\"$(date -d '-1 hour ago' -u \"+%Y-%m-%d--%H\").$(hostname).$app_name.log\"\n+\n+# Touch the log file so that we have something to send always\n+touch /tmp/$log_file\n+\n+# Grab the last hours worth of logs from journalctl and dump to file\n+sudo journalctl \\\n+  --since \"$(date -d '1 hour ago' -u \"+%Y-%m-%d %H:00:00 UTC\")\" \\\n+  --until \"$(date -d '1 hour ago' -u \"+%Y-%m-%d %H:59:59 UTC\")\" \\\n+  -u \"$app_name\" > /tmp/$log_file", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ad517e7edbea4d5acb523d63cf4c891ee3f304a"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNjUxNTIzOnYy", "diffSide": "RIGHT", "path": "infrastructure/ansible/roles/support/log_aggregation_sender/files/send_logs", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQwNDoyMDozNFrOGwRGxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQwNDoyMDozNFrOGwRGxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2NTA5Mg==", "bodyText": "Double quote to prevent globbing and word splitting.", "url": "https://github.com/triplea-game/triplea/pull/7125#discussion_r453265092", "createdAt": "2020-07-12T04:20:34Z", "author": {"login": "codeclimate"}, "path": "infrastructure/ansible/roles/support/log_aggregation_sender/files/send_logs", "diffHunk": "@@ -0,0 +1,48 @@\n+#!/bin/bash\n+###\n+### Sends the last hours worth of logs to a log aggregation server.\n+### \n+### Usage:\n+###    send_logs [journalctl_name] [log_server]\n+### Example:\n+###    send_logs bot@01 .ssh/logs_key_ed25519 logs@support01.triplea-game.org\n+###      \n+\n+app_name=\"$1\"\n+key_file=\"$2\"\n+log_server=\"$3\"\n+\n+function usage() {\n+  sed -rn 's/^### ?//;T;p' \"$0\"\n+}\n+\n+if [ -z \"$log_server\" ]; then\n+  echo \"Error: Missing arguments, received: '$@'\"\n+  usage\n+  exit 1\n+fi\n+\n+\n+# This is the file where we will dump the last hours worth of logs\n+log_file=\"$(date -d '-1 hour ago' -u \"+%Y-%m-%d--%H\").$(hostname).$app_name.log\"\n+\n+# Touch the log file so that we have something to send always\n+touch /tmp/$log_file\n+\n+# Grab the last hours worth of logs from journalctl and dump to file\n+sudo journalctl \\\n+  --since \"$(date -d '1 hour ago' -u \"+%Y-%m-%d %H:00:00 UTC\")\" \\\n+  --until \"$(date -d '1 hour ago' -u \"+%Y-%m-%d %H:59:59 UTC\")\" \\\n+  -u \"$app_name\" > /tmp/$log_file", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ad517e7edbea4d5acb523d63cf4c891ee3f304a"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNjUxNTI1OnYy", "diffSide": "RIGHT", "path": "infrastructure/ansible/roles/support/log_aggregation_sender/files/send_logs", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQwNDoyMDozNFrOGwRGxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQwNDoyMDozNFrOGwRGxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2NTA5NA==", "bodyText": "Note that, unescaped, this expands on the client side.", "url": "https://github.com/triplea-game/triplea/pull/7125#discussion_r453265094", "createdAt": "2020-07-12T04:20:34Z", "author": {"login": "codeclimate"}, "path": "infrastructure/ansible/roles/support/log_aggregation_sender/files/send_logs", "diffHunk": "@@ -0,0 +1,48 @@\n+#!/bin/bash\n+###\n+### Sends the last hours worth of logs to a log aggregation server.\n+### \n+### Usage:\n+###    send_logs [journalctl_name] [log_server]\n+### Example:\n+###    send_logs bot@01 .ssh/logs_key_ed25519 logs@support01.triplea-game.org\n+###      \n+\n+app_name=\"$1\"\n+key_file=\"$2\"\n+log_server=\"$3\"\n+\n+function usage() {\n+  sed -rn 's/^### ?//;T;p' \"$0\"\n+}\n+\n+if [ -z \"$log_server\" ]; then\n+  echo \"Error: Missing arguments, received: '$@'\"\n+  usage\n+  exit 1\n+fi\n+\n+\n+# This is the file where we will dump the last hours worth of logs\n+log_file=\"$(date -d '-1 hour ago' -u \"+%Y-%m-%d--%H\").$(hostname).$app_name.log\"\n+\n+# Touch the log file so that we have something to send always\n+touch /tmp/$log_file\n+\n+# Grab the last hours worth of logs from journalctl and dump to file\n+sudo journalctl \\\n+  --since \"$(date -d '1 hour ago' -u \"+%Y-%m-%d %H:00:00 UTC\")\" \\\n+  --until \"$(date -d '1 hour ago' -u \"+%Y-%m-%d %H:59:59 UTC\")\" \\\n+  -u \"$app_name\" > /tmp/$log_file\n+\n+\n+# Create the folder on the remote server where we will send the log file\n+log_folder_path=\"/home/admin/logs/$(date +%Y)/$(date +%m)/$(date +%d)\"\n+ssh -i \"$key_file\" \"$log_server\" \"mkdir -p $log_folder_path\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ad517e7edbea4d5acb523d63cf4c891ee3f304a"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNjUxNTI2OnYy", "diffSide": "RIGHT", "path": "infrastructure/ansible/roles/support/log_aggregation_sender/files/send_logs", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQwNDoyMDozNFrOGwRGxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQwNDoyMDozNFrOGwRGxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2NTA5NQ==", "bodyText": "Double quote to prevent globbing and word splitting.", "url": "https://github.com/triplea-game/triplea/pull/7125#discussion_r453265095", "createdAt": "2020-07-12T04:20:34Z", "author": {"login": "codeclimate"}, "path": "infrastructure/ansible/roles/support/log_aggregation_sender/files/send_logs", "diffHunk": "@@ -0,0 +1,48 @@\n+#!/bin/bash\n+###\n+### Sends the last hours worth of logs to a log aggregation server.\n+### \n+### Usage:\n+###    send_logs [journalctl_name] [log_server]\n+### Example:\n+###    send_logs bot@01 .ssh/logs_key_ed25519 logs@support01.triplea-game.org\n+###      \n+\n+app_name=\"$1\"\n+key_file=\"$2\"\n+log_server=\"$3\"\n+\n+function usage() {\n+  sed -rn 's/^### ?//;T;p' \"$0\"\n+}\n+\n+if [ -z \"$log_server\" ]; then\n+  echo \"Error: Missing arguments, received: '$@'\"\n+  usage\n+  exit 1\n+fi\n+\n+\n+# This is the file where we will dump the last hours worth of logs\n+log_file=\"$(date -d '-1 hour ago' -u \"+%Y-%m-%d--%H\").$(hostname).$app_name.log\"\n+\n+# Touch the log file so that we have something to send always\n+touch /tmp/$log_file\n+\n+# Grab the last hours worth of logs from journalctl and dump to file\n+sudo journalctl \\\n+  --since \"$(date -d '1 hour ago' -u \"+%Y-%m-%d %H:00:00 UTC\")\" \\\n+  --until \"$(date -d '1 hour ago' -u \"+%Y-%m-%d %H:59:59 UTC\")\" \\\n+  -u \"$app_name\" > /tmp/$log_file\n+\n+\n+# Create the folder on the remote server where we will send the log file\n+log_folder_path=\"/home/admin/logs/$(date +%Y)/$(date +%m)/$(date +%d)\"\n+ssh -i \"$key_file\" \"$log_server\" \"mkdir -p $log_folder_path\"\n+\n+# Copy the log file to the remote server\n+scp -i \"$key_file\" \"/tmp/$log_file\" \"$log_server:$log_folder_path/$log_file\"\n+\n+# Clean up locally\n+rm /tmp/$log_file", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ad517e7edbea4d5acb523d63cf4c891ee3f304a"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNjczNTEyOnYy", "diffSide": "RIGHT", "path": "infrastructure/ansible/roles/system/admin_user/tasks/main.yml", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQwOToyMzoxMFrOGwSu4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQyMDowNDozNlrOGwWwHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI5MTc0NQ==", "bodyText": "adm?", "url": "https://github.com/triplea-game/triplea/pull/7125#discussion_r453291745", "createdAt": "2020-07-12T09:23:10Z", "author": {"login": "RoiEXLab"}, "path": "infrastructure/ansible/roles/system/admin_user/tasks/main.yml", "diffHunk": "@@ -11,7 +11,7 @@\n     shell: /bin/bash\n     create_home: yes\n     append: yes\n-    groups: admin\n+    groups: admin,adm", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e59eae9a62e4486115d1bae9a4b688774c0262fc"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM0OTQ3NQ==", "bodyText": "Of some note, in this update we add 'admin' user to the 'adm' group on\napplication servers to allow 'admin' user sudo-less journalctl. Without\nthat you need to run 'sudo' to be able to view logs for arbitrary systemctl\nservices.", "url": "https://github.com/triplea-game/triplea/pull/7125#discussion_r453349475", "createdAt": "2020-07-12T18:40:11Z", "author": {"login": "DanVanAtta"}, "path": "infrastructure/ansible/roles/system/admin_user/tasks/main.yml", "diffHunk": "@@ -11,7 +11,7 @@\n     shell: /bin/bash\n     create_home: yes\n     append: yes\n-    groups: admin\n+    groups: admin,adm", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI5MTc0NQ=="}, "originalCommit": {"oid": "e59eae9a62e4486115d1bae9a4b688774c0262fc"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM1NzU5Ng==", "bodyText": "Ah, missed that part. I was searching for this in the rest of the diff but couldn't find it.\nThanks for clarifying", "url": "https://github.com/triplea-game/triplea/pull/7125#discussion_r453357596", "createdAt": "2020-07-12T20:04:36Z", "author": {"login": "RoiEXLab"}, "path": "infrastructure/ansible/roles/system/admin_user/tasks/main.yml", "diffHunk": "@@ -11,7 +11,7 @@\n     shell: /bin/bash\n     create_home: yes\n     append: yes\n-    groups: admin\n+    groups: admin,adm", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI5MTc0NQ=="}, "originalCommit": {"oid": "e59eae9a62e4486115d1bae9a4b688774c0262fc"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNzI5Mzk2OnYy", "diffSide": "RIGHT", "path": "infrastructure/ansible/roles/support/log_aggregation_sender/files/send_logs", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQyMDo0Mjo1OVrOGwW-wA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQyMDo0Mjo1OVrOGwW-wA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM2MTM0NA==", "bodyText": "Note that, unescaped, this expands on the client side.", "url": "https://github.com/triplea-game/triplea/pull/7125#discussion_r453361344", "createdAt": "2020-07-12T20:42:59Z", "author": {"login": "codeclimate"}, "path": "infrastructure/ansible/roles/support/log_aggregation_sender/files/send_logs", "diffHunk": "@@ -0,0 +1,48 @@\n+#!/bin/bash\n+###\n+### Sends the last hours worth of logs to a log aggregation server.\n+### Key file and user are controlled by .ssh/config\n+### \n+### Usage:\n+###    send_logs [journalctl_name] [log_server]\n+### Example:\n+###    send_logs bot@01 support01.triplea-game.org\n+###      \n+\n+app_name=\"$1\"\n+log_server=\"$2\"\n+\n+function usage() {\n+  sed -rn 's/^### ?//;T;p' \"$0\"\n+}\n+\n+if [ -z \"$log_server\" ]; then\n+  echo \"Error: Missing arguments, received: '$*'\"\n+  usage\n+  exit 1\n+fi\n+\n+\n+# This is the file where we will dump the last hours worth of logs\n+log_file=\"$(date -d '-1 hour' -u \"+%Y-%m-%d--%H\").$(hostname).$app_name.log\"\n+\n+# Touch the log file so that we have something to send always\n+touch \"/tmp/$log_file\"\n+\n+# Grab the last hours worth of logs from journalctl and dump to file\n+journalctl \\\n+  --since \"$(date -d '1 hour ago' -u \"+%Y-%m-%d %H:00:00 UTC\")\" \\\n+  --until \"$(date -d '1 hour ago' -u \"+%Y-%m-%d %H:59:59 UTC\")\" \\\n+  -u \"$app_name\" > \"/tmp/$log_file\"\n+\n+\n+# Create the folder on the remote server where we will send the log file\n+log_folder_path=\"/home/admin/logs/$(date +%Y)/$(date +%m)/$(date +%d)\"\n+ssh \"$log_server\" \"mkdir -p $log_folder_path\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de970700c63af8ee14bd75b252b8b7d274e34759"}, "originalPosition": 41}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2002, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}