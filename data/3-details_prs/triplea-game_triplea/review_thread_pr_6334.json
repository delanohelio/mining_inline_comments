{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA5MDAxNjkw", "number": 6334, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNlQwMjoxMzoyMFrOD2OayA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMzo1ODozMFrOD282MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU4MTg1OTI4OnYy", "diffSide": "RIGHT", "path": "http-clients/src/main/java/org/triplea/http/client/lobby/chat/upload/ChatMessageUpload.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNlQwMjoxMzoyMFrOGL9SMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNlQwMjoxMzoyMFrOGL9SMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE5MTYwMw==", "bodyText": "Similar blocks of code found in 2 locations. Consider refactoring.", "url": "https://github.com/triplea-game/triplea/pull/6334#discussion_r415191603", "createdAt": "2020-04-26T02:13:20Z", "author": {"login": "codeclimate"}, "path": "http-clients/src/main/java/org/triplea/http/client/lobby/chat/upload/ChatMessageUpload.java", "diffHunk": "@@ -0,0 +1,21 @@\n+package org.triplea.http.client.lobby.chat.upload;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "917bc7ad8544d1b10e4e6b7aa9f45e064e2746ed"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU4OTQ0MTYyOnYy", "diffSide": "RIGHT", "path": "http-server/src/main/java/org/triplea/db/dao/lobby/games/LobbyGameDao.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMzo0OTozMVrOGM8bNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwMDoyMDo1M1rOGM9H-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyNjEwMA==", "bodyText": "Ok this formatting confused me for a second", "url": "https://github.com/triplea-game/triplea/pull/6334#discussion_r416226100", "createdAt": "2020-04-27T23:49:31Z", "author": {"login": "RoiEXLab"}, "path": "http-server/src/main/java/org/triplea/db/dao/lobby/games/LobbyGameDao.java", "diffHunk": "@@ -0,0 +1,60 @@\n+package org.triplea.db.dao.lobby.games;\n+\n+import com.google.common.base.Ascii;\n+import org.jdbi.v3.sqlobject.customizer.Bind;\n+import org.jdbi.v3.sqlobject.statement.SqlUpdate;\n+import org.triplea.db.dao.api.key.ApiKeyHasher;\n+import org.triplea.domain.data.ApiKey;\n+import org.triplea.http.client.lobby.game.lobby.watcher.ChatMessageUpload;\n+import org.triplea.http.client.lobby.game.lobby.watcher.LobbyGameListing;\n+import org.triplea.java.Postconditions;\n+\n+/**\n+ * Game chat history table stores chat messages that have happened in games. This data is upload by\n+ * game servers to the lobby and is then recorded in database.\n+ */\n+public interface LobbyGameDao {\n+  int MESSAGE_COLUMN_LENGTH = 240;\n+\n+  default void insertLobbyGame(ApiKey apiKey, LobbyGameListing lobbyGameListing) {\n+    final String hashedkey = new ApiKeyHasher().apply(apiKey);\n+    final int insertCount =\n+        insertLobbyGame(\n+            lobbyGameListing.getLobbyGame().getHostName(), //\n+            lobbyGameListing.getGameId(),\n+            hashedkey);\n+    Postconditions.assertState(\n+        insertCount == 1, \"Failed to insert lobby game: \" + lobbyGameListing);\n+  }\n+\n+  @SqlUpdate(\n+      \"insert into lobby_game(host_name, game_id, game_hosting_api_key_id) \"\n+          + \"values (\"\n+          + \"  :hostName,\"\n+          + \"  :gameId,\"\n+          + \"  (select id from game_hosting_api_key where key = :apiKey))\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e428cb27bef505146343b2826cefc2579dff66f"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIzNzU2Mg==", "bodyText": "The string concats do make it kinda difficult. One 'values' arg per line is not too uncommon though.", "url": "https://github.com/triplea-game/triplea/pull/6334#discussion_r416237562", "createdAt": "2020-04-28T00:20:53Z", "author": {"login": "DanVanAtta"}, "path": "http-server/src/main/java/org/triplea/db/dao/lobby/games/LobbyGameDao.java", "diffHunk": "@@ -0,0 +1,60 @@\n+package org.triplea.db.dao.lobby.games;\n+\n+import com.google.common.base.Ascii;\n+import org.jdbi.v3.sqlobject.customizer.Bind;\n+import org.jdbi.v3.sqlobject.statement.SqlUpdate;\n+import org.triplea.db.dao.api.key.ApiKeyHasher;\n+import org.triplea.domain.data.ApiKey;\n+import org.triplea.http.client.lobby.game.lobby.watcher.ChatMessageUpload;\n+import org.triplea.http.client.lobby.game.lobby.watcher.LobbyGameListing;\n+import org.triplea.java.Postconditions;\n+\n+/**\n+ * Game chat history table stores chat messages that have happened in games. This data is upload by\n+ * game servers to the lobby and is then recorded in database.\n+ */\n+public interface LobbyGameDao {\n+  int MESSAGE_COLUMN_LENGTH = 240;\n+\n+  default void insertLobbyGame(ApiKey apiKey, LobbyGameListing lobbyGameListing) {\n+    final String hashedkey = new ApiKeyHasher().apply(apiKey);\n+    final int insertCount =\n+        insertLobbyGame(\n+            lobbyGameListing.getLobbyGame().getHostName(), //\n+            lobbyGameListing.getGameId(),\n+            hashedkey);\n+    Postconditions.assertState(\n+        insertCount == 1, \"Failed to insert lobby game: \" + lobbyGameListing);\n+  }\n+\n+  @SqlUpdate(\n+      \"insert into lobby_game(host_name, game_id, game_hosting_api_key_id) \"\n+          + \"values (\"\n+          + \"  :hostName,\"\n+          + \"  :gameId,\"\n+          + \"  (select id from game_hosting_api_key where key = :apiKey))\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyNjEwMA=="}, "originalCommit": {"oid": "8e428cb27bef505146343b2826cefc2579dff66f"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU4OTQ0NTA5OnYy", "diffSide": "RIGHT", "path": "http-server/src/main/java/org/triplea/db/dao/lobby/games/LobbyGameDao.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMzo1MDo1MVrOGM8dIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwMDoyMjozNlrOGM9Kcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyNjU5NQ==", "bodyText": "Is this to check if (select id from game_hosting_api_key where key = :apiKey) did actually return a single entry?\nMight be worth adding a comment to explain this.\nI don't think any other place in the code actually checks the insert count", "url": "https://github.com/triplea-game/triplea/pull/6334#discussion_r416226595", "createdAt": "2020-04-27T23:50:51Z", "author": {"login": "RoiEXLab"}, "path": "http-server/src/main/java/org/triplea/db/dao/lobby/games/LobbyGameDao.java", "diffHunk": "@@ -0,0 +1,60 @@\n+package org.triplea.db.dao.lobby.games;\n+\n+import com.google.common.base.Ascii;\n+import org.jdbi.v3.sqlobject.customizer.Bind;\n+import org.jdbi.v3.sqlobject.statement.SqlUpdate;\n+import org.triplea.db.dao.api.key.ApiKeyHasher;\n+import org.triplea.domain.data.ApiKey;\n+import org.triplea.http.client.lobby.game.lobby.watcher.ChatMessageUpload;\n+import org.triplea.http.client.lobby.game.lobby.watcher.LobbyGameListing;\n+import org.triplea.java.Postconditions;\n+\n+/**\n+ * Game chat history table stores chat messages that have happened in games. This data is upload by\n+ * game servers to the lobby and is then recorded in database.\n+ */\n+public interface LobbyGameDao {\n+  int MESSAGE_COLUMN_LENGTH = 240;\n+\n+  default void insertLobbyGame(ApiKey apiKey, LobbyGameListing lobbyGameListing) {\n+    final String hashedkey = new ApiKeyHasher().apply(apiKey);\n+    final int insertCount =\n+        insertLobbyGame(\n+            lobbyGameListing.getLobbyGame().getHostName(), //\n+            lobbyGameListing.getGameId(),\n+            hashedkey);\n+    Postconditions.assertState(\n+        insertCount == 1, \"Failed to insert lobby game: \" + lobbyGameListing);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e428cb27bef505146343b2826cefc2579dff66f"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIzODE5NA==", "bodyText": "If the subselect returns 0 elements we'll get a non-null constraint violation.\n\nI don't think any other place in the code actually checks the insert count\n\nWe should have at least a few. When adding a good number of inserts before during JDBI migration I actually removed a number of ''postcondition' checks so that 'postconditions' could be PR'd at the same time.. Slightly interesting history; in general we should be checking insert count and not just blindly trusting it succeeded.", "url": "https://github.com/triplea-game/triplea/pull/6334#discussion_r416238194", "createdAt": "2020-04-28T00:22:36Z", "author": {"login": "DanVanAtta"}, "path": "http-server/src/main/java/org/triplea/db/dao/lobby/games/LobbyGameDao.java", "diffHunk": "@@ -0,0 +1,60 @@\n+package org.triplea.db.dao.lobby.games;\n+\n+import com.google.common.base.Ascii;\n+import org.jdbi.v3.sqlobject.customizer.Bind;\n+import org.jdbi.v3.sqlobject.statement.SqlUpdate;\n+import org.triplea.db.dao.api.key.ApiKeyHasher;\n+import org.triplea.domain.data.ApiKey;\n+import org.triplea.http.client.lobby.game.lobby.watcher.ChatMessageUpload;\n+import org.triplea.http.client.lobby.game.lobby.watcher.LobbyGameListing;\n+import org.triplea.java.Postconditions;\n+\n+/**\n+ * Game chat history table stores chat messages that have happened in games. This data is upload by\n+ * game servers to the lobby and is then recorded in database.\n+ */\n+public interface LobbyGameDao {\n+  int MESSAGE_COLUMN_LENGTH = 240;\n+\n+  default void insertLobbyGame(ApiKey apiKey, LobbyGameListing lobbyGameListing) {\n+    final String hashedkey = new ApiKeyHasher().apply(apiKey);\n+    final int insertCount =\n+        insertLobbyGame(\n+            lobbyGameListing.getLobbyGame().getHostName(), //\n+            lobbyGameListing.getGameId(),\n+            hashedkey);\n+    Postconditions.assertState(\n+        insertCount == 1, \"Failed to insert lobby game: \" + lobbyGameListing);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyNjU5NQ=="}, "originalCommit": {"oid": "8e428cb27bef505146343b2826cefc2579dff66f"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU4OTQ2NjA4OnYy", "diffSide": "RIGHT", "path": "http-server/src/main/java/org/triplea/modules/game/lobby/watcher/ChatUploadModule.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMzo1ODozMFrOGM8odA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwMDoyNDo0MFrOGM9NKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyOTQ5Mg==", "bodyText": "I just noticed that the return value is used to potentially display  a warning message.\nWhy did you decide it's better to do the warning outside?", "url": "https://github.com/triplea-game/triplea/pull/6334#discussion_r416229492", "createdAt": "2020-04-27T23:58:30Z", "author": {"login": "RoiEXLab"}, "path": "http-server/src/main/java/org/triplea/modules/game/lobby/watcher/ChatUploadModule.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package org.triplea.modules.game.lobby.watcher;\n+\n+import java.util.function.BiPredicate;\n+import lombok.AllArgsConstructor;\n+import org.jdbi.v3.core.Jdbi;\n+import org.triplea.db.dao.lobby.games.LobbyGameDao;\n+import org.triplea.domain.data.ApiKey;\n+import org.triplea.http.client.lobby.game.lobby.watcher.ChatMessageUpload;\n+import org.triplea.modules.game.listing.GameListing;\n+\n+/**\n+ * Responsible for inserting chat messages into database. Validates that a given request has a\n+ * matching game-id and api-key pair, otherwise does a no-op. We need to be sure to validate an\n+ * API-key and game-id match otherwise an attacker with an http client could try to insert incorrect\n+ * data, game-id's are publicly known, but API-keys are not. Only the actual host should know the\n+ * api-key.\n+ *\n+ * <p>If the ID and API-Key pair are not valid, we will just drop the request and return a 200 If we\n+ * return a 400 or some other error, we'll give a potential attacker a way to try and guess\n+ * API-Keys.\n+ */\n+@AllArgsConstructor\n+class ChatUploadModule {\n+  private final LobbyGameDao lobbyGameDao;\n+  private final BiPredicate<ApiKey, String> gameIdValidator;\n+\n+  static ChatUploadModule build(final Jdbi jdbi, final GameListing gameListing) {\n+    return new ChatUploadModule(\n+        jdbi.onDemand(LobbyGameDao.class), gameListing::isValidApiKeyAndGameId);\n+  }\n+\n+  public boolean upload(final ChatMessageUpload chatMessageUpload) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e428cb27bef505146343b2826cefc2579dff66f"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIzODg5MA==", "bodyText": "Separation of responsibility I suppose. This class has trouble knowing if the 'silent fail' is actually an error condition or not.  Beyond that, we don't have all the information we'd want to log, notably the IP of who sent us this request as this condition is perhaps likely to be an attacker.", "url": "https://github.com/triplea-game/triplea/pull/6334#discussion_r416238890", "createdAt": "2020-04-28T00:24:40Z", "author": {"login": "DanVanAtta"}, "path": "http-server/src/main/java/org/triplea/modules/game/lobby/watcher/ChatUploadModule.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package org.triplea.modules.game.lobby.watcher;\n+\n+import java.util.function.BiPredicate;\n+import lombok.AllArgsConstructor;\n+import org.jdbi.v3.core.Jdbi;\n+import org.triplea.db.dao.lobby.games.LobbyGameDao;\n+import org.triplea.domain.data.ApiKey;\n+import org.triplea.http.client.lobby.game.lobby.watcher.ChatMessageUpload;\n+import org.triplea.modules.game.listing.GameListing;\n+\n+/**\n+ * Responsible for inserting chat messages into database. Validates that a given request has a\n+ * matching game-id and api-key pair, otherwise does a no-op. We need to be sure to validate an\n+ * API-key and game-id match otherwise an attacker with an http client could try to insert incorrect\n+ * data, game-id's are publicly known, but API-keys are not. Only the actual host should know the\n+ * api-key.\n+ *\n+ * <p>If the ID and API-Key pair are not valid, we will just drop the request and return a 200 If we\n+ * return a 400 or some other error, we'll give a potential attacker a way to try and guess\n+ * API-Keys.\n+ */\n+@AllArgsConstructor\n+class ChatUploadModule {\n+  private final LobbyGameDao lobbyGameDao;\n+  private final BiPredicate<ApiKey, String> gameIdValidator;\n+\n+  static ChatUploadModule build(final Jdbi jdbi, final GameListing gameListing) {\n+    return new ChatUploadModule(\n+        jdbi.onDemand(LobbyGameDao.class), gameListing::isValidApiKeyAndGameId);\n+  }\n+\n+  public boolean upload(final ChatMessageUpload chatMessageUpload) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyOTQ5Mg=="}, "originalCommit": {"oid": "8e428cb27bef505146343b2826cefc2579dff66f"}, "originalPosition": 32}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2299, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}