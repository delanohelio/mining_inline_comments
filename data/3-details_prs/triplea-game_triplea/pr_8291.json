{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4MzcyMzM5", "number": 8291, "title": "Unify low luck and normal roll code in DiceRoll", "bodyText": "The AA low luck and normal rolls have the same logic as the non-AA low\nluck and normal rolls. The only difference is handling dice sides that\nare different from the game state.  So add a getDiceSides method to\nTotalPowerAndTotalRolls and unify the code for low luck and normal\nrolls.\n\nTesting\n\nPlayed HardAI of Global 40 and WAW to test both normal and low luck games.\nScreens Shots\n\nAdditional Notes to Reviewer\n\nRelease Note", "createdAt": "2020-11-27T03:23:07Z", "url": "https://github.com/triplea-game/triplea/pull/8291", "merged": true, "mergeCommit": {"oid": "a56352c2323e53228794ed63da6a514951b1db34"}, "closed": true, "closedAt": "2020-11-27T17:45:55Z", "author": {"login": "trevan"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgezm6AH2gAyNTI4MzcyMzM5OjY2YWFmZmY5NmE1NTgzZDk4NmZmMTk3YjAwNjVjOTJhMDM2ZjRkN2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgrPiXAFqTU0MDEyMDUzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "66aafff96a5583d986ff197b0065c92a036f4d7a", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/66aafff96a5583d986ff197b0065c92a036f4d7a", "committedDate": "2020-11-27T03:16:20Z", "message": "Unify low luck and normal roll code in DiceRoll\n\nThe AA low luck and normal rolls have the same logic as the non-AA low\nluck and normal rolls. The only difference is handling dice sides that\nare different from the game state.  So add a getDiceSides method to\nTotalPowerAndTotalRolls and unify the code for low luck and normal\nrolls."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwMDUyMDQ0", "url": "https://github.com/triplea-game/triplea/pull/8291#pullrequestreview-540052044", "createdAt": "2020-11-27T15:20:08Z", "commit": {"oid": "66aafff96a5583d986ff197b0065c92a036f4d7a"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxNToyMDowOFrOH7B1vA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxNTozNzoxMVrOH7CU1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY1ODE3Mg==", "bodyText": "Would you mind updating the documentation that 'aaUnits' must have at least one element in it?", "url": "https://github.com/triplea-game/triplea/pull/8291#discussion_r531658172", "createdAt": "2020-11-27T15:20:08Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/DiceRoll.java", "diffHunk": "@@ -110,74 +110,26 @@ public static DiceRoll rollAa(\n       final Territory location,\n       final CombatValue combatValueCalculator) {\n \n-    final GameData data = bridge.getData();\n+    final String typeAa = UnitAttachment.get(aaUnits.iterator().next().getType()).getTypeAa();\n+    final GamePlayer player = aaUnits.iterator().next().getOwner();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66aafff96a5583d986ff197b0065c92a036f4d7a"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY2MTc3MQ==", "bodyText": "Side-note, this interface I think has lost its cohesion, it is more than total power and total rolls. It's also odds as TotalPowerAndTotalRolls would seem to be the name for a value object rather than an interface. This is something that if we can would be good t come back and rename. I almost think this would be an even better interface for a 'unitGroup', or have that just be a class and get rid of the sub-classing altogether and have the unitGroup use this for an API that would 'just do the right thing'.", "url": "https://github.com/triplea-game/triplea/pull/8291#discussion_r531661771", "createdAt": "2020-11-27T15:27:54Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/power/calculator/TotalPowerAndTotalRolls.java", "diffHunk": "@@ -13,6 +13,8 @@\n \n   List<Die> getDiceHits(int[] dice);\n \n+  int getDiceSides();\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66aafff96a5583d986ff197b0065c92a036f4d7a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY2MjY0NQ==", "bodyText": "unitPowerAndRollsMap is an unexpected name for this parameter as the type is not a map. Any objections to renaming it?", "url": "https://github.com/triplea-game/triplea/pull/8291#discussion_r531662645", "createdAt": "2020-11-27T15:29:49Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/DiceRoll.java", "diffHunk": "@@ -219,37 +171,40 @@ public static DiceRoll rollDice(\n       final String annotation,\n       final CombatValue combatValueCalculator) {\n \n+    final DiceRoll diceRoll;\n+    final PowerStrengthAndRolls unitPowerAndRollsMap =\n+        PowerStrengthAndRolls.build(units, combatValueCalculator);\n     if (Properties.getLowLuck(bridge.getData().getProperties())) {\n-      return rollDiceLowLuck(units, player, bridge, annotation, combatValueCalculator);\n+      diceRoll = rollDiceLowLuck(unitPowerAndRollsMap, player, bridge, annotation);\n+    } else {\n+      diceRoll = rollDiceNormal(unitPowerAndRollsMap, player, bridge, annotation);\n     }\n-    return rollDiceNormal(units, player, bridge, annotation, combatValueCalculator);\n+\n+    bridge\n+        .getHistoryWriter()\n+        .addChildToEvent(annotation + \" : \" + MyFormatter.asDice(diceRoll), diceRoll);\n+    return diceRoll;\n   }\n \n   /** Roll dice for units using low luck rules. */\n   private static DiceRoll rollDiceLowLuck(\n-      final Collection<Unit> unitsList,\n+      final TotalPowerAndTotalRolls unitPowerAndRollsMap,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66aafff96a5583d986ff197b0065c92a036f4d7a"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY2MzM2NA==", "bodyText": "It seems like 'hitCount' should be part of the 'totalPowerAndRolls' interface. Getting data from an object and then using that data to compute a value, as is the case here, appears to be a 'feature-envy' code-smell.\nIt might be possible that if the API is getHitCount, then we won't need the getDiceSides method and the dice sides would instead turn into a constructor arg for implementations of totalPowerAndRolls", "url": "https://github.com/triplea-game/triplea/pull/8291#discussion_r531663364", "createdAt": "2020-11-27T15:31:21Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/DiceRoll.java", "diffHunk": "@@ -219,37 +171,40 @@ public static DiceRoll rollDice(\n       final String annotation,\n       final CombatValue combatValueCalculator) {\n \n+    final DiceRoll diceRoll;\n+    final PowerStrengthAndRolls unitPowerAndRollsMap =\n+        PowerStrengthAndRolls.build(units, combatValueCalculator);\n     if (Properties.getLowLuck(bridge.getData().getProperties())) {\n-      return rollDiceLowLuck(units, player, bridge, annotation, combatValueCalculator);\n+      diceRoll = rollDiceLowLuck(unitPowerAndRollsMap, player, bridge, annotation);\n+    } else {\n+      diceRoll = rollDiceNormal(unitPowerAndRollsMap, player, bridge, annotation);\n     }\n-    return rollDiceNormal(units, player, bridge, annotation, combatValueCalculator);\n+\n+    bridge\n+        .getHistoryWriter()\n+        .addChildToEvent(annotation + \" : \" + MyFormatter.asDice(diceRoll), diceRoll);\n+    return diceRoll;\n   }\n \n   /** Roll dice for units using low luck rules. */\n   private static DiceRoll rollDiceLowLuck(\n-      final Collection<Unit> unitsList,\n+      final TotalPowerAndTotalRolls unitPowerAndRollsMap,\n       final GamePlayer player,\n       final IDelegateBridge bridge,\n-      final String annotation,\n-      final CombatValue combatValueCalculator) {\n-\n-    final GameData data = bridge.getData();\n+      final String annotation) {\n \n-    final int power =\n-        PowerStrengthAndRolls.build(unitsList, combatValueCalculator).calculateTotalPower();\n+    final int power = unitPowerAndRollsMap.calculateTotalPower();\n     if (power == 0) {\n       return new DiceRoll(List.of(), 0, 0);\n     }\n \n     // Roll dice for the fractional part of the dice\n-    int hitCount = power / data.getDiceSides();\n+    final int diceSides = unitPowerAndRollsMap.getDiceSides();\n+    int hitCount = power / diceSides;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66aafff96a5583d986ff197b0065c92a036f4d7a"}, "originalPosition": 147}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY2NjEzNQ==", "bodyText": "Side-note, perhaps worth doing here as we've re-written the entire method almost, most of the javadocs on the method are not very valuable.\nEG:\n\n\" aaUnits - AA units that could potentially be rolling\" < does not really add much information.\n\"@param location - battle territory\" < seems like the parameter should just be renamed\n\"* @param bridge - delegate bridge\" < ditto, parameter could just be renamed.", "url": "https://github.com/triplea-game/triplea/pull/8291#discussion_r531666135", "createdAt": "2020-11-27T15:37:11Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/DiceRoll.java", "diffHunk": "@@ -110,74 +110,26 @@ public static DiceRoll rollAa(\n       final Territory location,\n       final CombatValue combatValueCalculator) {\n \n-    final GameData data = bridge.getData();\n+    final String typeAa = UnitAttachment.get(aaUnits.iterator().next().getType()).getTypeAa();\n+    final GamePlayer player = aaUnits.iterator().next().getOwner();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY1ODE3Mg=="}, "originalCommit": {"oid": "66aafff96a5583d986ff197b0065c92a036f4d7a"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d39b07d4260ffa75ece4cf76b01c25dc76fdc3da", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/d39b07d4260ffa75ece4cf76b01c25dc76fdc3da", "committedDate": "2020-11-27T16:31:17Z", "message": "Rename variables and fix documentation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwMTIwNTMw", "url": "https://github.com/triplea-game/triplea/pull/8291#pullrequestreview-540120530", "createdAt": "2020-11-27T17:45:42Z", "commit": {"oid": "d39b07d4260ffa75ece4cf76b01c25dc76fdc3da"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3783, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}