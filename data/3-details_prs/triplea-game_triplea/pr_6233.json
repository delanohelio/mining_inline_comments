{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyNzU3MTEw", "number": 6233, "title": "Cache unit support information to speed up AI.", "bodyText": "Cache unit support information to speed up AI.\nComputing this dominated the battle simulation code, which is also\nused heavily in AI logic.\nThe cpu time (across threads) of DiceRoll.getSortedSupport() over\none round of an all-AI Domination 1914 game took 175 seconds prior\nto this change. After this change, it was 14 seconds.\nFunctional Changes\n\n[] New map or map update\n[] New Feature\n[] Feature update or enhancement\n[] Feature Removal\n[] Code Cleanup or refactor\n[] Configuration Change\n[] Problem fix:  \n[X] Other:  Optimization\nTesting\n\nRan unit tests from IntelliJ in game-core.\nRan one round of an all-AI game on Domination 1914 without errors.", "createdAt": "2020-04-13T17:46:28Z", "url": "https://github.com/triplea-game/triplea/pull/6233", "merged": true, "mergeCommit": {"oid": "7c3b1bf5a97624aa8e60c2fea647fc5d480d0bce"}, "closed": true, "closedAt": "2020-04-14T02:00:40Z", "author": {"login": "asvitkine"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXSj68AH2gAyNDAyNzU3MTEwOmM4ODFmYTQyNzlhYTJlZjEwMzEzY2ZhNTMyNWY2ZWYyYjJlZmUyYjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXWeYPAH2gAyNDAyNzU3MTEwOmIyZWNlZDNkZWFjODg0YmFkOTVkNTkyY2YxNWM3ODU0ZjBmZDY5NjE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c881fa4279aa2ef10313cfa5325f6ef2b2efe2b8", "author": {"user": {"login": "asvitkine", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/c881fa4279aa2ef10313cfa5325f6ef2b2efe2b8", "committedDate": "2020-04-13T17:43:52Z", "message": "Cache unit support information to speed up AI.\n\nComputing this dominated the battle simulation code, which is also\nused heavily in AI logic.\n\nThe cpu time (across threads) of DiceRoll.getSortedSupport() over\none round of an all-AI Domination 1914 game took 175 seconds prior\nto this change. After this change, it was 14 seconds."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMzE2NzIw", "url": "https://github.com/triplea-game/triplea/pull/6233#pullrequestreview-392316720", "createdAt": "2020-04-13T17:56:37Z", "commit": {"oid": "c881fa4279aa2ef10313cfa5325f6ef2b2efe2b8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNzo1NjozN1rOGEvIBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNzo1NjozN1rOGEvIBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYxOTU4OA==", "bodyText": "Did you happen to measure if there is a performance boost of using parallel stream here instead of stream? parallel stream is oddly often slower than stream.", "url": "https://github.com/triplea-game/triplea/pull/6233#discussion_r407619588", "createdAt": "2020-04-13T17:56:37Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/engine/data/UnitTypeList.java", "diffHunk": "@@ -40,6 +44,22 @@ public UnitType getUnitType(final String name) {\n     return types;\n   }\n \n+  /**\n+   * Returns the unit support rules for the unit types. Computed once and cached afterwards.\n+   *\n+   * @return The unit support rules.\n+   */\n+  public Set<UnitSupportAttachment> getSupportRules() {\n+    if (supportRules == null) {\n+      supportRules =\n+          UnitSupportAttachment.get(getData())\n+              .parallelStream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c881fa4279aa2ef10313cfa5325f6ef2b2efe2b8"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMzE3OTU3", "url": "https://github.com/triplea-game/triplea/pull/6233#pullrequestreview-392317957", "createdAt": "2020-04-13T17:58:17Z", "commit": {"oid": "c881fa4279aa2ef10313cfa5325f6ef2b2efe2b8"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNzo1ODoxOFrOGEvMFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxODowMzoxMFrOGEvXSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyMDYyOQ==", "bodyText": "If support rules are only used in DiceRoll, what's the rational to move them to UnitTypeList?", "url": "https://github.com/triplea-game/triplea/pull/6233#discussion_r407620629", "createdAt": "2020-04-13T17:58:18Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/DiceRoll.java", "diffHunk": "@@ -997,14 +997,9 @@ public static void getSortedSupport(\n       final GameData data,\n       final boolean defence,\n       final boolean allies) {\n-    final Set<UnitSupportAttachment> rules =\n-        UnitSupportAttachment.get(data)\n-            .parallelStream()\n-            .filter(usa -> (usa.getRoll() || usa.getStrength()))\n-            .collect(Collectors.toSet());\n     getSupport(\n         unitsGivingTheSupport,\n-        rules,\n+        data.getUnitTypeList().getSupportRules(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c881fa4279aa2ef10313cfa5325f6ef2b2efe2b8"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyMjY0MA==", "bodyText": "side-note, the method consuming this is overspecified\n  private static void getSupport(\n      final Collection<Unit> unitsGivingTheSupport,\n      final Set<UnitSupportAttachment> rules,\n      :\n\nWith the above, a consequence is if you have a List of rules, or any other non-Set collection, then you need to do a needless copy into a set. That method works fine when the collection type is changed to a Collection, ie:\n  private static void getSupport(\n      final Collection<Unit> unitsGivingTheSupport,\n      final Collection<UnitSupportAttachment> rules,\n     :", "url": "https://github.com/triplea-game/triplea/pull/6233#discussion_r407622640", "createdAt": "2020-04-13T18:01:37Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/engine/data/UnitTypeList.java", "diffHunk": "@@ -40,6 +44,22 @@ public UnitType getUnitType(final String name) {\n     return types;\n   }\n \n+  /**\n+   * Returns the unit support rules for the unit types. Computed once and cached afterwards.\n+   *\n+   * @return The unit support rules.\n+   */\n+  public Set<UnitSupportAttachment> getSupportRules() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c881fa4279aa2ef10313cfa5325f6ef2b2efe2b8"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyMzQ5Nw==", "bodyText": "Are you sure that usa, unit support attachment getStrength will never change?", "url": "https://github.com/triplea-game/triplea/pull/6233#discussion_r407623497", "createdAt": "2020-04-13T18:03:10Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/engine/data/UnitTypeList.java", "diffHunk": "@@ -40,6 +44,22 @@ public UnitType getUnitType(final String name) {\n     return types;\n   }\n \n+  /**\n+   * Returns the unit support rules for the unit types. Computed once and cached afterwards.\n+   *\n+   * @return The unit support rules.\n+   */\n+  public Set<UnitSupportAttachment> getSupportRules() {\n+    if (supportRules == null) {\n+      supportRules =\n+          UnitSupportAttachment.get(getData())\n+              .parallelStream()\n+              .filter(usa -> (usa.getRoll() || usa.getStrength()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c881fa4279aa2ef10313cfa5325f6ef2b2efe2b8"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMzM5MDU3", "url": "https://github.com/triplea-game/triplea/pull/6233#pullrequestreview-392339057", "createdAt": "2020-04-13T18:30:00Z", "commit": {"oid": "c881fa4279aa2ef10313cfa5325f6ef2b2efe2b8"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNDI2MDM3", "url": "https://github.com/triplea-game/triplea/pull/6233#pullrequestreview-392426037", "createdAt": "2020-04-13T20:45:03Z", "commit": {"oid": "c881fa4279aa2ef10313cfa5325f6ef2b2efe2b8"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2eced3deac884bad95d592cf15c7854f0fd6961", "author": {"user": {"login": "asvitkine", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/b2eced3deac884bad95d592cf15c7854f0fd6961", "committedDate": "2020-04-13T22:17:26Z", "message": "Use stream() and mark field transient."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3481, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}