{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyNDEzMTg1", "number": 5992, "title": "Hardcode network opcodes", "bodyText": "This is my proposal for the thing discussed in #5986\nI have no Idea if this does actually work, but for some reason gradle + lombok doesn't seem to be working anymore so I can really test this :(\nRan a local network game (where both parties were on this branch, so no compatibility checks there) and after some initial problems the current version seems to run fine without any problems. (I got an NPE in the UI code at some point, but it doesn't seem related)\nTell me what you think on the overall design choices.\nFunctional Changes\n\n[] New map or map update\n[] New Feature\n[] Feature update or enhancement\n[] Feature Removal\n[x] Code Cleanup or refactor\n[] Configuration Change\n[] Problem fix:  \n[] Other:   \nTesting\n\n[x] Manual testing done\n\n\n\n\nAdditional Review Notes\nIn case you're interested, here's the code I used to add most of the annotations:\n#!/usr/bin/env python3\n\nimport re\n\ndef main():\n  with open('path/to/Op-Codes.txt', 'r') as f:\n    for line in f:\n      if line:\n        if line[0] != '\\t':\n          file_path = line.replace('.', '/').strip().split('$')[0] + '.java'\n        elif ':' in line:\n          method, opcode = line.split(':')\n          method = method.strip()\n          opcode = int(opcode.strip())\n\n          split_method = method.split('(')\n          args = [s.split('.')[-1] for s in split_method[1][:-1].split(', ') if s]\n\n          method_name = split_method[0]\n\n          pattern = '\\\\r?\\\\n.*?' + re.escape(method_name) + '\\\\([^)]*?' + '[^)]*?'.join(re.escape(s) for s in args) + '[^,]*\\)'\n\n          print(pattern)\n\n          # Needs to run in triplea/game-core/src/main/java\n          with open(file_path, 'r') as f1:\n            content = f1.read()\n\n          content = re.sub(pattern, lambda m: ('\\n@RemoteActionCode(%d)' % opcode) + m.group(0), content)\n\n          with open(file_path, 'w') as f2:\n            f2.write(content)\n\nif __name__ == '__main__':\n  main()\nNot perfect, but good enough.", "createdAt": "2020-03-02T14:24:27Z", "url": "https://github.com/triplea-game/triplea/pull/5992", "merged": true, "mergeCommit": {"oid": "6ea949f141c1444caab0af8fa2b2776f4356ed77"}, "closed": true, "closedAt": "2020-03-03T12:13:50Z", "author": {"login": "RoiEXLab"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcJttlRgH2gAyMzgyNDEzMTg1OjQ2ZmI0YTU4M2M2NjY5NTdlODM5M2FjNDI2YWY4NzY1MjgwMzZlYzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKA7bPAH2gAyMzgyNDEzMTg1Ojc4YTBhYTczNWJkY2ZmOTRjMzY5Y2UzYzk4YTIzNzFiZTc0NjdhMmI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "46fb4a583c666957e8393ac426af876528036ec5", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/46fb4a583c666957e8393ac426af876528036ec5", "committedDate": "2020-03-02T13:26:55Z", "message": "Add annotations usiing script"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7bac2b60877332a088bbaca0711f4492f89e312", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/c7bac2b60877332a088bbaca0711f4492f89e312", "committedDate": "2020-03-02T13:54:49Z", "message": "Auto-Format and fix compile errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ab30b7597a128c49fe77a8f148f8683f021d3a9", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/2ab30b7597a128c49fe77a8f148f8683f021d3a9", "committedDate": "2020-03-02T14:11:08Z", "message": "Avoid weird comparator logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5d941be8f43db1c651d407feff0c66903d75c65", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/f5d941be8f43db1c651d407feff0c66903d75c65", "committedDate": "2020-03-02T14:31:35Z", "message": "Fix compilation error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cc85e26ecc3f4c0841651c55db2253addee2619", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/2cc85e26ecc3f4c0841651c55db2253addee2619", "committedDate": "2020-03-02T14:32:01Z", "message": "Fix typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8f3128cdbfe92d9255ed455aaa69350b1f0479a", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/f8f3128cdbfe92d9255ed455aaa69350b1f0479a", "committedDate": "2020-03-02T14:38:56Z", "message": "Fix double annotation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dccab88f686b0e9a1d8e92077433c9664c8b44e9", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/dccab88f686b0e9a1d8e92077433c9664c8b44e9", "committedDate": "2020-03-02T14:57:54Z", "message": "Add missing annotations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac1e2d875653d4c93b7653aa2afa97069bfcd3ca", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/ac1e2d875653d4c93b7653aa2afa97069bfcd3ca", "committedDate": "2020-03-02T14:58:07Z", "message": "Remove redundant field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8622d3f5f2b4117323ba019c04c1db5dccccd3d9", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/8622d3f5f2b4117323ba019c04c1db5dccccd3d9", "committedDate": "2020-03-02T15:01:40Z", "message": "Remove unused method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb63ed63907b4c3241dcc5d33730daa9e87e8b72", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/cb63ed63907b4c3241dcc5d33730daa9e87e8b72", "committedDate": "2020-03-02T15:04:47Z", "message": "Fix test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3a2130f304baa31da71695cec0e14f4fde75fac", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/a3a2130f304baa31da71695cec0e14f4fde75fac", "committedDate": "2020-03-02T15:07:57Z", "message": "Add documentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71f74e1bbb6097f4b8445ad20b1b9293b90b797e", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/71f74e1bbb6097f4b8445ad20b1b9293b90b797e", "committedDate": "2020-03-02T15:18:06Z", "message": "Fix EndPointTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2dda8afea786316479fdbef3c19c38a8f9aa2762", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/2dda8afea786316479fdbef3c19c38a8f9aa2762", "committedDate": "2020-03-02T16:26:18Z", "message": "Remove now redundant documentation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3MzQxMDI0", "url": "https://github.com/triplea-game/triplea/pull/5992#pullrequestreview-367341024", "createdAt": "2020-03-02T16:29:58Z", "commit": {"oid": "2dda8afea786316479fdbef3c19c38a8f9aa2762"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxNjoyOTo1OFrOFwmQRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxNjoyOTo1OFrOFwmQRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUwMjcyNw==", "bodyText": "Now with those changes this unused method can safely be removed", "url": "https://github.com/triplea-game/triplea/pull/5992#discussion_r386502727", "createdAt": "2020-03-02T16:29:58Z", "author": {"login": "RoiEXLab"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/remote/IEditDelegate.java", "diffHunk": "@@ -6,37 +6,48 @@\n import games.strategy.engine.data.Unit;\n import games.strategy.engine.delegate.IPersistentDelegate;\n import games.strategy.engine.message.IRemote;\n+import games.strategy.engine.message.RemoteActionCode;\n import games.strategy.triplea.delegate.TechAdvance;\n import java.util.Collection;\n import org.triplea.java.collections.IntegerMap;\n import org.triplea.util.Triple;\n \n /** Remote interface for EditDelegate. */\n public interface IEditDelegate extends IRemote, IPersistentDelegate {\n+  @RemoteActionCode(9)\n   boolean getEditMode();\n \n+  @RemoteActionCode(12)\n   void setEditMode(boolean editMode);\n \n+  @RemoteActionCode(11)\n   String removeUnits(Territory t, Collection<Unit> units);\n \n+  @RemoteActionCode(2)\n   String addUnits(Territory t, Collection<Unit> units);\n \n+  @RemoteActionCode(6)\n   String changeTerritoryOwner(Territory t, GamePlayer player);\n \n+  @RemoteActionCode(3)\n   String changePUs(GamePlayer player, int pus);\n \n-  String changeTechTokens(GamePlayer player, int tokens);\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2dda8afea786316479fdbef3c19c38a8f9aa2762"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NjY4Njc2", "url": "https://github.com/triplea-game/triplea/pull/5992#pullrequestreview-367668676", "createdAt": "2020-03-03T02:40:19Z", "commit": {"oid": "2dda8afea786316479fdbef3c19c38a8f9aa2762"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMjo0MDoxOVrOFw2isw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMjo0NjoyNlrOFw2o5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc2OTU4Nw==", "bodyText": "Should we re-order the methods so that the numbers would be ascending? I think that might help make it clear there are no gaps and just be nicer when reading the methods.", "url": "https://github.com/triplea-game/triplea/pull/5992#discussion_r386769587", "createdAt": "2020-03-03T02:40:19Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/engine/chat/IChatChannel.java", "diffHunk": "@@ -1,29 +1,31 @@\n package games.strategy.engine.chat;\n \n import games.strategy.engine.message.IChannelSubscriber;\n+import games.strategy.engine.message.RemoteActionCode;\n import org.triplea.domain.data.UserName;\n import org.triplea.http.client.lobby.chat.ChatParticipant;\n \n-/**\n- * Chat messages occur on this channel.\n- *\n- * <p>RMI warning: the ordering of methods cannot be changed, these methods will be invoked by\n- * method order number\n- */\n+/** Chat messages occur on this channel. */\n public interface IChatChannel extends IChannelSubscriber {\n   // we get the sender from MessageContext\n+  @RemoteActionCode(0)\n   void chatOccurred(String message);\n \n+  @RemoteActionCode(2)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2dda8afea786316479fdbef3c19c38a8f9aa2762"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc3MDM5OA==", "bodyText": "Looks like we are still bound by method name (and ordering must be preserved, but at least that is in annotation now). Is there a way we could put the method name in the annotation as well?", "url": "https://github.com/triplea-game/triplea/pull/5992#discussion_r386770398", "createdAt": "2020-03-03T02:43:32Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/test/java/games/strategy/engine/message/unifiedmessenger/EndPointTest.java", "diffHunk": "@@ -2,25 +2,26 @@\n \n import static org.junit.jupiter.api.Assertions.assertEquals;\n \n+import games.strategy.engine.message.RemoteActionCode;\n import games.strategy.engine.message.RemoteMethodCall;\n import games.strategy.engine.message.RemoteMethodCallResults;\n-import java.util.Comparator;\n import java.util.List;\n import org.junit.jupiter.api.Test;\n \n class EndPointTest {\n \n+  interface TestInterface {\n+    @RemoteActionCode(0)\n+    @SuppressWarnings(\"unused\")\n+    int dummy();\n+  }\n+\n   @Test\n-  void testEndPoint() {\n-    final EndPoint endPoint = new EndPoint(\"\", Comparator.class, false);\n-    endPoint.addImplementor((Comparator<Object>) (o1, o2) -> 2);\n+  void testEndPoint() throws Exception {\n+    final EndPoint endPoint = new EndPoint(\"\", TestInterface.class, false);\n+    endPoint.addImplementor((TestInterface) () -> 2);\n     final RemoteMethodCall call =\n-        new RemoteMethodCall(\n-            \"\",\n-            \"compare\",\n-            new Object[] {\"\", \"\"},\n-            new Class<?>[] {Object.class, Object.class},\n-            Comparator.class);\n+        new RemoteMethodCall(\"\", TestInterface.class.getMethod(\"dummy\"), new Object[] {});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2dda8afea786316479fdbef3c19c38a8f9aa2762"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc3MTE3NQ==", "bodyText": "I'd perhaps rephrase this slightly.\n\nopcode does not have a well defined meaning, perhaps better to say something along the lines of: \"Annotation that defines a method number, methods are called by method number using the {@link RemoteMethodCall} mechanism}\". In order to stay compatible over the network, annotated methods should be altered (including: renaming, changes in signature, or changes in the method ordering number).\"", "url": "https://github.com/triplea-game/triplea/pull/5992#discussion_r386771175", "createdAt": "2020-03-03T02:46:26Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/engine/message/RemoteActionCode.java", "diffHunk": "@@ -0,0 +1,19 @@\n+package games.strategy.engine.message;\n+\n+import java.lang.annotation.ElementType;\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+import java.lang.annotation.Target;\n+\n+/**\n+ * Annotation that sets the \"opcode\" for any particular method that may be used over the network", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2dda8afea786316479fdbef3c19c38a8f9aa2762"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78a0aa735bdcff94c369ce3c98a2371be7467a2b", "author": {"user": {"login": "RoiEXLab", "name": "RoiEX"}}, "url": "https://github.com/triplea-game/triplea/commit/78a0aa735bdcff94c369ce3c98a2371be7467a2b", "committedDate": "2020-03-03T11:50:14Z", "message": "Enhance javadoc"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3708, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}