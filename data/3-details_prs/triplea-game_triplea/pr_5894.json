{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5ODcyNjA1", "number": 5894, "title": "Infra auto cert", "bodyText": "Automate certbot letsencrypt and cert renewal\nFix nginx restarting on every deployment run, only restart if config changes\n\nAdditional Review Notes\n\nCommit-by-commit review may help break down the changesets and make review somewhat easier\n\n \nFunctional Changes\n\n[] New map or map update\n[] New Feature\n[] Feature update or enhancement\n[] Feature Removal\n[] Code Cleanup or refactor\n[x] Configuration Change\n[] Problem fix:  \n[] Other:   \nTesting\n\n[x] Manual testing done\n\nPreliminary:\n~/work/triplea/infrastructure$ echo \"***vault-password-omitted***\" > vault_password\n\nFull deployment command:\n~/work/triplea/infrastructure$ ./run_deployment 2.0.17779 -i ansible/inventory/prerelease\n\nNginx Deployment command:\n~/work/triplea/infrastructure$ ./run_deployment 2.0.17779 -i ansible/inventory/prerelease -t nginx --diff\n\nCertBot Deployment command:\n~/work/triplea/infrastructure$ ./run_deployment 2.0.17779 -i ansible/inventory/prerelease -t certbot --diff\n\n\n\nDeployed Nginx\n\nVerified:\n\n/etc/nginx/sites-enabled/default contained generated cert files\n\n\n\n\n\nDeployed Certbot\n\nVerified:\n\n/etc/nginx/sites-enabled/default contained letsencrypt cert files\n\n\n\n\n\nDeployed Nginx\n\nVerified:\n\n/etc/nginx/sites-enabled/default contained letsencrypt cert files\nansible reported no changes\n\n\n\n\n\nDeleted:\n\n\n/etc/letsencrypt\n\n\n/etc/nginx/cert.*\n\n\nDeployed Nginx\n\nVerified:\n\n/etc/nginx/sites-enabled/default contained generated cert files\nansible reported no changes\n\n\n\n\n\nDeployed Certbot\n\nVerified:\n\n/etc/nginx/sites-enabled/default contained letsencrypt cert files\n\n\n\n\n\nConnected to prerelease lobby with headed-game lobby using URL (in test tab): https://prerelease.triplea-game.org\n\nVerified:\n\nchat works\n\n\nNoticed:\n\nSeeing a presumably false-positive error message for a connection problem connecting to websocket URL\n\n\n\n\n\nConnected to prerelease lobby with a second headed-game lobby using URL (in test tab): https://prerelease.triplea-game.org\n\nVerified:\n\nchat works and visible to all connected headed-games\n\n\n\n\n\nDeleted the Prerelease linode\n\n\nCreated a new prerelease linode nanode\n\nubuntu 18.04 LTS\nused the well known root password\nselected the well known ssh key from linode account (we each should add this in the linode account settings)\n\n\n\nUpdated namecheap A & AAAA DNS records for prerelease to reflect new IPv4 and IPv6 addresses\n\n\nWaited for DNS changes to take effect\n\n\nRan full deployment\n\nVerified:\n\n/etc/nginx/sites-enabled/default contained letsencrypt cert files\n\n\n\n\n\nConnected to prerelease lobby with headed-game lobby using URL (in test tab): https://prerelease.triplea-game.org\n\nVerified:\n\nchat works\n\n\n\n\n\nDeployed Nginx\n\nVerified:\n\nestablished prerelease lobby connection from headed-game instance was not interrupted\n/etc/nginx/sites-enabled/default contained letsencrypt cert files\n\n\n\n\n\nDeployed CertBot\n\nVerified:\n\nestablished prerelease lobby connection from headed-game instance was not interrupted\n\n\n\n\n\nDeleted:\n\n\n/etc/letsencrypt\n\n\n/etc/nginx/cert.*\n\n\nDeployed Nginx\n\nVerified:\n\n/etc/nginx/sites-enabled/default contained generated cert files\n\n\n\n\n\nDeployed Certbot\n\nVerified:\n\n/etc/nginx/sites-enabled/default contained letsencrypt cert files\n\n\n\n\n\nConnected to prerelease lobby with headed-game lobby using URL (in test tab): https://prerelease.triplea-game.org\n\n\nVerified:\n\nchat works", "createdAt": "2020-02-01T08:19:58Z", "url": "https://github.com/triplea-game/triplea/pull/5894", "merged": true, "mergeCommit": {"oid": "5832ce1796ec77c5b570f0eecc9f37756d3c9d47"}, "closed": true, "closedAt": "2020-02-01T23:11:51Z", "author": {"login": "DanVanAtta"}, "timelineItems": {"totalCount": 30, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb__NpagH2gAyMzY5ODcyNjA1OmZmNDJiNjI5OGJkMjYwYWUwZGMyZjI2NzA0NDcwYjFmZDMzMmRmODQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcAL48RAH2gAyMzY5ODcyNjA1OjBhZjI5MzY0ZWUwZmU1OTFlMjcyYThhZTNiM2NlYzNkMTA1YTg2Y2I=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ff42b6298bd260ae0dc2f26704470b1fd332df84", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/ff42b6298bd260ae0dc2f26704470b1fd332df84", "committedDate": "2020-02-01T08:11:05Z", "message": "Ansible: Automate letsencrypt cert generation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7972db8b0fea8ef09526ecc641484f063d702595", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/7972db8b0fea8ef09526ecc641484f063d702595", "committedDate": "2020-02-01T08:11:09Z", "message": "Ansible: restart nginx only if config changed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d096c78fea931a362011cb758059f8b8e2bb030a", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/d096c78fea931a362011cb758059f8b8e2bb030a", "committedDate": "2020-02-01T08:11:09Z", "message": "Ansible: add certbot certificate renewal cronjob"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed972c8ac6b618d134dd2275c7e19057b2c0eb8b", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/ed972c8ac6b618d134dd2275c7e19057b2c0eb8b", "committedDate": "2020-02-01T08:11:09Z", "message": "Update infrastructure/README notes\n\n- fix up example commands\n- simplify and update https cert installation notes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee441ffa825e109b1eee96ca95051291c9003e85", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/ee441ffa825e109b1eee96ca95051291c9003e85", "committedDate": "2020-02-01T08:11:09Z", "message": "Ansible: Update site.yml deployment playbook to deploy certbot to only prod and prerelease"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7113b2978be63786e3bd24b8d6655d49998cf42f", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/7113b2978be63786e3bd24b8d6655d49998cf42f", "committedDate": "2020-02-01T08:11:09Z", "message": "Ansible: Run certbot only when needed and fix nginx configuration drift problem"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78d30e0991ac2b2233c5b41063a2f68cf475323a", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/78d30e0991ac2b2233c5b41063a2f68cf475323a", "committedDate": "2020-02-01T08:11:09Z", "message": "Ansible: Fix http_server port variable defined in that role but used in a different role"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "316c4206a042ab903c8afee00e832e5ee39aa368", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/316c4206a042ab903c8afee00e832e5ee39aa368", "committedDate": "2020-02-01T08:11:09Z", "message": "Ansible: Restart nginx if new cert keys are deployed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e07d510b7b78fcd637c7a28be64565579b829c9d", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/e07d510b7b78fcd637c7a28be64565579b829c9d", "committedDate": "2020-02-01T08:13:31Z", "message": "Ansible: Remove commented out properties"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6795b0daac398019e2e1705258b8c1e3b3f3adf5", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/6795b0daac398019e2e1705258b8c1e3b3f3adf5", "committedDate": "2020-02-01T08:16:08Z", "message": "Simplify letsEncrypt hostgroup config"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxODcyNjU3", "url": "https://github.com/triplea-game/triplea/pull/5894#pullrequestreview-351872657", "createdAt": "2020-02-01T08:21:29Z", "commit": {"oid": "6795b0daac398019e2e1705258b8c1e3b3f3adf5"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMVQwODoyMTozMFrOFkc4uQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMVQwODoyMTozMFrOFkc4uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc2NjMyOQ==", "bodyText": "Headers should be surrounded by blank lines", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373766329", "createdAt": "2020-02-01T08:21:30Z", "author": {"login": "codeclimate"}, "path": "infrastructure/README.md", "diffHunk": "@@ -80,19 +80,22 @@ examples\n \n # To see 'diff' output, which shows how each file on server is being updated\n #  (caution!! this can expose secret values to stdout)\n-./run_deployment 2.0.1000 -d -i ansible/inventory/prerelease\n+./run_deployment 2.0.1000 --diff -i ansible/inventory/prerelease\n \n # To see SSL debug output:\n+./run_deployment 2.0.1000 -vvvv -i ansible/inventory/prerelease\n+\n+# To see debug output from each command:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6795b0daac398019e2e1705258b8c1e3b3f3adf5"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc2NjMzMA==", "bodyText": "Multiple top level headers in the same document", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373766330", "createdAt": "2020-02-01T08:21:30Z", "author": {"login": "codeclimate"}, "path": "infrastructure/README.md", "diffHunk": "@@ -80,19 +80,22 @@ examples\n \n # To see 'diff' output, which shows how each file on server is being updated\n #  (caution!! this can expose secret values to stdout)\n-./run_deployment 2.0.1000 -d -i ansible/inventory/prerelease\n+./run_deployment 2.0.1000 --diff -i ansible/inventory/prerelease\n \n # To see SSL debug output:\n+./run_deployment 2.0.1000 -vvvv -i ansible/inventory/prerelease\n+\n+# To see debug output from each command:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6795b0daac398019e2e1705258b8c1e3b3f3adf5"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc2NjMzMQ==", "bodyText": "Trailing punctuation in header", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373766331", "createdAt": "2020-02-01T08:21:30Z", "author": {"login": "codeclimate"}, "path": "infrastructure/README.md", "diffHunk": "@@ -80,19 +80,22 @@ examples\n \n # To see 'diff' output, which shows how each file on server is being updated\n #  (caution!! this can expose secret values to stdout)\n-./run_deployment 2.0.1000 -d -i ansible/inventory/prerelease\n+./run_deployment 2.0.1000 --diff -i ansible/inventory/prerelease\n \n # To see SSL debug output:\n+./run_deployment 2.0.1000 -vvvv -i ansible/inventory/prerelease\n+\n+# To see debug output from each command:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6795b0daac398019e2e1705258b8c1e3b3f3adf5"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "651f04a9a496c701b317f7808a435a5534dcdf87", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/651f04a9a496c701b317f7808a435a5534dcdf87", "committedDate": "2020-02-01T19:27:44Z", "message": "Restructure examples in MD file"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxOTAwMzA1", "url": "https://github.com/triplea-game/triplea/pull/5894#pullrequestreview-351900305", "createdAt": "2020-02-01T19:29:59Z", "commit": {"oid": "651f04a9a496c701b317f7808a435a5534dcdf87"}, "state": "COMMENTED", "comments": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMVQxOToyOTo1OVrOFkeyng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMVQxOTozMDowMlrOFkeyqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzUzNA==", "bodyText": "Inconsistent indentation for list items at the same level", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797534", "createdAt": "2020-02-01T19:29:59Z", "author": {"login": "codeclimate"}, "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,46 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n+  * -v: Verbose output", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "651f04a9a496c701b317f7808a435a5534dcdf87"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzUzNQ==", "bodyText": "Inconsistent indentation for list items at the same level", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797535", "createdAt": "2020-02-01T19:29:59Z", "author": {"login": "codeclimate"}, "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,46 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n+  * -v: Verbose output\n+  * -vvv: Debug output", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "651f04a9a496c701b317f7808a435a5534dcdf87"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzUzNg==", "bodyText": "Inconsistent indentation for list items at the same level", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797536", "createdAt": "2020-02-01T19:29:59Z", "author": {"login": "codeclimate"}, "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,46 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n+  * -v: Verbose output\n+  * -vvv: Debug output\n+  * -vvvv: SSL Debug output", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "651f04a9a496c701b317f7808a435a5534dcdf87"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzUzOA==", "bodyText": "Inconsistent indentation for list items at the same level", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797538", "createdAt": "2020-02-01T19:30:00Z", "author": {"login": "codeclimate"}, "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,46 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n+  * -v: Verbose output\n+  * -vvv: Debug output\n+  * -vvvv: SSL Debug output\n+  * --diff: Shows differences in updated templates and files", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "651f04a9a496c701b317f7808a435a5534dcdf87"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzUzOQ==", "bodyText": "Inconsistent indentation for list items at the same level", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797539", "createdAt": "2020-02-01T19:30:00Z", "author": {"login": "codeclimate"}, "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,46 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n+  * -v: Verbose output\n+  * -vvv: Debug output\n+  * -vvvv: SSL Debug output\n+  * --diff: Shows differences in updated templates and files\n+  * -t : Tags", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "651f04a9a496c701b317f7808a435a5534dcdf87"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzU0MA==", "bodyText": "Consider starting bulleted lists at the beginning of the line", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797540", "createdAt": "2020-02-01T19:30:00Z", "author": {"login": "codeclimate"}, "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,46 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n+  * -v: Verbose output", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "651f04a9a496c701b317f7808a435a5534dcdf87"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzU0MQ==", "bodyText": "Trailing spaces", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797541", "createdAt": "2020-02-01T19:30:00Z", "author": {"login": "codeclimate"}, "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,46 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n+  * -v: Verbose output\n+  * -vvv: Debug output\n+  * -vvvv: SSL Debug output\n+  * --diff: Shows differences in updated templates and files\n+  * -t : Tags\n \n-# To see verbose output\n-./run_deployment 2.0.1000 -v -i ansible/inventory/prerelease\n+### Examples with Tags\n \n-# To see 'diff' output, which shows how each file on server is being updated\n-#  (caution!! this can expose secret values to stdout)\n-./run_deployment 2.0.1000 -d -i ansible/inventory/prerelease\n \n-# To see SSL debug output:\n-./run_deployment 2.0.1000 -vvv -i ansible/inventory/prerelease\n+#### Deploy just bots\n \n-# To deploy to just bots, use tags, '-t' (see playbook for tag names)\n-./run_deployment 2.0.1000 -vvv -t bots -i ansible/inventory/prerelease\n+```bash\n+./run_deployment 2.0.1000 -t bots -i ansible/inventory/prerelease\n+```\n+\n+#### Deploy NGINX and CertBot\n+```bash\n+./run_deployment 2.0.1000 -t nginx,certbot -i ansible/inventory/prerelease\n ```\n \n+\n+## Example Prod Deployment\n+ ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "651f04a9a496c701b317f7808a435a5534dcdf87"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzU0Mg==", "bodyText": "Headers should be surrounded by blank lines", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797542", "createdAt": "2020-02-01T19:30:00Z", "author": {"login": "codeclimate"}, "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,46 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "651f04a9a496c701b317f7808a435a5534dcdf87"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzU0Mw==", "bodyText": "Headers should be surrounded by blank lines", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797543", "createdAt": "2020-02-01T19:30:01Z", "author": {"login": "codeclimate"}, "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,46 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "651f04a9a496c701b317f7808a435a5534dcdf87"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzU0NA==", "bodyText": "Headers should be surrounded by blank lines", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797544", "createdAt": "2020-02-01T19:30:01Z", "author": {"login": "codeclimate"}, "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,46 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n+  * -v: Verbose output\n+  * -vvv: Debug output\n+  * -vvvv: SSL Debug output\n+  * --diff: Shows differences in updated templates and files\n+  * -t : Tags\n \n-# To see verbose output\n-./run_deployment 2.0.1000 -v -i ansible/inventory/prerelease\n+### Examples with Tags\n \n-# To see 'diff' output, which shows how each file on server is being updated\n-#  (caution!! this can expose secret values to stdout)\n-./run_deployment 2.0.1000 -d -i ansible/inventory/prerelease\n \n-# To see SSL debug output:\n-./run_deployment 2.0.1000 -vvv -i ansible/inventory/prerelease\n+#### Deploy just bots\n \n-# To deploy to just bots, use tags, '-t' (see playbook for tag names)\n-./run_deployment 2.0.1000 -vvv -t bots -i ansible/inventory/prerelease\n+```bash\n+./run_deployment 2.0.1000 -t bots -i ansible/inventory/prerelease\n+```\n+\n+#### Deploy NGINX and CertBot", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "651f04a9a496c701b317f7808a435a5534dcdf87"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzU0NQ==", "bodyText": "Headers should be surrounded by blank lines", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797545", "createdAt": "2020-02-01T19:30:01Z", "author": {"login": "codeclimate"}, "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,46 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n+  * -v: Verbose output\n+  * -vvv: Debug output\n+  * -vvvv: SSL Debug output\n+  * --diff: Shows differences in updated templates and files\n+  * -t : Tags\n \n-# To see verbose output\n-./run_deployment 2.0.1000 -v -i ansible/inventory/prerelease\n+### Examples with Tags\n \n-# To see 'diff' output, which shows how each file on server is being updated\n-#  (caution!! this can expose secret values to stdout)\n-./run_deployment 2.0.1000 -d -i ansible/inventory/prerelease\n \n-# To see SSL debug output:\n-./run_deployment 2.0.1000 -vvv -i ansible/inventory/prerelease\n+#### Deploy just bots\n \n-# To deploy to just bots, use tags, '-t' (see playbook for tag names)\n-./run_deployment 2.0.1000 -vvv -t bots -i ansible/inventory/prerelease\n+```bash\n+./run_deployment 2.0.1000 -t bots -i ansible/inventory/prerelease\n+```\n+\n+#### Deploy NGINX and CertBot\n+```bash\n+./run_deployment 2.0.1000 -t nginx,certbot -i ansible/inventory/prerelease\n ```\n \n+\n+## Example Prod Deployment", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "651f04a9a496c701b317f7808a435a5534dcdf87"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzU0Ng==", "bodyText": "Lists should be surrounded by blank lines", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797546", "createdAt": "2020-02-01T19:30:01Z", "author": {"login": "codeclimate"}, "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,46 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n+  * -v: Verbose output", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "651f04a9a496c701b317f7808a435a5534dcdf87"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzU0Nw==", "bodyText": "Lists should be surrounded by blank lines", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797547", "createdAt": "2020-02-01T19:30:02Z", "author": {"login": "codeclimate"}, "path": "infrastructure/README.md", "diffHunk": "@@ -165,47 +179,13 @@ ansible-vault encrypt --vault-password-file=vault_password ansible_ssh_key.ed255\n \n # Https Certificate Installation\n \n-Currently done manually.\n-\n-## certbot from letsencrypt\n+The 'certbot' role will:\n+  - run lets-encrypt and create a publicly signed SSL cert.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "651f04a9a496c701b317f7808a435a5534dcdf87"}, "originalPosition": 67}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxODkzODUy", "url": "https://github.com/triplea-game/triplea/pull/5894#pullrequestreview-351893852", "createdAt": "2020-02-01T17:08:27Z", "commit": {"oid": "6795b0daac398019e2e1705258b8c1e3b3f3adf5"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMVQxNzowODoyN1rOFkeWpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMVQxOToyNjoyNlrOFkeyAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5MDM3Mg==", "bodyText": "Technically that's not 100% required, but it definitely should be created", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373790372", "createdAt": "2020-02-01T17:08:27Z", "author": {"login": "RoiEXLab"}, "path": "infrastructure/README.md", "diffHunk": "@@ -165,47 +168,13 @@ ansible-vault encrypt --vault-password-file=vault_password ansible_ssh_key.ed255\n \n # Https Certificate Installation\n \n-Currently done manually.\n-\n-## certbot from letsencrypt\n-\n-```bash\n-sudo apt-get update\n-sudo apt-get install software-properties-common\n-sudo add-apt-repository universe\n-sudo add-apt-repository ppa:certbot/certbot\n-sudo apt-get update\n-sudo apt-get install certbot python-certbot-nginx \n-\n-sudo certbot --nginx -m tripleabuilderbot@gmail.com --agree-tos\n-```\n+The 'certbot' role will:\n+  - run lets-encrypt and create a publicly signed SSL cert.\n+  - sets up a weekly renewal cronjob that will renew the SSL cert if it\n+    is within 30 days of expiry\n \n-Create CAA DNS records\n+For each domain running SSH, a CAA DNS record needs to be created (one time):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6795b0daac398019e2e1705258b8c1e3b3f3adf5"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5MDUzMg==", "bodyText": "Please correct me if I'm missing something obvious here, but the certbot utility should create a cronjob automatically, so there's no need to define that ourselves", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373790532", "createdAt": "2020-02-01T17:11:02Z", "author": {"login": "RoiEXLab"}, "path": "infrastructure/ansible/roles/certbot/tasks/main.yml", "diffHunk": "@@ -0,0 +1,43 @@\n+- name: install software properties common\n+  become: true\n+  apt:\n+    state: present\n+    name: software-properties-common\n+  \n+- name: install certbot apt-repositories\n+  become: true\n+  apt_repository:\n+    state: present\n+    repo: \"{{ item }}\"\n+  loop:\n+    - \"deb http://archive.ubuntu.com/ubuntu/ bionic universe\"\n+    - \"deb http://archive.ubuntu.com/ubuntu/ bionic-updates universe\"\n+    - \"deb http://security.ubuntu.com/ubuntu/ bionic-security universe\"\n+    - \"ppa:certbot/certbot\"\n+\n+- name: install certbot and python for certbot on nginx\n+  become: true\n+  apt:\n+    update_cache: yes\n+    name:\n+      - certbot\n+      - python-certbot-nginx\n+\n+- name: look for certbot generated key file\n+  become: true\n+  stat:\n+    path: /etc/letsencrypt/live/prerelease.triplea-game.org/cert.pem\n+  register: has_certbot_pem\n+\n+- name: run certbot\n+  become: true\n+  command: \"certbot --nginx -n -m tripleabuilderbot@gmail.com --agree-tos -d {{ inventory_hostname }}\"\n+  when: has_certbot_pem.stat.exists == false\n+\n+- name: Add letsencrypt cronjob for cert renewal\n+  become: true\n+  cron:\n+    name: letsencrypt_renewal\n+    special_time: weekly\n+    job: certbot renew", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6795b0daac398019e2e1705258b8c1e3b3f3adf5"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NjE1NQ==", "bodyText": "Doesn't the statement above already ensure the service is restarted? So IIRC this also verifies that the service is started if it wasn't before.", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373796155", "createdAt": "2020-02-01T19:01:22Z", "author": {"login": "RoiEXLab"}, "path": "infrastructure/ansible/roles/nginx/tasks/main.yml", "diffHunk": "@@ -4,52 +4,108 @@\n     name: nginx\n     state: present\n \n+\n - name: generate dhparam.pem\n   become: true\n   shell:\n-    cmd: openssl dhparam -out {{ nginx_ssl_dhparams }} 4096\n-    creates: \"{{ nginx_ssl_dhparams }}\"\n+    cmd: openssl dhparam -out {{ dhparams_pem_file }} 4096\n+    creates: \"{{ dhparams_pem_file }}\"\n \n - name: set permissions of dhparam.pem\n   become: true\n   file:\n-    dest: \"{{ nginx_ssl_dhparams }}\"\n+    dest: \"{{ dhparams_pem_file }}\"\n     mode: 600\n \n-- name: check for nginx cert key\n+\n+- name: check for SSL cert key\n   stat:\n-    path: \"{{ nginx_ssl_certificate_key }}\"\n-  register: cert_key\n+    path: \"{{ ssl_cert_key }}\"\n+  register: has_cert_key\n   changed_when: false\n-\n-- name: check for nginx certificate\n+ \n+- name: check for SSL cert\n   stat:\n-    path: \"{{ nginx_ssl_certificate }}\"\n-  register: cert\n+    path: \"{{ ssl_cert }}\"\n+  register: has_cert\n   changed_when: false\n \n - name: create SSL keys if needed\n   become: true\n-  when: (cert_key.stat.exists == false) or (cert.stat.exists == false)\n-  command: openssl req -x509 -nodes -days 365 -newkey rsa:4096 -keyout {{ nginx_ssl_certificate_key }} -out {{ nginx_ssl_certificate }} -batch -subj '/CN=localhost' -sha256 -addext \"subjectAltName = IP:127.0.0.1, IP:::1\"\n+  when: (has_cert_key.stat.exists == false) or (has_cert.stat.exists == false)\n+  command: |\n+       openssl req -x509 -nodes -days 365 \\\n+          -newkey rsa:4096 -keyout {{ ssl_cert_key }} -out {{ ssl_cert }} \\\n+          -batch -subj '/CN=localhost' -sha256 -addext \"subjectAltName = IP:127.0.0.1, IP:::1\"\n+\n+\n+- name: check for letsencrypt cert key\n+  stat:\n+    path: \"{{ lets_encrypt_cert_key }}\"\n+  register: has_lets_encrypt_cert_key\n+  changed_when: false\n+\n+- name: set cert-key variable to generated cert if letsencrypt cert key DNE\n+  when: has_lets_encrypt_cert_key.stat.exists == false\n+  set_fact:\n+    cert_key: \"{{ ssl_cert_key }};\"\n+  changed_when: false\n+\n+- name: set cert-key variable to lets_encrypt cert-key if exists\n+  when: has_lets_encrypt_cert_key.stat.exists\n+  set_fact:\n+    cert_key: \"{{ lets_encrypt_cert_key }}; # managed by Certbot;\"\n+  changed_when: false\n+\n+\n+- name: check for lets_encrypt cert\n+  stat:\n+    path: \"{{ lets_encrypt_cert }}\"\n+  register: has_lets_encrypt_cert\n+  changed_when: false\n+  \n+- name: set cert variable to generated cert if lets_encrypt cert DNE\n+  when: has_lets_encrypt_cert.stat.exists == false\n+  set_fact:\n+    cert: \"{{ ssl_cert }};\"\n+  changed_when: false\n+\n+- name: set cert variable to lets_encrypt cert if exists\n+  when: has_lets_encrypt_cert.stat.exists\n+  set_fact:\n+    cert: \"{{ lets_encrypt_cert }}; # managed by Certbot;\"\n+  changed_when: false\n+\n \n - name: deploy nginx sites_enabled configuation\n   become: true\n   template:\n     src: etc_nginx_sites_enabled_default.j2\n     dest: /etc/nginx/sites-enabled/default\n+  register: nginx_config_changed\n \n - name: allow ports\n   become: true\n+  tags: firewall\n   ufw:\n     rule: allow\n     port: \"{{ item }}\"\n     proto: tcp\n   with_items: \"{{ nginx_allowed_ports }}\"\n \n-- name: relaunch nginx\n+- name: restart nginx if config changed\n+  when: |\n+    (nginx_config_changed.changed) \n+      or (has_cert_key.stat.exists == false) \n+      or (has_cert.stat.exists == false)\n   become: true\n   systemd:\n     name: nginx\n     state: restarted\n \n+- name: ensure nginx is started\n+  become: true\n+  systemd:\n+    name: nginx\n+    state: started", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6795b0daac398019e2e1705258b8c1e3b3f3adf5"}, "originalPosition": 120}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NjI0Mw==", "bodyText": "I assume this path shouldn't be hardcoded?", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373796243", "createdAt": "2020-02-01T19:03:13Z", "author": {"login": "RoiEXLab"}, "path": "infrastructure/ansible/roles/certbot/tasks/main.yml", "diffHunk": "@@ -0,0 +1,43 @@\n+- name: install software properties common\n+  become: true\n+  apt:\n+    state: present\n+    name: software-properties-common\n+  \n+- name: install certbot apt-repositories\n+  become: true\n+  apt_repository:\n+    state: present\n+    repo: \"{{ item }}\"\n+  loop:\n+    - \"deb http://archive.ubuntu.com/ubuntu/ bionic universe\"\n+    - \"deb http://archive.ubuntu.com/ubuntu/ bionic-updates universe\"\n+    - \"deb http://security.ubuntu.com/ubuntu/ bionic-security universe\"\n+    - \"ppa:certbot/certbot\"\n+\n+- name: install certbot and python for certbot on nginx\n+  become: true\n+  apt:\n+    update_cache: yes\n+    name:\n+      - certbot\n+      - python-certbot-nginx\n+\n+- name: look for certbot generated key file\n+  become: true\n+  stat:\n+    path: /etc/letsencrypt/live/prerelease.triplea-game.org/cert.pem", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6795b0daac398019e2e1705258b8c1e3b3f3adf5"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NjUwNA==", "bodyText": "We don't have any mail forwarding for this email don't we?\nI just got (2 days ago) an email from the certbot utility telling me that it failed to renew the MARTI HTTP certificates.\nTurns out that there was (and still is, but I found a workaround) a DNSSEC issue with namecheap that fails for a nonexistent subdomain, which ultimately caused the check to fail.\nWithout this email we wouldn't have noticed until it's too late, so I'm convinced there's definitely some value in using an actual email here.", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373796504", "createdAt": "2020-02-01T19:08:59Z", "author": {"login": "RoiEXLab"}, "path": "infrastructure/ansible/roles/certbot/tasks/main.yml", "diffHunk": "@@ -0,0 +1,43 @@\n+- name: install software properties common\n+  become: true\n+  apt:\n+    state: present\n+    name: software-properties-common\n+  \n+- name: install certbot apt-repositories\n+  become: true\n+  apt_repository:\n+    state: present\n+    repo: \"{{ item }}\"\n+  loop:\n+    - \"deb http://archive.ubuntu.com/ubuntu/ bionic universe\"\n+    - \"deb http://archive.ubuntu.com/ubuntu/ bionic-updates universe\"\n+    - \"deb http://security.ubuntu.com/ubuntu/ bionic-security universe\"\n+    - \"ppa:certbot/certbot\"\n+\n+- name: install certbot and python for certbot on nginx\n+  become: true\n+  apt:\n+    update_cache: yes\n+    name:\n+      - certbot\n+      - python-certbot-nginx\n+\n+- name: look for certbot generated key file\n+  become: true\n+  stat:\n+    path: /etc/letsencrypt/live/prerelease.triplea-game.org/cert.pem\n+  register: has_certbot_pem\n+\n+- name: run certbot\n+  become: true\n+  command: \"certbot --nginx -n -m tripleabuilderbot@gmail.com --agree-tos -d {{ inventory_hostname }}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6795b0daac398019e2e1705258b8c1e3b3f3adf5"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzM3Nw==", "bodyText": "How often is this file run?\nCould it happen that the certificate runs out in-between runs?\nFor Marti and the forum I solved this problem by adding a post-hook that runs sudo systemctl reload nginx to ensure that nginx picks up the certificate correctly after refreshing it. It could be the case that certbot does this automatically using the nginx plugin (which is used), but when I initially configured everything there such a plugin didn't exist yer.", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797377", "createdAt": "2020-02-01T19:26:26Z", "author": {"login": "RoiEXLab"}, "path": "infrastructure/ansible/roles/nginx/tasks/main.yml", "diffHunk": "@@ -4,52 +4,108 @@\n     name: nginx\n     state: present\n \n+\n - name: generate dhparam.pem\n   become: true\n   shell:\n-    cmd: openssl dhparam -out {{ nginx_ssl_dhparams }} 4096\n-    creates: \"{{ nginx_ssl_dhparams }}\"\n+    cmd: openssl dhparam -out {{ dhparams_pem_file }} 4096\n+    creates: \"{{ dhparams_pem_file }}\"\n \n - name: set permissions of dhparam.pem\n   become: true\n   file:\n-    dest: \"{{ nginx_ssl_dhparams }}\"\n+    dest: \"{{ dhparams_pem_file }}\"\n     mode: 600\n \n-- name: check for nginx cert key\n+\n+- name: check for SSL cert key\n   stat:\n-    path: \"{{ nginx_ssl_certificate_key }}\"\n-  register: cert_key\n+    path: \"{{ ssl_cert_key }}\"\n+  register: has_cert_key\n   changed_when: false\n-\n-- name: check for nginx certificate\n+ \n+- name: check for SSL cert\n   stat:\n-    path: \"{{ nginx_ssl_certificate }}\"\n-  register: cert\n+    path: \"{{ ssl_cert }}\"\n+  register: has_cert\n   changed_when: false\n \n - name: create SSL keys if needed\n   become: true\n-  when: (cert_key.stat.exists == false) or (cert.stat.exists == false)\n-  command: openssl req -x509 -nodes -days 365 -newkey rsa:4096 -keyout {{ nginx_ssl_certificate_key }} -out {{ nginx_ssl_certificate }} -batch -subj '/CN=localhost' -sha256 -addext \"subjectAltName = IP:127.0.0.1, IP:::1\"\n+  when: (has_cert_key.stat.exists == false) or (has_cert.stat.exists == false)\n+  command: |\n+       openssl req -x509 -nodes -days 365 \\\n+          -newkey rsa:4096 -keyout {{ ssl_cert_key }} -out {{ ssl_cert }} \\\n+          -batch -subj '/CN=localhost' -sha256 -addext \"subjectAltName = IP:127.0.0.1, IP:::1\"\n+\n+\n+- name: check for letsencrypt cert key\n+  stat:\n+    path: \"{{ lets_encrypt_cert_key }}\"\n+  register: has_lets_encrypt_cert_key\n+  changed_when: false\n+\n+- name: set cert-key variable to generated cert if letsencrypt cert key DNE\n+  when: has_lets_encrypt_cert_key.stat.exists == false\n+  set_fact:\n+    cert_key: \"{{ ssl_cert_key }};\"\n+  changed_when: false\n+\n+- name: set cert-key variable to lets_encrypt cert-key if exists\n+  when: has_lets_encrypt_cert_key.stat.exists\n+  set_fact:\n+    cert_key: \"{{ lets_encrypt_cert_key }}; # managed by Certbot;\"\n+  changed_when: false\n+\n+\n+- name: check for lets_encrypt cert\n+  stat:\n+    path: \"{{ lets_encrypt_cert }}\"\n+  register: has_lets_encrypt_cert\n+  changed_when: false\n+  \n+- name: set cert variable to generated cert if lets_encrypt cert DNE\n+  when: has_lets_encrypt_cert.stat.exists == false\n+  set_fact:\n+    cert: \"{{ ssl_cert }};\"\n+  changed_when: false\n+\n+- name: set cert variable to lets_encrypt cert if exists\n+  when: has_lets_encrypt_cert.stat.exists\n+  set_fact:\n+    cert: \"{{ lets_encrypt_cert }}; # managed by Certbot;\"\n+  changed_when: false\n+\n \n - name: deploy nginx sites_enabled configuation\n   become: true\n   template:\n     src: etc_nginx_sites_enabled_default.j2\n     dest: /etc/nginx/sites-enabled/default\n+  register: nginx_config_changed\n \n - name: allow ports\n   become: true\n+  tags: firewall\n   ufw:\n     rule: allow\n     port: \"{{ item }}\"\n     proto: tcp\n   with_items: \"{{ nginx_allowed_ports }}\"\n \n-- name: relaunch nginx\n+- name: restart nginx if config changed\n+  when: |\n+    (nginx_config_changed.changed) \n+      or (has_cert_key.stat.exists == false) \n+      or (has_cert.stat.exists == false)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6795b0daac398019e2e1705258b8c1e3b3f3adf5"}, "originalPosition": 110}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01ebf211ba0d1a9a70f83bbb1b5884443f2295e1", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/01ebf211ba0d1a9a70f83bbb1b5884443f2295e1", "committedDate": "2020-02-01T19:32:52Z", "message": "More formatting updates"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxOTAwNTgz", "url": "https://github.com/triplea-game/triplea/pull/5894#pullrequestreview-351900583", "createdAt": "2020-02-01T19:36:23Z", "commit": {"oid": "01ebf211ba0d1a9a70f83bbb1b5884443f2295e1"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMVQxOTozNjoyM1rOFkezwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMVQxOTozNjoyNFrOFkezxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzgyNA==", "bodyText": "Inconsistent indentation for list items at the same level", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797824", "createdAt": "2020-02-01T19:36:23Z", "author": {"login": "codeclimate"}, "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,47 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n \n-# To see verbose output\n-./run_deployment 2.0.1000 -v -i ansible/inventory/prerelease\n+  * `-v`: Verbose output", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01ebf211ba0d1a9a70f83bbb1b5884443f2295e1"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzgyNQ==", "bodyText": "Inconsistent indentation for list items at the same level", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797825", "createdAt": "2020-02-01T19:36:23Z", "author": {"login": "codeclimate"}, "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,47 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n \n-# To see verbose output\n-./run_deployment 2.0.1000 -v -i ansible/inventory/prerelease\n+  * `-v`: Verbose output\n+  * `-vvv`: Debug output", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01ebf211ba0d1a9a70f83bbb1b5884443f2295e1"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzgyNg==", "bodyText": "Inconsistent indentation for list items at the same level", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797826", "createdAt": "2020-02-01T19:36:23Z", "author": {"login": "codeclimate"}, "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,47 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n \n-# To see verbose output\n-./run_deployment 2.0.1000 -v -i ansible/inventory/prerelease\n+  * `-v`: Verbose output\n+  * `-vvv`: Debug output\n+  * `-vvvv`: SSL Debug output", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01ebf211ba0d1a9a70f83bbb1b5884443f2295e1"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzgyNw==", "bodyText": "Inconsistent indentation for list items at the same level", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797827", "createdAt": "2020-02-01T19:36:23Z", "author": {"login": "codeclimate"}, "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,47 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n \n-# To see verbose output\n-./run_deployment 2.0.1000 -v -i ansible/inventory/prerelease\n+  * `-v`: Verbose output\n+  * `-vvv`: Debug output\n+  * `-vvvv`: SSL Debug output\n+  * `--diff`: Shows differences in updated templates and files", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01ebf211ba0d1a9a70f83bbb1b5884443f2295e1"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzgyOA==", "bodyText": "Inconsistent indentation for list items at the same level", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797828", "createdAt": "2020-02-01T19:36:23Z", "author": {"login": "codeclimate"}, "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,47 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n \n-# To see verbose output\n-./run_deployment 2.0.1000 -v -i ansible/inventory/prerelease\n+  * `-v`: Verbose output\n+  * `-vvv`: Debug output\n+  * `-vvvv`: SSL Debug output\n+  * `--diff`: Shows differences in updated templates and files\n+  * `-t`: Tags", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01ebf211ba0d1a9a70f83bbb1b5884443f2295e1"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzgyOQ==", "bodyText": "Consider starting bulleted lists at the beginning of the line", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797829", "createdAt": "2020-02-01T19:36:24Z", "author": {"login": "codeclimate"}, "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,47 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n \n-# To see verbose output\n-./run_deployment 2.0.1000 -v -i ansible/inventory/prerelease\n+  * `-v`: Verbose output", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01ebf211ba0d1a9a70f83bbb1b5884443f2295e1"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "625a5ac48eab21763c02d74dd3f25fa175575856", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/625a5ac48eab21763c02d74dd3f25fa175575856", "committedDate": "2020-02-01T20:06:58Z", "message": "More MD formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13758f225e41b933c108218b403eb7f3e420b13c", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/13758f225e41b933c108218b403eb7f3e420b13c", "committedDate": "2020-02-01T20:08:25Z", "message": "Yet more MD formatting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxOTAyMDkz", "url": "https://github.com/triplea-game/triplea/pull/5894#pullrequestreview-351902093", "createdAt": "2020-02-01T20:09:49Z", "commit": {"oid": "13758f225e41b933c108218b403eb7f3e420b13c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMVQyMDowOTo0OVrOFke6cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMVQyMDowOTo1MFrOFke6dA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5OTUzOQ==", "bodyText": "Unordered list style", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373799539", "createdAt": "2020-02-01T20:09:49Z", "author": {"login": "codeclimate"}, "path": "infrastructure/README.md", "diffHunk": "@@ -165,47 +181,14 @@ ansible-vault encrypt --vault-password-file=vault_password ansible_ssh_key.ed255\n \n # Https Certificate Installation\n \n-Currently done manually.\n+The 'certbot' role will:\n \n-## certbot from letsencrypt\n+- run lets-encrypt and create a publicly signed SSL cert.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13758f225e41b933c108218b403eb7f3e420b13c"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5OTU0MA==", "bodyText": "Unordered list style", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373799540", "createdAt": "2020-02-01T20:09:50Z", "author": {"login": "codeclimate"}, "path": "infrastructure/README.md", "diffHunk": "@@ -165,47 +181,14 @@ ansible-vault encrypt --vault-password-file=vault_password ansible_ssh_key.ed255\n \n # Https Certificate Installation\n \n-Currently done manually.\n+The 'certbot' role will:\n \n-## certbot from letsencrypt\n+- run lets-encrypt and create a publicly signed SSL cert.\n+- sets up a weekly renewal cronjob that will renew the SSL cert if it", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13758f225e41b933c108218b403eb7f3e420b13c"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "828cce12439e6814b28fd6f7d24e474101345e72", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/828cce12439e6814b28fd6f7d24e474101345e72", "committedDate": "2020-02-01T20:12:07Z", "message": "Fix inventory-hostname hardcoding"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69a240eedeb17feccf82b66dc4e633c7eba7de71", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/69a240eedeb17feccf82b66dc4e633c7eba7de71", "committedDate": "2020-02-01T20:21:14Z", "message": "Add --rsa-key-size 4096 to certbot command and update command formatting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxOTAyODMy", "url": "https://github.com/triplea-game/triplea/pull/5894#pullrequestreview-351902832", "createdAt": "2020-02-01T20:24:02Z", "commit": {"oid": "69a240eedeb17feccf82b66dc4e633c7eba7de71"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMVQyMDoyNDowM1rOFke9ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMVQyMDoyNDowM1rOFke9uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgwMDM3OA==", "bodyText": "Unordered list style", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373800378", "createdAt": "2020-02-01T20:24:03Z", "author": {"login": "codeclimate"}, "path": "infrastructure/README.md", "diffHunk": "@@ -165,47 +181,14 @@ ansible-vault encrypt --vault-password-file=vault_password ansible_ssh_key.ed255\n \n # Https Certificate Installation\n \n-Currently done manually.\n+The 'certbot' role will:\n \n-## certbot from letsencrypt\n+- run lets-encrypt and create a publicly signed SSL cert.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69a240eedeb17feccf82b66dc4e633c7eba7de71"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgwMDM3OQ==", "bodyText": "Unordered list style", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373800379", "createdAt": "2020-02-01T20:24:03Z", "author": {"login": "codeclimate"}, "path": "infrastructure/README.md", "diffHunk": "@@ -165,47 +181,14 @@ ansible-vault encrypt --vault-password-file=vault_password ansible_ssh_key.ed255\n \n # Https Certificate Installation\n \n-Currently done manually.\n+The 'certbot' role will:\n \n-## certbot from letsencrypt\n+- run lets-encrypt and create a publicly signed SSL cert.\n+- sets up a weekly renewal cronjob that will renew the SSL cert if it", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69a240eedeb17feccf82b66dc4e633c7eba7de71"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05ff791652f048ee23926be5b2d9398a6b560ff7", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/05ff791652f048ee23926be5b2d9398a6b560ff7", "committedDate": "2020-02-01T20:32:33Z", "message": "More README formatting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxOTAzMzQy", "url": "https://github.com/triplea-game/triplea/pull/5894#pullrequestreview-351903342", "createdAt": "2020-02-01T20:34:41Z", "commit": {"oid": "05ff791652f048ee23926be5b2d9398a6b560ff7"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMVQyMDozNDo0MVrOFke_8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMVQyMDozNDo0MVrOFke_8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgwMDk0NA==", "bodyText": "Line length", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373800944", "createdAt": "2020-02-01T20:34:41Z", "author": {"login": "codeclimate"}, "path": "infrastructure/README.md", "diffHunk": "@@ -150,10 +166,11 @@ by ansible when ansible is run. To encrypt a variable:\n [Ansible-Vault Docs](https://docs.ansible.com/ansible/latest/user_guide/vault.html)\n \n Warnings:\n- - use files to store passwords/secrets so that the password is not in your shell history\n- - take care to not commit into git any passwords or secrets, files containing secrets should\n+\n+* use files to store passwords/secrets so that the password is not in your shell history", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05ff791652f048ee23926be5b2d9398a6b560ff7"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgwMDk0NQ==", "bodyText": "Line length", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373800945", "createdAt": "2020-02-01T20:34:41Z", "author": {"login": "codeclimate"}, "path": "infrastructure/README.md", "diffHunk": "@@ -150,10 +166,11 @@ by ansible when ansible is run. To encrypt a variable:\n [Ansible-Vault Docs](https://docs.ansible.com/ansible/latest/user_guide/vault.html)\n \n Warnings:\n- - use files to store passwords/secrets so that the password is not in your shell history\n- - take care to not commit into git any passwords or secrets, files containing secrets should\n+\n+* use files to store passwords/secrets so that the password is not in your shell history\n+* take care to not commit into git any passwords or secrets, files containing secrets should", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05ff791652f048ee23926be5b2d9398a6b560ff7"}, "originalPosition": 69}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85f89bc74ac5e9183ad1399c9ddbb8e5f6c54217", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/85f89bc74ac5e9183ad1399c9ddbb8e5f6c54217", "committedDate": "2020-02-01T20:36:42Z", "message": "Formatting, fix long lines"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxOTA0MzMx", "url": "https://github.com/triplea-game/triplea/pull/5894#pullrequestreview-351904331", "createdAt": "2020-02-01T20:59:58Z", "commit": {"oid": "85f89bc74ac5e9183ad1399c9ddbb8e5f6c54217"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fbc544c5b10028ff5917b25ad2643d9afeec13c", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/2fbc544c5b10028ff5917b25ad2643d9afeec13c", "committedDate": "2020-02-01T21:28:35Z", "message": "Comment out cronjob renewal (for now) pending verification if it is already automatic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "541befa26ccb416faa33cb185b71d01123828996", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/541befa26ccb416faa33cb185b71d01123828996", "committedDate": "2020-02-01T22:03:02Z", "message": "Switch prerelease URL to prerelease2 and simplify inventory file for prerelease"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7946c91fc50feb07d46a65bddda3621e437c8cfc", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/7946c91fc50feb07d46a65bddda3621e437c8cfc", "committedDate": "2020-02-01T22:03:34Z", "message": "Update (temporarily until cert rate limit expires ina week) prerelease server URI to prerelease2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0af29364ee0fe591e272a8ae3b3cec3d105a86cb", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/0af29364ee0fe591e272a8ae3b3cec3d105a86cb", "committedDate": "2020-02-01T22:57:14Z", "message": "Remove certbot cronjob renewal, it is automatically added in /etc/cron.d/certbot for us"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3778, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}