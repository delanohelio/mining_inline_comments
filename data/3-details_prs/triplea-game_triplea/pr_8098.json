{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1Nzk2NDM2", "number": 8098, "title": "Pass in a TotalPowerAndTotalRolls instance to UnitBattleComparator", "bodyText": "This removes the duplicate power calculation from UnitBattleComparator.\nEven though the comment says that it should have the same calculation as what is in TotalPowerAndTotalRolls, it is slightly different.  The two differences that I've found is that the marine bonus is given to defenders and that if the territory effect is a negative, then the power can be in the negative.\nSo this change will affect the OOL but it should make it more accurate.  I had to fix one test because of the marine bonus issue.  It ranked marines better than artillery because the marine was incorrectly being given the marine bonus during its defense.\n\nTesting\n\nI added some code to compare the result of the new power calculator against the old power calculator and ran both World at War and Total World War.  The only differences that I saw were because of the two items that I mentioned above.\nScreens Shots\n\nAdditional Notes to Reviewer\n\nRelease Note", "createdAt": "2020-11-05T05:03:20Z", "url": "https://github.com/triplea-game/triplea/pull/8098", "merged": true, "mergeCommit": {"oid": "fa57befb5f0dd903e5c925737f9bee0dd859f46e"}, "closed": true, "closedAt": "2020-11-07T23:05:48Z", "author": {"login": "trevan"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZbFJYAH2gAyNTE1Nzk2NDM2OmYxYTNhMDJlMzMyN2IzODBkM2M5ZTllZDEyNzgxODQxZmQ0NjQ4MTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdaTBRTgH2gAyNTE1Nzk2NDM2OjJlNTYyMzkwZWUzNzFmMGNmODIwMzdlODllM2RiY2YzMDhjZmNlMzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f1a3a02e3327b380d3c9e9ed12781841fd464816", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/f1a3a02e3327b380d3c9e9ed12781841fd464816", "committedDate": "2020-11-05T04:58:24Z", "message": "Pass in a TotalPowerAndTotalRolls instance to UnitBattleComparator\n\nThis removes the duplicate power calculation from UnitBattleComparator."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzOTI3NzU4", "url": "https://github.com/triplea-game/triplea/pull/8098#pullrequestreview-523927758", "createdAt": "2020-11-05T05:04:32Z", "commit": {"oid": "f1a3a02e3327b380d3c9e9ed12781841fd464816"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwNTowNDozMlrOHtzqow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwNTowODo1OVrOHtzvEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc5NDQ2Nw==", "bodyText": "The names for these two methods (buildWithNoUnitSupports and buildOppositeCombatValue) could probably be better.  And maybe there's a way to not need them but I couldn't figure one out.", "url": "https://github.com/triplea-game/triplea/pull/8098#discussion_r517794467", "createdAt": "2020-11-05T05:04:32Z", "author": {"login": "trevan"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/power/calculator/CombatValue.java", "diffHunk": "@@ -17,19 +18,21 @@\n \n   boolean isDefending();\n \n-  Collection<TerritoryEffect> getTerritoryEffects();\n-\n   GameData getGameData();\n \n   Collection<Unit> getFriendUnits();\n \n   Collection<Unit> getEnemyUnits();\n \n+  CombatValue buildWithNoUnitSupports();\n+\n+  CombatValue buildOppositeCombatValue();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1a3a02e3327b380d3c9e9ed12781841fd464816"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc5NTEyOA==", "bodyText": "I added this because the buildMainCombatValue requires a territory and some places this is called doesn't have a territory.  And I didn't want to pass in null to buildMainCombatValue for territory.  With the bombard combat value change (#8097) removes the territory parameter so I could wait for that to merge and then redo this piece.", "url": "https://github.com/triplea-game/triplea/pull/8098#discussion_r517795128", "createdAt": "2020-11-05T05:07:07Z", "author": {"login": "trevan"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/power/calculator/CombatValue.java", "diffHunk": "@@ -91,24 +94,49 @@ static CombatValue buildAaCombatValue(\n         AvailableSupports.getSortedSupport(\n             new SupportCalculator(\n                 allEnemyUnitsAliveOrWaitingToDie, //\n-                data.getUnitTypeList().getSupportAaRules(),\n+                gameData.getUnitTypeList().getSupportAaRules(),\n                 !defending,\n                 false));\n \n     return defending\n         ? AaDefenseCombatValue.builder()\n-            .gameData(data)\n+            .gameData(gameData)\n             .supportFromFriends(supportFromFriends)\n             .supportFromEnemies(supportFromEnemies)\n             .friendUnits(allFriendlyUnitsAliveOrWaitingToDie)\n             .enemyUnits(allEnemyUnitsAliveOrWaitingToDie)\n             .build()\n         : AaOffenseCombatValue.builder()\n-            .gameData(data)\n+            .gameData(gameData)\n             .supportFromFriends(supportFromFriends)\n             .supportFromEnemies(supportFromEnemies)\n             .friendUnits(allFriendlyUnitsAliveOrWaitingToDie)\n             .enemyUnits(allEnemyUnitsAliveOrWaitingToDie)\n             .build();\n   }\n+\n+  static CombatValue buildNoSupportCombatValue(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1a3a02e3327b380d3c9e9ed12781841fd464816"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc5NTYwMQ==", "bodyText": "Since the unit is ordered differently, this new PowerStrengthAndRolls will not be as optimized.  But the only use of buildOpposite is when the combat value has no unit support so it won't actually be affected.  Should I add a comment about that?  Or maybe change this method to always create a non-supported combat value?", "url": "https://github.com/triplea-game/triplea/pull/8098#discussion_r517795601", "createdAt": "2020-11-05T05:08:59Z", "author": {"login": "trevan"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/power/calculator/PowerStrengthAndRolls.java", "diffHunk": "@@ -124,4 +124,15 @@ public int getStrength(final Unit unit) {\n   public int getRolls(final Unit unit) {\n     return totalStrengthAndTotalRollsByUnit.get(unit).getRolls();\n   }\n+\n+  @Override\n+  public int calculatePower(final Unit unit) {\n+    return totalStrengthAndTotalRollsByUnit.get(unit).calculatePower();\n+  }\n+\n+  @Override\n+  public TotalPowerAndTotalRolls buildOpposite() {\n+    return PowerStrengthAndRolls.build(\n+        totalStrengthAndTotalRollsByUnit.keySet(), calculator.buildOppositeCombatValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1a3a02e3327b380d3c9e9ed12781841fd464816"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca4cf88266b119271e54baa93d58987ae760ee42", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/ca4cf88266b119271e54baa93d58987ae760ee42", "committedDate": "2020-11-05T17:50:55Z", "message": "Create a power calculator and use that instead of UnitPowerStrengthAndRolls"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abc0279d9132bcc961f7c39bb6b56fac12a7276a", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/abc0279d9132bcc961f7c39bb6b56fac12a7276a", "committedDate": "2020-11-05T21:39:00Z", "message": "Don't change an input parameter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "234956204d81305c7a1e4b666808458c311e3ab4", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/234956204d81305c7a1e4b666808458c311e3ab4", "committedDate": "2020-11-05T22:29:34Z", "message": "Remove another unused variable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1Njc5OTQ1", "url": "https://github.com/triplea-game/triplea/pull/8098#pullrequestreview-525679945", "createdAt": "2020-11-07T20:35:32Z", "commit": {"oid": "234956204d81305c7a1e4b666808458c311e3ab4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QyMDozNTozMlrOHvKa0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QyMDozNTozMlrOHvKa0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIxNTgyNw==", "bodyText": "Any objection to java-doc'ing this class to give an overview of what it does?", "url": "https://github.com/triplea-game/triplea/pull/8098#discussion_r519215827", "createdAt": "2020-11-07T20:35:32Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/delegate/power/calculator/PowerCalculator.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package games.strategy.triplea.delegate.power.calculator;\n+\n+import games.strategy.engine.data.GameData;\n+import games.strategy.engine.data.Unit;\n+import java.util.function.Function;\n+import lombok.AccessLevel;\n+import lombok.AllArgsConstructor;\n+import lombok.Getter;\n+import lombok.Value;\n+\n+@Value\n+@Getter(AccessLevel.NONE)\n+@AllArgsConstructor\n+public class PowerCalculator {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "234956204d81305c7a1e4b666808458c311e3ab4"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1NjgwNDU4", "url": "https://github.com/triplea-game/triplea/pull/8098#pullrequestreview-525680458", "createdAt": "2020-11-07T20:43:59Z", "commit": {"oid": "234956204d81305c7a1e4b666808458c311e3ab4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QyMDo0Mzo1OVrOHvKd_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QyMDo0Mzo1OVrOHvKd_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIxNjYzOA==", "bodyText": "Drilling into this method, I see: .defending(false) , which implies this is offense. @trevan can you comment? Am I missing something?", "url": "https://github.com/triplea-game/triplea/pull/8098#discussion_r519216638", "createdAt": "2020-11-07T20:43:59Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/test/java/games/strategy/triplea/delegate/battle/casualty/CasualtyOrderOfLossesTestOnGlobal.java", "diffHunk": "@@ -367,9 +360,9 @@ void improvedArtillery() {\n         CasualtyOrderOfLosses.sortUnitsForCasualtiesWithSupport(amphibAssault(attackingUnits));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "234956204d81305c7a1e4b666808458c311e3ab4"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1af46171f442a5beffc1060ccfaffbe7fe3541b1", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/1af46171f442a5beffc1060ccfaffbe7fe3541b1", "committedDate": "2020-11-07T21:26:57Z", "message": "Merge branch 'master' into remove-getUnitPowerForSorting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e562390ee371f0cf82037e89e3dbcf308cfce30", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/2e562390ee371f0cf82037e89e3dbcf308cfce30", "committedDate": "2020-11-07T22:08:51Z", "message": "Add java-doc, fix merge issues, replace buildNoSupportCombatValue"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3844, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}