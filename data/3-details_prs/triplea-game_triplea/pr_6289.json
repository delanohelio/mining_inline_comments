{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1NTAwMDI2", "number": 6289, "title": "Speed up code in UnitsHitChange.", "bodyText": "Previously, this code would need to look at all units in all territories to figure out which territories were affected, so that they can be notified. This was quite slow, taking 254 sec of CPU time over one round of all-AI Domination 1914 (across all threads - this was mostly affected battle simulation which was split across 8 threads on my machine).\nThis change explicitly passes the list of affected territories to the change object, eliminating that extra work. On the same Domination 1914 all-AI round, UnitsHitsChange.perform() now only takes 200 ms (instead of 254 sec).\n\nFunctional Changes\n\n[] New map or map update\n[] New Feature\n[] Feature update or enhancement\n[] Feature Removal\n[] Code Cleanup or refactor\n[] Configuration Change\n[] Problem fix:  \n[X] Other:   Optimization\nTesting\nPlayed one round of all-AI Domination 1914.", "createdAt": "2020-04-18T13:32:23Z", "url": "https://github.com/triplea-game/triplea/pull/6289", "merged": true, "mergeCommit": {"oid": "b8337b21ca8b3a3b3a2d423cac6e88474c0e2da3"}, "closed": true, "closedAt": "2020-04-18T20:27:53Z", "author": {"login": "asvitkine"}, "timelineItems": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcY13itAH2gAyNDA1NTAwMDI2OjBkYzMxYTFmMWNiYTJhY2NkMjY5NTEwZDc5OTg3YjNhN2NhYmY3MjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcY6ZAGAFqTM5NTkzOTYyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0dc31a1f1cba2accd269510d79987b3a7cabf722", "author": {"user": {"login": "asvitkine", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/0dc31a1f1cba2accd269510d79987b3a7cabf722", "committedDate": "2020-04-18T13:25:54Z", "message": "Speed up codein UnitsHitChange.\n\nPreviously, this code would need to look at all units in all\nterritories to figure out which territories were affected, so\nthat they can be notified. This was quite slow, taking 254 sec\nover one round of all-AI Domination 1914.\n\nThis change explicitly passes the list of affected territories\nto the change object, eliminating that extra work. On the same\nDomination 1914 all-AI round, UnitsHitsChange.perform() now only\ntakes 200 ms (instead of 254 sec)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1OTM5NjI4", "url": "https://github.com/triplea-game/triplea/pull/6289#pullrequestreview-395939628", "createdAt": "2020-04-18T18:36:22Z", "commit": {"oid": "0dc31a1f1cba2accd269510d79987b3a7cabf722"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxODozNjoyMlrOGHtN1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxODozNjoyMlrOGHtN1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczNDAzOA==", "bodyText": "Is this disjoint check just not needed in the end?", "url": "https://github.com/triplea-game/triplea/pull/6289#discussion_r410734038", "createdAt": "2020-04-18T18:36:22Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/engine/data/UnitHitsChange.java", "diffHunk": "@@ -10,35 +9,42 @@\n \n   private final IntegerMap<Unit> hits;\n   private final IntegerMap<Unit> undoHits;\n+  private final Collection<Territory> territoriesToNotify;\n \n-  private UnitHitsChange(final IntegerMap<Unit> hits, final IntegerMap<Unit> undoHits) {\n+  private UnitHitsChange(\n+      final IntegerMap<Unit> hits,\n+      final IntegerMap<Unit> undoHits,\n+      final Collection<Territory> territoriesToNotify) {\n     this.hits = hits;\n     this.undoHits = undoHits;\n+    this.territoriesToNotify = territoriesToNotify;\n   }\n \n-  public UnitHitsChange(final IntegerMap<Unit> hits) {\n-    this.hits = new IntegerMap<>(hits);\n-    undoHits = new IntegerMap<>();\n-    for (final Unit item : this.hits.keySet()) {\n+  public UnitHitsChange(\n+      final IntegerMap<Unit> hits, final Collection<Territory> territoriesToNotify) {\n+    this(new IntegerMap<>(hits), undoHits(hits), territoriesToNotify);\n+  }\n+\n+  private static IntegerMap<Unit> undoHits(final IntegerMap<Unit> hits) {\n+    final var undoHits = new IntegerMap<Unit>();\n+    for (final Unit item : hits.keySet()) {\n       undoHits.put(item, item.getHits());\n     }\n+    return undoHits;\n   }\n \n   @Override\n   protected void perform(final GameData data) {\n     for (final Unit item : hits.keySet()) {\n       item.setHits(hits.getInt(item));\n     }\n-    final Set<Unit> units = hits.keySet();\n-    for (final Territory element : data.getMap().getTerritories()) {\n-      if (!Collections.disjoint(element.getUnits(), units)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0dc31a1f1cba2accd269510d79987b3a7cabf722"}, "originalPosition": 49}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3505, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}