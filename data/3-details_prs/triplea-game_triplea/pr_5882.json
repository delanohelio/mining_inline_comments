{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3MTgxNzg5", "number": 5882, "title": "Make MapData control lifecycle of resource loader and remove close method", "bodyText": "Updates MapData to always instantiate a resource loader itself and to close\nit when construction is done. This ensures that the resource loader is closed\nand removes the burden of other classes from having to remember to call\nclose on map data.\n \nFunctional Changes\n\n[] New map or map update\n[] New Feature\n[] Feature update or enhancement\n[] Feature Removal\n[x] Code Cleanup or refactor\n[] Configuration Change\n[] Problem fix:  \n[] Other:   \nTesting\n\n[] Manual testing done\n\n\n\n\nAdditional Review Notes\nUse this link to hide whitespace changes: https://github.com/triplea-game/triplea/pull/5882/files?utf8=%E2%9C%93&diff=unified&w=1", "createdAt": "2020-01-26T04:48:06Z", "url": "https://github.com/triplea-game/triplea/pull/5882", "merged": true, "mergeCommit": {"oid": "1cbcd08101d0103994a02c747d41dd199f7d1e69"}, "closed": true, "closedAt": "2020-01-27T16:45:03Z", "author": {"login": "DanVanAtta"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-AnjPAH2gAyMzY3MTgxNzg5OjBlMTgxZTJhYjk4ZmVlMjM3MzQ0NGFlMmNhMjAxMmM0YzkxODA2OTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb-fkBPAFqTM0ODgxMTY1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0e181e2ab98fee2373444ae2ca2012c4c9180692", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/0e181e2ab98fee2373444ae2ca2012c4c9180692", "committedDate": "2020-01-26T04:41:26Z", "message": "Make MapData controll lifecycle of resource loader and remove close method.\n\nUpdates MapData to always instantiate a resource loader itself and to close\nit when construction is done. This ensures that the resource loader is closed\nand removes the burden of other classes from having to remember to call\nclose on map data."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4MzU4NDk1", "url": "https://github.com/triplea-game/triplea/pull/5882#pullrequestreview-348358495", "createdAt": "2020-01-26T04:50:26Z", "commit": {"oid": "0e181e2ab98fee2373444ae2ca2012c4c9180692"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNlQwNDo1MDoyN1rOFhya1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNlQwNDo1NToyM1rOFhybhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3MzM5OA==", "bodyText": "These three methods are moved, no updates to them.", "url": "https://github.com/triplea-game/triplea/pull/5882#discussion_r370973398", "createdAt": "2020-01-26T04:50:27Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/ResourceLoader.java", "diffHunk": "@@ -276,4 +281,31 @@ public boolean hasPath(final String path) {\n     return UrlStreams.openStream(url)\n         .orElseThrow(() -> new IllegalStateException(\"Failed to open an input stream to: \" + path));\n   }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e181e2ab98fee2373444ae2ca2012c4c9180692"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3MzQwNQ==", "bodyText": "Removing this kind of call to close() is the main impetus for this update.", "url": "https://github.com/triplea-game/triplea/pull/5882#discussion_r370973405", "createdAt": "2020-01-26T04:50:48Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/ui/HeadedUiContext.java", "diffHunk": "@@ -57,10 +57,7 @@\n   @Override\n   protected void internalSetMapDir(final String dir, final GameData data) {\n     resourceLoader = ResourceLoader.getMapResourceLoader(dir);\n-    if (mapData != null) {\n-      mapData.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e181e2ab98fee2373444ae2ca2012c4c9180692"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3MzQ1Mg==", "bodyText": "These 4 images were loaded when called, leveraging the fact that MapData had a reference to a resourceLoader. With the resourceLoader reference available now only on construction, we now load these images in the constructor.", "url": "https://github.com/triplea-game/triplea/pull/5882#discussion_r370973452", "createdAt": "2020-01-26T04:51:36Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/ui/mapdata/MapData.java", "diffHunk": "@@ -127,14 +122,16 @@\n   private final Map<Image, List<Point>> decorations = new HashMap<>();\n   private final Map<String, Image> territoryNameImages = new HashMap<>();\n   private final Map<String, Image> effectImages = new HashMap<>();\n-  private final ResourceLoader resourceLoader;\n \n-  public MapData(final String mapNameDir) {\n-    this(ResourceLoader.getMapResourceLoader(mapNameDir));\n-  }\n+  @Nullable private final Image vcImage;\n+  @Nullable private final Image blockadeImage;\n+  @Nullable private final Image errorImage;\n+  @Nullable private final Image warningImage;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e181e2ab98fee2373444ae2ca2012c4c9180692"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3MzUwMg==", "bodyText": "The updates to this method are a simplification:\n\nWe chain the if( img.isEmpty() )  check to the optional with an 'or' check\nRemove exception handling, none of the wrapped code (please double check) throws.", "url": "https://github.com/triplea-game/triplea/pull/5882#discussion_r370973502", "createdAt": "2020-01-26T04:52:55Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/ui/mapdata/MapData.java", "diffHunk": "@@ -224,52 +216,42 @@ public boolean scrollWrapY() {\n     return Boolean.parseBoolean(mapProperties.getProperty(PROPERTY_MAP_SCROLLWRAPY, \"false\"));\n   }\n \n-  @Override\n-  public void close() {\n-    resourceLoader.close();\n-  }\n-\n-  private Map<String, Image> territoryNameImages() {\n+  private Map<String, Image> territoryNameImages(final ResourceLoader resourceLoader) {\n     if (!resourceLoader.hasPath(\"territoryNames/\")) {\n       return new HashMap<>();\n     }\n \n     final Map<String, Image> territoryNameImages = new HashMap<>();\n     for (final String name : centers.keySet()) {\n-      final Optional<Image> territoryNameImage = loadTerritoryNameImage(name);\n+      final Optional<Image> territoryNameImage = loadTerritoryNameImage(resourceLoader, name);\n \n       territoryNameImage.ifPresent(image -> territoryNameImages.put(name, image));\n     }\n     return territoryNameImages;\n   }\n \n-  private Optional<Image> loadTerritoryNameImage(final String imageName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e181e2ab98fee2373444ae2ca2012c4c9180692"}, "originalPosition": 143}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3MzUxMA==", "bodyText": "loadImage is simply moved.", "url": "https://github.com/triplea-game/triplea/pull/5882#discussion_r370973510", "createdAt": "2020-01-26T04:53:12Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/ui/mapdata/MapData.java", "diffHunk": "@@ -765,34 +747,20 @@ private Rectangle getBoundingRectWithTranslate(\n   }\n \n   public Optional<Image> getVcImage() {\n-    return loadImage(\"misc/vc.png\");\n+\n+    return Optional.ofNullable(vcImage);\n   }\n \n   public Optional<Image> getBlockadeImage() {\n-    return loadImage(\"misc/blockade.png\");\n+    return Optional.ofNullable(blockadeImage);\n   }\n \n   public Optional<Image> getErrorImage() {\n-    return loadImage(\"misc/error.gif\");\n+    return Optional.of(errorImage);\n   }\n \n   public Optional<Image> getWarningImage() {\n-    return loadImage(\"misc/warning.gif\");\n-  }\n-\n-  private Optional<Image> loadImage(final String imageName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e181e2ab98fee2373444ae2ca2012c4c9180692"}, "originalPosition": 210}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3MzU1NA==", "bodyText": "This method looks up territory effects at runtime. It's not clear if we could load them all in construction very easily in case a map would add territory effects as some sort of trigger. Hence we need to instantiate a resource loader here to support dynamic lookup of territory effects. Not ideal, but a trade-off..", "url": "https://github.com/triplea-game/triplea/pull/5882#discussion_r370973554", "createdAt": "2020-01-26T04:54:26Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/ui/mapdata/MapData.java", "diffHunk": "@@ -811,15 +779,18 @@ private Rectangle getBoundingRectWithTranslate(\n   }\n \n   public Optional<Image> getTerritoryEffectImage(final String effectName) {\n-    // TODO: what does this cache buy us? should we still keep it?\n-    if (effectImages.get(effectName) != null) {\n-      return Optional.of(effectImages.get(effectName));\n-    }\n-    Optional<Image> effectImage = loadImage(\"territoryEffects/\" + effectName + \"_large.png\");\n-    if (effectImage.isEmpty()) {\n-      effectImage = loadImage(\"territoryEffects/\" + effectName + \".png\");\n+    try (ResourceLoader loader = ResourceLoader.getMapResourceLoader(mapNameDir)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e181e2ab98fee2373444ae2ca2012c4c9180692"}, "originalPosition": 238}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3MzU3NQ==", "bodyText": "This catch block would never have been triggered from new MapData to begin with, and is removed.", "url": "https://github.com/triplea-game/triplea/pull/5882#discussion_r370973575", "createdAt": "2020-01-26T04:55:23Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/tools/image/AutoPlacementFinder.java", "diffHunk": "@@ -260,56 +260,44 @@ private void calculate() {\n     }\n \n     // makes TripleA read all the text data files for the map.\n-    try (MapData mapData = new MapData(mapDir)) {\n-      textOptionPane.show();\n-      textOptionPane.appendNewLine(\n-          \"Place Dimensions in pixels, being used: \" + placeWidth + \"x\" + placeHeight + \"\\r\\n\");\n-      textOptionPane.appendNewLine(\"Calculating, this may take a while...\\r\\n\");\n-      final Map<String, List<Point>> placements = new HashMap<>();\n-      for (final String name : mapData.getTerritories()) {\n-        final Set<Polygon> containedPolygons = mapData.getContainedTerritoryPolygons(name);\n-        final List<Point> points =\n-            containedPolygons.isEmpty()\n-                ? getPlacementsStartingAtMiddle(\n-                    mapData.getPolygons(name),\n-                    mapData.getBoundingRect(name),\n-                    mapData.getCenter(name))\n-                : getPlacementsStartingAtTopLeft(\n-                    mapData.getPolygons(name),\n-                    mapData.getBoundingRect(name),\n-                    mapData.getCenter(name),\n-                    containedPolygons);\n-        placements.put(name, points);\n-        textOptionPane.appendNewLine(name + \": \" + points.size());\n-      }\n-      textOptionPane.appendNewLine(\"\\r\\nAll Finished!\");\n-      textOptionPane.countDown();\n-      final String fileName =\n-          new FileSave(\"Where To Save place.txt ?\", \"place.txt\", mapFolderLocation).getPathString();\n-      if (fileName == null) {\n-        textOptionPane.appendNewLine(\"You chose not to save, Shutting down\");\n-        textOptionPane.dispose();\n-        return;\n-      }\n-      try (OutputStream os = new FileOutputStream(fileName)) {\n-        PointFileReaderWriter.writeOneToMany(os, placements);\n-        textOptionPane.appendNewLine(\"Data written to :\" + new File(fileName).getCanonicalPath());\n-      } catch (final IOException e) {\n-        log.log(Level.SEVERE, \"Failed to write points file: \" + fileName, e);\n-        textOptionPane.dispose();\n-        return;\n-      }\n+    MapData mapData = new MapData(mapDir);\n+    textOptionPane.show();\n+    textOptionPane.appendNewLine(\n+        \"Place Dimensions in pixels, being used: \" + placeWidth + \"x\" + placeHeight + \"\\r\\n\");\n+    textOptionPane.appendNewLine(\"Calculating, this may take a while...\\r\\n\");\n+    final Map<String, List<Point>> placements = new HashMap<>();\n+    for (final String name : mapData.getTerritories()) {\n+      final Set<Polygon> containedPolygons = mapData.getContainedTerritoryPolygons(name);\n+      final List<Point> points =\n+          containedPolygons.isEmpty()\n+              ? getPlacementsStartingAtMiddle(\n+                  mapData.getPolygons(name), mapData.getBoundingRect(name), mapData.getCenter(name))\n+              : getPlacementsStartingAtTopLeft(\n+                  mapData.getPolygons(name),\n+                  mapData.getBoundingRect(name),\n+                  mapData.getCenter(name),\n+                  containedPolygons);\n+      placements.put(name, points);\n+      textOptionPane.appendNewLine(name + \": \" + points.size());\n+    }\n+    textOptionPane.appendNewLine(\"\\r\\nAll Finished!\");\n+    textOptionPane.countDown();\n+    final String fileName =\n+        new FileSave(\"Where To Save place.txt ?\", \"place.txt\", mapFolderLocation).getPathString();\n+    if (fileName == null) {\n+      textOptionPane.appendNewLine(\"You chose not to save, Shutting down\");\n       textOptionPane.dispose();\n-    } catch (final Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e181e2ab98fee2373444ae2ca2012c4c9180692"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a92ba18b532b30150b82140213e1489eb40bff1f", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/a92ba18b532b30150b82140213e1489eb40bff1f", "committedDate": "2020-01-26T23:46:01Z", "message": "Make mapData final and move closer to usage"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4MzcyNDYy", "url": "https://github.com/triplea-game/triplea/pull/5882#pullrequestreview-348372462", "createdAt": "2020-01-26T11:12:19Z", "commit": {"oid": "0e181e2ab98fee2373444ae2ca2012c4c9180692"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNlQxMToxMjoyMFrOFhzeMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QwMDo1Mjo0NlrOFh2lEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk5MDY0Mw==", "bodyText": "This should be ofNullable, right?", "url": "https://github.com/triplea-game/triplea/pull/5882#discussion_r370990643", "createdAt": "2020-01-26T11:12:20Z", "author": {"login": "RoiEXLab"}, "path": "game-core/src/main/java/games/strategy/triplea/ui/mapdata/MapData.java", "diffHunk": "@@ -765,34 +747,20 @@ private Rectangle getBoundingRectWithTranslate(\n   }\n \n   public Optional<Image> getVcImage() {\n-    return loadImage(\"misc/vc.png\");\n+\n+    return Optional.ofNullable(vcImage);\n   }\n \n   public Optional<Image> getBlockadeImage() {\n-    return loadImage(\"misc/blockade.png\");\n+    return Optional.ofNullable(blockadeImage);\n   }\n \n   public Optional<Image> getErrorImage() {\n-    return loadImage(\"misc/error.gif\");\n+    return Optional.of(errorImage);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e181e2ab98fee2373444ae2ca2012c4c9180692"}, "originalPosition": 203}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk5MDY4MA==", "bodyText": "Same here, ofNullable", "url": "https://github.com/triplea-game/triplea/pull/5882#discussion_r370990680", "createdAt": "2020-01-26T11:13:05Z", "author": {"login": "RoiEXLab"}, "path": "game-core/src/main/java/games/strategy/triplea/ui/mapdata/MapData.java", "diffHunk": "@@ -765,34 +747,20 @@ private Rectangle getBoundingRectWithTranslate(\n   }\n \n   public Optional<Image> getVcImage() {\n-    return loadImage(\"misc/vc.png\");\n+\n+    return Optional.ofNullable(vcImage);\n   }\n \n   public Optional<Image> getBlockadeImage() {\n-    return loadImage(\"misc/blockade.png\");\n+    return Optional.ofNullable(blockadeImage);\n   }\n \n   public Optional<Image> getErrorImage() {\n-    return loadImage(\"misc/error.gif\");\n+    return Optional.of(errorImage);\n   }\n \n   public Optional<Image> getWarningImage() {\n-    return loadImage(\"misc/warning.gif\");\n-  }\n-\n-  private Optional<Image> loadImage(final String imageName) {\n-    final URL url = resourceLoader.getResource(imageName);\n-    if (url == null) {\n-      // this is actually pretty common that we try to read images that are not there. Let the\n-      // caller\n-      // decide if this is an error or not.\n-      return Optional.empty();\n-    }\n-    try {\n-      return Optional.of(ImageIO.read(url));\n-    } catch (final IOException e) {\n-      throw new IllegalStateException(e);\n-    }\n+    return Optional.of(warningImage);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e181e2ab98fee2373444ae2ca2012c4c9180692"}, "originalPosition": 223}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk5MDkwNw==", "bodyText": "Is this resource loader closed at some point now?", "url": "https://github.com/triplea-game/triplea/pull/5882#discussion_r370990907", "createdAt": "2020-01-26T11:17:13Z", "author": {"login": "RoiEXLab"}, "path": "game-core/src/main/java/games/strategy/triplea/ui/HeadedUiContext.java", "diffHunk": "@@ -57,10 +57,7 @@\n   @Override\n   protected void internalSetMapDir(final String dir, final GameData data) {\n     resourceLoader = ResourceLoader.getMapResourceLoader(dir);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e181e2ab98fee2373444ae2ca2012c4c9180692"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk5MDk5Ng==", "bodyText": "Thoughts about using a try-with-resources here? Feels a little bit safer in case an exception is raised somewhere", "url": "https://github.com/triplea-game/triplea/pull/5882#discussion_r370990996", "createdAt": "2020-01-26T11:18:56Z", "author": {"login": "RoiEXLab"}, "path": "game-core/src/main/java/games/strategy/triplea/ui/mapdata/MapData.java", "diffHunk": "@@ -127,14 +122,16 @@\n   private final Map<Image, List<Point>> decorations = new HashMap<>();\n   private final Map<String, Image> territoryNameImages = new HashMap<>();\n   private final Map<String, Image> effectImages = new HashMap<>();\n-  private final ResourceLoader resourceLoader;\n \n-  public MapData(final String mapNameDir) {\n-    this(ResourceLoader.getMapResourceLoader(mapNameDir));\n-  }\n+  @Nullable private final Image vcImage;\n+  @Nullable private final Image blockadeImage;\n+  @Nullable private final Image errorImage;\n+  @Nullable private final Image warningImage;\n+  private final String mapNameDir;\n \n-  public MapData(final ResourceLoader loader) {\n-    resourceLoader = loader;\n+  public MapData(final String mapNameDir) {\n+    this.mapNameDir = mapNameDir;\n+    final ResourceLoader loader = ResourceLoader.getMapResourceLoader(mapNameDir);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e181e2ab98fee2373444ae2ca2012c4c9180692"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk5MTEzMg==", "bodyText": "Here you could use optional#or, like you did in the other method", "url": "https://github.com/triplea-game/triplea/pull/5882#discussion_r370991132", "createdAt": "2020-01-26T11:21:43Z", "author": {"login": "RoiEXLab"}, "path": "game-core/src/main/java/games/strategy/triplea/ui/mapdata/MapData.java", "diffHunk": "@@ -811,15 +779,18 @@ private Rectangle getBoundingRectWithTranslate(\n   }\n \n   public Optional<Image> getTerritoryEffectImage(final String effectName) {\n-    // TODO: what does this cache buy us? should we still keep it?\n-    if (effectImages.get(effectName) != null) {\n-      return Optional.of(effectImages.get(effectName));\n-    }\n-    Optional<Image> effectImage = loadImage(\"territoryEffects/\" + effectName + \"_large.png\");\n-    if (effectImage.isEmpty()) {\n-      effectImage = loadImage(\"territoryEffects/\" + effectName + \".png\");\n+    try (ResourceLoader loader = ResourceLoader.getMapResourceLoader(mapNameDir)) {\n+      // TODO: what does this cache buy us? should we still keep it?\n+      if (effectImages.get(effectName) != null) {\n+        return Optional.of(effectImages.get(effectName));\n+      }\n+      Optional<Image> effectImage =\n+          loader.loadImage(\"territoryEffects/\" + effectName + \"_large.png\");\n+      if (effectImage.isEmpty()) {\n+        effectImage = loader.loadImage(\"territoryEffects/\" + effectName + \".png\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e181e2ab98fee2373444ae2ca2012c4c9180692"}, "originalPosition": 246}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA0MTEyMg==", "bodyText": "Not sure about the exception part.\nloadImage explicitly rethrows an exception when there's an IOException thrown.\nBecause we have a URL-null check before, this shoudl happen rarely, but in case the image file has an unsupported format or something, this method would throw an exception.", "url": "https://github.com/triplea-game/triplea/pull/5882#discussion_r371041122", "createdAt": "2020-01-27T00:45:56Z", "author": {"login": "RoiEXLab"}, "path": "game-core/src/main/java/games/strategy/triplea/ui/mapdata/MapData.java", "diffHunk": "@@ -224,52 +216,42 @@ public boolean scrollWrapY() {\n     return Boolean.parseBoolean(mapProperties.getProperty(PROPERTY_MAP_SCROLLWRAPY, \"false\"));\n   }\n \n-  @Override\n-  public void close() {\n-    resourceLoader.close();\n-  }\n-\n-  private Map<String, Image> territoryNameImages() {\n+  private Map<String, Image> territoryNameImages(final ResourceLoader resourceLoader) {\n     if (!resourceLoader.hasPath(\"territoryNames/\")) {\n       return new HashMap<>();\n     }\n \n     final Map<String, Image> territoryNameImages = new HashMap<>();\n     for (final String name : centers.keySet()) {\n-      final Optional<Image> territoryNameImage = loadTerritoryNameImage(name);\n+      final Optional<Image> territoryNameImage = loadTerritoryNameImage(resourceLoader, name);\n \n       territoryNameImage.ifPresent(image -> territoryNameImages.put(name, image));\n     }\n     return territoryNameImages;\n   }\n \n-  private Optional<Image> loadTerritoryNameImage(final String imageName) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3MzUwMg=="}, "originalCommit": {"oid": "0e181e2ab98fee2373444ae2ca2012c4c9180692"}, "originalPosition": 143}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA0MTI1NA==", "bodyText": "Thinking about this again, you could even use it twice, by prepending Optional.ofNullable(effectImages.get(effectImages)), but in this case we might end up re-inserting the element into effect images", "url": "https://github.com/triplea-game/triplea/pull/5882#discussion_r371041254", "createdAt": "2020-01-27T00:47:56Z", "author": {"login": "RoiEXLab"}, "path": "game-core/src/main/java/games/strategy/triplea/ui/mapdata/MapData.java", "diffHunk": "@@ -811,15 +779,18 @@ private Rectangle getBoundingRectWithTranslate(\n   }\n \n   public Optional<Image> getTerritoryEffectImage(final String effectName) {\n-    // TODO: what does this cache buy us? should we still keep it?\n-    if (effectImages.get(effectName) != null) {\n-      return Optional.of(effectImages.get(effectName));\n-    }\n-    Optional<Image> effectImage = loadImage(\"territoryEffects/\" + effectName + \"_large.png\");\n-    if (effectImage.isEmpty()) {\n-      effectImage = loadImage(\"territoryEffects/\" + effectName + \".png\");\n+    try (ResourceLoader loader = ResourceLoader.getMapResourceLoader(mapNameDir)) {\n+      // TODO: what does this cache buy us? should we still keep it?\n+      if (effectImages.get(effectName) != null) {\n+        return Optional.of(effectImages.get(effectName));\n+      }\n+      Optional<Image> effectImage =\n+          loader.loadImage(\"territoryEffects/\" + effectName + \"_large.png\");\n+      if (effectImage.isEmpty()) {\n+        effectImage = loader.loadImage(\"territoryEffects/\" + effectName + \".png\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk5MTEzMg=="}, "originalCommit": {"oid": "0e181e2ab98fee2373444ae2ca2012c4c9180692"}, "originalPosition": 246}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA0MTU1NA==", "bodyText": "Not sure about that either.\nThis catches any potential RuntimeExceptions as well and loadImage does still explicitly throw one, so the constructor could definitely throw an exception that could land here.", "url": "https://github.com/triplea-game/triplea/pull/5882#discussion_r371041554", "createdAt": "2020-01-27T00:52:46Z", "author": {"login": "RoiEXLab"}, "path": "game-core/src/main/java/tools/image/AutoPlacementFinder.java", "diffHunk": "@@ -260,56 +260,44 @@ private void calculate() {\n     }\n \n     // makes TripleA read all the text data files for the map.\n-    try (MapData mapData = new MapData(mapDir)) {\n-      textOptionPane.show();\n-      textOptionPane.appendNewLine(\n-          \"Place Dimensions in pixels, being used: \" + placeWidth + \"x\" + placeHeight + \"\\r\\n\");\n-      textOptionPane.appendNewLine(\"Calculating, this may take a while...\\r\\n\");\n-      final Map<String, List<Point>> placements = new HashMap<>();\n-      for (final String name : mapData.getTerritories()) {\n-        final Set<Polygon> containedPolygons = mapData.getContainedTerritoryPolygons(name);\n-        final List<Point> points =\n-            containedPolygons.isEmpty()\n-                ? getPlacementsStartingAtMiddle(\n-                    mapData.getPolygons(name),\n-                    mapData.getBoundingRect(name),\n-                    mapData.getCenter(name))\n-                : getPlacementsStartingAtTopLeft(\n-                    mapData.getPolygons(name),\n-                    mapData.getBoundingRect(name),\n-                    mapData.getCenter(name),\n-                    containedPolygons);\n-        placements.put(name, points);\n-        textOptionPane.appendNewLine(name + \": \" + points.size());\n-      }\n-      textOptionPane.appendNewLine(\"\\r\\nAll Finished!\");\n-      textOptionPane.countDown();\n-      final String fileName =\n-          new FileSave(\"Where To Save place.txt ?\", \"place.txt\", mapFolderLocation).getPathString();\n-      if (fileName == null) {\n-        textOptionPane.appendNewLine(\"You chose not to save, Shutting down\");\n-        textOptionPane.dispose();\n-        return;\n-      }\n-      try (OutputStream os = new FileOutputStream(fileName)) {\n-        PointFileReaderWriter.writeOneToMany(os, placements);\n-        textOptionPane.appendNewLine(\"Data written to :\" + new File(fileName).getCanonicalPath());\n-      } catch (final IOException e) {\n-        log.log(Level.SEVERE, \"Failed to write points file: \" + fileName, e);\n-        textOptionPane.dispose();\n-        return;\n-      }\n+    MapData mapData = new MapData(mapDir);\n+    textOptionPane.show();\n+    textOptionPane.appendNewLine(\n+        \"Place Dimensions in pixels, being used: \" + placeWidth + \"x\" + placeHeight + \"\\r\\n\");\n+    textOptionPane.appendNewLine(\"Calculating, this may take a while...\\r\\n\");\n+    final Map<String, List<Point>> placements = new HashMap<>();\n+    for (final String name : mapData.getTerritories()) {\n+      final Set<Polygon> containedPolygons = mapData.getContainedTerritoryPolygons(name);\n+      final List<Point> points =\n+          containedPolygons.isEmpty()\n+              ? getPlacementsStartingAtMiddle(\n+                  mapData.getPolygons(name), mapData.getBoundingRect(name), mapData.getCenter(name))\n+              : getPlacementsStartingAtTopLeft(\n+                  mapData.getPolygons(name),\n+                  mapData.getBoundingRect(name),\n+                  mapData.getCenter(name),\n+                  containedPolygons);\n+      placements.put(name, points);\n+      textOptionPane.appendNewLine(name + \": \" + points.size());\n+    }\n+    textOptionPane.appendNewLine(\"\\r\\nAll Finished!\");\n+    textOptionPane.countDown();\n+    final String fileName =\n+        new FileSave(\"Where To Save place.txt ?\", \"place.txt\", mapFolderLocation).getPathString();\n+    if (fileName == null) {\n+      textOptionPane.appendNewLine(\"You chose not to save, Shutting down\");\n       textOptionPane.dispose();\n-    } catch (final Exception e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3MzU3NQ=="}, "originalCommit": {"oid": "0e181e2ab98fee2373444ae2ca2012c4c9180692"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87e8c7ed8afb24a8dc3ac2e6d62d47417308da5f", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/87e8c7ed8afb24a8dc3ac2e6d62d47417308da5f", "committedDate": "2020-01-27T01:02:45Z", "message": "Close resourceLoader on shutdown"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc36734b6c71505dec7c519871e7840e1618de06", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/cc36734b6c71505dec7c519871e7840e1618de06", "committedDate": "2020-01-27T01:05:19Z", "message": "Use try-with-resources block in MapData"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8340c9776d3bbc1a332e65867d4e696dbf708328", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/8340c9776d3bbc1a332e65867d4e696dbf708328", "committedDate": "2020-01-27T01:07:11Z", "message": "Move image loading logging to \"loadImage\""}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07502296e5bc296cd65545a3152ad2ceae355414", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/07502296e5bc296cd65545a3152ad2ceae355414", "committedDate": "2020-01-27T01:08:43Z", "message": "Use ofNullable instead of when loading error/warning images"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b060f844dc29c34fd6f8d4c1550233c23e10da46", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/b060f844dc29c34fd6f8d4c1550233c23e10da46", "committedDate": "2020-01-27T15:27:26Z", "message": "Fix line length"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4NzU2OTc2", "url": "https://github.com/triplea-game/triplea/pull/5882#pullrequestreview-348756976", "createdAt": "2020-01-27T15:36:53Z", "commit": {"oid": "b060f844dc29c34fd6f8d4c1550233c23e10da46"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNTozNjo1NFrOFiHF4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNTozNjo1NFrOFiHF4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMxMjA5OQ==", "bodyText": "Hmm I think we still have the initial Problem, but on a higher level.\nPreviously the code did call mapData.close() whenever internalSetMapDir is executed in order to close the underlying resourceloader that might still exist.\nNow MapData is fine, but in case this method is run twice (or more), we have n - 1 unclosed instances of ResourceLoader lying around, so it looks like this code needs to come back, I'm afraid :(", "url": "https://github.com/triplea-game/triplea/pull/5882#discussion_r371312099", "createdAt": "2020-01-27T15:36:54Z", "author": {"login": "RoiEXLab"}, "path": "game-core/src/main/java/games/strategy/triplea/ui/HeadedUiContext.java", "diffHunk": "@@ -57,10 +57,7 @@\n   @Override\n   protected void internalSetMapDir(final String dir, final GameData data) {\n     resourceLoader = ResourceLoader.getMapResourceLoader(dir);\n-    if (mapData != null) {\n-      mapData.close();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3MzQwNQ=="}, "originalCommit": {"oid": "0e181e2ab98fee2373444ae2ca2012c4c9180692"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdf4766caec4668d7dee4b4696b5769cc65d6bd3", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/cdf4766caec4668d7dee4b4696b5769cc65d6bd3", "committedDate": "2020-01-27T16:17:24Z", "message": "Close any previous resourceLoader instance in HeadedUiContext"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f666e147b6cbcd4edacc4a146aa6516119d5faf", "author": {"user": {"login": "tripleabuilderbot", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/8f666e147b6cbcd4edacc4a146aa6516119d5faf", "committedDate": "2020-01-27T16:19:55Z", "message": "Auto-Formatting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4ODExNjU2", "url": "https://github.com/triplea-game/triplea/pull/5882#pullrequestreview-348811656", "createdAt": "2020-01-27T16:44:38Z", "commit": {"oid": "8f666e147b6cbcd4edacc4a146aa6516119d5faf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3775, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}