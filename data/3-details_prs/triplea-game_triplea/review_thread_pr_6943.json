{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxNzk2MTU2", "number": 6943, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMDozOTowOFrOEKp14A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMTo1ODoyMlrOEKrLBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NjA2NzUyOnYy", "diffSide": "RIGHT", "path": "game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMDozOTowOFrOGr0nTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMDo0MjozNFrOGr0tUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwMzk4Mg==", "bodyText": "nit: 'get' methods usually are just 'getters'. If computation is done a different verb could be easier for future maintainers. Perhaps rewording this to buildUnitPlayerMap would help that. WDYT @trevan ?", "url": "https://github.com/triplea-game/triplea/pull/6943#discussion_r448603982", "createdAt": "2020-07-01T20:39:08Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java", "diffHunk": "@@ -15,19 +20,26 @@\n   private final String name;\n   private final Collection<Unit> units;\n   private final String type;\n+  private Map<UUID, String> unitPlayerMap;\n \n   AddUnits(final UnitCollection collection, final Collection<Unit> units) {\n-    this.units = new ArrayList<>(units);\n+    this.units = units;\n+    unitPlayerMap = getUnitPlayerMap(units);\n     name = collection.getHolder().getName();\n     type = collection.getHolder().getType();\n   }\n \n   AddUnits(final String name, final String type, final Collection<Unit> units) {\n-    this.units = new ArrayList<>(units);\n+    this.units = units;\n+    unitPlayerMap = getUnitPlayerMap(units);\n     this.type = type;\n     this.name = name;\n   }\n \n+  private Map<UUID, String> getUnitPlayerMap(final Collection<Unit> units) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59b252e3450e35fb03d2cfdf6d33cf2ff03f9720"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwNTUyMw==", "bodyText": "This could be a moot comment if it turns out we do not need a map.", "url": "https://github.com/triplea-game/triplea/pull/6943#discussion_r448605523", "createdAt": "2020-07-01T20:42:34Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java", "diffHunk": "@@ -15,19 +20,26 @@\n   private final String name;\n   private final Collection<Unit> units;\n   private final String type;\n+  private Map<UUID, String> unitPlayerMap;\n \n   AddUnits(final UnitCollection collection, final Collection<Unit> units) {\n-    this.units = new ArrayList<>(units);\n+    this.units = units;\n+    unitPlayerMap = getUnitPlayerMap(units);\n     name = collection.getHolder().getName();\n     type = collection.getHolder().getType();\n   }\n \n   AddUnits(final String name, final String type, final Collection<Unit> units) {\n-    this.units = new ArrayList<>(units);\n+    this.units = units;\n+    unitPlayerMap = getUnitPlayerMap(units);\n     this.type = type;\n     this.name = name;\n   }\n \n+  private Map<UUID, String> getUnitPlayerMap(final Collection<Unit> units) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwMzk4Mg=="}, "originalCommit": {"oid": "59b252e3450e35fb03d2cfdf6d33cf2ff03f9720"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NjA3NjYzOnYy", "diffSide": "RIGHT", "path": "game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMDo0MjoxOVrOGr0s6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMTo1MzozMFrOGr2kVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwNTQxNw==", "bodyText": "If we're iterating over the entry set of the unitPlayerMap, why do we need a map for this? Can we not just iterate over the set of units and avoid the map data structure altogether?", "url": "https://github.com/triplea-game/triplea/pull/6943#discussion_r448605417", "createdAt": "2020-07-01T20:42:19Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java", "diffHunk": "@@ -36,11 +48,36 @@ public Change invert() {\n   @Override\n   protected void perform(final GameData data) {\n     final UnitHolder holder = data.getUnitHolder(name, type);\n-    holder.getUnitCollection().addAll(units);\n+    final Collection<Unit> unitsWithCorrectOwner = getUnitsWithOwner(data);\n+    holder.getUnitCollection().addAll(unitsWithCorrectOwner);\n+  }\n+\n+  private Collection<Unit> getUnitsWithOwner(final GameData data) {\n+    final Map<UUID, Unit> uuidToUnits =\n+        units.stream().collect(Collectors.toMap(Unit::getId, unit -> unit));\n+    return unitPlayerMap.entrySet().stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59b252e3450e35fb03d2cfdf6d33cf2ff03f9720"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwNzk5Mw==", "bodyText": "The original code just iterated over the set of units.  That's the problem.  We need to store the map of unit -> owner outside of the units so that when the owner changes in the unit, it doesn't change the map here.", "url": "https://github.com/triplea-game/triplea/pull/6943#discussion_r448607993", "createdAt": "2020-07-01T20:47:51Z", "author": {"login": "trevan"}, "path": "game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java", "diffHunk": "@@ -36,11 +48,36 @@ public Change invert() {\n   @Override\n   protected void perform(final GameData data) {\n     final UnitHolder holder = data.getUnitHolder(name, type);\n-    holder.getUnitCollection().addAll(units);\n+    final Collection<Unit> unitsWithCorrectOwner = getUnitsWithOwner(data);\n+    holder.getUnitCollection().addAll(unitsWithCorrectOwner);\n+  }\n+\n+  private Collection<Unit> getUnitsWithOwner(final GameData data) {\n+    final Map<UUID, Unit> uuidToUnits =\n+        units.stream().collect(Collectors.toMap(Unit::getId, unit -> unit));\n+    return unitPlayerMap.entrySet().stream()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwNTQxNw=="}, "originalCommit": {"oid": "59b252e3450e35fb03d2cfdf6d33cf2ff03f9720"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzMDQ5OA==", "bodyText": "Cool, I think that probably should be called out to make it clear & obvious. Perhaps a javadoc comment on the map property would do the trick. WDYT?", "url": "https://github.com/triplea-game/triplea/pull/6943#discussion_r448630498", "createdAt": "2020-07-01T21:40:08Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java", "diffHunk": "@@ -36,11 +48,36 @@ public Change invert() {\n   @Override\n   protected void perform(final GameData data) {\n     final UnitHolder holder = data.getUnitHolder(name, type);\n-    holder.getUnitCollection().addAll(units);\n+    final Collection<Unit> unitsWithCorrectOwner = getUnitsWithOwner(data);\n+    holder.getUnitCollection().addAll(unitsWithCorrectOwner);\n+  }\n+\n+  private Collection<Unit> getUnitsWithOwner(final GameData data) {\n+    final Map<UUID, Unit> uuidToUnits =\n+        units.stream().collect(Collectors.toMap(Unit::getId, unit -> unit));\n+    return unitPlayerMap.entrySet().stream()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwNTQxNw=="}, "originalCommit": {"oid": "59b252e3450e35fb03d2cfdf6d33cf2ff03f9720"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzNTk5MQ==", "bodyText": "I added some documentation and changed the method names.  WDYT?", "url": "https://github.com/triplea-game/triplea/pull/6943#discussion_r448635991", "createdAt": "2020-07-01T21:53:30Z", "author": {"login": "trevan"}, "path": "game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java", "diffHunk": "@@ -36,11 +48,36 @@ public Change invert() {\n   @Override\n   protected void perform(final GameData data) {\n     final UnitHolder holder = data.getUnitHolder(name, type);\n-    holder.getUnitCollection().addAll(units);\n+    final Collection<Unit> unitsWithCorrectOwner = getUnitsWithOwner(data);\n+    holder.getUnitCollection().addAll(unitsWithCorrectOwner);\n+  }\n+\n+  private Collection<Unit> getUnitsWithOwner(final GameData data) {\n+    final Map<UUID, Unit> uuidToUnits =\n+        units.stream().collect(Collectors.toMap(Unit::getId, unit -> unit));\n+    return unitPlayerMap.entrySet().stream()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwNTQxNw=="}, "originalCommit": {"oid": "59b252e3450e35fb03d2cfdf6d33cf2ff03f9720"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NjI4Mjc3OnYy", "diffSide": "RIGHT", "path": "game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMTo1NzoxMlrOGr2pyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMTo1NzoxMlrOGr2pyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzNzM4Ng==", "bodyText": "side-note / big nit, this method could be static. I think we need to try and see if we can share a config that turns on the static analysis warning that methods can be marked as static.\nFor me it's really helpful as I watch for private methods being static. If they are, I know they do not interact with the class state. If they are not static, I assume they cannot be static and hence interact with class state.", "url": "https://github.com/triplea-game/triplea/pull/6943#discussion_r448637386", "createdAt": "2020-07-01T21:57:12Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java", "diffHunk": "@@ -15,19 +20,31 @@\n   private final String name;\n   private final Collection<Unit> units;\n   private final String type;\n+  /**\n+   * The unit's owner can be modified sometime after this Change is created but before it is\n+   * performed. To ensure that the newly created units have the correct ownership, their original\n+   * owners are stored in this separate map.\n+   */\n+  private Map<UUID, String> unitOwnerMap;\n \n   AddUnits(final UnitCollection collection, final Collection<Unit> units) {\n-    this.units = new ArrayList<>(units);\n+    this.units = units;\n+    unitOwnerMap = buildUnitOwnerMap(units);\n     name = collection.getHolder().getName();\n     type = collection.getHolder().getType();\n   }\n \n   AddUnits(final String name, final String type, final Collection<Unit> units) {\n-    this.units = new ArrayList<>(units);\n+    this.units = units;\n+    unitOwnerMap = buildUnitOwnerMap(units);\n     this.type = type;\n     this.name = name;\n   }\n \n+  private Map<UUID, String> buildUnitOwnerMap(final Collection<Unit> units) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d9e114af825a5d249f7bbf885ec0055ebd62238"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NjI4NTUwOnYy", "diffSide": "RIGHT", "path": "game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMTo1ODoyMlrOGr2rjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMTo1ODoyMlrOGr2rjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzNzgzOA==", "bodyText": "A test of some sort to verify the right functionality would be a good thing to have. If we change & break this, we'll have the extra safety net. Testing is really good for ensuring correctness, which is a further safety net that would be good to have as well.", "url": "https://github.com/triplea-game/triplea/pull/6943#discussion_r448637838", "createdAt": "2020-07-01T21:58:22Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java", "diffHunk": "@@ -36,11 +53,36 @@ public Change invert() {\n   @Override\n   protected void perform(final GameData data) {\n     final UnitHolder holder = data.getUnitHolder(name, type);\n-    holder.getUnitCollection().addAll(units);\n+    final Collection<Unit> unitsWithCorrectOwner = buildUnitsWithOwner(data);\n+    holder.getUnitCollection().addAll(unitsWithCorrectOwner);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d9e114af825a5d249f7bbf885ec0055ebd62238"}, "originalPosition": 58}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2083, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}