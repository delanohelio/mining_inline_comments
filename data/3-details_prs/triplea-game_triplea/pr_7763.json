{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyOTY1MDY1", "number": 7763, "title": "Improve test runtime of java-extras & Make Retryable more generic", "bodyText": "Retryable had a re-usability problem where it was useful for discrete void tasks to retry them to completion. If we want to retry something and get a result back, then we can't use it. Retryable is updated to return an optional, the task if it returns an empty is retried until it returns a non-empty optional which is then returned to the caller.\nMost of the changes here are speed improvements, largely by removing mocks (which are actually pretty slow, particularly with test start-up time (often that is a one-time initialization cost, though still methods like 'verify' are relatively very slow).\n\nTesting\n\nScreens Shots\n\nAdditional Notes to Reviewer\n\nRelease Note", "createdAt": "2020-09-25T09:56:30Z", "url": "https://github.com/triplea-game/triplea/pull/7763", "merged": true, "mergeCommit": {"oid": "68f326196f35272e419a778b016433ad6133041b"}, "closed": true, "closedAt": "2020-09-26T04:52:02Z", "author": {"login": "DanVanAtta"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdMRdTPgH2gAyNDkyOTY1MDY1OmFlNGM0NjZiMTY5Mjc1ZDNhM2I1NDZmNTg2MDRlNjE1NDlmZGY0NGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMiYuHAFqTQ5NjkzODIxMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ae4c466b169275d3a3b546f58604e61549fdf44f", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/ae4c466b169275d3a3b546f58604e61549fdf44f", "committedDate": "2020-09-25T08:24:43Z", "message": "- Replace EqualsVerifier with by-hand equality tests. Shaves 270ms off of test runtime."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0558eb3814a23f076f08b6a3ae937676da5a70f5", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/0558eb3814a23f076f08b6a3ae937676da5a70f5", "committedDate": "2020-09-25T08:40:49Z", "message": "- Remove mocks from FileUtils#ListFiles testing. Speeds up the test by 500ms and improves test robustness (less coupled)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd5d715ff07f80a7afab4ea4b3d2269cec6c2273", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/cd5d715ff07f80a7afab4ea4b3d2269cec6c2273", "committedDate": "2020-09-25T09:53:52Z", "message": "- Remove mock verifications from ExpiringAfterWriteCacheTest, shaves 420ms"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07ba1cc140298089ad9b0eeb095484cf2ad4c689", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/07ba1cc140298089ad9b0eeb095484cf2ad4c689", "committedDate": "2020-09-25T09:53:52Z", "message": "- Remove mocks from UrlStreams test, shaves 150ms"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd333a6da86e2d3c0333508ddffbf7723170bc0b", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/cd333a6da86e2d3c0333508ddffbf7723170bc0b", "committedDate": "2020-09-25T09:53:52Z", "message": "- Remove mocks from InterruptiblesTest, shaves 200ms"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e131f1bb52d663485352fd19467b191aa614ca7b", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/e131f1bb52d663485352fd19467b191aa614ca7b", "committedDate": "2020-09-25T09:53:52Z", "message": "- Remove mocks from CompletableFutureUtils, shaves 200ms"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d34fd244301139fa0be3beb696cc23ee2848ff2d", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/d34fd244301139fa0be3beb696cc23ee2848ff2d", "committedDate": "2020-09-25T09:53:54Z", "message": "- Inline single use OptionalUtils methods, saves 400ms of test time."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9422e6c8a6693afa9b0b46dcefe572088eb896ee", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/9422e6c8a6693afa9b0b46dcefe572088eb896ee", "committedDate": "2020-09-25T09:53:52Z", "message": "- Make Retryable more generic so it can return any kind of object and not just a success flag\n- Remove mocks from Retryable test, shaves 380ms"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18ff215ac4425f427231e87619ace2593bcb975f", "author": {"user": {"login": "tripleabuilderbot", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/18ff215ac4425f427231e87619ace2593bcb975f", "committedDate": "2020-09-25T09:55:54Z", "message": "Auto-Formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9fd439fc46f68b06e868b0e76615fb371dfcfc9", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/c9fd439fc46f68b06e868b0e76615fb371dfcfc9", "committedDate": "2020-09-26T01:27:40Z", "message": "Fix up javadoc (checkstyle fix)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc077da94d56e4b523f6a96e40c2cc853c33bc15", "author": {"user": {"login": "DanVanAtta", "name": "Dan Van Atta"}}, "url": "https://github.com/triplea-game/triplea/commit/fc077da94d56e4b523f6a96e40c2cc853c33bc15", "committedDate": "2020-09-26T04:03:20Z", "message": "FileUtilsTest - Use any order matcher, ordering not deterministic."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2OTM4MjA3", "url": "https://github.com/triplea-game/triplea/pull/7763#pullrequestreview-496938207", "createdAt": "2020-09-26T04:08:04Z", "commit": {"oid": "fc077da94d56e4b523f6a96e40c2cc853c33bc15"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQwNDowODowNFrOHYdiGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQwNDowODowNFrOHYdiGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQxMTczNw==", "bodyText": "Codacy found an issue: Document empty method body", "url": "https://github.com/triplea-game/triplea/pull/7763#discussion_r495411737", "createdAt": "2020-09-26T04:08:04Z", "author": {"login": "DanVanAtta"}, "path": "java-extras/src/test/java/org/triplea/java/UrlStreamsTest.java", "diffHunk": "@@ -3,66 +3,83 @@\n import static com.github.npathai.hamcrestopt.OptionalMatchers.isEmpty;\n import static com.github.npathai.hamcrestopt.OptionalMatchers.isPresent;\n import static org.hamcrest.MatcherAssert.assertThat;\n-import static org.hamcrest.Matchers.sameInstance;\n-import static org.mockito.Mockito.verify;\n-import static org.mockito.Mockito.when;\n+import static org.hamcrest.core.Is.is;\n \n+import java.io.ByteArrayInputStream;\n import java.io.IOException;\n import java.io.InputStream;\n import java.net.URL;\n import java.net.URLConnection;\n import java.util.Optional;\n import org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n-import org.junit.jupiter.api.extension.ExtendWith;\n-import org.mockito.Mock;\n-import org.mockito.junit.jupiter.MockitoExtension;\n \n-@ExtendWith(MockitoExtension.class)\n class UrlStreamsTest {\n \n   private UrlStreams testObj;\n \n   private URL fakeUrl;\n \n-  @Mock private URLConnection mockUrlConnection;\n-  @Mock private InputStream mockInputStream;\n+  //  @Mock private URLConnection mockUrlConnection;\n+  //  @Mock private InputStream mockInputStream;\n \n   @BeforeEach\n   void setUp() throws Exception {\n     // set up the test object with a function that will return a mocked url connection\n-    testObj = new UrlStreams(url -> mockUrlConnection);\n+    testObj =\n+        new UrlStreams(\n+            url ->\n+                new URLConnection(url) {\n+                  @Override\n+                  public void connect() {}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc077da94d56e4b523f6a96e40c2cc853c33bc15"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2OTM4MjA4", "url": "https://github.com/triplea-game/triplea/pull/7763#pullrequestreview-496938208", "createdAt": "2020-09-26T04:08:05Z", "commit": {"oid": "fc077da94d56e4b523f6a96e40c2cc853c33bc15"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQwNDowODowNVrOHYdiGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQwNDowODowNVrOHYdiGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQxMTczOA==", "bodyText": "Codacy found an issue: Fields should be declared at the top of the class, before any method declarations, constructors, initializers or inner classes.", "url": "https://github.com/triplea-game/triplea/pull/7763#discussion_r495411738", "createdAt": "2020-09-26T04:08:05Z", "author": {"login": "DanVanAtta"}, "path": "java-extras/src/test/java/org/triplea/java/RetryableTest.java", "diffHunk": "@@ -1,30 +1,43 @@\n package org.triplea.java;\n \n+import static com.github.npathai.hamcrestopt.OptionalMatchers.isEmpty;\n+import static com.github.npathai.hamcrestopt.OptionalMatchers.isPresent;\n import static org.hamcrest.MatcherAssert.assertThat;\n import static org.hamcrest.core.Is.is;\n import static org.junit.jupiter.api.Assertions.assertThrows;\n-import static org.mockito.Mockito.times;\n-import static org.mockito.Mockito.verify;\n-import static org.mockito.Mockito.when;\n \n import java.time.Duration;\n import java.util.List;\n-import java.util.function.BooleanSupplier;\n+import java.util.Optional;\n import java.util.function.Consumer;\n+import java.util.function.Supplier;\n+import lombok.RequiredArgsConstructor;\n import org.junit.jupiter.api.DisplayName;\n import org.junit.jupiter.api.Test;\n-import org.junit.jupiter.api.extension.ExtendWith;\n import org.junit.jupiter.params.ParameterizedTest;\n import org.junit.jupiter.params.provider.MethodSource;\n import org.junit.jupiter.params.provider.ValueSource;\n-import org.mockito.Mock;\n-import org.mockito.junit.jupiter.MockitoExtension;\n \n-@ExtendWith(MockitoExtension.class)\n class RetryableTest {\n \n-  @Mock private BooleanSupplier task;\n-  @Mock private Consumer<Duration> threadSleeper;\n+  /**\n+   * Increment the invocation count and return true if the invocation count matches the input\n+   * parameter. In other words, we can say \"return true on the 3rd invocation.\"\n+   */\n+  @RequiredArgsConstructor\n+  private static final class Task implements Supplier<Optional<Boolean>> {\n+    private final int successIteration;\n+    private int invocationCount;\n+\n+    @Override\n+    public Optional<Boolean> get() {\n+      invocationCount++;\n+      return invocationCount == successIteration ? Optional.of(true) : Optional.empty();\n+    }\n+  }\n+\n+  private int sleepCount;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc077da94d56e4b523f6a96e40c2cc853c33bc15"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2OTM4MjEw", "url": "https://github.com/triplea-game/triplea/pull/7763#pullrequestreview-496938210", "createdAt": "2020-09-26T04:08:06Z", "commit": {"oid": "fc077da94d56e4b523f6a96e40c2cc853c33bc15"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQwNDowODowNlrOHYdiHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQwNDowODowNlrOHYdiHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQxMTc0MQ==", "bodyText": "Codacy found an issue: Fields should be declared at the top of the class, before any method declarations, constructors, initializers or inner classes.", "url": "https://github.com/triplea-game/triplea/pull/7763#discussion_r495411741", "createdAt": "2020-09-26T04:08:06Z", "author": {"login": "DanVanAtta"}, "path": "java-extras/src/test/java/org/triplea/java/RetryableTest.java", "diffHunk": "@@ -1,30 +1,43 @@\n package org.triplea.java;\n \n+import static com.github.npathai.hamcrestopt.OptionalMatchers.isEmpty;\n+import static com.github.npathai.hamcrestopt.OptionalMatchers.isPresent;\n import static org.hamcrest.MatcherAssert.assertThat;\n import static org.hamcrest.core.Is.is;\n import static org.junit.jupiter.api.Assertions.assertThrows;\n-import static org.mockito.Mockito.times;\n-import static org.mockito.Mockito.verify;\n-import static org.mockito.Mockito.when;\n \n import java.time.Duration;\n import java.util.List;\n-import java.util.function.BooleanSupplier;\n+import java.util.Optional;\n import java.util.function.Consumer;\n+import java.util.function.Supplier;\n+import lombok.RequiredArgsConstructor;\n import org.junit.jupiter.api.DisplayName;\n import org.junit.jupiter.api.Test;\n-import org.junit.jupiter.api.extension.ExtendWith;\n import org.junit.jupiter.params.ParameterizedTest;\n import org.junit.jupiter.params.provider.MethodSource;\n import org.junit.jupiter.params.provider.ValueSource;\n-import org.mockito.Mock;\n-import org.mockito.junit.jupiter.MockitoExtension;\n \n-@ExtendWith(MockitoExtension.class)\n class RetryableTest {\n \n-  @Mock private BooleanSupplier task;\n-  @Mock private Consumer<Duration> threadSleeper;\n+  /**\n+   * Increment the invocation count and return true if the invocation count matches the input\n+   * parameter. In other words, we can say \"return true on the 3rd invocation.\"\n+   */\n+  @RequiredArgsConstructor\n+  private static final class Task implements Supplier<Optional<Boolean>> {\n+    private final int successIteration;\n+    private int invocationCount;\n+\n+    @Override\n+    public Optional<Boolean> get() {\n+      invocationCount++;\n+      return invocationCount == successIteration ? Optional.of(true) : Optional.empty();\n+    }\n+  }\n+\n+  private int sleepCount;\n+  private final Consumer<Duration> threadSleeper = duration -> sleepCount++;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc077da94d56e4b523f6a96e40c2cc853c33bc15"}, "originalPosition": 50}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3948, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}