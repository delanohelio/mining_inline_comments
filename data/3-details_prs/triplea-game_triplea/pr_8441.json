{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwODY3Nzk3", "number": 8441, "title": "Add interface so that a player object can add debug menu items", "bodyText": "The Debug menu will have an item for each player that has this\ninterface. The player can then define the items to be shown in the sub\nmenu. Useful for AI players to be able to add custom debug actions.\n\nTesting\n\nI modified AbstractProAI to implement the interface and I checked that the menu items showed up correctly and worked.\nScreens Shots\n\nHere's the Debug menu with all of the Axis in Global40 using Hard AI.\n\nAdditional Notes to Reviewer\n\nRelease Note\n\nCHANGE|Allow AI players to add custom menu items to the Debug menu.", "createdAt": "2020-12-16T03:48:21Z", "url": "https://github.com/triplea-game/triplea/pull/8441", "merged": true, "mergeCommit": {"oid": "da0ef03c8789838c486359f571ddf66129bf82da"}, "closed": true, "closedAt": "2020-12-28T19:46:01Z", "author": {"login": "trevan"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmneopgH2gAyNTQwODY3Nzk3OjlhMWZmNTEwZjkxNzkxYzg2ZDYwZmJiNzk4YjA5NjMzOGZmMTkzYjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdqfFBmAH2gAyNTQwODY3Nzk3OjFjODAwNTA3NTM1M2M1YWIwYjUwYTkxYzgzNGI1ZDhiMTZjYWFjN2Q=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9a1ff510f91791c86d60fbb798b096338ff193b4", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/9a1ff510f91791c86d60fbb798b096338ff193b4", "committedDate": "2020-12-16T04:46:07Z", "message": "Add interface so that a player object can add debug menu items\n\nThe Debug menu will have an item for each player that has this\ninterface. The player can then define the items to be shown in the sub\nmenu. Useful for AI players to be able to add custom debug actions."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a00d798a33728e3221a3d583b799c943fea9888", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/9a00d798a33728e3221a3d583b799c943fea9888", "committedDate": "2020-12-16T03:42:12Z", "message": "Add interface so that a player object can add debug menu items\n\nThe Debug menu will have an item for each player that has this\ninterface. The player can then define the items to be shown in the sub\nmenu. Useful for AI players to be able to add custom debug actions."}, "afterCommit": {"oid": "9a1ff510f91791c86d60fbb798b096338ff193b4", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/9a1ff510f91791c86d60fbb798b096338ff193b4", "committedDate": "2020-12-16T04:46:07Z", "message": "Add interface so that a player object can add debug menu items\n\nThe Debug menu will have an item for each player that has this\ninterface. The player can then define the items to be shown in the sub\nmenu. Useful for AI players to be able to add custom debug actions."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1OTgzMzk3", "url": "https://github.com/triplea-game/triplea/pull/8441#pullrequestreview-555983397", "createdAt": "2020-12-20T03:31:04Z", "commit": {"oid": "9a1ff510f91791c86d60fbb798b096338ff193b4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMFQwMzozMTowNFrOIJAb9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMFQwMzozMTowNFrOIJAb9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjMxNTI1Mw==", "bodyText": "I think we should prefer to avoid using class types to infer properties of an object. It can get odd in terms of nesting interfaces. Second, the menus suffer from a lot of side effect calls with methods like \"addMenu(menu)\", this makes code a lot harder to follow.\nWhat would you think about adding a method to the Player type, something like List<JMenuItem> getDebugMenutItems(). Then in this method, when iterating over each player, all you'd need to filter on is that the debug menus items is no non-null, and then you could add the menu times. This would avoid the 'void' return method and instanceOf check.", "url": "https://github.com/triplea-game/triplea/pull/8441#discussion_r546315253", "createdAt": "2020-12-20T03:31:04Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/ui/menubar/DebugMenu.java", "diffHunk": "@@ -25,6 +26,16 @@\n           .setMnemonic(KeyEvent.VK_X);\n     }\n \n+    players.stream()\n+        .filter(PlayerDebug.class::isInstance)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a1ff510f91791c86d60fbb798b096338ff193b4"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7318931d3e9adc7653d668b121d21f2cf5cf7cd3", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/7318931d3e9adc7653d668b121d21f2cf5cf7cd3", "committedDate": "2020-12-20T03:49:28Z", "message": "Return the debug menu items instead of adding them inline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e824c7a117929084a6cdbe5eaf48342c174dd157", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/e824c7a117929084a6cdbe5eaf48342c174dd157", "committedDate": "2020-12-23T15:53:31Z", "message": "Add a callback registry to DebugMenu for custom menus"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5208d692b7ec43c22851a87a139e3eac82f99e71", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/5208d692b7ec43c22851a87a139e3eac82f99e71", "committedDate": "2020-12-23T15:54:08Z", "message": "Merge remote-tracking branch 'upstream/master' into players-debug-menu-items"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c255d587ceb0480444c3291de063208200f1939b", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/c255d587ceb0480444c3291de063208200f1939b", "committedDate": "2020-12-23T17:07:59Z", "message": "Unregister only needs the name, not the callback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4ODMxNzg3", "url": "https://github.com/triplea-game/triplea/pull/8441#pullrequestreview-558831787", "createdAt": "2020-12-25T18:18:28Z", "commit": {"oid": "c255d587ceb0480444c3291de063208200f1939b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNVQxODoxODoyOVrOILeJyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNVQxODoxODoyOVrOILeJyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg5OTI3Mw==", "bodyText": "The type for this callback seems to be a bit overly generic. It's not clear what the semantic would be behind this type. Perhaps this can be resolved by creating an interface for this, eg: DebugMenuFactory\nWhy is the TripleAFrame reference required? Shouldn't any newly created debug menu be able to be added to a generic JMenu? Would it make sense for the debug menu factory to simply produce a menu and let this class deal with the detail of which menu it ought to be added to.", "url": "https://github.com/triplea-game/triplea/pull/8441#discussion_r548899273", "createdAt": "2020-12-25T18:18:29Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/ui/menubar/DebugMenu.java", "diffHunk": "@@ -4,13 +4,21 @@\n import games.strategy.triplea.ai.pro.AbstractProAi;\n import games.strategy.triplea.ui.TripleAFrame;\n import java.awt.event.KeyEvent;\n+import java.util.Collection;\n+import java.util.Map;\n import java.util.Set;\n+import java.util.TreeMap;\n+import java.util.function.Function;\n import javax.swing.JMenu;\n+import javax.swing.JMenuItem;\n import org.triplea.swing.SwingAction;\n \n-final class DebugMenu extends JMenu {\n+public final class DebugMenu extends JMenu {\n   private static final long serialVersionUID = -4876915214715298132L;\n \n+  private static final Map<String, Function<TripleAFrame, Collection<JMenuItem>>> menuCallbacks =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c255d587ceb0480444c3291de063208200f1939b"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8aa0cf717a7ac1a15570561fdc1d579d2b8e5931", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/8aa0cf717a7ac1a15570561fdc1d579d2b8e5931", "committedDate": "2020-12-27T01:08:42Z", "message": "Add a comment on the call back menu"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2dac876fe30ed32669cfa9e1aab15632bba41fff", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/2dac876fe30ed32669cfa9e1aab15632bba41fff", "committedDate": "2020-12-27T05:52:39Z", "message": "Move Pro AI logs menu to the debug menu registry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c17cf86284d7be5e8234eae657a818f267efeaef", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/c17cf86284d7be5e8234eae657a818f267efeaef", "committedDate": "2020-12-27T05:53:47Z", "message": "Rename some variables to say 'factory'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56f55330180834198205d4076ef0b3a529c86e3f", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/56f55330180834198205d4076ef0b3a529c86e3f", "committedDate": "2020-12-27T05:54:47Z", "message": "Merge remote-tracking branch 'upstream/master' into players-debug-menu-items"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4OTUzNDg5", "url": "https://github.com/triplea-game/triplea/pull/8441#pullrequestreview-558953489", "createdAt": "2020-12-27T19:12:03Z", "commit": {"oid": "56f55330180834198205d4076ef0b3a529c86e3f"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yN1QxOToxMjowM1rOILtqfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yN1QxOToxOTo1NFrOILttqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTE1MzQwNA==", "bodyText": "Could registerMenuCallback handle this detail for us?", "url": "https://github.com/triplea-game/triplea/pull/8441#discussion_r549153404", "createdAt": "2020-12-27T19:12:03Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/ai/pro/AbstractProAi.java", "diffHunk": "@@ -86,24 +90,35 @@ public AbstractProAi(\n     storedPurchaseTerritories = null;\n     storedPoliticalActions = null;\n     storedStrafingTerritories = new ArrayList<>();\n+\n+    // in case there are multiple Pro AIs running at the same time, unregister the one\n+    // created before creating one so that there is only one menu item for all of the ProAI\n+    DebugMenu.unregisterMenuCallback(\"Hard AI\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56f55330180834198205d4076ef0b3a529c86e3f"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTE1MzQ2OQ==", "bodyText": "If the game frame is going away, presumably the menu will be destroyed and GC'd. Do we need to unregister? Wouldn't this happen implicitly by the TripleAFrame closing?", "url": "https://github.com/triplea-game/triplea/pull/8441#discussion_r549153469", "createdAt": "2020-12-27T19:12:56Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/ai/pro/AbstractProAi.java", "diffHunk": "@@ -86,24 +90,35 @@ public AbstractProAi(\n     storedPurchaseTerritories = null;\n     storedPoliticalActions = null;\n     storedStrafingTerritories = new ArrayList<>();\n+\n+    // in case there are multiple Pro AIs running at the same time, unregister the one\n+    // created before creating one so that there is only one menu item for all of the ProAI\n+    DebugMenu.unregisterMenuCallback(\"Hard AI\");\n+    DebugMenu.registerMenuCallback(\"Hard AI\", this::initialize);\n   }\n \n   @Override\n   public void stopGame() {\n     super.stopGame(); // absolutely MUST call super.stopGame() first\n     calc.stop();\n+\n+    DebugMenu.unregisterMenuCallback(\"Hard AI\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56f55330180834198205d4076ef0b3a529c86e3f"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTE1MzU5NQ==", "bodyText": "The \"Hard AI\" label is in multiple places, it looks like it is a single thing and we would want to keep it consistent. I think this is a place where extracting it to a constant would be a good move so that the linkage between this label and what players select is explicit and would be the same value.", "url": "https://github.com/triplea-game/triplea/pull/8441#discussion_r549153595", "createdAt": "2020-12-27T19:14:17Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/ai/pro/AbstractProAi.java", "diffHunk": "@@ -86,24 +90,35 @@ public AbstractProAi(\n     storedPurchaseTerritories = null;\n     storedPoliticalActions = null;\n     storedStrafingTerritories = new ArrayList<>();\n+\n+    // in case there are multiple Pro AIs running at the same time, unregister the one\n+    // created before creating one so that there is only one menu item for all of the ProAI\n+    DebugMenu.unregisterMenuCallback(\"Hard AI\");\n+    DebugMenu.registerMenuCallback(\"Hard AI\", this::initialize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56f55330180834198205d4076ef0b3a529c86e3f"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTE1Mzk2NQ==", "bodyText": "Second, it's problematic that AI now has a dependency on swing. AI should ideally not depend on the UI layer at all.\nFor example, we saw this as a major problem when trying to replace Swing with JavaFX.\nPresumably this could be fixed by passing a DebugMenu interface to AbstractProAi which it could use to send data but not be aware of the UI implementation detail. WDYT @trevan ?", "url": "https://github.com/triplea-game/triplea/pull/8441#discussion_r549153965", "createdAt": "2020-12-27T19:17:39Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/ai/pro/AbstractProAi.java", "diffHunk": "@@ -86,24 +90,35 @@ public AbstractProAi(\n     storedPurchaseTerritories = null;\n     storedPoliticalActions = null;\n     storedStrafingTerritories = new ArrayList<>();\n+\n+    // in case there are multiple Pro AIs running at the same time, unregister the one\n+    // created before creating one so that there is only one menu item for all of the ProAI\n+    DebugMenu.unregisterMenuCallback(\"Hard AI\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTE1MzQwNA=="}, "originalCommit": {"oid": "56f55330180834198205d4076ef0b3a529c86e3f"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTE1NDIxNg==", "bodyText": "The frame dependency appears to only be here due to the initialize call. It does not look that is related to the menu item. Could we simply move the initialize call up a level and avoid the frame parameter?", "url": "https://github.com/triplea-game/triplea/pull/8441#discussion_r549154216", "createdAt": "2020-12-27T19:19:54Z", "author": {"login": "DanVanAtta"}, "path": "game-core/src/main/java/games/strategy/triplea/ai/pro/AbstractProAi.java", "diffHunk": "@@ -86,24 +90,35 @@ public AbstractProAi(\n     storedPurchaseTerritories = null;\n     storedPoliticalActions = null;\n     storedStrafingTerritories = new ArrayList<>();\n+\n+    // in case there are multiple Pro AIs running at the same time, unregister the one\n+    // created before creating one so that there is only one menu item for all of the ProAI\n+    DebugMenu.unregisterMenuCallback(\"Hard AI\");\n+    DebugMenu.registerMenuCallback(\"Hard AI\", this::initialize);\n   }\n \n   @Override\n   public void stopGame() {\n     super.stopGame(); // absolutely MUST call super.stopGame() first\n     calc.stop();\n+\n+    DebugMenu.unregisterMenuCallback(\"Hard AI\");\n   }\n \n   public ProOddsCalculator getCalc() {\n     return calc;\n   }\n \n-  public static void initialize(final TripleAFrame frame) {\n+  private Collection<JMenuItem> initialize(final TripleAFrame frame) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56f55330180834198205d4076ef0b3a529c86e3f"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a4cec437c9621bf472baaa72445ee331e47016f", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/1a4cec437c9621bf472baaa72445ee331e47016f", "committedDate": "2020-12-28T05:10:58Z", "message": "Move ProLog debug menu registry into ProLog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c8005075353c5ab0b50a91c834b5d8b16caac7d", "author": {"user": {"login": "trevan", "name": null}}, "url": "https://github.com/triplea-game/triplea/commit/1c8005075353c5ab0b50a91c834b5d8b16caac7d", "committedDate": "2020-12-28T05:14:36Z", "message": "Remove the unregisterMenuCallback"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3819, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}