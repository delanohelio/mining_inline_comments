{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwMTY0NTU1", "number": 6023, "title": "Lithium update", "bodyText": "", "createdAt": "2020-09-21T09:34:05Z", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6023", "merged": true, "mergeCommit": {"oid": "5cc9409172a09e5ecc8d0b301870ade1e0f85dd5"}, "closed": true, "closedAt": "2020-09-21T19:37:05Z", "author": {"login": "matt-42"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLAVTKAH2gAyNDkwMTY0NTU1OjYzMTRhZjU3ZjU0YzEzOTY1MWJiNmFmNmMyMTcwNzQzNzNmNWYzNzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLIS4cAH2gAyNDkwMTY0NTU1OmNiNDZiNjc0NDg0MTU1OTc1YTIxZWY4ZTU3YWQ4YzBhN2M4Yjc4M2M=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6314af57f54c139651bb6af6c217074373f5f371", "author": {"user": {"login": "matt-42", "name": "Matthieu Garrigues"}}, "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/6314af57f54c139651bb6af6c217074373f5f371", "committedDate": "2020-09-21T09:53:40Z", "message": "Lithium update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "991c38cf4e4249cef8e3fa20c13d85cae1c68b34", "author": {"user": {"login": "matt-42", "name": "Matthieu Garrigues"}}, "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/991c38cf4e4249cef8e3fa20c13d85cae1c68b34", "committedDate": "2020-09-21T10:08:00Z", "message": "Lithium update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69887f91cd2b88a658ec332fc2ba7d860a703243", "author": {"user": {"login": "matt-42", "name": "Matthieu Garrigues"}}, "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/69887f91cd2b88a658ec332fc2ba7d860a703243", "committedDate": "2020-09-21T10:17:28Z", "message": "Lithium update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNzU3MTY4", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6023#pullrequestreview-492757168", "createdAt": "2020-09-21T15:53:18Z", "commit": {"oid": "69887f91cd2b88a658ec332fc2ba7d860a703243"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNTo1MzoxOFrOHVXp9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNTo1MzoxOFrOHVXp9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE2OTcxNw==", "bodyText": "It's too early on Monday morning for me to figure out exactly what this cache is doing or why it's needed but if it's caching anything so that subsequent serializations require less work, it's a violation of the last rule in the JSON requirements.\n\nThe serialization to JSON must not be cached\n\nhttps://github.com/TechEmpower/FrameworkBenchmarks/wiki/Project-Information-Framework-Tests-Overview#json-serialization", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6023#discussion_r492169717", "createdAt": "2020-09-21T15:53:18Z", "author": {"login": "nbrady-techempower"}, "path": "frameworks/C++/lithium/lithium.cc", "diffHunk": "@@ -54,7 +54,31 @@ void siege(int port) {\n }\n #endif\n \n-lru_cache<int, decltype(mmm(s::id = int(), s::randomNumber = int()))> world_cache(10000);\n+struct json_cache {\n+\n+  template <typename T>\n+  void insert(T o) { \n+    if (0 == buffer.size())\n+      positions.push_back(buffer.size());\n+    buffer.append(json_encode(o)); \n+    positions.push_back(buffer.size());\n+  }\n+  std::string get_json_array(const std::vector<int>& ids) {\n+    std::string json = \"[\";\n+    json.append(buffer, positions[ids[0]], positions[ids[0]+1] - positions[ids[0]]);\n+    for (int i = 1; i < ids.size(); i++) {\n+      json.append(1, ',');\n+      json.append(buffer, positions[ids[i]], positions[ids[i]+1] - positions[ids[i]]);\n+    }\n+    json.append(1, ']');\n+    return json;\n+  }\n+\n+  std::string buffer;\n+  std::vector<int> positions;\n+};\n+\n+json_cache world_cache;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69887f91cd2b88a658ec332fc2ba7d860a703243"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "365ac0271cec6b210de3122a951e661b8667d3e3", "author": {"user": {"login": "matt-42", "name": "Matthieu Garrigues"}}, "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/365ac0271cec6b210de3122a951e661b8667d3e3", "committedDate": "2020-09-21T18:22:49Z", "message": "Lithium: Remove json caching."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb46b674484155975a21ef8e57ad8c0a7c8b783c", "author": {"user": {"login": "matt-42", "name": "Matthieu Garrigues"}}, "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/cb46b674484155975a21ef8e57ad8c0a7c8b783c", "committedDate": "2020-09-21T19:10:16Z", "message": "Lithium: Fix cached queries."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3929, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}