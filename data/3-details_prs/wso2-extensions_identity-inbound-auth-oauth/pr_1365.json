{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4NDY4MjE2", "number": 1365, "title": "Return default token endpoint for issuer ID in the tenant-qualified URLs mode", "bodyText": "Proposed changes in this pull request\n$subject\nimprovement for #1353\nWhen should this PR be merged\nASAP", "createdAt": "2020-04-24T10:29:51Z", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1365", "merged": true, "mergeCommit": {"oid": "aa9f7e7e34c778da0cb8cab3180e1f385221d9d1"}, "closed": true, "closedAt": "2020-04-24T13:14:56Z", "author": {"login": "chamathns"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcavC7bgFqTM5OTgzMjQwOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcaw5w5gFqTM5OTkxMzUyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5ODMyNDA4", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1365#pullrequestreview-399832408", "createdAt": "2020-04-24T10:36:51Z", "commit": {"oid": "5bfee42bc134416e7d6e1fa7c22bb9b45b138692"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5ODM0MTk5", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1365#pullrequestreview-399834199", "createdAt": "2020-04-24T10:39:42Z", "commit": {"oid": "5bfee42bc134416e7d6e1fa7c22bb9b45b138692"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMDozOTo0MlrOGLRmzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMDozOTo0MlrOGLRmzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ3NTk4Mg==", "bodyText": "This shouldn't be a runtime exception right?\nShall we throw a IdentityOAuth2Exception with a proper error message and including the original exception", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1365#discussion_r414475982", "createdAt": "2020-04-24T10:39:42Z", "author": {"login": "mefarazath"}, "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/util/OAuth2Util.java", "diffHunk": "@@ -3127,14 +3127,22 @@ public static AuthenticatedUser createAuthenticatedUser(String username, String\n \n     public static String getIdTokenIssuer(String tenantDomain) throws IdentityOAuth2Exception {\n \n-        IdentityProvider identityProvider = getResidentIdp(tenantDomain);\n-        FederatedAuthenticatorConfig[] fedAuthnConfigs = identityProvider.getFederatedAuthenticatorConfigs();\n-        // Get OIDC authenticator\n-        FederatedAuthenticatorConfig oidcAuthenticatorConfig =\n-                IdentityApplicationManagementUtil.getFederatedAuthenticator(fedAuthnConfigs,\n-                        IdentityApplicationConstants.Authenticator.OIDC.NAME);\n-        return IdentityApplicationManagementUtil.getProperty(oidcAuthenticatorConfig.getProperties(),\n-                IDP_ENTITY_ID).getValue();\n+        if (IdentityTenantUtil.isTenantQualifiedUrlsEnabled()) {\n+            try {\n+                return ServiceURLBuilder.create().addPath(OAUTH2_TOKEN_EP_URL).build().getAbsolutePublicURL();\n+            } catch (URLBuilderException e) {\n+                throw new OAuthRuntimeException(\"Error while building url for context: \" + OAUTH2_TOKEN_EP_URL);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bfee42bc134416e7d6e1fa7c22bb9b45b138692"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11277d223da66490be57b0a7d18a28bb209702e4", "author": {"user": {"login": "chamathns", "name": "Chamath Samarawickrama"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/11277d223da66490be57b0a7d18a28bb209702e4", "committedDate": "2020-04-24T10:53:00Z", "message": "Return default token endpoint for issuer ID in the tenant-qualified URLs mode"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5bfee42bc134416e7d6e1fa7c22bb9b45b138692", "author": {"user": {"login": "chamathns", "name": "Chamath Samarawickrama"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/5bfee42bc134416e7d6e1fa7c22bb9b45b138692", "committedDate": "2020-04-24T10:27:41Z", "message": "Return default token endpoint for issuer ID in the tenant-qualified URLs mode"}, "afterCommit": {"oid": "11277d223da66490be57b0a7d18a28bb209702e4", "author": {"user": {"login": "chamathns", "name": "Chamath Samarawickrama"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/11277d223da66490be57b0a7d18a28bb209702e4", "committedDate": "2020-04-24T10:53:00Z", "message": "Return default token endpoint for issuer ID in the tenant-qualified URLs mode"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5ODU0Mjgy", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1365#pullrequestreview-399854282", "createdAt": "2020-04-24T11:13:06Z", "commit": {"oid": "11277d223da66490be57b0a7d18a28bb209702e4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMToxMzowN1rOGLSuVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMToxMzowN1rOGLSuVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ5NDI5NA==", "bodyText": "I think it would be better say \"Error while retrieving ID Token issuer value for tenantDomain: \" + tenantDomain\nhere.\nCan you check how the exception thrown is handled? If we are handling and logging a similar message as I suggested above we do not need to change.", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1365#discussion_r414494294", "createdAt": "2020-04-24T11:13:07Z", "author": {"login": "mefarazath"}, "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/util/OAuth2Util.java", "diffHunk": "@@ -3127,14 +3127,23 @@ public static AuthenticatedUser createAuthenticatedUser(String username, String\n \n     public static String getIdTokenIssuer(String tenantDomain) throws IdentityOAuth2Exception {\n \n-        IdentityProvider identityProvider = getResidentIdp(tenantDomain);\n-        FederatedAuthenticatorConfig[] fedAuthnConfigs = identityProvider.getFederatedAuthenticatorConfigs();\n-        // Get OIDC authenticator\n-        FederatedAuthenticatorConfig oidcAuthenticatorConfig =\n-                IdentityApplicationManagementUtil.getFederatedAuthenticator(fedAuthnConfigs,\n-                        IdentityApplicationConstants.Authenticator.OIDC.NAME);\n-        return IdentityApplicationManagementUtil.getProperty(oidcAuthenticatorConfig.getProperties(),\n-                IDP_ENTITY_ID).getValue();\n+        if (IdentityTenantUtil.isTenantQualifiedUrlsEnabled()) {\n+            try {\n+                return ServiceURLBuilder.create().addPath(OAUTH2_TOKEN_EP_URL).build().getAbsolutePublicURL();\n+            } catch (URLBuilderException e) {\n+                String errorMsg = String.format(\"Error while building url for '%s' context\", OAUTH2_TOKEN_EP_URL);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11277d223da66490be57b0a7d18a28bb209702e4"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5ODk1ODI0", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1365#pullrequestreview-399895824", "createdAt": "2020-04-24T12:21:05Z", "commit": {"oid": "1e5a0c8916166a392cb62521d7bcddb459bc2c40"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMjoyMTowNVrOGLVEiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMjoyMTowNVrOGLVEiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDUzMjc0NQ==", "bodyText": "Can we present this message more clearly?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            String errorMsg = String.format(\"Error while building url for '%s' context for tenant domain: %s\",\n          \n          \n            \n                            String errorMsg = String.format(\"Error while building url  '%s' for tenant domain: %s\",", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1365#discussion_r414532745", "createdAt": "2020-04-24T12:21:05Z", "author": {"login": "denuwanthi"}, "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/util/OAuth2Util.java", "diffHunk": "@@ -3127,14 +3127,24 @@ public static AuthenticatedUser createAuthenticatedUser(String username, String\n \n     public static String getIdTokenIssuer(String tenantDomain) throws IdentityOAuth2Exception {\n \n-        IdentityProvider identityProvider = getResidentIdp(tenantDomain);\n-        FederatedAuthenticatorConfig[] fedAuthnConfigs = identityProvider.getFederatedAuthenticatorConfigs();\n-        // Get OIDC authenticator\n-        FederatedAuthenticatorConfig oidcAuthenticatorConfig =\n-                IdentityApplicationManagementUtil.getFederatedAuthenticator(fedAuthnConfigs,\n-                        IdentityApplicationConstants.Authenticator.OIDC.NAME);\n-        return IdentityApplicationManagementUtil.getProperty(oidcAuthenticatorConfig.getProperties(),\n-                IDP_ENTITY_ID).getValue();\n+        if (IdentityTenantUtil.isTenantQualifiedUrlsEnabled()) {\n+            try {\n+                return ServiceURLBuilder.create().addPath(OAUTH2_TOKEN_EP_URL).build().getAbsolutePublicURL();\n+            } catch (URLBuilderException e) {\n+                String errorMsg = String.format(\"Error while building url for '%s' context for tenant domain: %s\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e5a0c8916166a392cb62521d7bcddb459bc2c40"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5654c3971e0ccb838191e1bf6df56a404df617d3", "author": {"user": {"login": "chamathns", "name": "Chamath Samarawickrama"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/5654c3971e0ccb838191e1bf6df56a404df617d3", "committedDate": "2020-04-24T12:25:53Z", "message": "Update error messages"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1e5a0c8916166a392cb62521d7bcddb459bc2c40", "author": {"user": {"login": "chamathns", "name": "Chamath Samarawickrama"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/1e5a0c8916166a392cb62521d7bcddb459bc2c40", "committedDate": "2020-04-24T11:36:56Z", "message": "Update error messages"}, "afterCommit": {"oid": "5654c3971e0ccb838191e1bf6df56a404df617d3", "author": {"user": {"login": "chamathns", "name": "Chamath Samarawickrama"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/5654c3971e0ccb838191e1bf6df56a404df617d3", "committedDate": "2020-04-24T12:25:53Z", "message": "Update error messages"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5OTEzNTI3", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1365#pullrequestreview-399913527", "createdAt": "2020-04-24T12:46:39Z", "commit": {"oid": "5654c3971e0ccb838191e1bf6df56a404df617d3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3261, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}