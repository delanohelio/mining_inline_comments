{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5MzIxNTU2", "number": 1404, "title": "Fix issuing revoked access tokens when SMS OTP is set as 2nd step", "bodyText": "Resolves wso2/product-is#8529\nAs per the above issue, it will be seen that although the access token is revoked, it will issue the revoked access token again. The reason for this is when revoking the access token it won't clear the cache properly. That is because when clearing the cache it will clear a cache entry with cache key KdMTzq2VHxPiYu6fqHu34aiei7Aa:sam@carbon.super:openid:null:NONE. But initially, this access token is added to the OAuthCache with cache key as KdMTzq2VHxPiYu6fqHu34aiei7Aa:sam@carbon.super:openid:sms-otp-idp:NONE. The format of the cache key is [clientId]:[authorizedUser]:[scope]:[authenticatedIDP]:[tokenBindingReference]. So the difference in these two cache keys is when adding the cache key it will take \"sms-otp-idp\" as the authenticated IdP of the authorized user. But when clearing the cache it will see the authenticated IdP as null. Because of this mismatch in the cache key, the cache won't be cleared properly in token revocation flow.\nThis is reproduced only when SMS-OTP authenticator is configured as the second step. In other cases (e.g: when EMAIL-OTP authenticator is configured as the second step) when adding the access token to the OAuthCache it will take the authenticated IdP as null. But when this is persisted to the DB it will take 'LOCAL' as the authenticated IdP of the authorized user.\nProposed Solution\nUnless the user is authenticated by a federated IdP, the authenticated IdP of a user should be 'LOCAL'. So in this way, it won't add a null value or an erroneous value like 'sms-otp-idp' to the authenticatedIDP in the cache key. Hence with this fix, it will set the correct value for the authenticated IdP of an authorized user.", "createdAt": "2020-06-24T16:37:17Z", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1404", "merged": true, "mergeCommit": {"oid": "c5d51c9c4e4653bc9dd63b7e775d18db3d9268dc"}, "closed": true, "closedAt": "2020-06-26T05:35:19Z", "author": {"login": "sachiniWettasinghe"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuncJ_gBqjM0ODAzNTg3MjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcur9rSgFqTQzNzM2MDAyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9e7ebc24f699d42e70dde7afcef1ecf5088bc319", "author": {"user": {"login": "sachiniWettasinghe", "name": "Sachini"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/9e7ebc24f699d42e70dde7afcef1ecf5088bc319", "committedDate": "2020-06-24T16:33:11Z", "message": "Set correct authenticated IdP value to AuthenticatedUser object"}, "afterCommit": {"oid": "02ddac20ac1dd59b064095935a97927891baa44c", "author": {"user": {"login": "sachiniWettasinghe", "name": "Sachini"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/02ddac20ac1dd59b064095935a97927891baa44c", "committedDate": "2020-06-25T05:02:05Z", "message": "Set correct authenticated IdP value to AuthenticatedUser object"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MTk5OTM5", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1404#pullrequestreview-437199939", "createdAt": "2020-06-25T06:25:34Z", "commit": {"oid": "02ddac20ac1dd59b064095935a97927891baa44c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQwNjoyNTozNFrOGos8lA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQwNjoyNTozNFrOGos8lA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTMzMjYyOA==", "bodyText": "Since this should always be local idp we can set it as FrameworkConstants.LOCAL_IDP_NAME[1]\n\n  \n    \n      identity-inbound-auth-oauth/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/util/OAuth2Util.java\n    \n    \n         Line 3423\n      in\n      02ddac2\n    \n    \n    \n    \n\n        \n          \n           authenticatedIDP = FrameworkConstants.LOCAL_IDP_NAME;", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1404#discussion_r445332628", "createdAt": "2020-06-25T06:25:34Z", "author": {"login": "janakamarasena"}, "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/util/OAuth2Util.java", "diffHunk": "@@ -3163,6 +3163,7 @@ public static AuthenticatedUser createAuthenticatedUser(String username, String\n             }\n         } else {\n             authenticatedUser.setUserStoreDomain(userStoreDomain);\n+            authenticatedUser.setFederatedIdPName(idpName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02ddac20ac1dd59b064095935a97927891baa44c"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MjE0MDM3", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1404#pullrequestreview-437214037", "createdAt": "2020-06-25T06:54:29Z", "commit": {"oid": "02ddac20ac1dd59b064095935a97927891baa44c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ec98c9253cc9236077d52d5c2a73a5d7aeb03f5", "author": {"user": {"login": "sachiniWettasinghe", "name": "Sachini"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/6ec98c9253cc9236077d52d5c2a73a5d7aeb03f5", "committedDate": "2020-06-25T07:04:04Z", "message": "Set correct authenticated IdP value to AuthenticatedUser object"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "02ddac20ac1dd59b064095935a97927891baa44c", "author": {"user": {"login": "sachiniWettasinghe", "name": "Sachini"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/02ddac20ac1dd59b064095935a97927891baa44c", "committedDate": "2020-06-25T05:02:05Z", "message": "Set correct authenticated IdP value to AuthenticatedUser object"}, "afterCommit": {"oid": "6ec98c9253cc9236077d52d5c2a73a5d7aeb03f5", "author": {"user": {"login": "sachiniWettasinghe", "name": "Sachini"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/6ec98c9253cc9236077d52d5c2a73a5d7aeb03f5", "committedDate": "2020-06-25T07:04:04Z", "message": "Set correct authenticated IdP value to AuthenticatedUser object"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MzUzOTU4", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1404#pullrequestreview-437353958", "createdAt": "2020-06-25T10:10:44Z", "commit": {"oid": "6ec98c9253cc9236077d52d5c2a73a5d7aeb03f5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MzYwMDI1", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1404#pullrequestreview-437360025", "createdAt": "2020-06-25T10:19:53Z", "commit": {"oid": "6ec98c9253cc9236077d52d5c2a73a5d7aeb03f5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3118, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}