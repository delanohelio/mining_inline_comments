{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwNDE1MzM0", "number": 1468, "title": "Introduce the abiltiy to engage multiple scope validation implementaions at Server/Tenant level.", "bodyText": "The following PR adds the capability to engage multiple server/tenant level scope validation in the flows.\n\nat authorization (AuthorizationHandlerManager)\nat token issuance (AccessTokenIssuer)\nat introspection (TokenValidationHandler)\n\nThis provides another level of scope validation prior to the application level scope validation. The implementations could be enaged by implementing the interface(ScopeValidator) as OSGI services.\nIssues addressed by the PR\n\nwso2/product-is#8245\nwso2/product-is#8248", "createdAt": "2020-10-09T07:54:10Z", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468", "merged": true, "mergeCommit": {"oid": "b838b33a9b15e4dce43a843e4be55209a4df42c6"}, "closed": true, "closedAt": "2020-10-21T19:01:50Z", "author": {"login": "shilmyhasan"}, "timelineItems": {"totalCount": 48, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQKjrvgH2gAyNTAwNDE1MzM0Ojg0ODI5MGNhYzlmOTBhZWY1ZDk4NDk5NjUzODYzNWUxN2E5YmY2ZWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUpBj6AFqTUxMzQyNDU2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "848290cac9f90aef5d984996538635e17a9bf6ea", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/848290cac9f90aef5d984996538635e17a9bf6ea", "committedDate": "2020-10-07T10:38:03Z", "message": "Add server/tenant level scope validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8155539bf42476534dc23b44a83cf54ecbf4acf", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/a8155539bf42476534dc23b44a83cf54ecbf4acf", "committedDate": "2020-10-07T10:38:04Z", "message": "Add configuartion for allowed scopes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3004c201f06403a48a4b8dada463e8de89fc1fe", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/d3004c201f06403a48a4b8dada463e8de89fc1fe", "committedDate": "2020-10-07T10:38:04Z", "message": "Refactor global scope validation flow"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6deca6f7e981365f81e60c346835a5366e4a2653", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/6deca6f7e981365f81e60c346835a5366e4a2653", "committedDate": "2020-10-07T10:38:05Z", "message": "Refactor role based scope validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1128fb4608b45579dfdf0b6e1ab0cbb4e174b1bd", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/1128fb4608b45579dfdf0b6e1ab0cbb4e174b1bd", "committedDate": "2020-10-07T10:38:05Z", "message": "Refactor role based scope validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64da450ae777b5d354e460bf5c91e9c80ce63740", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/64da450ae777b5d354e460bf5c91e9c80ce63740", "committedDate": "2020-10-07T10:40:14Z", "message": "Refactor role based scope validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45b547a53517b3b1df78374e8ee70fd858ba89b9", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/45b547a53517b3b1df78374e8ee70fd858ba89b9", "committedDate": "2020-10-07T10:40:15Z", "message": "Refactor role based scope validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "756a7071328c83e75c077d507cc7b2467f9bb222", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/756a7071328c83e75c077d507cc7b2467f9bb222", "committedDate": "2020-10-07T10:40:15Z", "message": "Refactor role based scope validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b1e71dd677a426363b22d21e77cf596e8659c0b", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/4b1e71dd677a426363b22d21e77cf596e8659c0b", "committedDate": "2020-10-07T10:40:15Z", "message": "Refactor role based scope validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd4f8d488aa40aa64ce14570a3cfdfac02540c01", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/cd4f8d488aa40aa64ce14570a3cfdfac02540c01", "committedDate": "2020-10-07T10:40:16Z", "message": "Remove canhandle() method from the ScopeVaidator interface"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f3d7fef7ab99b14d966dcaaca4c19285e91952c", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/0f3d7fef7ab99b14d966dcaaca4c19285e91952c", "committedDate": "2020-10-09T05:11:36Z", "message": "Move the global validation to grant handler level"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b82a5df40af30a69c1db1f56870dd2d1f95fadd", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/1b82a5df40af30a69c1db1f56870dd2d1f95fadd", "committedDate": "2020-10-09T05:11:36Z", "message": "Refactor global scope validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dec441b11fc13e6615186742c5e58643b223a8f2", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/dec441b11fc13e6615186742c5e58643b223a8f2", "committedDate": "2020-10-09T07:45:17Z", "message": "fix comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8b96b8205984a30b5cb138beabce3e2d252674c", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/f8b96b8205984a30b5cb138beabce3e2d252674c", "committedDate": "2020-10-09T07:48:53Z", "message": "Merge branch 'master' of https://github.com/wso2-extensions/identity-inbound-auth-oauth into master-rolebasescopevaldation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f56dc3bfdb08306c6a9935b88786a99f728df4b", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/2f56dc3bfdb08306c6a9935b88786a99f728df4b", "committedDate": "2020-10-09T07:52:25Z", "message": "resolve merge conflict"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2NDg1MTg4", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#pullrequestreview-506485188", "createdAt": "2020-10-12T10:14:15Z", "commit": {"oid": "2f56dc3bfdb08306c6a9935b88786a99f728df4b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxMDoxNDoxNVrOHf4T0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxMDoxNDoxNVrOHf4T0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE5MDQ4Mg==", "bodyText": "Lets move the variable to the top. Would be cleaner.", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#discussion_r503190482", "createdAt": "2020-10-12T10:14:15Z", "author": {"login": "janakamarasena"}, "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/internal/OAuthComponentServiceHolder.java", "diffHunk": "@@ -47,6 +48,28 @@\n     private List<TokenBindingMetaDataDTO> tokenBindingMetaDataDTOs = new ArrayList<>();\n     private OAuthAdminServiceImpl oAuthAdminService;\n \n+    public List<ScopeValidator> getScopeValidators() {\n+\n+        return scopeValidators;\n+    }\n+\n+    public void addScopeValidator(ScopeValidator scopeValidator) {\n+\n+        scopeValidators.add(scopeValidator);\n+    }\n+\n+    public void removeScopeValidator(ScopeValidator scopeValidator) {\n+\n+        scopeValidators.remove(scopeValidator);\n+    }\n+\n+    public void setScopeValidators(List<ScopeValidator> scopeValidators) {\n+\n+        this.scopeValidators = scopeValidators;\n+    }\n+\n+    private List<ScopeValidator> scopeValidators = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f56dc3bfdb08306c6a9935b88786a99f728df4b"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2NDg1NjQ2", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#pullrequestreview-506485646", "createdAt": "2020-10-12T10:14:54Z", "commit": {"oid": "2f56dc3bfdb08306c6a9935b88786a99f728df4b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxMDoxNDo1NFrOHf4VRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxMDoxNDo1NFrOHf4VRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE5MDg1Mg==", "bodyText": "Add method comments to the public methods", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#discussion_r503190852", "createdAt": "2020-10-12T10:14:54Z", "author": {"login": "janakamarasena"}, "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/internal/OAuthComponentServiceHolder.java", "diffHunk": "@@ -47,6 +48,28 @@\n     private List<TokenBindingMetaDataDTO> tokenBindingMetaDataDTOs = new ArrayList<>();\n     private OAuthAdminServiceImpl oAuthAdminService;\n \n+    public List<ScopeValidator> getScopeValidators() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f56dc3bfdb08306c6a9935b88786a99f728df4b"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2NDkyMTA3", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#pullrequestreview-506492107", "createdAt": "2020-10-12T10:24:11Z", "commit": {"oid": "2f56dc3bfdb08306c6a9935b88786a99f728df4b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxMDoyNDoxMVrOHf4orw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxMDoyNDoxMVrOHf4orw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE5NTgyMw==", "bodyText": "Let's add a method comment", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#discussion_r503195823", "createdAt": "2020-10-12T10:24:11Z", "author": {"login": "GANGANI"}, "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/config/OAuthServerConfiguration.java", "diffHunk": "@@ -454,6 +478,11 @@ public boolean isShowDisplayNameInConsentPage() {\n         return showDisplayNameInConsentPage;\n     }\n \n+    public List<String> getAllowedScopes() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f56dc3bfdb08306c6a9935b88786a99f728df4b"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79d44c4e3bce8a5f1c57e5dce757c1bb19337031", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/79d44c4e3bce8a5f1c57e5dce757c1bb19337031", "committedDate": "2020-10-15T07:35:02Z", "message": "add method comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNDE1NDUx", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#pullrequestreview-510415451", "createdAt": "2020-10-16T12:19:08Z", "commit": {"oid": "79d44c4e3bce8a5f1c57e5dce757c1bb19337031"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMjoxOTowOFrOHi5irA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMjoxOTowOFrOHi5irA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM1NjM5Ng==", "bodyText": "Need to add the logic to handle allowed scopes", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#discussion_r506356396", "createdAt": "2020-10-16T12:19:08Z", "author": {"login": "janakamarasena"}, "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/validators/DefaultOAuth2TokenValidator.java", "diffHunk": "@@ -110,6 +113,21 @@ public boolean validateScope(OAuth2TokenValidationMessageContext messageContext)\n                             \" are not found in the server configuration \", StringUtils.join(appScopeValidators, \", \"),\n                     app.getApplicationName(), OAuth2Util.getTenantDomainOfOauthApp(app)));\n         }\n+\n+        // Deriving the global level scope validator implementations.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79d44c4e3bce8a5f1c57e5dce757c1bb19337031"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNDE1NDk2", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#pullrequestreview-510415496", "createdAt": "2020-10-16T12:19:12Z", "commit": {"oid": "79d44c4e3bce8a5f1c57e5dce757c1bb19337031"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMjoxOToxMlrOHi5i-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMjoxOToxMlrOHi5i-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM1NjQ3Mg==", "bodyText": "Need to add the logic to handle allowed scopes", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#discussion_r506356472", "createdAt": "2020-10-16T12:19:12Z", "author": {"login": "janakamarasena"}, "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/token/handlers/grant/AbstractAuthorizationGrantHandler.java", "diffHunk": "@@ -250,6 +252,20 @@ public boolean validateScope(OAuthTokenReqMessageContext tokReqMsgCtx) throws Id\n                 }\n             }\n         }\n+        // Deriving the list of global level scope validation implementations.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79d44c4e3bce8a5f1c57e5dce757c1bb19337031"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNDE1NzY3", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#pullrequestreview-510415767", "createdAt": "2020-10-16T12:19:38Z", "commit": {"oid": "79d44c4e3bce8a5f1c57e5dce757c1bb19337031"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMjoxOTozOFrOHi5j-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMjoxOTozOFrOHi5j-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM1NjcyOQ==", "bodyText": "Need to add the logic to handle allowed scopes.", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#discussion_r506356729", "createdAt": "2020-10-16T12:19:38Z", "author": {"login": "janakamarasena"}, "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/authz/handlers/AbstractResponseTypeHandler.java", "diffHunk": "@@ -101,6 +103,19 @@ public boolean validateScope(OAuthAuthzReqMessageContext oauthAuthzMsgCtx) throw\n                 .getAuthorizationCodeValidityPeriod());\n         oauthAuthzMsgCtx.setAccessTokenIssuedTime(scopeValidationCallback.getAccessTokenValidityPeriod());\n         oauthAuthzMsgCtx.setApprovedScope(scopeValidationCallback.getApprovedScope());\n+        // Deriving the global level scope validator implementations.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79d44c4e3bce8a5f1c57e5dce757c1bb19337031"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "328d264a2e70a4028ddfcbf05a25f57e3e873174", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/328d264a2e70a4028ddfcbf05a25f57e3e873174", "committedDate": "2020-10-18T22:00:47Z", "message": "move allowed scopes reading"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExNDA3MDc4", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#pullrequestreview-511407078", "createdAt": "2020-10-19T04:41:03Z", "commit": {"oid": "328d264a2e70a4028ddfcbf05a25f57e3e873174"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwNDo0MTowM1rOHj8SkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwNDo0MTowM1rOHj8SkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ1MDAwMQ==", "bodyText": "Do we need to mention at which level the scope validation fails in the response?\nWe could include that detail in a debug log.\n@IsuraD WDYT?", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#discussion_r507450001", "createdAt": "2020-10-19T04:41:03Z", "author": {"login": "janakamarasena"}, "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/validators/TokenValidationHandler.java", "diffHunk": "@@ -473,13 +481,14 @@ private OAuth2IntrospectionResponseDTO validateAccessToken(OAuth2TokenValidation\n             return buildIntrospectionErrorResponse(\"Invalid access delegation\");\n         }\n \n-        // Validate scopes.\n+        // Validate scopes at app level.\n         if (!tokenValidator.validateScope(messageContext)) {\n             // This is redundant. But sake of readability.\n             introResp.setActive(false);\n-            return buildIntrospectionErrorResponse(\"Scope validation failed\");\n+            return buildIntrospectionErrorResponse(\"Scope validation failed at app level\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "328d264a2e70a4028ddfcbf05a25f57e3e873174"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExNDA3NjE1", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#pullrequestreview-511407615", "createdAt": "2020-10-19T04:43:20Z", "commit": {"oid": "328d264a2e70a4028ddfcbf05a25f57e3e873174"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwNDo0MzoyMVrOHj8W0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwNDo0MzoyMVrOHj8W0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ1MTA5MQ==", "bodyText": "Duplicate code. Reuse the method defined in OAuth2Util", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#discussion_r507451091", "createdAt": "2020-10-19T04:43:21Z", "author": {"login": "janakamarasena"}, "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/authz/AuthorizationHandlerManager.java", "diffHunk": "@@ -142,10 +151,27 @@ private OAuth2AuthorizeRespDTO validateAuthzRequest(OAuth2AuthorizeReqDTO authzR\n         if (valid) {\n             //Add authorized internal scopes to the request for sending in the response.\n             addAuthorizedInternalScopes(authzReqMsgCtx, authorizedInternalScopes);\n+            addAllowedScopes(authzReqMsgCtx, requestedAllowedScopes.toArray(new String[requestedAllowedScopes.size()]));\n         }\n         return authorizeRespDTO;\n     }\n \n+    /**\n+     * Determines if the scope is specified in the whitelist.\n+     *\n+     * @param scope - The scope key to check\n+     * @return - 'true' if the scope is white listed. 'false' if not.\n+     */\n+    public boolean isAllowedScope(List<String> scopeSkipList, String scope) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "328d264a2e70a4028ddfcbf05a25f57e3e873174"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExNDA3ODk0", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#pullrequestreview-511407894", "createdAt": "2020-10-19T04:44:22Z", "commit": {"oid": "328d264a2e70a4028ddfcbf05a25f57e3e873174"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwNDo0NDoyMlrOHj8ZDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwNDo0NDoyMlrOHj8ZDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ1MTY2Mg==", "bodyText": "Let's change the variable name to allowedScopes", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#discussion_r507451662", "createdAt": "2020-10-19T04:44:22Z", "author": {"login": "janakamarasena"}, "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/authz/AuthorizationHandlerManager.java", "diffHunk": "@@ -129,6 +129,15 @@ private OAuth2AuthorizeRespDTO validateAuthzRequest(OAuth2AuthorizeReqDTO authzR\n             return authorizeRespDTO;\n         }\n \n+        List<String> allowedScope = OAuthServerConfiguration.getInstance().getAllowedScopes();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "328d264a2e70a4028ddfcbf05a25f57e3e873174"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExNDE1Njcy", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#pullrequestreview-511415672", "createdAt": "2020-10-19T05:13:23Z", "commit": {"oid": "328d264a2e70a4028ddfcbf05a25f57e3e873174"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwNToxMzoyM1rOHj9VZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwNToxMzoyM1rOHj9VZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ2NzEwOA==", "bodyText": "We need to remove these scopes from authzReqMsgCtx before engaging the  validateScope method.\nCheck the usage of removeInternalScopes method for reference.", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#discussion_r507467108", "createdAt": "2020-10-19T05:13:23Z", "author": {"login": "janakamarasena"}, "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/authz/AuthorizationHandlerManager.java", "diffHunk": "@@ -129,6 +129,15 @@ private OAuth2AuthorizeRespDTO validateAuthzRequest(OAuth2AuthorizeReqDTO authzR\n             return authorizeRespDTO;\n         }\n \n+        List<String> allowedScope = OAuthServerConfiguration.getInstance().getAllowedScopes();\n+        List<String> requestedAllowedScopes = new ArrayList<>();\n+        String[] requestedScope = authzReqMsgCtx.getAuthorizationReqDTO().getScopes();\n+        for (String scope : requestedScope) {\n+            if (OAuth2Util.isAllowedScope(allowedScope, scope)) {\n+                requestedAllowedScopes.add(scope);\n+            }\n+        }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "328d264a2e70a4028ddfcbf05a25f57e3e873174"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d2bf08c421feabe46cf80c0cda56853705228d8", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/4d2bf08c421feabe46cf80c0cda56853705228d8", "committedDate": "2020-10-19T06:22:23Z", "message": "Refactor allowed scopes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc50a199849af151aff3f12875d02c13a09887af", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/dc50a199849af151aff3f12875d02c13a09887af", "committedDate": "2020-10-19T06:31:37Z", "message": "Merge branch 'master' of https://github.com/wso2-extensions/identity-inbound-auth-oauth into master-rolebasescopevaldation\n\n\u0001 Conflicts:\n\u0001\tcomponents/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/util/OAuth2Util.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "712da68b56ac47cad8d15e773720e036846df432", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/712da68b56ac47cad8d15e773720e036846df432", "committedDate": "2020-10-19T09:10:46Z", "message": "remove allowed scope from message context"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExNTc1MTg2", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#pullrequestreview-511575186", "createdAt": "2020-10-19T09:29:25Z", "commit": {"oid": "712da68b56ac47cad8d15e773720e036846df432"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOToyOToyNVrOHkFqbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOToyOToyNVrOHkFqbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYwMzU2NQ==", "bodyText": "Add space after method signature.", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#discussion_r507603565", "createdAt": "2020-10-19T09:29:25Z", "author": {"login": "janakamarasena"}, "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/util/OAuth2Util.java", "diffHunk": "@@ -3856,4 +3856,19 @@ private static void endTenantFlow() {\n \n         PrivilegedCarbonContext.endTenantFlow();\n     }\n+\n+    /**\n+     * Determines if the scope is specified in the whitelist.\n+     *\n+     * @param scope - The scope key to check.\n+     * @return - 'true' if the scope is allowed. 'false' if not.\n+     */\n+    public static boolean isAllowedScope(List<String> scopeSkipList, String scope) {\n+        for (String scopeTobeSkipped : scopeSkipList) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "712da68b56ac47cad8d15e773720e036846df432"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExNTc1NzEy", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#pullrequestreview-511575712", "createdAt": "2020-10-19T09:29:58Z", "commit": {"oid": "712da68b56ac47cad8d15e773720e036846df432"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOToyOTo1OFrOHkFr7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOToyOTo1OFrOHkFr7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYwMzk1MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Determines if the scope is specified in the whitelist.\n          \n          \n            \n                 * Determines if the scope is specified in the allowed list.", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#discussion_r507603950", "createdAt": "2020-10-19T09:29:58Z", "author": {"login": "janakamarasena"}, "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/util/OAuth2Util.java", "diffHunk": "@@ -3856,4 +3856,19 @@ private static void endTenantFlow() {\n \n         PrivilegedCarbonContext.endTenantFlow();\n     }\n+\n+    /**\n+     * Determines if the scope is specified in the whitelist.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "712da68b56ac47cad8d15e773720e036846df432"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExNTc5NzM3", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#pullrequestreview-511579737", "createdAt": "2020-10-19T09:34:22Z", "commit": {"oid": "712da68b56ac47cad8d15e773720e036846df432"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOTozNDoyMlrOHkF3EA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOTozNDoyMlrOHkF3EA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYwNjgwMA==", "bodyText": "Missing param in javadoc comment", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#discussion_r507606800", "createdAt": "2020-10-19T09:34:22Z", "author": {"login": "janakamarasena"}, "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/util/OAuth2Util.java", "diffHunk": "@@ -3856,4 +3856,19 @@ private static void endTenantFlow() {\n \n         PrivilegedCarbonContext.endTenantFlow();\n     }\n+\n+    /**\n+     * Determines if the scope is specified in the whitelist.\n+     *\n+     * @param scope - The scope key to check.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "712da68b56ac47cad8d15e773720e036846df432"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExNTgwMzI2", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#pullrequestreview-511580326", "createdAt": "2020-10-19T09:35:02Z", "commit": {"oid": "712da68b56ac47cad8d15e773720e036846df432"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOTozNTowM1rOHkF4qQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOTozNTowM1rOHkF4qQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYwNzIwOQ==", "bodyText": "Lets rename scopeSkipList to something like allowedList for more clarity.", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#discussion_r507607209", "createdAt": "2020-10-19T09:35:03Z", "author": {"login": "janakamarasena"}, "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/util/OAuth2Util.java", "diffHunk": "@@ -3856,4 +3856,19 @@ private static void endTenantFlow() {\n \n         PrivilegedCarbonContext.endTenantFlow();\n     }\n+\n+    /**\n+     * Determines if the scope is specified in the whitelist.\n+     *\n+     * @param scope - The scope key to check.\n+     * @return - 'true' if the scope is allowed. 'false' if not.\n+     */\n+    public static boolean isAllowedScope(List<String> scopeSkipList, String scope) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "712da68b56ac47cad8d15e773720e036846df432"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExNTgwNzY2", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#pullrequestreview-511580766", "createdAt": "2020-10-19T09:35:30Z", "commit": {"oid": "712da68b56ac47cad8d15e773720e036846df432"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOTozNTozMVrOHkF5vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOTozNTozMVrOHkF5vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYwNzQ4Ng==", "bodyText": "Lets add a debug log to find what scopes were allowed since we are doing regex matching", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#discussion_r507607486", "createdAt": "2020-10-19T09:35:31Z", "author": {"login": "janakamarasena"}, "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/util/OAuth2Util.java", "diffHunk": "@@ -3856,4 +3856,19 @@ private static void endTenantFlow() {\n \n         PrivilegedCarbonContext.endTenantFlow();\n     }\n+\n+    /**\n+     * Determines if the scope is specified in the whitelist.\n+     *\n+     * @param scope - The scope key to check.\n+     * @return - 'true' if the scope is allowed. 'false' if not.\n+     */\n+    public static boolean isAllowedScope(List<String> scopeSkipList, String scope) {\n+        for (String scopeTobeSkipped : scopeSkipList) {\n+            if (scope.matches(scopeTobeSkipped)) {\n+                return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "712da68b56ac47cad8d15e773720e036846df432"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f55ee3aa001b5471ee20f6625ffebee8394af5e", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/9f55ee3aa001b5471ee20f6625ffebee8394af5e", "committedDate": "2020-10-19T09:45:27Z", "message": "refactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExNjI5NTY1", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#pullrequestreview-511629565", "createdAt": "2020-10-19T10:39:16Z", "commit": {"oid": "9f55ee3aa001b5471ee20f6625ffebee8394af5e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxMDozOToxN1rOHkIO-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxMDozOToxN1rOHkIO-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY0NTY4OA==", "bodyText": "Add null check for requestedScope. Also rename requestedScope to requestedScopes", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#discussion_r507645688", "createdAt": "2020-10-19T10:39:17Z", "author": {"login": "janakamarasena"}, "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/authz/AuthorizationHandlerManager.java", "diffHunk": "@@ -129,6 +129,20 @@ private OAuth2AuthorizeRespDTO validateAuthzRequest(OAuth2AuthorizeReqDTO authzR\n             return authorizeRespDTO;\n         }\n \n+        List<String> allowedScopes = OAuthServerConfiguration.getInstance().getAllowedScopes();\n+        List<String> requestedAllowedScopes = new ArrayList<>();\n+        String[] requestedScope = authzReqMsgCtx.getAuthorizationReqDTO().getScopes();\n+        List<String> requestedScopesList = new ArrayList<>();;\n+        for (String scope : requestedScope) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f55ee3aa001b5471ee20f6625ffebee8394af5e"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a93b154c4c7b205e58ded516c4d53be85f268998", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/a93b154c4c7b205e58ded516c4d53be85f268998", "committedDate": "2020-10-19T11:27:34Z", "message": "refactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExNjYzMzYw", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#pullrequestreview-511663360", "createdAt": "2020-10-19T11:29:13Z", "commit": {"oid": "a93b154c4c7b205e58ded516c4d53be85f268998"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxMToyOToxNFrOHkJ3fA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxMToyOToxNFrOHkJ3fA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY3MjQ0NA==", "bodyText": "new String[0])", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#discussion_r507672444", "createdAt": "2020-10-19T11:29:14Z", "author": {"login": "IsuraD"}, "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/authz/AuthorizationHandlerManager.java", "diffHunk": "@@ -129,6 +129,22 @@ private OAuth2AuthorizeRespDTO validateAuthzRequest(OAuth2AuthorizeReqDTO authzR\n             return authorizeRespDTO;\n         }\n \n+        List<String> allowedScopes = OAuthServerConfiguration.getInstance().getAllowedScopes();\n+        List<String> requestedAllowedScopes = new ArrayList<>();\n+        String[] requestedScopes = authzReqMsgCtx.getAuthorizationReqDTO().getScopes();\n+        List<String> requestedScopesList = new ArrayList<>();\n+        if (requestedScopes != null) {\n+            for (String scope : requestedScopes) {\n+                if (OAuth2Util.isAllowedScope(allowedScopes, scope)) {\n+                    requestedAllowedScopes.add(scope);\n+                } else {\n+                    requestedScopesList.add(scope);\n+                }\n+            }\n+            authzReqMsgCtx.getAuthorizationReqDTO().setScopes(requestedScopesList.toArray(\n+                    new String[requestedScopesList.size()]));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a93b154c4c7b205e58ded516c4d53be85f268998"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExNjY1ODg0", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#pullrequestreview-511665884", "createdAt": "2020-10-19T11:32:52Z", "commit": {"oid": "a93b154c4c7b205e58ded516c4d53be85f268998"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxMTozMjo1MlrOHkJ_Ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxMTozMjo1MlrOHkJ_Ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY3NDQyNw==", "bodyText": "rename requestedScopesList to scopesToValidate or scopesToBeValidated", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#discussion_r507674427", "createdAt": "2020-10-19T11:32:52Z", "author": {"login": "IsuraD"}, "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/authz/AuthorizationHandlerManager.java", "diffHunk": "@@ -129,6 +129,22 @@ private OAuth2AuthorizeRespDTO validateAuthzRequest(OAuth2AuthorizeReqDTO authzR\n             return authorizeRespDTO;\n         }\n \n+        List<String> allowedScopes = OAuthServerConfiguration.getInstance().getAllowedScopes();\n+        List<String> requestedAllowedScopes = new ArrayList<>();\n+        String[] requestedScopes = authzReqMsgCtx.getAuthorizationReqDTO().getScopes();\n+        List<String> requestedScopesList = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a93b154c4c7b205e58ded516c4d53be85f268998"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "760fadc552937ae7aee54dd69d30696c39f0f05f", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/760fadc552937ae7aee54dd69d30696c39f0f05f", "committedDate": "2020-10-19T11:47:23Z", "message": "refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e9c8538844849ed3ae1ab5576aab28d498cc017", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/9e9c8538844849ed3ae1ab5576aab28d498cc017", "committedDate": "2020-10-19T12:03:09Z", "message": "refactor logs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMTQwNzMw", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#pullrequestreview-512140730", "createdAt": "2020-10-19T20:38:38Z", "commit": {"oid": "9e9c8538844849ed3ae1ab5576aab28d498cc017"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMzE4MzY3", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#pullrequestreview-512318367", "createdAt": "2020-10-20T04:14:20Z", "commit": {"oid": "9e9c8538844849ed3ae1ab5576aab28d498cc017"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwNDoxNDoyMVrOHkp-9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwNDoxNDoyMVrOHkp-9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE5ODY0Nw==", "bodyText": "additional ;", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#discussion_r508198647", "createdAt": "2020-10-20T04:14:21Z", "author": {"login": "janakamarasena"}, "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/validators/TokenValidationHandler.java", "diffHunk": "@@ -408,9 +410,21 @@ private OAuth2IntrospectionResponseDTO validateAccessToken(OAuth2TokenValidation\n             }\n \n         } else {\n-\n             try {\n                 accessTokenDO = OAuth2Util.findAccessToken(validationRequest.getAccessToken().getIdentifier(), false);\n+                List<String> allowedScopes = OAuthServerConfiguration.getInstance().getAllowedScopes();\n+                String[] requestedScopes = accessTokenDO.getScope();\n+                List<String> scopesToBeValidated = new ArrayList<>();;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e9c8538844849ed3ae1ab5576aab28d498cc017"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMzE4NTEw", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#pullrequestreview-512318510", "createdAt": "2020-10-20T04:14:47Z", "commit": {"oid": "9e9c8538844849ed3ae1ab5576aab28d498cc017"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwNDoxNDo0N1rOHkp_ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwNDoxNDo0N1rOHkp_ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE5ODc5NA==", "bodyText": "add fullstop at the end", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#discussion_r508198794", "createdAt": "2020-10-20T04:14:47Z", "author": {"login": "janakamarasena"}, "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/validators/TokenValidationHandler.java", "diffHunk": "@@ -473,13 +487,17 @@ private OAuth2IntrospectionResponseDTO validateAccessToken(OAuth2TokenValidation\n             return buildIntrospectionErrorResponse(\"Invalid access delegation\");\n         }\n \n-        // Validate scopes.\n+        // Validate scopes at app level.\n         if (!tokenValidator.validateScope(messageContext)) {\n             // This is redundant. But sake of readability.\n             introResp.setActive(false);\n+            if (log.isDebugEnabled()) {\n+                log.debug(\"Scope validation has failed at app level\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e9c8538844849ed3ae1ab5576aab28d498cc017"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1fc7ccf713f226608dc667d1bdcf13cd22ad83d", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/a1fc7ccf713f226608dc667d1bdcf13cd22ad83d", "committedDate": "2020-10-20T04:58:56Z", "message": "refactor code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMzM4NDYz", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#pullrequestreview-512338463", "createdAt": "2020-10-20T05:20:59Z", "commit": {"oid": "a1fc7ccf713f226608dc667d1bdcf13cd22ad83d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzNDI0NTYx", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1468#pullrequestreview-513424561", "createdAt": "2020-10-21T08:23:32Z", "commit": {"oid": "a1fc7ccf713f226608dc667d1bdcf13cd22ad83d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3162, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}