{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgzOTc1MDE3", "number": 1441, "title": "Redirect to callback URL during error scenarios according to the response type", "bodyText": "Front porting the fix from the PR https://github.com/wso2-support/identity-inbound-auth-oauth/pull/631 into master\nRelated Issues\nwso2/product-is#5277 (Code fixed for the PR: #617)\nwso2/product-is#7673", "createdAt": "2020-09-10T15:06:19Z", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1441", "merged": true, "mergeCommit": {"oid": "b9ec6167af9e45aca3bb264ab7b699fcdcbf8b18"}, "closed": true, "closedAt": "2020-09-11T09:46:26Z", "author": {"login": "kasundharmadasa"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHiIsBAH2gAyNDgzOTc1MDE3OmIxNzlhZjFkNGZiOGQ1YTZjNzljMDMzMzJkODVmNDBjMTY5NzI4OGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHwuHRgFqTQ4NjU1ODk1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b179af1d4fb8d5a6c79c03332d85f40c1697288f", "author": {"user": {"login": "kasundharmadasa", "name": "Kasun Dharmadasa"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/b179af1d4fb8d5a6c79c03332d85f40c1697288f", "committedDate": "2020-09-10T15:00:58Z", "message": "fix redirect during error scenarios accoridng to the response type"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MDk0NDMy", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1441#pullrequestreview-486094432", "createdAt": "2020-09-10T16:08:27Z", "commit": {"oid": "b179af1d4fb8d5a6c79c03332d85f40c1697288f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNjowODoyOFrOHP7aDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNjowODoyOFrOHP7aDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ2NDAxMw==", "bodyText": "Shouldn't this be the other way in the master?\nie. by default we should not allow additional params in the error URL as it violates the spec", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1441#discussion_r486464013", "createdAt": "2020-09-10T16:08:28Z", "author": {"login": "mefarazath"}, "path": "components/org.wso2.carbon.identity.oauth.endpoint/src/main/java/org/wso2/carbon/identity/oauth/endpoint/util/EndpointUtil.java", "diffHunk": "@@ -966,13 +957,53 @@ private static String retrieveStateForErrorURL(OAuth2Parameters oAuth2Parameters\n         return state;\n     }\n \n+    /**\n+     * Return updated redirect URL.\n+     *\n+     * @param request       HttpServletRequest\n+     * @param redirectUri   Redirect Uri\n+     * @param errorCode     Error Code\n+     * @param errorMessage  Message of the error\n+     * @param state         State from the request\n+     * @param appName       Application Name\n+     * @return Updated Redirect URL\n+     */\n+    private static String getUpdatedRedirectURL(HttpServletRequest request, String redirectUri, String errorCode,\n+                                                String errorMessage, String state, String appName) {\n+\n+        String updatedRedirectUri = redirectUri;\n+        try {\n+            OAuthProblemException ex = OAuthProblemException.error(errorCode).description(errorMessage);\n+            if (OAuth2Util.isImplicitResponseType(request.getParameter(OAuthConstants.OAuth20Params.RESPONSE_TYPE))\n+                    || OAuth2Util.isHybridResponseType(request.getParameter(OAuthConstants.OAuth20Params.\n+                    RESPONSE_TYPE))) {\n+                updatedRedirectUri = OAuthASResponse.errorResponse(HttpServletResponse.SC_FOUND)\n+                        .error(ex).location(redirectUri).setState(state).setParam(OAuth.OAUTH_ACCESS_TOKEN, null)\n+                        .buildQueryMessage().getLocationUri();\n+            } else {\n+                updatedRedirectUri = OAuthASResponse.errorResponse(HttpServletResponse.SC_FOUND)\n+                        .error(ex).location(redirectUri).setState(state).buildQueryMessage().getLocationUri();\n+            }\n+\n+        } catch (OAuthSystemException e) {\n+            log.error(\"Server error occurred while building error redirect url for application: \" + appName, e);\n+        }\n+        return updatedRedirectUri;\n+    }\n+\n     /**\n      * Method to retrieve the <AllowAdditionalParamsFromErrorUrl> config from the OAuth Configuration.\n      * @return Retrieved config (true or false)\n      */\n     private static boolean isAllowAdditionalParamsFromErrorUrlEnabled() {\n \n-        return Boolean.parseBoolean(IdentityUtil.getProperty(ALLOW_ADDITIONAL_PARAMS_FROM_ERROR_URL));\n+        String isAllowAdditionalParamsEnabled = IdentityUtil.getProperty(ALLOW_ADDITIONAL_PARAMS_FROM_ERROR_URL);\n+\n+        if (StringUtils.isNotBlank(isAllowAdditionalParamsEnabled)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b179af1d4fb8d5a6c79c03332d85f40c1697288f"}, "originalPosition": 76}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c4c36d7512ccc58a34dd12dca9efc851fd4dc97", "author": {"user": {"login": "kasundharmadasa", "name": "Kasun Dharmadasa"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/7c4c36d7512ccc58a34dd12dca9efc851fd4dc97", "committedDate": "2020-09-10T17:12:52Z", "message": "make AllowAdditionalParamsFromErrorUrl cofig to false by default"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NDc0MDIz", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1441#pullrequestreview-486474023", "createdAt": "2020-09-11T04:59:54Z", "commit": {"oid": "7c4c36d7512ccc58a34dd12dca9efc851fd4dc97"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NTU4OTUx", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1441#pullrequestreview-486558951", "createdAt": "2020-09-11T08:00:31Z", "commit": {"oid": "7c4c36d7512ccc58a34dd12dca9efc851fd4dc97"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3138, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}