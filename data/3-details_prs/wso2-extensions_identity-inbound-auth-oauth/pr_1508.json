{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5MzI5MjI5", "number": 1508, "title": "Improve backchannel logout to be triggered during session_terminate event flow and improve sso session binding to check the commonAuthId validity", "bodyText": "Resolves wso2/product-is#10419\nFront port the below PRs\nwso2-support/identity-inbound-auth-oauth#774\nwso2-support/identity-inbound-auth-oauth#780", "createdAt": "2020-11-30T06:52:26Z", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1508", "merged": true, "mergeCommit": {"oid": "1a07036766a02a745eb3bf74f3b7b077350be534"}, "closed": true, "closedAt": "2020-12-02T05:57:31Z", "author": {"login": "piraveena"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdh3YWtgBqjQwNTYzODI4NDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdh9D5UAFqTU0MjExMzQzOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "33b5c1cc08295abe38d42fffdc02ad3b3bf7e8ce", "author": {"user": {"login": "piraveena", "name": "Piraveena Paralogarajah"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/33b5c1cc08295abe38d42fffdc02ad3b3bf7e8ce", "committedDate": "2020-12-01T10:24:49Z", "message": "refactor"}, "afterCommit": {"oid": "be28dfb07b7720445f367b9150c5345873234d02", "author": {"user": {"login": "piraveena", "name": "Piraveena Paralogarajah"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/be28dfb07b7720445f367b9150c5345873234d02", "committedDate": "2020-12-01T10:27:08Z", "message": "Improve backchannel logout to be triggered during session_terminate event flow and improve sso session binding to check the commonAuthId validity"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxNzc1MDky", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1508#pullrequestreview-541775092", "createdAt": "2020-12-01T10:48:51Z", "commit": {"oid": "be28dfb07b7720445f367b9150c5345873234d02"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMDo0ODo1MVrOH8m7oQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMDo0ODo1MVrOH8m7oQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzMxNDQ2NQ==", "bodyText": "shall we merge the nested if condition with this?", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1508#discussion_r533314465", "createdAt": "2020-12-01T10:48:51Z", "author": {"login": "emswbandara"}, "path": "components/org.wso2.carbon.identity.oauth.endpoint/src/main/java/org/wso2/carbon/identity/oauth/endpoint/authz/OAuth2AuthzEndpoint.java", "diffHunk": "@@ -2586,6 +2593,49 @@ private String appendAuthenticatedIDPs(SessionDataCacheEntry sessionDataCacheEnt\n         return redirectURL;\n     }\n \n+    /**\n+     * Store opbscookie in session context.\n+     *\n+     * @param sessionDataCacheEntry SessionDataCacheEntry.\n+     * @param opbscookie            opbscookie value.\n+     */\n+    private void storeOpbsInSessionContext(SessionDataCacheEntry sessionDataCacheEntry, String opbscookie) {\n+\n+        String sessionContextIdentifier = getSessionContextIdentifier(sessionDataCacheEntry);\n+        if (StringUtils.isNotBlank(sessionContextIdentifier)) {\n+            SessionContext sessionContext = FrameworkUtils.getSessionContextFromCache(sessionContextIdentifier);\n+            if (sessionContext != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be28dfb07b7720445f367b9150c5345873234d02"}, "originalPosition": 119}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxNzc1ODYy", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1508#pullrequestreview-541775862", "createdAt": "2020-12-01T10:49:44Z", "commit": {"oid": "be28dfb07b7720445f367b9150c5345873234d02"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMDo0OTo0NFrOH8m-Aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMDo0OTo0NFrOH8m-Aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzMxNTA3NQ==", "bodyText": "let's use multi-line comments", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1508#discussion_r533315075", "createdAt": "2020-12-01T10:49:44Z", "author": {"login": "emswbandara"}, "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/token/bindings/impl/SSOSessionBasedTokenBinder.java", "diffHunk": "@@ -113,6 +118,28 @@ public void clearTokenBindingElements(HttpServletRequest request, HttpServletRes\n     @Override\n     public boolean isValidTokenBinding(Object request, String bindingReference) {\n \n+        try {\n+            String sessionIdentifier = getTokenBindingValue((HttpServletRequest) request);\n+            if (StringUtils.isBlank(sessionIdentifier)) {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\"CommonAuthId cookie is not found in the request.\");\n+                }\n+                return false;\n+            }\n+            // Retrieve session context information using sessionIdentifier in order to check the validity of", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be28dfb07b7720445f367b9150c5345873234d02"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxNzc2NTYy", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1508#pullrequestreview-541776562", "createdAt": "2020-12-01T10:50:38Z", "commit": {"oid": "be28dfb07b7720445f367b9150c5345873234d02"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMDo1MDozOFrOH8nALg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMDo1MDozOFrOH8nALg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzMxNTYzMA==", "bodyText": "let's use StringUtils.isNotBlank", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1508#discussion_r533315630", "createdAt": "2020-12-01T10:50:38Z", "author": {"login": "emswbandara"}, "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/handler/OIDCLogoutEventHandler.java", "diffHunk": "@@ -85,6 +81,73 @@ public String getName() {\n         return \"OIDCLogoutEventHandler\";\n     }\n \n+    private boolean isLogoutInitiatedFromOIDCApp(Event event) {\n+\n+        HttpServletRequest request = getHttpRequestFromEvent(event);\n+        if (request != null) {\n+            if (StringUtils.equals(request.getParameter(TYPE), FrameworkConstants.RequestType.CLAIM_TYPE_OIDC)) {\n+                // If a logout request is triggered from an OIDC app then the OIDCLogoutServlet\n+                // and OIDCLogoutEventHandler both are triggered and the logout request is handled in both\n+                // places. https://github.com/wso2/product-is/issues/6418\n+                return true;\n+            }\n+        }\n+        return false;\n+    }\n+\n+    private String getopbsCookieId(Event event) {\n+\n+        HttpServletRequest request = getHttpRequestFromEvent(event);\n+        String opbsCookie = null;\n+        if (request != null) {\n+            // Get the opbscookie from request.\n+            opbsCookie = getOpbsCookieFromRequest(request);\n+        }\n+        if (StringUtils.isEmpty(opbsCookie)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be28dfb07b7720445f367b9150c5345873234d02"}, "originalPosition": 82}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1a6e4d1d3139de85598482c0137bea08805022f", "author": {"user": {"login": "piraveena", "name": "Piraveena Paralogarajah"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/d1a6e4d1d3139de85598482c0137bea08805022f", "committedDate": "2020-12-01T11:01:24Z", "message": "Improve backchannel logout to be triggered during session_terminate event flow and improve sso session binding to check the commonAuthId validity"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "be28dfb07b7720445f367b9150c5345873234d02", "author": {"user": {"login": "piraveena", "name": "Piraveena Paralogarajah"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/be28dfb07b7720445f367b9150c5345873234d02", "committedDate": "2020-12-01T10:27:08Z", "message": "Improve backchannel logout to be triggered during session_terminate event flow and improve sso session binding to check the commonAuthId validity"}, "afterCommit": {"oid": "d1a6e4d1d3139de85598482c0137bea08805022f", "author": {"user": {"login": "piraveena", "name": "Piraveena Paralogarajah"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/d1a6e4d1d3139de85598482c0137bea08805022f", "committedDate": "2020-12-01T11:01:24Z", "message": "Improve backchannel logout to be triggered during session_terminate event flow and improve sso session binding to check the commonAuthId validity"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxODcxOTcw", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1508#pullrequestreview-541871970", "createdAt": "2020-12-01T13:02:57Z", "commit": {"oid": "d1a6e4d1d3139de85598482c0137bea08805022f"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMzowMjo1N1rOH8rlTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMzowNDozOVrOH8rpFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM5MDY3MQ==", "bodyText": "Better if we could add a description to this param for consistency.", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1508#discussion_r533390671", "createdAt": "2020-12-01T13:02:57Z", "author": {"login": "chamathns"}, "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/backchannellogout/DefaultLogoutTokenBuilder.java", "diffHunk": "@@ -213,20 +238,17 @@ private String getSigningTenantDomain(OAuthAppDO oAuthAppDO) {\n     /**\n      * Returns the OIDCsessionState of the obps cookie.\n      *\n-     * @param request\n+     * @param opbscookie", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1a6e4d1d3139de85598482c0137bea08805022f"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM5MDc2Mw==", "bodyText": "Better if we could add a description to this param for consistency.", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1508#discussion_r533390763", "createdAt": "2020-12-01T13:03:09Z", "author": {"login": "chamathns"}, "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/backchannellogout/LogoutRequestSender.java", "diffHunk": "@@ -89,18 +106,19 @@ public void sendLogoutRequests(HttpServletRequest request) {\n         }\n     }\n \n+\n     /**\n      * Returns a Map with logout tokens and back-channel logut Url of Service providers.\n      *\n-     * @param request\n+     * @param opbsCookie", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1a6e4d1d3139de85598482c0137bea08805022f"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM5MTEzMA==", "bodyText": "Shall we use sentence-case here for the descriptions?", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1508#discussion_r533391130", "createdAt": "2020-12-01T13:03:47Z", "author": {"login": "chamathns"}, "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/backchannellogout/LogoutTokenBuilder.java", "diffHunk": "@@ -38,4 +38,14 @@\n      */\n     Map<String, String> buildLogoutToken(HttpServletRequest request)\n             throws IdentityOAuth2Exception, InvalidOAuthClientException;\n+\n+    /**\n+     * Returns logout token and back-channel logout uri map.\n+     *\n+     * @param opbsCookie opbscookie value\n+     * @return a map of logout tokens and corresponding back-channel logout URLs.\n+     * @throws IdentityOAuth2Exception", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1a6e4d1d3139de85598482c0137bea08805022f"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM5MTYzNg==", "bodyText": "Shall we make use of a comment block here?", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1508#discussion_r533391636", "createdAt": "2020-12-01T13:04:39Z", "author": {"login": "chamathns"}, "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/handler/OIDCLogoutEventHandler.java", "diffHunk": "@@ -85,6 +81,73 @@ public String getName() {\n         return \"OIDCLogoutEventHandler\";\n     }\n \n+    private boolean isLogoutInitiatedFromOIDCApp(Event event) {\n+\n+        HttpServletRequest request = getHttpRequestFromEvent(event);\n+        if (request != null) {\n+            if (StringUtils.equals(request.getParameter(TYPE), FrameworkConstants.RequestType.CLAIM_TYPE_OIDC)) {\n+                // If a logout request is triggered from an OIDC app then the OIDCLogoutServlet\n+                // and OIDCLogoutEventHandler both are triggered and the logout request is handled in both\n+                // places. https://github.com/wso2/product-is/issues/6418", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1a6e4d1d3139de85598482c0137bea08805022f"}, "originalPosition": 67}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d4e7bfdae4cf8f1397da05ea74eebe097efb182", "author": {"user": {"login": "piraveena", "name": "Piraveena Paralogarajah"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/3d4e7bfdae4cf8f1397da05ea74eebe097efb182", "committedDate": "2020-12-01T15:48:03Z", "message": "Add unit tests for storeOpbsInSessionContext flow"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f5f3d6ee7bde42aad792d9a79c21af4378ed506", "author": {"user": {"login": "piraveena", "name": "Piraveena Paralogarajah"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/7f5f3d6ee7bde42aad792d9a79c21af4378ed506", "committedDate": "2020-12-01T15:54:18Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMTEzNDM5", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1508#pullrequestreview-542113439", "createdAt": "2020-12-01T17:05:12Z", "commit": {"oid": "7f5f3d6ee7bde42aad792d9a79c21af4378ed506"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3099, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}