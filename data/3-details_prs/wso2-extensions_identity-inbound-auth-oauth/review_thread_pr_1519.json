{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyMjc2MDc0", "number": 1519, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwODoxMzo1NVrOFHEB0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMDoxNTo1M1rOFHvKDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQyOTUwMzU0OnYy", "diffSide": "RIGHT", "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwODoxMzo1NVrOIIXI6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxMDowMDo0MFrOIIcfcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTYzODYzNQ==", "bodyText": "Can Use StringUtils? WDYT?", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1519#discussion_r545638635", "createdAt": "2020-12-18T08:13:55Z", "author": {"login": "Thumimku"}, "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "diffHunk": "@@ -129,9 +130,9 @@ protected void doGet(HttpServletRequest request, HttpServletResponse response)\n          */\n \n         String redirectURL;\n-        Cookie opBrowserStateCookie = OIDCSessionManagementUtil.getOPBrowserStateCookie(request);\n+        String opBrowserStateCookieValue = getOPBSCookieValue(request);\n \n-        if (opBrowserStateCookie == null) {\n+        if (opBrowserStateCookieValue == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20cc869f2b182df33f2f0d4e6eee9d5a6e549138"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTcyNjMyMQ==", "bodyText": "Yes. We can. It's fixed with b6b16b4.", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1519#discussion_r545726321", "createdAt": "2020-12-18T10:00:40Z", "author": {"login": "chamathns"}, "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "diffHunk": "@@ -129,9 +130,9 @@ protected void doGet(HttpServletRequest request, HttpServletResponse response)\n          */\n \n         String redirectURL;\n-        Cookie opBrowserStateCookie = OIDCSessionManagementUtil.getOPBrowserStateCookie(request);\n+        String opBrowserStateCookieValue = getOPBSCookieValue(request);\n \n-        if (opBrowserStateCookie == null) {\n+        if (opBrowserStateCookieValue == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTYzODYzNQ=="}, "originalCommit": {"oid": "20cc869f2b182df33f2f0d4e6eee9d5a6e549138"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQyOTUwNjQ5OnYy", "diffSide": "RIGHT", "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwODoxNDo0OVrOIIXKeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxMDowMDoxMVrOIIcebQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTYzOTAzMg==", "bodyText": "Can we add a param description", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1519#discussion_r545639032", "createdAt": "2020-12-18T08:14:49Z", "author": {"login": "Thumimku"}, "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "diffHunk": "@@ -238,22 +239,39 @@ protected void doGet(HttpServletRequest request, HttpServletResponse response)\n         response.sendRedirect(getRedirectURL(redirectURL, request));\n     }\n \n+    private String getOPBSCookieValue(HttpServletRequest request) {\n+\n+        Cookie opBrowserStateCookie = OIDCSessionManagementUtil.getOPBrowserStateCookie(request);\n+        if (opBrowserStateCookie != null) {\n+            return opBrowserStateCookie.getValue();\n+        } else {\n+            String sessionDataKey = request.getParameter(OIDCSessionConstants.OIDC_SESSION_DATA_KEY_PARAM);\n+            if (StringUtils.isNotBlank(sessionDataKey)) {\n+                OIDCSessionDataCacheEntry cacheEntry = getSessionDataFromCache(sessionDataKey);\n+                if (cacheEntry != null) {\n+                    return cacheEntry.getParamMap().get(OIDCSessionConstants.OPBS_COOKIE_ID);\n+                }\n+            }\n+        }\n+        return null;\n+    }\n+\n     /**\n      * If postLogoutRedirectUri is send in Logout request parameter then set it as redirect URL.\n      *\n      * @param redirectURL\n-     * @param opBrowserStateCookie\n+     * @param opBrowserStateCookieValue", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20cc869f2b182df33f2f0d4e6eee9d5a6e549138"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTcyNjA2MQ==", "bodyText": "Addressed with b6b16b4.", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1519#discussion_r545726061", "createdAt": "2020-12-18T10:00:11Z", "author": {"login": "chamathns"}, "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "diffHunk": "@@ -238,22 +239,39 @@ protected void doGet(HttpServletRequest request, HttpServletResponse response)\n         response.sendRedirect(getRedirectURL(redirectURL, request));\n     }\n \n+    private String getOPBSCookieValue(HttpServletRequest request) {\n+\n+        Cookie opBrowserStateCookie = OIDCSessionManagementUtil.getOPBrowserStateCookie(request);\n+        if (opBrowserStateCookie != null) {\n+            return opBrowserStateCookie.getValue();\n+        } else {\n+            String sessionDataKey = request.getParameter(OIDCSessionConstants.OIDC_SESSION_DATA_KEY_PARAM);\n+            if (StringUtils.isNotBlank(sessionDataKey)) {\n+                OIDCSessionDataCacheEntry cacheEntry = getSessionDataFromCache(sessionDataKey);\n+                if (cacheEntry != null) {\n+                    return cacheEntry.getParamMap().get(OIDCSessionConstants.OPBS_COOKIE_ID);\n+                }\n+            }\n+        }\n+        return null;\n+    }\n+\n     /**\n      * If postLogoutRedirectUri is send in Logout request parameter then set it as redirect URL.\n      *\n      * @param redirectURL\n-     * @param opBrowserStateCookie\n+     * @param opBrowserStateCookieValue", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTYzOTAzMg=="}, "originalCommit": {"oid": "20cc869f2b182df33f2f0d4e6eee9d5a6e549138"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQyOTUxMDczOnYy", "diffSide": "RIGHT", "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwODoxNjowOFrOIIXM2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxMDowMDowNlrOIIceTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTYzOTY0Mw==", "bodyText": "Can't we put this along with previous line?", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1519#discussion_r545639643", "createdAt": "2020-12-18T08:16:08Z", "author": {"login": "Thumimku"}, "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "diffHunk": "@@ -717,7 +741,8 @@ private void addAuthenticationRequestToRequest(HttpServletRequest request,\n     }\n \n     private void sendRequestToFramework(HttpServletRequest request, HttpServletResponse response, String sessionDataKey,\n-                                        String type) throws ServletException, IOException {\n+                                        String type)\n+            throws ServletException, IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20cc869f2b182df33f2f0d4e6eee9d5a6e549138"}, "originalPosition": 195}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTcyNjAzMA==", "bodyText": "Addressed with b6b16b4.", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1519#discussion_r545726030", "createdAt": "2020-12-18T10:00:06Z", "author": {"login": "chamathns"}, "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "diffHunk": "@@ -717,7 +741,8 @@ private void addAuthenticationRequestToRequest(HttpServletRequest request,\n     }\n \n     private void sendRequestToFramework(HttpServletRequest request, HttpServletResponse response, String sessionDataKey,\n-                                        String type) throws ServletException, IOException {\n+                                        String type)\n+            throws ServletException, IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTYzOTY0Mw=="}, "originalCommit": {"oid": "20cc869f2b182df33f2f0d4e6eee9d5a6e549138"}, "originalPosition": 195}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQyOTUxMTcxOnYy", "diffSide": "RIGHT", "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwODoxNjoyM1rOIIXNXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxMDowMDowMlrOIIceMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTYzOTc3Mg==", "bodyText": "Param description", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1519#discussion_r545639772", "createdAt": "2020-12-18T08:16:23Z", "author": {"login": "Thumimku"}, "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "diffHunk": "@@ -814,11 +839,11 @@ private boolean getOpenIDConnectSkipUserConsent(HttpServletRequest request) thro\n     /**\n      * Sends logout token to registered back-channel logout uris.\n      *\n-     * @param request\n+     * @param opbsCookieValue", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20cc869f2b182df33f2f0d4e6eee9d5a6e549138"}, "originalPosition": 204}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTcyNjAwMA==", "bodyText": "Addressed with b6b16b4.", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1519#discussion_r545726000", "createdAt": "2020-12-18T10:00:02Z", "author": {"login": "chamathns"}, "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "diffHunk": "@@ -814,11 +839,11 @@ private boolean getOpenIDConnectSkipUserConsent(HttpServletRequest request) thro\n     /**\n      * Sends logout token to registered back-channel logout uris.\n      *\n-     * @param request\n+     * @param opbsCookieValue", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTYzOTc3Mg=="}, "originalCommit": {"oid": "20cc869f2b182df33f2f0d4e6eee9d5a6e549138"}, "originalPosition": 204}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQyOTUxNTU4OnYy", "diffSide": "RIGHT", "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwODoxNzoyOFrOIIXPeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxMDo1NzowNFrOIIeUpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTY0MDMxNA==", "bodyText": "We are passing String instead of HttpServletRequest object, Can't this cause an issue in callee?", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1519#discussion_r545640314", "createdAt": "2020-12-18T08:17:28Z", "author": {"login": "Thumimku"}, "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "diffHunk": "@@ -814,11 +839,11 @@ private boolean getOpenIDConnectSkipUserConsent(HttpServletRequest request) thro\n     /**\n      * Sends logout token to registered back-channel logout uris.\n      *\n-     * @param request\n+     * @param opbsCookieValue\n      */\n-    private void doBackChannelLogout(HttpServletRequest request) {\n+    private void doBackChannelLogout(String opbsCookieValue) {\n \n-        LogoutRequestSender.getInstance().sendLogoutRequests(request);\n+        LogoutRequestSender.getInstance().sendLogoutRequests(opbsCookieValue);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20cc869f2b182df33f2f0d4e6eee9d5a6e549138"}, "originalPosition": 210}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTcyNTQ3MQ==", "bodyText": "LogoutRequestSender.getInstance().sendLogoutRequests() has multiple implementations where it can accept a String value as well.", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1519#discussion_r545725471", "createdAt": "2020-12-18T09:59:01Z", "author": {"login": "chamathns"}, "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "diffHunk": "@@ -814,11 +839,11 @@ private boolean getOpenIDConnectSkipUserConsent(HttpServletRequest request) thro\n     /**\n      * Sends logout token to registered back-channel logout uris.\n      *\n-     * @param request\n+     * @param opbsCookieValue\n      */\n-    private void doBackChannelLogout(HttpServletRequest request) {\n+    private void doBackChannelLogout(String opbsCookieValue) {\n \n-        LogoutRequestSender.getInstance().sendLogoutRequests(request);\n+        LogoutRequestSender.getInstance().sendLogoutRequests(opbsCookieValue);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTY0MDMxNA=="}, "originalCommit": {"oid": "20cc869f2b182df33f2f0d4e6eee9d5a6e549138"}, "originalPosition": 210}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTc1NjMyNg==", "bodyText": "ACK", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1519#discussion_r545756326", "createdAt": "2020-12-18T10:57:04Z", "author": {"login": "Thumimku"}, "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "diffHunk": "@@ -814,11 +839,11 @@ private boolean getOpenIDConnectSkipUserConsent(HttpServletRequest request) thro\n     /**\n      * Sends logout token to registered back-channel logout uris.\n      *\n-     * @param request\n+     * @param opbsCookieValue\n      */\n-    private void doBackChannelLogout(HttpServletRequest request) {\n+    private void doBackChannelLogout(String opbsCookieValue) {\n \n-        LogoutRequestSender.getInstance().sendLogoutRequests(request);\n+        LogoutRequestSender.getInstance().sendLogoutRequests(opbsCookieValue);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTY0MDMxNA=="}, "originalCommit": {"oid": "20cc869f2b182df33f2f0d4e6eee9d5a6e549138"}, "originalPosition": 210}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQzNjE1NDk3OnYy", "diffSide": "RIGHT", "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQwNzo1OTozMVrOIJPU9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMDoxNDozM1rOIJTEsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU1OTIyMQ==", "bodyText": "shall we rename this to 'addOPBSCookieValueToCacheEntry'", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1519#discussion_r546559221", "createdAt": "2020-12-21T07:59:31Z", "author": {"login": "emswbandara"}, "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "diffHunk": "@@ -629,24 +648,31 @@ private void sendToFrameworkForLogout(HttpServletRequest request, HttpServletRes\n         AuthenticationRequestCacheEntry authenticationRequestCacheEntry =\n                 new AuthenticationRequestCacheEntry(authenticationRequest);\n         addAuthenticationRequestToRequest(request, authenticationRequestCacheEntry);\n+        OIDCSessionManagementUtil.removeOPBrowserStateCookie(request, response);\n         sendRequestToFramework(request, response, sessionDataKey, FrameworkConstants.RequestType.CLAIM_TYPE_OIDC);\n     }\n \n+    private void addOPBSCookieValueToCache(String opBrowserStateCookieValue, OIDCSessionDataCacheEntry cacheEntry) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6b16b4e9375169a8e8109dead588f7651e3a54b"}, "originalPosition": 123}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYyMDU5Mg==", "bodyText": "+1. Addressed with dda7bf8.", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1519#discussion_r546620592", "createdAt": "2020-12-21T10:14:33Z", "author": {"login": "chamathns"}, "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "diffHunk": "@@ -629,24 +648,31 @@ private void sendToFrameworkForLogout(HttpServletRequest request, HttpServletRes\n         AuthenticationRequestCacheEntry authenticationRequestCacheEntry =\n                 new AuthenticationRequestCacheEntry(authenticationRequest);\n         addAuthenticationRequestToRequest(request, authenticationRequestCacheEntry);\n+        OIDCSessionManagementUtil.removeOPBrowserStateCookie(request, response);\n         sendRequestToFramework(request, response, sessionDataKey, FrameworkConstants.RequestType.CLAIM_TYPE_OIDC);\n     }\n \n+    private void addOPBSCookieValueToCache(String opBrowserStateCookieValue, OIDCSessionDataCacheEntry cacheEntry) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU1OTIyMQ=="}, "originalCommit": {"oid": "b6b16b4e9375169a8e8109dead588f7651e3a54b"}, "originalPosition": 123}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQzNjE1NjIzOnYy", "diffSide": "RIGHT", "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQwODowMDowM1rOIJPVrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMDoxNDoyMVrOIJTERA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU1OTQwNw==", "bodyText": "can paramMap become null here? if so, handle null check", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1519#discussion_r546559407", "createdAt": "2020-12-21T08:00:03Z", "author": {"login": "emswbandara"}, "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "diffHunk": "@@ -629,24 +648,31 @@ private void sendToFrameworkForLogout(HttpServletRequest request, HttpServletRes\n         AuthenticationRequestCacheEntry authenticationRequestCacheEntry =\n                 new AuthenticationRequestCacheEntry(authenticationRequest);\n         addAuthenticationRequestToRequest(request, authenticationRequestCacheEntry);\n+        OIDCSessionManagementUtil.removeOPBrowserStateCookie(request, response);\n         sendRequestToFramework(request, response, sessionDataKey, FrameworkConstants.RequestType.CLAIM_TYPE_OIDC);\n     }\n \n+    private void addOPBSCookieValueToCache(String opBrowserStateCookieValue, OIDCSessionDataCacheEntry cacheEntry) {\n+\n+        ConcurrentMap<String, String> paramMap = cacheEntry.getParamMap();\n+        paramMap.put(OIDCSessionConstants.OPBS_COOKIE_ID, opBrowserStateCookieValue);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6b16b4e9375169a8e8109dead588f7651e3a54b"}, "originalPosition": 126}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYyMDQ4NA==", "bodyText": "Addressed with dda7bf8.", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1519#discussion_r546620484", "createdAt": "2020-12-21T10:14:21Z", "author": {"login": "chamathns"}, "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "diffHunk": "@@ -629,24 +648,31 @@ private void sendToFrameworkForLogout(HttpServletRequest request, HttpServletRes\n         AuthenticationRequestCacheEntry authenticationRequestCacheEntry =\n                 new AuthenticationRequestCacheEntry(authenticationRequest);\n         addAuthenticationRequestToRequest(request, authenticationRequestCacheEntry);\n+        OIDCSessionManagementUtil.removeOPBrowserStateCookie(request, response);\n         sendRequestToFramework(request, response, sessionDataKey, FrameworkConstants.RequestType.CLAIM_TYPE_OIDC);\n     }\n \n+    private void addOPBSCookieValueToCache(String opBrowserStateCookieValue, OIDCSessionDataCacheEntry cacheEntry) {\n+\n+        ConcurrentMap<String, String> paramMap = cacheEntry.getParamMap();\n+        paramMap.put(OIDCSessionConstants.OPBS_COOKIE_ID, opBrowserStateCookieValue);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU1OTQwNw=="}, "originalCommit": {"oid": "b6b16b4e9375169a8e8109dead588f7651e3a54b"}, "originalPosition": 126}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQzNjE4MDcxOnYy", "diffSide": "RIGHT", "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQwODowOTowM1rOIJPjtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMDoxNDoxN1rOIJTEJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU2Mjk5OQ==", "bodyText": "Need debug logs to indicate how the obps value was resolved.", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1519#discussion_r546562999", "createdAt": "2020-12-21T08:09:03Z", "author": {"login": "mefarazath"}, "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "diffHunk": "@@ -238,22 +239,39 @@ protected void doGet(HttpServletRequest request, HttpServletResponse response)\n         response.sendRedirect(getRedirectURL(redirectURL, request));\n     }\n \n+    private String getOPBSCookieValue(HttpServletRequest request) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6b16b4e9375169a8e8109dead588f7651e3a54b"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYyMDQ1NA==", "bodyText": "Addressed with dda7bf8.", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1519#discussion_r546620454", "createdAt": "2020-12-21T10:14:17Z", "author": {"login": "chamathns"}, "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "diffHunk": "@@ -238,22 +239,39 @@ protected void doGet(HttpServletRequest request, HttpServletResponse response)\n         response.sendRedirect(getRedirectURL(redirectURL, request));\n     }\n \n+    private String getOPBSCookieValue(HttpServletRequest request) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU2Mjk5OQ=="}, "originalCommit": {"oid": "b6b16b4e9375169a8e8109dead588f7651e3a54b"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQzNjE4NDc1OnYy", "diffSide": "RIGHT", "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQwODoxMDozOFrOIJPmIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMDoxNDoxMFrOIJTD9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU2MzYxOA==", "bodyText": "I prefer to rename this something like opBrowserState?\nobps cookie was one way to track the opBrowserState. And in the subsequent requests where the cookie is not present we are actually retrieving the same opBrowserState using some other means.", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1519#discussion_r546563618", "createdAt": "2020-12-21T08:10:38Z", "author": {"login": "mefarazath"}, "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "diffHunk": "@@ -129,9 +130,9 @@ protected void doGet(HttpServletRequest request, HttpServletResponse response)\n          */\n \n         String redirectURL;\n-        Cookie opBrowserStateCookie = OIDCSessionManagementUtil.getOPBrowserStateCookie(request);\n+        String opBrowserStateCookieValue = getOPBSCookieValue(request);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6b16b4e9375169a8e8109dead588f7651e3a54b"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYyMDQwNw==", "bodyText": "+1. Addressed with dda7bf8.", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1519#discussion_r546620407", "createdAt": "2020-12-21T10:14:10Z", "author": {"login": "chamathns"}, "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "diffHunk": "@@ -129,9 +130,9 @@ protected void doGet(HttpServletRequest request, HttpServletResponse response)\n          */\n \n         String redirectURL;\n-        Cookie opBrowserStateCookie = OIDCSessionManagementUtil.getOPBrowserStateCookie(request);\n+        String opBrowserStateCookieValue = getOPBSCookieValue(request);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU2MzYxOA=="}, "originalCommit": {"oid": "b6b16b4e9375169a8e8109dead588f7651e3a54b"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQzNjU2OTc0OnYy", "diffSide": "RIGHT", "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMDoxNTo1M1rOIJTHUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMDoxNTo1M1rOIJTHUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYyMTI2Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            log.debug(\"Resolving opBrowserState from the opBrowserState Cookie in the inbound request.\");\n          \n          \n            \n                            log.debug(\"Resolving opBrowserState from the 'obps' Cookie in the inbound request.\");", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1519#discussion_r546621267", "createdAt": "2020-12-21T10:15:53Z", "author": {"login": "mefarazath"}, "path": "components/org.wso2.carbon.identity.oidc.session/src/main/java/org/wso2/carbon/identity/oidc/session/servlet/OIDCLogoutServlet.java", "diffHunk": "@@ -238,22 +239,52 @@ protected void doGet(HttpServletRequest request, HttpServletResponse response)\n         response.sendRedirect(getRedirectURL(redirectURL, request));\n     }\n \n+    private String getOPBrowserState(HttpServletRequest request) {\n+\n+        Cookie opBrowserStateCookie = OIDCSessionManagementUtil.getOPBrowserStateCookie(request);\n+        if (opBrowserStateCookie != null) {\n+            if (log.isDebugEnabled()) {\n+                log.debug(\"Resolving opBrowserState from the opBrowserState Cookie in the inbound request.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dda7bf80cc7f604b87669ae653ed1ac12089cbb2"}, "originalPosition": 56}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3557, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}