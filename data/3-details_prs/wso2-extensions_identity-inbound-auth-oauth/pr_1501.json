{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5Nzg1MDU2", "number": 1501, "title": "Fix the issue with token revocation when account disabling/locking", "bodyText": "Proposed changes in this pull request\nA new identity claim is created in the AccountLockHandler and AccountDisableHandler during in postSetUserClaimsValue event[1] flow. So this will trigger doPreSetUserClaimValues event again and it will remove the exisiting IdentityCoreConstants.USER_ACCOUNT_STATE from the threadlocal [2] . Due to this, the accountLock/accountDisable status will be removed from the threadlocal.\nIn this PR, introduced a new OAuthEventHandler with higher priority than AccountLockHandler and AccounntDisableHandler\n[1]https://github.com/wso2-extensions/identity-event-handler-account-lock/blob/master/components/org.wso2.carbon.identity.handler.event.account.lock/src/main/java/org/wso2/carbon/identity/handler/event/account/lock/AccountLockHandler.java#L561\n[2]https://github.com/wso2-extensions/identity-governance/blob/master/components/org.wso2.carbon.identity.governance/src/main/java/org/wso2/carbon/identity/governance/listener/IdentityMgtEventListener.java#L157\n\n\n\nWhen should this PR be merged\nRelated PRs\nwso2-extensions/identity-event-handler-account-lock#78\nwso2/carbon-identity-framework#3250", "createdAt": "2020-11-12T10:31:57Z", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1501", "merged": true, "mergeCommit": {"oid": "d1dc5e14a8d256da5805642117c781f549321885"}, "closed": true, "closedAt": "2020-11-12T17:55:05Z", "author": {"login": "piraveena"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbwCFxgH2gAyNTE5Nzg1MDU2OjE4MjMxMjA2YzBlNjIwNjI3YzNmOTdmNTNkZDNlZGQ4YTJmMDUwYmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdb1c0NAFqTUyOTI4NDc5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "18231206c0e620627c3f97f53dd3edd8a2f050bd", "author": {"user": {"login": "piraveena", "name": "Piraveena Paralogarajah"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/18231206c0e620627c3f97f53dd3edd8a2f050bd", "committedDate": "2020-11-12T10:30:55Z", "message": "Fix the issue with token revocation when account diabling/locking"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee3988c20e4b901381ba76fdff28d1f26dabc1ff", "author": {"user": {"login": "piraveena", "name": "Piraveena Paralogarajah"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/ee3988c20e4b901381ba76fdff28d1f26dabc1ff", "committedDate": "2020-11-12T10:38:32Z", "message": "Resolve conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dadaefc96e77c0794409c2c1e710c30f60280f46", "author": {"user": {"login": "piraveena", "name": "Piraveena Paralogarajah"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/dadaefc96e77c0794409c2c1e710c30f60280f46", "committedDate": "2020-11-12T10:40:30Z", "message": "Merge remote-tracking branch 'piraveena/issue10101' into issue10101\n\n# Conflicts:\n#\tcomponents/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/internal/OAuthServiceComponent.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59ec3da2b0e6f34cefc4861aabf86d8c942543d3", "author": {"user": {"login": "piraveena", "name": "Piraveena Paralogarajah"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/59ec3da2b0e6f34cefc4861aabf86d8c942543d3", "committedDate": "2020-11-12T11:42:55Z", "message": "Refactor"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f73b957294f3644d67159f260c3031f8535253b6", "author": {"user": {"login": "piraveena", "name": "Piraveena Paralogarajah"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/f73b957294f3644d67159f260c3031f8535253b6", "committedDate": "2020-11-12T13:06:27Z", "message": "Refactoring common methods in EventLister to OAuthUtil"}, "afterCommit": {"oid": "a156d1c769148e1d7a739b97ec08ab1b2d0e1445", "author": {"user": {"login": "piraveena", "name": "Piraveena Paralogarajah"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/a156d1c769148e1d7a739b97ec08ab1b2d0e1445", "committedDate": "2020-11-12T13:29:28Z", "message": "Move common methods in EventListner and EventHandler to OAuthUtil"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5MTAyNTI0", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1501#pullrequestreview-529102524", "createdAt": "2020-11-12T13:49:51Z", "commit": {"oid": "a156d1c769148e1d7a739b97ec08ab1b2d0e1445"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMzo0OTo1MlrOHx7lAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMzo0OTo1MlrOHx7lAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjExODQwMQ==", "bodyText": "we have to check both POST_SET_USER_CLAIMS and POST_SET_USER_CLAIM events", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1501#discussion_r522118401", "createdAt": "2020-11-12T13:49:52Z", "author": {"login": "IsuraD"}, "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/listener/IdentityOauthEventHandler.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.oauth.listener;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.identity.base.IdentityRuntimeException;\n+import org.wso2.carbon.identity.core.bean.context.MessageContext;\n+import org.wso2.carbon.identity.core.handler.InitConfig;\n+import org.wso2.carbon.identity.core.util.IdentityCoreConstants;\n+import org.wso2.carbon.identity.core.util.IdentityUtil;\n+import org.wso2.carbon.identity.event.IdentityEventConstants;\n+import org.wso2.carbon.identity.event.IdentityEventException;\n+import org.wso2.carbon.identity.event.event.Event;\n+import org.wso2.carbon.identity.event.handler.AbstractEventHandler;\n+import org.wso2.carbon.identity.oauth.OAuthUtil;\n+import org.wso2.carbon.user.core.UserCoreConstants;\n+import org.wso2.carbon.user.core.UserStoreException;\n+import org.wso2.carbon.user.core.UserStoreManager;\n+\n+/**\n+ * This is an event handler listening for some of the core user management operations.\n+ */\n+public class IdentityOauthEventHandler extends AbstractEventHandler {\n+\n+    private static final Log log = LogFactory.getLog(IdentityOauthEventHandler.class);\n+\n+    public String getName() {\n+\n+        return \"identityOauthEventHandler\";\n+    }\n+\n+    public String getFriendlyName() {\n+\n+        return \"Identity Oauth Event Handler\";\n+    }\n+\n+    @Override\n+    public void init(InitConfig configuration) throws IdentityRuntimeException {\n+\n+        super.init(configuration);\n+    }\n+\n+    @Override\n+    public int getPriority(MessageContext messageContext) {\n+\n+        int priority = super.getPriority(messageContext);\n+        if (priority == -1) {\n+            priority = 51;\n+        }\n+        return priority;\n+    }\n+\n+\n+    @Override\n+    public void handleEvent(Event event) throws IdentityEventException {\n+\n+        if (IdentityEventConstants.Event.POST_SET_USER_CLAIMS.equals(event.getEventName())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a156d1c769148e1d7a739b97ec08ab1b2d0e1445"}, "originalPosition": 74}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5MTAzOTgw", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1501#pullrequestreview-529103980", "createdAt": "2020-11-12T13:51:28Z", "commit": {"oid": "a156d1c769148e1d7a739b97ec08ab1b2d0e1445"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMzo1MToyOFrOHx7pSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMzo1MToyOFrOHx7pSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjExOTQ5OA==", "bodyText": "Isn't this happening in IdentityOauthEventHandler?", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1501#discussion_r522119498", "createdAt": "2020-11-12T13:51:28Z", "author": {"login": "IsuraD"}, "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/listener/IdentityOathEventListener.java", "diffHunk": "@@ -140,9 +130,7 @@ public boolean doPostSetUserClaimValues(String userName, Map<String, String> cla\n         if (!isEnable()) {\n             return true;\n         }\n-        return revokeTokensOfLockedUser(userName, userStoreManager) &&\n-                revokeTokensOfDisabledUser(userName, userStoreManager)\n-                && removeUserClaimsFromCache(userName, userStoreManager);\n+        return OAuthUtil.removeUserClaimsFromCache(userName, userStoreManager);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a156d1c769148e1d7a739b97ec08ab1b2d0e1445"}, "originalPosition": 67}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5MTA0MDY0", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1501#pullrequestreview-529104064", "createdAt": "2020-11-12T13:51:33Z", "commit": {"oid": "a156d1c769148e1d7a739b97ec08ab1b2d0e1445"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMzo1MTozNFrOHx7phQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMzo1MTozNFrOHx7phQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjExOTU1Nw==", "bodyText": "Isn't this happening in IdentityOauthEventHandler?", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1501#discussion_r522119557", "createdAt": "2020-11-12T13:51:34Z", "author": {"login": "IsuraD"}, "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/listener/IdentityOathEventListener.java", "diffHunk": "@@ -130,7 +120,7 @@ public boolean doPostSetUserClaimValue(String userName, UserStoreManager userSto\n         }\n         return revokeTokensOfLockedUser(userName, userStoreManager) &&\n                 revokeTokensOfDisabledUser(userName, userStoreManager)\n-                && removeUserClaimsFromCache(userName, userStoreManager);\n+                && OAuthUtil.removeUserClaimsFromCache(userName, userStoreManager);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a156d1c769148e1d7a739b97ec08ab1b2d0e1445"}, "originalPosition": 56}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a156d1c769148e1d7a739b97ec08ab1b2d0e1445", "author": {"user": {"login": "piraveena", "name": "Piraveena Paralogarajah"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/a156d1c769148e1d7a739b97ec08ab1b2d0e1445", "committedDate": "2020-11-12T13:29:28Z", "message": "Move common methods in EventListner and EventHandler to OAuthUtil"}, "afterCommit": {"oid": "a9fd24f000582a162ddc72e5798ea48b0b1d1988", "author": {"user": {"login": "piraveena", "name": "Piraveena Paralogarajah"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/a9fd24f000582a162ddc72e5798ea48b0b1d1988", "committedDate": "2020-11-12T14:04:21Z", "message": "Move common methods in EventListner and EventHandler to OAuthUtil"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "648fa45148b9a49e463760d61a1821b1ffd782e9", "author": {"user": {"login": "piraveena", "name": "Piraveena Paralogarajah"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/648fa45148b9a49e463760d61a1821b1ffd782e9", "committedDate": "2020-11-12T14:11:01Z", "message": "Move common methods in EventListner and EventHandler to OAuthUtil"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a9fd24f000582a162ddc72e5798ea48b0b1d1988", "author": {"user": {"login": "piraveena", "name": "Piraveena Paralogarajah"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/a9fd24f000582a162ddc72e5798ea48b0b1d1988", "committedDate": "2020-11-12T14:04:21Z", "message": "Move common methods in EventListner and EventHandler to OAuthUtil"}, "afterCommit": {"oid": "648fa45148b9a49e463760d61a1821b1ffd782e9", "author": {"user": {"login": "piraveena", "name": "Piraveena Paralogarajah"}}, "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/648fa45148b9a49e463760d61a1821b1ffd782e9", "committedDate": "2020-11-12T14:11:01Z", "message": "Move common methods in EventListner and EventHandler to OAuthUtil"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5Mjg0Nzk0", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1501#pullrequestreview-529284794", "createdAt": "2020-11-12T16:49:38Z", "commit": {"oid": "648fa45148b9a49e463760d61a1821b1ffd782e9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3180, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}