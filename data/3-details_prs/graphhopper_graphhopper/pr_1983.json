{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxMDk0OTE2", "number": 1983, "title": "Add config option `preparation_profile` to allow cross-querying in hybrid mode", "bodyText": "Fixes #1980. @karussell can you check if this way this is also useful for #1776?\nThis is how it works\nprofiles:\n  - name: my_car\n    vehicle: car\n    weighting: some_weighting\n  - name: my_adjusted_car\n    vehicle: car\n    weighting: other_weighting\nlm_profiles:\n   # this means we will calculate landmarks for the 'my_car' profile\n  - name: my_car \n  # this means we do *not* calculate landmarks for the 'my_adjusted_car', but we can use still use \n  # the 'my_adjusted_car' profile in hybrid mode and it will use the landmarks from the 'my_car' profile\n  - name: my_adjusted_car\n    preparation_profile: my_car", "createdAt": "2020-04-08T21:40:19Z", "url": "https://github.com/graphhopper/graphhopper/pull/1983", "merged": true, "mergeCommit": {"oid": "7bee0e42ac6b13fe707699964120ed081c6f3ff7"}, "closed": true, "closedAt": "2020-04-14T10:33:11Z", "author": {"login": "easbar"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVu3WfgH2gAyNDAxMDk0OTE2OmJlYThmMzQxYmNhNjJhMTY1YWFkN2I0ZmI1OWRiNTYxYTE1MDJmNWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXg539gH2gAyNDAxMDk0OTE2OmI5ZjJiZmU3NGIwYmY0NTg3YzU5MTIxNjljYjc2YWRjOTU3MGIwYTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bea8f341bca62a165aad7b4fb59db561a1502f5d", "author": {"user": {"login": "easbar", "name": "Andi"}}, "url": "https://github.com/graphhopper/graphhopper/commit/bea8f341bca62a165aad7b4fb59db561a1502f5d", "committedDate": "2020-04-08T21:34:35Z", "message": "Add config option `preparation_profile` for LM profiles to be able to cross-query between profiles"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMzU2NDMz", "url": "https://github.com/graphhopper/graphhopper/pull/1983#pullrequestreview-390356433", "createdAt": "2020-04-08T21:49:04Z", "commit": {"oid": "bea8f341bca62a165aad7b4fb59db561a1502f5d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMTo0OTowNFrOGDCNdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMTo0OTowNFrOGDCNdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgzNTEyNA==", "bodyText": "This example might be a bit artificial, because we can also just use profile1 and change the distance factor on every request, but creating a dedicated profile for this illustrates the new feature here: We can setup a profile on the server side and then do no longer have to specify the different parameters for every request (like the distance factor) and at the same time we do not need an extra landmark calculation for this. This should be useful for #1776 when we want to setup a complex profile and then just select it by using the profile parameter (which btw is still missing on the web layer (#1934)).", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r405835124", "createdAt": "2020-04-08T21:49:04Z", "author": {"login": "easbar"}, "path": "reader-osm/src/test/java/com/graphhopper/GraphHopperIT.java", "diffHunk": "@@ -1356,6 +1356,54 @@ public void testFlexMode_631() {\n         // note: combining hybrid & speed mode is currently not possible and should be avoided: #1082\n     }\n \n+    @Test\n+    public void testCrossQuery() {\n+        final String profile1 = \"p1\";\n+        final String profile2 = \"p2\";\n+        final String profile3 = \"p3\";\n+        final String vehicle = \"car\";\n+        GraphHopper hopper = createGraphHopper(vehicle).\n+                setOSMFile(MONACO).\n+                setProfiles(\n+                        new ProfileConfig(profile1).setVehicle(\"car\").setWeighting(\"short_fastest\").putHint(\"short_fastest.distance_factor\", 0.07),\n+                        new ProfileConfig(profile2).setVehicle(\"car\").setWeighting(\"short_fastest\").putHint(\"short_fastest.distance_factor\", 0.10),\n+                        new ProfileConfig(profile3).setVehicle(\"car\").setWeighting(\"short_fastest\").putHint(\"short_fastest.distance_factor\", 0.15)\n+                ).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bea8f341bca62a165aad7b4fb59db561a1502f5d"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMzU3MTM5", "url": "https://github.com/graphhopper/graphhopper/pull/1983#pullrequestreview-390357139", "createdAt": "2020-04-08T21:50:23Z", "commit": {"oid": "bea8f341bca62a165aad7b4fb59db561a1502f5d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMTo1MDoyM1rOGDCPug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMTo1MDoyM1rOGDCPug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgzNTcwNg==", "bodyText": "This is a good use-case for the new feature: We use the same landmarks for both LM profiles (with and without turn costs).", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r405835706", "createdAt": "2020-04-08T21:50:23Z", "author": {"login": "easbar"}, "path": "tools/src/main/java/com/graphhopper/tools/Measurement.java", "diffHunk": "@@ -304,11 +304,10 @@ private GraphHopperConfig createConfigFromArgs(PMap args) {\n         ghConfig.setCHProfiles(chProfiles);\n         List<LMProfileConfig> lmProfiles = new ArrayList<>();\n         if (useLM) {\n-            // as currently we do not allow cross-querying LM with turn costs=true/false we have to add both\n-            // profiles and this currently leads to two identical LM preparations\n             lmProfiles.add(new LMProfileConfig(\"profile_no_tc\"));\n             if (turnCosts)\n-                lmProfiles.add(new LMProfileConfig(\"profile_tc\"));\n+                // no need for a second LM preparation, we can do cross queries here\n+                lmProfiles.add(new LMProfileConfig(\"profile_tc\").setPreparationProfile(\"profile_no_tc\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bea8f341bca62a165aad7b4fb59db561a1502f5d"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51bcb301625ed763edd07fde50aac109bcee4edd", "author": {"user": {"login": "easbar", "name": "Andi"}}, "url": "https://github.com/graphhopper/graphhopper/commit/51bcb301625ed763edd07fde50aac109bcee4edd", "committedDate": "2020-04-08T22:01:58Z", "message": "Minor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c646f75d2a02c754b4ce983ab64daaf852797b72", "author": {"user": {"login": "easbar", "name": "Andi"}}, "url": "https://github.com/graphhopper/graphhopper/commit/c646f75d2a02c754b4ce983ab64daaf852797b72", "committedDate": "2020-04-08T22:08:24Z", "message": "Merge branch 'master' into preparation_profiles"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMzE2MTM3", "url": "https://github.com/graphhopper/graphhopper/pull/1983#pullrequestreview-392316137", "createdAt": "2020-04-13T17:55:42Z", "commit": {"oid": "c646f75d2a02c754b4ce983ab64daaf852797b72"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNzo1NTo0MlrOGEvGKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxODowMzoyNFrOGEvXqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYxOTExMg==", "bodyText": "I would use the Java \"this\" but I have no good arguments :)", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r407619112", "createdAt": "2020-04-13T17:55:42Z", "author": {"login": "karussell"}, "path": "api/src/main/java/com/graphhopper/config/LMProfileConfig.java", "diffHunk": "@@ -28,6 +28,7 @@\n  */\n public class LMProfileConfig {\n     private String profile = \"\";\n+    private String preparationProfile = \"self\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c646f75d2a02c754b4ce983ab64daaf852797b72"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyMDA3Mg==", "bodyText": "Shouldn't we exclude all additional parameters earlier? I mean which parameters could be useful when we reuse the preparation?", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r407620072", "createdAt": "2020-04-13T17:57:21Z", "author": {"login": "karussell"}, "path": "api/src/main/java/com/graphhopper/config/LMProfileConfig.java", "diffHunk": "@@ -47,17 +48,35 @@ void setProfile(String profile) {\n         this.profile = profile;\n     }\n \n+    public boolean usesOtherPreparation() {\n+        return !preparationProfile.equals(\"self\");\n+    }\n+\n+    public String getPreparationProfile() {\n+        return preparationProfile;\n+    }\n+\n+    public LMProfileConfig setPreparationProfile(String preparationProfile) {\n+        validateProfileName(preparationProfile);\n+        if (maximumLMWeight >= 0)\n+            throw new IllegalArgumentException(\"Using non-default maximum_lm_weight and preparation_profile at the same time is not allowed\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c646f75d2a02c754b4ce983ab64daaf852797b72"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyMDg2NA==", "bodyText": "I would introduce an \"advanced\" section or even move this into the docs and link to them from here as this is very special and might be too confusing?", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r407620864", "createdAt": "2020-04-13T17:58:42Z", "author": {"login": "karussell"}, "path": "config-example.yml", "diffHunk": "@@ -62,7 +62,11 @@ graphhopper:\n \n   # Hybrid mode:\n   # Similar to speed mode, the hybrid mode (Landmarks, LM) also speeds up routing by doing calculating auxiliary data\n-  # in advance. Its not as fast as speed mode, but more flexible.\n+  # in advance. Its not as fast as speed mode, but more flexible. It is possible to use the same preparation for multiple\n+  # profiles which saves memory and preparation time. To do this use e.g. `preparation_profile: my_other_profile` where\n+  # `my_other_profile` is the name of another profile for which an LM profile exists.\n+  # Important: This only will give correct routing results if the weights calculated for the profile are equal or\n+  # larger (for every edge) than those calculated for the profile that was used for the preparation (`my_other_profile`)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c646f75d2a02c754b4ce983ab64daaf852797b72"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyMjA0Mg==", "bodyText": "What about always using getPreparationProfile here that uses the method usesOtherPreparation internally?", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r407622042", "createdAt": "2020-04-13T18:00:30Z", "author": {"login": "karussell"}, "path": "core/src/main/java/com/graphhopper/GraphHopper.java", "diffHunk": "@@ -861,7 +872,15 @@ public RoutingAlgorithmFactory getAlgorithmFactory(String profile, boolean disab\n         if (chPreparationHandler.isEnabled() && !disableCH) {\n             return chPreparationHandler.getAlgorithmFactory(profile);\n         } else if (lmPreparationHandler.isEnabled() && !disableLM) {\n-            return lmPreparationHandler.getAlgorithmFactory(profile);\n+            for (LMProfileConfig lmp : lmPreparationHandler.getLMProfileConfigs()) {\n+                if (lmp.getProfile().equals(profile)) {\n+                    return lmp.usesOtherPreparation()\n+                            // cross-querying\n+                            ? lmPreparationHandler.getAlgorithmFactory(lmp.getPreparationProfile())\n+                            : lmPreparationHandler.getAlgorithmFactory(lmp.getProfile());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c646f75d2a02c754b4ce983ab64daaf852797b72"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyMzU5NQ==", "bodyText": "The first one is likely still required as snake might do maximum_l_m_weight ... but not tested this.", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r407623595", "createdAt": "2020-04-13T18:03:24Z", "author": {"login": "karussell"}, "path": "web-api/src/main/java/com/graphhopper/jackson/LMProfileConfigMixIn.java", "diffHunk": "@@ -21,6 +21,10 @@\n import com.fasterxml.jackson.annotation.JsonProperty;\n \n public interface LMProfileConfigMixIn {\n+    // todonow: maybe both of these are no longer needed because of snake case module?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c646f75d2a02c754b4ce983ab64daaf852797b72"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ca2c9df8aa226cd1cbfa05cbfc7219292f32ef3", "author": {"user": {"login": "easbar", "name": "Andi"}}, "url": "https://github.com/graphhopper/graphhopper/commit/7ca2c9df8aa226cd1cbfa05cbfc7219292f32ef3", "committedDate": "2020-04-14T08:30:00Z", "message": "self -> this"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb3913b406fe8e165a71d95834d0167c7ac5cd7b", "author": {"user": {"login": "easbar", "name": "Andi"}}, "url": "https://github.com/graphhopper/graphhopper/commit/fb3913b406fe8e165a71d95834d0167c7ac5cd7b", "committedDate": "2020-04-14T08:34:18Z", "message": "Remove snake case jackson rule"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ea9b5b97765b08d1c6065e46cad581fb86516fc", "author": {"user": {"login": "easbar", "name": "Andi"}}, "url": "https://github.com/graphhopper/graphhopper/commit/8ea9b5b97765b08d1c6065e46cad581fb86516fc", "committedDate": "2020-04-14T08:37:42Z", "message": "Split docs into normal and advanced usage."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4955267a20924fa0287255841521d148dce5f75a", "author": {"user": {"login": "easbar", "name": "Andi"}}, "url": "https://github.com/graphhopper/graphhopper/commit/4955267a20924fa0287255841521d148dce5f75a", "committedDate": "2020-04-14T10:00:30Z", "message": "Merge branch 'master' into preparation_profiles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5f61bae130964e6695262669667887155cb2999", "author": {"user": {"login": "easbar", "name": "Andi"}}, "url": "https://github.com/graphhopper/graphhopper/commit/b5f61bae130964e6695262669667887155cb2999", "committedDate": "2020-04-14T10:05:42Z", "message": "Put back checks for edge_based and weighting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9f2bfe74b0bf4587c5912169cb76adc9570b0a9", "author": {"user": {"login": "easbar", "name": "Andi"}}, "url": "https://github.com/graphhopper/graphhopper/commit/b9f2bfe74b0bf4587c5912169cb76adc9570b0a9", "committedDate": "2020-04-14T10:26:31Z", "message": "Merge branch 'master' into preparation_profiles"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4628, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}