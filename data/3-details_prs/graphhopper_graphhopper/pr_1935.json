{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxMjkzODI4", "number": 1935, "title": "Add 100m radius restriction to point hint matches", "bodyText": "Fixes #1828\nNameSimilarityEdgeFilter has a circle of radius 100m around the original point. It then looks up the bounding box of the edges and see if they intersect with the circle. This is to help the issue where for some reason or another, it fails to match with the correct road and ends up matching one far away.\nI've added a test to make sure it only matches nearby points. For the majority of the matching tests we're only testing name similarity so I used a mock node access that gives 0 distance between the nodes and overloaded the methods.", "createdAt": "2020-02-28T09:39:43Z", "url": "https://github.com/graphhopper/graphhopper/pull/1935", "merged": true, "mergeCommit": {"oid": "7d1f8c855945f93a38f587a1bdbb4b1982e138f7"}, "closed": true, "closedAt": "2020-02-28T14:57:10Z", "author": {"login": "samruston"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIsh85gH2gAyMzgxMjkzODI4OmE5MzM0ZjY2NmFhMWEzNWRmZTgyOWUzN2YxNzE3MDkwMjcyZDAzYTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIw7sJgH2gAyMzgxMjkzODI4Ojc3ZmQzMjFlYjUxMDc1MTRjZDk2OTA1M2QwODM4YTljMGMzYzg3OTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a9334f666aa1a35dfe829e37f1717090272d03a4", "author": {"user": {"login": "samruston", "name": "Sam Ruston"}}, "url": "https://github.com/graphhopper/graphhopper/commit/a9334f666aa1a35dfe829e37f1717090272d03a4", "committedDate": "2020-02-28T09:30:23Z", "message": "Add 100m radius restriction to point hint matches"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NDI0MDM3", "url": "https://github.com/graphhopper/graphhopper/pull/1935#pullrequestreview-366424037", "createdAt": "2020-02-28T14:12:52Z", "commit": {"oid": "a9334f666aa1a35dfe829e37f1717090272d03a4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNDoxMjo1MlrOFv2QFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNDoxMzoyMlrOFv2RIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTcxNjI0Nw==", "bodyText": "This would be better to duplicate and keep private", "url": "https://github.com/graphhopper/graphhopper/pull/1935#discussion_r385716247", "createdAt": "2020-02-28T14:12:52Z", "author": {"login": "karussell"}, "path": "core/src/main/java/com/graphhopper/storage/GraphEdgeIdFinder.java", "diffHunk": "@@ -239,7 +239,7 @@ public BlockArea setQueryGraph(QueryGraph queryGraph) {\n         }\n     }\n \n-    private static BBox createBBox(NodeAccess na, EdgeIteratorState edgeState) {\n+    public static BBox createBBox(NodeAccess na, EdgeIteratorState edgeState) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9334f666aa1a35dfe829e37f1717090272d03a4"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTcxNjUxNQ==", "bodyText": "Can you make the radius configurable i.e. just move to a constructor parameter (and call it with 100 in the templates or something)?", "url": "https://github.com/graphhopper/graphhopper/pull/1935#discussion_r385716515", "createdAt": "2020-02-28T14:13:22Z", "author": {"login": "karussell"}, "path": "core/src/main/java/com/graphhopper/routing/util/NameSimilarityEdgeFilter.java", "diffHunk": "@@ -81,21 +86,26 @@\n     private static final Pattern WORD_CHAR = Pattern.compile(\"\\\\p{LD}+\");\n     private static final JaroWinkler jaroWinkler = new JaroWinkler();\n     private static final double JARO_WINKLER_ACCEPT_FACTOR = .9;\n+    private static final double WITHIN_RADIUS_METERS = 100;\n     private final EdgeFilter edgeFilter;\n     private final String pointHint;\n     private final Map<String, String> rewriteMap;\n+    private final Circle pointCircle;\n+    private final NodeAccess nodeAccess;\n \n-    public NameSimilarityEdgeFilter(EdgeFilter edgeFilter, String pointHint) {\n-        this(edgeFilter, pointHint, DEFAULT_REWRITE_MAP);\n+    public NameSimilarityEdgeFilter(EdgeFilter edgeFilter, NodeAccess nodeAccess, GHPoint point, String pointHint) {\n+        this(edgeFilter, nodeAccess, pointHint, point, DEFAULT_REWRITE_MAP);\n     }\n \n     /**\n      * @param rewriteMap maps abbreviations to its longer form\n      */\n-    public NameSimilarityEdgeFilter(EdgeFilter edgeFilter, String pointHint, Map<String, String> rewriteMap) {\n+    public NameSimilarityEdgeFilter(EdgeFilter edgeFilter, NodeAccess nodeAccess, String pointHint, GHPoint point, Map<String, String> rewriteMap) {\n         this.edgeFilter = edgeFilter;\n         this.rewriteMap = rewriteMap;\n+        this.nodeAccess = nodeAccess;\n         this.pointHint = prepareName(removeRelation(pointHint == null ? \"\" : pointHint));\n+        this.pointCircle = new Circle(point.lat, point.lon, WITHIN_RADIUS_METERS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9334f666aa1a35dfe829e37f1717090272d03a4"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77fd321eb5107514cd969053d0838a9c0c3c8799", "author": {"user": {"login": "samruston", "name": "Sam Ruston"}}, "url": "https://github.com/graphhopper/graphhopper/commit/77fd321eb5107514cd969053d0838a9c0c3c8799", "committedDate": "2020-02-28T14:38:07Z", "message": "Added requested changes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4589, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}