{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyMDkzMTk5", "number": 1891, "title": "Remove routing algorithm factory decorator abstraction", "bodyText": "Fixes #1889.\n\nThe decorator abstraction is gone, GraphHopper is now fully aware of CH & LM (well it was before, but it no longer allows adding other routing decorators it knows nothing more than the interface about).\nIts also no longer possible to combine different decorators (CH+LM, which was implemented, but already disabled before this PR).\nI renamed the previous CH/LMRoutingAlgoFactoryDecorators to CH/LMPreparationHandler.\nDisabling LM when there is only LM (no CH) preparation is working now (see corresponding test in GraphHopperIT) and c.f. #1889.", "createdAt": "2020-02-06T20:19:44Z", "url": "https://github.com/graphhopper/graphhopper/pull/1891", "merged": true, "mergeCommit": {"oid": "08acd7abf2b359fb57c3b193ef6a308f1e45341b"}, "closed": true, "closedAt": "2020-02-09T16:29:37Z", "author": {"login": "easbar"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBvSrogH2gAyMzcyMDkzMTk5OjVkMWMyNDc3NzU2ZDQwZjA0ZjI3MTRkYjNkMTJlNDdjZTJhNjllZGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcCrHxKAH2gAyMzcyMDkzMTk5OjliOWZmOTk3YTIxYWRiOWM1MjZhNTc5ZDY5OGVhZjYxNzU2MmZmYWU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5d1c2477756d40f04f2714db3d12e47ce2a69edf", "author": {"user": {"login": "easbar", "name": "Andi"}}, "url": "https://github.com/graphhopper/graphhopper/commit/5d1c2477756d40f04f2714db3d12e47ce2a69edf", "committedDate": "2020-02-06T18:45:57Z", "message": "Remove RoutingAlgoFactoryDecorator abstraction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7ec280e0765ee451162321715dde19f55859865", "author": {"user": {"login": "easbar", "name": "Andi"}}, "url": "https://github.com/graphhopper/graphhopper/commit/b7ec280e0765ee451162321715dde19f55859865", "committedDate": "2020-02-06T18:47:49Z", "message": "Remove combined CH+LM measurement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a948cc81a98e4699f69f205cb2c0909921d2628f", "author": {"user": {"login": "easbar", "name": "Andi"}}, "url": "https://github.com/graphhopper/graphhopper/commit/a948cc81a98e4699f69f205cb2c0909921d2628f", "committedDate": "2020-02-06T19:39:23Z", "message": "Rename LM/CH decorator -> handler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ea4de668ab6cd203e85efcc1192cb32d9037fc5", "author": {"user": {"login": "easbar", "name": "Andi"}}, "url": "https://github.com/graphhopper/graphhopper/commit/6ea4de668ab6cd203e85efcc1192cb32d9037fc5", "committedDate": "2020-02-06T19:59:14Z", "message": "Add tests for error on missing LM profile and switching LM on/off"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82577538356eb3d50d29f038f77fdff47e6ee0ef", "author": {"user": {"login": "easbar", "name": "Andi"}}, "url": "https://github.com/graphhopper/graphhopper/commit/82577538356eb3d50d29f038f77fdff47e6ee0ef", "committedDate": "2020-02-06T20:07:24Z", "message": "Some cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41b60936850775d992ed0a0fdd093db86459c0a0", "author": {"user": {"login": "easbar", "name": "Andi"}}, "url": "https://github.com/graphhopper/graphhopper/commit/41b60936850775d992ed0a0fdd093db86459c0a0", "committedDate": "2020-02-08T22:40:25Z", "message": "Merge branch 'master' into no_more_decorators"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NTg5NDc1", "url": "https://github.com/graphhopper/graphhopper/pull/1891#pullrequestreview-355589475", "createdAt": "2020-02-09T07:47:47Z", "commit": {"oid": "82577538356eb3d50d29f038f77fdff47e6ee0ef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQwNzo0Nzo0N1rOFnTwlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQwNzo0Nzo0N1rOFnTwlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc2MjUxNw==", "bodyText": "This comment can probably be removed, but I was not sure what 'cross query it' means here?", "url": "https://github.com/graphhopper/graphhopper/pull/1891#discussion_r376762517", "createdAt": "2020-02-09T07:47:47Z", "author": {"login": "easbar"}, "path": "core/src/main/java/com/graphhopper/routing/lm/LMPreparationHandler.java", "diffHunk": "@@ -218,37 +217,38 @@ public int size() {\n         return preparations;\n     }\n \n-    @Override\n-    public RoutingAlgorithmFactory getDecoratedAlgorithmFactory(RoutingAlgorithmFactory defaultAlgoFactory, HintsMap map) {\n-        // for now do not allow mixing CH&LM #1082\n-        boolean disableCH = map.getBool(Parameters.CH.DISABLE, false);\n-        boolean disableLM = map.getBool(Parameters.Landmark.DISABLE, false);\n-        if (!isEnabled() || disablingAllowed && disableLM || !disableCH)\n-            return defaultAlgoFactory;\n-\n+    /**\n+     * @return a {@link RoutingAlgorithmFactory} for LM or throw an error if no preparation is available for the given\n+     * hints\n+     */\n+    public RoutingAlgorithmFactory getAlgorithmFactory(HintsMap map) {\n         if (preparations.isEmpty())\n-            throw new IllegalStateException(\"No preparations added to this decorator\");\n+            throw new IllegalStateException(\"No LM preparations added yet\");\n \n         // if no weighting or vehicle is specified for this request and there is only one preparation, use it\n         if ((map.getWeighting().isEmpty() || map.getVehicle().isEmpty()) && preparations.size() == 1) {\n-            return new LMRAFactory(preparations.get(0), defaultAlgoFactory);\n+            return new LMRAFactory(preparations.get(0), new RoutingAlgorithmFactorySimple());\n         }\n \n+        List<Weighting> lmWeightings = new ArrayList<>(preparations.size());\n         for (final PrepareLandmarks p : preparations) {\n+            lmWeightings.add(p.getWeighting());\n             if (p.getWeighting().matches(map))\n-                return new LMRAFactory(p, defaultAlgoFactory);\n+                return new LMRAFactory(p, new RoutingAlgorithmFactorySimple());\n         }\n \n+        // todonow: what does that mean?\n         // if the initial encoder&weighting has certain properties we could cross query it but for now avoid this", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82577538356eb3d50d29f038f77fdff47e6ee0ef"}, "originalPosition": 136}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b9ff997a21adb9c526a579d698eaf617562ffae", "author": {"user": {"login": "easbar", "name": "Andi"}}, "url": "https://github.com/graphhopper/graphhopper/commit/9b9ff997a21adb9c526a579d698eaf617562ffae", "committedDate": "2020-02-09T16:28:20Z", "message": "Clarify comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4711, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}