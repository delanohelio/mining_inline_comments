{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1NDY3MTk4", "number": 2000, "title": "Move gpx test from GraphHopperWebIT to RouteResourceTest", "bodyText": "Fixes #1994\nTwo bugs here:\nBug 1: Despite setting usePostRequest GraphHopperWeb#export was using GET\nBug 2: When using POST the gpx.millis parameter was an empty String (timeString) and when trying to parse it there was a NumberFormatException (leading to a misleading error message about an empty string)\nSee comments inline", "createdAt": "2020-04-18T08:41:12Z", "url": "https://github.com/graphhopper/graphhopper/pull/2000", "merged": true, "mergeCommit": {"oid": "a39e8e961b251006c5b66842f36ae05fa213287d"}, "closed": true, "closedAt": "2020-04-21T09:57:08Z", "author": {"login": "easbar"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYxwzRgH2gAyNDA1NDY3MTk4OmI3NmZmMzk2MGMxMDI5MTM2YTIwN2E1YmIxZDBmYWM3NmIyYzBjYzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZxHKxAFqTM5NzE5NzcyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b76ff3960c1029136a207a5bb1d0fac76b2c0cc5", "author": {"user": {"login": "easbar", "name": "Andi"}}, "url": "https://github.com/graphhopper/graphhopper/commit/b76ff3960c1029136a207a5bb1d0fac76b2c0cc5", "committedDate": "2020-04-18T08:38:55Z", "message": "Make GH#export work for POST requests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1ODk1MDUx", "url": "https://github.com/graphhopper/graphhopper/pull/2000#pullrequestreview-395895051", "createdAt": "2020-04-18T08:41:40Z", "commit": {"oid": "b76ff3960c1029136a207a5bb1d0fac76b2c0cc5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQwODo0MTo0MVrOGHpQTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQwODo0MTo0MVrOGHpQTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDY2OTEzNA==", "bodyText": "This wasn't private before but should be now problem to do so as there is a setter anyway", "url": "https://github.com/graphhopper/graphhopper/pull/2000#discussion_r410669134", "createdAt": "2020-04-18T08:41:41Z", "author": {"login": "easbar"}, "path": "client-hc/src/main/java/com/graphhopper/api/GraphHopperWeb.java", "diffHunk": "@@ -64,8 +64,8 @@\n     private boolean calcPoints = true;\n     private boolean elevation = false;\n     private String optimize = \"false\";\n-    boolean postRequest = true;\n-    int maxUnzippedLength = 1000;\n+    private boolean postRequest = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b76ff3960c1029136a207a5bb1d0fac76b2c0cc5"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1ODk1MDgz", "url": "https://github.com/graphhopper/graphhopper/pull/2000#pullrequestreview-395895083", "createdAt": "2020-04-18T08:42:08Z", "commit": {"oid": "b76ff3960c1029136a207a5bb1d0fac76b2c0cc5"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQwODo0MjowOVrOGHpQbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQwODo0NDoyMlrOGHpRiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDY2OTE2Nw==", "bodyText": "Had to add a setter here, since we are now no longer testing this in the same package, do you think thats ok?", "url": "https://github.com/graphhopper/graphhopper/pull/2000#discussion_r410669167", "createdAt": "2020-04-18T08:42:09Z", "author": {"login": "easbar"}, "path": "client-hc/src/main/java/com/graphhopper/api/GraphHopperWeb.java", "diffHunk": "@@ -64,8 +64,8 @@\n     private boolean calcPoints = true;\n     private boolean elevation = false;\n     private String optimize = \"false\";\n-    boolean postRequest = true;\n-    int maxUnzippedLength = 1000;\n+    private boolean postRequest = true;\n+    private int maxUnzippedLength = 1000;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b76ff3960c1029136a207a5bb1d0fac76b2c0cc5"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDY2OTE4OA==", "bodyText": "WDYT?", "url": "https://github.com/graphhopper/graphhopper/pull/2000#discussion_r410669188", "createdAt": "2020-04-18T08:42:17Z", "author": {"login": "easbar"}, "path": "client-hc/src/main/java/com/graphhopper/api/GraphHopperWeb.java", "diffHunk": "@@ -138,6 +138,14 @@ public GraphHopperWeb setKey(String key) {\n         return this;\n     }\n \n+    /**\n+     * Only use this if you know what you are doing\n+     */\n+    public GraphHopperWeb _setMaxUnzippedLength(int maxUnzippedLength) {\n+        this.maxUnzippedLength = maxUnzippedLength;\n+        return this;\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b76ff3960c1029136a207a5bb1d0fac76b2c0cc5"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDY2OTI5OQ==", "bodyText": "I'm happy about every test we can remove here, see #1986.", "url": "https://github.com/graphhopper/graphhopper/pull/2000#discussion_r410669299", "createdAt": "2020-04-18T08:43:17Z", "author": {"login": "easbar"}, "path": "client-hc/src/test/java/com/graphhopper/api/GraphHopperWebIT.java", "diffHunk": "@@ -245,39 +246,6 @@ public void doNotReadFinishInstruction() {\n         assertEquals(\"\", finishInstructionName);\n     }\n \n-    @Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b76ff3960c1029136a207a5bb1d0fac76b2c0cc5"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDY2OTQxNQ==", "bodyText": "This was Bug2: For GET a missing gpx.millis would give null, but for POST it would be an empty String.", "url": "https://github.com/graphhopper/graphhopper/pull/2000#discussion_r410669415", "createdAt": "2020-04-18T08:43:57Z", "author": {"login": "easbar"}, "path": "web-bundle/src/main/java/com/graphhopper/resources/RouteResource.java", "diffHunk": "@@ -273,7 +273,14 @@ private void removeLegacyParameters(GHRequest request) {\n             throw new IllegalArgumentException(\"Alternatives are currently not yet supported for GPX\");\n         }\n \n-        long time = timeString != null ? Long.parseLong(timeString) : System.currentTimeMillis();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b76ff3960c1029136a207a5bb1d0fac76b2c0cc5"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDY2OTQ1MQ==", "bodyText": "Not handling NumberFormatException gave a misleading error message.", "url": "https://github.com/graphhopper/graphhopper/pull/2000#discussion_r410669451", "createdAt": "2020-04-18T08:44:22Z", "author": {"login": "easbar"}, "path": "web-bundle/src/main/java/com/graphhopper/resources/RouteResource.java", "diffHunk": "@@ -273,7 +273,14 @@ private void removeLegacyParameters(GHRequest request) {\n             throw new IllegalArgumentException(\"Alternatives are currently not yet supported for GPX\");\n         }\n \n-        long time = timeString != null ? Long.parseLong(timeString) : System.currentTimeMillis();\n+        long time = System.currentTimeMillis();\n+        if (!Helper.isEmpty(timeString)) {\n+            try {\n+                time = Long.parseLong(timeString);\n+            } catch (NumberFormatException e) {\n+                throw new IllegalArgumentException(\"Invalid value for 'gpx.millis': \" + timeString);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b76ff3960c1029136a207a5bb1d0fac76b2c0cc5"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1ODk1Njky", "url": "https://github.com/graphhopper/graphhopper/pull/2000#pullrequestreview-395895692", "createdAt": "2020-04-18T08:51:13Z", "commit": {"oid": "b76ff3960c1029136a207a5bb1d0fac76b2c0cc5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQwODo1MToxNFrOGHpUsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQwODo1MToxNFrOGHpUsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDY3MDI1OQ==", "bodyText": "This was 'bug' Bug1", "url": "https://github.com/graphhopper/graphhopper/pull/2000#discussion_r410670259", "createdAt": "2020-04-18T08:51:14Z", "author": {"login": "easbar"}, "path": "client-hc/src/main/java/com/graphhopper/api/GraphHopperWeb.java", "diffHunk": "@@ -368,7 +376,7 @@ private Request createGetRequest(GHRequest ghRequest) {\n     public String export(GHRequest ghRequest) {\n         String str = \"Creating request failed\";\n         try {\n-            Request okRequest = createGetRequest(ghRequest);\n+            Request okRequest = postRequest ? createPostRequest(ghRequest) : createGetRequest(ghRequest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b76ff3960c1029136a207a5bb1d0fac76b2c0cc5"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1ODk1ODY5", "url": "https://github.com/graphhopper/graphhopper/pull/2000#pullrequestreview-395895869", "createdAt": "2020-04-18T08:53:11Z", "commit": {"oid": "b76ff3960c1029136a207a5bb1d0fac76b2c0cc5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQwODo1MzoxMVrOGHpVnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQwODo1MzoxMVrOGHpVnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDY3MDQ5Mw==", "bodyText": "We could also remove maxunzipped length here since we are not testing it anyway, but we might need it for some other tests in GraphHopperWebIT (but then we can still add it -> removed it here :))", "url": "https://github.com/graphhopper/graphhopper/pull/2000#discussion_r410670493", "createdAt": "2020-04-18T08:53:11Z", "author": {"login": "easbar"}, "path": "web/src/test/java/com/graphhopper/http/resources/RouteResourceTest.java", "diffHunk": "@@ -502,6 +504,54 @@ public void testGPXWithError() {\n         assertTrue(str.contains(\"<hints><error details=\\\"java\"), \"Expected error but was: \" + str);\n     }\n \n+    @ParameterizedTest\n+    @CsvSource({\n+            \"false, -1\",\n+            \"true,0\",\n+            \"true,1000\",\n+    })\n+    public void testGPXExport(boolean usePost, int maxUnzippedLength) {\n+        GHRequest req = new GHRequest(42.554851, 1.536198, 42.510071, 1.548128);\n+        req.putHint(\"elevation\", false);\n+        req.putHint(\"instructions\", true);\n+        req.putHint(\"calc_points\", true);\n+        req.putHint(\"gpx.millis\", \"300000000\");\n+        req.putHint(\"type\", \"gpx\");\n+        GraphHopperWeb gh = new GraphHopperWeb(clientUrl(app, \"/route\"))\n+                .setPostRequest(usePost)\n+                ._setMaxUnzippedLength(maxUnzippedLength);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b76ff3960c1029136a207a5bb1d0fac76b2c0cc5"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e385f43987a1b8b7925b314b27d4585d2392753", "author": {"user": {"login": "easbar", "name": "Andi"}}, "url": "https://github.com/graphhopper/graphhopper/commit/2e385f43987a1b8b7925b314b27d4585d2392753", "committedDate": "2020-04-18T08:55:22Z", "message": "Remove max unzipped length from test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47c20f78dd44320c42084cebd45426fe9bcfd74d", "author": {"user": {"login": "easbar", "name": "Andi"}}, "url": "https://github.com/graphhopper/graphhopper/commit/47c20f78dd44320c42084cebd45426fe9bcfd74d", "committedDate": "2020-04-18T08:56:41Z", "message": "Minor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2855db85095dd0c2038cf9562f7cd36f67502316", "author": {"user": {"login": "easbar", "name": "Andi"}}, "url": "https://github.com/graphhopper/graphhopper/commit/2855db85095dd0c2038cf9562f7cd36f67502316", "committedDate": "2020-04-20T07:22:44Z", "message": "Fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "928c7528e3912a83ea9572d9ace1378c20ee5ae1", "author": {"user": {"login": "easbar", "name": "Andi"}}, "url": "https://github.com/graphhopper/graphhopper/commit/928c7528e3912a83ea9572d9ace1378c20ee5ae1", "committedDate": "2020-04-20T07:22:50Z", "message": "Merge branch 'master' into issue_1994"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50a7324b5289b20ab44bf893781700f0a7469e52", "author": {"user": {"login": "easbar", "name": "Andi"}}, "url": "https://github.com/graphhopper/graphhopper/commit/50a7324b5289b20ab44bf893781700f0a7469e52", "committedDate": "2020-04-20T21:59:29Z", "message": "Merge branch 'master' into issue_1994"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1aa4e79b9aa53abb04362f33ee163cc4e0612dd3", "author": {"user": {"login": "easbar", "name": "Andi"}}, "url": "https://github.com/graphhopper/graphhopper/commit/1aa4e79b9aa53abb04362f33ee163cc4e0612dd3", "committedDate": "2020-04-21T09:51:16Z", "message": "Update now that gpx for post is gone"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3MTk3NzI2", "url": "https://github.com/graphhopper/graphhopper/pull/2000#pullrequestreview-397197726", "createdAt": "2020-04-21T10:27:21Z", "commit": {"oid": "1aa4e79b9aa53abb04362f33ee163cc4e0612dd3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxMDoyNzoyMlrOGI-djQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxMDoyNzoyMlrOGI-djQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA2NTE2NQ==", "bodyText": "Yes, this would be probably a good idea.", "url": "https://github.com/graphhopper/graphhopper/pull/2000#discussion_r412065165", "createdAt": "2020-04-21T10:27:22Z", "author": {"login": "karussell"}, "path": "client-hc/src/main/java/com/graphhopper/api/GraphHopperWeb.java", "diffHunk": "@@ -376,7 +368,8 @@ private Request createGetRequest(GHRequest ghRequest) {\n     public String export(GHRequest ghRequest) {\n         String str = \"Creating request failed\";\n         try {\n-            Request okRequest = postRequest ? createPostRequest(ghRequest) : createGetRequest(ghRequest);\n+            // todonow: should there be an error if usePost=true (because it is not supported)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1aa4e79b9aa53abb04362f33ee163cc4e0612dd3"}, "originalPosition": 29}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4634, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}