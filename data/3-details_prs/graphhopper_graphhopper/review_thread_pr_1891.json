{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyMDkzMTk5", "number": 1891, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQwNzo0Nzo0N1rODeQj-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQwNzo0Nzo0N1rODeQj-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMDU1MjI3OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/graphhopper/routing/lm/LMPreparationHandler.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQwNzo0Nzo0N1rOFnTwlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQxNDoxNDo1OVrOFnVRZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc2MjUxNw==", "bodyText": "This comment can probably be removed, but I was not sure what 'cross query it' means here?", "url": "https://github.com/graphhopper/graphhopper/pull/1891#discussion_r376762517", "createdAt": "2020-02-09T07:47:47Z", "author": {"login": "easbar"}, "path": "core/src/main/java/com/graphhopper/routing/lm/LMPreparationHandler.java", "diffHunk": "@@ -218,37 +217,38 @@ public int size() {\n         return preparations;\n     }\n \n-    @Override\n-    public RoutingAlgorithmFactory getDecoratedAlgorithmFactory(RoutingAlgorithmFactory defaultAlgoFactory, HintsMap map) {\n-        // for now do not allow mixing CH&LM #1082\n-        boolean disableCH = map.getBool(Parameters.CH.DISABLE, false);\n-        boolean disableLM = map.getBool(Parameters.Landmark.DISABLE, false);\n-        if (!isEnabled() || disablingAllowed && disableLM || !disableCH)\n-            return defaultAlgoFactory;\n-\n+    /**\n+     * @return a {@link RoutingAlgorithmFactory} for LM or throw an error if no preparation is available for the given\n+     * hints\n+     */\n+    public RoutingAlgorithmFactory getAlgorithmFactory(HintsMap map) {\n         if (preparations.isEmpty())\n-            throw new IllegalStateException(\"No preparations added to this decorator\");\n+            throw new IllegalStateException(\"No LM preparations added yet\");\n \n         // if no weighting or vehicle is specified for this request and there is only one preparation, use it\n         if ((map.getWeighting().isEmpty() || map.getVehicle().isEmpty()) && preparations.size() == 1) {\n-            return new LMRAFactory(preparations.get(0), defaultAlgoFactory);\n+            return new LMRAFactory(preparations.get(0), new RoutingAlgorithmFactorySimple());\n         }\n \n+        List<Weighting> lmWeightings = new ArrayList<>(preparations.size());\n         for (final PrepareLandmarks p : preparations) {\n+            lmWeightings.add(p.getWeighting());\n             if (p.getWeighting().matches(map))\n-                return new LMRAFactory(p, defaultAlgoFactory);\n+                return new LMRAFactory(p, new RoutingAlgorithmFactorySimple());\n         }\n \n+        // todonow: what does that mean?\n         // if the initial encoder&weighting has certain properties we could cross query it but for now avoid this", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82577538356eb3d50d29f038f77fdff47e6ee0ef"}, "originalPosition": 136}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc4NzMwMA==", "bodyText": "It means if we have a LM preparation for e.g. \"fastest+car\" and it should be okay to do a request also with a changed or even different weighting (for optimality the edge weights must not decrease and so not all changes are acceptable).\nBut such a check for the changed Weighting is not easy. Even for our new CustomWeighting (but there it is possible and should be made possible)", "url": "https://github.com/graphhopper/graphhopper/pull/1891#discussion_r376787300", "createdAt": "2020-02-09T14:14:59Z", "author": {"login": "karussell"}, "path": "core/src/main/java/com/graphhopper/routing/lm/LMPreparationHandler.java", "diffHunk": "@@ -218,37 +217,38 @@ public int size() {\n         return preparations;\n     }\n \n-    @Override\n-    public RoutingAlgorithmFactory getDecoratedAlgorithmFactory(RoutingAlgorithmFactory defaultAlgoFactory, HintsMap map) {\n-        // for now do not allow mixing CH&LM #1082\n-        boolean disableCH = map.getBool(Parameters.CH.DISABLE, false);\n-        boolean disableLM = map.getBool(Parameters.Landmark.DISABLE, false);\n-        if (!isEnabled() || disablingAllowed && disableLM || !disableCH)\n-            return defaultAlgoFactory;\n-\n+    /**\n+     * @return a {@link RoutingAlgorithmFactory} for LM or throw an error if no preparation is available for the given\n+     * hints\n+     */\n+    public RoutingAlgorithmFactory getAlgorithmFactory(HintsMap map) {\n         if (preparations.isEmpty())\n-            throw new IllegalStateException(\"No preparations added to this decorator\");\n+            throw new IllegalStateException(\"No LM preparations added yet\");\n \n         // if no weighting or vehicle is specified for this request and there is only one preparation, use it\n         if ((map.getWeighting().isEmpty() || map.getVehicle().isEmpty()) && preparations.size() == 1) {\n-            return new LMRAFactory(preparations.get(0), defaultAlgoFactory);\n+            return new LMRAFactory(preparations.get(0), new RoutingAlgorithmFactorySimple());\n         }\n \n+        List<Weighting> lmWeightings = new ArrayList<>(preparations.size());\n         for (final PrepareLandmarks p : preparations) {\n+            lmWeightings.add(p.getWeighting());\n             if (p.getWeighting().matches(map))\n-                return new LMRAFactory(p, defaultAlgoFactory);\n+                return new LMRAFactory(p, new RoutingAlgorithmFactorySimple());\n         }\n \n+        // todonow: what does that mean?\n         // if the initial encoder&weighting has certain properties we could cross query it but for now avoid this", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc2MjUxNw=="}, "originalCommit": {"oid": "82577538356eb3d50d29f038f77fdff47e6ee0ef"}, "originalPosition": 136}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4862, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}