{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0MTc5ODg3", "number": 1990, "title": "Improve docker image size", "bodyText": "I've changed the docker image creation to reduce its size.\nI've added some safe checks to config copying when using graphopper.sh and config.yml does not exists\nI've moved ensure maven to maven commands only\nI've added artifacts to appveyor and updated the build image to latest image.\n\nThe last item is not mandatory for docker.\nThis is related to #1985", "createdAt": "2020-04-16T07:52:42Z", "url": "https://github.com/graphhopper/graphhopper/pull/1990", "merged": true, "mergeCommit": {"oid": "4f9d478f2d79af1764fa0b4dcf35aea77391073f"}, "closed": true, "closedAt": "2020-04-17T10:34:31Z", "author": {"login": "HarelM"}, "timelineItems": {"totalCount": 31, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXh__RAH2gAyNDA0MTc5ODg3OjQ5YWRiMjg1ZjdmNjMzZGMxOGJmZDNiOWY0NDE4YTQ2NWQwMThiYzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYaBJdgH2gAyNDA0MTc5ODg3OmNkMmYxYzU5NjUyMDRkYjI1ZDg1NTllZGZhOTQxYTk2Mzc5N2M3NDA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "49adb285f7f633dc18bfd3b9f4418a465d018bc4", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/49adb285f7f633dc18bfd3b9f4418a465d018bc4", "committedDate": "2020-04-14T11:43:06Z", "message": "#1985 - Added an appveyor docker deploy yml file - init test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b6fb045e0dd0007e9ab4252bc7ba2e6e25baf5d", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/1b6fb045e0dd0007e9ab4252bc7ba2e6e25baf5d", "committedDate": "2020-04-14T18:18:43Z", "message": "Merge branch 'master' of https://github.com/HarelM/graphhopper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c07e66121d8803b50c1146b6941306bb20bcca7", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/1c07e66121d8803b50c1146b6941306bb20bcca7", "committedDate": "2020-04-14T18:19:30Z", "message": "#1985 - Try the same with a linux image"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d3d783436ebe9d3d80e3e5f69984bd9219eb00d", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/9d3d783436ebe9d3d80e3e5f69984bd9219eb00d", "committedDate": "2020-04-15T19:57:01Z", "message": "#1985 - build and run changes to remove global ensure mvn and config overwrite. Changed to harelmazor dockerhub for further testing."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17a01c05d98377a9582923ef0b7725335a6a9e26", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/17a01c05d98377a9582923ef0b7725335a6a9e26", "committedDate": "2020-04-15T20:02:33Z", "message": "#1985 - fix appveyor yml file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a8f81e1b75ebc278eb63930fa68f87473525c91", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/4a8f81e1b75ebc278eb63930fa68f87473525c91", "committedDate": "2020-04-15T20:08:28Z", "message": "#1985 - Fix appveyor file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "daac6da3d1bf7f1ae9e5587b3e1ee2ce1d715acd", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/daac6da3d1bf7f1ae9e5587b3e1ee2ce1d715acd", "committedDate": "2020-04-15T20:12:55Z", "message": "#1985 - Fix switchdeamon command"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55da9a79399427efa276eae6394af496fa3b28c2", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/55da9a79399427efa276eae6394af496fa3b28c2", "committedDate": "2020-04-15T20:22:17Z", "message": "#1985 - Fix tag build flag"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd63ffd58414d220b02aa59be05925e9cf2da744", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/bd63ffd58414d220b02aa59be05925e9cf2da744", "committedDate": "2020-04-15T20:29:18Z", "message": "#1985 - make sure it is running linux and not just switching..."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ed6d21991054995720bd22daf703d5342394a38", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/2ed6d21991054995720bd22daf703d5342394a38", "committedDate": "2020-04-15T20:52:50Z", "message": "#1985 - Bad provider fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "076ae235b5fbf84edaafce7b3c0a5b51680a0ce2", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/076ae235b5fbf84edaafce7b3c0a5b51680a0ce2", "committedDate": "2020-04-15T20:53:42Z", "message": "#1985 - Set provider to be script"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f9388b1cfe657ed5ab3920ee850459107d2c74e", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/3f9388b1cfe657ed5ab3920ee850459107d2c74e", "committedDate": "2020-04-15T21:09:14Z", "message": "#1985 - Added back prodcution environment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfc4f0f581896a3e77c8b9210a75d6307224f354", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/dfc4f0f581896a3e77c8b9210a75d6307224f354", "committedDate": "2020-04-15T21:26:07Z", "message": "#1985 - Change provider to local"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fae702526faf13748c196d73de618700d6603cce", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/fae702526faf13748c196d73de618700d6603cce", "committedDate": "2020-04-16T05:33:40Z", "message": "#1985 - Added tag for build, removed web assets, moved deploy to detault build"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3e79161fa9fc6a11d0ca33200515111880e9af1", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/c3e79161fa9fc6a11d0ca33200515111880e9af1", "committedDate": "2020-04-16T05:33:44Z", "message": "Merge branch 'master' of https://github.com/HarelM/graphhopper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79f9768905b8017220415658e8f65d3d52a7b5a5", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/79f9768905b8017220415658e8f65d3d52a7b5a5", "committedDate": "2020-04-16T06:36:44Z", "message": "#1985 - Moved all configurations to dockerhub"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bee254d49964480d1aad4816e3edf934f91eda1", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/0bee254d49964480d1aad4816e3edf934f91eda1", "committedDate": "2020-04-16T07:02:52Z", "message": "#1985 - Simplify appveyor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6788265241ff119118ef353a9d1f71aaeb1d8ed", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/f6788265241ff119118ef353a9d1f71aaeb1d8ed", "committedDate": "2020-04-16T07:04:28Z", "message": "#1985 - Fix appveyor.yml file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56381d4d8447cb99f57b9d3f894ed937439a8bc2", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/56381d4d8447cb99f57b9d3f894ed937439a8bc2", "committedDate": "2020-04-16T07:06:42Z", "message": "#1985 - fix yml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9435b5bb7df8797bbf816ed09c92051cbe97a1d", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/a9435b5bb7df8797bbf816ed09c92051cbe97a1d", "committedDate": "2020-04-16T07:09:02Z", "message": "#1985 - Fix build?"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b3e7d21bcea6605b95e0161945bdb6d5c20b4ad", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/0b3e7d21bcea6605b95e0161945bdb6d5c20b4ad", "committedDate": "2020-04-16T07:11:27Z", "message": "#1985 - fix build...?"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93723b2e51014e6509ad8cb98f9f27b865b33ed5", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/93723b2e51014e6509ad8cb98f9f27b865b33ed5", "committedDate": "2020-04-16T07:15:58Z", "message": "#1985 - add back java and mvn versions."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f558162292b0e65b3025fce466b7fd589cd2b392", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/f558162292b0e65b3025fce466b7fd589cd2b392", "committedDate": "2020-04-16T07:36:51Z", "message": "#1985 - reduce appveyor changes, fix java version red text."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bde6db0d722b6201f3f156baa75a5dda6ef592f8", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/bde6db0d722b6201f3f156baa75a5dda6ef592f8", "committedDate": "2020-04-16T07:39:06Z", "message": "#1985 - add java version"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NDY0OTQ4", "url": "https://github.com/graphhopper/graphhopper/pull/1990#pullrequestreview-394464948", "createdAt": "2020-04-16T09:39:18Z", "commit": {"oid": "bde6db0d722b6201f3f156baa75a5dda6ef592f8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwOTozOToxOFrOGGdE3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwOTo0MDozNFrOGGdH8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQyMTAyMw==", "bodyText": "Is the pom.xml file really necessary here? As we use a jre (second FROM) compiling is not possible anymore.", "url": "https://github.com/graphhopper/graphhopper/pull/1990#discussion_r409421023", "createdAt": "2020-04-16T09:39:18Z", "author": {"login": "karussell"}, "path": "Dockerfile", "diffHunk": "@@ -1,23 +1,36 @@\n-FROM openjdk:8-jdk\n+FROM maven:3.6.3-jdk-8 as build\n \n ENV JAVA_OPTS \"-server -Xconcurrentio -Xmx1g -Xms1g -XX:+UseG1GC -Ddw.server.application_connectors[0].bind_host=0.0.0.0 -Ddw.server.application_connectors[0].port=8989\"\n \n-RUN mkdir -p /data && mkdir -p /graphhopper\n-\n # install node - only required for JS UI\n RUN apt-get install -y wget \\\n        && curl -sL https://deb.nodesource.com/setup_13.x | bash - \\\n        && apt-get install -y nodejs\n \n-COPY . /graphhopper/\n-\n WORKDIR /graphhopper\n \n+COPY . .\n+\n # create main.js - only required for JS UI\n-RUN cd web && npm install && npm run bundleProduction && cd ..\n+WORKDIR /graphhopper/web\n+\n+RUN npm install && npm run bundleProduction\n+\n+WORKDIR /graphhopper\n \n RUN ./graphhopper.sh build\n \n+FROM openjdk:11.0.5-jre\n+\n+ENV JAVA_OPTS \"-server -Xconcurrentio -Xmx1g -Xms1g -XX:+UseG1GC -Ddw.server.application_connectors[0].bind_host=0.0.0.0 -Ddw.server.application_connectors[0].port=8989\"\n+\n+RUN mkdir -p /data\n+\n+WORKDIR /graphhopper\n+\n+COPY --from=build /graphhopper/web/target/*.jar ./web/target/\n+COPY ./graphhopper.sh ./pom.xml ./config-example.yml ./", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bde6db0d722b6201f3f156baa75a5dda6ef592f8"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQyMTgwOQ==", "bodyText": "Can you remove the options -server -Xconcurrentio and -XX:+UseG1GC? We should use the JVM defaults.", "url": "https://github.com/graphhopper/graphhopper/pull/1990#discussion_r409421809", "createdAt": "2020-04-16T09:40:34Z", "author": {"login": "karussell"}, "path": "Dockerfile", "diffHunk": "@@ -1,23 +1,36 @@\n-FROM openjdk:8-jdk\n+FROM maven:3.6.3-jdk-8 as build\n \n ENV JAVA_OPTS \"-server -Xconcurrentio -Xmx1g -Xms1g -XX:+UseG1GC -Ddw.server.application_connectors[0].bind_host=0.0.0.0 -Ddw.server.application_connectors[0].port=8989\"\n \n-RUN mkdir -p /data && mkdir -p /graphhopper\n-\n # install node - only required for JS UI\n RUN apt-get install -y wget \\\n        && curl -sL https://deb.nodesource.com/setup_13.x | bash - \\\n        && apt-get install -y nodejs\n \n-COPY . /graphhopper/\n-\n WORKDIR /graphhopper\n \n+COPY . .\n+\n # create main.js - only required for JS UI\n-RUN cd web && npm install && npm run bundleProduction && cd ..\n+WORKDIR /graphhopper/web\n+\n+RUN npm install && npm run bundleProduction\n+\n+WORKDIR /graphhopper\n \n RUN ./graphhopper.sh build\n \n+FROM openjdk:11.0.5-jre\n+\n+ENV JAVA_OPTS \"-server -Xconcurrentio -Xmx1g -Xms1g -XX:+UseG1GC -Ddw.server.application_connectors[0].bind_host=0.0.0.0 -Ddw.server.application_connectors[0].port=8989\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bde6db0d722b6201f3f156baa75a5dda6ef592f8"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f1bdbd47b3a5b9868d88afd6d9ebf22580b70e8", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/0f1bdbd47b3a5b9868d88afd6d9ebf22580b70e8", "committedDate": "2020-04-16T10:09:59Z", "message": "#1985 - Fixes according to code review."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4af8f1dc14a08dbafd6666c7f1eb5081d4bbb7dd", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/4af8f1dc14a08dbafd6666c7f1eb5081d4bbb7dd", "committedDate": "2020-04-16T10:33:07Z", "message": "#1985 - Added comment for pom.xml file"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NTE4MTE2", "url": "https://github.com/graphhopper/graphhopper/pull/1990#pullrequestreview-394518116", "createdAt": "2020-04-16T10:52:23Z", "commit": {"oid": "4af8f1dc14a08dbafd6666c7f1eb5081d4bbb7dd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxMDo1MjoyNFrOGGft7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxMDo1NTo0NlrOGGf1ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ2NDMwMA==", "bodyText": "Do we need to hardcode minor/patch versions?", "url": "https://github.com/graphhopper/graphhopper/pull/1990#discussion_r409464300", "createdAt": "2020-04-16T10:52:24Z", "author": {"login": "otbutz"}, "path": "Dockerfile", "diffHunk": "@@ -1,23 +1,37 @@\n-FROM openjdk:8-jdk\n+FROM maven:3.6.3-jdk-8 as build\n \n ENV JAVA_OPTS \"-server -Xconcurrentio -Xmx1g -Xms1g -XX:+UseG1GC -Ddw.server.application_connectors[0].bind_host=0.0.0.0 -Ddw.server.application_connectors[0].port=8989\"\n \n-RUN mkdir -p /data && mkdir -p /graphhopper\n-\n # install node - only required for JS UI\n RUN apt-get install -y wget \\\n        && curl -sL https://deb.nodesource.com/setup_13.x | bash - \\\n        && apt-get install -y nodejs\n \n-COPY . /graphhopper/\n-\n WORKDIR /graphhopper\n \n+COPY . .\n+\n # create main.js - only required for JS UI\n-RUN cd web && npm install && npm run bundleProduction && cd ..\n+WORKDIR /graphhopper/web\n+\n+RUN npm install && npm run bundleProduction\n+\n+WORKDIR /graphhopper\n \n RUN ./graphhopper.sh build\n \n+FROM openjdk:11.0.5-jre", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4af8f1dc14a08dbafd6666c7f1eb5081d4bbb7dd"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ2NjIzNQ==", "bodyText": "Dropping the package cache might further reduce image size:\nRUN apt-get install -y wget \\\n       && curl -sL https://deb.nodesource.com/setup_13.x | bash - \\\n       && apt-get install -y nodejs \\\n       && rm -rf /var/lib/apt/lists/*", "url": "https://github.com/graphhopper/graphhopper/pull/1990#discussion_r409466235", "createdAt": "2020-04-16T10:55:46Z", "author": {"login": "otbutz"}, "path": "Dockerfile", "diffHunk": "@@ -1,23 +1,37 @@\n-FROM openjdk:8-jdk\n+FROM maven:3.6.3-jdk-8 as build\n \n ENV JAVA_OPTS \"-server -Xconcurrentio -Xmx1g -Xms1g -XX:+UseG1GC -Ddw.server.application_connectors[0].bind_host=0.0.0.0 -Ddw.server.application_connectors[0].port=8989\"\n \n-RUN mkdir -p /data && mkdir -p /graphhopper\n-\n # install node - only required for JS UI\n RUN apt-get install -y wget \\\n        && curl -sL https://deb.nodesource.com/setup_13.x | bash - \\\n        && apt-get install -y nodejs", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4af8f1dc14a08dbafd6666c7f1eb5081d4bbb7dd"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb0e22d0f4412e20a92e96fed9060faf6aa37f35", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/fb0e22d0f4412e20a92e96fed9060faf6aa37f35", "committedDate": "2020-04-16T11:35:50Z", "message": "#1985 - Fix jre version according to code review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0620ed760e061e874ce51468fb63623819dcc971", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/0620ed760e061e874ce51468fb63623819dcc971", "committedDate": "2020-04-16T16:58:49Z", "message": "Merge branch 'master' of https://github.com/HarelM/graphhopper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd2f1c5965204db25d8559edfa941a963797c740", "author": {"user": {"login": "HarelM", "name": "Harel M"}}, "url": "https://github.com/graphhopper/graphhopper/commit/cd2f1c5965204db25d8559edfa941a963797c740", "committedDate": "2020-04-17T04:59:03Z", "message": "Merge branch 'master' of https://github.com/HarelM/graphhopper"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4632, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}