{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyNjkzODkw", "number": 1943, "title": "Simplify entire edges on import instead of just pillar nodes", "bodyText": "Fix #1353 by simplifying whole edge geometries instead of just the pillar nodes. Since only edges with more than one pillar node remaining are stored in edge geometries, this ends up reducing edge geometry file size by 15-20%\nThis did result in some churn in the integration tests, please take a close look at those and let me know if they look OK. It also removed a case to not calculate edge distances on edges that cross the international date line - this didn't seem necessary since that code uses DistanceCalcEarth which handles these crossings correctly but let me know if I'm missing something.", "createdAt": "2020-03-03T01:19:30Z", "url": "https://github.com/graphhopper/graphhopper/pull/1943", "merged": true, "mergeCommit": {"oid": "d6515a2fb87cff63cdbbdc0bc37f342a26baa707"}, "closed": true, "closedAt": "2020-03-10T18:52:58Z", "author": {"login": "msbarry"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcJrrm6gH2gAyMzgyNjkzODkwOmIwNGQ5OTg3ZWFhMTIwOGUzZTIwN2E3OGYxMTI2NWViMjJhNTFmNTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMR99RAH2gAyMzgyNjkzODkwOjIwOGYwZTM1NzUxMjZkZGM3OWYzMTUzMjljNmU1MWFlZjgzYmVlMjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b04d9987eaa1208e3e207a78f11265eb22a51f51", "author": {"user": {"login": "msbarry", "name": "Michael Barry"}}, "url": "https://github.com/graphhopper/graphhopper/commit/b04d9987eaa1208e3e207a78f11265eb22a51f51", "committedDate": "2020-03-02T11:04:57Z", "message": "initial fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba36cafa108cb48d24dcd892ff810eb587cda6db", "author": {"user": {"login": "msbarry", "name": "Michael Barry"}}, "url": "https://github.com/graphhopper/graphhopper/commit/ba36cafa108cb48d24dcd892ff810eb587cda6db", "committedDate": "2020-03-02T13:07:55Z", "message": "update integration tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57f740ffd4159a464c262a92b72481b5382ebd9b", "author": {"user": {"login": "msbarry", "name": "Michael Barry"}}, "url": "https://github.com/graphhopper/graphhopper/commit/57f740ffd4159a464c262a92b72481b5382ebd9b", "committedDate": "2020-03-03T01:06:21Z", "message": "fix tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NjQ1MzA0", "url": "https://github.com/graphhopper/graphhopper/pull/1943#pullrequestreview-367645304", "createdAt": "2020-03-03T01:22:31Z", "commit": {"oid": "57f740ffd4159a464c262a92b72481b5382ebd9b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMToyMjozMVrOFw1RxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMToyMjozMVrOFw1RxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc0ODg2OA==", "bodyText": "instruction 4 that went away was \"continue onto Margarethenstra\u00dfe\"", "url": "https://github.com/graphhopper/graphhopper/pull/1943#discussion_r386748868", "createdAt": "2020-03-03T01:22:31Z", "author": {"login": "msbarry"}, "path": "reader-osm/src/test/java/com/graphhopper/GraphHopperIT.java", "diffHunk": "@@ -968,15 +968,15 @@ public void testKremsCyclewayInstructionsWithWayTypeInfo() {\n \n         assertEquals(\"turn right onto Pfarrplatz\", il.get(2).getTurnDescription(tr));\n         assertEquals(\"turn right onto Margarethenstra\u00dfe\", il.get(3).getTurnDescription(tr));\n-        assertEquals(\"keep left onto Hoher Markt\", il.get(5).getTurnDescription(tr));\n-        assertEquals(\"turn right onto Wegscheid\", il.get(7).getTurnDescription(tr));\n-        assertEquals(\"turn right onto Ringstra\u00dfe, L73\", il.get(9).getTurnDescription(tr));\n-        assertEquals(\"keep left onto Eyblparkstra\u00dfe\", il.get(10).getTurnDescription(tr));\n-        assertEquals(\"keep left onto Austra\u00dfe\", il.get(11).getTurnDescription(tr));\n-        assertEquals(\"keep left onto Rechte Kremszeile\", il.get(12).getTurnDescription(tr));\n+        assertEquals(\"keep left onto Hoher Markt\", il.get(4).getTurnDescription(tr));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57f740ffd4159a464c262a92b72481b5382ebd9b"}, "originalPosition": 148}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NjQ2MTA4", "url": "https://github.com/graphhopper/graphhopper/pull/1943#pullrequestreview-367646108", "createdAt": "2020-03-03T01:25:02Z", "commit": {"oid": "57f740ffd4159a464c262a92b72481b5382ebd9b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMToyNTowM1rOFw1UhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMToyNTowM1rOFw1UhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc0OTU3Mw==", "bodyText": "these changes are probably because by forcing simplification to always keep the closest pillar node to each tower node, we had been getting a bit more resolution on the angles into and out of each intersection.", "url": "https://github.com/graphhopper/graphhopper/pull/1943#discussion_r386749573", "createdAt": "2020-03-03T01:25:03Z", "author": {"login": "msbarry"}, "path": "reader-osm/src/test/java/com/graphhopper/GraphHopperIT.java", "diffHunk": "@@ -575,12 +575,12 @@ public void testMonacoVia() {\n \n         PathWrapper arsp = rsp.getBest();\n         assertEquals(6875.2, arsp.getDistance(), .1);\n-        assertEquals(171, arsp.getPoints().getSize());\n+        assertEquals(170, arsp.getPoints().getSize());\n \n         InstructionList il = arsp.getInstructions();\n         assertEquals(30, il.size());\n         assertEquals(\"continue onto Avenue des Guelfes\", il.get(0).getTurnDescription(tr));\n-        assertEquals(\"continue onto Avenue des Papalins\", il.get(1).getTurnDescription(tr));\n+        assertEquals(\"turn slight left onto Avenue des Papalins\", il.get(1).getTurnDescription(tr));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57f740ffd4159a464c262a92b72481b5382ebd9b"}, "originalPosition": 74}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f08a471dad184e3a7ab3c82b8a4f72b18f7b6cc", "author": {"user": {"login": "msbarry", "name": "Michael Barry"}}, "url": "https://github.com/graphhopper/graphhopper/commit/4f08a471dad184e3a7ab3c82b8a4f72b18f7b6cc", "committedDate": "2020-03-03T11:15:08Z", "message": "tweak"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4MDc3MzE1", "url": "https://github.com/graphhopper/graphhopper/pull/1943#pullrequestreview-368077315", "createdAt": "2020-03-03T15:29:29Z", "commit": {"oid": "4f08a471dad184e3a7ab3c82b8a4f72b18f7b6cc"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7a400193defa4cadaf35f376269263385b0d5dd", "author": {"user": {"login": "msbarry", "name": "Michael Barry"}}, "url": "https://github.com/graphhopper/graphhopper/commit/e7a400193defa4cadaf35f376269263385b0d5dd", "committedDate": "2020-03-04T00:50:38Z", "message": "move endpoint removal into douglas peucker"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NDMyNzU0", "url": "https://github.com/graphhopper/graphhopper/pull/1943#pullrequestreview-368432754", "createdAt": "2020-03-04T00:55:15Z", "commit": {"oid": "e7a400193defa4cadaf35f376269263385b0d5dd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwMDo1NToxNVrOFxcB1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwMDo1NToxNVrOFxcB1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM4Mzc2Ng==", "bodyText": "at first I was creating a shallow copy excluding first and last points, but then I tried this approach of removing the first and last point as part of simplification and it was consistently faster than the shallow copy approach on a medium size ~1GB extract (US northeast)", "url": "https://github.com/graphhopper/graphhopper/pull/1943#discussion_r387383766", "createdAt": "2020-03-04T00:55:15Z", "author": {"login": "msbarry"}, "path": "reader-osm/src/main/java/com/graphhopper/reader/osm/OSMReader.java", "diffHunk": "@@ -720,12 +694,15 @@ EdgeIteratorState addEdge(int fromIndex, int toIndex, PointList pointList, IntsR\n \n         EdgeIteratorState iter = graph.edge(fromIndex, toIndex).setDistance(towerNodeDistance).setFlags(flags);\n \n-        if (nodes > 2) {\n+        if (pointList.size() > 2) {\n             if (doSimplify)\n-                simplifyAlgo.simplify(pillarNodes);\n+                simplifyAlgo.simplifyExcludeFirstLast(pointList);\n \n-            iter.setWayGeometry(pillarNodes);\n+            // If the entire way is just the first and last point, do not waste space storing an empty way geometry\n+            if (!pointList.isEmpty())\n+                iter.setWayGeometry(pointList);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7a400193defa4cadaf35f376269263385b0d5dd"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e44949e45890a53039051be0d5e97193f97561e", "author": {"user": {"login": "msbarry", "name": "Michael Barry"}}, "url": "https://github.com/graphhopper/graphhopper/commit/5e44949e45890a53039051be0d5e97193f97561e", "committedDate": "2020-03-04T01:24:59Z", "message": "Revert \"move endpoint removal into douglas peucker\"\n\nThis reverts commit e7a400193defa4cadaf35f376269263385b0d5dd."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d601eda3d4d87ed65383fb892333ee0bc665dd1c", "author": {"user": {"login": "msbarry", "name": "Michael Barry"}}, "url": "https://github.com/graphhopper/graphhopper/commit/d601eda3d4d87ed65383fb892333ee0bc665dd1c", "committedDate": "2020-03-05T01:33:37Z", "message": "Merge branch 'master' into simplify-whole-edge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "208f0e3575126ddc79f315329c6e51aef83bee22", "author": {"user": {"login": "msbarry", "name": "Michael Barry"}}, "url": "https://github.com/graphhopper/graphhopper/commit/208f0e3575126ddc79f315329c6e51aef83bee22", "committedDate": "2020-03-10T12:49:14Z", "message": "Merge branch 'master' into simplify-whole-edge"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4593, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}