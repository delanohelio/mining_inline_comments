{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc0MjI5Mzg4", "number": 1903, "title": "Allow overlapping SpatialRules with priorities", "bodyText": "This PR builds on top of #1880 and restructures the SpatialRuleLookup interface to return SpatialRuleSets which cover multiple rules.", "createdAt": "2020-02-12T10:33:14Z", "url": "https://github.com/graphhopper/graphhopper/pull/1903", "merged": true, "mergeCommit": {"oid": "fb34ac093d0d12d572d8b29d7496849c1bf2d3e3"}, "closed": true, "closedAt": "2020-04-14T16:26:16Z", "author": {"login": "otbutz"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcH07mhgBqjMwNzAxNzE0NjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcaycLugFqTQwMDAwMjE5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5af6a814d8ec266a22ef2174d4aacc3aa1c35465", "author": {"user": null}, "url": "https://github.com/graphhopper/graphhopper/commit/5af6a814d8ec266a22ef2174d4aacc3aa1c35465", "committedDate": "2020-02-12T10:27:25Z", "message": "Remove `SpatialRule.EMPTY`"}, "afterCommit": {"oid": "fde4c063600fbb3165b3b1d2ffd7aa2d59b1cf06", "author": {"user": null}, "url": "https://github.com/graphhopper/graphhopper/commit/fde4c063600fbb3165b3b1d2ffd7aa2d59b1cf06", "committedDate": "2020-02-25T16:25:25Z", "message": "Remove `SpatialRule.EMPTY`"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fde4c063600fbb3165b3b1d2ffd7aa2d59b1cf06", "author": {"user": null}, "url": "https://github.com/graphhopper/graphhopper/commit/fde4c063600fbb3165b3b1d2ffd7aa2d59b1cf06", "committedDate": "2020-02-25T16:25:25Z", "message": "Remove `SpatialRule.EMPTY`"}, "afterCommit": {"oid": "affbc05bc34a3c49e763300bc57572f1e9e4aa7f", "author": {"user": null}, "url": "https://github.com/graphhopper/graphhopper/commit/affbc05bc34a3c49e763300bc57572f1e9e4aa7f", "committedDate": "2020-03-04T08:27:41Z", "message": "Remove `SpatialRule.EMPTY`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxOTI5NzU1", "url": "https://github.com/graphhopper/graphhopper/pull/1903#pullrequestreview-371929755", "createdAt": "2020-03-10T13:04:07Z", "commit": {"oid": "affbc05bc34a3c49e763300bc57572f1e9e4aa7f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMzowNDowN1rOF0Nz-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMzowNDowN1rOF0Nz-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI5NjU3MQ==", "bodyText": "Why is sorting necessary?\nSee https://github.com/graphhopper/graphhopper/pull/1911/files#diff-e313449003aba3db12b92952cd486e32L85-L87 where I had to remove it to avoid problems.", "url": "https://github.com/graphhopper/graphhopper/pull/1903#discussion_r390296571", "createdAt": "2020-03-10T13:04:07Z", "author": {"login": "karussell"}, "path": "core/src/main/java/com/graphhopper/routing/util/spatialrules/SpatialRuleLookupJTS.java", "diffHunk": "@@ -17,110 +17,113 @@\n  */\n package com.graphhopper.routing.util.spatialrules;\n \n-import com.graphhopper.util.shapes.GHPoint;\n+import java.util.*;\n+\n import org.locationtech.jts.geom.*;\n import org.locationtech.jts.index.strtree.STRtree;\n \n-import java.util.*;\n-\n /**\n  * @author Thomas Butz\n  */\n public class SpatialRuleLookupJTS implements SpatialRuleLookup {\n-\n+    \n+    private static final Comparator<SpatialRule> RULE_COMP = new Comparator<SpatialRule>() {\n+\n+        @Override\n+        public int compare(SpatialRule o1, SpatialRule o2) {\n+            int comp = Integer.compare(o1.getPriority(), o2.getPriority());\n+            if (comp != 0) {\n+                return comp;\n+            }\n+            \n+            return o1.getId().compareTo(o2.getId());\n+        }\n+    };\n+    \n     private final GeometryFactory geometryFactory = new GeometryFactory();\n     private final List<SpatialRule> rules;\n     private final Envelope maxBounds;\n     private final STRtree index;\n-\n+    \n     public SpatialRuleLookupJTS(List<SpatialRule> spatialRules, Envelope maxBounds) {\n         this.index = new STRtree();\n-\n+        \n         Map<Polygon, SpatialRuleContainer> containerMap = new HashMap<>();\n+        List<SpatialRule> registeredRules = new ArrayList<>();\n         Set<String> ruleIDs = new HashSet<>();\n         for (SpatialRule rule : spatialRules) {\n             if (rule == null)\n                 throw new IllegalArgumentException(\"rule cannot be null\");\n-\n-            if (rule.equals(SpatialRule.EMPTY))\n-                throw new IllegalArgumentException(\"rule cannot be EMPTY\");\n-\n+            \n             if (!ruleIDs.add(rule.getId()))\n                 throw new IllegalArgumentException(\"Duplicate rule ID: \\\"\" + rule.getId() + \"\\\"\");\n-\n+            \n+            boolean registered = false;\n             for (Polygon border : rule.getBorders()) {\n                 Envelope borderEnvelope = border.getEnvelopeInternal();\n                 if (!maxBounds.intersects(borderEnvelope)) {\n                     continue;\n                 }\n-\n+                \n                 SpatialRuleContainer container = containerMap.get(border);\n                 if (container == null) {\n                     container = new SpatialRuleContainer(border);\n                     containerMap.put(border, container);\n                     index.insert(borderEnvelope, container);\n                 }\n                 container.addRule(rule);\n+                registered = true;\n+            }\n+            \n+            if (registered) {\n+                registeredRules.add(rule);\n             }\n         }\n \n         index.build();\n \n-        this.rules = new ArrayList<>();\n-        rules.add(SpatialRule.EMPTY);\n-        rules.addAll(spatialRules);\n+        Collections.sort(registeredRules, RULE_COMP); // keep the spatial id stable", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "affbc05bc34a3c49e763300bc57572f1e9e4aa7f"}, "originalPosition": 84}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "affbc05bc34a3c49e763300bc57572f1e9e4aa7f", "author": {"user": null}, "url": "https://github.com/graphhopper/graphhopper/commit/affbc05bc34a3c49e763300bc57572f1e9e4aa7f", "committedDate": "2020-03-04T08:27:41Z", "message": "Remove `SpatialRule.EMPTY`"}, "afterCommit": {"oid": "e8d1b56632906335fec30b295033f7557b51eca0", "author": {"user": null}, "url": "https://github.com/graphhopper/graphhopper/commit/e8d1b56632906335fec30b295033f7557b51eca0", "committedDate": "2020-03-11T10:29:59Z", "message": "Don't reorder rules"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed9ae988ceae2986831f0e2832ea068c6489d034", "author": {"user": null}, "url": "https://github.com/graphhopper/graphhopper/commit/ed9ae988ceae2986831f0e2832ea068c6489d034", "committedDate": "2020-03-16T07:50:54Z", "message": "Allow rules to be sorted according to a priority score"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adf87d0294a1135894ba3526233113ab12335b80", "author": {"user": null}, "url": "https://github.com/graphhopper/graphhopper/commit/adf87d0294a1135894ba3526233113ab12335b80", "committedDate": "2020-03-16T07:50:54Z", "message": "Define a ruleset"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fd873f8ac3941752447200c7fb22537c868c562", "author": {"user": null}, "url": "https://github.com/graphhopper/graphhopper/commit/7fd873f8ac3941752447200c7fb22537c868c562", "committedDate": "2020-03-16T07:50:54Z", "message": "Handle sorting inside the SpatialRuleLookup implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7ecb4eaf9070202c45bb959b9b2372446c0c439", "author": {"user": null}, "url": "https://github.com/graphhopper/graphhopper/commit/d7ecb4eaf9070202c45bb959b9b2372446c0c439", "committedDate": "2020-03-16T07:58:24Z", "message": "Return multiple rules per location"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d5fffb881e9173704f34360d311866d6a40aa00", "author": {"user": null}, "url": "https://github.com/graphhopper/graphhopper/commit/2d5fffb881e9173704f34360d311866d6a40aa00", "committedDate": "2020-03-16T07:58:24Z", "message": "Only keep rules within the bounds"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfcc758ffba05899fee754a8a6a000e4cd68203f", "author": {"user": null}, "url": "https://github.com/graphhopper/graphhopper/commit/dfcc758ffba05899fee754a8a6a000e4cd68203f", "committedDate": "2020-03-16T07:58:24Z", "message": "Remove `SpatialRule.EMPTY`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a55d9eedb354a7fcd920c2ab9838dc8dc1a94b8", "author": {"user": null}, "url": "https://github.com/graphhopper/graphhopper/commit/3a55d9eedb354a7fcd920c2ab9838dc8dc1a94b8", "committedDate": "2020-03-16T07:58:24Z", "message": "Don't reorder rules"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e8d1b56632906335fec30b295033f7557b51eca0", "author": {"user": null}, "url": "https://github.com/graphhopper/graphhopper/commit/e8d1b56632906335fec30b295033f7557b51eca0", "committedDate": "2020-03-11T10:29:59Z", "message": "Don't reorder rules"}, "afterCommit": {"oid": "3a55d9eedb354a7fcd920c2ab9838dc8dc1a94b8", "author": {"user": null}, "url": "https://github.com/graphhopper/graphhopper/commit/3a55d9eedb354a7fcd920c2ab9838dc8dc1a94b8", "committedDate": "2020-03-16T07:58:24Z", "message": "Don't reorder rules"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MTEzMjUw", "url": "https://github.com/graphhopper/graphhopper/pull/1903#pullrequestreview-375113250", "createdAt": "2020-03-16T11:12:01Z", "commit": {"oid": "3a55d9eedb354a7fcd920c2ab9838dc8dc1a94b8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMToxMjowMVrOF2vZKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMToxMjowMVrOF2vZKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk0MzkxNQ==", "bodyText": "Why do we need to add 1 when storing it into the edge? Also we should state it returns \"EMPTY.getSpatialId\" if it doesn't contain any rules.", "url": "https://github.com/graphhopper/graphhopper/pull/1903#discussion_r392943915", "createdAt": "2020-03-16T11:12:01Z", "author": {"login": "karussell"}, "path": "core/src/main/java/com/graphhopper/routing/util/spatialrules/SpatialRuleSet.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ *  Licensed to GraphHopper GmbH under one or more contributor\n+ *  license agreements. See the NOTICE file distributed with this work for\n+ *  additional information regarding copyright ownership.\n+ *\n+ *  GraphHopper GmbH licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except in\n+ *  compliance with the License. You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package com.graphhopper.routing.util.spatialrules;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+import com.graphhopper.routing.profiles.RoadAccess;\n+import com.graphhopper.routing.profiles.RoadClass;\n+\n+/**\n+ * Contains all rules which are applicable for a certain position.\n+ * \n+ * @author Thomas Butz\n+ */\n+public class SpatialRuleSet {\n+    public static final SpatialRuleSet EMPTY = new SpatialRuleSet(Collections.<SpatialRule>emptyList(), -1);\n+    \n+    private final List<SpatialRule> rules;\n+    private final int spatialId;\n+\n+    /**\n+     * @param rules     a List of rules, ordered according to how they are to be applied\n+     * @param spatialId the index of the rule with the highest priority\n+     */\n+    public SpatialRuleSet(List<SpatialRule> rules, int spatialId) {\n+        this.rules = Collections.unmodifiableList(rules);\n+        this.spatialId = spatialId;\n+    }\n+    \n+    /**\n+     * Return the max speed for a certain road class.\n+     *\n+     * @param roadClass       The highway type, e.g. {@link RoadClass#MOTORWAY}\n+     * @param transport       The mode of transportation\n+     * @param currentMaxSpeed The current max speed value or -1 if no value has been set yet\n+     * @return the maximum speed value to be used\n+     */\n+    public double getMaxSpeed(RoadClass roadClass, TransportationMode transport, double currentMaxSpeed) {\n+        double value = currentMaxSpeed;\n+        for (SpatialRule rule : rules) {\n+            value = rule.getMaxSpeed(roadClass, transport, value);\n+        }\n+        return value;\n+    }\n+\n+    /**\n+     * Returns the {@link RoadAccess} for a certain highway type and transportation mode.\n+     *\n+     * @param roadClass          The highway type, e.g. {@link RoadClass#MOTORWAY}\n+     * @param transport          The mode of transportation\n+     * @param currentRoadAccess  The current road access value (default: {@link RoadAccess#YES})\n+     * @return the type of access to be used\n+     */\n+    public RoadAccess getAccess(RoadClass roadClass, TransportationMode transport, RoadAccess currentRoadAccess) {\n+        RoadAccess value = currentRoadAccess;\n+        for (SpatialRule rule : rules) {\n+            value = rule.getAccess(roadClass, transport, value);\n+        }\n+        return value;\n+    }\n+    \n+    /**\n+     * @return the rules in this set\n+     */\n+    public List<SpatialRule> getRules() {\n+        return rules;\n+    }\n+\n+    /**\n+     * @return the index of the rule with the highest priority or\n+     *         <i>-1</i> if the set doesn't contain any rules\n+     */\n+    public int getSpatialId() {\n+        return spatialId;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a55d9eedb354a7fcd920c2ab9838dc8dc1a94b8"}, "originalPosition": 91}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a87f0d103e7ca3510b787c282c07dc34f7b03079", "author": {"user": null}, "url": "https://github.com/graphhopper/graphhopper/commit/a87f0d103e7ca3510b787c282c07dc34f7b03079", "committedDate": "2020-03-23T12:00:30Z", "message": "Use spatial id 0 to represent no rule"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "704e016a3d2bc74b035b194ce7ceb0c8d27c7acb", "author": {"user": {"login": "boldtrn", "name": "Robin"}}, "url": "https://github.com/graphhopper/graphhopper/commit/704e016a3d2bc74b035b194ce7ceb0c8d27c7acb", "committedDate": "2020-04-14T13:57:42Z", "message": "Add a testcase for overlapping rules"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "00996dbd295babf805d92d414f77010150c16403", "author": {"user": null}, "url": "https://github.com/graphhopper/graphhopper/commit/00996dbd295babf805d92d414f77010150c16403", "committedDate": "2020-04-14T13:57:01Z", "message": "Add a testcase for overlapping rules"}, "afterCommit": {"oid": "704e016a3d2bc74b035b194ce7ceb0c8d27c7acb", "author": {"user": {"login": "boldtrn", "name": "Robin"}}, "url": "https://github.com/graphhopper/graphhopper/commit/704e016a3d2bc74b035b194ce7ceb0c8d27c7acb", "committedDate": "2020-04-14T13:57:42Z", "message": "Add a testcase for overlapping rules"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMDE5MjIz", "url": "https://github.com/graphhopper/graphhopper/pull/1903#pullrequestreview-393019223", "createdAt": "2020-04-14T15:03:50Z", "commit": {"oid": "704e016a3d2bc74b035b194ce7ceb0c8d27c7acb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "159602212a4d0893d5ad3fadf4c5c3b4ae2350cd", "author": {"user": {"login": "karussell", "name": "Peter"}}, "url": "https://github.com/graphhopper/graphhopper/commit/159602212a4d0893d5ad3fadf4c5c3b4ae2350cd", "committedDate": "2020-04-14T16:15:11Z", "message": "Merge branch 'master' into ruleset"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMDAyMTk5", "url": "https://github.com/graphhopper/graphhopper/pull/1903#pullrequestreview-400002199", "createdAt": "2020-04-24T14:34:09Z", "commit": {"oid": "159602212a4d0893d5ad3fadf4c5c3b4ae2350cd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNDozNDowOVrOGLaoXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNDozNDowOVrOGLaoXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYyMzgzOQ==", "bodyText": "@otbutz if the first SpatialRule is always available should we provide a convenient method for this? Or will it be rather rare use case?", "url": "https://github.com/graphhopper/graphhopper/pull/1903#discussion_r414623839", "createdAt": "2020-04-24T14:34:09Z", "author": {"login": "karussell"}, "path": "core/src/main/java/com/graphhopper/routing/lm/LandmarkStorage.java", "diffHunk": "@@ -464,10 +464,10 @@ protected IntHashSet findBorderEdgeIds(SpatialRuleLookup ruleLookup) {\n         IntHashSet inaccessible = new IntHashSet();\n         while (allEdgesIterator.next()) {\n             int adjNode = allEdgesIterator.getAdjNode();\n-            SpatialRule ruleAdj = ruleLookup.lookupRule(nodeAccess.getLatitude(adjNode), nodeAccess.getLongitude(adjNode));\n+            SpatialRule ruleAdj = ruleLookup.lookupRules(nodeAccess.getLatitude(adjNode), nodeAccess.getLongitude(adjNode)).getRules().get(0);\n \n             int baseNode = allEdgesIterator.getBaseNode();\n-            SpatialRule ruleBase = ruleLookup.lookupRule(nodeAccess.getLatitude(baseNode), nodeAccess.getLongitude(baseNode));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "159602212a4d0893d5ad3fadf4c5c3b4ae2350cd"}, "originalPosition": 26}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4558, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}