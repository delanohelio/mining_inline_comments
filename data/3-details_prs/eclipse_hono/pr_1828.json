{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2NjY2MjQ1", "number": 1828, "title": "[#1272] Implement new Device Connection API methods", "bodyText": "This is for #1272:\nAdds an implementation for the new Device Connection API methods to the Infinispan client.", "createdAt": "2020-03-11T12:41:28Z", "url": "https://github.com/eclipse/hono/pull/1828", "merged": true, "mergeCommit": {"oid": "2760ef2abea9015a4b0b4095effae3c67b24e79c"}, "closed": true, "closedAt": "2020-03-16T12:06:32Z", "author": {"login": "calohmn"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMmlJ-gFqTM3MjcyNTk0Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOKqPwgFqTM3NTAzNDMzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNzI1OTQ2", "url": "https://github.com/eclipse/hono/pull/1828#pullrequestreview-372725946", "createdAt": "2020-03-11T12:48:51Z", "commit": {"oid": "0f22270cce271059d9003e3d48adf421458d03bc"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMjo0ODo1MlrOF01dRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMjo0OTo1OFrOF01fsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk0NjExOA==", "bodyText": "final ?", "url": "https://github.com/eclipse/hono/pull/1828#discussion_r390946118", "createdAt": "2020-03-11T12:48:52Z", "author": {"login": "sophokles73"}, "path": "client-device-connection-infinispan/src/main/java/org/eclipse/hono/deviceconnection/infinispan/client/Versioned.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+\n+package org.eclipse.hono.deviceconnection.infinispan.client;\n+\n+/**\n+ * A versioned entry.\n+ * \n+ * @param <T> The payload type.\n+ */\n+public class Versioned<T> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f22270cce271059d9003e3d48adf421458d03bc"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk0NjczOQ==", "bodyText": "what do we need this for?", "url": "https://github.com/eclipse/hono/pull/1828#discussion_r390946739", "createdAt": "2020-03-11T12:49:58Z", "author": {"login": "sophokles73"}, "path": "bom/pom.xml", "diffHunk": "@@ -545,6 +545,11 @@\n         <artifactId>infinispan-client-hotrod</artifactId>\n         <version>${infinispan.version}</version>\n       </dependency>\n+      <dependency>\n+        <groupId>org.infinispan</groupId>\n+        <artifactId>infinispan-query-dsl</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f22270cce271059d9003e3d48adf421458d03bc"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNzI3MzU0", "url": "https://github.com/eclipse/hono/pull/1828#pullrequestreview-372727354", "createdAt": "2020-03-11T12:50:56Z", "commit": {"oid": "0f22270cce271059d9003e3d48adf421458d03bc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMjo1MDo1NlrOF01hxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMjo1MDo1NlrOF01hxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk0NzI2OQ==", "bodyText": "Since the HotrodCache class uses a org.infinispan.client.hotrod.RemoteCache field now (instead of org.infinispan.commons.api.BasicCache), this mock had to be changed.\nUnfortunately, the org.infinispan.client.hotrod.RemoteCache has a dependency on the infinispan-query-dsl module (for the retrieveEntriesByQuery method) and without having that module integrated, creating the mock here will fail.\nTherefore I've added infinispan-query-dsl as a test-only dependency (CQ still needed for that). As alternative option, I only see removing this test class.", "url": "https://github.com/eclipse/hono/pull/1828#discussion_r390947269", "createdAt": "2020-03-11T12:50:56Z", "author": {"login": "calohmn"}, "path": "client-device-connection-infinispan/src/test/java/org/eclipse/hono/deviceconnection/infinispan/client/HotrodCacheTest.java", "diffHunk": "@@ -152,10 +161,149 @@ void testPutFails(final VertxTestContext ctx) {\n             }));\n     }\n \n-    private BasicCache<Object, Object> givenAConnectedCache() {\n+    /**\n+     * Verifies that a request to remove a cache entry with a version\n+     * results in the value being removed in the data grid.\n+     *\n+     * @param ctx The vert.x text context.\n+     */\n+    @Test\n+    void testRemoveWithVersionSucceeds(final VertxTestContext ctx) {\n+        final org.infinispan.client.hotrod.RemoteCache<Object, Object> grid = givenAConnectedCache();\n+        when(grid.removeWithVersion(anyString(), anyLong())).thenReturn(true);\n+        cache.connect()\n+                .compose(c -> c.removeWithVersion(\"key\", 1L))\n+                .setHandler(ctx.succeeding(v -> {\n+                    ctx.verify(() -> {\n+                        verify(grid).removeWithVersion(\"key\", 1L);\n+                        assertThat(v).isTrue();\n+                    });\n+                    ctx.completeNow();\n+                }));\n+    }\n+\n+    /**\n+     * Verifies that a request to remove a cache entry with a version\n+     * fails with the root cause for the failure to access the data grid.\n+     *\n+     * @param ctx The vert.x text context.\n+     */\n+    @Test\n+    void testRemoveWithVersionFails(final VertxTestContext ctx) {\n+        final org.infinispan.client.hotrod.RemoteCache<Object, Object> grid = givenAConnectedCache();\n+        when(grid.removeWithVersion(anyString(), anyLong())).thenThrow(new IllegalStateException());\n+        cache.connect()\n+                .compose(c -> c.removeWithVersion(\"key\", 1L))\n+                .setHandler(ctx.failing(t -> {\n+                    ctx.verify(() -> {\n+                        verify(grid).removeWithVersion(\"key\", 1L);\n+                        assertThat(t).isInstanceOf(IllegalStateException.class);\n+                    });\n+                    ctx.completeNow();\n+                }));\n+    }\n+\n+    /**\n+     * Verifies that a request to get a cache entry along with its version\n+     * results in the value being retrieved from the data grid.\n+     *\n+     * @param ctx The vert.x text context.\n+     */\n+    @Test\n+    void testGetWithVersionSucceeds(final VertxTestContext ctx) {\n+        final org.infinispan.client.hotrod.RemoteCache<Object, Object> grid = givenAConnectedCache();\n+        @SuppressWarnings(\"unchecked\")\n+        final MetadataValue<Object> metadataValue = mock(MetadataValue.class);\n+        final Object value = \"testValue\";\n+        when(metadataValue.getValue()).thenReturn(value);\n+        final long version = 1L;\n+        when(metadataValue.getVersion()).thenReturn(version);\n+        when(grid.getWithMetadata(anyString())).thenReturn(metadataValue);\n+        cache.connect()\n+                .compose(c -> c.getWithVersion(\"key\"))\n+                .setHandler(ctx.succeeding(v -> {\n+                    ctx.verify(() -> {\n+                        verify(grid).getWithMetadata(\"key\");\n+                        assertThat(v.getVersion()).isEqualTo(version);\n+                        assertThat(v.getValue()).isEqualTo(value);\n+                    });\n+                    ctx.completeNow();\n+                }));\n+    }\n+\n+    /**\n+     * Verifies that a request to get a cache entry along with its version\n+     * fails with the root cause for the failure to access the data grid.\n+     *\n+     * @param ctx The vert.x text context.\n+     */\n+    @Test\n+    void testGetWithVersionFails(final VertxTestContext ctx) {\n+        final org.infinispan.client.hotrod.RemoteCache<Object, Object> grid = givenAConnectedCache();\n+        when(grid.getWithMetadata(anyString())).thenThrow(new IllegalStateException());\n+        cache.connect()\n+                .compose(c -> c.getWithVersion(\"key\"))\n+                .setHandler(ctx.failing(t -> {\n+                    ctx.verify(() -> {\n+                        verify(grid).getWithMetadata(\"key\");\n+                        assertThat(t).isInstanceOf(IllegalStateException.class);\n+                    });\n+                    ctx.completeNow();\n+                }));\n+    }\n+\n+    /**\n+     * Verifies that a request to get a map of all cache entries with given keys\n+     * results in the map value being retrieved from the data grid.\n+     *\n+     * @param ctx The vert.x text context.\n+     */\n+    @Test\n+    void testGetAllSucceeds(final VertxTestContext ctx) {\n+        final org.infinispan.client.hotrod.RemoteCache<Object, Object> grid = givenAConnectedCache();\n+        final Map<Object, Object> mapValue = new HashMap<>();\n+        when(grid.getAll(anySet())).thenReturn(mapValue);\n+        final Set<String> keys = Set.of(\"key\");\n+        cache.connect()\n+                .compose(c -> c.getAll(keys))\n+                .setHandler(ctx.succeeding(v -> {\n+                    ctx.verify(() -> {\n+                        verify(grid).getAll(keys);\n+                        assertThat(v).isEqualTo(mapValue);\n+                    });\n+                    ctx.completeNow();\n+                }));\n+    }\n+\n+    /**\n+     * Verifies that a request to get a map of all cache entries with given keys\n+     * fails with the root cause for the failure to access the data grid.\n+     *\n+     * @param ctx The vert.x text context.\n+     */\n+    @Test\n+    void testGetAllFails(final VertxTestContext ctx) {\n+        final org.infinispan.client.hotrod.RemoteCache<Object, Object> grid = givenAConnectedCache();\n+        when(grid.getAll(anySet())).thenThrow(new IllegalStateException());\n+        final Set<String> keys = Set.of(\"key\");\n+        cache.connect()\n+                .compose(c -> c.getAll(keys))\n+                .setHandler(ctx.failing(t -> {\n+                    ctx.verify(() -> {\n+                        verify(grid).getAll(keys);\n+                        assertThat(t).isInstanceOf(IllegalStateException.class);\n+                    });\n+                    ctx.completeNow();\n+                }));\n+    }\n+\n+    private org.infinispan.client.hotrod.RemoteCache<Object, Object> givenAConnectedCache() {\n+        final Configuration configuration = mock(Configuration.class);\n         @SuppressWarnings(\"unchecked\")\n-        final BasicCache<Object, Object> result = mock(BasicCache.class);\n-        when(remoteCacheManager.getCache(anyString())).thenReturn(result);\n+        final org.infinispan.client.hotrod.RemoteCache<Object, Object> result = mock(org.infinispan.client.hotrod.RemoteCache.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f22270cce271059d9003e3d48adf421458d03bc"}, "originalPosition": 187}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0f22270cce271059d9003e3d48adf421458d03bc", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/0f22270cce271059d9003e3d48adf421458d03bc", "committedDate": "2020-03-11T12:38:33Z", "message": "[#1272] Implement new Device Connection API methods.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}, "afterCommit": {"oid": "66147524277f3efefad19f2c67040ae81b90b6ea", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/66147524277f3efefad19f2c67040ae81b90b6ea", "committedDate": "2020-03-11T14:46:22Z", "message": "[#1272] Implement new Device Connection API methods.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczNjA1OTEw", "url": "https://github.com/eclipse/hono/pull/1828#pullrequestreview-373605910", "createdAt": "2020-03-12T14:29:16Z", "commit": {"oid": "66147524277f3efefad19f2c67040ae81b90b6ea"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxNDoyOToxNlrOF1hBjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxNDoyOToxNlrOF1hBjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY1OTkxNg==", "bodyText": "the last known gateway id ?", "url": "https://github.com/eclipse/hono/pull/1828#discussion_r391659916", "createdAt": "2020-03-12T14:29:16Z", "author": {"login": "sophokles73"}, "path": "services/device-connection/src/test/java/org/eclipse/hono/deviceconnection/infinispan/RemoteCacheBasedDeviceConnectionServiceTest.java", "diffHunk": "@@ -139,4 +139,28 @@ public void testGetLastKnownGatewayForDeviceNotFound(final VertxTestContext ctx)\n             ctx.completeNow();\n         }));\n     }\n+\n+    /**\n+     * Verifies that the last known gateway id can be set via the <em>setCommandHandlingAdapterInstance</em> operation.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66147524277f3efefad19f2c67040ae81b90b6ea"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48812c147d8ec2a2ade479217cf30df9aa96caf4", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/48812c147d8ec2a2ade479217cf30df9aa96caf4", "committedDate": "2020-03-12T17:46:56Z", "message": "[#1272] Implement new Device Connection API methods.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "66147524277f3efefad19f2c67040ae81b90b6ea", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/66147524277f3efefad19f2c67040ae81b90b6ea", "committedDate": "2020-03-11T14:46:22Z", "message": "[#1272] Implement new Device Connection API methods.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}, "afterCommit": {"oid": "48812c147d8ec2a2ade479217cf30df9aa96caf4", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/48812c147d8ec2a2ade479217cf30df9aa96caf4", "committedDate": "2020-03-12T17:46:56Z", "message": "[#1272] Implement new Device Connection API methods.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MDM0MzMw", "url": "https://github.com/eclipse/hono/pull/1828#pullrequestreview-375034330", "createdAt": "2020-03-16T09:26:13Z", "commit": {"oid": "48812c147d8ec2a2ade479217cf30df9aa96caf4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 778, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}