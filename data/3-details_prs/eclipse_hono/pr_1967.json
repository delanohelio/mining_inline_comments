{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5NDc0ODcz", "number": 1967, "title": "[#1679] Part 2: Support updating credentials with secret ids", "bodyText": "With this PR, the Mongo DB based device registry extends support for updating the credentials with existing secret identifiers.\nThis PR needs to merged after the #1947.", "createdAt": "2020-05-18T12:40:07Z", "url": "https://github.com/eclipse/hono/pull/1967", "merged": true, "mergeCommit": {"oid": "8d40e142fc5ead20a941c25d67d2874fdc3bebe3"}, "closed": true, "closedAt": "2020-05-27T14:55:46Z", "author": {"login": "kaniyan"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABciwTeEgBqjMzNTA3MjY0NTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABclZlssgFqTQxOTIyNzY2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dbbe1bc4d047445e07809bf0cdb33d65c98be7c5", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/dbbe1bc4d047445e07809bf0cdb33d65c98be7c5", "committedDate": "2020-05-18T12:32:09Z", "message": "[#1679] Add provision to update credentials data with secret ids.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}, "afterCommit": {"oid": "98b7c991226574415a07b5fe9619715755e50012", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/98b7c991226574415a07b5fe9619715755e50012", "committedDate": "2020-05-19T08:04:23Z", "message": "[#1679] Add provision to update credentials data with secret ids.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "98b7c991226574415a07b5fe9619715755e50012", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/98b7c991226574415a07b5fe9619715755e50012", "committedDate": "2020-05-19T08:04:23Z", "message": "[#1679] Add provision to update credentials data with secret ids.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}, "afterCommit": {"oid": "a871d19a505b02d99e653f8fdac66d07efe3b768", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/a871d19a505b02d99e653f8fdac66d07efe3b768", "committedDate": "2020-05-19T09:54:32Z", "message": "[#1679] Add provision to update credentials data with secret ids\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a871d19a505b02d99e653f8fdac66d07efe3b768", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/a871d19a505b02d99e653f8fdac66d07efe3b768", "committedDate": "2020-05-19T09:54:32Z", "message": "[#1679] Add provision to update credentials data with secret ids\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}, "afterCommit": {"oid": "aa66bea8ecbaf01d4e43ae11cb9d0bf2507c0f82", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/aa66bea8ecbaf01d4e43ae11cb9d0bf2507c0f82", "committedDate": "2020-05-19T10:22:48Z", "message": "[#1679] Add provision to update credentials data with secret ids\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aa66bea8ecbaf01d4e43ae11cb9d0bf2507c0f82", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/aa66bea8ecbaf01d4e43ae11cb9d0bf2507c0f82", "committedDate": "2020-05-19T10:22:48Z", "message": "[#1679] Add provision to update credentials data with secret ids\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}, "afterCommit": {"oid": "563239639bdc1bb9515b791d43fd38d8fc01694a", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/563239639bdc1bb9515b791d43fd38d8fc01694a", "committedDate": "2020-05-20T08:20:37Z", "message": "[#1679] Add provision to update credentials data with secret ids\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "563239639bdc1bb9515b791d43fd38d8fc01694a", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/563239639bdc1bb9515b791d43fd38d8fc01694a", "committedDate": "2020-05-20T08:20:37Z", "message": "[#1679] Add provision to update credentials data with secret ids\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}, "afterCommit": {"oid": "c3ac8e8059302d175a1837736831c5f78478bdce", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/c3ac8e8059302d175a1837736831c5f78478bdce", "committedDate": "2020-05-20T12:52:38Z", "message": "[#1679] Add provision to update credentials data with secret ids\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c3ac8e8059302d175a1837736831c5f78478bdce", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/c3ac8e8059302d175a1837736831c5f78478bdce", "committedDate": "2020-05-20T12:52:38Z", "message": "[#1679] Add provision to update credentials data with secret ids\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}, "afterCommit": {"oid": "7ef1d5587d6199adaf662a49c8c04db25728abcb", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/7ef1d5587d6199adaf662a49c8c04db25728abcb", "committedDate": "2020-05-27T07:11:15Z", "message": "[#1679] Add provision to update credentials data with secret ids\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5MDA4MDI3", "url": "https://github.com/eclipse/hono/pull/1967#pullrequestreview-419008027", "createdAt": "2020-05-27T09:17:45Z", "commit": {"oid": "7ef1d5587d6199adaf662a49c8c04db25728abcb"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwOToxNzo0NVrOGbArsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwOToxOToxOVrOGbAvkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk3NTkyMw==", "bodyText": "why not getCredentialsDto and use the DTO's API to retrieve the credentials? As the name Data Transfer Object suggests, it should be used to transfer data to/from the persistence store, right? That way we also wouldn't require this method to have knowledge about the internal structure of the JSON document being stored in the DB ...", "url": "https://github.com/eclipse/hono/pull/1967#discussion_r430975923", "createdAt": "2020-05-27T09:17:45Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDbBasedCredentialsService.java", "diffHunk": "@@ -190,7 +208,7 @@ public MongoDbBasedCredentialsService(\n         Objects.requireNonNull(deviceKey);\n         Objects.requireNonNull(span);\n \n-        return findCredentials(deviceKey)\n+        return findCredentials(deviceKey, Optional.empty())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ef1d5587d6199adaf662a49c8c04db25728abcb"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk3NjQwNQ==", "bodyText": "I like this approach because it increases encapsulation \ud83d\udc4d", "url": "https://github.com/eclipse/hono/pull/1967#discussion_r430976405", "createdAt": "2020-05-27T09:18:29Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-base/src/main/java/org/eclipse/hono/service/management/credentials/CommonCredential.java", "diffHunk": "@@ -164,4 +167,46 @@ public void checkValidity() {\n     public CommonCredential stripPrivateInfo() {\n         return this;\n     }\n+\n+    /**\n+     * Merges the secrets of the given credential with that of the current one based on the secret ids.\n+     *\n+     * @param credential The credential to be merged.\n+     * @return a reference to this for fluent use.\n+     * @throws IllegalArgumentException if the given credential is invalid and cannot be merged.\n+     * @throws NullPointerException if the given credential is {@code null}.\n+     */\n+    @JsonIgnore\n+    public CommonCredential merge(final CommonCredential credential) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ef1d5587d6199adaf662a49c8c04db25728abcb"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk3NjkxMg==", "bodyText": "why don't we simply define a merge method on CommonSecret?", "url": "https://github.com/eclipse/hono/pull/1967#discussion_r430976912", "createdAt": "2020-05-27T09:19:19Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-base/src/main/java/org/eclipse/hono/service/management/credentials/CommonCredential.java", "diffHunk": "@@ -164,4 +167,46 @@ public void checkValidity() {\n     public CommonCredential stripPrivateInfo() {\n         return this;\n     }\n+\n+    /**\n+     * Merges the secrets of the given credential with that of the current one based on the secret ids.\n+     *\n+     * @param credential The credential to be merged.\n+     * @return a reference to this for fluent use.\n+     * @throws IllegalArgumentException if the given credential is invalid and cannot be merged.\n+     * @throws NullPointerException if the given credential is {@code null}.\n+     */\n+    @JsonIgnore\n+    public CommonCredential merge(final CommonCredential credential) {\n+\n+        Objects.requireNonNull(credential);\n+\n+        if (!getType().equals(credential.getType())) {\n+            throw new IllegalArgumentException(\"credential to be merged must be of the same type\");\n+        }\n+\n+        getSecrets()\n+                .forEach(secret -> Optional.ofNullable(secret.getId())\n+                        .ifPresent(secretId -> findSecretById(credential, secretId)\n+                                .map(result -> {\n+                                    if (secret instanceof PasswordSecret) {\n+                                        ((PasswordSecret) secret).merge((PasswordSecret) result);\n+                                    } else if (secret instanceof PskSecret) {\n+                                        ((PskSecret) secret).merge((PskSecret) result);\n+                                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ef1d5587d6199adaf662a49c8c04db25728abcb"}, "originalPosition": 43}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7ef1d5587d6199adaf662a49c8c04db25728abcb", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/7ef1d5587d6199adaf662a49c8c04db25728abcb", "committedDate": "2020-05-27T07:11:15Z", "message": "[#1679] Add provision to update credentials data with secret ids\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}, "afterCommit": {"oid": "0d5154872c07bbaba5c62cdaaf64b9ded2b0915a", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/0d5154872c07bbaba5c62cdaaf64b9ded2b0915a", "committedDate": "2020-05-27T10:20:01Z", "message": "[#1679] Add merge method to CommonSecret\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5MTEzNDQ2", "url": "https://github.com/eclipse/hono/pull/1967#pullrequestreview-419113446", "createdAt": "2020-05-27T11:49:38Z", "commit": {"oid": "0d5154872c07bbaba5c62cdaaf64b9ded2b0915a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMTo0OTozOFrOGbFopw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMTo1MDo1N1rOGbFreA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA1NzA2Mw==", "bodyText": "FMPOV we do not need the credentials parameter, do we?", "url": "https://github.com/eclipse/hono/pull/1967#discussion_r431057063", "createdAt": "2020-05-27T11:49:38Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-base/src/main/java/org/eclipse/hono/service/management/credentials/CommonCredential.java", "diffHunk": "@@ -164,4 +167,41 @@ public void checkValidity() {\n     public CommonCredential stripPrivateInfo() {\n         return this;\n     }\n+\n+    /**\n+     * Merges the secrets of the given credential with that of the current one based on the secret ids.\n+     *\n+     * @param credential The credential to be merged.\n+     * @return a reference to this for fluent use.\n+     * @throws IllegalArgumentException if the given credential is invalid and cannot be merged.\n+     * @throws NullPointerException if the given credential is {@code null}.\n+     */\n+    @JsonIgnore\n+    public CommonCredential merge(final CommonCredential credential) {\n+\n+        Objects.requireNonNull(credential);\n+\n+        if (!getType().equals(credential.getType())) {\n+            throw new IllegalArgumentException(\"credential to be merged must be of the same type\");\n+        }\n+\n+        getSecrets()\n+                .forEach(secret -> Optional.ofNullable(secret.getId())\n+                        .ifPresent(secretId -> findSecretById(credential, secretId)\n+                                .ifPresentOrElse(secret::merge, () -> {\n+                                    throw new IllegalArgumentException(\n+                                            String.format(\"secret [id: %s] not found\", secret.getId()));\n+                                })));\n+\n+        return this;\n+    }\n+\n+\n+    private Optional<? extends CommonSecret> findSecretById(final CommonCredential credential, final String secretId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d5154872c07bbaba5c62cdaaf64b9ded2b0915a"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA1Nzc4NA==", "bodyText": "My point was to add an empty method at this level which would then be overridden by PasswordSecret and PskSecret. The way you have implemented it couples the generic CommonSecrets to some of its subclasses ...", "url": "https://github.com/eclipse/hono/pull/1967#discussion_r431057784", "createdAt": "2020-05-27T11:50:57Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-base/src/main/java/org/eclipse/hono/service/management/credentials/CommonSecret.java", "diffHunk": "@@ -160,4 +160,12 @@ public void checkValidity() {\n             }\n         }\n     }\n+\n+    void merge(final CommonSecret secret) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d5154872c07bbaba5c62cdaaf64b9ded2b0915a"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f50fdc05aaa06fb8d84ed66efbace9e2955e90c2", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/f50fdc05aaa06fb8d84ed66efbace9e2955e90c2", "committedDate": "2020-05-27T12:43:24Z", "message": "[#1679] Add provision to update credentials data with secret ids\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9f70e16cb47c0b97301585194729a98dcf7c036", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/e9f70e16cb47c0b97301585194729a98dcf7c036", "committedDate": "2020-05-27T12:43:24Z", "message": "[#1679] Minor improvements\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0d5154872c07bbaba5c62cdaaf64b9ded2b0915a", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/0d5154872c07bbaba5c62cdaaf64b9ded2b0915a", "committedDate": "2020-05-27T10:20:01Z", "message": "[#1679] Add merge method to CommonSecret\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}, "afterCommit": {"oid": "5c9f2ec7f7659cab0b57b9533a2183e4e26d91ca", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/5c9f2ec7f7659cab0b57b9533a2183e4e26d91ca", "committedDate": "2020-05-27T12:43:24Z", "message": "[#1679] Add merge method to CommonSecret\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "662fdaf161dc5c17248ea7f70af03195608636cb", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/662fdaf161dc5c17248ea7f70af03195608636cb", "committedDate": "2020-05-27T12:57:43Z", "message": "[#1679] Add merge method to CommonSecret\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5c9f2ec7f7659cab0b57b9533a2183e4e26d91ca", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/5c9f2ec7f7659cab0b57b9533a2183e4e26d91ca", "committedDate": "2020-05-27T12:43:24Z", "message": "[#1679] Add merge method to CommonSecret\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}, "afterCommit": {"oid": "662fdaf161dc5c17248ea7f70af03195608636cb", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/662fdaf161dc5c17248ea7f70af03195608636cb", "committedDate": "2020-05-27T12:57:43Z", "message": "[#1679] Add merge method to CommonSecret\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5MTkwODE0", "url": "https://github.com/eclipse/hono/pull/1967#pullrequestreview-419190814", "createdAt": "2020-05-27T13:12:37Z", "commit": {"oid": "662fdaf161dc5c17248ea7f70af03195608636cb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMzoxMjozOFrOGbJHpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMzoxMjozOFrOGbJHpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTExNDE1MQ==", "bodyText": "I think that this method deserves a JavaDoc comment, doesn't it?", "url": "https://github.com/eclipse/hono/pull/1967#discussion_r431114151", "createdAt": "2020-05-27T13:12:38Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-base/src/main/java/org/eclipse/hono/service/management/credentials/CommonSecret.java", "diffHunk": "@@ -160,4 +160,7 @@ public void checkValidity() {\n             }\n         }\n     }\n+\n+    void merge(final CommonSecret secret) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "662fdaf161dc5c17248ea7f70af03195608636cb"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89ceb974c8b2098a8e3b76827ae23ab68019e7e2", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/89ceb974c8b2098a8e3b76827ae23ab68019e7e2", "committedDate": "2020-05-27T13:44:04Z", "message": "[#1679] Add javadoc\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5MjI3NjY1", "url": "https://github.com/eclipse/hono/pull/1967#pullrequestreview-419227665", "createdAt": "2020-05-27T13:50:05Z", "commit": {"oid": "89ceb974c8b2098a8e3b76827ae23ab68019e7e2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 623, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}