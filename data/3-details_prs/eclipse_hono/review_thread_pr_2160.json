{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgxMTg0NTUz", "number": 2160, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwOToyNTowNVrOEg2_Vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwOToyNTowNVrOEg2_Vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyODkwODM4OnYy", "diffSide": "RIGHT", "path": "adapters/coap-vertx-base/src/main/java/org/eclipse/hono/adapter/coap/AbstractVertxBasedCoapAdapter.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwOToyNTowNVrOHN30FQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNzoyMjozOVrOHOP_2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDMwNzk4OQ==", "bodyText": "Is that change from tenantValidationTracker to tenantTracker intended?", "url": "https://github.com/eclipse/hono/pull/2160#discussion_r484307989", "createdAt": "2020-09-07T09:25:05Z", "author": {"login": "boaks"}, "path": "adapters/coap-vertx-base/src/main/java/org/eclipse/hono/adapter/coap/AbstractVertxBasedCoapAdapter.java", "diffHunk": "@@ -745,15 +749,16 @@ protected final String getAuthId(final CoapExchange exchange) {\n             return CompositeFuture.join(senderTracker, commandConsumerTracker)\n             .compose(ok -> {\n                 final DownstreamSender sender = senderTracker.result();\n-                final Integer ttd = ttdTracker.result();\n+                final Integer ttd = Optional.ofNullable(commandConsumerTracker.result())\n+                        .map(c -> ttdTracker.result())\n+                        .orElse(null);\n                 final Message downstreamMessage = newMessage(\n                         context.getRequestedQos(),\n-                        ResourceIdentifier.from(endpoint.getCanonicalName(), context.getOriginDevice().getTenantId(),\n-                                context.getOriginDevice().getDeviceId()),\n+                        ResourceIdentifier.from(endpoint.getCanonicalName(), tenantId, deviceId),\n                         \"/\" + context.getExchange().getRequestOptions().getUriPathString(),\n                         contentType,\n                         payload,\n-                        tenantValidationTracker.result(),\n+                        tenantTracker.result(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "268728a32bdbb6c50e9d843b31778ecc433abec3"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDMxNzM1Ng==", "bodyText": "Yes. It makes the code more in line with the corresponding code from the HTTP adapter and makes it more obvious that it is about the returned TenantObject here. In the following lines the tenant object is accessed via tenantTracker.result() as well.", "url": "https://github.com/eclipse/hono/pull/2160#discussion_r484317356", "createdAt": "2020-09-07T09:40:53Z", "author": {"login": "calohmn"}, "path": "adapters/coap-vertx-base/src/main/java/org/eclipse/hono/adapter/coap/AbstractVertxBasedCoapAdapter.java", "diffHunk": "@@ -745,15 +749,16 @@ protected final String getAuthId(final CoapExchange exchange) {\n             return CompositeFuture.join(senderTracker, commandConsumerTracker)\n             .compose(ok -> {\n                 final DownstreamSender sender = senderTracker.result();\n-                final Integer ttd = ttdTracker.result();\n+                final Integer ttd = Optional.ofNullable(commandConsumerTracker.result())\n+                        .map(c -> ttdTracker.result())\n+                        .orElse(null);\n                 final Message downstreamMessage = newMessage(\n                         context.getRequestedQos(),\n-                        ResourceIdentifier.from(endpoint.getCanonicalName(), context.getOriginDevice().getTenantId(),\n-                                context.getOriginDevice().getDeviceId()),\n+                        ResourceIdentifier.from(endpoint.getCanonicalName(), tenantId, deviceId),\n                         \"/\" + context.getExchange().getRequestOptions().getUriPathString(),\n                         contentType,\n                         payload,\n-                        tenantValidationTracker.result(),\n+                        tenantTracker.result(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDMwNzk4OQ=="}, "originalCommit": {"oid": "268728a32bdbb6c50e9d843b31778ecc433abec3"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY5NDA5Mg==", "bodyText": "Is there a test, which demonstrates, that a failure in tenantValidationTracker is handled proper by that code?", "url": "https://github.com/eclipse/hono/pull/2160#discussion_r484694092", "createdAt": "2020-09-08T07:02:53Z", "author": {"login": "boaks"}, "path": "adapters/coap-vertx-base/src/main/java/org/eclipse/hono/adapter/coap/AbstractVertxBasedCoapAdapter.java", "diffHunk": "@@ -745,15 +749,16 @@ protected final String getAuthId(final CoapExchange exchange) {\n             return CompositeFuture.join(senderTracker, commandConsumerTracker)\n             .compose(ok -> {\n                 final DownstreamSender sender = senderTracker.result();\n-                final Integer ttd = ttdTracker.result();\n+                final Integer ttd = Optional.ofNullable(commandConsumerTracker.result())\n+                        .map(c -> ttdTracker.result())\n+                        .orElse(null);\n                 final Message downstreamMessage = newMessage(\n                         context.getRequestedQos(),\n-                        ResourceIdentifier.from(endpoint.getCanonicalName(), context.getOriginDevice().getTenantId(),\n-                                context.getOriginDevice().getDeviceId()),\n+                        ResourceIdentifier.from(endpoint.getCanonicalName(), tenantId, deviceId),\n                         \"/\" + context.getExchange().getRequestOptions().getUriPathString(),\n                         contentType,\n                         payload,\n-                        tenantValidationTracker.result(),\n+                        tenantTracker.result(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDMwNzk4OQ=="}, "originalCommit": {"oid": "268728a32bdbb6c50e9d843b31778ecc433abec3"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDcwNDIxNw==", "bodyText": "A failure in the tenantValidationTracker would cause the ttdTracker to fail and subsequently the commandConsumerTracker. A failed commandConsumerTracker will cause the above code block (sending the telemetry/event message) to not be entered anyway.\nA unit test in which a failed tenantValidationTracker is tested is AbstractVertxBasedCoapAdapterTest#testMessageLimitExceededForAnEventMessage.", "url": "https://github.com/eclipse/hono/pull/2160#discussion_r484704217", "createdAt": "2020-09-08T07:22:39Z", "author": {"login": "calohmn"}, "path": "adapters/coap-vertx-base/src/main/java/org/eclipse/hono/adapter/coap/AbstractVertxBasedCoapAdapter.java", "diffHunk": "@@ -745,15 +749,16 @@ protected final String getAuthId(final CoapExchange exchange) {\n             return CompositeFuture.join(senderTracker, commandConsumerTracker)\n             .compose(ok -> {\n                 final DownstreamSender sender = senderTracker.result();\n-                final Integer ttd = ttdTracker.result();\n+                final Integer ttd = Optional.ofNullable(commandConsumerTracker.result())\n+                        .map(c -> ttdTracker.result())\n+                        .orElse(null);\n                 final Message downstreamMessage = newMessage(\n                         context.getRequestedQos(),\n-                        ResourceIdentifier.from(endpoint.getCanonicalName(), context.getOriginDevice().getTenantId(),\n-                                context.getOriginDevice().getDeviceId()),\n+                        ResourceIdentifier.from(endpoint.getCanonicalName(), tenantId, deviceId),\n                         \"/\" + context.getExchange().getRequestOptions().getUriPathString(),\n                         contentType,\n                         payload,\n-                        tenantValidationTracker.result(),\n+                        tenantTracker.result(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDMwNzk4OQ=="}, "originalCommit": {"oid": "268728a32bdbb6c50e9d843b31778ecc433abec3"}, "originalPosition": 87}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3035, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}