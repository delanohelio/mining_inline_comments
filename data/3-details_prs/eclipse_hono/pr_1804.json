{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyOTkxMjM1", "number": 1804, "title": "[#1791] Allow hashed passwords credentials with a whitelist of algorithms", "bodyText": "Signed-off-by: Jean-Baptiste Trystram jbtrystram@redhat.com", "createdAt": "2020-03-03T14:42:49Z", "url": "https://github.com/eclipse/hono/pull/1804", "merged": true, "mergeCommit": {"oid": "d9aea13341b530af3b365de980a121805009cbb6"}, "closed": true, "closedAt": "2020-03-06T09:12:44Z", "author": {"login": "jbtrystram"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKDdv6ABqjMwOTI0NzE5MDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcK8eK7gFqTM3MDE3NTE2NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5809e293092c0ea508c4cade59e391ed324446c2", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/5809e293092c0ea508c4cade59e391ed324446c2", "committedDate": "2020-03-03T14:39:30Z", "message": "[#1791] Allow already hashed passwords credentials in the device registry with a whitelist of allowed hashing algorithms\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}, "afterCommit": {"oid": "b61473b0e82a6ec8292602d2116dc8c9f8450ae3", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/b61473b0e82a6ec8292602d2116dc8c9f8450ae3", "committedDate": "2020-03-03T14:45:14Z", "message": "[#1791] Allow already hashed passwords credentials in the device registry with a whitelist of allowed hashing algorithms\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b61473b0e82a6ec8292602d2116dc8c9f8450ae3", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/b61473b0e82a6ec8292602d2116dc8c9f8450ae3", "committedDate": "2020-03-03T14:45:14Z", "message": "[#1791] Allow already hashed passwords credentials in the device registry with a whitelist of allowed hashing algorithms\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}, "afterCommit": {"oid": "c248f2fccb99d3e6d72869e6751e4b0baaac2175", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/c248f2fccb99d3e6d72869e6751e4b0baaac2175", "committedDate": "2020-03-03T15:29:40Z", "message": "[#1791] Allow already hashed passwords credentials in the device registry with a whitelist of allowed hashing algorithms\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NTU2MjUz", "url": "https://github.com/eclipse/hono/pull/1804#pullrequestreview-368556253", "createdAt": "2020-03-04T07:37:27Z", "commit": {"oid": "c248f2fccb99d3e6d72869e6751e4b0baaac2175"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwNzozNzoyN1rOFximnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwNzozNzoyN1rOFximnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ5MTQ4NA==", "bodyText": "I would use a HashSet, rather than an array.", "url": "https://github.com/eclipse/hono/pull/1804#discussion_r387491484", "createdAt": "2020-03-04T07:37:27Z", "author": {"login": "ctron"}, "path": "services/device-registry-file/src/main/java/org/eclipse/hono/deviceregistry/file/AbstractFileBasedRegistryConfigProperties.java", "diffHunk": "@@ -31,6 +31,7 @@\n     private boolean modificationEnabled = true;\n     private boolean startEmpty = false;\n     private int cacheMaxAge = DEFAULT_MAX_AGE_SECONDS;\n+    private String[] hashAlgorithmsWhitelist = {};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c248f2fccb99d3e6d72869e6751e4b0baaac2175"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c248f2fccb99d3e6d72869e6751e4b0baaac2175", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/c248f2fccb99d3e6d72869e6751e4b0baaac2175", "committedDate": "2020-03-03T15:29:40Z", "message": "[#1791] Allow already hashed passwords credentials in the device registry with a whitelist of allowed hashing algorithms\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}, "afterCommit": {"oid": "3f31de9f66853cd733185ccd40015a295489c616", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/3f31de9f66853cd733185ccd40015a295489c616", "committedDate": "2020-03-04T08:40:05Z", "message": "[#1791] Allow already hashed passwords credentials in the device registry with a whitelist of allowed hashing algorithms\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NTg4NDIx", "url": "https://github.com/eclipse/hono/pull/1804#pullrequestreview-368588421", "createdAt": "2020-03-04T08:41:11Z", "commit": {"oid": "3f31de9f66853cd733185ccd40015a295489c616"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwODo0MToxMlrOFxkNDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwODo0MToxMlrOFxkNDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzUxNzcxMA==", "bodyText": "@ctron WDYT ?", "url": "https://github.com/eclipse/hono/pull/1804#discussion_r387517710", "createdAt": "2020-03-04T08:41:12Z", "author": {"login": "jbtrystram"}, "path": "services/device-registry-file/src/main/java/org/eclipse/hono/deviceregistry/file/AbstractFileBasedRegistryConfigProperties.java", "diffHunk": "@@ -164,4 +168,38 @@ public final boolean isStartEmpty() {\n     public final void setStartEmpty(final boolean flag) {\n         this.startEmpty = flag;\n     }\n+\n+    /**\n+     * Get the list of authorised hashing algorithms for already hashed passwords.\n+     * The device registry will not accept credentials using a hashing\n+     * algorithm that is not present in that list.\n+     * If the list is empty, the device registry will accept any hashing algorithm.\n+     * <p>\n+     * Default value is an empty HashSet.\n+     *\n+     * @return The list of authorized algorithms.\n+     */\n+    public Set<String> getHashAlgorithmsWhitelist() {\n+        return hashAlgorithmsWhitelist;\n+    }\n+\n+    /**\n+     * Set the list of authorised hashing algorithms for already hashed passwords.\n+     * The device registry will not accept credentials using a hashing\n+     * algorithm that is not present in that list.\n+     * <p>\n+     * The default value is empty.\n+     *\n+     * @param hashAlgorithmsWhitelist The list of authorized algorithms.\n+     */\n+    public void setHashAlgorithmsWhitelist(final String[] hashAlgorithmsWhitelist) {\n+\n+        final HashSet<String> set = new HashSet<>();\n+\n+        for (String s : hashAlgorithmsWhitelist) {\n+            set.add(s);\n+        }\n+\n+        this.hashAlgorithmsWhitelist = set;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f31de9f66853cd733185ccd40015a295489c616"}, "originalPosition": 72}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3f31de9f66853cd733185ccd40015a295489c616", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/3f31de9f66853cd733185ccd40015a295489c616", "committedDate": "2020-03-04T08:40:05Z", "message": "[#1791] Allow already hashed passwords credentials in the device registry with a whitelist of allowed hashing algorithms\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}, "afterCommit": {"oid": "3ed5bdea5c94dca2f8d9d948b8ca1f7516415b4c", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/3ed5bdea5c94dca2f8d9d948b8ca1f7516415b4c", "committedDate": "2020-03-04T09:01:39Z", "message": "[#1791] Allow already hashed passwords credentials in the device registry with a whitelist of allowed hashing algorithms\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NzcwMzU1", "url": "https://github.com/eclipse/hono/pull/1804#pullrequestreview-369770355", "createdAt": "2020-03-05T17:29:41Z", "commit": {"oid": "3ed5bdea5c94dca2f8d9d948b8ca1f7516415b4c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNzoyOTo0MVrOFyc_hA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNzo0NTo0M1rOFydiWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ0ODEzMg==", "bodyText": "We should probably use set instead of array here as well?", "url": "https://github.com/eclipse/hono/pull/1804#discussion_r388448132", "createdAt": "2020-03-05T17:29:41Z", "author": {"login": "dejanb"}, "path": "services/device-registry-file/src/main/java/org/eclipse/hono/deviceregistry/file/AbstractFileBasedRegistryConfigProperties.java", "diffHunk": "@@ -164,4 +168,34 @@ public final boolean isStartEmpty() {\n     public final void setStartEmpty(final boolean flag) {\n         this.startEmpty = flag;\n     }\n+\n+    /**\n+     * Get the list of authorised hashing algorithms for already hashed passwords.\n+     * The device registry will not accept credentials using a hashing\n+     * algorithm that is not present in that list.\n+     * If the list is empty, the device registry will accept any hashing algorithm.\n+     * <p>\n+     * Default value is an empty HashSet.\n+     *\n+     * @return The list of authorized algorithms.\n+     */\n+    public Set<String> getHashAlgorithmsWhitelist() {\n+        return hashAlgorithmsWhitelist;\n+    }\n+\n+    /**\n+     * Set the list of authorised hashing algorithms for already hashed passwords.\n+     * The device registry will not accept credentials using a hashing\n+     * algorithm that is not present in that list.\n+     * <p>\n+     * The default value is empty.\n+     *\n+     * @param hashAlgorithmsWhitelist The list of authorized algorithms.\n+     */\n+    public void setHashAlgorithmsWhitelist(final String[] hashAlgorithmsWhitelist) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ed5bdea5c94dca2f8d9d948b8ca1f7516415b4c"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ0ODk3OA==", "bodyText": "This should be checked before containsOnlySecretId() method call.", "url": "https://github.com/eclipse/hono/pull/1804#discussion_r388448978", "createdAt": "2020-03-05T17:31:12Z", "author": {"login": "dejanb"}, "path": "services/device-registry-file/src/main/java/org/eclipse/hono/deviceregistry/file/FileBasedCredentialsService.java", "diffHunk": "@@ -629,6 +631,33 @@ protected void checkCredential(final CommonCredential credential) {\n         }\n     }\n \n+    /**\n+     * Verifies that a hash algorithm in the supplied PasswordSecret is authorised.\n+     * <p>\n+     * The value must be present in the whitelist provided in the configuration\n+     * by {@link #getHashAlgorithmsWhitelist()}\n+     * If the whitelist is empty, any value will be accepted.\n+     *\n+     * @param secret The PasswordSecret object to verify.\n+     * @throws IllegalStateException if the hash algorithm provided in the PasswordSecret is not in the whitelist.\n+     */\n+    protected void verifyHashAlgorithmIsAuthorised(final PasswordSecret secret){\n+\n+        if (getHashAlgorithmsWhitelist().isEmpty()\n+            || secret.containsOnlySecretId()) {\n+            return;\n+        }\n+\n+        Objects.requireNonNull(secret);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ed5bdea5c94dca2f8d9d948b8ca1f7516415b4c"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ1NzA1MA==", "bodyText": "formatting ... space inside if() statement.", "url": "https://github.com/eclipse/hono/pull/1804#discussion_r388457050", "createdAt": "2020-03-05T17:45:43Z", "author": {"login": "dejanb"}, "path": "services/device-registry-file/src/main/java/org/eclipse/hono/deviceregistry/file/FileBasedCredentialsService.java", "diffHunk": "@@ -629,6 +631,33 @@ protected void checkCredential(final CommonCredential credential) {\n         }\n     }\n \n+    /**\n+     * Verifies that a hash algorithm in the supplied PasswordSecret is authorised.\n+     * <p>\n+     * The value must be present in the whitelist provided in the configuration\n+     * by {@link #getHashAlgorithmsWhitelist()}\n+     * If the whitelist is empty, any value will be accepted.\n+     *\n+     * @param secret The PasswordSecret object to verify.\n+     * @throws IllegalStateException if the hash algorithm provided in the PasswordSecret is not in the whitelist.\n+     */\n+    protected void verifyHashAlgorithmIsAuthorised(final PasswordSecret secret){\n+\n+        if (getHashAlgorithmsWhitelist().isEmpty()\n+            || secret.containsOnlySecretId()) {\n+            return;\n+        }\n+\n+        Objects.requireNonNull(secret);\n+        final String hashAlgorithm = secret.getHashFunction();\n+        Objects.requireNonNull(hashAlgorithm);\n+\n+        if ( getHashAlgorithmsWhitelist().contains(hashAlgorithm)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ed5bdea5c94dca2f8d9d948b8ca1f7516415b4c"}, "originalPosition": 41}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3ed5bdea5c94dca2f8d9d948b8ca1f7516415b4c", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/3ed5bdea5c94dca2f8d9d948b8ca1f7516415b4c", "committedDate": "2020-03-04T09:01:39Z", "message": "[#1791] Allow already hashed passwords credentials in the device registry with a whitelist of allowed hashing algorithms\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}, "afterCommit": {"oid": "383a043eeb8449c7205d2a8446e3d688b8522fad", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/383a043eeb8449c7205d2a8446e3d688b8522fad", "committedDate": "2020-03-06T08:01:32Z", "message": "[#1791] Allow already hashed passwords credentials in the device registry with a whitelist of allowed hashing algorithms\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "206327dc1d53ab7bdb4a738ba42fc44b83d1b298", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/206327dc1d53ab7bdb4a738ba42fc44b83d1b298", "committedDate": "2020-03-06T08:01:52Z", "message": "[#1791] Allow already hashed passwords credentials in the device registry with a whitelist of allowed hashing algorithms\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "383a043eeb8449c7205d2a8446e3d688b8522fad", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/383a043eeb8449c7205d2a8446e3d688b8522fad", "committedDate": "2020-03-06T08:01:32Z", "message": "[#1791] Allow already hashed passwords credentials in the device registry with a whitelist of allowed hashing algorithms\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}, "afterCommit": {"oid": "206327dc1d53ab7bdb4a738ba42fc44b83d1b298", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/206327dc1d53ab7bdb4a738ba42fc44b83d1b298", "committedDate": "2020-03-06T08:01:52Z", "message": "[#1791] Allow already hashed passwords credentials in the device registry with a whitelist of allowed hashing algorithms\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMTc1MTY0", "url": "https://github.com/eclipse/hono/pull/1804#pullrequestreview-370175164", "createdAt": "2020-03-06T09:12:35Z", "commit": {"oid": "206327dc1d53ab7bdb4a738ba42fc44b83d1b298"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 758, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}