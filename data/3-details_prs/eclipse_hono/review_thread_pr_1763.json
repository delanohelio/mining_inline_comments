{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczNzYzMDE0", "number": 1763, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwOTozMTo1MlrODfGs7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxMToyNTowOFrODfJDvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzOTQyMjUyOnYy", "diffSide": "RIGHT", "path": "service-base/src/main/java/org/eclipse/hono/service/management/credentials/AbstractCredentialsManagementHttpEndpoint.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwOTozMTo1MlrOFonUpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwOTozMTo1MlrOFonUpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEzMTYyMA==", "bodyText": "We moved this to the static field in other implementations.", "url": "https://github.com/eclipse/hono/pull/1763#discussion_r378131620", "createdAt": "2020-02-12T09:31:52Z", "author": {"login": "dejanb"}, "path": "service-base/src/main/java/org/eclipse/hono/service/management/credentials/AbstractCredentialsManagementHttpEndpoint.java", "diffHunk": "@@ -0,0 +1,265 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+\n+package org.eclipse.hono.service.management.credentials;\n+\n+import io.opentracing.Span;\n+import io.opentracing.tag.Tags;\n+import io.vertx.core.Promise;\n+import io.vertx.core.Vertx;\n+import io.vertx.core.http.HttpHeaders;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.core.http.HttpServerResponse;\n+import io.vertx.core.json.JsonArray;\n+import io.vertx.core.json.JsonObject;\n+import io.vertx.ext.web.Router;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.BodyHandler;\n+import java.net.HttpURLConnection;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+import org.eclipse.hono.client.ClientErrorException;\n+import org.eclipse.hono.config.ServiceConfigProperties;\n+import org.eclipse.hono.service.http.AbstractHttpEndpoint;\n+import org.eclipse.hono.service.http.HttpUtils;\n+import org.eclipse.hono.service.http.TracingHandler;\n+import org.eclipse.hono.service.management.OperationResult;\n+import org.eclipse.hono.service.management.Util;\n+\n+import org.eclipse.hono.tracing.TracingHelper;\n+import org.eclipse.hono.util.RegistryManagementConstants;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+/**\n+ * An {@code HttpEndpoint} for managing device credentials.\n+ * <p>\n+ * This endpoint implements Hono's <a href=\"https://www.eclipse.org/hono/docs/api/credentials//\">Credentials API</a>.\n+ * It receives HTTP requests representing operation invocations and forward them to the\n+ * Credential Management Service Implementation for processing.\n+ * The outcome is then returned to the client in the HTTP response.\n+ */\n+public abstract class AbstractCredentialsManagementHttpEndpoint extends AbstractHttpEndpoint<ServiceConfigProperties> {\n+\n+\n+    private static final String SPAN_NAME_GET_CREDENTIALS = \"get Credentials from management API\";\n+    private static final String SPAN_NAME_UPDATE_CREDENTIALS = \"update Credentials from management API\";\n+\n+    /**\n+     * Creates an endpoint for a Vertx instance.\n+     *\n+     * @param vertx The Vertx instance to use.\n+     * @throws NullPointerException if vertx is {@code null};\n+     */\n+    @Autowired\n+    public AbstractCredentialsManagementHttpEndpoint(final Vertx vertx) {\n+        super(Objects.requireNonNull(vertx));\n+    }\n+\n+    /**\n+     * Returns an empty String as this implementation does not use event bus.\n+     */\n+    @Override\n+    protected String getEventBusAddress() {\n+        return \"\";\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return String.format(\"%s/%s\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e065c6314bbe2a3fafdc2495ec01dac88eacd61"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzOTQyOTAwOnYy", "diffSide": "RIGHT", "path": "service-base/src/main/java/org/eclipse/hono/service/management/credentials/AbstractCredentialsManagementHttpEndpoint.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwOTozMzozNVrOFonYjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwOTozMzozNVrOFonYjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEzMjYyMQ==", "bodyText": "Take a look at how Util.getRequestParam() is used in tenant implementation. We should be consistent here and change device endpoint as well.", "url": "https://github.com/eclipse/hono/pull/1763#discussion_r378132621", "createdAt": "2020-02-12T09:33:35Z", "author": {"login": "dejanb"}, "path": "service-base/src/main/java/org/eclipse/hono/service/management/credentials/AbstractCredentialsManagementHttpEndpoint.java", "diffHunk": "@@ -0,0 +1,265 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+\n+package org.eclipse.hono.service.management.credentials;\n+\n+import io.opentracing.Span;\n+import io.opentracing.tag.Tags;\n+import io.vertx.core.Promise;\n+import io.vertx.core.Vertx;\n+import io.vertx.core.http.HttpHeaders;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.core.http.HttpServerResponse;\n+import io.vertx.core.json.JsonArray;\n+import io.vertx.core.json.JsonObject;\n+import io.vertx.ext.web.Router;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.BodyHandler;\n+import java.net.HttpURLConnection;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+import org.eclipse.hono.client.ClientErrorException;\n+import org.eclipse.hono.config.ServiceConfigProperties;\n+import org.eclipse.hono.service.http.AbstractHttpEndpoint;\n+import org.eclipse.hono.service.http.HttpUtils;\n+import org.eclipse.hono.service.http.TracingHandler;\n+import org.eclipse.hono.service.management.OperationResult;\n+import org.eclipse.hono.service.management.Util;\n+\n+import org.eclipse.hono.tracing.TracingHelper;\n+import org.eclipse.hono.util.RegistryManagementConstants;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+/**\n+ * An {@code HttpEndpoint} for managing device credentials.\n+ * <p>\n+ * This endpoint implements Hono's <a href=\"https://www.eclipse.org/hono/docs/api/credentials//\">Credentials API</a>.\n+ * It receives HTTP requests representing operation invocations and forward them to the\n+ * Credential Management Service Implementation for processing.\n+ * The outcome is then returned to the client in the HTTP response.\n+ */\n+public abstract class AbstractCredentialsManagementHttpEndpoint extends AbstractHttpEndpoint<ServiceConfigProperties> {\n+\n+\n+    private static final String SPAN_NAME_GET_CREDENTIALS = \"get Credentials from management API\";\n+    private static final String SPAN_NAME_UPDATE_CREDENTIALS = \"update Credentials from management API\";\n+\n+    /**\n+     * Creates an endpoint for a Vertx instance.\n+     *\n+     * @param vertx The Vertx instance to use.\n+     * @throws NullPointerException if vertx is {@code null};\n+     */\n+    @Autowired\n+    public AbstractCredentialsManagementHttpEndpoint(final Vertx vertx) {\n+        super(Objects.requireNonNull(vertx));\n+    }\n+\n+    /**\n+     * Returns an empty String as this implementation does not use event bus.\n+     */\n+    @Override\n+    protected String getEventBusAddress() {\n+        return \"\";\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return String.format(\"%s/%s\",\n+                RegistryManagementConstants.API_VERSION,\n+                RegistryManagementConstants.CREDENTIALS_HTTP_ENDPOINT);\n+    }\n+\n+    @Override\n+    public void addRoutes(final Router router) {\n+\n+        final String pathWithTenantAndDeviceId = String.format(\"/%s/:%s/:%s\",\n+                getName(), PARAM_TENANT_ID, PARAM_DEVICE_ID);\n+\n+\n+        // Add CORS handler\n+        router.route(pathWithTenantAndDeviceId).handler(createCorsHandler(config.getCorsAllowedOrigin(), EnumSet.of(HttpMethod.GET, HttpMethod.PUT)));\n+\n+        final BodyHandler bodyHandler = BodyHandler.create();\n+        bodyHandler.setBodyLimit(config.getMaxPayloadSize());\n+\n+        // get all credentials for a given device\n+        router.get(pathWithTenantAndDeviceId).handler(this::getCredentialsForDevice);\n+\n+        // set credentials for a given device\n+        router.put(pathWithTenantAndDeviceId).handler(bodyHandler);\n+        router.put(pathWithTenantAndDeviceId).handler(this::extractRequiredJsonArrayPayload);\n+        router.put(pathWithTenantAndDeviceId).handler(this::extractIfMatchVersionParam);\n+        router.put(pathWithTenantAndDeviceId).handler(this::updateCredentials);\n+    }\n+\n+\n+    /**\n+     * The service to forward requests to.\n+     *\n+     * @return The service to bind to, must never return {@code null}.\n+     */\n+    protected abstract CredentialsManagementService getService();\n+\n+    private void updateCredentials(final RoutingContext ctx) {\n+\n+        final Span span = Util.newChildSpan(SPAN_NAME_UPDATE_CREDENTIALS, TracingHandler.serverSpanContext(ctx), tracer,\n+                getClass().getSimpleName());\n+\n+        final JsonArray credentials = ctx.get(KEY_REQUEST_BODY);\n+\n+        final String deviceId = getDeviceIdParam(ctx);\n+        final Optional<String> resourceVersion = Optional.ofNullable(ctx.get(KEY_RESOURCE_VERSION));\n+        final String tenantId = getTenantParam(ctx);\n+\n+        if (tenantId == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e065c6314bbe2a3fafdc2495ec01dac88eacd61"}, "originalPosition": 128}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzOTQzMTc3OnYy", "diffSide": "RIGHT", "path": "service-base/src/main/java/org/eclipse/hono/service/management/credentials/AbstractCredentialsManagementHttpEndpoint.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwOTozNDoyNFrOFonaRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwOTozNDoyNFrOFonaRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEzMzA2MQ==", "bodyText": "We need to finish response and span here (and return?)", "url": "https://github.com/eclipse/hono/pull/1763#discussion_r378133061", "createdAt": "2020-02-12T09:34:24Z", "author": {"login": "dejanb"}, "path": "service-base/src/main/java/org/eclipse/hono/service/management/credentials/AbstractCredentialsManagementHttpEndpoint.java", "diffHunk": "@@ -0,0 +1,265 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+\n+package org.eclipse.hono.service.management.credentials;\n+\n+import io.opentracing.Span;\n+import io.opentracing.tag.Tags;\n+import io.vertx.core.Promise;\n+import io.vertx.core.Vertx;\n+import io.vertx.core.http.HttpHeaders;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.core.http.HttpServerResponse;\n+import io.vertx.core.json.JsonArray;\n+import io.vertx.core.json.JsonObject;\n+import io.vertx.ext.web.Router;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.BodyHandler;\n+import java.net.HttpURLConnection;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+import org.eclipse.hono.client.ClientErrorException;\n+import org.eclipse.hono.config.ServiceConfigProperties;\n+import org.eclipse.hono.service.http.AbstractHttpEndpoint;\n+import org.eclipse.hono.service.http.HttpUtils;\n+import org.eclipse.hono.service.http.TracingHandler;\n+import org.eclipse.hono.service.management.OperationResult;\n+import org.eclipse.hono.service.management.Util;\n+\n+import org.eclipse.hono.tracing.TracingHelper;\n+import org.eclipse.hono.util.RegistryManagementConstants;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+/**\n+ * An {@code HttpEndpoint} for managing device credentials.\n+ * <p>\n+ * This endpoint implements Hono's <a href=\"https://www.eclipse.org/hono/docs/api/credentials//\">Credentials API</a>.\n+ * It receives HTTP requests representing operation invocations and forward them to the\n+ * Credential Management Service Implementation for processing.\n+ * The outcome is then returned to the client in the HTTP response.\n+ */\n+public abstract class AbstractCredentialsManagementHttpEndpoint extends AbstractHttpEndpoint<ServiceConfigProperties> {\n+\n+\n+    private static final String SPAN_NAME_GET_CREDENTIALS = \"get Credentials from management API\";\n+    private static final String SPAN_NAME_UPDATE_CREDENTIALS = \"update Credentials from management API\";\n+\n+    /**\n+     * Creates an endpoint for a Vertx instance.\n+     *\n+     * @param vertx The Vertx instance to use.\n+     * @throws NullPointerException if vertx is {@code null};\n+     */\n+    @Autowired\n+    public AbstractCredentialsManagementHttpEndpoint(final Vertx vertx) {\n+        super(Objects.requireNonNull(vertx));\n+    }\n+\n+    /**\n+     * Returns an empty String as this implementation does not use event bus.\n+     */\n+    @Override\n+    protected String getEventBusAddress() {\n+        return \"\";\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return String.format(\"%s/%s\",\n+                RegistryManagementConstants.API_VERSION,\n+                RegistryManagementConstants.CREDENTIALS_HTTP_ENDPOINT);\n+    }\n+\n+    @Override\n+    public void addRoutes(final Router router) {\n+\n+        final String pathWithTenantAndDeviceId = String.format(\"/%s/:%s/:%s\",\n+                getName(), PARAM_TENANT_ID, PARAM_DEVICE_ID);\n+\n+\n+        // Add CORS handler\n+        router.route(pathWithTenantAndDeviceId).handler(createCorsHandler(config.getCorsAllowedOrigin(), EnumSet.of(HttpMethod.GET, HttpMethod.PUT)));\n+\n+        final BodyHandler bodyHandler = BodyHandler.create();\n+        bodyHandler.setBodyLimit(config.getMaxPayloadSize());\n+\n+        // get all credentials for a given device\n+        router.get(pathWithTenantAndDeviceId).handler(this::getCredentialsForDevice);\n+\n+        // set credentials for a given device\n+        router.put(pathWithTenantAndDeviceId).handler(bodyHandler);\n+        router.put(pathWithTenantAndDeviceId).handler(this::extractRequiredJsonArrayPayload);\n+        router.put(pathWithTenantAndDeviceId).handler(this::extractIfMatchVersionParam);\n+        router.put(pathWithTenantAndDeviceId).handler(this::updateCredentials);\n+    }\n+\n+\n+    /**\n+     * The service to forward requests to.\n+     *\n+     * @return The service to bind to, must never return {@code null}.\n+     */\n+    protected abstract CredentialsManagementService getService();\n+\n+    private void updateCredentials(final RoutingContext ctx) {\n+\n+        final Span span = Util.newChildSpan(SPAN_NAME_UPDATE_CREDENTIALS, TracingHandler.serverSpanContext(ctx), tracer,\n+                getClass().getSimpleName());\n+\n+        final JsonArray credentials = ctx.get(KEY_REQUEST_BODY);\n+\n+        final String deviceId = getDeviceIdParam(ctx);\n+        final Optional<String> resourceVersion = Optional.ofNullable(ctx.get(KEY_RESOURCE_VERSION));\n+        final String tenantId = getTenantParam(ctx);\n+\n+        if (tenantId == null) {\n+            logger.debug(\"missing tenant ID\");\n+            TracingHelper.logError(span, \"missing tenant ID\");\n+            ctx.fail(new ClientErrorException(HttpURLConnection.HTTP_BAD_REQUEST, \"missing tenant ID\"));\n+        } else if (credentials == null) {\n+            logger.debug(\"missing payload\");\n+            TracingHelper.logError(span, \"missing payload\");\n+            ctx.fail(new ClientErrorException(HttpURLConnection.HTTP_BAD_REQUEST, \"missing payload\"));\n+        } else {\n+\n+            try {\n+                decodeCredentials(credentials);\n+            } catch (final IllegalArgumentException | IllegalStateException e) {\n+                logger.debug(\"Error parsing credentials\");\n+                ctx.fail(new ClientErrorException(HttpURLConnection.HTTP_BAD_REQUEST, e));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e065c6314bbe2a3fafdc2495ec01dac88eacd61"}, "originalPosition": 142}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzOTQzMzY2OnYy", "diffSide": "RIGHT", "path": "service-base/src/main/java/org/eclipse/hono/service/management/credentials/AbstractCredentialsManagementHttpEndpoint.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwOTozNDo1N1rOFonbZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwOTozNDo1N1rOFonbZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEzMzM0OA==", "bodyText": "Again, see if you can use getRequestParam()", "url": "https://github.com/eclipse/hono/pull/1763#discussion_r378133348", "createdAt": "2020-02-12T09:34:57Z", "author": {"login": "dejanb"}, "path": "service-base/src/main/java/org/eclipse/hono/service/management/credentials/AbstractCredentialsManagementHttpEndpoint.java", "diffHunk": "@@ -0,0 +1,265 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+\n+package org.eclipse.hono.service.management.credentials;\n+\n+import io.opentracing.Span;\n+import io.opentracing.tag.Tags;\n+import io.vertx.core.Promise;\n+import io.vertx.core.Vertx;\n+import io.vertx.core.http.HttpHeaders;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.core.http.HttpServerResponse;\n+import io.vertx.core.json.JsonArray;\n+import io.vertx.core.json.JsonObject;\n+import io.vertx.ext.web.Router;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.BodyHandler;\n+import java.net.HttpURLConnection;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+import org.eclipse.hono.client.ClientErrorException;\n+import org.eclipse.hono.config.ServiceConfigProperties;\n+import org.eclipse.hono.service.http.AbstractHttpEndpoint;\n+import org.eclipse.hono.service.http.HttpUtils;\n+import org.eclipse.hono.service.http.TracingHandler;\n+import org.eclipse.hono.service.management.OperationResult;\n+import org.eclipse.hono.service.management.Util;\n+\n+import org.eclipse.hono.tracing.TracingHelper;\n+import org.eclipse.hono.util.RegistryManagementConstants;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+/**\n+ * An {@code HttpEndpoint} for managing device credentials.\n+ * <p>\n+ * This endpoint implements Hono's <a href=\"https://www.eclipse.org/hono/docs/api/credentials//\">Credentials API</a>.\n+ * It receives HTTP requests representing operation invocations and forward them to the\n+ * Credential Management Service Implementation for processing.\n+ * The outcome is then returned to the client in the HTTP response.\n+ */\n+public abstract class AbstractCredentialsManagementHttpEndpoint extends AbstractHttpEndpoint<ServiceConfigProperties> {\n+\n+\n+    private static final String SPAN_NAME_GET_CREDENTIALS = \"get Credentials from management API\";\n+    private static final String SPAN_NAME_UPDATE_CREDENTIALS = \"update Credentials from management API\";\n+\n+    /**\n+     * Creates an endpoint for a Vertx instance.\n+     *\n+     * @param vertx The Vertx instance to use.\n+     * @throws NullPointerException if vertx is {@code null};\n+     */\n+    @Autowired\n+    public AbstractCredentialsManagementHttpEndpoint(final Vertx vertx) {\n+        super(Objects.requireNonNull(vertx));\n+    }\n+\n+    /**\n+     * Returns an empty String as this implementation does not use event bus.\n+     */\n+    @Override\n+    protected String getEventBusAddress() {\n+        return \"\";\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return String.format(\"%s/%s\",\n+                RegistryManagementConstants.API_VERSION,\n+                RegistryManagementConstants.CREDENTIALS_HTTP_ENDPOINT);\n+    }\n+\n+    @Override\n+    public void addRoutes(final Router router) {\n+\n+        final String pathWithTenantAndDeviceId = String.format(\"/%s/:%s/:%s\",\n+                getName(), PARAM_TENANT_ID, PARAM_DEVICE_ID);\n+\n+\n+        // Add CORS handler\n+        router.route(pathWithTenantAndDeviceId).handler(createCorsHandler(config.getCorsAllowedOrigin(), EnumSet.of(HttpMethod.GET, HttpMethod.PUT)));\n+\n+        final BodyHandler bodyHandler = BodyHandler.create();\n+        bodyHandler.setBodyLimit(config.getMaxPayloadSize());\n+\n+        // get all credentials for a given device\n+        router.get(pathWithTenantAndDeviceId).handler(this::getCredentialsForDevice);\n+\n+        // set credentials for a given device\n+        router.put(pathWithTenantAndDeviceId).handler(bodyHandler);\n+        router.put(pathWithTenantAndDeviceId).handler(this::extractRequiredJsonArrayPayload);\n+        router.put(pathWithTenantAndDeviceId).handler(this::extractIfMatchVersionParam);\n+        router.put(pathWithTenantAndDeviceId).handler(this::updateCredentials);\n+    }\n+\n+\n+    /**\n+     * The service to forward requests to.\n+     *\n+     * @return The service to bind to, must never return {@code null}.\n+     */\n+    protected abstract CredentialsManagementService getService();\n+\n+    private void updateCredentials(final RoutingContext ctx) {\n+\n+        final Span span = Util.newChildSpan(SPAN_NAME_UPDATE_CREDENTIALS, TracingHandler.serverSpanContext(ctx), tracer,\n+                getClass().getSimpleName());\n+\n+        final JsonArray credentials = ctx.get(KEY_REQUEST_BODY);\n+\n+        final String deviceId = getDeviceIdParam(ctx);\n+        final Optional<String> resourceVersion = Optional.ofNullable(ctx.get(KEY_RESOURCE_VERSION));\n+        final String tenantId = getTenantParam(ctx);\n+\n+        if (tenantId == null) {\n+            logger.debug(\"missing tenant ID\");\n+            TracingHelper.logError(span, \"missing tenant ID\");\n+            ctx.fail(new ClientErrorException(HttpURLConnection.HTTP_BAD_REQUEST, \"missing tenant ID\"));\n+        } else if (credentials == null) {\n+            logger.debug(\"missing payload\");\n+            TracingHelper.logError(span, \"missing payload\");\n+            ctx.fail(new ClientErrorException(HttpURLConnection.HTTP_BAD_REQUEST, \"missing payload\"));\n+        } else {\n+\n+            try {\n+                decodeCredentials(credentials);\n+            } catch (final IllegalArgumentException | IllegalStateException e) {\n+                logger.debug(\"Error parsing credentials\");\n+                ctx.fail(new ClientErrorException(HttpURLConnection.HTTP_BAD_REQUEST, e));\n+            }\n+\n+            logger.debug(\"updating credentials [tenant: {}, device-id: {}] - {}\", tenantId, deviceId, credentials);\n+\n+            final Promise<OperationResult<Void>> result = Promise.promise();\n+            result.future().setHandler(handler -> {\n+                    final OperationResult<Void> operationResult = handler.result();\n+                    Util.writeOperationResponse(\n+                            ctx,\n+                            operationResult,\n+                            null,\n+                            span);\n+            });\n+\n+            getService().set(tenantId, deviceId, resourceVersion, decodeCredentials(credentials), span, result);\n+        }\n+    }\n+\n+    private void getCredentialsForDevice(final RoutingContext ctx) {\n+\n+        final Span span = Util.newChildSpan(SPAN_NAME_GET_CREDENTIALS, TracingHandler.serverSpanContext(ctx), tracer,\n+                getClass().getSimpleName());\n+\n+        // mandatory params\n+        final String tenantId = getTenantParam(ctx);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e065c6314bbe2a3fafdc2495ec01dac88eacd61"}, "originalPosition": 167}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzOTQ0MDE0OnYy", "diffSide": "RIGHT", "path": "service-base/src/main/java/org/eclipse/hono/service/management/credentials/AbstractCredentialsManagementHttpEndpoint.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwOTozNjozOFrOFonfCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwOTozNjozOFrOFonfCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEzNDI4MA==", "bodyText": "Formatting  (tabs) are not right", "url": "https://github.com/eclipse/hono/pull/1763#discussion_r378134280", "createdAt": "2020-02-12T09:36:38Z", "author": {"login": "dejanb"}, "path": "service-base/src/main/java/org/eclipse/hono/service/management/credentials/AbstractCredentialsManagementHttpEndpoint.java", "diffHunk": "@@ -0,0 +1,265 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+\n+package org.eclipse.hono.service.management.credentials;\n+\n+import io.opentracing.Span;\n+import io.opentracing.tag.Tags;\n+import io.vertx.core.Promise;\n+import io.vertx.core.Vertx;\n+import io.vertx.core.http.HttpHeaders;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.core.http.HttpServerResponse;\n+import io.vertx.core.json.JsonArray;\n+import io.vertx.core.json.JsonObject;\n+import io.vertx.ext.web.Router;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.BodyHandler;\n+import java.net.HttpURLConnection;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+import org.eclipse.hono.client.ClientErrorException;\n+import org.eclipse.hono.config.ServiceConfigProperties;\n+import org.eclipse.hono.service.http.AbstractHttpEndpoint;\n+import org.eclipse.hono.service.http.HttpUtils;\n+import org.eclipse.hono.service.http.TracingHandler;\n+import org.eclipse.hono.service.management.OperationResult;\n+import org.eclipse.hono.service.management.Util;\n+\n+import org.eclipse.hono.tracing.TracingHelper;\n+import org.eclipse.hono.util.RegistryManagementConstants;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+/**\n+ * An {@code HttpEndpoint} for managing device credentials.\n+ * <p>\n+ * This endpoint implements Hono's <a href=\"https://www.eclipse.org/hono/docs/api/credentials//\">Credentials API</a>.\n+ * It receives HTTP requests representing operation invocations and forward them to the\n+ * Credential Management Service Implementation for processing.\n+ * The outcome is then returned to the client in the HTTP response.\n+ */\n+public abstract class AbstractCredentialsManagementHttpEndpoint extends AbstractHttpEndpoint<ServiceConfigProperties> {\n+\n+\n+    private static final String SPAN_NAME_GET_CREDENTIALS = \"get Credentials from management API\";\n+    private static final String SPAN_NAME_UPDATE_CREDENTIALS = \"update Credentials from management API\";\n+\n+    /**\n+     * Creates an endpoint for a Vertx instance.\n+     *\n+     * @param vertx The Vertx instance to use.\n+     * @throws NullPointerException if vertx is {@code null};\n+     */\n+    @Autowired\n+    public AbstractCredentialsManagementHttpEndpoint(final Vertx vertx) {\n+        super(Objects.requireNonNull(vertx));\n+    }\n+\n+    /**\n+     * Returns an empty String as this implementation does not use event bus.\n+     */\n+    @Override\n+    protected String getEventBusAddress() {\n+        return \"\";\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return String.format(\"%s/%s\",\n+                RegistryManagementConstants.API_VERSION,\n+                RegistryManagementConstants.CREDENTIALS_HTTP_ENDPOINT);\n+    }\n+\n+    @Override\n+    public void addRoutes(final Router router) {\n+\n+        final String pathWithTenantAndDeviceId = String.format(\"/%s/:%s/:%s\",\n+                getName(), PARAM_TENANT_ID, PARAM_DEVICE_ID);\n+\n+\n+        // Add CORS handler\n+        router.route(pathWithTenantAndDeviceId).handler(createCorsHandler(config.getCorsAllowedOrigin(), EnumSet.of(HttpMethod.GET, HttpMethod.PUT)));\n+\n+        final BodyHandler bodyHandler = BodyHandler.create();\n+        bodyHandler.setBodyLimit(config.getMaxPayloadSize());\n+\n+        // get all credentials for a given device\n+        router.get(pathWithTenantAndDeviceId).handler(this::getCredentialsForDevice);\n+\n+        // set credentials for a given device\n+        router.put(pathWithTenantAndDeviceId).handler(bodyHandler);\n+        router.put(pathWithTenantAndDeviceId).handler(this::extractRequiredJsonArrayPayload);\n+        router.put(pathWithTenantAndDeviceId).handler(this::extractIfMatchVersionParam);\n+        router.put(pathWithTenantAndDeviceId).handler(this::updateCredentials);\n+    }\n+\n+\n+    /**\n+     * The service to forward requests to.\n+     *\n+     * @return The service to bind to, must never return {@code null}.\n+     */\n+    protected abstract CredentialsManagementService getService();\n+\n+    private void updateCredentials(final RoutingContext ctx) {\n+\n+        final Span span = Util.newChildSpan(SPAN_NAME_UPDATE_CREDENTIALS, TracingHandler.serverSpanContext(ctx), tracer,\n+                getClass().getSimpleName());\n+\n+        final JsonArray credentials = ctx.get(KEY_REQUEST_BODY);\n+\n+        final String deviceId = getDeviceIdParam(ctx);\n+        final Optional<String> resourceVersion = Optional.ofNullable(ctx.get(KEY_RESOURCE_VERSION));\n+        final String tenantId = getTenantParam(ctx);\n+\n+        if (tenantId == null) {\n+            logger.debug(\"missing tenant ID\");\n+            TracingHelper.logError(span, \"missing tenant ID\");\n+            ctx.fail(new ClientErrorException(HttpURLConnection.HTTP_BAD_REQUEST, \"missing tenant ID\"));\n+        } else if (credentials == null) {\n+            logger.debug(\"missing payload\");\n+            TracingHelper.logError(span, \"missing payload\");\n+            ctx.fail(new ClientErrorException(HttpURLConnection.HTTP_BAD_REQUEST, \"missing payload\"));\n+        } else {\n+\n+            try {\n+                decodeCredentials(credentials);\n+            } catch (final IllegalArgumentException | IllegalStateException e) {\n+                logger.debug(\"Error parsing credentials\");\n+                ctx.fail(new ClientErrorException(HttpURLConnection.HTTP_BAD_REQUEST, e));\n+            }\n+\n+            logger.debug(\"updating credentials [tenant: {}, device-id: {}] - {}\", tenantId, deviceId, credentials);\n+\n+            final Promise<OperationResult<Void>> result = Promise.promise();\n+            result.future().setHandler(handler -> {\n+                    final OperationResult<Void> operationResult = handler.result();\n+                    Util.writeOperationResponse(\n+                            ctx,\n+                            operationResult,\n+                            null,\n+                            span);\n+            });\n+\n+            getService().set(tenantId, deviceId, resourceVersion, decodeCredentials(credentials), span, result);\n+        }\n+    }\n+\n+    private void getCredentialsForDevice(final RoutingContext ctx) {\n+\n+        final Span span = Util.newChildSpan(SPAN_NAME_GET_CREDENTIALS, TracingHandler.serverSpanContext(ctx), tracer,\n+                getClass().getSimpleName());\n+\n+        // mandatory params\n+        final String tenantId = getTenantParam(ctx);\n+        final String deviceId = getDeviceIdParam(ctx);\n+\n+        final HttpServerResponse response = ctx.response();\n+\n+        logger.debug(\"getCredentialsForDevice [tenant: {}, device-id: {}]]\", tenantId, deviceId);\n+        final Promise<OperationResult<List<CommonCredential>>> result = Promise.promise();\n+\n+        result.future().setHandler(handler -> {\n+            final OperationResult<List<CommonCredential>> operationResult = handler.result();\n+            final int status = operationResult.getStatus();\n+            response.setStatusCode(status);\n+            switch (status) {\n+            case HttpURLConnection.HTTP_OK:\n+                final JsonArray credentialsArray = new JsonArray();\n+                for (final CommonCredential credential : operationResult.getPayload()) {\n+                    credentialsArray.add(JsonObject.mapFrom(credential));\n+                }\n+                operationResult.getResourceVersion().ifPresent(v -> response.putHeader(HttpHeaders.ETAG, v));\n+                HttpUtils.setResponseBody(response, credentialsArray);\n+                response.end();\n+\n+                // falls through intentionally\n+            default:\n+                Tags.HTTP_STATUS.set(span, status);\n+                span.finish();\n+                response.end();\n+            }\n+        });\n+\n+        getService().get(tenantId, deviceId, span, result);\n+    }\n+\n+    /**\n+     * Decode a list of secrets from a JSON array.\n+     * <p>\n+     * This is a convenience method, decoding a list of secrets from a JSON array.\n+     *\n+     * @param objects The JSON array.\n+     * @return The list of decoded secrets.\n+     * @throws NullPointerException in the case the {@code objects} parameter is {@code null}.\n+     * @throws IllegalStateException if the {@code type} field was not set in a credentials object.\n+     * @throws IllegalArgumentException If a credentials object is invalid.\n+     */\n+    protected List<CommonCredential> decodeCredentials(final JsonArray objects) {\n+        return objects\n+                .stream()\n+                .filter(JsonObject.class::isInstance)\n+                .map(JsonObject.class::cast)\n+                .map(this::decodeCredential)\n+                .filter(Objects::nonNull)\n+                .collect(Collectors.toList());\n+    }\n+\n+    /**\n+     * Decode a credential from a JSON object.\n+     *\n+     * @param object The object to device from.\n+     * @return The decoded secret. Or {@code null} if the provided JSON object was {@code null}.\n+     * @throws IllegalStateException if the {@code type} field was not set.\n+     * @throws IllegalArgumentException If the credential object is invalid.\n+     */\n+    protected CommonCredential decodeCredential(final JsonObject object) {\n+\n+        if (object == null) {\n+            return null;\n+        }\n+\n+        final String type = object.getString(\"type\");\n+        if (type == null || type.isEmpty()) {\n+            // TODO this should rather be an IllegalArgumentException\n+            throw new IllegalStateException(\"'type' field must be set\");\n+        }\n+\n+        return decodeCredential(type, object);\n+    }\n+\n+    /**\n+     * Decode a credential, based on the provided type.\n+     *\n+     * @param type The type of the secret. Will never be {@code null}.\n+     * @param object The JSON object to decode. Will never be {@code null}.\n+     * @return The decoded secret.\n+     * @throws IllegalArgumentException If the credential object is invalid.\n+     */\n+    protected CommonCredential decodeCredential(final String type, final JsonObject object) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e065c6314bbe2a3fafdc2495ec01dac88eacd61"}, "originalPosition": 252}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzOTQ0NTEwOnYy", "diffSide": "RIGHT", "path": "services/device-registry/src/main/java/org/eclipse/hono/deviceregistry/AutowiredCredentialsManagementAdapter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwOTozODowN1rOFonh-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwOTozODowN1rOFonh-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEzNTAzNQ==", "bodyText": "Add a deprecation comment", "url": "https://github.com/eclipse/hono/pull/1763#discussion_r378135035", "createdAt": "2020-02-12T09:38:07Z", "author": {"login": "dejanb"}, "path": "services/device-registry/src/main/java/org/eclipse/hono/deviceregistry/AutowiredCredentialsManagementAdapter.java", "diffHunk": "@@ -28,6 +28,7 @@\n  */\n @Component\n @ConditionalOnBean(CredentialsManagementService.class)\n+@Deprecated(forRemoval = true)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e065c6314bbe2a3fafdc2495ec01dac88eacd61"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzOTQ1NjE2OnYy", "diffSide": "RIGHT", "path": "service-base/src/main/java/org/eclipse/hono/service/management/credentials/AbstractCredentialsManagementHttpEndpoint.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwOTo0MTowNFrOFonofA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwOTo0MTowNFrOFonofA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEzNjcwMA==", "bodyText": "This seems unnecessary.", "url": "https://github.com/eclipse/hono/pull/1763#discussion_r378136700", "createdAt": "2020-02-12T09:41:04Z", "author": {"login": "dejanb"}, "path": "service-base/src/main/java/org/eclipse/hono/service/management/credentials/AbstractCredentialsManagementHttpEndpoint.java", "diffHunk": "@@ -0,0 +1,265 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+\n+package org.eclipse.hono.service.management.credentials;\n+\n+import io.opentracing.Span;\n+import io.opentracing.tag.Tags;\n+import io.vertx.core.Promise;\n+import io.vertx.core.Vertx;\n+import io.vertx.core.http.HttpHeaders;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.core.http.HttpServerResponse;\n+import io.vertx.core.json.JsonArray;\n+import io.vertx.core.json.JsonObject;\n+import io.vertx.ext.web.Router;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.BodyHandler;\n+import java.net.HttpURLConnection;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+import org.eclipse.hono.client.ClientErrorException;\n+import org.eclipse.hono.config.ServiceConfigProperties;\n+import org.eclipse.hono.service.http.AbstractHttpEndpoint;\n+import org.eclipse.hono.service.http.HttpUtils;\n+import org.eclipse.hono.service.http.TracingHandler;\n+import org.eclipse.hono.service.management.OperationResult;\n+import org.eclipse.hono.service.management.Util;\n+\n+import org.eclipse.hono.tracing.TracingHelper;\n+import org.eclipse.hono.util.RegistryManagementConstants;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+/**\n+ * An {@code HttpEndpoint} for managing device credentials.\n+ * <p>\n+ * This endpoint implements Hono's <a href=\"https://www.eclipse.org/hono/docs/api/credentials//\">Credentials API</a>.\n+ * It receives HTTP requests representing operation invocations and forward them to the\n+ * Credential Management Service Implementation for processing.\n+ * The outcome is then returned to the client in the HTTP response.\n+ */\n+public abstract class AbstractCredentialsManagementHttpEndpoint extends AbstractHttpEndpoint<ServiceConfigProperties> {\n+\n+\n+    private static final String SPAN_NAME_GET_CREDENTIALS = \"get Credentials from management API\";\n+    private static final String SPAN_NAME_UPDATE_CREDENTIALS = \"update Credentials from management API\";\n+\n+    /**\n+     * Creates an endpoint for a Vertx instance.\n+     *\n+     * @param vertx The Vertx instance to use.\n+     * @throws NullPointerException if vertx is {@code null};\n+     */\n+    @Autowired\n+    public AbstractCredentialsManagementHttpEndpoint(final Vertx vertx) {\n+        super(Objects.requireNonNull(vertx));\n+    }\n+\n+    /**\n+     * Returns an empty String as this implementation does not use event bus.\n+     */\n+    @Override\n+    protected String getEventBusAddress() {\n+        return \"\";\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return String.format(\"%s/%s\",\n+                RegistryManagementConstants.API_VERSION,\n+                RegistryManagementConstants.CREDENTIALS_HTTP_ENDPOINT);\n+    }\n+\n+    @Override\n+    public void addRoutes(final Router router) {\n+\n+        final String pathWithTenantAndDeviceId = String.format(\"/%s/:%s/:%s\",\n+                getName(), PARAM_TENANT_ID, PARAM_DEVICE_ID);\n+\n+\n+        // Add CORS handler\n+        router.route(pathWithTenantAndDeviceId).handler(createCorsHandler(config.getCorsAllowedOrigin(), EnumSet.of(HttpMethod.GET, HttpMethod.PUT)));\n+\n+        final BodyHandler bodyHandler = BodyHandler.create();\n+        bodyHandler.setBodyLimit(config.getMaxPayloadSize());\n+\n+        // get all credentials for a given device\n+        router.get(pathWithTenantAndDeviceId).handler(this::getCredentialsForDevice);\n+\n+        // set credentials for a given device\n+        router.put(pathWithTenantAndDeviceId).handler(bodyHandler);\n+        router.put(pathWithTenantAndDeviceId).handler(this::extractRequiredJsonArrayPayload);\n+        router.put(pathWithTenantAndDeviceId).handler(this::extractIfMatchVersionParam);\n+        router.put(pathWithTenantAndDeviceId).handler(this::updateCredentials);\n+    }\n+\n+\n+    /**\n+     * The service to forward requests to.\n+     *\n+     * @return The service to bind to, must never return {@code null}.\n+     */\n+    protected abstract CredentialsManagementService getService();\n+\n+    private void updateCredentials(final RoutingContext ctx) {\n+\n+        final Span span = Util.newChildSpan(SPAN_NAME_UPDATE_CREDENTIALS, TracingHandler.serverSpanContext(ctx), tracer,\n+                getClass().getSimpleName());\n+\n+        final JsonArray credentials = ctx.get(KEY_REQUEST_BODY);\n+\n+        final String deviceId = getDeviceIdParam(ctx);\n+        final Optional<String> resourceVersion = Optional.ofNullable(ctx.get(KEY_RESOURCE_VERSION));\n+        final String tenantId = getTenantParam(ctx);\n+\n+        if (tenantId == null) {\n+            logger.debug(\"missing tenant ID\");\n+            TracingHelper.logError(span, \"missing tenant ID\");\n+            ctx.fail(new ClientErrorException(HttpURLConnection.HTTP_BAD_REQUEST, \"missing tenant ID\"));\n+        } else if (credentials == null) {\n+            logger.debug(\"missing payload\");\n+            TracingHelper.logError(span, \"missing payload\");\n+            ctx.fail(new ClientErrorException(HttpURLConnection.HTTP_BAD_REQUEST, \"missing payload\"));\n+        } else {\n+\n+            try {\n+                decodeCredentials(credentials);\n+            } catch (final IllegalArgumentException | IllegalStateException e) {\n+                logger.debug(\"Error parsing credentials\");\n+                ctx.fail(new ClientErrorException(HttpURLConnection.HTTP_BAD_REQUEST, e));\n+            }\n+\n+            logger.debug(\"updating credentials [tenant: {}, device-id: {}] - {}\", tenantId, deviceId, credentials);\n+\n+            final Promise<OperationResult<Void>> result = Promise.promise();\n+            result.future().setHandler(handler -> {\n+                    final OperationResult<Void> operationResult = handler.result();\n+                    Util.writeOperationResponse(\n+                            ctx,\n+                            operationResult,\n+                            null,\n+                            span);\n+            });\n+\n+            getService().set(tenantId, deviceId, resourceVersion, decodeCredentials(credentials), span, result);\n+        }\n+    }\n+\n+    private void getCredentialsForDevice(final RoutingContext ctx) {\n+\n+        final Span span = Util.newChildSpan(SPAN_NAME_GET_CREDENTIALS, TracingHandler.serverSpanContext(ctx), tracer,\n+                getClass().getSimpleName());\n+\n+        // mandatory params\n+        final String tenantId = getTenantParam(ctx);\n+        final String deviceId = getDeviceIdParam(ctx);\n+\n+        final HttpServerResponse response = ctx.response();\n+\n+        logger.debug(\"getCredentialsForDevice [tenant: {}, device-id: {}]]\", tenantId, deviceId);\n+        final Promise<OperationResult<List<CommonCredential>>> result = Promise.promise();\n+\n+        result.future().setHandler(handler -> {\n+            final OperationResult<List<CommonCredential>> operationResult = handler.result();\n+            final int status = operationResult.getStatus();\n+            response.setStatusCode(status);\n+            switch (status) {\n+            case HttpURLConnection.HTTP_OK:\n+                final JsonArray credentialsArray = new JsonArray();\n+                for (final CommonCredential credential : operationResult.getPayload()) {\n+                    credentialsArray.add(JsonObject.mapFrom(credential));\n+                }\n+                operationResult.getResourceVersion().ifPresent(v -> response.putHeader(HttpHeaders.ETAG, v));\n+                HttpUtils.setResponseBody(response, credentialsArray);\n+                response.end();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e065c6314bbe2a3fafdc2495ec01dac88eacd61"}, "originalPosition": 187}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzOTY2MDA1OnYy", "diffSide": "RIGHT", "path": "service-base/src/main/java/org/eclipse/hono/service/management/credentials/AbstractCredentialsManagementHttpEndpoint.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxMDozOToxM1rOFopmmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxMDo1Nzo0MlrOFoqM9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE2ODk4NA==", "bodyText": "I feel like I could extract this as getMandatoryPayload() in AbstractHttpEndpoint. @dejanb WDYT ?", "url": "https://github.com/eclipse/hono/pull/1763#discussion_r378168984", "createdAt": "2020-02-12T10:39:13Z", "author": {"login": "jbtrystram"}, "path": "service-base/src/main/java/org/eclipse/hono/service/management/credentials/AbstractCredentialsManagementHttpEndpoint.java", "diffHunk": "@@ -0,0 +1,267 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+\n+package org.eclipse.hono.service.management.credentials;\n+\n+import io.opentracing.Span;\n+import io.opentracing.tag.Tags;\n+import io.vertx.core.Promise;\n+import io.vertx.core.Vertx;\n+import io.vertx.core.http.HttpHeaders;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.core.http.HttpServerResponse;\n+import io.vertx.core.json.JsonArray;\n+import io.vertx.core.json.JsonObject;\n+import io.vertx.ext.web.Router;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.BodyHandler;\n+import java.net.HttpURLConnection;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+import org.eclipse.hono.client.ClientErrorException;\n+import org.eclipse.hono.config.ServiceConfigProperties;\n+import org.eclipse.hono.service.http.AbstractHttpEndpoint;\n+import org.eclipse.hono.service.http.HttpUtils;\n+import org.eclipse.hono.service.http.TracingHandler;\n+import org.eclipse.hono.service.management.OperationResult;\n+import org.eclipse.hono.service.management.Util;\n+\n+import org.eclipse.hono.tracing.TracingHelper;\n+import org.eclipse.hono.util.RegistryManagementConstants;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+/**\n+ * An {@code HttpEndpoint} for managing device credentials.\n+ * <p>\n+ * This endpoint implements Hono's <a href=\"https://www.eclipse.org/hono/docs/api/credentials//\">Credentials API</a>.\n+ * It receives HTTP requests representing operation invocations and forward them to the\n+ * Credential Management Service Implementation for processing.\n+ * The outcome is then returned to the client in the HTTP response.\n+ */\n+public abstract class AbstractCredentialsManagementHttpEndpoint extends AbstractHttpEndpoint<ServiceConfigProperties> {\n+\n+\n+    private static final String SPAN_NAME_GET_CREDENTIALS = \"get Credentials from management API\";\n+    private static final String SPAN_NAME_UPDATE_CREDENTIALS = \"update Credentials from management API\";\n+\n+    private static final String CREDENTIALS_MANAGEMENT_ENDPOINT_NAME = String.format(\"%s/%s\",\n+                    RegistryManagementConstants.API_VERSION,\n+                    RegistryManagementConstants.CREDENTIALS_HTTP_ENDPOINT);\n+\n+    /**\n+     * Creates an endpoint for a Vertx instance.\n+     *\n+     * @param vertx The Vertx instance to use.\n+     * @throws NullPointerException if vertx is {@code null};\n+     */\n+    @Autowired\n+    public AbstractCredentialsManagementHttpEndpoint(final Vertx vertx) {\n+        super(Objects.requireNonNull(vertx));\n+    }\n+\n+    /**\n+     * Returns an empty String as this implementation does not use event bus.\n+     */\n+    @Override\n+    protected String getEventBusAddress() {\n+        return \"\";\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return CREDENTIALS_MANAGEMENT_ENDPOINT_NAME;\n+    }\n+\n+    @Override\n+    public void addRoutes(final Router router) {\n+\n+        final String pathWithTenantAndDeviceId = String.format(\"/%s/:%s/:%s\",\n+                getName(), PARAM_TENANT_ID, PARAM_DEVICE_ID);\n+\n+\n+        // Add CORS handler\n+        router.route(pathWithTenantAndDeviceId).handler(createCorsHandler(config.getCorsAllowedOrigin(), EnumSet.of(HttpMethod.GET, HttpMethod.PUT)));\n+\n+        final BodyHandler bodyHandler = BodyHandler.create();\n+        bodyHandler.setBodyLimit(config.getMaxPayloadSize());\n+\n+        // get all credentials for a given device\n+        router.get(pathWithTenantAndDeviceId).handler(this::getCredentialsForDevice);\n+\n+        // set credentials for a given device\n+        router.put(pathWithTenantAndDeviceId).handler(bodyHandler);\n+        router.put(pathWithTenantAndDeviceId).handler(this::extractRequiredJsonArrayPayload);\n+        router.put(pathWithTenantAndDeviceId).handler(this::extractIfMatchVersionParam);\n+        router.put(pathWithTenantAndDeviceId).handler(this::updateCredentials);\n+    }\n+\n+\n+    /**\n+     * The service to forward requests to.\n+     *\n+     * @return The service to bind to, must never return {@code null}.\n+     */\n+    protected abstract CredentialsManagementService getService();\n+\n+    private void updateCredentials(final RoutingContext ctx) {\n+\n+        final Span span = Util.newChildSpan(SPAN_NAME_UPDATE_CREDENTIALS, TracingHandler.serverSpanContext(ctx), tracer,\n+                getClass().getSimpleName());\n+\n+        final JsonArray credentials = ctx.get(KEY_REQUEST_BODY);\n+\n+        final String tenantId = getMandatoryRequestParam(PARAM_TENANT_ID, ctx, span);\n+        final String deviceId = getMandatoryRequestParam(PARAM_DEVICE_ID, ctx, span);\n+        final Optional<String> resourceVersion = Optional.ofNullable(getRequestParam(KEY_RESOURCE_VERSION, ctx, span, true));\n+\n+        if (credentials == null) {\n+            final String msg = String.format(\"Missing request payload\");\n+            logger.debug(msg);\n+            TracingHelper.logError(span, msg);\n+            HttpUtils.badRequest(ctx, msg);\n+            Tags.HTTP_STATUS.set(span, HttpURLConnection.HTTP_BAD_REQUEST);\n+            span.finish();\n+            return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9313b48f6a43857333f250efd5b612b050e37efd"}, "originalPosition": 137}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE3ODgwNg==", "bodyText": "Yeah, looks like it", "url": "https://github.com/eclipse/hono/pull/1763#discussion_r378178806", "createdAt": "2020-02-12T10:57:42Z", "author": {"login": "dejanb"}, "path": "service-base/src/main/java/org/eclipse/hono/service/management/credentials/AbstractCredentialsManagementHttpEndpoint.java", "diffHunk": "@@ -0,0 +1,267 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+\n+package org.eclipse.hono.service.management.credentials;\n+\n+import io.opentracing.Span;\n+import io.opentracing.tag.Tags;\n+import io.vertx.core.Promise;\n+import io.vertx.core.Vertx;\n+import io.vertx.core.http.HttpHeaders;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.core.http.HttpServerResponse;\n+import io.vertx.core.json.JsonArray;\n+import io.vertx.core.json.JsonObject;\n+import io.vertx.ext.web.Router;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.BodyHandler;\n+import java.net.HttpURLConnection;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+import org.eclipse.hono.client.ClientErrorException;\n+import org.eclipse.hono.config.ServiceConfigProperties;\n+import org.eclipse.hono.service.http.AbstractHttpEndpoint;\n+import org.eclipse.hono.service.http.HttpUtils;\n+import org.eclipse.hono.service.http.TracingHandler;\n+import org.eclipse.hono.service.management.OperationResult;\n+import org.eclipse.hono.service.management.Util;\n+\n+import org.eclipse.hono.tracing.TracingHelper;\n+import org.eclipse.hono.util.RegistryManagementConstants;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+/**\n+ * An {@code HttpEndpoint} for managing device credentials.\n+ * <p>\n+ * This endpoint implements Hono's <a href=\"https://www.eclipse.org/hono/docs/api/credentials//\">Credentials API</a>.\n+ * It receives HTTP requests representing operation invocations and forward them to the\n+ * Credential Management Service Implementation for processing.\n+ * The outcome is then returned to the client in the HTTP response.\n+ */\n+public abstract class AbstractCredentialsManagementHttpEndpoint extends AbstractHttpEndpoint<ServiceConfigProperties> {\n+\n+\n+    private static final String SPAN_NAME_GET_CREDENTIALS = \"get Credentials from management API\";\n+    private static final String SPAN_NAME_UPDATE_CREDENTIALS = \"update Credentials from management API\";\n+\n+    private static final String CREDENTIALS_MANAGEMENT_ENDPOINT_NAME = String.format(\"%s/%s\",\n+                    RegistryManagementConstants.API_VERSION,\n+                    RegistryManagementConstants.CREDENTIALS_HTTP_ENDPOINT);\n+\n+    /**\n+     * Creates an endpoint for a Vertx instance.\n+     *\n+     * @param vertx The Vertx instance to use.\n+     * @throws NullPointerException if vertx is {@code null};\n+     */\n+    @Autowired\n+    public AbstractCredentialsManagementHttpEndpoint(final Vertx vertx) {\n+        super(Objects.requireNonNull(vertx));\n+    }\n+\n+    /**\n+     * Returns an empty String as this implementation does not use event bus.\n+     */\n+    @Override\n+    protected String getEventBusAddress() {\n+        return \"\";\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return CREDENTIALS_MANAGEMENT_ENDPOINT_NAME;\n+    }\n+\n+    @Override\n+    public void addRoutes(final Router router) {\n+\n+        final String pathWithTenantAndDeviceId = String.format(\"/%s/:%s/:%s\",\n+                getName(), PARAM_TENANT_ID, PARAM_DEVICE_ID);\n+\n+\n+        // Add CORS handler\n+        router.route(pathWithTenantAndDeviceId).handler(createCorsHandler(config.getCorsAllowedOrigin(), EnumSet.of(HttpMethod.GET, HttpMethod.PUT)));\n+\n+        final BodyHandler bodyHandler = BodyHandler.create();\n+        bodyHandler.setBodyLimit(config.getMaxPayloadSize());\n+\n+        // get all credentials for a given device\n+        router.get(pathWithTenantAndDeviceId).handler(this::getCredentialsForDevice);\n+\n+        // set credentials for a given device\n+        router.put(pathWithTenantAndDeviceId).handler(bodyHandler);\n+        router.put(pathWithTenantAndDeviceId).handler(this::extractRequiredJsonArrayPayload);\n+        router.put(pathWithTenantAndDeviceId).handler(this::extractIfMatchVersionParam);\n+        router.put(pathWithTenantAndDeviceId).handler(this::updateCredentials);\n+    }\n+\n+\n+    /**\n+     * The service to forward requests to.\n+     *\n+     * @return The service to bind to, must never return {@code null}.\n+     */\n+    protected abstract CredentialsManagementService getService();\n+\n+    private void updateCredentials(final RoutingContext ctx) {\n+\n+        final Span span = Util.newChildSpan(SPAN_NAME_UPDATE_CREDENTIALS, TracingHandler.serverSpanContext(ctx), tracer,\n+                getClass().getSimpleName());\n+\n+        final JsonArray credentials = ctx.get(KEY_REQUEST_BODY);\n+\n+        final String tenantId = getMandatoryRequestParam(PARAM_TENANT_ID, ctx, span);\n+        final String deviceId = getMandatoryRequestParam(PARAM_DEVICE_ID, ctx, span);\n+        final Optional<String> resourceVersion = Optional.ofNullable(getRequestParam(KEY_RESOURCE_VERSION, ctx, span, true));\n+\n+        if (credentials == null) {\n+            final String msg = String.format(\"Missing request payload\");\n+            logger.debug(msg);\n+            TracingHelper.logError(span, msg);\n+            HttpUtils.badRequest(ctx, msg);\n+            Tags.HTTP_STATUS.set(span, HttpURLConnection.HTTP_BAD_REQUEST);\n+            span.finish();\n+            return;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE2ODk4NA=="}, "originalCommit": {"oid": "9313b48f6a43857333f250efd5b612b050e37efd"}, "originalPosition": 137}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzOTcyNDkyOnYy", "diffSide": "RIGHT", "path": "service-base/src/main/java/org/eclipse/hono/service/http/AbstractHttpEndpoint.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxMDo1ODozMlrOFoqOnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxMToyMDo1NVrOFoq5IA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE3OTIyOA==", "bodyText": "Are we sure we don't need this anymore?", "url": "https://github.com/eclipse/hono/pull/1763#discussion_r378179228", "createdAt": "2020-02-12T10:58:32Z", "author": {"login": "dejanb"}, "path": "service-base/src/main/java/org/eclipse/hono/service/http/AbstractHttpEndpoint.java", "diffHunk": "@@ -188,12 +188,7 @@ protected final void extractOptionalJsonPayload(final RoutingContext ctx) {\n      */\n     protected final void extractRequiredJsonArrayPayload(final RoutingContext ctx) {\n         extractRequiredJson(ctx, body -> {\n-            final var payload = body.getBodyAsJsonArray();\n-            if (payload != null && payload.getList() == null) {\n-                // work around eclipse-vertx/vert.x#2993\n-                return null;\n-            }\n-            return payload;\n+            return body.getBodyAsJsonArray();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd0ad98109154f7e8cca4b3b44ffa742ce1594c8"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE4ODY3Nw==", "bodyText": "the bug is fixed : eclipse-vertx/vert.x#2993\nand hono updated to a more recent version of vertx (3.8.4)", "url": "https://github.com/eclipse/hono/pull/1763#discussion_r378188677", "createdAt": "2020-02-12T11:17:50Z", "author": {"login": "jbtrystram"}, "path": "service-base/src/main/java/org/eclipse/hono/service/http/AbstractHttpEndpoint.java", "diffHunk": "@@ -188,12 +188,7 @@ protected final void extractOptionalJsonPayload(final RoutingContext ctx) {\n      */\n     protected final void extractRequiredJsonArrayPayload(final RoutingContext ctx) {\n         extractRequiredJson(ctx, body -> {\n-            final var payload = body.getBodyAsJsonArray();\n-            if (payload != null && payload.getList() == null) {\n-                // work around eclipse-vertx/vert.x#2993\n-                return null;\n-            }\n-            return payload;\n+            return body.getBodyAsJsonArray();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE3OTIyOA=="}, "originalCommit": {"oid": "bd0ad98109154f7e8cca4b3b44ffa742ce1594c8"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE5MDExMg==", "bodyText": "OK. Great.", "url": "https://github.com/eclipse/hono/pull/1763#discussion_r378190112", "createdAt": "2020-02-12T11:20:55Z", "author": {"login": "dejanb"}, "path": "service-base/src/main/java/org/eclipse/hono/service/http/AbstractHttpEndpoint.java", "diffHunk": "@@ -188,12 +188,7 @@ protected final void extractOptionalJsonPayload(final RoutingContext ctx) {\n      */\n     protected final void extractRequiredJsonArrayPayload(final RoutingContext ctx) {\n         extractRequiredJson(ctx, body -> {\n-            final var payload = body.getBodyAsJsonArray();\n-            if (payload != null && payload.getList() == null) {\n-                // work around eclipse-vertx/vert.x#2993\n-                return null;\n-            }\n-            return payload;\n+            return body.getBodyAsJsonArray();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE3OTIyOA=="}, "originalCommit": {"oid": "bd0ad98109154f7e8cca4b3b44ffa742ce1594c8"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzOTgwODYzOnYy", "diffSide": "RIGHT", "path": "service-base/src/main/java/org/eclipse/hono/service/management/credentials/AbstractCredentialsManagementHttpEndpoint.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxMToyNTowOFrOForAdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxMToyNTowOFrOForAdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE5MTk5MQ==", "bodyText": "case should be indented.", "url": "https://github.com/eclipse/hono/pull/1763#discussion_r378191991", "createdAt": "2020-02-12T11:25:08Z", "author": {"login": "dejanb"}, "path": "service-base/src/main/java/org/eclipse/hono/service/management/credentials/AbstractCredentialsManagementHttpEndpoint.java", "diffHunk": "@@ -0,0 +1,267 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+\n+package org.eclipse.hono.service.management.credentials;\n+\n+import io.opentracing.Span;\n+import io.opentracing.tag.Tags;\n+import io.vertx.core.Promise;\n+import io.vertx.core.Vertx;\n+import io.vertx.core.http.HttpHeaders;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.core.http.HttpServerResponse;\n+import io.vertx.core.json.JsonArray;\n+import io.vertx.core.json.JsonObject;\n+import io.vertx.ext.web.Router;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.BodyHandler;\n+import java.net.HttpURLConnection;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+import org.eclipse.hono.client.ClientErrorException;\n+import org.eclipse.hono.config.ServiceConfigProperties;\n+import org.eclipse.hono.service.http.AbstractHttpEndpoint;\n+import org.eclipse.hono.service.http.HttpUtils;\n+import org.eclipse.hono.service.http.TracingHandler;\n+import org.eclipse.hono.service.management.OperationResult;\n+import org.eclipse.hono.service.management.Util;\n+\n+import org.eclipse.hono.tracing.TracingHelper;\n+import org.eclipse.hono.util.RegistryManagementConstants;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+/**\n+ * An {@code HttpEndpoint} for managing device credentials.\n+ * <p>\n+ * This endpoint implements Hono's <a href=\"https://www.eclipse.org/hono/docs/api/credentials//\">Credentials API</a>.\n+ * It receives HTTP requests representing operation invocations and forward them to the\n+ * Credential Management Service Implementation for processing.\n+ * The outcome is then returned to the client in the HTTP response.\n+ */\n+public abstract class AbstractCredentialsManagementHttpEndpoint extends AbstractHttpEndpoint<ServiceConfigProperties> {\n+\n+\n+    private static final String SPAN_NAME_GET_CREDENTIALS = \"get Credentials from management API\";\n+    private static final String SPAN_NAME_UPDATE_CREDENTIALS = \"update Credentials from management API\";\n+\n+    private static final String CREDENTIALS_MANAGEMENT_ENDPOINT_NAME = String.format(\"%s/%s\",\n+                    RegistryManagementConstants.API_VERSION,\n+                    RegistryManagementConstants.CREDENTIALS_HTTP_ENDPOINT);\n+\n+    /**\n+     * Creates an endpoint for a Vertx instance.\n+     *\n+     * @param vertx The Vertx instance to use.\n+     * @throws NullPointerException if vertx is {@code null};\n+     */\n+    @Autowired\n+    public AbstractCredentialsManagementHttpEndpoint(final Vertx vertx) {\n+        super(Objects.requireNonNull(vertx));\n+    }\n+\n+    /**\n+     * Returns an empty String as this implementation does not use event bus.\n+     */\n+    @Override\n+    protected String getEventBusAddress() {\n+        return \"\";\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return CREDENTIALS_MANAGEMENT_ENDPOINT_NAME;\n+    }\n+\n+    @Override\n+    public void addRoutes(final Router router) {\n+\n+        final String pathWithTenantAndDeviceId = String.format(\"/%s/:%s/:%s\",\n+                getName(), PARAM_TENANT_ID, PARAM_DEVICE_ID);\n+\n+\n+        // Add CORS handler\n+        router.route(pathWithTenantAndDeviceId).handler(createCorsHandler(config.getCorsAllowedOrigin(), EnumSet.of(HttpMethod.GET, HttpMethod.PUT)));\n+\n+        final BodyHandler bodyHandler = BodyHandler.create();\n+        bodyHandler.setBodyLimit(config.getMaxPayloadSize());\n+\n+        // get all credentials for a given device\n+        router.get(pathWithTenantAndDeviceId).handler(this::getCredentialsForDevice);\n+\n+        // set credentials for a given device\n+        router.put(pathWithTenantAndDeviceId).handler(bodyHandler);\n+        router.put(pathWithTenantAndDeviceId).handler(this::extractRequiredJsonArrayPayload);\n+        router.put(pathWithTenantAndDeviceId).handler(this::extractIfMatchVersionParam);\n+        router.put(pathWithTenantAndDeviceId).handler(this::updateCredentials);\n+    }\n+\n+\n+    /**\n+     * The service to forward requests to.\n+     *\n+     * @return The service to bind to, must never return {@code null}.\n+     */\n+    protected abstract CredentialsManagementService getService();\n+\n+    private void updateCredentials(final RoutingContext ctx) {\n+\n+        final Span span = Util.newChildSpan(SPAN_NAME_UPDATE_CREDENTIALS, TracingHandler.serverSpanContext(ctx), tracer,\n+                getClass().getSimpleName());\n+\n+        final JsonArray credentials = ctx.get(KEY_REQUEST_BODY);\n+\n+        final String tenantId = getMandatoryRequestParam(PARAM_TENANT_ID, ctx, span);\n+        final String deviceId = getMandatoryRequestParam(PARAM_DEVICE_ID, ctx, span);\n+        final Optional<String> resourceVersion = Optional.ofNullable(ctx.get(KEY_RESOURCE_VERSION));\n+\n+        if (credentials == null) {\n+            final String msg = String.format(\"Missing request payload\");\n+            logger.debug(msg);\n+            TracingHelper.logError(span, msg);\n+            HttpUtils.badRequest(ctx, msg);\n+            Tags.HTTP_STATUS.set(span, HttpURLConnection.HTTP_BAD_REQUEST);\n+            span.finish();\n+            return;\n+        } else {\n+\n+            try {\n+                decodeCredentials(credentials);\n+            } catch (final IllegalArgumentException | IllegalStateException e) {\n+                logger.debug(\"Error parsing credentials\");\n+                ctx.fail(new ClientErrorException(HttpURLConnection.HTTP_BAD_REQUEST, e));\n+                span.finish();\n+            }\n+\n+            logger.debug(\"updating credentials [tenant: {}, device-id: {}] - {}\", tenantId, deviceId, credentials);\n+\n+            final Promise<OperationResult<Void>> result = Promise.promise();\n+            result.future().setHandler(handler -> {\n+                    final OperationResult<Void> operationResult = handler.result();\n+                    Util.writeOperationResponse(\n+                            ctx,\n+                            operationResult,\n+                            null,\n+                            span);\n+            });\n+\n+            getService().set(tenantId, deviceId, resourceVersion, decodeCredentials(credentials), span, result);\n+        }\n+    }\n+\n+    private void getCredentialsForDevice(final RoutingContext ctx) {\n+\n+        final Span span = Util.newChildSpan(SPAN_NAME_GET_CREDENTIALS, TracingHandler.serverSpanContext(ctx), tracer,\n+                getClass().getSimpleName());\n+\n+        // mandatory params\n+        final String tenantId = getMandatoryRequestParam(PARAM_TENANT_ID, ctx, span);\n+        final String deviceId = getMandatoryRequestParam(PARAM_DEVICE_ID, ctx, span);\n+\n+        final HttpServerResponse response = ctx.response();\n+\n+        logger.debug(\"getCredentialsForDevice [tenant: {}, device-id: {}]]\", tenantId, deviceId);\n+        final Promise<OperationResult<List<CommonCredential>>> result = Promise.promise();\n+\n+        result.future().setHandler(handler -> {\n+            final OperationResult<List<CommonCredential>> operationResult = handler.result();\n+            final int status = operationResult.getStatus();\n+            response.setStatusCode(status);\n+            switch (status) {\n+            case HttpURLConnection.HTTP_OK:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd0ad98109154f7e8cca4b3b44ffa742ce1594c8"}, "originalPosition": 183}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3427, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}