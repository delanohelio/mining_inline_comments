{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwNzEzMDIy", "number": 1886, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMzowMDoxMVrODv-zkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMzowMDoxMVrODv-zkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNjM4Njc1OnYy", "diffSide": "RIGHT", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDbBasedRegistrationService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMzowMDoxMVrOGCuD8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMzo0ODowMVrOGCwGPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUwNTAwOQ==", "bodyText": "The span should already be tagged with the tenant ID.", "url": "https://github.com/eclipse/hono/pull/1886#discussion_r405505009", "createdAt": "2020-04-08T13:00:11Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDbBasedRegistrationService.java", "diffHunk": "@@ -314,6 +319,35 @@ private boolean isDuplicateKeyError(final Throwable throwable) {\n                                 Optional.ofNullable(deviceDto.getVersion()))));\n     }\n \n+    private Future<JsonArray> processResolveGroupMembers(final String tenantId, final JsonArray viaGroups,\n+            final Span span) {\n+        final JsonObject resolveGroupMembersQuery = new MongoDbDocumentBuilder()\n+                .withTenantId(tenantId).document()\n+                .put(String.format(\"%s.%s\", MongoDbDeviceRegistryUtils.FIELD_DEVICE,\n+                        RegistryManagementConstants.FIELD_MEMBER_OF),\n+                        new JsonObject()\n+                                .put(\"$exists\", true)\n+                                .put(\"$in\", viaGroups));\n+        //Retrieve only the deviceId instead of the whole document.\n+        final FindOptions findOptionsForDeviceId = new FindOptions()\n+                .setFields(new JsonObject().put(RegistrationConstants.FIELD_PAYLOAD_DEVICE_ID, true).put(\"_id\", false));\n+        final Promise<List<JsonObject>> resolveGroupMembersPromise = Promise.promise();\n+\n+        mongoClient.findWithOptions(config.getCollectionName(), resolveGroupMembersQuery, findOptionsForDeviceId,\n+                resolveGroupMembersPromise);\n+\n+        return resolveGroupMembersPromise.future()\n+                .map(deviceIdsList -> {\n+                    final JsonArray deviceIds = Optional.ofNullable(deviceIdsList)\n+                            .map(ok -> deviceIdsList.stream()\n+                                    .map(json -> json.getString(RegistrationConstants.FIELD_PAYLOAD_DEVICE_ID))\n+                                    .collect(Collectors.collectingAndThen(Collectors.toList(), JsonArray::new)))\n+                            .orElse(new JsonArray());\n+                    span.log(String.format(\"successfully resolved group members for the tenant [%s]\", tenantId));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85d214641e36a97cb359a9f048149dcaf586f373"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUzODM2Ng==", "bodyText": "Since the tenant ID is already being tagged, now I have removed logging the tenant ID and pushed the changes.", "url": "https://github.com/eclipse/hono/pull/1886#discussion_r405538366", "createdAt": "2020-04-08T13:48:01Z", "author": {"login": "kaniyan"}, "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDbBasedRegistrationService.java", "diffHunk": "@@ -314,6 +319,35 @@ private boolean isDuplicateKeyError(final Throwable throwable) {\n                                 Optional.ofNullable(deviceDto.getVersion()))));\n     }\n \n+    private Future<JsonArray> processResolveGroupMembers(final String tenantId, final JsonArray viaGroups,\n+            final Span span) {\n+        final JsonObject resolveGroupMembersQuery = new MongoDbDocumentBuilder()\n+                .withTenantId(tenantId).document()\n+                .put(String.format(\"%s.%s\", MongoDbDeviceRegistryUtils.FIELD_DEVICE,\n+                        RegistryManagementConstants.FIELD_MEMBER_OF),\n+                        new JsonObject()\n+                                .put(\"$exists\", true)\n+                                .put(\"$in\", viaGroups));\n+        //Retrieve only the deviceId instead of the whole document.\n+        final FindOptions findOptionsForDeviceId = new FindOptions()\n+                .setFields(new JsonObject().put(RegistrationConstants.FIELD_PAYLOAD_DEVICE_ID, true).put(\"_id\", false));\n+        final Promise<List<JsonObject>> resolveGroupMembersPromise = Promise.promise();\n+\n+        mongoClient.findWithOptions(config.getCollectionName(), resolveGroupMembersQuery, findOptionsForDeviceId,\n+                resolveGroupMembersPromise);\n+\n+        return resolveGroupMembersPromise.future()\n+                .map(deviceIdsList -> {\n+                    final JsonArray deviceIds = Optional.ofNullable(deviceIdsList)\n+                            .map(ok -> deviceIdsList.stream()\n+                                    .map(json -> json.getString(RegistrationConstants.FIELD_PAYLOAD_DEVICE_ID))\n+                                    .collect(Collectors.collectingAndThen(Collectors.toList(), JsonArray::new)))\n+                            .orElse(new JsonArray());\n+                    span.log(String.format(\"successfully resolved group members for the tenant [%s]\", tenantId));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUwNTAwOQ=="}, "originalCommit": {"oid": "85d214641e36a97cb359a9f048149dcaf586f373"}, "originalPosition": 53}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3329, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}