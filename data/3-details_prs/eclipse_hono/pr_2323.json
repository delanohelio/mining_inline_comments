{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI1ODcwNjM4", "number": 2323, "title": "[#2029] Fix Command Router AMQP server vert.x context issues", "bodyText": "When processing Command Router API requests, the original vert.x context of the CommandRouterAmqpServer needs to be restored at the end, because the commandConsumerFactory has switched to the context in which the downstream AMQP connection is used.\nThis fixes issues with the Command Router component sending invalid AMQP frames or throwing exceptions when handling the requests.\nI'm also working on a more general fix concerning verticle handling/communication in the Command Router component, which shall use multiple ProtonBasedCommandConsumerFactoryImpl instances and thereby use multiple downstream AMQP connections.", "createdAt": "2020-11-23T17:01:07Z", "url": "https://github.com/eclipse/hono/pull/2323", "merged": true, "mergeCommit": {"oid": "275332b20617c850fbc639a77ff06f5b6d6283c2"}, "closed": true, "closedAt": "2020-11-26T08:47:49Z", "author": {"login": "calohmn"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdf715CgH2gAyNTI1ODcwNjM4OjliYTA0YjQ2NzVjODJhMjMzYjAzNzI4NmUyYTE4M2Y2MzI5ZGY2ZTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgO6vzgFqTUzOTA5OTk1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9ba04b4675c82a233b037286e2a183f6329df6e1", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/9ba04b4675c82a233b037286e2a183f6329df6e1", "committedDate": "2020-11-25T10:32:09Z", "message": "[#2029] Fix issues caused by different vertx contexts being used.\n\nThe CommandRouterServiceImpl is no Verticle anymore, therefore\nthere is no issue anymore with CommandRouterAmqpServer requests\nending up being handled on the wrong vert.x context.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9343c3bc82955e6281d6f27c395ae023ef983a40", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/9343c3bc82955e6281d6f27c395ae023ef983a40", "committedDate": "2020-11-23T16:50:22Z", "message": "[#2029] Fix issues caused by different vertx contexts being used.\n\nWhen processing Command Router API requests, the original vert.x\ncontext of the CommandRouterAmqpServer needs to be restored at\nthe end, because the commandConsumerFactory has switched to the\ncontext in which the downstream AMQP connection is used.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}, "afterCommit": {"oid": "9ba04b4675c82a233b037286e2a183f6329df6e1", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/9ba04b4675c82a233b037286e2a183f6329df6e1", "committedDate": "2020-11-25T10:32:09Z", "message": "[#2029] Fix issues caused by different vertx contexts being used.\n\nThe CommandRouterServiceImpl is no Verticle anymore, therefore\nthere is no issue anymore with CommandRouterAmqpServer requests\nending up being handled on the wrong vert.x context.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5MDY0MzI2", "url": "https://github.com/eclipse/hono/pull/2323#pullrequestreview-539064326", "createdAt": "2020-11-26T07:54:49Z", "commit": {"oid": "9ba04b4675c82a233b037286e2a183f6329df6e1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwNzo1NDo0OVrOH6PY2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwNzo1NDo0OVrOH6PY2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgzMTU3Ng==", "bodyText": "how about adding this as the default implementation to org.eclipse.hono.service.amqp.AbstractDelegatingRequestResponseEndpoint?\nIt seems to make a lot of sense to register these checks automatically, doesn't it?", "url": "https://github.com/eclipse/hono/pull/2323#discussion_r530831576", "createdAt": "2020-11-26T07:54:49Z", "author": {"login": "sophokles73"}, "path": "services/command-router/src/main/java/org/eclipse/hono/commandrouter/ApplicationConfig.java", "diffHunk": "@@ -172,13 +174,28 @@ public ObjectFactoryCreatingFactoryBean amqpServerFactory() {\n     /**\n      * Creates a new instance of an AMQP 1.0 protocol handler for Hono's <em>Command Router</em> API.\n      *\n-     * @param service The service instance to delegate to.\n      * @return The handler.\n      */\n     @Bean\n     @Scope(\"prototype\")\n-    public AmqpEndpoint commandRouterAmqpEndpoint(final CommandRouterService service) {\n-        return new DelegatingCommandRouterAmqpEndpoint<>(vertx(), service);\n+    public AmqpEndpoint commandRouterAmqpEndpoint() {\n+        final CommandRouterService commandRouterService = commandRouterService();\n+        return new DelegatingCommandRouterAmqpEndpoint<>(vertx(), commandRouterService) {\n+\n+            @Override\n+            public void registerLivenessChecks(final HealthCheckHandler handler) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ba04b4675c82a233b037286e2a183f6329df6e1"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5MDk5OTU1", "url": "https://github.com/eclipse/hono/pull/2323#pullrequestreview-539099955", "createdAt": "2020-11-26T08:45:21Z", "commit": {"oid": "9ba04b4675c82a233b037286e2a183f6329df6e1"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwODo0NToyMVrOH6RHxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwODo0NToyMVrOH6RHxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg1OTk3Mg==", "bodyText": "I see, then let's keep it like this for the time being ...", "url": "https://github.com/eclipse/hono/pull/2323#discussion_r530859972", "createdAt": "2020-11-26T08:45:21Z", "author": {"login": "sophokles73"}, "path": "services/command-router/src/main/java/org/eclipse/hono/commandrouter/ApplicationConfig.java", "diffHunk": "@@ -172,13 +174,28 @@ public ObjectFactoryCreatingFactoryBean amqpServerFactory() {\n     /**\n      * Creates a new instance of an AMQP 1.0 protocol handler for Hono's <em>Command Router</em> API.\n      *\n-     * @param service The service instance to delegate to.\n      * @return The handler.\n      */\n     @Bean\n     @Scope(\"prototype\")\n-    public AmqpEndpoint commandRouterAmqpEndpoint(final CommandRouterService service) {\n-        return new DelegatingCommandRouterAmqpEndpoint<>(vertx(), service);\n+    public AmqpEndpoint commandRouterAmqpEndpoint() {\n+        final CommandRouterService commandRouterService = commandRouterService();\n+        return new DelegatingCommandRouterAmqpEndpoint<>(vertx(), commandRouterService) {\n+\n+            @Override\n+            public void registerLivenessChecks(final HealthCheckHandler handler) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgzMTU3Ng=="}, "originalCommit": {"oid": "9ba04b4675c82a233b037286e2a183f6329df6e1"}, "originalPosition": 32}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 459, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}