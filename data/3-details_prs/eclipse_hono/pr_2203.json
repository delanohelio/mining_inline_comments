{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxODM0NDk0", "number": 2203, "title": "[#2115] Use PreCredentialsValidationHandler in AMQP adapter", "bodyText": "This is for #2115.\nSetting the trace-sampling-priority according to the tenant configuration when processing a telemetry/event message in the AMQP adapter is now done via the new PreCredentialsValidationHandler. This removes duplicate code related to extracting the tenant information from the authentication data.", "createdAt": "2020-09-23T14:45:02Z", "url": "https://github.com/eclipse/hono/pull/2203", "merged": true, "mergeCommit": {"oid": "3e2ebb194db04d87e541a16dcf405d6fd63a0e35"}, "closed": true, "closedAt": "2020-09-24T14:01:01Z", "author": {"login": "calohmn"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLtqotAH2gAyNDkxODM0NDk0OmZmNTA1Zjk5ZTkxYTFjOTM5ZDJmMjlkYTAwYTM2MWQ3ZTU1N2EzYzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMBghKgFqTQ5NTU5MzE2Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ff505f99e91a1c939d2f29da00a361d7e557a3c8", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/ff505f99e91a1c939d2f29da00a361d7e557a3c8", "committedDate": "2020-09-23T14:42:42Z", "message": "[#2115] Use PreCredentialsValidationHandler in AMQP adapter.\n\nSetting the trace-sampling-priority according to the tenant\nconfiguration when processing a telemetry/event message in\nthe AMQP adapter is now done via the new\nPreCredentialsValidationHandler. This removes duplicate\ncode related to extracting the tenant information from\nthe authentication data.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MzMxODE4", "url": "https://github.com/eclipse/hono/pull/2203#pullrequestreview-495331818", "createdAt": "2020-09-24T08:24:10Z", "commit": {"oid": "ff505f99e91a1c939d2f29da00a361d7e557a3c8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwODoyNDoxMFrOHXPTCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwODoyNDoxMFrOHXPTCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDEyOTkzMQ==", "bodyText": "FMPOV we should not rely on the internal structure of the SaslResponseContext here but instead simply invoke something like SaslResponseContext.setTraceSamplingPriority(TenantObject) to improve encapsulation ...", "url": "https://github.com/eclipse/hono/pull/2203#discussion_r494129931", "createdAt": "2020-09-24T08:24:10Z", "author": {"login": "sophokles73"}, "path": "adapters/amqp-vertx/src/main/java/org/eclipse/hono/adapter/amqp/impl/VertxBasedAmqpProtocolAdapter.java", "diffHunk": "@@ -197,6 +196,37 @@ protected void doStart(final Promise<Void> startPromise) {\n         .onComplete(startPromise);\n     }\n \n+    /**\n+     * Handles any operations that should be invoked as part of the authentication process after the credentials got\n+     * determined and before they get validated. Can be used to perform checks using the credentials and tenant\n+     * information before the potentially expensive credentials validation is done\n+     * <p>\n+     * The default implementation updates the trace sampling priority in the execution context tracing span.\n+     * <p>\n+     * Subclasses should override this method in order to perform additional operations after calling this super method.\n+     *\n+     * @param credentials The credentials.\n+     * @param executionContext The execution context, including the TenantObject.\n+     * @return A future indicating the outcome of the operation. A failed future will fail the authentication attempt.\n+     */\n+    protected Future<Void> handleBeforeCredentialsValidation(final DeviceCredentials credentials,\n+            final SaslResponseContext executionContext) {\n+\n+        final String tenantId = credentials.getTenantId();\n+        final Span span = executionContext.getTracingSpan();\n+        final String authId = credentials.getAuthId();\n+\n+        return getTenantConfiguration(tenantId, span.context())\n+                .compose(tenantObject -> {\n+                    TracingHelper.setDeviceTags(span, tenantId, null, authId);\n+                    final OptionalInt traceSamplingPriority = TenantTraceSamplingHelper.applyTraceSamplingPriority(\n+                            tenantObject, authId, span);\n+                    executionContext.getProtonConnection().attachments().set(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff505f99e91a1c939d2f29da00a361d7e557a3c8"}, "originalPosition": 72}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NTkzMTY3", "url": "https://github.com/eclipse/hono/pull/2203#pullrequestreview-495593167", "createdAt": "2020-09-24T13:49:45Z", "commit": {"oid": "ff505f99e91a1c939d2f29da00a361d7e557a3c8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 588, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}