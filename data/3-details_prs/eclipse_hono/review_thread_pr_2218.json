{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0MDA2NjY3", "number": 2218, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNjoxNjo1M1rOErBtgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNjoyNDo0MVrOErB1GQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNTUyMjU2OnYy", "diffSide": "RIGHT", "path": "client/src/main/java/org/eclipse/hono/client/impl/AbstractSender.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNjoxNjo1M1rOHdkDAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNjoxNjo1M1rOHdkDAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc2MTM0Nw==", "bodyText": "how about adding a comment here explaining why we are doing this?", "url": "https://github.com/eclipse/hono/pull/2218#discussion_r500761347", "createdAt": "2020-10-07T06:16:53Z", "author": {"login": "sophokles73"}, "path": "client/src/main/java/org/eclipse/hono/client/impl/AbstractSender.java", "diffHunk": "@@ -282,13 +285,15 @@ protected final Span startSpan(final Message message) {\n                                         + connection.getConfig().getSendMessageTimeout() + \"ms\");\n                         logMessageSendingError(\"waiting for delivery update timed out for message [ID: {}, address: {}] after {}ms\",\n                                 messageId, getMessageAddress(message), connection.getConfig().getSendMessageTimeout());\n+                        Optional.ofNullable(deliveryRef.get())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d82b78a2036dd365ae74ecf0cb2da24f4d6bf961"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNTUyMjk1OnYy", "diffSide": "RIGHT", "path": "client/src/main/java/org/eclipse/hono/client/impl/DelegatedCommandSenderImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNjoxNzowOFrOHdkDPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNjoxNzowOFrOHdkDPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc2MTQwNg==", "bodyText": "comment?", "url": "https://github.com/eclipse/hono/pull/2218#discussion_r500761406", "createdAt": "2020-10-07T06:17:08Z", "author": {"login": "sophokles73"}, "path": "client/src/main/java/org/eclipse/hono/client/impl/DelegatedCommandSenderImpl.java", "diffHunk": "@@ -142,13 +146,15 @@ public String getEndpoint() {\n                                         + connection.getConfig().getSendMessageTimeout() + \"ms\");\n                         logMessageSendingError(\"waiting for delivery update timed out for message [ID: {}, address: {}] after {}ms\",\n                                 messageId, getMessageAddress(message), connection.getConfig().getSendMessageTimeout());\n+                        Optional.ofNullable(deliveryRef.get())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d82b78a2036dd365ae74ecf0cb2da24f4d6bf961"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNTUyNDY4OnYy", "diffSide": "RIGHT", "path": "client/src/main/java/org/eclipse/hono/client/impl/TelemetrySenderImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNjoxNzo1NFrOHdkEQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNjoxNzo1NFrOHdkEQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc2MTY2NA==", "bodyText": "comment?", "url": "https://github.com/eclipse/hono/pull/2218#discussion_r500761664", "createdAt": "2020-10-07T06:17:54Z", "author": {"login": "sophokles73"}, "path": "client/src/main/java/org/eclipse/hono/client/impl/TelemetrySenderImpl.java", "diffHunk": "@@ -180,6 +184,8 @@ protected String getTo(final String deviceId) {\n                         logMessageSendingError(\n                                 \"waiting for delivery update timed out for message [ID: {}, address: {}] after {}ms\",\n                                 messageId, getMessageAddress(message), connection.getConfig().getSendMessageTimeout());\n+                        Optional.ofNullable(deliveryRef.get())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d82b78a2036dd365ae74ecf0cb2da24f4d6bf961"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNTU0MjAxOnYy", "diffSide": "RIGHT", "path": "tests/src/test/java/org/eclipse/hono/tests/http/TelemetryHttpIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNjoyNDo0MVrOHdkOjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNjoyNDo0MVrOHdkOjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc2NDMwMA==", "bodyText": "IMHO we should tie this check to after the HTTP client has gotten back its 501 response (and then wait some) in order to make it more robust against timing issues induced by scarce computing resources on the CI system ...", "url": "https://github.com/eclipse/hono/pull/2218#discussion_r500764300", "createdAt": "2020-10-07T06:24:41Z", "author": {"login": "sophokles73"}, "path": "tests/src/test/java/org/eclipse/hono/tests/http/TelemetryHttpIT.java", "diffHunk": "@@ -194,8 +199,22 @@ public void testUploadQos1MessageFailsIfDeliveryStateNotUpdated(final VertxTestC\n                         tenantId, \n                         (delivery, msg) -> {\n                             logger.debug(\"received {}\", msg);\n+                            ctx.verify(() -> {\n+                                assertThat(delivery.remotelySettled()).isFalse();\n+                                assertThat(delivery.getRemoteState()).isNull();\n+                            });\n                             messageReceived.flag();\n                             // don't update the delivery state here\n+                            // wait for the delivery to get remotely settled via the timeout handling in the adapter\n+                            vertx.setTimer(ClientConfigProperties.DEFAULT_SEND_MESSAGE_TIMEOUT + 50, tid -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d82b78a2036dd365ae74ecf0cb2da24f4d6bf961"}, "originalPosition": 53}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3083, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}