{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5OTUyMjU0", "number": 1882, "title": "[#1865] Hono resource limits : add timeout for Prometheus queries", "bodyText": "add timeout for Prometheus queries", "createdAt": "2020-04-06T23:14:46Z", "url": "https://github.com/eclipse/hono/pull/1882", "merged": true, "mergeCommit": {"oid": "43b0c2b39f0fba723d5aedcd65de11a0cab8c823"}, "closed": true, "closedAt": "2020-04-22T14:41:59Z", "author": {"login": "bordeuax"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVNcfxgFqTM4ODgyMDM0NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcaB72-AFqTM5Nzg2NjUxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4ODIwMzQ0", "url": "https://github.com/eclipse/hono/pull/1882#pullrequestreview-388820344", "createdAt": "2020-04-07T06:35:17Z", "commit": {"oid": "ed3ff7cdedce42407be7e5184f6498c4a1d3d676"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNjozNToxN1rOGB01aA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNjozODoxNlrOGB06Iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU2NzQwMA==", "bodyText": "IMHO this should also be done in the newQueryRequest method, shouldn't it? It should also only be set if the config value is > 0, right?", "url": "https://github.com/eclipse/hono/pull/1882#discussion_r404567400", "createdAt": "2020-04-07T06:35:17Z", "author": {"login": "sophokles73"}, "path": "service-base/src/main/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecks.java", "diffHunk": "@@ -488,7 +488,9 @@ private void checkMessageLimit(\n \n         final Promise<Long> result = Promise.promise();\n         LOG.trace(\"running Prometheus query [URL: {}, query: {}]\", url, query);\n-        newQueryRequest(query).send(sendAttempt -> {\n+        newQueryRequest(query)\n+                .timeout(config.getQueryTimeout())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed3ff7cdedce42407be7e5184f6498c4a1d3d676"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU2ODYxMQ==", "bodyText": "My understanding is that the query will run on Prometheus for hte given amount of time. However, since the query will be started after the request has been sent, I assume that we can run into situations where the WebClient stops waiting for the response while the query is still running. I therefore think that the timeout set on the WebClient should serve as a backstop only, i.e. it should wait for some additional time in order to allow for the query to finish in any case. WDYT?", "url": "https://github.com/eclipse/hono/pull/1882#discussion_r404568611", "createdAt": "2020-04-07T06:38:16Z", "author": {"login": "sophokles73"}, "path": "service-base/src/main/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecks.java", "diffHunk": "@@ -515,6 +517,10 @@ private void checkMessageLimit(\n                 .expect(ResponsePredicate.SC_OK)\n                 .as(BodyCodec.jsonObject());\n \n+        if (config.getQueryTimeout() > 0) {\n+           request.addQueryParam(\"timeout\", String.format(\"%dms\", config.getQueryTimeout()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed3ff7cdedce42407be7e5184f6498c4a1d3d676"}, "originalPosition": 16}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ed3ff7cdedce42407be7e5184f6498c4a1d3d676", "author": {"user": {"login": "bordeuax", "name": "Sergiu Bordeianu"}}, "url": "https://github.com/eclipse/hono/commit/ed3ff7cdedce42407be7e5184f6498c4a1d3d676", "committedDate": "2020-04-06T23:09:22Z", "message": "[#1865] Hono resource limits : add timeout for Prometheus queries"}, "afterCommit": {"oid": "fb6a10bf1c0fcf7a715396adeb42372dbddffe3e", "author": {"user": {"login": "bordeuax", "name": "Sergiu Bordeianu"}}, "url": "https://github.com/eclipse/hono/commit/fb6a10bf1c0fcf7a715396adeb42372dbddffe3e", "committedDate": "2020-04-15T14:52:54Z", "message": "[#1865] Hono resource limits : add timeout for Prometheus queries\n\nSigned-off-by: Sergiu Bordeianu <sergiu.bordeianu@bosch-si.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb6a10bf1c0fcf7a715396adeb42372dbddffe3e", "author": {"user": {"login": "bordeuax", "name": "Sergiu Bordeianu"}}, "url": "https://github.com/eclipse/hono/commit/fb6a10bf1c0fcf7a715396adeb42372dbddffe3e", "committedDate": "2020-04-15T14:52:54Z", "message": "[#1865] Hono resource limits : add timeout for Prometheus queries\n\nSigned-off-by: Sergiu Bordeianu <sergiu.bordeianu@bosch-si.com>"}, "afterCommit": {"oid": "aed4ed5626d1182074a82548549155207e413f75", "author": {"user": {"login": "bordeuax", "name": "Sergiu Bordeianu"}}, "url": "https://github.com/eclipse/hono/commit/aed4ed5626d1182074a82548549155207e413f75", "committedDate": "2020-04-17T09:01:17Z", "message": "[#1865] Hono resource limits : add timeout for Prometheus queries\n\nSigned-off-by: Sergiu Bordeianu <sergiu.bordeianu@bosch-si.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MzQwNDUx", "url": "https://github.com/eclipse/hono/pull/1882#pullrequestreview-395340451", "createdAt": "2020-04-17T10:27:45Z", "commit": {"oid": "aed4ed5626d1182074a82548549155207e413f75"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMDoyNzo0NVrOGHIsGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMDoyNzo0NVrOGHIsGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEzNTU3OQ==", "bodyText": "how about using a request instead of the request since you are not referring to a particular request? e.g\n\nGets the period of time after which a request to a Prometheus server is closed", "url": "https://github.com/eclipse/hono/pull/1882#discussion_r410135579", "createdAt": "2020-04-17T10:27:45Z", "author": {"login": "Alfusainey"}, "path": "service-base/src/main/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecksConfig.java", "diffHunk": "@@ -138,4 +144,28 @@ public void setCacheTimeout(final long timeout) {\n         this.cacheTimeout = timeout;\n     }\n \n+    /**\n+     * Gets the period of time after which the request to a Prometheus server are closed.\n+     * <p>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aed4ed5626d1182074a82548549155207e413f75"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MzQxMTIw", "url": "https://github.com/eclipse/hono/pull/1882#pullrequestreview-395341120", "createdAt": "2020-04-17T10:28:49Z", "commit": {"oid": "aed4ed5626d1182074a82548549155207e413f75"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMDoyODo0OVrOGHIuFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMDoyODo0OVrOGHIuFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEzNjA4NA==", "bodyText": "same as above", "url": "https://github.com/eclipse/hono/pull/1882#discussion_r410136084", "createdAt": "2020-04-17T10:28:49Z", "author": {"login": "Alfusainey"}, "path": "service-base/src/main/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecksConfig.java", "diffHunk": "@@ -138,4 +144,28 @@ public void setCacheTimeout(final long timeout) {\n         this.cacheTimeout = timeout;\n     }\n \n+    /**\n+     * Gets the period of time after which the request to a Prometheus server are closed.\n+     * <p>\n+     * The default value of this property is {@link #DEFAULT_QUERY_TIMEOUT}.\n+     *\n+     * @return The timeout for the request to a remote server in milliseconds, zero or negative value is for disabled timeout.\n+     */\n+    public long getQueryTimeout() {\n+        return queryTimeout;\n+    }\n+\n+    /**\n+     * Sets the period of time after which the request to a Prometheus server are closed.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aed4ed5626d1182074a82548549155207e413f75"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MzQxNDc2", "url": "https://github.com/eclipse/hono/pull/1882#pullrequestreview-395341476", "createdAt": "2020-04-17T10:29:27Z", "commit": {"oid": "aed4ed5626d1182074a82548549155207e413f75"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMDoyOToyOFrOGHIvQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMDoyOToyOFrOGHIvQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEzNjM4Nw==", "bodyText": "has occured", "url": "https://github.com/eclipse/hono/pull/1882#discussion_r410136387", "createdAt": "2020-04-17T10:29:28Z", "author": {"login": "Alfusainey"}, "path": "service-base/src/test/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecksTest.java", "diffHunk": "@@ -519,6 +545,35 @@ public void testConnectionDurationLimitExceeded(final VertxTestContext ctx) {\n                 }));\n     }\n \n+    /**\n+     * Verifies that the message limit check returns {@code false} if a timeout is occurred.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aed4ed5626d1182074a82548549155207e413f75"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MzQ0MzYy", "url": "https://github.com/eclipse/hono/pull/1882#pullrequestreview-395344362", "createdAt": "2020-04-17T10:34:15Z", "commit": {"oid": "aed4ed5626d1182074a82548549155207e413f75"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMDozNDoxNVrOGHI38w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMDozNDoxNVrOGHI38w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEzODYxMQ==", "bodyText": "a  request to  a Prometheus server is closed", "url": "https://github.com/eclipse/hono/pull/1882#discussion_r410138611", "createdAt": "2020-04-17T10:34:15Z", "author": {"login": "Alfusainey"}, "path": "site/documentation/content/admin-guide/common-config.md", "diffHunk": "@@ -136,6 +136,7 @@ The following table provides an overview of the configuration variables and corr\n | `HONO_RESOURCELIMITS_PROMETHEUSBASED_CACHE_MIN_SIZE`<br>`--hono.resourceLimits.prometheusBased.cacheMinSize` | no | `20` | The minimum size of the cache to store the metrics data retrieved from the Prometheus server. The cache is used for storing the current amount of data exchanged with devices of tenants. |\n | `HONO_RESOURCELIMITS_PROMETHEUSBASED_CACHE_MAX_SIZE`<br>`--hono.resourceLimits.prometheusBased.cacheMaxSize` | no | `1000` | The maximum size of the cache to store the metrics data retrieved from the Prometheus server. |\n | `HONO_RESOURCELIMITS_PROMETHEUSBASED_CACHE_TIMEOUT`<br>`--hono.resourceLimits.prometheusBased.cacheTimeout` | no | `600` | The number of seconds after which the cached metrics data should be considered invalid. |\n+| `HONO_RESOURCELIMITS_PROMETHEUSBASED_QUERY_TIMEOUT`<br>`--hono.resourceLimits.prometheusBased.queryTimeout` | no | `500` | The number of milliseconds after which the request to a Prometheus server are closed. Setting zero or a negative value disables the timeout.|", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aed4ed5626d1182074a82548549155207e413f75"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3MDUyMTg1", "url": "https://github.com/eclipse/hono/pull/1882#pullrequestreview-397052185", "createdAt": "2020-04-21T07:20:28Z", "commit": {"oid": "aed4ed5626d1182074a82548549155207e413f75"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8dc5a7567f7c3696421c22a7ad5401829f58139a", "author": {"user": {"login": "bordeuax", "name": "Sergiu Bordeianu"}}, "url": "https://github.com/eclipse/hono/commit/8dc5a7567f7c3696421c22a7ad5401829f58139a", "committedDate": "2020-04-21T13:41:51Z", "message": "[#1865] Hono resource limits : add timeout for Prometheus queries\n\nSigned-off-by: Sergiu Bordeianu <sergiu.bordeianu@bosch-si.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aed4ed5626d1182074a82548549155207e413f75", "author": {"user": {"login": "bordeuax", "name": "Sergiu Bordeianu"}}, "url": "https://github.com/eclipse/hono/commit/aed4ed5626d1182074a82548549155207e413f75", "committedDate": "2020-04-17T09:01:17Z", "message": "[#1865] Hono resource limits : add timeout for Prometheus queries\n\nSigned-off-by: Sergiu Bordeianu <sergiu.bordeianu@bosch-si.com>"}, "afterCommit": {"oid": "8dc5a7567f7c3696421c22a7ad5401829f58139a", "author": {"user": {"login": "bordeuax", "name": "Sergiu Bordeianu"}}, "url": "https://github.com/eclipse/hono/commit/8dc5a7567f7c3696421c22a7ad5401829f58139a", "committedDate": "2020-04-21T13:41:51Z", "message": "[#1865] Hono resource limits : add timeout for Prometheus queries\n\nSigned-off-by: Sergiu Bordeianu <sergiu.bordeianu@bosch-si.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3ODY2NTEy", "url": "https://github.com/eclipse/hono/pull/1882#pullrequestreview-397866512", "createdAt": "2020-04-22T06:03:24Z", "commit": {"oid": "8dc5a7567f7c3696421c22a7ad5401829f58139a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 848, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}