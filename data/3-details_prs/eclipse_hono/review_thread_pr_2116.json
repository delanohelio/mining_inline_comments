{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5Mjg3MTY1", "number": 2116, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxMzoyNzo0NFrOEZe7Lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNDoxMToxMFrOEZgHtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MTU2NTI2OnYy", "diffSide": "RIGHT", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDbBasedDeviceBackend.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxMzoyNzo0NFrOHCUi1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNDowMTozNVrOHCWC-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE5NTc5OQ==", "bodyText": "I have changed the searchDevices method signature to no longer use Optional around the filters and sort options. Can you please adapt your code accordingly?", "url": "https://github.com/eclipse/hono/pull/2116#discussion_r472195799", "createdAt": "2020-08-18T13:27:44Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDbBasedDeviceBackend.java", "diffHunk": "@@ -77,6 +80,16 @@ public MongoDbBasedDeviceBackend(\n         return registrationService.readDevice(tenantId, deviceId, span);\n     }\n \n+    @Override\n+    public Future<OperationResult<List<DeviceWithId>>> searchDevices(final String tenantId,\n+            final int pageSize,\n+            final int pageOffset,\n+            final Optional<List<Filter>> filters,\n+            final Optional<List<Sort>> sortOptions,\n+            final Span span) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2281374b607b484b401d70245eb752d0cbebb6e1"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyMDQxMA==", "bodyText": "I have adapted the code according and pushed my changes.", "url": "https://github.com/eclipse/hono/pull/2116#discussion_r472220410", "createdAt": "2020-08-18T14:01:35Z", "author": {"login": "kaniyan"}, "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDbBasedDeviceBackend.java", "diffHunk": "@@ -77,6 +80,16 @@ public MongoDbBasedDeviceBackend(\n         return registrationService.readDevice(tenantId, deviceId, span);\n     }\n \n+    @Override\n+    public Future<OperationResult<List<DeviceWithId>>> searchDevices(final String tenantId,\n+            final int pageSize,\n+            final int pageOffset,\n+            final Optional<List<Filter>> filters,\n+            final Optional<List<Sort>> sortOptions,\n+            final Span span) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE5NTc5OQ=="}, "originalCommit": {"oid": "2281374b607b484b401d70245eb752d0cbebb6e1"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MTc0NTc0OnYy", "diffSide": "RIGHT", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDbBasedRegistrationService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNDowNzozOFrOHCWTtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNDozODo0M1rOHCXtoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyNDY5NQ==", "bodyText": "this should be put into a\nif (LOG.isTraceEnabled()) {\n}\n\nblock in order to prevent serialization of query and sort documents if not required", "url": "https://github.com/eclipse/hono/pull/2116#discussion_r472224695", "createdAt": "2020-08-18T14:07:38Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDbBasedRegistrationService.java", "diffHunk": "@@ -333,6 +354,53 @@ private RegistrationResult getRegistrationResult(final String deviceId, final Js\n                 });\n     }\n \n+    private Future<OperationResult<List<DeviceWithId>>> processSearchDevices(\n+            final String tenantId,\n+            final int pageSize,\n+            final int pageOffset,\n+            final List<Filter> filters,\n+            final List<Sort> sortOptions) {\n+\n+        final FindOptions searchDevicesOptions = new FindOptions()\n+                .setLimit(pageSize)\n+                .setSkip(pageOffset);\n+        final JsonObject searchDevicesQuery = MongoDbDocumentBuilder.builder()\n+                .withTenantId(tenantId)\n+                .withDeviceFilters(filters)\n+                .document();\n+        final JsonObject sortDocument = MongoDbDocumentBuilder.builder()\n+                .withDeviceSortOptions(sortOptions)\n+                .document();\n+        final Promise<List<JsonObject>> searchDevicesPromise = Promise.promise();\n+\n+        searchDevicesOptions.setSort(sortDocument);\n+        LOG.trace(\"pageSize: [{}], pageOffset: [{}], searchDevicesQuery: [{}], sortOptions: [{}]\", pageSize, pageOffset,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6de3ede629c0300792e4da27c880777f34ee13f4"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI0NzcxMg==", "bodyText": "I have incorporated it and pushed the changes.", "url": "https://github.com/eclipse/hono/pull/2116#discussion_r472247712", "createdAt": "2020-08-18T14:38:43Z", "author": {"login": "kaniyan"}, "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDbBasedRegistrationService.java", "diffHunk": "@@ -333,6 +354,53 @@ private RegistrationResult getRegistrationResult(final String deviceId, final Js\n                 });\n     }\n \n+    private Future<OperationResult<List<DeviceWithId>>> processSearchDevices(\n+            final String tenantId,\n+            final int pageSize,\n+            final int pageOffset,\n+            final List<Filter> filters,\n+            final List<Sort> sortOptions) {\n+\n+        final FindOptions searchDevicesOptions = new FindOptions()\n+                .setLimit(pageSize)\n+                .setSkip(pageOffset);\n+        final JsonObject searchDevicesQuery = MongoDbDocumentBuilder.builder()\n+                .withTenantId(tenantId)\n+                .withDeviceFilters(filters)\n+                .document();\n+        final JsonObject sortDocument = MongoDbDocumentBuilder.builder()\n+                .withDeviceSortOptions(sortOptions)\n+                .document();\n+        final Promise<List<JsonObject>> searchDevicesPromise = Promise.promise();\n+\n+        searchDevicesOptions.setSort(sortDocument);\n+        LOG.trace(\"pageSize: [{}], pageOffset: [{}], searchDevicesQuery: [{}], sortOptions: [{}]\", pageSize, pageOffset,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyNDY5NQ=="}, "originalCommit": {"oid": "6de3ede629c0300792e4da27c880777f34ee13f4"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MTc0NzMxOnYy", "diffSide": "RIGHT", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDbBasedRegistrationService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNDowODowMFrOHCWUsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNDoxNTozOVrOHCWq5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyNDk0NA==", "bodyText": "is there any value in creating this private method with exactly the same signature as searchDevices instead of simply implementing searchDevices directly?", "url": "https://github.com/eclipse/hono/pull/2116#discussion_r472224944", "createdAt": "2020-08-18T14:08:00Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDbBasedRegistrationService.java", "diffHunk": "@@ -333,6 +354,53 @@ private RegistrationResult getRegistrationResult(final String deviceId, final Js\n                 });\n     }\n \n+    private Future<OperationResult<List<DeviceWithId>>> processSearchDevices(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6de3ede629c0300792e4da27c880777f34ee13f4"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIzMDYyOA==", "bodyText": "As the code is already compact, IMHO there is no benefit or drawback. I just followed the same style as of other methods in that class.", "url": "https://github.com/eclipse/hono/pull/2116#discussion_r472230628", "createdAt": "2020-08-18T14:15:39Z", "author": {"login": "kaniyan"}, "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDbBasedRegistrationService.java", "diffHunk": "@@ -333,6 +354,53 @@ private RegistrationResult getRegistrationResult(final String deviceId, final Js\n                 });\n     }\n \n+    private Future<OperationResult<List<DeviceWithId>>> processSearchDevices(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyNDk0NA=="}, "originalCommit": {"oid": "6de3ede629c0300792e4da27c880777f34ee13f4"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MTc1NzIzOnYy", "diffSide": "RIGHT", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/utils/MongoDbDocumentBuilder.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNDoxMDoxOFrOHCWa9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNDozMTozMlrOHCXYnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyNjU0OA==", "bodyText": "does this also cover indexes into arrays, i.e. something like /myJsonArray/1 to address the second element of a JSON array?", "url": "https://github.com/eclipse/hono/pull/2116#discussion_r472226548", "createdAt": "2020-08-18T14:10:18Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/utils/MongoDbDocumentBuilder.java", "diffHunk": "@@ -126,4 +131,54 @@ public MongoDbDocumentBuilder withAuthId(final String authId) {\n         document.put(FIELD_CREDENTIALS_AUTH_ID_KEY, authId);\n         return this;\n     }\n+\n+\n+    /**\n+     * Sets the json object with the given device filters.\n+     *\n+     * @param filters The device filters list.\n+     * @return a reference to this for fluent use.\n+     */\n+    public MongoDbDocumentBuilder withDeviceFilters(final List<Filter> filters) {\n+\n+        filters.forEach(filter -> {\n+            // TODO: To implement when filter values contain patterns such as * or %\n+            if (FIELD_ID.equals(filter.getField())) {\n+                document.put(RegistryManagementConstants.FIELD_PAYLOAD_DEVICE_ID, filter.getValue());\n+            } else {\n+                document.put(MongoDbDeviceRegistryUtils.FIELD_DEVICE + filter.getField().toString().replace(\"/\", \".\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6de3ede629c0300792e4da27c880777f34ee13f4"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI0MjMzMg==", "bodyText": "yes, it covers arrays too. For example  /myJsonArray/1 is translated to device.myJsonArray.1 as required by the MongoDB search operation.", "url": "https://github.com/eclipse/hono/pull/2116#discussion_r472242332", "createdAt": "2020-08-18T14:31:32Z", "author": {"login": "kaniyan"}, "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/utils/MongoDbDocumentBuilder.java", "diffHunk": "@@ -126,4 +131,54 @@ public MongoDbDocumentBuilder withAuthId(final String authId) {\n         document.put(FIELD_CREDENTIALS_AUTH_ID_KEY, authId);\n         return this;\n     }\n+\n+\n+    /**\n+     * Sets the json object with the given device filters.\n+     *\n+     * @param filters The device filters list.\n+     * @return a reference to this for fluent use.\n+     */\n+    public MongoDbDocumentBuilder withDeviceFilters(final List<Filter> filters) {\n+\n+        filters.forEach(filter -> {\n+            // TODO: To implement when filter values contain patterns such as * or %\n+            if (FIELD_ID.equals(filter.getField())) {\n+                document.put(RegistryManagementConstants.FIELD_PAYLOAD_DEVICE_ID, filter.getValue());\n+            } else {\n+                document.put(MongoDbDeviceRegistryUtils.FIELD_DEVICE + filter.getField().toString().replace(\"/\", \".\"),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyNjU0OA=="}, "originalCommit": {"oid": "6de3ede629c0300792e4da27c880777f34ee13f4"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MTc2MTE4OnYy", "diffSide": "RIGHT", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/utils/MongoDbDocumentBuilder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNDoxMToxMFrOHCWddQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNDoxMToxMFrOHCWddQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyNzE4OQ==", "bodyText": "static?", "url": "https://github.com/eclipse/hono/pull/2116#discussion_r472227189", "createdAt": "2020-08-18T14:11:10Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/utils/MongoDbDocumentBuilder.java", "diffHunk": "@@ -126,4 +131,54 @@ public MongoDbDocumentBuilder withAuthId(final String authId) {\n         document.put(FIELD_CREDENTIALS_AUTH_ID_KEY, authId);\n         return this;\n     }\n+\n+\n+    /**\n+     * Sets the json object with the given device filters.\n+     *\n+     * @param filters The device filters list.\n+     * @return a reference to this for fluent use.\n+     */\n+    public MongoDbDocumentBuilder withDeviceFilters(final List<Filter> filters) {\n+\n+        filters.forEach(filter -> {\n+            // TODO: To implement when filter values contain patterns such as * or %\n+            if (FIELD_ID.equals(filter.getField())) {\n+                document.put(RegistryManagementConstants.FIELD_PAYLOAD_DEVICE_ID, filter.getValue());\n+            } else {\n+                document.put(MongoDbDeviceRegistryUtils.FIELD_DEVICE + filter.getField().toString().replace(\"/\", \".\"),\n+                        filter.getValue());\n+            }\n+        });\n+\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the json object with the given sorting options.\n+     *\n+     * @param sortOptions The list of soring options.\n+     * @return a reference to this for fluent use.\n+     */\n+    public MongoDbDocumentBuilder withDeviceSortOptions(final List<Sort> sortOptions) {\n+\n+        sortOptions.forEach(sortOption -> {\n+            if (FIELD_ID.equals(sortOption.getField())) {\n+                document.put(RegistryManagementConstants.FIELD_PAYLOAD_DEVICE_ID,\n+                        mapSortingDirection(sortOption.getDirection()));\n+            } else {\n+                document.put(MongoDbDeviceRegistryUtils.FIELD_DEVICE + \".\" + sortOption.getField(),\n+                        mapSortingDirection(sortOption.getDirection()));\n+            }\n+        });\n+        return this;\n+    }\n+\n+    private int mapSortingDirection(final Sort.Direction direction) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6de3ede629c0300792e4da27c880777f34ee13f4"}, "originalPosition": 73}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2978, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}