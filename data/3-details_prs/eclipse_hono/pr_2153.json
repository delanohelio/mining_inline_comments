{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc5Mjg3MzAz", "number": 2153, "title": "Improve Command & Control related tracing.", "bodyText": "The HTTP adapter now tracks the reception of a command in a separate \"wait for command\" span.\nThis allows for easier filtering in Jaeger for HTTP requests that have opened a command consumer.\nIn this span the reception of the command message is now logged explicitly, with details of the command message.\nFor the HTTP adapter, there are generally 2 separate traces involved in processing a command:\n\nThe trace for the HTTP request from the device\nThe trace that gets started when the command message initially gets received in Hono. (This trace is always separate because at the point of starting it, there is no association to the HTTP request from the device yet.)\n\nThis PR adds logging events to these two traces that were previously only set in one of them.\n(Corresponding changes to the CoAP adapter will be done in a separate PR.)", "createdAt": "2020-09-04T04:54:00Z", "url": "https://github.com/eclipse/hono/pull/2153", "merged": true, "mergeCommit": {"oid": "a4e6a96610bb3834f9636e083f0eb305e8ea34b9"}, "closed": true, "closedAt": "2020-09-04T14:07:02Z", "author": {"login": "calohmn"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFgbCWgFqTQ4MjQzNTU1NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFlfQWgFqTQ4MjY2NjE1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyNDM1NTU0", "url": "https://github.com/eclipse/hono/pull/2153#pullrequestreview-482435554", "createdAt": "2020-09-04T07:51:21Z", "commit": {"oid": "5c68a75cadf4ec47757e9940afb374d6d77dbfff"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNzo1MToyMVrOHNDa3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNzo1MToyMVrOHNDa3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ0OTU2NQ==", "bodyText": "FMPOV the cause (Throwable) should be logged here as intended by the OpenTracing spec, i.e. using Fields.ERROR_KIND and Fields.ERROR_OBJECT to be consistent with other cases where we use TracingHelper.log(Throwable). We might want to consider adding Fields.STACK to that method as well ...", "url": "https://github.com/eclipse/hono/pull/2153#discussion_r483449565", "createdAt": "2020-09-04T07:51:21Z", "author": {"login": "sophokles73"}, "path": "adapters/http-vertx-base/src/main/java/org/eclipse/hono/adapter/http/AbstractVertxBasedHttpProtocolAdapter.java", "diffHunk": "@@ -975,24 +974,34 @@ protected void setNonEmptyResponsePayload(final HttpServerResponse response, fin\n             }\n             return Future.succeededFuture();\n         }\n+        uploadMessageSpan.setTag(MessageHelper.APP_PROPERTY_DEVICE_TTD, ttdSecs);\n+\n+        final Span waitForCommandSpan = TracingHelper\n+                .buildChildSpan(tracer, uploadMessageSpan.context(),\n+                        \"wait for command\", getTypeName())\n+                .withTag(Tags.SPAN_KIND.getKey(), Tags.SPAN_KIND_CLIENT)\n+                .withTag(TracingHelper.TAG_TENANT_ID, tenantObject.getTenantId())\n+                .withTag(TracingHelper.TAG_DEVICE_ID, deviceId)\n+                .start();\n \n-        currentSpan.setTag(MessageHelper.APP_PROPERTY_DEVICE_TTD, ttdSecs);\n         final Handler<CommandContext> commandHandler = commandContext -> {\n \n             Tags.COMPONENT.set(commandContext.getTracingSpan(), getTypeName());\n             final Command command = commandContext.getCommand();\n             final Sample commandSample = getMetrics().startTimer();\n-            if (isCommandValid(command, currentSpan)) {\n+            if (isCommandValid(command, waitForCommandSpan)) {\n \n                 if (requestProcessed.compareAndSet(false, true)) {\n-                    checkMessageLimit(tenantObject, command.getPayloadSize(), currentSpan.context())\n+                    CommandConsumer.logReceivedCommandToSpan(command, waitForCommandSpan);\n+                    checkMessageLimit(tenantObject, command.getPayloadSize(), waitForCommandSpan.context())\n                     .onComplete(result -> {\n                         if (result.succeeded()) {\n                             addMicrometerSample(commandContext, commandSample);\n                             // put command context to routing context and notify\n                             ctx.put(CommandContext.KEY_COMMAND_CONTEXT, commandContext);\n                         } else {\n                             commandContext.reject(getErrorCondition(result.cause()));\n+                            waitForCommandSpan.log(\"rejected command for device: \" + result.cause());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c68a75cadf4ec47757e9940afb374d6d77dbfff"}, "originalPosition": 164}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5c68a75cadf4ec47757e9940afb374d6d77dbfff", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/5c68a75cadf4ec47757e9940afb374d6d77dbfff", "committedDate": "2020-09-04T04:42:47Z", "message": "Improve Command & Control related tracing.\n\nThe HTTP adapter now tracks the reception of a\ncommand in a separate span.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}, "afterCommit": {"oid": "f187a5b07ba4e9987b0129d2a51c96ff268b8b02", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/f187a5b07ba4e9987b0129d2a51c96ff268b8b02", "committedDate": "2020-09-04T08:28:27Z", "message": "Improve Command & Control related tracing.\n\nThe HTTP adapter now tracks the reception of a\ncommand in a separate span.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyNDk3MDEz", "url": "https://github.com/eclipse/hono/pull/2153#pullrequestreview-482497013", "createdAt": "2020-09-04T09:20:02Z", "commit": {"oid": "f187a5b07ba4e9987b0129d2a51c96ff268b8b02"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyNTA1Nzgy", "url": "https://github.com/eclipse/hono/pull/2153#pullrequestreview-482505782", "createdAt": "2020-09-04T09:33:07Z", "commit": {"oid": "f187a5b07ba4e9987b0129d2a51c96ff268b8b02"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwOTozMzowN1rOHNGw0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwOTozMzowN1rOHNGw0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwNDMzNw==", "bodyText": "The command is invalid in this case, isn't it? Shouldn't this result in an error being logged to the span?", "url": "https://github.com/eclipse/hono/pull/2153#discussion_r483504337", "createdAt": "2020-09-04T09:33:07Z", "author": {"login": "sophokles73"}, "path": "adapters/http-vertx-base/src/main/java/org/eclipse/hono/adapter/http/AbstractVertxBasedHttpProtocolAdapter.java", "diffHunk": "@@ -1020,6 +1029,9 @@ protected void setNonEmptyResponsePayload(final HttpServerResponse response, fin\n                 }\n \n             } else {\n+                if (!requestProcessed.get()) {\n+                    CommandConsumer.logReceivedCommandToSpan(command, waitForCommandSpan);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f187a5b07ba4e9987b0129d2a51c96ff268b8b02"}, "originalPosition": 173}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffb5389a0668d5f8ae66163d3d27ed343f0b4f2f", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/ffb5389a0668d5f8ae66163d3d27ed343f0b4f2f", "committedDate": "2020-09-04T12:17:47Z", "message": "Improve Command & Control related tracing.\n\nThe HTTP adapter now tracks the reception of a\ncommand in a separate span.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f187a5b07ba4e9987b0129d2a51c96ff268b8b02", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/f187a5b07ba4e9987b0129d2a51c96ff268b8b02", "committedDate": "2020-09-04T08:28:27Z", "message": "Improve Command & Control related tracing.\n\nThe HTTP adapter now tracks the reception of a\ncommand in a separate span.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}, "afterCommit": {"oid": "ffb5389a0668d5f8ae66163d3d27ed343f0b4f2f", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/ffb5389a0668d5f8ae66163d3d27ed343f0b4f2f", "committedDate": "2020-09-04T12:17:47Z", "message": "Improve Command & Control related tracing.\n\nThe HTTP adapter now tracks the reception of a\ncommand in a separate span.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyNjY2MTUy", "url": "https://github.com/eclipse/hono/pull/2153#pullrequestreview-482666152", "createdAt": "2020-09-04T13:47:29Z", "commit": {"oid": "ffb5389a0668d5f8ae66163d3d27ed343f0b4f2f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 546, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}