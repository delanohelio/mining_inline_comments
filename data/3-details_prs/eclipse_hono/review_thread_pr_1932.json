{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwNzY1MjA2", "number": 1932, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNzoxODoxMVrOD5slDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNzoxODoxMVrOD5slDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxODI1ODA0OnYy", "diffSide": "RIGHT", "path": "adapters/mqtt-vertx-base/src/main/java/org/eclipse/hono/adapter/mqtt/AbstractVertxBasedMqttProtocolAdapter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNzoxODoxMVrOGRGtSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwODoxNDo1M1rOGRIa3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU4ODg3NA==", "bodyText": "If I am not mistaken, then this code sends a disconnect event for each subscription being canceled. However, FMPOV we only need to send the disconnect once after all subscriptions have been canceled. WDYT?", "url": "https://github.com/eclipse/hono/pull/1932#discussion_r420588874", "createdAt": "2020-05-06T07:18:11Z", "author": {"login": "sophokles73"}, "path": "adapters/mqtt-vertx-base/src/main/java/org/eclipse/hono/adapter/mqtt/AbstractVertxBasedMqttProtocolAdapter.java", "diffHunk": "@@ -1196,12 +1201,12 @@ protected final void close(final MqttEndpoint endpoint, final Device authenticat\n \n         final Span span = newSpan(\"CLOSE\", endpoint, authenticatedDevice, traceSamplingPriority);\n         onClose(endpoint);\n-        cmdHandler.removeAllSubscriptions((tenant, device) -> {\n-            final Span closeHandlerSpan = newSpan(\"Send Disconnected Event\", endpoint, authenticatedDevice,\n-                    traceSamplingPriority);\n-            sendDisconnectedTtdEvent(tenant, device, authenticatedDevice, span.context())\n-                    .setHandler(sendAttempt -> closeHandlerSpan.finish());\n-        });\n+        final CompositeFuture removalDoneFuture = cmdHandler.removeAllSubscriptions((tenant, device) -> {\n+            final Span sendEventSpan = newChildSpan(span.context(), \"Send Disconnected Event\", endpoint,\n+                    authenticatedDevice);\n+            return sendDisconnectedTtdEvent(tenant, device, authenticatedDevice, sendEventSpan.context())\n+                    .onComplete(r -> sendEventSpan.finish()).mapEmpty();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c702ddc749cd2d02484e9567bb48248967a16ccc"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDYxNjkyNg==", "bodyText": "IMHO, the only scenario, where an MQTT device would want to create multiple subscriptions over the same MQTT connection, would be for a gateway device to add multiple subscriptions for commands targeted at different, specific devices. In that case, the sendDisconnectedTtdEvent method with its deviceId parameter should actually be called for all these devices separately.\nSo, I think, the code makes sense, the way it is.", "url": "https://github.com/eclipse/hono/pull/1932#discussion_r420616926", "createdAt": "2020-05-06T08:14:53Z", "author": {"login": "calohmn"}, "path": "adapters/mqtt-vertx-base/src/main/java/org/eclipse/hono/adapter/mqtt/AbstractVertxBasedMqttProtocolAdapter.java", "diffHunk": "@@ -1196,12 +1201,12 @@ protected final void close(final MqttEndpoint endpoint, final Device authenticat\n \n         final Span span = newSpan(\"CLOSE\", endpoint, authenticatedDevice, traceSamplingPriority);\n         onClose(endpoint);\n-        cmdHandler.removeAllSubscriptions((tenant, device) -> {\n-            final Span closeHandlerSpan = newSpan(\"Send Disconnected Event\", endpoint, authenticatedDevice,\n-                    traceSamplingPriority);\n-            sendDisconnectedTtdEvent(tenant, device, authenticatedDevice, span.context())\n-                    .setHandler(sendAttempt -> closeHandlerSpan.finish());\n-        });\n+        final CompositeFuture removalDoneFuture = cmdHandler.removeAllSubscriptions((tenant, device) -> {\n+            final Span sendEventSpan = newChildSpan(span.context(), \"Send Disconnected Event\", endpoint,\n+                    authenticatedDevice);\n+            return sendDisconnectedTtdEvent(tenant, device, authenticatedDevice, sendEventSpan.context())\n+                    .onComplete(r -> sendEventSpan.finish()).mapEmpty();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU4ODg3NA=="}, "originalCommit": {"oid": "c702ddc749cd2d02484e9567bb48248967a16ccc"}, "originalPosition": 92}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3372, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}