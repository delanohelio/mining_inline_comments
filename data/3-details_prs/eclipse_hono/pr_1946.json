{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0NjE1OTg0", "number": 1946, "title": "Verify tenant from command target address", "bodyText": "When mapping and delegating a command message, the tenant is now being\nextracted from the message's address instead of using the (static)\ntenant used for creating the tenant scoped command receiver link.\nSigned-off-by: Kai Hudalla kai.hudalla@bosch.io", "createdAt": "2020-05-07T11:08:28Z", "url": "https://github.com/eclipse/hono/pull/1946", "merged": true, "mergeCommit": {"oid": "40f0dcbb02b5f87a378aa7fb5c3f9c7b4902caae"}, "closed": true, "closedAt": "2020-05-25T06:34:40Z", "author": {"login": "sophokles73"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABce8VjDgFqTQwNzQxNjUzNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABckpYYvAFqTQxNzQ2NTg5Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NDE2NTM0", "url": "https://github.com/eclipse/hono/pull/1946#pullrequestreview-407416534", "createdAt": "2020-05-07T12:21:39Z", "commit": {"oid": "4e351112dbe69c4f951d021f34a212a828ed7de3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxMjoyMTozOVrOGR76dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxMjoyMTozOVrOGR76dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQ2MDU5OQ==", "bodyText": "What about a downstream application sending a command on a command/TenantA link and using command/TenantB/someDevice in the command message to address?\nCan we be sure that the AMQP messaging network rejects such a message if the sender has only been given rights to send on the command/TenantA address? I'm not sure if the qdrouter for example checks the to address here as well.", "url": "https://github.com/eclipse/hono/pull/1946#discussion_r421460599", "createdAt": "2020-05-07T12:21:39Z", "author": {"login": "calohmn"}, "path": "client/src/main/java/org/eclipse/hono/client/impl/MappingAndDelegatingCommandHandler.java", "diffHunk": "@@ -96,34 +96,45 @@ public MappingAndDelegatingCommandHandler(final HonoConnection connection,\n     }\n \n     /**\n+     * Delegates an incoming command to the protocol adapter instance that the target\n+     * device is connected to.\n+     * <p>\n      * Determines the target gateway (if applicable) and protocol adapter instance for an incoming command\n      * and delegates the command either to the local AdapterInstanceCommandHandler or to the resulting\n      * protocol adapter instance.\n      *\n-     * @param tenantId The tenant id.\n      * @param originalMessageDelivery The delivery of the command message.\n      * @param message The command message.\n      * @throws NullPointerException if any of the parameters is {@code null}.\n      */\n-    public void mapAndDelegateIncomingCommandMessage(final String tenantId,\n-            final ProtonDelivery originalMessageDelivery, final Message message) {\n-        Objects.requireNonNull(tenantId);\n+    public void mapAndDelegateIncomingCommandMessage(final ProtonDelivery originalMessageDelivery, final Message message) {\n         Objects.requireNonNull(originalMessageDelivery);\n         Objects.requireNonNull(message);\n \n-        // this is the place where a command message on the \"command/tenant\" address arrives *first*\n-        final String deviceId = message.getAddress() != null ? ResourceIdentifier.fromString(message.getAddress()).getResourceId() : null;\n-        if (deviceId == null) {\n-            LOG.debug(\"address of command message is invalid: {}\", message.getAddress());\n+        // this is the place where a command message on the \"command/${tenant}\" address arrives *first*\n+        if (message.getAddress() == null) {\n+            LOG.debug(\"command message has no address\");\n+            final Rejected rejected = new Rejected();\n+            rejected.setError(new ErrorCondition(Constants.AMQP_BAD_REQUEST, \"missing command target address\"));\n+            originalMessageDelivery.disposition(rejected, true);\n+            return;\n+        }\n+        final ResourceIdentifier targetAddress = ResourceIdentifier.fromString(message.getAddress());\n+        final String tenantId = targetAddress.getTenantId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e351112dbe69c4f951d021f34a212a828ed7de3"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "465e69cdcfdc16d6bd39fd612b98cb5637d99b31", "author": {"user": {"login": "sophokles73", "name": "Kai Hudalla"}}, "url": "https://github.com/eclipse/hono/commit/465e69cdcfdc16d6bd39fd612b98cb5637d99b31", "committedDate": "2020-05-20T18:04:51Z", "message": "Verify tenant from command target address\n\nWhen mapping and delegating a command message, the tenant from the\nmessage's address is now being compared to the tenant that the command\nreceiver link is scoped to.\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4e351112dbe69c4f951d021f34a212a828ed7de3", "author": {"user": {"login": "sophokles73", "name": "Kai Hudalla"}}, "url": "https://github.com/eclipse/hono/commit/4e351112dbe69c4f951d021f34a212a828ed7de3", "committedDate": "2020-05-07T11:07:36Z", "message": "Use tenant from command target address\n\nWhen mapping and delegating a command message, the tenant is now being\nextracted from the message's address instead of using the (static)\ntenant used for creating the tenant scoped command receiver link.\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>"}, "afterCommit": {"oid": "465e69cdcfdc16d6bd39fd612b98cb5637d99b31", "author": {"user": {"login": "sophokles73", "name": "Kai Hudalla"}}, "url": "https://github.com/eclipse/hono/commit/465e69cdcfdc16d6bd39fd612b98cb5637d99b31", "committedDate": "2020-05-20T18:04:51Z", "message": "Verify tenant from command target address\n\nWhen mapping and delegating a command message, the tenant from the\nmessage's address is now being compared to the tenant that the command\nreceiver link is scoped to.\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3NDY1ODky", "url": "https://github.com/eclipse/hono/pull/1946#pullrequestreview-417465892", "createdAt": "2020-05-25T05:40:06Z", "commit": {"oid": "465e69cdcfdc16d6bd39fd612b98cb5637d99b31"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 739, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}