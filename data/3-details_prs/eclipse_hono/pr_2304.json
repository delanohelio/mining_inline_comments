{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyNTI0Mzc4", "number": 2304, "title": "#2301 auto provisioning status properties integration tests", "bodyText": "", "createdAt": "2020-11-17T16:06:25Z", "url": "https://github.com/eclipse/hono/pull/2304", "merged": true, "mergeCommit": {"oid": "211e2346d74eef076c3522b52af603131170ef76"}, "closed": true, "closedAt": "2020-11-23T16:09:08Z", "author": {"login": "fkaltner"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddbt58gH2gAyNTIyNTI0Mzc4OmRlYThhZjAxZDRiMjNmZGEzOWJmMDE0MmFmODkwN2FhNDA5YzU5MmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfXbJEgFqTUzNjYyMTIwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dea8af01d4b23fda39bf0142af8907aa409c592d", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/dea8af01d4b23fda39bf0142af8907aa409c592d", "committedDate": "2020-11-17T15:58:37Z", "message": "#2301 Replacing \"dummy\" implementation of auto-provisioning properties in FileBasedRegistrationService\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "642b40f1b360c5d4141cb74edb10d96f5996f5ab", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/642b40f1b360c5d4141cb74edb10d96f5996f5ab", "committedDate": "2020-11-17T16:04:57Z", "message": "#2301 Adding assertions for auto-provisioning status properties to integration tests\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MjAxNTQ0", "url": "https://github.com/eclipse/hono/pull/2304#pullrequestreview-534201544", "createdAt": "2020-11-19T08:57:10Z", "commit": {"oid": "642b40f1b360c5d4141cb74edb10d96f5996f5ab"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwODo1NzoxMFrOH2SxmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwOTowMjo0MVrOH2S_2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY5Mjc2MA==", "bodyText": "is there a reason why this method returns a DeviceDto while forUpdate returns a FileBasedDeviceDto?", "url": "https://github.com/eclipse/hono/pull/2304#discussion_r526692760", "createdAt": "2020-11-19T08:57:10Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-file/src/main/java/org/eclipse/hono/deviceregistry/file/FileBasedRegistrationService.java", "diffHunk": "@@ -707,47 +705,57 @@ public String toString() {\n      */\n     private String generateDeviceId(final String tenantId) {\n \n-        final ConcurrentMap<String, FileBasedDeviceDto> devices = getDevicesForTenant(tenantId);\n+        final ConcurrentMap<String, DeviceDto> devices = getDevicesForTenant(tenantId);\n         String tempDeviceId;\n         do {\n             tempDeviceId = UUID.randomUUID().toString();\n         } while (devices.containsKey(tempDeviceId));\n         return tempDeviceId;\n     }\n \n-    private static final class FileBasedDeviceDto extends BaseDto<Versioned<Device>> {\n+    private static final class FileBasedDeviceDto extends DeviceDto {\n \n         FileBasedDeviceDto() {\n         }\n \n+        public static DeviceDto forRead(final String tenantId, final String deviceId, final JsonObject entry) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "642b40f1b360c5d4141cb74edb10d96f5996f5ab"}, "originalPosition": 231}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY5NDExOQ==", "bodyText": "to me it is very confusing that in some places we use DeviceDto while in others we use FileBasedDeviceDto. Can't we only use FileBasedDeviceDto?", "url": "https://github.com/eclipse/hono/pull/2304#discussion_r526694119", "createdAt": "2020-11-19T08:59:09Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-file/src/main/java/org/eclipse/hono/deviceregistry/file/FileBasedRegistrationService.java", "diffHunk": "@@ -75,7 +73,7 @@\n     private static final Logger LOG = LoggerFactory.getLogger(FileBasedRegistrationService.class);\n \n     // <tenantId, <deviceId, registrationData>>\n-    private final ConcurrentMap<String, ConcurrentMap<String, FileBasedDeviceDto>> identities = new ConcurrentHashMap<>();\n+    private final ConcurrentMap<String, ConcurrentMap<String, DeviceDto>> identities = new ConcurrentHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "642b40f1b360c5d4141cb74edb10d96f5996f5ab"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY5NjQxMQ==", "bodyText": "currently, the Device Registry Management API does not require the status property to be present in the response body. It also doesn't mention the autoprovisioned and autoprovisioningnotificationsent property at all.\nSo, IMHO we need to add these properties to the API spec, if they indeed can be returned by a registry implementation.", "url": "https://github.com/eclipse/hono/pull/2304#discussion_r526696411", "createdAt": "2020-11-19T09:02:41Z", "author": {"login": "sophokles73"}, "path": "tests/src/test/java/org/eclipse/hono/tests/registry/DeviceManagementIT.java", "diffHunk": "@@ -734,11 +735,19 @@ private static String assertLocationHeader(final MultiMap responseHeaders, final\n         return generatedId;\n     }\n \n-    private static void assertRegistrationInformation(final Device response, final Device expectedData) {\n+    private static void assertRegistrationInformation(final HttpResponse<Buffer> response, final Device expectedData) {\n \n+        final JsonObject actualDeviceJson = response.bodyAsJsonObject();\n+\n+        // internal status is not decoded from JSON as users should not be allowed to change internal status\n+        final JsonObject actualDeviceStatus = actualDeviceJson.getJsonObject(RegistryManagementConstants.FIELD_STATUS);\n+        assertThat(actualDeviceStatus.getBoolean(RegistryManagementConstants.FIELD_AUTO_PROVISIONED)).isFalse();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "642b40f1b360c5d4141cb74edb10d96f5996f5ab"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bcfd2c62a65e0b825c29098f35dca8dcaec142a2", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/bcfd2c62a65e0b825c29098f35dca8dcaec142a2", "committedDate": "2020-11-19T17:32:07Z", "message": "Review suggestions:\n- Using FileBasedDeviceDto everywhere\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MjM2MDQ3", "url": "https://github.com/eclipse/hono/pull/2304#pullrequestreview-535236047", "createdAt": "2020-11-20T08:58:37Z", "commit": {"oid": "bcfd2c62a65e0b825c29098f35dca8dcaec142a2"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwODo1ODozN1rOH3GUXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwOTowNzozMlrOH3G7SQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzNzI0NQ==", "bodyText": "shouldn't this method return a JdbcBasedDeviceDto?", "url": "https://github.com/eclipse/hono/pull/2304#discussion_r527537245", "createdAt": "2020-11-20T08:58:37Z", "author": {"login": "sophokles73"}, "path": "services/base-jdbc/src/main/java/org/eclipse/hono/service/base/jdbc/store/model/JdbcBasedDeviceDto.java", "diffHunk": "@@ -57,7 +57,7 @@ public static JdbcBasedDeviceDto forCreation(final DeviceKey deviceKey, final Bo\n      */\n     public static DeviceDto forRead(final String tenantId, final String deviceId, final JsonObject recordJson) {\n \n-        return DeviceDto.forRead(tenantId,\n+        return DeviceDto.forRead(DeviceDto::new, tenantId,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcfd2c62a65e0b825c29098f35dca8dcaec142a2"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU0NTg2Mg==", "bodyText": "camel case, yes. last-user should be changed to lastUser FMPOV. But we will handle that in another issue: #2309", "url": "https://github.com/eclipse/hono/pull/2304#discussion_r527545862", "createdAt": "2020-11-20T09:06:25Z", "author": {"login": "sophokles73"}, "path": "tests/src/test/java/org/eclipse/hono/tests/registry/DeviceManagementIT.java", "diffHunk": "@@ -734,11 +735,19 @@ private static String assertLocationHeader(final MultiMap responseHeaders, final\n         return generatedId;\n     }\n \n-    private static void assertRegistrationInformation(final Device response, final Device expectedData) {\n+    private static void assertRegistrationInformation(final HttpResponse<Buffer> response, final Device expectedData) {\n \n+        final JsonObject actualDeviceJson = response.bodyAsJsonObject();\n+\n+        // internal status is not decoded from JSON as users should not be allowed to change internal status\n+        final JsonObject actualDeviceStatus = actualDeviceJson.getJsonObject(RegistryManagementConstants.FIELD_STATUS);\n+        assertThat(actualDeviceStatus.getBoolean(RegistryManagementConstants.FIELD_AUTO_PROVISIONED)).isFalse();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY5NjQxMQ=="}, "originalCommit": {"oid": "642b40f1b360c5d4141cb74edb10d96f5996f5ab"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU0NzIwOQ==", "bodyText": "shouldn't this method return a MongoDbBasedDeviceDto?", "url": "https://github.com/eclipse/hono/pull/2304#discussion_r527547209", "createdAt": "2020-11-20T09:07:32Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/model/MongoDbBasedDeviceDto.java", "diffHunk": "@@ -44,7 +44,7 @@ public MongoDbBasedDeviceDto() {\n      */\n     public static DeviceDto forRead(final String tenantId, final String deviceId, final JsonObject recordJson) {\n \n-        return DeviceDto.forRead(tenantId,\n+        return DeviceDto.forRead(DeviceDto::new, tenantId,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcfd2c62a65e0b825c29098f35dca8dcaec142a2"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f1038cc9b97d2b27de46bbacb732b87564d82ef", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/3f1038cc9b97d2b27de46bbacb732b87564d82ef", "committedDate": "2020-11-20T09:34:38Z", "message": "Review suggestions:\n- Adding auto-provisioning properties to API spec\n- Returning JdbcBasedDeviceDto / MongoDbBasedDeviceDto in their forRead methods\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1Mjg1MTUx", "url": "https://github.com/eclipse/hono/pull/2304#pullrequestreview-535285151", "createdAt": "2020-11-20T10:00:24Z", "commit": {"oid": "3f1038cc9b97d2b27de46bbacb732b87564d82ef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMDowMDoyNFrOH3I99g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMDowMDoyNFrOH3I99g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU4MDY2Mg==", "bodyText": "can you also please bump the spec's version to 1.5.0", "url": "https://github.com/eclipse/hono/pull/2304#discussion_r527580662", "createdAt": "2020-11-20T10:00:24Z", "author": {"login": "sophokles73"}, "path": "site/documentation/content/api/management/device-registry-v1.yaml", "diffHunk": "@@ -1030,6 +1032,13 @@ components:\n             \"last-user\":\n                type: string\n                description: The user who made the last edit on this device.\n+            \"autoProvisioned\":", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f1038cc9b97d2b27de46bbacb732b87564d82ef"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2991ad051b871ebedd54eed9fa7a5764609fd612", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/2991ad051b871ebedd54eed9fa7a5764609fd612", "committedDate": "2020-11-20T10:04:08Z", "message": "Review suggestions:\n- Bumping API Spec version to 1.5.0\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NjIxMjA4", "url": "https://github.com/eclipse/hono/pull/2304#pullrequestreview-536621208", "createdAt": "2020-11-23T16:06:21Z", "commit": {"oid": "2991ad051b871ebedd54eed9fa7a5764609fd612"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 447, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}