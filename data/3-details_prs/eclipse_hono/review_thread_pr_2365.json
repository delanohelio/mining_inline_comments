{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1NzYxMTEx", "number": 2365, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNjo0NzoxNVrOFOwg_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNjo1NDoyOVrOFOwtxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUxMDE5MjYxOnYy", "diffSide": "RIGHT", "path": "tests/src/test/java/org/eclipse/hono/tests/amqp/AmqpUploadTestBase.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNjo0NzoxNVrOITtgAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNjo0NzoxNVrOITtgAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzUzOTMyOA==", "bodyText": "you should either consider the senderQoS being passed into the test method or do not run this as a parameterized test. FMPOV the latter would be ok.", "url": "https://github.com/eclipse/hono/pull/2365#discussion_r557539328", "createdAt": "2021-01-14T16:47:15Z", "author": {"login": "sophokles73"}, "path": "tests/src/test/java/org/eclipse/hono/tests/amqp/AmqpUploadTestBase.java", "diffHunk": "@@ -241,6 +244,76 @@ public void testAdapterClosesLinkOnMessageExceedingMaxPayloadSize(final VertxTes\n \n     }\n \n+    /**\n+     * Verifies that an edge device is auto-provisioned if it connects via a gateway equipped with the corresponding\n+     * authority.\n+     *\n+     * @param senderQos The delivery semantics to use for the device.\n+     * @throws InterruptedException if test is interrupted while running.\n+     */\n+    @ParameterizedTest(name = IntegrationTestSupport.PARAMETERIZED_TEST_NAME_PATTERN)\n+    @MethodSource(\"senderQoSTypes\")\n+    public void testAutoProvisioningViaGateway(final ProtonQoS senderQos) throws InterruptedException {\n+\n+        final String tenantId = helper.getRandomTenantId();\n+        final String gatewayId = helper.getRandomDeviceId(tenantId);\n+        final Device gateway = new Device()\n+                .setAuthorities(Collections.singleton(RegistryManagementConstants.AUTHORITY_AUTO_PROVISIONING_ENABLED));\n+\n+        final String username = IntegrationTestSupport.getUsername(gatewayId, tenantId);\n+        final VertxTestContext emptyEventReceived = new VertxTestContext();\n+        helper.applicationClientFactory.createEventConsumer(tenantId,\n+                msg -> emptyEventReceived.verify( () -> {\n+                    assertThat(msg.getContentType()).isEqualTo(EventConstants.CONTENT_TYPE_EMPTY_NOTIFICATION);\n+                    assertThat(MessageHelper.getRegistrationStatus(msg)).isEqualTo(EventConstants.RegistrationStatus.NEW.name());\n+                    emptyEventReceived.completeNow();\n+                }),\n+                close -> {});\n+\n+        final VertxTestContext telemetryReceived = new VertxTestContext();\n+        createConsumer(tenantId, msg -> {\n+            telemetryReceived.verify( () -> {\n+                assertThat(msg.getContentType()).isEqualTo(\"text/plain\");\n+                assertMessageProperties(telemetryReceived, msg);\n+            });\n+            telemetryReceived.completeNow();\n+        });\n+\n+        final VertxTestContext setup = new VertxTestContext();\n+        helper.registry\n+                .addDeviceForTenant(tenantId, new Tenant(), gatewayId, gateway, DEVICE_PASSWORD)\n+                .compose(ok -> connectToAdapter(username, DEVICE_PASSWORD))\n+                .compose(con -> createProducer(null, senderQos))\n+                .recover(t -> {\n+                    log.error(\"error setting up AMQP protocol adapter\", t);\n+                    return Future.failedFuture(t);\n+                })\n+                .onComplete(setup.succeeding(s -> {\n+                    sender = s;\n+                    setup.completeNow();\n+                }));\n+\n+        assertThat(setup.awaitCompletion(5, TimeUnit.SECONDS)).isTrue();\n+        assertThat(setup.failed())\n+                .as(\"successfully connect to adapter\")\n+                .isFalse();\n+\n+        final VertxTestContext messageSent = new VertxTestContext();\n+        final Message msg = ProtonHelper.message(\"apFoobar\");\n+        msg.setContentType(\"text/plain\");\n+\n+        final String deviceId = helper.getRandomDeviceId(tenantId);\n+        msg.setAddress(String.format(\"%s/%s/%s\", getEndpointName(), tenantId, deviceId));\n+        sender.send(msg, delivery -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d914e1c6ce29acb636dad0d07e970ae99e47c65b"}, "originalPosition": 88}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUxMDE5NjcyOnYy", "diffSide": "RIGHT", "path": "tests/src/test/java/org/eclipse/hono/tests/amqp/AmqpUploadTestBase.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNjo0ODowMVrOITticw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNjo0ODowMVrOITticw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzUzOTk1NQ==", "bodyText": "how about using a simple Checkpoint instead of coordinating three TestContexts?", "url": "https://github.com/eclipse/hono/pull/2365#discussion_r557539955", "createdAt": "2021-01-14T16:48:01Z", "author": {"login": "sophokles73"}, "path": "tests/src/test/java/org/eclipse/hono/tests/amqp/AmqpUploadTestBase.java", "diffHunk": "@@ -241,6 +244,76 @@ public void testAdapterClosesLinkOnMessageExceedingMaxPayloadSize(final VertxTes\n \n     }\n \n+    /**\n+     * Verifies that an edge device is auto-provisioned if it connects via a gateway equipped with the corresponding\n+     * authority.\n+     *\n+     * @param senderQos The delivery semantics to use for the device.\n+     * @throws InterruptedException if test is interrupted while running.\n+     */\n+    @ParameterizedTest(name = IntegrationTestSupport.PARAMETERIZED_TEST_NAME_PATTERN)\n+    @MethodSource(\"senderQoSTypes\")\n+    public void testAutoProvisioningViaGateway(final ProtonQoS senderQos) throws InterruptedException {\n+\n+        final String tenantId = helper.getRandomTenantId();\n+        final String gatewayId = helper.getRandomDeviceId(tenantId);\n+        final Device gateway = new Device()\n+                .setAuthorities(Collections.singleton(RegistryManagementConstants.AUTHORITY_AUTO_PROVISIONING_ENABLED));\n+\n+        final String username = IntegrationTestSupport.getUsername(gatewayId, tenantId);\n+        final VertxTestContext emptyEventReceived = new VertxTestContext();\n+        helper.applicationClientFactory.createEventConsumer(tenantId,\n+                msg -> emptyEventReceived.verify( () -> {\n+                    assertThat(msg.getContentType()).isEqualTo(EventConstants.CONTENT_TYPE_EMPTY_NOTIFICATION);\n+                    assertThat(MessageHelper.getRegistrationStatus(msg)).isEqualTo(EventConstants.RegistrationStatus.NEW.name());\n+                    emptyEventReceived.completeNow();\n+                }),\n+                close -> {});\n+\n+        final VertxTestContext telemetryReceived = new VertxTestContext();\n+        createConsumer(tenantId, msg -> {\n+            telemetryReceived.verify( () -> {\n+                assertThat(msg.getContentType()).isEqualTo(\"text/plain\");\n+                assertMessageProperties(telemetryReceived, msg);\n+            });\n+            telemetryReceived.completeNow();\n+        });\n+\n+        final VertxTestContext setup = new VertxTestContext();\n+        helper.registry\n+                .addDeviceForTenant(tenantId, new Tenant(), gatewayId, gateway, DEVICE_PASSWORD)\n+                .compose(ok -> connectToAdapter(username, DEVICE_PASSWORD))\n+                .compose(con -> createProducer(null, senderQos))\n+                .recover(t -> {\n+                    log.error(\"error setting up AMQP protocol adapter\", t);\n+                    return Future.failedFuture(t);\n+                })\n+                .onComplete(setup.succeeding(s -> {\n+                    sender = s;\n+                    setup.completeNow();\n+                }));\n+\n+        assertThat(setup.awaitCompletion(5, TimeUnit.SECONDS)).isTrue();\n+        assertThat(setup.failed())\n+                .as(\"successfully connect to adapter\")\n+                .isFalse();\n+\n+        final VertxTestContext messageSent = new VertxTestContext();\n+        final Message msg = ProtonHelper.message(\"apFoobar\");\n+        msg.setContentType(\"text/plain\");\n+\n+        final String deviceId = helper.getRandomDeviceId(tenantId);\n+        msg.setAddress(String.format(\"%s/%s/%s\", getEndpointName(), tenantId, deviceId));\n+        sender.send(msg, delivery -> {\n+            messageSent.verify(() -> assertThat(delivery.getRemoteState()).isInstanceOf(Accepted.class));\n+            messageSent.completeNow();\n+        });\n+\n+        assertThat(messageSent.awaitCompletion(5, TimeUnit.SECONDS)).isTrue();\n+        assertThat(emptyEventReceived.awaitCompletion(5, TimeUnit.SECONDS)).isTrue();\n+        assertThat(telemetryReceived.awaitCompletion(5, TimeUnit.SECONDS)).isTrue();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d914e1c6ce29acb636dad0d07e970ae99e47c65b"}, "originalPosition": 95}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUxMDIwODI0OnYy", "diffSide": "RIGHT", "path": "tests/src/test/java/org/eclipse/hono/tests/coap/CoapTestBase.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNjo1MDozMFrOITtpcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNjo1MDozMFrOITtpcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU0MTc0NQ==", "bodyText": "one gateway, isn't it?", "url": "https://github.com/eclipse/hono/pull/2365#discussion_r557541745", "createdAt": "2021-01-14T16:50:30Z", "author": {"login": "sophokles73"}, "path": "tests/src/test/java/org/eclipse/hono/tests/coap/CoapTestBase.java", "diffHunk": "@@ -408,6 +410,56 @@ public void testUploadMessagesViaGateway(final VertxTestContext ctx) throws Inte\n                 });\n     }\n \n+    /**\n+     * Verifies that an edge device is auto-provisioned if it connects via a gateway equipped with the corresponding\n+     * authority.\n+     *\n+     * @param ctx The test context.\n+     * @throws InterruptedException if the test fails.\n+     */\n+    @Test\n+    public void testAutoProvisioningViaGateway(final VertxTestContext ctx) throws InterruptedException {\n+\n+        // GIVEN a device that is connected via two gateways", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d914e1c6ce29acb636dad0d07e970ae99e47c65b"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUxMDIyMjAyOnYy", "diffSide": "RIGHT", "path": "tests/src/test/java/org/eclipse/hono/tests/coap/CoapTestBase.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNjo1Mzo0MVrOITtyLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNjo1Mzo0MVrOITtyLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU0Mzk4Mg==", "bodyText": "IMHO sending the message could/should be done in a much simpler way, e.g. as in the testUploadMessageFailsForDisabledDevice test method ...", "url": "https://github.com/eclipse/hono/pull/2365#discussion_r557543982", "createdAt": "2021-01-14T16:53:41Z", "author": {"login": "sophokles73"}, "path": "tests/src/test/java/org/eclipse/hono/tests/coap/CoapTestBase.java", "diffHunk": "@@ -408,6 +410,56 @@ public void testUploadMessagesViaGateway(final VertxTestContext ctx) throws Inte\n                 });\n     }\n \n+    /**\n+     * Verifies that an edge device is auto-provisioned if it connects via a gateway equipped with the corresponding\n+     * authority.\n+     *\n+     * @param ctx The test context.\n+     * @throws InterruptedException if the test fails.\n+     */\n+    @Test\n+    public void testAutoProvisioningViaGateway(final VertxTestContext ctx) throws InterruptedException {\n+\n+        // GIVEN a device that is connected via two gateways\n+        final Tenant tenant = new Tenant();\n+        final String gatewayId = helper.getRandomDeviceId(tenantId);\n+        final Device gateway = new Device()\n+                .setAuthorities(Collections.singleton(RegistryManagementConstants.AUTHORITY_AUTO_PROVISIONING_ENABLED));\n+\n+        final VertxTestContext setup = new VertxTestContext();\n+        helper.registry.addPskDeviceForTenant(tenantId, tenant, gatewayId, gateway, SECRET)\n+                .onComplete(setup.completing());\n+        ctx.verify(() -> assertThat(setup.awaitCompletion(5, TimeUnit.SECONDS)).isTrue());\n+\n+        final CoapClient gatewayClient = getCoapsClient(gatewayId, tenantId, SECRET);\n+\n+        final VertxTestContext emptyEventReceived = new VertxTestContext();\n+        helper.applicationClientFactory.createEventConsumer(tenantId,\n+                msg -> emptyEventReceived.verify( () -> {\n+                    // ignore potential events of warmup\n+                    if (MessageHelper.getDeviceId(msg).equals(deviceId)) {\n+                        assertThat(msg.getContentType()).isEqualTo(EventConstants.CONTENT_TYPE_EMPTY_NOTIFICATION);\n+                        assertThat(MessageHelper.getRegistrationStatus(msg)).isEqualTo(EventConstants.RegistrationStatus.NEW.name());\n+                        emptyEventReceived.completeNow();\n+                    }\n+                }),\n+                close -> {});\n+\n+        testUploadMessages(ctx, tenantId,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d914e1c6ce29acb636dad0d07e970ae99e47c65b"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUxMDIyNTM1OnYy", "diffSide": "RIGHT", "path": "tests/src/test/java/org/eclipse/hono/tests/http/HttpTestBase.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNjo1NDoyOVrOITt0GQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNjo1NDoyOVrOITt0GQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU0NDQ3Mw==", "bodyText": "same here, simply send one request and handle its outcome directly ...", "url": "https://github.com/eclipse/hono/pull/2365#discussion_r557544473", "createdAt": "2021-01-14T16:54:29Z", "author": {"login": "sophokles73"}, "path": "tests/src/test/java/org/eclipse/hono/tests/http/HttpTestBase.java", "diffHunk": "@@ -857,6 +859,64 @@ public void testUploadMessageFailsForUnauthorizedGateway(final VertxTestContext\n         .onComplete(ctx.completing());\n     }\n \n+    /**\n+     * Verifies that an edge device is auto-provisioned if it connects via a gateway equipped with the corresponding\n+     * authority.\n+     *\n+     * @param ctx The test context.\n+     * @throws InterruptedException if the test fails.\n+     */\n+    @Test\n+    public void testAutoProvisioningViaGateway(final VertxTestContext ctx) throws InterruptedException {\n+\n+        final Tenant tenant = new Tenant();\n+        final String gatewayId = helper.getRandomDeviceId(tenantId);\n+        final Device gateway = new Device()\n+                .setAuthorities(Collections.singleton(RegistryManagementConstants.AUTHORITY_AUTO_PROVISIONING_ENABLED));\n+\n+        final VertxTestContext setup = new VertxTestContext();\n+        helper.registry.addDeviceForTenant(tenantId, tenant, gatewayId, gateway, PWD)\n+                .onComplete(setup.completing());\n+\n+        assertThat(setup.awaitCompletion(5, TimeUnit.SECONDS)).isTrue();\n+        if (setup.failed()) {\n+            ctx.failNow(setup.causeOfFailure());\n+            return;\n+        }\n+\n+        final MultiMap requestHeaders = MultiMap.caseInsensitiveMultiMap()\n+                .add(HttpHeaders.CONTENT_TYPE, \"text/plain\")\n+                .add(HttpHeaders.AUTHORIZATION, getBasicAuth(tenantId, gatewayId, PWD))\n+                .add(HttpHeaders.ORIGIN, ORIGIN_URI);\n+\n+        final String uri = String.format(\"%s/%s/%s\", getEndpointUri(), tenantId, helper.getRandomDeviceId(tenantId));\n+\n+        helper.applicationClientFactory.createEventConsumer(tenantId, msg -> {\n+            ctx.verify(() -> {\n+                assertThat(msg.getContentType()).isEqualTo(EventConstants.CONTENT_TYPE_EMPTY_NOTIFICATION);\n+                assertThat(MessageHelper.getRegistrationStatus(msg)).isEqualTo(EventConstants.RegistrationStatus.NEW.name());\n+            });\n+        }, remoteClose -> {});\n+\n+        testUploadMessages(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d914e1c6ce29acb636dad0d07e970ae99e47c65b"}, "originalPosition": 54}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2944, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}