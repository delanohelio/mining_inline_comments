{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3ODcwOTQ0", "number": 1920, "title": "[#1848] Fix limit verification outcomes in AMQP adapter.", "bodyText": "In AMQP adapter, the checks (such as connection limit, adapter enabled or not ) are performed as part of the AmqpAdapterSaslAuthenticatorFactory. If the connection limit check has failed or the adapter is disabled, this approach always returned authentication failure instead of propagating the actual reason. In this PR, these checks are moved out of the AmqpAdapterSaslAuthenticatorFactory and there by fixing the issue #1848.", "createdAt": "2020-04-23T12:03:47Z", "url": "https://github.com/eclipse/hono/pull/1920", "merged": true, "mergeCommit": {"oid": "d0cb9b066904d826b5ed79579db2b38b67a14ff4"}, "closed": true, "closedAt": "2020-04-28T13:41:11Z", "author": {"login": "kaniyan"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcadV12gBqjMyNjUxMTQ4MzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABccCyTbgFqTQwMTc3MDQ5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fafaa3d695723e88a295e07f3c18bc37abba0623", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/fafaa3d695723e88a295e07f3c18bc37abba0623", "committedDate": "2020-04-23T11:46:04Z", "message": "[#1848] Fix limit verification outcomes in AMQP adapter.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}, "afterCommit": {"oid": "eebfcc4e4dc7dbe4f35dc456f11e2c4c4ef5057d", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/eebfcc4e4dc7dbe4f35dc456f11e2c4c4ef5057d", "committedDate": "2020-04-23T13:20:33Z", "message": "[#1848] Fix limit verification outcomes in AMQP adapter.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNzIwNjAy", "url": "https://github.com/eclipse/hono/pull/1920#pullrequestreview-400720602", "createdAt": "2020-04-27T08:11:34Z", "commit": {"oid": "eebfcc4e4dc7dbe4f35dc456f11e2c4c4ef5057d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QwODoxMTozNFrOGMWZBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QwODoxNzowMVrOGMWngA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYwMjk0OA==", "bodyText": "what about\n// we still need to verify that\n// the adapter is enabled for the tenant,\n// the device/gateway exists and is enabled and\n// that the connection limit for the tenant and the adapter are not exceeded.", "url": "https://github.com/eclipse/hono/pull/1920#discussion_r415602948", "createdAt": "2020-04-27T08:11:34Z", "author": {"login": "sophokles73"}, "path": "adapters/amqp-vertx/src/main/java/org/eclipse/hono/adapter/amqp/impl/VertxBasedAmqpProtocolAdapter.java", "diffHunk": "@@ -357,18 +357,26 @@ private void processRemoteOpen(final ProtonConnection con) {\n         if (getConfig().isAuthenticationRequired()) {\n \n             if (authenticatedDevice == null) {\n-                connectAuthorizationCheck.fail(new ClientErrorException(HttpURLConnection.HTTP_UNAUTHORIZED, \"anonymous devices not supported\"));\n+                connectAuthorizationCheck.fail(new ClientErrorException(HttpURLConnection.HTTP_UNAUTHORIZED,\n+                        \"anonymous devices not supported\"));\n             } else {\n                 log.trace(\"received connection request from {}\", authenticatedDevice);\n                 // the SASL handshake will already have authenticated the device\n-                // and will have verified that the adapter is enabled for the tenant\n-                // we still need to check if the device/gateway exists and is enabled\n-                checkDeviceRegistration(authenticatedDevice, span.context())\n-                .map(ok -> {\n-                    log.debug(\"{} is registered and enabled\", authenticatedDevice);\n-                    span.log(\"device is registered and enabled\");\n-                    return ok;\n-                }).setHandler(connectAuthorizationCheck);\n+                // and verify if the adapter is enabled for the tenant", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eebfcc4e4dc7dbe4f35dc456f11e2c4c4ef5057d"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYwNjY1Ng==", "bodyText": "can you please refactor the tests to use assertj instead?", "url": "https://github.com/eclipse/hono/pull/1920#discussion_r415606656", "createdAt": "2020-04-27T08:17:01Z", "author": {"login": "sophokles73"}, "path": "adapters/amqp-vertx/src/test/java/org/eclipse/hono/adapter/amqp/impl/VertxBasedAmqpProtocolAdapterTest.java", "diffHunk": "@@ -13,6 +13,7 @@\n package org.eclipse.hono.adapter.amqp.impl;\n \n import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.assertEquals;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eebfcc4e4dc7dbe4f35dc456f11e2c4c4ef5057d"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77802e253e7fa636210577406f714e5d570fccf2", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/77802e253e7fa636210577406f714e5d570fccf2", "committedDate": "2020-04-28T09:16:22Z", "message": "[#1848] Fix limit verification outcomes in AMQP adapter.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97eb6b62aef18bc10a30eaafd0027ba4a4edd3fb", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/97eb6b62aef18bc10a30eaafd0027ba4a4edd3fb", "committedDate": "2020-04-28T11:31:32Z", "message": "[#1848] Update user guide and release notes.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eebfcc4e4dc7dbe4f35dc456f11e2c4c4ef5057d", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/eebfcc4e4dc7dbe4f35dc456f11e2c4c4ef5057d", "committedDate": "2020-04-23T13:20:33Z", "message": "[#1848] Fix limit verification outcomes in AMQP adapter.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}, "afterCommit": {"oid": "97eb6b62aef18bc10a30eaafd0027ba4a4edd3fb", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/97eb6b62aef18bc10a30eaafd0027ba4a4edd3fb", "committedDate": "2020-04-28T11:31:32Z", "message": "[#1848] Update user guide and release notes.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNzcwNDk3", "url": "https://github.com/eclipse/hono/pull/1920#pullrequestreview-401770497", "createdAt": "2020-04-28T12:10:18Z", "commit": {"oid": "97eb6b62aef18bc10a30eaafd0027ba4a4edd3fb"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMjoxMDoxOFrOGNQ2qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMjoxMDoxOFrOGNQ2qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU2MDgxMQ==", "bodyText": "I see. Let's keep it like this, then ...", "url": "https://github.com/eclipse/hono/pull/1920#discussion_r416560811", "createdAt": "2020-04-28T12:10:18Z", "author": {"login": "sophokles73"}, "path": "adapters/amqp-vertx/src/test/java/org/eclipse/hono/adapter/amqp/impl/VertxBasedAmqpProtocolAdapterTest.java", "diffHunk": "@@ -13,6 +13,7 @@\n package org.eclipse.hono.adapter.amqp.impl;\n \n import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.assertEquals;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYwNjY1Ng=="}, "originalCommit": {"oid": "eebfcc4e4dc7dbe4f35dc456f11e2c4c4ef5057d"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 890, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}