{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5MTg2MTgz", "number": 2051, "title": "#1856 negative authenticated connection count", "bodyText": "This fixes #1856", "createdAt": "2020-06-24T12:50:21Z", "url": "https://github.com/eclipse/hono/pull/2051", "merged": true, "mergeCommit": {"oid": "4e6247181645747323c9f4108d9e7a5bd495412c"}, "closed": true, "closedAt": "2020-06-25T06:09:45Z", "author": {"login": "fkaltner"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuZlXHAH2gAyNDM5MTg2MTgzOmM5N2NiOGM3YThhNjNkMTA4NjU1ZjNlZWRhNjE1OThiZDNkYzRiYjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuoXLVgFqTQzNzE5MjQ0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c97cb8c7a8a63d108655f3eeda61598bd3dc4bb0", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/c97cb8c7a8a63d108655f3eeda61598bd3dc4bb0", "committedDate": "2020-06-24T12:55:02Z", "message": "[#1856] Fixing negative AMQP authenticated connection count metric\n\nConnection count was erroneously not incremented when a connection was rejected due to the connection limit of an adapter, but was decremented in that case as well which lead to negative connection counts.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a662b1e1f65bb694250e864020111dccced21d2b", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/a662b1e1f65bb694250e864020111dccced21d2b", "committedDate": "2020-06-24T12:45:12Z", "message": "[#1856] Fixing negative AMQP authenticated connection count metric\n\nConnection count was erroneously not incremented when a connection was rejected due to the connection limit of an adapter, but was decremented in that case as well which lead to negative connection counts.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}, "afterCommit": {"oid": "c97cb8c7a8a63d108655f3eeda61598bd3dc4bb0", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/c97cb8c7a8a63d108655f3eeda61598bd3dc4bb0", "committedDate": "2020-06-24T12:55:02Z", "message": "[#1856] Fixing negative AMQP authenticated connection count metric\n\nConnection count was erroneously not incremented when a connection was rejected due to the connection limit of an adapter, but was decremented in that case as well which lead to negative connection counts.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2Njg5NzEx", "url": "https://github.com/eclipse/hono/pull/2051#pullrequestreview-436689711", "createdAt": "2020-06-24T14:15:38Z", "commit": {"oid": "c97cb8c7a8a63d108655f3eeda61598bd3dc4bb0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxNDoxNTozOFrOGoUIBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxNDoxNTozOFrOGoUIBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDkyNTk1OA==", "bodyText": "FMPOV this check should be done immediately after the openHandler has been invoked", "url": "https://github.com/eclipse/hono/pull/2051#discussion_r444925958", "createdAt": "2020-06-24T14:15:38Z", "author": {"login": "sophokles73"}, "path": "adapters/amqp-vertx/src/test/java/org/eclipse/hono/adapter/amqp/impl/VertxBasedAmqpProtocolAdapterTest.java", "diffHunk": "@@ -1189,10 +1191,17 @@ public void testConnectionFailsIfAdapterLevelConnectionLimitIsExceeded() {\n                 .forClass(Handler.class);\n         verify(deviceConnection).openHandler(openHandler.capture());\n         openHandler.getValue().handle(Future.succeededFuture(deviceConnection));\n-        // THEN the adapter does not accept the incoming connection request. \n+        // THEN the adapter closes the connection right after it opened it\n+        final ArgumentCaptor<Handler<AsyncResult<ProtonConnection>>> closeHandler = ArgumentCaptor.forClass(Handler.class);\n+        verify(deviceConnection).closeHandler(closeHandler.capture());\n+        closeHandler.getValue().handle(Future.succeededFuture());\n         final ArgumentCaptor<ErrorCondition> errorConditionCaptor = ArgumentCaptor.forClass(ErrorCondition.class);\n         verify(deviceConnection).setCondition(errorConditionCaptor.capture());\n         assertEquals(AmqpError.UNAUTHORIZED_ACCESS, errorConditionCaptor.getValue().getCondition());\n+        // AND increments and decrements the connection count accordingly\n+        final InOrder metricsInOrderVerifier = inOrder(metrics);\n+        metricsInOrderVerifier.verify(metrics).incrementConnections(TEST_TENANT_ID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c97cb8c7a8a63d108655f3eeda61598bd3dc4bb0"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a180d94580c1fab08fd360f4dc57c0f2dca251a4", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/a180d94580c1fab08fd360f4dc57c0f2dca251a4", "committedDate": "2020-06-24T15:03:40Z", "message": "[#1856] Fixing negative AMQP authenticated connection count metric\n\nConnection count was erroneously not incremented when a connection was rejected due to the connection limit of an adapter, but was decremented in that case as well which lead to negative connection counts.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MTkyNDQw", "url": "https://github.com/eclipse/hono/pull/2051#pullrequestreview-437192440", "createdAt": "2020-06-25T06:08:07Z", "commit": {"oid": "a180d94580c1fab08fd360f4dc57c0f2dca251a4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 688, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}