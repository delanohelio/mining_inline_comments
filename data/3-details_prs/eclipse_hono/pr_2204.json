{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxODY2MDIy", "number": 2204, "title": "Extend search devices operation to support wildcards in the MongoDB device registry", "bodyText": "With this PR, the MongoDB device registry supports wildcard matching in search devices operation. The supported wildcard characters are  *  and ?.", "createdAt": "2020-09-23T15:31:24Z", "url": "https://github.com/eclipse/hono/pull/2204", "merged": true, "mergeCommit": {"oid": "4ad5e24f8516f8c82f00f4b7a08881e7f9a951fc"}, "closed": true, "closedAt": "2020-09-25T13:04:02Z", "author": {"login": "kaniyan"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLuW1zgH2gAyNDkxODY2MDIyOmI2ZGU0Yzc0MmFhNDA0ZGVjYjlkOTBmMmQzMzQxMWZmZDBkYmMwNTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMVcu5gFqTQ5NjM5ODY2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b6de4c742aa404decb9d90f2d33411ffd0dbc051", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/b6de4c742aa404decb9d90f2d33411ffd0dbc051", "committedDate": "2020-09-23T15:30:59Z", "message": "Extend search devices operation to support wildcards in the MongoDB based registry.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2MzYzNTUz", "url": "https://github.com/eclipse/hono/pull/2204#pullrequestreview-496363553", "createdAt": "2020-09-25T12:13:31Z", "commit": {"oid": "b6de4c742aa404decb9d90f2d33411ffd0dbc051"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxMjoxMzozMVrOHYBFVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxMjoxNDo1MlrOHYBHxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk0NTYyMg==", "bodyText": "does it make a big difference to handle the two cases differently? I would assume that MongoDB internally treats both cases the same anyway, i.e. wrapping a literal string with ^ and $, thus turning it into a regex.\nWe could then simply let DeviceRegistryUtils.getRegexExpressionForSearchOperation handle all filters ...", "url": "https://github.com/eclipse/hono/pull/2204#discussion_r494945622", "createdAt": "2020-09-25T12:13:31Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/utils/MongoDbDocumentBuilder.java", "diffHunk": "@@ -142,10 +143,18 @@ public MongoDbDocumentBuilder withAuthId(final String authId) {\n     public MongoDbDocumentBuilder withDeviceFilters(final List<Filter> filters) {\n \n         filters.forEach(filter -> {\n-            // TODO: To implement when filter values contain patterns such as * or %\n-            document.put(mapDeviceField(filter.getField()), filter.getValue());\n+            if (filter.getValue() instanceof String) {\n+                final String value = (String) filter.getValue();\n+                if (value.contains(\"*\") || value.contains(\"?\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6de4c742aa404decb9d90f2d33411ffd0dbc051"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk0NjI0Nw==", "bodyText": "is there a particular reason why you want to use the brackets here?", "url": "https://github.com/eclipse/hono/pull/2204#discussion_r494946247", "createdAt": "2020-09-25T12:14:52Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-base/src/main/java/org/eclipse/hono/deviceregistry/util/DeviceRegistryUtils.java", "diffHunk": "@@ -284,4 +287,36 @@ public static boolean matchesWithClientContext(final JsonObject credential,\n                         .orElse(true));\n \n     }\n+\n+    /**\n+     * Returns a regex expression based on the given filter value which can be used by the device registry \n+     * implementations to support wildcard matching during search operations.\n+     * <p>\n+     * The below wildcard characters are supported.\n+     * <ol>\n+     * <li>`*` will match zero or any number of characters.</li>\n+     * <li>`?` will match exactly one character.</li>\n+     * </ol>\n+     * @param filterValue The value corresponding to the field to use for filtering.\n+     * @return The regex expression to use for filtering.\n+     * @throws NullPointerException if the filterValue is {@code null}\n+     */\n+    public static String getRegexExpressionForSearchOperation(final String filterValue) {\n+        Objects.requireNonNull(filterValue);\n+\n+        return Collections.list(new StringTokenizer(filterValue, \"*?\", true))\n+                .stream()\n+                .map(token -> (String) token)\n+                .map(token -> {\n+                    if (token.equals(\"*\")) {\n+                        return \"(.*)\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6de4c742aa404decb9d90f2d33411ffd0dbc051"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2Mzk4NjYx", "url": "https://github.com/eclipse/hono/pull/2204#pullrequestreview-496398661", "createdAt": "2020-09-25T13:03:43Z", "commit": {"oid": "b6de4c742aa404decb9d90f2d33411ffd0dbc051"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 589, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}