{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1MjYxMTUw", "number": 2360, "title": "#2053 implicit device registration mongodb registry", "bodyText": "This pull request depends on #2094 being merged first.\nSo I guess it makes sense to review the second commit only.\nNote however that this PR partially shares changes with #2358 and #2359 in order to not depend on these being merged before.", "createdAt": "2020-12-09T15:28:10Z", "url": "https://github.com/eclipse/hono/pull/2360", "merged": true, "mergeCommit": {"oid": "04493df6d687f3f65a37e6311374eb7a39c88e44"}, "closed": true, "closedAt": "2021-01-12T08:48:40Z", "author": {"login": "fkaltner"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmv9EeABqjQxMjAwMTk1ODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdvXHvkgFqTU2NjA0NzgxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "616f375f1b1429655e9b47f22f305bc564389eeb", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/616f375f1b1429655e9b47f22f305bc564389eeb", "committedDate": "2020-12-09T15:26:28Z", "message": "[#2053] Adding capability to auto-provision devices to MongoDb-based device registry.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}, "afterCommit": {"oid": "18fbbc8015540970723bf6936022235e5d9ac4f2", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/18fbbc8015540970723bf6936022235e5d9ac4f2", "committedDate": "2020-12-16T14:38:19Z", "message": "[#2053] Adding capability to auto-provision devices to MongoDb-based device registry.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "18fbbc8015540970723bf6936022235e5d9ac4f2", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/18fbbc8015540970723bf6936022235e5d9ac4f2", "committedDate": "2020-12-16T14:38:19Z", "message": "[#2053] Adding capability to auto-provision devices to MongoDb-based device registry.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}, "afterCommit": {"oid": "69dca12b69675f9640b27b1f0532870dbdeed43b", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/69dca12b69675f9640b27b1f0532870dbdeed43b", "committedDate": "2021-01-05T08:44:01Z", "message": "[#2053] Adding capability to auto-provision devices to MongoDb-based device registry.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "69dca12b69675f9640b27b1f0532870dbdeed43b", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/69dca12b69675f9640b27b1f0532870dbdeed43b", "committedDate": "2021-01-05T08:44:01Z", "message": "[#2053] Adding capability to auto-provision devices to MongoDb-based device registry.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}, "afterCommit": {"oid": "bc3f8d1477c1031c58a0bbce3b3c6df1ce388130", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/bc3f8d1477c1031c58a0bbce3b3c6df1ce388130", "committedDate": "2021-01-05T10:25:36Z", "message": "[#2053] Adding capability to auto-provision devices to MongoDb-based device registry.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bc3f8d1477c1031c58a0bbce3b3c6df1ce388130", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/bc3f8d1477c1031c58a0bbce3b3c6df1ce388130", "committedDate": "2021-01-05T10:25:36Z", "message": "[#2053] Adding capability to auto-provision devices to MongoDb-based device registry.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}, "afterCommit": {"oid": "96eb8dc4410e48e0a3c84bd53477c0b05917f98e", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/96eb8dc4410e48e0a3c84bd53477c0b05917f98e", "committedDate": "2021-01-05T11:28:16Z", "message": "[#2053] Adding capability to auto-provision devices to MongoDb-based device registry.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxNzQ3MDU4", "url": "https://github.com/eclipse/hono/pull/2360#pullrequestreview-561747058", "createdAt": "2021-01-05T12:24:57Z", "commit": {"oid": "96eb8dc4410e48e0a3c84bd53477c0b05917f98e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxMjoyNDo1N1rOIOVTpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxMjoyNTo1OFrOIOVVeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTkwMDA2OQ==", "bodyText": "shouldn't this be either forCreate or forUpdate if the test is about verifying the document structure that is to be persisted as indicated in the JavaDoc?", "url": "https://github.com/eclipse/hono/pull/2360#discussion_r551900069", "createdAt": "2021-01-05T12:24:57Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-mongodb/src/test/java/org/eclipse/hono/deviceregistry/mongodb/model/MongoDbBasedDeviceDtoTest.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.hono.deviceregistry.mongodb.model;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.time.Instant;\n+import java.time.temporal.ChronoUnit;\n+\n+import org.eclipse.hono.deviceregistry.mongodb.utils.MongoDbDeviceRegistryUtils;\n+import org.eclipse.hono.service.management.BaseDto;\n+import org.eclipse.hono.service.management.device.Device;\n+import org.eclipse.hono.service.management.device.DeviceStatus;\n+import org.eclipse.hono.util.RegistryManagementConstants;\n+import org.junit.jupiter.api.Test;\n+\n+import io.vertx.core.json.JsonObject;\n+\n+\n+class MongoDbBasedDeviceDtoTest {\n+\n+    /**\n+     * Tests that the DTO is serialized to JSON as expected in order to verify that the document persisted is\n+     * written as expected.\n+     */\n+    @Test\n+    public void testEncode() {\n+        final String tenantId = \"barfoo\";\n+        final String deviceId = \"foobar\";\n+        final Device device = new Device();\n+        final DeviceStatus deviceStatus = new DeviceStatus()\n+                .setAutoProvisioned(true)\n+                .setAutoProvisioningNotificationSent(true)\n+                // make sure that these values do not interfere with the corresponding properties of DeviceDto's parent classes\n+                .setCreationTime(Instant.now().plusSeconds(3600))\n+                .setLastUpdate(Instant.now().plusSeconds(3600));\n+        final Instant created = Instant.now().minusSeconds(1).truncatedTo(ChronoUnit.SECONDS);\n+        final Instant updated = Instant.now().truncatedTo(ChronoUnit.SECONDS);;\n+        final String version = \"spam\";\n+\n+        final var deviceDto = MongoDbBasedDeviceDto.forRead(MongoDbBasedDeviceDto::new, tenantId, deviceId, device, deviceStatus,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96eb8dc4410e48e0a3c84bd53477c0b05917f98e"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTkwMDUzNw==", "bodyText": "DownstreamSenderFactory is deprecated. Can you please use the new client's ProtonBasedDownstreamSender instead?", "url": "https://github.com/eclipse/hono/pull/2360#discussion_r551900537", "createdAt": "2021-01-05T12:25:58Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/ApplicationConfig.java", "diffHunk": "@@ -286,19 +291,87 @@ public ObjectFactoryCreatingFactoryBean amqpServerFactory() {\n         return factory;\n     }\n \n+    /**\n+     * Exposes a factory for creating clients for the <em>AMQP Messaging Network</em> as a Spring bean.\n+     * <p>\n+     * The factory is initialized with the connection provided by {@link #downstreamConnection(Vertx)}.\n+     *\n+     * @param vertx The vert.x instance to run on.\n+     *\n+     * @return The factory.\n+     */\n+    @Bean\n+    @Scope(\"prototype\")\n+    public DownstreamSenderFactory downstreamSenderFactory(final Vertx vertx) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96eb8dc4410e48e0a3c84bd53477c0b05917f98e"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY0MzI1NzI2", "url": "https://github.com/eclipse/hono/pull/2360#pullrequestreview-564325726", "createdAt": "2021-01-08T15:01:01Z", "commit": {"oid": "96eb8dc4410e48e0a3c84bd53477c0b05917f98e"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wOFQxNTowMTowMVrOIQVGlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wOFQxNToxNjo1NVrOIQVs1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzk5Mzg3Nw==", "bodyText": "is this used anywhere in this test?", "url": "https://github.com/eclipse/hono/pull/2360#discussion_r553993877", "createdAt": "2021-01-08T15:01:01Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-mongodb/src/test/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDbBasedCredentialServiceTest.java", "diffHunk": "@@ -69,6 +74,9 @@ public void startService(final VertxTestContext testContext) {\n \n         vertx = Vertx.vertx();\n         mongoClient = MongoDbTestUtils.getMongoClient(vertx, \"hono-credentials-test\");\n+        final DownstreamSenderFactory downstreamSenderFactoryMock = mock(DownstreamSenderFactory.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96eb8dc4410e48e0a3c84bd53477c0b05917f98e"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzk5NDM3Mg==", "bodyText": "is this used anywhere?", "url": "https://github.com/eclipse/hono/pull/2360#discussion_r553994372", "createdAt": "2021-01-08T15:01:51Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-mongodb/src/test/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDBBasedDeviceManagementSearchDevicesTest.java", "diffHunk": "@@ -66,6 +71,8 @@ public void setup(final VertxTestContext testContext) {\n                 mongoClient,\n                 config,\n                 new NoopTenantInformationService());\n+        final DownstreamSenderFactory downstreamSenderFactoryMock = mock(DownstreamSenderFactory.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96eb8dc4410e48e0a3c84bd53477c0b05917f98e"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDAwMzY2OA==", "bodyText": "FMPOV it would be more helpful to have separate test methods which test the DTO in the way(s) that it is supposed to be used by client code ...", "url": "https://github.com/eclipse/hono/pull/2360#discussion_r554003668", "createdAt": "2021-01-08T15:16:55Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-mongodb/src/test/java/org/eclipse/hono/deviceregistry/mongodb/model/MongoDbBasedDeviceDtoTest.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.hono.deviceregistry.mongodb.model;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.time.Instant;\n+import java.time.temporal.ChronoUnit;\n+\n+import org.eclipse.hono.deviceregistry.mongodb.utils.MongoDbDeviceRegistryUtils;\n+import org.eclipse.hono.service.management.BaseDto;\n+import org.eclipse.hono.service.management.device.Device;\n+import org.eclipse.hono.service.management.device.DeviceStatus;\n+import org.eclipse.hono.util.RegistryManagementConstants;\n+import org.junit.jupiter.api.Test;\n+\n+import io.vertx.core.json.JsonObject;\n+\n+\n+class MongoDbBasedDeviceDtoTest {\n+\n+    /**\n+     * Tests that the DTO is serialized to JSON as expected in order to verify that the document persisted is\n+     * written as expected.\n+     */\n+    @Test\n+    public void testEncode() {\n+        final String tenantId = \"barfoo\";\n+        final String deviceId = \"foobar\";\n+        final Device device = new Device();\n+        final DeviceStatus deviceStatus = new DeviceStatus()\n+                .setAutoProvisioned(true)\n+                .setAutoProvisioningNotificationSent(true)\n+                // make sure that these values do not interfere with the corresponding properties of DeviceDto's parent classes\n+                .setCreationTime(Instant.now().plusSeconds(3600))\n+                .setLastUpdate(Instant.now().plusSeconds(3600));\n+        final Instant created = Instant.now().minusSeconds(1).truncatedTo(ChronoUnit.SECONDS);\n+        final Instant updated = Instant.now().truncatedTo(ChronoUnit.SECONDS);;\n+        final String version = \"spam\";\n+\n+        final var deviceDto = MongoDbBasedDeviceDto.forRead(MongoDbBasedDeviceDto::new, tenantId, deviceId, device, deviceStatus,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTkwMDA2OQ=="}, "originalCommit": {"oid": "96eb8dc4410e48e0a3c84bd53477c0b05917f98e"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25c79131972e77f935a57da526f55b74e284bcb7", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/25c79131972e77f935a57da526f55b74e284bcb7", "committedDate": "2021-01-11T07:29:13Z", "message": "[#2053] Adding capability to auto-provision devices to MongoDb-based device registry.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76a98d2429a26979d542aea6b747c68391c69336", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/76a98d2429a26979d542aea6b747c68391c69336", "committedDate": "2021-01-11T09:20:12Z", "message": "Review suggestions:\n- Using forCreation()/forUpdate() in MongoDbBasedDeviceDtoTest\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "96eb8dc4410e48e0a3c84bd53477c0b05917f98e", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/96eb8dc4410e48e0a3c84bd53477c0b05917f98e", "committedDate": "2021-01-05T11:28:16Z", "message": "[#2053] Adding capability to auto-provision devices to MongoDb-based device registry.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}, "afterCommit": {"oid": "76a98d2429a26979d542aea6b747c68391c69336", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/76a98d2429a26979d542aea6b747c68391c69336", "committedDate": "2021-01-11T09:20:12Z", "message": "Review suggestions:\n- Using forCreation()/forUpdate() in MongoDbBasedDeviceDtoTest\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY1MTgyODI1", "url": "https://github.com/eclipse/hono/pull/2360#pullrequestreview-565182825", "createdAt": "2021-01-11T09:31:05Z", "commit": {"oid": "76a98d2429a26979d542aea6b747c68391c69336"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQwOTozMTowNlrOIRNYvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQwOTozNTozOVrOIRNh8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDkxNjAyOQ==", "bodyText": "Sure, but why should downstreamSenderFactoryMock.connect() ever be invoked? I do not see any place where the created downstreamSenderFactoryMock is being used by or injected into any of the objects under test. Or am I mistaken?", "url": "https://github.com/eclipse/hono/pull/2360#discussion_r554916029", "createdAt": "2021-01-11T09:31:06Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-mongodb/src/test/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDbBasedCredentialServiceTest.java", "diffHunk": "@@ -69,6 +74,9 @@ public void startService(final VertxTestContext testContext) {\n \n         vertx = Vertx.vertx();\n         mongoClient = MongoDbTestUtils.getMongoClient(vertx, \"hono-credentials-test\");\n+        final DownstreamSenderFactory downstreamSenderFactoryMock = mock(DownstreamSenderFactory.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzk5Mzg3Nw=="}, "originalCommit": {"oid": "96eb8dc4410e48e0a3c84bd53477c0b05917f98e"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDkxNzU3NA==", "bodyText": "should this be related to the instant set in the DeviceStatus?", "url": "https://github.com/eclipse/hono/pull/2360#discussion_r554917574", "createdAt": "2021-01-11T09:34:07Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-mongodb/src/test/java/org/eclipse/hono/deviceregistry/mongodb/model/MongoDbBasedDeviceDtoTest.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.hono.deviceregistry.mongodb.model;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.time.Instant;\n+import java.time.temporal.ChronoUnit;\n+\n+import org.eclipse.hono.deviceregistry.mongodb.utils.MongoDbDeviceRegistryUtils;\n+import org.eclipse.hono.service.management.BaseDto;\n+import org.eclipse.hono.service.management.device.Device;\n+import org.eclipse.hono.service.management.device.DeviceStatus;\n+import org.eclipse.hono.util.RegistryManagementConstants;\n+import org.junit.jupiter.api.Test;\n+\n+import io.vertx.core.json.JsonObject;\n+\n+\n+class MongoDbBasedDeviceDtoTest {\n+\n+    /**\n+     * Tests that a DTO created for inserting a new entry is serialized to JSON as expected in order to verify that\n+     * the document to be persisted is written as expected.\n+     */\n+    @Test\n+    public void testEncodeForCreate() {\n+        final String tenantId = \"barfoo\";\n+        final String deviceId = \"foobar\";\n+        final DeviceStatus deviceStatus = new DeviceStatus()\n+                // make sure that these values do not interfere with the corresponding properties of DeviceDto's parent classes\n+                .setAutoProvisioned(true)\n+                .setCreationTime(Instant.now().plusSeconds(3600));\n+        final Device device = new Device();\n+        device.setStatus(deviceStatus);\n+        final String version = \"spam\";\n+\n+        final var deviceDto = MongoDbBasedDeviceDto.forCreation(MongoDbBasedDeviceDto::new, tenantId, deviceId, true, device, version);\n+        final var json = JsonObject.mapFrom(deviceDto);\n+\n+        assertThat(json).isNotNull();\n+        // size should match number of assertions below, to make sure no unexpected properties are serialized\n+        assertThat(json.getMap()).hasSize(7);\n+\n+        assertThat(json.getString(RegistryManagementConstants.FIELD_PAYLOAD_TENANT_ID)).isEqualTo(tenantId);\n+        assertThat(json.getString(RegistryManagementConstants.FIELD_PAYLOAD_DEVICE_ID)).isEqualTo(deviceId);\n+        assertThat(json.getInstant(RegistryManagementConstants.FIELD_STATUS_CREATION_DATE)).isNotNull();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76a98d2429a26979d542aea6b747c68391c69336"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDkxODM4NQ==", "bodyText": "what about the updated on field? Shouldn't that contain the same instant as the created on field in this case?", "url": "https://github.com/eclipse/hono/pull/2360#discussion_r554918385", "createdAt": "2021-01-11T09:35:39Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-mongodb/src/test/java/org/eclipse/hono/deviceregistry/mongodb/model/MongoDbBasedDeviceDtoTest.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.hono.deviceregistry.mongodb.model;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.time.Instant;\n+import java.time.temporal.ChronoUnit;\n+\n+import org.eclipse.hono.deviceregistry.mongodb.utils.MongoDbDeviceRegistryUtils;\n+import org.eclipse.hono.service.management.BaseDto;\n+import org.eclipse.hono.service.management.device.Device;\n+import org.eclipse.hono.service.management.device.DeviceStatus;\n+import org.eclipse.hono.util.RegistryManagementConstants;\n+import org.junit.jupiter.api.Test;\n+\n+import io.vertx.core.json.JsonObject;\n+\n+\n+class MongoDbBasedDeviceDtoTest {\n+\n+    /**\n+     * Tests that a DTO created for inserting a new entry is serialized to JSON as expected in order to verify that\n+     * the document to be persisted is written as expected.\n+     */\n+    @Test\n+    public void testEncodeForCreate() {\n+        final String tenantId = \"barfoo\";\n+        final String deviceId = \"foobar\";\n+        final DeviceStatus deviceStatus = new DeviceStatus()\n+                // make sure that these values do not interfere with the corresponding properties of DeviceDto's parent classes\n+                .setAutoProvisioned(true)\n+                .setCreationTime(Instant.now().plusSeconds(3600));\n+        final Device device = new Device();\n+        device.setStatus(deviceStatus);\n+        final String version = \"spam\";\n+\n+        final var deviceDto = MongoDbBasedDeviceDto.forCreation(MongoDbBasedDeviceDto::new, tenantId, deviceId, true, device, version);\n+        final var json = JsonObject.mapFrom(deviceDto);\n+\n+        assertThat(json).isNotNull();\n+        // size should match number of assertions below, to make sure no unexpected properties are serialized\n+        assertThat(json.getMap()).hasSize(7);\n+\n+        assertThat(json.getString(RegistryManagementConstants.FIELD_PAYLOAD_TENANT_ID)).isEqualTo(tenantId);\n+        assertThat(json.getString(RegistryManagementConstants.FIELD_PAYLOAD_DEVICE_ID)).isEqualTo(deviceId);\n+        assertThat(json.getInstant(RegistryManagementConstants.FIELD_STATUS_CREATION_DATE)).isNotNull();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDkxNzU3NA=="}, "originalCommit": {"oid": "76a98d2429a26979d542aea6b747c68391c69336"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b834d6255730949066d1b1525d2b1fa87b9107c8", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/b834d6255730949066d1b1525d2b1fa87b9107c8", "committedDate": "2021-01-11T10:18:38Z", "message": "Review suggestions:\n- Removing obsolete mocks\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY1NTAxNjk4", "url": "https://github.com/eclipse/hono/pull/2360#pullrequestreview-565501698", "createdAt": "2021-01-11T16:01:11Z", "commit": {"oid": "b834d6255730949066d1b1525d2b1fa87b9107c8"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxNjowMToxMVrOIRcFCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxNjowMToxNVrOIRcFLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTE1Njc0Nw==", "bodyText": "but this is supposed to be the same value as in the DeviceStatus, right? If so, we could also make it more explicit by comparing to DeviceStatus.isAutoProvisioned(). WDYT?", "url": "https://github.com/eclipse/hono/pull/2360#discussion_r555156747", "createdAt": "2021-01-11T16:01:11Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-mongodb/src/test/java/org/eclipse/hono/deviceregistry/mongodb/model/MongoDbBasedDeviceDtoTest.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.hono.deviceregistry.mongodb.model;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.time.Instant;\n+import java.time.temporal.ChronoUnit;\n+\n+import org.eclipse.hono.deviceregistry.mongodb.utils.MongoDbDeviceRegistryUtils;\n+import org.eclipse.hono.service.management.BaseDto;\n+import org.eclipse.hono.service.management.device.Device;\n+import org.eclipse.hono.service.management.device.DeviceStatus;\n+import org.eclipse.hono.util.RegistryManagementConstants;\n+import org.junit.jupiter.api.Test;\n+\n+import io.vertx.core.json.JsonObject;\n+\n+\n+class MongoDbBasedDeviceDtoTest {\n+\n+    /**\n+     * Tests that a DTO created for inserting a new entry is serialized to JSON as expected in order to verify that\n+     * the document to be persisted is written as expected.\n+     */\n+    @Test\n+    public void testEncodeForCreate() {\n+        final String tenantId = \"barfoo\";\n+        final String deviceId = \"foobar\";\n+        final DeviceStatus deviceStatus = new DeviceStatus()\n+                // make sure that these values do not interfere with the corresponding properties of DeviceDto's parent classes\n+                .setAutoProvisioned(true)\n+                .setCreationTime(Instant.now().plusSeconds(3600));\n+        final Device device = new Device();\n+        device.setStatus(deviceStatus);\n+        final String version = \"spam\";\n+\n+        final var deviceDto = MongoDbBasedDeviceDto.forCreation(MongoDbBasedDeviceDto::new, tenantId, deviceId, true, device, version);\n+        final var json = JsonObject.mapFrom(deviceDto);\n+\n+        assertThat(json).isNotNull();\n+        // size should match number of assertions below, to make sure no unexpected properties are serialized\n+        assertThat(json.getMap()).hasSize(7);\n+\n+        assertThat(json.getString(RegistryManagementConstants.FIELD_PAYLOAD_TENANT_ID)).isEqualTo(tenantId);\n+        assertThat(json.getString(RegistryManagementConstants.FIELD_PAYLOAD_DEVICE_ID)).isEqualTo(deviceId);\n+        assertThat(json.getInstant(RegistryManagementConstants.FIELD_STATUS_CREATION_DATE)).isNotNull();\n+        assertThat(json.getString(BaseDto.FIELD_VERSION)).isEqualTo(version);\n+        assertThat(json.getBoolean(RegistryManagementConstants.FIELD_AUTO_PROVISIONED)).isTrue();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b834d6255730949066d1b1525d2b1fa87b9107c8"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTE1Njc4MA==", "bodyText": "No, actually the device status should be ignored.\nI added a DeviceStatus object to the test since the properties of DeviceStatus partially have the same name as the properties in the DTO subclasses. Before adding the @JsonIgnore annotation to the deviceStatus property in DeviceDto they were accidentally serialised but the error was hard to spot since everything was still working but there was an additional, unwanted property being serialized.\n\nThat's a good idea \ud83d\udc4d  IMHO we should make it explicit then and add corresponding assertions as well.", "url": "https://github.com/eclipse/hono/pull/2360#discussion_r555156780", "createdAt": "2021-01-11T16:01:15Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-mongodb/src/test/java/org/eclipse/hono/deviceregistry/mongodb/model/MongoDbBasedDeviceDtoTest.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.hono.deviceregistry.mongodb.model;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.time.Instant;\n+import java.time.temporal.ChronoUnit;\n+\n+import org.eclipse.hono.deviceregistry.mongodb.utils.MongoDbDeviceRegistryUtils;\n+import org.eclipse.hono.service.management.BaseDto;\n+import org.eclipse.hono.service.management.device.Device;\n+import org.eclipse.hono.service.management.device.DeviceStatus;\n+import org.eclipse.hono.util.RegistryManagementConstants;\n+import org.junit.jupiter.api.Test;\n+\n+import io.vertx.core.json.JsonObject;\n+\n+\n+class MongoDbBasedDeviceDtoTest {\n+\n+    /**\n+     * Tests that a DTO created for inserting a new entry is serialized to JSON as expected in order to verify that\n+     * the document to be persisted is written as expected.\n+     */\n+    @Test\n+    public void testEncodeForCreate() {\n+        final String tenantId = \"barfoo\";\n+        final String deviceId = \"foobar\";\n+        final DeviceStatus deviceStatus = new DeviceStatus()\n+                // make sure that these values do not interfere with the corresponding properties of DeviceDto's parent classes\n+                .setAutoProvisioned(true)\n+                .setCreationTime(Instant.now().plusSeconds(3600));\n+        final Device device = new Device();\n+        device.setStatus(deviceStatus);\n+        final String version = \"spam\";\n+\n+        final var deviceDto = MongoDbBasedDeviceDto.forCreation(MongoDbBasedDeviceDto::new, tenantId, deviceId, true, device, version);\n+        final var json = JsonObject.mapFrom(deviceDto);\n+\n+        assertThat(json).isNotNull();\n+        // size should match number of assertions below, to make sure no unexpected properties are serialized\n+        assertThat(json.getMap()).hasSize(7);\n+\n+        assertThat(json.getString(RegistryManagementConstants.FIELD_PAYLOAD_TENANT_ID)).isEqualTo(tenantId);\n+        assertThat(json.getString(RegistryManagementConstants.FIELD_PAYLOAD_DEVICE_ID)).isEqualTo(deviceId);\n+        assertThat(json.getInstant(RegistryManagementConstants.FIELD_STATUS_CREATION_DATE)).isNotNull();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDkxNzU3NA=="}, "originalCommit": {"oid": "76a98d2429a26979d542aea6b747c68391c69336"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e2a3413b8025e9ecf041ee6edab7a4649c1bf28", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/1e2a3413b8025e9ecf041ee6edab7a4649c1bf28", "committedDate": "2021-01-11T16:44:54Z", "message": "Review suggestions:\n- Verifying autoProvisioning and autoProvisioningSent flags against DeviceStatus object in unit test\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0dd7e689c7c2d2647487a50d6ee30048b08e64e2", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/0dd7e689c7c2d2647487a50d6ee30048b08e64e2", "committedDate": "2021-01-12T08:08:46Z", "message": "Review suggestions:\n- Improving creationDate assertion\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "95c93352094fd22230fc46670f0f2ea5482d2c28", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/95c93352094fd22230fc46670f0f2ea5482d2c28", "committedDate": "2021-01-12T08:01:51Z", "message": "Review suggestions:\n- Improving creationDate assertion\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}, "afterCommit": {"oid": "0dd7e689c7c2d2647487a50d6ee30048b08e64e2", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/0dd7e689c7c2d2647487a50d6ee30048b08e64e2", "committedDate": "2021-01-12T08:08:46Z", "message": "Review suggestions:\n- Improving creationDate assertion\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY2MDQ3ODEx", "url": "https://github.com/eclipse/hono/pull/2360#pullrequestreview-566047811", "createdAt": "2021-01-12T08:47:57Z", "commit": {"oid": "0dd7e689c7c2d2647487a50d6ee30048b08e64e2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 482, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}