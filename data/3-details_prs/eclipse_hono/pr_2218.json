{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0MDA2NjY3", "number": 2218, "title": "Release and settle delivery when waiting for update timed out", "bodyText": "This should free up some resources.\nEDIT:\nWhen a telemetry message with Qos1 gets sent and the northbound consumer doesn't acknowledge the message by sending a delivery update, a timeout will occur in the protocol adapter after some time.\nThe problem here is, that the message is considered as \"in flight\" still, most notably from the point of view of the AMQP messaging network (e.g. the Qpid dispatch router). This message counts towards the link capacity configured in the router.\nThis all means that if one sends as many messages as configured as the router link capacity to the north bound application, and if the northbound application doesn't send a delivery update for any of these, then any further messages will result in a \"no credit\" error when the adapter tries to send them to the router.\nThis will be the case irrespective of the northbound application having sent new credits to the router.\nI think we should consider releasing/settling the message from the sender side (i.e. the protocol adapter) in this case, in order to free up resources in the router.", "createdAt": "2020-09-28T09:20:58Z", "url": "https://github.com/eclipse/hono/pull/2218", "merged": true, "mergeCommit": {"oid": "aa5b95645b09deebd88858fad50f7b2e124c9a3a"}, "closed": true, "closedAt": "2020-10-07T08:17:19Z", "author": {"login": "calohmn"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPeacUABqjM4Mzg4NzY4Mjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQIhftgFqTUwMzYzMDM4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "41214b87e496467f2165d30d9547581cfcb7e105", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/41214b87e496467f2165d30d9547581cfcb7e105", "committedDate": "2020-09-28T09:18:46Z", "message": "Settle delivery locally when waiting for update timed out.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}, "afterCommit": {"oid": "d82b78a2036dd365ae74ecf0cb2da24f4d6bf961", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/d82b78a2036dd365ae74ecf0cb2da24f4d6bf961", "committedDate": "2020-10-05T07:11:52Z", "message": "Release and settle delivery when waiting for update timed out.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNTUzNjM2", "url": "https://github.com/eclipse/hono/pull/2218#pullrequestreview-503553636", "createdAt": "2020-10-07T06:16:53Z", "commit": {"oid": "d82b78a2036dd365ae74ecf0cb2da24f4d6bf961"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNjoxNjo1M1rOHdkDAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNjoyNDo0MVrOHdkOjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc2MTM0Nw==", "bodyText": "how about adding a comment here explaining why we are doing this?", "url": "https://github.com/eclipse/hono/pull/2218#discussion_r500761347", "createdAt": "2020-10-07T06:16:53Z", "author": {"login": "sophokles73"}, "path": "client/src/main/java/org/eclipse/hono/client/impl/AbstractSender.java", "diffHunk": "@@ -282,13 +285,15 @@ protected final Span startSpan(final Message message) {\n                                         + connection.getConfig().getSendMessageTimeout() + \"ms\");\n                         logMessageSendingError(\"waiting for delivery update timed out for message [ID: {}, address: {}] after {}ms\",\n                                 messageId, getMessageAddress(message), connection.getConfig().getSendMessageTimeout());\n+                        Optional.ofNullable(deliveryRef.get())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d82b78a2036dd365ae74ecf0cb2da24f4d6bf961"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc2MTQwNg==", "bodyText": "comment?", "url": "https://github.com/eclipse/hono/pull/2218#discussion_r500761406", "createdAt": "2020-10-07T06:17:08Z", "author": {"login": "sophokles73"}, "path": "client/src/main/java/org/eclipse/hono/client/impl/DelegatedCommandSenderImpl.java", "diffHunk": "@@ -142,13 +146,15 @@ public String getEndpoint() {\n                                         + connection.getConfig().getSendMessageTimeout() + \"ms\");\n                         logMessageSendingError(\"waiting for delivery update timed out for message [ID: {}, address: {}] after {}ms\",\n                                 messageId, getMessageAddress(message), connection.getConfig().getSendMessageTimeout());\n+                        Optional.ofNullable(deliveryRef.get())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d82b78a2036dd365ae74ecf0cb2da24f4d6bf961"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc2MTY2NA==", "bodyText": "comment?", "url": "https://github.com/eclipse/hono/pull/2218#discussion_r500761664", "createdAt": "2020-10-07T06:17:54Z", "author": {"login": "sophokles73"}, "path": "client/src/main/java/org/eclipse/hono/client/impl/TelemetrySenderImpl.java", "diffHunk": "@@ -180,6 +184,8 @@ protected String getTo(final String deviceId) {\n                         logMessageSendingError(\n                                 \"waiting for delivery update timed out for message [ID: {}, address: {}] after {}ms\",\n                                 messageId, getMessageAddress(message), connection.getConfig().getSendMessageTimeout());\n+                        Optional.ofNullable(deliveryRef.get())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d82b78a2036dd365ae74ecf0cb2da24f4d6bf961"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc2NDMwMA==", "bodyText": "IMHO we should tie this check to after the HTTP client has gotten back its 501 response (and then wait some) in order to make it more robust against timing issues induced by scarce computing resources on the CI system ...", "url": "https://github.com/eclipse/hono/pull/2218#discussion_r500764300", "createdAt": "2020-10-07T06:24:41Z", "author": {"login": "sophokles73"}, "path": "tests/src/test/java/org/eclipse/hono/tests/http/TelemetryHttpIT.java", "diffHunk": "@@ -194,8 +199,22 @@ public void testUploadQos1MessageFailsIfDeliveryStateNotUpdated(final VertxTestC\n                         tenantId, \n                         (delivery, msg) -> {\n                             logger.debug(\"received {}\", msg);\n+                            ctx.verify(() -> {\n+                                assertThat(delivery.remotelySettled()).isFalse();\n+                                assertThat(delivery.getRemoteState()).isNull();\n+                            });\n                             messageReceived.flag();\n                             // don't update the delivery state here\n+                            // wait for the delivery to get remotely settled via the timeout handling in the adapter\n+                            vertx.setTimer(ClientConfigProperties.DEFAULT_SEND_MESSAGE_TIMEOUT + 50, tid -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d82b78a2036dd365ae74ecf0cb2da24f4d6bf961"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98352f47da27fcb3ee7b6e10bc9f0873cc2f41b3", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/98352f47da27fcb3ee7b6e10bc9f0873cc2f41b3", "committedDate": "2020-10-07T07:01:27Z", "message": "Release and settle delivery when waiting for update has timed out.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d82b78a2036dd365ae74ecf0cb2da24f4d6bf961", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/d82b78a2036dd365ae74ecf0cb2da24f4d6bf961", "committedDate": "2020-10-05T07:11:52Z", "message": "Release and settle delivery when waiting for update timed out.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}, "afterCommit": {"oid": "98352f47da27fcb3ee7b6e10bc9f0873cc2f41b3", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/98352f47da27fcb3ee7b6e10bc9f0873cc2f41b3", "committedDate": "2020-10-07T07:01:27Z", "message": "Release and settle delivery when waiting for update has timed out.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNjMwMzg4", "url": "https://github.com/eclipse/hono/pull/2218#pullrequestreview-503630388", "createdAt": "2020-10-07T08:15:51Z", "commit": {"oid": "98352f47da27fcb3ee7b6e10bc9f0873cc2f41b3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 593, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}