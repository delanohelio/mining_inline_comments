{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxNTQxODc2", "number": 2199, "title": "[#2115] Add PreCredentialsValidationHandler", "bodyText": "This is for #2115 and replaces the previous PR #2192.\nAdds an optional handler to the AuthHandler classes that is invoked before the actual (possibly expensive) credentials validation is performed. This handler can do checks using tenant information obtained from the authentication data.\nRecent changes to the DeviceCredentialsAuthProvider interface have been reverted (removing the ExecutionContext dependency) and a getCredentials(JsonObject) method has been added.\nIn comparison to the previous PR #2192, I have removed the code that has obtained the TenantObject before calling the PreCredentialsValidationHandler (it was put in the ExecutionContext then). This removes the need to pass on the TenantClientFactory in all AuthHandler constructors.", "createdAt": "2020-09-23T06:13:30Z", "url": "https://github.com/eclipse/hono/pull/2199", "merged": true, "mergeCommit": {"oid": "b12b871455fc36f95f6b80f24b9c716e306b34bb"}, "closed": true, "closedAt": "2020-09-23T12:44:55Z", "author": {"login": "calohmn"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLmTZhgH2gAyNDkxNTQxODc2OjU0NjMxOTM4ZjA4YmE4ZjU2ODZlNGJkMDE4ZTU0NDg1YTJlOTRiOTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLr179AFqTQ5NDYxMDUxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "54631938f08ba8f5686e4bd018e54485a2e94b97", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/54631938f08ba8f5686e4bd018e54485a2e94b97", "committedDate": "2020-09-23T06:07:59Z", "message": "[#2115] Add PreCredentialsValidationHandler.\n\nAdds an optional handler to the AuthHandler classes that is invoked\nbefore the actual (possibly expensive) credentials validation is\nperformed. This handler can do checks using tenant information obtained\nfrom the authentication data.\nRecent changes to the DeviceCredentialsAuthProvider interface have\nbeen reverted (removing the ExecutionContext dependency) and a\ngetCredentials(JsonObject) method has been added.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0NTU0OTM1", "url": "https://github.com/eclipse/hono/pull/2199#pullrequestreview-494554935", "createdAt": "2020-09-23T11:22:10Z", "commit": {"oid": "54631938f08ba8f5686e4bd018e54485a2e94b97"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxMToyMjoxMFrOHWnF_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxMToyMjoxMFrOHWnF_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQ3MTIyOA==", "bodyText": "authenticate(credentials, TracingHelper.extractSpanContext(tracer, authInfo), resultHandler) ?", "url": "https://github.com/eclipse/hono/pull/2199#discussion_r493471228", "createdAt": "2020-09-23T11:22:10Z", "author": {"login": "sophokles73"}, "path": "service-base/src/main/java/org/eclipse/hono/service/auth/device/CredentialsApiAuthProvider.java", "diffHunk": "@@ -206,47 +203,19 @@ public final void authenticate(\n \n     @Override\n     public final void authenticate(final JsonObject authInfo, final Handler<AsyncResult<User>> resultHandler) {\n-        final ExecutionContext executionContext = new GenericExecutionContext(\n-                TracingHelper.extractSpanContext(tracer, authInfo));\n-        authenticate(authInfo, executionContext, s -> {\n-            if (s.succeeded()) {\n-                resultHandler.handle(Future.succeededFuture(s.result()));\n-            } else {\n-                resultHandler.handle(Future.failedFuture(s.cause()));\n-            }\n-        });\n-    }\n-\n-    @Override\n-    public final void authenticate(\n-            final JsonObject authInfo,\n-            final ExecutionContext executionContext,\n-            final Handler<AsyncResult<DeviceUser>> resultHandler) {\n \n-        Objects.requireNonNull(authInfo);\n-        Objects.requireNonNull(executionContext);\n-        Objects.requireNonNull(resultHandler);\n-\n-        final T credentials = getCredentials(authInfo);\n+        final T credentials = getCredentials(Objects.requireNonNull(authInfo));\n         if (credentials == null) {\n             resultHandler.handle(Future.failedFuture(new ClientErrorException(HttpURLConnection.HTTP_UNAUTHORIZED, \"malformed credentials\")));\n         } else {\n-            authenticate(credentials, executionContext, resultHandler);\n+            authenticate(credentials, TracingHelper.extractSpanContext(tracer, authInfo), s -> {\n+                if (s.succeeded()) {\n+                    resultHandler.handle(Future.succeededFuture(s.result()));\n+                } else {\n+                    resultHandler.handle(Future.failedFuture(s.cause()));\n+                }\n+            });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54631938f08ba8f5686e4bd018e54485a2e94b97"}, "originalPosition": 70}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0NjEwNTE1", "url": "https://github.com/eclipse/hono/pull/2199#pullrequestreview-494610515", "createdAt": "2020-09-23T12:35:14Z", "commit": {"oid": "54631938f08ba8f5686e4bd018e54485a2e94b97"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 584, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}