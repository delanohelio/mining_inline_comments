{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5Mjg3MTY1", "number": 2116, "title": "[#2112] Add search devices operation in MongoDB based device registry", "bodyText": "With this PR, the MongoDB based device registry supports search devices operation as specified in the OpenAPI spec by #1958. The tests are in progress.", "createdAt": "2020-08-18T08:16:35Z", "url": "https://github.com/eclipse/hono/pull/2116", "merged": true, "mergeCommit": {"oid": "8a0863a4e7df61762904318ab84a5c8ef4bfa124"}, "closed": true, "closedAt": "2020-08-19T06:51:56Z", "author": {"login": "kaniyan"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAHBpPAFqTQ2OTQ1MzkxNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAV8sSAFqTQ3MDE3MDA3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NDUzOTE2", "url": "https://github.com/eclipse/hono/pull/2116#pullrequestreview-469453916", "createdAt": "2020-08-18T13:27:44Z", "commit": {"oid": "2281374b607b484b401d70245eb752d0cbebb6e1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxMzoyNzo0NFrOHCUi1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxMzoyNzo0NFrOHCUi1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE5NTc5OQ==", "bodyText": "I have changed the searchDevices method signature to no longer use Optional around the filters and sort options. Can you please adapt your code accordingly?", "url": "https://github.com/eclipse/hono/pull/2116#discussion_r472195799", "createdAt": "2020-08-18T13:27:44Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDbBasedDeviceBackend.java", "diffHunk": "@@ -77,6 +80,16 @@ public MongoDbBasedDeviceBackend(\n         return registrationService.readDevice(tenantId, deviceId, span);\n     }\n \n+    @Override\n+    public Future<OperationResult<List<DeviceWithId>>> searchDevices(final String tenantId,\n+            final int pageSize,\n+            final int pageOffset,\n+            final Optional<List<Filter>> filters,\n+            final Optional<List<Sort>> sortOptions,\n+            final Span span) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2281374b607b484b401d70245eb752d0cbebb6e1"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6de3ede629c0300792e4da27c880777f34ee13f4", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/6de3ede629c0300792e4da27c880777f34ee13f4", "committedDate": "2020-08-18T14:00:23Z", "message": "[#2112] Add search devices operation in MongoDB based device registry\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2281374b607b484b401d70245eb752d0cbebb6e1", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/2281374b607b484b401d70245eb752d0cbebb6e1", "committedDate": "2020-08-18T08:03:48Z", "message": "[#2112] Add search devices operation in MongoDB based device registry\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}, "afterCommit": {"oid": "6de3ede629c0300792e4da27c880777f34ee13f4", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/6de3ede629c0300792e4da27c880777f34ee13f4", "committedDate": "2020-08-18T14:00:23Z", "message": "[#2112] Add search devices operation in MongoDB based device registry\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NDkxNjk1", "url": "https://github.com/eclipse/hono/pull/2116#pullrequestreview-469491695", "createdAt": "2020-08-18T14:07:38Z", "commit": {"oid": "6de3ede629c0300792e4da27c880777f34ee13f4"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNDowNzozOFrOHCWTtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNDoxMToxMFrOHCWddQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyNDY5NQ==", "bodyText": "this should be put into a\nif (LOG.isTraceEnabled()) {\n}\n\nblock in order to prevent serialization of query and sort documents if not required", "url": "https://github.com/eclipse/hono/pull/2116#discussion_r472224695", "createdAt": "2020-08-18T14:07:38Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDbBasedRegistrationService.java", "diffHunk": "@@ -333,6 +354,53 @@ private RegistrationResult getRegistrationResult(final String deviceId, final Js\n                 });\n     }\n \n+    private Future<OperationResult<List<DeviceWithId>>> processSearchDevices(\n+            final String tenantId,\n+            final int pageSize,\n+            final int pageOffset,\n+            final List<Filter> filters,\n+            final List<Sort> sortOptions) {\n+\n+        final FindOptions searchDevicesOptions = new FindOptions()\n+                .setLimit(pageSize)\n+                .setSkip(pageOffset);\n+        final JsonObject searchDevicesQuery = MongoDbDocumentBuilder.builder()\n+                .withTenantId(tenantId)\n+                .withDeviceFilters(filters)\n+                .document();\n+        final JsonObject sortDocument = MongoDbDocumentBuilder.builder()\n+                .withDeviceSortOptions(sortOptions)\n+                .document();\n+        final Promise<List<JsonObject>> searchDevicesPromise = Promise.promise();\n+\n+        searchDevicesOptions.setSort(sortDocument);\n+        LOG.trace(\"pageSize: [{}], pageOffset: [{}], searchDevicesQuery: [{}], sortOptions: [{}]\", pageSize, pageOffset,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6de3ede629c0300792e4da27c880777f34ee13f4"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyNDk0NA==", "bodyText": "is there any value in creating this private method with exactly the same signature as searchDevices instead of simply implementing searchDevices directly?", "url": "https://github.com/eclipse/hono/pull/2116#discussion_r472224944", "createdAt": "2020-08-18T14:08:00Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDbBasedRegistrationService.java", "diffHunk": "@@ -333,6 +354,53 @@ private RegistrationResult getRegistrationResult(final String deviceId, final Js\n                 });\n     }\n \n+    private Future<OperationResult<List<DeviceWithId>>> processSearchDevices(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6de3ede629c0300792e4da27c880777f34ee13f4"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyNjU0OA==", "bodyText": "does this also cover indexes into arrays, i.e. something like /myJsonArray/1 to address the second element of a JSON array?", "url": "https://github.com/eclipse/hono/pull/2116#discussion_r472226548", "createdAt": "2020-08-18T14:10:18Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/utils/MongoDbDocumentBuilder.java", "diffHunk": "@@ -126,4 +131,54 @@ public MongoDbDocumentBuilder withAuthId(final String authId) {\n         document.put(FIELD_CREDENTIALS_AUTH_ID_KEY, authId);\n         return this;\n     }\n+\n+\n+    /**\n+     * Sets the json object with the given device filters.\n+     *\n+     * @param filters The device filters list.\n+     * @return a reference to this for fluent use.\n+     */\n+    public MongoDbDocumentBuilder withDeviceFilters(final List<Filter> filters) {\n+\n+        filters.forEach(filter -> {\n+            // TODO: To implement when filter values contain patterns such as * or %\n+            if (FIELD_ID.equals(filter.getField())) {\n+                document.put(RegistryManagementConstants.FIELD_PAYLOAD_DEVICE_ID, filter.getValue());\n+            } else {\n+                document.put(MongoDbDeviceRegistryUtils.FIELD_DEVICE + filter.getField().toString().replace(\"/\", \".\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6de3ede629c0300792e4da27c880777f34ee13f4"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyNzE4OQ==", "bodyText": "static?", "url": "https://github.com/eclipse/hono/pull/2116#discussion_r472227189", "createdAt": "2020-08-18T14:11:10Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/utils/MongoDbDocumentBuilder.java", "diffHunk": "@@ -126,4 +131,54 @@ public MongoDbDocumentBuilder withAuthId(final String authId) {\n         document.put(FIELD_CREDENTIALS_AUTH_ID_KEY, authId);\n         return this;\n     }\n+\n+\n+    /**\n+     * Sets the json object with the given device filters.\n+     *\n+     * @param filters The device filters list.\n+     * @return a reference to this for fluent use.\n+     */\n+    public MongoDbDocumentBuilder withDeviceFilters(final List<Filter> filters) {\n+\n+        filters.forEach(filter -> {\n+            // TODO: To implement when filter values contain patterns such as * or %\n+            if (FIELD_ID.equals(filter.getField())) {\n+                document.put(RegistryManagementConstants.FIELD_PAYLOAD_DEVICE_ID, filter.getValue());\n+            } else {\n+                document.put(MongoDbDeviceRegistryUtils.FIELD_DEVICE + filter.getField().toString().replace(\"/\", \".\"),\n+                        filter.getValue());\n+            }\n+        });\n+\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the json object with the given sorting options.\n+     *\n+     * @param sortOptions The list of soring options.\n+     * @return a reference to this for fluent use.\n+     */\n+    public MongoDbDocumentBuilder withDeviceSortOptions(final List<Sort> sortOptions) {\n+\n+        sortOptions.forEach(sortOption -> {\n+            if (FIELD_ID.equals(sortOption.getField())) {\n+                document.put(RegistryManagementConstants.FIELD_PAYLOAD_DEVICE_ID,\n+                        mapSortingDirection(sortOption.getDirection()));\n+            } else {\n+                document.put(MongoDbDeviceRegistryUtils.FIELD_DEVICE + \".\" + sortOption.getField(),\n+                        mapSortingDirection(sortOption.getDirection()));\n+            }\n+        });\n+        return this;\n+    }\n+\n+    private int mapSortingDirection(final Sort.Direction direction) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6de3ede629c0300792e4da27c880777f34ee13f4"}, "originalPosition": 73}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7470b2f859e3890726605bdab6cf551f5de35bde", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/7470b2f859e3890726605bdab6cf551f5de35bde", "committedDate": "2020-08-18T14:37:10Z", "message": "Changes related to review comments\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMTcwMDc3", "url": "https://github.com/eclipse/hono/pull/2116#pullrequestreview-470170077", "createdAt": "2020-08-19T06:51:32Z", "commit": {"oid": "7470b2f859e3890726605bdab6cf551f5de35bde"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 509, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}