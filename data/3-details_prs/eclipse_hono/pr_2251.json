{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzMTU3NzAw", "number": 2251, "title": "[#2244] Skip sendDisconnectedTtdEvent if consumer not mapped", "bodyText": "No 'disconnectedTtdEvent' is now sent anymore when a command consumer is obviously not registered anymore\nbecause its associated command handling adapter instance entry has already been removed or overwritten.\nThis resolves both cases described in #2244.", "createdAt": "2020-10-14T06:57:41Z", "url": "https://github.com/eclipse/hono/pull/2251", "merged": true, "mergeCommit": {"oid": "e4e6e2464b51fe6f5c34b6a2db2826600b749ca4"}, "closed": true, "closedAt": "2020-10-19T09:10:45Z", "author": {"login": "calohmn"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdScn62gBqjM4NzY0MDMwNTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdT_4jNgBqjM4OTIwNDM4OTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a42403756f244a48ea528eb26c63feef3cc9dc62", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/a42403756f244a48ea528eb26c63feef3cc9dc62", "committedDate": "2020-10-14T06:48:23Z", "message": "[#2244] Suppress event if command consumer not registered.\n\nNo 'disconnectedTtdEvent' is now sent anymore when a\ncommand consumer is obviously not registered anymore\nbecause its associated command handling adapter instance\nentry has already been removed or overwritten.\nThis resolves case A described in #2244.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}, "afterCommit": {"oid": "09d49c9ec750d62e8cfc51f2bb224fb4f27da371", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/09d49c9ec750d62e8cfc51f2bb224fb4f27da371", "committedDate": "2020-10-14T12:48:30Z", "message": "[#2244] Skip sendDisconnectedTtdEvent if consumer not mapped.\n\nNo 'disconnectedTtdEvent' is now sent anymore after closing\nthe command consumer when it has become obvious that the\nconsumer had already been removed/overwritten before.\nThis resolves case A described in #2244.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4MzY2MDY1", "url": "https://github.com/eclipse/hono/pull/2251#pullrequestreview-508366065", "createdAt": "2020-10-14T13:48:17Z", "commit": {"oid": "09d49c9ec750d62e8cfc51f2bb224fb4f27da371"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxMzo0ODoxOFrOHhT-xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxNDowODozNlrOHhU79Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY5MjQyMw==", "bodyText": "shouldn't this compare to 412 instead of 404?", "url": "https://github.com/eclipse/hono/pull/2251#discussion_r504692423", "createdAt": "2020-10-14T13:48:18Z", "author": {"login": "sophokles73"}, "path": "adapters/amqp-vertx/src/main/java/org/eclipse/hono/adapter/amqp/impl/VertxBasedAmqpProtocolAdapter.java", "diffHunk": "@@ -823,6 +819,26 @@ private Span newSpan(final String operationName, final Device authenticatedDevic\n                 new ServerErrorException(HttpURLConnection.HTTP_UNAVAILABLE, \"cannot create command consumer\")));\n     }\n \n+    private Future<Void> closeCommandConsumer(\n+            final ProtocolAdapterCommandConsumer consumer,\n+            final String tenantId,\n+            final String deviceId,\n+            final Device authenticatedDevice,\n+            final Span span) {\n+\n+        return consumer.close(span.context())\n+                .recover(thr -> {\n+                    // ignore all but not-found errors\n+                    if (ServiceInvocationException.extractStatusCode(thr) == HttpURLConnection.HTTP_NOT_FOUND) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09d49c9ec750d62e8cfc51f2bb224fb4f27da371"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY5MjkyMQ==", "bodyText": "412?", "url": "https://github.com/eclipse/hono/pull/2251#discussion_r504692921", "createdAt": "2020-10-14T13:48:57Z", "author": {"login": "sophokles73"}, "path": "adapters/mqtt-vertx-base/src/main/java/org/eclipse/hono/adapter/mqtt/AbstractVertxBasedMqttProtocolAdapter.java", "diffHunk": "@@ -760,6 +761,28 @@ protected final void onUnsubscribe(\n         CompositeFuture.join(removalDoneFutures).onComplete(r -> span.finish());\n     }\n \n+    private Function<Pair<CommandSubscription, ProtocolAdapterCommandConsumer>, Future<Void>> getOnSubscriptionRemovedFunction(\n+            final Device authenticatedDevice,\n+            final MqttEndpoint endpoint,\n+            final Span span) {\n+\n+        return subscriptionConsumerPair -> {\n+            final CommandSubscription subscription = subscriptionConsumerPair.one();\n+            final ProtocolAdapterCommandConsumer commandConsumer = subscriptionConsumerPair.two();\n+            return commandConsumer.close(span.context())\n+                    .recover(thr -> {\n+                        // ignore all but not-found errors\n+                        if (ServiceInvocationException.extractStatusCode(thr) == HttpURLConnection.HTTP_NOT_FOUND) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09d49c9ec750d62e8cfc51f2bb224fb4f27da371"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcwODA4NQ==", "bodyText": "I find it extremely confusing that DeviceConnectionClientImpl.removeCommandHandlingAdapterInstance method does not comply with the Device Connection API in that the returned future actually succeeds for status codes 404 and 412 but fails for e.g. a status code 404 being returned from the service.\nI am even more confused seeing that a few lines below we actually map the successful result to a 404?", "url": "https://github.com/eclipse/hono/pull/2251#discussion_r504708085", "createdAt": "2020-10-14T14:08:36Z", "author": {"login": "sophokles73"}, "path": "client/src/main/java/org/eclipse/hono/client/impl/ProtocolAdapterCommandConsumerFactoryImpl.java", "diffHunk": "@@ -196,19 +198,29 @@ protected void onDisconnect() {\n     }\n \n     private Future<Void> removeCommandConsumer(final String tenantId, final String deviceId,\n-            final SpanContext onCloseSpanContext) {\n+            final SpanContext onCloseSpanContext, final boolean isUnlimitedLifespanConsumer) {\n         log.trace(\"remove command consumer [tenant-id: {}, device-id: {}]\", tenantId, deviceId);\n         adapterInstanceCommandHandler.removeDeviceSpecificCommandHandler(tenantId, deviceId);\n \n         return deviceConnectionClientFactory.getOrCreateDeviceConnectionClient(tenantId)\n                 .compose(client -> client.removeCommandHandlingAdapterInstance(deviceId, adapterInstanceId,\n                         onCloseSpanContext))\n+                .compose(removed -> {\n+                    if (!removed && isUnlimitedLifespanConsumer) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09d49c9ec750d62e8cfc51f2bb224fb4f27da371"}, "originalPosition": 33}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "09d49c9ec750d62e8cfc51f2bb224fb4f27da371", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/09d49c9ec750d62e8cfc51f2bb224fb4f27da371", "committedDate": "2020-10-14T12:48:30Z", "message": "[#2244] Skip sendDisconnectedTtdEvent if consumer not mapped.\n\nNo 'disconnectedTtdEvent' is now sent anymore after closing\nthe command consumer when it has become obvious that the\nconsumer had already been removed/overwritten before.\nThis resolves case A described in #2244.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}, "afterCommit": {"oid": "ce0a4cb9cdfe6770dbc9c16e198a4b5caff79f7e", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/ce0a4cb9cdfe6770dbc9c16e198a4b5caff79f7e", "committedDate": "2020-10-14T15:20:53Z", "message": "[#2244] Skip sendDisconnectedTtdEvent if consumer not mapped.\n\nNo 'disconnectedTtdEvent' is now sent anymore after closing\nthe command consumer when it has become obvious that the\nconsumer had already been removed/overwritten before.\nThis resolves case A described in #2244.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ce0a4cb9cdfe6770dbc9c16e198a4b5caff79f7e", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/ce0a4cb9cdfe6770dbc9c16e198a4b5caff79f7e", "committedDate": "2020-10-14T15:20:53Z", "message": "[#2244] Skip sendDisconnectedTtdEvent if consumer not mapped.\n\nNo 'disconnectedTtdEvent' is now sent anymore after closing\nthe command consumer when it has become obvious that the\nconsumer had already been removed/overwritten before.\nThis resolves case A described in #2244.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}, "afterCommit": {"oid": "e062b7d62e1f51a03fb1c1cc933c4b991f63ce7a", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/e062b7d62e1f51a03fb1c1cc933c4b991f63ce7a", "committedDate": "2020-10-14T16:02:42Z", "message": "[#2244] Skip sendDisconnectedTtdEvent if consumer not mapped.\n\nNo 'disconnectedTtdEvent' is now sent anymore after closing\nthe command consumer when it has become obvious that the\nconsumer had already been removed/overwritten before.\nThis resolves case A described in #2244.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e062b7d62e1f51a03fb1c1cc933c4b991f63ce7a", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/e062b7d62e1f51a03fb1c1cc933c4b991f63ce7a", "committedDate": "2020-10-14T16:02:42Z", "message": "[#2244] Skip sendDisconnectedTtdEvent if consumer not mapped.\n\nNo 'disconnectedTtdEvent' is now sent anymore after closing\nthe command consumer when it has become obvious that the\nconsumer had already been removed/overwritten before.\nThis resolves case A described in #2244.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}, "afterCommit": {"oid": "335dbce12245f4c237b14ee533c0442b7d3b4121", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/335dbce12245f4c237b14ee533c0442b7d3b4121", "committedDate": "2020-10-14T16:04:04Z", "message": "[#2244] Skip sendDisconnectedTtdEvent if consumer not mapped.\n\nNo 'disconnectedTtdEvent' is now sent anymore after closing\nthe command consumer when it has become obvious that the\nconsumer had already been removed/overwritten before.\nThis resolves case A described in #2244.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "335dbce12245f4c237b14ee533c0442b7d3b4121", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/335dbce12245f4c237b14ee533c0442b7d3b4121", "committedDate": "2020-10-14T16:04:04Z", "message": "[#2244] Skip sendDisconnectedTtdEvent if consumer not mapped.\n\nNo 'disconnectedTtdEvent' is now sent anymore after closing\nthe command consumer when it has become obvious that the\nconsumer had already been removed/overwritten before.\nThis resolves case A described in #2244.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}, "afterCommit": {"oid": "8b36de7da91f356fab3bd6697a38c3161e5a5743", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/8b36de7da91f356fab3bd6697a38c3161e5a5743", "committedDate": "2020-10-15T09:42:55Z", "message": "[#2244] Skip sendDisconnectedTtdEvent if consumer not mapped.\n\nNo 'disconnectedTtdEvent' is now sent anymore after closing\nthe command consumer when it has become obvious that the\nconsumer had already been removed/overwritten before.\nThis resolves case A described in #2244.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8b36de7da91f356fab3bd6697a38c3161e5a5743", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/8b36de7da91f356fab3bd6697a38c3161e5a5743", "committedDate": "2020-10-15T09:42:55Z", "message": "[#2244] Skip sendDisconnectedTtdEvent if consumer not mapped.\n\nNo 'disconnectedTtdEvent' is now sent anymore after closing\nthe command consumer when it has become obvious that the\nconsumer had already been removed/overwritten before.\nThis resolves case A described in #2244.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}, "afterCommit": {"oid": "791e854f789b1b488394b8e4751640c8d2740c5a", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/791e854f789b1b488394b8e4751640c8d2740c5a", "committedDate": "2020-10-15T14:17:27Z", "message": "[#2244] Skip sendDisconnectedTtdEvent if consumer not mapped.\n\nNo 'disconnectedTtdEvent' is now sent anymore after closing\nthe command consumer when it has become obvious that the\nconsumer had already been removed/overwritten before.\nThis resolves case A described in #2244.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "791e854f789b1b488394b8e4751640c8d2740c5a", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/791e854f789b1b488394b8e4751640c8d2740c5a", "committedDate": "2020-10-15T14:17:27Z", "message": "[#2244] Skip sendDisconnectedTtdEvent if consumer not mapped.\n\nNo 'disconnectedTtdEvent' is now sent anymore after closing\nthe command consumer when it has become obvious that the\nconsumer had already been removed/overwritten before.\nThis resolves case A described in #2244.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}, "afterCommit": {"oid": "2a575d18a58b5d99738e59332722c81d6b1dcbd7", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/2a575d18a58b5d99738e59332722c81d6b1dcbd7", "committedDate": "2020-10-15T14:32:28Z", "message": "[#2244] Skip sendDisconnectedTtdEvent if consumer not mapped.\n\nNo 'disconnectedTtdEvent' is now sent anymore after closing\nthe command consumer when it has become obvious that the\nconsumer had already been removed/overwritten before.\nThis resolves case A described in #2244.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2a575d18a58b5d99738e59332722c81d6b1dcbd7", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/2a575d18a58b5d99738e59332722c81d6b1dcbd7", "committedDate": "2020-10-15T14:32:28Z", "message": "[#2244] Skip sendDisconnectedTtdEvent if consumer not mapped.\n\nNo 'disconnectedTtdEvent' is now sent anymore after closing\nthe command consumer when it has become obvious that the\nconsumer had already been removed/overwritten before.\nThis resolves case A described in #2244.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}, "afterCommit": {"oid": "ab16cdd3878c0cbf32302d034bf074dfffc71b5f", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/ab16cdd3878c0cbf32302d034bf074dfffc71b5f", "committedDate": "2020-10-16T05:47:46Z", "message": "[#2244] Skip sendDisconnectedTtdEvent if consumer not mapped.\n\nNo 'disconnectedTtdEvent' is now sent anymore after closing\nthe command consumer when it has become obvious that the\nconsumer had already been removed/overwritten before.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab16cdd3878c0cbf32302d034bf074dfffc71b5f", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/ab16cdd3878c0cbf32302d034bf074dfffc71b5f", "committedDate": "2020-10-16T05:47:46Z", "message": "[#2244] Skip sendDisconnectedTtdEvent if consumer not mapped.\n\nNo 'disconnectedTtdEvent' is now sent anymore after closing\nthe command consumer when it has become obvious that the\nconsumer had already been removed/overwritten before.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}, "afterCommit": {"oid": "73d4d410e64028e908d8c4476e61f43c0c89115a", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/73d4d410e64028e908d8c4476e61f43c0c89115a", "committedDate": "2020-10-16T09:43:31Z", "message": "[#2244] Skip sendDisconnectedTtdEvent if consumer not mapped.\n\nNo 'disconnectedTtdEvent' is now sent anymore after closing\nthe command consumer when it has become obvious that the\nconsumer had already been removed/overwritten before.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNDIyNTk0", "url": "https://github.com/eclipse/hono/pull/2251#pullrequestreview-510422594", "createdAt": "2020-10-16T12:29:50Z", "commit": {"oid": "73d4d410e64028e908d8c4476e61f43c0c89115a"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMjoyOTo1MFrOHi6CIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMzoyMTo1N1rOHi876g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM2NDQ0OQ==", "bodyText": "... to a succeeded future with value false ...", "url": "https://github.com/eclipse/hono/pull/2251#discussion_r506364449", "createdAt": "2020-10-16T12:29:50Z", "author": {"login": "sophokles73"}, "path": "client/src/main/java/org/eclipse/hono/client/DeviceConnectionClient.java", "diffHunk": "@@ -98,6 +98,10 @@\n      * @return A future indicating the outcome of the operation, with its value indicating whether the protocol\n      *         adapter instance value was removed or not.\n      *         <p>\n+     *         NOTE: this method maps an outcome with status 404 or 412 as defined in the\n+     *         <a href=\"https://www.eclipse.org/hono/docs/api/device-connection/\">Device Connection API\n+     *         specification</a> to a future result value of {@code false} here.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73d4d410e64028e908d8c4476e61f43c0c89115a"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQwOTI0NQ==", "bodyText": "this is the check for scenario B, right (device has re-connected to same verticle instance)? IMHO it would be very helpful to describe this scenario in a comment here", "url": "https://github.com/eclipse/hono/pull/2251#discussion_r506409245", "createdAt": "2020-10-16T13:19:51Z", "author": {"login": "sophokles73"}, "path": "client/src/main/java/org/eclipse/hono/client/impl/ProtocolAdapterCommandConsumerFactoryImpl.java", "diffHunk": "@@ -195,11 +202,19 @@ protected void onDisconnect() {\n                 });\n     }\n \n-    private Future<Void> removeCommandConsumer(final String tenantId, final String deviceId,\n-            final SpanContext onCloseSpanContext) {\n-        log.trace(\"remove command consumer [tenant-id: {}, device-id: {}]\", tenantId, deviceId);\n-        adapterInstanceCommandHandler.removeDeviceSpecificCommandHandler(tenantId, deviceId);\n+    private Future<Void> removeCommandConsumer(final CommandHandlerWrapper commandHandlerWrapper, final Duration lifespan,\n+            final Instant lifespanStart, final SpanContext onCloseSpanContext) {\n+\n+        final String tenantId = commandHandlerWrapper.getTenantId();\n+        final String deviceId = commandHandlerWrapper.getDeviceId();\n \n+        log.trace(\"remove command consumer [tenant-id: {}, device-id: {}]\", tenantId, deviceId);\n+        if (!adapterInstanceCommandHandler.removeDeviceSpecificCommandHandler(commandHandlerWrapper)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73d4d410e64028e908d8c4476e61f43c0c89115a"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQxMjAxMA==", "bodyText": "this covers adapters which use stateful protocols like AMQP and MQTT where the TTD is -1, right?\nagain, IMHO it would be helpful to describe the circumstances under which this happens here in the comment in some more detail", "url": "https://github.com/eclipse/hono/pull/2251#discussion_r506412010", "createdAt": "2020-10-16T13:21:57Z", "author": {"login": "sophokles73"}, "path": "client/src/main/java/org/eclipse/hono/client/impl/ProtocolAdapterCommandConsumerFactoryImpl.java", "diffHunk": "@@ -208,7 +223,18 @@ protected void onDisconnect() {\n                             deviceId, thr);\n                     return Future.failedFuture(thr);\n                 })\n-                .mapEmpty();\n+                .compose(removed -> {\n+                    final boolean entryNotExpired = lifespan.isNegative() || Instant.now().isBefore(lifespanStart.plus(lifespan));\n+                    if (!removed && entryNotExpired) {\n+                        // entry wasn't actually removed and entry hasn't expired (yet)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73d4d410e64028e908d8c4476e61f43c0c89115a"}, "originalPosition": 79}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "73d4d410e64028e908d8c4476e61f43c0c89115a", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/73d4d410e64028e908d8c4476e61f43c0c89115a", "committedDate": "2020-10-16T09:43:31Z", "message": "[#2244] Skip sendDisconnectedTtdEvent if consumer not mapped.\n\nNo 'disconnectedTtdEvent' is now sent anymore after closing\nthe command consumer when it has become obvious that the\nconsumer had already been removed/overwritten before.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}, "afterCommit": {"oid": "4c1332541d56bc1c39ddc08bcbf41e1f849d8fb8", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/4c1332541d56bc1c39ddc08bcbf41e1f849d8fb8", "committedDate": "2020-10-16T14:28:06Z", "message": "[#2244] Skip sendDisconnectedTtdEvent if consumer not mapped.\n\nNo 'disconnectedTtdEvent' is now sent anymore after closing\nthe command consumer when it has become obvious that the\nconsumer had already been removed/overwritten before.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNTMxMzk5", "url": "https://github.com/eclipse/hono/pull/2251#pullrequestreview-510531399", "createdAt": "2020-10-16T14:35:42Z", "commit": {"oid": "4c1332541d56bc1c39ddc08bcbf41e1f849d8fb8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e824fa21a93d28781ce11e4265d8c4759b220710", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/e824fa21a93d28781ce11e4265d8c4759b220710", "committedDate": "2020-10-19T08:20:49Z", "message": "[#2244] Skip sendDisconnectedTtdEvent if consumer not mapped.\n\nNo 'disconnectedTtdEvent' is now sent anymore after closing\nthe command consumer when it has become obvious that the\nconsumer had already been removed/overwritten before.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4c1332541d56bc1c39ddc08bcbf41e1f849d8fb8", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/4c1332541d56bc1c39ddc08bcbf41e1f849d8fb8", "committedDate": "2020-10-16T14:28:06Z", "message": "[#2244] Skip sendDisconnectedTtdEvent if consumer not mapped.\n\nNo 'disconnectedTtdEvent' is now sent anymore after closing\nthe command consumer when it has become obvious that the\nconsumer had already been removed/overwritten before.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}, "afterCommit": {"oid": "e824fa21a93d28781ce11e4265d8c4759b220710", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/e824fa21a93d28781ce11e4265d8c4759b220710", "committedDate": "2020-10-19T08:20:49Z", "message": "[#2244] Skip sendDisconnectedTtdEvent if consumer not mapped.\n\nNo 'disconnectedTtdEvent' is now sent anymore after closing\nthe command consumer when it has become obvious that the\nconsumer had already been removed/overwritten before.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 614, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}