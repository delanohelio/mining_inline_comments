{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4MjM2OTIx", "number": 1923, "title": "[#1714] Set TTL for connection event messages.", "bodyText": "fixes #1714\n\nI placed the TTL config parameter in the ClientConfigProperties since protocol adapters connect to the messaging network to forward the connection event downstream.\nI  currently set a default TTL value of 5 secs. Users can change the default  value  to any non-negative value by changing the corresponding config property.\n\n@sophokles73 I was thinking of allowing  the  option  to set the value to -1 if  a connection event message should be  keep in the broker (forever) until  it is consumed. WDYT? maybe this value would make a more sensible default?\nSigned-off-by: Alfusainey Jallow alf.jallow@gmail.com", "createdAt": "2020-04-23T22:42:49Z", "url": "https://github.com/eclipse/hono/pull/1923", "merged": true, "mergeCommit": {"oid": "45a1baf715006a6059480b6750a3e6d65dbaa3a2"}, "closed": true, "closedAt": "2020-05-06T13:25:09Z", "author": {"login": "Alfusainey"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcauARzgBqjMyNjg1ODk5ODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABceondngFqTQwNjYwNjE5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "33d89bd66909e21a27d5c9cfe0f1626d2c5c49f5", "author": {"user": {"login": "Alfusainey", "name": "Alfusainey Jallow"}}, "url": "https://github.com/eclipse/hono/commit/33d89bd66909e21a27d5c9cfe0f1626d2c5c49f5", "committedDate": "2020-04-23T22:02:45Z", "message": "[#1714] Set TTL for connection event messages.\n\nfixes #1714\n\nSigned-off-by: Alfusainey Jallow <alf.jallow@gmail.com>"}, "afterCommit": {"oid": "834a661c88b3d47458bbf541a2e92d9d08f79837", "author": {"user": {"login": "Alfusainey", "name": "Alfusainey Jallow"}}, "url": "https://github.com/eclipse/hono/commit/834a661c88b3d47458bbf541a2e92d9d08f79837", "committedDate": "2020-04-24T09:23:33Z", "message": "[#1714] Set TTL for connection event messages.\n\nfixes #1714\n\nSigned-off-by: Alfusainey Jallow <alf.jallow@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "834a661c88b3d47458bbf541a2e92d9d08f79837", "author": {"user": {"login": "Alfusainey", "name": "Alfusainey Jallow"}}, "url": "https://github.com/eclipse/hono/commit/834a661c88b3d47458bbf541a2e92d9d08f79837", "committedDate": "2020-04-24T09:23:33Z", "message": "[#1714] Set TTL for connection event messages.\n\nfixes #1714\n\nSigned-off-by: Alfusainey Jallow <alf.jallow@gmail.com>"}, "afterCommit": {"oid": "55afda39249f3194b4f0b53ab891271df907bdd1", "author": {"user": {"login": "Alfusainey", "name": "Alfusainey Jallow"}}, "url": "https://github.com/eclipse/hono/commit/55afda39249f3194b4f0b53ab891271df907bdd1", "committedDate": "2020-04-28T21:19:40Z", "message": "[#1714] Set TTL for connection event messages.\n\nfixes #1714\n\nSigned-off-by: Alfusainey Jallow <alf.jallow@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNzkxMjMy", "url": "https://github.com/eclipse/hono/pull/1923#pullrequestreview-402791232", "createdAt": "2020-04-29T15:37:00Z", "commit": {"oid": "55afda39249f3194b4f0b53ab891271df907bdd1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNTozNzowMFrOGOE2Ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNTo0MDoxMFrOGOE_Rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQxMjYyNw==", "bodyText": "I'd rather not introduce a new parameter here but instead simply use the MessageSender.send(Message) method for sending the event ...", "url": "https://github.com/eclipse/hono/pull/1923#discussion_r417412627", "createdAt": "2020-04-29T15:37:00Z", "author": {"login": "sophokles73"}, "path": "client/src/main/java/org/eclipse/hono/client/DownstreamSender.java", "diffHunk": "@@ -162,6 +166,7 @@\n      * @throws IllegalArgumentException if the content type specifies an unsupported character set.\n      */\n     Future<ProtonDelivery> send(\n+            Long maxTtl,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55afda39249f3194b4f0b53ab891271df907bdd1"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQxNDI0Mw==", "bodyText": "we can use MessageHelper.newMessage() here to create the message and send it using DownstreamSender.send(Message) ...", "url": "https://github.com/eclipse/hono/pull/1923#discussion_r417414243", "createdAt": "2020-04-29T15:39:10Z", "author": {"login": "sophokles73"}, "path": "service-base/src/main/java/org/eclipse/hono/service/monitoring/AbstractMessageSenderConnectionEventProducer.java", "diffHunk": "@@ -82,23 +82,29 @@ protected AbstractMessageSenderConnectionEventProducer(\n             return Future.succeededFuture();\n         }\n \n-        return getOrCreateSender(context.getMessageSenderClient(), authenticatedDevice.getTenantId())\n-                .compose(sender -> {\n-\n-                    final JsonObject payload = new JsonObject();\n-                    payload.put(\"cause\", cause);\n-                    payload.put(\"remote-id\", remoteId);\n-                    payload.put(\"source\", protocolAdapter);\n-\n-                    if (data != null) {\n-                        payload.put(\"data\", data);\n-                    }\n-\n-                    return sender.send(\n-                            authenticatedDevice.getDeviceId(),\n-                            payload.encode().getBytes(StandardCharsets.UTF_8),\n-                            EventConstants.EVENT_CONNECTION_NOTIFICATION_CONTENT_TYPE\n-                            );\n+        return context.getTenantClient().getOrCreateTenantClient()\n+                .map(tenantClient -> tenantClient.get(authenticatedDevice.getTenantId()))\n+                .map(tenantObject -> {\n+                    return getOrCreateSender(context.getMessageSenderClient(), authenticatedDevice.getTenantId())\n+                            .compose(sender -> {\n+\n+                                final JsonObject payload = new JsonObject();\n+                                payload.put(\"cause\", cause);\n+                                payload.put(\"remote-id\", remoteId);\n+                                payload.put(\"source\", protocolAdapter);\n+\n+                                if (data != null) {\n+                                    payload.put(\"data\", data);\n+                                }\n+\n+                                final Long maxTtl = tenantObject.result().getResourceLimits().getMaxTtl();\n+                                return sender.send(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55afda39249f3194b4f0b53ab891271df907bdd1"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQxNDk4Mg==", "bodyText": "IMHO this should be called getTenantClientFactory instead", "url": "https://github.com/eclipse/hono/pull/1923#discussion_r417414982", "createdAt": "2020-04-29T15:40:10Z", "author": {"login": "sophokles73"}, "path": "service-base/src/main/java/org/eclipse/hono/service/monitoring/ConnectionEventProducer.java", "diffHunk": "@@ -52,6 +53,14 @@\n          *         use. This client has to be initialized and started.\n          */\n         DownstreamSenderFactory getMessageSenderClient();\n+        /**\n+         * Provides the tenant client which the {@link ConnectionEventProducer} should use to lookup the tenant\n+         * that the device connecting to a protocol adapter belongs to.\n+         * \n+         * @return The tenant client instance. This client has to be initialized and started.\n+         */\n+        TenantClientFactory getTenantClient();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55afda39249f3194b4f0b53ab891271df907bdd1"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NTEzMDA1", "url": "https://github.com/eclipse/hono/pull/1923#pullrequestreview-404513005", "createdAt": "2020-05-02T09:07:07Z", "commit": {"oid": "491314621515851f8d927b0734116f349fbfb346"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMlQwOTowNzowN1rOGPhuYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMlQwOTowNzowN1rOGPhuYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODkzNDM2OA==", "bodyText": "I don't think so because the Event API defines this as a mandatory property of the message body.", "url": "https://github.com/eclipse/hono/pull/1923#discussion_r418934368", "createdAt": "2020-05-02T09:07:07Z", "author": {"login": "sophokles73"}, "path": "service-base/src/main/java/org/eclipse/hono/service/monitoring/AbstractMessageSenderConnectionEventProducer.java", "diffHunk": "@@ -82,27 +85,45 @@ protected AbstractMessageSenderConnectionEventProducer(\n             return Future.succeededFuture();\n         }\n \n-        return getOrCreateSender(context.getMessageSenderClient(), authenticatedDevice.getTenantId())\n-                .compose(sender -> {\n-\n-                    final JsonObject payload = new JsonObject();\n-                    payload.put(\"cause\", cause);\n-                    payload.put(\"remote-id\", remoteId);\n-                    payload.put(\"source\", protocolAdapter);\n-\n-                    if (data != null) {\n-                        payload.put(\"data\", data);\n-                    }\n-\n-                    return sender.send(\n-                            authenticatedDevice.getDeviceId(),\n-                            payload.encode().getBytes(StandardCharsets.UTF_8),\n-                            EventConstants.EVENT_CONNECTION_NOTIFICATION_CONTENT_TYPE\n-                            );\n+        return context.getTenantClientFactory().getOrCreateTenantClient()\n+                .map(tenantClient -> tenantClient.get(authenticatedDevice.getTenantId()))\n+                .map(tenantObjectFuture -> {\n+                    return getOrCreateSender(context.getMessageSenderClient(), authenticatedDevice.getTenantId())\n+                            .compose(sender -> {\n+\n+                                final JsonObject payload = new JsonObject();\n+                                payload.put(\"cause\", cause);\n+                                payload.put(\"remote-id\", remoteId);\n+                                // TODO: can this be removed in favour of 'orig_dapter'?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "491314621515851f8d927b0734116f349fbfb346"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2MzI3Mzc3", "url": "https://github.com/eclipse/hono/pull/1923#pullrequestreview-406327377", "createdAt": "2020-05-06T06:18:02Z", "commit": {"oid": "5098391dc4743fb682c57cc2d0df5ee7153f32c2"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNjoxODowMlrOGRFVWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNjoyMjoyMFrOGRFaww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU2NjM2MQ==", "bodyText": "applications", "url": "https://github.com/eclipse/hono/pull/1923#discussion_r420566361", "createdAt": "2020-05-06T06:18:02Z", "author": {"login": "sophokles73"}, "path": "service-base/src/test/java/org/eclipse/hono/service/AbstractProtocolAdapterBaseTest.java", "diffHunk": "@@ -686,6 +696,44 @@ public void verifyConnectionDurationLimitIsReached(final VertxTestContext ctx) {\n                 }));\n     }\n \n+    /**\n+     * Verifies that the (default) ConnectionEvent API configured for a protocol adapter\n+     * sets the connection event message's TTL header value before forwarding the message\n+     * to downstream aoplications.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5098391dc4743fb682c57cc2d0df5ee7153f32c2"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU2NjQ3NA==", "bodyText": "testForwarded ...", "url": "https://github.com/eclipse/hono/pull/1923#discussion_r420566474", "createdAt": "2020-05-06T06:18:22Z", "author": {"login": "sophokles73"}, "path": "service-base/src/test/java/org/eclipse/hono/service/AbstractProtocolAdapterBaseTest.java", "diffHunk": "@@ -686,6 +696,44 @@ public void verifyConnectionDurationLimitIsReached(final VertxTestContext ctx) {\n                 }));\n     }\n \n+    /**\n+     * Verifies that the (default) ConnectionEvent API configured for a protocol adapter\n+     * sets the connection event message's TTL header value before forwarding the message\n+     * to downstream aoplications.\n+     * \n+     * @param ctx The vert.x test context.\n+     */\n+    @Test\n+    public void tesForwardedConnectionEventMessageHasTtlHeaderSet(final VertxTestContext ctx) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5098391dc4743fb682c57cc2d0df5ee7153f32c2"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU2Nzc0Nw==", "bodyText": "there is no need to mock this class, is there?", "url": "https://github.com/eclipse/hono/pull/1923#discussion_r420567747", "createdAt": "2020-05-06T06:22:20Z", "author": {"login": "sophokles73"}, "path": "service-base/src/test/java/org/eclipse/hono/service/AbstractProtocolAdapterBaseTest.java", "diffHunk": "@@ -686,6 +696,44 @@ public void verifyConnectionDurationLimitIsReached(final VertxTestContext ctx) {\n                 }));\n     }\n \n+    /**\n+     * Verifies that the (default) ConnectionEvent API configured for a protocol adapter\n+     * sets the connection event message's TTL header value before forwarding the message\n+     * to downstream aoplications.\n+     * \n+     * @param ctx The vert.x test context.\n+     */\n+    @Test\n+    public void tesForwardedConnectionEventMessageHasTtlHeaderSet(final VertxTestContext ctx) {\n+\n+        // GIVEN a protocol adapter configured to send connection events\n+        final ConnectionEventProducer connectionEventProducer = new HonoEventConnectionEventProducer();\n+        adapter.setConnectionEventProducer(connectionEventProducer);\n+        final DownstreamSender connectionEventSender = mock(DownstreamSender.class);\n+        when(connectionEventSender.send(any(Message.class))).thenReturn(Future.succeededFuture());\n+        when(downstreamSenderFactory.getOrCreateEventSender(Constants.DEFAULT_TENANT)).thenReturn(Future.succeededFuture(connectionEventSender));\n+\n+        // WHEN a device, belonging to a tenant for which a max TTL is configured, connects to such an adapter\n+        final Device authenticatedDevice = new Device(Constants.DEFAULT_TENANT, \"4711\");\n+        final TenantClient tenantClient = mock(TenantClient.class);\n+        when(tenantClientFactory.getOrCreateTenantClient()).thenReturn(Future.succeededFuture(tenantClient));\n+        final TenantObject tenantObject = TenantObject.from(Constants.DEFAULT_TENANT, true);\n+        final ResourceLimits tenantLimits = mock(ResourceLimits.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5098391dc4743fb682c57cc2d0df5ee7153f32c2"}, "originalPosition": 126}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6099296328b44801e81c031dd7a92997230c3846", "author": {"user": {"login": "Alfusainey", "name": "Alfusainey Jallow"}}, "url": "https://github.com/eclipse/hono/commit/6099296328b44801e81c031dd7a92997230c3846", "committedDate": "2020-05-06T11:56:51Z", "message": "[#1714] Set TTL for connection event messages.\n\nfixes #1714\n\nSigned-off-by: Alfusainey Jallow <alf.jallow@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44b468ca4d40ce9877a26e851ae2f6f51697cc2f", "author": {"user": {"login": "Alfusainey", "name": "Alfusainey Jallow"}}, "url": "https://github.com/eclipse/hono/commit/44b468ca4d40ce9877a26e851ae2f6f51697cc2f", "committedDate": "2020-05-06T11:56:51Z", "message": "Use MessageHelper.new() to create AMQP message\n\nSigned-off-by: Alfusainey Jallow <alf.jallow@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfbea36299a3c3d0b7a0be6adc507ea5fdf6abdc", "author": {"user": {"login": "Alfusainey", "name": "Alfusainey Jallow"}}, "url": "https://github.com/eclipse/hono/commit/dfbea36299a3c3d0b7a0be6adc507ea5fdf6abdc", "committedDate": "2020-05-06T11:56:51Z", "message": "verify that TTL is set on connect event messages\n\nSigned-off-by: Alfusainey Jallow <alf.jallow@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "163cab9c05e81b30f1784a874bdfa4e3f622a968", "author": {"user": {"login": "Alfusainey", "name": "Alfusainey Jallow"}}, "url": "https://github.com/eclipse/hono/commit/163cab9c05e81b30f1784a874bdfa4e3f622a968", "committedDate": "2020-05-06T12:11:33Z", "message": "minor fixes\n\nSigned-off-by: Alfusainey Jallow <alf.jallow@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5098391dc4743fb682c57cc2d0df5ee7153f32c2", "author": {"user": {"login": "Alfusainey", "name": "Alfusainey Jallow"}}, "url": "https://github.com/eclipse/hono/commit/5098391dc4743fb682c57cc2d0df5ee7153f32c2", "committedDate": "2020-05-06T04:50:00Z", "message": "verify that TTL is set on connect event messages\n\nSigned-off-by: Alfusainey Jallow <alf.jallow@gmail.com>"}, "afterCommit": {"oid": "163cab9c05e81b30f1784a874bdfa4e3f622a968", "author": {"user": {"login": "Alfusainey", "name": "Alfusainey Jallow"}}, "url": "https://github.com/eclipse/hono/commit/163cab9c05e81b30f1784a874bdfa4e3f622a968", "committedDate": "2020-05-06T12:11:33Z", "message": "minor fixes\n\nSigned-off-by: Alfusainey Jallow <alf.jallow@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2NjA2MTk3", "url": "https://github.com/eclipse/hono/pull/1923#pullrequestreview-406606197", "createdAt": "2020-05-06T13:23:07Z", "commit": {"oid": "163cab9c05e81b30f1784a874bdfa4e3f622a968"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 893, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}