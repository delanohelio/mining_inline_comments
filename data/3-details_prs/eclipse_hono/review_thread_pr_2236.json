{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5Nzc5ODI1", "number": 2236, "reviewThreads": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwODo0MjowOVrOEr9Rnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxMzoyODo1MlrOEsoerQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0NTI4MTU5OnYy", "diffSide": "RIGHT", "path": "site/documentation/content/admin-guide/amqp-adapter-config.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwODo0MjowOVrOHfAoJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwODo0MjowOVrOHfAoJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI3ODE4MQ==", "bodyText": "Usage of \"client\" is a bit confusing here compared to the descriptions of the other properties - I guess it should be \"that the protocol adapter should accept\".\nBetter use AMQP frame singular - no cumulative size meant here.", "url": "https://github.com/eclipse/hono/pull/2236#discussion_r502278181", "createdAt": "2020-10-09T08:42:09Z", "author": {"login": "calohmn"}, "path": "site/documentation/content/admin-guide/amqp-adapter-config.md", "diffHunk": "@@ -36,7 +36,7 @@ The following table provides an overview of the configuration variables and corr\n | `HONO_AMQP_KEY_STORE_PATH`<br>`--hono.amqp.keyStorePath` | no | - | The absolute path to the Java key store containing the private key and certificate that the protocol adapter should use for authenticating to clients. Either this option or the `HONO_AMQP_KEY_PATH` and `HONO_AMQP_CERT_PATH` options need to be set in order to enable TLS secured connections with clients. The key store format can be either `JKS` or `PKCS12` indicated by a `.jks` or `.p12` file suffix respectively. |\n | `HONO_AMQP_SNI`<br>`--hono.amqp.sni` | no | `false` | Set whether the server supports Server Name Indication. By default, the server will not support SNI and the option is `false`. However, if set to `true` then the key store format, `HONO_AMQP_KEY_STORE_PATH`,  should be either `JKS` or `PKCS12` indicated by a `.jks` or `.p12` file suffix respectively. |\n | `HONO_AMQP_MAX_CONNECTIONS`<br>`--hono.amqp.maxConnections` | no | `0` | The maximum number of concurrent connections that the protocol adapter should accept. If not set (or set to `0`), the protocol adapter determines a reasonable value based on the available resources like memory and CPU. |\n-| `HONO_AMQP_MAX_FRAME_SIZE`<br>`--hono.amqp.maxFrameSize` | no | `16384` | The maximum number of bytes that can be sent in an AMQP message delivery over the connection with a device. When a client sends an AMQP frame of larger size, the connection is closed. |\n+| `HONO_AMQP_MAX_FRAME_SIZE`<br>`--hono.amqp.maxFrameSize` | no | `16384` | The maximum size (in bytes) of AMQP frames that the client should accept from the device. When a device sends a bigger frame, the connection will be closed. |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f15438df774eb9a5d84bddeb190c56ea79531c16"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0NTI5NDI0OnYy", "diffSide": "RIGHT", "path": "site/documentation/content/admin-guide/hono-client-configuration.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwODo0NToyOFrOHfAv1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwODo0NToyOFrOHfAv1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI4MDE0OA==", "bodyText": "\"AMQP frames\" - singular instead?", "url": "https://github.com/eclipse/hono/pull/2236#discussion_r502280148", "createdAt": "2020-10-09T08:45:28Z", "author": {"login": "calohmn"}, "path": "site/documentation/content/admin-guide/hono-client-configuration.md", "diffHunk": "@@ -39,6 +39,10 @@ delimiter,  e.g. the variable prefix `HONO_CREDENTIALS` corresponds to the comma\n | `${PREFIX}_KEYSTOREPASSWORD`<br>`--${prefix}.keyStorePassword` | no | - | The password required to read the contents of the key store. |\n | `${PREFIX}_KEYSTOREPATH`<br>`--${prefix}.keyStorePath` | no | - | The absolute path to the Java key store containing the private key and certificate that the client should use for authenticating to the server. Either this variable or the `${PREFIX}_KEYPATH` and `${PREFIX}_CERTPATH` variables need to be set in order to enable *SASL External* based authentication to the server. The key store format can be either `JKS` or `PKCS12` indicated by a `.jks` or `.p12` file suffix respectively. |\n | `${PREFIX}_LINKESTABLISMENTTIMEOUT`<br>`--${prefix}.linkEstablishmentTimeout` | no | `1000` | The maximum amount of time (milliseconds) that the client should wait for the service's *attach* frame during link establishment. This property can be used to tune the time period to wait according to the network latency involved with the communication link between the client and the service. |\n+| `${PREFIX}_MAXFRAMESIZE`<br>`--${prefix}.maxFrameSize` | no | `-1` | The maximum size (in bytes) of AMQP frames that the client should accept from the peer. When a peer sends a bigger frame, the connection will be closed. The default value of `-1` indicates that no limit is to be imposed. |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f15438df774eb9a5d84bddeb190c56ea79531c16"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0NTI5Nzc3OnYy", "diffSide": "RIGHT", "path": "site/documentation/content/admin-guide/hono-client-configuration.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwODo0NjoxOVrOHfAx9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwODo0NjoxOVrOHfAx9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI4MDY5NQ==", "bodyText": "\"The maximum size of messages\" - singular instead?", "url": "https://github.com/eclipse/hono/pull/2236#discussion_r502280695", "createdAt": "2020-10-09T08:46:19Z", "author": {"login": "calohmn"}, "path": "site/documentation/content/admin-guide/hono-client-configuration.md", "diffHunk": "@@ -39,6 +39,10 @@ delimiter,  e.g. the variable prefix `HONO_CREDENTIALS` corresponds to the comma\n | `${PREFIX}_KEYSTOREPASSWORD`<br>`--${prefix}.keyStorePassword` | no | - | The password required to read the contents of the key store. |\n | `${PREFIX}_KEYSTOREPATH`<br>`--${prefix}.keyStorePath` | no | - | The absolute path to the Java key store containing the private key and certificate that the client should use for authenticating to the server. Either this variable or the `${PREFIX}_KEYPATH` and `${PREFIX}_CERTPATH` variables need to be set in order to enable *SASL External* based authentication to the server. The key store format can be either `JKS` or `PKCS12` indicated by a `.jks` or `.p12` file suffix respectively. |\n | `${PREFIX}_LINKESTABLISMENTTIMEOUT`<br>`--${prefix}.linkEstablishmentTimeout` | no | `1000` | The maximum amount of time (milliseconds) that the client should wait for the service's *attach* frame during link establishment. This property can be used to tune the time period to wait according to the network latency involved with the communication link between the client and the service. |\n+| `${PREFIX}_MAXFRAMESIZE`<br>`--${prefix}.maxFrameSize` | no | `-1` | The maximum size (in bytes) of AMQP frames that the client should accept from the peer. When a peer sends a bigger frame, the connection will be closed. The default value of `-1` indicates that no limit is to be imposed. |\n+| `${PREFIX}_MAXMESSAGESIZE`<br>`--${prefix}.maxMessageSize` | no | `-1` | The maximum size of messages (in bytes) that the client should accept from a peer. The default value of `-1` indicates that messages of any size should be accepted. |\n+| `${PREFIX}_MINMESSAGESIZE`<br>`--${prefix}.minMessageSize` | no | `0` | The minimum size of messages (in bytes) that a peer is required to accept from the client. The default value of `0` indicates that no minimum size is required. (Sender) link establishment will fail, if the *max-message-size* conveyed by the peer in its *attach* frame is smaller than this property's value. |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f15438df774eb9a5d84bddeb190c56ea79531c16"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0NTM5ODMyOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/eclipse/hono/config/ClientConfigProperties.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwOToxNDoxOFrOHfBwYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQwODo0OToxMlrOHf1ETQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI5NjY3NA==", "bodyText": "Since the AMQP spec associates 0 with an unlimited size and requires a ulong, I think MAX_MESSAGE_SIZE_UNLIMITED should be 0 instead of   -1 (otherwise the attach frame would contain a value of 18446744073709551615 here, I guess).\nWith that, the condition above can be simplified to size < 0 and then the existing exception text also takes the unlimited case into account.", "url": "https://github.com/eclipse/hono/pull/2236#discussion_r502296674", "createdAt": "2020-10-09T09:14:18Z", "author": {"login": "calohmn"}, "path": "core/src/main/java/org/eclipse/hono/config/ClientConfigProperties.java", "diffHunk": "@@ -575,4 +603,140 @@ public final Pattern getAddressRewritePattern() {\n     public final String getAddressRewriteReplacement() {\n         return addressRewriteReplacement;\n     }\n+\n+    /**\n+     * Gets the minimum size of AMQP 1.0 messages that this client requires a peer to accept.\n+     * <p>\n+     * The default value of this property is {@value #MIN_MESSAGE_SIZE_NONE}.\n+     * <p>\n+     * The value of this property will be used by the client during sender link establishment.\n+     * Link establishment will fail, if the peer indicates a max-message-size in its <em>attach</em>\n+     * frame that is smaller than the configured minimum message size.\n+     *\n+     * @return The message size in bytes or {@value #MIN_MESSAGE_SIZE_NONE}, indicating no minimum size at all.\n+     */\n+    public final long getMinMessageSize() {\n+        return minMessageSize;\n+    }\n+\n+    /**\n+     * Sets the minimum size of AMQP 1.0 messages that this client requires a peer to accept.\n+     * <p>\n+     * The default value of this property is {@value #MIN_MESSAGE_SIZE_NONE}.\n+     * <p>\n+     * The value of this property will be used by the client during sender link establishment.\n+     * Link establishment will fail, if the peer indicates a max-message-size in its <em>attach</em>\n+     * frame that is smaller than the configured minimum message size.\n+     *\n+     * @param size The message size in bytes or {@value #MIN_MESSAGE_SIZE_NONE}, indicating no minimum size at all.\n+     * @throws IllegalArgumentException if size is &lt; 0.\n+     */\n+    public final void setMinMessageSize(final long size) {\n+        if (size < MIN_MESSAGE_SIZE_NONE) {\n+            throw new IllegalArgumentException(\"min message size must be >= 0\");\n+        }\n+        this.minMessageSize = size;\n+    }\n+\n+\n+    /**\n+     * Gets the maximum size of an AMQP 1.0 message that this client accepts from a peer.\n+     * <p>\n+     * The default value of this property is {@value #MAX_MESSAGE_SIZE_UNLIMITED}.\n+     *\n+     * @return The message size in bytes or {@value #MAX_MESSAGE_SIZE_UNLIMITED}, indicating messages of any size.\n+     */\n+    public final long getMaxMessageSize() {\n+        return maxMessageSize;\n+    }\n+\n+    /**\n+     * Sets the maximum size of an AMQP 1.0 message that this client should accept from a peer.\n+     * <p>\n+     * The default value of this property is {@value #MAX_MESSAGE_SIZE_UNLIMITED}.\n+     *\n+     * @param size The message size in bytes or {@value #MAX_MESSAGE_SIZE_UNLIMITED}, indicating messages of any size.\n+     * @throws IllegalArgumentException if size is &lt; 0 and not {@value #MAX_MESSAGE_SIZE_UNLIMITED}.\n+     */\n+    public final void setMaxMessageSize(final long size) {\n+        if (size != MAX_MESSAGE_SIZE_UNLIMITED && size < 0) {\n+            throw new IllegalArgumentException(\"max-message-size must be >= 0\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f15438df774eb9a5d84bddeb190c56ea79531c16"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM4MDgwMg==", "bodyText": "That is true. However, I wanted to use the same semantics as with MAX_FRAME_SIZE, i.e. use -1 in both cases to indicate no limit. In fact, the ProtonClientOptions require a negative value to indicate no limit ...", "url": "https://github.com/eclipse/hono/pull/2236#discussion_r502380802", "createdAt": "2020-10-09T12:05:17Z", "author": {"login": "sophokles73"}, "path": "core/src/main/java/org/eclipse/hono/config/ClientConfigProperties.java", "diffHunk": "@@ -575,4 +603,140 @@ public final Pattern getAddressRewritePattern() {\n     public final String getAddressRewriteReplacement() {\n         return addressRewriteReplacement;\n     }\n+\n+    /**\n+     * Gets the minimum size of AMQP 1.0 messages that this client requires a peer to accept.\n+     * <p>\n+     * The default value of this property is {@value #MIN_MESSAGE_SIZE_NONE}.\n+     * <p>\n+     * The value of this property will be used by the client during sender link establishment.\n+     * Link establishment will fail, if the peer indicates a max-message-size in its <em>attach</em>\n+     * frame that is smaller than the configured minimum message size.\n+     *\n+     * @return The message size in bytes or {@value #MIN_MESSAGE_SIZE_NONE}, indicating no minimum size at all.\n+     */\n+    public final long getMinMessageSize() {\n+        return minMessageSize;\n+    }\n+\n+    /**\n+     * Sets the minimum size of AMQP 1.0 messages that this client requires a peer to accept.\n+     * <p>\n+     * The default value of this property is {@value #MIN_MESSAGE_SIZE_NONE}.\n+     * <p>\n+     * The value of this property will be used by the client during sender link establishment.\n+     * Link establishment will fail, if the peer indicates a max-message-size in its <em>attach</em>\n+     * frame that is smaller than the configured minimum message size.\n+     *\n+     * @param size The message size in bytes or {@value #MIN_MESSAGE_SIZE_NONE}, indicating no minimum size at all.\n+     * @throws IllegalArgumentException if size is &lt; 0.\n+     */\n+    public final void setMinMessageSize(final long size) {\n+        if (size < MIN_MESSAGE_SIZE_NONE) {\n+            throw new IllegalArgumentException(\"min message size must be >= 0\");\n+        }\n+        this.minMessageSize = size;\n+    }\n+\n+\n+    /**\n+     * Gets the maximum size of an AMQP 1.0 message that this client accepts from a peer.\n+     * <p>\n+     * The default value of this property is {@value #MAX_MESSAGE_SIZE_UNLIMITED}.\n+     *\n+     * @return The message size in bytes or {@value #MAX_MESSAGE_SIZE_UNLIMITED}, indicating messages of any size.\n+     */\n+    public final long getMaxMessageSize() {\n+        return maxMessageSize;\n+    }\n+\n+    /**\n+     * Sets the maximum size of an AMQP 1.0 message that this client should accept from a peer.\n+     * <p>\n+     * The default value of this property is {@value #MAX_MESSAGE_SIZE_UNLIMITED}.\n+     *\n+     * @param size The message size in bytes or {@value #MAX_MESSAGE_SIZE_UNLIMITED}, indicating messages of any size.\n+     * @throws IllegalArgumentException if size is &lt; 0 and not {@value #MAX_MESSAGE_SIZE_UNLIMITED}.\n+     */\n+    public final void setMaxMessageSize(final long size) {\n+        if (size != MAX_MESSAGE_SIZE_UNLIMITED && size < 0) {\n+            throw new IllegalArgumentException(\"max-message-size must be >= 0\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI5NjY3NA=="}, "originalCommit": {"oid": "f15438df774eb9a5d84bddeb190c56ea79531c16"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzA5NjA4MQ==", "bodyText": "Ok. I that case I would suggest adding a check when applying the MaxMessageSize value, either not using the value at all:\n                if (clientConfigProperties.getMaxMessageSize() != ClientConfigProperties.MAX_MESSAGE_SIZE_UNLIMITED) {\n                    receiver.setMaxMessageSize(new UnsignedLong(clientConfigProperties.getMaxMessageSize()));\n                }\n\nor applying 0 in the \"unlimited size\" case, in order to not transport 18446744073709551615 on the wire.\nAnd I would also change the exception text to max-message-size must be >= -1.", "url": "https://github.com/eclipse/hono/pull/2236#discussion_r503096081", "createdAt": "2020-10-12T07:40:13Z", "author": {"login": "calohmn"}, "path": "core/src/main/java/org/eclipse/hono/config/ClientConfigProperties.java", "diffHunk": "@@ -575,4 +603,140 @@ public final Pattern getAddressRewritePattern() {\n     public final String getAddressRewriteReplacement() {\n         return addressRewriteReplacement;\n     }\n+\n+    /**\n+     * Gets the minimum size of AMQP 1.0 messages that this client requires a peer to accept.\n+     * <p>\n+     * The default value of this property is {@value #MIN_MESSAGE_SIZE_NONE}.\n+     * <p>\n+     * The value of this property will be used by the client during sender link establishment.\n+     * Link establishment will fail, if the peer indicates a max-message-size in its <em>attach</em>\n+     * frame that is smaller than the configured minimum message size.\n+     *\n+     * @return The message size in bytes or {@value #MIN_MESSAGE_SIZE_NONE}, indicating no minimum size at all.\n+     */\n+    public final long getMinMessageSize() {\n+        return minMessageSize;\n+    }\n+\n+    /**\n+     * Sets the minimum size of AMQP 1.0 messages that this client requires a peer to accept.\n+     * <p>\n+     * The default value of this property is {@value #MIN_MESSAGE_SIZE_NONE}.\n+     * <p>\n+     * The value of this property will be used by the client during sender link establishment.\n+     * Link establishment will fail, if the peer indicates a max-message-size in its <em>attach</em>\n+     * frame that is smaller than the configured minimum message size.\n+     *\n+     * @param size The message size in bytes or {@value #MIN_MESSAGE_SIZE_NONE}, indicating no minimum size at all.\n+     * @throws IllegalArgumentException if size is &lt; 0.\n+     */\n+    public final void setMinMessageSize(final long size) {\n+        if (size < MIN_MESSAGE_SIZE_NONE) {\n+            throw new IllegalArgumentException(\"min message size must be >= 0\");\n+        }\n+        this.minMessageSize = size;\n+    }\n+\n+\n+    /**\n+     * Gets the maximum size of an AMQP 1.0 message that this client accepts from a peer.\n+     * <p>\n+     * The default value of this property is {@value #MAX_MESSAGE_SIZE_UNLIMITED}.\n+     *\n+     * @return The message size in bytes or {@value #MAX_MESSAGE_SIZE_UNLIMITED}, indicating messages of any size.\n+     */\n+    public final long getMaxMessageSize() {\n+        return maxMessageSize;\n+    }\n+\n+    /**\n+     * Sets the maximum size of an AMQP 1.0 message that this client should accept from a peer.\n+     * <p>\n+     * The default value of this property is {@value #MAX_MESSAGE_SIZE_UNLIMITED}.\n+     *\n+     * @param size The message size in bytes or {@value #MAX_MESSAGE_SIZE_UNLIMITED}, indicating messages of any size.\n+     * @throws IllegalArgumentException if size is &lt; 0 and not {@value #MAX_MESSAGE_SIZE_UNLIMITED}.\n+     */\n+    public final void setMaxMessageSize(final long size) {\n+        if (size != MAX_MESSAGE_SIZE_UNLIMITED && size < 0) {\n+            throw new IllegalArgumentException(\"max-message-size must be >= 0\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI5NjY3NA=="}, "originalCommit": {"oid": "f15438df774eb9a5d84bddeb190c56ea79531c16"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEzNzM1Nw==", "bodyText": "yes, that makes sense ...", "url": "https://github.com/eclipse/hono/pull/2236#discussion_r503137357", "createdAt": "2020-10-12T08:49:12Z", "author": {"login": "sophokles73"}, "path": "core/src/main/java/org/eclipse/hono/config/ClientConfigProperties.java", "diffHunk": "@@ -575,4 +603,140 @@ public final Pattern getAddressRewritePattern() {\n     public final String getAddressRewriteReplacement() {\n         return addressRewriteReplacement;\n     }\n+\n+    /**\n+     * Gets the minimum size of AMQP 1.0 messages that this client requires a peer to accept.\n+     * <p>\n+     * The default value of this property is {@value #MIN_MESSAGE_SIZE_NONE}.\n+     * <p>\n+     * The value of this property will be used by the client during sender link establishment.\n+     * Link establishment will fail, if the peer indicates a max-message-size in its <em>attach</em>\n+     * frame that is smaller than the configured minimum message size.\n+     *\n+     * @return The message size in bytes or {@value #MIN_MESSAGE_SIZE_NONE}, indicating no minimum size at all.\n+     */\n+    public final long getMinMessageSize() {\n+        return minMessageSize;\n+    }\n+\n+    /**\n+     * Sets the minimum size of AMQP 1.0 messages that this client requires a peer to accept.\n+     * <p>\n+     * The default value of this property is {@value #MIN_MESSAGE_SIZE_NONE}.\n+     * <p>\n+     * The value of this property will be used by the client during sender link establishment.\n+     * Link establishment will fail, if the peer indicates a max-message-size in its <em>attach</em>\n+     * frame that is smaller than the configured minimum message size.\n+     *\n+     * @param size The message size in bytes or {@value #MIN_MESSAGE_SIZE_NONE}, indicating no minimum size at all.\n+     * @throws IllegalArgumentException if size is &lt; 0.\n+     */\n+    public final void setMinMessageSize(final long size) {\n+        if (size < MIN_MESSAGE_SIZE_NONE) {\n+            throw new IllegalArgumentException(\"min message size must be >= 0\");\n+        }\n+        this.minMessageSize = size;\n+    }\n+\n+\n+    /**\n+     * Gets the maximum size of an AMQP 1.0 message that this client accepts from a peer.\n+     * <p>\n+     * The default value of this property is {@value #MAX_MESSAGE_SIZE_UNLIMITED}.\n+     *\n+     * @return The message size in bytes or {@value #MAX_MESSAGE_SIZE_UNLIMITED}, indicating messages of any size.\n+     */\n+    public final long getMaxMessageSize() {\n+        return maxMessageSize;\n+    }\n+\n+    /**\n+     * Sets the maximum size of an AMQP 1.0 message that this client should accept from a peer.\n+     * <p>\n+     * The default value of this property is {@value #MAX_MESSAGE_SIZE_UNLIMITED}.\n+     *\n+     * @param size The message size in bytes or {@value #MAX_MESSAGE_SIZE_UNLIMITED}, indicating messages of any size.\n+     * @throws IllegalArgumentException if size is &lt; 0 and not {@value #MAX_MESSAGE_SIZE_UNLIMITED}.\n+     */\n+    public final void setMaxMessageSize(final long size) {\n+        if (size != MAX_MESSAGE_SIZE_UNLIMITED && size < 0) {\n+            throw new IllegalArgumentException(\"max-message-size must be >= 0\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI5NjY3NA=="}, "originalCommit": {"oid": "f15438df774eb9a5d84bddeb190c56ea79531c16"}, "originalPosition": 128}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0NTYxMDc4OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/eclipse/hono/config/ClientConfigProperties.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMDoxNzozNVrOHfD0rA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQwODo0ODozMlrOHf1CzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMzMDU0MA==", "bodyText": "I think this property is quite confusing. Just guessing from the name, I would think that with such a setting, messages with a smaller size than configured here would be dropped/rejected. However, its actual semantics would be described by a name like getMinimumRequiredPeerMaxMessageSize() (which is maybe a bit long), right?\nAlso the fact that getMaxMessageSize only applies to a receiver whereas getMinMessageSize is only for a sender makes things somewhat hard to grasp at first sight.\nCan there be a better name? Or, do we really need this property?", "url": "https://github.com/eclipse/hono/pull/2236#discussion_r502330540", "createdAt": "2020-10-09T10:17:35Z", "author": {"login": "calohmn"}, "path": "core/src/main/java/org/eclipse/hono/config/ClientConfigProperties.java", "diffHunk": "@@ -575,4 +603,140 @@ public final Pattern getAddressRewritePattern() {\n     public final String getAddressRewriteReplacement() {\n         return addressRewriteReplacement;\n     }\n+\n+    /**\n+     * Gets the minimum size of AMQP 1.0 messages that this client requires a peer to accept.\n+     * <p>\n+     * The default value of this property is {@value #MIN_MESSAGE_SIZE_NONE}.\n+     * <p>\n+     * The value of this property will be used by the client during sender link establishment.\n+     * Link establishment will fail, if the peer indicates a max-message-size in its <em>attach</em>\n+     * frame that is smaller than the configured minimum message size.\n+     *\n+     * @return The message size in bytes or {@value #MIN_MESSAGE_SIZE_NONE}, indicating no minimum size at all.\n+     */\n+    public final long getMinMessageSize() {\n+        return minMessageSize;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f15438df774eb9a5d84bddeb190c56ea79531c16"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM4MTcyNQ==", "bodyText": "Or, do we really need this property?\n\nWhat is the alternative? Having the sender link being closed on each message being sent that is bigger than the peer's max-message-size?", "url": "https://github.com/eclipse/hono/pull/2236#discussion_r502381725", "createdAt": "2020-10-09T12:07:14Z", "author": {"login": "sophokles73"}, "path": "core/src/main/java/org/eclipse/hono/config/ClientConfigProperties.java", "diffHunk": "@@ -575,4 +603,140 @@ public final Pattern getAddressRewritePattern() {\n     public final String getAddressRewriteReplacement() {\n         return addressRewriteReplacement;\n     }\n+\n+    /**\n+     * Gets the minimum size of AMQP 1.0 messages that this client requires a peer to accept.\n+     * <p>\n+     * The default value of this property is {@value #MIN_MESSAGE_SIZE_NONE}.\n+     * <p>\n+     * The value of this property will be used by the client during sender link establishment.\n+     * Link establishment will fail, if the peer indicates a max-message-size in its <em>attach</em>\n+     * frame that is smaller than the configured minimum message size.\n+     *\n+     * @return The message size in bytes or {@value #MIN_MESSAGE_SIZE_NONE}, indicating no minimum size at all.\n+     */\n+    public final long getMinMessageSize() {\n+        return minMessageSize;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMzMDU0MA=="}, "originalCommit": {"oid": "f15438df774eb9a5d84bddeb190c56ea79531c16"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEwNjcwMA==", "bodyText": "What is the alternative? Having the sender link being closed on each message being sent that is bigger than the peer's max-message-size?\n\nRight, having that check on link establishment already is better. For the use case of the telemetry/event sender clients in the protocol adapters, I think this config value should internally be modified to be at least the configured ServiceConfigProperties#getMaxPayloadSize value.\nI still think the name should be changed, though. How about getMinMaxMessageSize or getMinMessageSizeLimit?\n(MinMaxMessageSize would be similar in naming to the MIN-MAX-FRAME-SIZE constant of the AMQP spec).", "url": "https://github.com/eclipse/hono/pull/2236#discussion_r503106700", "createdAt": "2020-10-12T07:59:00Z", "author": {"login": "calohmn"}, "path": "core/src/main/java/org/eclipse/hono/config/ClientConfigProperties.java", "diffHunk": "@@ -575,4 +603,140 @@ public final Pattern getAddressRewritePattern() {\n     public final String getAddressRewriteReplacement() {\n         return addressRewriteReplacement;\n     }\n+\n+    /**\n+     * Gets the minimum size of AMQP 1.0 messages that this client requires a peer to accept.\n+     * <p>\n+     * The default value of this property is {@value #MIN_MESSAGE_SIZE_NONE}.\n+     * <p>\n+     * The value of this property will be used by the client during sender link establishment.\n+     * Link establishment will fail, if the peer indicates a max-message-size in its <em>attach</em>\n+     * frame that is smaller than the configured minimum message size.\n+     *\n+     * @return The message size in bytes or {@value #MIN_MESSAGE_SIZE_NONE}, indicating no minimum size at all.\n+     */\n+    public final long getMinMessageSize() {\n+        return minMessageSize;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMzMDU0MA=="}, "originalCommit": {"oid": "f15438df774eb9a5d84bddeb190c56ea79531c16"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEzNjk3Mg==", "bodyText": "let's use minMaxMessageSize then ...", "url": "https://github.com/eclipse/hono/pull/2236#discussion_r503136972", "createdAt": "2020-10-12T08:48:32Z", "author": {"login": "sophokles73"}, "path": "core/src/main/java/org/eclipse/hono/config/ClientConfigProperties.java", "diffHunk": "@@ -575,4 +603,140 @@ public final Pattern getAddressRewritePattern() {\n     public final String getAddressRewriteReplacement() {\n         return addressRewriteReplacement;\n     }\n+\n+    /**\n+     * Gets the minimum size of AMQP 1.0 messages that this client requires a peer to accept.\n+     * <p>\n+     * The default value of this property is {@value #MIN_MESSAGE_SIZE_NONE}.\n+     * <p>\n+     * The value of this property will be used by the client during sender link establishment.\n+     * Link establishment will fail, if the peer indicates a max-message-size in its <em>attach</em>\n+     * frame that is smaller than the configured minimum message size.\n+     *\n+     * @return The message size in bytes or {@value #MIN_MESSAGE_SIZE_NONE}, indicating no minimum size at all.\n+     */\n+    public final long getMinMessageSize() {\n+        return minMessageSize;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMzMDU0MA=="}, "originalCommit": {"oid": "f15438df774eb9a5d84bddeb190c56ea79531c16"}, "originalPosition": 84}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0NTYzMzAxOnYy", "diffSide": "RIGHT", "path": "client/src/main/java/org/eclipse/hono/client/impl/HonoConnectionImpl.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMDoyNDo0MFrOHfECdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQwODoxMDoxMlrOHfzlFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMzNDA2OA==", "bodyText": "I think throwing a ClientErrorException here means that we have to adapt the code for sending telemetry messages for example by catching this ClientErrorException and rethrowing it back as a ServerErrorException, so that the device gets a 5xx error here.", "url": "https://github.com/eclipse/hono/pull/2236#discussion_r502334068", "createdAt": "2020-10-09T10:24:40Z", "author": {"login": "calohmn"}, "path": "client/src/main/java/org/eclipse/hono/client/impl/HonoConnectionImpl.java", "diffHunk": "@@ -769,9 +832,20 @@ public void closeAndFree(\n \n                     } else if (HonoProtonHelper.isLinkEstablished(sender)) {\n \n-                        log.debug(\"sender open [target: {}, sendQueueFull: {}]\", targetAddress, sender.sendQueueFull());\n-                        // wait on credits a little time, if not already given\n-                        if (sender.getCredit() <= 0) {\n+                        log.debug(\"sender open [target: {}, sendQueueFull: {}, remote max-message-size: {}]\",\n+                                targetAddress, sender.sendQueueFull(), sender.getRemoteMaxMessageSize());\n+                        final long remoteMaxMessageSize = Optional.ofNullable(sender.getRemoteMaxMessageSize())\n+                                .map(UnsignedLong::longValue)\n+                                .orElse(0L);\n+                        if (remoteMaxMessageSize < clientConfigProperties.getMinMessageSize()) {\n+                            // peer won't accept our (biggest) messages\n+                            sender.close();\n+                            log.debug(\"peer does not support minimum message size [required: {}, supported: {}\",\n+                                    clientConfigProperties.getMinMessageSize(), remoteMaxMessageSize);\n+                            senderPromise.tryFail(new ClientErrorException(HttpURLConnection.HTTP_PRECON_FAILED,\n+                                    \"peer does not meet sender's minimum max-message-size requirement\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f15438df774eb9a5d84bddeb190c56ea79531c16"}, "originalPosition": 159}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM4NDA4MQ==", "bodyText": "Well, both the DownstreamSender.send() and HonoConnection.createSender() JavaDoc allow the returned Future to be failed with a ClientErrorException. Or am I missing something?", "url": "https://github.com/eclipse/hono/pull/2236#discussion_r502384081", "createdAt": "2020-10-09T12:12:18Z", "author": {"login": "sophokles73"}, "path": "client/src/main/java/org/eclipse/hono/client/impl/HonoConnectionImpl.java", "diffHunk": "@@ -769,9 +832,20 @@ public void closeAndFree(\n \n                     } else if (HonoProtonHelper.isLinkEstablished(sender)) {\n \n-                        log.debug(\"sender open [target: {}, sendQueueFull: {}]\", targetAddress, sender.sendQueueFull());\n-                        // wait on credits a little time, if not already given\n-                        if (sender.getCredit() <= 0) {\n+                        log.debug(\"sender open [target: {}, sendQueueFull: {}, remote max-message-size: {}]\",\n+                                targetAddress, sender.sendQueueFull(), sender.getRemoteMaxMessageSize());\n+                        final long remoteMaxMessageSize = Optional.ofNullable(sender.getRemoteMaxMessageSize())\n+                                .map(UnsignedLong::longValue)\n+                                .orElse(0L);\n+                        if (remoteMaxMessageSize < clientConfigProperties.getMinMessageSize()) {\n+                            // peer won't accept our (biggest) messages\n+                            sender.close();\n+                            log.debug(\"peer does not support minimum message size [required: {}, supported: {}\",\n+                                    clientConfigProperties.getMinMessageSize(), remoteMaxMessageSize);\n+                            senderPromise.tryFail(new ClientErrorException(HttpURLConnection.HTTP_PRECON_FAILED,\n+                                    \"peer does not meet sender's minimum max-message-size requirement\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMzNDA2OA=="}, "originalCommit": {"oid": "f15438df774eb9a5d84bddeb190c56ea79531c16"}, "originalPosition": 159}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzExMjk4Mg==", "bodyText": "Yes, I see there is a case already where a ClientErrorException is thrown in HonoConnection.createSender().\nSo that is an issue independent of this PR really, preventing a ClientErrorException on createSender() for a telemetry/event sender to be propagated to the device. I'll create an issue for that. EDIT: Created issue #2247.", "url": "https://github.com/eclipse/hono/pull/2236#discussion_r503112982", "createdAt": "2020-10-12T08:10:12Z", "author": {"login": "calohmn"}, "path": "client/src/main/java/org/eclipse/hono/client/impl/HonoConnectionImpl.java", "diffHunk": "@@ -769,9 +832,20 @@ public void closeAndFree(\n \n                     } else if (HonoProtonHelper.isLinkEstablished(sender)) {\n \n-                        log.debug(\"sender open [target: {}, sendQueueFull: {}]\", targetAddress, sender.sendQueueFull());\n-                        // wait on credits a little time, if not already given\n-                        if (sender.getCredit() <= 0) {\n+                        log.debug(\"sender open [target: {}, sendQueueFull: {}, remote max-message-size: {}]\",\n+                                targetAddress, sender.sendQueueFull(), sender.getRemoteMaxMessageSize());\n+                        final long remoteMaxMessageSize = Optional.ofNullable(sender.getRemoteMaxMessageSize())\n+                                .map(UnsignedLong::longValue)\n+                                .orElse(0L);\n+                        if (remoteMaxMessageSize < clientConfigProperties.getMinMessageSize()) {\n+                            // peer won't accept our (biggest) messages\n+                            sender.close();\n+                            log.debug(\"peer does not support minimum message size [required: {}, supported: {}\",\n+                                    clientConfigProperties.getMinMessageSize(), remoteMaxMessageSize);\n+                            senderPromise.tryFail(new ClientErrorException(HttpURLConnection.HTTP_PRECON_FAILED,\n+                                    \"peer does not meet sender's minimum max-message-size requirement\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMzNDA2OA=="}, "originalCommit": {"oid": "f15438df774eb9a5d84bddeb190c56ea79531c16"}, "originalPosition": 159}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1MjExMjkxOnYy", "diffSide": "RIGHT", "path": "client/src/main/java/org/eclipse/hono/client/impl/HonoConnectionImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxMjoyMjozMlrOHf8bPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNToyNDoyMlrOHgDRGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI1NzkxNg==", "bodyText": "I think the connection should be closed in this case here (that was also the old behaviour triggered via the close handler of the ProtonConnectionImpl default session).\nOr the session should be recreated - but probably better to close the connection here, so that connection and session get recreated on reconnect.", "url": "https://github.com/eclipse/hono/pull/2236#discussion_r503257916", "createdAt": "2020-10-12T12:22:32Z", "author": {"login": "calohmn"}, "path": "client/src/main/java/org/eclipse/hono/client/impl/HonoConnectionImpl.java", "diffHunk": "@@ -707,6 +718,58 @@ public void closeAndFree(\n         }\n     }\n \n+    private Future<ProtonSession> createDefaultSession(final ProtonConnection connection) {\n+\n+        final Promise<ProtonSession> result = Promise.promise();\n+        if (connection == null) {\n+            result.fail(new NullPointerException(\"connection must not be null\"));\n+        } else {\n+            log.debug(\"trying to establish AMQP session with server [{}:{}, role: {}]\",\n+                    connectionFactory.getHost(),\n+                    connectionFactory.getPort(),\n+                    connectionFactory.getServerRole());\n+            final ProtonSession session = connection.createSession();\n+            session.openHandler(beginAttempt -> {\n+                if (beginAttempt.succeeded()) {\n+                    log.debug(\"successfully established AMQP session with server [{}:{}, role: {}]\",\n+                            connectionFactory.getHost(),\n+                            connectionFactory.getPort(),\n+                            connectionFactory.getServerRole());\n+                    result.complete(session);\n+                } else {\n+                    log.debug(\"failed to establish AMQP session with server [{}:{}, role: {}]\",\n+                            connectionFactory.getHost(),\n+                            connectionFactory.getPort(),\n+                            connectionFactory.getServerRole(),\n+                            beginAttempt.cause());\n+                    result.fail(new ClientErrorException(\n+                            HttpURLConnection.HTTP_BAD_REQUEST,\n+                            \"failed to establish AMQP session with peer\",\n+                            beginAttempt.cause()));\n+                }\n+            });\n+            session.closeHandler(remoteClose -> {\n+                final ErrorCondition error = session.getRemoteCondition();\n+                if (error == null) {\n+                    log.debug(\"server [{}:{}, role: {}] closed session\",\n+                            connectionFactory.getHost(),\n+                            connectionFactory.getPort(),\n+                            connectionFactory.getServerRole());\n+                } else {\n+                    log.debug(\"server [{}:{}, role: {}] closed session with error [condition: {}, description: {}]\",\n+                            connectionFactory.getHost(),\n+                            connectionFactory.getPort(),\n+                            connectionFactory.getServerRole(),\n+                            error.getCondition(),\n+                            error.getDescription());\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85c96618bdac058047a16ca01ccdc3b3dc9ddd45"}, "originalPosition": 121}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM3MDAwOA==", "bodyText": "yes, closing the connection seems to be the right thing to do. I will set a corresponding handler ...", "url": "https://github.com/eclipse/hono/pull/2236#discussion_r503370008", "createdAt": "2020-10-12T15:24:22Z", "author": {"login": "sophokles73"}, "path": "client/src/main/java/org/eclipse/hono/client/impl/HonoConnectionImpl.java", "diffHunk": "@@ -707,6 +718,58 @@ public void closeAndFree(\n         }\n     }\n \n+    private Future<ProtonSession> createDefaultSession(final ProtonConnection connection) {\n+\n+        final Promise<ProtonSession> result = Promise.promise();\n+        if (connection == null) {\n+            result.fail(new NullPointerException(\"connection must not be null\"));\n+        } else {\n+            log.debug(\"trying to establish AMQP session with server [{}:{}, role: {}]\",\n+                    connectionFactory.getHost(),\n+                    connectionFactory.getPort(),\n+                    connectionFactory.getServerRole());\n+            final ProtonSession session = connection.createSession();\n+            session.openHandler(beginAttempt -> {\n+                if (beginAttempt.succeeded()) {\n+                    log.debug(\"successfully established AMQP session with server [{}:{}, role: {}]\",\n+                            connectionFactory.getHost(),\n+                            connectionFactory.getPort(),\n+                            connectionFactory.getServerRole());\n+                    result.complete(session);\n+                } else {\n+                    log.debug(\"failed to establish AMQP session with server [{}:{}, role: {}]\",\n+                            connectionFactory.getHost(),\n+                            connectionFactory.getPort(),\n+                            connectionFactory.getServerRole(),\n+                            beginAttempt.cause());\n+                    result.fail(new ClientErrorException(\n+                            HttpURLConnection.HTTP_BAD_REQUEST,\n+                            \"failed to establish AMQP session with peer\",\n+                            beginAttempt.cause()));\n+                }\n+            });\n+            session.closeHandler(remoteClose -> {\n+                final ErrorCondition error = session.getRemoteCondition();\n+                if (error == null) {\n+                    log.debug(\"server [{}:{}, role: {}] closed session\",\n+                            connectionFactory.getHost(),\n+                            connectionFactory.getPort(),\n+                            connectionFactory.getServerRole());\n+                } else {\n+                    log.debug(\"server [{}:{}, role: {}] closed session with error [condition: {}, description: {}]\",\n+                            connectionFactory.getHost(),\n+                            connectionFactory.getPort(),\n+                            connectionFactory.getServerRole(),\n+                            error.getCondition(),\n+                            error.getDescription());\n+                }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI1NzkxNg=="}, "originalCommit": {"oid": "85c96618bdac058047a16ca01ccdc3b3dc9ddd45"}, "originalPosition": 121}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1MjE1NDU1OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/eclipse/hono/connection/impl/ConnectionFactoryImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxMjozNDo1OVrOHf81Cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxMjozNDo1OVrOHf81Cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI2NDUyMg==", "bodyText": "This line should also be added to AmqpCliClient#connectToAdapter() FMPOV.", "url": "https://github.com/eclipse/hono/pull/2236#discussion_r503264522", "createdAt": "2020-10-12T12:34:59Z", "author": {"login": "calohmn"}, "path": "core/src/main/java/org/eclipse/hono/connection/impl/ConnectionFactoryImpl.java", "diffHunk": "@@ -403,6 +403,7 @@ private ProtonClientOptions createClientOptions() {\n         final ProtonClientOptions options = new ProtonClientOptions();\n         options.setConnectTimeout(config.getConnectTimeout());\n         options.setHeartbeat(config.getHeartbeatInterval());\n+        options.setMaxFrameSize(config.getMaxFrameSize());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85c96618bdac058047a16ca01ccdc3b3dc9ddd45"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1MjI1NTIwOnYy", "diffSide": "RIGHT", "path": "client/src/main/java/org/eclipse/hono/client/impl/HonoConnectionImpl.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxMzowMTowN1rOHf9xJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMjozMDowOFrOHgkPTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI3OTkxMQ==", "bodyText": "Instead of failing all reconnect attempts like this, close the connection and call reconnect in the onFailure case here instead?", "url": "https://github.com/eclipse/hono/pull/2236#discussion_r503279911", "createdAt": "2020-10-12T13:01:07Z", "author": {"login": "calohmn"}, "path": "client/src/main/java/org/eclipse/hono/client/impl/HonoConnectionImpl.java", "diffHunk": "@@ -436,8 +441,14 @@ private void connect(\n                                             connectionFactory.getPort(),\n                                             connectionFactory.getServerRole(),\n                                             newConnection.getRemoteContainer());\n-                                    setConnection(newConnection);\n-                                    wrappedConnectionHandler.handle(Future.succeededFuture(this));\n+                                    createDefaultSession(newConnection)\n+                                        .onSuccess(newSession -> {\n+                                            setConnection(newConnection, newSession);\n+                                            wrappedConnectionHandler.handle(Future.succeededFuture(this));\n+                                        })\n+                                        .onFailure(t -> {\n+                                            wrappedConnectionHandler.handle(Future.failedFuture(t));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85c96618bdac058047a16ca01ccdc3b3dc9ddd45"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzcwMDc3MA==", "bodyText": "If the peer does not accept the session I do not really see why it should accept it in subsequent attempts. FMPOV this is comparable to wrong credentials, the peer either is willing to open a session or not, or am I mistaken?\nI agree that we should close the newly opened connection but then I guess we will need to fail the connection attempt. WDYT?", "url": "https://github.com/eclipse/hono/pull/2236#discussion_r503700770", "createdAt": "2020-10-13T06:40:36Z", "author": {"login": "sophokles73"}, "path": "client/src/main/java/org/eclipse/hono/client/impl/HonoConnectionImpl.java", "diffHunk": "@@ -436,8 +441,14 @@ private void connect(\n                                             connectionFactory.getPort(),\n                                             connectionFactory.getServerRole(),\n                                             newConnection.getRemoteContainer());\n-                                    setConnection(newConnection);\n-                                    wrappedConnectionHandler.handle(Future.succeededFuture(this));\n+                                    createDefaultSession(newConnection)\n+                                        .onSuccess(newSession -> {\n+                                            setConnection(newConnection, newSession);\n+                                            wrappedConnectionHandler.handle(Future.succeededFuture(this));\n+                                        })\n+                                        .onFailure(t -> {\n+                                            wrappedConnectionHandler.handle(Future.failedFuture(t));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI3OTkxMQ=="}, "originalCommit": {"oid": "85c96618bdac058047a16ca01ccdc3b3dc9ddd45"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc2NDM2OA==", "bodyText": "For a session to not get established by the remote peer, here Qpid in particular, I could think of 2 reasons:\n\nmaxSessions having been reached already (shouldn't happen here since we only use one session per connection)\nor Qpid not having enough memory to create a new session.\n\nFor the 2nd case, I think it would be good to retry the connection attempt, potentially ending up at another Qpid instance or Qpid having been restarted then.\nFailing the connection attempt instead in this case would be fatal and cause the whole adapter to need a restart in case of the telemetry/event sender connection for example, if I'm not mistaken.", "url": "https://github.com/eclipse/hono/pull/2236#discussion_r503764368", "createdAt": "2020-10-13T08:29:32Z", "author": {"login": "calohmn"}, "path": "client/src/main/java/org/eclipse/hono/client/impl/HonoConnectionImpl.java", "diffHunk": "@@ -436,8 +441,14 @@ private void connect(\n                                             connectionFactory.getPort(),\n                                             connectionFactory.getServerRole(),\n                                             newConnection.getRemoteContainer());\n-                                    setConnection(newConnection);\n-                                    wrappedConnectionHandler.handle(Future.succeededFuture(this));\n+                                    createDefaultSession(newConnection)\n+                                        .onSuccess(newSession -> {\n+                                            setConnection(newConnection, newSession);\n+                                            wrappedConnectionHandler.handle(Future.succeededFuture(this));\n+                                        })\n+                                        .onFailure(t -> {\n+                                            wrappedConnectionHandler.handle(Future.failedFuture(t));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI3OTkxMQ=="}, "originalCommit": {"oid": "85c96618bdac058047a16ca01ccdc3b3dc9ddd45"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg2NTY2Nw==", "bodyText": "I see your point and it makes sense to me. The default session in vertx-proton only has a close handler which is used to trigger the underlying connection's close handler. This mechanism is already being used by Hono implicitly, so I guess we could use the same approach here as well, i.e. do not register an explicit open handler for the session at all but simply rely on the (standard) behavior of the connection's close handler to trigger reconnect. WDYT?", "url": "https://github.com/eclipse/hono/pull/2236#discussion_r503865667", "createdAt": "2020-10-13T11:12:39Z", "author": {"login": "sophokles73"}, "path": "client/src/main/java/org/eclipse/hono/client/impl/HonoConnectionImpl.java", "diffHunk": "@@ -436,8 +441,14 @@ private void connect(\n                                             connectionFactory.getPort(),\n                                             connectionFactory.getServerRole(),\n                                             newConnection.getRemoteContainer());\n-                                    setConnection(newConnection);\n-                                    wrappedConnectionHandler.handle(Future.succeededFuture(this));\n+                                    createDefaultSession(newConnection)\n+                                        .onSuccess(newSession -> {\n+                                            setConnection(newConnection, newSession);\n+                                            wrappedConnectionHandler.handle(Future.succeededFuture(this));\n+                                        })\n+                                        .onFailure(t -> {\n+                                            wrappedConnectionHandler.handle(Future.failedFuture(t));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI3OTkxMQ=="}, "originalCommit": {"oid": "85c96618bdac058047a16ca01ccdc3b3dc9ddd45"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzkxMDIyMg==", "bodyText": "Yes, I agree.", "url": "https://github.com/eclipse/hono/pull/2236#discussion_r503910222", "createdAt": "2020-10-13T12:30:08Z", "author": {"login": "calohmn"}, "path": "client/src/main/java/org/eclipse/hono/client/impl/HonoConnectionImpl.java", "diffHunk": "@@ -436,8 +441,14 @@ private void connect(\n                                             connectionFactory.getPort(),\n                                             connectionFactory.getServerRole(),\n                                             newConnection.getRemoteContainer());\n-                                    setConnection(newConnection);\n-                                    wrappedConnectionHandler.handle(Future.succeededFuture(this));\n+                                    createDefaultSession(newConnection)\n+                                        .onSuccess(newSession -> {\n+                                            setConnection(newConnection, newSession);\n+                                            wrappedConnectionHandler.handle(Future.succeededFuture(this));\n+                                        })\n+                                        .onFailure(t -> {\n+                                            wrappedConnectionHandler.handle(Future.failedFuture(t));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI3OTkxMQ=="}, "originalCommit": {"oid": "85c96618bdac058047a16ca01ccdc3b3dc9ddd45"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1MjMwNTM0OnYy", "diffSide": "RIGHT", "path": "client/src/main/java/org/eclipse/hono/client/impl/HonoConnectionImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxMzoxNDozN1rOHf-Pvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxMzoxNDozN1rOHf-Pvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI4Nzc0Mg==", "bodyText": "I think in the condition here there is an added remoteMaxMessageSize > 0 missing.", "url": "https://github.com/eclipse/hono/pull/2236#discussion_r503287742", "createdAt": "2020-10-12T13:14:37Z", "author": {"login": "calohmn"}, "path": "client/src/main/java/org/eclipse/hono/client/impl/HonoConnectionImpl.java", "diffHunk": "@@ -769,9 +832,20 @@ public void closeAndFree(\n \n                     } else if (HonoProtonHelper.isLinkEstablished(sender)) {\n \n-                        log.debug(\"sender open [target: {}, sendQueueFull: {}]\", targetAddress, sender.sendQueueFull());\n-                        // wait on credits a little time, if not already given\n-                        if (sender.getCredit() <= 0) {\n+                        log.debug(\"sender open [target: {}, sendQueueFull: {}, remote max-message-size: {}]\",\n+                                targetAddress, sender.sendQueueFull(), sender.getRemoteMaxMessageSize());\n+                        final long remoteMaxMessageSize = Optional.ofNullable(sender.getRemoteMaxMessageSize())\n+                                .map(UnsignedLong::longValue)\n+                                .orElse(0L);\n+                        if (remoteMaxMessageSize < clientConfigProperties.getMinMaxMessageSize()) {\n+                            // peer won't accept our (biggest) messages\n+                            sender.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85c96618bdac058047a16ca01ccdc3b3dc9ddd45"}, "originalPosition": 155}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1MjM2MDEzOnYy", "diffSide": "RIGHT", "path": "client/src/main/java/org/eclipse/hono/client/impl/HonoConnectionImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxMzoyODo1MlrOHf-w-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxMzoyODo1MlrOHf-w-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI5NjI0OA==", "bodyText": "Maybe include the remoteMaxMessageSize in the exception text so that it appears in the surrounding tracing span (if one exists) via the logged error message? (So that the application doesn't needed to be restarted if not run with DEBUG log level in order to find out about the actual advertised value.)", "url": "https://github.com/eclipse/hono/pull/2236#discussion_r503296248", "createdAt": "2020-10-12T13:28:52Z", "author": {"login": "calohmn"}, "path": "client/src/main/java/org/eclipse/hono/client/impl/HonoConnectionImpl.java", "diffHunk": "@@ -769,9 +832,20 @@ public void closeAndFree(\n \n                     } else if (HonoProtonHelper.isLinkEstablished(sender)) {\n \n-                        log.debug(\"sender open [target: {}, sendQueueFull: {}]\", targetAddress, sender.sendQueueFull());\n-                        // wait on credits a little time, if not already given\n-                        if (sender.getCredit() <= 0) {\n+                        log.debug(\"sender open [target: {}, sendQueueFull: {}, remote max-message-size: {}]\",\n+                                targetAddress, sender.sendQueueFull(), sender.getRemoteMaxMessageSize());\n+                        final long remoteMaxMessageSize = Optional.ofNullable(sender.getRemoteMaxMessageSize())\n+                                .map(UnsignedLong::longValue)\n+                                .orElse(0L);\n+                        if (remoteMaxMessageSize < clientConfigProperties.getMinMaxMessageSize()) {\n+                            // peer won't accept our (biggest) messages\n+                            sender.close();\n+                            log.debug(\"peer does not support minimum message size [required: {}, supported: {}\",\n+                                    clientConfigProperties.getMinMaxMessageSize(), remoteMaxMessageSize);\n+                            senderPromise.tryFail(new ClientErrorException(HttpURLConnection.HTTP_PRECON_FAILED,\n+                                    \"peer does not meet sender's minimum max-message-size requirement\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85c96618bdac058047a16ca01ccdc3b3dc9ddd45"}, "originalPosition": 159}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3097, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}