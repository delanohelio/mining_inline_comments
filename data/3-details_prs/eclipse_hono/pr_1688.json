{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5MDExMzEx", "number": 1688, "title": "[#1687] Close root span if connection got closed prematurely", "bodyText": "This fixes #1687.", "createdAt": "2020-01-03T14:42:27Z", "url": "https://github.com/eclipse/hono/pull/1688", "merged": true, "mergeCommit": {"oid": "cde62cebf41f9c1fab2eed6e2c51747aef015014"}, "closed": true, "closedAt": "2020-01-07T16:08:05Z", "author": {"login": "calohmn"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb3oU0DAFqTMzODUyNzQwNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb39EjogFqTMzOTEwOTIwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NTI3NDA0", "url": "https://github.com/eclipse/hono/pull/1688#pullrequestreview-338527404", "createdAt": "2020-01-06T08:57:04Z", "commit": {"oid": "4bc36d61527f6ae0f1d1ae0839f8f388b93834e2"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwODo1NzowNFrOFaYSFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwODo1OTozOVrOFaYVCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIwNTE0MQ==", "bodyText": "can we merge this with the previous message being logged to the current span?", "url": "https://github.com/eclipse/hono/pull/1688#discussion_r363205141", "createdAt": "2020-01-06T08:57:04Z", "author": {"login": "sophokles73"}, "path": "adapters/http-vertx-base/src/main/java/org/eclipse/hono/adapter/http/AbstractVertxBasedHttpProtocolAdapter.java", "diffHunk": "@@ -860,18 +879,21 @@ protected Integer getTimeUntilDisconnectFromRequest(final RoutingContext ctx) {\n      * @param deviceId The identifier of the device.\n      * @param currentSpan The <em>OpenTracing</em> Span used for tracking the processing of the request.\n      */\n-    private void addConnectionCloseHandler(\n+    private void setTtdRequestConnectionCloseHandler(\n             final RoutingContext ctx,\n             final MessageConsumer messageConsumer,\n             final String tenantId,\n             final String deviceId,\n             final Span currentSpan) {\n \n-        if (messageConsumer != null && !ctx.response().closed()) {\n+        if (messageConsumer != null && !ctx.response().closed() && !ctx.response().ended()) {\n             ctx.response().closeHandler(v -> {\n                 log.debug(\"device [tenant: {}, device-id: {}] closed connection before response could be sent\",\n                         tenantId, deviceId);\n                 currentSpan.log(\"device closed connection\");\n+                TracingHelper.logError(currentSpan, \"cannot send HTTP response to device: response already closed\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4bc36d61527f6ae0f1d1ae0839f8f388b93834e2"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIwNTg5OQ==", "bodyText": "this handler seems to be useful/required for any request, not just TTD requests, doesn't it?", "url": "https://github.com/eclipse/hono/pull/1688#discussion_r363205899", "createdAt": "2020-01-06T08:59:39Z", "author": {"login": "sophokles73"}, "path": "adapters/http-vertx-base/src/main/java/org/eclipse/hono/adapter/http/AbstractVertxBasedHttpProtocolAdapter.java", "diffHunk": "@@ -860,18 +879,21 @@ protected Integer getTimeUntilDisconnectFromRequest(final RoutingContext ctx) {\n      * @param deviceId The identifier of the device.\n      * @param currentSpan The <em>OpenTracing</em> Span used for tracking the processing of the request.\n      */\n-    private void addConnectionCloseHandler(\n+    private void setTtdRequestConnectionCloseHandler(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4bc36d61527f6ae0f1d1ae0839f8f388b93834e2"}, "originalPosition": 74}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4bc36d61527f6ae0f1d1ae0839f8f388b93834e2", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/4bc36d61527f6ae0f1d1ae0839f8f388b93834e2", "committedDate": "2020-01-03T14:40:11Z", "message": "[#1687] Close root span if connection got closed prematurely.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch-si.com>"}, "afterCommit": {"oid": "de081f735d826141aa68cc35dc369ca70c53e001", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/de081f735d826141aa68cc35dc369ca70c53e001", "committedDate": "2020-01-06T13:20:16Z", "message": "[#1687] Close root span if connection got closed prematurely.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch-si.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NjQ5ODYx", "url": "https://github.com/eclipse/hono/pull/1688#pullrequestreview-338649861", "createdAt": "2020-01-06T13:46:44Z", "commit": {"oid": "de081f735d826141aa68cc35dc369ca70c53e001"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQxMzo0Njo0NFrOFaeAFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQxMzo0Njo0NFrOFaeAFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzI5ODgzOQ==", "bodyText": "the close handler that is set here will be overwritten later by the doUploadMessage method, right?\nWhy don't we set a failure Handler here instead which finishes the root span and modify the doUploadMessage method to fail the RoutingContext e.g. with an IllegalStateException if the request is being closed before we can send the response or if sending the response fails?", "url": "https://github.com/eclipse/hono/pull/1688#discussion_r363298839", "createdAt": "2020-01-06T13:46:44Z", "author": {"login": "sophokles73"}, "path": "adapters/http-vertx-base/src/main/java/org/eclipse/hono/adapter/http/AbstractVertxBasedHttpProtocolAdapter.java", "diffHunk": "@@ -315,16 +316,24 @@ protected Router createRouter() {\n         final TracingHandler tracingHandler = createTracingHandler();\n         matchAllRoute.handler(tracingHandler).failureHandler(tracingHandler);\n \n-        // 3. default handler for failed routes\n+        // 3. handler to ensure tracing root span is finished if the request gets closed prematurely\n+        matchAllRoute.handler(ctx -> {\n+            if (!ctx.response().closed() && !ctx.response().ended()) {\n+                ctx.response().closeHandler(v -> finishRootSpanOnResponseGettingClosedPrematurely(ctx));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de081f735d826141aa68cc35dc369ca70c53e001"}, "originalPosition": 16}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de081f735d826141aa68cc35dc369ca70c53e001", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/de081f735d826141aa68cc35dc369ca70c53e001", "committedDate": "2020-01-06T13:20:16Z", "message": "[#1687] Close root span if connection got closed prematurely.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch-si.com>"}, "afterCommit": {"oid": "ce2305fa040fa360a277a2764e297061b349e0ed", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/ce2305fa040fa360a277a2764e297061b349e0ed", "committedDate": "2020-01-06T15:05:37Z", "message": "[#1687] Ensure response is ended if it got closed prematurely.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch-si.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NzEwMDIz", "url": "https://github.com/eclipse/hono/pull/1688#pullrequestreview-338710023", "createdAt": "2020-01-06T15:31:49Z", "commit": {"oid": "ce2305fa040fa360a277a2764e297061b349e0ed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQxNTozMTo0OVrOFaguPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQxNTozMTo0OVrOFaguPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzM0MzQyMw==", "bodyText": "shouldn't this better be part of the condition in the first if statement?", "url": "https://github.com/eclipse/hono/pull/1688#discussion_r363343423", "createdAt": "2020-01-06T15:31:49Z", "author": {"login": "sophokles73"}, "path": "service-base/src/main/java/org/eclipse/hono/service/http/HttpUtils.java", "diffHunk": "@@ -181,7 +181,7 @@ public static void failWithHeaders(\n         if (ctx.failed() || ctx.response().ended()) {\n             // nothing to do\n         } else {\n-            if (headers != null) {\n+            if (headers != null && !ctx.response().closed()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce2305fa040fa360a277a2764e297061b349e0ed"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9f64e4ebb147e63c89305ca6243f49d5f871e06", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/f9f64e4ebb147e63c89305ca6243f49d5f871e06", "committedDate": "2020-01-07T08:33:16Z", "message": "[#1687] Ensure response is ended if it got closed prematurely.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch-si.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ce2305fa040fa360a277a2764e297061b349e0ed", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/ce2305fa040fa360a277a2764e297061b349e0ed", "committedDate": "2020-01-06T15:05:37Z", "message": "[#1687] Ensure response is ended if it got closed prematurely.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch-si.com>"}, "afterCommit": {"oid": "f9f64e4ebb147e63c89305ca6243f49d5f871e06", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/f9f64e4ebb147e63c89305ca6243f49d5f871e06", "committedDate": "2020-01-07T08:33:16Z", "message": "[#1687] Ensure response is ended if it got closed prematurely.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch-si.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MTA5MjA5", "url": "https://github.com/eclipse/hono/pull/1688#pullrequestreview-339109209", "createdAt": "2020-01-07T09:09:57Z", "commit": {"oid": "f9f64e4ebb147e63c89305ca6243f49d5f871e06"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 905, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}