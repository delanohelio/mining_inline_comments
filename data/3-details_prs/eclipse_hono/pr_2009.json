{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3MTQzOTgx", "number": 2009, "title": "[#1958]  implementation of the search devices operation for the file-based registry", "bodyText": "Follow up of issue #1995. This implementation on the search devices operations only support paging ( and it may not be consistent).\nFiltering and sorting should be implemented using databases features.\nThis is a draft PR to make sure we agree on the shape of things while I write a few integration tests \ud83d\ude03\nSigned-off-by: Jean-Baptiste Trystram jbtrystram@redhat.com", "createdAt": "2020-06-03T11:35:58Z", "url": "https://github.com/eclipse/hono/pull/2009", "merged": true, "mergeCommit": {"oid": "1e1f54d02d2dc58039e560e0f83e2ebcf8bd4b7a"}, "closed": true, "closedAt": "2020-10-02T09:50:48Z", "author": {"login": "jbtrystram"}, "timelineItems": {"totalCount": 28, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpib1SgFqTQyNjk3NjQ2OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOi18UAFqTUwMTAwMDE4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2OTc2NDY5", "url": "https://github.com/eclipse/hono/pull/2009#pullrequestreview-426976469", "createdAt": "2020-06-09T09:50:14Z", "commit": {"oid": "c1e62e98a253b4d76a8b059137e51cc513655777"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwOTo1MDoxNFrOGhBw3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDoyMzo0OVrOGhC7Cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI4NTA4Nw==", "bodyText": "The description doesn't match the intention of the method.", "url": "https://github.com/eclipse/hono/pull/2009#discussion_r437285087", "createdAt": "2020-06-09T09:50:14Z", "author": {"login": "kaniyan"}, "path": "services/device-registry-base/src/main/java/org/eclipse/hono/deviceregistry/service/device/AbstractDeviceManagementService.java", "diffHunk": "@@ -90,6 +93,22 @@ public void setTenantInformationService(final TenantInformationService tenantInf\n      */\n     protected abstract Future<Result<Void>> processDeleteDevice(DeviceKey key, Optional<String> resourceVersion, Span span);\n \n+    /**\n+     * Delete a device with a specified key.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1e62e98a253b4d76a8b059137e51cc513655777"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI4NzAxNQ==", "bodyText": "This variable is used only within this class and IMHO this could be private.", "url": "https://github.com/eclipse/hono/pull/2009#discussion_r437287015", "createdAt": "2020-06-09T09:53:30Z", "author": {"login": "kaniyan"}, "path": "services/device-registry-file/src/main/java/org/eclipse/hono/deviceregistry/file/AbstractFileBasedRegistryConfigProperties.java", "diffHunk": "@@ -26,11 +26,17 @@\n      */\n     public static final int DEFAULT_MAX_AGE_SECONDS = 180;\n \n+    /**\n+     * The default limit of results returned by the service when searching for multiples devices.\n+     */\n+    public static final int DEFAULT_PAGE_LIMIT = 30;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1e62e98a253b4d76a8b059137e51cc513655777"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI4OTkyMA==", "bodyText": "How about Optional.empty() instead of null?", "url": "https://github.com/eclipse/hono/pull/2009#discussion_r437289920", "createdAt": "2020-06-09T09:58:25Z", "author": {"login": "kaniyan"}, "path": "services/device-registry-file/src/main/java/org/eclipse/hono/deviceregistry/file/FileBasedRegistrationService.java", "diffHunk": "@@ -520,6 +522,43 @@ private JsonObject convertDevice(final String deviceId, final Device payload) {\n         return identities.computeIfAbsent(tenantId, id -> new ConcurrentHashMap<>());\n     }\n \n+    /**\n+     * Return all devices for a tenant.\n+     *\n+     * This implementation is for demo purpose, it does not support filtering and sorting.\n+     * Moreover, the order of devices cannot be guaranteed by the underlying in-memory storage\n+     * so the paging may be inconsistent.\n+     */\n+    @Override\n+    public Future<OperationResult<List<DeviceWithId>>> searchDevices(final String tenantId, final Optional<Integer> limit, final Optional<Integer> offset,\n+                                                                     final Optional<Map> sorting, final Optional<Map> filters, final Span span) {\n+\n+        final int actualLimit = limit.orElse(config.getDefaultPageLimit());\n+        final int actualOffset = offset.orElse(0);\n+\n+        return Future.succeededFuture(doSearchDevices(tenantId, actualLimit, actualOffset));\n+    }\n+\n+    private OperationResult<List<DeviceWithId>> doSearchDevices(final String tenantId, final int limit, final int offset) {\n+\n+        final Set allDevicesIds = getDevicesForTenant(tenantId).keySet();\n+        final List<DeviceWithId> devicesList = new ArrayList<>();\n+\n+        for (int i = offset; i < limit + offset; i++ ) {\n+            final String id = (String) allDevicesIds.toArray()[i];\n+            final Device device = getDevicesForTenant(tenantId).get(id).getValue();\n+            final DeviceWithId withId = DeviceWithId.fromDevice(device, id);\n+\n+            devicesList.add(withId);\n+        }\n+\n+        return OperationResult.ok(HttpURLConnection.HTTP_OK,\n+                devicesList,\n+                Optional.ofNullable(DeviceRegistryUtils.getCacheDirective(config.getCacheMaxAge())),\n+                null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1e62e98a253b4d76a8b059137e51cc513655777"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwNDA3NA==", "bodyText": "IMHO it is better if the type is also specified for the Map that holds the filters elements(e.g Optional<Map<String, String>> filters). Also please check if it is also applicable for sorting .", "url": "https://github.com/eclipse/hono/pull/2009#discussion_r437304074", "createdAt": "2020-06-09T10:23:49Z", "author": {"login": "kaniyan"}, "path": "services/device-registry-base/src/main/java/org/eclipse/hono/service/management/device/DeviceManagementService.java", "diffHunk": "@@ -106,4 +108,28 @@\n      *      Device Registry Management API - Delete Device Registration</a>\n      */\n     Future<Result<Void>> deleteDevice(String tenantId, String deviceId, Optional<String> resourceVersion, Span span);\n+\n+    /**\n+     * Gets all devices registration data by tenant ID. Optionally searchable with filters.\n+     *\n+     * @param tenantId The tenant the devices belongs to.\n+     * @param limit The maximum number of result to return.\n+     * @param offset The number of results to skip before applying the limit.\n+     * @param sorting A Map entry containing the JSON Path of a key to sort by, and the sorting method.\n+     *                If the sorting method is null, a default sort will be applied.\n+     * @param filters a Map containing the JSON Path of a key to filter by, and the value to filter with.\n+     *                If a filter key is given with a null value, it will be ignored.\n+     * @param span The active OpenTracing span for this operation. It is not to be closed in this method!\n+     *          An implementation should log (error) events on this span and it may set tags and use this span as the\n+     *          parent for any spans created in this method.\n+     * @return A future indicating the outcome of the operation.\n+     *         The <em>status code</em> is set as specified in the\n+     *         <a href=\"https://www.eclipse.org/hono/docs/api/management/#/devices/searchDevicesForTenant\">\n+     *         Device Registry Management API - Search devices for a tenant </a>\n+     * @throws NullPointerException if any of the parameters is {@code null}.\n+     * @see <a href=\"https://www.eclipse.org/hono/docs/api/management/#/devices/searchDevicesForTenant\">\n+     *      Device Registry Management API - Search devices for a tenant</a>\n+     */\n+    Future<OperationResult<List<DeviceWithId>>> searchDevices(String tenantId, Optional<Integer> limit, Optional<Integer> offset,\n+                                                              Optional<Map> sorting, Optional<Map> filters, Span span);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1e62e98a253b4d76a8b059137e51cc513655777"}, "originalPosition": 36}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "882feda40daf5f8eb391748d1c7bf76b8206dd12", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/882feda40daf5f8eb391748d1c7bf76b8206dd12", "committedDate": "2020-06-10T08:21:23Z", "message": "PR feedback\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}, "afterCommit": {"oid": "74a1ed6daf6dd29406a2e4cb0d68de1533169cc8", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/74a1ed6daf6dd29406a2e4cb0d68de1533169cc8", "committedDate": "2020-07-27T16:27:48Z", "message": "search device support work"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NTU1MTMw", "url": "https://github.com/eclipse/hono/pull/2009#pullrequestreview-456555130", "createdAt": "2020-07-28T11:51:07Z", "commit": {"oid": "74a1ed6daf6dd29406a2e4cb0d68de1533169cc8"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMTo1MTowN1rOG4I-5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMTo1Mzo0MFrOG4JDeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTUyMDYxMw==", "bodyText": "I think it would be better to combine multiple filters into a single predicate and apply it only once, rather than iterating collection multiple times. This might not be the topic for this PR, but right now we're supporting only applying all filters. By combining predicated we could support OR functionality, but this might be left for the future.", "url": "https://github.com/eclipse/hono/pull/2009#discussion_r461520613", "createdAt": "2020-07-28T11:51:07Z", "author": {"login": "dejanb"}, "path": "services/device-registry-file/src/main/java/org/eclipse/hono/deviceregistry/file/FileBasedRegistrationService.java", "diffHunk": "@@ -520,6 +526,102 @@ private JsonObject convertDevice(final String deviceId, final Device payload) {\n         return identities.computeIfAbsent(tenantId, id -> new ConcurrentHashMap<>());\n     }\n \n+    /**\n+     * Return all devices for a tenant.\n+     *\n+     * This implementation is for demo purpose, it does not support filtering and sorting.\n+     * Moreover, the order of devices cannot be guaranteed by the underlying in-memory storage\n+     * so the paging may be inconsistent.\n+     */\n+    @Override\n+    public Future<OperationResult<List<DeviceWithId>>> searchDevices(final String tenantId, final Optional<Integer> limit, final Optional<Integer> offset,\n+                                                                     final Optional<List<SortingOption>> sorting, final Optional<List<Filter>> filters, final Span span) {\n+\n+        final int actualLimit = limit.orElse(config.getDefaultPageLimit());\n+        final int actualOffset = offset.orElse(0);\n+\n+        return Future.succeededFuture(doSearchDevices(tenantId, actualLimit, actualOffset, sorting.orElse(null), filters.orElse(null)));\n+    }\n+\n+    private OperationResult<List<DeviceWithId>> doSearchDevices(final String tenantId, final int limit, final int offset,\n+                                                                final List<SortingOption> sort, final List<Filter> filters) {\n+\n+        final Set allDevicesIds = getDevicesForTenant(tenantId).keySet();\n+        List<DeviceWithId> devicesList = new ArrayList<>();\n+\n+        for (int i = offset; i < limit + offset; i++ ) {\n+            final String id = (String) allDevicesIds.toArray()[i];\n+            final Device device = getDevicesForTenant(tenantId).get(id).getValue();\n+            final DeviceWithId withId = DeviceWithId.fromDevice(device, id);\n+\n+            devicesList.add(withId);\n+        }\n+\n+        for (Filter f : filters) {\n+            devicesList = filterDeviceList(devicesList, f);\n+        }\n+\n+        for (SortingOption s : sort) {\n+            devicesList = sortDeviceList(devicesList, s);\n+        }\n+\n+        return OperationResult.ok(HttpURLConnection.HTTP_OK,\n+                devicesList,\n+                Optional.ofNullable(DeviceRegistryUtils.getCacheDirective(config.getCacheMaxAge())),\n+                Optional.empty());\n+    }\n+\n+    private List<DeviceWithId> filterDeviceList(final List<DeviceWithId> list, final Filter filter) {\n+\n+        return list\n+                .stream()\n+                .filter(buildJsonBasedPredicate(filter))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74a1ed6daf6dd29406a2e4cb0d68de1533169cc8"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTUyMTc4Ng==", "bodyText": "Same here, if we could build one comparator and then use one stream() to filter and sort that would be great.", "url": "https://github.com/eclipse/hono/pull/2009#discussion_r461521786", "createdAt": "2020-07-28T11:53:40Z", "author": {"login": "dejanb"}, "path": "services/device-registry-file/src/main/java/org/eclipse/hono/deviceregistry/file/FileBasedRegistrationService.java", "diffHunk": "@@ -520,6 +526,102 @@ private JsonObject convertDevice(final String deviceId, final Device payload) {\n         return identities.computeIfAbsent(tenantId, id -> new ConcurrentHashMap<>());\n     }\n \n+    /**\n+     * Return all devices for a tenant.\n+     *\n+     * This implementation is for demo purpose, it does not support filtering and sorting.\n+     * Moreover, the order of devices cannot be guaranteed by the underlying in-memory storage\n+     * so the paging may be inconsistent.\n+     */\n+    @Override\n+    public Future<OperationResult<List<DeviceWithId>>> searchDevices(final String tenantId, final Optional<Integer> limit, final Optional<Integer> offset,\n+                                                                     final Optional<List<SortingOption>> sorting, final Optional<List<Filter>> filters, final Span span) {\n+\n+        final int actualLimit = limit.orElse(config.getDefaultPageLimit());\n+        final int actualOffset = offset.orElse(0);\n+\n+        return Future.succeededFuture(doSearchDevices(tenantId, actualLimit, actualOffset, sorting.orElse(null), filters.orElse(null)));\n+    }\n+\n+    private OperationResult<List<DeviceWithId>> doSearchDevices(final String tenantId, final int limit, final int offset,\n+                                                                final List<SortingOption> sort, final List<Filter> filters) {\n+\n+        final Set allDevicesIds = getDevicesForTenant(tenantId).keySet();\n+        List<DeviceWithId> devicesList = new ArrayList<>();\n+\n+        for (int i = offset; i < limit + offset; i++ ) {\n+            final String id = (String) allDevicesIds.toArray()[i];\n+            final Device device = getDevicesForTenant(tenantId).get(id).getValue();\n+            final DeviceWithId withId = DeviceWithId.fromDevice(device, id);\n+\n+            devicesList.add(withId);\n+        }\n+\n+        for (Filter f : filters) {\n+            devicesList = filterDeviceList(devicesList, f);\n+        }\n+\n+        for (SortingOption s : sort) {\n+            devicesList = sortDeviceList(devicesList, s);\n+        }\n+\n+        return OperationResult.ok(HttpURLConnection.HTTP_OK,\n+                devicesList,\n+                Optional.ofNullable(DeviceRegistryUtils.getCacheDirective(config.getCacheMaxAge())),\n+                Optional.empty());\n+    }\n+\n+    private List<DeviceWithId> filterDeviceList(final List<DeviceWithId> list, final Filter filter) {\n+\n+        return list\n+                .stream()\n+                .filter(buildJsonBasedPredicate(filter))\n+                .collect(Collectors.toList());\n+    }\n+\n+    //TODO : support JSON Path\n+    // won't be supported by vertx : https://github.com/eclipse-vertx/vert.x/issues/1661\n+    private Predicate<DeviceWithId> buildJsonBasedPredicate(final Filter filter) {\n+        return deviceWithId -> {\n+            final Map<String, Object> device = JsonObject.mapFrom(deviceWithId).getMap();\n+\n+            switch (filter.getOperation()) {\n+                case eq:\n+                    return device.get(filter.getField()) == filter.getValue();\n+                default:\n+                    return true;\n+            }\n+        };\n+    }\n+\n+    private List<DeviceWithId> sortDeviceList(final List<DeviceWithId> list, final SortingOption sort) {\n+\n+        return list\n+                .stream()\n+                .sorted(buildJsonBasedComparator(sort))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74a1ed6daf6dd29406a2e4cb0d68de1533169cc8"}, "originalPosition": 106}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NTk1MDA3", "url": "https://github.com/eclipse/hono/pull/2009#pullrequestreview-456595007", "createdAt": "2020-07-28T12:47:55Z", "commit": {"oid": "794976912d2bbb9e23aecbf271d731c91bb10bc9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMjo0Nzo1NVrOG4K59g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMjo1MzoxMlrOG4LGoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU1MjExOA==", "bodyText": "Also please update this interface method as per the updated OpenAPI spec in #1995?", "url": "https://github.com/eclipse/hono/pull/2009#discussion_r461552118", "createdAt": "2020-07-28T12:47:55Z", "author": {"login": "kaniyan"}, "path": "services/device-registry-base/src/main/java/org/eclipse/hono/service/management/device/DeviceManagementService.java", "diffHunk": "@@ -106,4 +108,28 @@\n      *      Device Registry Management API - Delete Device Registration</a>\n      */\n     Future<Result<Void>> deleteDevice(String tenantId, String deviceId, Optional<String> resourceVersion, Span span);\n+\n+    /**\n+     * Gets all devices registration data by tenant ID. Optionally searchable with filters.\n+     *\n+     * @param tenantId The tenant the devices belongs to.\n+     * @param limit The maximum number of result to return.\n+     * @param offset The number of results to skip before applying the limit.\n+     * @param sorting A Map entry containing the JSON Path of a key to sort by, and the sorting method.\n+     *                If the sorting method is null, a default sort will be applied.\n+     * @param filters a Map containing the JSON Path of a key to filter by, and the value to filter with.\n+     *                If a filter key is given with a null value, it will be ignored.\n+     * @param span The active OpenTracing span for this operation. It is not to be closed in this method!\n+     *          An implementation should log (error) events on this span and it may set tags and use this span as the\n+     *          parent for any spans created in this method.\n+     * @return A future indicating the outcome of the operation.\n+     *         The <em>status code</em> is set as specified in the\n+     *         <a href=\"https://www.eclipse.org/hono/docs/api/management/#/devices/searchDevicesForTenant\">\n+     *         Device Registry Management API - Search devices for a tenant </a>\n+     * @throws NullPointerException if any of the parameters is {@code null}.\n+     * @see <a href=\"https://www.eclipse.org/hono/docs/api/management/#/devices/searchDevicesForTenant\">\n+     *      Device Registry Management API - Search devices for a tenant</a>\n+     */\n+    Future<OperationResult<List<DeviceWithId>>> searchDevices(String tenantId, Optional<Integer> limit, Optional<Integer> offset,\n+                                                              Optional<Map> sorting, Optional<Map> filters, Span span);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "794976912d2bbb9e23aecbf271d731c91bb10bc9"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU1NTM2MA==", "bodyText": "My understanding is that the searchDevices operation is not mandatory and it is also not needed for Hono to function normally. IMHO we can declare this method as default, there by the implementers of device registry APIs can decide if they would like to implement it or not. This default method could respond with http status code 501 Not Implemented.  WDYT?", "url": "https://github.com/eclipse/hono/pull/2009#discussion_r461555360", "createdAt": "2020-07-28T12:53:12Z", "author": {"login": "kaniyan"}, "path": "services/device-registry-base/src/main/java/org/eclipse/hono/service/management/device/DeviceManagementService.java", "diffHunk": "@@ -106,4 +108,28 @@\n      *      Device Registry Management API - Delete Device Registration</a>\n      */\n     Future<Result<Void>> deleteDevice(String tenantId, String deviceId, Optional<String> resourceVersion, Span span);\n+\n+    /**\n+     * Gets all devices registration data by tenant ID. Optionally searchable with filters.\n+     *\n+     * @param tenantId The tenant the devices belongs to.\n+     * @param limit The maximum number of result to return.\n+     * @param offset The number of results to skip before applying the limit.\n+     * @param sorting A Map entry containing the JSON Path of a key to sort by, and the sorting method.\n+     *                If the sorting method is null, a default sort will be applied.\n+     * @param filters a Map containing the JSON Path of a key to filter by, and the value to filter with.\n+     *                If a filter key is given with a null value, it will be ignored.\n+     * @param span The active OpenTracing span for this operation. It is not to be closed in this method!\n+     *          An implementation should log (error) events on this span and it may set tags and use this span as the\n+     *          parent for any spans created in this method.\n+     * @return A future indicating the outcome of the operation.\n+     *         The <em>status code</em> is set as specified in the\n+     *         <a href=\"https://www.eclipse.org/hono/docs/api/management/#/devices/searchDevicesForTenant\">\n+     *         Device Registry Management API - Search devices for a tenant </a>\n+     * @throws NullPointerException if any of the parameters is {@code null}.\n+     * @see <a href=\"https://www.eclipse.org/hono/docs/api/management/#/devices/searchDevicesForTenant\">\n+     *      Device Registry Management API - Search devices for a tenant</a>\n+     */\n+    Future<OperationResult<List<DeviceWithId>>> searchDevices(String tenantId, Optional<Integer> limit, Optional<Integer> offset,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "794976912d2bbb9e23aecbf271d731c91bb10bc9"}, "originalPosition": 35}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "775da138cfcfb7fc62c245f1adb90fd247d75428", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/775da138cfcfb7fc62c245f1adb90fd247d75428", "committedDate": "2020-07-28T13:37:34Z", "message": "add a default implementation returning non implemented"}, "afterCommit": {"oid": "5210671adc512ffd120b9c1f0e34fa39217c0d79", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/5210671adc512ffd120b9c1f0e34fa39217c0d79", "committedDate": "2020-07-28T13:44:40Z", "message": "add a default implementation returning non implemented"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NjgwMjUy", "url": "https://github.com/eclipse/hono/pull/2009#pullrequestreview-456680252", "createdAt": "2020-07-28T14:17:12Z", "commit": {"oid": "5210671adc512ffd120b9c1f0e34fa39217c0d79"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNDoxNzoxM1rOG4O3XQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNDoxNzoxM1rOG4O3XQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYxNjk4OQ==", "bodyText": "How about null check of the arguments as described in the JavaDoc of the searchDevices method?\n@throws NullPointerException if any of the parameters is {@code null}.", "url": "https://github.com/eclipse/hono/pull/2009#discussion_r461616989", "createdAt": "2020-07-28T14:17:13Z", "author": {"login": "kaniyan"}, "path": "services/device-registry-base/src/main/java/org/eclipse/hono/service/management/device/DeviceManagementService.java", "diffHunk": "@@ -129,6 +131,11 @@\n      * @see <a href=\"https://www.eclipse.org/hono/docs/api/management/#/devices/searchDevicesForTenant\">\n      *      Device Registry Management API - Search devices for a tenant</a>\n      */\n-    Future<OperationResult<List<DeviceWithId>>> searchDevices(String tenantId, Optional<Integer> limit, Optional<Integer> offset,\n-                                                              Optional<List<SortingOption>> sorting, Optional<List<Filter>> filters, Span span);\n+    default Future<OperationResult<List<DeviceWithId>>> searchDevices(String tenantId, Optional<Integer> limit, Optional<Integer> offset,\n+                                                              Optional<List<SortingOption>> sorting, Optional<List<Filter>> filters, Span span) {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5210671adc512ffd120b9c1f0e34fa39217c0d79"}, "originalPosition": 24}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "abf27c9753cfba3ffff27e264b569ef960236466", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/abf27c9753cfba3ffff27e264b569ef960236466", "committedDate": "2020-07-31T13:20:59Z", "message": "add check for limit size to not exceed configured max value"}, "afterCommit": {"oid": "b46dd99f6c31f3cc44d5207a067ae03841a71c85", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/b46dd99f6c31f3cc44d5207a067ae03841a71c85", "committedDate": "2020-08-07T14:41:11Z", "message": "add check for limit size to not exceed configured max value"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzOTc3MzMx", "url": "https://github.com/eclipse/hono/pull/2009#pullrequestreview-463977331", "createdAt": "2020-08-10T06:18:52Z", "commit": {"oid": "b46dd99f6c31f3cc44d5207a067ae03841a71c85"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwNjoxODo1MlrOG-CeCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwNjo0MTo0MlrOG-C5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcwNTM1NA==", "bodyText": "I can only see a List but no Map here ...\nJSON Pointer?", "url": "https://github.com/eclipse/hono/pull/2009#discussion_r467705354", "createdAt": "2020-08-10T06:18:52Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-base/src/main/java/org/eclipse/hono/deviceregistry/service/device/AbstractDeviceManagementService.java", "diffHunk": "@@ -90,6 +94,22 @@ public void setTenantInformationService(final TenantInformationService tenantInf\n      */\n     protected abstract Future<Result<Void>> processDeleteDevice(DeviceKey key, Optional<String> resourceVersion, Span span);\n \n+    /**\n+     * Search for the devices optionally using filters and sort options.\n+     *\n+     * @param tenantId The tenantID.\n+     * @param limit The maximum number of result to return.\n+     * @param offset The number of results to skip before applying the limit.\n+     * @param sorting A Map entry containing the JSON Path of a key to sort by, and the sorting method.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b46dd99f6c31f3cc44d5207a067ae03841a71c85"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcwNTgwNQ==", "bodyText": "List? JSON Pointer?", "url": "https://github.com/eclipse/hono/pull/2009#discussion_r467705805", "createdAt": "2020-08-10T06:20:22Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-base/src/main/java/org/eclipse/hono/deviceregistry/service/device/AbstractDeviceManagementService.java", "diffHunk": "@@ -90,6 +94,22 @@ public void setTenantInformationService(final TenantInformationService tenantInf\n      */\n     protected abstract Future<Result<Void>> processDeleteDevice(DeviceKey key, Optional<String> resourceVersion, Span span);\n \n+    /**\n+     * Search for the devices optionally using filters and sort options.\n+     *\n+     * @param tenantId The tenantID.\n+     * @param limit The maximum number of result to return.\n+     * @param offset The number of results to skip before applying the limit.\n+     * @param sorting A Map entry containing the JSON Path of a key to sort by, and the sorting method.\n+     *                If the sorting method is null, a default sort will be applied.\n+     * @param filters a Map containing the JSON Path of a key to filter by, and the value to filter with.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b46dd99f6c31f3cc44d5207a067ae03841a71c85"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcwNzAwMg==", "bodyText": "I have just now realized that we are using a GET request with a request body (containing the query params). This is commonly considered bad practice for RESTful APIs. One of the reasons being that standard HTTP infrastructure like proxies will often not consider the body of a GET request and might return a cached response which has been created for a different set of query params.\nThe common advice is to either use POST instead or encode the search criteria in URI query params. The latter approach is used by most GET based APIs of common services AFAIK.\nSince the POST /tenantID resource is already in use we might want to consider using query params instead.\nSome references:\nhttps://stackoverflow.com/questions/978061/http-get-with-request-body\nhttps://softwareengineering.stackexchange.com/questions/372664/use-case-of-http-get-request-with-a-body\nHere's one which explicitly proposes a design for a search API:\nhttps://stackoverflow.blog/2020/03/02/best-practices-for-rest-api-design/\n@dejanb @ctron @calohmn WDYT?", "url": "https://github.com/eclipse/hono/pull/2009#discussion_r467707002", "createdAt": "2020-08-10T06:24:32Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-base/src/main/java/org/eclipse/hono/service/management/device/DelegatingDeviceManagementHttpEndpoint.java", "diffHunk": "@@ -101,6 +105,11 @@ public void addRoutes(final Router router) {\n         router.get(pathWithTenantAndDeviceId)\n                 .handler(this::doGetDevice);\n \n+        //GET devices for tenant\n+        router.get(pathWithTenant)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b46dd99f6c31f3cc44d5207a067ae03841a71c85"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcwODI0MQ==", "bodyText": "there is no Map here, just Lists AFAIC\nJSON Pointer ...", "url": "https://github.com/eclipse/hono/pull/2009#discussion_r467708241", "createdAt": "2020-08-10T06:28:56Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-base/src/main/java/org/eclipse/hono/service/management/device/DeviceManagementService.java", "diffHunk": "@@ -106,4 +110,42 @@\n      *      Device Registry Management API - Delete Device Registration</a>\n      */\n     Future<Result<Void>> deleteDevice(String tenantId, String deviceId, Optional<String> resourceVersion, Span span);\n+\n+    /**\n+     * Gets all devices registration data by tenant ID. Optionally searchable with filters.\n+     * As this method is optional to support for implementations the default implementation will respond\n+     * with http status code: 501 Not Implemented.\n+     *\n+     * @param tenantId The tenant the devices belongs to.\n+     * @param limit The maximum number of result to return.\n+     * @param offset The number of results to skip before applying the limit.\n+     * @param sorting A Map entry containing the JSON Path of a key to sort by, and the sorting method.\n+     *                If the sorting method is null, a default sort will be applied.\n+     * @param filters a Map containing the JSON Path of a key to filter by, and the value to filter with.\n+     *                If a filter key is given with a null value, it will be ignored.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b46dd99f6c31f3cc44d5207a067ae03841a71c85"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcxMjExOA==", "bodyText": "FMPOV the expected order of applying the sorting and filtering is this:\n\napply the filter on the set of all devices\nsort the selected elements according to the sorting criteria\nreturn the requested subset according to the paging options\n\nOtherwise, you might get back less objects than requested, if fewer objects in the page match the filtering criteria ...", "url": "https://github.com/eclipse/hono/pull/2009#discussion_r467712118", "createdAt": "2020-08-10T06:41:05Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-file/src/main/java/org/eclipse/hono/deviceregistry/file/FileBasedRegistrationService.java", "diffHunk": "@@ -520,6 +527,108 @@ private JsonObject convertDevice(final String deviceId, final Device payload) {\n         return identities.computeIfAbsent(tenantId, id -> new ConcurrentHashMap<>());\n     }\n \n+    /**\n+     * Return all devices for a tenant.\n+     *\n+     * This implementation is for demo purpose, it does not support filtering and sorting.\n+     * Moreover, the order of devices cannot be guaranteed by the underlying in-memory storage\n+     * so the paging may be inconsistent.\n+     */\n+    @Override\n+    public Future<OperationResult<List<DeviceWithId>>> searchDevices(final String tenantId, final Optional<Integer> limit, final Optional<Integer> offset,\n+                                                                     final Optional<List<SortingOption>> sorting, final Optional<List<Filter>> filters, final Span span) {\n+        final int actualLimit = limit.map(l -> {\n+            if (l > config.getMaxPageLimit()) {\n+              return config.getMaxPageLimit();\n+            } else {\n+              return l;\n+            }\n+        }).orElse(config.getDefaultPageLimit());\n+        final int actualOffset = offset.orElse(0);\n+\n+        return Future.succeededFuture(doSearchDevices(tenantId, actualLimit, actualOffset, sorting.orElse(Collections.EMPTY_LIST), filters.orElse(Collections.EMPTY_LIST)));\n+    }\n+\n+    private OperationResult<List<DeviceWithId>> doSearchDevices(final String tenantId, final int limit, final int offset,\n+                                                                final List<SortingOption> sort, final List<Filter> filters) {\n+\n+        final Set allDevicesIds = getDevicesForTenant(tenantId).keySet();\n+        List<DeviceWithId> devicesList = new ArrayList<>();\n+\n+        for (int i = offset; i < allDevicesIds.size() && devicesList.size() < limit; i++) {\n+            final String id = (String) allDevicesIds.toArray()[i];\n+            final Device device = getDevicesForTenant(tenantId).get(id).getValue();\n+            final DeviceWithId withId = DeviceWithId.fromDevice(device, id);\n+\n+            devicesList.add(withId);\n+        }\n+\n+        final List<Predicate<DeviceWithId>> predicates = new ArrayList<>();\n+        for (Filter f : filters) {\n+            predicates.add(buildJsonBasedPredicate(f));\n+        }\n+\n+        //Regroup predicates in a single one with AND.\n+        final Predicate<DeviceWithId> predicate = predicates.stream()\n+                .reduce(x -> true, Predicate::and);\n+\n+        // filter the list\n+        devicesList = devicesList\n+                .stream()\n+                .filter(predicate)\n+                .collect(Collectors.toList());\n+\n+        for (SortingOption s : sort) {\n+            devicesList = sortDeviceList(devicesList, s);\n+        }\n+\n+        return OperationResult.ok(HttpURLConnection.HTTP_OK,\n+                devicesList,\n+                Optional.ofNullable(DeviceRegistryUtils.getCacheDirective(config.getCacheMaxAge())),\n+                Optional.empty());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b46dd99f6c31f3cc44d5207a067ae03841a71c85"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcxMjMxMw==", "bodyText": "?", "url": "https://github.com/eclipse/hono/pull/2009#discussion_r467712313", "createdAt": "2020-08-10T06:41:42Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDbBasedDeviceBackend.java", "diffHunk": "@@ -125,6 +125,7 @@ public MongoDbBasedDeviceBackend(\n         return registrationService.updateDevice(tenantId, deviceId, device, resourceVersion, span);\n     }\n \n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b46dd99f6c31f3cc44d5207a067ae03841a71c85"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NjcxNjg2", "url": "https://github.com/eclipse/hono/pull/2009#pullrequestreview-465671686", "createdAt": "2020-08-12T07:50:51Z", "commit": {"oid": "b46dd99f6c31f3cc44d5207a067ae03841a71c85"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwNzo1MDo1MVrOG_V4BA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwNzo1NTowMFrOG_WA4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA3MTg3Ng==", "bodyText": "I do not think that you want to be able to change the identifier after the instance has been created, do you?", "url": "https://github.com/eclipse/hono/pull/2009#discussion_r469071876", "createdAt": "2020-08-12T07:50:51Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-base/src/main/java/org/eclipse/hono/service/management/device/DeviceWithId.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*******************************************************************************\n+ * Copyright (c) 2019, 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+\n+package org.eclipse.hono.service.management.device;\n+\n+import org.eclipse.hono.util.RegistryManagementConstants;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonInclude.Include;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+\n+/**\n+ * Device Information.\n+ */\n+@JsonInclude(value = Include.NON_NULL)\n+public class DeviceWithId extends Device {\n+\n+    @JsonProperty(RegistryManagementConstants.FIELD_PAYLOAD_DEVICE_ID)\n+    private String deviceId;\n+\n+    private DeviceWithId(final Device device, final String id) {\n+        super(device);\n+        setDeviceId(id);\n+    }\n+\n+    /**\n+     * Creates a new DeviceWithId instance.\n+     */\n+    public DeviceWithId() {\n+    }\n+\n+    /**\n+     * Creates a new DeviceWithId instance from a Device object, adding the Id.\n+     *\n+     * @param device The Device object.\n+     * @param id the device Id as a string.\n+     * @return a deviceWithId object.\n+     */\n+    public static DeviceWithId fromDevice(final Device device, final String id) {\n+\n+        return new DeviceWithId(device, id);\n+    }\n+\n+    /**\n+     * Set the device Id for this device.\n+     *\n+     * @param deviceId The resource ID for this device.\n+     * @return A reference to this for fluent use.\n+     */\n+    public DeviceWithId setDeviceId(final String deviceId) {\n+        this.deviceId = deviceId;\n+        return this;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b46dd99f6c31f3cc44d5207a067ae03841a71c85"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA3MTk1Ng==", "bodyText": "final?", "url": "https://github.com/eclipse/hono/pull/2009#discussion_r469071956", "createdAt": "2020-08-12T07:51:01Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-base/src/main/java/org/eclipse/hono/service/management/device/DeviceWithId.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*******************************************************************************\n+ * Copyright (c) 2019, 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+\n+package org.eclipse.hono.service.management.device;\n+\n+import org.eclipse.hono.util.RegistryManagementConstants;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonInclude.Include;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+\n+/**\n+ * Device Information.\n+ */\n+@JsonInclude(value = Include.NON_NULL)\n+public class DeviceWithId extends Device {\n+\n+    @JsonProperty(RegistryManagementConstants.FIELD_PAYLOAD_DEVICE_ID)\n+    private String deviceId;\n+\n+    private DeviceWithId(final Device device, final String id) {\n+        super(device);\n+        setDeviceId(id);\n+    }\n+\n+    /**\n+     * Creates a new DeviceWithId instance.\n+     */\n+    public DeviceWithId() {\n+    }\n+\n+    /**\n+     * Creates a new DeviceWithId instance from a Device object, adding the Id.\n+     *\n+     * @param device The Device object.\n+     * @param id the device Id as a string.\n+     * @return a deviceWithId object.\n+     */\n+    public static DeviceWithId fromDevice(final Device device, final String id) {\n+\n+        return new DeviceWithId(device, id);\n+    }\n+\n+    /**\n+     * Set the device Id for this device.\n+     *\n+     * @param deviceId The resource ID for this device.\n+     * @return A reference to this for fluent use.\n+     */\n+    public DeviceWithId setDeviceId(final String deviceId) {\n+        this.deviceId = deviceId;\n+        return this;\n+    }\n+\n+    /**\n+     * Get the device Id for this device.\n+     *\n+     * @return A string containing the deviceID.\n+     */\n+    @JsonIgnore\n+    public String getDeviceId() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b46dd99f6c31f3cc44d5207a067ae03841a71c85"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA3Mzk5Mw==", "bodyText": "If I am not mistaken then you are returning DeviceWithId instances to the client which include the device identifier. However, the OpenAPI spec defines the returned result as an array of Device objects which do not contain an ID.", "url": "https://github.com/eclipse/hono/pull/2009#discussion_r469073993", "createdAt": "2020-08-12T07:54:48Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-file/src/main/java/org/eclipse/hono/deviceregistry/file/FileBasedRegistrationService.java", "diffHunk": "@@ -520,6 +527,108 @@ private JsonObject convertDevice(final String deviceId, final Device payload) {\n         return identities.computeIfAbsent(tenantId, id -> new ConcurrentHashMap<>());\n     }\n \n+    /**\n+     * Return all devices for a tenant.\n+     *\n+     * This implementation is for demo purpose, it does not support filtering and sorting.\n+     * Moreover, the order of devices cannot be guaranteed by the underlying in-memory storage\n+     * so the paging may be inconsistent.\n+     */\n+    @Override\n+    public Future<OperationResult<List<DeviceWithId>>> searchDevices(final String tenantId, final Optional<Integer> limit, final Optional<Integer> offset,\n+                                                                     final Optional<List<SortingOption>> sorting, final Optional<List<Filter>> filters, final Span span) {\n+        final int actualLimit = limit.map(l -> {\n+            if (l > config.getMaxPageLimit()) {\n+              return config.getMaxPageLimit();\n+            } else {\n+              return l;\n+            }\n+        }).orElse(config.getDefaultPageLimit());\n+        final int actualOffset = offset.orElse(0);\n+\n+        return Future.succeededFuture(doSearchDevices(tenantId, actualLimit, actualOffset, sorting.orElse(Collections.EMPTY_LIST), filters.orElse(Collections.EMPTY_LIST)));\n+    }\n+\n+    private OperationResult<List<DeviceWithId>> doSearchDevices(final String tenantId, final int limit, final int offset,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b46dd99f6c31f3cc44d5207a067ae03841a71c85"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA3NDE0Nw==", "bodyText": "Is this still true?", "url": "https://github.com/eclipse/hono/pull/2009#discussion_r469074147", "createdAt": "2020-08-12T07:55:00Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-file/src/main/java/org/eclipse/hono/deviceregistry/file/FileBasedRegistrationService.java", "diffHunk": "@@ -520,6 +527,108 @@ private JsonObject convertDevice(final String deviceId, final Device payload) {\n         return identities.computeIfAbsent(tenantId, id -> new ConcurrentHashMap<>());\n     }\n \n+    /**\n+     * Return all devices for a tenant.\n+     *\n+     * This implementation is for demo purpose, it does not support filtering and sorting.\n+     * Moreover, the order of devices cannot be guaranteed by the underlying in-memory storage\n+     * so the paging may be inconsistent.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b46dd99f6c31f3cc44d5207a067ae03841a71c85"}, "originalPosition": 40}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b46dd99f6c31f3cc44d5207a067ae03841a71c85", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/b46dd99f6c31f3cc44d5207a067ae03841a71c85", "committedDate": "2020-08-07T14:41:11Z", "message": "add check for limit size to not exceed configured max value"}, "afterCommit": {"oid": "9f4daba776d1a453e189d55a5412b6565406c3e1", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/9f4daba776d1a453e189d55a5412b6565406c3e1", "committedDate": "2020-09-03T15:10:50Z", "message": "align file based search devices implem to base classes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyNTUyODQ2", "url": "https://github.com/eclipse/hono/pull/2009#pullrequestreview-482552846", "createdAt": "2020-09-04T10:49:19Z", "commit": {"oid": "9f4daba776d1a453e189d55a5412b6565406c3e1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxMDo0OToxOVrOHNJABA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxMDo0OToxOVrOHNJABA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU0MDk5Ng==", "bodyText": "Could you please rebase again with the master? searchDevices(...) doesn't return List<DeviceWithId> anymore rather SearchDevicesResult.", "url": "https://github.com/eclipse/hono/pull/2009#discussion_r483540996", "createdAt": "2020-09-04T10:49:19Z", "author": {"login": "kaniyan"}, "path": "services/device-registry-file/src/main/java/org/eclipse/hono/deviceregistry/file/FileBasedDeviceBackend.java", "diffHunk": "@@ -175,9 +175,8 @@ public FileBasedDeviceBackend(\n     }\n \n     @Override\n-    public Future<OperationResult<List<DeviceWithId>>> searchDevices(final String tenantId, final Optional<Integer> limit,\n-                                                                     final Optional<Integer> offset, final Optional<List<SortingOption>> sorting, final Optional<List<Filter>> filters, final Span span) {\n-        return registrationService.searchDevices(tenantId, limit, offset, sorting, filters, span);\n+    public Future<OperationResult<List<DeviceWithId>>> searchDevices(final String tenantId, final int pageSize, final int pageOffset, final List<Filter> filters, final List<Sort> sortOptions, final Span span) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f4daba776d1a453e189d55a5412b6565406c3e1"}, "originalPosition": 16}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9f4daba776d1a453e189d55a5412b6565406c3e1", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/9f4daba776d1a453e189d55a5412b6565406c3e1", "committedDate": "2020-09-03T15:10:50Z", "message": "align file based search devices implem to base classes"}, "afterCommit": {"oid": "b9718a4a65d77e9931e677377c6f621fcb96d554", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/b9718a4a65d77e9931e677377c6f621fcb96d554", "committedDate": "2020-09-07T13:06:04Z", "message": "align file based search devices implem to base classes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b9718a4a65d77e9931e677377c6f621fcb96d554", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/b9718a4a65d77e9931e677377c6f621fcb96d554", "committedDate": "2020-09-07T13:06:04Z", "message": "align file based search devices implem to base classes"}, "afterCommit": {"oid": "7f65b8b04fe51d54c3f08dd7fb5ee4d105ab7783", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/7f65b8b04fe51d54c3f08dd7fb5ee4d105ab7783", "committedDate": "2020-09-07T13:13:07Z", "message": "[#1958] Follow up of issue #1995. Add a preliminary implementation of the search devices operation for the file-based registry, with paging support only.\nFiltering and sorting should be implemented using databases features.\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7f65b8b04fe51d54c3f08dd7fb5ee4d105ab7783", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/7f65b8b04fe51d54c3f08dd7fb5ee4d105ab7783", "committedDate": "2020-09-07T13:13:07Z", "message": "[#1958] Follow up of issue #1995. Add a preliminary implementation of the search devices operation for the file-based registry, with paging support only.\nFiltering and sorting should be implemented using databases features.\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}, "afterCommit": {"oid": "de3eb978d86a929782db0829122478f6370cce48", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/de3eb978d86a929782db0829122478f6370cce48", "committedDate": "2020-09-07T13:13:57Z", "message": "[#1958] Follow up of issue #1995. Add a preliminary implementation of the search devices operation for the file-based registry, with paging support only.\nFiltering and sorting should be implemented using databases features.\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzOTk2NDMy", "url": "https://github.com/eclipse/hono/pull/2009#pullrequestreview-483996432", "createdAt": "2020-09-08T10:19:49Z", "commit": {"oid": "de3eb978d86a929782db0829122478f6370cce48"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMDoxOTo0OVrOHOWeYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMDoyMTo0MVrOHOWiPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgxMDMzNw==", "bodyText": "IMHO it doesn't return all devices for a tenant. The JavaDoc from the parent class could be well reused by using {@inheritdoc} and then adding your additional comment regarding in-memory storage and paging inconsistency.", "url": "https://github.com/eclipse/hono/pull/2009#discussion_r484810337", "createdAt": "2020-09-08T10:19:49Z", "author": {"login": "kaniyan"}, "path": "services/device-registry-file/src/main/java/org/eclipse/hono/deviceregistry/file/FileBasedRegistrationService.java", "diffHunk": "@@ -520,6 +527,120 @@ private JsonObject convertDevice(final String deviceId, final Device payload) {\n         return identities.computeIfAbsent(tenantId, id -> new ConcurrentHashMap<>());\n     }\n \n+    /**\n+     * Return all devices for a tenant.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de3eb978d86a929782db0829122478f6370cce48"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgxMTMyNA==", "bodyText": "How about Set<String>?", "url": "https://github.com/eclipse/hono/pull/2009#discussion_r484811324", "createdAt": "2020-09-08T10:21:41Z", "author": {"login": "kaniyan"}, "path": "services/device-registry-file/src/main/java/org/eclipse/hono/deviceregistry/file/FileBasedRegistrationService.java", "diffHunk": "@@ -520,6 +527,120 @@ private JsonObject convertDevice(final String deviceId, final Device payload) {\n         return identities.computeIfAbsent(tenantId, id -> new ConcurrentHashMap<>());\n     }\n \n+    /**\n+     * Return all devices for a tenant.\n+     *\n+     * The order of devices cannot be guaranteed by the underlying in-memory storage\n+     * so the paging may be inconsistent.\n+     */\n+    @Override\n+    public Future<OperationResult<SearchDevicesResult>> searchDevices(final String tenantId, final int pageSize, final int pageOffset,\n+                                                                       final List<Filter> filters, final List<Sort> sortOptions, final Span span) {\n+\n+        final Set allDevicesIds = getDevicesForTenant(tenantId).keySet();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de3eb978d86a929782db0829122478f6370cce48"}, "originalPosition": 45}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "20b9b5451badb64f3f4a4407bdda0a28dce3d806", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/20b9b5451badb64f3f4a4407bdda0a28dce3d806", "committedDate": "2020-09-08T13:15:50Z", "message": "add unit tests and enable integration tests for add search devices operation\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}, "afterCommit": {"oid": "8ca9c1d1e0ee3a47b56512277f93e158e029e87a", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/8ca9c1d1e0ee3a47b56512277f93e158e029e87a", "committedDate": "2020-09-08T13:23:45Z", "message": "add unit tests and enable integration tests for add search devices operation\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0MjA3NTY3", "url": "https://github.com/eclipse/hono/pull/2009#pullrequestreview-484207567", "createdAt": "2020-09-08T14:37:54Z", "commit": {"oid": "531c11fee80ee6ff99bcdc4a86f291af0caa0d61"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNDozNzo1NFrOHOgWJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNDozNzo1NFrOHOgWJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk3MjA3MQ==", "bodyText": "pageOffset corresponds to pages and not the place holder of the result in resultset. I think here it should be int i = pageOffset*PageSize+1. Eg. When the pageSize is set to 10 and pageOffset to 2, the result should start with 21st device in the resultset and not 2nd.", "url": "https://github.com/eclipse/hono/pull/2009#discussion_r484972071", "createdAt": "2020-09-08T14:37:54Z", "author": {"login": "kaniyan"}, "path": "services/device-registry-file/src/main/java/org/eclipse/hono/deviceregistry/file/FileBasedRegistrationService.java", "diffHunk": "@@ -520,6 +527,120 @@ private JsonObject convertDevice(final String deviceId, final Device payload) {\n         return identities.computeIfAbsent(tenantId, id -> new ConcurrentHashMap<>());\n     }\n \n+    /**\n+     * Return all devices for a tenant.\n+     *\n+     * The order of devices cannot be guaranteed by the underlying in-memory storage\n+     * so the paging may be inconsistent.\n+     */\n+    @Override\n+    public Future<OperationResult<SearchDevicesResult>> searchDevices(final String tenantId, final int pageSize, final int pageOffset,\n+                                                                       final List<Filter> filters, final List<Sort> sortOptions, final Span span) {\n+\n+        final Set allDevicesIds = getDevicesForTenant(tenantId).keySet();\n+        List<DeviceWithId> devicesList = new ArrayList<>();\n+\n+        for (int i = 0; i < allDevicesIds.size(); i++) {\n+            final String id = (String) allDevicesIds.toArray()[i];\n+            final Device device = getDevicesForTenant(tenantId).get(id).getValue();\n+            final DeviceWithId withId = DeviceWithId.from(id, device);\n+\n+            devicesList.add(withId);\n+        }\n+\n+        final List<Predicate<DeviceWithId>> predicates = new ArrayList<>();\n+        for (Filter f : filters) {\n+            predicates.add(buildJsonBasedPredicate(f));\n+        }\n+\n+        //Regroup predicates in a single one with AND.\n+        final Predicate<DeviceWithId> predicate = predicates.stream()\n+                .reduce(x -> true, Predicate::and);\n+\n+        // 1. apply the filter options to the list\n+        devicesList = devicesList\n+                .stream()\n+                .filter(predicate)\n+                .collect(Collectors.toList());\n+\n+        // 2. sort the selected elements\n+        for (Sort s : sortOptions) {\n+            devicesList = sortDeviceList(devicesList, s);\n+        }\n+\n+        // 3. limit the results according to the page settings.\n+        final List<DeviceWithId> returnDevicesList = new ArrayList<>();\n+\n+        for (int i = pageOffset; i < devicesList.size() && returnDevicesList.size() < pageSize; i++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "531c11fee80ee6ff99bcdc4a86f291af0caa0d61"}, "originalPosition": 79}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0MjM0MTEw", "url": "https://github.com/eclipse/hono/pull/2009#pullrequestreview-484234110", "createdAt": "2020-09-08T15:03:15Z", "commit": {"oid": "531c11fee80ee6ff99bcdc4a86f291af0caa0d61"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNTowMzoxNVrOHOhl6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNTowMzoxNVrOHOhl6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk5MjQ5MQ==", "bodyText": "As per the spec, if none of the devices are matched, then 404 should be returned.", "url": "https://github.com/eclipse/hono/pull/2009#discussion_r484992491", "createdAt": "2020-09-08T15:03:15Z", "author": {"login": "kaniyan"}, "path": "services/device-registry-file/src/main/java/org/eclipse/hono/deviceregistry/file/FileBasedRegistrationService.java", "diffHunk": "@@ -520,6 +527,120 @@ private JsonObject convertDevice(final String deviceId, final Device payload) {\n         return identities.computeIfAbsent(tenantId, id -> new ConcurrentHashMap<>());\n     }\n \n+    /**\n+     * Return all devices for a tenant.\n+     *\n+     * The order of devices cannot be guaranteed by the underlying in-memory storage\n+     * so the paging may be inconsistent.\n+     */\n+    @Override\n+    public Future<OperationResult<SearchDevicesResult>> searchDevices(final String tenantId, final int pageSize, final int pageOffset,\n+                                                                       final List<Filter> filters, final List<Sort> sortOptions, final Span span) {\n+\n+        final Set allDevicesIds = getDevicesForTenant(tenantId).keySet();\n+        List<DeviceWithId> devicesList = new ArrayList<>();\n+\n+        for (int i = 0; i < allDevicesIds.size(); i++) {\n+            final String id = (String) allDevicesIds.toArray()[i];\n+            final Device device = getDevicesForTenant(tenantId).get(id).getValue();\n+            final DeviceWithId withId = DeviceWithId.from(id, device);\n+\n+            devicesList.add(withId);\n+        }\n+\n+        final List<Predicate<DeviceWithId>> predicates = new ArrayList<>();\n+        for (Filter f : filters) {\n+            predicates.add(buildJsonBasedPredicate(f));\n+        }\n+\n+        //Regroup predicates in a single one with AND.\n+        final Predicate<DeviceWithId> predicate = predicates.stream()\n+                .reduce(x -> true, Predicate::and);\n+\n+        // 1. apply the filter options to the list\n+        devicesList = devicesList\n+                .stream()\n+                .filter(predicate)\n+                .collect(Collectors.toList());\n+\n+        // 2. sort the selected elements\n+        for (Sort s : sortOptions) {\n+            devicesList = sortDeviceList(devicesList, s);\n+        }\n+\n+        // 3. limit the results according to the page settings.\n+        final List<DeviceWithId> returnDevicesList = new ArrayList<>();\n+\n+        for (int i = pageOffset; i < devicesList.size() && returnDevicesList.size() < pageSize; i++) {\n+            returnDevicesList.add(devicesList.get(i));\n+        }\n+\n+        return Future.succeededFuture(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "531c11fee80ee6ff99bcdc4a86f291af0caa0d61"}, "originalPosition": 83}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8ca9c1d1e0ee3a47b56512277f93e158e029e87a", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/8ca9c1d1e0ee3a47b56512277f93e158e029e87a", "committedDate": "2020-09-08T13:23:45Z", "message": "add unit tests and enable integration tests for add search devices operation\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}, "afterCommit": {"oid": "a02a8e60fa16822b71893441023a48b5d79737fe", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/a02a8e60fa16822b71893441023a48b5d79737fe", "committedDate": "2020-09-11T12:47:43Z", "message": "add unit tests and enable integration tests for add search devices operation\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a02a8e60fa16822b71893441023a48b5d79737fe", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/a02a8e60fa16822b71893441023a48b5d79737fe", "committedDate": "2020-09-11T12:47:43Z", "message": "add unit tests and enable integration tests for add search devices operation\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}, "afterCommit": {"oid": "ab06c3dac4226772fc608b13941cc8ed2da0e966", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/ab06c3dac4226772fc608b13941cc8ed2da0e966", "committedDate": "2020-09-11T12:49:41Z", "message": "add unit tests and enable integration tests for add search devices operation\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab06c3dac4226772fc608b13941cc8ed2da0e966", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/ab06c3dac4226772fc608b13941cc8ed2da0e966", "committedDate": "2020-09-11T12:49:41Z", "message": "add unit tests and enable integration tests for add search devices operation\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}, "afterCommit": {"oid": "2fd9242ff4b7ff372a520e32fafee14307f36f1b", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/2fd9242ff4b7ff372a520e32fafee14307f36f1b", "committedDate": "2020-09-11T12:50:51Z", "message": "[#1958] Follow up of issue #1995. Add an implementation of the search devices operation for the file-based registry.\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4ODMyMjY3", "url": "https://github.com/eclipse/hono/pull/2009#pullrequestreview-488832267", "createdAt": "2020-09-15T15:56:37Z", "commit": {"oid": "2fd9242ff4b7ff372a520e32fafee14307f36f1b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxNTo1NjozN1rOHSIyBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxNTo1NjozN1rOHSIyBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc4MDI5NQ==", "bodyText": "testContext is not being set to complete properly. It is one of the reasons for the tests failure.\nThis can be removed as it is not being used insde the setup(...) method.", "url": "https://github.com/eclipse/hono/pull/2009#discussion_r488780295", "createdAt": "2020-09-15T15:56:37Z", "author": {"login": "kaniyan"}, "path": "services/device-registry-file/src/test/java/org/eclipse/hono/deviceregistry/file/FileBasedDeviceManagementSearchDevicesTest.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*****************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.hono.deviceregistry.file;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import java.net.HttpURLConnection;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.hono.deviceregistry.util.DeviceRegistryUtils;\n+import org.eclipse.hono.service.management.device.AbstractDeviceManagementSearchDevicesTest;\n+import org.eclipse.hono.service.management.device.Device;\n+import org.eclipse.hono.service.management.device.DeviceManagementService;\n+import org.eclipse.hono.service.management.device.Filter;\n+import org.eclipse.hono.service.management.device.SearchDevicesResult;\n+import org.eclipse.hono.service.management.device.Sort;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInfo;\n+import org.junit.jupiter.api.TestInstance;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import io.opentracing.Span;\n+import io.opentracing.noop.NoopSpan;\n+import io.vertx.core.Vertx;\n+import io.vertx.core.file.FileSystem;\n+import io.vertx.junit5.Timeout;\n+import io.vertx.junit5.VertxExtension;\n+import io.vertx.junit5.VertxTestContext;\n+\n+/**\n+ * Tests for {@link FileBasedRegistrationService#searchDevices(String, int, int, List, List, Span)}.\n+ */\n+@ExtendWith(VertxExtension.class)\n+@TestInstance(TestInstance.Lifecycle.PER_CLASS)\n+@Timeout(value = 5, timeUnit = TimeUnit.SECONDS)\n+public final class FileBasedDeviceManagementSearchDevicesTest implements AbstractDeviceManagementSearchDevicesTest {\n+\n+    private static final String FILE_NAME = \"/device-identities.json\";\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(FileBasedDeviceManagementSearchDevicesTest.class);\n+    private Vertx vertx;\n+    private FileBasedRegistrationService registrationService;\n+    private FileBasedRegistrationConfigProperties registrationConfig;\n+    private FileSystem fileSystem;\n+\n+    /**\n+     * Sets up static fixture.\n+     *\n+     * @param testContext The test context to use for running asynchronous tests.\n+     */\n+    @BeforeAll\n+    public void setup(final VertxTestContext testContext) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fd9242ff4b7ff372a520e32fafee14307f36f1b"}, "originalPosition": 71}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2fd9242ff4b7ff372a520e32fafee14307f36f1b", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/2fd9242ff4b7ff372a520e32fafee14307f36f1b", "committedDate": "2020-09-11T12:50:51Z", "message": "[#1958] Follow up of issue #1995. Add an implementation of the search devices operation for the file-based registry.\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}, "afterCommit": {"oid": "3ff594334536af49ef8a927f272381308b4aa102", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/3ff594334536af49ef8a927f272381308b4aa102", "committedDate": "2020-09-18T08:19:49Z", "message": "[#1958] Follow up of issue #1995. Add an implementation of the search devices operation for the file-based registry.\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3ff594334536af49ef8a927f272381308b4aa102", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/3ff594334536af49ef8a927f272381308b4aa102", "committedDate": "2020-09-18T08:19:49Z", "message": "[#1958] Follow up of issue #1995. Add an implementation of the search devices operation for the file-based registry.\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}, "afterCommit": {"oid": "f3e1dc410afcbe3f64e6c0a611e03f64777124ad", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/f3e1dc410afcbe3f64e6c0a611e03f64777124ad", "committedDate": "2020-09-21T12:06:19Z", "message": "[#1958] Follow up of issue #1995. Add an implementation of the search devices operation for the file-based registry.\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f3e1dc410afcbe3f64e6c0a611e03f64777124ad", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/f3e1dc410afcbe3f64e6c0a611e03f64777124ad", "committedDate": "2020-09-21T12:06:19Z", "message": "[#1958] Follow up of issue #1995. Add an implementation of the search devices operation for the file-based registry.\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}, "afterCommit": {"oid": "ae04ac052e36f6433bc3493ebeba43ea702f1c22", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/ae04ac052e36f6433bc3493ebeba43ea702f1c22", "committedDate": "2020-09-21T12:07:35Z", "message": "[#1958] Follow up of issue #1995. Add an implementation of the search devices operation for the file-based registry.\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12589612855f0a958b6fa6970210fcbc020dc33c", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/12589612855f0a958b6fa6970210fcbc020dc33c", "committedDate": "2020-09-23T08:38:39Z", "message": "[#1958] Follow up of issue #1995. Add an implementation of the search devices operation for the file-based registry.\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ae04ac052e36f6433bc3493ebeba43ea702f1c22", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/ae04ac052e36f6433bc3493ebeba43ea702f1c22", "committedDate": "2020-09-21T12:07:35Z", "message": "[#1958] Follow up of issue #1995. Add an implementation of the search devices operation for the file-based registry.\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}, "afterCommit": {"oid": "12589612855f0a958b6fa6970210fcbc020dc33c", "author": {"user": {"login": "jbtrystram", "name": "Jean-Baptiste Trystram"}}, "url": "https://github.com/eclipse/hono/commit/12589612855f0a958b6fa6970210fcbc020dc33c", "committedDate": "2020-09-23T08:38:39Z", "message": "[#1958] Follow up of issue #1995. Add an implementation of the search devices operation for the file-based registry.\n\nSigned-off-by: Jean-Baptiste Trystram <jbtrystram@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMDAwMTg0", "url": "https://github.com/eclipse/hono/pull/2009#pullrequestreview-501000184", "createdAt": "2020-10-02T09:47:52Z", "commit": {"oid": "12589612855f0a958b6fa6970210fcbc020dc33c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 658, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}