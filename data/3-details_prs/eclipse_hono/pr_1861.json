{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1Mjg4NDM5", "number": 1861, "title": "[#1860] Use unique adapter instance id per consumer factory", "bodyText": "Fix for #1860.\nMakes sure that each ProtocolAdapterCommandConsumerFactory instance gets assigned its own unique adapterInstanceId (which then kind of represents the AbstractProtocolAdapterBase instance that the command consumer factory instance is used in).", "createdAt": "2020-03-29T17:31:04Z", "url": "https://github.com/eclipse/hono/pull/1861", "merged": true, "mergeCommit": {"oid": "2f3d404c04a0a882942c125883247465b787cdc7"}, "closed": true, "closedAt": "2020-04-08T10:59:51Z", "author": {"login": "calohmn"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTR0btAFqTM4NTI5ODc1Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVlgL0AFqTM4OTg1NTUxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1Mjk4NzUz", "url": "https://github.com/eclipse/hono/pull/1861#pullrequestreview-385298753", "createdAt": "2020-04-01T06:34:41Z", "commit": {"oid": "f2b20a9f8d21b25205410a3cd26574bc389d1d89"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwNjozNDo0MlrOF-ymYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwNjozNjoxNFrOF-yotA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM4NTA1OQ==", "bodyText": "I do not really see why we need this additional constructor. In fact, I believe we once had one like this one but removed it because it was hard to make sure that the config props passed in are the same as the ones used for creating the connection factory. Also, HonoConnectionImpl(Vertx, ClientConfigProperties) seems to be doing the same thing as what you are doing in AbstractAdapterConfig or am I mistaken?", "url": "https://github.com/eclipse/hono/pull/1861#discussion_r401385059", "createdAt": "2020-04-01T06:34:42Z", "author": {"login": "sophokles73"}, "path": "client/src/main/java/org/eclipse/hono/client/HonoConnection.java", "diffHunk": "@@ -82,6 +83,24 @@ static HonoConnection newConnection(final Vertx vertx, final ClientConfigPropert\n         return new HonoConnectionImpl(vertx, clientConfigProperties);\n     }\n \n+    /**\n+     * Creates a new connection using the default implementation.\n+     * <p>\n+     * <strong>Note:</strong> Instances of {@link ClientConfigProperties} are not thread safe and not immutable.\n+     * They must therefore not be modified after calling this method.\n+     *\n+     * @param vertx The vert.x instance to use.\n+     * @param connectionFactory The factory to use for creating an AMQP connection to the Hono server.\n+     * @param clientConfigProperties The client properties to use.\n+     * @return The newly created connection. Note that the underlying AMQP connection will not be established\n+     *         until one of its <em>connect</em> methods is invoked.\n+     * @throws NullPointerException if vertx or clientConfigProperties is {@code null}.\n+     */\n+    static HonoConnection newConnection(final Vertx vertx, final ConnectionFactory connectionFactory,\n+            final ClientConfigProperties clientConfigProperties) {\n+        return new HonoConnectionImpl(vertx, connectionFactory, clientConfigProperties);\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2b20a9f8d21b25205410a3cd26574bc389d1d89"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM4NTY1Mg==", "bodyText": "Is there a particular reason why you do not want to simply remove this method?", "url": "https://github.com/eclipse/hono/pull/1861#discussion_r401385652", "createdAt": "2020-04-01T06:36:14Z", "author": {"login": "sophokles73"}, "path": "core/src/main/java/org/eclipse/hono/config/ClientConfigProperties.java", "diffHunk": "@@ -159,7 +159,11 @@ public final void setAmqpHostname(final String amqpHostname) {\n      * The identifier consists of the name returned by {@link #getName()} plus a UUID.\n      *\n      * @return The identifier.\n+     * @deprecated The preferred way to obtain the <em>container-id</em> for the AMQP connection is now via\n+     *             the connection factory, so that not necessarily all connections configured with this properties\n+     *             object get the same id, but rather only all connections of the same connection factory instance do.\n      */\n+    @Deprecated", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2b20a9f8d21b25205410a3cd26574bc389d1d89"}, "originalPosition": 8}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f2b20a9f8d21b25205410a3cd26574bc389d1d89", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/f2b20a9f8d21b25205410a3cd26574bc389d1d89", "committedDate": "2020-03-29T17:19:09Z", "message": "[#1860] Use unique adapter instance id per consumer factory.\n\nThis fixes Command & Control errors if the protocol adapter\nis configured with hono.app.maxInstances > 1.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}, "afterCommit": {"oid": "1233efa7ac7bffae8b615733d8c504ffb85ba9dc", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/1233efa7ac7bffae8b615733d8c504ffb85ba9dc", "committedDate": "2020-04-01T14:25:33Z", "message": "[#1860] Use unique adapter instance id per consumer factory.\n\nThis fixes Command & Control errors if the protocol adapter\nis configured with hono.app.maxInstances > 1.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MjQ5MjI0", "url": "https://github.com/eclipse/hono/pull/1861#pullrequestreview-386249224", "createdAt": "2020-04-02T09:21:37Z", "commit": {"oid": "1233efa7ac7bffae8b615733d8c504ffb85ba9dc"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwOToyMTozN1rOF_inWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwOToyODo1MlrOF_i4sA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE3MTczOQ==", "bodyText": "Is this necessarily the case? I would rather document the requirement regarding the ID's uniqueness instead of describing (and thus defining) how it needs to be created. WDYT?", "url": "https://github.com/eclipse/hono/pull/1861#discussion_r402171739", "createdAt": "2020-04-02T09:21:37Z", "author": {"login": "sophokles73"}, "path": "client/src/main/java/org/eclipse/hono/client/HonoConnection.java", "diffHunk": "@@ -230,10 +230,19 @@ static HonoConnection newConnection(final Vertx vertx, final ClientConfigPropert\n      *\n      * @return The remote container id or {@code null}.\n      */\n-    default String getRemoteContainer() {\n+    default String getRemoteContainerId() {\n         return \"N/A\";\n     }\n \n+    /**\n+     * Gets the container id as advertised to the peer.\n+     * <p>\n+     * The identifier consists of the name set in the configuration plus a UUID.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1233efa7ac7bffae8b615733d8c504ffb85ba9dc"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE3Mjc3MA==", "bodyText": "just wondering: shouldn't this better return null by default? Otherwise, what purpose does it have to allow for null to be returned in the first place?", "url": "https://github.com/eclipse/hono/pull/1861#discussion_r402172770", "createdAt": "2020-04-02T09:23:13Z", "author": {"login": "sophokles73"}, "path": "client/src/main/java/org/eclipse/hono/client/HonoConnection.java", "diffHunk": "@@ -230,10 +230,19 @@ static HonoConnection newConnection(final Vertx vertx, final ClientConfigPropert\n      *\n      * @return The remote container id or {@code null}.\n      */\n-    default String getRemoteContainer() {\n+    default String getRemoteContainerId() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1233efa7ac7bffae8b615733d8c504ffb85ba9dc"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE3NjE3Ng==", "bodyText": "this means that all connections produced by this factory share the same UUID, right? Doesn't it make more sense that each connection has a distinct UUID?", "url": "https://github.com/eclipse/hono/pull/1861#discussion_r402176176", "createdAt": "2020-04-02T09:28:52Z", "author": {"login": "sophokles73"}, "path": "core/src/main/java/org/eclipse/hono/connection/impl/ConnectionFactoryImpl.java", "diffHunk": "@@ -44,6 +45,7 @@\n public final class ConnectionFactoryImpl implements ConnectionFactory {\n \n     private static final Logger logger = LoggerFactory.getLogger(ConnectionFactoryImpl.class);\n+    private final String containerIdUuidPart = UUID.randomUUID().toString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1233efa7ac7bffae8b615733d8c504ffb85ba9dc"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NDA1MzM5", "url": "https://github.com/eclipse/hono/pull/1861#pullrequestreview-386405339", "createdAt": "2020-04-02T13:06:28Z", "commit": {"oid": "1233efa7ac7bffae8b615733d8c504ffb85ba9dc"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxMzowNjoyOFrOF_qRkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxMzoxMDowN1rOF_qa8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI5NzIzNQ==", "bodyText": "FMPOV each connection created by this factory should have its own unique container ID, e.g.\nprivate String getContainerId() {\n  return String.format(\"%s-%s-%s\", config.getName(), config.getServerRole(), UUID.randomUUID())\n}", "url": "https://github.com/eclipse/hono/pull/1861#discussion_r402297235", "createdAt": "2020-04-02T13:06:28Z", "author": {"login": "sophokles73"}, "path": "core/src/main/java/org/eclipse/hono/connection/impl/ConnectionFactoryImpl.java", "diffHunk": "@@ -82,6 +84,11 @@ public String getName() {\n         return config.getName();\n     }\n \n+    @Override\n+    public String getContainerId() {\n+        return String.format(\"%s-%s\", getName(), containerIdUuidPart);\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1233efa7ac7bffae8b615733d8c504ffb85ba9dc"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI5ODg4Nw==", "bodyText": "FMPOV this should return the (local) container ID of the ProtonConnection instead ...", "url": "https://github.com/eclipse/hono/pull/1861#discussion_r402298887", "createdAt": "2020-04-02T13:09:02Z", "author": {"login": "sophokles73"}, "path": "client/src/main/java/org/eclipse/hono/client/impl/HonoConnectionImpl.java", "diffHunk": "@@ -1043,13 +1043,18 @@ public final void disconnect(final Handler<AsyncResult<Void>> completionHandler)\n      * @return The remote container id or {@code null}.\n      */\n     @Override\n-    public String getRemoteContainer() {\n+    public String getRemoteContainerId() {\n         if (!isConnectedInternal()) {\n             return null;\n         }\n         return connection.getRemoteContainer();\n     }\n \n+    @Override\n+    public String getContainerId() {\n+        return connectionFactory.getContainerId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1233efa7ac7bffae8b615733d8c504ffb85ba9dc"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI5OTYzNA==", "bodyText": "this is not needed FMPOV", "url": "https://github.com/eclipse/hono/pull/1861#discussion_r402299634", "createdAt": "2020-04-02T13:10:07Z", "author": {"login": "sophokles73"}, "path": "core/src/main/java/org/eclipse/hono/connection/ConnectionFactory.java", "diffHunk": "@@ -28,12 +30,23 @@\n public interface ConnectionFactory {\n \n     /**\n-     * Gets the name being indicated as the <em>container-id</em> in the client's AMQP <em>Open</em> frame.\n+     * Gets the name being indicated as part of the <em>container-id</em> in the client's AMQP <em>Open</em> frame.\n      *\n      * @return The name or {@code null} if no name has been set.\n      */\n     String getName();\n \n+    /**\n+     * Gets the identifier being indicated as the <em>container-id</em> in the client's AMQP <em>Open</em> frame.\n+     * <p>\n+     * The identifier consists of the name returned by {@link #getName()} plus a UUID.\n+     *\n+     * @return The identifier.\n+     */\n+    default String getContainerId() {\n+        return String.format(\"%s-%s\", getName(), UUID.randomUUID());\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1233efa7ac7bffae8b615733d8c504ffb85ba9dc"}, "originalPosition": 30}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1233efa7ac7bffae8b615733d8c504ffb85ba9dc", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/1233efa7ac7bffae8b615733d8c504ffb85ba9dc", "committedDate": "2020-04-01T14:25:33Z", "message": "[#1860] Use unique adapter instance id per consumer factory.\n\nThis fixes Command & Control errors if the protocol adapter\nis configured with hono.app.maxInstances > 1.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}, "afterCommit": {"oid": "cdfe78edcf01307624fca54ae0f2d0ff9fb171ad", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/cdfe78edcf01307624fca54ae0f2d0ff9fb171ad", "committedDate": "2020-04-02T20:12:02Z", "message": "[#1860] Use unique adapter instance id per consumer factory.\n\nThis fixes Command & Control errors if the protocol adapter\nis configured with hono.app.maxInstances > 1.\nFurthermore, a single HonoConnection now uses the same\ncontainer id in the AMQP open frame every time the connection\nis reestablished.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cdfe78edcf01307624fca54ae0f2d0ff9fb171ad", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/cdfe78edcf01307624fca54ae0f2d0ff9fb171ad", "committedDate": "2020-04-02T20:12:02Z", "message": "[#1860] Use unique adapter instance id per consumer factory.\n\nThis fixes Command & Control errors if the protocol adapter\nis configured with hono.app.maxInstances > 1.\nFurthermore, a single HonoConnection now uses the same\ncontainer id in the AMQP open frame every time the connection\nis reestablished.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}, "afterCommit": {"oid": "67f821a20b5077dccaf4a10cb7bfcb1f0144e693", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/67f821a20b5077dccaf4a10cb7bfcb1f0144e693", "committedDate": "2020-04-08T08:50:17Z", "message": "[#1860] Use unique adapter instance id per consumer factory.\n\nThis fixes Command & Control errors if the protocol adapter\nis configured with hono.app.maxInstances > 1.\nFurthermore, a single HonoConnection now uses the same\ncontainer id in the AMQP open frame every time the connection\nis reestablished.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5Nzg4MDE3", "url": "https://github.com/eclipse/hono/pull/1861#pullrequestreview-389788017", "createdAt": "2020-04-08T09:07:28Z", "commit": {"oid": "67f821a20b5077dccaf4a10cb7bfcb1f0144e693"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwOTowNzoyOFrOGCl_1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwOTowNzoyOFrOGCl_1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM3Mjg4NA==", "bodyText": "maybe we also want to mention the changes to ConnectionFactory?", "url": "https://github.com/eclipse/hono/pull/1861#discussion_r405372884", "createdAt": "2020-04-08T09:07:28Z", "author": {"login": "sophokles73"}, "path": "site/homepage/content/release-notes.md", "diffHunk": "@@ -8,6 +8,10 @@ title = \"Release Notes\"\n \n * An admin guide for the CoAP adapter has been added.\n \n+### API Changes\n+\n+* The `getRemoteContainer` method in `org.eclipse.hono.client.HonoConnection` has been renamed to `getRemoteContainerId`.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67f821a20b5077dccaf4a10cb7bfcb1f0144e693"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59e0bcff6bdbea661d760e817b2dd638d3d2fab7", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/59e0bcff6bdbea661d760e817b2dd638d3d2fab7", "committedDate": "2020-04-08T10:32:08Z", "message": "[#1860] Use unique adapter instance id per consumer factory.\n\nThis fixes Command & Control errors if the protocol adapter\nis configured with hono.app.maxInstances > 1.\nFurthermore, a single HonoConnection now uses the same\ncontainer id in the AMQP open frame every time the connection\nis reestablished.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "67f821a20b5077dccaf4a10cb7bfcb1f0144e693", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/67f821a20b5077dccaf4a10cb7bfcb1f0144e693", "committedDate": "2020-04-08T08:50:17Z", "message": "[#1860] Use unique adapter instance id per consumer factory.\n\nThis fixes Command & Control errors if the protocol adapter\nis configured with hono.app.maxInstances > 1.\nFurthermore, a single HonoConnection now uses the same\ncontainer id in the AMQP open frame every time the connection\nis reestablished.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}, "afterCommit": {"oid": "59e0bcff6bdbea661d760e817b2dd638d3d2fab7", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/59e0bcff6bdbea661d760e817b2dd638d3d2fab7", "committedDate": "2020-04-08T10:32:08Z", "message": "[#1860] Use unique adapter instance id per consumer factory.\n\nThis fixes Command & Control errors if the protocol adapter\nis configured with hono.app.maxInstances > 1.\nFurthermore, a single HonoConnection now uses the same\ncontainer id in the AMQP open frame every time the connection\nis reestablished.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5ODU1NTE4", "url": "https://github.com/eclipse/hono/pull/1861#pullrequestreview-389855518", "createdAt": "2020-04-08T10:40:08Z", "commit": {"oid": "59e0bcff6bdbea661d760e817b2dd638d3d2fab7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 833, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}