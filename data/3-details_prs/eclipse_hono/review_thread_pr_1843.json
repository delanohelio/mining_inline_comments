{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwNDY2OTQ2", "number": 1843, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxOToyNDo1OVrODpP55w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxOToyNjo0M1rODpP8HQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0NTc4NzkxOnYy", "diffSide": "RIGHT", "path": "client-device-connection-infinispan/src/main/java/org/eclipse/hono/deviceconnection/infinispan/client/HotrodCache.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxOToyNDo1OVrOF4TsZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwOTo0NTo0OVrOF5NIrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU4NzIzNg==", "bodyText": "I find the naming of MoreFutures.create() somewhat unintuitive (are more/multiple Futures created here?).\nLooking at the Javadoc of the class and the method, I think something like FuturesHelper.mapCompletionStageResult() would make it more obvious what is being done here. WDYT?", "url": "https://github.com/eclipse/hono/pull/1843#discussion_r394587236", "createdAt": "2020-03-18T19:24:59Z", "author": {"login": "calohmn"}, "path": "client-device-connection-infinispan/src/main/java/org/eclipse/hono/deviceconnection/infinispan/client/HotrodCache.java", "diffHunk": "@@ -162,44 +162,45 @@ public void addReconnectListener(final ReconnectListener<HotrodCache<K, V>> list\n     @Override\n     public Future<V> put(final K key, final V value) {\n \n-        final Promise<V> result = Promise.promise();\n         if (cache == null) {\n-            result.fail(new ServerErrorException(HttpURLConnection.HTTP_UNAVAILABLE, \"no connection to data grid\"));\n+\n+            return noConnectionFailure();\n+\n         } else {\n-            vertx.executeBlocking(outcome -> {\n-                try {\n-                    final V replacedValue = cache.put(key, value);\n-                    outcome.complete(replacedValue);\n-                } catch (final Throwable e) {\n-                    outcome.fail(e);\n-                }\n-            }, result);\n+\n+            return MoreFutures.create(() -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16eefec56feee03a843451d84ace484939c65c26"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg5MDQ1NQ==", "bodyText": "I followed this pattern: https://guava.dev/releases/23.0/api/docs/com/google/common/base/MoreObjects.html\nBut I am open to making changes to the name.", "url": "https://github.com/eclipse/hono/pull/1843#discussion_r394890455", "createdAt": "2020-03-19T09:26:26Z", "author": {"login": "ctron"}, "path": "client-device-connection-infinispan/src/main/java/org/eclipse/hono/deviceconnection/infinispan/client/HotrodCache.java", "diffHunk": "@@ -162,44 +162,45 @@ public void addReconnectListener(final ReconnectListener<HotrodCache<K, V>> list\n     @Override\n     public Future<V> put(final K key, final V value) {\n \n-        final Promise<V> result = Promise.promise();\n         if (cache == null) {\n-            result.fail(new ServerErrorException(HttpURLConnection.HTTP_UNAVAILABLE, \"no connection to data grid\"));\n+\n+            return noConnectionFailure();\n+\n         } else {\n-            vertx.executeBlocking(outcome -> {\n-                try {\n-                    final V replacedValue = cache.put(key, value);\n-                    outcome.complete(replacedValue);\n-                } catch (final Throwable e) {\n-                    outcome.fail(e);\n-                }\n-            }, result);\n+\n+            return MoreFutures.create(() -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU4NzIzNg=="}, "originalCommit": {"oid": "16eefec56feee03a843451d84ace484939c65c26"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ1ODYwNw==", "bodyText": "I think with MoreObjects that pattern works, because it complements the Objects helper class. Since there is no Futures helper class for Vert.x or Java futures, this pattern doesn't work so well here, IMHO.", "url": "https://github.com/eclipse/hono/pull/1843#discussion_r395458607", "createdAt": "2020-03-20T06:41:52Z", "author": {"login": "calohmn"}, "path": "client-device-connection-infinispan/src/main/java/org/eclipse/hono/deviceconnection/infinispan/client/HotrodCache.java", "diffHunk": "@@ -162,44 +162,45 @@ public void addReconnectListener(final ReconnectListener<HotrodCache<K, V>> list\n     @Override\n     public Future<V> put(final K key, final V value) {\n \n-        final Promise<V> result = Promise.promise();\n         if (cache == null) {\n-            result.fail(new ServerErrorException(HttpURLConnection.HTTP_UNAVAILABLE, \"no connection to data grid\"));\n+\n+            return noConnectionFailure();\n+\n         } else {\n-            vertx.executeBlocking(outcome -> {\n-                try {\n-                    final V replacedValue = cache.put(key, value);\n-                    outcome.complete(replacedValue);\n-                } catch (final Throwable e) {\n-                    outcome.fail(e);\n-                }\n-            }, result);\n+\n+            return MoreFutures.create(() -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU4NzIzNg=="}, "originalCommit": {"oid": "16eefec56feee03a843451d84ace484939c65c26"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ2NTgxMA==", "bodyText": "Then why not simply call the class Futures?", "url": "https://github.com/eclipse/hono/pull/1843#discussion_r395465810", "createdAt": "2020-03-20T07:11:13Z", "author": {"login": "sophokles73"}, "path": "client-device-connection-infinispan/src/main/java/org/eclipse/hono/deviceconnection/infinispan/client/HotrodCache.java", "diffHunk": "@@ -162,44 +162,45 @@ public void addReconnectListener(final ReconnectListener<HotrodCache<K, V>> list\n     @Override\n     public Future<V> put(final K key, final V value) {\n \n-        final Promise<V> result = Promise.promise();\n         if (cache == null) {\n-            result.fail(new ServerErrorException(HttpURLConnection.HTTP_UNAVAILABLE, \"no connection to data grid\"));\n+\n+            return noConnectionFailure();\n+\n         } else {\n-            vertx.executeBlocking(outcome -> {\n-                try {\n-                    final V replacedValue = cache.put(key, value);\n-                    outcome.complete(replacedValue);\n-                } catch (final Throwable e) {\n-                    outcome.fail(e);\n-                }\n-            }, result);\n+\n+            return MoreFutures.create(() -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU4NzIzNg=="}, "originalCommit": {"oid": "16eefec56feee03a843451d84ace484939c65c26"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUyNzExOA==", "bodyText": "Because we already have a class called Futures in our classpath: com.google.common.util.concurrent.Futures.", "url": "https://github.com/eclipse/hono/pull/1843#discussion_r395527118", "createdAt": "2020-03-20T09:43:18Z", "author": {"login": "ctron"}, "path": "client-device-connection-infinispan/src/main/java/org/eclipse/hono/deviceconnection/infinispan/client/HotrodCache.java", "diffHunk": "@@ -162,44 +162,45 @@ public void addReconnectListener(final ReconnectListener<HotrodCache<K, V>> list\n     @Override\n     public Future<V> put(final K key, final V value) {\n \n-        final Promise<V> result = Promise.promise();\n         if (cache == null) {\n-            result.fail(new ServerErrorException(HttpURLConnection.HTTP_UNAVAILABLE, \"no connection to data grid\"));\n+\n+            return noConnectionFailure();\n+\n         } else {\n-            vertx.executeBlocking(outcome -> {\n-                try {\n-                    final V replacedValue = cache.put(key, value);\n-                    outcome.complete(replacedValue);\n-                } catch (final Throwable e) {\n-                    outcome.fail(e);\n-                }\n-            }, result);\n+\n+            return MoreFutures.create(() -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU4NzIzNg=="}, "originalCommit": {"oid": "16eefec56feee03a843451d84ace484939c65c26"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUyODM2NA==", "bodyText": "Assuming you still prefer Futures, I updated the pull request to that name. If you re-consider, I can still revert back to MoreFutures.", "url": "https://github.com/eclipse/hono/pull/1843#discussion_r395528364", "createdAt": "2020-03-20T09:45:49Z", "author": {"login": "ctron"}, "path": "client-device-connection-infinispan/src/main/java/org/eclipse/hono/deviceconnection/infinispan/client/HotrodCache.java", "diffHunk": "@@ -162,44 +162,45 @@ public void addReconnectListener(final ReconnectListener<HotrodCache<K, V>> list\n     @Override\n     public Future<V> put(final K key, final V value) {\n \n-        final Promise<V> result = Promise.promise();\n         if (cache == null) {\n-            result.fail(new ServerErrorException(HttpURLConnection.HTTP_UNAVAILABLE, \"no connection to data grid\"));\n+\n+            return noConnectionFailure();\n+\n         } else {\n-            vertx.executeBlocking(outcome -> {\n-                try {\n-                    final V replacedValue = cache.put(key, value);\n-                    outcome.complete(replacedValue);\n-                } catch (final Throwable e) {\n-                    outcome.fail(e);\n-                }\n-            }, result);\n+\n+            return MoreFutures.create(() -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU4NzIzNg=="}, "originalCommit": {"oid": "16eefec56feee03a843451d84ace484939c65c26"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0NTc5MTYyOnYy", "diffSide": "RIGHT", "path": "client-device-connection-infinispan/src/main/java/org/eclipse/hono/deviceconnection/infinispan/client/HotrodCache.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxOToyNjowNVrOF4Tu0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxOToyNjowNVrOF4Tu0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU4Nzg1Ng==", "bodyText": "Replace with return noConnectionFailure();?", "url": "https://github.com/eclipse/hono/pull/1843#discussion_r394587856", "createdAt": "2020-03-18T19:26:05Z", "author": {"login": "calohmn"}, "path": "client-device-connection-infinispan/src/main/java/org/eclipse/hono/deviceconnection/infinispan/client/HotrodCache.java", "diffHunk": "@@ -162,44 +162,45 @@ public void addReconnectListener(final ReconnectListener<HotrodCache<K, V>> list\n     @Override\n     public Future<V> put(final K key, final V value) {\n \n-        final Promise<V> result = Promise.promise();\n         if (cache == null) {\n-            result.fail(new ServerErrorException(HttpURLConnection.HTTP_UNAVAILABLE, \"no connection to data grid\"));\n+\n+            return noConnectionFailure();\n+\n         } else {\n-            vertx.executeBlocking(outcome -> {\n-                try {\n-                    final V replacedValue = cache.put(key, value);\n-                    outcome.complete(replacedValue);\n-                } catch (final Throwable e) {\n-                    outcome.fail(e);\n-                }\n-            }, result);\n+\n+            return MoreFutures.create(() -> {\n+                return cache\n+                    .withFlags(Flag.FORCE_RETURN_VALUE)\n+                    .putAsync(key, value);\n+            });\n+\n         }\n-        return result.future();\n+\n     }\n \n     @Override\n     public Future<Boolean> removeWithVersion(final K key, final long version) {\n \n-        final Promise<Boolean> result = Promise.promise();\n         if (cache == null) {\n-            result.fail(new ServerErrorException(HttpURLConnection.HTTP_UNAVAILABLE, \"no connection to data grid\"));\n+\n+            return Future.failedFuture(new ServerErrorException(\n+                    HttpURLConnection.HTTP_UNAVAILABLE, \"no connection to data grid\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16eefec56feee03a843451d84ace484939c65c26"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0NTc5MzEwOnYy", "diffSide": "RIGHT", "path": "client-device-connection-infinispan/src/main/java/org/eclipse/hono/deviceconnection/infinispan/client/HotrodCache.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxOToyNjozM1rOF4TvtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxOToyNjozM1rOF4TvtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU4ODA4NQ==", "bodyText": "Replace with return noConnectionFailure();?", "url": "https://github.com/eclipse/hono/pull/1843#discussion_r394588085", "createdAt": "2020-03-18T19:26:33Z", "author": {"login": "calohmn"}, "path": "client-device-connection-infinispan/src/main/java/org/eclipse/hono/deviceconnection/infinispan/client/HotrodCache.java", "diffHunk": "@@ -235,38 +235,46 @@ public void addReconnectListener(final ReconnectListener<HotrodCache<K, V>> list\n     @Override\n     public Future<Versioned<V>> getWithVersion(final K key) {\n \n-        final Promise<Versioned<V>> result = Promise.promise();\n         if (cache == null) {\n-            result.fail(new ServerErrorException(HttpURLConnection.HTTP_UNAVAILABLE, \"no connection to data grid\"));\n+\n+            return Future.failedFuture(new ServerErrorException(\n+                    HttpURLConnection.HTTP_UNAVAILABLE, \"no connection to data grid\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16eefec56feee03a843451d84ace484939c65c26"}, "originalPosition": 127}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0NTc5MzU3OnYy", "diffSide": "RIGHT", "path": "client-device-connection-infinispan/src/main/java/org/eclipse/hono/deviceconnection/infinispan/client/HotrodCache.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxOToyNjo0M1rOF4Tv_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxOToyNjo0M1rOF4Tv_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU4ODE1Nw==", "bodyText": "Replace with return noConnectionFailure();?", "url": "https://github.com/eclipse/hono/pull/1843#discussion_r394588157", "createdAt": "2020-03-18T19:26:43Z", "author": {"login": "calohmn"}, "path": "client-device-connection-infinispan/src/main/java/org/eclipse/hono/deviceconnection/infinispan/client/HotrodCache.java", "diffHunk": "@@ -235,38 +235,46 @@ public void addReconnectListener(final ReconnectListener<HotrodCache<K, V>> list\n     @Override\n     public Future<Versioned<V>> getWithVersion(final K key) {\n \n-        final Promise<Versioned<V>> result = Promise.promise();\n         if (cache == null) {\n-            result.fail(new ServerErrorException(HttpURLConnection.HTTP_UNAVAILABLE, \"no connection to data grid\"));\n+\n+            return Future.failedFuture(new ServerErrorException(\n+                    HttpURLConnection.HTTP_UNAVAILABLE, \"no connection to data grid\"));\n+\n         } else {\n-            vertx.executeBlocking(outcome -> {\n-                try {\n-                    final MetadataValue<V> value = cache.getWithMetadata(key);\n-                    outcome.complete(value != null ? new Versioned<>(value.getVersion(), value.getValue()) : null);\n-                } catch (final Throwable e) {\n-                    outcome.fail(e);\n-                }\n-            }, result);\n+\n+            return MoreFutures.create(() -> {\n+                return cache\n+                    .getWithMetadataAsync(key)\n+                    .thenApply(value -> {\n+                        if (value != null ) {\n+                            return new Versioned<>(value.getVersion(), value.getValue());\n+                        } else {\n+                            return null;\n+                        }\n+                    });\n+            });\n+\n         }\n-        return result.future();\n+\n     }\n \n     @Override\n     public Future<Map<K, V>> getAll(final Set<? extends K> keys) {\n-        final Promise<Map<K, V>> result = Promise.promise();\n+\n         if (cache == null) {\n-            result.fail(new ServerErrorException(HttpURLConnection.HTTP_UNAVAILABLE, \"no connection to data grid\"));\n+\n+            return Future.failedFuture(new ServerErrorException(\n+                    HttpURLConnection.HTTP_UNAVAILABLE, \"no connection to data grid\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16eefec56feee03a843451d84ace484939c65c26"}, "originalPosition": 164}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3285, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}