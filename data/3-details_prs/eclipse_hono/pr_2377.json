{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQzOTMyMDg4", "number": 2377, "title": "Invoke assertRegistration before creating command consumer", "bodyText": "", "createdAt": "2020-12-22T07:35:02Z", "url": "https://github.com/eclipse/hono/pull/2377", "merged": true, "mergeCommit": {"oid": "8bd9b93c10e34ae084f6d643dc050a6bc510fe85"}, "closed": true, "closedAt": "2020-12-22T09:41:03Z", "author": {"login": "calohmn"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdomIDuAFqTU1Njg5NTAxNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdonQjXgFqTU1Njk0NDUwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2ODk1MDE1", "url": "https://github.com/eclipse/hono/pull/2377#pullrequestreview-556895015", "createdAt": "2020-12-22T08:18:22Z", "commit": {"oid": "abca0ff6922efd26f951e75796a725c1699505f2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwODoxODoyM1rOIJyUYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwODoxODoyM1rOIJyUYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzEzMjUxMw==", "bodyText": "I am not sure if the open handler will be invoked with a failed AsyncResult in any case. However, the closeHandler and/or the detachHandler should contain an error that we can assert.", "url": "https://github.com/eclipse/hono/pull/2377#discussion_r547132513", "createdAt": "2020-12-22T08:18:23Z", "author": {"login": "sophokles73"}, "path": "tests/src/test/java/org/eclipse/hono/tests/amqp/CommandAndControlAmqpIT.java", "diffHunk": "@@ -849,6 +849,45 @@ public void testSendCommandFailsForCommandNotAcknowledgedByDevice(\n         }\n     }\n \n+    /**\n+     * Verifies that the adapter immediately closes the command receiver link of a gateway wanting\n+     * to receive commands of a device that doesn't have the gateway in its via-gateways.\n+     *\n+     * @param ctx The vert.x test context.\n+     */\n+    @Test\n+    @Timeout(timeUnit = TimeUnit.SECONDS, value = 20)\n+    public void testCommandReceiverCreationFailsForDeviceNotInViaGateways(\n+            final VertxTestContext ctx) {\n+\n+        final AmqpCommandEndpointConfiguration endpointConfig = new AmqpCommandEndpointConfiguration(\n+                SubscriberRole.GATEWAY_FOR_SINGLE_DEVICE);\n+\n+        final String otherDeviceId = helper.getRandomDeviceId(tenantId);\n+        helper.registry\n+                .addDeviceToTenant(tenantId, deviceId, password)\n+                .compose(ok -> helper.registry.addDeviceToTenant(tenantId, otherDeviceId, password))\n+                .compose(ok -> connectToAdapter(IntegrationTestSupport.getUsername(deviceId, tenantId), password))\n+                .compose(conAck -> {\n+                    final Promise<Void> result = Promise.promise();\n+                    context.runOnContext(go -> {\n+                        final ProtonReceiver recv = connection\n+                                .createReceiver(endpointConfig.getSubscriptionAddress(tenantId, otherDeviceId));\n+                        recv.setQoS(ProtonQoS.AT_LEAST_ONCE);\n+                        recv.openHandler(openResult -> {\n+                            ctx.verify(() -> {\n+                                assertThat(openResult.failed()).isTrue();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abca0ff6922efd26f951e75796a725c1699505f2"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2db14b93edf3b997b95659e3828061fa9f8de84c", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/2db14b93edf3b997b95659e3828061fa9f8de84c", "committedDate": "2020-12-22T09:11:25Z", "message": "Invoke assertRegistration before creating command consumer.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "abca0ff6922efd26f951e75796a725c1699505f2", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/abca0ff6922efd26f951e75796a725c1699505f2", "committedDate": "2020-12-22T07:33:36Z", "message": "Invoke assertRegistration before creating command consumer.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}, "afterCommit": {"oid": "2db14b93edf3b997b95659e3828061fa9f8de84c", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/2db14b93edf3b997b95659e3828061fa9f8de84c", "committedDate": "2020-12-22T09:11:25Z", "message": "Invoke assertRegistration before creating command consumer.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2OTQ0NTA4", "url": "https://github.com/eclipse/hono/pull/2377#pullrequestreview-556944508", "createdAt": "2020-12-22T09:38:35Z", "commit": {"oid": "2db14b93edf3b997b95659e3828061fa9f8de84c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 494, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}