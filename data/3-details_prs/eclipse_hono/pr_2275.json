{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyODIyNzcw", "number": 2275, "title": "Create downstream message from properties gathered from context", "bodyText": "The protocol adapters now create downstream messages using the new\nMessageHelper.newMessage() method which accepts a Map of properties to\ninclude in the message.\nThis is in preparation for the adapters being refactored to use the new\nTelemetrySender and EventSender instead of the legacy DownstreamSender.", "createdAt": "2020-10-30T07:52:05Z", "url": "https://github.com/eclipse/hono/pull/2275", "merged": true, "mergeCommit": {"oid": "9517adc740e28eb5c34c45c2fafa1fe3e37444b3"}, "closed": true, "closedAt": "2020-10-30T15:54:34Z", "author": {"login": "sophokles73"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXV4H0AH2gAyNTEyODIyNzcwOjIyN2UzOGEwNGY1ZTg3ZTUwYThmZDJjNjZhMGMwYzAyYTQyYmI4ZjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXoNfhAFqTUyMDc2MDc5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "227e38a04f5e87e50a8fd2c66a0c0c02a42bb8f0", "author": {"user": {"login": "sophokles73", "name": "Kai Hudalla"}}, "url": "https://github.com/eclipse/hono/commit/227e38a04f5e87e50a8fd2c66a0c0c02a42bb8f0", "committedDate": "2020-10-29T17:46:48Z", "message": "Create downstream message from properties gathered from context\n\nThe protocol adapters now create downstream messages using the new\nMessageHelper.newMessage() method which accepts a Map of properties to\ninclude in the message.\n\nThis is in preparation for the adapters being refactored to use the new\nTelemetrySender and EventSender instead of the legacy DownstreamSender.\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNDgyNDg0", "url": "https://github.com/eclipse/hono/pull/2275#pullrequestreview-520482484", "createdAt": "2020-10-30T09:06:50Z", "commit": {"oid": "227e38a04f5e87e50a8fd2c66a0c0c02a42bb8f0"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwOTowNjo1MFrOHrGeUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxMTo0OTozMlrOHrLt2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk1Njg4MQ==", "bodyText": "The waitForOutcome method parameter is now not used anymore in the method.", "url": "https://github.com/eclipse/hono/pull/2275#discussion_r514956881", "createdAt": "2020-10-30T09:06:50Z", "author": {"login": "calohmn"}, "path": "adapters/coap-vertx-base/src/main/java/org/eclipse/hono/adapter/coap/AbstractVertxBasedCoapAdapter.java", "diffHunk": "@@ -695,7 +695,7 @@ protected final String getAuthId(final CoapExchange exchange) {\n             final String gatewayId = context.getGatewayId();\n             final String tenantId = context.getOriginDevice().getTenantId();\n             final String deviceId = context.getOriginDevice().getDeviceId();\n-            final MetricsTags.QoS qos = waitForOutcome ? MetricsTags.QoS.AT_LEAST_ONCE : MetricsTags.QoS.AT_MOST_ONCE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "227e38a04f5e87e50a8fd2c66a0c0c02a42bb8f0"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk1OTMyMA==", "bodyText": "Optional.ofNullable not really needed here since exchange.getRequestOptions().getUriPathString() doesn't return null.", "url": "https://github.com/eclipse/hono/pull/2275#discussion_r514959320", "createdAt": "2020-10-30T09:11:37Z", "author": {"login": "calohmn"}, "path": "adapters/coap-vertx-base/src/main/java/org/eclipse/hono/adapter/coap/CoapContext.java", "diffHunk": "@@ -416,4 +417,26 @@ private Integer getIntegerQueryParameter(final String parameterName) {\n     public QoS getRequestedQos() {\n         return isConfirmable() ? QoS.AT_LEAST_ONCE : QoS.AT_MOST_ONCE;\n     }\n+\n+    /**\n+     * {@inheritDoc}\n+     *\n+     * @return An empty optional.\n+     */\n+    @Override\n+    public Optional<Duration> getTimeToLive() {\n+        return Optional.empty();\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     *\n+     * @return The <em>Uri-Path</em> request option prefixed with a <em>/</em> character.\n+     */\n+    @Override\n+    public String getOrigAddress() {\n+        return Optional.ofNullable(exchange.getRequestOptions().getUriPathString())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "227e38a04f5e87e50a8fd2c66a0c0c02a42bb8f0"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk5OTMwMA==", "bodyText": "Always adding a second seems a bit strange here (would also cause \"limiting device provided TTL [{}ms] to max TTL\" log output if client always uses the maxTtl value here). In my view, using\nmessage.getTtl() >= 1000 ? message.getTtl() : 1000\nwould be better.", "url": "https://github.com/eclipse/hono/pull/2275#discussion_r514999300", "createdAt": "2020-10-30T10:25:25Z", "author": {"login": "calohmn"}, "path": "adapters/amqp-vertx/src/main/java/org/eclipse/hono/adapter/amqp/impl/AmqpContext.java", "diffHunk": "@@ -106,6 +108,18 @@ final String getMessageContentType() {\n         return message.getContentType();\n     }\n \n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public final Optional<Duration> getTimeToLive() {\n+        if (endpoint == EndpointType.EVENT && message.getTtl() > 0) {\n+            // make sure it is at least one second\n+            return Optional.of(Duration.ofMillis(message.getTtl() + 1000L));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "227e38a04f5e87e50a8fd2c66a0c0c02a42bb8f0"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA0Mjc3Ng==", "bodyText": "(Redundant String cast.)\nThe extra propertyBag check looks superfluous here since all MqttContext fields except timer are effectively final. (And there is a different content-type constant being used compared to the constructor code.)", "url": "https://github.com/eclipse/hono/pull/2275#discussion_r515042776", "createdAt": "2020-10-30T11:49:32Z", "author": {"login": "calohmn"}, "path": "adapters/mqtt-vertx-base/src/main/java/org/eclipse/hono/adapter/mqtt/MqttContext.java", "diffHunk": "@@ -152,11 +156,22 @@ public Device authenticatedDevice() {\n \n     /**\n      * Gets the content type of the message payload.\n+     * <p>\n+     * The type is the value set via {@link #setContentType(String)}.\n+     * Otherwise, the type is determined from the message topic's property\n+     * bag, if if contains a content type.\n+     * Otherwise, the {@linkplain MessageHelper#CONTENT_TYPE_OCTET_STREAM default\n+     * content type} is used.\n      *\n-     * @return The type or {@code null} if the content type is unknown.\n+     * @return The type of the message payload.\n      */\n     public String contentType() {\n-        return contentType;\n+        if (contentType != null) {\n+            return contentType;\n+        }\n+        return Optional.ofNullable(propertyBag)\n+                .flatMap(bag -> Optional.ofNullable((String) bag.getProperty(HttpHeaders.CONTENT_TYPE.toString())))\n+                .orElse(MessageHelper.CONTENT_TYPE_OCTET_STREAM);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "227e38a04f5e87e50a8fd2c66a0c0c02a42bb8f0"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11127f6c2a6e9be8f3ff0b06975a99d1f2497502", "author": {"user": {"login": "sophokles73", "name": "Kai Hudalla"}}, "url": "https://github.com/eclipse/hono/commit/11127f6c2a6e9be8f3ff0b06975a99d1f2497502", "committedDate": "2020-10-30T14:17:38Z", "message": "Incorporate feedback\n\nIn particular, read properties from topic's property bag during creation\nof MQTTContext.\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNzYwNzkw", "url": "https://github.com/eclipse/hono/pull/2275#pullrequestreview-520760790", "createdAt": "2020-10-30T15:08:26Z", "commit": {"oid": "11127f6c2a6e9be8f3ff0b06975a99d1f2497502"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 416, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}