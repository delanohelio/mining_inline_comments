{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3OTE1Nzc3", "number": 2045, "title": "[#1023] Adding metric for rejected connections", "bodyText": "In order to be able to fine-tune connection limits it is useful to know how many connections were actually rejected. This is now enabled by introducing the metric \"rejectedConnectionsTotal\"\nSigned-off-by: Florian Kaltner florian.kaltner@bosch.io\nThis fixes #1023", "createdAt": "2020-06-22T12:40:24Z", "url": "https://github.com/eclipse/hono/pull/2045", "merged": true, "mergeCommit": {"oid": "7025c4db63484d1d7237e697732ea7fd2410cc59"}, "closed": true, "closedAt": "2020-06-24T10:05:11Z", "author": {"login": "fkaltner"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABctwEFrgH2gAyNDM3OTE1Nzc3OmU1ZmUyYzZjYjk2YWZkYmE2NDkwZjlkZDQ0NTYwNmY1ZmVmODc5NzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuXGm9AFqTQzNjUwMjg4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e5fe2c6cb96afdba6490f9dd445606f5fef87974", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/e5fe2c6cb96afdba6490f9dd445606f5fef87974", "committedDate": "2020-06-22T12:32:35Z", "message": "[#1023] Adding metric for rejected connections\n\nIn order to be able to fine-tune connection limits it is useful to know how many connections were actually rejected. This is now enabled by introducing the metric \"rejectedConnectionsTotal\"\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0ODg5OTI4", "url": "https://github.com/eclipse/hono/pull/2045#pullrequestreview-434889928", "createdAt": "2020-06-22T12:49:54Z", "commit": {"oid": "e5fe2c6cb96afdba6490f9dd445606f5fef87974"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxMjo0OTo1NFrOGm_Ktg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxMjo0OTo1NFrOGm_Ktg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzUzNDAwNg==", "bodyText": "I would rather replace this with a metric for connection attempts in general. We could then use tags to indicate the outcome like succeeded, unauthenticated, rejected (due to resource limitations). In any case, this metric would only make sense as a connection attempt rate, i.e. how many attempts per time-period instead of absolute numbers.", "url": "https://github.com/eclipse/hono/pull/2045#discussion_r443534006", "createdAt": "2020-06-22T12:49:54Z", "author": {"login": "sophokles73"}, "path": "site/documentation/content/api/Metrics.md", "diffHunk": "@@ -75,6 +75,7 @@ Metrics provided by the protocol adapters are:\n | *hono.connections.authenticated*   | Gauge               | *host*, *component-type*, *component-name*, *tenant*                                         | Current number of connected, authenticated devices. <br/> **NB** This metric is only supported by protocol adapters that maintain *connection state* with authenticated devices. In particular, the HTTP adapter does not support this metric. |\n | *hono.connections.unauthenticated* | Gauge               | *host*, *component-type*, *component-name*                                                   | Current number of connected, unauthenticated devices. <br/> **NB** This metric is only supported by protocol adapters that maintain *connection state* with authenticated devices. In particular, the HTTP adapter does not support this metric. |\n | *hono.connections.authenticated.duration* | Timer        | *host*, *component-type*, *component-name*, *tenant*                                         | The overall amount of time that authenticated devices have been connected to protocol adapters. <br/> **NB** This metric is only supported by protocol adapters that maintain *connection state* with authenticated devices. In particular, the HTTP adapter does not support this metric. |\n+| *hono.connections.rejected.total*  | Counter             | *host*, *component-type*, *component-name*, *tenant*                                         | The number of attempted connections to protocol adapters which were rejected because a configured connection limit was hit. <br/> **NB** This metric is only supported by protocol adapters that maintain *connection state* with authenticated devices. In particular, the HTTP adapter does not support this metric. |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5fe2c6cb96afdba6490f9dd445606f5fef87974"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d3ce96ebc8a3b227d3b6092aab5e0fde455faef", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/3d3ce96ebc8a3b227d3b6092aab5e0fde455faef", "committedDate": "2020-06-22T15:47:31Z", "message": "[#1023] Adding metric for connection attempts\n\nIn order to be able to fine-tune connection limits it is useful to know how many connections were actually rejected. This is now enabled by introducing the metric \"hono.connections.attempts.total\" and a corresponding \"outcome\" and \"reason\" tag which allows filtering of rejected connections.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MDgzNDU0", "url": "https://github.com/eclipse/hono/pull/2045#pullrequestreview-435083454", "createdAt": "2020-06-22T16:22:04Z", "commit": {"oid": "3d3ce96ebc8a3b227d3b6092aab5e0fde455faef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxNjoyMjowNFrOGnIA6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxNjoyMjowNFrOGnIA6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY3ODk1NQ==", "bodyText": "FMPOV it should also have a tag status or outcome which indicated whether the attempt succeeded or, if not, why. Possible values of the tag could therefore be succeeded, rejected and unauthorized FMPOV ...", "url": "https://github.com/eclipse/hono/pull/2045#discussion_r443678955", "createdAt": "2020-06-22T16:22:04Z", "author": {"login": "sophokles73"}, "path": "site/documentation/content/api/Metrics.md", "diffHunk": "@@ -75,6 +75,7 @@ Metrics provided by the protocol adapters are:\n | *hono.connections.authenticated*   | Gauge               | *host*, *component-type*, *component-name*, *tenant*                                         | Current number of connected, authenticated devices. <br/> **NB** This metric is only supported by protocol adapters that maintain *connection state* with authenticated devices. In particular, the HTTP adapter does not support this metric. |\n | *hono.connections.unauthenticated* | Gauge               | *host*, *component-type*, *component-name*                                                   | Current number of connected, unauthenticated devices. <br/> **NB** This metric is only supported by protocol adapters that maintain *connection state* with authenticated devices. In particular, the HTTP adapter does not support this metric. |\n | *hono.connections.authenticated.duration* | Timer        | *host*, *component-type*, *component-name*, *tenant*                                         | The overall amount of time that authenticated devices have been connected to protocol adapters. <br/> **NB** This metric is only supported by protocol adapters that maintain *connection state* with authenticated devices. In particular, the HTTP adapter does not support this metric. |\n+| *hono.connections.attempts.total*  | Counter             | *host*, *component-type*, *component-name*, *tenant*                                         | The number of connection attempts to protocol adapters. Can be distinguished by outcome by evaluating the tag \"outcome\" (and its corresponding \"reason\"). <br/> **NB** This metric is only supported by protocol adapters that maintain *connection state* with authenticated devices. In particular, the HTTP adapter does not support this metric. |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d3ce96ebc8a3b227d3b6092aab5e0fde455faef"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e3e2331ea9edc6beb6b4bbc01e822d9c62587c9", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/0e3e2331ea9edc6beb6b4bbc01e822d9c62587c9", "committedDate": "2020-06-23T07:05:19Z", "message": "[#1023] Adding metric for connection attempts\n\nIn order to be able to fine-tune connection limits it is useful to know how many connections were actually rejected. This is now enabled by introducing the metric \"hono.connections.attempts.total\" and a corresponding \"outcome\" and \"reason\" tag which allows filtering of rejected connections.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25ce759732183a9d8e0d414149cf205f0f8c0930", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/25ce759732183a9d8e0d414149cf205f0f8c0930", "committedDate": "2020-06-23T08:20:57Z", "message": "[#1023] Adding metric for connection attempts\n\nIn order to be able to fine-tune connection limits it is useful to know how many connections were actually rejected. This is now enabled by introducing the metric \"hono.connections.attempts.total\" and a corresponding \"outcome\" tag which holds the result of the connection attempt and hinting for a reason if applicable.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1ODM5NjA1", "url": "https://github.com/eclipse/hono/pull/2045#pullrequestreview-435839605", "createdAt": "2020-06-23T14:27:16Z", "commit": {"oid": "25ce759732183a9d8e0d414149cf205f0f8c0930"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNDoyNzoxNlrOGnr5kQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNDoyNzoxNlrOGnr5kQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI2Njg5Nw==", "bodyText": "can you please replace the quotes around \"outcome\" with asterisks (*outcome*)?\nIt would also be helpful to define the possible values of the outcome tag in the corresponding table above.\nFMPOV we just need accepted, unauthorized, data-volume-exceeded, connection-count-exceeded and connection-duration-exceeded for now ...", "url": "https://github.com/eclipse/hono/pull/2045#discussion_r444266897", "createdAt": "2020-06-23T14:27:16Z", "author": {"login": "sophokles73"}, "path": "site/documentation/content/api/Metrics.md", "diffHunk": "@@ -75,6 +75,7 @@ Metrics provided by the protocol adapters are:\n | *hono.connections.authenticated*   | Gauge               | *host*, *component-type*, *component-name*, *tenant*                                         | Current number of connected, authenticated devices. <br/> **NB** This metric is only supported by protocol adapters that maintain *connection state* with authenticated devices. In particular, the HTTP adapter does not support this metric. |\n | *hono.connections.unauthenticated* | Gauge               | *host*, *component-type*, *component-name*                                                   | Current number of connected, unauthenticated devices. <br/> **NB** This metric is only supported by protocol adapters that maintain *connection state* with authenticated devices. In particular, the HTTP adapter does not support this metric. |\n | *hono.connections.authenticated.duration* | Timer        | *host*, *component-type*, *component-name*, *tenant*                                         | The overall amount of time that authenticated devices have been connected to protocol adapters. <br/> **NB** This metric is only supported by protocol adapters that maintain *connection state* with authenticated devices. In particular, the HTTP adapter does not support this metric. |\n+| *hono.connections.attempts.total*  | Counter             | *host*, *component-type*, *component-name*, *outcome*                              | The number of connection attempts to protocol adapters. The outcome can be observed by looking the tag \"outcome\" which contains the result and the reason. <br/> **NB** This metric is only supported by protocol adapters that maintain *connection state* with authenticated devices. In particular, the HTTP adapter does not support this metric. |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25ce759732183a9d8e0d414149cf205f0f8c0930"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf7366264bbef4eef732b3f2836cb8578b73f69d", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/bf7366264bbef4eef732b3f2836cb8578b73f69d", "committedDate": "2020-06-23T15:19:05Z", "message": "[#1023] Adding metric for connection attempts\n\nIn order to be able to fine-tune connection limits it is useful to know how many connections were actually rejected. This is now enabled by introducing the metric \"hono.connections.attempts.total\" and a corresponding \"outcome\" tag which holds the result of the connection attempt and hinting for a reason if applicable.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1OTM0MzEy", "url": "https://github.com/eclipse/hono/pull/2045#pullrequestreview-435934312", "createdAt": "2020-06-23T16:05:38Z", "commit": {"oid": "bf7366264bbef4eef732b3f2836cb8578b73f69d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNjowNTozOVrOGnwTEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNjowNTozOVrOGnwTEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzODk2Mw==", "bodyText": "this is only capable of recording a rejected connection attempt. What about the successful attempts?", "url": "https://github.com/eclipse/hono/pull/2045#discussion_r444338963", "createdAt": "2020-06-23T16:05:39Z", "author": {"login": "sophokles73"}, "path": "service-base/src/main/java/org/eclipse/hono/service/metric/MicrometerBasedMetrics.java", "diffHunk": "@@ -116,6 +126,10 @@ protected MicrometerBasedMetrics(final MeterRegistry registry, final Vertx vertx\n             }\n         });\n         this.unauthenticatedConnections = registry.gauge(METER_CONNECTIONS_UNAUTHENTICATED, new AtomicLong());\n+\n+        this.rejectedConnections = Counter.builder(METER_CONNECTIONS_ATTEMPTS)\n+            .tag(METER_CONNECTION_ATTEMPTS_TAG_KEY_OUTCOME, \"adapter-connection-limit-exceeded\")\n+            .register(registry);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf7366264bbef4eef732b3f2836cb8578b73f69d"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df1620b7236d3eab01fae6f4004d791910638ed5", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/df1620b7236d3eab01fae6f4004d791910638ed5", "committedDate": "2020-06-24T08:42:46Z", "message": "[#1023] Adding metric for connection attempts\n\nIn order to be able to fine-tune connection limits it is useful to know how many connections were actually rejected. This is now enabled by introducing the metric \"hono.connections.attempts.total\" and a corresponding \"outcome\" tag which holds the result of the connection attempt and hinting for a reason if applicable.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2NDU4MDg0", "url": "https://github.com/eclipse/hono/pull/2045#pullrequestreview-436458084", "createdAt": "2020-06-24T09:01:25Z", "commit": {"oid": "df1620b7236d3eab01fae6f4004d791910638ed5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwOTowMToyNlrOGoJXxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwOTowMToyNlrOGoJXxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc0OTc2Ng==", "bodyText": "according to the constant definition in MicrometerBasedMetrics, the name is hono.connections.attempts only (which I find preferable).", "url": "https://github.com/eclipse/hono/pull/2045#discussion_r444749766", "createdAt": "2020-06-24T09:01:26Z", "author": {"login": "sophokles73"}, "path": "site/documentation/content/api/Metrics.md", "diffHunk": "@@ -75,6 +75,7 @@ Metrics provided by the protocol adapters are:\n | *hono.connections.authenticated*   | Gauge               | *host*, *component-type*, *component-name*, *tenant*                                         | Current number of connected, authenticated devices. <br/> **NB** This metric is only supported by protocol adapters that maintain *connection state* with authenticated devices. In particular, the HTTP adapter does not support this metric. |\n | *hono.connections.unauthenticated* | Gauge               | *host*, *component-type*, *component-name*                                                   | Current number of connected, unauthenticated devices. <br/> **NB** This metric is only supported by protocol adapters that maintain *connection state* with authenticated devices. In particular, the HTTP adapter does not support this metric. |\n | *hono.connections.authenticated.duration* | Timer        | *host*, *component-type*, *component-name*, *tenant*                                         | The overall amount of time that authenticated devices have been connected to protocol adapters. <br/> **NB** This metric is only supported by protocol adapters that maintain *connection state* with authenticated devices. In particular, the HTTP adapter does not support this metric. |\n+| *hono.connections.attempts.total*  | Counter             | *host*, *component-type*, *component-name*, *outcome*                                        | The number of connection attempts to protocol adapters. The outcome can be observed by looking the tag *outcome* which contains the result and the reason. At the moment there's only one possible value: `adapter-connection-limit-exceeded`<br/> **NB** This metric is only supported by protocol adapters that maintain *connection state* with authenticated devices. In particular, the HTTP adapter does not support this metric. |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df1620b7236d3eab01fae6f4004d791910638ed5"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79cd69d1f279c9565db22a0fcaacfaa9b0244abe", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/79cd69d1f279c9565db22a0fcaacfaa9b0244abe", "committedDate": "2020-06-24T09:27:41Z", "message": "[#1023] Adding metric for connection attempts\n\nIn order to be able to fine-tune connection limits it is useful to know how many connections were actually rejected. This is now enabled by introducing the metric \"hono.connections.attempts\" and a corresponding \"outcome\" tag which holds the result of the connection attempt and hinting for a reason if applicable.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2NDgxOTQ1", "url": "https://github.com/eclipse/hono/pull/2045#pullrequestreview-436481945", "createdAt": "2020-06-24T09:33:10Z", "commit": {"oid": "79cd69d1f279c9565db22a0fcaacfaa9b0244abe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwOTozMzoxMFrOGoKgCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwOTozMzoxMFrOGoKgCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc2ODI2Ng==", "bodyText": "I believe that this is no longer necessary, is it?", "url": "https://github.com/eclipse/hono/pull/2045#discussion_r444768266", "createdAt": "2020-06-24T09:33:10Z", "author": {"login": "sophokles73"}, "path": "service-base/src/main/java/org/eclipse/hono/service/metric/MicrometerBasedMetrics.java", "diffHunk": "@@ -60,6 +61,14 @@\n      * The name of the meter for unauthenticated connections.\n      */\n     public static final String METER_CONNECTIONS_UNAUTHENTICATED = \"hono.connections.unauthenticated\";\n+    /**\n+     * The name of the meter for connection attempts. The outcome is signaled by the accordingly named tag.\n+     */\n+    public static final String METER_CONNECTIONS_ATTEMPTS = \"hono.connections.attempts\";\n+    /**\n+     * The key for the meter connection attempt tag holding the outcome of the connection attempt.\n+     */\n+    public static final String METER_CONNECTION_ATTEMPTS_TAG_KEY_OUTCOME = \"outcome\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79cd69d1f279c9565db22a0fcaacfaa9b0244abe"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a872e709a7fb34eb225fac3911f213137dd324d4", "author": {"user": {"login": "fkaltner", "name": "Florian Kaltner"}}, "url": "https://github.com/eclipse/hono/commit/a872e709a7fb34eb225fac3911f213137dd324d4", "committedDate": "2020-06-24T09:37:30Z", "message": "[#1023] Adding metric for connection attempts\n\nIn order to be able to fine-tune connection limits it is useful to know how many connections were actually rejected. This is now enabled by introducing the metric \"hono.connections.attempts\" and a corresponding \"outcome\" tag which holds the result of the connection attempt and hinting for a reason if applicable.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2NTAyODg3", "url": "https://github.com/eclipse/hono/pull/2045#pullrequestreview-436502887", "createdAt": "2020-06-24T10:01:38Z", "commit": {"oid": "a872e709a7fb34eb225fac3911f213137dd324d4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 679, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}