{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5NzA1ODA0", "number": 2235, "title": "[#2234] Reject command message with unsupported body section", "bodyText": "This fixes #2234:\nCommands now get rejected if they have a non-null body section that is not supported.\nThis is a conservative approach in that it still allows the body section to be an amqp-value (not documented in the API), not wanting to break existing consumer applications.\nAlso introduce a getPayloadSize() method, preventing copy of body section bytes.", "createdAt": "2020-10-08T06:57:56Z", "url": "https://github.com/eclipse/hono/pull/2235", "merged": true, "mergeCommit": {"oid": "dcbf5f213fff7a18495396ef02ae97e1daf4d45d"}, "closed": true, "closedAt": "2020-10-12T13:50:13Z", "author": {"login": "calohmn"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQdfN1AFqTUwNDU1Mzk5Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdRzANUAFqTUwNjU2Nzc1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NTUzOTky", "url": "https://github.com/eclipse/hono/pull/2235#pullrequestreview-504553992", "createdAt": "2020-10-08T08:40:51Z", "commit": {"oid": "76f83aa4b3bf30eef27325068f99f9350acde1fe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwODo0MDo1MVrOHeT-qQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwODo0MDo1MVrOHeT-qQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU0NjY2NQ==", "bodyText": "This looks a little odd to me. How about renaming this to something like assertSupportedPayloadType and throw an exception holding a description in case of an invalid payload?", "url": "https://github.com/eclipse/hono/pull/2235#discussion_r501546665", "createdAt": "2020-10-08T08:40:51Z", "author": {"login": "sophokles73"}, "path": "core/src/main/java/org/eclipse/hono/util/MessageHelper.java", "diffHunk": "@@ -459,39 +440,88 @@ public static Buffer getPayload(final Message msg) {\n      * <li>In all other cases, {@code null} is returned.</li>\n      * </ul>\n      *\n-     * @param message The AMQP 1.0 message to parse the body of.\n+     * @param msg The AMQP 1.0 message to parse the body of.\n      * @return The String representation of the payload data or {@code null} if the message\n      *         body does not contain data that can be decoded into a String.\n      * @throws NullPointerException if the message is {@code null}.\n      */\n-    public static String getPayloadAsString(final Message message) {\n+    public static String getPayloadAsString(final Message msg) {\n+        Objects.requireNonNull(msg);\n+        // In case of an AmqpValue containing a String,\n+        // we prevent encoding/decoding of the String to/from its UTF-8 bytes.\n+        if (msg.getBody() instanceof AmqpValue\n+                && ((AmqpValue) msg.getBody()).getValue() instanceof String) {\n+            return (String) ((AmqpValue) msg.getBody()).getValue();\n+        }\n+        return Optional.ofNullable(getPayload(msg)).map(Buffer::toString).orElse(null);\n+    }\n \n-        Objects.requireNonNull(message);\n+    /**\n+     * Gets the size of the payload data contained in a message's body.\n+     * <p>\n+     * If there is no body section or if its type is unsupported, {@code 0} is returned.\n+     *\n+     * @param msg The AMQP 1.0 message to parse the body of.\n+     * @return The payload size in bytes, 0 if message body is {@code null} or unsupported.\n+     * @throws NullPointerException if the message is {@code null}.\n+     */\n+    public static int getPayloadSize(final Message msg) {\n+        Objects.requireNonNull(msg);\n+        return Optional.ofNullable(getPayloadByteArray(msg)).map(bytes -> bytes.length).orElse(0);\n+    }\n \n-        if (message.getBody() == null) {\n-            LOG.trace(\"message has no body\");\n-            return null;\n-        }\n+    /**\n+     * Checks whether the payload data contained in a message's body is returned as {@code null} by\n+     * {@link #getPayload(Message)} or {@link #getPayloadAsString(Message)} and, if that is the case,\n+     * returns the reason for that.\n+     *\n+     * @param msg The AMQP 1.0 message to parse.\n+     * @return A reason string or {@code null} if the payload is not {@code null}.\n+     * @throws NullPointerException if the message is {@code null}.\n+     */\n+    public static String getReasonIfPayloadNull(final Message msg) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76f83aa4b3bf30eef27325068f99f9350acde1fe"}, "originalPosition": 88}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "76f83aa4b3bf30eef27325068f99f9350acde1fe", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/76f83aa4b3bf30eef27325068f99f9350acde1fe", "committedDate": "2020-10-08T06:52:29Z", "message": "[#2234] Reject command message with unsupported body section.\n\nAlso introduce getPayloadSize() method, preventing copy of\nbody section bytes.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}, "afterCommit": {"oid": "be6b7d65d90aeb33ce875479b9cf2160a52969df", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/be6b7d65d90aeb33ce875479b9cf2160a52969df", "committedDate": "2020-10-12T08:35:24Z", "message": "[#2234] Reject command message with unsupported body section.\n\nAlso introduce getPayloadSize() method, preventing copy of\nbody section bytes.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "be6b7d65d90aeb33ce875479b9cf2160a52969df", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/be6b7d65d90aeb33ce875479b9cf2160a52969df", "committedDate": "2020-10-12T08:35:24Z", "message": "[#2234] Reject command message with unsupported body section.\n\nAlso introduce getPayloadSize() method, preventing copy of\nbody section bytes.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}, "afterCommit": {"oid": "18e69129a4f4aee36352b7e7fd9c76175abb342e", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/18e69129a4f4aee36352b7e7fd9c76175abb342e", "committedDate": "2020-10-12T11:26:40Z", "message": "[#2234] Reject command message with unsupported body section.\n\nAlso introduce getPayloadSize() method, preventing copy of\nbody section bytes.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a25db6cbe2c1ba8465a311d236fc941b9d8db18e", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/a25db6cbe2c1ba8465a311d236fc941b9d8db18e", "committedDate": "2020-10-12T11:57:54Z", "message": "[#2234] Reject command message with unsupported body section.\n\nAlso introduce getPayloadSize() method, preventing copy of\nbody section bytes.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "18e69129a4f4aee36352b7e7fd9c76175abb342e", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/18e69129a4f4aee36352b7e7fd9c76175abb342e", "committedDate": "2020-10-12T11:26:40Z", "message": "[#2234] Reject command message with unsupported body section.\n\nAlso introduce getPayloadSize() method, preventing copy of\nbody section bytes.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}, "afterCommit": {"oid": "a25db6cbe2c1ba8465a311d236fc941b9d8db18e", "author": {"user": {"login": "calohmn", "name": "Carsten Lohmann"}}, "url": "https://github.com/eclipse/hono/commit/a25db6cbe2c1ba8465a311d236fc941b9d8db18e", "committedDate": "2020-10-12T11:57:54Z", "message": "[#2234] Reject command message with unsupported body section.\n\nAlso introduce getPayloadSize() method, preventing copy of\nbody section bytes.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2NTY3NzUw", "url": "https://github.com/eclipse/hono/pull/2235#pullrequestreview-506567750", "createdAt": "2020-10-12T12:19:20Z", "commit": {"oid": "a25db6cbe2c1ba8465a311d236fc941b9d8db18e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 603, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}