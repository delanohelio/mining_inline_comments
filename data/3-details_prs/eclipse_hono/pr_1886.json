{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwNzEzMDIy", "number": 1886, "title": "[#1679] Add implementation to resolve group members in MongoDB based device registry", "bodyText": "In this PR, an implementation of the AbstractRegistrationService.resolveGroupMembers(...) has been added to the MongoDB based device registry.", "createdAt": "2020-04-08T08:46:19Z", "url": "https://github.com/eclipse/hono/pull/1886", "merged": true, "mergeCommit": {"oid": "ce2ca2ce9cccf6b0ad40b2099bdb5131225ba0ca"}, "closed": true, "closedAt": "2020-04-09T12:32:35Z", "author": {"login": "kaniyan"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVj5M_gBqjMyMTMxMzY3NDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcV7tNIAFqTM5MDc0OTA3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "22694ec3d83e119cfe5ea7aeb1b654afe536387e", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/22694ec3d83e119cfe5ea7aeb1b654afe536387e", "committedDate": "2020-04-08T08:41:14Z", "message": "[#1679] Add implementation to resolve group members in device registration service.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}, "afterCommit": {"oid": "85d214641e36a97cb359a9f048149dcaf586f373", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/85d214641e36a97cb359a9f048149dcaf586f373", "committedDate": "2020-04-08T08:47:21Z", "message": "[#1679] Add implementation to resolve group members in device registration service.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5OTQ5NDMx", "url": "https://github.com/eclipse/hono/pull/1886#pullrequestreview-389949431", "createdAt": "2020-04-08T13:00:11Z", "commit": {"oid": "85d214641e36a97cb359a9f048149dcaf586f373"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMzowMDoxMVrOGCuD8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMzowMDoxMVrOGCuD8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUwNTAwOQ==", "bodyText": "The span should already be tagged with the tenant ID.", "url": "https://github.com/eclipse/hono/pull/1886#discussion_r405505009", "createdAt": "2020-04-08T13:00:11Z", "author": {"login": "sophokles73"}, "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDbBasedRegistrationService.java", "diffHunk": "@@ -314,6 +319,35 @@ private boolean isDuplicateKeyError(final Throwable throwable) {\n                                 Optional.ofNullable(deviceDto.getVersion()))));\n     }\n \n+    private Future<JsonArray> processResolveGroupMembers(final String tenantId, final JsonArray viaGroups,\n+            final Span span) {\n+        final JsonObject resolveGroupMembersQuery = new MongoDbDocumentBuilder()\n+                .withTenantId(tenantId).document()\n+                .put(String.format(\"%s.%s\", MongoDbDeviceRegistryUtils.FIELD_DEVICE,\n+                        RegistryManagementConstants.FIELD_MEMBER_OF),\n+                        new JsonObject()\n+                                .put(\"$exists\", true)\n+                                .put(\"$in\", viaGroups));\n+        //Retrieve only the deviceId instead of the whole document.\n+        final FindOptions findOptionsForDeviceId = new FindOptions()\n+                .setFields(new JsonObject().put(RegistrationConstants.FIELD_PAYLOAD_DEVICE_ID, true).put(\"_id\", false));\n+        final Promise<List<JsonObject>> resolveGroupMembersPromise = Promise.promise();\n+\n+        mongoClient.findWithOptions(config.getCollectionName(), resolveGroupMembersQuery, findOptionsForDeviceId,\n+                resolveGroupMembersPromise);\n+\n+        return resolveGroupMembersPromise.future()\n+                .map(deviceIdsList -> {\n+                    final JsonArray deviceIds = Optional.ofNullable(deviceIdsList)\n+                            .map(ok -> deviceIdsList.stream()\n+                                    .map(json -> json.getString(RegistrationConstants.FIELD_PAYLOAD_DEVICE_ID))\n+                                    .collect(Collectors.collectingAndThen(Collectors.toList(), JsonArray::new)))\n+                            .orElse(new JsonArray());\n+                    span.log(String.format(\"successfully resolved group members for the tenant [%s]\", tenantId));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85d214641e36a97cb359a9f048149dcaf586f373"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95f61ffe216ac0c5336c51022a7eaeff7fba5334", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/95f61ffe216ac0c5336c51022a7eaeff7fba5334", "committedDate": "2020-04-08T13:46:13Z", "message": "[#1679] Add implementation to resolve group members in device registration service.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "85d214641e36a97cb359a9f048149dcaf586f373", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/85d214641e36a97cb359a9f048149dcaf586f373", "committedDate": "2020-04-08T08:47:21Z", "message": "[#1679] Add implementation to resolve group members in device registration service.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}, "afterCommit": {"oid": "95f61ffe216ac0c5336c51022a7eaeff7fba5334", "author": {"user": {"login": "kaniyan", "name": "Karthees Kalidass"}}, "url": "https://github.com/eclipse/hono/commit/95f61ffe216ac0c5336c51022a7eaeff7fba5334", "committedDate": "2020-04-08T13:46:13Z", "message": "[#1679] Add implementation to resolve group members in device registration service.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNzQ5MDc4", "url": "https://github.com/eclipse/hono/pull/1886#pullrequestreview-390749078", "createdAt": "2020-04-09T12:32:16Z", "commit": {"oid": "95f61ffe216ac0c5336c51022a7eaeff7fba5334"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 853, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}