{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4NDQ3MzY2", "number": 1727, "title": "[#1642] Add Hotrod based DeviceConnectionClient", "bodyText": "The client implementation connects directly to an Infinispan data grid\nto access device connection information. This client is an optimized\nversion of the existing client, skipping the Device Connection service\naltogether. Note that this also means that the client can access all\ndata for all tenants and should therefore not be used with custom\nprotocol adapters.\nIt might also be possible to split up the PR into two parts:\nA first one introducing the Infinispan based DeviceConnectionClient implementation and a second one which refactors the existing Device Connection service implementation to use the new client.", "createdAt": "2020-01-29T09:13:18Z", "url": "https://github.com/eclipse/hono/pull/1727", "merged": true, "mergeCommit": {"oid": "ac742eca5f1ab5459d0bfadd6a50c0312cc14d4c"}, "closed": true, "closedAt": "2020-02-20T16:44:26Z", "author": {"login": "sophokles73"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcC9cixgBqjMwMjI3NzcwODg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGNvM4gBqjMwNTcwNTQxNzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8968b7da9852d7c077d2a80d43658a9ae0fb3c54", "author": {"user": {"login": "sophokles73", "name": "Kai Hudalla"}}, "url": "https://github.com/eclipse/hono/commit/8968b7da9852d7c077d2a80d43658a9ae0fb3c54", "committedDate": "2020-01-28T09:45:46Z", "message": "[#1642] Add Hotrod based DeviceConnectionClient\n\nThe client implementation connects directly to an Infinispan data grid\nto access device connection information. This client is an optimized\nversion of the existing client, skipping the Device Connection service\naltogether. Note that this also means that the client can access all\ndata for all tenants and should therefore not be used with custom\nprotocol adapters.\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>"}, "afterCommit": {"oid": "bd15f72ebe5ca45debcd2b54169b5d286c8903fd", "author": {"user": {"login": "sophokles73", "name": "Kai Hudalla"}}, "url": "https://github.com/eclipse/hono/commit/bd15f72ebe5ca45debcd2b54169b5d286c8903fd", "committedDate": "2020-02-10T12:07:34Z", "message": "[#1642] Add Hotrod based DeviceConnectionClient\n\nThe client implementation connects directly to an Infinispan data grid\nto access device connection information. This client is an optimized\nversion of the existing client, skipping the Device Connection service\naltogether. Note that this also means that the client can access all\ndata for all tenants and should therefore not be used with custom\nprotocol adapters.\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MjcwMTEz", "url": "https://github.com/eclipse/hono/pull/1727#pullrequestreview-358270113", "createdAt": "2020-02-13T14:42:19Z", "commit": {"oid": "bd15f72ebe5ca45debcd2b54169b5d286c8903fd"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNDo0MjoxOVrOFpWXqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNDo0MzoyNFrOFpWaog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODkwMjQ0MA==", "bodyText": "I find having another cache abstraction on top of the existing one a bit of over-complication. We have an abstraction in enmasse of CacheProvider, which adds necessary cache handling but then services use infinispan interfaces directly.\nhttps://github.com/EnMasseProject/enmasse/blob/master/iot/iot-infinispan-base/src/main/java/io/enmasse/iot/infinispan/cache/AbstractCacheProvider.java\nMaybe at some point we can align two implementations more.", "url": "https://github.com/eclipse/hono/pull/1727#discussion_r378902440", "createdAt": "2020-02-13T14:42:19Z", "author": {"login": "dejanb"}, "path": "client-device-connection-infinispan/src/main/java/org/eclipse/hono/deviceconnection/infinispan/client/HotrodCache.java", "diffHunk": "@@ -0,0 +1,279 @@\n+/**\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+\n+package org.eclipse.hono.deviceconnection.infinispan.client;\n+\n+import java.net.HttpURLConnection;\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.Objects;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.eclipse.hono.client.ConnectionLifecycle;\n+import org.eclipse.hono.client.DisconnectListener;\n+import org.eclipse.hono.client.ReconnectListener;\n+import org.eclipse.hono.client.ServerErrorException;\n+import org.infinispan.client.hotrod.RemoteCache;\n+import org.infinispan.client.hotrod.RemoteCacheManager;\n+import org.infinispan.commons.api.BasicCache;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import io.vertx.core.AsyncResult;\n+import io.vertx.core.Future;\n+import io.vertx.core.Handler;\n+import io.vertx.core.Promise;\n+import io.vertx.core.Vertx;\n+import io.vertx.core.json.JsonObject;\n+\n+/**\n+ * A HotrodCache.\n+ *\n+ * @param <K> The type of keys used by the cache.\n+ * @param <V> The type of values stored in the cache.\n+ */\n+public final class HotrodCache<K, V> implements ConnectionLifecycle<HotrodCache<K, V>> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd15f72ebe5ca45debcd2b54169b5d286c8903fd"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODkwMjU3Nw==", "bodyText": "I'm not sure this module should be the \"root\" one of the whole Hono project. I'm not sure yet what would be the best place for it. Maybe put it in the \"client\" one, or as a part of the service implementation. Or even refactor the client one to have submodules like adapters and services.", "url": "https://github.com/eclipse/hono/pull/1727#discussion_r378902577", "createdAt": "2020-02-13T14:42:30Z", "author": {"login": "dejanb"}, "path": "client-device-connection-infinispan/pom.xml", "diffHunk": "@@ -0,0 +1,58 @@\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd15f72ebe5ca45debcd2b54169b5d286c8903fd"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODkwMzIwMg==", "bodyText": "Why not use RemoteCache or AdvanceCache interfaces and then use \"async\" variant of the calls instead of handling this manually?", "url": "https://github.com/eclipse/hono/pull/1727#discussion_r378903202", "createdAt": "2020-02-13T14:43:24Z", "author": {"login": "dejanb"}, "path": "client-device-connection-infinispan/src/main/java/org/eclipse/hono/deviceconnection/infinispan/client/HotrodCache.java", "diffHunk": "@@ -0,0 +1,279 @@\n+/**\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+\n+package org.eclipse.hono.deviceconnection.infinispan.client;\n+\n+import java.net.HttpURLConnection;\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.Objects;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.eclipse.hono.client.ConnectionLifecycle;\n+import org.eclipse.hono.client.DisconnectListener;\n+import org.eclipse.hono.client.ReconnectListener;\n+import org.eclipse.hono.client.ServerErrorException;\n+import org.infinispan.client.hotrod.RemoteCache;\n+import org.infinispan.client.hotrod.RemoteCacheManager;\n+import org.infinispan.commons.api.BasicCache;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import io.vertx.core.AsyncResult;\n+import io.vertx.core.Future;\n+import io.vertx.core.Handler;\n+import io.vertx.core.Promise;\n+import io.vertx.core.Vertx;\n+import io.vertx.core.json.JsonObject;\n+\n+/**\n+ * A HotrodCache.\n+ *\n+ * @param <K> The type of keys used by the cache.\n+ * @param <V> The type of values stored in the cache.\n+ */\n+public final class HotrodCache<K, V> implements ConnectionLifecycle<HotrodCache<K, V>> {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(HotrodCache.class);\n+\n+    private final AtomicBoolean connecting = new AtomicBoolean(false);\n+    private final Vertx vertx;\n+    private final RemoteCacheManager cacheManager;\n+    private final String cacheName;\n+    private final K connectionCheckKey;\n+    private final V connectionCheckValue;\n+\n+    private RemoteCache<K, V> cache;\n+\n+    /**\n+     * @param vertx The vert.x instance to run on.\n+     * @param cacheManager The connection to the remote cache.\n+     * @param name The name of the (remote) cache.\n+     * @param connectionCheckKey The key to use for checking the connection\n+     *                           to the data grid.\n+     * @param connectionCheckValue The value to use for checking the connection\n+     *                           to the data grid.\n+     */\n+    public HotrodCache(\n+            final Vertx vertx,\n+            final RemoteCacheManager cacheManager,\n+            final String name,\n+            final K connectionCheckKey,\n+            final V connectionCheckValue) {\n+        this.vertx = Objects.requireNonNull(vertx);\n+        this.cacheManager = Objects.requireNonNull(cacheManager);\n+        this.cacheName = Objects.requireNonNull(name);\n+        this.connectionCheckKey = Objects.requireNonNull(connectionCheckKey);\n+        this.connectionCheckValue = Objects.requireNonNull(connectionCheckValue);\n+    }\n+\n+    public BasicCache<K, V> getCache() {\n+        return cache;\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public Future<HotrodCache<K, V>> connect() {\n+        return connectToGrid().map(ok -> this);\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public Future<Void> isConnected() {\n+        return checkForCacheAvailability().mapEmpty();\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void disconnect() {\n+        disconnect(r -> {});\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void disconnect(final Handler<AsyncResult<Void>> completionHandler) {\n+\n+        vertx.executeBlocking(r -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd15f72ebe5ca45debcd2b54169b5d286c8903fd"}, "originalPosition": 115}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7db2442c6a54e8a05d8817b45b232495bef118ed", "author": {"user": {"login": "sophokles73", "name": "Kai Hudalla"}}, "url": "https://github.com/eclipse/hono/commit/7db2442c6a54e8a05d8817b45b232495bef118ed", "committedDate": "2020-02-14T13:25:57Z", "message": "[#1642] Add Hotrod based DeviceConnectionClient\n\nThe client implementation connects directly to an Infinispan data grid\nto access device connection information. This client is an optimized\nversion of the existing client, skipping the Device Connection service\naltogether. Note that this also means that the client can access all\ndata for all tenants and should therefore not be used with custom\nprotocol adapters.\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4OTcwNDkw", "url": "https://github.com/eclipse/hono/pull/1727#pullrequestreview-358970490", "createdAt": "2020-02-14T14:18:21Z", "commit": {"oid": "bd15f72ebe5ca45debcd2b54169b5d286c8903fd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNDoxODoyMVrOFp3-mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNDoxODoyMVrOFp3-mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ1MzA4Mw==", "bodyText": "This name very much implies there being only one cache for the device connection data. However, for #1272 there will be other data added (mapping between device id and id of the protocol adapter instance that has a command consumer for that device). I would rather put this data in a separate Infinispan cache. So then there would be 2 Infinispan caches used for device connection data.\nSo, for now the name is Ok, for #1272 I think it will better be renamed to something like LastKnownGatewayInfoCache.", "url": "https://github.com/eclipse/hono/pull/1727#discussion_r379453083", "createdAt": "2020-02-14T14:18:21Z", "author": {"login": "calohmn"}, "path": "client-device-connection-infinispan/src/main/java/org/eclipse/hono/deviceconnection/infinispan/client/DeviceConnectionInfoCache.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/**\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.eclipse.hono.deviceconnection.infinispan.client;\n+\n+import io.opentracing.SpanContext;\n+import io.vertx.core.Future;\n+import io.vertx.core.json.JsonObject;\n+\n+/**\n+ * A repository for keeping connection information about devices.\n+ *\n+ */\n+public interface DeviceConnectionInfoCache {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd15f72ebe5ca45debcd2b54169b5d286c8903fd"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MDA4NzQ2", "url": "https://github.com/eclipse/hono/pull/1727#pullrequestreview-359008746", "createdAt": "2020-02-14T15:11:44Z", "commit": {"oid": "bd15f72ebe5ca45debcd2b54169b5d286c8903fd"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNToxMTo0NVrOFp5xfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNToyNDo1OVrOFp6Ong==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ4MjQ5NQ==", "bodyText": "I think the type parameter T should better be renamed so that it doesn't hide the T parameter of the enclosing class.", "url": "https://github.com/eclipse/hono/pull/1727#discussion_r379482495", "createdAt": "2020-02-14T15:11:45Z", "author": {"login": "calohmn"}, "path": "service-base/src/main/java/org/eclipse/hono/service/AbstractProtocolAdapterBase.java", "diffHunk": "@@ -719,8 +744,9 @@ protected void doStop(final Promise<Void> stopPromise) {\n      *         connection cannot be established.\n      * @throws NullPointerException if serviceName is {@code null}.\n      * @throws IllegalArgumentException if factory is {@code null}.\n+     * @param <T> The type of connection that the factory uses.\n      */\n-    protected final Future<HonoConnection> connectToService(final ConnectionLifecycle<HonoConnection> factory, final String serviceName) {\n+    protected final <T> Future<T> connectToService(final ConnectionLifecycle<T> factory, final String serviceName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd15f72ebe5ca45debcd2b54169b5d286c8903fd"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ4MjcxNA==", "bodyText": "I think the type parameter T should better be renamed so that it doesn't hide the T parameter of the enclosing class.", "url": "https://github.com/eclipse/hono/pull/1727#discussion_r379482714", "createdAt": "2020-02-14T15:12:08Z", "author": {"login": "calohmn"}, "path": "service-base/src/main/java/org/eclipse/hono/service/AbstractProtocolAdapterBase.java", "diffHunk": "@@ -738,12 +764,13 @@ protected void doStop(final Promise<Void> stopPromise) {\n      *         connection cannot be established.\n      * @throws NullPointerException if serviceName is {@code null}.\n      * @throws IllegalArgumentException if factory is {@code null}.\n+     * @param <T> The type of connection that the factory uses.\n      */\n-    protected final Future<HonoConnection> connectToService(\n-            final ConnectionLifecycle<HonoConnection> factory,\n+    protected final <T> Future<T> connectToService(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd15f72ebe5ca45debcd2b54169b5d286c8903fd"}, "originalPosition": 136}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ4Mzc0OQ==", "bodyText": "final?", "url": "https://github.com/eclipse/hono/pull/1727#discussion_r379483749", "createdAt": "2020-02-14T15:13:59Z", "author": {"login": "calohmn"}, "path": "services/device-connection/src/main/java/org/eclipse/hono/deviceconnection/infinispan/RemoteCacheBasedDeviceConnectionService.java", "diffHunk": "@@ -46,100 +37,16 @@\n  */\n public class RemoteCacheBasedDeviceConnectionService extends EventBusDeviceConnectionAdapter implements DeviceConnectionService, HealthCheckProvider {\n \n-    private static final String CACHE_NAME = \"device-connection\";\n-\n-    private RemoteCacheContainer cacheManager;\n-    private BasicCache<String, String> cache;\n-    private AtomicBoolean connecting = new AtomicBoolean(false);\n+    private DeviceConnectionInfoCache cache;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd15f72ebe5ca45debcd2b54169b5d286c8903fd"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ4OTk1MA==", "bodyText": "How about adding the added logger definitions also to the other adapters?", "url": "https://github.com/eclipse/hono/pull/1727#discussion_r379489950", "createdAt": "2020-02-14T15:24:59Z", "author": {"login": "calohmn"}, "path": "adapters/amqp-vertx/src/main/resources/logback-spring.xml", "diffHunk": "@@ -41,6 +42,7 @@\n     <logger name=\"org.eclipse.hono.client\" level=\"DEBUG\"/>\n     <logger name=\"org.eclipse.hono.client.impl.AbstractRequestResponseClient\" level=\"DEBUG\"/>\n     <logger name=\"org.eclipse.hono.connection\" level=\"DEBUG\"/>\n+    <logger name=\"org.eclipse.hono.deviceconnection.infinispan.client\" level=\"DEBUG\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd15f72ebe5ca45debcd2b54169b5d286c8903fd"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e811d30dbcef68504c1cffd330ec784bf4ff1d4", "author": {"user": {"login": "sophokles73", "name": "Kai Hudalla"}}, "url": "https://github.com/eclipse/hono/commit/6e811d30dbcef68504c1cffd330ec784bf4ff1d4", "committedDate": "2020-02-20T13:04:26Z", "message": "Suggested changes\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1635991bc127497b03eb0ae92856ef7e6ff39d1", "author": {"user": {"login": "sophokles73", "name": "Kai Hudalla"}}, "url": "https://github.com/eclipse/hono/commit/a1635991bc127497b03eb0ae92856ef7e6ff39d1", "committedDate": "2020-02-20T15:11:59Z", "message": "Rename DeviceConnectionInfo\n\nadded tests\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bd15f72ebe5ca45debcd2b54169b5d286c8903fd", "author": {"user": {"login": "sophokles73", "name": "Kai Hudalla"}}, "url": "https://github.com/eclipse/hono/commit/bd15f72ebe5ca45debcd2b54169b5d286c8903fd", "committedDate": "2020-02-10T12:07:34Z", "message": "[#1642] Add Hotrod based DeviceConnectionClient\n\nThe client implementation connects directly to an Infinispan data grid\nto access device connection information. This client is an optimized\nversion of the existing client, skipping the Device Connection service\naltogether. Note that this also means that the client can access all\ndata for all tenants and should therefore not be used with custom\nprotocol adapters.\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>"}, "afterCommit": {"oid": "a1635991bc127497b03eb0ae92856ef7e6ff39d1", "author": {"user": {"login": "sophokles73", "name": "Kai Hudalla"}}, "url": "https://github.com/eclipse/hono/commit/a1635991bc127497b03eb0ae92856ef7e6ff39d1", "committedDate": "2020-02-20T15:11:59Z", "message": "Rename DeviceConnectionInfo\n\nadded tests\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 940, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}