{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3NjE5MzA4", "number": 2286, "title": "[#2267] Add AMQP 1.0 based DeviceConnectionClient implementation", "bodyText": "Added transport protocol agnostic DeviceConnectionClient interface to\nthe adapter client module.\nAdded AMQP 1.0 based implementation which simply wraps the existing\nvertx-proton based \"legacy\" DeviceConnectionClientImpl.", "createdAt": "2020-11-09T09:29:46Z", "url": "https://github.com/eclipse/hono/pull/2286", "merged": true, "mergeCommit": {"oid": "651fcbfe3f528e87f574344d4a9647b071c21f84"}, "closed": true, "closedAt": "2020-11-09T14:12:40Z", "author": {"login": "sophokles73"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdaxVvvAH2gAyNTE3NjE5MzA4OjBiYzE5YTA4MTM2YjE4NzQ4ZmUwZmIwNjIzODEzNjA0ZTAyYjdmZWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABda1X7LAFqTUyNjI5MTk2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0bc19a08136b18748fe0fb0623813604e02b7fec", "author": {"user": {"login": "sophokles73", "name": "Kai Hudalla"}}, "url": "https://github.com/eclipse/hono/commit/0bc19a08136b18748fe0fb0623813604e02b7fec", "committedDate": "2020-11-09T09:28:22Z", "message": "[#2267] Add AMQP 1.0 based DeviceConnectionClient implementation\n\nAdded transport protocol agnostic DeviceConnectionClient interface to\nthe adapter client module.\nAdded AMQP 1.0 based implementation which simply wraps the existing\nvertx-proton based \"legacy\" DeviceConnectionClientImpl.\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MDg4MzAy", "url": "https://github.com/eclipse/hono/pull/2286#pullrequestreview-526088302", "createdAt": "2020-11-09T09:55:39Z", "commit": {"oid": "0bc19a08136b18748fe0fb0623813604e02b7fec"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwOTo1NTozOVrOHvm3lA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMDoyNDowMlrOHvn_-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY4MTk0MA==", "bodyText": "A few lines below, the exception text\n\nDevice Connection client factory is not set\n\nshould be replaced.\nRegarding the isConnected() method in general:\nIt doesn't actually do what it proclaims in the javadoc anymore. The method is currently used in the MQTT adapter and in the registerReadinessChecks method of this class. I guess the invocation in the MQTT adapter isn't needed anymore (a missing connection will result in a failed future when using the respective clients anyway).\nI think since it's then only invoked from registerReadinessChecks, isConnected() can be renamed and turned into a private method, or possibly inlined into registerReadinessChecks.", "url": "https://github.com/eclipse/hono/pull/2286#discussion_r519681940", "createdAt": "2020-11-09T09:55:39Z", "author": {"login": "calohmn"}, "path": "service-base/src/main/java/org/eclipse/hono/service/AbstractProtocolAdapterBase.java", "diffHunk": "@@ -1010,9 +993,9 @@ protected void onCommandConnectionEstablished(final HonoConnection commandConnec\n                 .map(client -> client.isConnected())\n                 .orElseGet(() -> Future.failedFuture(new ServerErrorException(\n                         HttpURLConnection.HTTP_UNAVAILABLE, \"Command & Control client factory is not set\"))));\n-        connections.add(Optional.ofNullable(deviceConnectionClientFactory)\n+        connections.add(Optional.ofNullable(deviceConnectionClient)\n                 .map(client -> {\n-                    if (deviceConnectionClientFactory instanceof ConnectionLifecycle) {\n+                    if (deviceConnectionClient instanceof ConnectionLifecycle) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bc19a08136b18748fe0fb0623813604e02b7fec"}, "originalPosition": 177}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY4NjY2MA==", "bodyText": "Corresponding dependency can be removed from the dependent \"hono-adapter-base-spring\" module then.", "url": "https://github.com/eclipse/hono/pull/2286#discussion_r519686660", "createdAt": "2020-11-09T10:02:29Z", "author": {"login": "calohmn"}, "path": "adapters/pom.xml", "diffHunk": "@@ -113,6 +113,10 @@\n       <groupId>org.eclipse.hono</groupId>\n       <artifactId>service-base-test-utils</artifactId>\n     </dependency>\n+    <dependency>\n+      <groupId>org.eclipse.hono</groupId>\n+      <artifactId>hono-service-base</artifactId>\n+    </dependency>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bc19a08136b18748fe0fb0623813604e02b7fec"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY5MTY1OQ==", "bodyText": "Wouldn't it make sense to remove the 'hono-service-base' dependency here and add the exclusion to the existing 'hono-service-base' dependency in the parent 'hono-services' module?", "url": "https://github.com/eclipse/hono/pull/2286#discussion_r519691659", "createdAt": "2020-11-09T10:10:28Z", "author": {"login": "calohmn"}, "path": "services/device-connection/pom.xml", "diffHunk": "@@ -25,6 +25,16 @@\n       <groupId>org.eclipse.hono</groupId>\n       <artifactId>client-device-connection-infinispan</artifactId>\n     </dependency>\n+    <dependency>\n+      <groupId>org.eclipse.hono</groupId>\n+      <artifactId>hono-service-base</artifactId>\n+      <exclusions>\n+        <exclusion>\n+          <groupId>org.eclipse.hono</groupId>\n+          <artifactId>hono-client-adapter-amqp</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bc19a08136b18748fe0fb0623813604e02b7fec"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTcwMDQ3NQ==", "bodyText": "Device Connection service", "url": "https://github.com/eclipse/hono/pull/2286#discussion_r519700475", "createdAt": "2020-11-09T10:24:02Z", "author": {"login": "calohmn"}, "path": "clients/adapter-amqp/src/main/java/org/eclipse/hono/adapter/client/command/amqp/ProtonBasedDeviceConnectionClient.java", "diffHunk": "@@ -0,0 +1,193 @@\n+/**\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+\n+package org.eclipse.hono.adapter.client.command.amqp;\n+\n+import java.time.Duration;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import org.eclipse.hono.adapter.client.amqp.AbstractRequestResponseClient;\n+import org.eclipse.hono.adapter.client.command.DeviceConnectionClient;\n+import org.eclipse.hono.client.HonoConnection;\n+import org.eclipse.hono.client.SendMessageSampler.Factory;\n+import org.eclipse.hono.client.impl.CachingClientFactory;\n+import org.eclipse.hono.client.impl.CredentialsClientImpl;\n+import org.eclipse.hono.client.impl.DeviceConnectionClientImpl;\n+import org.eclipse.hono.config.ProtocolAdapterProperties;\n+import org.eclipse.hono.util.Constants;\n+import org.eclipse.hono.util.DeviceConnectionConstants;\n+import org.eclipse.hono.util.DeviceConnectionResult;\n+\n+import io.opentracing.SpanContext;\n+import io.vertx.core.Future;\n+import io.vertx.core.eventbus.Message;\n+import io.vertx.core.json.JsonObject;\n+\n+\n+/**\n+ * A ProtonBasedDeviceConnectionClient.\n+ *\n+ */\n+public class ProtonBasedDeviceConnectionClient extends AbstractRequestResponseClient<DeviceConnectionResult>\n+        implements DeviceConnectionClient {\n+\n+    private final CachingClientFactory<org.eclipse.hono.client.DeviceConnectionClient> clientFactory;\n+\n+    /**\n+     * Creates a new client for a connection.\n+     *\n+     * @param connection The connection to the Credentials service.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bc19a08136b18748fe0fb0623813604e02b7fec"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "723a5e5dfed5fa7f65eefe989074ac909fb432df", "author": {"user": {"login": "sophokles73", "name": "Kai Hudalla"}}, "url": "https://github.com/eclipse/hono/commit/723a5e5dfed5fa7f65eefe989074ac909fb432df", "committedDate": "2020-11-09T13:52:47Z", "message": "Incorporate feedback\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MjkxOTY1", "url": "https://github.com/eclipse/hono/pull/2286#pullrequestreview-526291965", "createdAt": "2020-11-09T14:10:22Z", "commit": {"oid": "723a5e5dfed5fa7f65eefe989074ac909fb432df"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 431, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}