{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzMTQ5MTMx", "number": 4947, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjo0MTo0NFrOEoK-9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjo0MjoxOFrOEoK_rA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwNTU4NDUzOnYy", "diffSide": "RIGHT", "path": "support/cas-server-support-otp-mfa-core/src/main/java/org/apereo/cas/otp/util/QRUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjo0MTo0NFrOHZG31A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMzo1NTo0M1rOHfKxWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA4OTA0NA==", "bodyText": "Remove \"data:image/png;base64,\" and move it over to the actual template to be consistent with other areas in CAS doing the same.", "url": "https://github.com/apereo/cas/pull/4947#discussion_r496089044", "createdAt": "2020-09-28T16:41:44Z", "author": {"login": "mmoayyed"}, "path": "support/cas-server-support-otp-mfa-core/src/main/java/org/apereo/cas/otp/util/QRUtils.java", "diffHunk": "@@ -66,7 +69,13 @@ public static void generateQRCode(final OutputStream stream, final String key,\n                 .filter(j -> byteMatrix.get(i, j))\n                 .forEach(j -> graphics.fillRect(i, j, 1, 1)));\n \n-        ImageIO.write(image, \"png\", stream);\n+        ByteArrayOutputStream out = new ByteArrayOutputStream();\n+        ImageIO.write(image, \"PNG\", out);\n+        byte[] bytes = out.toByteArray();\n+\n+        String base64bytes = EncodingUtils.encodeBase64(bytes);\n+        String src = \"data:image/png;base64,\" + base64bytes;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98df1509fe1e359698feeb24243caaca9a508367"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ0NDM3OQ==", "bodyText": "I've pushed a fixup to address this one", "url": "https://github.com/apereo/cas/pull/4947#discussion_r502444379", "createdAt": "2020-10-09T13:55:43Z", "author": {"login": "linosgian"}, "path": "support/cas-server-support-otp-mfa-core/src/main/java/org/apereo/cas/otp/util/QRUtils.java", "diffHunk": "@@ -66,7 +69,13 @@ public static void generateQRCode(final OutputStream stream, final String key,\n                 .filter(j -> byteMatrix.get(i, j))\n                 .forEach(j -> graphics.fillRect(i, j, 1, 1)));\n \n-        ImageIO.write(image, \"png\", stream);\n+        ByteArrayOutputStream out = new ByteArrayOutputStream();\n+        ImageIO.write(image, \"PNG\", out);\n+        byte[] bytes = out.toByteArray();\n+\n+        String base64bytes = EncodingUtils.encodeBase64(bytes);\n+        String src = \"data:image/png;base64,\" + base64bytes;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA4OTA0NA=="}, "originalCommit": {"oid": "98df1509fe1e359698feeb24243caaca9a508367"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwNTU4NjM2OnYy", "diffSide": "RIGHT", "path": "support/cas-server-support-otp-mfa-core/src/main/java/org/apereo/cas/otp/web/flow/OneTimeTokenAccountCheckRegistrationAction.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjo0MjoxOFrOHZG5Bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMzo1NjoxNFrOHfKyrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA4OTM1MQ==", "bodyText": "Renaming a flow-scope variable will surely break tests. Please review and adjust.", "url": "https://github.com/apereo/cas/pull/4947#discussion_r496089351", "createdAt": "2020-09-28T16:42:18Z", "author": {"login": "mmoayyed"}, "path": "support/cas-server-support-otp-mfa-core/src/main/java/org/apereo/cas/otp/web/flow/OneTimeTokenAccountCheckRegistrationAction.java", "diffHunk": "@@ -45,9 +48,12 @@ protected Event doExecute(final RequestContext requestContext) {\n         if (acct == null || StringUtils.isBlank(acct.getSecretKey())) {\n             val keyAccount = this.repository.create(uid);\n             val keyUri = \"otpauth://totp/\" + this.label + ':' + uid + \"?secret=\" + keyAccount.getSecretKey() + \"&issuer=\" + this.issuer;\n+            ByteArrayOutputStream QRcodeBase64 = new ByteArrayOutputStream();\n+            QRUtils.generateQRCode(QRcodeBase64, keyUri, QRUtils.WIDTH_LARGE, QRUtils.WIDTH_LARGE);\n+\n             val flowScope = requestContext.getFlowScope();\n             flowScope.put(FLOW_SCOPE_ATTR_ACCOUNT, keyAccount);\n-            flowScope.put(FLOW_SCOPE_ATTR_ACCOUNT_URI, keyUri);\n+            flowScope.put(FLOW_SCOPE_ATTR_QR_IMAGE_BASE64, QRcodeBase64);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98df1509fe1e359698feeb24243caaca9a508367"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ0NDcxNw==", "bodyText": "Right, I've fixed the tests as well. We should be okay now", "url": "https://github.com/apereo/cas/pull/4947#discussion_r502444717", "createdAt": "2020-10-09T13:56:14Z", "author": {"login": "linosgian"}, "path": "support/cas-server-support-otp-mfa-core/src/main/java/org/apereo/cas/otp/web/flow/OneTimeTokenAccountCheckRegistrationAction.java", "diffHunk": "@@ -45,9 +48,12 @@ protected Event doExecute(final RequestContext requestContext) {\n         if (acct == null || StringUtils.isBlank(acct.getSecretKey())) {\n             val keyAccount = this.repository.create(uid);\n             val keyUri = \"otpauth://totp/\" + this.label + ':' + uid + \"?secret=\" + keyAccount.getSecretKey() + \"&issuer=\" + this.issuer;\n+            ByteArrayOutputStream QRcodeBase64 = new ByteArrayOutputStream();\n+            QRUtils.generateQRCode(QRcodeBase64, keyUri, QRUtils.WIDTH_LARGE, QRUtils.WIDTH_LARGE);\n+\n             val flowScope = requestContext.getFlowScope();\n             flowScope.put(FLOW_SCOPE_ATTR_ACCOUNT, keyAccount);\n-            flowScope.put(FLOW_SCOPE_ATTR_ACCOUNT_URI, keyUri);\n+            flowScope.put(FLOW_SCOPE_ATTR_QR_IMAGE_BASE64, QRcodeBase64);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA4OTM1MQ=="}, "originalCommit": {"oid": "98df1509fe1e359698feeb24243caaca9a508367"}, "originalPosition": 39}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3978, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}