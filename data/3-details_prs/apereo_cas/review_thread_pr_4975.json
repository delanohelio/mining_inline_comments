{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3NDYxNzM0", "number": 4975, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwODo1Mjo1MlrOE7carg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwODo1NzoxOVrOE7cg-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwNzY3MDIyOnYy", "diffSide": "RIGHT", "path": ".github/workflows/initializr-build.yml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwODo1Mjo1MlrOH3GH4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwODo1Mjo1MlrOH3GH4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzNDA1MQ==", "bodyText": "Please move the version next to JDK_CURRENT, so it'd be easier to update later on.", "url": "https://github.com/apereo/cas/pull/4975#discussion_r527534051", "createdAt": "2020-11-20T08:52:52Z", "author": {"login": "mmoayyed"}, "path": ".github/workflows/initializr-build.yml", "diffHunk": "@@ -72,3 +72,43 @@ jobs:\n           imageTag=(`./gradlew casVersion --q`)\n           echo \"Pushing Docker image with tag $imageTag\"\n           docker push apereo/cas-initializr:\"$imageTag\"\n+  helm:\n+    needs: [build]\n+    runs-on: ubuntu-latest\n+    strategy:\n+      matrix:\n+        k3s-version: [v1.19.2, v1.18.9, v1.17.11] # v1.16.15\n+    env:\n+      GOPATH: /home/runner/go\n+    steps:\n+      - name: Checkout code\n+        uses: actions/checkout@v2\n+      - name: Set up JDK\n+        uses: actions/setup-java@v1\n+        with:\n+          java-version: ${{ env.JDK_CURRENT }}\n+      - uses: actions/download-artifact@v2\n+        with:\n+          name: binary-artifacts\n+      - name: Install K3S\n+        env:\n+          INSTALL_K3S_VERSION: ${{ matrix.k3s-version }}+k3s1\n+          INSTALL_K3S_EXEC: \"--disable=traefik\" # using ingress-nginx\n+        run: |\n+          set -x\n+          curl -sfL https://get.k3s.io | sh -\n+          sudo chmod -R a+rw /etc/rancher/k3s\n+          sudo mkdir -p $HOME/.kube && sudo chown -R runner $HOME/.kube\n+          sudo k3s kubectl config view --raw > $HOME/.kube/config\n+          sudo chown runner $HOME/.kube/config\n+          kubectl version\n+      - name: Add /usr/local/bin to PATH\n+        run: |\n+          echo \"/usr/local/bin\" >> $GITHUB_PATH\n+      - name: Install helm 3\n+        uses: azure/setup-helm@v1\n+        with:\n+          version: 'v3.4.0'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "430740a3f1d0046ad3915ad56451e76f67eba285"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwNzY3MDcxOnYy", "diffSide": "RIGHT", "path": ".github/workflows/initializr-build.yml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwODo1MzowMlrOH3GIMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwODo1MzowMlrOH3GIMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzNDEyOA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  - name: Install helm 3\n          \n          \n            \n                  - name: Install helm", "url": "https://github.com/apereo/cas/pull/4975#discussion_r527534128", "createdAt": "2020-11-20T08:53:02Z", "author": {"login": "mmoayyed"}, "path": ".github/workflows/initializr-build.yml", "diffHunk": "@@ -72,3 +72,43 @@ jobs:\n           imageTag=(`./gradlew casVersion --q`)\n           echo \"Pushing Docker image with tag $imageTag\"\n           docker push apereo/cas-initializr:\"$imageTag\"\n+  helm:\n+    needs: [build]\n+    runs-on: ubuntu-latest\n+    strategy:\n+      matrix:\n+        k3s-version: [v1.19.2, v1.18.9, v1.17.11] # v1.16.15\n+    env:\n+      GOPATH: /home/runner/go\n+    steps:\n+      - name: Checkout code\n+        uses: actions/checkout@v2\n+      - name: Set up JDK\n+        uses: actions/setup-java@v1\n+        with:\n+          java-version: ${{ env.JDK_CURRENT }}\n+      - uses: actions/download-artifact@v2\n+        with:\n+          name: binary-artifacts\n+      - name: Install K3S\n+        env:\n+          INSTALL_K3S_VERSION: ${{ matrix.k3s-version }}+k3s1\n+          INSTALL_K3S_EXEC: \"--disable=traefik\" # using ingress-nginx\n+        run: |\n+          set -x\n+          curl -sfL https://get.k3s.io | sh -\n+          sudo chmod -R a+rw /etc/rancher/k3s\n+          sudo mkdir -p $HOME/.kube && sudo chown -R runner $HOME/.kube\n+          sudo k3s kubectl config view --raw > $HOME/.kube/config\n+          sudo chown runner $HOME/.kube/config\n+          kubectl version\n+      - name: Add /usr/local/bin to PATH\n+        run: |\n+          echo \"/usr/local/bin\" >> $GITHUB_PATH\n+      - name: Install helm 3", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "430740a3f1d0046ad3915ad56451e76f67eba285"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwNzY3NDM3OnYy", "diffSide": "RIGHT", "path": "app/src/main/resources/overlay/helmcharts/helm/README.md", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwODo1NDowOFrOH3GKkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwODo1NDowOFrOH3GKkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzNDczOQ==", "bodyText": "Add a new line to separate headers from content.", "url": "https://github.com/apereo/cas/pull/4975#discussion_r527534739", "createdAt": "2020-11-20T08:54:08Z", "author": {"login": "mmoayyed"}, "path": "app/src/main/resources/overlay/helmcharts/helm/README.md", "diffHunk": "@@ -0,0 +1,101 @@\n+## Helm Charts for CAS\n+\n+The current helm chart for cas-server is a WIP. \n+It needs work and probably won't maintain backwards compatibility.\n+Contributions welcome. Eventually it would be nice to support running containers with bootadmin and config-server\n+pre-configured to work, and to have cas-management available as its own helm chart (or running as part of this one).\n+The chart supports mapping in arbitrary volumes and cas config can be specified in values files.  \n+\n+### Install Kubernetes (Docker for Windows/Mac, Minikube, K3S, Rancher, etc)\n+[Docker Desktop](https://www.docker.com/products/docker-desktop)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "430740a3f1d0046ad3915ad56451e76f67eba285"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwNzY4MDY5OnYy", "diffSide": "RIGHT", "path": "app/src/main/resources/overlay/helmcharts/helm/README.md", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwODo1NTo0N1rOH3GOSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMjoyOTo1MlrOH9CayA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzNTY4OQ==", "bodyText": "This bit is fine, but I'd suggest that you remove it, and instead let's add a section/page to the CAS documentation instead, which would be much more likely to be read, or indexed/searched by engines. This goes for the entire readme of course.", "url": "https://github.com/apereo/cas/pull/4975#discussion_r527535689", "createdAt": "2020-11-20T08:55:47Z", "author": {"login": "mmoayyed"}, "path": "app/src/main/resources/overlay/helmcharts/helm/README.md", "diffHunk": "@@ -0,0 +1,101 @@\n+## Helm Charts for CAS\n+\n+The current helm chart for cas-server is a WIP. \n+It needs work and probably won't maintain backwards compatibility.\n+Contributions welcome. Eventually it would be nice to support running containers with bootadmin and config-server\n+pre-configured to work, and to have cas-management available as its own helm chart (or running as part of this one).\n+The chart supports mapping in arbitrary volumes and cas config can be specified in values files.  ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "430740a3f1d0046ad3915ad56451e76f67eba285"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcwNjUwMA==", "bodyText": "So you think this should be a new page in the Installation section of the CAS docs? Is the initializer covered in the docs yet? This sort of depends on that (if only b/c that is where the code lives). I agree this should eventually live in the docs but it might be a little early, but I can put it there if you prefer.", "url": "https://github.com/apereo/cas/pull/4975#discussion_r530706500", "createdAt": "2020-11-26T00:26:52Z", "author": {"login": "hdeadman"}, "path": "app/src/main/resources/overlay/helmcharts/helm/README.md", "diffHunk": "@@ -0,0 +1,101 @@\n+## Helm Charts for CAS\n+\n+The current helm chart for cas-server is a WIP. \n+It needs work and probably won't maintain backwards compatibility.\n+Contributions welcome. Eventually it would be nice to support running containers with bootadmin and config-server\n+pre-configured to work, and to have cas-management available as its own helm chart (or running as part of this one).\n+The chart supports mapping in arbitrary volumes and cas config can be specified in values files.  ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzNTY4OQ=="}, "originalCommit": {"oid": "430740a3f1d0046ad3915ad56451e76f67eba285"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgyMDc3Mw==", "bodyText": "I think we should have a dedicated page to describe how one could use with Helm w/ CAS, with more or less generic instructions similar to how there exists one for Docker. We should also have a dedicated page for the Initializr (TBD) that outlines its capabilities, including the Helm configuration and setup.\nThis should help users from either category. I assume it's possible to use the Helm configuration independently without having to deal with CAS overlays, Gradle and such?\nI will be adding a page for the Initializr after the RC5 release. So by Monday, we could try to re-organize the docs a bit with what you have here.", "url": "https://github.com/apereo/cas/pull/4975#discussion_r530820773", "createdAt": "2020-11-26T07:31:55Z", "author": {"login": "mmoayyed"}, "path": "app/src/main/resources/overlay/helmcharts/helm/README.md", "diffHunk": "@@ -0,0 +1,101 @@\n+## Helm Charts for CAS\n+\n+The current helm chart for cas-server is a WIP. \n+It needs work and probably won't maintain backwards compatibility.\n+Contributions welcome. Eventually it would be nice to support running containers with bootadmin and config-server\n+pre-configured to work, and to have cas-management available as its own helm chart (or running as part of this one).\n+The chart supports mapping in arbitrary volumes and cas config can be specified in values files.  ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzNTY4OQ=="}, "originalCommit": {"oid": "430740a3f1d0046ad3915ad56451e76f67eba285"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc2NDgwOA==", "bodyText": "I think you always need to build your own docker image so I don't know how you do that without gradle, so i think you would always have an overlay (or gradle project from initializr). The image could be built by a different team than the person that used it to install the helm chart so in that sense you could use helm with just a reference to a CAS image in a docker registry (custom built by someone for your particular deployment). That process of running initializer, building image and pushing to docker hub (or private registry) could be done in a gitlab or github pipeline so people could clone the pipeline, configure their credentials  and desired modules as external variables or arguments and then get an image without ever running gradle themselves.\nI think the chart is at a decent place (alpha) in the sense that in the cicd pipeline it installs the chart and then CAS and boot admin both come up and talk to each other. Everything is using SSL and one could argue that SSL could terminate at the ingress controller. If I was deploying this with X509 auth I would terminate client ssl at an F5 or HAProxy and send the client cert to kubernetes ingress controller via http header (and that could be SSL too). Eventually maybe there will be an option to use SSL or not. The validate-helm.sh script is running with set -e so if anything breaks it should show up in the pipeline as failed.\nThe values.yaml contains cas config that can include references to helm values from values file or other values files and set arguments, but the template functions only work if property file is yaml format. I think it is due to this issue:\nhelm/helm#8890\nhelm/helm#7704\nBasically you can only use the {{ .Values.someval }} in the yaml configmap in the values file (unless it is in first 80 characters of the non-yaml properties file).\nI may add something so that the default config can pull services out of a git service registry and maybe install a ticket registry like redis (from a stock helm chart) so that the CAS cluster could be scaled up and be available to run a load test against.\nOther TODOs:\n\nmoving the credentials used by CAS and Boot Admin to into secrets (or encrypting them)\nsetting CAS jasypt encryption keys as secrets\ndo something with cas shell... maybe run an image that stays running with some dummy command and someone can exec into it and run the shell?\ndo something for saml metadata (chart already supports arbitrary volumes so someone could mount a PV now)\nadd way to specify spring profiles that are used via helm values\nmake boot admin optional\nchart is currently using hdeadman/cas-bootadmin-server docker hub image for boot admin but I can switch to apereo when you publish new one, I built mine from current overlay template\neventually publish helm chart or host it somewhere\n\nDo you envision this initializr branch being incorporated into master at some point? It seems sort of hidden but I suppose the documentation will make it more visible.", "url": "https://github.com/apereo/cas/pull/4975#discussion_r533764808", "createdAt": "2020-12-01T22:29:52Z", "author": {"login": "hdeadman"}, "path": "app/src/main/resources/overlay/helmcharts/helm/README.md", "diffHunk": "@@ -0,0 +1,101 @@\n+## Helm Charts for CAS\n+\n+The current helm chart for cas-server is a WIP. \n+It needs work and probably won't maintain backwards compatibility.\n+Contributions welcome. Eventually it would be nice to support running containers with bootadmin and config-server\n+pre-configured to work, and to have cas-management available as its own helm chart (or running as part of this one).\n+The chart supports mapping in arbitrary volumes and cas config can be specified in values files.  ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzNTY4OQ=="}, "originalCommit": {"oid": "430740a3f1d0046ad3915ad56451e76f67eba285"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwNzY4NjMyOnYy", "diffSide": "RIGHT", "path": ".github/workflows/initializr-build.yml", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwODo1NzoxOVrOH3GRgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwNzozNDo0MVrOH6Oyrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzNjUxNQ==", "bodyText": "Could we add support for Windows and MACOS here?", "url": "https://github.com/apereo/cas/pull/4975#discussion_r527536515", "createdAt": "2020-11-20T08:57:19Z", "author": {"login": "mmoayyed"}, "path": ".github/workflows/initializr-build.yml", "diffHunk": "@@ -72,3 +72,43 @@ jobs:\n           imageTag=(`./gradlew casVersion --q`)\n           echo \"Pushing Docker image with tag $imageTag\"\n           docker push apereo/cas-initializr:\"$imageTag\"\n+  helm:\n+    needs: [build]\n+    runs-on: ubuntu-latest", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "430740a3f1d0046ad3915ad56451e76f67eba285"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcwODc5NQ==", "bodyText": "Running the helm installation on windows or MacOS would require a linux VM with kubernetes, which I don't imagine is that could be done in cicd. I have run 32-bit linux VMs inside windows VMs before and not sure what is possible these days but at the end of the day it would still be getting installed on linux (possibly using a windows version of helm but I would expect that to behave the same as the linux version). To test this out locally I used k3s on a linux VM (windows hyper-v/ubuntu) but I also have Docker Desktop and it should work on that if kubernetes is enabled (haven't tried yet but I have previous installed the same ingress controller and another cas helm chart before when I was running load tests against a two server cas cluster).", "url": "https://github.com/apereo/cas/pull/4975#discussion_r530708795", "createdAt": "2020-11-26T00:36:11Z", "author": {"login": "hdeadman"}, "path": ".github/workflows/initializr-build.yml", "diffHunk": "@@ -72,3 +72,43 @@ jobs:\n           imageTag=(`./gradlew casVersion --q`)\n           echo \"Pushing Docker image with tag $imageTag\"\n           docker push apereo/cas-initializr:\"$imageTag\"\n+  helm:\n+    needs: [build]\n+    runs-on: ubuntu-latest", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzNjUxNQ=="}, "originalCommit": {"oid": "430740a3f1d0046ad3915ad56451e76f67eba285"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgyMTgwNw==", "bodyText": "Makes sense, thanks. On MacOS, I typically use minikube and VirtualBox; I imagine it'd be rather complicated to set all that for CI/CD and probably not worth it at this point. We can worry about it later.", "url": "https://github.com/apereo/cas/pull/4975#discussion_r530821807", "createdAt": "2020-11-26T07:34:41Z", "author": {"login": "mmoayyed"}, "path": ".github/workflows/initializr-build.yml", "diffHunk": "@@ -72,3 +72,43 @@ jobs:\n           imageTag=(`./gradlew casVersion --q`)\n           echo \"Pushing Docker image with tag $imageTag\"\n           docker push apereo/cas-initializr:\"$imageTag\"\n+  helm:\n+    needs: [build]\n+    runs-on: ubuntu-latest", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzNjUxNQ=="}, "originalCommit": {"oid": "430740a3f1d0046ad3915ad56451e76f67eba285"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3991, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}