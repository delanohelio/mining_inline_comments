{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2NDA1MDUz", "number": 4822, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMzo1NzowMVrOD2soXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMzo1NzozM1rOD2spNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU4NjgwOTI1OnYy", "diffSide": "RIGHT", "path": "core/cas-server-core-tickets-api/src/main/java/org/apereo/cas/ticket/expiration/ThrottledUseAndTimeoutExpirationPolicy.java", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMzo1NzowMVrOGMkjOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMjo1MDoxMlrOGNSXZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgzNDkzOA==", "bodyText": "This should be removed as a class field; it will mess with serialization of objects.", "url": "https://github.com/apereo/cas/pull/4822#discussion_r415834938", "createdAt": "2020-04-27T13:57:01Z", "author": {"login": "mmoayyed"}, "path": "core/cas-server-core-tickets-api/src/main/java/org/apereo/cas/ticket/expiration/ThrottledUseAndTimeoutExpirationPolicy.java", "diffHunk": "@@ -43,6 +44,8 @@\n \n     private long timeInBetweenUsesInSeconds;\n \n+    private Clock clock = Clock.systemUTC();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "493fc520541e789d6ab3451a9a0a28d6c45df1a9"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTkwODIxNQ==", "bodyText": "Can we exclude this field from serialization? like Transient?", "url": "https://github.com/apereo/cas/pull/4822#discussion_r415908215", "createdAt": "2020-04-27T15:23:45Z", "author": {"login": "potato04"}, "path": "core/cas-server-core-tickets-api/src/main/java/org/apereo/cas/ticket/expiration/ThrottledUseAndTimeoutExpirationPolicy.java", "diffHunk": "@@ -43,6 +44,8 @@\n \n     private long timeInBetweenUsesInSeconds;\n \n+    private Clock clock = Clock.systemUTC();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgzNDkzOA=="}, "originalCommit": {"oid": "493fc520541e789d6ab3451a9a0a28d6c45df1a9"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA0ODM0Mw==", "bodyText": "You could, but then you'll risk null-pointer-exceptions when the object is constructed back.\nAlso, it doesn't make sense to add a field only for it to be used in tests. If that is case, the test should be rewritten to not require an extra field.", "url": "https://github.com/apereo/cas/pull/4822#discussion_r416048343", "createdAt": "2020-04-27T18:25:55Z", "author": {"login": "mmoayyed"}, "path": "core/cas-server-core-tickets-api/src/main/java/org/apereo/cas/ticket/expiration/ThrottledUseAndTimeoutExpirationPolicy.java", "diffHunk": "@@ -43,6 +44,8 @@\n \n     private long timeInBetweenUsesInSeconds;\n \n+    private Clock clock = Clock.systemUTC();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgzNDkzOA=="}, "originalCommit": {"oid": "493fc520541e789d6ab3451a9a0a28d6c45df1a9"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQzMzg4OA==", "bodyText": "Reviewed this some more, and on second thought, should be fine. Thanks!", "url": "https://github.com/apereo/cas/pull/4822#discussion_r416433888", "createdAt": "2020-04-28T08:36:59Z", "author": {"login": "mmoayyed"}, "path": "core/cas-server-core-tickets-api/src/main/java/org/apereo/cas/ticket/expiration/ThrottledUseAndTimeoutExpirationPolicy.java", "diffHunk": "@@ -43,6 +44,8 @@\n \n     private long timeInBetweenUsesInSeconds;\n \n+    private Clock clock = Clock.systemUTC();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgzNDkzOA=="}, "originalCommit": {"oid": "493fc520541e789d6ab3451a9a0a28d6c45df1a9"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU3OTE1Mw==", "bodyText": "Wow, thank you for your understanding!  How about moving the clock filed into the abstract expiration policy class AbstractCasExpirationPolicy?  so we can write better unit tests for other child policies.", "url": "https://github.com/apereo/cas/pull/4822#discussion_r416579153", "createdAt": "2020-04-28T12:40:05Z", "author": {"login": "potato04"}, "path": "core/cas-server-core-tickets-api/src/main/java/org/apereo/cas/ticket/expiration/ThrottledUseAndTimeoutExpirationPolicy.java", "diffHunk": "@@ -43,6 +44,8 @@\n \n     private long timeInBetweenUsesInSeconds;\n \n+    private Clock clock = Clock.systemUTC();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgzNDkzOA=="}, "originalCommit": {"oid": "493fc520541e789d6ab3451a9a0a28d6c45df1a9"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU4NTU3Mg==", "bodyText": "Pleasure!\nImproving tests is always a big win in my book. So, yes! That would be a welcome change and I think perhaps with that, a number of Thread.sleep() calls can also be removed.\nKeep up the good work.", "url": "https://github.com/apereo/cas/pull/4822#discussion_r416585572", "createdAt": "2020-04-28T12:50:12Z", "author": {"login": "mmoayyed"}, "path": "core/cas-server-core-tickets-api/src/main/java/org/apereo/cas/ticket/expiration/ThrottledUseAndTimeoutExpirationPolicy.java", "diffHunk": "@@ -43,6 +44,8 @@\n \n     private long timeInBetweenUsesInSeconds;\n \n+    private Clock clock = Clock.systemUTC();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgzNDkzOA=="}, "originalCommit": {"oid": "493fc520541e789d6ab3451a9a0a28d6c45df1a9"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU4NjgxMTQzOnYy", "diffSide": "RIGHT", "path": "core/cas-server-core-tickets-api/src/main/java/org/apereo/cas/ticket/expiration/ThrottledUseAndTimeoutExpirationPolicy.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMzo1NzozM1rOGMkktA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwODozNzoxNVrOGNJHcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgzNTMxNg==", "bodyText": "What's the difference between what exists and your change?", "url": "https://github.com/apereo/cas/pull/4822#discussion_r415835316", "createdAt": "2020-04-27T13:57:33Z", "author": {"login": "mmoayyed"}, "path": "core/cas-server-core-tickets-api/src/main/java/org/apereo/cas/ticket/expiration/ThrottledUseAndTimeoutExpirationPolicy.java", "diffHunk": "@@ -53,15 +56,13 @@ public ThrottledUseAndTimeoutExpirationPolicy(@JsonProperty(\"timeToLive\") final\n     public boolean isExpired(final TicketState ticketState) {\n         LOGGER.trace(\"Checking validity of ticket [{}]\", ticketState);\n         val lastTimeUsed = ticketState.getLastTimeUsed();\n-        val currentTime = ZonedDateTime.now(ZoneOffset.UTC);\n+        val currentTime = ZonedDateTime.now(clock);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "493fc520541e789d6ab3451a9a0a28d6c45df1a9"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTg4Nzk0Ng==", "bodyText": "After this modification, we can change the currentTime to any specified time in unit tests, and being able to check the expiration of TGT at 0.99s(should be valid) or 1s(should be expired) after last use, this can not be handled by Thread.sleep() method.", "url": "https://github.com/apereo/cas/pull/4822#discussion_r415887946", "createdAt": "2020-04-27T14:59:39Z", "author": {"login": "potato04"}, "path": "core/cas-server-core-tickets-api/src/main/java/org/apereo/cas/ticket/expiration/ThrottledUseAndTimeoutExpirationPolicy.java", "diffHunk": "@@ -53,15 +56,13 @@ public ThrottledUseAndTimeoutExpirationPolicy(@JsonProperty(\"timeToLive\") final\n     public boolean isExpired(final TicketState ticketState) {\n         LOGGER.trace(\"Checking validity of ticket [{}]\", ticketState);\n         val lastTimeUsed = ticketState.getLastTimeUsed();\n-        val currentTime = ZonedDateTime.now(ZoneOffset.UTC);\n+        val currentTime = ZonedDateTime.now(clock);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgzNTMxNg=="}, "originalCommit": {"oid": "493fc520541e789d6ab3451a9a0a28d6c45df1a9"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTkxOTA3NA==", "bodyText": "Like this in Spring source code:\nhttps://github.com/spring-projects/spring-framework/blob/9277b470404ce1dce790fa82e684c9d8220940e7/spring-web/src/main/java/org/springframework/web/server/session/InMemoryWebSessionStore.java#L80-L93", "url": "https://github.com/apereo/cas/pull/4822#discussion_r415919074", "createdAt": "2020-04-27T15:36:20Z", "author": {"login": "potato04"}, "path": "core/cas-server-core-tickets-api/src/main/java/org/apereo/cas/ticket/expiration/ThrottledUseAndTimeoutExpirationPolicy.java", "diffHunk": "@@ -53,15 +56,13 @@ public ThrottledUseAndTimeoutExpirationPolicy(@JsonProperty(\"timeToLive\") final\n     public boolean isExpired(final TicketState ticketState) {\n         LOGGER.trace(\"Checking validity of ticket [{}]\", ticketState);\n         val lastTimeUsed = ticketState.getLastTimeUsed();\n-        val currentTime = ZonedDateTime.now(ZoneOffset.UTC);\n+        val currentTime = ZonedDateTime.now(clock);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgzNTMxNg=="}, "originalCommit": {"oid": "493fc520541e789d6ab3451a9a0a28d6c45df1a9"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQzNDAzNA==", "bodyText": "Thanks for the reference.", "url": "https://github.com/apereo/cas/pull/4822#discussion_r416434034", "createdAt": "2020-04-28T08:37:15Z", "author": {"login": "mmoayyed"}, "path": "core/cas-server-core-tickets-api/src/main/java/org/apereo/cas/ticket/expiration/ThrottledUseAndTimeoutExpirationPolicy.java", "diffHunk": "@@ -53,15 +56,13 @@ public ThrottledUseAndTimeoutExpirationPolicy(@JsonProperty(\"timeToLive\") final\n     public boolean isExpired(final TicketState ticketState) {\n         LOGGER.trace(\"Checking validity of ticket [{}]\", ticketState);\n         val lastTimeUsed = ticketState.getLastTimeUsed();\n-        val currentTime = ZonedDateTime.now(ZoneOffset.UTC);\n+        val currentTime = ZonedDateTime.now(clock);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgzNTMxNg=="}, "originalCommit": {"oid": "493fc520541e789d6ab3451a9a0a28d6c45df1a9"}, "originalPosition": 24}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4031, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}