{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc5NzM2NDQ0", "number": 4936, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwOTo0MDo0MlrOEk5QTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMDowNjowOVrOElliZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MTIyMjU0OnYy", "diffSide": "RIGHT", "path": "support/cas-server-support-token-tickets/src/main/java/org/apereo/cas/token/authentication/principal/TokenWebApplicationServiceResponseBuilder.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwOTo0MDo0MlrOHUFxrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwOTozNTo0MlrOHVHp6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgyODIwNg==", "bodyText": "Fix the formatting issues here. Spaces between operators, and also fix the indentation please.", "url": "https://github.com/apereo/cas/pull/4936#discussion_r490828206", "createdAt": "2020-09-18T09:40:42Z", "author": {"login": "mmoayyed"}, "path": "support/cas-server-support-token-tickets/src/main/java/org/apereo/cas/token/authentication/principal/TokenWebApplicationServiceResponseBuilder.java", "diffHunk": "@@ -40,11 +39,14 @@ protected WebApplicationService buildInternal(final WebApplicationService servic\n         val registeredService = this.servicesManager.findServiceBy(service);\n         RegisteredServiceAccessStrategyUtils.ensureServiceAccessIsAllowed(service, registeredService);\n         val tokenAsResponse = RegisteredServiceProperty.RegisteredServiceProperties.TOKEN_AS_SERVICE_TICKET.isAssignedTo(registeredService);\n+        val ticketIdAvailable=isTicketIdAvailable(parameters);\n \n-        if (!tokenAsResponse) {\n-            LOGGER.debug(\"Registered service [{}] is not configured to issue JWTs for service tickets. \"\n-                    + \"Make sure the service property [{}] is defined and is set to true\", registeredService,\n-                RegisteredServiceProperties.TOKEN_AS_SERVICE_TICKET.getPropertyName());\n+        if (!tokenAsResponse||!ticketIdAvailable) {\n+            if (ticketIdAvailable) {\n+                LOGGER.debug(\"Registered service [{}] is not configured to issue JWTs for service tickets. \"\n+                                + \"Make sure the service property [{}] is defined and set to true\", registeredService,\n+                        RegisteredServiceProperties.TOKEN_AS_SERVICE_TICKET.getPropertyName());\n+            }\n             return super.buildInternal(service, parameters);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "729d68b27d054ce85f095fe78069b2ef415f9a0e"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkwNzU2Mg==", "bodyText": "Done.", "url": "https://github.com/apereo/cas/pull/4936#discussion_r491907562", "createdAt": "2020-09-21T09:35:42Z", "author": {"login": "C4n4rd0"}, "path": "support/cas-server-support-token-tickets/src/main/java/org/apereo/cas/token/authentication/principal/TokenWebApplicationServiceResponseBuilder.java", "diffHunk": "@@ -40,11 +39,14 @@ protected WebApplicationService buildInternal(final WebApplicationService servic\n         val registeredService = this.servicesManager.findServiceBy(service);\n         RegisteredServiceAccessStrategyUtils.ensureServiceAccessIsAllowed(service, registeredService);\n         val tokenAsResponse = RegisteredServiceProperty.RegisteredServiceProperties.TOKEN_AS_SERVICE_TICKET.isAssignedTo(registeredService);\n+        val ticketIdAvailable=isTicketIdAvailable(parameters);\n \n-        if (!tokenAsResponse) {\n-            LOGGER.debug(\"Registered service [{}] is not configured to issue JWTs for service tickets. \"\n-                    + \"Make sure the service property [{}] is defined and is set to true\", registeredService,\n-                RegisteredServiceProperties.TOKEN_AS_SERVICE_TICKET.getPropertyName());\n+        if (!tokenAsResponse||!ticketIdAvailable) {\n+            if (ticketIdAvailable) {\n+                LOGGER.debug(\"Registered service [{}] is not configured to issue JWTs for service tickets. \"\n+                                + \"Make sure the service property [{}] is defined and set to true\", registeredService,\n+                        RegisteredServiceProperties.TOKEN_AS_SERVICE_TICKET.getPropertyName());\n+            }\n             return super.buildInternal(service, parameters);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgyODIwNg=="}, "originalCommit": {"oid": "729d68b27d054ce85f095fe78069b2ef415f9a0e"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MTIyNjY3OnYy", "diffSide": "RIGHT", "path": "support/cas-server-support-token-tickets/src/main/java/org/apereo/cas/token/authentication/principal/TokenWebApplicationServiceResponseBuilder.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwOTo0MToyMVrOHUF0Hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwOTozNTo1MlrOHVHqUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgyODgzMA==", "bodyText": "Simplify to one line:\nreturn StringUtils.isNotBlank(parameters.get(CasProtocolConstants.PARAMETER_TICKET))", "url": "https://github.com/apereo/cas/pull/4936#discussion_r490828830", "createdAt": "2020-09-18T09:41:21Z", "author": {"login": "mmoayyed"}, "path": "support/cas-server-support-token-tickets/src/main/java/org/apereo/cas/token/authentication/principal/TokenWebApplicationServiceResponseBuilder.java", "diffHunk": "@@ -58,6 +60,16 @@ protected WebApplicationService buildInternal(final WebApplicationService servic\n \n         return jwtService;\n     }\n+    \n+    private boolean isTicketIdAvailable(final Map<String, String> parameters){\n+        final String ticketId=parameters.get(CasProtocolConstants.PARAMETER_TICKET);\n+\n+        if (StringUtils.isBlank(ticketId)){\n+            return false;\n+        }\n+\n+        return true;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "729d68b27d054ce85f095fe78069b2ef415f9a0e"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgyODk1MA==", "bodyText": "Also fix formatting issues", "url": "https://github.com/apereo/cas/pull/4936#discussion_r490828950", "createdAt": "2020-09-18T09:41:29Z", "author": {"login": "mmoayyed"}, "path": "support/cas-server-support-token-tickets/src/main/java/org/apereo/cas/token/authentication/principal/TokenWebApplicationServiceResponseBuilder.java", "diffHunk": "@@ -58,6 +60,16 @@ protected WebApplicationService buildInternal(final WebApplicationService servic\n \n         return jwtService;\n     }\n+    \n+    private boolean isTicketIdAvailable(final Map<String, String> parameters){\n+        final String ticketId=parameters.get(CasProtocolConstants.PARAMETER_TICKET);\n+\n+        if (StringUtils.isBlank(ticketId)){\n+            return false;\n+        }\n+\n+        return true;\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgyODgzMA=="}, "originalCommit": {"oid": "729d68b27d054ce85f095fe78069b2ef415f9a0e"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkwNzY2Ng==", "bodyText": "Done.", "url": "https://github.com/apereo/cas/pull/4936#discussion_r491907666", "createdAt": "2020-09-21T09:35:52Z", "author": {"login": "C4n4rd0"}, "path": "support/cas-server-support-token-tickets/src/main/java/org/apereo/cas/token/authentication/principal/TokenWebApplicationServiceResponseBuilder.java", "diffHunk": "@@ -58,6 +60,16 @@ protected WebApplicationService buildInternal(final WebApplicationService servic\n \n         return jwtService;\n     }\n+    \n+    private boolean isTicketIdAvailable(final Map<String, String> parameters){\n+        final String ticketId=parameters.get(CasProtocolConstants.PARAMETER_TICKET);\n+\n+        if (StringUtils.isBlank(ticketId)){\n+            return false;\n+        }\n+\n+        return true;\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgyODgzMA=="}, "originalCommit": {"oid": "729d68b27d054ce85f095fe78069b2ef415f9a0e"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MTIzMjQwOnYy", "diffSide": "RIGHT", "path": "support/cas-server-support-token-tickets/src/test/java/org/apereo/cas/token/authentication/principal/TokenWebApplicationServiceResponseBuilderTests.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwOTo0MjoxNFrOHUF3XQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwOToyNzoyM1rOHXRxJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgyOTY2MQ==", "bodyText": "How does this test verify gateway=true?", "url": "https://github.com/apereo/cas/pull/4936#discussion_r490829661", "createdAt": "2020-09-18T09:42:14Z", "author": {"login": "mmoayyed"}, "path": "support/cas-server-support-token-tickets/src/test/java/org/apereo/cas/token/authentication/principal/TokenWebApplicationServiceResponseBuilderTests.java", "diffHunk": "@@ -139,4 +140,19 @@ public void verifyTokenBuilder() throws Exception {\n             assertNotNull(JWTParser.parse(ticket));\n         }\n     }\n+    \n+    @Test\n+    public void verifyTokenBuilderWhenGatewayIsTrue() throws Exception {\n+        val data = \"yes\\ncasuser\";\n+        try (val webServer = new MockWebServer(8281,\n+            new ByteArrayResource(data.getBytes(StandardCharsets.UTF_8), \"REST Output\"), MediaType.APPLICATION_JSON_VALUE)) {\n+            webServer.start();\n+\n+            val result = responseBuilder.build(CoreAuthenticationTestUtils.getWebApplicationService(\"jwtservice\"),\n+                StringUtils.EMPTY,\n+                CoreAuthenticationTestUtils.getAuthentication());\n+            assertNotNull(result);\n+            assertFalse(result.getAttributes().containsKey(CasProtocolConstants.PARAMETER_TICKET));\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "729d68b27d054ce85f095fe78069b2ef415f9a0e"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkxMDEzNQ==", "bodyText": "If the service is configured to receive \u00e0 service ticket as a JWT and that the request parameter gateway=true, then there is no service ticket generated. So the second parameter of the method responseBuilder.build() is empty. I renamed the test method to avoid any misunderstanding.", "url": "https://github.com/apereo/cas/pull/4936#discussion_r491910135", "createdAt": "2020-09-21T09:40:09Z", "author": {"login": "C4n4rd0"}, "path": "support/cas-server-support-token-tickets/src/test/java/org/apereo/cas/token/authentication/principal/TokenWebApplicationServiceResponseBuilderTests.java", "diffHunk": "@@ -139,4 +140,19 @@ public void verifyTokenBuilder() throws Exception {\n             assertNotNull(JWTParser.parse(ticket));\n         }\n     }\n+    \n+    @Test\n+    public void verifyTokenBuilderWhenGatewayIsTrue() throws Exception {\n+        val data = \"yes\\ncasuser\";\n+        try (val webServer = new MockWebServer(8281,\n+            new ByteArrayResource(data.getBytes(StandardCharsets.UTF_8), \"REST Output\"), MediaType.APPLICATION_JSON_VALUE)) {\n+            webServer.start();\n+\n+            val result = responseBuilder.build(CoreAuthenticationTestUtils.getWebApplicationService(\"jwtservice\"),\n+                StringUtils.EMPTY,\n+                CoreAuthenticationTestUtils.getAuthentication());\n+            assertNotNull(result);\n+            assertFalse(result.getAttributes().containsKey(CasProtocolConstants.PARAMETER_TICKET));\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgyOTY2MQ=="}, "originalCommit": {"oid": "729d68b27d054ce85f095fe78069b2ef415f9a0e"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyNTU5Nw==", "bodyText": "There is nothing in your test about gateway=true. You need to have two tests; one with and one without that parameter.", "url": "https://github.com/apereo/cas/pull/4936#discussion_r491925597", "createdAt": "2020-09-21T10:04:15Z", "author": {"login": "mmoayyed"}, "path": "support/cas-server-support-token-tickets/src/test/java/org/apereo/cas/token/authentication/principal/TokenWebApplicationServiceResponseBuilderTests.java", "diffHunk": "@@ -139,4 +140,19 @@ public void verifyTokenBuilder() throws Exception {\n             assertNotNull(JWTParser.parse(ticket));\n         }\n     }\n+    \n+    @Test\n+    public void verifyTokenBuilderWhenGatewayIsTrue() throws Exception {\n+        val data = \"yes\\ncasuser\";\n+        try (val webServer = new MockWebServer(8281,\n+            new ByteArrayResource(data.getBytes(StandardCharsets.UTF_8), \"REST Output\"), MediaType.APPLICATION_JSON_VALUE)) {\n+            webServer.start();\n+\n+            val result = responseBuilder.build(CoreAuthenticationTestUtils.getWebApplicationService(\"jwtservice\"),\n+                StringUtils.EMPTY,\n+                CoreAuthenticationTestUtils.getAuthentication());\n+            assertNotNull(result);\n+            assertFalse(result.getAttributes().containsKey(CasProtocolConstants.PARAMETER_TICKET));\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgyOTY2MQ=="}, "originalCommit": {"oid": "729d68b27d054ce85f095fe78069b2ef415f9a0e"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE3MDQwNQ==", "bodyText": "Just to be sure that there is no misunderstanding, let's focus on these lines:\nTokenWebApplicationServiceResponseBuilder:\nif (!tokenAsResponse) { LOGGER.debug(\"Registered service [{}] is not configured to issue JWTs for service tickets. \" + \"Make sure the service property [{}] is defined and is set to true\", registeredService, RegisteredServiceProperties.TOKEN_AS_SERVICE_TICKET.getPropertyName()); return super.buildInternal(service, parameters); }\nTokenWebApplicationServiceResponseBuilderTests:\nresponseBuilder.build(CoreAuthenticationTestUtils.getWebApplicationService(\"jwtservice\"), \"ST-123456\",CoreAuthenticationTestUtils.getAuthentication());\nScenario 1: The service is not configured to send the  service ticket as a JWT and there is no SSO session (no TGT, no Service ticket), gateway=false. Then:\nThe call to the responseBuilder looks like something like this: responseBuilder.build(CoreAuthenticationTestUtils.getWebApplicationService(\"jwtservice\"), \"\",CoreAuthenticationTestUtils.getAuthentication()); because there is no service ticket.\nAnd as tokenAsResponse=false => execute super.buildInternal(service, parameters)\nScenario 2: The service is configured to send the  service ticket as a JWT and there is a SSO session with a TGT and a service ticket, gateway=false. Then:\nThe call to the responseBuilder looks like something like that:\nresponseBuilder.build(CoreAuthenticationTestUtils.getWebApplicationService(\"jwtservice\"), \"ST-123456\", CoreAuthenticationTestUtils.getAuthentication()); because there is a service ticket.\nAnd as tokenAsResponse=true=> let's generate the JWT from the service ticket.\nScenario 3: The service is configured to send the  service ticket as a JWT and there is a SSO session with a TGT and a service ticket, gateway=true. Then:\nThe call to the responseBuilder looks like something like that:\nresponseBuilder.build(CoreAuthenticationTestUtils.getWebApplicationService(\"jwtservice\"), \"ST-123456\", CoreAuthenticationTestUtils.getAuthentication()); because there is a service ticket.\nAnd as tokenAsResponse=true=> let's generate the JWT from the service ticket.\nScenario 4: The service is configured to send the  service ticket as a JWT and there is no SSO session(no TGT, no Service ticket), gateway=true. Then:\nThe call to the responseBuilder looks like something like that:\nresponseBuilder.build(CoreAuthenticationTestUtils.getWebApplicationService(\"jwtservice\"), \"\", CoreAuthenticationTestUtils.getAuthentication()); because there is no service ticket.\nAnd as tokenAsResponse=true=> CAS tries to generate the JWT from the service ticket. But there is no service ticket so it ends with an exception.\nThat's why the parameter gateway is not there. And that's why I renamed to unit test. It's not really related to the parameter gateway. It's related to the fact that there might be no service ticket.", "url": "https://github.com/apereo/cas/pull/4936#discussion_r494170405", "createdAt": "2020-09-24T09:27:23Z", "author": {"login": "C4n4rd0"}, "path": "support/cas-server-support-token-tickets/src/test/java/org/apereo/cas/token/authentication/principal/TokenWebApplicationServiceResponseBuilderTests.java", "diffHunk": "@@ -139,4 +140,19 @@ public void verifyTokenBuilder() throws Exception {\n             assertNotNull(JWTParser.parse(ticket));\n         }\n     }\n+    \n+    @Test\n+    public void verifyTokenBuilderWhenGatewayIsTrue() throws Exception {\n+        val data = \"yes\\ncasuser\";\n+        try (val webServer = new MockWebServer(8281,\n+            new ByteArrayResource(data.getBytes(StandardCharsets.UTF_8), \"REST Output\"), MediaType.APPLICATION_JSON_VALUE)) {\n+            webServer.start();\n+\n+            val result = responseBuilder.build(CoreAuthenticationTestUtils.getWebApplicationService(\"jwtservice\"),\n+                StringUtils.EMPTY,\n+                CoreAuthenticationTestUtils.getAuthentication());\n+            assertNotNull(result);\n+            assertFalse(result.getAttributes().containsKey(CasProtocolConstants.PARAMETER_TICKET));\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgyOTY2MQ=="}, "originalCommit": {"oid": "729d68b27d054ce85f095fe78069b2ef415f9a0e"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3ODQ3MjI3OnYy", "diffSide": "RIGHT", "path": "support/cas-server-support-token-tickets/src/main/java/org/apereo/cas/token/authentication/principal/TokenWebApplicationServiceResponseBuilder.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMDowNDozNlrOHVIxCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxMzoxMToyOFrOHXZ7Ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyNTc3MQ==", "bodyText": "Space before and after =", "url": "https://github.com/apereo/cas/pull/4936#discussion_r491925771", "createdAt": "2020-09-21T10:04:36Z", "author": {"login": "mmoayyed"}, "path": "support/cas-server-support-token-tickets/src/main/java/org/apereo/cas/token/authentication/principal/TokenWebApplicationServiceResponseBuilder.java", "diffHunk": "@@ -40,11 +39,15 @@ protected WebApplicationService buildInternal(final WebApplicationService servic\n         val registeredService = this.servicesManager.findServiceBy(service);\n         RegisteredServiceAccessStrategyUtils.ensureServiceAccessIsAllowed(service, registeredService);\n         val tokenAsResponse = RegisteredServiceProperty.RegisteredServiceProperties.TOKEN_AS_SERVICE_TICKET.isAssignedTo(registeredService);\n+        val ticketIdAvailable=isTicketIdAvailable(parameters);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d3db61eb5f2bed2a720d49315f1a62bc9a8fe57"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMwNDA4Mg==", "bodyText": "Done for the spaces around the '='.\nFor everything else, you're right. And in fact, I think that it's not really related to the parameter gateway. The main concern, here, is that \"Is there a service ticket or not?\". If there is a service ticket, then we can generate a service ticket as a JWT. If not, let's apply the default behaviour.  So I left only 2 unit tests in the class: the original one which test the behaviour with a service ticket and the one I added which test the behaviour without a service ticket.", "url": "https://github.com/apereo/cas/pull/4936#discussion_r494304082", "createdAt": "2020-09-24T13:11:28Z", "author": {"login": "C4n4rd0"}, "path": "support/cas-server-support-token-tickets/src/main/java/org/apereo/cas/token/authentication/principal/TokenWebApplicationServiceResponseBuilder.java", "diffHunk": "@@ -40,11 +39,15 @@ protected WebApplicationService buildInternal(final WebApplicationService servic\n         val registeredService = this.servicesManager.findServiceBy(service);\n         RegisteredServiceAccessStrategyUtils.ensureServiceAccessIsAllowed(service, registeredService);\n         val tokenAsResponse = RegisteredServiceProperty.RegisteredServiceProperties.TOKEN_AS_SERVICE_TICKET.isAssignedTo(registeredService);\n+        val ticketIdAvailable=isTicketIdAvailable(parameters);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyNTc3MQ=="}, "originalCommit": {"oid": "4d3db61eb5f2bed2a720d49315f1a62bc9a8fe57"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3ODQ3NzgwOnYy", "diffSide": "RIGHT", "path": "support/cas-server-support-token-tickets/src/main/java/org/apereo/cas/token/authentication/principal/TokenWebApplicationServiceResponseBuilder.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMDowNjowOVrOHVI0fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxMzoyMDo0NFrOHXaVaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyNjY1NQ==", "bodyText": "Don't think the log statement here makes sense.", "url": "https://github.com/apereo/cas/pull/4936#discussion_r491926655", "createdAt": "2020-09-21T10:06:09Z", "author": {"login": "mmoayyed"}, "path": "support/cas-server-support-token-tickets/src/main/java/org/apereo/cas/token/authentication/principal/TokenWebApplicationServiceResponseBuilder.java", "diffHunk": "@@ -40,11 +39,15 @@ protected WebApplicationService buildInternal(final WebApplicationService servic\n         val registeredService = this.servicesManager.findServiceBy(service);\n         RegisteredServiceAccessStrategyUtils.ensureServiceAccessIsAllowed(service, registeredService);\n         val tokenAsResponse = RegisteredServiceProperty.RegisteredServiceProperties.TOKEN_AS_SERVICE_TICKET.isAssignedTo(registeredService);\n+        val ticketIdAvailable=isTicketIdAvailable(parameters);\n \n-        if (!tokenAsResponse) {\n-            LOGGER.debug(\"Registered service [{}] is not configured to issue JWTs for service tickets. \"\n-                    + \"Make sure the service property [{}] is defined and is set to true\", registeredService,\n-                RegisteredServiceProperties.TOKEN_AS_SERVICE_TICKET.getPropertyName());\n+        if (!tokenAsResponse || !ticketIdAvailable) {\n+            if (ticketIdAvailable) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d3db61eb5f2bed2a720d49315f1a62bc9a8fe57"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMxMDc2MQ==", "bodyText": "Actually, this log statement is on the master branch. It display the message in debug mode when a service is not configured to send the service ticket as a JWT. So I put it in a condition to fit exactly the previous behaviour which is to be displayed if there is a service ticket and if the service is not configured to send the service ticket as a JWT. Moreover, this message is not relevant if there is no service ticket.", "url": "https://github.com/apereo/cas/pull/4936#discussion_r494310761", "createdAt": "2020-09-24T13:20:44Z", "author": {"login": "C4n4rd0"}, "path": "support/cas-server-support-token-tickets/src/main/java/org/apereo/cas/token/authentication/principal/TokenWebApplicationServiceResponseBuilder.java", "diffHunk": "@@ -40,11 +39,15 @@ protected WebApplicationService buildInternal(final WebApplicationService servic\n         val registeredService = this.servicesManager.findServiceBy(service);\n         RegisteredServiceAccessStrategyUtils.ensureServiceAccessIsAllowed(service, registeredService);\n         val tokenAsResponse = RegisteredServiceProperty.RegisteredServiceProperties.TOKEN_AS_SERVICE_TICKET.isAssignedTo(registeredService);\n+        val ticketIdAvailable=isTicketIdAvailable(parameters);\n \n-        if (!tokenAsResponse) {\n-            LOGGER.debug(\"Registered service [{}] is not configured to issue JWTs for service tickets. \"\n-                    + \"Make sure the service property [{}] is defined and is set to true\", registeredService,\n-                RegisteredServiceProperties.TOKEN_AS_SERVICE_TICKET.getPropertyName());\n+        if (!tokenAsResponse || !ticketIdAvailable) {\n+            if (ticketIdAvailable) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyNjY1NQ=="}, "originalCommit": {"oid": "4d3db61eb5f2bed2a720d49315f1a62bc9a8fe57"}, "originalPosition": 24}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3976, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}