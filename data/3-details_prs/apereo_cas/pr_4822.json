{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2NDA1MDUz", "number": 4822, "title": "improve ticket expiration policies - throttled timeout", "bodyText": "After enabling TGT's throttling policy in our test environment, the SERVICE_TICKET_VALIDATE_FAILED event occurs frequently on the server. The configuration we used for this policy is below.\ncas.ticket.tgt.throttledTimeout.timeToKillInSeconds=28800\ncas.ticket.tgt.throttledTimeout.timeInBetweenUsesInSeconds=1\n\nAfter trawling through the logs, the reason is that the ST was removed from the cache (redis) due to the TGT expiration.\n2020-04-15 13:28:15,897 DEBUG [org.apereo.cas.services.RegisteredServiceAccessStrategyUtils] - Current authentication via ticket [TGT-717-********************************************************ZDJyFo0PCWYxxxxx-xxxxx-02] allows service [http://oa.example.org/login] to participate in the existing SSO session \n2020-04-15 13:28:15,898 TRACE [org.apereo.cas.AbstractCentralAuthenticationService] - TGT is not proxied by another service \n2020-04-15 13:28:15,898 DEBUG [org.apereo.cas.ticket.factory.DefaultServiceTicketFactory] - Looking up service ticket id generator for [org.apereo.cas.authentication.principal.SimpleWebApplicationServiceImpl] \n2020-04-15 13:28:15,898 DEBUG [org.apereo.cas.ticket.factory.DefaultServiceTicketFactory] - Attempting to encode service ticket [ST-1070--kFNUImJI9Q8fyHu1jwhxBrmjyUxxxxx-xxxxx-02] \n2020-04-15 13:28:15,899 DEBUG [org.apereo.cas.ticket.factory.DefaultServiceTicketFactory] - Encoded service ticket id [ST-1070--kFNUImJI9Q8fyHu1jwhxBrmjyUxxxxx-xxxxx-02] \n2020-04-15 13:28:15,899 DEBUG [org.apereo.cas.ticket.registry.RedisTicketRegistry] - Updating ticket [TGT-717-********************************************************ZDJyFo0PCWYxxxxx-xxxxx-02] \n2020-04-15 13:28:15,899 TRACE [org.apereo.cas.ticket.registry.AbstractTicketRegistry] - Ticket encryption is not enabled. Falling back to default behavior \n2020-04-15 13:28:15,900 DEBUG [org.apereo.cas.ticket.registry.RedisTicketRegistry] - Adding ticket [ST-1070--kFNUImJI9Q8fyHu1jwhxBrmjyUxxxxx-xxxxx-02] \n2020-04-15 13:28:15,901 TRACE [org.apereo.cas.ticket.registry.AbstractTicketRegistry] - Ticket encryption is not enabled. Falling back to default behavior \n2020-04-15 13:28:15,901 INFO [org.apereo.cas.DefaultCentralAuthenticationService] - Granted ticket [ST-1070--kFNUImJI9Q8fyHu1jwhxBrmjyUxxxxx-xxxxx-02] for service [http://oa.example.org/login] and principal [someone] \n2020-04-15 13:28:15,902 DEBUG [org.apereo.cas.AbstractCentralAuthenticationService] - Publishing [CasServiceTicketGrantedEvent(ticketGrantingTicket=TGT-717-********************************************************ZDJyFo0PCWYxxxxx-xxxxx-02, serviceTicket=ST-1070--kFNUImJI9Q8fyHu1jwhxBrmjyUxxxxx-xxxxx-02)] \n2020-04-15 13:28:15,902 TRACE [org.apereo.cas.web.CasWebApplicationContext] - Publishing event in org.apereo.cas.web.CasWebApplicationContext@587e5365: CasServiceTicketGrantedEvent(ticketGrantingTicket=TGT-717-********************************************************ZDJyFo0PCWYxxxxx-xxxxx-02, serviceTicket=ST-1070--kFNUImJI9Q8fyHu1jwhxBrmjyUxxxxx-xxxxx-02) \n2020-04-15 13:28:15,902 TRACE [org.apereo.cas.audit.spi.ThreadLocalPrincipalResolver] - Resolving principal at audit point [execution(ServiceTicket org.apereo.cas.DefaultCentralAuthenticationService.grantServiceTicket(String,Service,AuthenticationResult))] \n2020-04-15 13:28:15,902 INFO [org.apereo.inspektr.audit.support.Slf4jLoggingAuditTrailManager] - Audit trail record BEGIN\n=============================================================\nWHO: someone\nWHAT: ST-1070--kFNUImJI9Q8fyHu1jwhxBrmjyUxxxxx-xxxxx-02 for http://oa.example.org/login\nACTION: SERVICE_TICKET_CREATED\nAPPLICATION: CAS\nWHEN: Wed Apr 15 13:28:15 CST 2020\nCLIENT IP ADDRESS: 10.162.65.117\nSERVER IP ADDRESS: 127.0.0.1\n=============================================================\n\n/*\n* irrelevant entries deleted\n*/\n\n2020-04-15 13:28:16,206 TRACE [org.apereo.cas.ticket.support.ThrottledUseAndTimeoutExpirationPolicy] - Checking validity of ticket [TGT-717-********************************************************ZDJyFo0PCWYxxxxx-xxxxx-02] \n2020-04-15 13:28:16,206 TRACE [org.apereo.cas.ticket.support.ThrottledUseAndTimeoutExpirationPolicy] - Current time is [2020-04-15T05:28:16.206Z]. Ticket last used time is [2020-04-15T05:28:15.899Z] \n2020-04-15 13:28:16,206 TRACE [org.apereo.cas.ticket.support.ThrottledUseAndTimeoutExpirationPolicy] - Current time in seconds is [1586928496]. Ticket last used time in seconds is [1586928495] \n2020-04-15 13:28:16,206 WARN [org.apereo.cas.ticket.support.ThrottledUseAndTimeoutExpirationPolicy] - Expired [TGT-717-********************************************************ZDJyFo0PCWYxxxxx-xxxxx-02]: number of seconds since ticket usage time [1] is less than or equal to time in between uses in seconds [1] \n2020-04-15 13:28:16,207 DEBUG [org.apereo.cas.ticket.registry.RedisTicketRegistry] - Ticket [ST-1070--kFNUImJI9Q8fyHu1jwhxBrmjyUxxxxx-xxxxx-02] has expired and is now removed from the cache \n2020-04-15 13:28:16,207 WARN [org.apereo.cas.DefaultCentralAuthenticationService] - Service ticket [ST-1070--kFNUImJI9Q8fyHu1jwhxBrmjyUxxxxx-xxxxx-02] does not exist. \n2020-04-15 13:28:16,207 TRACE [org.apereo.cas.audit.spi.ThreadLocalPrincipalResolver] - Resolving principal at audit point [execution(Assertion org.apereo.cas.DefaultCentralAuthenticationService.validateServiceTicket(String,Service))] with thrown exception [RootCasException(code=INVALID_TICKET)] \n2020-04-15 13:28:16,207 INFO [org.apereo.inspektr.audit.support.Slf4jLoggingAuditTrailManager] - Audit trail record BEGIN\n=============================================================\nWHO: audit:unknown\nWHAT: ST-1070--kFNUImJI9Q8fyHu1jwhxBrmjyUxxxxx-xxxxx-02 for http://oa.example.org/login\nACTION: SERVICE_TICKET_VALIDATE_FAILED\nAPPLICATION: CAS\nWHEN: Wed Apr 15 13:28:16 CST 2020\nCLIENT IP ADDRESS: 10.154.91.107\nSERVER IP ADDRESS: 127.0.0.1\n=============================================================\n\nAs you can see from the logs,  the time interval between granting(2020-04-15T05:28:15.899Z) and validating(2020-04-15T05:28:16.206Z) the ST is less than 1 second, which should be a normal thing, why would it be throttled and marked as expired? So I created this pull request.\nIn the pull request, throttling policy will not be triggered if the time interval doesn\u2019t exceed 1 second, instead of having to be in the same epoch second.\nThis may not be perfect, but i think it works a little better than before.\nMaybe we should import another DateTime property of the ticket to improve throttling policy in the future.", "createdAt": "2020-04-21T02:44:32Z", "url": "https://github.com/apereo/cas/pull/4822", "merged": true, "mergeCommit": {"oid": "8b32840a872bd917978c74d8d1def48279833c37"}, "closed": true, "closedAt": "2020-04-28T09:00:12Z", "author": {"login": "potato04"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZi4dnAH2gAyNDA2NDA1MDUzOjY3YmI2ZGU0NDJhYjMyNjUwYjc2YWJiZTc1Y2FmYjljYWZmMWI0Y2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcbvt-2AFqTQwMDk3NzI0NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "67bb6de442ab32650b76abbe75cafb9caff1b4cf", "author": {"user": {"login": "potato04", "name": null}}, "url": "https://github.com/apereo/cas/commit/67bb6de442ab32650b76abbe75cafb9caff1b4cf", "committedDate": "2020-04-20T17:52:38Z", "message": "fixes throttled use expiration policy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5MTEwODI4", "url": "https://github.com/apereo/cas/pull/4822#pullrequestreview-399110828", "createdAt": "2020-04-23T13:46:39Z", "commit": {"oid": "67bb6de442ab32650b76abbe75cafb9caff1b4cf"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7fa22ab9921a8d8d079e3d38d28c5d9d4bea885", "author": {"user": {"login": "potato04", "name": null}}, "url": "https://github.com/apereo/cas/commit/d7fa22ab9921a8d8d079e3d38d28c5d9d4bea885", "committedDate": "2020-04-25T14:24:15Z", "message": "update unit tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eb895d2653a628b0507ea69e72450e2eab5a0e43", "author": {"user": {"login": "potato04", "name": null}}, "url": "https://github.com/apereo/cas/commit/eb895d2653a628b0507ea69e72450e2eab5a0e43", "committedDate": "2020-04-25T18:30:26Z", "message": "code styling fixes"}, "afterCommit": {"oid": "e71ab05875616098f5f4cab1ddfb34afbfd0bd4f", "author": {"user": {"login": "potato04", "name": null}}, "url": "https://github.com/apereo/cas/commit/e71ab05875616098f5f4cab1ddfb34afbfd0bd4f", "committedDate": "2020-04-26T11:12:01Z", "message": "code styling fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "493fc520541e789d6ab3451a9a0a28d6c45df1a9", "author": {"user": {"login": "potato04", "name": null}}, "url": "https://github.com/apereo/cas/commit/493fc520541e789d6ab3451a9a0a28d6c45df1a9", "committedDate": "2020-04-27T08:31:36Z", "message": "code styling fixes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e71ab05875616098f5f4cab1ddfb34afbfd0bd4f", "author": {"user": {"login": "potato04", "name": null}}, "url": "https://github.com/apereo/cas/commit/e71ab05875616098f5f4cab1ddfb34afbfd0bd4f", "committedDate": "2020-04-26T11:12:01Z", "message": "code styling fixes"}, "afterCommit": {"oid": "493fc520541e789d6ab3451a9a0a28d6c45df1a9", "author": {"user": {"login": "potato04", "name": null}}, "url": "https://github.com/apereo/cas/commit/493fc520541e789d6ab3451a9a0a28d6c45df1a9", "committedDate": "2020-04-27T08:31:36Z", "message": "code styling fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwOTc3MjQ1", "url": "https://github.com/apereo/cas/pull/4822#pullrequestreview-400977245", "createdAt": "2020-04-27T13:57:01Z", "commit": {"oid": "493fc520541e789d6ab3451a9a0a28d6c45df1a9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMzo1NzowMVrOGMkjOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMzo1NzozM1rOGMkktA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgzNDkzOA==", "bodyText": "This should be removed as a class field; it will mess with serialization of objects.", "url": "https://github.com/apereo/cas/pull/4822#discussion_r415834938", "createdAt": "2020-04-27T13:57:01Z", "author": {"login": "mmoayyed"}, "path": "core/cas-server-core-tickets-api/src/main/java/org/apereo/cas/ticket/expiration/ThrottledUseAndTimeoutExpirationPolicy.java", "diffHunk": "@@ -43,6 +44,8 @@\n \n     private long timeInBetweenUsesInSeconds;\n \n+    private Clock clock = Clock.systemUTC();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "493fc520541e789d6ab3451a9a0a28d6c45df1a9"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgzNTMxNg==", "bodyText": "What's the difference between what exists and your change?", "url": "https://github.com/apereo/cas/pull/4822#discussion_r415835316", "createdAt": "2020-04-27T13:57:33Z", "author": {"login": "mmoayyed"}, "path": "core/cas-server-core-tickets-api/src/main/java/org/apereo/cas/ticket/expiration/ThrottledUseAndTimeoutExpirationPolicy.java", "diffHunk": "@@ -53,15 +56,13 @@ public ThrottledUseAndTimeoutExpirationPolicy(@JsonProperty(\"timeToLive\") final\n     public boolean isExpired(final TicketState ticketState) {\n         LOGGER.trace(\"Checking validity of ticket [{}]\", ticketState);\n         val lastTimeUsed = ticketState.getLastTimeUsed();\n-        val currentTime = ZonedDateTime.now(ZoneOffset.UTC);\n+        val currentTime = ZonedDateTime.now(clock);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "493fc520541e789d6ab3451a9a0a28d6c45df1a9"}, "originalPosition": 24}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3581, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}