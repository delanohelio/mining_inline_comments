{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxMTc5MTIx", "number": 4812, "title": "properly clean up resources at application shutdown", "bodyText": "PR #4803 rewritten. This should really work now. I realized I can simply use @WebListener annoation to add ServletContextListener.\nWe should unregister JDBC drivers at shutdown instead of relying tomcat to forcefully deregister it. (This feature may not exist in other servlet servers.)\nTomcat throws this message\nSEVERE: A web application registered the JDBC driver [XXXXX] but failed to unregister it when the web application was stopped. To prevent a memory leak, the JDBC Driver has been forcibly unregistered.\nwhen a JDBC driver deregisters forcefully.\nAlso, for unknown reason quartz thread shut down is asynchronous and I have to put 5 sec wait to wait these threads to shut down", "createdAt": "2020-04-09T02:56:07Z", "url": "https://github.com/apereo/cas/pull/4812", "merged": true, "mergeCommit": {"oid": "ca3c693447730e5ec9bc3aace8791f52107673bd"}, "closed": true, "closedAt": "2020-05-08T10:38:18Z", "author": {"login": "leeyc0"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcdXdlagFqTQwNDUzNDEzMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcfOk95gH2gAyNDAxMTc5MTIxOmVjOWU1YmY5MWE5M2RkMTQ3NmMxZTUzYWFjZThlMDk2NzYwNmVhZjc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NTM0MTMz", "url": "https://github.com/apereo/cas/pull/4812#pullrequestreview-404534133", "createdAt": "2020-05-02T14:50:02Z", "commit": {"oid": "15207e784af79d1f53b97c0aa1e6ba466829c305"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NTk2MjQ3", "url": "https://github.com/apereo/cas/pull/4812#pullrequestreview-407596247", "createdAt": "2020-05-07T15:37:55Z", "commit": {"oid": "0d5d87bba4654a5516c4eaaf1ab90d9b11027635"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNTozNzo1NVrOGSEf9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNTozODo1NVrOGSEi9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYwMTI2OQ==", "bodyText": "Remove all of this. See previous discussions on the topic.", "url": "https://github.com/apereo/cas/pull/4812#discussion_r421601269", "createdAt": "2020-05-07T15:37:55Z", "author": {"login": "mmoayyed"}, "path": "core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java", "diffHunk": "@@ -115,6 +116,13 @@ public SmsSender smsSender() {\n         return SmsSender.noOp();\n     }\n \n+    @Bean\n+    public SchedulerFactoryBean schedulerFactoryBean() {\n+        val schedulerFactoryBean = new SchedulerFactoryBean();\n+        schedulerFactoryBean.setWaitForJobsToCompleteOnShutdown(true);\n+        return schedulerFactoryBean;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d5d87bba4654a5516c4eaaf1ab90d9b11027635"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYwMTcwNw==", "bodyText": "Remove all inline comments; Either turn into javadoc or write the code in such a way that \"hidden\" comments would not be required.", "url": "https://github.com/apereo/cas/pull/4812#discussion_r421601707", "createdAt": "2020-05-07T15:38:30Z", "author": {"login": "mmoayyed"}, "path": "support/cas-server-support-jdbc-drivers/src/main/java/org/apereo/cas/JdbcServletContextListener.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package org.apereo.cas;\n+\n+import lombok.val;\n+\n+import javax.servlet.ServletContextEvent;\n+import javax.servlet.ServletContextListener;\n+import javax.servlet.annotation.WebListener;\n+import java.sql.DriverManager;\n+import java.sql.SQLException;\n+import java.util.logging.Logger;\n+\n+/**\n+ * This is {@link JdbcServletContextListener} that properly\n+ * deregisters JDBC drivers.\n+ *\n+ * @author leeyc0\n+ * @since 6.2.0\n+ */\n+@WebListener\n+public class JdbcServletContextListener implements ServletContextListener {\n+\n+    @Override\n+    public void contextInitialized(final ServletContextEvent sce) {\n+    }\n+\n+    @Override\n+    public final void contextDestroyed(final ServletContextEvent sce) {\n+        /* Slf4j does not work in contextDestroyed */\n+        val logger = Logger.getLogger(\"org.apereo.cas\");\n+        logger.info(\"Unregistering JdbcServletContextListener\");\n+\n+        /* ... First close any background tasks which may be using the DB ...\n+         * ... Then close any DB connection pools ... */\n+\n+        /*  Now deregister JDBC drivers in this context's ClassLoader:\n+         *  Get the webapp's ClassLoader */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d5d87bba4654a5516c4eaaf1ab90d9b11027635"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYwMTgzNg==", "bodyText": "This should work.", "url": "https://github.com/apereo/cas/pull/4812#discussion_r421601836", "createdAt": "2020-05-07T15:38:40Z", "author": {"login": "mmoayyed"}, "path": "support/cas-server-support-jdbc-drivers/src/main/java/org/apereo/cas/JdbcServletContextListener.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package org.apereo.cas;\n+\n+import lombok.val;\n+\n+import javax.servlet.ServletContextEvent;\n+import javax.servlet.ServletContextListener;\n+import javax.servlet.annotation.WebListener;\n+import java.sql.DriverManager;\n+import java.sql.SQLException;\n+import java.util.logging.Logger;\n+\n+/**\n+ * This is {@link JdbcServletContextListener} that properly\n+ * deregisters JDBC drivers.\n+ *\n+ * @author leeyc0\n+ * @since 6.2.0\n+ */\n+@WebListener\n+public class JdbcServletContextListener implements ServletContextListener {\n+\n+    @Override\n+    public void contextInitialized(final ServletContextEvent sce) {\n+    }\n+\n+    @Override\n+    public final void contextDestroyed(final ServletContextEvent sce) {\n+        /* Slf4j does not work in contextDestroyed */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d5d87bba4654a5516c4eaaf1ab90d9b11027635"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYwMjAzOA==", "bodyText": "Review all logger statements, and choose levels correctly.", "url": "https://github.com/apereo/cas/pull/4812#discussion_r421602038", "createdAt": "2020-05-07T15:38:55Z", "author": {"login": "mmoayyed"}, "path": "support/cas-server-support-jdbc-drivers/src/main/java/org/apereo/cas/JdbcServletContextListener.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package org.apereo.cas;\n+\n+import lombok.val;\n+\n+import javax.servlet.ServletContextEvent;\n+import javax.servlet.ServletContextListener;\n+import javax.servlet.annotation.WebListener;\n+import java.sql.DriverManager;\n+import java.sql.SQLException;\n+import java.util.logging.Logger;\n+\n+/**\n+ * This is {@link JdbcServletContextListener} that properly\n+ * deregisters JDBC drivers.\n+ *\n+ * @author leeyc0\n+ * @since 6.2.0\n+ */\n+@WebListener\n+public class JdbcServletContextListener implements ServletContextListener {\n+\n+    @Override\n+    public void contextInitialized(final ServletContextEvent sce) {\n+    }\n+\n+    @Override\n+    public final void contextDestroyed(final ServletContextEvent sce) {\n+        /* Slf4j does not work in contextDestroyed */\n+        val logger = Logger.getLogger(\"org.apereo.cas\");\n+        logger.info(\"Unregistering JdbcServletContextListener\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d5d87bba4654a5516c4eaaf1ab90d9b11027635"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4MTAxMTY1", "url": "https://github.com/apereo/cas/pull/4812#pullrequestreview-408101165", "createdAt": "2020-05-08T08:58:04Z", "commit": {"oid": "bd6af1d0f6d1d3acd217a24f044dfccfea87bf42"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdc7e7ca7310575e709041eb9128fa92ba49f5f2", "author": {"user": {"login": "leeyc0", "name": null}}, "url": "https://github.com/apereo/cas/commit/cdc7e7ca7310575e709041eb9128fa92ba49f5f2", "committedDate": "2020-05-08T09:36:30Z", "message": "properly unregister JDBC driver and wait quartz thread at application shutdown"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec9e5bf91a93dd1476c1e53aace8e0967606eaf7", "author": {"user": {"login": "leeyc0", "name": null}}, "url": "https://github.com/apereo/cas/commit/ec9e5bf91a93dd1476c1e53aace8e0967606eaf7", "committedDate": "2020-05-08T09:36:47Z", "message": "add tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3579, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}