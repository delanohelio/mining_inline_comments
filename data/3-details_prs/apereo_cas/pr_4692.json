{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc0NTU0MzMz", "number": 4692, "title": "Password Management Token & Server/Client IP Address check", "bodyText": "Details\nHello Misagh\nWhen you're using the reset password feature, a Token is generated and sent inside a hyperlink by email or SMS.\nThe Token contains the client IPaddress who requested the reset and the server IP adress who received it.\nIf the link is used by another client IP address or processed by another server IP address than the ones contains in the Token, the reset will fail.\nProblem: When you're running cas inside a container orchestrator like Kubernetes :\n\nIt could be difficult to stick a user to a specific container\nA container could have a very short life (less than the token TTL) because of horizontal autoscaling\n\nThis pull request adds the capability to disable the check of the server IP address. It also adds the capability to disable to check of the client IP address if needed.\nLet me know if you need any further information.\nRegards,\nJulien", "createdAt": "2020-02-12T21:50:46Z", "url": "https://github.com/apereo/cas/pull/4692", "merged": true, "mergeCommit": {"oid": "e20933fe99d8e9fe550d6ed7b135199f26a7111d"}, "closed": true, "closedAt": "2020-02-14T07:51:19Z", "author": {"login": "julienhuon"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDtMqkgH2gAyMzc0NTU0MzMzOmU0ZDIzZGVlZGQ4OTlhZjZiYTIxNDZiMTIxMjUzOTk5OGNlZGRiZjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcEKuBhAFqTM1ODc2MDg2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e4d23deedd899af6ba2146b1212539998ceddbf4", "author": {"user": {"login": "julienhuon", "name": "Julien Huon"}}, "url": "https://github.com/apereo/cas/commit/e4d23deedd899af6ba2146b1212539998ceddbf4", "committedDate": "2020-02-12T21:27:25Z", "message": " Password Management Token : Add the capability to disable the check of the client/server ip address."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a43f1d0473745f4def9a7ac2f40a41b72b361b8c", "author": {"user": {"login": "apereocas-bot", "name": null}}, "url": "https://github.com/apereo/cas/commit/a43f1d0473745f4def9a7ac2f40a41b72b361b8c", "committedDate": "2020-02-13T02:37:01Z", "message": "Merge branch '6.1.x' into 6.1.x"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MDEyMzIx", "url": "https://github.com/apereo/cas/pull/4692#pullrequestreview-358012321", "createdAt": "2020-02-13T07:55:32Z", "commit": {"oid": "a43f1d0473745f4def9a7ac2f40a41b72b361b8c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwNzo1NTozMlrOFpJ8Yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwNzo1NjoyM1rOFpJ9ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODY5ODg1MA==", "bodyText": "Rename to includeServerIpAddress or something similar", "url": "https://github.com/apereo/cas/pull/4692#discussion_r378698850", "createdAt": "2020-02-13T07:55:32Z", "author": {"login": "mmoayyed"}, "path": "api/cas-server-core-api-configuration-model/src/main/java/org/apereo/cas/configuration/model/support/pm/PasswordManagementProperties.java", "diffHunk": "@@ -266,6 +266,16 @@ public ForgotUsername() {\n          */\n         private boolean securityQuestionsEnabled = true;\n \n+        /**\n+         * Whether the Password Management Token will contain the server IP Address.\n+         */\n+        private boolean checkServerIpAddress = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a43f1d0473745f4def9a7ac2f40a41b72b361b8c"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODY5ODkyNg==", "bodyText": "Rename to includeClientIpAddress or something similar", "url": "https://github.com/apereo/cas/pull/4692#discussion_r378698926", "createdAt": "2020-02-13T07:55:45Z", "author": {"login": "mmoayyed"}, "path": "api/cas-server-core-api-configuration-model/src/main/java/org/apereo/cas/configuration/model/support/pm/PasswordManagementProperties.java", "diffHunk": "@@ -266,6 +266,16 @@ public ForgotUsername() {\n          */\n         private boolean securityQuestionsEnabled = true;\n \n+        /**\n+         * Whether the Password Management Token will contain the server IP Address.\n+         */\n+        private boolean checkServerIpAddress = true;\n+\n+        /**\n+         * Whether the Password Management Token will contain the client IP Address.\n+         */\n+        private boolean checkClientIpAddress = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a43f1d0473745f4def9a7ac2f40a41b72b361b8c"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODY5OTA3NA==", "bodyText": "Extract properties.getRest() into a variable.", "url": "https://github.com/apereo/cas/pull/4692#discussion_r378699074", "createdAt": "2020-02-13T07:56:08Z", "author": {"login": "mmoayyed"}, "path": "support/cas-server-support-pm-core/src/main/java/org/apereo/cas/pm/BasePasswordManagementService.java", "diffHunk": "@@ -74,11 +74,11 @@ public String parseToken(final String token) {\n             }\n \n             val holder = ClientInfoHolder.getClientInfo();\n-            if (!claims.getStringClaimValue(\"origin\").equals(holder.getServerIpAddress())) {\n+            if (properties.getReset().isCheckServerIpAddress() && !claims.getStringClaimValue(\"origin\").equals(holder.getServerIpAddress())) {\n                 LOGGER.error(\"Token origin server IP address does not match CAS\");\n                 return null;\n             }\n-            if (!claims.getStringClaimValue(\"client\").equals(holder.getClientIpAddress())) {\n+            if (properties.getReset().isCheckClientIpAddress() && !claims.getStringClaimValue(\"client\").equals(holder.getClientIpAddress())) {\n                 LOGGER.error(\"Token client IP address does not match CAS\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a43f1d0473745f4def9a7ac2f40a41b72b361b8c"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODY5OTE2Ng==", "bodyText": "Extract properties.getRest() into a variable.", "url": "https://github.com/apereo/cas/pull/4692#discussion_r378699166", "createdAt": "2020-02-13T07:56:23Z", "author": {"login": "mmoayyed"}, "path": "support/cas-server-support-pm-core/src/main/java/org/apereo/cas/pm/BasePasswordManagementService.java", "diffHunk": "@@ -110,8 +110,12 @@ public String createToken(final String to) {\n \n             val holder = ClientInfoHolder.getClientInfo();\n             if (holder != null) {\n-                claims.setStringClaim(\"origin\", holder.getServerIpAddress());\n-                claims.setStringClaim(\"client\", holder.getClientIpAddress());\n+                if (properties.getReset().isCheckServerIpAddress()) {\n+                    claims.setStringClaim(\"origin\", holder.getServerIpAddress());\n+                }\n+                if (properties.getReset().isCheckClientIpAddress()) {\n+                    claims.setStringClaim(\"client\", holder.getClientIpAddress());\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a43f1d0473745f4def9a7ac2f40a41b72b361b8c"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41e4d91f7e50e9a4fbc39f588c3fdcaa2283bdd1", "author": {"user": {"login": "apereocas-bot", "name": null}}, "url": "https://github.com/apereo/cas/commit/41e4d91f7e50e9a4fbc39f588c3fdcaa2283bdd1", "committedDate": "2020-02-13T08:36:59Z", "message": "Merge branch '6.1.x' into 6.1.x"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2b4fb2b679bb34dcc995c8767e115fb928f1290", "author": {"user": {"login": "apereocas-bot", "name": null}}, "url": "https://github.com/apereo/cas/commit/b2b4fb2b679bb34dcc995c8767e115fb928f1290", "committedDate": "2020-02-13T11:57:02Z", "message": "Merge branch '6.1.x' into 6.1.x"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69ca66b7d9b0e2dec742d8fa47ff8f69028123f7", "author": {"user": {"login": "apereocas-bot", "name": null}}, "url": "https://github.com/apereo/cas/commit/69ca66b7d9b0e2dec742d8fa47ff8f69028123f7", "committedDate": "2020-02-13T13:27:02Z", "message": "Merge branch '6.1.x' into 6.1.x"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f958ea55ced8f6133f97ba9267b7b5d2b86f7a0a", "author": {"user": {"login": "apereocas-bot", "name": null}}, "url": "https://github.com/apereo/cas/commit/f958ea55ced8f6133f97ba9267b7b5d2b86f7a0a", "committedDate": "2020-02-13T14:57:02Z", "message": "Merge branch '6.1.x' into 6.1.x"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f57072e09d4074840bfc79439cb0ec25241b7e87", "author": {"user": {"login": "apereocas-bot", "name": null}}, "url": "https://github.com/apereo/cas/commit/f57072e09d4074840bfc79439cb0ec25241b7e87", "committedDate": "2020-02-13T16:27:02Z", "message": "Merge branch '6.1.x' into 6.1.x"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48dbfdcb53a203297cba56cd8f8915d71fb4414d", "author": {"user": {"login": "apereocas-bot", "name": null}}, "url": "https://github.com/apereo/cas/commit/48dbfdcb53a203297cba56cd8f8915d71fb4414d", "committedDate": "2020-02-13T17:57:01Z", "message": "Merge branch '6.1.x' into 6.1.x"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdfaa4814b0b879aea3700ff838b540340263140", "author": {"user": {"login": "apereocas-bot", "name": null}}, "url": "https://github.com/apereo/cas/commit/fdfaa4814b0b879aea3700ff838b540340263140", "committedDate": "2020-02-13T19:27:03Z", "message": "Merge branch '6.1.x' into 6.1.x"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f07ac965b0a74e6c83c0613abaee6891cccd808d", "author": {"user": {"login": "julienhuon", "name": "Julien Huon"}}, "url": "https://github.com/apereo/cas/commit/f07ac965b0a74e6c83c0613abaee6891cccd808d", "committedDate": "2020-02-13T22:57:15Z", "message": "code improvement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e76aae022de7a52739f05f029334a869b5d3d91", "author": {"user": {"login": "apereocas-bot", "name": null}}, "url": "https://github.com/apereo/cas/commit/9e76aae022de7a52739f05f029334a869b5d3d91", "committedDate": "2020-02-14T04:27:00Z", "message": "Merge branch '6.1.x' into 6.1.x"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NzYwODYz", "url": "https://github.com/apereo/cas/pull/4692#pullrequestreview-358760863", "createdAt": "2020-02-14T07:51:06Z", "commit": {"oid": "9e76aae022de7a52739f05f029334a869b5d3d91"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3678, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}