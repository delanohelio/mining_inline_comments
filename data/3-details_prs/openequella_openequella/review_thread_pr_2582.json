{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyMTkwMjAx", "number": 2582, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMDozNDo0NlrOFAkJog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMDo1NDowNVrOFAkeBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MTM2NjEwOnYy", "diffSide": "RIGHT", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/LegacySelectionSessionModule.ts", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMDozNDo0NlrOH-7gOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMDozNDo0NlrOH-7gOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc0ODY2NQ==", "bodyText": "To keep things DRY so as to ensure accuracy, this should more so wrap the route in routes, something like:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              const remoteSearchLink = AppConfig.baseUrl.concat(\n          \n          \n            \n                `access/z3950.do?.repository=${uuid}&uc=true&_sl.stateId=${stateId}`\n          \n          \n            \n              );\n          \n          \n            \n              const remoteSearchLink = AppConfig.baseUrl.concat(\n          \n          \n            \n                `${routes.RemoteSearch.to(uuid)}&_sl.stateId=${stateId}`\n          \n          \n            \n              );\n          \n      \n    \n    \n  \n\nThe same suggestion applies for the below Advanced Search.", "url": "https://github.com/openequella/openEQUELLA/pull/2582#discussion_r535748665", "createdAt": "2020-12-04T00:34:46Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/LegacySelectionSessionModule.ts", "diffHunk": "@@ -215,6 +226,42 @@ export const buildSelectionSessionItemSummaryLink = (\n   return itemSummaryPageLink;\n };\n \n+/**\n+ * Build a Selection Session specific Remote search Link. Recommended to first call `isSelectionSessionOpen()`\n+ * before use.\n+ * @param uuid The UUID of a Remote search\n+ */\n+export const buildSelectionSessionRemoteSearchLink = (uuid: string): string => {\n+  const { stateId, integId } = getSelectionSessionInfo();\n+  const remoteSearchLink = AppConfig.baseUrl.concat(\n+    `access/z3950.do?.repository=${uuid}&uc=true&_sl.stateId=${stateId}`\n+  );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ff6b085b5e48c6db9eaaef52741c21fd161322d"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MTM4MDc3OnYy", "diffSide": "RIGHT", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/LegacySelectionSessionModule.ts", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMDo0MDoyMVrOH-7oPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMjoyNzowMVrOH-9-HQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc1MDcxOQ==", "bodyText": "This body pretty well duplicates the above function. I'd suggest you have one function such as:\nconst buildSelectionSessionLink = (routerPath: string) => {\n  const { stateId, integId } = getSelectionSessionInfo();\n  const selectionSessionLink = AppConfig.baseUrl.concat(\n    `${routerPath}&_sl.stateId=${stateId}`\n  );\n\n  if (integId) {\n    return selectionSessionLink.concat(`&_int.id=${integId}`);\n  }\n  return selectionSessionLink;\n}\nAnd this this function would simply be:\nexport const buildSelectionSessionAdvancedSearchLink = (\n  uuid: string\n): string => buildSelectionSessionLink(routes.AdvancedSearch.to(uuid));\nAnd you'd obviously do the same for buildSelectionSessionRemoteSearchLink. (And further down this review I've noted you'd probably want the same for buildSelectionSessionItemSummaryLink.)", "url": "https://github.com/openequella/openEQUELLA/pull/2582#discussion_r535750719", "createdAt": "2020-12-04T00:40:21Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/LegacySelectionSessionModule.ts", "diffHunk": "@@ -215,6 +226,42 @@ export const buildSelectionSessionItemSummaryLink = (\n   return itemSummaryPageLink;\n };\n \n+/**\n+ * Build a Selection Session specific Remote search Link. Recommended to first call `isSelectionSessionOpen()`\n+ * before use.\n+ * @param uuid The UUID of a Remote search\n+ */\n+export const buildSelectionSessionRemoteSearchLink = (uuid: string): string => {\n+  const { stateId, integId } = getSelectionSessionInfo();\n+  const remoteSearchLink = AppConfig.baseUrl.concat(\n+    `access/z3950.do?.repository=${uuid}&uc=true&_sl.stateId=${stateId}`\n+  );\n+\n+  if (integId) {\n+    return remoteSearchLink.concat(`&_int.id=${integId}`);\n+  }\n+  return remoteSearchLink;\n+};\n+\n+/**\n+ * Build a Selection Session specific Advanced search Link. Recommended to first call `isSelectionSessionOpen()`\n+ * before use.\n+ * @param uuid The UUID of an Advanced search\n+ */\n+export const buildSelectionSessionAdvancedSearchLink = (\n+  uuid: string\n+): string => {\n+  const { stateId, integId } = getSelectionSessionInfo();\n+  const advancedSearchLink = AppConfig.baseUrl.concat(\n+    `advanced/searching.do?in=P${uuid}&editquery=true&_sl.stateId=${stateId}`\n+  );\n+\n+  if (integId) {\n+    return advancedSearchLink.concat(`&_int.id=${integId}`);\n+  }\n+  return advancedSearchLink;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ff6b085b5e48c6db9eaaef52741c21fd161322d"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc4OTA4NQ==", "bodyText": "There is one small difference. For the ItemSummary URL, it requires &a=${layout} whereas the remote one and advanced one do not need. But I think it's fine to add this query string to the remote one and advanced one.", "url": "https://github.com/openequella/openEQUELLA/pull/2582#discussion_r535789085", "createdAt": "2020-12-04T02:27:01Z", "author": {"login": "PenghaiZhang"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/LegacySelectionSessionModule.ts", "diffHunk": "@@ -215,6 +226,42 @@ export const buildSelectionSessionItemSummaryLink = (\n   return itemSummaryPageLink;\n };\n \n+/**\n+ * Build a Selection Session specific Remote search Link. Recommended to first call `isSelectionSessionOpen()`\n+ * before use.\n+ * @param uuid The UUID of a Remote search\n+ */\n+export const buildSelectionSessionRemoteSearchLink = (uuid: string): string => {\n+  const { stateId, integId } = getSelectionSessionInfo();\n+  const remoteSearchLink = AppConfig.baseUrl.concat(\n+    `access/z3950.do?.repository=${uuid}&uc=true&_sl.stateId=${stateId}`\n+  );\n+\n+  if (integId) {\n+    return remoteSearchLink.concat(`&_int.id=${integId}`);\n+  }\n+  return remoteSearchLink;\n+};\n+\n+/**\n+ * Build a Selection Session specific Advanced search Link. Recommended to first call `isSelectionSessionOpen()`\n+ * before use.\n+ * @param uuid The UUID of an Advanced search\n+ */\n+export const buildSelectionSessionAdvancedSearchLink = (\n+  uuid: string\n+): string => {\n+  const { stateId, integId } = getSelectionSessionInfo();\n+  const advancedSearchLink = AppConfig.baseUrl.concat(\n+    `advanced/searching.do?in=P${uuid}&editquery=true&_sl.stateId=${stateId}`\n+  );\n+\n+  if (integId) {\n+    return advancedSearchLink.concat(`&_int.id=${integId}`);\n+  }\n+  return advancedSearchLink;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc1MDcxOQ=="}, "originalCommit": {"oid": "2ff6b085b5e48c6db9eaaef52741c21fd161322d"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MTQwNTg3OnYy", "diffSide": "RIGHT", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/SearchResult.tsx", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMDo0OToyM1rOH-71og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMDo0OToyM1rOH-71og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc1NDE0Ng==", "bodyText": "With this block we now have further conditional logic where we're already inside a ternary. I think for readability sake, this true branch of the ternary should now be in it's own function. So then this value expression might end up looking like:\nconst itemPrimaryContent =\n  inSelectionSession && !isSelectSummaryButtonDisabled() ? (\n    selectionSessionItemContent()\n  ) : (\n    itemLink()\n  );", "url": "https://github.com/openequella/openEQUELLA/pull/2582#discussion_r535754146", "createdAt": "2020-12-04T00:49:23Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/SearchResult.tsx", "diffHunk": "@@ -482,11 +480,13 @@ export default function SearchResult({\n         data-itemuuid={uuid}\n         data-itemversion={version}\n       >\n-        <Grid item>\n-          <IconButton>\n-            <DragIndicatorIcon />\n-          </IconButton>\n-        </Grid>\n+        {inStructured && (\n+          <Grid item>\n+            <IconButton>\n+              <DragIndicatorIcon />\n+            </IconButton>\n+          </Grid>\n+        )}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ff6b085b5e48c6db9eaaef52741c21fd161322d"}, "originalPosition": 96}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MTQxMTk5OnYy", "diffSide": "RIGHT", "path": "Source/Plugins/Core/com.equella.core/src/com/tle/web/searching/section/RootAdvancedSearchSection.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMDo1MTo0MlrOH-746A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMDo1MTo0MlrOH-746A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc1NDk4NA==", "bodyText": "Could be value here in a comment saying why you're setting this to 'false'.", "url": "https://github.com/openequella/openEQUELLA/pull/2582#discussion_r535754984", "createdAt": "2020-12-04T00:51:42Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/src/com/tle/web/searching/section/RootAdvancedSearchSection.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * The Apereo Foundation licenses this file to you under the Apache License,\n+ * Version 2.0, (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.tle.web.searching.section;\n+\n+import com.tle.web.sections.SectionResult;\n+import com.tle.web.sections.SectionTree;\n+import com.tle.web.sections.events.RenderEventContext;\n+import com.tle.web.sections.events.RenderEventListener;\n+import com.tle.web.sections.render.HtmlRendererListener;\n+import com.tle.web.selection.SelectionSession;\n+import com.tle.web.selection.section.RootSelectionSection.Layout;\n+import com.tle.web.selection.section.SelectionSummarySection;\n+\n+public class RootAdvancedSearchSection extends RootSearchSection {\n+\n+  @Override\n+  public SectionResult renderHtml(RenderEventContext context) {\n+    SelectionSession selectionSession = selectionService.getCurrentSession(context);\n+    if (selectionSession != null) {\n+      // As we keep SelectionSummarySection in the tree for 'advanced/searching.do' regardless of\n+      // Selection Session's layout, we need to dynamically handle whether to show it or not.\n+      // The approach is to remove or add the RenderEventListener for SelectionSummarySection.\n+      SelectionSummarySection selectionSummarySection =\n+          context.lookupSection(SelectionSummarySection.class);\n+      String selectionSummarySectionId = selectionSummarySection.getSectionId();\n+      Layout selectionSessionLayout = selectionSession.getLayout();\n+      boolean selectionSummaryListenerExisting =\n+          context\n+                  .getTree()\n+                  .getListeners(selectionSummarySectionId, RenderEventListener.class)\n+                  .size()\n+              > 0;\n+\n+      // Remove the listener in 'structured'.\n+      if (selectionSessionLayout == Layout.COURSE && selectionSummaryListenerExisting) {\n+        context.getTree().removeListeners(selectionSummarySectionId);\n+      }\n+      // Or add the listener back in 'selectOrAdd'.\n+      else if (selectionSessionLayout == Layout.NORMAL && !selectionSummaryListenerExisting) {\n+        context\n+            .getTree()\n+            .addListener(\n+                selectionSummarySectionId,\n+                RenderEventListener.class,\n+                new HtmlRendererListener(\n+                    selectionSummarySectionId, selectionSummarySection, getTree()));\n+      }\n+    }\n+\n+    return super.renderHtml(context);\n+  }\n+\n+  @Override\n+  public void registered(String id, SectionTree tree) {\n+    super.registered(id, tree);\n+  }\n+\n+  @Override\n+  public boolean useNewSearch() {\n+    return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ff6b085b5e48c6db9eaaef52741c21fd161322d"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MTQxNTc2OnYy", "diffSide": "RIGHT", "path": "Source/Plugins/Core/com.equella.core/src/com/tle/web/searching/section/RootSearchSection.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMDo1Mjo1NlrOH-762g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMDo1Mjo1NlrOH-762g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc1NTQ4Mg==", "bodyText": "Be good to do as JavaDoc.", "url": "https://github.com/openequella/openEQUELLA/pull/2582#discussion_r535755482", "createdAt": "2020-12-04T00:52:56Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/src/com/tle/web/searching/section/RootSearchSection.java", "diffHunk": "@@ -70,6 +70,11 @@ protected String getSessionKey() {\n     return SEARCH_SESSIONKEY;\n   }\n \n+  // For child sections that need to skip new Search UI, override this function and return false.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ff6b085b5e48c6db9eaaef52741c21fd161322d"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MTQxODI5OnYy", "diffSide": "RIGHT", "path": "Source/Plugins/Core/com.equella.core/src/com/tle/web/searching/section/RootSearchSection.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMDo1NDowNVrOH-78Rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMDo1NDowNVrOH-78Rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc1NTg0Nw==", "bodyText": "Should this perhaps just be protected?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public boolean useNewSearch() {\n          \n          \n            \n              protected boolean useNewSearch() {\n          \n      \n    \n    \n  \n\nIt's not intended to be used a public interface, just for internal operations.", "url": "https://github.com/openequella/openEQUELLA/pull/2582#discussion_r535755847", "createdAt": "2020-12-04T00:54:05Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/src/com/tle/web/searching/section/RootSearchSection.java", "diffHunk": "@@ -70,6 +70,11 @@ protected String getSessionKey() {\n     return SEARCH_SESSIONKEY;\n   }\n \n+  // For child sections that need to skip new Search UI, override this function and return false.\n+  public boolean useNewSearch() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ff6b085b5e48c6db9eaaef52741c21fd161322d"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1614, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}