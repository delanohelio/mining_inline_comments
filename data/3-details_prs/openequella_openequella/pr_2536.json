{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzODQxMDEw", "number": 2536, "title": "Feature/share search button", "bodyText": "Checklist\n\n\n the contributor license agreement is signed\n commit message follows commit guidelines\n tests are included\n screenshots are included showing significant UI changes\n\nDescription of change\n\n#1306\nThis is essentially adding a ui layer for my previous PR (#2506)\nA new share button has been added to the SearchResultList component.\nIt generates the url of the current search page, along with a query string param that stores the current state of the search page. The link is stored in the user's clipboard, and a snackbar is displayed.", "createdAt": "2020-11-19T10:31:40Z", "url": "https://github.com/openequella/openEQUELLA/pull/2536", "merged": true, "mergeCommit": {"oid": "0e55135bdd3b23b333ca99b15c86c54a053ef4d9"}, "closed": true, "closedAt": "2020-11-26T21:51:06Z", "author": {"login": "mrblippy"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdd_8AWAH2gAyNTIzODQxMDEwOjc1NjBiZGQ4NTNjNTE1ZDNiMzJkMDljNDgyNWQwNTQwZjhmZmFiYWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgMfTkAFqTUzOTAxMTkyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7560bdd853c515d3b32d09c4825d0540f8ffabad", "author": {"user": {"login": "mrblippy", "name": "Nick Charles"}}, "url": "https://github.com/openequella/openEQUELLA/commit/7560bdd853c515d3b32d09c4825d0540f8ffabad", "committedDate": "2020-11-19T10:10:36Z", "message": "Added 'copy search link' button to search result list"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ec08bd66a3a59bd2f3a2ce3e2a2645a6111431b", "author": {"user": {"login": "mrblippy", "name": "Nick Charles"}}, "url": "https://github.com/openequella/openEQUELLA/commit/4ec08bd66a3a59bd2f3a2ce3e2a2645a6111431b", "committedDate": "2020-11-19T10:10:36Z", "message": "Put in a null check before mapping over collections. This addresses an issue when I came accross while clciking the copy search button on an already copied link"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0OTIxMTY0", "url": "https://github.com/openequella/openEQUELLA/pull/2536#pullrequestreview-534921164", "createdAt": "2020-11-19T22:48:36Z", "commit": {"oid": "4ec08bd66a3a59bd2f3a2ce3e2a2645a6111431b"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMjo0ODozNlrOH21JRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMzowNDoxNVrOH21luA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1NTg3OQ==", "bodyText": "Why added this question mark may I ask ? The type of value is Array which should ensure it won't be undefined or null.", "url": "https://github.com/openequella/openEQUELLA/pull/2536#discussion_r527255879", "createdAt": "2020-11-19T22:48:36Z", "author": {"login": "PenghaiZhang"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "diffHunk": "@@ -274,7 +274,7 @@ export const generateQueryStringFromSearchOptions = (\n       return match(\n         [\n           Literal(\"collections\"),\n-          () => value.map((collection) => pick(collection, [\"uuid\"])),\n+          () => value?.map((collection) => pick(collection, [\"uuid\"])),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ec08bd66a3a59bd2f3a2ce3e2a2645a6111431b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1NjMyMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import { RenderData } from \"../mainui\";\n          \n          \n            \n            import type { RenderData } from \"../mainui\";", "url": "https://github.com/openequella/openEQUELLA/pull/2536#discussion_r527256321", "createdAt": "2020-11-19T22:49:37Z", "author": {"login": "PenghaiZhang"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/SearchPage.tsx", "diffHunk": "@@ -24,7 +24,10 @@ import { useEffect, useRef, useState } from \"react\";\n import { useHistory, useLocation } from \"react-router\";\n import { Static } from \"runtypes\";\n import { generateFromError } from \"../api/errors\";\n+import { AppConfig } from \"../AppConfig\";\n import { DateRangeSelector } from \"../components/DateRangeSelector\";\n+import MessageInfo from \"../components/MessageInfo\";\n+import { RenderData } from \"../mainui\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ec08bd66a3a59bd2f3a2ce3e2a2645a6111431b"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1NzUxMA==", "bodyText": "You can reuse searchStrings.", "url": "https://github.com/openequella/openEQUELLA/pull/2536#discussion_r527257510", "createdAt": "2020-11-19T22:51:50Z", "author": {"login": "PenghaiZhang"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/SearchPage.tsx", "diffHunk": "@@ -288,6 +295,27 @@ const SearchPage = ({ updateTemplate }: TemplateUpdateProps) => {\n     setFilterExpansion(false);\n   };\n \n+  const copySearchInfoSnackbar = (\n+    <MessageInfo\n+      open={showSnackBar}\n+      onClose={() => setShowSnackBar(false)}\n+      title={languageStrings.searchpage.shareSearchConfirmationText}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ec08bd66a3a59bd2f3a2ce3e2a2645a6111431b"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI2MDUxNg==", "bodyText": "Is there any possibility that writeText could fail ?", "url": "https://github.com/openequella/openEQUELLA/pull/2536#discussion_r527260516", "createdAt": "2020-11-19T22:58:33Z", "author": {"login": "PenghaiZhang"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/SearchPage.tsx", "diffHunk": "@@ -288,6 +295,27 @@ const SearchPage = ({ updateTemplate }: TemplateUpdateProps) => {\n     setFilterExpansion(false);\n   };\n \n+  const copySearchInfoSnackbar = (\n+    <MessageInfo\n+      open={showSnackBar}\n+      onClose={() => setShowSnackBar(false)}\n+      title={languageStrings.searchpage.shareSearchConfirmationText}\n+      variant=\"success\"\n+    />\n+  );\n+\n+  const handleCopySearch = () => {\n+    //base institution urls have a trailing / that we need to get rid of\n+    const instUrl = AppConfig.baseUrl.slice(0, -1);\n+    const searchUrl = `${instUrl}${\n+      location.pathname\n+    }?${generateQueryStringFromSearchOptions(searchPageOptions)}`;\n+\n+    navigator.clipboard.writeText(searchUrl).then(() => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ec08bd66a3a59bd2f3a2ce3e2a2645a6111431b"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI2MjM2Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import { Share } from \"@material-ui/icons\";\n          \n          \n            \n            import Share from \"@material-ui/icons/Share\"", "url": "https://github.com/openequella/openEQUELLA/pull/2536#discussion_r527262363", "createdAt": "2020-11-19T23:02:05Z", "author": {"login": "PenghaiZhang"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/SearchResultList.tsx", "diffHunk": "@@ -23,12 +23,14 @@ import {\n   CardHeader,\n   CircularProgress,\n   Grid,\n+  IconButton,\n   List,\n   ListItem,\n   Tooltip,\n   Typography,\n } from \"@material-ui/core\";\n import { makeStyles } from \"@material-ui/core/styles\";\n+import { Share } from \"@material-ui/icons\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ec08bd66a3a59bd2f3a2ce3e2a2645a6111431b"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI2MzE2MA==", "bodyText": "What about adding a label here for accessibility and writing tests more easily ?", "url": "https://github.com/openequella/openEQUELLA/pull/2536#discussion_r527263160", "createdAt": "2020-11-19T23:04:15Z", "author": {"login": "PenghaiZhang"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/SearchResultList.tsx", "diffHunk": "@@ -122,6 +129,13 @@ export const SearchResultList = ({\n                 </Button>\n               </Tooltip>\n             </Grid>\n+            <Grid item>\n+              <Tooltip title={searchPageStrings.shareSearchHelperText}>\n+                <IconButton onClick={onCopySearchLink}>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ec08bd66a3a59bd2f3a2ce3e2a2645a6111431b"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0OTUxNzIw", "url": "https://github.com/openequella/openEQUELLA/pull/2536#pullrequestreview-534951720", "createdAt": "2020-11-19T23:55:16Z", "commit": {"oid": "4ec08bd66a3a59bd2f3a2ce3e2a2645a6111431b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMzo1NToxNlrOH22uOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMzo1NzozN1rOH22xeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI4MTcyMA==", "bodyText": "Two things:\n\nHow come you can't do it like the window.scroll below; and\nEven if you can't, rather than using () => {} could be better to use jest.fn();", "url": "https://github.com/openequella/openEQUELLA/pull/2536#discussion_r527281720", "createdAt": "2020-11-19T23:55:16Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -82,6 +82,11 @@ const mockConvertParamsToSearchOptions = jest.spyOn(\n   SearchModule,\n   \"queryStringParamsToSearchOptions\"\n );\n+Object.assign(navigator, {\n+  clipboard: {\n+    writeText: () => {},\n+  },\n+});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ec08bd66a3a59bd2f3a2ce3e2a2645a6111431b"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI4MjA2MQ==", "bodyText": "Best to use languageString here rather than raw string literal.", "url": "https://github.com/openequella/openEQUELLA/pull/2536#discussion_r527282061", "createdAt": "2020-11-19T23:56:14Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -680,6 +685,18 @@ describe(\"<SearchPage/>\", () => {\n       selectedCategories: selectedCategories,\n     });\n   });\n+\n+  it(\"should copy a search link to clipboard, and show a snackbar\", async () => {\n+    const mockClipboard = jest.spyOn(navigator.clipboard, \"writeText\");\n+    const copySearchButton = screen.getByTitle(\"Copy search link to clipboard\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ec08bd66a3a59bd2f3a2ce3e2a2645a6111431b"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI4MjU1NA==", "bodyText": "langstrings", "url": "https://github.com/openequella/openEQUELLA/pull/2536#discussion_r527282554", "createdAt": "2020-11-19T23:57:37Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -680,6 +685,18 @@ describe(\"<SearchPage/>\", () => {\n       selectedCategories: selectedCategories,\n     });\n   });\n+\n+  it(\"should copy a search link to clipboard, and show a snackbar\", async () => {\n+    const mockClipboard = jest.spyOn(navigator.clipboard, \"writeText\");\n+    const copySearchButton = screen.getByTitle(\"Copy search link to clipboard\");\n+    mockClipboard.mockResolvedValueOnce();\n+    await act(async () => {\n+      copySearchButton.click();\n+    });\n+    expect(\n+      screen.getByText(\"Search link saved to clipboard\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ec08bd66a3a59bd2f3a2ce3e2a2645a6111431b"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82d7aefcaea906aa84bf9cd2616038a579f12635", "author": {"user": {"login": "mrblippy", "name": "Nick Charles"}}, "url": "https://github.com/openequella/openEQUELLA/commit/82d7aefcaea906aa84bf9cd2616038a579f12635", "committedDate": "2020-11-21T07:30:13Z", "message": "add extra logging and assertion to BaseEntityAPITest, to try and work out why th test fails on github actions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9888d2bf59e536c265421ebf015398e7d494a34", "author": {"user": {"login": "mrblippy", "name": "Nick Charles"}}, "url": "https://github.com/openequella/openEQUELLA/commit/f9888d2bf59e536c265421ebf015398e7d494a34", "committedDate": "2020-11-21T09:42:03Z", "message": "try setting parallel=true, as that is one differnce to codebuild autotest config. this is to futher narrow down an issue in failing BaseEntityAPITest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6275a9e1160c79a3d1ef5f1e1033d2ecd841f349", "author": {"user": {"login": "mrblippy", "name": "Nick Charles"}}, "url": "https://github.com/openequella/openEQUELLA/commit/6275a9e1160c79a3d1ef5f1e1033d2ecd841f349", "committedDate": "2020-11-22T22:14:01Z", "message": "more logging to try and work out why baseentity test is failing, will revert this later"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fff1f5a1419269cedab45ea2208d9ca9f47c11e8", "author": {"user": {"login": "mrblippy", "name": "Nick Charles"}}, "url": "https://github.com/openequella/openEQUELLA/commit/fff1f5a1419269cedab45ea2208d9ca9f47c11e8", "committedDate": "2020-11-23T01:41:16Z", "message": "Revert \"more logging to try and work out why baseentity test is failing, will revert this later\"\n\nThis reverts commit 6275a9e1160c79a3d1ef5f1e1033d2ecd841f349."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cba132a0209ae3754637c094aab73f186e1eedc2", "author": {"user": {"login": "mrblippy", "name": "Nick Charles"}}, "url": "https://github.com/openequella/openEQUELLA/commit/cba132a0209ae3754637c094aab73f186e1eedc2", "committedDate": "2020-11-23T01:41:42Z", "message": "Revert \"try setting parallel=true, as that is one differnce to codebuild autotest config. this is to futher narrow down an issue in failing BaseEntityAPITest\"\n\nThis reverts commit f9888d2bf59e536c265421ebf015398e7d494a34."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43c4d7e33e97004665ccfb49dbb2c2fe3af5231b", "author": {"user": {"login": "mrblippy", "name": "Nick Charles"}}, "url": "https://github.com/openequella/openEQUELLA/commit/43c4d7e33e97004665ccfb49dbb2c2fe3af5231b", "committedDate": "2020-11-23T01:42:38Z", "message": "Revert \"add extra logging and assertion to BaseEntityAPITest, to try and work out why th test fails on github actions\"\n\nThis reverts commit 82d7aefcaea906aa84bf9cd2616038a579f12635."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75022e50aed94fb67269f8e89022385f11a8065b", "author": {"user": {"login": "mrblippy", "name": "Nick Charles"}}, "url": "https://github.com/openequella/openEQUELLA/commit/75022e50aed94fb67269f8e89022385f11a8065b", "committedDate": "2020-11-23T05:07:25Z", "message": "Check for one security node in results. This has been changed because the results come back in a different order for codebuild vs github actions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "588441ed11dedd09fa150d4bf89f934b14309d4a", "author": {"user": {"login": "mrblippy", "name": "Nick Charles"}}, "url": "https://github.com/openequella/openEQUELLA/commit/588441ed11dedd09fa150d4bf89f934b14309d4a", "committedDate": "2020-11-23T23:06:33Z", "message": "Handle error for navigator.clipboard, and reuse an existing language string const"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e502043482ff6754700f4b6bb285e86835e7417", "author": {"user": {"login": "mrblippy", "name": "Nick Charles"}}, "url": "https://github.com/openequella/openEQUELLA/commit/0e502043482ff6754700f4b6bb285e86835e7417", "committedDate": "2020-11-24T05:35:01Z", "message": "Add selenuim test to test copying a saved search link to clipboard, and accessing it"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6585e2aff0c3e967e9bb6ccbe5c4b73a726996d5", "author": {"user": {"login": "mrblippy", "name": "Nick Charles"}}, "url": "https://github.com/openequella/openEQUELLA/commit/6585e2aff0c3e967e9bb6ccbe5c4b73a726996d5", "committedDate": "2020-11-24T05:41:09Z", "message": "Use language strings instead of raw strings for assertions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d03a74cb8038b0ed492b36713144f8c1b62ed403", "author": {"user": {"login": "mrblippy", "name": "Nick Charles"}}, "url": "https://github.com/openequella/openEQUELLA/commit/d03a74cb8038b0ed492b36713144f8c1b62ed403", "committedDate": "2020-11-24T05:47:03Z", "message": "be more explicit when checking collection results for presence security node, instead of assuming the order"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4c2145969d503de0fa3fb2ea007df93723edcf7", "author": {"user": {"login": "mrblippy", "name": "Nick Charles"}}, "url": "https://github.com/openequella/openEQUELLA/commit/f4c2145969d503de0fa3fb2ea007df93723edcf7", "committedDate": "2020-11-24T22:09:02Z", "message": "remove mock that i shouldn't have commited in the first place"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be81895d421d2430414e61d24fd7be05461bfc76", "author": {"user": {"login": "mrblippy", "name": "Nick Charles"}}, "url": "https://github.com/openequella/openEQUELLA/commit/be81895d421d2430414e61d24fd7be05461bfc76", "committedDate": "2020-11-25T05:07:50Z", "message": "Revert \"Add selenuim test to test copying a saved search link to clipboard, and accessing it\". I did this due to issues when accessing the clipboard api when running chrome in headless mode\n\nThis reverts commit 0e502043482ff6754700f4b6bb285e86835e7417."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a423b0adb3ac3350ba1584bd1764db4be0d80187", "author": {"user": {"login": "mrblippy", "name": "Nick Charles"}}, "url": "https://github.com/openequella/openEQUELLA/commit/a423b0adb3ac3350ba1584bd1764db4be0d80187", "committedDate": "2020-11-25T05:13:57Z", "message": "Assert that the mocked clipboard has been called with the correct query string. This is to account for not being able to test the copy/pasting functionality correctly in the selenium headless NewSearchPageTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4OTE5NjIx", "url": "https://github.com/openequella/openEQUELLA/pull/2536#pullrequestreview-538919621", "createdAt": "2020-11-26T00:27:54Z", "commit": {"oid": "a423b0adb3ac3350ba1584bd1764db4be0d80187"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f75b557d9257b6bea213ad29a628026a8359695", "author": {"user": {"login": "mrblippy", "name": "Nick Charles"}}, "url": "https://github.com/openequella/openEQUELLA/commit/4f75b557d9257b6bea213ad29a628026a8359695", "committedDate": "2020-11-26T05:40:31Z", "message": "add undefined type to json stringify function, as it's conceivable that the value can be undefined"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5MDExOTIw", "url": "https://github.com/openequella/openEQUELLA/pull/2536#pullrequestreview-539011920", "createdAt": "2020-11-26T05:55:52Z", "commit": {"oid": "4f75b557d9257b6bea213ad29a628026a8359695"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 361, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}