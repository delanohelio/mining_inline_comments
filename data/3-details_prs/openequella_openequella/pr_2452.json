{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4NjI3MjU5", "number": 2452, "title": "Allow skipping tests in TestNG at runtime", "bodyText": "Checklist\n\n the [contributor license agreement][] is signed\n commit message follows [commit guidelines][]\n tests are included\n screenshots are included showing significant UI changes\n documentation is changed or added\n\nDescription of change\nAdd the ability of skipping tests in TestNG at runtime based on the environment.\nThere are three steps done to support this.\n\nAdd a new annotation which is used to specify whether to skip a test or not.\nIn 'TestAnnotationTransformer', dynamically disable a test based on the annotation and environment.\nInclude the Transformer in tesnng-codebuild.yaml .\n\nThis PR also refactored the directory structure where TestAnnotationTransformer is sitting.", "createdAt": "2020-10-23T00:22:02Z", "url": "https://github.com/openequella/openEQUELLA/pull/2452", "merged": true, "mergeCommit": {"oid": "a7ef6293743d38cd7966743560b177fb95be1bc5"}, "closed": true, "closedAt": "2020-10-27T02:44:08Z", "author": {"login": "PenghaiZhang"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVJ1aiAH2gAyNTA4NjI3MjU5OjY5NWIyYmY1MWJmOGI0MTNkNzZiYTFjOTgwMzAxZGZlNjY0YTA5N2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWenqzgFqTUxNzI4NDIzNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "695b2bf51bf8b413d76ba1c980301dfe664a097b", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/695b2bf51bf8b413d76ba1c980301dfe664a097b", "committedDate": "2020-10-22T22:37:08Z", "message": "Refactor the TestNG Transformer directory structure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a334d9a2efed4f082c943b2b4b13dd3a526ae5b", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/0a334d9a2efed4f082c943b2b4b13dd3a526ae5b", "committedDate": "2020-10-22T22:39:43Z", "message": "Add a new annotation to skip tests in TestNG."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fd7f34b93caebc6e6a891c3bcef144e5c5a20c5", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/0fd7f34b93caebc6e6a891c3bcef144e5c5a20c5", "committedDate": "2020-10-23T00:00:18Z", "message": "Use the SkipTest annotation to skip tests at runtime."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5eae8de91eede5ad5871f1bb1ca27b4901b4446b", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/5eae8de91eede5ad5871f1bb1ca27b4901b4446b", "committedDate": "2020-10-23T00:02:01Z", "message": "Skip NewSearchPageTest when CI is in Old UI."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fae8a78b1f5023c7314b9e83db4d87dc5cc9822", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/8fae8a78b1f5023c7314b9e83db4d87dc5cc9822", "committedDate": "2020-10-23T00:07:11Z", "message": "Update 'testng-codebuild.yaml' to use the TestAnnotationTransformer."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33b5649303f469297725d95b1c1561c96e766420", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/33b5649303f469297725d95b1c1561c96e766420", "committedDate": "2020-10-23T00:08:48Z", "message": "Remove the skipping test workaround added in NewSearchPageTest."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6752dfe3786d8939e866db3b7771663d2b2a85de", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/6752dfe3786d8939e866db3b7771663d2b2a85de", "committedDate": "2020-10-23T00:15:07Z", "message": "Add environment variable 'OLD_TEST_NEWUI' in buildspec.yml"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MjA3MTE5", "url": "https://github.com/openequella/openEQUELLA/pull/2452#pullrequestreview-515207119", "createdAt": "2020-10-23T00:32:35Z", "commit": {"oid": "6752dfe3786d8939e866db3b7771663d2b2a85de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwMDozMjozNVrOHm4dGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwMDozMjozNVrOHm4dGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUzMjg5MA==", "bodyText": "I wonder if people want to add this annotation on class level. Adding it on method level gives more flexibility though.", "url": "https://github.com/openequella/openEQUELLA/pull/2452#discussion_r510532890", "createdAt": "2020-10-23T00:32:35Z", "author": {"login": "PenghaiZhang"}, "path": "autotest/OldTests/src/test/java/io/github/openequella/search/NewSearchPageTest.java", "diffHunk": "@@ -18,13 +19,15 @@ protected void prepareBrowserSession() {\n   }\n \n   @Test(description = \"open the new Search page and wait for initial search completed\")\n+  @SkipTest(skipOldUI = true)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6752dfe3786d8939e866db3b7771663d2b2a85de"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e8ea9c228c17ff0ce1cc3c2ee3809effe0f6975", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/2e8ea9c228c17ff0ce1cc3c2ee3809effe0f6975", "committedDate": "2020-10-23T03:22:10Z", "message": "Remove an error configuration for testng-codebuild listener."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MzY3Njc3", "url": "https://github.com/openequella/openEQUELLA/pull/2452#pullrequestreview-515367677", "createdAt": "2020-10-23T06:05:46Z", "commit": {"oid": "2e8ea9c228c17ff0ce1cc3c2ee3809effe0f6975"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwNjowNTo0N1rOHm_ZtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwNjowOTowMlrOHm_llg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY0NjcwOQ==", "bodyText": "Arguably these should be split out into two methods:\n\ncheckRetryAnnotation; and\ncheckSkipTestAnnotation.", "url": "https://github.com/openequella/openEQUELLA/pull/2452#discussion_r510646709", "createdAt": "2020-10-23T06:05:47Z", "author": {"login": "edalex-ian"}, "path": "autotest/OldTests/src/test/java/testng/TestAnnotationTransformer.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package testng;\n+\n+import java.lang.reflect.Constructor;\n+import java.lang.reflect.Method;\n+import org.testng.IAnnotationTransformer;\n+import org.testng.annotations.ITestAnnotation;\n+import testng.annotation.RetryTest;\n+import testng.annotation.SkipTest;\n+\n+public class TestAnnotationTransformer implements IAnnotationTransformer {\n+  private static final String OLD_TEST_NEWUI = \"OLD_TEST_NEWUI\";\n+\n+  @Override\n+  public void transform(\n+      ITestAnnotation annotation, Class testClass, Constructor testConstructor, Method testMethod) {\n+    if (testMethod == null) return;\n+\n+    RetryTest maxRetryCount = testMethod.getAnnotation(RetryTest.class);\n+    if (maxRetryCount != null && maxRetryCount.value() > 1) {\n+      annotation.setRetryAnalyzer(FailureRetryAnalyzer.class);\n+    }\n+\n+    SkipTest skipTest = testMethod.getAnnotation(SkipTest.class);\n+    // Read the configuration of using new UI or not from environment variable.\n+    boolean isNewUIEnabled = Boolean.parseBoolean(System.getProperty(OLD_TEST_NEWUI));\n+    // Skip tests that should not run against Old UI when CI is running in Old UI.\n+    if (skipTest != null && skipTest.skipOldUI() && !isNewUIEnabled) {\n+      annotation.setEnabled(false);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e8ea9c228c17ff0ce1cc3c2ee3809effe0f6975"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY0OTEzMQ==", "bodyText": "Seeing this annotation is just about skipping base on old vs new, should we maybe go with naming like NewUiOnly? And have a simple value so that then you can have:\n@NewUiOnly(true)\n@Test\nclass NewUiTests {", "url": "https://github.com/openequella/openEQUELLA/pull/2452#discussion_r510649131", "createdAt": "2020-10-23T06:08:26Z", "author": {"login": "edalex-ian"}, "path": "autotest/OldTests/src/test/java/testng/annotation/SkipTest.java", "diffHunk": "@@ -0,0 +1,9 @@\n+package testng.annotation;\n+\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+\n+@Retention(RetentionPolicy.RUNTIME)\n+public @interface SkipTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e8ea9c228c17ff0ce1cc3c2ee3809effe0f6975"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY0OTc1MA==", "bodyText": "Nice work dude! Shame our retry tests appear to have not been running on CI.", "url": "https://github.com/openequella/openEQUELLA/pull/2452#discussion_r510649750", "createdAt": "2020-10-23T06:09:02Z", "author": {"login": "edalex-ian"}, "path": "autotest/OldTests/testng-codebuild.yaml", "diffHunk": "@@ -1,6 +1,7 @@\n name: SingleSuite\n threadCount: 1\n-\n+listeners:\n+  - testng.TestAnnotationTransformer", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e8ea9c228c17ff0ce1cc3c2ee3809effe0f6975"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1Njk0ODM1", "url": "https://github.com/openequella/openEQUELLA/pull/2452#pullrequestreview-515694835", "createdAt": "2020-10-23T14:00:23Z", "commit": {"oid": "2e8ea9c228c17ff0ce1cc3c2ee3809effe0f6975"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "882cb9d416d83e0adad5ccc61c04009a16a92270", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/882cb9d416d83e0adad5ccc61c04009a16a92270", "committedDate": "2020-10-25T22:17:25Z", "message": "Check why NewSearchPageTest was skipped on both New and Old UI."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae076406f8fe3231d96ca0ccfddc7b01dd39ce6a", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/ae076406f8fe3231d96ca0ccfddc7b01dd39ce6a", "committedDate": "2020-10-25T22:39:43Z", "message": "Rename annotation 'SkipTest' to 'NewUIOnly'."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd59edc3b57bce8ff95c9c54c956feabf8e7d678", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/dd59edc3b57bce8ff95c9c54c956feabf8e7d678", "committedDate": "2020-10-25T22:40:56Z", "message": "Refactor method 'transform' of TestAnnotationTransformer."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10e91c0eb7ca75b07591caeac1c8ca58dea7d8da", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/10e91c0eb7ca75b07591caeac1c8ca58dea7d8da", "committedDate": "2020-10-25T22:44:21Z", "message": "Use 'getenv' to access environment variable 'OLD_TEST_NEWUI'."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b44fb0cabdaa83ea2dc81c9878f75025ee9ea0f", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/5b44fb0cabdaa83ea2dc81c9878f75025ee9ea0f", "committedDate": "2020-10-25T23:05:27Z", "message": "Remove testing code added in TestAnnotationTransformer."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTgxNzg1", "url": "https://github.com/openequella/openEQUELLA/pull/2452#pullrequestreview-516981785", "createdAt": "2020-10-26T16:51:48Z", "commit": {"oid": "5b44fb0cabdaa83ea2dc81c9878f75025ee9ea0f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjo1MTo0OFrOHoZBFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjo1MTo0OFrOHoZBFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjExNDk2NQ==", "bodyText": "out of curiosity, why does this need to be passed true?\nWouldn't it default to true?", "url": "https://github.com/openequella/openEQUELLA/pull/2452#discussion_r512114965", "createdAt": "2020-10-26T16:51:48Z", "author": {"login": "ChristianMurphy"}, "path": "autotest/OldTests/src/test/java/io/github/openequella/search/NewSearchPageTest.java", "diffHunk": "@@ -18,13 +19,15 @@ protected void prepareBrowserSession() {\n   }\n \n   @Test(description = \"open the new Search page and wait for initial search completed\")\n+  @NewUIOnly(true)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b44fb0cabdaa83ea2dc81c9878f75025ee9ea0f"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e1d826e90747b21862fa4f57c76f4cd6fc62765", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/9e1d826e90747b21862fa4f57c76f4cd6fc62765", "committedDate": "2020-10-26T23:16:05Z", "message": "Change the default value of annotation 'NewUIOnly' to true."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MjQ1NzM0", "url": "https://github.com/openequella/openEQUELLA/pull/2452#pullrequestreview-517245734", "createdAt": "2020-10-26T23:23:47Z", "commit": {"oid": "9e1d826e90747b21862fa4f57c76f4cd6fc62765"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3Mjg0MjM2", "url": "https://github.com/openequella/openEQUELLA/pull/2452#pullrequestreview-517284236", "createdAt": "2020-10-27T01:24:03Z", "commit": {"oid": "9e1d826e90747b21862fa4f57c76f4cd6fc62765"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 325, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}