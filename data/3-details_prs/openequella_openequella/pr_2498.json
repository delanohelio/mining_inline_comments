{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3NDc3ODU4", "number": 2498, "title": "Fix view video attachments from New Search UI search results", "bodyText": "Checklist\n\n\n the contributor license agreement is signed\n commit message follows commit guidelines\n tests are included\n\nDescription of change\n\nUnfortunately, unless the viewer for the video MIME types was configured as 'file' then the viewer would fail. By default, the viewer is the HTML 5 Viewer of oEQ, so it was attempting to use the resultant HTML from that page in a <video> tag.\nTo fix this, the path of the file for file attachments is also returned in the attachment data for search results. This can then be used by the front end to build a direct file URL when wanted. In the case of the viewer, this is pretty well always unless the viewer configuration is for download.", "createdAt": "2020-11-09T05:24:28Z", "url": "https://github.com/openequella/openEQUELLA/pull/2498", "merged": true, "mergeCommit": {"oid": "595b44f84fef476d0649d4f20e2e657ecc00bbd9"}, "closed": true, "closedAt": "2020-11-10T00:09:21Z", "author": {"login": "edalex-ian"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdatvJ7AH2gAyNTE3NDc3ODU4OmU0Nzk2YzYwNWZjM2IzNGFjMzBjZTE5YzM1MmIwMTVjMzMxOGUzZDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABda9kwCgFqTUyNjc0Mjg1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e4796c605fc3b34ac30ce19c352b015c3318e3d3", "author": {"user": {"login": "edalex-ian", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/e4796c605fc3b34ac30ce19c352b015c3318e3d3", "committedDate": "2020-11-09T05:16:30Z", "message": "feat(server): Return attachment filePath in search results\n\nThat way it can be used to construct direct access URLs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "720c86a12ba25c5bbbf6bf66b4f745f64374cfed", "author": {"user": {"login": "edalex-ian", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/720c86a12ba25c5bbbf6bf66b4f745f64374cfed", "committedDate": "2020-11-09T05:17:27Z", "message": "feat(oeq-ts-rest-api): Support attachment filePath in search results\n\nThat way it can be used to construct direct access URLs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ba2c0212d31ac80bf0d5a47a46d4b8703b926d9", "author": {"user": {"login": "edalex-ian", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/9ba2c0212d31ac80bf0d5a47a46d4b8703b926d9", "committedDate": "2020-11-09T05:19:00Z", "message": "bugfix(new-ui): Display video attachments in lightbox\n\nUnless the viewer is set to 'download'. Unfortunately, before if the viewer was the old html5viewer it would try and send that link (and resultant content) to a <video>."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NjkzMzMw", "url": "https://github.com/openequella/openEQUELLA/pull/2498#pullrequestreview-526693330", "createdAt": "2020-11-09T22:06:32Z", "commit": {"oid": "9ba2c0212d31ac80bf0d5a47a46d4b8703b926d9"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMjowNjozM1rOHwDflA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMjowNjozM1rOHwDflA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE1MDkzMg==", "bodyText": "nit: since the string \"file\" is checked on line 87 and then used again in line 88's string literal, perhaps it could be a constant.", "url": "https://github.com/openequella/openEQUELLA/pull/2498#discussion_r520150932", "createdAt": "2020-11-09T22:06:33Z", "author": {"login": "SammyIsConfused"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/ViewerModule.ts", "diffHunk": "@@ -65,3 +66,24 @@ export const determineViewer = (\n \n   return simpleLinkView;\n };\n+\n+/**\n+ * Based on attachment type, builds either a direct link to a file attachment URL or uses the\n+ * provided `viewUrl`.\n+ *\n+ * @param itemUuid The attachment item's UUID\n+ * @param itemVersion The attachment item's version\n+ * @param attachmentType The type of the attachment - as provided by the server\n+ * @param viewUrl The default 'view' link provided by the server for the attachment\n+ * @param fileAttachmentPath If attachment type of 'file' then the `filePath` provided by the server\n+ */\n+export const determineAttachmentViewUrl = (\n+  itemUuid: string,\n+  itemVersion: number,\n+  attachmentType: string,\n+  viewUrl: string,\n+  fileAttachmentPath?: string\n+): string =>\n+  attachmentType === \"file\"\n+    ? `${AppConfig.baseUrl}file/${itemUuid}/${itemVersion}/${fileAttachmentPath}`", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ba2c0212d31ac80bf0d5a47a46d4b8703b926d9"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NzQyODUy", "url": "https://github.com/openequella/openEQUELLA/pull/2498#pullrequestreview-526742852", "createdAt": "2020-11-09T23:42:47Z", "commit": {"oid": "9ba2c0212d31ac80bf0d5a47a46d4b8703b926d9"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMzo0Mjo0N1rOHwF_qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMzo0Mjo0N1rOHwF_qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE5MTkxNA==", "bodyText": "Just be curious here . Does fileAttachment.getFilename actually return a relative path ?  I wonder this because the file path in this test is \"directory/file.txt\".", "url": "https://github.com/openequella/openEQUELLA/pull/2498#discussion_r520191914", "createdAt": "2020-11-09T23:42:47Z", "author": {"login": "PenghaiZhang"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/modules/ViewerModule.test.ts", "diffHunk": "@@ -58,3 +61,25 @@ describe(\"determineViewer()\", () => {\n       ).toEqual([\"lightbox\", fileViewUrl])\n   );\n });\n+\n+describe(\"determineAttachmentViewUrl()\", () => {\n+  const viewUrl = \"http://blah/blah\";\n+  const uuid = \"uuid\";\n+  const version = 1;\n+\n+  it(\"returns the viewUrl for non 'file' attachmentType\", () =>\n+    expect(\n+      determineAttachmentViewUrl(uuid, version, \"link\", viewUrl, undefined)\n+    ).toEqual(viewUrl));\n+\n+  it(\"returns an oEQ 'file' URL for attachmentType 'file'\", () =>\n+    expect(\n+      determineAttachmentViewUrl(\n+        uuid,\n+        version,\n+        \"file\",\n+        viewUrl,\n+        \"directory/file.txt\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ba2c0212d31ac80bf0d5a47a46d4b8703b926d9"}, "originalPosition": 34}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 331, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}