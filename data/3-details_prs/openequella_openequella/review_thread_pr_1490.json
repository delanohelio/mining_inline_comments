{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1NzM4MDUx", "number": 1490, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QwMzo1MDo0OFrODgQz6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QwNDowNDo1MFrODgQ5YQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1MTU2NDU3OnYy", "diffSide": "RIGHT", "path": "autotest/OldTests/src/test/java/com/tle/webtests/test/admin/ApidocsTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QwMzo1MDo0OFrOFqX3Tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QwMzo1MDo0OFrOFqX3Tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk3NTUwMw==", "bodyText": "To get the two failed tests pass in our CI environments, we need to make getMainErrorMessage  work for new New UI. An example is getDetail which is in the same file.", "url": "https://github.com/openequella/openEQUELLA/pull/1490#discussion_r379975503", "createdAt": "2020-02-17T03:50:48Z", "author": {"login": "PenghaiZhang"}, "path": "autotest/OldTests/src/test/java/com/tle/webtests/test/admin/ApidocsTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.tle.webtests.test.admin;\n+\n+import static org.testng.Assert.assertEquals;\n+\n+import com.tle.webtests.framework.TestInstitution;\n+import com.tle.webtests.pageobject.AccessDeniedErrorPage;\n+import com.tle.webtests.pageobject.ApidocsPage;\n+import com.tle.webtests.pageobject.LoginPage;\n+import com.tle.webtests.test.AbstractSessionTest;\n+import org.testng.annotations.Test;\n+\n+@TestInstitution(\"fiveo\")\n+public class ApidocsTest extends AbstractSessionTest {\n+\n+  @Test\n+  public void testLoginNoAccess() {\n+    new LoginPage(context).load().login(\"AutoTest\", \"automated\");\n+\n+    context.getDriver().get(context.getBaseUrl() + ApidocsPage.getUrl());\n+    AccessDeniedErrorPage error = new AccessDeniedErrorPage(context);\n+    assertAccessDenied(error);\n+  }\n+\n+  @Test\n+  public void testDefaultNoAccess() {\n+    context.getDriver().get(context.getBaseUrl() + ApidocsPage.getUrl());\n+    AccessDeniedErrorPage error = new AccessDeniedErrorPage(context);\n+    assertAccessDenied(error);\n+  }\n+\n+  @Test\n+  public void testLoginWithAccess() {\n+    new LoginPage(context).load().login(\"AutoTestWithViewApidocs\", \"automated\");\n+    loadAndAssertSuccess();\n+  }\n+\n+  @Test\n+  public void testTleAdminAccess() {\n+    new LoginPage(context).load().login(\"TLE_ADMINISTRATOR\", this.testConfig.getAdminPassword());\n+    loadAndAssertSuccess();\n+  }\n+\n+  private void assertAccessDenied(AccessDeniedErrorPage error) {\n+    assertEquals(error.getMainErrorMessage(), \"Access denied\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9af167f4c14235afee921f9986d779ef2f1162df"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1MTU2NjA5OnYy", "diffSide": "RIGHT", "path": "autotest/OldTests/src/test/java/com/tle/webtests/test/admin/ApidocsTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QwMzo1MjoxMlrOFqX4Qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwMTowNzowOVrOFrX69A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk3NTc0Ng==", "bodyText": "Instead of getDenied, we can call getDetail to retrieve the error message text.", "url": "https://github.com/openequella/openEQUELLA/pull/1490#discussion_r379975746", "createdAt": "2020-02-17T03:52:12Z", "author": {"login": "PenghaiZhang"}, "path": "autotest/OldTests/src/test/java/com/tle/webtests/test/admin/ApidocsTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.tle.webtests.test.admin;\n+\n+import static org.testng.Assert.assertEquals;\n+\n+import com.tle.webtests.framework.TestInstitution;\n+import com.tle.webtests.pageobject.AccessDeniedErrorPage;\n+import com.tle.webtests.pageobject.ApidocsPage;\n+import com.tle.webtests.pageobject.LoginPage;\n+import com.tle.webtests.test.AbstractSessionTest;\n+import org.testng.annotations.Test;\n+\n+@TestInstitution(\"fiveo\")\n+public class ApidocsTest extends AbstractSessionTest {\n+\n+  @Test\n+  public void testLoginNoAccess() {\n+    new LoginPage(context).load().login(\"AutoTest\", \"automated\");\n+\n+    context.getDriver().get(context.getBaseUrl() + ApidocsPage.getUrl());\n+    AccessDeniedErrorPage error = new AccessDeniedErrorPage(context);\n+    assertAccessDenied(error);\n+  }\n+\n+  @Test\n+  public void testDefaultNoAccess() {\n+    context.getDriver().get(context.getBaseUrl() + ApidocsPage.getUrl());\n+    AccessDeniedErrorPage error = new AccessDeniedErrorPage(context);\n+    assertAccessDenied(error);\n+  }\n+\n+  @Test\n+  public void testLoginWithAccess() {\n+    new LoginPage(context).load().login(\"AutoTestWithViewApidocs\", \"automated\");\n+    loadAndAssertSuccess();\n+  }\n+\n+  @Test\n+  public void testTleAdminAccess() {\n+    new LoginPage(context).load().login(\"TLE_ADMINISTRATOR\", this.testConfig.getAdminPassword());\n+    loadAndAssertSuccess();\n+  }\n+\n+  private void assertAccessDenied(AccessDeniedErrorPage error) {\n+    assertEquals(error.getMainErrorMessage(), \"Access denied\");\n+    assertEquals(\n+        error.getSubErrorMessage(), \"Sorry you do not have access to view the page you requested.\");\n+    assertEquals(\n+        error.getDenied(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9af167f4c14235afee921f9986d779ef2f1162df"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAyNTAxMg==", "bodyText": "Plz see answer below.  I am trying to assert the p > denied text, and getDetail gives p > description.", "url": "https://github.com/openequella/openEQUELLA/pull/1490#discussion_r381025012", "createdAt": "2020-02-19T01:07:09Z", "author": {"login": "cbeach47"}, "path": "autotest/OldTests/src/test/java/com/tle/webtests/test/admin/ApidocsTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.tle.webtests.test.admin;\n+\n+import static org.testng.Assert.assertEquals;\n+\n+import com.tle.webtests.framework.TestInstitution;\n+import com.tle.webtests.pageobject.AccessDeniedErrorPage;\n+import com.tle.webtests.pageobject.ApidocsPage;\n+import com.tle.webtests.pageobject.LoginPage;\n+import com.tle.webtests.test.AbstractSessionTest;\n+import org.testng.annotations.Test;\n+\n+@TestInstitution(\"fiveo\")\n+public class ApidocsTest extends AbstractSessionTest {\n+\n+  @Test\n+  public void testLoginNoAccess() {\n+    new LoginPage(context).load().login(\"AutoTest\", \"automated\");\n+\n+    context.getDriver().get(context.getBaseUrl() + ApidocsPage.getUrl());\n+    AccessDeniedErrorPage error = new AccessDeniedErrorPage(context);\n+    assertAccessDenied(error);\n+  }\n+\n+  @Test\n+  public void testDefaultNoAccess() {\n+    context.getDriver().get(context.getBaseUrl() + ApidocsPage.getUrl());\n+    AccessDeniedErrorPage error = new AccessDeniedErrorPage(context);\n+    assertAccessDenied(error);\n+  }\n+\n+  @Test\n+  public void testLoginWithAccess() {\n+    new LoginPage(context).load().login(\"AutoTestWithViewApidocs\", \"automated\");\n+    loadAndAssertSuccess();\n+  }\n+\n+  @Test\n+  public void testTleAdminAccess() {\n+    new LoginPage(context).load().login(\"TLE_ADMINISTRATOR\", this.testConfig.getAdminPassword());\n+    loadAndAssertSuccess();\n+  }\n+\n+  private void assertAccessDenied(AccessDeniedErrorPage error) {\n+    assertEquals(error.getMainErrorMessage(), \"Access denied\");\n+    assertEquals(\n+        error.getSubErrorMessage(), \"Sorry you do not have access to view the page you requested.\");\n+    assertEquals(\n+        error.getDenied(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk3NTc0Ng=="}, "originalCommit": {"oid": "9af167f4c14235afee921f9986d779ef2f1162df"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1MTU2OTEyOnYy", "diffSide": "RIGHT", "path": "autotest/OldTests/src/test/java/com/tle/webtests/test/admin/ApidocsTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QwMzo1NTo0MFrOFqX6PQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QwMzo1NTo0MFrOFqX6PQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk3NjI1Mw==", "bodyText": "The New UI does not have a sub error message. So when tests run against New UI, we can skip this assert by using isNewUI.", "url": "https://github.com/openequella/openEQUELLA/pull/1490#discussion_r379976253", "createdAt": "2020-02-17T03:55:40Z", "author": {"login": "PenghaiZhang"}, "path": "autotest/OldTests/src/test/java/com/tle/webtests/test/admin/ApidocsTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.tle.webtests.test.admin;\n+\n+import static org.testng.Assert.assertEquals;\n+\n+import com.tle.webtests.framework.TestInstitution;\n+import com.tle.webtests.pageobject.AccessDeniedErrorPage;\n+import com.tle.webtests.pageobject.ApidocsPage;\n+import com.tle.webtests.pageobject.LoginPage;\n+import com.tle.webtests.test.AbstractSessionTest;\n+import org.testng.annotations.Test;\n+\n+@TestInstitution(\"fiveo\")\n+public class ApidocsTest extends AbstractSessionTest {\n+\n+  @Test\n+  public void testLoginNoAccess() {\n+    new LoginPage(context).load().login(\"AutoTest\", \"automated\");\n+\n+    context.getDriver().get(context.getBaseUrl() + ApidocsPage.getUrl());\n+    AccessDeniedErrorPage error = new AccessDeniedErrorPage(context);\n+    assertAccessDenied(error);\n+  }\n+\n+  @Test\n+  public void testDefaultNoAccess() {\n+    context.getDriver().get(context.getBaseUrl() + ApidocsPage.getUrl());\n+    AccessDeniedErrorPage error = new AccessDeniedErrorPage(context);\n+    assertAccessDenied(error);\n+  }\n+\n+  @Test\n+  public void testLoginWithAccess() {\n+    new LoginPage(context).load().login(\"AutoTestWithViewApidocs\", \"automated\");\n+    loadAndAssertSuccess();\n+  }\n+\n+  @Test\n+  public void testTleAdminAccess() {\n+    new LoginPage(context).load().login(\"TLE_ADMINISTRATOR\", this.testConfig.getAdminPassword());\n+    loadAndAssertSuccess();\n+  }\n+\n+  private void assertAccessDenied(AccessDeniedErrorPage error) {\n+    assertEquals(error.getMainErrorMessage(), \"Access denied\");\n+    assertEquals(\n+        error.getSubErrorMessage(), \"Sorry you do not have access to view the page you requested.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9af167f4c14235afee921f9986d779ef2f1162df"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1MTU3MTU1OnYy", "diffSide": "RIGHT", "path": "Source/Plugins/Core/com.equella.core/src/com/tle/web/remoting/rest/docs/DocsSection.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QwMzo1ODowNVrOFqX7sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwMTowNDowMVrOFrX36w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk3NjYyNw==", "bodyText": "I am not entirely sure if here is the best place to add this annotation, but I have not found a better place so far...", "url": "https://github.com/openequella/openEQUELLA/pull/1490#discussion_r379976627", "createdAt": "2020-02-17T03:58:05Z", "author": {"login": "PenghaiZhang"}, "path": "Source/Plugins/Core/com.equella.core/src/com/tle/web/remoting/rest/docs/DocsSection.java", "diffHunk": "@@ -36,6 +37,7 @@\n \n   @ViewFactory private FreemarkerFactory viewFactory;\n \n+  @RequiresPrivilege(priv = \"VIEW_APIDOCS\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9af167f4c14235afee921f9986d779ef2f1162df"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAyNDIzNQ==", "bodyText": "There seemed to be a couple different ways to check permissions, and the annotation seemed like the cleanest way.\nFor the location, since we are only interested in locking down the display of the actual page (as opposed to the REST calls themselves), it seemed to be reasonable to place it in the DocsSection. I did notice a /api/swagger.json endpoint is available, so I'll lock that down as well.", "url": "https://github.com/openequella/openEQUELLA/pull/1490#discussion_r381024235", "createdAt": "2020-02-19T01:04:01Z", "author": {"login": "cbeach47"}, "path": "Source/Plugins/Core/com.equella.core/src/com/tle/web/remoting/rest/docs/DocsSection.java", "diffHunk": "@@ -36,6 +37,7 @@\n \n   @ViewFactory private FreemarkerFactory viewFactory;\n \n+  @RequiresPrivilege(priv = \"VIEW_APIDOCS\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk3NjYyNw=="}, "originalCommit": {"oid": "9af167f4c14235afee921f9986d779ef2f1162df"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1MTU3ODU3OnYy", "diffSide": "RIGHT", "path": "autotest/Tests/src/main/java/com/tle/webtests/pageobject/AccessDeniedErrorPage.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QwNDowNDo1MFrOFqX_xA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwMToyNTowOVrOFrYNxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk3NzY2OA==", "bodyText": "Since we already have getDetail, I feel we don't this class at the moment.", "url": "https://github.com/openequella/openEQUELLA/pull/1490#discussion_r379977668", "createdAt": "2020-02-17T04:04:50Z", "author": {"login": "PenghaiZhang"}, "path": "autotest/Tests/src/main/java/com/tle/webtests/pageobject/AccessDeniedErrorPage.java", "diffHunk": "@@ -0,0 +1,15 @@\n+package com.tle.webtests.pageobject;\n+\n+import com.tle.webtests.framework.PageContext;\n+import org.openqa.selenium.By;\n+\n+public class AccessDeniedErrorPage extends ErrorPage {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9af167f4c14235afee921f9986d779ef2f1162df"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAyNDcyNA==", "bodyText": "The issue I was running into is that getDetail returns p[@id='description'], while the message I'm trying to assert is p[@id='denied'].  However, probably better to just add another method to the ErrorPage class.  I'll update the code.", "url": "https://github.com/openequella/openEQUELLA/pull/1490#discussion_r381024724", "createdAt": "2020-02-19T01:05:59Z", "author": {"login": "cbeach47"}, "path": "autotest/Tests/src/main/java/com/tle/webtests/pageobject/AccessDeniedErrorPage.java", "diffHunk": "@@ -0,0 +1,15 @@\n+package com.tle.webtests.pageobject;\n+\n+import com.tle.webtests.framework.PageContext;\n+import org.openqa.selenium.By;\n+\n+public class AccessDeniedErrorPage extends ErrorPage {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk3NzY2OA=="}, "originalCommit": {"oid": "9af167f4c14235afee921f9986d779ef2f1162df"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAyOTgyOA==", "bodyText": "Thanks for explanation!! Yes,  then we can use getDetail in New UI and the new method in Old UI.", "url": "https://github.com/openequella/openEQUELLA/pull/1490#discussion_r381029828", "createdAt": "2020-02-19T01:25:09Z", "author": {"login": "PenghaiZhang"}, "path": "autotest/Tests/src/main/java/com/tle/webtests/pageobject/AccessDeniedErrorPage.java", "diffHunk": "@@ -0,0 +1,15 @@\n+package com.tle.webtests.pageobject;\n+\n+import com.tle.webtests.framework.PageContext;\n+import org.openqa.selenium.By;\n+\n+public class AccessDeniedErrorPage extends ErrorPage {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk3NzY2OA=="}, "originalCommit": {"oid": "9af167f4c14235afee921f9986d779ef2f1162df"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1582, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}