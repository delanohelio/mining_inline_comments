{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1NDAzMjc4", "number": 2592, "title": "Fix Bb LTI / REST caching and request all course folders", "bodyText": "History in #2587\nChecklist\n\n the contributor license agreement is signed\n commit message follows commit guidelines\n tests are included - N/A\n screenshots are included showing significant UI changes - N/A\n documentation is changed or added - N/A\n\nDescription of change\nCaching adjustments:\n\nLeverage Bb REST API refresh tokens so the user does not have to log back into Bb during the same oEQ session\nUser session caching now in place for auth token\nAuth caches now combined into a single cache of the entire Token\nCourses and Folders requests are now setup to check the cache, and if none are available, pull a fresh set of results from Bb\n\nFound a unrelated bug where only the first 200 content items from a Bb course were being returned.  Now pulls all pages of content results.", "createdAt": "2020-12-09T19:12:25Z", "url": "https://github.com/openequella/openEQUELLA/pull/2592", "merged": true, "mergeCommit": {"oid": "84d2d4722aecacdc98ea6753a0c15e811f8d455e"}, "closed": true, "closedAt": "2020-12-14T17:58:18Z", "author": {"login": "cbeach47"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkjWgRAH2gAyNTM1NDAzMjc4OjA2ZWFhYjBhMTkzZmIzYzZhZGUyZGE2ZmVhNWQ2ODAyNjNjMjYzZjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdl_RbGgFqTU1MTA2MjEwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "06eaab0a193fb3c6ade2da6fea5d680263c263f2", "author": {"user": {"login": "cbeach47", "name": "Chris Beach"}}, "url": "https://github.com/openequella/openEQUELLA/commit/06eaab0a193fb3c6ade2da6fea5d680263c263f2", "committedDate": "2020-12-09T18:49:46Z", "message": "Fix caching and request all course folders"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48f93e886eb0ad29fe11a2fe4e9c424de8474df1", "author": {"user": {"login": "cbeach47", "name": "Chris Beach"}}, "url": "https://github.com/openequella/openEQUELLA/commit/48f93e886eb0ad29fe11a2fe4e9c424de8474df1", "committedDate": "2020-12-09T20:50:22Z", "message": "bugfix: descendant folder now returned"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NjMxMDc4", "url": "https://github.com/openequella/openEQUELLA/pull/2592#pullrequestreview-548631078", "createdAt": "2020-12-09T21:37:44Z", "commit": {"oid": "48f93e886eb0ad29fe11a2fe4e9c424de8474df1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4Njk2MDE1", "url": "https://github.com/openequella/openEQUELLA/pull/2592#pullrequestreview-548696015", "createdAt": "2020-12-09T23:21:31Z", "commit": {"oid": "48f93e886eb0ad29fe11a2fe4e9c424de8474df1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMzoyMTozMlrOICuBtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwNToyMjozM1rOIC2C6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcyMjE2Nw==", "bodyText": "Arguably these should be completed. Or, otherwise removed. (But it would be nice if they were actually populated to assist with future maintenance - it's one area that bites us again and again maintaining oEQ code.)", "url": "https://github.com/openequella/openEQUELLA/pull/2592#discussion_r539722167", "createdAt": "2020-12-09T23:21:32Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/src/com/tle/core/connectors/blackboard/service/BlackboardRESTConnectorService.java", "diffHunk": "@@ -46,16 +47,16 @@ String getAuthorisationUrl(\n    * The connector object will need to store an encrypted admin token in the DB. Use this method to\n    * encrypt the one returned from Blackboard.\n    *\n-   * @param token\n+   * @param data\n    * @return", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48f93e886eb0ad29fe11a2fe4e9c424de8474df1"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcyMjkyMg==", "bodyText": "A comment on this would be gold. As it's definitely unclear what this should be doing/implemented as.\nFrom reading on more, I'd suggest a different name though: buildBasicAuthorizationCredentials. As that seems to be the aim, and it's definitely not encrypting anything (just encoding).", "url": "https://github.com/openequella/openEQUELLA/pull/2592#discussion_r539722922", "createdAt": "2020-12-09T23:22:54Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/src/com/tle/core/connectors/blackboard/service/BlackboardRESTConnectorService.java", "diffHunk": "@@ -46,16 +47,16 @@ String getAuthorisationUrl(\n    * The connector object will need to store an encrypted admin token in the DB. Use this method to\n    * encrypt the one returned from Blackboard.\n    *\n-   * @param token\n+   * @param data\n    * @return\n    */\n   String encrypt(String data);\n \n   String decrypt(String encryptedData);\n \n-  void setToken(Connector connector, String value);\n+  String encryptKeyAndSecret(Connector connector);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48f93e886eb0ad29fe11a2fe4e9c424de8474df1"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcyNTA5Mg==", "bodyText": "Maybe I've misread... But, if a token expires after 60mins, why cache for 90mins - shouldn't it also be 60?\nI assume with a refresh that'd do an update to the cache item and then it would start its TTL again.", "url": "https://github.com/openequella/openEQUELLA/pull/2592#discussion_r539725092", "createdAt": "2020-12-09T23:27:51Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/src/com/tle/core/connectors/blackboard/service/impl/BlackboardRESTConnectorServiceImpl.java", "diffHunk": "@@ -138,10 +136,15 @@\n \n   @PostConstruct\n   public void setupCache() {\n-    courseCache = cacheService.getCache(CACHE_ID_COURSE, 1000, 10, TimeUnit.MINUTES);\n-    courseFoldersCache = cacheService.getCache(CACHE_ID_COURSE_FOLDERS, 1000, 10, TimeUnit.MINUTES);\n-    tokenCache = cacheService.getCache(CACHE_ID_TOKEN, 1000, 60, TimeUnit.MINUTES);\n-    uidCache = cacheService.getCache(CACHE_ID_USERID, 1000, 60, TimeUnit.MINUTES);\n+    // These two caches can be easily rebuilt, and the original\n+    //  data on the Bb servers can frequently change\n+    courseCache = cacheService.getCache(CACHE_ID_COURSE, 100, 2, TimeUnit.MINUTES);\n+    courseFoldersCache = cacheService.getCache(CACHE_ID_COURSE_FOLDERS, 100, 2, TimeUnit.MINUTES);\n+    // Depending on usage, setting this values (size and ttl) too low will break the\n+    //  FU / MER / AES flows. Setting it higher to be safe.  Bb tokens expire after 60\n+    //  minutes, and since we use the refresh_token flows, refreshing a token is less\n+    //  noticeable to the user then requesting a new access token\n+    authCache = cacheService.getCache(CACHE_ID_AUTH, 1000, 90, TimeUnit.MINUTES);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48f93e886eb0ad29fe11a2fe4e9c424de8474df1"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcyNjU1OA==", "bodyText": "I'd normally only expect this defined in the interface, or if you wish to change it maybe have a reference back.", "url": "https://github.com/openequella/openEQUELLA/pull/2592#discussion_r539726558", "createdAt": "2020-12-09T23:30:59Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/src/com/tle/core/connectors/blackboard/service/impl/BlackboardRESTConnectorServiceImpl.java", "diffHunk": "@@ -166,10 +169,18 @@ protected boolean isRelativeUrls() {\n     return false;\n   }\n \n+  /**\n+   * Calling this method loads the auth Token into the user session.\n+   *\n+   * @param connector\n+   * @return\n+   */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48f93e886eb0ad29fe11a2fe4e9c424de8474df1"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTc3MTkyNA==", "bodyText": "Are you sure you want to do that - it's kind of expected with Base64.", "url": "https://github.com/openequella/openEQUELLA/pull/2592#discussion_r539771924", "createdAt": "2020-12-10T01:23:20Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/src/com/tle/core/connectors/blackboard/service/impl/BlackboardRESTConnectorServiceImpl.java", "diffHunk": "@@ -687,25 +727,38 @@ public String decrypt(String encryptedData) {\n     return encryptedData;\n   }\n \n-  public Optional<String> getToken(Connector connector) {\n-    return getCachedValue(tokenCache, buildCacheKey(CACHE_ID_TOKEN, connector));\n+  @Override\n+  public String encryptKeyAndSecret(Connector connector) {\n+    final String apiKey = connector.getAttribute(BlackboardRESTConnectorConstants.FIELD_API_KEY);\n+    final String apiSecret =\n+        encryptionService.decrypt(\n+            connector.getAttribute(BlackboardRESTConnectorConstants.FIELD_API_SECRET));\n+    return new Base64()\n+        .encode((apiKey + \":\" + apiSecret).getBytes())\n+        .replace(\"\\n\", \"\")\n+        .replace(\"\\r\", \"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48f93e886eb0ad29fe11a2fe4e9c424de8474df1"}, "originalPosition": 323}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTc3NjAzNw==", "bodyText": "This function (sendBlackboardData) is really getting out of hand and needs to be refactored I'm afraid. We have it implementing two concerns at least - making a request and processing the response - and even in the request areas we have some headers added at the start, some then added later after the body, and then a MIME type set here or there. But then with this modification the request building also includes the verbatim details of whether to attempt a refresh, or use an existing token.\nAt the very least it should be refactored into: makeBlackboardRequest and processBlackboardResponse. Following that, each of those should then be tidied up to be more orderly.", "url": "https://github.com/openequella/openEQUELLA/pull/2592#discussion_r539776037", "createdAt": "2020-12-10T01:34:13Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/src/com/tle/core/connectors/blackboard/service/impl/BlackboardRESTConnectorServiceImpl.java", "diffHunk": "@@ -548,47 +531,54 @@ public boolean supportsReverseSort() {\n       } else {\n         body = \"\";\n       }\n-      request.setBody(body);\n-      if (body.length() > 0) {\n-        request.addHeader(\"Content-Type\", \"application/json\");\n+\n+      if (\"grant_type=refresh_token\".equals(data)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48f93e886eb0ad29fe11a2fe4e9c424de8474df1"}, "originalPosition": 183}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTc3NjI4NQ==", "bodyText": "This string and logic check is duplicated from a few lines up. Should at the very least be stored in a flag, and possibly the logic joined together - or split into another method.", "url": "https://github.com/openequella/openEQUELLA/pull/2592#discussion_r539776285", "createdAt": "2020-12-10T01:34:50Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/src/com/tle/core/connectors/blackboard/service/impl/BlackboardRESTConnectorServiceImpl.java", "diffHunk": "@@ -548,47 +531,54 @@ public boolean supportsReverseSort() {\n       } else {\n         body = \"\";\n       }\n-      request.setBody(body);\n-      if (body.length() > 0) {\n-        request.addHeader(\"Content-Type\", \"application/json\");\n+\n+      if (\"grant_type=refresh_token\".equals(data)) {\n+        request.setMimeType(\"application/x-www-form-urlencoded\");\n+      } else {\n+        if (body.length() > 0) {\n+          request.addHeader(\"Content-Type\", \"application/json\");\n+        }\n       }\n+      request.setBody(body);\n+\n       if (LOGGER.isDebugEnabled()) {\n         LOGGER.debug(\"Sending \" + prettyJson(body));\n       }\n \n-      // attach cached token.\n-      final Optional<String> token = getToken(connector);\n-      if (!token.isPresent()) {\n-        throw new AuthenticationException(\"User token is not present\");\n+      if (\"grant_type=refresh_token\".equals(data)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48f93e886eb0ad29fe11a2fe4e9c424de8474df1"}, "originalPosition": 200}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg0OTQ4Nw==", "bodyText": "Should this just be a do-while? Something like:\n    Optional<String> url = Optional\n        .of(API_ROOT_V1 + \"courses/\" + courseId + \"/contents?recursive=true\");\n    final List<Content> allContent = new ArrayList<>();\n    do {\n      Contents contents =\n          sendBlackboardData(connector, url.get(), Contents.class, null, Request.Method.GET);\n      allContent.addAll(contents.getResults());\n      url = Optional.ofNullable(contents.getPaging()).map(Paging::getNextPage);\n    } while (url.isPresent());", "url": "https://github.com/openequella/openEQUELLA/pull/2592#discussion_r539849487", "createdAt": "2020-12-10T05:09:42Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/src/com/tle/core/connectors/blackboard/service/impl/BlackboardRESTConnectorServiceImpl.java", "diffHunk": "@@ -346,13 +315,27 @@ private boolean isCoursesCached(Connector connector) {\n       return cachedFolders.get();\n     }\n \n+    // No cached folders available.  Pull latest from Blackboard.\n     final String url = API_ROOT_V1 + \"courses/\" + courseId + \"/contents?recursive=true\";\n-    final Contents contents =\n+    final List<Content> allContent = new ArrayList<>();\n+    Contents contents =\n         sendBlackboardData(connector, url, Contents.class, null, Request.Method.GET);\n+    allContent.addAll(contents.getResults());\n+\n+    Paging paging = contents.getPaging();\n+\n+    while (paging != null && paging.getNextPage() != null) {\n+      contents =\n+          sendBlackboardData(\n+              connector, paging.getNextPage(), Contents.class, null, Request.Method.GET);\n+      allContent.addAll(contents.getResults());\n+\n+      paging = contents.getPaging();\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48f93e886eb0ad29fe11a2fe4e9c424de8474df1"}, "originalPosition": 164}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg1MTIyMA==", "bodyText": "Should be an orElseThrow:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                Optional<Token> auth =\n          \n          \n            \n                    userSessionService.getAttribute(BlackboardRESTConnectorConstants.USER_SESSION_AUTH_KEY);\n          \n          \n            \n                if (!auth.isPresent()) {\n          \n          \n            \n                  throw new AuthenticationException(\n          \n          \n            \n                      \"User authentication details are not available in the session\");\n          \n          \n            \n                }\n          \n          \n            \n                return auth.get();\n          \n          \n            \n                return userSessionService.getAttribute(BlackboardRESTConnectorConstants.USER_SESSION_AUTH_KEY)\n          \n          \n            \n                  .orElseThrow(\n          \n          \n            \n                    () -> new AuthenticationException(\"User authentication details are not available in the session\"));", "url": "https://github.com/openequella/openEQUELLA/pull/2592#discussion_r539851220", "createdAt": "2020-12-10T05:15:05Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/src/com/tle/core/connectors/blackboard/service/impl/BlackboardRESTConnectorServiceImpl.java", "diffHunk": "@@ -606,6 +596,56 @@ public boolean supportsReverseSort() {\n     }\n   }\n \n+  private Token getUserSessionAuth() {\n+    Optional<Token> auth =\n+        userSessionService.getAttribute(BlackboardRESTConnectorConstants.USER_SESSION_AUTH_KEY);\n+    if (!auth.isPresent()) {\n+      throw new AuthenticationException(\n+          \"User authentication details are not available in the session\");\n+    }\n+    return auth.get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48f93e886eb0ad29fe11a2fe4e9c424de8474df1"}, "originalPosition": 262}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg1MjI3MQ==", "bodyText": "Is this:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                Token expAuth = getUserSessionAuth();\n          \n          \n            \n            \n          \n          \n            \n                // Make a reasonable effort to obtain the latest refresh token\n          \n          \n            \n                Optional<Token> cachedAuth = getAuth(connector);\n          \n          \n            \n                if (cachedAuth.isPresent()) {\n          \n          \n            \n                  expAuth = cachedAuth.get();\n          \n          \n            \n                }\n          \n          \n            \n                Token expAuth = getAuth(connector)\n          \n          \n            \n                  .orElse(() -> getUserSessionAuth());", "url": "https://github.com/openequella/openEQUELLA/pull/2592#discussion_r539852271", "createdAt": "2020-12-10T05:18:33Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/src/com/tle/core/connectors/blackboard/service/impl/BlackboardRESTConnectorServiceImpl.java", "diffHunk": "@@ -606,6 +596,56 @@ public boolean supportsReverseSort() {\n     }\n   }\n \n+  private Token getUserSessionAuth() {\n+    Optional<Token> auth =\n+        userSessionService.getAttribute(BlackboardRESTConnectorConstants.USER_SESSION_AUTH_KEY);\n+    if (!auth.isPresent()) {\n+      throw new AuthenticationException(\n+          \"User authentication details are not available in the session\");\n+    }\n+    return auth.get();\n+  }\n+\n+  private void setUserSessionAuth(Optional<Token> t) {\n+    userSessionService.setAttribute(BlackboardRESTConnectorConstants.USER_SESSION_AUTH_KEY, t);\n+  }\n+\n+  private void setUserSessionAuth(Token t) {\n+    setUserSessionAuth(Optional.fromNullable(t));\n+  }\n+\n+  private void refreshBlackboardToken(Connector connector) {\n+    Token expAuth = getUserSessionAuth();\n+\n+    // Make a reasonable effort to obtain the latest refresh token\n+    Optional<Token> cachedAuth = getAuth(connector);\n+    if (cachedAuth.isPresent()) {\n+      expAuth = cachedAuth.get();\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48f93e886eb0ad29fe11a2fe4e9c424de8474df1"}, "originalPosition": 280}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg1MjUwNA==", "bodyText": "Is this missing a throw?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  new AuthenticationException(\"Unable to refresh auth token.  Please retry action.\");\n          \n          \n            \n                  throw new AuthenticationException(\"Unable to refresh auth token.  Please retry action.\");", "url": "https://github.com/openequella/openEQUELLA/pull/2592#discussion_r539852504", "createdAt": "2020-12-10T05:19:17Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/src/com/tle/core/connectors/blackboard/service/impl/BlackboardRESTConnectorServiceImpl.java", "diffHunk": "@@ -606,6 +596,56 @@ public boolean supportsReverseSort() {\n     }\n   }\n \n+  private Token getUserSessionAuth() {\n+    Optional<Token> auth =\n+        userSessionService.getAttribute(BlackboardRESTConnectorConstants.USER_SESSION_AUTH_KEY);\n+    if (!auth.isPresent()) {\n+      throw new AuthenticationException(\n+          \"User authentication details are not available in the session\");\n+    }\n+    return auth.get();\n+  }\n+\n+  private void setUserSessionAuth(Optional<Token> t) {\n+    userSessionService.setAttribute(BlackboardRESTConnectorConstants.USER_SESSION_AUTH_KEY, t);\n+  }\n+\n+  private void setUserSessionAuth(Token t) {\n+    setUserSessionAuth(Optional.fromNullable(t));\n+  }\n+\n+  private void refreshBlackboardToken(Connector connector) {\n+    Token expAuth = getUserSessionAuth();\n+\n+    // Make a reasonable effort to obtain the latest refresh token\n+    Optional<Token> cachedAuth = getAuth(connector);\n+    if (cachedAuth.isPresent()) {\n+      expAuth = cachedAuth.get();\n+    }\n+\n+    final String path =\n+        \"learn/api/public/v1/oauth2/token?grant_type=refresh_token&refresh_token=\"\n+            + expAuth.getRefreshToken();\n+\n+    try {\n+      // Setting 'firstTime' to false - if the token refresh fails, it's likely not recoverable.\n+      setAuth(\n+          connector,\n+          sendBlackboardData(\n+              connector,\n+              path,\n+              Token.class,\n+              \"grant_type=refresh_token\",\n+              Request.Method.POST,\n+              false));\n+    } catch (Exception exception) {\n+      LOGGER.error(exception.getMessage());\n+      // Likely an expired auth token that failed to refresh.  Guide the user to try again\n+      removeCachedValue(authCache, buildCacheKey(CACHE_ID_AUTH, connector));\n+      new AuthenticationException(\"Unable to refresh auth token.  Please retry action.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48f93e886eb0ad29fe11a2fe4e9c424de8474df1"}, "originalPosition": 301}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg1MzU0Ng==", "bodyText": "This looks like it should be a do-while like earlier up.\nOne thing also interesting here is the duplicated pattern: sendBlackboardData -> process output to create a List -> check for another page -> repeat. Feels like that should be a method which takes a lambda to support abstracting the commonality of processing/consuming List output.", "url": "https://github.com/openequella/openEQUELLA/pull/2592#discussion_r539853546", "createdAt": "2020-12-10T05:22:33Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/src/com/tle/core/connectors/blackboard/service/impl/BlackboardRESTConnectorServiceImpl.java", "diffHunk": "@@ -730,34 +786,67 @@ private void setCachedCourses(Connector connector, ImmutableList<Course> courses\n     setCachedValue(courseCache, key, courses);\n   }\n \n-  private Optional<ImmutableList<Course>> getCachedCourses(Connector connector) {\n+  /**\n+   * First tries to return the cached courses. If none are available, request them from Blackboard,\n+   * cache them, and return the now cached courses.\n+   *\n+   * @param connector\n+   * @return\n+   */\n+  private ImmutableList<Course> getCachedCourses(Connector connector) {\n     final String key = buildCacheKey(CACHE_ID_COURSE, connector);\n-    return getCachedValue(courseCache, key);\n+    final Optional<ImmutableList<Course>> cached = getCachedValue(courseCache, key);\n+    if (cached.isPresent()) {\n+      return cached.get();\n+    }\n+\n+    // Not cached - get a fresh copy\n+    String url =\n+        API_ROOT_V1\n+            + \"users/\"\n+            + getUserIdType()\n+            + getUserSessionAuth().getUserId()\n+            + \"/courses?fields=course\";\n+\n+    final List<Course> allCourses = new ArrayList<>();\n+    CoursesByUser courses =\n+        sendBlackboardData(connector, url, CoursesByUser.class, null, Request.Method.GET);\n+    for (CourseByUser cbu : courses.getResults()) {\n+      allCourses.add(cbu.getCourse());\n+    }\n+    Paging paging = courses.getPaging();\n+\n+    while (paging != null && paging.getNextPage() != null) {\n+      courses =\n+          sendBlackboardData(\n+              connector, paging.getNextPage(), CoursesByUser.class, null, Request.Method.GET);\n+      for (CourseByUser cbu : courses.getResults()) {\n+        allCourses.add(cbu.getCourse());\n+      }\n+      paging = courses.getPaging();\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48f93e886eb0ad29fe11a2fe4e9c424de8474df1"}, "originalPosition": 423}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2173df2407fc51ea96dd96b433b91be8494628e4", "author": {"user": {"login": "cbeach47", "name": "Chris Beach"}}, "url": "https://github.com/openequella/openEQUELLA/commit/2173df2407fc51ea96dd96b433b91be8494628e4", "committedDate": "2020-12-10T17:26:49Z", "message": "cleanup Optional throw code\n\nCo-authored-by: edalex-ian <43919233+edalex-ian@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0ddf0c1fe341ac681bfdda16bab48e662daf3c5", "author": {"user": {"login": "cbeach47", "name": "Chris Beach"}}, "url": "https://github.com/openequella/openEQUELLA/commit/c0ddf0c1fe341ac681bfdda16bab48e662daf3c5", "committedDate": "2020-12-10T17:35:15Z", "message": "Simplify getting the latest refresh token\n\nCo-authored-by: edalex-ian <43919233+edalex-ian@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79e16973f6326a38c4028c4cbf18b3a89940d1e0", "author": {"user": {"login": "cbeach47", "name": "Chris Beach"}}, "url": "https://github.com/openequella/openEQUELLA/commit/79e16973f6326a38c4028c4cbf18b3a89940d1e0", "committedDate": "2020-12-10T18:25:44Z", "message": "Favored java Optional, and related clean up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3dade0941e9af2e911573cad460cc6bd2d88f206", "author": {"user": {"login": "cbeach47", "name": "Chris Beach"}}, "url": "https://github.com/openequella/openEQUELLA/commit/3dade0941e9af2e911573cad460cc6bd2d88f206", "committedDate": "2020-12-10T18:30:28Z", "message": "Actually throw the exception\n\nCo-authored-by: edalex-ian <43919233+edalex-ian@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1084499b870d318ce2958f7e6ffd8d5ea48424a6", "author": {"user": {"login": "cbeach47", "name": "Chris Beach"}}, "url": "https://github.com/openequella/openEQUELLA/commit/1084499b870d318ce2958f7e6ffd8d5ea48424a6", "committedDate": "2020-12-10T22:55:37Z", "message": "Refactor request logic, javadoc, and pagination"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxMDYyMTA2", "url": "https://github.com/openequella/openEQUELLA/pull/2592#pullrequestreview-551062106", "createdAt": "2020-12-14T05:55:29Z", "commit": {"oid": "1084499b870d318ce2958f7e6ffd8d5ea48424a6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 299, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}