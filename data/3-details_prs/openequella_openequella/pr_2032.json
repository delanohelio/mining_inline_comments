{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2NzE0MTkw", "number": 2032, "title": "Jest tests for search page pagination and sorting", "bodyText": "#1306\nChecklist\n\n the [contributor license agreement][] is signed\n commit message follows [commit guidelines][]\n tests are included\n screenshots are included showing significant UI changes\n documentation is changed or added\n\nDescription of change\nUpdate search page Jest test, including:\n\nadding new tests for Search page pagination and the sorting control; and\nrefactoring the tests for spinner and debounce query; and\nupdating mock data.", "createdAt": "2020-07-09T08:47:45Z", "url": "https://github.com/openequella/openEQUELLA/pull/2032", "merged": true, "mergeCommit": {"oid": "0ff771ab86ecc280c43d45e8dabefa1544dd22ea"}, "closed": true, "closedAt": "2020-07-13T06:07:31Z", "author": {"login": "PenghaiZhang"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczLAW7AH2gAyNDQ2NzE0MTkwOmI3NGI3ZTYxNzQ0ZTUzZWNkYTliMDEyZWQzZWQzMjNmYjg1NDQ0NzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc0Z_E4AFqTQ0Njk3ODE1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b74b7e61744e53ecda9b012ed3ed323fb8544473", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/b74b7e61744e53ecda9b012ed3ed323fb8544473", "committedDate": "2020-07-09T08:45:34Z", "message": "Jest test for search page pagination and sorting\n\n1. Add tests for pagination and sorting.\n2. Update the test for spinner and debounce query.\n3. Not all tests need fake timer so move fake timer to the test\n   which needs it."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NDE4MDIw", "url": "https://github.com/openequella/openEQUELLA/pull/2032#pullrequestreview-445418020", "createdAt": "2020-07-09T08:54:15Z", "commit": {"oid": "b74b7e61744e53ecda9b012ed3ed323fb8544473"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwODo1NDoxNVrOGvH8gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwODo1NDoxNVrOGvH8gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA2NjQzNQ==", "bodyText": "Help wanted here.\nWarning An update to SearchPage inside a test was not wrapped in act(...). is always given.\nI can see it is caused by debouncing search query which triggers a state update after 500ms.  I have not worked out how to put this update inside a act.", "url": "https://github.com/openequella/openEQUELLA/pull/2032#discussion_r452066435", "createdAt": "2020-07-09T08:54:15Z", "author": {"login": "PenghaiZhang"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -62,50 +66,97 @@ describe(\"<SearchPage/>\", () => {\n   });\n \n   afterEach(() => {\n-    mount.cleanUp();\n+    jest.clearAllMocks();\n   });\n \n-  const changeQuery = (query: string) => {\n-    act(() => {\n-      const input = component.find(\"input.MuiInputBase-input\");\n-      input.simulate(\"change\", { target: { value: query } });\n+  /**\n+   * Update search options in order to trigger a search.\n+   * @param update A function that simulates UI behaviours such as selecting a different value from a dropdown.\n+   */\n+  const updateSearchOptions = async (update: () => void) => {\n+    await act(async () => {\n+      await update();\n     });\n   };\n \n-  it(\"should retrieve search settings and do a search when the page is opened\", async () => {\n+  it(\"should retrieve search settings and do a search when the page is opened\", () => {\n     expect(\n       SearchSettingsModule.getSearchSettingsFromServer\n     ).toHaveBeenCalledTimes(1);\n     expect(SearchModule.searchItems).toHaveBeenCalledTimes(1);\n+    expect(SearchModule.searchItems).toHaveBeenCalledWith(defaultSearchOptions);\n   });\n \n-  it(\"should display 'No results found.' when there are no search results\", () => {\n-    changeQuery(\"old title\");\n-    //use a timed callback to wait for the debounce before asserting results have populated the page\n-    setTimeout(() => {\n-      expect(component.html()).toContain(\"No results found.\");\n-    }, 1000);\n+  it(\"should support debounce query search\", async () => {\n+    jest.useFakeTimers(\"modern\");\n+    const input = component.find(\"input.MuiInputBase-input\");\n+    await updateSearchOptions(() =>\n+      input.simulate(\"change\", { target: { value: \"new query\" } })", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b74b7e61744e53ecda9b012ed3ed323fb8544473"}, "originalPosition": 84}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c94ac81834e8cca4ad2f5fd976908646a5fdbb0b", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/c94ac81834e8cca4ad2f5fd976908646a5fdbb0b", "committedDate": "2020-07-09T08:59:42Z", "message": "Update SearchModule test due to updated mock data."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NzU0MDE1", "url": "https://github.com/openequella/openEQUELLA/pull/2032#pullrequestreview-445754015", "createdAt": "2020-07-09T15:56:30Z", "commit": {"oid": "c94ac81834e8cca4ad2f5fd976908646a5fdbb0b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNTo1NjozMFrOGvXlGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxODozOTo1NFrOGvdTcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjMyMjU4Ng==", "bodyText": "is this wrapper around act needed?\nIt seems to be a direct pass through", "url": "https://github.com/openequella/openEQUELLA/pull/2032#discussion_r452322586", "createdAt": "2020-07-09T15:56:30Z", "author": {"login": "ChristianMurphy"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -62,50 +66,97 @@ describe(\"<SearchPage/>\", () => {\n   });\n \n   afterEach(() => {\n-    mount.cleanUp();\n+    jest.clearAllMocks();\n   });\n \n-  const changeQuery = (query: string) => {\n-    act(() => {\n-      const input = component.find(\"input.MuiInputBase-input\");\n-      input.simulate(\"change\", { target: { value: query } });\n+  /**\n+   * Update search options in order to trigger a search.\n+   * @param update A function that simulates UI behaviours such as selecting a different value from a dropdown.\n+   */\n+  const updateSearchOptions = async (update: () => void) => {\n+    await act(async () => {\n+      await update();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c94ac81834e8cca4ad2f5fd976908646a5fdbb0b"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQxNjM2OQ==", "bodyText": "Would moving jest.advanceTimersByTime inside the act resolve the issue? \ud83e\udd14", "url": "https://github.com/openequella/openEQUELLA/pull/2032#discussion_r452416369", "createdAt": "2020-07-09T18:39:54Z", "author": {"login": "ChristianMurphy"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -62,50 +66,97 @@ describe(\"<SearchPage/>\", () => {\n   });\n \n   afterEach(() => {\n-    mount.cleanUp();\n+    jest.clearAllMocks();\n   });\n \n-  const changeQuery = (query: string) => {\n-    act(() => {\n-      const input = component.find(\"input.MuiInputBase-input\");\n-      input.simulate(\"change\", { target: { value: query } });\n+  /**\n+   * Update search options in order to trigger a search.\n+   * @param update A function that simulates UI behaviours such as selecting a different value from a dropdown.\n+   */\n+  const updateSearchOptions = async (update: () => void) => {\n+    await act(async () => {\n+      await update();\n     });\n   };\n \n-  it(\"should retrieve search settings and do a search when the page is opened\", async () => {\n+  it(\"should retrieve search settings and do a search when the page is opened\", () => {\n     expect(\n       SearchSettingsModule.getSearchSettingsFromServer\n     ).toHaveBeenCalledTimes(1);\n     expect(SearchModule.searchItems).toHaveBeenCalledTimes(1);\n+    expect(SearchModule.searchItems).toHaveBeenCalledWith(defaultSearchOptions);\n   });\n \n-  it(\"should display 'No results found.' when there are no search results\", () => {\n-    changeQuery(\"old title\");\n-    //use a timed callback to wait for the debounce before asserting results have populated the page\n-    setTimeout(() => {\n-      expect(component.html()).toContain(\"No results found.\");\n-    }, 1000);\n+  it(\"should support debounce query search\", async () => {\n+    jest.useFakeTimers(\"modern\");\n+    const input = component.find(\"input.MuiInputBase-input\");\n+    await updateSearchOptions(() =>\n+      input.simulate(\"change\", { target: { value: \"new query\" } })", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA2NjQzNQ=="}, "originalCommit": {"oid": "b74b7e61744e53ecda9b012ed3ed323fb8544473"}, "originalPosition": 84}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e2eabb8e8ac0faa512fba342015e6ce376d26ae", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/9e2eabb8e8ac0faa512fba342015e6ce376d26ae", "committedDate": "2020-07-09T23:22:48Z", "message": "Call 'advanceTimersByTime' inside 'act' to remove state update warning."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MTAyMDgw", "url": "https://github.com/openequella/openEQUELLA/pull/2032#pullrequestreview-446102080", "createdAt": "2020-07-10T03:38:56Z", "commit": {"oid": "9e2eabb8e8ac0faa512fba342015e6ce376d26ae"}, "state": "APPROVED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwMzozODo1NlrOGvo1cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwMzo0OTo1OFrOGvo_DA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYwNTI5OQ==", "bodyText": "do these await simulate blocks need to be surrounded with an act function? Whenever I did things like that I'd get warnings in the jest console.", "url": "https://github.com/openequella/openEQUELLA/pull/2032#discussion_r452605299", "createdAt": "2020-07-10T03:38:56Z", "author": {"login": "SammyIsConfused"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -62,50 +66,94 @@ describe(\"<SearchPage/>\", () => {\n   });\n \n   afterEach(() => {\n-    mount.cleanUp();\n+    jest.clearAllMocks();\n   });\n \n-  const changeQuery = (query: string) => {\n-    act(() => {\n-      const input = component.find(\"input.MuiInputBase-input\");\n-      input.simulate(\"change\", { target: { value: query } });\n-    });\n-  };\n+  /**\n+   * Update search options in order to trigger a search.\n+   * @param update A function that simulates UI behaviours such as selecting a different value from a dropdown.\n+   */\n+  const updateSearchOptions = async (update: () => void) =>\n+    await act(async () => await update());\n \n-  it(\"should retrieve search settings and do a search when the page is opened\", async () => {\n+  it(\"should retrieve search settings and do a search when the page is opened\", () => {\n     expect(\n       SearchSettingsModule.getSearchSettingsFromServer\n     ).toHaveBeenCalledTimes(1);\n     expect(SearchModule.searchItems).toHaveBeenCalledTimes(1);\n+    expect(SearchModule.searchItems).toHaveBeenCalledWith(defaultSearchOptions);\n   });\n \n-  it(\"should display 'No results found.' when there are no search results\", () => {\n-    changeQuery(\"old title\");\n-    //use a timed callback to wait for the debounce before asserting results have populated the page\n-    setTimeout(() => {\n-      expect(component.html()).toContain(\"No results found.\");\n-    }, 1000);\n+  it(\"should support debounce query search\", async () => {\n+    jest.useFakeTimers(\"modern\");\n+    const input = component.find(\"input.MuiInputBase-input\");\n+    await updateSearchOptions(() => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e2eabb8e8ac0faa512fba342015e6ce376d26ae"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYwNzQzNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Because sorting is done on Server and we are using mock data, we can only check if the selected\n          \n          \n            \n                // Because sorting is done on the server-side and we are using mock data, we can only check if the selected", "url": "https://github.com/openequella/openEQUELLA/pull/2032#discussion_r452607436", "createdAt": "2020-07-10T03:48:27Z", "author": {"login": "SammyIsConfused"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -62,50 +66,94 @@ describe(\"<SearchPage/>\", () => {\n   });\n \n   afterEach(() => {\n-    mount.cleanUp();\n+    jest.clearAllMocks();\n   });\n \n-  const changeQuery = (query: string) => {\n-    act(() => {\n-      const input = component.find(\"input.MuiInputBase-input\");\n-      input.simulate(\"change\", { target: { value: query } });\n-    });\n-  };\n+  /**\n+   * Update search options in order to trigger a search.\n+   * @param update A function that simulates UI behaviours such as selecting a different value from a dropdown.\n+   */\n+  const updateSearchOptions = async (update: () => void) =>\n+    await act(async () => await update());\n \n-  it(\"should retrieve search settings and do a search when the page is opened\", async () => {\n+  it(\"should retrieve search settings and do a search when the page is opened\", () => {\n     expect(\n       SearchSettingsModule.getSearchSettingsFromServer\n     ).toHaveBeenCalledTimes(1);\n     expect(SearchModule.searchItems).toHaveBeenCalledTimes(1);\n+    expect(SearchModule.searchItems).toHaveBeenCalledWith(defaultSearchOptions);\n   });\n \n-  it(\"should display 'No results found.' when there are no search results\", () => {\n-    changeQuery(\"old title\");\n-    //use a timed callback to wait for the debounce before asserting results have populated the page\n-    setTimeout(() => {\n-      expect(component.html()).toContain(\"No results found.\");\n-    }, 1000);\n+  it(\"should support debounce query search\", async () => {\n+    jest.useFakeTimers(\"modern\");\n+    const input = component.find(\"input.MuiInputBase-input\");\n+    await updateSearchOptions(() => {\n+      input.simulate(\"change\", { target: { value: \"new query\" } });\n+      jest.advanceTimersByTime(1000);\n+    });\n+    // After 1s the second search should be triggered.\n+    expect(SearchModule.searchItems).toHaveBeenCalledTimes(2);\n+    expect(SearchModule.searchItems).toHaveBeenCalledWith({\n+      ...defaultSearchOptions,\n+      query: \"new query\",\n+    });\n   });\n \n-  it(\"should contain the test data after a search bar text change and render\", () => {\n-    changeQuery(\"new title\");\n-    setTimeout(() => {\n-      expect(component.html()).not.toContain(\"No results found.\");\n-      expect(component.html()).toContain(\n-        \"266bb0ff-a730-4658-aec0-c68bbefc227c\"\n-      );\n-    }, 1000);\n+  it(\"should support changing the number of items displayed per page\", async () => {\n+    // Initial items per page is 10.\n+    expect(component.html()).toContain(\"1-10 of 12\");\n+    const itemsPerPageSelect = component.find(\n+      \".MuiTablePagination-input input\"\n+    );\n+    await updateSearchOptions(() =>\n+      itemsPerPageSelect.simulate(\"change\", { target: { value: 25 } })\n+    );\n+    expect(SearchModule.searchItems).toHaveBeenCalledWith({\n+      ...defaultSearchOptions,\n+      rowsPerPage: 25,\n+    });\n+    expect(component.html()).toContain(\"1-12 of 12\");\n+  });\n+\n+  it(\"should support navigating to previous/next page\", async () => {\n+    const prevPageButton = component\n+      .find(\".MuiTablePagination-actions button\")\n+      .at(0);\n+    const nextPageButton = component\n+      .find(\".MuiTablePagination-actions button\")\n+      .at(1);\n+    await updateSearchOptions(() => nextPageButton.simulate(\"click\"));\n+    expect(component.html()).toContain(\"11-12 of 12\");\n+    await updateSearchOptions(() => prevPageButton.simulate(\"click\"));\n+    expect(component.html()).toContain(\"1-10 of 12\");\n+  });\n+\n+  it(\"should support sorting search results\", async () => {\n+    const sortingControl = component.find(\".MuiCardHeader-action input\");\n+    await updateSearchOptions(() =>\n+      sortingControl.simulate(\"change\", {\n+        target: { value: SortOrder.DATEMODIFIED },\n+      })\n+    );\n+    // Because sorting is done on Server and we are using mock data, we can only check if the selected", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e2eabb8e8ac0faa512fba342015e6ce376d26ae"}, "originalPosition": 138}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYwNzU2MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Trigger a search by changing sorting order.\n          \n          \n            \n                // Trigger a search by changing sorting order", "url": "https://github.com/openequella/openEQUELLA/pull/2032#discussion_r452607561", "createdAt": "2020-07-10T03:49:05Z", "author": {"login": "SammyIsConfused"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -62,50 +66,94 @@ describe(\"<SearchPage/>\", () => {\n   });\n \n   afterEach(() => {\n-    mount.cleanUp();\n+    jest.clearAllMocks();\n   });\n \n-  const changeQuery = (query: string) => {\n-    act(() => {\n-      const input = component.find(\"input.MuiInputBase-input\");\n-      input.simulate(\"change\", { target: { value: query } });\n-    });\n-  };\n+  /**\n+   * Update search options in order to trigger a search.\n+   * @param update A function that simulates UI behaviours such as selecting a different value from a dropdown.\n+   */\n+  const updateSearchOptions = async (update: () => void) =>\n+    await act(async () => await update());\n \n-  it(\"should retrieve search settings and do a search when the page is opened\", async () => {\n+  it(\"should retrieve search settings and do a search when the page is opened\", () => {\n     expect(\n       SearchSettingsModule.getSearchSettingsFromServer\n     ).toHaveBeenCalledTimes(1);\n     expect(SearchModule.searchItems).toHaveBeenCalledTimes(1);\n+    expect(SearchModule.searchItems).toHaveBeenCalledWith(defaultSearchOptions);\n   });\n \n-  it(\"should display 'No results found.' when there are no search results\", () => {\n-    changeQuery(\"old title\");\n-    //use a timed callback to wait for the debounce before asserting results have populated the page\n-    setTimeout(() => {\n-      expect(component.html()).toContain(\"No results found.\");\n-    }, 1000);\n+  it(\"should support debounce query search\", async () => {\n+    jest.useFakeTimers(\"modern\");\n+    const input = component.find(\"input.MuiInputBase-input\");\n+    await updateSearchOptions(() => {\n+      input.simulate(\"change\", { target: { value: \"new query\" } });\n+      jest.advanceTimersByTime(1000);\n+    });\n+    // After 1s the second search should be triggered.\n+    expect(SearchModule.searchItems).toHaveBeenCalledTimes(2);\n+    expect(SearchModule.searchItems).toHaveBeenCalledWith({\n+      ...defaultSearchOptions,\n+      query: \"new query\",\n+    });\n   });\n \n-  it(\"should contain the test data after a search bar text change and render\", () => {\n-    changeQuery(\"new title\");\n-    setTimeout(() => {\n-      expect(component.html()).not.toContain(\"No results found.\");\n-      expect(component.html()).toContain(\n-        \"266bb0ff-a730-4658-aec0-c68bbefc227c\"\n-      );\n-    }, 1000);\n+  it(\"should support changing the number of items displayed per page\", async () => {\n+    // Initial items per page is 10.\n+    expect(component.html()).toContain(\"1-10 of 12\");\n+    const itemsPerPageSelect = component.find(\n+      \".MuiTablePagination-input input\"\n+    );\n+    await updateSearchOptions(() =>\n+      itemsPerPageSelect.simulate(\"change\", { target: { value: 25 } })\n+    );\n+    expect(SearchModule.searchItems).toHaveBeenCalledWith({\n+      ...defaultSearchOptions,\n+      rowsPerPage: 25,\n+    });\n+    expect(component.html()).toContain(\"1-12 of 12\");\n+  });\n+\n+  it(\"should support navigating to previous/next page\", async () => {\n+    const prevPageButton = component\n+      .find(\".MuiTablePagination-actions button\")\n+      .at(0);\n+    const nextPageButton = component\n+      .find(\".MuiTablePagination-actions button\")\n+      .at(1);\n+    await updateSearchOptions(() => nextPageButton.simulate(\"click\"));\n+    expect(component.html()).toContain(\"11-12 of 12\");\n+    await updateSearchOptions(() => prevPageButton.simulate(\"click\"));\n+    expect(component.html()).toContain(\"1-10 of 12\");\n+  });\n+\n+  it(\"should support sorting search results\", async () => {\n+    const sortingControl = component.find(\".MuiCardHeader-action input\");\n+    await updateSearchOptions(() =>\n+      sortingControl.simulate(\"change\", {\n+        target: { value: SortOrder.DATEMODIFIED },\n+      })\n+    );\n+    // Because sorting is done on Server and we are using mock data, we can only check if the selected\n+    // sort order is included in the search params.\n+    expect(SearchModule.searchItems).toHaveBeenCalledWith({\n+      ...defaultSearchOptions,\n+      sortOrder: SortOrder.DATEMODIFIED,\n+    });\n   });\n \n   it(\"should display a spinner when search is in progress\", async () => {\n-    // Trigger a search by changing search query.\n-    changeQuery(\"new query\");\n-    setTimeout(async () => {\n-      expect(component.find(CircularProgress)).toHaveLength(1);\n-    }, 1000);\n+    // Trigger a search by changing sorting order.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e2eabb8e8ac0faa512fba342015e6ce376d26ae"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYwNzY0Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // sort order is included in the search params.\n          \n          \n            \n                // sort order is included in the search params", "url": "https://github.com/openequella/openEQUELLA/pull/2032#discussion_r452607642", "createdAt": "2020-07-10T03:49:26Z", "author": {"login": "SammyIsConfused"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -62,50 +66,94 @@ describe(\"<SearchPage/>\", () => {\n   });\n \n   afterEach(() => {\n-    mount.cleanUp();\n+    jest.clearAllMocks();\n   });\n \n-  const changeQuery = (query: string) => {\n-    act(() => {\n-      const input = component.find(\"input.MuiInputBase-input\");\n-      input.simulate(\"change\", { target: { value: query } });\n-    });\n-  };\n+  /**\n+   * Update search options in order to trigger a search.\n+   * @param update A function that simulates UI behaviours such as selecting a different value from a dropdown.\n+   */\n+  const updateSearchOptions = async (update: () => void) =>\n+    await act(async () => await update());\n \n-  it(\"should retrieve search settings and do a search when the page is opened\", async () => {\n+  it(\"should retrieve search settings and do a search when the page is opened\", () => {\n     expect(\n       SearchSettingsModule.getSearchSettingsFromServer\n     ).toHaveBeenCalledTimes(1);\n     expect(SearchModule.searchItems).toHaveBeenCalledTimes(1);\n+    expect(SearchModule.searchItems).toHaveBeenCalledWith(defaultSearchOptions);\n   });\n \n-  it(\"should display 'No results found.' when there are no search results\", () => {\n-    changeQuery(\"old title\");\n-    //use a timed callback to wait for the debounce before asserting results have populated the page\n-    setTimeout(() => {\n-      expect(component.html()).toContain(\"No results found.\");\n-    }, 1000);\n+  it(\"should support debounce query search\", async () => {\n+    jest.useFakeTimers(\"modern\");\n+    const input = component.find(\"input.MuiInputBase-input\");\n+    await updateSearchOptions(() => {\n+      input.simulate(\"change\", { target: { value: \"new query\" } });\n+      jest.advanceTimersByTime(1000);\n+    });\n+    // After 1s the second search should be triggered.\n+    expect(SearchModule.searchItems).toHaveBeenCalledTimes(2);\n+    expect(SearchModule.searchItems).toHaveBeenCalledWith({\n+      ...defaultSearchOptions,\n+      query: \"new query\",\n+    });\n   });\n \n-  it(\"should contain the test data after a search bar text change and render\", () => {\n-    changeQuery(\"new title\");\n-    setTimeout(() => {\n-      expect(component.html()).not.toContain(\"No results found.\");\n-      expect(component.html()).toContain(\n-        \"266bb0ff-a730-4658-aec0-c68bbefc227c\"\n-      );\n-    }, 1000);\n+  it(\"should support changing the number of items displayed per page\", async () => {\n+    // Initial items per page is 10.\n+    expect(component.html()).toContain(\"1-10 of 12\");\n+    const itemsPerPageSelect = component.find(\n+      \".MuiTablePagination-input input\"\n+    );\n+    await updateSearchOptions(() =>\n+      itemsPerPageSelect.simulate(\"change\", { target: { value: 25 } })\n+    );\n+    expect(SearchModule.searchItems).toHaveBeenCalledWith({\n+      ...defaultSearchOptions,\n+      rowsPerPage: 25,\n+    });\n+    expect(component.html()).toContain(\"1-12 of 12\");\n+  });\n+\n+  it(\"should support navigating to previous/next page\", async () => {\n+    const prevPageButton = component\n+      .find(\".MuiTablePagination-actions button\")\n+      .at(0);\n+    const nextPageButton = component\n+      .find(\".MuiTablePagination-actions button\")\n+      .at(1);\n+    await updateSearchOptions(() => nextPageButton.simulate(\"click\"));\n+    expect(component.html()).toContain(\"11-12 of 12\");\n+    await updateSearchOptions(() => prevPageButton.simulate(\"click\"));\n+    expect(component.html()).toContain(\"1-10 of 12\");\n+  });\n+\n+  it(\"should support sorting search results\", async () => {\n+    const sortingControl = component.find(\".MuiCardHeader-action input\");\n+    await updateSearchOptions(() =>\n+      sortingControl.simulate(\"change\", {\n+        target: { value: SortOrder.DATEMODIFIED },\n+      })\n+    );\n+    // Because sorting is done on Server and we are using mock data, we can only check if the selected\n+    // sort order is included in the search params.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e2eabb8e8ac0faa512fba342015e6ce376d26ae"}, "originalPosition": 139}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYwNzY5MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Initial items per page is 10.\n          \n          \n            \n                // Initial items per page is 10", "url": "https://github.com/openequella/openEQUELLA/pull/2032#discussion_r452607691", "createdAt": "2020-07-10T03:49:41Z", "author": {"login": "SammyIsConfused"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -62,50 +66,94 @@ describe(\"<SearchPage/>\", () => {\n   });\n \n   afterEach(() => {\n-    mount.cleanUp();\n+    jest.clearAllMocks();\n   });\n \n-  const changeQuery = (query: string) => {\n-    act(() => {\n-      const input = component.find(\"input.MuiInputBase-input\");\n-      input.simulate(\"change\", { target: { value: query } });\n-    });\n-  };\n+  /**\n+   * Update search options in order to trigger a search.\n+   * @param update A function that simulates UI behaviours such as selecting a different value from a dropdown.\n+   */\n+  const updateSearchOptions = async (update: () => void) =>\n+    await act(async () => await update());\n \n-  it(\"should retrieve search settings and do a search when the page is opened\", async () => {\n+  it(\"should retrieve search settings and do a search when the page is opened\", () => {\n     expect(\n       SearchSettingsModule.getSearchSettingsFromServer\n     ).toHaveBeenCalledTimes(1);\n     expect(SearchModule.searchItems).toHaveBeenCalledTimes(1);\n+    expect(SearchModule.searchItems).toHaveBeenCalledWith(defaultSearchOptions);\n   });\n \n-  it(\"should display 'No results found.' when there are no search results\", () => {\n-    changeQuery(\"old title\");\n-    //use a timed callback to wait for the debounce before asserting results have populated the page\n-    setTimeout(() => {\n-      expect(component.html()).toContain(\"No results found.\");\n-    }, 1000);\n+  it(\"should support debounce query search\", async () => {\n+    jest.useFakeTimers(\"modern\");\n+    const input = component.find(\"input.MuiInputBase-input\");\n+    await updateSearchOptions(() => {\n+      input.simulate(\"change\", { target: { value: \"new query\" } });\n+      jest.advanceTimersByTime(1000);\n+    });\n+    // After 1s the second search should be triggered.\n+    expect(SearchModule.searchItems).toHaveBeenCalledTimes(2);\n+    expect(SearchModule.searchItems).toHaveBeenCalledWith({\n+      ...defaultSearchOptions,\n+      query: \"new query\",\n+    });\n   });\n \n-  it(\"should contain the test data after a search bar text change and render\", () => {\n-    changeQuery(\"new title\");\n-    setTimeout(() => {\n-      expect(component.html()).not.toContain(\"No results found.\");\n-      expect(component.html()).toContain(\n-        \"266bb0ff-a730-4658-aec0-c68bbefc227c\"\n-      );\n-    }, 1000);\n+  it(\"should support changing the number of items displayed per page\", async () => {\n+    // Initial items per page is 10.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e2eabb8e8ac0faa512fba342015e6ce376d26ae"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYwNzc1Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // After 1s the second search should be triggered.\n          \n          \n            \n                // After 1s the second search should be triggered", "url": "https://github.com/openequella/openEQUELLA/pull/2032#discussion_r452607756", "createdAt": "2020-07-10T03:49:58Z", "author": {"login": "SammyIsConfused"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -62,50 +66,94 @@ describe(\"<SearchPage/>\", () => {\n   });\n \n   afterEach(() => {\n-    mount.cleanUp();\n+    jest.clearAllMocks();\n   });\n \n-  const changeQuery = (query: string) => {\n-    act(() => {\n-      const input = component.find(\"input.MuiInputBase-input\");\n-      input.simulate(\"change\", { target: { value: query } });\n-    });\n-  };\n+  /**\n+   * Update search options in order to trigger a search.\n+   * @param update A function that simulates UI behaviours such as selecting a different value from a dropdown.\n+   */\n+  const updateSearchOptions = async (update: () => void) =>\n+    await act(async () => await update());\n \n-  it(\"should retrieve search settings and do a search when the page is opened\", async () => {\n+  it(\"should retrieve search settings and do a search when the page is opened\", () => {\n     expect(\n       SearchSettingsModule.getSearchSettingsFromServer\n     ).toHaveBeenCalledTimes(1);\n     expect(SearchModule.searchItems).toHaveBeenCalledTimes(1);\n+    expect(SearchModule.searchItems).toHaveBeenCalledWith(defaultSearchOptions);\n   });\n \n-  it(\"should display 'No results found.' when there are no search results\", () => {\n-    changeQuery(\"old title\");\n-    //use a timed callback to wait for the debounce before asserting results have populated the page\n-    setTimeout(() => {\n-      expect(component.html()).toContain(\"No results found.\");\n-    }, 1000);\n+  it(\"should support debounce query search\", async () => {\n+    jest.useFakeTimers(\"modern\");\n+    const input = component.find(\"input.MuiInputBase-input\");\n+    await updateSearchOptions(() => {\n+      input.simulate(\"change\", { target: { value: \"new query\" } });\n+      jest.advanceTimersByTime(1000);\n+    });\n+    // After 1s the second search should be triggered.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e2eabb8e8ac0faa512fba342015e6ce376d26ae"}, "originalPosition": 86}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b49c170b8fad0e40102a617e622370ce73487b62", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/b49c170b8fad0e40102a617e622370ce73487b62", "committedDate": "2020-07-10T03:57:40Z", "message": "Reword comments for Search page test.\n\nCo-authored-by: SammyIsConfused <samantha.fisher@edalex.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NDA5MTYw", "url": "https://github.com/openequella/openEQUELLA/pull/2032#pullrequestreview-446409160", "createdAt": "2020-07-10T13:39:39Z", "commit": {"oid": "b49c170b8fad0e40102a617e622370ce73487b62"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxMzozOTo0MFrOGv3wGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxMzozOTo0MFrOGv3wGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg0OTY5MQ==", "bodyText": "wouldn't calling\nupdateSearchOptions(() => itemsPerPageSelect.simulate(\"change\", { target: { value: 25 } }));\nbe the same as\nact(() => itemsPerPageSelect.simulate(\"change\", { target: { value: 25 } }));\n?\nI'm missing what this wrapper around act is adding.", "url": "https://github.com/openequella/openEQUELLA/pull/2032#discussion_r452849691", "createdAt": "2020-07-10T13:39:40Z", "author": {"login": "ChristianMurphy"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -62,50 +66,94 @@ describe(\"<SearchPage/>\", () => {\n   });\n \n   afterEach(() => {\n-    mount.cleanUp();\n+    jest.clearAllMocks();\n   });\n \n-  const changeQuery = (query: string) => {\n-    act(() => {\n-      const input = component.find(\"input.MuiInputBase-input\");\n-      input.simulate(\"change\", { target: { value: query } });\n-    });\n-  };\n+  /**\n+   * Update search options in order to trigger a search.\n+   * @param update A function that simulates UI behaviours such as selecting a different value from a dropdown.\n+   */\n+  const updateSearchOptions = async (update: () => void) =>\n+    await act(async () => await update());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b49c170b8fad0e40102a617e622370ce73487b62"}, "originalPosition": 62}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2OTQwOTUz", "url": "https://github.com/openequella/openEQUELLA/pull/2032#pullrequestreview-446940953", "createdAt": "2020-07-13T02:03:27Z", "commit": {"oid": "b49c170b8fad0e40102a617e622370ce73487b62"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwMjowMzoyN1rOGwZPwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwMjowNDoyNVrOGwZQbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM5ODQ2NQ==", "bodyText": "I don't seen an equivalent test for this? Why is it removed?", "url": "https://github.com/openequella/openEQUELLA/pull/2032#discussion_r453398465", "createdAt": "2020-07-13T02:03:27Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -62,50 +66,94 @@ describe(\"<SearchPage/>\", () => {\n   });\n \n   afterEach(() => {\n-    mount.cleanUp();\n+    jest.clearAllMocks();\n   });\n \n-  const changeQuery = (query: string) => {\n-    act(() => {\n-      const input = component.find(\"input.MuiInputBase-input\");\n-      input.simulate(\"change\", { target: { value: query } });\n-    });\n-  };\n+  /**\n+   * Update search options in order to trigger a search.\n+   * @param update A function that simulates UI behaviours such as selecting a different value from a dropdown.\n+   */\n+  const updateSearchOptions = async (update: () => void) =>\n+    await act(async () => await update());\n \n-  it(\"should retrieve search settings and do a search when the page is opened\", async () => {\n+  it(\"should retrieve search settings and do a search when the page is opened\", () => {\n     expect(\n       SearchSettingsModule.getSearchSettingsFromServer\n     ).toHaveBeenCalledTimes(1);\n     expect(SearchModule.searchItems).toHaveBeenCalledTimes(1);\n+    expect(SearchModule.searchItems).toHaveBeenCalledWith(defaultSearchOptions);\n   });\n \n-  it(\"should display 'No results found.' when there are no search results\", () => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b49c170b8fad0e40102a617e622370ce73487b62"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM5ODYzOQ==", "bodyText": "I don't see an equivalent test for this (especially one that actually verifies that search results are in the list). Why the removal?", "url": "https://github.com/openequella/openEQUELLA/pull/2032#discussion_r453398639", "createdAt": "2020-07-13T02:04:25Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -62,50 +66,94 @@ describe(\"<SearchPage/>\", () => {\n   });\n \n   afterEach(() => {\n-    mount.cleanUp();\n+    jest.clearAllMocks();\n   });\n \n-  const changeQuery = (query: string) => {\n-    act(() => {\n-      const input = component.find(\"input.MuiInputBase-input\");\n-      input.simulate(\"change\", { target: { value: query } });\n-    });\n-  };\n+  /**\n+   * Update search options in order to trigger a search.\n+   * @param update A function that simulates UI behaviours such as selecting a different value from a dropdown.\n+   */\n+  const updateSearchOptions = async (update: () => void) =>\n+    await act(async () => await update());\n \n-  it(\"should retrieve search settings and do a search when the page is opened\", async () => {\n+  it(\"should retrieve search settings and do a search when the page is opened\", () => {\n     expect(\n       SearchSettingsModule.getSearchSettingsFromServer\n     ).toHaveBeenCalledTimes(1);\n     expect(SearchModule.searchItems).toHaveBeenCalledTimes(1);\n+    expect(SearchModule.searchItems).toHaveBeenCalledWith(defaultSearchOptions);\n   });\n \n-  it(\"should display 'No results found.' when there are no search results\", () => {\n-    changeQuery(\"old title\");\n-    //use a timed callback to wait for the debounce before asserting results have populated the page\n-    setTimeout(() => {\n-      expect(component.html()).toContain(\"No results found.\");\n-    }, 1000);\n+  it(\"should support debounce query search\", async () => {\n+    jest.useFakeTimers(\"modern\");\n+    const input = component.find(\"input.MuiInputBase-input\");\n+    await updateSearchOptions(() => {\n+      input.simulate(\"change\", { target: { value: \"new query\" } });\n+      jest.advanceTimersByTime(1000);\n+    });\n+    // After 1s the second search should be triggered\n+    expect(SearchModule.searchItems).toHaveBeenCalledTimes(2);\n+    expect(SearchModule.searchItems).toHaveBeenCalledWith({\n+      ...defaultSearchOptions,\n+      query: \"new query\",\n+    });\n   });\n \n-  it(\"should contain the test data after a search bar text change and render\", () => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b49c170b8fad0e40102a617e622370ce73487b62"}, "originalPosition": 94}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b30261a04c987b6944529f847a5093c97e9ed10", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/1b30261a04c987b6944529f847a5093c97e9ed10", "committedDate": "2020-07-13T03:47:11Z", "message": "Add one test case for empty search result."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2OTc0MzYz", "url": "https://github.com/openequella/openEQUELLA/pull/2032#pullrequestreview-446974363", "createdAt": "2020-07-13T04:30:38Z", "commit": {"oid": "1b30261a04c987b6944529f847a5093c97e9ed10"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwNDozMDozOVrOGwbGJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwNDozMDozOVrOGwbGJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQyODc3NQ==", "bodyText": "This is now duplicated. Seems you need a function of:\nconst doSearch = async (searchTerm: string) => {\n    jest.useFakeTimers(\"modern\");\n    const input = component.find(\"input.MuiInputBase-input\");\n    await awaitAct(() => {\n      input.simulate(\"change\", { target: { value: searchTerm } });\n      jest.advanceTimersByTime(1000);\n    });\n}", "url": "https://github.com/openequella/openEQUELLA/pull/2032#discussion_r453428775", "createdAt": "2020-07-13T04:30:39Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -97,6 +100,21 @@ describe(\"<SearchPage/>\", () => {\n       ...defaultSearchOptions,\n       query: \"new query\",\n     });\n+    expect(component.html()).not.toContain(\"No results found.\");\n+    expect(component.html()).toContain(\"266bb0ff-a730-4658-aec0-c68bbefc227c\");\n+  });\n+\n+  it(\"should display 'No results found.' when there are no search results\", async () => {\n+    mockSearch.mockImplementationOnce(() =>\n+      Promise.resolve(getEmptySearchResult)\n+    );\n+    jest.useFakeTimers(\"modern\");\n+    const input = component.find(\"input.MuiInputBase-input\");\n+    await awaitAct(() => {\n+      input.simulate(\"change\", { target: { value: \"no items\" } });\n+      jest.advanceTimersByTime(1000);\n+    });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b30261a04c987b6944529f847a5093c97e9ed10"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b92db439b16bf86a66e7ce16a9c4af0deafd4646", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/b92db439b16bf86a66e7ce16a9c4af0deafd4646", "committedDate": "2020-07-13T04:45:01Z", "message": "Fix the duplication for query search tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2OTc4MTU1", "url": "https://github.com/openequella/openEQUELLA/pull/2032#pullrequestreview-446978155", "createdAt": "2020-07-13T04:46:40Z", "commit": {"oid": "b92db439b16bf86a66e7ce16a9c4af0deafd4646"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4947, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}