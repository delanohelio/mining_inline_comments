{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4MTM2Mjg3", "number": 2116, "title": "Improve Date range selector", "bodyText": "#1306\nChecklist\n\n the [contributor license agreement][] is signed\n commit message follows [commit guidelines][]\n tests are included\n screenshots are included showing significant UI changes\n documentation is changed or added\n\nDescription of change\nHere are some improvements made for the Date range selector. However, the component becomes a lot more complicated accordingly. So I am still thinking if these improvements are worth to have.\n\nUsed KeyboardDatePicker to allow type and clear a date. But in order to properly use it, state is required, which increases complexity.\nChanged to default picker labels to from and to.\nAdded a util function to help convert a date object to a string in ISO format. The reason is Javascript native function toISOString changes the time to UTC time,  which may result in incorrect search results.", "createdAt": "2020-07-29T01:12:32Z", "url": "https://github.com/openequella/openEQUELLA/pull/2116", "merged": true, "mergeCommit": {"oid": "78e69d372d15de4a8adb07f2865ce62759b9abe5"}, "closed": true, "closedAt": "2020-07-29T06:23:22Z", "author": {"login": "PenghaiZhang"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5fqBHgH2gAyNDU4MTM2Mjg3OjA3MWIzYzQxMDRlZjg0ZWMwOGE2M2Y3ZDJlNWJmNGVlYjc1ODc4NWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5jiFGAFqTQ1NzE5MDEyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "071b3c4104ef84ec08a63f7d2e5bf4eeb758785d", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/071b3c4104ef84ec08a63f7d2e5bf4eeb758785d", "committedDate": "2020-07-29T00:12:43Z", "message": "Improvements for Date range selector\n\n1. Use MUI KeyboardDatePicker to allow typing a custom date; and\n2. Use state to control Date picker values; and\n3. Change the default label to 'From' and 'To'; and\n4. Create a util function to help convert a date object to string in\n   ISO format without changing time."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee64a86b98ddabaefd5c2efea2658feb5dcd9630", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/ee64a86b98ddabaefd5c2efea2658feb5dcd9630", "committedDate": "2020-07-29T00:47:04Z", "message": "Ensure the updated date range is valid."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d8b830855ce6f1d3b2e2e98636acf52e8d2eb5c", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/6d8b830855ce6f1d3b2e2e98636acf52e8d2eb5c", "committedDate": "2020-07-29T01:04:05Z", "message": "Don't update date range at the first render."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MTMxMzIz", "url": "https://github.com/openequella/openEQUELLA/pull/2116#pullrequestreview-457131323", "createdAt": "2020-07-29T01:18:07Z", "commit": {"oid": "6d8b830855ce6f1d3b2e2e98636acf52e8d2eb5c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMToxODowN1rOG4lIyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMToxODowN1rOG4lIyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk4MTg5Nw==", "bodyText": "The initial date range always meets one of the below four conditions and therefore onDateRangeChange is called. This results in an extra render which should not be performed. So here I want  this effect to skip the first render.", "url": "https://github.com/openequella/openEQUELLA/pull/2116#discussion_r461981897", "createdAt": "2020-07-29T01:18:07Z", "author": {"login": "PenghaiZhang"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/components/DateRangeSelector.tsx", "diffHunk": "@@ -118,6 +120,38 @@ export const DateRangeSelector = ({\n   const startLabel = startDatePickerLabel ?? defaultStartDatePickerLabel;\n   const endLabel = endDatePickerLabel ?? defaultEndDatePickerLabel;\n \n+  /**\n+   * MUI KeyboardDatePicker requires its value to be controlled by state,\n+   * in order to properly parse and validate TextField inputs.\n+   */\n+  const [stateDateRange, setStateDateRange] = useState<DateRange | undefined>(\n+    dateRange\n+  );\n+\n+  const isInitialRender = useRef(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d8b830855ce6f1d3b2e2e98636acf52e8d2eb5c"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MTQwMzAw", "url": "https://github.com/openequella/openEQUELLA/pull/2116#pullrequestreview-457140300", "createdAt": "2020-07-29T01:48:05Z", "commit": {"oid": "6d8b830855ce6f1d3b2e2e98636acf52e8d2eb5c"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMTo0ODowNlrOG4loVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMTo1ODoxNlrOG4ly_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk4OTk3NA==", "bodyText": "How would either of these fail the isValid check? If they're not undefined then they're a Date and shouldn't they be valid?", "url": "https://github.com/openequella/openEQUELLA/pull/2116#discussion_r461989974", "createdAt": "2020-07-29T01:48:06Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/components/DateRangeSelector.tsx", "diffHunk": "@@ -118,6 +120,38 @@ export const DateRangeSelector = ({\n   const startLabel = startDatePickerLabel ?? defaultStartDatePickerLabel;\n   const endLabel = endDatePickerLabel ?? defaultEndDatePickerLabel;\n \n+  /**\n+   * MUI KeyboardDatePicker requires its value to be controlled by state,\n+   * in order to properly parse and validate TextField inputs.\n+   */\n+  const [stateDateRange, setStateDateRange] = useState<DateRange | undefined>(\n+    dateRange\n+  );\n+\n+  const isInitialRender = useRef(true);\n+  useEffect(() => {\n+    if (isInitialRender.current) {\n+      isInitialRender.current = false;\n+      return;\n+    }\n+    const start = stateDateRange?.start;\n+    const end = stateDateRange?.end;\n+    const isStartValid = start && DateTime.fromJSDate(start).isValid;\n+    const isEndValid = end && DateTime.fromJSDate(end).isValid;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d8b830855ce6f1d3b2e2e98636acf52e8d2eb5c"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk5MDkwOA==", "bodyText": "I would've been inclined to leave this as was (taking a parameter) so that you have a nice simple pure stand-alone function (easier to maintain and reason out). But it's done now, so up to you.", "url": "https://github.com/openequella/openEQUELLA/pull/2116#discussion_r461990908", "createdAt": "2020-07-29T01:51:32Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/components/DateRangeSelector.tsx", "diffHunk": "@@ -163,18 +197,18 @@ export const DateRangeSelector = ({\n    *\n    * @param dateRange A date range to be converted to a Quick date option label.\n    */\n-  const dateRangeToDateOptionConverter = (dateRange?: DateRange): string => {\n+  const dateRangeToDateOptionConverter = (): string => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d8b830855ce6f1d3b2e2e98636acf52e8d2eb5c"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk5MjcwMw==", "bodyText": "I think here we should either:\na. Use the Locale again; or\nb. Go with the more internationally acceptable ISO format.", "url": "https://github.com/openequella/openEQUELLA/pull/2116#discussion_r461992703", "createdAt": "2020-07-29T01:58:16Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/components/DateRangeSelector.tsx", "diffHunk": "@@ -224,36 +258,47 @@ export const DateRangeSelector = ({\n       {\n         field: \"start\",\n         label: startLabel,\n-        value: dateRange?.start,\n+        value: stateDateRange?.start,\n       },\n       {\n         field: \"end\",\n         label: endLabel,\n-        value: dateRange?.end,\n+        value: stateDateRange?.end,\n       },\n     ];\n \n-    return dateRangePickers.map(({ field, label, value }) => (\n-      <Grid item key={field}>\n-        <DatePicker\n-          disableFuture\n-          variant=\"inline\"\n-          inputVariant=\"outlined\"\n-          autoOk\n-          labelFunc={(value, invalidLabel) =>\n-            value?.toLocaleString() ?? invalidLabel\n-          }\n-          label={!value ? label : \"\"}\n-          value={value ?? null}\n-          onChange={(newDate: MaterialUiPickersDate) =>\n-            onDateRangeChange({\n-              ...dateRange,\n-              [field]: newDate?.toJSDate(),\n-            })\n-          }\n-        />\n-      </Grid>\n-    ));\n+    return dateRangePickers.map(({ field, label, value }) => {\n+      const isStart = field === \"start\";\n+      return (\n+        <Grid item key={field} xs={12} md={6}>\n+          <KeyboardDatePicker\n+            disableFuture\n+            variant=\"dialog\"\n+            clearable\n+            inputVariant=\"outlined\"\n+            autoOk\n+            // Show date in locale string, or nothing if date is null.\n+            labelFunc={(date, _) => {\n+              return date?.toLocaleString() ?? \"\";\n+            }}\n+            // TextField inputs are parsed to this format.\n+            format=\"dd/MM/yyyy\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d8b830855ce6f1d3b2e2e98636acf52e8d2eb5c"}, "originalPosition": 149}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7713f2b19c91710551607ecb63efcb43f1de5bca", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/7713f2b19c91710551607ecb63efcb43f1de5bca", "committedDate": "2020-07-29T04:39:11Z", "message": "Three tweaks for Date range selector\n\n1. Specify the locale used by MuiPickersUtilsProvider; and\n2. Rollback function 'dateRangeToDateOptionConverter' to take a parameter; and\n3. Make Date pickers parse and display date values in ISO format."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MTkwMTIx", "url": "https://github.com/openequella/openEQUELLA/pull/2116#pullrequestreview-457190121", "createdAt": "2020-07-29T04:43:40Z", "commit": {"oid": "7713f2b19c91710551607ecb63efcb43f1de5bca"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4857, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}