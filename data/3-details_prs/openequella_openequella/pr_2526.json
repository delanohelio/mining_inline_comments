{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyNzgyNTIx", "number": 2526, "title": "Handle PDF thumbnailing safely", "bodyText": "Checklist\n\n\n the contributor license agreement is signed\n commit message follows commit guidelines\n\nDescription of change\nThumb-nailing of PDFs is done by an external ImageMagick process. This is then delegated by ImageMagick to a program called Ghostscript. If uploading a broken PDF, Ghostscript will attempt indefinitely to \"fix\" the PDF, slamming the server CPU and affecting performance. If the process takes too long to finish it can cause issues with server stability.\nThis PR solves the problem by adding a new config property to plugins/com.tle.core.imageMagick/config.properties called thumbnailing.timeout. This adds a timeout cap to the imageMagick process - if exceeded thumb-nailing for that attachment will error out and cancel, and will not be retried. When not set, the default is 20 seconds. It is possible to use the standard non-capped thumb-nailing process by setting it to 0.\nNote: Similar problems occur with indexing broken PDFs for freetext search using Tika - this will be addressed in another PR.\n#2527", "createdAt": "2020-11-18T00:01:19Z", "url": "https://github.com/openequella/openEQUELLA/pull/2526", "merged": true, "mergeCommit": {"oid": "2aca361ac168953307bd9a662b72459fa8765521"}, "closed": true, "closedAt": "2020-11-26T21:59:06Z", "author": {"login": "SammyIsConfused"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddhf9igH2gAyNTIyNzgyNTIxOjY3MDgwZTkyNjFhMGUzNTdlNTY1YWRkODY2YWEwZTljN2M5ZDY3YWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgL5HOgH2gAyNTIyNzgyNTIxOmU0ZTg0ZjQxZmQxYmU3OWU0YmZhMjY0YmU0M2Y1ZDE2YTZlM2YyYjM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "67080e9261a0e357e565add866aa0e9c7c9d67aa", "author": {"user": null}, "url": "https://github.com/openequella/openEQUELLA/commit/67080e9261a0e357e565add866aa0e9c7c9d67aa", "committedDate": "2020-11-17T22:42:49Z", "message": "Add a process exec with a time limit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4232dcd8c008daf5022443f4a36c1fedca7bf646", "author": {"user": null}, "url": "https://github.com/openequella/openEQUELLA/commit/4232dcd8c008daf5022443f4a36c1fedca7bf646", "committedDate": "2020-11-17T22:43:45Z", "message": "Consume pdf thumbnail time limit from image magick properties file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c936089b761a3dd2af9f60bc79df114c6e12f85", "author": {"user": null}, "url": "https://github.com/openequella/openEQUELLA/commit/3c936089b761a3dd2af9f60bc79df114c6e12f85", "committedDate": "2020-11-17T22:51:50Z", "message": "Use a timed process for PDF thumbnailing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9384b9fa5f51bde4a726172221463248cce3ad03", "author": {"user": null}, "url": "https://github.com/openequella/openEQUELLA/commit/9384b9fa5f51bde4a726172221463248cce3ad03", "committedDate": "2020-11-17T22:55:17Z", "message": "Remove unnecessary $NON-NLS-1$ comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc7986e05c68f7fd12882572829bd038c8935f45", "author": {"user": null}, "url": "https://github.com/openequella/openEQUELLA/commit/cc7986e05c68f7fd12882572829bd038c8935f45", "committedDate": "2020-11-17T22:58:53Z", "message": "Use StandardCharsets rather than inline string"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0OTgzNjc5", "url": "https://github.com/openequella/openEQUELLA/pull/2526#pullrequestreview-534983679", "createdAt": "2020-11-20T00:18:54Z", "commit": {"oid": "cc7986e05c68f7fd12882572829bd038c8935f45"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwMDoxODo1NVrOH23bFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwMDoyODo1NFrOH238Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI5MzIwNA==", "bodyText": "This will make for some rather verbose logs, and is really only relevant for debugging issues so\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  LOGGER.info(\"maxDurationInSeconds not set. Using a regular non-timed process.\");\n          \n          \n            \n                  LOGGER.debug(\"maxDurationInSeconds not set. Using a regular non-timed process.\");", "url": "https://github.com/openequella/openEQUELLA/pull/2526#discussion_r527293204", "createdAt": "2020-11-20T00:18:55Z", "author": {"login": "edalex-ian"}, "path": "Platform/Plugins/com.tle.platform.common/src/com/tle/common/util/ExecUtils.java", "diffHunk": "@@ -114,6 +115,38 @@ public static ExecResult exec(String[] cmdarray, Map<String, String> additionalE\n     }\n   }\n \n+  public static ExecResult execWithTimeLimit(long maxDurationInSeconds, String[] options) {\n+    if (maxDurationInSeconds < 1L) {\n+      LOGGER.info(\"maxDurationInSeconds not set. Using a regular non-timed process.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc7986e05c68f7fd12882572829bd038c8935f45"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI5NDMwOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  LOGGER.info(\"Started timed process\");\n          \n          \n            \n                  LOGGER.debug(\"Started timed process\");", "url": "https://github.com/openequella/openEQUELLA/pull/2526#discussion_r527294309", "createdAt": "2020-11-20T00:20:13Z", "author": {"login": "edalex-ian"}, "path": "Platform/Plugins/com.tle.platform.common/src/com/tle/common/util/ExecUtils.java", "diffHunk": "@@ -114,6 +115,38 @@ public static ExecResult exec(String[] cmdarray, Map<String, String> additionalE\n     }\n   }\n \n+  public static ExecResult execWithTimeLimit(long maxDurationInSeconds, String[] options) {\n+    if (maxDurationInSeconds < 1L) {\n+      LOGGER.info(\"maxDurationInSeconds not set. Using a regular non-timed process.\");\n+      return exec(options, null, null);\n+    }\n+    return execWithTimeLimit(options, null, null, maxDurationInSeconds);\n+  }\n+\n+  public static ExecResult execWithTimeLimit(\n+      String[] cmdarray, Map<String, String> additionalEnv, File dir, long durationInSeconds) {\n+    try {\n+      final Triple<Process, StreamReader, StreamReader> cp =\n+          createProcess(cmdarray, additionalEnv, dir);\n+      LOGGER.info(\"Started timed process\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc7986e05c68f7fd12882572829bd038c8935f45"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI5NDU5OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  LOGGER.info(\"Timed process finished\");\n          \n          \n            \n                  LOGGER.debug(\"Timed process finished\");", "url": "https://github.com/openequella/openEQUELLA/pull/2526#discussion_r527294599", "createdAt": "2020-11-20T00:20:31Z", "author": {"login": "edalex-ian"}, "path": "Platform/Plugins/com.tle.platform.common/src/com/tle/common/util/ExecUtils.java", "diffHunk": "@@ -114,6 +115,38 @@ public static ExecResult exec(String[] cmdarray, Map<String, String> additionalE\n     }\n   }\n \n+  public static ExecResult execWithTimeLimit(long maxDurationInSeconds, String[] options) {\n+    if (maxDurationInSeconds < 1L) {\n+      LOGGER.info(\"maxDurationInSeconds not set. Using a regular non-timed process.\");\n+      return exec(options, null, null);\n+    }\n+    return execWithTimeLimit(options, null, null, maxDurationInSeconds);\n+  }\n+\n+  public static ExecResult execWithTimeLimit(\n+      String[] cmdarray, Map<String, String> additionalEnv, File dir, long durationInSeconds) {\n+    try {\n+      final Triple<Process, StreamReader, StreamReader> cp =\n+          createProcess(cmdarray, additionalEnv, dir);\n+      LOGGER.info(\"Started timed process\");\n+      final Process proc = cp.getFirst();\n+      final StreamReader stdOut = cp.getSecond();\n+      final StreamReader stdErr = cp.getThird();\n+      proc.waitFor(durationInSeconds, TimeUnit.SECONDS);\n+      if (!stdErr.isFinished() || !stdOut.isFinished()) {\n+        throw new InterruptedException();\n+      }\n+      LOGGER.info(\"Timed process finished\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc7986e05c68f7fd12882572829bd038c8935f45"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI5OTEzMw==", "bodyText": "Doesn't need to be this specific. Arguably any thumbnail process going rouge/forever should be hit on the head. I think the check should be removed, and the configuration property made more generic - e.g. thumbnailing.timeout.\nThat in turn raises the question as to whether all thumbnailing goes through here. And if not, should we really do the circuit breaker higher up.", "url": "https://github.com/openequella/openEQUELLA/pull/2526#discussion_r527299133", "createdAt": "2020-11-20T00:25:54Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/src/com/tle/core/imagemagick/ImageMagickServiceImpl.java", "diffHunk": "@@ -204,12 +209,34 @@ public Dimension getImageDimensions(FileHandle handle, String filename) throws I\n \n   @Override\n   public Dimension getImageDimensions(File image) throws IOException {\n-    ExecResult result =\n-        ExecUtils.exec(\n-            identifyExe.getAbsolutePath(),\n-            \"-format\",\n-            \"%wx%h\",\n-            new String(image.getAbsolutePath().getBytes(\"UTF-8\"), \"UTF-8\"));\n+    ExecResult result;\n+    if (image.getAbsolutePath().toLowerCase().contains(\".pdf\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc7986e05c68f7fd12882572829bd038c8935f45"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMwMDk1OQ==", "bodyText": "This duplicates the above. As per above, this branch may be removed. But if not, this should be centralised in a shared String[] as used above.", "url": "https://github.com/openequella/openEQUELLA/pull/2526#discussion_r527300959", "createdAt": "2020-11-20T00:28:02Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/src/com/tle/core/imagemagick/ImageMagickServiceImpl.java", "diffHunk": "@@ -204,12 +209,34 @@ public Dimension getImageDimensions(FileHandle handle, String filename) throws I\n \n   @Override\n   public Dimension getImageDimensions(File image) throws IOException {\n-    ExecResult result =\n-        ExecUtils.exec(\n-            identifyExe.getAbsolutePath(),\n-            \"-format\",\n-            \"%wx%h\",\n-            new String(image.getAbsolutePath().getBytes(\"UTF-8\"), \"UTF-8\"));\n+    ExecResult result;\n+    if (image.getAbsolutePath().toLowerCase().contains(\".pdf\")) {\n+      // use a timed process for pdfs so that thumbnailing\n+      // for large or badly generated PDFs doesn't attempt indefinitely.\n+      // Set in plugins/com.tle.core.imagemagick/config.properties\n+      // imageMagick.seconds.before.cancel.pdf.thumbnailing as an integer.\n+      // if not set, the default is 20 seconds. If set to 0, uses a regular non-timed process.\n+      result =\n+          ExecUtils.execWithTimeLimit(\n+              pdfThumbnailTimeLimit,\n+              new String[] {\n+                identifyExe.getAbsolutePath(),\n+                \"-format\",\n+                \"%wx%h\",\n+                new String(\n+                    image.getAbsolutePath().getBytes(StandardCharsets.UTF_8),\n+                    StandardCharsets.UTF_8)\n+              });\n+    } else {\n+      result =\n+          ExecUtils.exec(\n+              identifyExe.getAbsolutePath(),\n+              \"-format\",\n+              \"%wx%h\",\n+              new String(\n+                  image.getAbsolutePath().getBytes(StandardCharsets.UTF_8),\n+                  StandardCharsets.UTF_8));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc7986e05c68f7fd12882572829bd038c8935f45"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMwMTY4Mg==", "bodyText": "This should also be added to the example optional config properties file as way of documentation.", "url": "https://github.com/openequella/openEQUELLA/pull/2526#discussion_r527301682", "createdAt": "2020-11-20T00:28:54Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/src/com/tle/core/imagemagick/guice/ImageMagickModule.java", "diffHunk": "@@ -32,5 +32,6 @@ protected String getFilename() {\n   @Override\n   protected void configure() {\n     bindProp(\"imageMagick.path\");\n+    bindInt(\"imageMagick.seconds.before.cancel.pdf.thumbnailing\", 20);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc7986e05c68f7fd12882572829bd038c8935f45"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe97f043ce17407bfe68cb0a1b881f1f1e90342b", "author": {"user": null}, "url": "https://github.com/openequella/openEQUELLA/commit/fe97f043ce17407bfe68cb0a1b881f1f1e90342b", "committedDate": "2020-11-20T00:36:33Z", "message": "Elevate info logs to debug\n\nCo-authored-by: edalex-ian <43919233+edalex-ian@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6497960d3bb7afc59db6c02d1e7fe4e70a539a75", "author": {"user": null}, "url": "https://github.com/openequella/openEQUELLA/commit/6497960d3bb7afc59db6c02d1e7fe4e70a539a75", "committedDate": "2020-11-20T04:09:11Z", "message": "Rename to thumbnailing.timeout and add docs to config.properties.unresolved"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a73d3a5e1bbf9a5e9d93ec7ab34e4fe21dbef9c", "author": {"user": null}, "url": "https://github.com/openequella/openEQUELLA/commit/4a73d3a5e1bbf9a5e9d93ec7ab34e4fe21dbef9c", "committedDate": "2020-11-20T04:10:00Z", "message": "Refactor timed process to occur as validation step"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2OTYyNDg1", "url": "https://github.com/openequella/openEQUELLA/pull/2526#pullrequestreview-536962485", "createdAt": "2020-11-24T01:03:25Z", "commit": {"oid": "4a73d3a5e1bbf9a5e9d93ec7ab34e4fe21dbef9c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "891e25824f1d61a503d56942db254fce6c5b698e", "author": {"user": null}, "url": "https://github.com/openequella/openEQUELLA/commit/891e25824f1d61a503d56942db254fce6c5b698e", "committedDate": "2020-11-26T04:26:31Z", "message": "Merge branch 'develop' into bugfix/make_pdf_thumbnailing_safe"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4e84f41fd1be79e4bfa264be43f5d16a6e3f2b3", "author": {"user": null}, "url": "https://github.com/openequella/openEQUELLA/commit/e4e84f41fd1be79e4bfa264be43f5d16a6e3f2b3", "committedDate": "2020-11-26T05:14:09Z", "message": "Add wait to MimeTypesTest"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 356, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}