{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5MTcyNzE3", "number": 2052, "title": "Feature/search2 API attachment enhancements", "bodyText": "Checklist\n\n\n the contributor license agreement is signed\n commit message follows commit guidelines\n\nDescription of change\n\n#1306\nTwo new attachment properties have been added to the SearchHelper object, used by the search2 api endpoint:\n\nMimetype (for file based attachments)\nisPlaceholderThumb: Indicates if an attachment does not yet have a generated thumbnail\n\nThe plan is to eventually use these two properties to display more pleasing thumbnails in the SearchResult frontend component", "createdAt": "2020-07-15T00:09:11Z", "url": "https://github.com/openequella/openEQUELLA/pull/2052", "merged": true, "mergeCommit": {"oid": "4ff453aa3f6276afc7d8eff6865e89c72a4eca28"}, "closed": true, "closedAt": "2020-07-15T04:29:01Z", "author": {"login": "mrblippy"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0tr7NgH2gAyNDQ5MTcyNzE3OjUxNmFkNTU2ZWZmM2Q5ZGJhYmM0MDlhODhiNWI1MTEwMWM1YTcyOWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1AsrSAH2gAyNDQ5MTcyNzE3OjM5M2UyMzAxYWNiYmI2OWYxNzA4OWE0ODFhZTlkYmNiNjgxMWQ1OTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "516ad556eff3d9dbabc409a88b5b51101c5a729b", "author": {"user": {"login": "mrblippy", "name": "Nick Charles"}}, "url": "https://github.com/openequella/openEQUELLA/commit/516ad556eff3d9dbabc409a88b5b51101c5a729b", "committedDate": "2020-07-14T03:43:51Z", "message": "Add MimeType and Thumbnail properties to attachments for Search2 endpoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "967d58e9d28568789badbe9c9c6bd10b6c0689f2", "author": {"user": {"login": "mrblippy", "name": "Nick Charles"}}, "url": "https://github.com/openequella/openEQUELLA/commit/967d58e9d28568789badbe9c9c6bd10b6c0689f2", "committedDate": "2020-07-14T04:17:06Z", "message": "Give method for extracting mimetypes a more descirptive name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d69daf36f5583f2d73f084945019ad0c46dbfa65", "author": {"user": {"login": "mrblippy", "name": "Nick Charles"}}, "url": "https://github.com/openequella/openEQUELLA/commit/d69daf36f5583f2d73f084945019ad0c46dbfa65", "committedDate": "2020-07-15T00:06:16Z", "message": "add documentation for isPlacehoderThumb property for SearchResultAttachment class"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NTQ5NTg3", "url": "https://github.com/openequella/openEQUELLA/pull/2052#pullrequestreview-448549587", "createdAt": "2020-07-15T00:20:21Z", "commit": {"oid": "967d58e9d28568789badbe9c9c6bd10b6c0689f2"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMDoyMDoyMVrOGxpyYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMDoyMjoyNlrOGxp0kA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcxODA0OQ==", "bodyText": "Can getAttachmentByUuid return null? Or does it simply throw an exception?\nIf it can return null, maybe we should handle it and return false.", "url": "https://github.com/openequella/openEQUELLA/pull/2052#discussion_r454718049", "createdAt": "2020-07-15T00:20:21Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/scalasrc/com/tle/web/api/search/SearchHelper.scala", "diffHunk": "@@ -199,19 +201,43 @@ object SearchHelper {\n   /**\n     * Convert a list of AttachmentBean to a list of SearchResultAttachment\n     */\n-  def convertToAttachment(\n-      attachmentBeans: java.util.List[AttachmentBean]): List[SearchResultAttachment] = {\n+  def convertToAttachment(attachmentBeans: java.util.List[AttachmentBean],\n+                          itemKey: ItemIdKey): List[SearchResultAttachment] = {\n     attachmentBeans.asScala\n       .map(\n         att =>\n-          SearchResultAttachment(att.getRawAttachmentType,\n-                                 att.getUuid,\n-                                 Option(att.getDescription),\n-                                 att.isPreview,\n-                                 getLinksFromBean(att)))\n+          SearchResultAttachment(\n+            att.getRawAttachmentType,\n+            att.getUuid,\n+            Option(att.getDescription),\n+            att.isPreview,\n+            getMimetypeForAttachment(att),\n+            !thumbExists(itemKey, att.getUuid),\n+            getLinksFromBean(att)\n+        ))\n       .toList\n   }\n \n+  /**\n+    * Determines if attachment contains a generated thumbnail in filestore\n+    */\n+  def thumbExists(itemKey: ItemIdKey, attachUuid: String): Boolean = {\n+    val item   = LegacyGuice.viewableItemFactory.createNewViewableItem(itemKey)\n+    val attach = item.getAttachmentByUuid(attachUuid)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "967d58e9d28568789badbe9c9c6bd10b6c0689f2"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcxODYwOA==", "bodyText": "This makes for slightly awkward reading. It'd possibly be improved by either:\n\nUsing named arguments here; or\nUsing a variable.\n\nI think 1 would be worthwhile.", "url": "https://github.com/openequella/openEQUELLA/pull/2052#discussion_r454718608", "createdAt": "2020-07-15T00:22:26Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/scalasrc/com/tle/web/api/search/SearchHelper.scala", "diffHunk": "@@ -199,19 +201,43 @@ object SearchHelper {\n   /**\n     * Convert a list of AttachmentBean to a list of SearchResultAttachment\n     */\n-  def convertToAttachment(\n-      attachmentBeans: java.util.List[AttachmentBean]): List[SearchResultAttachment] = {\n+  def convertToAttachment(attachmentBeans: java.util.List[AttachmentBean],\n+                          itemKey: ItemIdKey): List[SearchResultAttachment] = {\n     attachmentBeans.asScala\n       .map(\n         att =>\n-          SearchResultAttachment(att.getRawAttachmentType,\n-                                 att.getUuid,\n-                                 Option(att.getDescription),\n-                                 att.isPreview,\n-                                 getLinksFromBean(att)))\n+          SearchResultAttachment(\n+            att.getRawAttachmentType,\n+            att.getUuid,\n+            Option(att.getDescription),\n+            att.isPreview,\n+            getMimetypeForAttachment(att),\n+            !thumbExists(itemKey, att.getUuid),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "967d58e9d28568789badbe9c9c6bd10b6c0689f2"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "143ba45d50ce2d24a221a7c603d78bed966f54c7", "author": {"user": {"login": "mrblippy", "name": "Nick Charles"}}, "url": "https://github.com/openequella/openEQUELLA/commit/143ba45d50ce2d24a221a7c603d78bed966f54c7", "committedDate": "2020-07-15T01:22:00Z", "message": "pass named arguments to SearchResultAttachment, to aid in readability"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NTQ5Mzg0", "url": "https://github.com/openequella/openEQUELLA/pull/2052#pullrequestreview-448549384", "createdAt": "2020-07-15T00:19:39Z", "commit": {"oid": "967d58e9d28568789badbe9c9c6bd10b6c0689f2"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMDoxOTozOVrOGxpxlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMTozMDo0MFrOGxq8sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcxNzg0NA==", "bodyText": "Let's remove this blank line.", "url": "https://github.com/openequella/openEQUELLA/pull/2052#discussion_r454717844", "createdAt": "2020-07-15T00:19:39Z", "author": {"login": "PenghaiZhang"}, "path": "Source/Plugins/Core/com.equella.core/scalasrc/com/tle/web/api/search/SearchHelper.scala", "diffHunk": "@@ -20,6 +20,7 @@ package com.tle.web.api.search\n \n import java.text.{ParseException, SimpleDateFormat}\n import java.util.Date\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "967d58e9d28568789badbe9c9c6bd10b6c0689f2"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcxNzg2Mw==", "bodyText": "Let's remove this blank line.", "url": "https://github.com/openequella/openEQUELLA/pull/2052#discussion_r454717863", "createdAt": "2020-07-15T00:19:45Z", "author": {"login": "PenghaiZhang"}, "path": "Source/Plugins/Core/com.equella.core/scalasrc/com/tle/web/api/search/SearchHelper.scala", "diffHunk": "@@ -32,9 +33,10 @@ import com.tle.core.freetext.queries.FreeTextBooleanQuery\n import com.tle.core.item.serializer.{ItemSerializerItemBean, ItemSerializerService}\n import com.tle.legacy.LegacyGuice\n import com.tle.web.api.interfaces.beans.AbstractExtendableBean\n-import com.tle.web.api.item.equella.interfaces.beans.EquellaItemBean\n+import com.tle.web.api.item.equella.interfaces.beans.{AbstractFileAttachmentBean, EquellaItemBean}\n import com.tle.web.api.item.interfaces.beans.AttachmentBean\n import com.tle.web.api.search.model.{SearchResultAttachment, SearchParam, SearchResultItem}\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "967d58e9d28568789badbe9c9c6bd10b6c0689f2"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcxODc0Mg==", "bodyText": "Javadoc for this parameter is missing.", "url": "https://github.com/openequella/openEQUELLA/pull/2052#discussion_r454718742", "createdAt": "2020-07-15T00:22:54Z", "author": {"login": "PenghaiZhang"}, "path": "Source/Plugins/Core/com.equella.core/scalasrc/com/tle/web/api/search/model/SearchResultItem.scala", "diffHunk": "@@ -62,12 +62,15 @@ case class SearchResultItem(\n   * @param id The unique ID of an attachment.\n   * @param description The description of an attachment.\n   * @param preview If an attachment can be previewed or not.\n+  * @param mimeType Mime Type of file based attachments\n   * @param links Attachment's links.\n   */\n case class SearchResultAttachment(\n     attachmentType: String,\n     id: String,\n     description: Option[String],\n     preview: Boolean,\n+    mimeType: Option[String],\n+    isPlaceholderThumb: Boolean,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "967d58e9d28568789badbe9c9c6bd10b6c0689f2"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcxOTYyNg==", "bodyText": "Not much difference, but using Some(..) here seems to be more scala idiomatic.", "url": "https://github.com/openequella/openEQUELLA/pull/2052#discussion_r454719626", "createdAt": "2020-07-15T00:26:08Z", "author": {"login": "PenghaiZhang"}, "path": "Source/Plugins/Core/com.equella.core/scalasrc/com/tle/web/api/search/SearchHelper.scala", "diffHunk": "@@ -199,19 +201,43 @@ object SearchHelper {\n   /**\n     * Convert a list of AttachmentBean to a list of SearchResultAttachment\n     */\n-  def convertToAttachment(\n-      attachmentBeans: java.util.List[AttachmentBean]): List[SearchResultAttachment] = {\n+  def convertToAttachment(attachmentBeans: java.util.List[AttachmentBean],\n+                          itemKey: ItemIdKey): List[SearchResultAttachment] = {\n     attachmentBeans.asScala\n       .map(\n         att =>\n-          SearchResultAttachment(att.getRawAttachmentType,\n-                                 att.getUuid,\n-                                 Option(att.getDescription),\n-                                 att.isPreview,\n-                                 getLinksFromBean(att)))\n+          SearchResultAttachment(\n+            att.getRawAttachmentType,\n+            att.getUuid,\n+            Option(att.getDescription),\n+            att.isPreview,\n+            getMimetypeForAttachment(att),\n+            !thumbExists(itemKey, att.getUuid),\n+            getLinksFromBean(att)\n+        ))\n       .toList\n   }\n \n+  /**\n+    * Determines if attachment contains a generated thumbnail in filestore\n+    */\n+  def thumbExists(itemKey: ItemIdKey, attachUuid: String): Boolean = {\n+    val item   = LegacyGuice.viewableItemFactory.createNewViewableItem(itemKey)\n+    val attach = item.getAttachmentByUuid(attachUuid)\n+    LegacyGuice.fileSystemService.fileExists(item.getFileHandle, attach.getThumbnail)\n+  }\n+\n+  /**\n+    * Extract the mimetype for AbstractExtendableBean.\n+    */\n+  def getMimetypeForAttachment[T <: AbstractExtendableBean](bean: T): Option[String] = {\n+    bean match {\n+      case file: AbstractFileAttachmentBean =>\n+        Option(LegacyGuice.mimeTypeService.getMimeTypeForFilename(file.getFilename))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "967d58e9d28568789badbe9c9c6bd10b6c0689f2"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDczNzA3NA==", "bodyText": "Perhaps we can this to avoid checking if thumbnail exists for non-file attachments.\ndef thumbExists(itemKey: ItemIdKey, attachBean: AttachmentBean): Boolean = {\nattachBean match {\ncase bean: FileAttachmentBean =>\nval item   = LegacyGuice.viewableItemFactory.createNewViewableItem(itemKey)\nLegacyGuice.fileSystemService.fileExists(item.getFileHandle, bean.getThumbnail)\ncase _ => false\n}\n}", "url": "https://github.com/openequella/openEQUELLA/pull/2052#discussion_r454737074", "createdAt": "2020-07-15T01:30:40Z", "author": {"login": "PenghaiZhang"}, "path": "Source/Plugins/Core/com.equella.core/scalasrc/com/tle/web/api/search/SearchHelper.scala", "diffHunk": "@@ -199,19 +201,43 @@ object SearchHelper {\n   /**\n     * Convert a list of AttachmentBean to a list of SearchResultAttachment\n     */\n-  def convertToAttachment(\n-      attachmentBeans: java.util.List[AttachmentBean]): List[SearchResultAttachment] = {\n+  def convertToAttachment(attachmentBeans: java.util.List[AttachmentBean],\n+                          itemKey: ItemIdKey): List[SearchResultAttachment] = {\n     attachmentBeans.asScala\n       .map(\n         att =>\n-          SearchResultAttachment(att.getRawAttachmentType,\n-                                 att.getUuid,\n-                                 Option(att.getDescription),\n-                                 att.isPreview,\n-                                 getLinksFromBean(att)))\n+          SearchResultAttachment(\n+            att.getRawAttachmentType,\n+            att.getUuid,\n+            Option(att.getDescription),\n+            att.isPreview,\n+            getMimetypeForAttachment(att),\n+            !thumbExists(itemKey, att.getUuid),\n+            getLinksFromBean(att)\n+        ))\n       .toList\n   }\n \n+  /**\n+    * Determines if attachment contains a generated thumbnail in filestore\n+    */\n+  def thumbExists(itemKey: ItemIdKey, attachUuid: String): Boolean = {\n+    val item   = LegacyGuice.viewableItemFactory.createNewViewableItem(itemKey)\n+    val attach = item.getAttachmentByUuid(attachUuid)\n+    LegacyGuice.fileSystemService.fileExists(item.getFileHandle, attach.getThumbnail)\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "967d58e9d28568789badbe9c9c6bd10b6c0689f2"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "393e2301acbbb69f17089a481ae9dbcb6811d591", "author": {"user": {"login": "mrblippy", "name": "Nick Charles"}}, "url": "https://github.com/openequella/openEQUELLA/commit/393e2301acbbb69f17089a481ae9dbcb6811d591", "committedDate": "2020-07-15T01:52:52Z", "message": "Refactor thumbExists and getMimetypeForAttachment methods in SearchHelper\n\n- Using pattern matching inside the thumbExists ensures that filestore attachment lookups only occurs for File based attachments. It's pointless to do filestore lookups for other attachment types, since they will never have thumbnails stored in filestore"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4962, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}