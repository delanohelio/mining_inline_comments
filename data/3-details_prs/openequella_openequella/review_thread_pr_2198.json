{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5MjIzNzg2", "number": 2198, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMzo1MzozOFrOEZsw6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMDowNzoyMlrOEZs6_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MzgzMjczOnYy", "diffSide": "RIGHT", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/modules/SearchModule.test.ts", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMzo1MzozOFrOHCqjBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMzo1MzozOFrOHCqjBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1NjI5NA==", "bodyText": "I think this test is redundant, as it's already covered by the test on line 51.", "url": "https://github.com/openequella/openEQUELLA/pull/2198#discussion_r472556294", "createdAt": "2020-08-18T23:53:38Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/modules/SearchModule.test.ts", "diffHunk": "@@ -68,4 +68,42 @@ describe(\"SearchModule\", () => {\n     });\n     validateSearchQuery(`${queryTerm}`);\n   });\n+\n+  it(\"should append Classification terms to query if one or more Classifications are selected\", async () => {\n+    mockedSearch.mockReset();\n+    const query = \"technology\";\n+    const terms = [\"Java\", \"Scala\", \"SBT\"];\n+    await SearchModule.searchItems({\n+      ...SearchModule.defaultSearchOptions,\n+      query: query,\n+      rawMode: false,\n+      classificationTerms: terms,\n+    });\n+    validateSearchQuery(`${query}* AND (Java OR Scala OR SBT)`);\n+  });\n+\n+  it(\"should not append Classification terms to query if no Classifications are selected\", async () => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18577c53481c6ad7a4f3518c8f5cedc9cbd33ce9"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MzgzNjg0OnYy", "diffSide": "RIGHT", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMzo1NTo0NFrOHCqlbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMzo1NTo0NFrOHCqlbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1NjkxMA==", "bodyText": "It'd be preferable to have this function declared before it's use. (i.e. above the searchItems function, but after the formatQuery function.)", "url": "https://github.com/openequella/openEQUELLA/pull/2198#discussion_r472556910", "createdAt": "2020-08-18T23:55:44Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "diffHunk": "@@ -106,6 +106,40 @@ export const searchItems = ({\n   return OEQ.Search.search(API_BASE_URL, searchParams);\n };\n \n+/**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18577c53481c6ad7a4f3518c8f5cedc9cbd33ce9"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1Mzg0MzY4OnYy", "diffSide": "RIGHT", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMzo1OToxNVrOHCqpkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMzo1OToxNVrOHCqpkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1Nzk2OQ==", "bodyText": "Should this more so be marked as an optional?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              classificationTerms: string[] | undefined\n          \n          \n            \n              classificationTerms?: string[]", "url": "https://github.com/openequella/openEQUELLA/pull/2198#discussion_r472557969", "createdAt": "2020-08-18T23:59:15Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "diffHunk": "@@ -106,6 +106,40 @@ export const searchItems = ({\n   return OEQ.Search.search(API_BASE_URL, searchParams);\n };\n \n+/**\n+ * This function processes the query put in the SearchBar and terms selected from Classifications.\n+ * It firstly formats the query based on whether raw mode is on or off.\n+ * If there are no Classifications terms selected, it returns the formatted query.\n+ * Otherwise, it consolidates all terms into one Lucene query by OR, and combines the two queries\n+ * by AND, and return the combined one.\n+ *\n+ * @param query The query put in the SearchBar.\n+ * @param rawMode Whether raw mode is on or off.\n+ * @param classificationTerms A list of selected Classification terms.\n+ */\n+export const processQuery = (\n+  query: string | undefined,\n+  rawMode: boolean,\n+  classificationTerms: string[] | undefined", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18577c53481c6ad7a4f3518c8f5cedc9cbd33ce9"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1Mzg1MjAzOnYy", "diffSide": "RIGHT", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMDowMzo1NVrOHCqujg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMDozODo1NFrOHCrUYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1OTI0Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              const terms: string =\n          \n          \n            \n                \"(\" +\n          \n          \n            \n                classificationTerms.reduce((previousTerm, nextTerm) =>\n          \n          \n            \n                  previousTerm.concat(or, nextTerm)\n          \n          \n            \n                ) +\n          \n          \n            \n                \")\";\n          \n          \n            \n              const terms: string =\n          \n          \n            \n                `(${classificationTerms.join(or)})`;", "url": "https://github.com/openequella/openEQUELLA/pull/2198#discussion_r472559246", "createdAt": "2020-08-19T00:03:55Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "diffHunk": "@@ -106,6 +106,40 @@ export const searchItems = ({\n   return OEQ.Search.search(API_BASE_URL, searchParams);\n };\n \n+/**\n+ * This function processes the query put in the SearchBar and terms selected from Classifications.\n+ * It firstly formats the query based on whether raw mode is on or off.\n+ * If there are no Classifications terms selected, it returns the formatted query.\n+ * Otherwise, it consolidates all terms into one Lucene query by OR, and combines the two queries\n+ * by AND, and return the combined one.\n+ *\n+ * @param query The query put in the SearchBar.\n+ * @param rawMode Whether raw mode is on or off.\n+ * @param classificationTerms A list of selected Classification terms.\n+ */\n+export const processQuery = (\n+  query: string | undefined,\n+  rawMode: boolean,\n+  classificationTerms: string[] | undefined\n+): string | undefined => {\n+  // If query is undefined, then we want to keep 'undefined'; but otherwise let's pre-process it.\n+  const textQuery = query ? formatQuery(query, !rawMode) : undefined;\n+\n+  if (!classificationTerms || classificationTerms.length === 0) {\n+    return textQuery;\n+  }\n+\n+  const or = \" OR \";\n+  const and = \" AND \";\n+  // Each term should be concatenated by 'OR'.\n+  const terms: string =\n+    \"(\" +\n+    classificationTerms.reduce((previousTerm, nextTerm) =>\n+      previousTerm.concat(or, nextTerm)\n+    ) +\n+    \")\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18577c53481c6ad7a4f3518c8f5cedc9cbd33ce9"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU2ODkzMA==", "bodyText": "This is a lot more concise and readable!", "url": "https://github.com/openequella/openEQUELLA/pull/2198#discussion_r472568930", "createdAt": "2020-08-19T00:38:54Z", "author": {"login": "PenghaiZhang"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "diffHunk": "@@ -106,6 +106,40 @@ export const searchItems = ({\n   return OEQ.Search.search(API_BASE_URL, searchParams);\n };\n \n+/**\n+ * This function processes the query put in the SearchBar and terms selected from Classifications.\n+ * It firstly formats the query based on whether raw mode is on or off.\n+ * If there are no Classifications terms selected, it returns the formatted query.\n+ * Otherwise, it consolidates all terms into one Lucene query by OR, and combines the two queries\n+ * by AND, and return the combined one.\n+ *\n+ * @param query The query put in the SearchBar.\n+ * @param rawMode Whether raw mode is on or off.\n+ * @param classificationTerms A list of selected Classification terms.\n+ */\n+export const processQuery = (\n+  query: string | undefined,\n+  rawMode: boolean,\n+  classificationTerms: string[] | undefined\n+): string | undefined => {\n+  // If query is undefined, then we want to keep 'undefined'; but otherwise let's pre-process it.\n+  const textQuery = query ? formatQuery(query, !rawMode) : undefined;\n+\n+  if (!classificationTerms || classificationTerms.length === 0) {\n+    return textQuery;\n+  }\n+\n+  const or = \" OR \";\n+  const and = \" AND \";\n+  // Each term should be concatenated by 'OR'.\n+  const terms: string =\n+    \"(\" +\n+    classificationTerms.reduce((previousTerm, nextTerm) =>\n+      previousTerm.concat(or, nextTerm)\n+    ) +\n+    \")\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1OTI0Ng=="}, "originalCommit": {"oid": "18577c53481c6ad7a4f3518c8f5cedc9cbd33ce9"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1Mzg1NDUwOnYy", "diffSide": "RIGHT", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMDowNToxMlrOHCqv6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMDowNToxMlrOHCqv6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1OTU5NQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              return textQuery ? textQuery.concat(and, terms) : terms;\n          \n          \n            \n              return textQuery ? (textQuery+ and + terms) : terms;", "url": "https://github.com/openequella/openEQUELLA/pull/2198#discussion_r472559595", "createdAt": "2020-08-19T00:05:12Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "diffHunk": "@@ -106,6 +106,40 @@ export const searchItems = ({\n   return OEQ.Search.search(API_BASE_URL, searchParams);\n };\n \n+/**\n+ * This function processes the query put in the SearchBar and terms selected from Classifications.\n+ * It firstly formats the query based on whether raw mode is on or off.\n+ * If there are no Classifications terms selected, it returns the formatted query.\n+ * Otherwise, it consolidates all terms into one Lucene query by OR, and combines the two queries\n+ * by AND, and return the combined one.\n+ *\n+ * @param query The query put in the SearchBar.\n+ * @param rawMode Whether raw mode is on or off.\n+ * @param classificationTerms A list of selected Classification terms.\n+ */\n+export const processQuery = (\n+  query: string | undefined,\n+  rawMode: boolean,\n+  classificationTerms: string[] | undefined\n+): string | undefined => {\n+  // If query is undefined, then we want to keep 'undefined'; but otherwise let's pre-process it.\n+  const textQuery = query ? formatQuery(query, !rawMode) : undefined;\n+\n+  if (!classificationTerms || classificationTerms.length === 0) {\n+    return textQuery;\n+  }\n+\n+  const or = \" OR \";\n+  const and = \" AND \";\n+  // Each term should be concatenated by 'OR'.\n+  const terms: string =\n+    \"(\" +\n+    classificationTerms.reduce((previousTerm, nextTerm) =>\n+      previousTerm.concat(or, nextTerm)\n+    ) +\n+    \")\";\n+  return textQuery ? textQuery.concat(and, terms) : terms;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18577c53481c6ad7a4f3518c8f5cedc9cbd33ce9"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1Mzg1NjY5OnYy", "diffSide": "RIGHT", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMDowNjozMFrOHCqxRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMDowNjozMFrOHCqxRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1OTk0Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * A list of classification terms.\n          \n          \n            \n               * A list of classification terms. (Typically a subset of those generated by Search Facets.)", "url": "https://github.com/openequella/openEQUELLA/pull/2198#discussion_r472559942", "createdAt": "2020-08-19T00:06:30Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "diffHunk": "@@ -147,6 +181,10 @@ export interface SearchOptions {\n    * Filter search results to only include items with the specified statuses.\n    */\n   status?: OEQ.Common.ItemStatus[];\n+  /**\n+   * A list of classification terms.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18577c53481c6ad7a4f3518c8f5cedc9cbd33ce9"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1Mzg1ODU1OnYy", "diffSide": "RIGHT", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMDowNzoyMlrOHCqyUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMDowNzoyMlrOHCqyUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU2MDIxMQ==", "bodyText": "Do we need to use this externally? Can export be removed?", "url": "https://github.com/openequella/openEQUELLA/pull/2198#discussion_r472560211", "createdAt": "2020-08-19T00:07:22Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "diffHunk": "@@ -106,6 +106,40 @@ export const searchItems = ({\n   return OEQ.Search.search(API_BASE_URL, searchParams);\n };\n \n+/**\n+ * This function processes the query put in the SearchBar and terms selected from Classifications.\n+ * It firstly formats the query based on whether raw mode is on or off.\n+ * If there are no Classifications terms selected, it returns the formatted query.\n+ * Otherwise, it consolidates all terms into one Lucene query by OR, and combines the two queries\n+ * by AND, and return the combined one.\n+ *\n+ * @param query The query put in the SearchBar.\n+ * @param rawMode Whether raw mode is on or off.\n+ * @param classificationTerms A list of selected Classification terms.\n+ */\n+export const processQuery = (", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18577c53481c6ad7a4f3518c8f5cedc9cbd33ce9"}, "originalPosition": 30}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1840, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}