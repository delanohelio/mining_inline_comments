{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxOTEzNTk0", "number": 1419, "title": "Create a REST endpoint to handle Cloud Provider Proxy PUT requests;", "bodyText": "#1414 #1413\nChecklist\n\n the [contributor license agreement] is signed\n commit message follows [commit guidelines]\n screenshots are included showing significant UI changes\n\nDescription of change\n\nAdd a new REST endpoint to support PUT requests through Cloud Provider proxy;\nInclude HTTP headers in Cloud Provider proxy (JSESSIONID is dropped).", "createdAt": "2020-01-13T03:29:59Z", "url": "https://github.com/openequella/openEQUELLA/pull/1419", "merged": true, "mergeCommit": {"oid": "1d05d703eae85b563d2605c19bc6ae9ae8eb1a7e"}, "closed": true, "closedAt": "2020-01-14T21:43:31Z", "author": {"login": "PenghaiZhang"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb5zmFRAH2gAyMzYxOTEzNTk0OjExYWNkODAyZWRlZGIyYmViZTM0YTczODEyYTZhMWI5ODMzM2Y1ZWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6K98ngFqTM0MjMxMjY2Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "11acd802ededb2bebe34a73812a6a1b98333f5ec", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/11acd802ededb2bebe34a73812a6a1b98333f5ec", "committedDate": "2020-01-13T03:15:22Z", "message": "Create a REST endpoint to handle Cloud Provider Proxy PUT requests;\nCopy and filter headers, and add headers to the proxied requests;"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNjM0OTg5", "url": "https://github.com/openequella/openEQUELLA/pull/1419#pullrequestreview-341634989", "createdAt": "2020-01-13T04:20:41Z", "commit": {"oid": "11acd802ededb2bebe34a73812a6a1b98333f5ec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QwNDoyMDo0MVrOFctHlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QwNDoyMDo0MVrOFctHlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY0MzY2OQ==", "bodyText": "These methods should be private", "url": "https://github.com/openequella/openEQUELLA/pull/1419#discussion_r365643669", "createdAt": "2020-01-13T04:20:41Z", "author": {"login": "nmkae"}, "path": "Source/Plugins/Core/com.equella.core/scalasrc/com/tle/web/api/wizard/WizardApi.scala", "diffHunk": "@@ -184,6 +184,22 @@ class WizardApi {\n \n   }\n \n+  def getStreamedBody(content: InputStream): Stream[IO, ByteBuffer] = {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11acd802ededb2bebe34a73812a6a1b98333f5ec"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNjM1MjE2", "url": "https://github.com/openequella/openEQUELLA/pull/1419#pullrequestreview-341635216", "createdAt": "2020-01-13T04:22:46Z", "commit": {"oid": "11acd802ededb2bebe34a73812a6a1b98333f5ec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QwNDoyMjo0N1rOFctIbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QwNDoyMjo0N1rOFctIbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY0Mzg4NQ==", "bodyText": "This appears to be the same code as the POST (just with a PUT), the buttons could be consolidated into a simple component", "url": "https://github.com/openequella/openEQUELLA/pull/1419#discussion_r365643885", "createdAt": "2020-01-13T04:22:47Z", "author": {"login": "nmkae"}, "path": "autotest/IntegTester/ps/www/control.tsx", "diffHunk": "@@ -196,6 +196,22 @@ function TestControl(p: ControlApi<MyConfig>) {\n       >\n         Delete Test\n       </button>\n+\n+      <button\n+        onClick={_ => {\n+          const url = p.providerUrl(serviceId) + \"?\" + queryString;\n+          const req = axios.put(url, {\n+            data: serviceContent\n+          });\n+          return req\n+            .then(resp => setServiceResponse(resp.data))\n+            .catch((err: Error) => {\n+              setServiceResponse(err.message);\n+            });\n+        }}\n+      >\n+        Put Test\n+      </button>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11acd802ededb2bebe34a73812a6a1b98333f5ec"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNjM1MzA5", "url": "https://github.com/openequella/openEQUELLA/pull/1419#pullrequestreview-341635309", "createdAt": "2020-01-13T04:23:36Z", "commit": {"oid": "11acd802ededb2bebe34a73812a6a1b98333f5ec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QwNDoyMzozNlrOFctIuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QwNDoyMzozNlrOFctIuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY0Mzk2MA==", "bodyText": "Would be nice to sanity check the headers here", "url": "https://github.com/openequella/openEQUELLA/pull/1419#discussion_r365643960", "createdAt": "2020-01-13T04:23:36Z", "author": {"login": "nmkae"}, "path": "autotest/IntegTester/src/main/scala/integtester/testprovider/TestingCloudProvider.scala", "diffHunk": "@@ -132,6 +132,11 @@ class TestingCloudProvider(implicit val cs: ContextShift[IO]) extends Http4sDsl[\n       req.decode[String] { serviceData =>\n         Ok(ServiceResponse(user, serviceData, req.queryString).asJson)\n       }\n+    case authReq @ PUT -> Root / \"myService\" as user =>\n+      val req = authReq.req\n+      req.decode[String] { serviceData =>\n+        Ok(ServiceResponse(user, serviceData, req.queryString).asJson)\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11acd802ededb2bebe34a73812a6a1b98333f5ec"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNjQzMjgw", "url": "https://github.com/openequella/openEQUELLA/pull/1419#pullrequestreview-341643280", "createdAt": "2020-01-13T05:26:29Z", "commit": {"oid": "11acd802ededb2bebe34a73812a6a1b98333f5ec"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a8d5dd84b11d234942cc3854ea2988ebb81c5e9", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/9a8d5dd84b11d234942cc3854ea2988ebb81c5e9", "committedDate": "2020-01-14T05:57:29Z", "message": "Only drop JSESSION rather than all cookies;\nUse a React component instead of replicated HTML buttons;\nRefactor the Integtester."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMzExMDI5", "url": "https://github.com/openequella/openEQUELLA/pull/1419#pullrequestreview-342311029", "createdAt": "2020-01-14T06:23:17Z", "commit": {"oid": "9a8d5dd84b11d234942cc3854ea2988ebb81c5e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwNjoyMzoxN1rOFdNI2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwNjoyMzoxN1rOFdNI2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE2ODI4Mw==", "bodyText": "Recommend the message states the unexpected cookie name (JSESSIONID) that was found, otherwise it would require tracking down this code to confirm what it really means", "url": "https://github.com/openequella/openEQUELLA/pull/1419#discussion_r366168283", "createdAt": "2020-01-14T06:23:17Z", "author": {"login": "nmkae"}, "path": "autotest/IntegTester/src/main/scala/integtester/testprovider/TestingCloudProvider.scala", "diffHunk": "@@ -127,16 +128,36 @@ class TestingCloudProvider(implicit val cs: ContextShift[IO]) extends Http4sDsl[\n     case req @ POST -> Root / \"itemNotification\" as user =>\n       System.err.println(req.req.queryString)\n       Ok()\n+\n     case authReq @ POST -> Root / \"myService\" as user =>\n-      val req = authReq.req\n+      createResponse(true, authReq.req, user)\n+\n+    case authReq @ PUT -> Root / \"myService\" as user =>\n+      createResponse(true, authReq.req, user)\n+\n+    case authReq @ GET -> Root / \"myService\" as user =>\n+      createResponse(false, authReq.req, user)\n+\n+    case authReq @ DELETE -> Root / \"myService\" as user =>\n+      createResponse(false, authReq.req, user)\n+  }\n+  def createResponse(decode: Boolean, req: Request[IO], user: TestUser): IO[Response[IO]] = {\n+    val cookies = req.headers.get(CaseInsensitiveString(\"cookie\"))\n+\n+    // If header includes cookies then check if JSESSIONID exists; if yes then respond with a bad request.\n+    if (cookies.isDefined) {\n+      val jSessionId = cookies.get.value.split(\";\").exists(value => value.startsWith(\"JSESSIONID\"))\n+      if (jSessionId) {\n+        return BadRequest(\"Unexpected cookie is found.\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a8d5dd84b11d234942cc3854ea2988ebb81c5e9"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6c146e0eb7984a209bc3148bf25229cb2a0d58e", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/c6c146e0eb7984a209bc3148bf25229cb2a0d58e", "committedDate": "2020-01-14T06:26:49Z", "message": "Reword the message of the bad request."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMzEyNjY3", "url": "https://github.com/openequella/openEQUELLA/pull/1419#pullrequestreview-342312667", "createdAt": "2020-01-14T06:29:15Z", "commit": {"oid": "c6c146e0eb7984a209bc3148bf25229cb2a0d58e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 233, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}