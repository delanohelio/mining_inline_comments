{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5MzA3NjU5", "number": 2572, "title": "Feature - Advanced search selector", "bodyText": "Checklist\n\n\n the contributor license agreement is signed\n commit message follows commit guidelines\n tests are included\n screenshots are video is included showing significant UI changes\n documentation is changed or added\n\nDescription of change\n\nAdd a new selector which navigates uses to the legacy Advanced Search UIs (as Advanced Search is not planned to be implemented until 2021.x).\nTo do this, I refactored the RemoteSearchSelector into the generic AuxiliarySearchSelector and then plugged it in. There was also a requirement that it should always be displayed along with the Collections selector, so I also modified that logic in the RefineSearchPanel.\nLastly, due to the support for saved search URLs from legacy UI (using searching.do) requiring logic in the routes, I had to further rework this as Advanced Searches are access by searching.do. This required refactoring out of routes.tsx and into the main router Switch in IndexPage so as to achieve the dynamic nature needed. This seems rather valid, as the route is not strictly New or Legacy, it does a bit of both depending on about three pre-conditions (now).\nThere is still some persistence of state for the Advanced Searches, but if required we can revisit in another PR. Unlike initial Remote Searches though, that persistence has no functional issues. Just a slightly different UX than hoped.\nVideo:\nhttps://streamable.com/ye65ht\n#1306", "createdAt": "2020-11-30T06:09:56Z", "url": "https://github.com/openequella/openEQUELLA/pull/2572", "merged": true, "mergeCommit": {"oid": "0bd50e3afe74984ca2c8ce7c7d15885793706e51"}, "closed": true, "closedAt": "2020-12-01T22:39:46Z", "author": {"login": "edalex-ian"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdhevpiAH2gAyNTI5MzA3NjU5OjY4NTAwMjg2MGNhMGNhOTZiNTU1NmE5MDM5Mzc5Mjc0OGE1ODBjYWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhzzA-gH2gAyNTI5MzA3NjU5OjdhMGEyNzM3Njg5NjhkYzQzNThhODY4NWUyMWRlNGNlNjFiNjc5ZjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "685002860ca0ca96b5556a90393792748a580cad", "author": {"user": {"login": "edalex-ian", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/685002860ca0ca96b5556a90393792748a580cad", "committedDate": "2020-11-30T05:45:56Z", "message": "refactor(front-end): Make RemoteSearchSelector generic\n\nRemoteSearchSelector is the same as what we'll need for Advanced Searches. So change it to a generic component that we can re-use."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5de65baea2add725d0e0bb89f466c68b487edcb8", "author": {"user": {"login": "edalex-ian", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/5de65baea2add725d0e0bb89f466c68b487edcb8", "committedDate": "2020-11-30T05:45:56Z", "message": "feat(front-end): Add ability to navigate to Advanced Searches (from New Search UI)\n\nThis also required a refactor of how we route to the Search page, as it straddles the old and new due to the use of search.do to get to Advanced Searches."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMzc0NjI1", "url": "https://github.com/openequella/openEQUELLA/pull/2572#pullrequestreview-541374625", "createdAt": "2020-11-30T23:24:42Z", "commit": {"oid": "5de65baea2add725d0e0bb89f466c68b487edcb8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxNDEyMDQ4", "url": "https://github.com/openequella/openEQUELLA/pull/2572#pullrequestreview-541412048", "createdAt": "2020-12-01T00:59:38Z", "commit": {"oid": "5de65baea2add725d0e0bb89f466c68b487edcb8"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwMDo1OTozOFrOH8T8cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwMToyOTo1MFrOH8UjXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAwMzM3OA==", "bodyText": "What about adding some comments here to explain the logic ?\nThe logic here in my understanding is: if the current path ends with \"/page/search\", return true; if it doesn't , but if new Search UI is enabled and the request is not for an advanced search, then returns true.\nSo I image that if we turn on new Search and the request is for advanced search, we will see LegacyPage, which is what we want.", "url": "https://github.com/openequella/openEQUELLA/pull/2572#discussion_r533003378", "createdAt": "2020-12-01T00:59:38Z", "author": {"login": "PenghaiZhang"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/mainui/IndexPage.tsx", "diffHunk": "@@ -159,7 +161,35 @@ export default function IndexPage() {\n     setFullPageError(err);\n   }, []);\n \n-  function routeSwitch(content?: PageContent) {\n+  const routeSwitch = (content?: PageContent) => {\n+    const oldSearchPagePath = \"/searching.do\";\n+    const newSearchPagePath = \"/page/search\";\n+\n+    const newOrOldSearch = (location: Location): boolean => {\n+      const currentParams = new URLSearchParams(location.search);\n+      const currentPath = location.pathname;\n+\n+      const advancedSearchParamsPresent: boolean =\n+        currentParams.get(\"in\")?.startsWith(\"P\") ?? false;\n+      const advancedSearchRequested: boolean =\n+        currentPath.endsWith(oldSearchPagePath) && advancedSearchParamsPresent;\n+      const newSearchEnabled: boolean =\n+        typeof renderData !== \"undefined\" && renderData?.newSearch;\n+\n+      return (\n+        currentPath.match(newSearchPagePath) !== null ||\n+        (newSearchEnabled && !advancedSearchRequested)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5de65baea2add725d0e0bb89f466c68b487edcb8"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAwNjA1NA==", "bodyText": "I think that once we remove the switch for newSearchEnabled we need to change here accordingly. Do we need to todo to remind? It's not a big deal though.", "url": "https://github.com/openequella/openEQUELLA/pull/2572#discussion_r533006054", "createdAt": "2020-12-01T01:07:24Z", "author": {"login": "PenghaiZhang"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/mainui/IndexPage.tsx", "diffHunk": "@@ -159,7 +161,35 @@ export default function IndexPage() {\n     setFullPageError(err);\n   }, []);\n \n-  function routeSwitch(content?: PageContent) {\n+  const routeSwitch = (content?: PageContent) => {\n+    const oldSearchPagePath = \"/searching.do\";\n+    const newSearchPagePath = \"/page/search\";\n+\n+    const newOrOldSearch = (location: Location): boolean => {\n+      const currentParams = new URLSearchParams(location.search);\n+      const currentPath = location.pathname;\n+\n+      const advancedSearchParamsPresent: boolean =\n+        currentParams.get(\"in\")?.startsWith(\"P\") ?? false;\n+      const advancedSearchRequested: boolean =\n+        currentPath.endsWith(oldSearchPagePath) && advancedSearchParamsPresent;\n+      const newSearchEnabled: boolean =\n+        typeof renderData !== \"undefined\" && renderData?.newSearch;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5de65baea2add725d0e0bb89f466c68b487edcb8"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAxMzM0Mg==", "bodyText": "I am trying to think what will happen in Selection Session.\nFor example, we are in the My Resources and we click Search, and the URL must be search.do and does not include in. So this function will true. Consequently, SearchPage will get rendered instead of LegacyPage.\nI want to do some testing but I realise this PR is targeting develop...", "url": "https://github.com/openequella/openEQUELLA/pull/2572#discussion_r533013342", "createdAt": "2020-12-01T01:29:50Z", "author": {"login": "PenghaiZhang"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/mainui/IndexPage.tsx", "diffHunk": "@@ -172,17 +202,19 @@ export default function IndexPage() {\n         </Route>\n         {newUIRoutes}\n         <Route\n-          render={(p) => (\n-            <LegacyPage\n-              {...mkRouteProps(p)}\n-              errorCallback={errorCallback}\n-              legacyContent={{ content, setLegacyContentProps }}\n-            />\n-          )}\n+          path={[newSearchPagePath, oldSearchPagePath]}\n+          render={(p) =>\n+            newOrOldSearch(window.location) ? (", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5de65baea2add725d0e0bb89f466c68b487edcb8"}, "originalPosition": 97}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxNDU0MDU2", "url": "https://github.com/openequella/openEQUELLA/pull/2572#pullrequestreview-541454056", "createdAt": "2020-12-01T02:59:41Z", "commit": {"oid": "5de65baea2add725d0e0bb89f466c68b487edcb8"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwMjo1OTo0MVrOH8WR-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwMzowOTowNlrOH8WcUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA0MTY1OA==", "bodyText": "nit: might be good to use mocked uuids in a proper format here.", "url": "https://github.com/openequella/openEQUELLA/pull/2572#discussion_r533041658", "createdAt": "2020-12-01T02:59:41Z", "author": {"login": "SammyIsConfused"}, "path": "Source/Plugins/Core/com.equella.core/js/__mocks__/AdvancedSearchModule.mock.ts", "diffHunk": "@@ -0,0 +1,24 @@\n+/*\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * The Apereo Foundation licenses this file to you under the Apache License,\n+ * Version 2.0, (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+import * as OEQ from \"@openequella/rest-api-client\";\n+\n+export const getAdvancedSearchesFromServerResult: OEQ.Common.BaseEntitySummary[] = [\n+  { name: \"Advanced Search 1\", uuid: \"123\" },", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5de65baea2add725d0e0bb89f466c68b487edcb8"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA0NDAxNA==", "bodyText": "Up to preference, but I'd use less abbreviated titles for acc and cur. Without knowing offhand what RefinePanelControl contains, its hard to know at-a-glance what these are for.  Makes sense with the c on line 90 as it is right next to the controls identifier, but here its a bit more opaque.", "url": "https://github.com/openequella/openEQUELLA/pull/2572#discussion_r533044014", "createdAt": "2020-12-01T03:07:49Z", "author": {"login": "SammyIsConfused"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/RefineSearchPanel.tsx", "diffHunk": "@@ -79,9 +83,24 @@ export const RefineSearchPanel = ({\n \n   const { showMore, showLess } = languageStrings.common.action;\n \n-  const [alwaysVisibleControl, ...collapsedControls] = controls.filter(\n-    (c) => !c.disabled\n-  );\n+  const {\n+    visible: alwaysVisibleControls,\n+    collapsed: collapsedControls,\n+  } = controls\n+    .filter((c) => !c.disabled)\n+    .reduce(\n+      (acc, cur: RefinePanelControl) => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5de65baea2add725d0e0bb89f466c68b487edcb8"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA0NDMwNA==", "bodyText": "Are we forgoing the general rule for openEquella strings only being capitalized on the first word for Advanced and Remote search? If not, this should be changed to \"Access advanced searches\".", "url": "https://github.com/openequella/openEQUELLA/pull/2572#discussion_r533044304", "createdAt": "2020-12-01T03:09:06Z", "author": {"login": "SammyIsConfused"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/util/langstrings.ts", "diffHunk": "@@ -379,6 +379,9 @@ export const languageStrings = {\n     refineSearchPanel: {\n       title: \"Refine search\",\n     },\n+    advancedSearchSelector: {\n+      title: \"Access Advanced searches\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5de65baea2add725d0e0bb89f466c68b487edcb8"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76ec7ccb9be5e17c305280d67521e1233270f4d9", "author": {"user": {"login": "edalex-ian", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/76ec7ccb9be5e17c305280d67521e1233270f4d9", "committedDate": "2020-12-01T05:44:43Z", "message": "Merge branch 'develop' into feature/advanced_search_selector"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b42d52a19155ad5e6cb4e0623f2c94bf7096ab5", "author": {"user": {"login": "edalex-ian", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/1b42d52a19155ad5e6cb4e0623f2c94bf7096ab5", "committedDate": "2020-12-01T06:10:56Z", "message": "chore(front-end): Add documentation for route switch\n\nThere's a bit of complexity as to when and how to trigger the New Search page due to straddling the old and new modes for other search related features. So here I attempt to capture that for easier reading.\n\nFeedback from PR #2572"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a0a273768968dc4358a8685e21de4ce61b679f2", "author": {"user": {"login": "edalex-ian", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/7a0a273768968dc4358a8685e21de4ce61b679f2", "committedDate": "2020-12-01T06:17:37Z", "message": "chore(front-end): Use real UUIDs in mocks\n\nFeedback from PR #2572"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 276, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}