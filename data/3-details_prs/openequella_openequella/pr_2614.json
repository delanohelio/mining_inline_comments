{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxNTkyOTM2", "number": 2614, "title": "Bugfix/search portlet do not support new search UI", "bodyText": "Checklist\n\n the [contributor license agreement][] is signed\n commit message follows [commit guidelines][]\n tests are included\n screenshots are included showing significant UI changes\n documentation is changed or added\n\nDescription of change\nCurrently, when a search is triggered from quick search in Selection Session, the endpoint is not selectoradd/searching.do. This will result in showing the regular page in Selection Session. So we need to change the endpoint.\nAlso, in order to pass the search query to new search UI, we need to\n\nenable the feature of converting query strings to search options in Selection Session;\nappend the query to the URL.\n\nWhen I was testing,  I noticed that converting query strings to search options is not quite compatible with back to search page. The issue is if back to a search URL which has query strings, the search option stored in browser history is ignored.\nSo overall, this PR fixes above issue and make quick search work fine with new search UI.\nquick search in regular page\nquick search in resource selector", "createdAt": "2020-12-17T04:28:07Z", "url": "https://github.com/openequella/openEQUELLA/pull/2614", "merged": true, "mergeCommit": {"oid": "7e3d51db8d824abf698ec8df3fa0398d65dd7131"}, "closed": true, "closedAt": "2020-12-18T03:59:16Z", "author": {"login": "PenghaiZhang"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdm5N62gH2gAyNTQxNTkyOTM2OmZkZGE5ODc2NTExMjcxOTI1YmNmOTQ5NzFjMGY3ODk1NjAxOTA3ZDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnOdghgFqTU1NTEyNjA2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fdda9876511271925bcf94971c0f7895601907d2", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/fdda9876511271925bcf94971c0f7895601907d2", "committedDate": "2020-12-17T01:26:09Z", "message": "Support quick search portlet for new Search UI."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e55578829e609d5bfc0b6683145cd102233995c", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/4e55578829e609d5bfc0b6683145cd102233995c", "committedDate": "2020-12-17T02:16:41Z", "message": "Support converting query strings to search options\nin Selection Session."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea13a660c7922a517f46765b8773a9b5f687df7b", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/ea13a660c7922a517f46765b8773a9b5f687df7b", "committedDate": "2020-12-17T03:50:19Z", "message": "Don't convert query strings to search option\nif there is a search option in history."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71cc4ce767494e3fc2235d38fe27d59d05b40ef6", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/71cc4ce767494e3fc2235d38fe27d59d05b40ef6", "committedDate": "2020-12-17T22:53:12Z", "message": "Don't manipulate browser history for the initial search\nif the search option is the default one."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1MDUzNTAx", "url": "https://github.com/openequella/openEQUELLA/pull/2614#pullrequestreview-555053501", "createdAt": "2020-12-17T22:58:06Z", "commit": {"oid": "71cc4ce767494e3fc2235d38fe27d59d05b40ef6"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QyMjo1ODowNlrOIIMKJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QyMjo1OTo1MlrOIIMM_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ1ODcyNQ==", "bodyText": "Without this library, TS complains that the function keys() does not exist in URLSearchParams.", "url": "https://github.com/openequella/openEQUELLA/pull/2614#discussion_r545458725", "createdAt": "2020-12-17T22:58:06Z", "author": {"login": "PenghaiZhang"}, "path": "Source/Plugins/Core/com.equella.core/js/tsconfig.json", "diffHunk": "@@ -4,7 +4,7 @@\n     \"module\": \"CommonJS\",\n     \"esModuleInterop\": true,\n     \"target\": \"es5\",\n-    \"lib\": [\"es2020\", \"dom\"],\n+    \"lib\": [\"es2020\", \"dom\", \"dom.iterable\"],", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71cc4ce767494e3fc2235d38fe27d59d05b40ef6"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ1OTQ1Mg==", "bodyText": "As I need to use the standard Array, I need to rename this Runtype Array.", "url": "https://github.com/openequella/openEQUELLA/pull/2614#discussion_r545459452", "createdAt": "2020-12-17T22:59:52Z", "author": {"login": "PenghaiZhang"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "diffHunk": "@@ -20,7 +20,7 @@ import * as OEQ from \"@openequella/rest-api-client\";\n import { Location } from \"history\";\n import { pick } from \"lodash\";\n import {\n-  Array,\n+  Array as RuntypeArray,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71cc4ce767494e3fc2235d38fe27d59d05b40ef6"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1MDYzOTU3", "url": "https://github.com/openequella/openEQUELLA/pull/2614#pullrequestreview-555063957", "createdAt": "2020-12-17T23:16:18Z", "commit": {"oid": "71cc4ce767494e3fc2235d38fe27d59d05b40ef6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QyMzoxNjoxOFrOIIMsFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QyMzoxNjoxOFrOIIMsFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ2NzQxNQ==", "bodyText": "do we know the state will be this shape for certain?\nWould a runtype make sense here?", "url": "https://github.com/openequella/openEQUELLA/pull/2614#discussion_r545467415", "createdAt": "2020-12-17T23:16:18Z", "author": {"login": "ChristianMurphy"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/SearchPage.tsx", "diffHunk": "@@ -121,15 +120,16 @@ const SearchPage = ({ updateTemplate }: TemplateUpdateProps) => {\n     searchPageOptions: defaultSearchPageOptions,\n     filterExpansion: false,\n   };\n-\n+  const searchPageHistoryState: SearchPageHistoryState | undefined = history\n+    .location.state as SearchPageHistoryState;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71cc4ce767494e3fc2235d38fe27d59d05b40ef6"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1MDc5Nzk0", "url": "https://github.com/openequella/openEQUELLA/pull/2614#pullrequestreview-555079794", "createdAt": "2020-12-17T23:54:27Z", "commit": {"oid": "71cc4ce767494e3fc2235d38fe27d59d05b40ef6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QyMzo1NDoyN1rOIINmeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMDoxNDowOFrOIIOBlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ4MjM2MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  // If the search option already exists, don't do query string conversion.\n          \n          \n            \n                  // If the search options are available from browser history, ignore those in the query string", "url": "https://github.com/openequella/openEQUELLA/pull/2614#discussion_r545482361", "createdAt": "2020-12-17T23:54:27Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/SearchPage.tsx", "diffHunk": "@@ -158,8 +158,8 @@ const SearchPage = ({ updateTemplate }: TemplateUpdateProps) => {\n \n     Promise.all([\n       getSearchSettingsFromServer(),\n-      // Do not convert query string params to search options in Selection Session.\n-      isSelectionSessionOpen()\n+      // If the search option already exists, don't do query string conversion.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71cc4ce767494e3fc2235d38fe27d59d05b40ef6"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ4MzE1NA==", "bodyText": "We have a few comments like this scattered around the place, what's really missing though is the why. Could you please add that here.", "url": "https://github.com/openequella/openEQUELLA/pull/2614#discussion_r545483154", "createdAt": "2020-12-17T23:56:33Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/SearchPage.tsx", "diffHunk": "@@ -197,10 +197,16 @@ const SearchPage = ({ updateTemplate }: TemplateUpdateProps) => {\n   }, [searchPageOptions]);\n \n   useEffect(() => {\n-    history.replace({\n-      ...history.location,\n-      state: { searchPageOptions, filterExpansion },\n-    });\n+    // Don't manipulate the history for the initial search if the search\n+    // option is the default one.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71cc4ce767494e3fc2235d38fe27d59d05b40ef6"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ4OTMwMw==", "bodyText": "As discussed, probably want to rework to this rough idea - maybe need try/catch too.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                String basicUrl = info.getPublicBookmark().getHref();\n          \n          \n            \n            \n          \n          \n            \n                String queryString = ((InfoBookmark) info.getPublicBookmark()).getQuery();\n          \n          \n            \n                if (queryString.isEmpty()) {\n          \n          \n            \n                  basicUrl = basicUrl + \"?\";\n          \n          \n            \n                }\n          \n          \n            \n                from.forwardToUrl(basicUrl + \"&q=\" + query);\n          \n          \n            \n                URL basicUrl = new URL(info.getPublicBookmark().getHref());\n          \n          \n            \n                \n          \n          \n            \n                from.forwardToURL(\n          \n          \n            \n                  basicUrl.toString()\n          \n          \n            \n                  + (basicUrl.getQuery().isEmpty() ? \"?\" : \"&\")\n          \n          \n            \n                  + \"q=\" + query));", "url": "https://github.com/openequella/openEQUELLA/pull/2614#discussion_r545489303", "createdAt": "2020-12-18T00:14:08Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/src/com/tle/web/searching/section/SearchQuerySection.java", "diffHunk": "@@ -623,6 +623,22 @@ private void doBasicSearch(SectionInfo info, String query) {\n     searchResults.startSearch(info);\n   }\n \n+  public static void basicSearchForNewSearch(\n+      SectionInfo from, String query, boolean inSelectOrAdd) {\n+    // In selectOrAdd the endpoint is '/selectoradd/searching.do'.\n+    SectionInfo info =\n+        inSelectOrAdd\n+            ? from.createForward(SearchSelectable.NEW_FORWARD_PATH)\n+            : RootSearchSection.createForward(from);\n+    String basicUrl = info.getPublicBookmark().getHref();\n+\n+    String queryString = ((InfoBookmark) info.getPublicBookmark()).getQuery();\n+    if (queryString.isEmpty()) {\n+      basicUrl = basicUrl + \"?\";\n+    }\n+    from.forwardToUrl(basicUrl + \"&q=\" + query);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71cc4ce767494e3fc2235d38fe27d59d05b40ef6"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bbe18b300292c0d1600f5ee7d583b583262d72b", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/3bbe18b300292c0d1600f5ee7d583b583262d72b", "committedDate": "2020-12-18T00:46:37Z", "message": "Tidy up SearchPage comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89cf9d94d0bc4332f0ce92f637dc4b448c488465", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/89cf9d94d0bc4332f0ce92f637dc4b448c488465", "committedDate": "2020-12-18T01:25:16Z", "message": "Properly generate URL for endpoint '/selectoradd/searching.do'."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1MTEyMDc2", "url": "https://github.com/openequella/openEQUELLA/pull/2614#pullrequestreview-555112076", "createdAt": "2020-12-18T01:27:46Z", "commit": {"oid": "89cf9d94d0bc4332f0ce92f637dc4b448c488465"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMToyNzo0NlrOIIPgIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMToyNzo0NlrOIIPgIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUxMzUwNg==", "bodyText": "with the return, else is not needed\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  return;\n          \n          \n            \n                } else {\n          \n          \n            \n                  history.replace({\n          \n          \n            \n                    ...history.location,\n          \n          \n            \n                    state: { searchPageOptions, filterExpansion },\n          \n          \n            \n                  });\n          \n          \n            \n                }\n          \n          \n            \n                  return;\n          \n          \n            \n                }\n          \n          \n            \n                history.replace({\n          \n          \n            \n                  ...history.location,\n          \n          \n            \n                  state: { searchPageOptions, filterExpansion },\n          \n          \n            \n                });", "url": "https://github.com/openequella/openEQUELLA/pull/2614#discussion_r545513506", "createdAt": "2020-12-18T01:27:46Z", "author": {"login": "ChristianMurphy"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/SearchPage.tsx", "diffHunk": "@@ -197,10 +197,19 @@ const SearchPage = ({ updateTemplate }: TemplateUpdateProps) => {\n   }, [searchPageOptions]);\n \n   useEffect(() => {\n-    history.replace({\n-      ...history.location,\n-      state: { searchPageOptions, filterExpansion },\n-    });\n+    // If search page is open from a URL which has some query params, updating browser\n+    // history for the initial search will produce wrong search option for the second\n+    // render. This is because in the second render, we ignore the query param conversion\n+    // as the history data has higher priority. So the end result is wrong search options\n+    // are displayed in the page.\n+    if (isInitialSearch && searchPageOptions === defaultSearchPageOptions) {\n+      return;\n+    } else {\n+      history.replace({\n+        ...history.location,\n+        state: { searchPageOptions, filterExpansion },\n+      });\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89cf9d94d0bc4332f0ce92f637dc4b448c488465"}, "originalPosition": 59}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afb39b65c3b4e2dd258c90f9542f6b4936afc101", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/afb39b65c3b4e2dd258c90f9542f6b4936afc101", "committedDate": "2020-12-18T02:08:13Z", "message": "Remove unneeded else block for history update.\n\nCo-authored-by: Christian Murphy <christian.murphy.42@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1MTI2MDY4", "url": "https://github.com/openequella/openEQUELLA/pull/2614#pullrequestreview-555126068", "createdAt": "2020-12-18T02:11:11Z", "commit": {"oid": "afb39b65c3b4e2dd258c90f9542f6b4936afc101"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 314, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}