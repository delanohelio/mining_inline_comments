{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3MTQyNjA0", "number": 1728, "title": "Add functionality of editing and deleting facets", "bodyText": "#1337\nChecklist\n\n\n the [contributor license agreement] is signed\n commit message follows [commit guidelines]\n tests are included\n screenshots are included showing significant UI changes\n documentation is changed or added\n\nDescription of change\nRefactor Faceted search setting page to support editing and deleting facets.\nAdd a Jest test for this page.\nAdd a story for a new component FacetDialog.", "createdAt": "2020-05-13T06:17:46Z", "url": "https://github.com/openequella/openEQUELLA/pull/1728", "merged": true, "mergeCommit": {"oid": "f28daefde1b06e7ff4a8d2a85dd97a4fb3105b07"}, "closed": true, "closedAt": "2020-05-15T01:19:48Z", "author": {"login": "PenghaiZhang"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgamSwgH2gAyNDE3MTQyNjA0OjYyMzlhMDMxMDg1OGMzYjU1N2E2NWNjMzJkOTEzOWY3ZjFiODhmMmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchXhYwAFqTQxMjI4Mzc1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6239a0310858c3b557a65cc32d9139f7f1b88f2c", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/6239a0310858c3b557a65cc32d9139f7f1b88f2c", "committedDate": "2020-05-12T02:11:01Z", "message": "Add functionality of editing and deleting facets to Facet setting page;\n\nRefactor the Facet dialog for editing facets;\n\nWhen save changes, create two promises: one for update and the other for\ndelete. If both get resolved, show a dialog or snackbar depending on their\n207 responses."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86a8d084e874d52b1b215885514e5ae8c1aaf7dc", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/86a8d084e874d52b1b215885514e5ae8c1aaf7dc", "committedDate": "2020-05-12T07:05:05Z", "message": "Add a story for FacetDialog;"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "739b48533615afc3e7996d7feb37bfe7a059900a", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/739b48533615afc3e7996d7feb37bfe7a059900a", "committedDate": "2020-05-13T06:08:28Z", "message": "Add a Jest test for Faceted search setting page."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "438e4d8fd5a112737f9980910272eca0d5895bb5", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/438e4d8fd5a112737f9980910272eca0d5895bb5", "committedDate": "2020-05-13T06:09:24Z", "message": "Address MUI warnings caused by MessageDialog."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNjcyODQ3", "url": "https://github.com/openequella/openEQUELLA/pull/1728#pullrequestreview-410672847", "createdAt": "2020-05-13T07:52:02Z", "commit": {"oid": "438e4d8fd5a112737f9980910272eca0d5895bb5"}, "state": "APPROVED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNzo1MjowM1rOGUlnOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwODowNToxN1rOGUmFwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI0MDk1NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Remove the boolean flags and then save to the Server.\n          \n          \n            \n             * Remove the flags and then save to the server.", "url": "https://github.com/openequella/openEQUELLA/pull/1728#discussion_r424240955", "createdAt": "2020-05-13T07:52:03Z", "author": {"login": "SammyIsConfused"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/settings/Search/facetedsearch/FacetedSearchSettingsModule.ts", "diffHunk": "@@ -60,12 +65,19 @@ export const getFacetsFromServer = (): Promise<Facet[]> =>\n /**\n  * Remove the boolean flags and then save to the Server.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "438e4d8fd5a112737f9980910272eca0d5895bb5"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI0MjEzOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                describe(\"when the Save button is enabled and click it\", () => {\n          \n          \n            \n                describe(\"when the Save button is enabled and clicked\", () => {", "url": "https://github.com/openequella/openEQUELLA/pull/1728#discussion_r424242139", "createdAt": "2020-05-13T07:53:54Z", "author": {"login": "SammyIsConfused"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/mainui/FacetedSearchSettingsPage.test.tsx", "diffHunk": "@@ -0,0 +1,199 @@\n+/*\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * The Apereo Foundation licenses this file to you under the Apache License,\n+ * Version 2.0, (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+import * as React from \"react\";\n+import { mount, ReactWrapper } from \"enzyme\";\n+import FacetedSearchSettingsPage from \"../../../tsrc/settings/Search/facetedsearch/FacetedSearchSettingsPage\";\n+import * as FacetedSearchSettingsModule from \"../../../tsrc/settings/Search/facetedsearch/FacetedSearchSettingsModule\";\n+import { NavigationGuardProps } from \"../../../tsrc/components/NavigationGuard\";\n+import { act } from \"react-dom/test-utils\";\n+import FacetDialog from \"../../../tsrc/settings/Search/facetedsearch/FacetDialog\";\n+import MessageInfo from \"../../../tsrc/components/MessageInfo\";\n+import MessageDialog from \"../../../tsrc/components/MessageDialog\";\n+\n+const mockFacets: FacetedSearchSettingsModule.Facet[] = [\n+  {\n+    id: 1,\n+    name: \"mocked facet1\",\n+    schemaNode: \"item/name\",\n+    maxResults: 1,\n+    orderIndex: 1,\n+  },\n+  {\n+    id: 2,\n+    name: \"mocked facet3\",\n+    schemaNode: \"item/age\",\n+    maxResults: 2,\n+    orderIndex: 2,\n+  },\n+];\n+\n+// This test does not need NavigationGuard which is part of the Setting page template.\n+jest.mock(\"../../../tsrc/components/NavigationGuard\", () => ({\n+  NavigationGuard: (props: NavigationGuardProps) => {\n+    return <div />;\n+  },\n+}));\n+\n+const mockGetFacetsFromServer = jest.spyOn(\n+  FacetedSearchSettingsModule,\n+  \"getFacetsFromServer\"\n+);\n+const mockBatchDelete = jest.spyOn(FacetedSearchSettingsModule, \"batchDelete\");\n+const mockBatchUpdateOrAdd = jest.spyOn(\n+  FacetedSearchSettingsModule,\n+  \"batchUpdateOrAdd\"\n+);\n+\n+describe(\"<FacetedSearchSettingsPage />\", () => {\n+  let component: ReactWrapper;\n+  beforeEach(async () => {\n+    const getFacetsPromise = mockGetFacetsFromServer.mockImplementation(() =>\n+      Promise.resolve(mockFacets)\n+    );\n+    component = mount(<FacetedSearchSettingsPage updateTemplate={jest.fn()} />);\n+    await act(async () => {\n+      await getFacetsPromise;\n+    });\n+    component.update();\n+  });\n+  afterEach(() => jest.clearAllMocks());\n+\n+  describe(\"when the page is mounted\", () => {\n+    const getListItems = () => component.find(\".MuiListItem-container\");\n+    const getSaveButton = () => component.find(\"#_saveButton\").hostNodes();\n+    const deleteFacet = () => {\n+      const deleteButton = getListItems().at(0).find(\"button\").at(1);\n+      deleteButton.simulate(\"click\");\n+    };\n+    const updateFacet = (addOrEdit: boolean) => {\n+      const fields = component.find(\"input\");\n+      fields.at(0).simulate(\"change\", {\n+        target: { value: addOrEdit ? \"new facet\" : \"updated facet\" },\n+      });\n+      fields.at(1).simulate(\"change\", { target: { value: \"item/name/first\" } });\n+      const okButton = component\n+        .findWhere(\n+          (node) =>\n+            node.text() === (addOrEdit ? \"Add\" : \"OK\") &&\n+            node.type() === \"button\"\n+        )\n+        .hostNodes();\n+      okButton.simulate(\"click\");\n+    };\n+    const openDialog = (addOrEdit: boolean) => {\n+      let button: ReactWrapper;\n+      if (addOrEdit) {\n+        button = component.find(\".MuiCardActions-root button\");\n+      } else {\n+        button = getListItems().at(0).find(\"button\").at(0);\n+      }\n+      button.simulate(\"click\");\n+    };\n+\n+    it(\"should fetch facets\", () => {\n+      expect(\n+        FacetedSearchSettingsModule.getFacetsFromServer\n+      ).toHaveBeenCalledTimes(1);\n+    });\n+\n+    it(\"should display a list of facets\", () => {\n+      expect(getListItems()).toHaveLength(2);\n+    });\n+\n+    describe(\"when click an Edit button\", () => {\n+      it(\"should show a dialog\", async () => {\n+        openDialog(false);\n+        expect(component.find(FacetDialog).prop(\"open\")).toBeTruthy();\n+      });\n+    });\n+\n+    describe(\"when click the Add button\", () => {\n+      it(\"should show a dialog\", async () => {\n+        openDialog(true);\n+        expect(component.find(FacetDialog).prop(\"open\")).toBeTruthy();\n+      });\n+    });\n+\n+    describe(\"when click a delete button\", () => {\n+      it(\"should remove a facet from the list and enable the Save button\", () => {\n+        deleteFacet();\n+        const items = getListItems();\n+        expect(items).toHaveLength(1);\n+        expect(getSaveButton().prop(\"disabled\")).toBeFalsy();\n+      });\n+    });\n+\n+    describe(\"when edit a facet through the dialog\", () => {\n+      it(\"should show the updated facet and enable the Save button\", () => {\n+        openDialog(false);\n+        updateFacet(false);\n+        const items = getListItems();\n+        expect(items).toHaveLength(2);\n+        expect(items.at(0).text()).toContain(\"updated facet\");\n+        expect(getSaveButton().prop(\"disabled\")).toBeFalsy();\n+      });\n+    });\n+\n+    describe(\"when add a new facet through the dialog\", () => {\n+      it(\"should add the facet to the list and enable the Save button\", () => {\n+        openDialog(true);\n+        updateFacet(true);\n+        const items = getListItems();\n+        expect(items).toHaveLength(3);\n+        expect(items.at(2).text()).toContain(\"new facet\");\n+        expect(getSaveButton().prop(\"disabled\")).toBeFalsy();\n+      });\n+    });\n+\n+    describe(\"when the Save button is enabled and click it\", () => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "438e4d8fd5a112737f9980910272eca0d5895bb5"}, "originalPosition": 163}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI0MjQ2Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                describe(\"when add a new facet through the dialog\", () => {\n          \n          \n            \n                describe(\"when a new facet is added through the dialog\", () => {", "url": "https://github.com/openequella/openEQUELLA/pull/1728#discussion_r424242467", "createdAt": "2020-05-13T07:54:29Z", "author": {"login": "SammyIsConfused"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/mainui/FacetedSearchSettingsPage.test.tsx", "diffHunk": "@@ -0,0 +1,199 @@\n+/*\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * The Apereo Foundation licenses this file to you under the Apache License,\n+ * Version 2.0, (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+import * as React from \"react\";\n+import { mount, ReactWrapper } from \"enzyme\";\n+import FacetedSearchSettingsPage from \"../../../tsrc/settings/Search/facetedsearch/FacetedSearchSettingsPage\";\n+import * as FacetedSearchSettingsModule from \"../../../tsrc/settings/Search/facetedsearch/FacetedSearchSettingsModule\";\n+import { NavigationGuardProps } from \"../../../tsrc/components/NavigationGuard\";\n+import { act } from \"react-dom/test-utils\";\n+import FacetDialog from \"../../../tsrc/settings/Search/facetedsearch/FacetDialog\";\n+import MessageInfo from \"../../../tsrc/components/MessageInfo\";\n+import MessageDialog from \"../../../tsrc/components/MessageDialog\";\n+\n+const mockFacets: FacetedSearchSettingsModule.Facet[] = [\n+  {\n+    id: 1,\n+    name: \"mocked facet1\",\n+    schemaNode: \"item/name\",\n+    maxResults: 1,\n+    orderIndex: 1,\n+  },\n+  {\n+    id: 2,\n+    name: \"mocked facet3\",\n+    schemaNode: \"item/age\",\n+    maxResults: 2,\n+    orderIndex: 2,\n+  },\n+];\n+\n+// This test does not need NavigationGuard which is part of the Setting page template.\n+jest.mock(\"../../../tsrc/components/NavigationGuard\", () => ({\n+  NavigationGuard: (props: NavigationGuardProps) => {\n+    return <div />;\n+  },\n+}));\n+\n+const mockGetFacetsFromServer = jest.spyOn(\n+  FacetedSearchSettingsModule,\n+  \"getFacetsFromServer\"\n+);\n+const mockBatchDelete = jest.spyOn(FacetedSearchSettingsModule, \"batchDelete\");\n+const mockBatchUpdateOrAdd = jest.spyOn(\n+  FacetedSearchSettingsModule,\n+  \"batchUpdateOrAdd\"\n+);\n+\n+describe(\"<FacetedSearchSettingsPage />\", () => {\n+  let component: ReactWrapper;\n+  beforeEach(async () => {\n+    const getFacetsPromise = mockGetFacetsFromServer.mockImplementation(() =>\n+      Promise.resolve(mockFacets)\n+    );\n+    component = mount(<FacetedSearchSettingsPage updateTemplate={jest.fn()} />);\n+    await act(async () => {\n+      await getFacetsPromise;\n+    });\n+    component.update();\n+  });\n+  afterEach(() => jest.clearAllMocks());\n+\n+  describe(\"when the page is mounted\", () => {\n+    const getListItems = () => component.find(\".MuiListItem-container\");\n+    const getSaveButton = () => component.find(\"#_saveButton\").hostNodes();\n+    const deleteFacet = () => {\n+      const deleteButton = getListItems().at(0).find(\"button\").at(1);\n+      deleteButton.simulate(\"click\");\n+    };\n+    const updateFacet = (addOrEdit: boolean) => {\n+      const fields = component.find(\"input\");\n+      fields.at(0).simulate(\"change\", {\n+        target: { value: addOrEdit ? \"new facet\" : \"updated facet\" },\n+      });\n+      fields.at(1).simulate(\"change\", { target: { value: \"item/name/first\" } });\n+      const okButton = component\n+        .findWhere(\n+          (node) =>\n+            node.text() === (addOrEdit ? \"Add\" : \"OK\") &&\n+            node.type() === \"button\"\n+        )\n+        .hostNodes();\n+      okButton.simulate(\"click\");\n+    };\n+    const openDialog = (addOrEdit: boolean) => {\n+      let button: ReactWrapper;\n+      if (addOrEdit) {\n+        button = component.find(\".MuiCardActions-root button\");\n+      } else {\n+        button = getListItems().at(0).find(\"button\").at(0);\n+      }\n+      button.simulate(\"click\");\n+    };\n+\n+    it(\"should fetch facets\", () => {\n+      expect(\n+        FacetedSearchSettingsModule.getFacetsFromServer\n+      ).toHaveBeenCalledTimes(1);\n+    });\n+\n+    it(\"should display a list of facets\", () => {\n+      expect(getListItems()).toHaveLength(2);\n+    });\n+\n+    describe(\"when click an Edit button\", () => {\n+      it(\"should show a dialog\", async () => {\n+        openDialog(false);\n+        expect(component.find(FacetDialog).prop(\"open\")).toBeTruthy();\n+      });\n+    });\n+\n+    describe(\"when click the Add button\", () => {\n+      it(\"should show a dialog\", async () => {\n+        openDialog(true);\n+        expect(component.find(FacetDialog).prop(\"open\")).toBeTruthy();\n+      });\n+    });\n+\n+    describe(\"when click a delete button\", () => {\n+      it(\"should remove a facet from the list and enable the Save button\", () => {\n+        deleteFacet();\n+        const items = getListItems();\n+        expect(items).toHaveLength(1);\n+        expect(getSaveButton().prop(\"disabled\")).toBeFalsy();\n+      });\n+    });\n+\n+    describe(\"when edit a facet through the dialog\", () => {\n+      it(\"should show the updated facet and enable the Save button\", () => {\n+        openDialog(false);\n+        updateFacet(false);\n+        const items = getListItems();\n+        expect(items).toHaveLength(2);\n+        expect(items.at(0).text()).toContain(\"updated facet\");\n+        expect(getSaveButton().prop(\"disabled\")).toBeFalsy();\n+      });\n+    });\n+\n+    describe(\"when add a new facet through the dialog\", () => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "438e4d8fd5a112737f9980910272eca0d5895bb5"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI0Mjg3OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                describe(\"when edit a facet through the dialog\", () => {\n          \n          \n            \n                describe(\"when a facet is edited through the dialog\", () => {", "url": "https://github.com/openequella/openEQUELLA/pull/1728#discussion_r424242879", "createdAt": "2020-05-13T07:55:10Z", "author": {"login": "SammyIsConfused"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/mainui/FacetedSearchSettingsPage.test.tsx", "diffHunk": "@@ -0,0 +1,199 @@\n+/*\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * The Apereo Foundation licenses this file to you under the Apache License,\n+ * Version 2.0, (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+import * as React from \"react\";\n+import { mount, ReactWrapper } from \"enzyme\";\n+import FacetedSearchSettingsPage from \"../../../tsrc/settings/Search/facetedsearch/FacetedSearchSettingsPage\";\n+import * as FacetedSearchSettingsModule from \"../../../tsrc/settings/Search/facetedsearch/FacetedSearchSettingsModule\";\n+import { NavigationGuardProps } from \"../../../tsrc/components/NavigationGuard\";\n+import { act } from \"react-dom/test-utils\";\n+import FacetDialog from \"../../../tsrc/settings/Search/facetedsearch/FacetDialog\";\n+import MessageInfo from \"../../../tsrc/components/MessageInfo\";\n+import MessageDialog from \"../../../tsrc/components/MessageDialog\";\n+\n+const mockFacets: FacetedSearchSettingsModule.Facet[] = [\n+  {\n+    id: 1,\n+    name: \"mocked facet1\",\n+    schemaNode: \"item/name\",\n+    maxResults: 1,\n+    orderIndex: 1,\n+  },\n+  {\n+    id: 2,\n+    name: \"mocked facet3\",\n+    schemaNode: \"item/age\",\n+    maxResults: 2,\n+    orderIndex: 2,\n+  },\n+];\n+\n+// This test does not need NavigationGuard which is part of the Setting page template.\n+jest.mock(\"../../../tsrc/components/NavigationGuard\", () => ({\n+  NavigationGuard: (props: NavigationGuardProps) => {\n+    return <div />;\n+  },\n+}));\n+\n+const mockGetFacetsFromServer = jest.spyOn(\n+  FacetedSearchSettingsModule,\n+  \"getFacetsFromServer\"\n+);\n+const mockBatchDelete = jest.spyOn(FacetedSearchSettingsModule, \"batchDelete\");\n+const mockBatchUpdateOrAdd = jest.spyOn(\n+  FacetedSearchSettingsModule,\n+  \"batchUpdateOrAdd\"\n+);\n+\n+describe(\"<FacetedSearchSettingsPage />\", () => {\n+  let component: ReactWrapper;\n+  beforeEach(async () => {\n+    const getFacetsPromise = mockGetFacetsFromServer.mockImplementation(() =>\n+      Promise.resolve(mockFacets)\n+    );\n+    component = mount(<FacetedSearchSettingsPage updateTemplate={jest.fn()} />);\n+    await act(async () => {\n+      await getFacetsPromise;\n+    });\n+    component.update();\n+  });\n+  afterEach(() => jest.clearAllMocks());\n+\n+  describe(\"when the page is mounted\", () => {\n+    const getListItems = () => component.find(\".MuiListItem-container\");\n+    const getSaveButton = () => component.find(\"#_saveButton\").hostNodes();\n+    const deleteFacet = () => {\n+      const deleteButton = getListItems().at(0).find(\"button\").at(1);\n+      deleteButton.simulate(\"click\");\n+    };\n+    const updateFacet = (addOrEdit: boolean) => {\n+      const fields = component.find(\"input\");\n+      fields.at(0).simulate(\"change\", {\n+        target: { value: addOrEdit ? \"new facet\" : \"updated facet\" },\n+      });\n+      fields.at(1).simulate(\"change\", { target: { value: \"item/name/first\" } });\n+      const okButton = component\n+        .findWhere(\n+          (node) =>\n+            node.text() === (addOrEdit ? \"Add\" : \"OK\") &&\n+            node.type() === \"button\"\n+        )\n+        .hostNodes();\n+      okButton.simulate(\"click\");\n+    };\n+    const openDialog = (addOrEdit: boolean) => {\n+      let button: ReactWrapper;\n+      if (addOrEdit) {\n+        button = component.find(\".MuiCardActions-root button\");\n+      } else {\n+        button = getListItems().at(0).find(\"button\").at(0);\n+      }\n+      button.simulate(\"click\");\n+    };\n+\n+    it(\"should fetch facets\", () => {\n+      expect(\n+        FacetedSearchSettingsModule.getFacetsFromServer\n+      ).toHaveBeenCalledTimes(1);\n+    });\n+\n+    it(\"should display a list of facets\", () => {\n+      expect(getListItems()).toHaveLength(2);\n+    });\n+\n+    describe(\"when click an Edit button\", () => {\n+      it(\"should show a dialog\", async () => {\n+        openDialog(false);\n+        expect(component.find(FacetDialog).prop(\"open\")).toBeTruthy();\n+      });\n+    });\n+\n+    describe(\"when click the Add button\", () => {\n+      it(\"should show a dialog\", async () => {\n+        openDialog(true);\n+        expect(component.find(FacetDialog).prop(\"open\")).toBeTruthy();\n+      });\n+    });\n+\n+    describe(\"when click a delete button\", () => {\n+      it(\"should remove a facet from the list and enable the Save button\", () => {\n+        deleteFacet();\n+        const items = getListItems();\n+        expect(items).toHaveLength(1);\n+        expect(getSaveButton().prop(\"disabled\")).toBeFalsy();\n+      });\n+    });\n+\n+    describe(\"when edit a facet through the dialog\", () => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "438e4d8fd5a112737f9980910272eca0d5895bb5"}, "originalPosition": 141}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI0MzEyMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                describe(\"when click a delete button\", () => {\n          \n          \n            \n                describe(\"when a delete button is clicked\", () => {", "url": "https://github.com/openequella/openEQUELLA/pull/1728#discussion_r424243121", "createdAt": "2020-05-13T07:55:34Z", "author": {"login": "SammyIsConfused"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/mainui/FacetedSearchSettingsPage.test.tsx", "diffHunk": "@@ -0,0 +1,199 @@\n+/*\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * The Apereo Foundation licenses this file to you under the Apache License,\n+ * Version 2.0, (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+import * as React from \"react\";\n+import { mount, ReactWrapper } from \"enzyme\";\n+import FacetedSearchSettingsPage from \"../../../tsrc/settings/Search/facetedsearch/FacetedSearchSettingsPage\";\n+import * as FacetedSearchSettingsModule from \"../../../tsrc/settings/Search/facetedsearch/FacetedSearchSettingsModule\";\n+import { NavigationGuardProps } from \"../../../tsrc/components/NavigationGuard\";\n+import { act } from \"react-dom/test-utils\";\n+import FacetDialog from \"../../../tsrc/settings/Search/facetedsearch/FacetDialog\";\n+import MessageInfo from \"../../../tsrc/components/MessageInfo\";\n+import MessageDialog from \"../../../tsrc/components/MessageDialog\";\n+\n+const mockFacets: FacetedSearchSettingsModule.Facet[] = [\n+  {\n+    id: 1,\n+    name: \"mocked facet1\",\n+    schemaNode: \"item/name\",\n+    maxResults: 1,\n+    orderIndex: 1,\n+  },\n+  {\n+    id: 2,\n+    name: \"mocked facet3\",\n+    schemaNode: \"item/age\",\n+    maxResults: 2,\n+    orderIndex: 2,\n+  },\n+];\n+\n+// This test does not need NavigationGuard which is part of the Setting page template.\n+jest.mock(\"../../../tsrc/components/NavigationGuard\", () => ({\n+  NavigationGuard: (props: NavigationGuardProps) => {\n+    return <div />;\n+  },\n+}));\n+\n+const mockGetFacetsFromServer = jest.spyOn(\n+  FacetedSearchSettingsModule,\n+  \"getFacetsFromServer\"\n+);\n+const mockBatchDelete = jest.spyOn(FacetedSearchSettingsModule, \"batchDelete\");\n+const mockBatchUpdateOrAdd = jest.spyOn(\n+  FacetedSearchSettingsModule,\n+  \"batchUpdateOrAdd\"\n+);\n+\n+describe(\"<FacetedSearchSettingsPage />\", () => {\n+  let component: ReactWrapper;\n+  beforeEach(async () => {\n+    const getFacetsPromise = mockGetFacetsFromServer.mockImplementation(() =>\n+      Promise.resolve(mockFacets)\n+    );\n+    component = mount(<FacetedSearchSettingsPage updateTemplate={jest.fn()} />);\n+    await act(async () => {\n+      await getFacetsPromise;\n+    });\n+    component.update();\n+  });\n+  afterEach(() => jest.clearAllMocks());\n+\n+  describe(\"when the page is mounted\", () => {\n+    const getListItems = () => component.find(\".MuiListItem-container\");\n+    const getSaveButton = () => component.find(\"#_saveButton\").hostNodes();\n+    const deleteFacet = () => {\n+      const deleteButton = getListItems().at(0).find(\"button\").at(1);\n+      deleteButton.simulate(\"click\");\n+    };\n+    const updateFacet = (addOrEdit: boolean) => {\n+      const fields = component.find(\"input\");\n+      fields.at(0).simulate(\"change\", {\n+        target: { value: addOrEdit ? \"new facet\" : \"updated facet\" },\n+      });\n+      fields.at(1).simulate(\"change\", { target: { value: \"item/name/first\" } });\n+      const okButton = component\n+        .findWhere(\n+          (node) =>\n+            node.text() === (addOrEdit ? \"Add\" : \"OK\") &&\n+            node.type() === \"button\"\n+        )\n+        .hostNodes();\n+      okButton.simulate(\"click\");\n+    };\n+    const openDialog = (addOrEdit: boolean) => {\n+      let button: ReactWrapper;\n+      if (addOrEdit) {\n+        button = component.find(\".MuiCardActions-root button\");\n+      } else {\n+        button = getListItems().at(0).find(\"button\").at(0);\n+      }\n+      button.simulate(\"click\");\n+    };\n+\n+    it(\"should fetch facets\", () => {\n+      expect(\n+        FacetedSearchSettingsModule.getFacetsFromServer\n+      ).toHaveBeenCalledTimes(1);\n+    });\n+\n+    it(\"should display a list of facets\", () => {\n+      expect(getListItems()).toHaveLength(2);\n+    });\n+\n+    describe(\"when click an Edit button\", () => {\n+      it(\"should show a dialog\", async () => {\n+        openDialog(false);\n+        expect(component.find(FacetDialog).prop(\"open\")).toBeTruthy();\n+      });\n+    });\n+\n+    describe(\"when click the Add button\", () => {\n+      it(\"should show a dialog\", async () => {\n+        openDialog(true);\n+        expect(component.find(FacetDialog).prop(\"open\")).toBeTruthy();\n+      });\n+    });\n+\n+    describe(\"when click a delete button\", () => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "438e4d8fd5a112737f9980910272eca0d5895bb5"}, "originalPosition": 132}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI0MzQzOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                describe(\"when click the Add button\", () => {\n          \n          \n            \n                describe(\"when the Add button is clicked\", () => {", "url": "https://github.com/openequella/openEQUELLA/pull/1728#discussion_r424243439", "createdAt": "2020-05-13T07:56:06Z", "author": {"login": "SammyIsConfused"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/mainui/FacetedSearchSettingsPage.test.tsx", "diffHunk": "@@ -0,0 +1,199 @@\n+/*\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * The Apereo Foundation licenses this file to you under the Apache License,\n+ * Version 2.0, (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+import * as React from \"react\";\n+import { mount, ReactWrapper } from \"enzyme\";\n+import FacetedSearchSettingsPage from \"../../../tsrc/settings/Search/facetedsearch/FacetedSearchSettingsPage\";\n+import * as FacetedSearchSettingsModule from \"../../../tsrc/settings/Search/facetedsearch/FacetedSearchSettingsModule\";\n+import { NavigationGuardProps } from \"../../../tsrc/components/NavigationGuard\";\n+import { act } from \"react-dom/test-utils\";\n+import FacetDialog from \"../../../tsrc/settings/Search/facetedsearch/FacetDialog\";\n+import MessageInfo from \"../../../tsrc/components/MessageInfo\";\n+import MessageDialog from \"../../../tsrc/components/MessageDialog\";\n+\n+const mockFacets: FacetedSearchSettingsModule.Facet[] = [\n+  {\n+    id: 1,\n+    name: \"mocked facet1\",\n+    schemaNode: \"item/name\",\n+    maxResults: 1,\n+    orderIndex: 1,\n+  },\n+  {\n+    id: 2,\n+    name: \"mocked facet3\",\n+    schemaNode: \"item/age\",\n+    maxResults: 2,\n+    orderIndex: 2,\n+  },\n+];\n+\n+// This test does not need NavigationGuard which is part of the Setting page template.\n+jest.mock(\"../../../tsrc/components/NavigationGuard\", () => ({\n+  NavigationGuard: (props: NavigationGuardProps) => {\n+    return <div />;\n+  },\n+}));\n+\n+const mockGetFacetsFromServer = jest.spyOn(\n+  FacetedSearchSettingsModule,\n+  \"getFacetsFromServer\"\n+);\n+const mockBatchDelete = jest.spyOn(FacetedSearchSettingsModule, \"batchDelete\");\n+const mockBatchUpdateOrAdd = jest.spyOn(\n+  FacetedSearchSettingsModule,\n+  \"batchUpdateOrAdd\"\n+);\n+\n+describe(\"<FacetedSearchSettingsPage />\", () => {\n+  let component: ReactWrapper;\n+  beforeEach(async () => {\n+    const getFacetsPromise = mockGetFacetsFromServer.mockImplementation(() =>\n+      Promise.resolve(mockFacets)\n+    );\n+    component = mount(<FacetedSearchSettingsPage updateTemplate={jest.fn()} />);\n+    await act(async () => {\n+      await getFacetsPromise;\n+    });\n+    component.update();\n+  });\n+  afterEach(() => jest.clearAllMocks());\n+\n+  describe(\"when the page is mounted\", () => {\n+    const getListItems = () => component.find(\".MuiListItem-container\");\n+    const getSaveButton = () => component.find(\"#_saveButton\").hostNodes();\n+    const deleteFacet = () => {\n+      const deleteButton = getListItems().at(0).find(\"button\").at(1);\n+      deleteButton.simulate(\"click\");\n+    };\n+    const updateFacet = (addOrEdit: boolean) => {\n+      const fields = component.find(\"input\");\n+      fields.at(0).simulate(\"change\", {\n+        target: { value: addOrEdit ? \"new facet\" : \"updated facet\" },\n+      });\n+      fields.at(1).simulate(\"change\", { target: { value: \"item/name/first\" } });\n+      const okButton = component\n+        .findWhere(\n+          (node) =>\n+            node.text() === (addOrEdit ? \"Add\" : \"OK\") &&\n+            node.type() === \"button\"\n+        )\n+        .hostNodes();\n+      okButton.simulate(\"click\");\n+    };\n+    const openDialog = (addOrEdit: boolean) => {\n+      let button: ReactWrapper;\n+      if (addOrEdit) {\n+        button = component.find(\".MuiCardActions-root button\");\n+      } else {\n+        button = getListItems().at(0).find(\"button\").at(0);\n+      }\n+      button.simulate(\"click\");\n+    };\n+\n+    it(\"should fetch facets\", () => {\n+      expect(\n+        FacetedSearchSettingsModule.getFacetsFromServer\n+      ).toHaveBeenCalledTimes(1);\n+    });\n+\n+    it(\"should display a list of facets\", () => {\n+      expect(getListItems()).toHaveLength(2);\n+    });\n+\n+    describe(\"when click an Edit button\", () => {\n+      it(\"should show a dialog\", async () => {\n+        openDialog(false);\n+        expect(component.find(FacetDialog).prop(\"open\")).toBeTruthy();\n+      });\n+    });\n+\n+    describe(\"when click the Add button\", () => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "438e4d8fd5a112737f9980910272eca0d5895bb5"}, "originalPosition": 125}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI0Mzc0Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                describe(\"when click an Edit button\", () => {\n          \n          \n            \n                describe(\"when an Edit button is clicked\", () => {", "url": "https://github.com/openequella/openEQUELLA/pull/1728#discussion_r424243742", "createdAt": "2020-05-13T07:56:34Z", "author": {"login": "SammyIsConfused"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/mainui/FacetedSearchSettingsPage.test.tsx", "diffHunk": "@@ -0,0 +1,199 @@\n+/*\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * The Apereo Foundation licenses this file to you under the Apache License,\n+ * Version 2.0, (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+import * as React from \"react\";\n+import { mount, ReactWrapper } from \"enzyme\";\n+import FacetedSearchSettingsPage from \"../../../tsrc/settings/Search/facetedsearch/FacetedSearchSettingsPage\";\n+import * as FacetedSearchSettingsModule from \"../../../tsrc/settings/Search/facetedsearch/FacetedSearchSettingsModule\";\n+import { NavigationGuardProps } from \"../../../tsrc/components/NavigationGuard\";\n+import { act } from \"react-dom/test-utils\";\n+import FacetDialog from \"../../../tsrc/settings/Search/facetedsearch/FacetDialog\";\n+import MessageInfo from \"../../../tsrc/components/MessageInfo\";\n+import MessageDialog from \"../../../tsrc/components/MessageDialog\";\n+\n+const mockFacets: FacetedSearchSettingsModule.Facet[] = [\n+  {\n+    id: 1,\n+    name: \"mocked facet1\",\n+    schemaNode: \"item/name\",\n+    maxResults: 1,\n+    orderIndex: 1,\n+  },\n+  {\n+    id: 2,\n+    name: \"mocked facet3\",\n+    schemaNode: \"item/age\",\n+    maxResults: 2,\n+    orderIndex: 2,\n+  },\n+];\n+\n+// This test does not need NavigationGuard which is part of the Setting page template.\n+jest.mock(\"../../../tsrc/components/NavigationGuard\", () => ({\n+  NavigationGuard: (props: NavigationGuardProps) => {\n+    return <div />;\n+  },\n+}));\n+\n+const mockGetFacetsFromServer = jest.spyOn(\n+  FacetedSearchSettingsModule,\n+  \"getFacetsFromServer\"\n+);\n+const mockBatchDelete = jest.spyOn(FacetedSearchSettingsModule, \"batchDelete\");\n+const mockBatchUpdateOrAdd = jest.spyOn(\n+  FacetedSearchSettingsModule,\n+  \"batchUpdateOrAdd\"\n+);\n+\n+describe(\"<FacetedSearchSettingsPage />\", () => {\n+  let component: ReactWrapper;\n+  beforeEach(async () => {\n+    const getFacetsPromise = mockGetFacetsFromServer.mockImplementation(() =>\n+      Promise.resolve(mockFacets)\n+    );\n+    component = mount(<FacetedSearchSettingsPage updateTemplate={jest.fn()} />);\n+    await act(async () => {\n+      await getFacetsPromise;\n+    });\n+    component.update();\n+  });\n+  afterEach(() => jest.clearAllMocks());\n+\n+  describe(\"when the page is mounted\", () => {\n+    const getListItems = () => component.find(\".MuiListItem-container\");\n+    const getSaveButton = () => component.find(\"#_saveButton\").hostNodes();\n+    const deleteFacet = () => {\n+      const deleteButton = getListItems().at(0).find(\"button\").at(1);\n+      deleteButton.simulate(\"click\");\n+    };\n+    const updateFacet = (addOrEdit: boolean) => {\n+      const fields = component.find(\"input\");\n+      fields.at(0).simulate(\"change\", {\n+        target: { value: addOrEdit ? \"new facet\" : \"updated facet\" },\n+      });\n+      fields.at(1).simulate(\"change\", { target: { value: \"item/name/first\" } });\n+      const okButton = component\n+        .findWhere(\n+          (node) =>\n+            node.text() === (addOrEdit ? \"Add\" : \"OK\") &&\n+            node.type() === \"button\"\n+        )\n+        .hostNodes();\n+      okButton.simulate(\"click\");\n+    };\n+    const openDialog = (addOrEdit: boolean) => {\n+      let button: ReactWrapper;\n+      if (addOrEdit) {\n+        button = component.find(\".MuiCardActions-root button\");\n+      } else {\n+        button = getListItems().at(0).find(\"button\").at(0);\n+      }\n+      button.simulate(\"click\");\n+    };\n+\n+    it(\"should fetch facets\", () => {\n+      expect(\n+        FacetedSearchSettingsModule.getFacetsFromServer\n+      ).toHaveBeenCalledTimes(1);\n+    });\n+\n+    it(\"should display a list of facets\", () => {\n+      expect(getListItems()).toHaveLength(2);\n+    });\n+\n+    describe(\"when click an Edit button\", () => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "438e4d8fd5a112737f9980910272eca0d5895bb5"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI0NzAwNg==", "bodyText": "Might be good to have a quick line about the definition of dirty in this scenario.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * ID of a facet; being undefined means this facet is dirty.\n          \n          \n            \n               * ID of a facet; being undefined means this facet is dirty. (i.e., not saved to the server)", "url": "https://github.com/openequella/openEQUELLA/pull/1728#discussion_r424247006", "createdAt": "2020-05-13T08:02:13Z", "author": {"login": "SammyIsConfused"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/settings/Search/facetedsearch/FacetedSearchSettingsModule.ts", "diffHunk": "@@ -21,14 +21,19 @@ import {\n   BatchOperationResponse,\n   groupErrorMessages,\n } from \"../../../api/BatchOperationResponse\";\n+import { encodeQuery } from \"../../../util/encodequery\";\n \n export interface Facet {\n   /**\n-   * Name of a facet\n+   * ID of a facet; being undefined means this facet is dirty.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "438e4d8fd5a112737f9980910272eca0d5895bb5"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI0ODAwNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Get facets from the Server and add boolean flags on them.\n          \n          \n            \n               * Get facets from the server and add flags to them.", "url": "https://github.com/openequella/openEQUELLA/pull/1728#discussion_r424248004", "createdAt": "2020-05-13T08:03:52Z", "author": {"login": "SammyIsConfused"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/settings/Search/facetedsearch/FacetedSearchSettingsPage.tsx", "diffHunk": "@@ -99,24 +109,40 @@ const FacetedSearchSettingsPage = ({ updateTemplate }: TemplateUpdateProps) => {\n    * Get facets from the Server and add boolean flags on them.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "438e4d8fd5a112737f9980910272eca0d5895bb5"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI0ODc2OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Save updated/deleted facets to the Server.\n          \n          \n            \n               * Show the message dialog if any error message is received otherwise show snackbar.\n          \n          \n            \n               * Save updated/deleted facets to the server.\n          \n          \n            \n               * Show the message dialog if any error message is received. Otherwise, show snackbar.", "url": "https://github.com/openequella/openEQUELLA/pull/1728#discussion_r424248769", "createdAt": "2020-05-13T08:05:17Z", "author": {"login": "SammyIsConfused"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/settings/Search/facetedsearch/FacetedSearchSettingsPage.tsx", "diffHunk": "@@ -99,24 +109,40 @@ const FacetedSearchSettingsPage = ({ updateTemplate }: TemplateUpdateProps) => {\n    * Get facets from the Server and add boolean flags on them.\n    */\n   const getFacets = () => {\n-    getFacetsFromServer().then((facets) => {\n-      setFacets(\n-        facets.map((facet) => {\n-          return { ...facet, updated: false, deleted: false };\n-        })\n-      );\n-    });\n+    getFacetsFromServer()\n+      .then((facets) =>\n+        setFacets(\n+          facets.map((facet) => {\n+            return { ...facet, updated: false, deleted: false };\n+          })\n+        )\n+      )\n+      .catch((error: Error) => handleError(error));\n   };\n \n   /**\n    * Save updated/deleted facets to the Server.\n    * Show the message dialog if any error message is received otherwise show snackbar.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "438e4d8fd5a112737f9980910272eca0d5895bb5"}, "originalPosition": 65}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56aeaff183f75f6e132fc9df6b4e0461163c893d", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/56aeaff183f75f6e132fc9df6b4e0461163c893d", "committedDate": "2020-05-14T00:05:09Z", "message": "Add a helper text for category number in FacetDialog."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMzUxNTQx", "url": "https://github.com/openequella/openEQUELLA/pull/1728#pullrequestreview-411351541", "createdAt": "2020-05-13T22:48:11Z", "commit": {"oid": "438e4d8fd5a112737f9980910272eca0d5895bb5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMjo0ODoxMVrOGVGKHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwMDowNTowNVrOGVHqBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc3NDE3Mw==", "bodyText": "This describe seems redundant, because there are no subsequent describe blocks at this level.", "url": "https://github.com/openequella/openEQUELLA/pull/1728#discussion_r424774173", "createdAt": "2020-05-13T22:48:11Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/mainui/FacetedSearchSettingsPage.test.tsx", "diffHunk": "@@ -0,0 +1,199 @@\n+/*\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * The Apereo Foundation licenses this file to you under the Apache License,\n+ * Version 2.0, (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+import * as React from \"react\";\n+import { mount, ReactWrapper } from \"enzyme\";\n+import FacetedSearchSettingsPage from \"../../../tsrc/settings/Search/facetedsearch/FacetedSearchSettingsPage\";\n+import * as FacetedSearchSettingsModule from \"../../../tsrc/settings/Search/facetedsearch/FacetedSearchSettingsModule\";\n+import { NavigationGuardProps } from \"../../../tsrc/components/NavigationGuard\";\n+import { act } from \"react-dom/test-utils\";\n+import FacetDialog from \"../../../tsrc/settings/Search/facetedsearch/FacetDialog\";\n+import MessageInfo from \"../../../tsrc/components/MessageInfo\";\n+import MessageDialog from \"../../../tsrc/components/MessageDialog\";\n+\n+const mockFacets: FacetedSearchSettingsModule.Facet[] = [\n+  {\n+    id: 1,\n+    name: \"mocked facet1\",\n+    schemaNode: \"item/name\",\n+    maxResults: 1,\n+    orderIndex: 1,\n+  },\n+  {\n+    id: 2,\n+    name: \"mocked facet3\",\n+    schemaNode: \"item/age\",\n+    maxResults: 2,\n+    orderIndex: 2,\n+  },\n+];\n+\n+// This test does not need NavigationGuard which is part of the Setting page template.\n+jest.mock(\"../../../tsrc/components/NavigationGuard\", () => ({\n+  NavigationGuard: (props: NavigationGuardProps) => {\n+    return <div />;\n+  },\n+}));\n+\n+const mockGetFacetsFromServer = jest.spyOn(\n+  FacetedSearchSettingsModule,\n+  \"getFacetsFromServer\"\n+);\n+const mockBatchDelete = jest.spyOn(FacetedSearchSettingsModule, \"batchDelete\");\n+const mockBatchUpdateOrAdd = jest.spyOn(\n+  FacetedSearchSettingsModule,\n+  \"batchUpdateOrAdd\"\n+);\n+\n+describe(\"<FacetedSearchSettingsPage />\", () => {\n+  let component: ReactWrapper;\n+  beforeEach(async () => {\n+    const getFacetsPromise = mockGetFacetsFromServer.mockImplementation(() =>\n+      Promise.resolve(mockFacets)\n+    );\n+    component = mount(<FacetedSearchSettingsPage updateTemplate={jest.fn()} />);\n+    await act(async () => {\n+      await getFacetsPromise;\n+    });\n+    component.update();\n+  });\n+  afterEach(() => jest.clearAllMocks());\n+\n+  describe(\"when the page is mounted\", () => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "438e4d8fd5a112737f9980910272eca0d5895bb5"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc3NTM1MQ==", "bodyText": "AFAIK, other than documentation there is no benefit to have a describe block that simply wraps a single it or test statement - only if there was also some other logic such as a before or after. That also extends to even if the describe only had multiple it/test blocks but no other blocks or statements in it.\nSo I'd suggest we remove all those type of describes here and below, and simply rework the it description to cover it.", "url": "https://github.com/openequella/openEQUELLA/pull/1728#discussion_r424775351", "createdAt": "2020-05-13T22:51:19Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/mainui/FacetedSearchSettingsPage.test.tsx", "diffHunk": "@@ -0,0 +1,199 @@\n+/*\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * The Apereo Foundation licenses this file to you under the Apache License,\n+ * Version 2.0, (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+import * as React from \"react\";\n+import { mount, ReactWrapper } from \"enzyme\";\n+import FacetedSearchSettingsPage from \"../../../tsrc/settings/Search/facetedsearch/FacetedSearchSettingsPage\";\n+import * as FacetedSearchSettingsModule from \"../../../tsrc/settings/Search/facetedsearch/FacetedSearchSettingsModule\";\n+import { NavigationGuardProps } from \"../../../tsrc/components/NavigationGuard\";\n+import { act } from \"react-dom/test-utils\";\n+import FacetDialog from \"../../../tsrc/settings/Search/facetedsearch/FacetDialog\";\n+import MessageInfo from \"../../../tsrc/components/MessageInfo\";\n+import MessageDialog from \"../../../tsrc/components/MessageDialog\";\n+\n+const mockFacets: FacetedSearchSettingsModule.Facet[] = [\n+  {\n+    id: 1,\n+    name: \"mocked facet1\",\n+    schemaNode: \"item/name\",\n+    maxResults: 1,\n+    orderIndex: 1,\n+  },\n+  {\n+    id: 2,\n+    name: \"mocked facet3\",\n+    schemaNode: \"item/age\",\n+    maxResults: 2,\n+    orderIndex: 2,\n+  },\n+];\n+\n+// This test does not need NavigationGuard which is part of the Setting page template.\n+jest.mock(\"../../../tsrc/components/NavigationGuard\", () => ({\n+  NavigationGuard: (props: NavigationGuardProps) => {\n+    return <div />;\n+  },\n+}));\n+\n+const mockGetFacetsFromServer = jest.spyOn(\n+  FacetedSearchSettingsModule,\n+  \"getFacetsFromServer\"\n+);\n+const mockBatchDelete = jest.spyOn(FacetedSearchSettingsModule, \"batchDelete\");\n+const mockBatchUpdateOrAdd = jest.spyOn(\n+  FacetedSearchSettingsModule,\n+  \"batchUpdateOrAdd\"\n+);\n+\n+describe(\"<FacetedSearchSettingsPage />\", () => {\n+  let component: ReactWrapper;\n+  beforeEach(async () => {\n+    const getFacetsPromise = mockGetFacetsFromServer.mockImplementation(() =>\n+      Promise.resolve(mockFacets)\n+    );\n+    component = mount(<FacetedSearchSettingsPage updateTemplate={jest.fn()} />);\n+    await act(async () => {\n+      await getFacetsPromise;\n+    });\n+    component.update();\n+  });\n+  afterEach(() => jest.clearAllMocks());\n+\n+  describe(\"when the page is mounted\", () => {\n+    const getListItems = () => component.find(\".MuiListItem-container\");\n+    const getSaveButton = () => component.find(\"#_saveButton\").hostNodes();\n+    const deleteFacet = () => {\n+      const deleteButton = getListItems().at(0).find(\"button\").at(1);\n+      deleteButton.simulate(\"click\");\n+    };\n+    const updateFacet = (addOrEdit: boolean) => {\n+      const fields = component.find(\"input\");\n+      fields.at(0).simulate(\"change\", {\n+        target: { value: addOrEdit ? \"new facet\" : \"updated facet\" },\n+      });\n+      fields.at(1).simulate(\"change\", { target: { value: \"item/name/first\" } });\n+      const okButton = component\n+        .findWhere(\n+          (node) =>\n+            node.text() === (addOrEdit ? \"Add\" : \"OK\") &&\n+            node.type() === \"button\"\n+        )\n+        .hostNodes();\n+      okButton.simulate(\"click\");\n+    };\n+    const openDialog = (addOrEdit: boolean) => {\n+      let button: ReactWrapper;\n+      if (addOrEdit) {\n+        button = component.find(\".MuiCardActions-root button\");\n+      } else {\n+        button = getListItems().at(0).find(\"button\").at(0);\n+      }\n+      button.simulate(\"click\");\n+    };\n+\n+    it(\"should fetch facets\", () => {\n+      expect(\n+        FacetedSearchSettingsModule.getFacetsFromServer\n+      ).toHaveBeenCalledTimes(1);\n+    });\n+\n+    it(\"should display a list of facets\", () => {\n+      expect(getListItems()).toHaveLength(2);\n+    });\n+\n+    describe(\"when click an Edit button\", () => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "438e4d8fd5a112737f9980910272eca0d5895bb5"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc3NjE5Mg==", "bodyText": "I wonder if this is valid. \ud83e\udd14\nWhat if open is present, but has a text value of false. Will it be okay?\nAlso, this reads odd after the line above it of openDialog(false). That makes me think it's saying \"don't open the dialog\", and then we're testing to make sure it's open. \ud83e\udd2f", "url": "https://github.com/openequella/openEQUELLA/pull/1728#discussion_r424776192", "createdAt": "2020-05-13T22:53:41Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/mainui/FacetedSearchSettingsPage.test.tsx", "diffHunk": "@@ -0,0 +1,199 @@\n+/*\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * The Apereo Foundation licenses this file to you under the Apache License,\n+ * Version 2.0, (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+import * as React from \"react\";\n+import { mount, ReactWrapper } from \"enzyme\";\n+import FacetedSearchSettingsPage from \"../../../tsrc/settings/Search/facetedsearch/FacetedSearchSettingsPage\";\n+import * as FacetedSearchSettingsModule from \"../../../tsrc/settings/Search/facetedsearch/FacetedSearchSettingsModule\";\n+import { NavigationGuardProps } from \"../../../tsrc/components/NavigationGuard\";\n+import { act } from \"react-dom/test-utils\";\n+import FacetDialog from \"../../../tsrc/settings/Search/facetedsearch/FacetDialog\";\n+import MessageInfo from \"../../../tsrc/components/MessageInfo\";\n+import MessageDialog from \"../../../tsrc/components/MessageDialog\";\n+\n+const mockFacets: FacetedSearchSettingsModule.Facet[] = [\n+  {\n+    id: 1,\n+    name: \"mocked facet1\",\n+    schemaNode: \"item/name\",\n+    maxResults: 1,\n+    orderIndex: 1,\n+  },\n+  {\n+    id: 2,\n+    name: \"mocked facet3\",\n+    schemaNode: \"item/age\",\n+    maxResults: 2,\n+    orderIndex: 2,\n+  },\n+];\n+\n+// This test does not need NavigationGuard which is part of the Setting page template.\n+jest.mock(\"../../../tsrc/components/NavigationGuard\", () => ({\n+  NavigationGuard: (props: NavigationGuardProps) => {\n+    return <div />;\n+  },\n+}));\n+\n+const mockGetFacetsFromServer = jest.spyOn(\n+  FacetedSearchSettingsModule,\n+  \"getFacetsFromServer\"\n+);\n+const mockBatchDelete = jest.spyOn(FacetedSearchSettingsModule, \"batchDelete\");\n+const mockBatchUpdateOrAdd = jest.spyOn(\n+  FacetedSearchSettingsModule,\n+  \"batchUpdateOrAdd\"\n+);\n+\n+describe(\"<FacetedSearchSettingsPage />\", () => {\n+  let component: ReactWrapper;\n+  beforeEach(async () => {\n+    const getFacetsPromise = mockGetFacetsFromServer.mockImplementation(() =>\n+      Promise.resolve(mockFacets)\n+    );\n+    component = mount(<FacetedSearchSettingsPage updateTemplate={jest.fn()} />);\n+    await act(async () => {\n+      await getFacetsPromise;\n+    });\n+    component.update();\n+  });\n+  afterEach(() => jest.clearAllMocks());\n+\n+  describe(\"when the page is mounted\", () => {\n+    const getListItems = () => component.find(\".MuiListItem-container\");\n+    const getSaveButton = () => component.find(\"#_saveButton\").hostNodes();\n+    const deleteFacet = () => {\n+      const deleteButton = getListItems().at(0).find(\"button\").at(1);\n+      deleteButton.simulate(\"click\");\n+    };\n+    const updateFacet = (addOrEdit: boolean) => {\n+      const fields = component.find(\"input\");\n+      fields.at(0).simulate(\"change\", {\n+        target: { value: addOrEdit ? \"new facet\" : \"updated facet\" },\n+      });\n+      fields.at(1).simulate(\"change\", { target: { value: \"item/name/first\" } });\n+      const okButton = component\n+        .findWhere(\n+          (node) =>\n+            node.text() === (addOrEdit ? \"Add\" : \"OK\") &&\n+            node.type() === \"button\"\n+        )\n+        .hostNodes();\n+      okButton.simulate(\"click\");\n+    };\n+    const openDialog = (addOrEdit: boolean) => {\n+      let button: ReactWrapper;\n+      if (addOrEdit) {\n+        button = component.find(\".MuiCardActions-root button\");\n+      } else {\n+        button = getListItems().at(0).find(\"button\").at(0);\n+      }\n+      button.simulate(\"click\");\n+    };\n+\n+    it(\"should fetch facets\", () => {\n+      expect(\n+        FacetedSearchSettingsModule.getFacetsFromServer\n+      ).toHaveBeenCalledTimes(1);\n+    });\n+\n+    it(\"should display a list of facets\", () => {\n+      expect(getListItems()).toHaveLength(2);\n+    });\n+\n+    describe(\"when click an Edit button\", () => {\n+      it(\"should show a dialog\", async () => {\n+        openDialog(false);\n+        expect(component.find(FacetDialog).prop(\"open\")).toBeTruthy();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "438e4d8fd5a112737f9980910272eca0d5895bb5"}, "originalPosition": 121}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc3NjY5Nw==", "bodyText": "Okay, what now... This reads very close to the above test, but now we call openDialog with true (rather than false) and yet we're still expecting the same result. Huh!?", "url": "https://github.com/openequella/openEQUELLA/pull/1728#discussion_r424776697", "createdAt": "2020-05-13T22:55:02Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/mainui/FacetedSearchSettingsPage.test.tsx", "diffHunk": "@@ -0,0 +1,199 @@\n+/*\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * The Apereo Foundation licenses this file to you under the Apache License,\n+ * Version 2.0, (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+import * as React from \"react\";\n+import { mount, ReactWrapper } from \"enzyme\";\n+import FacetedSearchSettingsPage from \"../../../tsrc/settings/Search/facetedsearch/FacetedSearchSettingsPage\";\n+import * as FacetedSearchSettingsModule from \"../../../tsrc/settings/Search/facetedsearch/FacetedSearchSettingsModule\";\n+import { NavigationGuardProps } from \"../../../tsrc/components/NavigationGuard\";\n+import { act } from \"react-dom/test-utils\";\n+import FacetDialog from \"../../../tsrc/settings/Search/facetedsearch/FacetDialog\";\n+import MessageInfo from \"../../../tsrc/components/MessageInfo\";\n+import MessageDialog from \"../../../tsrc/components/MessageDialog\";\n+\n+const mockFacets: FacetedSearchSettingsModule.Facet[] = [\n+  {\n+    id: 1,\n+    name: \"mocked facet1\",\n+    schemaNode: \"item/name\",\n+    maxResults: 1,\n+    orderIndex: 1,\n+  },\n+  {\n+    id: 2,\n+    name: \"mocked facet3\",\n+    schemaNode: \"item/age\",\n+    maxResults: 2,\n+    orderIndex: 2,\n+  },\n+];\n+\n+// This test does not need NavigationGuard which is part of the Setting page template.\n+jest.mock(\"../../../tsrc/components/NavigationGuard\", () => ({\n+  NavigationGuard: (props: NavigationGuardProps) => {\n+    return <div />;\n+  },\n+}));\n+\n+const mockGetFacetsFromServer = jest.spyOn(\n+  FacetedSearchSettingsModule,\n+  \"getFacetsFromServer\"\n+);\n+const mockBatchDelete = jest.spyOn(FacetedSearchSettingsModule, \"batchDelete\");\n+const mockBatchUpdateOrAdd = jest.spyOn(\n+  FacetedSearchSettingsModule,\n+  \"batchUpdateOrAdd\"\n+);\n+\n+describe(\"<FacetedSearchSettingsPage />\", () => {\n+  let component: ReactWrapper;\n+  beforeEach(async () => {\n+    const getFacetsPromise = mockGetFacetsFromServer.mockImplementation(() =>\n+      Promise.resolve(mockFacets)\n+    );\n+    component = mount(<FacetedSearchSettingsPage updateTemplate={jest.fn()} />);\n+    await act(async () => {\n+      await getFacetsPromise;\n+    });\n+    component.update();\n+  });\n+  afterEach(() => jest.clearAllMocks());\n+\n+  describe(\"when the page is mounted\", () => {\n+    const getListItems = () => component.find(\".MuiListItem-container\");\n+    const getSaveButton = () => component.find(\"#_saveButton\").hostNodes();\n+    const deleteFacet = () => {\n+      const deleteButton = getListItems().at(0).find(\"button\").at(1);\n+      deleteButton.simulate(\"click\");\n+    };\n+    const updateFacet = (addOrEdit: boolean) => {\n+      const fields = component.find(\"input\");\n+      fields.at(0).simulate(\"change\", {\n+        target: { value: addOrEdit ? \"new facet\" : \"updated facet\" },\n+      });\n+      fields.at(1).simulate(\"change\", { target: { value: \"item/name/first\" } });\n+      const okButton = component\n+        .findWhere(\n+          (node) =>\n+            node.text() === (addOrEdit ? \"Add\" : \"OK\") &&\n+            node.type() === \"button\"\n+        )\n+        .hostNodes();\n+      okButton.simulate(\"click\");\n+    };\n+    const openDialog = (addOrEdit: boolean) => {\n+      let button: ReactWrapper;\n+      if (addOrEdit) {\n+        button = component.find(\".MuiCardActions-root button\");\n+      } else {\n+        button = getListItems().at(0).find(\"button\").at(0);\n+      }\n+      button.simulate(\"click\");\n+    };\n+\n+    it(\"should fetch facets\", () => {\n+      expect(\n+        FacetedSearchSettingsModule.getFacetsFromServer\n+      ).toHaveBeenCalledTimes(1);\n+    });\n+\n+    it(\"should display a list of facets\", () => {\n+      expect(getListItems()).toHaveLength(2);\n+    });\n+\n+    describe(\"when click an Edit button\", () => {\n+      it(\"should show a dialog\", async () => {\n+        openDialog(false);\n+        expect(component.find(FacetDialog).prop(\"open\")).toBeTruthy();\n+      });\n+    });\n+\n+    describe(\"when click the Add button\", () => {\n+      it(\"should show a dialog\", async () => {\n+        openDialog(true);\n+        expect(component.find(FacetDialog).prop(\"open\")).toBeTruthy();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "438e4d8fd5a112737f9980910272eca0d5895bb5"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc3ODU3OA==", "bodyText": "So aparently jest toBeTruthy relies on type conversion via !!. So if we look at the above in the node repl:\n$ node\nWelcome to Node.js v12.16.1.\nType \".help\" for more information.\n> !!\"false\"\ntrue\n\nWe see there is probably a problem - and this may extend to your below tests (incl. the toBeFalsey).", "url": "https://github.com/openequella/openEQUELLA/pull/1728#discussion_r424778578", "createdAt": "2020-05-13T23:00:25Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/mainui/FacetedSearchSettingsPage.test.tsx", "diffHunk": "@@ -0,0 +1,199 @@\n+/*\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * The Apereo Foundation licenses this file to you under the Apache License,\n+ * Version 2.0, (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+import * as React from \"react\";\n+import { mount, ReactWrapper } from \"enzyme\";\n+import FacetedSearchSettingsPage from \"../../../tsrc/settings/Search/facetedsearch/FacetedSearchSettingsPage\";\n+import * as FacetedSearchSettingsModule from \"../../../tsrc/settings/Search/facetedsearch/FacetedSearchSettingsModule\";\n+import { NavigationGuardProps } from \"../../../tsrc/components/NavigationGuard\";\n+import { act } from \"react-dom/test-utils\";\n+import FacetDialog from \"../../../tsrc/settings/Search/facetedsearch/FacetDialog\";\n+import MessageInfo from \"../../../tsrc/components/MessageInfo\";\n+import MessageDialog from \"../../../tsrc/components/MessageDialog\";\n+\n+const mockFacets: FacetedSearchSettingsModule.Facet[] = [\n+  {\n+    id: 1,\n+    name: \"mocked facet1\",\n+    schemaNode: \"item/name\",\n+    maxResults: 1,\n+    orderIndex: 1,\n+  },\n+  {\n+    id: 2,\n+    name: \"mocked facet3\",\n+    schemaNode: \"item/age\",\n+    maxResults: 2,\n+    orderIndex: 2,\n+  },\n+];\n+\n+// This test does not need NavigationGuard which is part of the Setting page template.\n+jest.mock(\"../../../tsrc/components/NavigationGuard\", () => ({\n+  NavigationGuard: (props: NavigationGuardProps) => {\n+    return <div />;\n+  },\n+}));\n+\n+const mockGetFacetsFromServer = jest.spyOn(\n+  FacetedSearchSettingsModule,\n+  \"getFacetsFromServer\"\n+);\n+const mockBatchDelete = jest.spyOn(FacetedSearchSettingsModule, \"batchDelete\");\n+const mockBatchUpdateOrAdd = jest.spyOn(\n+  FacetedSearchSettingsModule,\n+  \"batchUpdateOrAdd\"\n+);\n+\n+describe(\"<FacetedSearchSettingsPage />\", () => {\n+  let component: ReactWrapper;\n+  beforeEach(async () => {\n+    const getFacetsPromise = mockGetFacetsFromServer.mockImplementation(() =>\n+      Promise.resolve(mockFacets)\n+    );\n+    component = mount(<FacetedSearchSettingsPage updateTemplate={jest.fn()} />);\n+    await act(async () => {\n+      await getFacetsPromise;\n+    });\n+    component.update();\n+  });\n+  afterEach(() => jest.clearAllMocks());\n+\n+  describe(\"when the page is mounted\", () => {\n+    const getListItems = () => component.find(\".MuiListItem-container\");\n+    const getSaveButton = () => component.find(\"#_saveButton\").hostNodes();\n+    const deleteFacet = () => {\n+      const deleteButton = getListItems().at(0).find(\"button\").at(1);\n+      deleteButton.simulate(\"click\");\n+    };\n+    const updateFacet = (addOrEdit: boolean) => {\n+      const fields = component.find(\"input\");\n+      fields.at(0).simulate(\"change\", {\n+        target: { value: addOrEdit ? \"new facet\" : \"updated facet\" },\n+      });\n+      fields.at(1).simulate(\"change\", { target: { value: \"item/name/first\" } });\n+      const okButton = component\n+        .findWhere(\n+          (node) =>\n+            node.text() === (addOrEdit ? \"Add\" : \"OK\") &&\n+            node.type() === \"button\"\n+        )\n+        .hostNodes();\n+      okButton.simulate(\"click\");\n+    };\n+    const openDialog = (addOrEdit: boolean) => {\n+      let button: ReactWrapper;\n+      if (addOrEdit) {\n+        button = component.find(\".MuiCardActions-root button\");\n+      } else {\n+        button = getListItems().at(0).find(\"button\").at(0);\n+      }\n+      button.simulate(\"click\");\n+    };\n+\n+    it(\"should fetch facets\", () => {\n+      expect(\n+        FacetedSearchSettingsModule.getFacetsFromServer\n+      ).toHaveBeenCalledTimes(1);\n+    });\n+\n+    it(\"should display a list of facets\", () => {\n+      expect(getListItems()).toHaveLength(2);\n+    });\n+\n+    describe(\"when click an Edit button\", () => {\n+      it(\"should show a dialog\", async () => {\n+        openDialog(false);\n+        expect(component.find(FacetDialog).prop(\"open\")).toBeTruthy();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc3NjE5Mg=="}, "originalCommit": {"oid": "438e4d8fd5a112737f9980910272eca0d5895bb5"}, "originalPosition": 121}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc3OTM2NA==", "bodyText": "This describe makes sense, as you're name spacing a few additional functions etc.", "url": "https://github.com/openequella/openEQUELLA/pull/1728#discussion_r424779364", "createdAt": "2020-05-13T23:02:34Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/mainui/FacetedSearchSettingsPage.test.tsx", "diffHunk": "@@ -0,0 +1,199 @@\n+/*\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * The Apereo Foundation licenses this file to you under the Apache License,\n+ * Version 2.0, (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+import * as React from \"react\";\n+import { mount, ReactWrapper } from \"enzyme\";\n+import FacetedSearchSettingsPage from \"../../../tsrc/settings/Search/facetedsearch/FacetedSearchSettingsPage\";\n+import * as FacetedSearchSettingsModule from \"../../../tsrc/settings/Search/facetedsearch/FacetedSearchSettingsModule\";\n+import { NavigationGuardProps } from \"../../../tsrc/components/NavigationGuard\";\n+import { act } from \"react-dom/test-utils\";\n+import FacetDialog from \"../../../tsrc/settings/Search/facetedsearch/FacetDialog\";\n+import MessageInfo from \"../../../tsrc/components/MessageInfo\";\n+import MessageDialog from \"../../../tsrc/components/MessageDialog\";\n+\n+const mockFacets: FacetedSearchSettingsModule.Facet[] = [\n+  {\n+    id: 1,\n+    name: \"mocked facet1\",\n+    schemaNode: \"item/name\",\n+    maxResults: 1,\n+    orderIndex: 1,\n+  },\n+  {\n+    id: 2,\n+    name: \"mocked facet3\",\n+    schemaNode: \"item/age\",\n+    maxResults: 2,\n+    orderIndex: 2,\n+  },\n+];\n+\n+// This test does not need NavigationGuard which is part of the Setting page template.\n+jest.mock(\"../../../tsrc/components/NavigationGuard\", () => ({\n+  NavigationGuard: (props: NavigationGuardProps) => {\n+    return <div />;\n+  },\n+}));\n+\n+const mockGetFacetsFromServer = jest.spyOn(\n+  FacetedSearchSettingsModule,\n+  \"getFacetsFromServer\"\n+);\n+const mockBatchDelete = jest.spyOn(FacetedSearchSettingsModule, \"batchDelete\");\n+const mockBatchUpdateOrAdd = jest.spyOn(\n+  FacetedSearchSettingsModule,\n+  \"batchUpdateOrAdd\"\n+);\n+\n+describe(\"<FacetedSearchSettingsPage />\", () => {\n+  let component: ReactWrapper;\n+  beforeEach(async () => {\n+    const getFacetsPromise = mockGetFacetsFromServer.mockImplementation(() =>\n+      Promise.resolve(mockFacets)\n+    );\n+    component = mount(<FacetedSearchSettingsPage updateTemplate={jest.fn()} />);\n+    await act(async () => {\n+      await getFacetsPromise;\n+    });\n+    component.update();\n+  });\n+  afterEach(() => jest.clearAllMocks());\n+\n+  describe(\"when the page is mounted\", () => {\n+    const getListItems = () => component.find(\".MuiListItem-container\");\n+    const getSaveButton = () => component.find(\"#_saveButton\").hostNodes();\n+    const deleteFacet = () => {\n+      const deleteButton = getListItems().at(0).find(\"button\").at(1);\n+      deleteButton.simulate(\"click\");\n+    };\n+    const updateFacet = (addOrEdit: boolean) => {\n+      const fields = component.find(\"input\");\n+      fields.at(0).simulate(\"change\", {\n+        target: { value: addOrEdit ? \"new facet\" : \"updated facet\" },\n+      });\n+      fields.at(1).simulate(\"change\", { target: { value: \"item/name/first\" } });\n+      const okButton = component\n+        .findWhere(\n+          (node) =>\n+            node.text() === (addOrEdit ? \"Add\" : \"OK\") &&\n+            node.type() === \"button\"\n+        )\n+        .hostNodes();\n+      okButton.simulate(\"click\");\n+    };\n+    const openDialog = (addOrEdit: boolean) => {\n+      let button: ReactWrapper;\n+      if (addOrEdit) {\n+        button = component.find(\".MuiCardActions-root button\");\n+      } else {\n+        button = getListItems().at(0).find(\"button\").at(0);\n+      }\n+      button.simulate(\"click\");\n+    };\n+\n+    it(\"should fetch facets\", () => {\n+      expect(\n+        FacetedSearchSettingsModule.getFacetsFromServer\n+      ).toHaveBeenCalledTimes(1);\n+    });\n+\n+    it(\"should display a list of facets\", () => {\n+      expect(getListItems()).toHaveLength(2);\n+    });\n+\n+    describe(\"when click an Edit button\", () => {\n+      it(\"should show a dialog\", async () => {\n+        openDialog(false);\n+        expect(component.find(FacetDialog).prop(\"open\")).toBeTruthy();\n+      });\n+    });\n+\n+    describe(\"when click the Add button\", () => {\n+      it(\"should show a dialog\", async () => {\n+        openDialog(true);\n+        expect(component.find(FacetDialog).prop(\"open\")).toBeTruthy();\n+      });\n+    });\n+\n+    describe(\"when click a delete button\", () => {\n+      it(\"should remove a facet from the list and enable the Save button\", () => {\n+        deleteFacet();\n+        const items = getListItems();\n+        expect(items).toHaveLength(1);\n+        expect(getSaveButton().prop(\"disabled\")).toBeFalsy();\n+      });\n+    });\n+\n+    describe(\"when edit a facet through the dialog\", () => {\n+      it(\"should show the updated facet and enable the Save button\", () => {\n+        openDialog(false);\n+        updateFacet(false);\n+        const items = getListItems();\n+        expect(items).toHaveLength(2);\n+        expect(items.at(0).text()).toContain(\"updated facet\");\n+        expect(getSaveButton().prop(\"disabled\")).toBeFalsy();\n+      });\n+    });\n+\n+    describe(\"when add a new facet through the dialog\", () => {\n+      it(\"should add the facet to the list and enable the Save button\", () => {\n+        openDialog(true);\n+        updateFacet(true);\n+        const items = getListItems();\n+        expect(items).toHaveLength(3);\n+        expect(items.at(2).text()).toContain(\"new facet\");\n+        expect(getSaveButton().prop(\"disabled\")).toBeFalsy();\n+      });\n+    });\n+\n+    describe(\"when the Save button is enabled and click it\", () => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "438e4d8fd5a112737f9980910272eca0d5895bb5"}, "originalPosition": 163}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc5NjkzMg==", "bodyText": "Rather than having this external variable errorMessages, why not simply return the messages from your updatePromise and deletePromise.\nRoughly:\nconst updatePromise : Promise<string[]> = listOfUpdates.length\n  ? batchUpdateOrAdd(listOfUpdates)\n  : Promise.resovle([]);\n\n// same for deletePromise\n\nPromise.all([updatePromise, deletePromise])\n  then((messages) => {\n    const allMessages = messages.flat();\n    if( allMessages.length > 0 ) {\n// etc. etc.", "url": "https://github.com/openequella/openEQUELLA/pull/1728#discussion_r424796932", "createdAt": "2020-05-13T23:58:43Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/settings/Search/facetedsearch/FacetedSearchSettingsPage.tsx", "diffHunk": "@@ -99,24 +109,40 @@ const FacetedSearchSettingsPage = ({ updateTemplate }: TemplateUpdateProps) => {\n    * Get facets from the Server and add boolean flags on them.\n    */\n   const getFacets = () => {\n-    getFacetsFromServer().then((facets) => {\n-      setFacets(\n-        facets.map((facet) => {\n-          return { ...facet, updated: false, deleted: false };\n-        })\n-      );\n-    });\n+    getFacetsFromServer()\n+      .then((facets) =>\n+        setFacets(\n+          facets.map((facet) => {\n+            return { ...facet, updated: false, deleted: false };\n+          })\n+        )\n+      )\n+      .catch((error: Error) => handleError(error));\n   };\n \n   /**\n    * Save updated/deleted facets to the Server.\n    * Show the message dialog if any error message is received otherwise show snackbar.\n    */\n   const save = () => {\n-    batchUpdateOrAdd(listOfUpdates)\n-      .then((messages) => {\n-        if (messages.length > 0) {\n-          setResultMessagesMessages(messages);\n+    const errorMessages: string[] = [];\n+\n+    const updatePromise: Promise<any> = listOfUpdates.length\n+      ? batchUpdateOrAdd(listOfUpdates).then((messages: string[]) =>\n+          errorMessages.push(...messages)\n+        )\n+      : Promise.resolve();\n+\n+    const deletePromise: Promise<any> = listOfDeleted.length\n+      ? batchDelete(\n+          listOfDeleted.map((facet) => facet.id!.toString())\n+        ).then((messages: string[]) => errorMessages.push(...messages))\n+      : Promise.resolve();\n+\n+    Promise.all([updatePromise, deletePromise])\n+      .then(() => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "438e4d8fd5a112737f9980910272eca0d5895bb5"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc5ODcyNQ==", "bodyText": "I don't believe this needs to be in state. (Also, if it does this name is getting shadowed in many functions below and is rather confusing.)\nIf I understand correctly, this is a new facet that is being created via the create facet dialog - and as a result could just be returned in the provided function for the onclick handler. Probably easier to discuss in chat/zoom.", "url": "https://github.com/openequella/openEQUELLA/pull/1728#discussion_r424798725", "createdAt": "2020-05-14T00:05:05Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/settings/Search/facetedsearch/FacetedSearchSettingsPage.tsx", "diffHunk": "@@ -78,11 +84,15 @@ const FacetedSearchSettingsPage = ({ updateTemplate }: TemplateUpdateProps) => {\n   const [resultMessages, setResultMessagesMessages] = useState<string[]>([]);\n   const [showEditingDialog, setShowEditingDialog] = useState<boolean>(false);\n   const [facets, setFacets] = useState<FacetWithFlags[]>([]);\n+  const [facet, setFacet] = useState<FacetWithFlags | undefined>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "438e4d8fd5a112737f9980910272eca0d5895bb5"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fe3779f8b876d1010f87741050b014c8bd417c0", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/8fe3779f8b876d1010f87741050b014c8bd417c0", "committedDate": "2020-05-14T00:12:56Z", "message": "Reword comments and test descriptions."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50f2ad6dff460b5546149e35e711e40e58b8019d", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/50f2ad6dff460b5546149e35e711e40e58b8019d", "committedDate": "2020-05-14T04:58:28Z", "message": "Remove redundant 'describe' from the Jest jest of Facet setting page;\n\nUse props() to access one of the props of a component;\n\nUse enum values to indicate if the action is to add or edit;"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ce88da23915d8048506c95156536e2a59d97364", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/4ce88da23915d8048506c95156536e2a59d97364", "committedDate": "2020-05-14T05:04:43Z", "message": "Tidy up FacetedSearchSettingsPage, including:\n\nIn the 'then' of Promise.all(), check messages of all 207 responses returned\nfrom multiple promises, rather than check each Promise's messages in their\n'then'.\n\nRename the state variable 'facet' to 'currentFacet'."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc55aee3315e95fa69a94d4da86961e47ca836d6", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/cc55aee3315e95fa69a94d4da86961e47ca836d6", "committedDate": "2020-05-14T07:07:19Z", "message": "Update the key of each ListItem."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMjgzNzU1", "url": "https://github.com/openequella/openEQUELLA/pull/1728#pullrequestreview-412283755", "createdAt": "2020-05-15T01:09:52Z", "commit": {"oid": "cc55aee3315e95fa69a94d4da86961e47ca836d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 123, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}