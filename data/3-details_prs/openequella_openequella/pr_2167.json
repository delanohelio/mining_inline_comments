{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1ODczMzA3", "number": 2167, "title": "Make date range end inclusive in searches", "bodyText": "#1306\nChecklist\n\n the [contributor license agreement][] is signed\n commit message follows [commit guidelines][]\n tests are included\n screenshots are included showing significant UI changes\n documentation is changed or added\n\nDescription of change\nThis PR attempts to make the end of a date range inclusive in searches without making any change on the old Search page.\nAlso during the work, I found that in the old Search page, selected dates are always convert to UTC dates, which means the search results may be wrong. For example, if I select 1st Aug, the real date passed to Lucene is 31 July 14:00:00 because AEST is 10 hours ahead of UTC time. More info can be found in screenshots.\nIn new Search page:\n\n\nIn old Search page:", "createdAt": "2020-08-11T05:25:05Z", "url": "https://github.com/openequella/openEQUELLA/pull/2167", "merged": true, "mergeCommit": {"oid": "6c8ab5216dee6b2f9d3577398adff6eec2a84267"}, "closed": true, "closedAt": "2020-08-12T23:10:40Z", "author": {"login": "PenghaiZhang"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9vvaJgH2gAyNDY1ODczMzA3OmQ3ZmQ2YTAzMDg3ZWRlNGQ4ZmFjNmIzMDgyNzRhMWEwZGIyZDQxN2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-GcdRAFqTQ2NTY2NDIxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d7fd6a03087ede4d8fac6b308274a1a0db2d417a", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/d7fd6a03087ede4d8fac6b308274a1a0db2d417a", "committedDate": "2020-08-11T05:12:47Z", "message": "Make the end of date range inclusive in searches.\n\nFirstly, change the time of start to '00:00:00' and that of end to\n'23:59:59'. Secondly, to ensure the old Search page keeps unchanged, add a\nnew boolean variable to flag if a search is performed by 'Search2' API.\nAnd then in the function that prepares Lucine queries, use proper timezone\nbased on the flag."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0ODI5OTkw", "url": "https://github.com/openequella/openEQUELLA/pull/2167#pullrequestreview-464829990", "createdAt": "2020-08-11T07:53:14Z", "commit": {"oid": "d7fd6a03087ede4d8fac6b308274a1a0db2d417a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNzo1MzoxNFrOG-scsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwODowMzo1OFrOG-szow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM5MzEzOA==", "bodyText": "Two things:\n\nCould we use a better name for this? From what I can gather, it only does one thing - control whether or not to include a timezone in the DateFilter. So maybe a name like useServerTimeZone?\nLike we've started doing in all our TS code, let's add a JavaDoc comment to any new bits we add - especially here at the interface level.", "url": "https://github.com/openequella/openEQUELLA/pull/2167#discussion_r468393138", "createdAt": "2020-08-11T07:53:14Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.base/src/com/tle/common/searching/Search.java", "diffHunk": "@@ -86,4 +86,6 @@ public SortField getSortField(boolean reverseTheDefault) {\n   String getPrivilegeToCollect();\n \n   Collection<DateFilter> getDateFilters();\n+\n+  boolean isFromSearch2API();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7fd6a03087ede4d8fac6b308274a1a0db2d417a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM5OTAxMQ==", "bodyText": "I feel the isStart flag is obfuscating things unnecessarily here. Could this not just be time: LocalTime?\nIf it was, where it's used would become much clearer, as you'd simply have:\n    // The After date is the start of the range and so should be at the first possible moment of the day - LocalTime.MIN\n    val modifiedAfter  = handleModifiedDate(params.modifiedAfter, LocalTime.MIN)\n    // The Before date is the end of the range and so should be in the last possible moment of the day - LocalTime.MAX\n    val modifiedBefore = handleModifiedDate(params.modifiedBefore, LocalTime.MAX)\n(As an aside, you'll also note I've re-ordered the declaration of these two values to be slightly more logical.)\nThis change then also simplifies the code down below.", "url": "https://github.com/openequella/openEQUELLA/pull/2167#discussion_r468399011", "createdAt": "2020-08-11T08:03:58Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/scalasrc/com/tle/web/api/search/SearchHelper.scala", "diffHunk": "@@ -118,17 +120,22 @@ object SearchHelper {\n \n   /**\n     * Parse a string to a new instance of Date in the format of \"yyyy-MM-dd\".\n-    * @param date The string to parse.\n-    * @return An option which wraps an instace of Date.\n+    * @param dateString The string to parse.\n+    * @param isStart True if the date is the start of a date range.\n+    * @return An option which wraps an instance of Date.\n     */\n-  def handleModifiedDate(date: String): Option[Date] = {\n-    if (Check.isEmpty(date)) {\n+  def handleModifiedDate(dateString: String, isStart: Boolean = false): Option[Date] = {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7fd6a03087ede4d8fac6b308274a1a0db2d417a"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c96f1862d00c65ae0ff9e098a4d6e87a3d0c659", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/8c96f1862d00c65ae0ff9e098a4d6e87a3d0c659", "committedDate": "2020-08-12T00:13:02Z", "message": "Simplify SearchHelper's method 'handleModifiedDate'."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12120bd516e381d7d5d42d1ae7b0f55bbdf6ee66", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/12120bd516e381d7d5d42d1ae7b0f55bbdf6ee66", "committedDate": "2020-08-12T00:14:43Z", "message": "Rename variable 'isFromSearch2API' to 'useServerTimeZone' and add JavaDoc."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NjEyMzk4", "url": "https://github.com/openequella/openEQUELLA/pull/2167#pullrequestreview-465612398", "createdAt": "2020-08-12T06:03:04Z", "commit": {"oid": "12120bd516e381d7d5d42d1ae7b0f55bbdf6ee66"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwNjowMzowNFrOG_S7Hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwNjowOToxNVrOG_TDyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAyMzUxOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Indicate if the server time zone is needed in searches.\n          \n          \n            \n               * Indicates if the server time zone should be included in searches.", "url": "https://github.com/openequella/openEQUELLA/pull/2167#discussion_r469023518", "createdAt": "2020-08-12T06:03:04Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.base/src/com/tle/common/searching/Search.java", "diffHunk": "@@ -87,5 +87,10 @@ public SortField getSortField(boolean reverseTheDefault) {\n \n   Collection<DateFilter> getDateFilters();\n \n-  boolean isFromSearch2API();\n+  /**\n+   * Indicate if the server time zone is needed in searches.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12120bd516e381d7d5d42d1ae7b0f55bbdf6ee66"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAyNTczNg==", "bodyText": "Be good to further detail the return value. That way a user can rely on their IDE's documentation feature to display useful guidance without needing to review the function.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                * @return An option which wraps an instance of Date.\n          \n          \n            \n                * @return An Option which wraps an instance of Date, combining the successfully parsed dateString and provided time (based on the system's default timezone).", "url": "https://github.com/openequella/openEQUELLA/pull/2167#discussion_r469025736", "createdAt": "2020-08-12T06:09:15Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/scalasrc/com/tle/web/api/search/SearchHelper.scala", "diffHunk": "@@ -118,17 +121,20 @@ object SearchHelper {\n \n   /**\n     * Parse a string to a new instance of Date in the format of \"yyyy-MM-dd\".\n-    * @param date The string to parse.\n-    * @return An option which wraps an instace of Date.\n+    * @param dateString The string to parse.\n+    * @param time The time added to a date.\n+    * @return An option which wraps an instance of Date.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12120bd516e381d7d5d42d1ae7b0f55bbdf6ee66"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3489e5b52972d129912004de67d8b092ccb80bee", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/3489e5b52972d129912004de67d8b092ccb80bee", "committedDate": "2020-08-12T06:14:27Z", "message": "Two tweaks for JavaDoc.\n\nCo-authored-by: edalex-ian <43919233+edalex-ian@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NjY0MjE1", "url": "https://github.com/openequella/openEQUELLA/pull/2167#pullrequestreview-465664215", "createdAt": "2020-08-12T07:39:54Z", "commit": {"oid": "3489e5b52972d129912004de67d8b092ccb80bee"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4892, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}