{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxNTkyOTM2", "number": 2614, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QyMjo1ODowNlrOFG8QPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMToyNzo0NlrOFG-nOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQyODIyOTc1OnYy", "diffSide": "RIGHT", "path": "Source/Plugins/Core/com.equella.core/js/tsconfig.json", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QyMjo1ODowNlrOIIMKJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QyMjo1ODowNlrOIIMKJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ1ODcyNQ==", "bodyText": "Without this library, TS complains that the function keys() does not exist in URLSearchParams.", "url": "https://github.com/openequella/openEQUELLA/pull/2614#discussion_r545458725", "createdAt": "2020-12-17T22:58:06Z", "author": {"login": "PenghaiZhang"}, "path": "Source/Plugins/Core/com.equella.core/js/tsconfig.json", "diffHunk": "@@ -4,7 +4,7 @@\n     \"module\": \"CommonJS\",\n     \"esModuleInterop\": true,\n     \"target\": \"es5\",\n-    \"lib\": [\"es2020\", \"dom\"],\n+    \"lib\": [\"es2020\", \"dom\", \"dom.iterable\"],", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71cc4ce767494e3fc2235d38fe27d59d05b40ef6"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQyODIzNDg1OnYy", "diffSide": "RIGHT", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QyMjo1OTo1MlrOIIMM_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QyMjo1OTo1MlrOIIMM_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ1OTQ1Mg==", "bodyText": "As I need to use the standard Array, I need to rename this Runtype Array.", "url": "https://github.com/openequella/openEQUELLA/pull/2614#discussion_r545459452", "createdAt": "2020-12-17T22:59:52Z", "author": {"login": "PenghaiZhang"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "diffHunk": "@@ -20,7 +20,7 @@ import * as OEQ from \"@openequella/rest-api-client\";\n import { Location } from \"history\";\n import { pick } from \"lodash\";\n import {\n-  Array,\n+  Array as RuntypeArray,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71cc4ce767494e3fc2235d38fe27d59d05b40ef6"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQyODI4ODc0OnYy", "diffSide": "RIGHT", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/SearchPage.tsx", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QyMzoxNjoxOFrOIIMsFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMDo1NToyOVrOIIO3vQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ2NzQxNQ==", "bodyText": "do we know the state will be this shape for certain?\nWould a runtype make sense here?", "url": "https://github.com/openequella/openEQUELLA/pull/2614#discussion_r545467415", "createdAt": "2020-12-17T23:16:18Z", "author": {"login": "ChristianMurphy"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/SearchPage.tsx", "diffHunk": "@@ -121,15 +120,16 @@ const SearchPage = ({ updateTemplate }: TemplateUpdateProps) => {\n     searchPageOptions: defaultSearchPageOptions,\n     filterExpansion: false,\n   };\n-\n+  const searchPageHistoryState: SearchPageHistoryState | undefined = history\n+    .location.state as SearchPageHistoryState;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71cc4ce767494e3fc2235d38fe27d59d05b40ef6"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUwMzE2NQ==", "bodyText": "Thanks Christian!\nLike your idea ! I have raised an Github issue  #2615 for this and do it in next release \ud83d\ude04", "url": "https://github.com/openequella/openEQUELLA/pull/2614#discussion_r545503165", "createdAt": "2020-12-18T00:55:29Z", "author": {"login": "PenghaiZhang"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/SearchPage.tsx", "diffHunk": "@@ -121,15 +120,16 @@ const SearchPage = ({ updateTemplate }: TemplateUpdateProps) => {\n     searchPageOptions: defaultSearchPageOptions,\n     filterExpansion: false,\n   };\n-\n+  const searchPageHistoryState: SearchPageHistoryState | undefined = history\n+    .location.state as SearchPageHistoryState;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ2NzQxNQ=="}, "originalCommit": {"oid": "71cc4ce767494e3fc2235d38fe27d59d05b40ef6"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQyODM5NTQzOnYy", "diffSide": "RIGHT", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/SearchPage.tsx", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QyMzo1NDoyN1rOIINmeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QyMzo1NDoyN1rOIINmeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ4MjM2MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  // If the search option already exists, don't do query string conversion.\n          \n          \n            \n                  // If the search options are available from browser history, ignore those in the query string", "url": "https://github.com/openequella/openEQUELLA/pull/2614#discussion_r545482361", "createdAt": "2020-12-17T23:54:27Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/SearchPage.tsx", "diffHunk": "@@ -158,8 +158,8 @@ const SearchPage = ({ updateTemplate }: TemplateUpdateProps) => {\n \n     Promise.all([\n       getSearchSettingsFromServer(),\n-      // Do not convert query string params to search options in Selection Session.\n-      isSelectionSessionOpen()\n+      // If the search option already exists, don't do query string conversion.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71cc4ce767494e3fc2235d38fe27d59d05b40ef6"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQyODQwMTE4OnYy", "diffSide": "RIGHT", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/SearchPage.tsx", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QyMzo1NjozM1rOIINpkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QyMzo1NjozM1rOIINpkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ4MzE1NA==", "bodyText": "We have a few comments like this scattered around the place, what's really missing though is the why. Could you please add that here.", "url": "https://github.com/openequella/openEQUELLA/pull/2614#discussion_r545483154", "createdAt": "2020-12-17T23:56:33Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/SearchPage.tsx", "diffHunk": "@@ -197,10 +197,16 @@ const SearchPage = ({ updateTemplate }: TemplateUpdateProps) => {\n   }, [searchPageOptions]);\n \n   useEffect(() => {\n-    history.replace({\n-      ...history.location,\n-      state: { searchPageOptions, filterExpansion },\n-    });\n+    // Don't manipulate the history for the initial search if the search\n+    // option is the default one.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71cc4ce767494e3fc2235d38fe27d59d05b40ef6"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQyODQ0NDc4OnYy", "diffSide": "RIGHT", "path": "Source/Plugins/Core/com.equella.core/src/com/tle/web/searching/section/SearchQuerySection.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMDoxNDowOFrOIIOBlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMDoyMzoyOFrOIIOOGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ4OTMwMw==", "bodyText": "As discussed, probably want to rework to this rough idea - maybe need try/catch too.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                String basicUrl = info.getPublicBookmark().getHref();\n          \n          \n            \n            \n          \n          \n            \n                String queryString = ((InfoBookmark) info.getPublicBookmark()).getQuery();\n          \n          \n            \n                if (queryString.isEmpty()) {\n          \n          \n            \n                  basicUrl = basicUrl + \"?\";\n          \n          \n            \n                }\n          \n          \n            \n                from.forwardToUrl(basicUrl + \"&q=\" + query);\n          \n          \n            \n                URL basicUrl = new URL(info.getPublicBookmark().getHref());\n          \n          \n            \n                \n          \n          \n            \n                from.forwardToURL(\n          \n          \n            \n                  basicUrl.toString()\n          \n          \n            \n                  + (basicUrl.getQuery().isEmpty() ? \"?\" : \"&\")\n          \n          \n            \n                  + \"q=\" + query));", "url": "https://github.com/openequella/openEQUELLA/pull/2614#discussion_r545489303", "createdAt": "2020-12-18T00:14:08Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/src/com/tle/web/searching/section/SearchQuerySection.java", "diffHunk": "@@ -623,6 +623,22 @@ private void doBasicSearch(SectionInfo info, String query) {\n     searchResults.startSearch(info);\n   }\n \n+  public static void basicSearchForNewSearch(\n+      SectionInfo from, String query, boolean inSelectOrAdd) {\n+    // In selectOrAdd the endpoint is '/selectoradd/searching.do'.\n+    SectionInfo info =\n+        inSelectOrAdd\n+            ? from.createForward(SearchSelectable.NEW_FORWARD_PATH)\n+            : RootSearchSection.createForward(from);\n+    String basicUrl = info.getPublicBookmark().getHref();\n+\n+    String queryString = ((InfoBookmark) info.getPublicBookmark()).getQuery();\n+    if (queryString.isEmpty()) {\n+      basicUrl = basicUrl + \"?\";\n+    }\n+    from.forwardToUrl(basicUrl + \"&q=\" + query);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71cc4ce767494e3fc2235d38fe27d59d05b40ef6"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ5MjUwNA==", "bodyText": "Oops.... URL.getQuery() returns null if there is no query, so that should be basicUrl.getQuery() == null.", "url": "https://github.com/openequella/openEQUELLA/pull/2614#discussion_r545492504", "createdAt": "2020-12-18T00:23:28Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/src/com/tle/web/searching/section/SearchQuerySection.java", "diffHunk": "@@ -623,6 +623,22 @@ private void doBasicSearch(SectionInfo info, String query) {\n     searchResults.startSearch(info);\n   }\n \n+  public static void basicSearchForNewSearch(\n+      SectionInfo from, String query, boolean inSelectOrAdd) {\n+    // In selectOrAdd the endpoint is '/selectoradd/searching.do'.\n+    SectionInfo info =\n+        inSelectOrAdd\n+            ? from.createForward(SearchSelectable.NEW_FORWARD_PATH)\n+            : RootSearchSection.createForward(from);\n+    String basicUrl = info.getPublicBookmark().getHref();\n+\n+    String queryString = ((InfoBookmark) info.getPublicBookmark()).getQuery();\n+    if (queryString.isEmpty()) {\n+      basicUrl = basicUrl + \"?\";\n+    }\n+    from.forwardToUrl(basicUrl + \"&q=\" + query);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ4OTMwMw=="}, "originalCommit": {"oid": "71cc4ce767494e3fc2235d38fe27d59d05b40ef6"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQyODYxNjI1OnYy", "diffSide": "RIGHT", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/SearchPage.tsx", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMToyNzo0NlrOIIPgIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMToyNzo0NlrOIIPgIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUxMzUwNg==", "bodyText": "with the return, else is not needed\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  return;\n          \n          \n            \n                } else {\n          \n          \n            \n                  history.replace({\n          \n          \n            \n                    ...history.location,\n          \n          \n            \n                    state: { searchPageOptions, filterExpansion },\n          \n          \n            \n                  });\n          \n          \n            \n                }\n          \n          \n            \n                  return;\n          \n          \n            \n                }\n          \n          \n            \n                history.replace({\n          \n          \n            \n                  ...history.location,\n          \n          \n            \n                  state: { searchPageOptions, filterExpansion },\n          \n          \n            \n                });", "url": "https://github.com/openequella/openEQUELLA/pull/2614#discussion_r545513506", "createdAt": "2020-12-18T01:27:46Z", "author": {"login": "ChristianMurphy"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/SearchPage.tsx", "diffHunk": "@@ -197,10 +197,19 @@ const SearchPage = ({ updateTemplate }: TemplateUpdateProps) => {\n   }, [searchPageOptions]);\n \n   useEffect(() => {\n-    history.replace({\n-      ...history.location,\n-      state: { searchPageOptions, filterExpansion },\n-    });\n+    // If search page is open from a URL which has some query params, updating browser\n+    // history for the initial search will produce wrong search option for the second\n+    // render. This is because in the second render, we ignore the query param conversion\n+    // as the history data has higher priority. So the end result is wrong search options\n+    // are displayed in the page.\n+    if (isInitialSearch && searchPageOptions === defaultSearchPageOptions) {\n+      return;\n+    } else {\n+      history.replace({\n+        ...history.location,\n+        state: { searchPageOptions, filterExpansion },\n+      });\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89cf9d94d0bc4332f0ce92f637dc4b448c488465"}, "originalPosition": 59}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1637, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}