{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgyMzc0MDk0", "number": 2259, "title": "Feature/facet selector integration", "bodyText": "#1306\nChecklist\n\n the [contributor license agreement][] is signed\n commit message follows [commit guidelines][]\n tests are included\n screenshots are included showing significant UI changes\n documentation is changed or added\n\nDescription of change\nAccording to the latest discussions, we want to refactor the Category Selector for below changes:\n\nEach Classification is joined by AND;\nEach category of a Classification is joined by OR;\nSelected categories that do not apply to current search criteria are still displayed and their counts are 0 so that users can deselect them;\nTo generate a where clause for updating one Classification, only categories selected from other Classifications are used.\nThe Classification panel do not show if all Classifications do not have categories for selecting.", "createdAt": "2020-09-09T00:00:51Z", "url": "https://github.com/openequella/openEQUELLA/pull/2259", "merged": true, "mergeCommit": {"oid": "c31429f1031673ebaaab8483e3665dd82865a616"}, "closed": true, "closedAt": "2020-09-10T02:14:00Z", "author": {"login": "PenghaiZhang"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdGwA0TgH2gAyNDgyMzc0MDk0OjhiYmJhOWViYmZiZjVlMmMzMjc0MGUyMGY0YzM1M2EyMDdhZTdiZGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHVJHUAH2gAyNDgyMzc0MDk0OmY4NDYwZDI0NjA0M2Y2NTIzYTYxY2IwZDdiOGNkZjIxNjY4ZDg0NzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8bbba9ebbfbf5e2c32740e20f4c353a207ae7bdf", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/8bbba9ebbfbf5e2c32740e20f4c353a207ae7bdf", "committedDate": "2020-09-08T04:37:07Z", "message": "Don't show the Classification panel if there are no Classifications configured."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aad1c5b7be7ba4e6523343a315d26c6046f3f879", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/aad1c5b7be7ba4e6523343a315d26c6046f3f879", "committedDate": "2020-09-08T04:44:27Z", "message": "Refactor the logic of generating category where clause\n\nEach Classification should be joined by AND, and each selected category\nof one Classification should be joined by OR."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fc12b7e4f8c3f27178ff28f793e1690168e6d92", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/9fc12b7e4f8c3f27178ff28f793e1690168e6d92", "committedDate": "2020-09-08T04:46:38Z", "message": "Refactor SearchFacetsModule for where clause\n\nA where clause for each Classification should only use categories\nof other Classifications"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac7b43a58d8e72ccbc90366614d1bc7b183e71a2", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/ac7b43a58d8e72ccbc90366614d1bc7b183e71a2", "committedDate": "2020-09-08T05:00:02Z", "message": "Refactor Category Selector.\n\nCategories that have been selected but no longer apply to current\nsearch criteria should be displayed as well, and their counts are\n0."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f5c199b39b0ead1b834e6874c2ac37466b98f8d", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/3f5c199b39b0ead1b834e6874c2ac37466b98f8d", "committedDate": "2020-09-08T06:03:58Z", "message": "Update Search module test for the where clause change."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60493f59770677cee1748dd8ab7eeded34361082", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/60493f59770677cee1748dd8ab7eeded34361082", "committedDate": "2020-09-08T23:02:40Z", "message": "The Classification panel should not display if all Classifications have\nno categories."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NTcxNzQ2", "url": "https://github.com/openequella/openEQUELLA/pull/2259#pullrequestreview-484571746", "createdAt": "2020-09-09T00:04:33Z", "commit": {"oid": "60493f59770677cee1748dd8ab7eeded34361082"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMDowNDozM1rOHOx9QQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMDowNDozM1rOHOx9QQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI2MDYwOQ==", "bodyText": "It was struggling for me to give proper names in this function. so HELP wanted.", "url": "https://github.com/openequella/openEQUELLA/pull/2259#discussion_r485260609", "createdAt": "2020-09-09T00:04:33Z", "author": {"login": "PenghaiZhang"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/CategorySelector.tsx", "diffHunk": "@@ -212,21 +212,28 @@ export const CategorySelector = ({\n   ): ReactElement[] => {\n     const selectedTerms: string[] =\n       selectedCategories?.find((c) => c.id === id)?.categories ?? [];\n-    const selectedFacets: OEQ.SearchFacets.Facet[] = selectedTerms.map(\n-      (selectedTerm) => {\n-        const facet = categories.find((c) => selectedTerm === c.term);\n-        if (!facet) {\n-          throw new Error(\n-            \"Data integrity issue, we're unable to match a selected term.\"\n-          );\n-        }\n \n-        return facet;\n-      }\n+    // Previously selected categories that still apply to current search criteria.\n+    const selectedAndExist = categories.filter((c) =>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60493f59770677cee1748dd8ab7eeded34361082"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NjUxNDY2", "url": "https://github.com/openequella/openEQUELLA/pull/2259#pullrequestreview-484651466", "createdAt": "2020-09-09T04:25:36Z", "commit": {"oid": "60493f59770677cee1748dd8ab7eeded34361082"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNDoyNTozNlrOHO2J-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNDoyNTo1N1rOHO2KSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMyOTQwMA==", "bodyText": "You could go with:\n\nselectedApplicable\nselectedNotApplicable\nnotSelected\n\nAnd to further this idea, it'd be great to maintain the relationships here strictly back to selectedTerms. So how about changing the first two sets to be processed with something like:\nconst [selectedApplicable, selectedNotApplicable] =\n  selectedTerms.reduce<[OEQ.SearchFacets.Facet[], OEQ.SearchFacets.Facet[]]>(\n    ([applicable, notApplicable], term) => {\n      const applicableCategory = category.find( c => c.term === term );\n      return applicableCategory\n        ? [applicable.concat(applicableCategory), notApplicable]\n        : [applicable, notApplicable.concat({term: term, count: 0});\n    }, [[], []]);\nThis is a bit more verbose, but it ties it the data structure it is being generated from, and so I think it's worth that.", "url": "https://github.com/openequella/openEQUELLA/pull/2259#discussion_r485329400", "createdAt": "2020-09-09T04:25:36Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/CategorySelector.tsx", "diffHunk": "@@ -212,21 +212,28 @@ export const CategorySelector = ({\n   ): ReactElement[] => {\n     const selectedTerms: string[] =\n       selectedCategories?.find((c) => c.id === id)?.categories ?? [];\n-    const selectedFacets: OEQ.SearchFacets.Facet[] = selectedTerms.map(\n-      (selectedTerm) => {\n-        const facet = categories.find((c) => selectedTerm === c.term);\n-        if (!facet) {\n-          throw new Error(\n-            \"Data integrity issue, we're unable to match a selected term.\"\n-          );\n-        }\n \n-        return facet;\n-      }\n+    // Previously selected categories that still apply to current search criteria.\n+    const selectedAndExist = categories.filter((c) =>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI2MDYwOQ=="}, "originalCommit": {"oid": "60493f59770677cee1748dd8ab7eeded34361082"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMyOTQ4MA==", "bodyText": "I'm guess this is a typo and should be:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                const noSelected = categories.filter(\n          \n          \n            \n                const notSelected = categories.filter(", "url": "https://github.com/openequella/openEQUELLA/pull/2259#discussion_r485329480", "createdAt": "2020-09-09T04:25:57Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/CategorySelector.tsx", "diffHunk": "@@ -212,21 +212,28 @@ export const CategorySelector = ({\n   ): ReactElement[] => {\n     const selectedTerms: string[] =\n       selectedCategories?.find((c) => c.id === id)?.categories ?? [];\n-    const selectedFacets: OEQ.SearchFacets.Facet[] = selectedTerms.map(\n-      (selectedTerm) => {\n-        const facet = categories.find((c) => selectedTerm === c.term);\n-        if (!facet) {\n-          throw new Error(\n-            \"Data integrity issue, we're unable to match a selected term.\"\n-          );\n-        }\n \n-        return facet;\n-      }\n+    // Previously selected categories that still apply to current search criteria.\n+    const selectedAndExist = categories.filter((c) =>\n+      selectedTerms.includes(c.term)\n     );\n-    const orderedFacets = selectedFacets.concat(\n-      categories.filter((c) => !selectedFacets.includes(c))\n+\n+    // Previously selected categories that do not apply to current search criteria.\n+    // Their counts should be 0.\n+    const selectedButDisappear = selectedTerms\n+      .filter((t) => categories.every((c) => c.term !== t))\n+      .map((t) => ({ term: t, count: 0 }));\n+\n+    // Categories that apply to current search criteria but have not been selected.\n+    const noSelected = categories.filter(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60493f59770677cee1748dd8ab7eeded34361082"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b823a3f1f07f6ad1ea74716b4ce31e09ce76278e", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/b823a3f1f07f6ad1ea74716b4ce31e09ce76278e", "committedDate": "2020-09-09T05:02:59Z", "message": "Simplify function 'listCategories' and use proper names."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28db24d4e9d92f74d97080025afe8f9387ee030f", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/28db24d4e9d92f74d97080025afe8f9387ee030f", "committedDate": "2020-09-09T05:17:56Z", "message": "Update JSDoc for Search Module and Search Facet Module."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8460d246043f6523a61cb0d7b8cdf21668d8472", "author": {"user": {"login": "PenghaiZhang", "name": null}}, "url": "https://github.com/openequella/openEQUELLA/commit/f8460d246043f6523a61cb0d7b8cdf21668d8472", "committedDate": "2020-09-09T23:52:40Z", "message": "Refactor the rule for showing 'SHOW MORE' buttons.\n\nBecause categories that are not applicable but were previously\nselected are also displayed now, we need to take into account these\ncategories for displaying the 'SHOW MORE' buttons."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 447, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}