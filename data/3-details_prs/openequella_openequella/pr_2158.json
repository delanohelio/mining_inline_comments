{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1Mjg3MTMx", "number": 2158, "title": "EBP: Updates to legacy.scss do not show up properly until theme changes happen", "bodyText": "Checklist\n\n\n the contributor license agreement is signed\n commit message follows commit guidelines\n\nDescription of change\n#2107\nThe issue was caused by the lastModified check on the legacy.scss file.\nCreating a new File() with getResource().getFile() worked fine in a dev environment - but in an installed oEQ\nthis file would be inside a jar and wouldn't work. The lastModified date would always return 0.\nThis PR changes to use an URLConnection to the same file to grab the value and then close the stream, and I have tested this via installerZip.", "createdAt": "2020-08-10T05:45:30Z", "url": "https://github.com/openequella/openEQUELLA/pull/2158", "merged": true, "mergeCommit": {"oid": "f9e2ac3d4dcd76476ee918f115b8539fae8e8a4c"}, "closed": true, "closedAt": "2020-08-10T22:54:41Z", "author": {"login": "SammyIsConfused"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9bh68gH2gAyNDY1Mjg3MTMxOjY0OWRkZjYxZWVmYjBjZDNjNTk5MGJiY2NlMGI3ZmJkZDQ4MWJhMmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc9dS_RgFqTQ2NDAxNDE2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "649ddf61eefb0cd3c5990bbcce0b7fbdd481ba2f", "author": {"user": null}, "url": "https://github.com/openequella/openEQUELLA/commit/649ddf61eefb0cd3c5990bbcce0b7fbdd481ba2f", "committedDate": "2020-08-10T05:39:57Z", "message": "Use an URLConnection to get the last modified date\n\nAs opposed to creating a new File() directly with a .getResource\ncall - as this fails when legacy.scss is in a jar."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f87bfa24d6e325ddf1771ff14e87d93ce422fe3", "author": {"user": null}, "url": "https://github.com/openequella/openEQUELLA/commit/6f87bfa24d6e325ddf1771ff14e87d93ce422fe3", "committedDate": "2020-08-10T06:15:14Z", "message": "Run Java formatter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzOTgwNDE3", "url": "https://github.com/openequella/openEQUELLA/pull/2158#pullrequestreview-463980417", "createdAt": "2020-08-10T06:27:52Z", "commit": {"oid": "6f87bfa24d6e325ddf1771ff14e87d93ce422fe3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwNjoyNzo1MlrOG-CoHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwNjoyNzo1MlrOG-CoHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcwNzkzNQ==", "bodyText": "The logic for this used to be:\n\n!legacyCssExists OR baseSassUpdated\n\nNow it's:\n\nlegacyCssExists AND baseSassUpdated\n\nI believe that means on the first run of a fresh system, this will not get generated.", "url": "https://github.com/openequella/openEQUELLA/pull/2158#discussion_r467707935", "createdAt": "2020-08-10T06:27:52Z", "author": {"login": "edalex-ian"}, "path": "Source/Plugins/Core/com.equella.core/src/com/tle/core/settings/service/impl/ThemeSettingsServiceImpl.java", "diffHunk": "@@ -165,16 +166,22 @@ private String themeToJSONString(NewUITheme theme) throws JsonProcessingExceptio\n   }\n \n   public InputStream getLegacyCss() throws IOException {\n-    File baseLegacySass =\n-        new File(getClass().getResource(\"/web/sass/\" + SASS_LEGACY_CSS_FILENAME).getFile());\n     CustomisationFile customisationFile = new CustomisationFile();\n-    boolean legacyCssExists = fileSystemService.fileExists(customisationFile, LEGACY_CSS_FILENAME);\n-    boolean baseSassUpdated =\n-        baseLegacySass.lastModified()\n-            > fileSystemService.lastModified(customisationFile, LEGACY_CSS_FILENAME);\n \n-    if (!legacyCssExists || baseSassUpdated) {\n-      compileSass();\n+    // get last modified date of the scss file\n+    URLConnection conn =\n+        getClass().getResource(\"/web/sass/\" + SASS_LEGACY_CSS_FILENAME).openConnection();\n+    long lastMod = conn.getLastModified();\n+    conn.getInputStream().close();\n+\n+    // compare against the modified date of the css file if it exists\n+    boolean legacyCssExists = fileSystemService.fileExists(customisationFile, LEGACY_CSS_FILENAME);\n+    if (legacyCssExists) {\n+      long cssLastMod = fileSystemService.lastModified(customisationFile, LEGACY_CSS_FILENAME);\n+      boolean baseSassUpdated = lastMod > cssLastMod;\n+      if (baseSassUpdated) {\n+        compileSass();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f87bfa24d6e325ddf1771ff14e87d93ce422fe3"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52990a3584c5ee8a391e230c4bdbe643187007f6", "author": {"user": null}, "url": "https://github.com/openequella/openEQUELLA/commit/52990a3584c5ee8a391e230c4bdbe643187007f6", "committedDate": "2020-08-10T06:52:16Z", "message": "Fix logic to handle case in which compiled css file does not exist"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MDE0MTY4", "url": "https://github.com/openequella/openEQUELLA/pull/2158#pullrequestreview-464014168", "createdAt": "2020-08-10T07:43:27Z", "commit": {"oid": "52990a3584c5ee8a391e230c4bdbe643187007f6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4886, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}