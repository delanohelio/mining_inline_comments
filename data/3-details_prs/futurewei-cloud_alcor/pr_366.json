{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1MjUzNjg2", "number": 366, "title": "[Port Manager] Support L2 and L3 Type Neighbors", "bodyText": "This PR proposes the following changes to Port Manager and DPM:\n\nPM interacts with RM to obtain connected subnet ids when create a non-gateway port.\nUpdate neighbor tables and send them to DPM when adding/deleting a gateway port in Neutron L3 routing scenario.\nRefactor DPM service/controller codes and develop a generic DP client for various implementations.", "createdAt": "2020-08-28T08:06:17Z", "url": "https://github.com/futurewei-cloud/alcor/pull/366", "merged": true, "mergeCommit": {"oid": "a9f8efb58edfb6bf193a958b51979641088a4334"}, "closed": true, "closedAt": "2020-09-25T07:00:36Z", "author": {"login": "chenpiaoping"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEOJ4oABqjM3MDg3MTk2NzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMQQE3AFqTQ5NjE1NzUwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ec42752477569debdf970b1c63c9aa67433493dc", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/ec42752477569debdf970b1c63c9aa67433493dc", "committedDate": "2020-08-28T08:02:39Z", "message": "Interact with RM to obtain connected subnets and updating neighbor information when gateway port add or delete"}, "afterCommit": {"oid": "b591796240905b76603b8f21da3970e56fe6af7f", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/b591796240905b76603b8f21da3970e56fe6af7f", "committedDate": "2020-08-31T08:01:51Z", "message": "Update PM-DPM contract"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b591796240905b76603b8f21da3970e56fe6af7f", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/b591796240905b76603b8f21da3970e56fe6af7f", "committedDate": "2020-08-31T08:01:51Z", "message": "Update PM-DPM contract"}, "afterCommit": {"oid": "57d058633948ed1c8c7ae987153e2142fbd3605c", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/57d058633948ed1c8c7ae987153e2142fbd3605c", "committedDate": "2020-08-31T08:04:15Z", "message": "Update PM-DPM contract"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "57d058633948ed1c8c7ae987153e2142fbd3605c", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/57d058633948ed1c8c7ae987153e2142fbd3605c", "committedDate": "2020-08-31T08:04:15Z", "message": "Update PM-DPM contract"}, "afterCommit": {"oid": "10cbf00ea7de8c3fed647216f41b5ade399ccbe5", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/10cbf00ea7de8c3fed647216f41b5ade399ccbe5", "committedDate": "2020-08-31T08:10:37Z", "message": "Update PM-DPM contract"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "10cbf00ea7de8c3fed647216f41b5ade399ccbe5", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/10cbf00ea7de8c3fed647216f41b5ade399ccbe5", "committedDate": "2020-08-31T08:10:37Z", "message": "Update PM-DPM contract"}, "afterCommit": {"oid": "6d4037753129dbabfa83f24b06eacc1e10a21d30", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/6d4037753129dbabfa83f24b06eacc1e10a21d30", "committedDate": "2020-08-31T08:12:19Z", "message": "Update PM-DPM contract"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5MjU5ODU5", "url": "https://github.com/futurewei-cloud/alcor/pull/366#pullrequestreview-479259859", "createdAt": "2020-09-01T01:15:15Z", "commit": {"oid": "6d4037753129dbabfa83f24b06eacc1e10a21d30"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwMToxNToxNVrOHKRuow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwMToxNToxNVrOHKRuow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDUzODI3NQ==", "bodyText": "I suggest that using PUT for this api, then it will become /project/{project_id}/update-l3-neighbors/{new_subnet_id}.\nThe BODY becomes {operation_type, vpcid, [old_subnet_ids]}", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r480538275", "createdAt": "2020-09-01T01:15:15Z", "author": {"login": "cj-chung"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/controller/PortController.java", "diffHunk": "@@ -203,4 +205,22 @@ public PortWebBulkJson listPort(@PathVariable(\"project_id\") String projectId) th\n \n         return new PortWebBulkJson(portsList);\n     }\n+\n+    /**\n+     * Update neighbor tables and send them to DPM when adding or deleting gateway port\n+     * @param projectId Project Id\n+     * @param routerSubnetUpdateInfo Router's latest subnet information\n+     * @return RouterSubnetUpdateInfo\n+     * @throws Exception Db operation exception\n+     */\n+    @Rbac(resource =\"port\")\n+    @PostMapping({\"/project/{project_id}/update-l3-neighbors\", \"v4/{project_id}/update-l3-neighbors\"})\n+    @ResponseBody\n+    @ResponseStatus(HttpStatus.CREATED)\n+    @DurationStatistics\n+    public RouterSubnetUpdateInfo updateL3Neighbors(@PathVariable(\"project_id\") String projectId,\n+                                                    @RequestBody RouterSubnetUpdateInfo routerSubnetUpdateInfo) throws Exception {\n+        checkRouterSubnetUpdateInfo(routerSubnetUpdateInfo);\n+        return portService.updateL3Neighbors(projectId, routerSubnetUpdateInfo);\n+    }\n }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d4037753129dbabfa83f24b06eacc1e10a21d30"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c4d8143c2b740a8141d0e927641daad34e5e1c6", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/9c4d8143c2b740a8141d0e927641daad34e5e1c6", "committedDate": "2020-09-17T03:11:15Z", "message": "Get connected subnets from router manager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8878e961b30af52b999e0110762b68f1fcdf05e", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/a8878e961b30af52b999e0110762b68f1fcdf05e", "committedDate": "2020-09-17T03:11:21Z", "message": "Interact with RM to obtain connected subnets and updating neighbor information when gateway port add or delete"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "467677f446edfab763ceb8abca65f8197d0deb8a", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/467677f446edfab763ceb8abca65f8197d0deb8a", "committedDate": "2020-09-17T03:11:24Z", "message": "Update PM-DPM contract"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96f38b3ebbd284934bb71910fcda0e90dc218fca", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/96f38b3ebbd284934bb71910fcda0e90dc218fca", "committedDate": "2020-09-17T03:11:30Z", "message": "DPM support pulsar"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2742ecd1e4487c6b82991128e87cb59b60b82bcc", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/2742ecd1e4487c6b82991128e87cb59b60b82bcc", "committedDate": "2020-09-19T07:09:42Z", "message": "update PM-RM contract"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6d4037753129dbabfa83f24b06eacc1e10a21d30", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/6d4037753129dbabfa83f24b06eacc1e10a21d30", "committedDate": "2020-08-31T08:12:19Z", "message": "Update PM-DPM contract"}, "afterCommit": {"oid": "2742ecd1e4487c6b82991128e87cb59b60b82bcc", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/2742ecd1e4487c6b82991128e87cb59b60b82bcc", "committedDate": "2020-09-19T07:09:42Z", "message": "update PM-RM contract"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/245c1ebcb14f8fd99b31482ee09b7d31ca6e460f", "committedDate": "2020-09-19T07:22:11Z", "message": "Turn off all UTs of DPM temporarily"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMTE0MzIw", "url": "https://github.com/futurewei-cloud/alcor/pull/366#pullrequestreview-493114320", "createdAt": "2020-09-22T04:02:54Z", "commit": {"oid": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNDowMjo1NVrOHVpipA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNDowMzoyOVrOHVpjAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ2Mjc1Ng==", "bodyText": "Don't think this is going to work. We should use /project/%s", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r492462756", "createdAt": "2020-09-22T04:02:55Z", "author": {"login": "xieus"}, "path": "web/src/main/java/com/futurewei/alcor/web/restclient/RouterManagerRestClient.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.web.restclient;\n+\n+import com.futurewei.alcor.web.entity.port.PortEntity;\n+import com.futurewei.alcor.web.entity.route.ConnectedSubnetsWebResponse;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Configuration;\n+\n+@Configuration\n+public class RouterManagerRestClient extends AbstractRestClient {\n+    @Value(\"${microservices.router.service.url:#{\\\"\\\"}}\")\n+    private String routerManagerUrl;\n+\n+    public ConnectedSubnetsWebResponse getRouterSubnets(String projectId, String vpcId, String subnetId) throws Exception {\n+        String url = String.format(\"/project/%s/vpcs/%s/subnets/%s/connected-subnets\", projectId, vpcId, subnetId);\n+        ConnectedSubnetsWebResponse routerSubnets = restTemplate.getForObject(url, ConnectedSubnetsWebResponse.class);\n+        if (routerSubnets == null) {\n+            throw new Exception(\"Get router connected subnets failed\");\n+        }\n+\n+        return routerSubnets;\n+    }\n+\n+    public void addRouterInterface(String routerId, PortEntity portEntity) {\n+        String url = String.format(\"/v2.0/routers/%s/add_router_interface\", routerId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ2Mjg1MQ==", "bodyText": "This url doesn't include routeManagerUrl.", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r492462851", "createdAt": "2020-09-22T04:03:29Z", "author": {"login": "xieus"}, "path": "web/src/main/java/com/futurewei/alcor/web/restclient/RouterManagerRestClient.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.web.restclient;\n+\n+import com.futurewei.alcor.web.entity.port.PortEntity;\n+import com.futurewei.alcor.web.entity.route.ConnectedSubnetsWebResponse;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Configuration;\n+\n+@Configuration\n+public class RouterManagerRestClient extends AbstractRestClient {\n+    @Value(\"${microservices.router.service.url:#{\\\"\\\"}}\")\n+    private String routerManagerUrl;\n+\n+    public ConnectedSubnetsWebResponse getRouterSubnets(String projectId, String vpcId, String subnetId) throws Exception {\n+        String url = String.format(\"/project/%s/vpcs/%s/subnets/%s/connected-subnets\", projectId, vpcId, subnetId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMTQyMDYy", "url": "https://github.com/futurewei-cloud/alcor/pull/366#pullrequestreview-493142062", "createdAt": "2020-09-22T05:52:37Z", "commit": {"oid": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNTo1MjozN1rOHVrDqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNjowNzoxMFrOHVrTdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ4NzU5NQ==", "bodyText": "Could you add a comment to show this is a mapping from vpc_id to a list of subnet ids?\nbtw, do we have more than one vpc that a port needs to worry about here?", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r492487595", "createdAt": "2020-09-22T05:52:37Z", "author": {"login": "xieus"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/PortContext.java", "diffHunk": "@@ -34,6 +37,8 @@\n     private List<PortEntity> portEntities; //For add and delete\n     private PortEntity oldPortEntity; //For update\n     private PortEntity newPortEntity; //For update\n+    private Map<String, List<String>> routerSubnetIds;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ4ODk5MQ==", "bodyText": "Glad to see that PM starts supporting multiple IPs \ud83d\udc4d", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r492488991", "createdAt": "2020-09-22T05:57:51Z", "author": {"login": "xieus"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/DatabaseProcessor.java", "diffHunk": "@@ -44,16 +51,15 @@ void createProcess(PortContext context) throws Exception {\n         NetworkConfig networkConfig = context.getNetworkConfig();\n         List<InternalPortEntity> internalPortEntities = networkConfig.getPortEntities();\n         for (InternalPortEntity internalPortEntity : internalPortEntities) {\n-            NeighborInfo neighborInfo = buildNeighborInfo(internalPortEntity);\n-            if (neighborInfo == null) {\n+            List<NeighborInfo> neighborInfoList = buildNeighborInfos(internalPortEntity);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ4OTY5Mw==", "bodyText": "Does this TODO get implemented already?", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r492489693", "createdAt": "2020-09-22T06:00:29Z", "author": {"login": "xieus"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/DatabaseProcessor.java", "diffHunk": "@@ -22,19 +22,26 @@\n import java.util.*;\n \n public class DatabaseProcessor extends AbstractProcessor {\n-    private NeighborInfo buildNeighborInfo(InternalPortEntity internalPortEntity) {\n+    private List<NeighborInfo> buildNeighborInfos(InternalPortEntity internalPortEntity) {\n+        List<NeighborInfo> neighborInfos = new ArrayList<>();\n         String bindingHostIp = internalPortEntity.getBindingHostIP();\n         if (bindingHostIp == null) {\n-            return null;\n+            return neighborInfos;\n         }\n \n-        NeighborInfo neighborInfo = new NeighborInfo(bindingHostIp,\n-                internalPortEntity.getBindingHostId(),\n-                internalPortEntity.getId(),\n-                internalPortEntity.getMacAddress(),\n-                internalPortEntity.getFixedIps().get(0).getIpAddress());\n+        //TODO: Support a port with multiple neighborInfos", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ5MTYzOA==", "bodyText": "What if neighborInfos contains some duplicated neighbors? Is it possible?", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r492491638", "createdAt": "2020-09-22T06:07:10Z", "author": {"login": "xieus"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/NeighborProcessor.java", "diffHunk": "@@ -18,34 +18,31 @@\n import com.futurewei.alcor.portmanager.entity.PortNeighbors;\n import com.futurewei.alcor.portmanager.request.FetchPortNeighborRequest;\n import com.futurewei.alcor.portmanager.request.IRestRequest;\n-import com.futurewei.alcor.web.entity.dataplane.InternalPortEntity;\n import com.futurewei.alcor.web.entity.dataplane.NeighborInfo;\n import com.futurewei.alcor.web.entity.port.PortEntity;\n \n-import java.util.ArrayList;\n-import java.util.Collections;\n-import java.util.List;\n-import java.util.Set;\n+import java.util.*;\n import java.util.stream.Collectors;\n \n public class NeighborProcessor extends AbstractProcessor {\n     private void fetchPortNeighborCallback(IRestRequest request) {\n         List<PortNeighbors> portNeighborsList = ((FetchPortNeighborRequest) request).getPortNeighborsList();\n-        List<InternalPortEntity> internalPortEntities =\n-                request.getContext().getNetworkConfig().getPortEntities();\n-\n-        for (InternalPortEntity internalPortEntity : internalPortEntities) {\n-            for (PortNeighbors portNeighbors: portNeighborsList) {\n-                if (portNeighbors.getNeighbors() == null) {\n-                    continue;\n-                }\n+        if (portNeighborsList == null || portNeighborsList.size() == 0) {\n+            return;\n+        }\n \n-                if (internalPortEntity.getVpcId().equals(portNeighbors.getVpcId())) {\n-                    List<NeighborInfo> neighborInfos = new ArrayList<>(portNeighbors.getNeighbors().values());\n-                    internalPortEntity.setNeighborInfos(neighborInfos);\n-                }\n+        List<NeighborInfo> neighborInfos = new ArrayList<>();\n+        for (PortNeighbors portNeighbors: portNeighborsList) {\n+            if (portNeighbors.getNeighbors() == null ||\n+                    portNeighbors.getNeighbors().size() == 0) {\n+                continue;\n             }\n+\n+            neighborInfos.addAll(portNeighbors.getNeighbors().values());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMTU1MDI4", "url": "https://github.com/futurewei-cloud/alcor/pull/366#pullrequestreview-493155028", "createdAt": "2020-09-22T06:26:45Z", "commit": {"oid": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce077dbb8a2873702981ba9e612fdab45917d2ae", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/ce077dbb8a2873702981ba9e612fdab45917d2ae", "committedDate": "2020-09-22T07:08:48Z", "message": "Correct the url of connected-subnets interface"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7dd1aeda09c727be089451465646c45c2a8b0dd4", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/7dd1aeda09c727be089451465646c45c2a8b0dd4", "committedDate": "2020-09-24T07:02:50Z", "message": "Add testcase for updateL3Neighbor interface"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NzY2NTcx", "url": "https://github.com/futurewei-cloud/alcor/pull/366#pullrequestreview-495766571", "createdAt": "2020-09-24T16:50:51Z", "commit": {"oid": "7dd1aeda09c727be089451465646c45c2a8b0dd4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNjo1MDo1MVrOHXj4Zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNjo1MDo1MVrOHXj4Zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ2NzE3NQ==", "bodyText": "We would need a case-insensitive check.", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494467175", "createdAt": "2020-09-24T16:50:51Z", "author": {"login": "xieus"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/util/RestParameterValidator.java", "diffHunk": "@@ -138,9 +138,9 @@ public static void checkRouterSubnetUpdateInfo(RouterUpdateInfo routerUpdateInfo\n             throw new SubnetIdInvalid();\n         }\n \n-        RouterUpdateInfo.OperationType operationType = routerUpdateInfo.getOperationType();\n-        if (!RouterUpdateInfo.OperationType.ADD.equals(operationType) &&\n-                !RouterUpdateInfo.OperationType.DELETE.equals(operationType)) {\n+        String operationType = routerUpdateInfo.getOperationType();\n+        if (!RouterUpdateInfo.OperationType.ADD.getType().equals(operationType) &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7dd1aeda09c727be089451465646c45c2a8b0dd4"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5ffbfe2b464b115a0cf913c0bc70055652fe347", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/e5ffbfe2b464b115a0cf913c0bc70055652fe347", "committedDate": "2020-09-25T01:47:09Z", "message": "Use the annotation @AfterProcessor to control the order in which processor is executed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2MDcyNjQ5", "url": "https://github.com/futurewei-cloud/alcor/pull/366#pullrequestreview-496072649", "createdAt": "2020-09-25T02:38:44Z", "commit": {"oid": "e5ffbfe2b464b115a0cf913c0bc70055652fe347"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQwMjozODo0NFrOHXy9Bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQwMjo0NToxM1rOHXzEFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxNDExOQ==", "bodyText": "@chenpiaoping trying to understand whether this process relies on the new AfterProcessor annotation. How is the order determined?", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494714119", "createdAt": "2020-09-25T02:38:44Z", "author": {"login": "xieus"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/ProcessorManager.java", "diffHunk": "@@ -27,41 +27,57 @@\n public class ProcessorManager {\n     private static final Logger LOG = LoggerFactory.getLogger(ProcessorManager.class);\n \n-    private static List<IProcessor> statelessProcessors = new ArrayList<>();\n-    private static Map<Class, IProcessor> allProcessors = new HashMap<>();\n-    private static IProcessor headProcessor;\n-    private static IProcessor dataPlaneProcessor;\n-    private static IProcessor databaseProcessor;\n+    private static List<IProcessor> processors = new ArrayList<>();\n+    private static Map<Class, IProcessor> processorMap = new HashMap<>();\n \n     private void buildProcessChain() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5ffbfe2b464b115a0cf913c0bc70055652fe347"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxNTkyNg==", "bodyText": "Could we make the TRY_TIMES and SLEEP_TIME configurable?", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494715926", "createdAt": "2020-09-25T02:45:13Z", "author": {"login": "xieus"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/RouterProcessor.java", "diffHunk": "@@ -36,13 +41,24 @@ private void getRouterSubnetIds(PortContext context, String vpcId, String subnet\n                 fetchRouterSubnetsRequest, this::fetchConnectedSubnetIdsCallback);\n     }\n \n-    private void getRouterSubnetIds(PortContext context, List<PortEntity> portEntities) {\n+    private void getRouterSubnetIds(PortContext context, List<PortEntity> portEntities) throws Exception {\n         Set<String> vpcIds = new HashSet<>();\n+        int tryTimes = TRY_TIMES;\n         for (PortEntity portEntity: portEntities) {\n             if (portEntity.getFixedIps() == null) {\n                 continue;\n             }\n \n+            //Waiting for random ip address to be assigned\n+            while (portEntity.getFixedIps() == null && tryTimes > 0) {\n+                Thread.sleep(SLEEP_TIME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5ffbfe2b464b115a0cf913c0bc70055652fe347"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6741f97fd2feb4cb329eb7623bfb2b41e4e869e0", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/6741f97fd2feb4cb329eb7623bfb2b41e4e869e0", "committedDate": "2020-09-25T03:06:34Z", "message": "Delete some unused comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ccbe473788133d22fb657d1381ea1db620aa398", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/4ccbe473788133d22fb657d1381ea1db620aa398", "committedDate": "2020-09-25T06:35:32Z", "message": "Operation type use case-insensitive check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2MTU3NTA4", "url": "https://github.com/futurewei-cloud/alcor/pull/366#pullrequestreview-496157508", "createdAt": "2020-09-25T07:00:22Z", "commit": {"oid": "4ccbe473788133d22fb657d1381ea1db620aa398"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1915, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}