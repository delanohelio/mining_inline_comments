{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0OTQ4NzQ5", "number": 512, "title": "[Microservice] Move forward to DPM v2.0 APIs", "bodyText": "PM uses the new APIs of DPM\nRemove the usage of deprecating OperationType in PM\nRefactor update-l3-neighbors API to accept a list of gateway port IDs\nDPM handles the configuration information of neighbors", "createdAt": "2020-12-09T06:44:32Z", "url": "https://github.com/futurewei-cloud/alcor/pull/512", "merged": true, "mergeCommit": {"oid": "62e7728a6aa3d87464a756eeaf7b89dc012985f9"}, "closed": true, "closedAt": "2020-12-15T08:00:12Z", "author": {"login": "chenpiaoping"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkY9fuAH2gAyNTM0OTQ4NzQ5OmZjYjdjNTljYTA1M2QzMjI1Y2RmMTk5NDkyYzc3ZTMyOWYyYmIzZmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmVoNagFqTU1MjE4NjM5Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fcb7c59ca053d3225cdf199492c77e329f2bb3fd", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/fcb7c59ca053d3225cdf199492c77e329f2bb3fd", "committedDate": "2020-12-09T06:43:24Z", "message": "pm uses the new APIs of dpm"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67701a0a5492806049b9a406cf332bac5a177833", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/67701a0a5492806049b9a406cf332bac5a177833", "committedDate": "2020-12-09T06:49:40Z", "message": "Remove the usage of deprecating OperationType in PM"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c89fe86ce5cc5a86079be783fe44258ea430d47b", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/c89fe86ce5cc5a86079be783fe44258ea430d47b", "committedDate": "2020-12-09T07:38:50Z", "message": "Refactor update-l3-neighbors API to accept a list of gateway port IDs"}, "afterCommit": {"oid": "4deb5700508382222108a3fc6b0bde5dae322b7e", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/4deb5700508382222108a3fc6b0bde5dae322b7e", "committedDate": "2020-12-09T07:39:47Z", "message": "Refactor update-l3-neighbors API to accept a list of gateway port IDs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5846b1b176c94b57e821dcec833fc475cfd92dde", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/5846b1b176c94b57e821dcec833fc475cfd92dde", "committedDate": "2020-12-09T07:49:10Z", "message": "Refactor update-l3-neighbors API to accept a list of gateway port IDs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4deb5700508382222108a3fc6b0bde5dae322b7e", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/4deb5700508382222108a3fc6b0bde5dae322b7e", "committedDate": "2020-12-09T07:39:47Z", "message": "Refactor update-l3-neighbors API to accept a list of gateway port IDs"}, "afterCommit": {"oid": "5846b1b176c94b57e821dcec833fc475cfd92dde", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/5846b1b176c94b57e821dcec833fc475cfd92dde", "committedDate": "2020-12-09T07:49:10Z", "message": "Refactor update-l3-neighbors API to accept a list of gateway port IDs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c1a2a2ddd8bfe32fe0da34ae4f595598151e6f5", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/4c1a2a2ddd8bfe32fe0da34ae4f595598151e6f5", "committedDate": "2020-12-09T10:14:37Z", "message": "DPM handles the configuration information of neighbors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxMTAwMjQ5", "url": "https://github.com/futurewei-cloud/alcor/pull/512#pullrequestreview-551100249", "createdAt": "2020-12-14T07:29:10Z", "commit": {"oid": "4c1a2a2ddd8bfe32fe0da34ae4f595598151e6f5"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQwNzoyOToxMFrOIFDGRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQwNzo1NToxOVrOIFD2Sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE2NDU1MA==", "bodyText": "This is indeed a better name.", "url": "https://github.com/futurewei-cloud/alcor/pull/512#discussion_r542164550", "createdAt": "2020-12-14T07:29:10Z", "author": {"login": "xieus"}, "path": "services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/client/DataPlaneClient.java", "diffHunk": "@@ -26,7 +26,7 @@\n \n @Component\n public interface DataPlaneClient {\n-    List<String> createGoalStates(List<UnicastGoalState> unicastGoalStates) throws Exception;\n-    List<String> createGoalStates(List<UnicastGoalState> unicastGoalStates,\n-                                  MulticastGoalState multicastGoalState) throws Exception;\n+    List<String> sendGoalStates(List<UnicastGoalState> unicastGoalStates) throws Exception;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c1a2a2ddd8bfe32fe0da34ae4f595598151e6f5"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE2OTUxNA==", "bodyText": "@kevin-zhonghao @cj-chung  FYI. Please review this change as well.", "url": "https://github.com/futurewei-cloud/alcor/pull/512#discussion_r542169514", "createdAt": "2020-12-14T07:39:59Z", "author": {"login": "xieus"}, "path": "web/src/main/java/com/futurewei/alcor/web/entity/route/RouterUpdateInfo.java", "diffHunk": "@@ -29,8 +29,8 @@\n     @JsonProperty(\"operation_type\")\n     private String operationType;\n \n-    @JsonProperty(\"old_subnet_ids\")\n-    private List<String> oldSubnetIds;\n+    @JsonProperty(\"gateway_port_ids\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c1a2a2ddd8bfe32fe0da34ae4f595598151e6f5"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE3MTAwMA==", "bodyText": "@chenpiaoping Please also update the yaml file\n\n  \n    \n      alcor/kubernetes/services/port_manager.yaml\n    \n    \n         Line 23\n      in\n      28cfda5\n    \n    \n    \n    \n\n        \n          \n               microservices.dataplane.service.url=http://dataplanemanager-service.default.svc.cluster.local:9010/v4/port/", "url": "https://github.com/futurewei-cloud/alcor/pull/512#discussion_r542171000", "createdAt": "2020-12-14T07:43:09Z", "author": {"login": "xieus"}, "path": "services/port_manager/src/main/resources/application.properties", "diffHunk": "@@ -8,7 +8,7 @@ microservices.ip.service.url=http://localhost:9004/ips\n microservices.mac.service.url=http://localhost:9005/macs\n microservices.sg.service.url=http://localhost:9008\n microservices.node.service.url=http://localhost:9007/nodes\n-microservices.dataplane.service.url=http://localhost:9010/v4/port/\n+microservices.dataplane.service.url=http://localhost:9010/network-configuration", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c1a2a2ddd8bfe32fe0da34ae4f595598151e6f5"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE3NTE0Nw==", "bodyText": "what if gatewayPortEntities ==null here? Should we add some special handling?", "url": "https://github.com/futurewei-cloud/alcor/pull/512#discussion_r542175147", "createdAt": "2020-12-14T07:52:02Z", "author": {"login": "xieus"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/service/PortServiceImpl.java", "diffHunk": "@@ -208,25 +209,51 @@ public PortWebJson getPort(String projectId, String portId) throws Exception {\n         return result;\n     }\n \n-    private List<NeighborEntry> buildNeighborTable(List<NeighborInfo> localNeighborInfos, List<NeighborInfo> l3Neighbors) {\n-        List<NeighborEntry> neighborTable = new ArrayList<>();\n+    private Map<String, List<NeighborEntry>> buildNeighborTable(List<NeighborInfo> localNeighborInfos, List<NeighborInfo> l3Neighbors) {\n+        Map<String, List<NeighborEntry>> neighborTable = new HashMap<>();\n         for (NeighborInfo localNeighborInfo: localNeighborInfos) {\n+            List<NeighborEntry> neighborEntries = new ArrayList<>();\n             for (NeighborInfo l3Neighbor: l3Neighbors) {\n                 NeighborEntry neighborEntry = new NeighborEntry();\n                 neighborEntry.setNeighborType(NeighborEntry.NeighborType.L3);\n                 neighborEntry.setLocalIp(localNeighborInfo.getPortIp());\n                 neighborEntry.setNeighborIp(l3Neighbor.getPortIp());\n-                neighborTable.add(neighborEntry);\n+                neighborEntries.add(neighborEntry);\n             }\n+\n+            String portIp = localNeighborInfo.getPortIp();\n+            neighborTable.put(portIp, neighborEntries);\n         }\n \n         return neighborTable;\n     }\n \n-    private List<NeighborEntry> updateNeighborTable(RouterUpdateInfo routerUpdateInfo, List<NeighborInfo> neighborInfos) throws CacheException {\n+    private Map<String, List<NeighborEntry>> updateNeighborTable(RouterUpdateInfo routerUpdateInfo, Map<String, NeighborInfo> neighborInfos) throws CacheException {\n         String vpcId = routerUpdateInfo.getVpcId();\n         String subnetId = routerUpdateInfo.getSubnetId();\n-        List<String> oldSubnetIds = routerUpdateInfo.getOldSubnetIds();\n+        List<String> gatewayPortIds = routerUpdateInfo.getGatewayPortIds();\n+        List<String> gatewaySubnetIds = new ArrayList<>();\n+\n+        Map<String, Object[]> filterParams = new HashMap<>();\n+        filterParams.put(\"id\", gatewayPortIds.toArray());\n+        Map<String, PortEntity> gatewayPortEntities = portRepository.findAllPortEntities(filterParams);\n+        if (gatewayPortEntities != null) {\n+            for (Map.Entry<String, PortEntity> entry: gatewayPortEntities.entrySet()) {\n+                PortEntity portEntity = entry.getValue();\n+                List<PortEntity.FixedIp> fixedIps = portEntity.getFixedIps();\n+                if (fixedIps == null) {\n+                    LOG.warn(\"Can not find fixedIp of gateway port: {}\", portEntity);\n+                    continue;\n+                }\n+\n+                for (PortEntity.FixedIp fixedIp: fixedIps) {\n+                    String subnetId1 = fixedIp.getSubnetId();\n+                    if (!StringUtils.isEmpty(subnetId1)) {\n+                        gatewaySubnetIds.add(subnetId1);\n+                    }\n+                }\n+            }\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c1a2a2ddd8bfe32fe0da34ae4f595598151e6f5"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE3NjIxNA==", "bodyText": "Could you add brief comments to this method?", "url": "https://github.com/futurewei-cloud/alcor/pull/512#discussion_r542176214", "createdAt": "2020-12-14T07:54:06Z", "author": {"login": "xieus"}, "path": "services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/service/impl/DpmServiceImpl.java", "diffHunk": "@@ -108,10 +117,10 @@ private UnicastGoalState buildUnicastGoalState(NetworkConfiguration networkConfi\n                     networkConfig, hostIp, portEntities, multicastGoalState));\n         }\n \n-        return dataPlaneClient.createGoalStates(unicastGoalStates, multicastGoalState);\n+        return dataPlaneClient.sendGoalStates(unicastGoalStates, multicastGoalState);\n     }\n \n-    private List<String> createPortConfiguration(NetworkConfiguration networkConfig) throws Exception {\n+    private List<String> processPortConfiguration(NetworkConfiguration networkConfig) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c1a2a2ddd8bfe32fe0da34ae4f595598151e6f5"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE3Njg0Mg==", "bodyText": "Can you elaborate a bit here? Neighbor table also includes L2 neighbors if my memory is right :-)", "url": "https://github.com/futurewei-cloud/alcor/pull/512#discussion_r542176842", "createdAt": "2020-12-14T07:55:19Z", "author": {"login": "xieus"}, "path": "services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/service/impl/DpmServiceImpl.java", "diffHunk": "@@ -144,20 +153,92 @@ private UnicastGoalState buildUnicastGoalState(NetworkConfiguration networkConfi\n                     networkConfig, pulsarHostPortEntities, pulsarDataPlaneClient));\n         }\n \n-        localCache.addSubnetPorts(networkConfig);\n+        localCache.updateLocalCache(networkConfig);\n \n         return statusList;\n     }\n \n-    private List<String> createNeighborConfiguration(NetworkConfiguration networkConfig) throws Exception {\n-        return null;\n+    private List<String> processNeighborConfiguration(NetworkConfiguration networkConfig) throws Exception {\n+        Map<String, NeighborInfo> neighborInfos = networkConfig.getNeighborInfos();\n+        Map<String, List<NeighborEntry>> neighborTable = networkConfig.getNeighborTable();\n+        List<UnicastGoalState> unicastGoalStates = new ArrayList<>();\n+        MulticastGoalState multicastGoalState = new MulticastGoalState();\n+\n+        if (neighborTable == null || neighborInfos == null) {\n+            throw new NeighborInfoNotFound();\n+        }\n+\n+        Map<String, List<NeighborInfo>> hostNeighbors = new HashMap<>();\n+        for (Map.Entry<String, List<NeighborEntry>> entry: neighborTable.entrySet()) {\n+            String portIp = entry.getKey();\n+            NeighborInfo localInfo = neighborInfos.get(portIp);\n+            if (localInfo == null) {\n+                throw new NeighborInfoNotFound();\n+            }\n+\n+            String hostIp = localInfo.getHostIp();\n+            if (!hostNeighbors.containsKey(hostIp)) {\n+                hostNeighbors.put(hostIp, new ArrayList<>());\n+            }\n+\n+            List<NeighborEntry> neighborEntries = entry.getValue();\n+            for (NeighborEntry neighborEntry: neighborEntries) {\n+                String neighborIp = neighborEntry.getNeighborIp();\n+                NeighborInfo neighborInfo = neighborInfos.get(neighborIp);\n+                if (neighborInfo == null) {\n+                    throw new NeighborInfoNotFound();\n+                }\n+\n+                hostNeighbors.get(hostIp).add(neighborInfo);\n+                multicastGoalState.getHostIps().add(neighborInfo.getHostIp());\n+            }\n+\n+            //Add neighborInfo to multicastGoalState\n+            Neighbor.NeighborState neighborState = neighborService.buildNeighborState(\n+                    NeighborType.L3, localInfo, networkConfig.getOpType());\n+            multicastGoalState.getGoalStateBuilder().addNeighborStates(neighborState);\n+        }\n+\n+        for (Map.Entry<String, List<NeighborInfo>> entry: hostNeighbors.entrySet()) {\n+            String hostIp = entry.getKey();\n+            List<NeighborInfo> hostNeighborInfos = entry.getValue();\n+\n+            /**\n+             * At present, there are only L3 neighbors in the neighbor table,\n+             * and the processing of L2 neighbors should be considered in the future.\n+             */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c1a2a2ddd8bfe32fe0da34ae4f595598151e6f5"}, "originalPosition": 109}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMDIwNzAy", "url": "https://github.com/futurewei-cloud/alcor/pull/512#pullrequestreview-552020702", "createdAt": "2020-12-15T00:47:21Z", "commit": {"oid": "4c1a2a2ddd8bfe32fe0da34ae4f595598151e6f5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "046ab21961d20b2c864fdf26a17056a060f397b4", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/046ab21961d20b2c864fdf26a17056a060f397b4", "committedDate": "2020-12-15T07:37:14Z", "message": "Add some comments according to the suggestion of the review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMTg2Mzky", "url": "https://github.com/futurewei-cloud/alcor/pull/512#pullrequestreview-552186392", "createdAt": "2020-12-15T07:58:17Z", "commit": {"oid": "046ab21961d20b2c864fdf26a17056a060f397b4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2054, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}