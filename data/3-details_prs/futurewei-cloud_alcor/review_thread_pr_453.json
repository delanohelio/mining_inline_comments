{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExODUwMTc0", "number": 453, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMjoxMToxOFrOEzBWjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMzo0MjoxOVrOEzCs2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxOTM0OTkxOnYy", "diffSide": "RIGHT", "path": "services/subnet_manager/src/main/java/com/futurewei/alcor/subnet/controller/SubnetController.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMjoxMToxOFrOHp_aJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMzo0Mjo0OFrOHqBcqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc5MjU0OQ==", "bodyText": "In order to grant deletion, we will need to make sure the following two conditions are met:\n\nNo ports are under this subnet\nThe subnet is not attached to any router", "url": "https://github.com/futurewei-cloud/alcor/pull/453#discussion_r513792549", "createdAt": "2020-10-28T22:11:18Z", "author": {"login": "xieus"}, "path": "services/subnet_manager/src/main/java/com/futurewei/alcor/subnet/controller/SubnetController.java", "diffHunk": "@@ -449,7 +449,7 @@ public ResponseId deleteSubnetState(@PathVariable String projectId, @PathVariabl\n                 return new ResponseId();\n             }\n \n-            //RestPreconditionsUtil.verifyParameterEqual(subnetEntity.getProjectId(), projectId);\n+            this.subnetDatabaseService.deleteSubnet(subnetId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b590cad0fcbb1a04c1e31136541df562f1303a92"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgxMzQzNA==", "bodyText": "sure", "url": "https://github.com/futurewei-cloud/alcor/pull/453#discussion_r513813434", "createdAt": "2020-10-28T23:05:32Z", "author": {"login": "kevin-zhonghao"}, "path": "services/subnet_manager/src/main/java/com/futurewei/alcor/subnet/controller/SubnetController.java", "diffHunk": "@@ -449,7 +449,7 @@ public ResponseId deleteSubnetState(@PathVariable String projectId, @PathVariabl\n                 return new ResponseId();\n             }\n \n-            //RestPreconditionsUtil.verifyParameterEqual(subnetEntity.getProjectId(), projectId);\n+            this.subnetDatabaseService.deleteSubnet(subnetId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc5MjU0OQ=="}, "originalCommit": {"oid": "b590cad0fcbb1a04c1e31136541df562f1303a92"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgyNTk2MA==", "bodyText": "Very good improvement and thanks.", "url": "https://github.com/futurewei-cloud/alcor/pull/453#discussion_r513825960", "createdAt": "2020-10-28T23:42:48Z", "author": {"login": "xieus"}, "path": "services/subnet_manager/src/main/java/com/futurewei/alcor/subnet/controller/SubnetController.java", "diffHunk": "@@ -449,7 +449,7 @@ public ResponseId deleteSubnetState(@PathVariable String projectId, @PathVariabl\n                 return new ResponseId();\n             }\n \n-            //RestPreconditionsUtil.verifyParameterEqual(subnetEntity.getProjectId(), projectId);\n+            this.subnetDatabaseService.deleteSubnet(subnetId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc5MjU0OQ=="}, "originalCommit": {"oid": "b590cad0fcbb1a04c1e31136541df562f1303a92"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxOTM1MzE4OnYy", "diffSide": "RIGHT", "path": "services/route_manager/src/main/java/com/futurewei/alcor/route/service/Impl/NeutronRouterServiceImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMjoxMjozOFrOHp_cOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMzoxNDoyN1rOHqA3SQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc5MzA4Mg==", "bodyText": "Recommend to\n\nrename it to RouterUnavailable or RouterNotExist\nprint router id in the exception message", "url": "https://github.com/futurewei-cloud/alcor/pull/453#discussion_r513793082", "createdAt": "2020-10-28T22:12:38Z", "author": {"login": "xieus"}, "path": "services/route_manager/src/main/java/com/futurewei/alcor/route/service/Impl/NeutronRouterServiceImpl.java", "diffHunk": "@@ -159,6 +159,11 @@ else if (portId == null && subnetId != null) {\n         } else {\n             return new RouterInterfaceResponse();\n         }\n+        Router router = this.routerDatabaseService.getByRouterId(routerId);\n+        if (router == null) {\n+            throw new CanNotFindRouter();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b590cad0fcbb1a04c1e31136541df562f1303a92"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgxNjM5Mw==", "bodyText": "Done", "url": "https://github.com/futurewei-cloud/alcor/pull/453#discussion_r513816393", "createdAt": "2020-10-28T23:14:27Z", "author": {"login": "kevin-zhonghao"}, "path": "services/route_manager/src/main/java/com/futurewei/alcor/route/service/Impl/NeutronRouterServiceImpl.java", "diffHunk": "@@ -159,6 +159,11 @@ else if (portId == null && subnetId != null) {\n         } else {\n             return new RouterInterfaceResponse();\n         }\n+        Router router = this.routerDatabaseService.getByRouterId(routerId);\n+        if (router == null) {\n+            throw new CanNotFindRouter();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc5MzA4Mg=="}, "originalCommit": {"oid": "b590cad0fcbb1a04c1e31136541df562f1303a92"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxOTU3MDgzOnYy", "diffSide": "RIGHT", "path": "services/subnet_manager/src/main/java/com/futurewei/alcor/subnet/service/implement/SubnetServiceImp.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMzo0MjoyMFrOHqBcJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwMDoxNjoyN1rOHqCEug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgyNTgyOA==", "bodyText": "Minor comment:\nif (attachedRouterId == null || attachedRouterId.equals(\"\")){\nreturn false;\n}\nreturn true;", "url": "https://github.com/futurewei-cloud/alcor/pull/453#discussion_r513825828", "createdAt": "2020-10-28T23:42:20Z", "author": {"login": "xieus"}, "path": "services/subnet_manager/src/main/java/com/futurewei/alcor/subnet/service/implement/SubnetServiceImp.java", "diffHunk": "@@ -362,6 +360,37 @@ public void deleteSubnetIdInVpc(String subnetId, String projectId, String vpcId)\n         restTemplate.put(vpcManagerServiceUrl, VpcWebJson.class);\n     }\n \n+    @Override\n+    public boolean checkIfAnyPortInSubnet(String rangeId) throws RangeIdIsNullOrEmpty {\n+        if (rangeId == null) {\n+            throw new RangeIdIsNullOrEmpty();\n+        }\n+        String ipManagerServiceUrl = ipUrl + rangeId;\n+        IpAddrRangeRequest ipAddrRangeRequest = restTemplate.getForObject(ipManagerServiceUrl, IpAddrRangeRequest.class);\n+        if (ipAddrRangeRequest == null) {\n+            return false;\n+        }\n+\n+        // check usedIps\n+        long usedIps = ipAddrRangeRequest.getUsedIps();\n+        if (usedIps > ConstantsConfig.UsedIpThreshold) {\n+            return true;\n+        }\n+\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean checkIfSubnetBindAnyRoutes(SubnetEntity subnetEntity) {\n+\n+        String attachedRouterId = subnetEntity.getAttachedRouterId();\n+        if (attachedRouterId != null && !attachedRouterId.equals(\"\")){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83b8b15c444f3d6180cb2a5e7788df3c66bc3f6b"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgzNjIxOA==", "bodyText": "Done", "url": "https://github.com/futurewei-cloud/alcor/pull/453#discussion_r513836218", "createdAt": "2020-10-29T00:16:27Z", "author": {"login": "kevin-zhonghao"}, "path": "services/subnet_manager/src/main/java/com/futurewei/alcor/subnet/service/implement/SubnetServiceImp.java", "diffHunk": "@@ -362,6 +360,37 @@ public void deleteSubnetIdInVpc(String subnetId, String projectId, String vpcId)\n         restTemplate.put(vpcManagerServiceUrl, VpcWebJson.class);\n     }\n \n+    @Override\n+    public boolean checkIfAnyPortInSubnet(String rangeId) throws RangeIdIsNullOrEmpty {\n+        if (rangeId == null) {\n+            throw new RangeIdIsNullOrEmpty();\n+        }\n+        String ipManagerServiceUrl = ipUrl + rangeId;\n+        IpAddrRangeRequest ipAddrRangeRequest = restTemplate.getForObject(ipManagerServiceUrl, IpAddrRangeRequest.class);\n+        if (ipAddrRangeRequest == null) {\n+            return false;\n+        }\n+\n+        // check usedIps\n+        long usedIps = ipAddrRangeRequest.getUsedIps();\n+        if (usedIps > ConstantsConfig.UsedIpThreshold) {\n+            return true;\n+        }\n+\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean checkIfSubnetBindAnyRoutes(SubnetEntity subnetEntity) {\n+\n+        String attachedRouterId = subnetEntity.getAttachedRouterId();\n+        if (attachedRouterId != null && !attachedRouterId.equals(\"\")){", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgyNTgyOA=="}, "originalCommit": {"oid": "83b8b15c444f3d6180cb2a5e7788df3c66bc3f6b"}, "originalPosition": 44}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4445, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}