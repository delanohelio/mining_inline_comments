{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU5MTAxMjUw", "number": 333, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNDozNTo0NVrOETtSkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNDo1MDoyMVrOETttew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MTAwNDMyOnYy", "diffSide": "RIGHT", "path": "services/api_gateway/src/main/java/com/futurewei/alcor/apigateway/client/KeystoneClient.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNDozNTo0NVrOG5l6eg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNDozNTo0NVrOG5l6eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA0MzE5NA==", "bodyText": "This is a very good refactor \ud83d\udc4d", "url": "https://github.com/futurewei-cloud/alcor/pull/333#discussion_r463043194", "createdAt": "2020-07-30T14:35:45Z", "author": {"login": "xieus"}, "path": "services/api_gateway/src/main/java/com/futurewei/alcor/apigateway/client/KeystoneClient.java", "diffHunk": "@@ -192,13 +190,13 @@ private void getLocalToken() throws IOException{\n      *\n      * @see <a href=\"https://docs.openstack.org/api-ref/identity/v3/index.html?expanded=password-authentication-with-scoped-authorization-detail#identity-api-operations\">Keystone api operations</a>\n      */\n-    public String verifyToken(String token){\n+    public Optional<TokenEntity> verifyToken(String token){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd010f6936a659b7cb2f050fe5427a340f8d01af"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MTAzMTM3OnYy", "diffSide": "RIGHT", "path": "services/api_gateway/src/main/java/com/futurewei/alcor/apigateway/client/KeystoneClient.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNDo0MTo0MVrOG5mLfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNDo0MTo0MVrOG5mLfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA0NzU0OA==", "bodyText": "Recommend to add a Log.debug if a token is expired.", "url": "https://github.com/futurewei-cloud/alcor/pull/333#discussion_r463047548", "createdAt": "2020-07-30T14:41:41Z", "author": {"login": "xieus"}, "path": "services/api_gateway/src/main/java/com/futurewei/alcor/apigateway/client/KeystoneClient.java", "diffHunk": "@@ -192,13 +190,13 @@ private void getLocalToken() throws IOException{\n      *\n      * @see <a href=\"https://docs.openstack.org/api-ref/identity/v3/index.html?expanded=password-authentication-with-scoped-authorization-detail#identity-api-operations\">Keystone api operations</a>\n      */\n-    public String verifyToken(String token){\n+    public Optional<TokenEntity> verifyToken(String token){\n         try {\n \n             TokenEntity tokenEntity = cache.get(token);\n             if(tokenEntity != null){\n                 LOG.debug(\"fetch the token from cache {}\", tokenEntity);\n-                return tokenEntity.isExpired() ? \"\" : tokenEntity.getProjectId();\n+                return tokenEntity.isExpired() ? Optional.empty() : Optional.of(tokenEntity);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd010f6936a659b7cb2f050fe5427a340f8d01af"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MTA3MzIzOnYy", "diffSide": "RIGHT", "path": "services/api_gateway/src/main/java/com/futurewei/alcor/apigateway/filter/KeystoneAuthGwFilter.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNDo1MDoyMVrOG5mk3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNDo1MDoyMVrOG5mk3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA1NDA0NQ==", "bodyText": "This appears to overwrite the header fields. Pls make sure that other header fields (if useful) will not be removed. @Gzure", "url": "https://github.com/futurewei-cloud/alcor/pull/333#discussion_r463054045", "createdAt": "2020-07-30T14:50:21Z", "author": {"login": "xieus"}, "path": "services/api_gateway/src/main/java/com/futurewei/alcor/apigateway/filter/KeystoneAuthGwFilter.java", "diffHunk": "@@ -54,21 +61,27 @@\n             exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);\n             return exchange.getResponse().setComplete();\n         }\n-        String projectId = keystoneClient.verifyToken(token);\n-        if(\"\".equals(projectId)){\n+        Optional<TokenEntity> tokenEntityOptional = keystoneClient.verifyToken(token);\n+        if(tokenEntityOptional.isEmpty()){\n             LOG.warn(\"parsed token {} project id failed\", token);\n             exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);\n             return exchange.getResponse().setComplete();\n         }\n+\n+        TokenEntity tokenEntity = tokenEntityOptional.get();\n+        String projectId = tokenEntity.getProjectId();\n         LOG.debug(\"parsed token {} project id success, project id:[{}]\", token, projectId);\n+\n         // rewrite uri path include project id\n         ServerHttpRequest req = exchange.getRequest();\n         ServerWebExchangeUtils.addOriginalRequestUrl(exchange, req.getURI());\n         String path = req.getURI().getRawPath();\n         path = path.replaceAll(neutronUrlPrefix, \"/project/\" + projectId);\n         path = path.replaceAll(VPC_REPLACE_NAME, VPC_NAME);\n-        ServerHttpRequest request = req.mutate().path(path).build();\n+\n+        ServerHttpRequest request = req.mutate().path(path).header(TOKEN_INFO_HEADER, tokenEntity.toJson()).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd010f6936a659b7cb2f050fe5427a340f8d01af"}, "originalPosition": 47}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4621, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}