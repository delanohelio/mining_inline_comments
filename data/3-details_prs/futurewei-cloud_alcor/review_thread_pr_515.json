{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwODM2ODcy", "number": 515, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwMDo0MDozM1rOFGdunQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMjoyOTo1MFrOFG_cYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQyMzIyODQ1OnYy", "diffSide": "RIGHT", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/service/PortServiceImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwMDo0MDozM1rOIHfZ2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMjozMzoyMlrOIHziEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcyNTQ2Nw==", "bodyText": "@chenpiaoping This API just need to return # of ports in the subnet, you don't need to return their port ids. Subnet Manager will check this return value when the subnet is going to be deleted.", "url": "https://github.com/futurewei-cloud/alcor/pull/515#discussion_r544725467", "createdAt": "2020-12-17T00:40:33Z", "author": {"login": "cj-chung"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/service/PortServiceImpl.java", "diffHunk": "@@ -296,4 +295,9 @@ public RouterUpdateInfo updateL3Neighbors(String projectId, RouterUpdateInfo rou\n \n         return routerUpdateInfo;\n     }\n+\n+    @Override\n+    public SubnetPortIds getSubnetPorts(String projectId, String subnetId) throws Exception {\n+        return portRepository.getSubnetPortIds(subnetId);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f324f817241f201d014c4d86fd823b4040f498c"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA1NTI1MQ==", "bodyText": "fixed, please review again.", "url": "https://github.com/futurewei-cloud/alcor/pull/515#discussion_r545055251", "createdAt": "2020-12-17T12:33:22Z", "author": {"login": "chenpiaoping"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/service/PortServiceImpl.java", "diffHunk": "@@ -296,4 +295,9 @@ public RouterUpdateInfo updateL3Neighbors(String projectId, RouterUpdateInfo rou\n \n         return routerUpdateInfo;\n     }\n+\n+    @Override\n+    public SubnetPortIds getSubnetPorts(String projectId, String subnetId) throws Exception {\n+        return portRepository.getSubnetPortIds(subnetId);\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcyNTQ2Nw=="}, "originalCommit": {"oid": "2f324f817241f201d014c4d86fd823b4040f498c"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQyNzYxMjIwOnYy", "diffSide": "RIGHT", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/entity/SubnetPortIds.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QyMDowMToyMlrOIIGllg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMjozNjoyNlrOIIQ0OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM2NzQ0Ng==", "bodyText": "@chenpiaoping Should include gateway port here and  distinguish it from a normal port? or add another field for gateway ports?", "url": "https://github.com/futurewei-cloud/alcor/pull/515#discussion_r545367446", "createdAt": "2020-12-17T20:01:22Z", "author": {"login": "cj-chung"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/entity/SubnetPortIds.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.portmanager.entity;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+import java.util.Set;\n+\n+public class SubnetPortIds {\n+    @JsonProperty(\"subnet_id\")\n+    private String subnetId;\n+\n+    @JsonProperty(\"port_ids\")\n+    private Set<String> portIds;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa0cd127e0ef1aa36e12caa4873edb37cc1f09b6"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUyMTEwNQ==", "bodyText": "Right now portIds only contains non-gateway port.", "url": "https://github.com/futurewei-cloud/alcor/pull/515#discussion_r545521105", "createdAt": "2020-12-18T01:51:05Z", "author": {"login": "chenpiaoping"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/entity/SubnetPortIds.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.portmanager.entity;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+import java.util.Set;\n+\n+public class SubnetPortIds {\n+    @JsonProperty(\"subnet_id\")\n+    private String subnetId;\n+\n+    @JsonProperty(\"port_ids\")\n+    private Set<String> portIds;\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM2NzQ0Ng=="}, "originalCommit": {"oid": "fa0cd127e0ef1aa36e12caa4873edb37cc1f09b6"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUzNTAzMw==", "bodyText": "ok", "url": "https://github.com/futurewei-cloud/alcor/pull/515#discussion_r545535033", "createdAt": "2020-12-18T02:36:26Z", "author": {"login": "cj-chung"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/entity/SubnetPortIds.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.portmanager.entity;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+import java.util.Set;\n+\n+public class SubnetPortIds {\n+    @JsonProperty(\"subnet_id\")\n+    private String subnetId;\n+\n+    @JsonProperty(\"port_ids\")\n+    private Set<String> portIds;\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM2NzQ0Ng=="}, "originalCommit": {"oid": "fa0cd127e0ef1aa36e12caa4873edb37cc1f09b6"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQyNzc0OTE1OnYy", "diffSide": "RIGHT", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/controller/PortController.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QyMDozNzowM1rOIIH1Lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMTo0MDo0OFrOIIPwKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM4NzgyMw==", "bodyText": "@chenpiaoping do you think function name getSubnetPortCount would be better? Same as the API name: subnet-port-count.", "url": "https://github.com/futurewei-cloud/alcor/pull/515#discussion_r545387823", "createdAt": "2020-12-17T20:37:03Z", "author": {"login": "cj-chung"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/controller/PortController.java", "diffHunk": "@@ -221,4 +221,16 @@ public RouterUpdateInfo updateL3Neighbors(@PathVariable(\"project_id\") String pro\n         checkRouterSubnetUpdateInfo(routerUpdateInfo);\n         return portService.updateL3Neighbors(projectId, routerUpdateInfo);\n     }\n+\n+    @Rbac(resource =\"port\")\n+    @GetMapping({\"/project/{project_id}/subnet-port-number/{subnet_id}\", \"v4/{project_id}/subnet-port-number/{subnet_id}\"})\n+    @DurationStatistics\n+    public int getSubnetPortNumber(@PathVariable(\"project_id\") String projectId,\n+                                             @PathVariable(\"subnet_id\") String subnetId) throws Exception {\n+        if (StringUtil.isNullOrEmpty(subnetId)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa0cd127e0ef1aa36e12caa4873edb37cc1f09b6"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUxNzYwOQ==", "bodyText": "agree", "url": "https://github.com/futurewei-cloud/alcor/pull/515#discussion_r545517609", "createdAt": "2020-12-18T01:40:48Z", "author": {"login": "chenpiaoping"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/controller/PortController.java", "diffHunk": "@@ -221,4 +221,16 @@ public RouterUpdateInfo updateL3Neighbors(@PathVariable(\"project_id\") String pro\n         checkRouterSubnetUpdateInfo(routerUpdateInfo);\n         return portService.updateL3Neighbors(projectId, routerUpdateInfo);\n     }\n+\n+    @Rbac(resource =\"port\")\n+    @GetMapping({\"/project/{project_id}/subnet-port-number/{subnet_id}\", \"v4/{project_id}/subnet-port-number/{subnet_id}\"})\n+    @DurationStatistics\n+    public int getSubnetPortNumber(@PathVariable(\"project_id\") String projectId,\n+                                             @PathVariable(\"subnet_id\") String subnetId) throws Exception {\n+        if (StringUtil.isNullOrEmpty(subnetId)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM4NzgyMw=="}, "originalCommit": {"oid": "fa0cd127e0ef1aa36e12caa4873edb37cc1f09b6"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQyODc1MjM1OnYy", "diffSide": "RIGHT", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/repo/PortRepository.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMjoyOTo1MFrOIIQsHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMzowNTowOVrOIIRWGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUzMjk1OQ==", "bodyText": "A constant string would be better.", "url": "https://github.com/futurewei-cloud/alcor/pull/515#discussion_r545532959", "createdAt": "2020-12-18T02:29:50Z", "author": {"login": "xieus"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/repo/PortRepository.java", "diffHunk": "@@ -263,6 +264,33 @@ private String getNeighborCacheName(String suffix) {\n         return NEIGHBOR_CACHE_NAME_PREFIX + suffix;\n     }\n \n+    private List<SubnetPortIds> getSubnetPortIds(List<PortEntity> portEntities) {\n+        Map<String, SubnetPortIds> subnetPortIdsMap = new HashMap<>();\n+        for (PortEntity portEntity: portEntities) {\n+            if (\"network:router_interface\".equals(portEntity.getDeviceOwner())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d11b117c8792b2eeab8b38bbabecd367cba1a9f"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU0MzcwNw==", "bodyText": "Fixed, another PR: #519", "url": "https://github.com/futurewei-cloud/alcor/pull/515#discussion_r545543707", "createdAt": "2020-12-18T03:05:09Z", "author": {"login": "chenpiaoping"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/repo/PortRepository.java", "diffHunk": "@@ -263,6 +264,33 @@ private String getNeighborCacheName(String suffix) {\n         return NEIGHBOR_CACHE_NAME_PREFIX + suffix;\n     }\n \n+    private List<SubnetPortIds> getSubnetPortIds(List<PortEntity> portEntities) {\n+        Map<String, SubnetPortIds> subnetPortIdsMap = new HashMap<>();\n+        for (PortEntity portEntity: portEntities) {\n+            if (\"network:router_interface\".equals(portEntity.getDeviceOwner())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUzMjk1OQ=="}, "originalCommit": {"oid": "0d11b117c8792b2eeab8b38bbabecd367cba1a9f"}, "originalPosition": 44}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4494, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}