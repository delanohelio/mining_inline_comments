{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzNDU3MDMx", "number": 248, "title": "Microsevice Integration of Port Manager and Data-Plane Manager", "bodyText": "This PR proposes the following changes:\n\nSlightly refactor DPM contract for code consistency\nIntegrate port manager with DPM based on latest contract\nRemove Port Manager dao layer for now", "createdAt": "2020-06-12T04:29:17Z", "url": "https://github.com/futurewei-cloud/alcor/pull/248", "merged": true, "mergeCommit": {"oid": "80110a7f257af2808285c015e3c73656f5a08d67"}, "closed": true, "closedAt": "2020-06-12T15:49:39Z", "author": {"login": "chenpiaoping"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqbhlIgFqTQyOTQ2MDIzMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqk4YYAFqTQyOTg1MDg4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5NDYwMjMx", "url": "https://github.com/futurewei-cloud/alcor/pull/248#pullrequestreview-429460231", "createdAt": "2020-06-12T04:55:01Z", "commit": {"oid": "752095bf4025e071d1dbb3baf638cb488c5d27ab"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwNDo1NTowMVrOGi3Atw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwNDo1NTowMVrOGi3Atw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTIwNjA3MQ==", "bodyText": "@chenpiaoping Check a few latest commits that were not included here: https://github.com/futurewei-cloud/alcor/pull/244/commits, particularly this one cdbd96e", "url": "https://github.com/futurewei-cloud/alcor/pull/248#discussion_r439206071", "createdAt": "2020-06-12T04:55:01Z", "author": {"login": "xieus"}, "path": "web/src/main/java/com/futurewei/alcor/web/entity/dataplane/InternalPortEntity.java", "diffHunk": "@@ -15,24 +15,27 @@\n import com.fasterxml.jackson.annotation.JsonProperty;\n import com.futurewei.alcor.web.entity.port.PortEntity;\n import com.futurewei.alcor.web.entity.route.RouteEntity;\n-import com.futurewei.alcor.web.entity.vpc.VpcEntity;\n import lombok.Data;\n \n+import java.util.ArrayList;\n import java.util.List;\n-import java.util.Set;\n \n @Data\n-public class InternalPortEntityNB extends PortEntity {\n+public class InternalPortEntity extends PortEntity {\n \n-  @JsonProperty(\"routes\")\n-  private List<RouteEntity> routes;\n+    @JsonProperty(\"routes\")\n+    private List<RouteEntity> routes;\n \n-  @JsonProperty(\"neighbor_info\")\n-  private List<NeighborInfo> neighborIps;\n+    @JsonProperty(\"neighbor_info\")\n+    private List<NeighborInfo> neighborInfos;\n \n-  @JsonProperty(\"binding_host_ip\")\n-  private String bindingHostIP;\n+    @JsonProperty(\"binding_host_ip\")\n+    private String bindingHostIP;\n \n-  private Set<InternalSubnetEntityNB> subnetEntities;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "752095bf4025e071d1dbb3baf638cb488c5d27ab"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6dca6f3d3452f04ceed9a12e3230355ebbd5ea00", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/6dca6f3d3452f04ceed9a12e3230355ebbd5ea00", "committedDate": "2020-06-12T06:40:07Z", "message": "Integration of Port Manager and Data-Plane Manager"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5NTE0ODUy", "url": "https://github.com/futurewei-cloud/alcor/pull/248#pullrequestreview-429514852", "createdAt": "2020-06-12T07:18:31Z", "commit": {"oid": "752095bf4025e071d1dbb3baf638cb488c5d27ab"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwNzoxODozMVrOGi5rQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwNzoxODozMVrOGi5rQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI0OTczMQ==", "bodyText": "Lock on portCache may not be sufficient. If multiple ports (in the same vpc) are created in separate calls, those calls will operate on different portCache row but the same neighborCache row.", "url": "https://github.com/futurewei-cloud/alcor/pull/248#discussion_r439249731", "createdAt": "2020-06-12T07:18:31Z", "author": {"login": "xieus"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/repo/PortRepository.java", "diffHunk": "@@ -18,62 +18,199 @@\n import com.futurewei.alcor.common.db.CacheException;\n import com.futurewei.alcor.common.db.CacheFactory;\n import com.futurewei.alcor.common.db.ICache;\n-import com.futurewei.alcor.common.db.repo.ICacheRepository;\n+import com.futurewei.alcor.common.db.Transaction;\n+import com.futurewei.alcor.portmanager.entity.PortNeighbors;\n+import com.futurewei.alcor.web.entity.dataplane.NeighborInfo;\n import com.futurewei.alcor.web.entity.port.PortEntity;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.context.annotation.ComponentScan;\n import org.springframework.stereotype.Repository;\n import javax.annotation.PostConstruct;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n import java.util.function.Function;\n import java.util.stream.Collectors;\n \n @ComponentScan(value=\"com.futurewei.alcor.common.db\")\n @Repository\n-public class PortRepository implements ICacheRepository<PortEntity> {\n+public class PortRepository {\n     private static final Logger LOG = LoggerFactory.getLogger(PortRepository.class);\n \n-    private ICache<String, PortEntity> cache;\n+    private ICache<String, PortEntity> portCache;\n+    private ICache<String, PortNeighbors> neighborCache;\n \n     @Autowired\n     public PortRepository(CacheFactory cacheFactory) {\n-        cache = cacheFactory.getCache(PortEntity.class);\n+        portCache = cacheFactory.getCache(PortEntity.class);\n     }\n \n     @PostConstruct\n     private void init() {\n         LOG.info(\"PortRepository init done\");\n     }\n \n-    @Override\n-    public PortEntity findItem(String id) throws CacheException {\n-        return cache.get(id);\n+    public PortEntity findPortEntity(String portId) throws CacheException {\n+        return portCache.get(portId);\n     }\n \n-    @Override\n-    public Map<String, PortEntity> findAllItems() throws CacheException {\n-        return cache.getAll();\n+    public Map<String, PortEntity> findAllPortEntities() throws CacheException {\n+        return portCache.getAll();\n     }\n \n-    @Override\n-    public void addItem(PortEntity portEntity) throws CacheException {\n-        cache.put(portEntity.getId(), portEntity);\n+    public void createPortAndNeighbor(PortEntity portEntity, NeighborInfo neighborInfo) throws Exception {\n+        try (Transaction tx = portCache.getTransaction().start()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "752095bf4025e071d1dbb3baf638cb488c5d27ab"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5NTE5MTQ2", "url": "https://github.com/futurewei-cloud/alcor/pull/248#pullrequestreview-429519146", "createdAt": "2020-06-12T07:26:41Z", "commit": {"oid": "752095bf4025e071d1dbb3baf638cb488c5d27ab"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwNzoyNjo0MlrOGi54fQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwNzozMjo0M1rOGi6CjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI1MzExNw==", "bodyText": "Try to use \"this.getNodeInfos\" if possible.", "url": "https://github.com/futurewei-cloud/alcor/pull/248#discussion_r439253117", "createdAt": "2020-06-12T07:26:42Z", "author": {"login": "xieus"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/service/implement/PortServiceImpl.java", "diffHunk": "@@ -146,21 +205,25 @@ public PortWebJson createPort(String projectId, PortWebJson portWebJson) throws\n         portEntity.setProjectId(projectId);\n \n         try {\n-            createPortAsync(portEntity, executor, rollbacks);\n+            this.createPortAsync(portEntity, executor, rollbacks, true);\n \n             //Wait for all async functions to finish\n             List<Object> entities = executor.joinAll();\n             entities.add(portEntity);\n \n-            //Build GoalState and Send it to DPM\n+            NeighborInfo neighborInfo = null;\n             if (portEntity.getBindingHostId() != null) {\n-                Goalstate.GoalState goalState = GoalStateUtil.buildGoalState(entities, Common.OperationType.CREATE);\n+                Map<String, NodeInfo> nodeInfoMap = getNodeInfos(entities);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "752095bf4025e071d1dbb3baf638cb488c5d27ab"}, "originalPosition": 141}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI1NTY5Mg==", "bodyText": "Confirmed. This is needed. @chenpiaoping @haboy52581", "url": "https://github.com/futurewei-cloud/alcor/pull/248#discussion_r439255692", "createdAt": "2020-06-12T07:32:43Z", "author": {"login": "xieus"}, "path": "web/src/main/java/com/futurewei/alcor/web/entity/dataplane/NeighborInfo.java", "diffHunk": "@@ -26,4 +25,50 @@\n \n   @JsonProperty(\"port_id\")\n   private String portId;\n+\n+  @JsonProperty(\"port_mac\")\n+  private String portMac;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "752095bf4025e071d1dbb3baf638cb488c5d27ab"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3815368b1ab385394b9f84e3a4d667fc4af90ac8", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/3815368b1ab385394b9f84e3a4d667fc4af90ac8", "committedDate": "2020-06-12T07:54:35Z", "message": "rebase from master"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "752095bf4025e071d1dbb3baf638cb488c5d27ab", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/752095bf4025e071d1dbb3baf638cb488c5d27ab", "committedDate": "2020-06-12T04:27:00Z", "message": "Integration of Port Manager and Data-Plane Manager"}, "afterCommit": {"oid": "3815368b1ab385394b9f84e3a4d667fc4af90ac8", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/3815368b1ab385394b9f84e3a4d667fc4af90ac8", "committedDate": "2020-06-12T07:54:35Z", "message": "rebase from master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f5a81f32cc854a84f4a4e5437540bb89262b7f9", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/6f5a81f32cc854a84f4a4e5437540bb89262b7f9", "committedDate": "2020-06-12T10:08:17Z", "message": "if no security group is configured in port, bind it to the default security group"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "143679521f35557a347a3a77e84256e32b2160f4", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/143679521f35557a347a3a77e84256e32b2160f4", "committedDate": "2020-06-12T09:45:05Z", "message": "if no security group is configured in port, bind the default security group"}, "afterCommit": {"oid": "6f5a81f32cc854a84f4a4e5437540bb89262b7f9", "author": {"user": {"login": "chenpiaoping", "name": null}}, "url": "https://github.com/futurewei-cloud/alcor/commit/6f5a81f32cc854a84f4a4e5437540bb89262b7f9", "committedDate": "2020-06-12T10:08:17Z", "message": "if no security group is configured in port, bind it to the default security group"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5Nzc0MDIy", "url": "https://github.com/futurewei-cloud/alcor/pull/248#pullrequestreview-429774022", "createdAt": "2020-06-12T14:11:23Z", "commit": {"oid": "6f5a81f32cc854a84f4a4e5437540bb89262b7f9"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxNDoxMToyM1rOGjFeZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxNDozNzozNlrOGjGbng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ0MzA0Ng==", "bodyText": "Do we disable temporarily for some reason?", "url": "https://github.com/futurewei-cloud/alcor/pull/248#discussion_r439443046", "createdAt": "2020-06-12T14:11:23Z", "author": {"login": "xieus"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/PortManagerApplication.java", "diffHunk": "@@ -1,13 +1,10 @@\n package com.futurewei.alcor.portmanager;\n \n-import org.mybatis.spring.annotation.MapperScan;\n import org.springframework.boot.SpringApplication;\n import org.springframework.boot.autoconfigure.SpringBootApplication;\n import org.springframework.transaction.annotation.EnableTransactionManagement;\n \n @SpringBootApplication\n-@EnableTransactionManagement", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f5a81f32cc854a84f4a4e5437540bb89262b7f9"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ1ODcxOA==", "bodyText": "Need to add dpm service url as in commit 5fce678\nLet me add it for you to kick off the integration.", "url": "https://github.com/futurewei-cloud/alcor/pull/248#discussion_r439458718", "createdAt": "2020-06-12T14:37:36Z", "author": {"login": "xieus"}, "path": "services/port_manager/src/main/resources/application.properties", "diffHunk": "@@ -17,12 +17,4 @@ microservices.ip.service.url=http://localhost:9004/ips\n microservices.mac.service.url=http://localhost:9005/macs\n microservices.sg.service.url=http://127.0.0.1:8080/securitygroups\n microservices.route.service.url=http://localhost:9003/routes\n-microservices.node.service.url=http://localhost:9007/nodes\n-#MyBatis configuration\n-spring.datasource.driverClassName=org.apache.ignite.IgniteJdbcThinDriver\n-spring.datasource.url=jdbc:ignite:thin://127.0.0.1\n-spring.datasource.schema=classpath:sql/port.sql\n-mybatis.configuration.map-underscore-to-camel-case=true\n-#spring.datasource.username=your_username\n-#spring.datasource.password=your_password\n-logging.level.com.dao=debug\n\\ No newline at end of file\n+microservices.node.service.url=http://localhost:9007/nodes", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f5a81f32cc854a84f4a4e5437540bb89262b7f9"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7148558ea03dbb2b2eb2241cdd3fc6fea3ac2ded", "author": {"user": {"login": "xieus", "name": "Liguang Xie"}}, "url": "https://github.com/futurewei-cloud/alcor/commit/7148558ea03dbb2b2eb2241cdd3fc6fea3ac2ded", "committedDate": "2020-06-12T15:32:09Z", "message": "Add dpm service url in port manager config file"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5ODUwODg3", "url": "https://github.com/futurewei-cloud/alcor/pull/248#pullrequestreview-429850887", "createdAt": "2020-06-12T15:49:04Z", "commit": {"oid": "7148558ea03dbb2b2eb2241cdd3fc6fea3ac2ded"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2148, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}