{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1MjUzNjg2", "number": 366, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwMToxNToxNVrOEejxfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQwMjo0NToxM1rOEnSVvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwNDc4ODQ0OnYy", "diffSide": "RIGHT", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/controller/PortController.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwMToxNToxNVrOHKRuow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwMTo0Mzo0NVrOHKTmaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDUzODI3NQ==", "bodyText": "I suggest that using PUT for this api, then it will become /project/{project_id}/update-l3-neighbors/{new_subnet_id}.\nThe BODY becomes {operation_type, vpcid, [old_subnet_ids]}", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r480538275", "createdAt": "2020-09-01T01:15:15Z", "author": {"login": "cj-chung"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/controller/PortController.java", "diffHunk": "@@ -203,4 +205,22 @@ public PortWebBulkJson listPort(@PathVariable(\"project_id\") String projectId) th\n \n         return new PortWebBulkJson(portsList);\n     }\n+\n+    /**\n+     * Update neighbor tables and send them to DPM when adding or deleting gateway port\n+     * @param projectId Project Id\n+     * @param routerSubnetUpdateInfo Router's latest subnet information\n+     * @return RouterSubnetUpdateInfo\n+     * @throws Exception Db operation exception\n+     */\n+    @Rbac(resource =\"port\")\n+    @PostMapping({\"/project/{project_id}/update-l3-neighbors\", \"v4/{project_id}/update-l3-neighbors\"})\n+    @ResponseBody\n+    @ResponseStatus(HttpStatus.CREATED)\n+    @DurationStatistics\n+    public RouterSubnetUpdateInfo updateL3Neighbors(@PathVariable(\"project_id\") String projectId,\n+                                                    @RequestBody RouterSubnetUpdateInfo routerSubnetUpdateInfo) throws Exception {\n+        checkRouterSubnetUpdateInfo(routerSubnetUpdateInfo);\n+        return portService.updateL3Neighbors(projectId, routerSubnetUpdateInfo);\n+    }\n }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d4037753129dbabfa83f24b06eacc1e10a21d30"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDU2ODkzNg==", "bodyText": "ok", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r480568936", "createdAt": "2020-09-01T01:43:45Z", "author": {"login": "chenpiaoping"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/controller/PortController.java", "diffHunk": "@@ -203,4 +205,22 @@ public PortWebBulkJson listPort(@PathVariable(\"project_id\") String projectId) th\n \n         return new PortWebBulkJson(portsList);\n     }\n+\n+    /**\n+     * Update neighbor tables and send them to DPM when adding or deleting gateway port\n+     * @param projectId Project Id\n+     * @param routerSubnetUpdateInfo Router's latest subnet information\n+     * @return RouterSubnetUpdateInfo\n+     * @throws Exception Db operation exception\n+     */\n+    @Rbac(resource =\"port\")\n+    @PostMapping({\"/project/{project_id}/update-l3-neighbors\", \"v4/{project_id}/update-l3-neighbors\"})\n+    @ResponseBody\n+    @ResponseStatus(HttpStatus.CREATED)\n+    @DurationStatistics\n+    public RouterSubnetUpdateInfo updateL3Neighbors(@PathVariable(\"project_id\") String projectId,\n+                                                    @RequestBody RouterSubnetUpdateInfo routerSubnetUpdateInfo) throws Exception {\n+        checkRouterSubnetUpdateInfo(routerSubnetUpdateInfo);\n+        return portService.updateL3Neighbors(projectId, routerSubnetUpdateInfo);\n+    }\n }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDUzODI3NQ=="}, "originalCommit": {"oid": "6d4037753129dbabfa83f24b06eacc1e10a21d30"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MTkyMTEwOnYy", "diffSide": "RIGHT", "path": "web/src/main/java/com/futurewei/alcor/web/restclient/RouterManagerRestClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNDowMjo1NVrOHVpipA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNDowMjo1NVrOHVpipA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ2Mjc1Ng==", "bodyText": "Don't think this is going to work. We should use /project/%s", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r492462756", "createdAt": "2020-09-22T04:02:55Z", "author": {"login": "xieus"}, "path": "web/src/main/java/com/futurewei/alcor/web/restclient/RouterManagerRestClient.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.web.restclient;\n+\n+import com.futurewei.alcor.web.entity.port.PortEntity;\n+import com.futurewei.alcor.web.entity.route.ConnectedSubnetsWebResponse;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Configuration;\n+\n+@Configuration\n+public class RouterManagerRestClient extends AbstractRestClient {\n+    @Value(\"${microservices.router.service.url:#{\\\"\\\"}}\")\n+    private String routerManagerUrl;\n+\n+    public ConnectedSubnetsWebResponse getRouterSubnets(String projectId, String vpcId, String subnetId) throws Exception {\n+        String url = String.format(\"/project/%s/vpcs/%s/subnets/%s/connected-subnets\", projectId, vpcId, subnetId);\n+        ConnectedSubnetsWebResponse routerSubnets = restTemplate.getForObject(url, ConnectedSubnetsWebResponse.class);\n+        if (routerSubnets == null) {\n+            throw new Exception(\"Get router connected subnets failed\");\n+        }\n+\n+        return routerSubnets;\n+    }\n+\n+    public void addRouterInterface(String routerId, PortEntity portEntity) {\n+        String url = String.format(\"/v2.0/routers/%s/add_router_interface\", routerId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MTkyMTgzOnYy", "diffSide": "RIGHT", "path": "web/src/main/java/com/futurewei/alcor/web/restclient/RouterManagerRestClient.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNDowMzoyOVrOHVpjAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNjo0Mjo1NVrOHVsGNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ2Mjg1MQ==", "bodyText": "This url doesn't include routeManagerUrl.", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r492462851", "createdAt": "2020-09-22T04:03:29Z", "author": {"login": "xieus"}, "path": "web/src/main/java/com/futurewei/alcor/web/restclient/RouterManagerRestClient.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.web.restclient;\n+\n+import com.futurewei.alcor.web.entity.port.PortEntity;\n+import com.futurewei.alcor.web.entity.route.ConnectedSubnetsWebResponse;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Configuration;\n+\n+@Configuration\n+public class RouterManagerRestClient extends AbstractRestClient {\n+    @Value(\"${microservices.router.service.url:#{\\\"\\\"}}\")\n+    private String routerManagerUrl;\n+\n+    public ConnectedSubnetsWebResponse getRouterSubnets(String projectId, String vpcId, String subnetId) throws Exception {\n+        String url = String.format(\"/project/%s/vpcs/%s/subnets/%s/connected-subnets\", projectId, vpcId, subnetId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUwNDYzMQ==", "bodyText": "Oh, yes, thanks", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r492504631", "createdAt": "2020-09-22T06:42:55Z", "author": {"login": "chenpiaoping"}, "path": "web/src/main/java/com/futurewei/alcor/web/restclient/RouterManagerRestClient.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.web.restclient;\n+\n+import com.futurewei.alcor.web.entity.port.PortEntity;\n+import com.futurewei.alcor.web.entity.route.ConnectedSubnetsWebResponse;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Configuration;\n+\n+@Configuration\n+public class RouterManagerRestClient extends AbstractRestClient {\n+    @Value(\"${microservices.router.service.url:#{\\\"\\\"}}\")\n+    private String routerManagerUrl;\n+\n+    public ConnectedSubnetsWebResponse getRouterSubnets(String projectId, String vpcId, String subnetId) throws Exception {\n+        String url = String.format(\"/project/%s/vpcs/%s/subnets/%s/connected-subnets\", projectId, vpcId, subnetId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ2Mjg1MQ=="}, "originalCommit": {"oid": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MjA5NjQyOnYy", "diffSide": "RIGHT", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/PortContext.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNTo1MjozN1rOHVrDqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQwMjo1MDozMFrOHXzJiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ4NzU5NQ==", "bodyText": "Could you add a comment to show this is a mapping from vpc_id to a list of subnet ids?\nbtw, do we have more than one vpc that a port needs to worry about here?", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r492487595", "createdAt": "2020-09-22T05:52:37Z", "author": {"login": "xieus"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/PortContext.java", "diffHunk": "@@ -34,6 +37,8 @@\n     private List<PortEntity> portEntities; //For add and delete\n     private PortEntity oldPortEntity; //For update\n     private PortEntity newPortEntity; //For update\n+    private Map<String, List<String>> routerSubnetIds;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUwNjY5NA==", "bodyText": "sure, I will add some comments here\nPortContext contains all the context information for port batch processing, where multiple vpc may be processed at the same time.", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r492506694", "createdAt": "2020-09-22T06:47:51Z", "author": {"login": "chenpiaoping"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/PortContext.java", "diffHunk": "@@ -34,6 +37,8 @@\n     private List<PortEntity> portEntities; //For add and delete\n     private PortEntity oldPortEntity; //For update\n     private PortEntity newPortEntity; //For update\n+    private Map<String, List<String>> routerSubnetIds;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ4NzU5NQ=="}, "originalCommit": {"oid": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxNzMyMw==", "bodyText": "Makes sense.", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494717323", "createdAt": "2020-09-25T02:50:30Z", "author": {"login": "xieus"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/PortContext.java", "diffHunk": "@@ -34,6 +37,8 @@\n     private List<PortEntity> portEntities; //For add and delete\n     private PortEntity oldPortEntity; //For update\n     private PortEntity newPortEntity; //For update\n+    private Map<String, List<String>> routerSubnetIds;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ4NzU5NQ=="}, "originalCommit": {"oid": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MjEwNjI1OnYy", "diffSide": "RIGHT", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/DatabaseProcessor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNTo1Nzo1MVrOHVrJHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNTo1Nzo1MVrOHVrJHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ4ODk5MQ==", "bodyText": "Glad to see that PM starts supporting multiple IPs \ud83d\udc4d", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r492488991", "createdAt": "2020-09-22T05:57:51Z", "author": {"login": "xieus"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/DatabaseProcessor.java", "diffHunk": "@@ -44,16 +51,15 @@ void createProcess(PortContext context) throws Exception {\n         NetworkConfig networkConfig = context.getNetworkConfig();\n         List<InternalPortEntity> internalPortEntities = networkConfig.getPortEntities();\n         for (InternalPortEntity internalPortEntity : internalPortEntities) {\n-            NeighborInfo neighborInfo = buildNeighborInfo(internalPortEntity);\n-            if (neighborInfo == null) {\n+            List<NeighborInfo> neighborInfoList = buildNeighborInfos(internalPortEntity);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MjExMTExOnYy", "diffSide": "RIGHT", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/DatabaseProcessor.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNjowMDoyOVrOHVrL3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQwMzoxNzo1NVrOHXzkPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ4OTY5Mw==", "bodyText": "Does this TODO get implemented already?", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r492489693", "createdAt": "2020-09-22T06:00:29Z", "author": {"login": "xieus"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/DatabaseProcessor.java", "diffHunk": "@@ -22,19 +22,26 @@\n import java.util.*;\n \n public class DatabaseProcessor extends AbstractProcessor {\n-    private NeighborInfo buildNeighborInfo(InternalPortEntity internalPortEntity) {\n+    private List<NeighborInfo> buildNeighborInfos(InternalPortEntity internalPortEntity) {\n+        List<NeighborInfo> neighborInfos = new ArrayList<>();\n         String bindingHostIp = internalPortEntity.getBindingHostIP();\n         if (bindingHostIp == null) {\n-            return null;\n+            return neighborInfos;\n         }\n \n-        NeighborInfo neighborInfo = new NeighborInfo(bindingHostIp,\n-                internalPortEntity.getBindingHostId(),\n-                internalPortEntity.getId(),\n-                internalPortEntity.getMacAddress(),\n-                internalPortEntity.getFixedIps().get(0).getIpAddress());\n+        //TODO: Support a port with multiple neighborInfos", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUwNzA0MA==", "bodyText": "Not yet", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r492507040", "createdAt": "2020-09-22T06:48:41Z", "author": {"login": "chenpiaoping"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/DatabaseProcessor.java", "diffHunk": "@@ -22,19 +22,26 @@\n import java.util.*;\n \n public class DatabaseProcessor extends AbstractProcessor {\n-    private NeighborInfo buildNeighborInfo(InternalPortEntity internalPortEntity) {\n+    private List<NeighborInfo> buildNeighborInfos(InternalPortEntity internalPortEntity) {\n+        List<NeighborInfo> neighborInfos = new ArrayList<>();\n         String bindingHostIp = internalPortEntity.getBindingHostIP();\n         if (bindingHostIp == null) {\n-            return null;\n+            return neighborInfos;\n         }\n \n-        NeighborInfo neighborInfo = new NeighborInfo(bindingHostIp,\n-                internalPortEntity.getBindingHostId(),\n-                internalPortEntity.getId(),\n-                internalPortEntity.getMacAddress(),\n-                internalPortEntity.getFixedIps().get(0).getIpAddress());\n+        //TODO: Support a port with multiple neighborInfos", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ4OTY5Mw=="}, "originalCommit": {"oid": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcyMTE0NA==", "bodyText": "Correct me if I am wrong. neighborInfos itself is an array and could contain more than one items assuming that a port has multiple fixed ips.\nCan you elaborate a bit what multiple neighbors you refer to? Which scenario may not be supported as this time.", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494721144", "createdAt": "2020-09-25T03:05:19Z", "author": {"login": "xieus"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/DatabaseProcessor.java", "diffHunk": "@@ -22,19 +22,26 @@\n import java.util.*;\n \n public class DatabaseProcessor extends AbstractProcessor {\n-    private NeighborInfo buildNeighborInfo(InternalPortEntity internalPortEntity) {\n+    private List<NeighborInfo> buildNeighborInfos(InternalPortEntity internalPortEntity) {\n+        List<NeighborInfo> neighborInfos = new ArrayList<>();\n         String bindingHostIp = internalPortEntity.getBindingHostIP();\n         if (bindingHostIp == null) {\n-            return null;\n+            return neighborInfos;\n         }\n \n-        NeighborInfo neighborInfo = new NeighborInfo(bindingHostIp,\n-                internalPortEntity.getBindingHostId(),\n-                internalPortEntity.getId(),\n-                internalPortEntity.getMacAddress(),\n-                internalPortEntity.getFixedIps().get(0).getIpAddress());\n+        //TODO: Support a port with multiple neighborInfos", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ4OTY5Mw=="}, "originalCommit": {"oid": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcyNDE1Nw==", "bodyText": "Oh, yes, neighborInfos itself is an array,  this comment is meaningless. Let me delete it.", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494724157", "createdAt": "2020-09-25T03:17:55Z", "author": {"login": "chenpiaoping"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/DatabaseProcessor.java", "diffHunk": "@@ -22,19 +22,26 @@\n import java.util.*;\n \n public class DatabaseProcessor extends AbstractProcessor {\n-    private NeighborInfo buildNeighborInfo(InternalPortEntity internalPortEntity) {\n+    private List<NeighborInfo> buildNeighborInfos(InternalPortEntity internalPortEntity) {\n+        List<NeighborInfo> neighborInfos = new ArrayList<>();\n         String bindingHostIp = internalPortEntity.getBindingHostIP();\n         if (bindingHostIp == null) {\n-            return null;\n+            return neighborInfos;\n         }\n \n-        NeighborInfo neighborInfo = new NeighborInfo(bindingHostIp,\n-                internalPortEntity.getBindingHostId(),\n-                internalPortEntity.getId(),\n-                internalPortEntity.getMacAddress(),\n-                internalPortEntity.getFixedIps().get(0).getIpAddress());\n+        //TODO: Support a port with multiple neighborInfos", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ4OTY5Mw=="}, "originalCommit": {"oid": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MjEyNDgxOnYy", "diffSide": "RIGHT", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/NeighborProcessor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNjowNzoxMFrOHVrTdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNjo1Mjo0NVrOHVsWbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ5MTYzOA==", "bodyText": "What if neighborInfos contains some duplicated neighbors? Is it possible?", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r492491638", "createdAt": "2020-09-22T06:07:10Z", "author": {"login": "xieus"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/NeighborProcessor.java", "diffHunk": "@@ -18,34 +18,31 @@\n import com.futurewei.alcor.portmanager.entity.PortNeighbors;\n import com.futurewei.alcor.portmanager.request.FetchPortNeighborRequest;\n import com.futurewei.alcor.portmanager.request.IRestRequest;\n-import com.futurewei.alcor.web.entity.dataplane.InternalPortEntity;\n import com.futurewei.alcor.web.entity.dataplane.NeighborInfo;\n import com.futurewei.alcor.web.entity.port.PortEntity;\n \n-import java.util.ArrayList;\n-import java.util.Collections;\n-import java.util.List;\n-import java.util.Set;\n+import java.util.*;\n import java.util.stream.Collectors;\n \n public class NeighborProcessor extends AbstractProcessor {\n     private void fetchPortNeighborCallback(IRestRequest request) {\n         List<PortNeighbors> portNeighborsList = ((FetchPortNeighborRequest) request).getPortNeighborsList();\n-        List<InternalPortEntity> internalPortEntities =\n-                request.getContext().getNetworkConfig().getPortEntities();\n-\n-        for (InternalPortEntity internalPortEntity : internalPortEntities) {\n-            for (PortNeighbors portNeighbors: portNeighborsList) {\n-                if (portNeighbors.getNeighbors() == null) {\n-                    continue;\n-                }\n+        if (portNeighborsList == null || portNeighborsList.size() == 0) {\n+            return;\n+        }\n \n-                if (internalPortEntity.getVpcId().equals(portNeighbors.getVpcId())) {\n-                    List<NeighborInfo> neighborInfos = new ArrayList<>(portNeighbors.getNeighbors().values());\n-                    internalPortEntity.setNeighborInfos(neighborInfos);\n-                }\n+        List<NeighborInfo> neighborInfos = new ArrayList<>();\n+        for (PortNeighbors portNeighbors: portNeighborsList) {\n+            if (portNeighbors.getNeighbors() == null ||\n+                    portNeighbors.getNeighbors().size() == 0) {\n+                continue;\n             }\n+\n+            neighborInfos.addAll(portNeighbors.getNeighbors().values());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUwODc4MA==", "bodyText": "The portNeighbors is read from the DB, and the they are stored with port_id as key, so the neighbor is not duplicated.", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r492508780", "createdAt": "2020-09-22T06:52:45Z", "author": {"login": "chenpiaoping"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/NeighborProcessor.java", "diffHunk": "@@ -18,34 +18,31 @@\n import com.futurewei.alcor.portmanager.entity.PortNeighbors;\n import com.futurewei.alcor.portmanager.request.FetchPortNeighborRequest;\n import com.futurewei.alcor.portmanager.request.IRestRequest;\n-import com.futurewei.alcor.web.entity.dataplane.InternalPortEntity;\n import com.futurewei.alcor.web.entity.dataplane.NeighborInfo;\n import com.futurewei.alcor.web.entity.port.PortEntity;\n \n-import java.util.ArrayList;\n-import java.util.Collections;\n-import java.util.List;\n-import java.util.Set;\n+import java.util.*;\n import java.util.stream.Collectors;\n \n public class NeighborProcessor extends AbstractProcessor {\n     private void fetchPortNeighborCallback(IRestRequest request) {\n         List<PortNeighbors> portNeighborsList = ((FetchPortNeighborRequest) request).getPortNeighborsList();\n-        List<InternalPortEntity> internalPortEntities =\n-                request.getContext().getNetworkConfig().getPortEntities();\n-\n-        for (InternalPortEntity internalPortEntity : internalPortEntities) {\n-            for (PortNeighbors portNeighbors: portNeighborsList) {\n-                if (portNeighbors.getNeighbors() == null) {\n-                    continue;\n-                }\n+        if (portNeighborsList == null || portNeighborsList.size() == 0) {\n+            return;\n+        }\n \n-                if (internalPortEntity.getVpcId().equals(portNeighbors.getVpcId())) {\n-                    List<NeighborInfo> neighborInfos = new ArrayList<>(portNeighbors.getNeighbors().values());\n-                    internalPortEntity.setNeighborInfos(neighborInfos);\n-                }\n+        List<NeighborInfo> neighborInfos = new ArrayList<>();\n+        for (PortNeighbors portNeighbors: portNeighborsList) {\n+            if (portNeighbors.getNeighbors() == null ||\n+                    portNeighbors.getNeighbors().size() == 0) {\n+                continue;\n             }\n+\n+            neighborInfos.addAll(portNeighbors.getNeighbors().values());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ5MTYzOA=="}, "originalCommit": {"oid": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NDY5NDk2OnYy", "diffSide": "RIGHT", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/util/RestParameterValidator.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNjo1MDo1MVrOHXj4Zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQwNjozNjo1MlrOHX2zSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ2NzE3NQ==", "bodyText": "We would need a case-insensitive check.", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494467175", "createdAt": "2020-09-24T16:50:51Z", "author": {"login": "xieus"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/util/RestParameterValidator.java", "diffHunk": "@@ -138,9 +138,9 @@ public static void checkRouterSubnetUpdateInfo(RouterUpdateInfo routerUpdateInfo\n             throw new SubnetIdInvalid();\n         }\n \n-        RouterUpdateInfo.OperationType operationType = routerUpdateInfo.getOperationType();\n-        if (!RouterUpdateInfo.OperationType.ADD.equals(operationType) &&\n-                !RouterUpdateInfo.OperationType.DELETE.equals(operationType)) {\n+        String operationType = routerUpdateInfo.getOperationType();\n+        if (!RouterUpdateInfo.OperationType.ADD.getType().equals(operationType) &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7dd1aeda09c727be089451465646c45c2a8b0dd4"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDczMDMyNA==", "bodyText": "@chenpiaoping Check if this is a problem. If not, we can go ahead to merge it.", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494730324", "createdAt": "2020-09-25T03:43:40Z", "author": {"login": "xieus"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/util/RestParameterValidator.java", "diffHunk": "@@ -138,9 +138,9 @@ public static void checkRouterSubnetUpdateInfo(RouterUpdateInfo routerUpdateInfo\n             throw new SubnetIdInvalid();\n         }\n \n-        RouterUpdateInfo.OperationType operationType = routerUpdateInfo.getOperationType();\n-        if (!RouterUpdateInfo.OperationType.ADD.equals(operationType) &&\n-                !RouterUpdateInfo.OperationType.DELETE.equals(operationType)) {\n+        String operationType = routerUpdateInfo.getOperationType();\n+        if (!RouterUpdateInfo.OperationType.ADD.getType().equals(operationType) &&", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ2NzE3NQ=="}, "originalCommit": {"oid": "7dd1aeda09c727be089451465646c45c2a8b0dd4"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDc3NzE2Mw==", "bodyText": "Fixed.", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494777163", "createdAt": "2020-09-25T06:36:52Z", "author": {"login": "chenpiaoping"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/util/RestParameterValidator.java", "diffHunk": "@@ -138,9 +138,9 @@ public static void checkRouterSubnetUpdateInfo(RouterUpdateInfo routerUpdateInfo\n             throw new SubnetIdInvalid();\n         }\n \n-        RouterUpdateInfo.OperationType operationType = routerUpdateInfo.getOperationType();\n-        if (!RouterUpdateInfo.OperationType.ADD.equals(operationType) &&\n-                !RouterUpdateInfo.OperationType.DELETE.equals(operationType)) {\n+        String operationType = routerUpdateInfo.getOperationType();\n+        if (!RouterUpdateInfo.OperationType.ADD.getType().equals(operationType) &&", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ2NzE3NQ=="}, "originalCommit": {"oid": "7dd1aeda09c727be089451465646c45c2a8b0dd4"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NjI5MTM0OnYy", "diffSide": "RIGHT", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/ProcessorManager.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQwMjozODo0NFrOHXy9Bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQwMzowOToxMlrOHXzcDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxNDExOQ==", "bodyText": "@chenpiaoping trying to understand whether this process relies on the new AfterProcessor annotation. How is the order determined?", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494714119", "createdAt": "2020-09-25T02:38:44Z", "author": {"login": "xieus"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/ProcessorManager.java", "diffHunk": "@@ -27,41 +27,57 @@\n public class ProcessorManager {\n     private static final Logger LOG = LoggerFactory.getLogger(ProcessorManager.class);\n \n-    private static List<IProcessor> statelessProcessors = new ArrayList<>();\n-    private static Map<Class, IProcessor> allProcessors = new HashMap<>();\n-    private static IProcessor headProcessor;\n-    private static IProcessor dataPlaneProcessor;\n-    private static IProcessor databaseProcessor;\n+    private static List<IProcessor> processors = new ArrayList<>();\n+    private static Map<Class, IProcessor> processorMap = new HashMap<>();\n \n     private void buildProcessChain() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5ffbfe2b464b115a0cf913c0bc70055652fe347"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxOTQyMQ==", "bodyText": "The order is determined in the instanceProcessor() method.", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494719421", "createdAt": "2020-09-25T02:58:30Z", "author": {"login": "chenpiaoping"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/ProcessorManager.java", "diffHunk": "@@ -27,41 +27,57 @@\n public class ProcessorManager {\n     private static final Logger LOG = LoggerFactory.getLogger(ProcessorManager.class);\n \n-    private static List<IProcessor> statelessProcessors = new ArrayList<>();\n-    private static Map<Class, IProcessor> allProcessors = new HashMap<>();\n-    private static IProcessor headProcessor;\n-    private static IProcessor dataPlaneProcessor;\n-    private static IProcessor databaseProcessor;\n+    private static List<IProcessor> processors = new ArrayList<>();\n+    private static Map<Class, IProcessor> processorMap = new HashMap<>();\n \n     private void buildProcessChain() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxNDExOQ=="}, "originalCommit": {"oid": "e5ffbfe2b464b115a0cf913c0bc70055652fe347"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcyMjA2MA==", "bodyText": "Got it. I think our current assumption for the chain is no more than 2, which should be satisficed in most of cases.", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494722060", "createdAt": "2020-09-25T03:09:12Z", "author": {"login": "xieus"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/ProcessorManager.java", "diffHunk": "@@ -27,41 +27,57 @@\n public class ProcessorManager {\n     private static final Logger LOG = LoggerFactory.getLogger(ProcessorManager.class);\n \n-    private static List<IProcessor> statelessProcessors = new ArrayList<>();\n-    private static Map<Class, IProcessor> allProcessors = new HashMap<>();\n-    private static IProcessor headProcessor;\n-    private static IProcessor dataPlaneProcessor;\n-    private static IProcessor databaseProcessor;\n+    private static List<IProcessor> processors = new ArrayList<>();\n+    private static Map<Class, IProcessor> processorMap = new HashMap<>();\n \n     private void buildProcessChain() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxNDExOQ=="}, "originalCommit": {"oid": "e5ffbfe2b464b115a0cf913c0bc70055652fe347"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NjMwMzk3OnYy", "diffSide": "RIGHT", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/RouterProcessor.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQwMjo0NToxM1rOHXzEFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQwMzo0MjoxOFrOHXz7Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxNTkyNg==", "bodyText": "Could we make the TRY_TIMES and SLEEP_TIME configurable?", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494715926", "createdAt": "2020-09-25T02:45:13Z", "author": {"login": "xieus"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/RouterProcessor.java", "diffHunk": "@@ -36,13 +41,24 @@ private void getRouterSubnetIds(PortContext context, String vpcId, String subnet\n                 fetchRouterSubnetsRequest, this::fetchConnectedSubnetIdsCallback);\n     }\n \n-    private void getRouterSubnetIds(PortContext context, List<PortEntity> portEntities) {\n+    private void getRouterSubnetIds(PortContext context, List<PortEntity> portEntities) throws Exception {\n         Set<String> vpcIds = new HashSet<>();\n+        int tryTimes = TRY_TIMES;\n         for (PortEntity portEntity: portEntities) {\n             if (portEntity.getFixedIps() == null) {\n                 continue;\n             }\n \n+            //Waiting for random ip address to be assigned\n+            while (portEntity.getFixedIps() == null && tryTimes > 0) {\n+                Thread.sleep(SLEEP_TIME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5ffbfe2b464b115a0cf913c0bc70055652fe347"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxOTk2Nw==", "bodyText": "This may be a temporary implementation, I am considering whether there is a better way to deal with request dependencies.", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494719967", "createdAt": "2020-09-25T03:00:36Z", "author": {"login": "chenpiaoping"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/RouterProcessor.java", "diffHunk": "@@ -36,13 +41,24 @@ private void getRouterSubnetIds(PortContext context, String vpcId, String subnet\n                 fetchRouterSubnetsRequest, this::fetchConnectedSubnetIdsCallback);\n     }\n \n-    private void getRouterSubnetIds(PortContext context, List<PortEntity> portEntities) {\n+    private void getRouterSubnetIds(PortContext context, List<PortEntity> portEntities) throws Exception {\n         Set<String> vpcIds = new HashSet<>();\n+        int tryTimes = TRY_TIMES;\n         for (PortEntity portEntity: portEntities) {\n             if (portEntity.getFixedIps() == null) {\n                 continue;\n             }\n \n+            //Waiting for random ip address to be assigned\n+            while (portEntity.getFixedIps() == null && tryTimes > 0) {\n+                Thread.sleep(SLEEP_TIME);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxNTkyNg=="}, "originalCommit": {"oid": "e5ffbfe2b464b115a0cf913c0bc70055652fe347"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcyMjQ1Nw==", "bodyText": "I think we could have a generic retry mechanism across the processes, but each process could have its own set of configurations.", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494722457", "createdAt": "2020-09-25T03:10:41Z", "author": {"login": "xieus"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/RouterProcessor.java", "diffHunk": "@@ -36,13 +41,24 @@ private void getRouterSubnetIds(PortContext context, String vpcId, String subnet\n                 fetchRouterSubnetsRequest, this::fetchConnectedSubnetIdsCallback);\n     }\n \n-    private void getRouterSubnetIds(PortContext context, List<PortEntity> portEntities) {\n+    private void getRouterSubnetIds(PortContext context, List<PortEntity> portEntities) throws Exception {\n         Set<String> vpcIds = new HashSet<>();\n+        int tryTimes = TRY_TIMES;\n         for (PortEntity portEntity: portEntities) {\n             if (portEntity.getFixedIps() == null) {\n                 continue;\n             }\n \n+            //Waiting for random ip address to be assigned\n+            while (portEntity.getFixedIps() == null && tryTimes > 0) {\n+                Thread.sleep(SLEEP_TIME);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxNTkyNg=="}, "originalCommit": {"oid": "e5ffbfe2b464b115a0cf913c0bc70055652fe347"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcyNTMzNw==", "bodyText": "I'm thinking of solving this problem through the observer design pattern, instead of blocking and waiting for dependent process completion in an asynchronous way.", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494725337", "createdAt": "2020-09-25T03:22:47Z", "author": {"login": "chenpiaoping"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/RouterProcessor.java", "diffHunk": "@@ -36,13 +41,24 @@ private void getRouterSubnetIds(PortContext context, String vpcId, String subnet\n                 fetchRouterSubnetsRequest, this::fetchConnectedSubnetIdsCallback);\n     }\n \n-    private void getRouterSubnetIds(PortContext context, List<PortEntity> portEntities) {\n+    private void getRouterSubnetIds(PortContext context, List<PortEntity> portEntities) throws Exception {\n         Set<String> vpcIds = new HashSet<>();\n+        int tryTimes = TRY_TIMES;\n         for (PortEntity portEntity: portEntities) {\n             if (portEntity.getFixedIps() == null) {\n                 continue;\n             }\n \n+            //Waiting for random ip address to be assigned\n+            while (portEntity.getFixedIps() == null && tryTimes > 0) {\n+                Thread.sleep(SLEEP_TIME);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxNTkyNg=="}, "originalCommit": {"oid": "e5ffbfe2b464b115a0cf913c0bc70055652fe347"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcyNTY2NQ==", "bodyText": "these configurations may not be needed in the future..", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494725665", "createdAt": "2020-09-25T03:24:06Z", "author": {"login": "chenpiaoping"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/RouterProcessor.java", "diffHunk": "@@ -36,13 +41,24 @@ private void getRouterSubnetIds(PortContext context, String vpcId, String subnet\n                 fetchRouterSubnetsRequest, this::fetchConnectedSubnetIdsCallback);\n     }\n \n-    private void getRouterSubnetIds(PortContext context, List<PortEntity> portEntities) {\n+    private void getRouterSubnetIds(PortContext context, List<PortEntity> portEntities) throws Exception {\n         Set<String> vpcIds = new HashSet<>();\n+        int tryTimes = TRY_TIMES;\n         for (PortEntity portEntity: portEntities) {\n             if (portEntity.getFixedIps() == null) {\n                 continue;\n             }\n \n+            //Waiting for random ip address to be assigned\n+            while (portEntity.getFixedIps() == null && tryTimes > 0) {\n+                Thread.sleep(SLEEP_TIME);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxNTkyNg=="}, "originalCommit": {"oid": "e5ffbfe2b464b115a0cf913c0bc70055652fe347"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDczMDAzNQ==", "bodyText": "Cool. Observer pattern is used in the case of one-to-many relationship between objects such as if one object is modified, its dependent objects are to be notified automatically. Does this apply to our scenario as you intend to use the asynchronous notification.\nThis temp configuration is fine for now. We can merge this PR of current form to master, and you can take the time to design and leverage some advanced design pattern \ud83d\udc4d", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494730035", "createdAt": "2020-09-25T03:42:18Z", "author": {"login": "xieus"}, "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/RouterProcessor.java", "diffHunk": "@@ -36,13 +41,24 @@ private void getRouterSubnetIds(PortContext context, String vpcId, String subnet\n                 fetchRouterSubnetsRequest, this::fetchConnectedSubnetIdsCallback);\n     }\n \n-    private void getRouterSubnetIds(PortContext context, List<PortEntity> portEntities) {\n+    private void getRouterSubnetIds(PortContext context, List<PortEntity> portEntities) throws Exception {\n         Set<String> vpcIds = new HashSet<>();\n+        int tryTimes = TRY_TIMES;\n         for (PortEntity portEntity: portEntities) {\n             if (portEntity.getFixedIps() == null) {\n                 continue;\n             }\n \n+            //Waiting for random ip address to be assigned\n+            while (portEntity.getFixedIps() == null && tryTimes > 0) {\n+                Thread.sleep(SLEEP_TIME);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxNTkyNg=="}, "originalCommit": {"oid": "e5ffbfe2b464b115a0cf913c0bc70055652fe347"}, "originalPosition": 34}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4388, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}