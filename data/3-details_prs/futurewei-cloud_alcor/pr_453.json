{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExODUwMTc0", "number": 453, "title": "[E2E Integration] Fix Multiple Issues in E2E Integration", "bodyText": "Fix multiple issues in e2e integration. The details of issues are described as follows:\nDescriptions\nIssue 1 - When deleting the subnet, we need to delete the corresponding binding subnet_id in vpc. If the process throws an exception, the exception type is unsupported 500\u3002\nIssue 2 - When calling getRulesBySubnetId API in RouteController, the routes in RoutesWebJson returned may be null\u3002\nIssue 3 - In the addAnInterfaceToNeutronRouter API in NeutronRouter, if validate router = null, router_id will still be attached in the subnet\u3002\nIssue 4 - Delete subnet shows success, but it did not actually succeed\uff0cbecause we lack the database operation of delete subnet in some reasons.\nSolutions\nIssue 1 solution: Change the HTTP exception type of SubnetIdIsNull to 412.\nIssue 2 solution: If routes is null, return new RoutesWebJson(new ArrayList<>()).\nIssue 3 solution: Put the steps of verifying router_id before subnet related operations.\nIssue 4 solution: Increase the database operation of delete subnet.", "createdAt": "2020-10-28T21:31:56Z", "url": "https://github.com/futurewei-cloud/alcor/pull/453", "merged": true, "mergeCommit": {"oid": "94d33a39f5565e8d1c2c7e5bccb26d020b342459"}, "closed": true, "closedAt": "2020-10-29T00:31:44Z", "author": {"login": "kevin-zhonghao"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQUKStAH2gAyNTExODUwMTc0OjI0YjliNzZhZTM0OWYyNzdhYzU1ZjFjYzExZTgxNjM2ZDE1NjliNmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXGzGGAH2gAyNTExODUwMTc0OjU2NjhlMTdlMmNmYmMxM2E2YTAzOWJkZDNiMjA1ODZhNWU2ZDUyZmY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "24b9b76ae349f277ac55f1cc11e81636d1569b6d", "author": {"user": {"login": "kevin-zhonghao", "name": "Zhonghao(Kevin) Lyu"}}, "url": "https://github.com/futurewei-cloud/alcor/commit/24b9b76ae349f277ac55f1cc11e81636d1569b6d", "committedDate": "2020-10-07T21:49:22Z", "message": "commit message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08ec421662ef56559a388e6c7308aa47cfd07a6b", "author": {"user": {"login": "kevin-zhonghao", "name": "Zhonghao(Kevin) Lyu"}}, "url": "https://github.com/futurewei-cloud/alcor/commit/08ec421662ef56559a388e6c7308aa47cfd07a6b", "committedDate": "2020-10-07T22:00:25Z", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor into new_master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2507b8fc44a4ca94da310b73c11453cec9f2504b", "author": {"user": {"login": "kevin-zhonghao", "name": "Zhonghao(Kevin) Lyu"}}, "url": "https://github.com/futurewei-cloud/alcor/commit/2507b8fc44a4ca94da310b73c11453cec9f2504b", "committedDate": "2020-10-15T17:12:49Z", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor into new_master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cab6bfa9573926c29b9f8dbbeab732a9de1da7e", "author": {"user": {"login": "kevin-zhonghao", "name": "Zhonghao(Kevin) Lyu"}}, "url": "https://github.com/futurewei-cloud/alcor/commit/8cab6bfa9573926c29b9f8dbbeab732a9de1da7e", "committedDate": "2020-10-15T23:33:06Z", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor into new_master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9d2a5822429286e2b01ce0842f16cb70dc5168f", "author": {"user": {"login": "kevin-zhonghao", "name": "Zhonghao(Kevin) Lyu"}}, "url": "https://github.com/futurewei-cloud/alcor/commit/d9d2a5822429286e2b01ce0842f16cb70dc5168f", "committedDate": "2020-10-16T16:57:50Z", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor into new_master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "daba98ee8949b91b2b77f74c6fbb30529355ee51", "author": {"user": {"login": "kevin-zhonghao", "name": "Zhonghao(Kevin) Lyu"}}, "url": "https://github.com/futurewei-cloud/alcor/commit/daba98ee8949b91b2b77f74c6fbb30529355ee51", "committedDate": "2020-10-20T00:03:13Z", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor into new_master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b813735c5032b70928a2304007875824f5ccedca", "author": {"user": {"login": "kevin-zhonghao", "name": "Zhonghao(Kevin) Lyu"}}, "url": "https://github.com/futurewei-cloud/alcor/commit/b813735c5032b70928a2304007875824f5ccedca", "committedDate": "2020-10-22T17:43:05Z", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor into new_master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd9a9847b0f42c5a7fd089ea09fa6f24233d008e", "author": {"user": {"login": "kevin-zhonghao", "name": "Zhonghao(Kevin) Lyu"}}, "url": "https://github.com/futurewei-cloud/alcor/commit/fd9a9847b0f42c5a7fd089ea09fa6f24233d008e", "committedDate": "2020-10-28T19:40:54Z", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor into new_master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8d7b4aa3ed8aa33cb514d0c8e469c26f5e5117d", "author": {"user": {"login": "kevin-zhonghao", "name": "Zhonghao(Kevin) Lyu"}}, "url": "https://github.com/futurewei-cloud/alcor/commit/e8d7b4aa3ed8aa33cb514d0c8e469c26f5e5117d", "committedDate": "2020-10-28T21:30:04Z", "message": "fix multiple issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b590cad0fcbb1a04c1e31136541df562f1303a92", "author": {"user": {"login": "kevin-zhonghao", "name": "Zhonghao(Kevin) Lyu"}}, "url": "https://github.com/futurewei-cloud/alcor/commit/b590cad0fcbb1a04c1e31136541df562f1303a92", "committedDate": "2020-10-28T21:46:02Z", "message": "update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5MTIzMjMw", "url": "https://github.com/futurewei-cloud/alcor/pull/453#pullrequestreview-519123230", "createdAt": "2020-10-28T22:11:18Z", "commit": {"oid": "b590cad0fcbb1a04c1e31136541df562f1303a92"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMjoxMToxOFrOHp_aJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMjoxMjozOFrOHp_cOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc5MjU0OQ==", "bodyText": "In order to grant deletion, we will need to make sure the following two conditions are met:\n\nNo ports are under this subnet\nThe subnet is not attached to any router", "url": "https://github.com/futurewei-cloud/alcor/pull/453#discussion_r513792549", "createdAt": "2020-10-28T22:11:18Z", "author": {"login": "xieus"}, "path": "services/subnet_manager/src/main/java/com/futurewei/alcor/subnet/controller/SubnetController.java", "diffHunk": "@@ -449,7 +449,7 @@ public ResponseId deleteSubnetState(@PathVariable String projectId, @PathVariabl\n                 return new ResponseId();\n             }\n \n-            //RestPreconditionsUtil.verifyParameterEqual(subnetEntity.getProjectId(), projectId);\n+            this.subnetDatabaseService.deleteSubnet(subnetId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b590cad0fcbb1a04c1e31136541df562f1303a92"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc5MzA4Mg==", "bodyText": "Recommend to\n\nrename it to RouterUnavailable or RouterNotExist\nprint router id in the exception message", "url": "https://github.com/futurewei-cloud/alcor/pull/453#discussion_r513793082", "createdAt": "2020-10-28T22:12:38Z", "author": {"login": "xieus"}, "path": "services/route_manager/src/main/java/com/futurewei/alcor/route/service/Impl/NeutronRouterServiceImpl.java", "diffHunk": "@@ -159,6 +159,11 @@ else if (portId == null && subnetId != null) {\n         } else {\n             return new RouterInterfaceResponse();\n         }\n+        Router router = this.routerDatabaseService.getByRouterId(routerId);\n+        if (router == null) {\n+            throw new CanNotFindRouter();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b590cad0fcbb1a04c1e31136541df562f1303a92"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b47088ce7d376fd679e497df6eefb5a33f9d4c5", "author": {"user": {"login": "kevin-zhonghao", "name": "Zhonghao(Kevin) Lyu"}}, "url": "https://github.com/futurewei-cloud/alcor/commit/1b47088ce7d376fd679e497df6eefb5a33f9d4c5", "committedDate": "2020-10-28T22:57:01Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83b8b15c444f3d6180cb2a5e7788df3c66bc3f6b", "author": {"user": {"login": "kevin-zhonghao", "name": "Zhonghao(Kevin) Lyu"}}, "url": "https://github.com/futurewei-cloud/alcor/commit/83b8b15c444f3d6180cb2a5e7788df3c66bc3f6b", "committedDate": "2020-10-28T23:08:37Z", "message": "update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5MTYyNDU4", "url": "https://github.com/futurewei-cloud/alcor/pull/453#pullrequestreview-519162458", "createdAt": "2020-10-28T23:42:19Z", "commit": {"oid": "83b8b15c444f3d6180cb2a5e7788df3c66bc3f6b"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMzo0MjoyMFrOHqBcJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMzo0Mjo0OFrOHqBcqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgyNTgyOA==", "bodyText": "Minor comment:\nif (attachedRouterId == null || attachedRouterId.equals(\"\")){\nreturn false;\n}\nreturn true;", "url": "https://github.com/futurewei-cloud/alcor/pull/453#discussion_r513825828", "createdAt": "2020-10-28T23:42:20Z", "author": {"login": "xieus"}, "path": "services/subnet_manager/src/main/java/com/futurewei/alcor/subnet/service/implement/SubnetServiceImp.java", "diffHunk": "@@ -362,6 +360,37 @@ public void deleteSubnetIdInVpc(String subnetId, String projectId, String vpcId)\n         restTemplate.put(vpcManagerServiceUrl, VpcWebJson.class);\n     }\n \n+    @Override\n+    public boolean checkIfAnyPortInSubnet(String rangeId) throws RangeIdIsNullOrEmpty {\n+        if (rangeId == null) {\n+            throw new RangeIdIsNullOrEmpty();\n+        }\n+        String ipManagerServiceUrl = ipUrl + rangeId;\n+        IpAddrRangeRequest ipAddrRangeRequest = restTemplate.getForObject(ipManagerServiceUrl, IpAddrRangeRequest.class);\n+        if (ipAddrRangeRequest == null) {\n+            return false;\n+        }\n+\n+        // check usedIps\n+        long usedIps = ipAddrRangeRequest.getUsedIps();\n+        if (usedIps > ConstantsConfig.UsedIpThreshold) {\n+            return true;\n+        }\n+\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean checkIfSubnetBindAnyRoutes(SubnetEntity subnetEntity) {\n+\n+        String attachedRouterId = subnetEntity.getAttachedRouterId();\n+        if (attachedRouterId != null && !attachedRouterId.equals(\"\")){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83b8b15c444f3d6180cb2a5e7788df3c66bc3f6b"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgyNTk2MA==", "bodyText": "Very good improvement and thanks.", "url": "https://github.com/futurewei-cloud/alcor/pull/453#discussion_r513825960", "createdAt": "2020-10-28T23:42:48Z", "author": {"login": "xieus"}, "path": "services/subnet_manager/src/main/java/com/futurewei/alcor/subnet/controller/SubnetController.java", "diffHunk": "@@ -449,7 +449,7 @@ public ResponseId deleteSubnetState(@PathVariable String projectId, @PathVariabl\n                 return new ResponseId();\n             }\n \n-            //RestPreconditionsUtil.verifyParameterEqual(subnetEntity.getProjectId(), projectId);\n+            this.subnetDatabaseService.deleteSubnet(subnetId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc5MjU0OQ=="}, "originalCommit": {"oid": "b590cad0fcbb1a04c1e31136541df562f1303a92"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15e765d162ebd3cdf61c4b6dcab87f813ee6fb97", "author": {"user": {"login": "kevin-zhonghao", "name": "Zhonghao(Kevin) Lyu"}}, "url": "https://github.com/futurewei-cloud/alcor/commit/15e765d162ebd3cdf61c4b6dcab87f813ee6fb97", "committedDate": "2020-10-29T00:09:42Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5668e17e2cfbc13a6a039bdd3b20586a5e6d52ff", "author": {"user": {"login": "kevin-zhonghao", "name": "Zhonghao(Kevin) Lyu"}}, "url": "https://github.com/futurewei-cloud/alcor/commit/5668e17e2cfbc13a6a039bdd3b20586a5e6d52ff", "committedDate": "2020-10-29T00:12:44Z", "message": "update"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2003, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}