{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxMzMyNzM0", "number": 6020, "title": "Fixes multi agent post verification analysis", "bodyText": "Description\nThis PR fixes post verification analysis results involving work done on multiple agents. It appears the post step of the Verify stage is run on the main agent only, meaning it only has access to build artefacts produced on that agent. Any results (e.g. FlakyTests.txt, JaCoCo .exec files) produced in the IT stage are ignored in the post analysis.\nThe solution is to stash and un-stash the artefacts produced by the IT agents. As they have share the same names (since those are coming from the POM/plugins), a new directory is created as .tmp/it in the main agent, where the files are un-stashed.\nRelated issues\nDefinition of Done\nNot all items need to be done depending on the issue and the pull request.\nCode changes:\n\n The changes are backwards compatibility with previous versions\n If it fixes a bug then PRs are created to backport the fix to the last two minor versions. You can trigger a backport by assigning labels (e.g. backport stable/0.25) to the PR, in case that fails you need to create backports manually.\n\nTesting:\n\n There are unit/integration tests that verify all acceptance criterias of the issue\n New tests are written to ensure backwards compatibility with further versions\n The behavior is tested manually\n The change has been verified by a QA run\n The impact of the changes is verified by a benchmark\n\nDocumentation:\n\n The documentation is updated (e.g. BPMN reference, configuration, examples, get-started guides, etc.)\n New content is added to the release announcement", "createdAt": "2020-12-16T17:40:19Z", "url": "https://github.com/camunda-cloud/zeebe/pull/6020", "merged": true, "mergeCommit": {"oid": "45c9a86379a3ebc37e9f95e25f44aa1cba0250f2"}, "closed": true, "closedAt": "2020-12-17T10:41:32Z", "author": {"login": "npepinpe"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmykeVgBqjQxMjA5NzExNjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnAqa8gBqjQxMjQyODc1NzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d07b37ac1073ff3ff142a1edbbaae3d7619554dc", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/d07b37ac1073ff3ff142a1edbbaae3d7619554dc", "committedDate": "2020-12-16T17:35:20Z", "message": "fix(ci): fix multi-agent post analysis\n\n- fixes JaCoCo analysis by stashing the IT agent results and unstashing\n  them in the main agent to make them available during post analysis\n- fixes flaky test analysis/build status by stashing the IT agent\n  results and unstashing them in the main agent for post analysis"}, "afterCommit": {"oid": "913b82b49caf3d58a05ea21d930f7b3af9df8d39", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/913b82b49caf3d58a05ea21d930f7b3af9df8d39", "committedDate": "2020-12-16T17:41:19Z", "message": "fix(ci): fix multi-agent post analysis\n\n- fixes JaCoCo analysis by stashing the IT agent results and unstashing\n  them in the main agent to make them available during post analysis\n- fixes flaky test analysis/build status by stashing the IT agent\n  results and unstashing them in the main agent for post analysis"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "913b82b49caf3d58a05ea21d930f7b3af9df8d39", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/913b82b49caf3d58a05ea21d930f7b3af9df8d39", "committedDate": "2020-12-16T17:41:19Z", "message": "fix(ci): fix multi-agent post analysis\n\n- fixes JaCoCo analysis by stashing the IT agent results and unstashing\n  them in the main agent to make them available during post analysis\n- fixes flaky test analysis/build status by stashing the IT agent\n  results and unstashing them in the main agent for post analysis"}, "afterCommit": {"oid": "840220f6688f7d96ba8d59901c8e75611088e643", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/840220f6688f7d96ba8d59901c8e75611088e643", "committedDate": "2020-12-16T20:56:03Z", "message": "fix(ci): fix multi-agent post analysis\n\n- fixes JaCoCo analysis by stashing the IT agent results and unstashing\n  them in the main agent to make them available during post analysis\n- fixes flaky test analysis/build status by stashing the IT agent\n  results and unstashing them in the main agent for post analysis"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NDE3NTU0", "url": "https://github.com/camunda-cloud/zeebe/pull/6020#pullrequestreview-554417554", "createdAt": "2020-12-17T09:25:13Z", "commit": {"oid": "840220f6688f7d96ba8d59901c8e75611088e643"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwOToyNToxNFrOIHsO3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwOToyNzo0OVrOIHsWKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDkzNTY0Nw==", "bodyText": "Do we want to run test coverage for integration tests? I find this approach rather unusual.\nNormally, code coverage is recorded for unit tests primarily. Because for unit tests the code being executed is often the code being testen.\nFor integration tests, there is so much code being executed during a test that the code coverage metric becomes less useful.", "url": "https://github.com/camunda-cloud/zeebe/pull/6020#discussion_r544935647", "createdAt": "2020-12-17T09:25:14Z", "author": {"login": "pihme"}, "path": "Jenkinsfile", "diffHunk": "@@ -234,6 +250,13 @@ pipeline {\n                             post {\n                                 always {\n                                     junit testResults: \"**/*/TEST*${SUREFIRE_REPORT_NAME_SUFFIX}*.xml\", keepLongStdio: true\n+                                    stash allowEmpty: true, name: itJacocoStashName, includes: '**/*.exec'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "840220f6688f7d96ba8d59901c8e75611088e643"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDkzNzUxMw==", "bodyText": "Question for my understanding:\nWhy do we need to stash these files for IT tests, but not for the other tests? Or in other words, how can I know for which agent I need to stash/unstash things and for which I don't need it?\nIs there same way we can make this clearer, e.g. by given the agents different names?", "url": "https://github.com/camunda-cloud/zeebe/pull/6020#discussion_r544937513", "createdAt": "2020-12-17T09:27:49Z", "author": {"login": "pihme"}, "path": "Jenkinsfile", "diffHunk": "@@ -234,6 +250,13 @@ pipeline {\n                             post {\n                                 always {\n                                     junit testResults: \"**/*/TEST*${SUREFIRE_REPORT_NAME_SUFFIX}*.xml\", keepLongStdio: true\n+                                    stash allowEmpty: true, name: itJacocoStashName, includes: '**/*.exec'\n+                                }\n+\n+                                failure {\n+                                    zip zipFile: 'test-reports-it.zip', archive: true, glob: \"**/*/surefire-reports/**\"\n+                                    zip zipFile: 'test-errors-it.zip', archive: true, glob: \"**/hs_err_*.log\"\n+                                    stash allowEmpty: true, name: itFlakyTestStashName, includes: '**/FlakyTests.txt'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "840220f6688f7d96ba8d59901c8e75611088e643"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NDQ2NjI1", "url": "https://github.com/camunda-cloud/zeebe/pull/6020#pullrequestreview-554446625", "createdAt": "2020-12-17T10:00:07Z", "commit": {"oid": "43184ea6eaee3b59c739086d0b7366b51b4d0cb6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f9b479f1bffc91a612c43d5b49afba839fa4955", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/3f9b479f1bffc91a612c43d5b49afba839fa4955", "committedDate": "2020-12-17T10:06:28Z", "message": "fix(ci): fix multi-agent post analysis\n\n- fixes JaCoCo analysis by stashing the IT agent results and unstashing\n  them in the main agent to make them available during post analysis\n- fixes flaky test analysis/build status by stashing the IT agent\n  results and unstashing them in the main agent for post analysis"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c20b16417eadf17303a30a4457a89f7dc9f1723", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/7c20b16417eadf17303a30a4457a89f7dc9f1723", "committedDate": "2020-12-17T10:06:28Z", "message": "chore(qa): skip JaCoCo for IT"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "12a844915a4d3fde2809097954575ef4a313487a", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/12a844915a4d3fde2809097954575ef4a313487a", "committedDate": "2020-12-17T10:03:11Z", "message": "chore(ci): explain nested agent"}, "afterCommit": {"oid": "7c20b16417eadf17303a30a4457a89f7dc9f1723", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/7c20b16417eadf17303a30a4457a89f7dc9f1723", "committedDate": "2020-12-17T10:06:28Z", "message": "chore(qa): skip JaCoCo for IT"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2237, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}