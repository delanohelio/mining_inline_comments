{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc2ODc0MjA2", "number": 5269, "title": "Fix disk monitor notification on startup and during failover", "bodyText": "Description\n\nCheck for disk availability immediately on start\nNotify listeners if disk is not available when they are added\nPause streamprocessor if no disk available during a leader change\n\nRelated issues\ncloses #5093\nDefinition of Done\nNot all items need to be done depending on the issue and the pull request.\nCode changes:\n\n The changes are backwards compatibility with previous versions\n If it fixes a bug then PRs are created to backport the fix to the last two minor versions\n\nTesting:\n\n There are unit/integration tests that verify all acceptance criterias of the issue\n New tests are written to ensure backwards compatibility with further versions\n The behavior is tested manually\n The impact of the changes is verified by a benchmark\n\nDocumentation:\n\n The documentation is updated (e.g. BPMN reference, configuration, examples, get-started guides, etc.)\n New content is added to the release announcement", "createdAt": "2020-09-01T07:20:05Z", "url": "https://github.com/camunda-cloud/zeebe/pull/5269", "merged": true, "mergeCommit": {"oid": "5086b7cbccd1485df05814c261b030367e706604"}, "closed": true, "closedAt": "2020-09-02T15:55:38Z", "author": {"login": "deepthidevaki"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdE4HsOgFqTQ4MDU5OTUwMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdE9vmaABqjM3MjA0MzEzOTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNTk5NTAw", "url": "https://github.com/camunda-cloud/zeebe/pull/5269#pullrequestreview-480599500", "createdAt": "2020-09-02T08:31:57Z", "commit": {"oid": "a859c1d7b30ef680b7cfe897212611c4e0da533f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwODozMTo1OFrOHLkAkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwODo1MjozN1rOHLlKWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg4NjM1Mw==", "bodyText": "Why this change? Why no longer do it immediately?", "url": "https://github.com/camunda-cloud/zeebe/pull/5269#discussion_r481886353", "createdAt": "2020-09-02T08:31:58Z", "author": {"login": "pihme"}, "path": "broker/src/main/java/io/zeebe/broker/system/monitoring/DiskSpaceUsageMonitor.java", "diffHunk": "@@ -56,11 +57,18 @@ private void checkDiskUsageAndNotifyListeners() {\n   }\n \n   public void addDiskUsageListener(final DiskSpaceUsageListener listener) {\n-    diskSpaceUsageListeners.add(listener);\n+    actor.call(\n+        () -> {\n+          diskSpaceUsageListeners.add(listener);\n+          // Listeners always assumes diskspace is available on start. So notify them if it is not.\n+          if (!currentDiskAvailableStatus) {\n+            listener.onDiskSpaceNotAvailable();\n+          }\n+        });\n   }\n \n   public void removeDiskUsageListener(final DiskSpaceUsageListener listener) {\n-    diskSpaceUsageListeners.remove(listener);\n+    actor.call(() -> diskSpaceUsageListeners.remove(listener));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a859c1d7b30ef680b7cfe897212611c4e0da533f"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg5NDUzNg==", "bodyText": "Please let us talk about this.\nThe SpringBrokerBridge is intended to be treated like a Singleton, and managed by Spring. So nobody should call its constructor.", "url": "https://github.com/camunda-cloud/zeebe/pull/5269#discussion_r481894536", "createdAt": "2020-09-02T08:40:57Z", "author": {"login": "pihme"}, "path": "qa/integration-tests/src/test/java/io/zeebe/broker/it/clustering/ClusteringRule.java", "diffHunk": "@@ -114,6 +114,7 @@\n   private Gateway gateway;\n   private CountDownLatch partitionLatch;\n   private final Map<Integer, Leader> partitionLeader;\n+  private final Map<Integer, SpringBrokerBridge> springBrokerBridge;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a859c1d7b30ef680b7cfe897212611c4e0da533f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwNTI0Mg==", "bodyText": "This comment is actually for line 30 this.minFreeDiskSpaceRequired = dataCfg.getFreeDiskSpaceCommandWatermark(); (I don't know hot to add comments for lines that have not changed)\nI am pretty (albeit not a 100%) sure that this can be wrong. During out game days one of the interventions that the cloud team was able to do was to increase the PVC of the running broker. That means in the cloud the disk can grow (or shrink) at runtime, so this should become a supplier instead of a cached vale.", "url": "https://github.com/camunda-cloud/zeebe/pull/5269#discussion_r481905242", "createdAt": "2020-09-02T08:52:37Z", "author": {"login": "pihme"}, "path": "broker/src/main/java/io/zeebe/broker/system/monitoring/DiskSpaceUsageMonitor.java", "diffHunk": "@@ -34,6 +34,7 @@ public DiskSpaceUsageMonitor(final DataCfg dataCfg) {\n \n   @Override\n   protected void onActorStarted() {\n+    checkDiskUsageAndNotifyListeners();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a859c1d7b30ef680b7cfe897212611c4e0da533f"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNzc3MDI3", "url": "https://github.com/camunda-cloud/zeebe/pull/5269#pullrequestreview-480777027", "createdAt": "2020-09-02T12:41:03Z", "commit": {"oid": "a859c1d7b30ef680b7cfe897212611c4e0da533f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxMjo0MTowNFrOHLtJ9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxMjo0MTowNFrOHLtJ9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAzNjIxMw==", "bodyText": "Sorry, my bad. Didn't realize that we are in the test code.", "url": "https://github.com/camunda-cloud/zeebe/pull/5269#discussion_r482036213", "createdAt": "2020-09-02T12:41:04Z", "author": {"login": "pihme"}, "path": "qa/integration-tests/src/test/java/io/zeebe/broker/it/clustering/ClusteringRule.java", "diffHunk": "@@ -114,6 +114,7 @@\n   private Gateway gateway;\n   private CountDownLatch partitionLatch;\n   private final Map<Integer, Leader> partitionLeader;\n+  private final Map<Integer, SpringBrokerBridge> springBrokerBridge;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg5NDUzNg=="}, "originalCommit": {"oid": "a859c1d7b30ef680b7cfe897212611c4e0da533f"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a859c1d7b30ef680b7cfe897212611c4e0da533f", "author": {"user": {"login": "deepthidevaki", "name": "Deepthi Devaki Akkoorath"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/a859c1d7b30ef680b7cfe897212611c4e0da533f", "committedDate": "2020-08-31T14:08:24Z", "message": "chore(broker): notify diskspace listeners when added\nand pause streamprocessor after a failover if diskspace not available"}, "afterCommit": {"oid": "e68747736bf8b75b281b1ebcd9caf35748a25bd9", "author": {"user": {"login": "deepthidevaki", "name": "Deepthi Devaki Akkoorath"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/e68747736bf8b75b281b1ebcd9caf35748a25bd9", "committedDate": "2020-09-02T14:10:16Z", "message": "chore(broker): notify diskspace listeners when added\nand pause streamprocessor after a failover if diskspace not available"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cdf4802bf657b4a75976e0e99e61c8c2dce8d1c", "author": {"user": {"login": "deepthidevaki", "name": "Deepthi Devaki Akkoorath"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/1cdf4802bf657b4a75976e0e99e61c8c2dce8d1c", "committedDate": "2020-09-02T15:28:56Z", "message": "chore(qa): add tests for diskspace monitor after a failover"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16fc7e7d3c7265bddc3549cc24f7d6ba9c5f9570", "author": {"user": {"login": "deepthidevaki", "name": "Deepthi Devaki Akkoorath"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/16fc7e7d3c7265bddc3549cc24f7d6ba9c5f9570", "committedDate": "2020-09-02T15:28:56Z", "message": "chore(broker): notify diskspace listeners when added\nand pause streamprocessor after a failover if diskspace not available"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e68747736bf8b75b281b1ebcd9caf35748a25bd9", "author": {"user": {"login": "deepthidevaki", "name": "Deepthi Devaki Akkoorath"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/e68747736bf8b75b281b1ebcd9caf35748a25bd9", "committedDate": "2020-09-02T14:10:16Z", "message": "chore(broker): notify diskspace listeners when added\nand pause streamprocessor after a failover if diskspace not available"}, "afterCommit": {"oid": "16fc7e7d3c7265bddc3549cc24f7d6ba9c5f9570", "author": {"user": {"login": "deepthidevaki", "name": "Deepthi Devaki Akkoorath"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/16fc7e7d3c7265bddc3549cc24f7d6ba9c5f9570", "committedDate": "2020-09-02T15:28:56Z", "message": "chore(broker): notify diskspace listeners when added\nand pause streamprocessor after a failover if diskspace not available"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2589, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}