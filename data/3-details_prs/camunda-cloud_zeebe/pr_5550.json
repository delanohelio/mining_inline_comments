{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5OTIzODA5", "number": 5550, "title": "Fix flaky CancelWorkflowInstanceConcurrentlyTest again", "bodyText": "Description\nIt looked like #5485 fixed the flakiness, but it didn't.\nThe test has multiple scenarios, and the sequential scenario actually\nonly expects 1 job to become activatable.\nIn addition, in the scenarios where we expect 2 jobs to become\nactivatable, it was not enough to just limit the stream to 2 when only\ngrabbing one specific one. This because it might not be clear which job\nis created first. Therefore, the tests should always first assert that\nall expected jobs have been created and then continue.\nRelated issues\ncloses #3606\nDefinition of Done\nNot all items need to be done depending on the issue and the pull request.\nCode changes:\n\n The changes are backwards compatibility with previous versions\n If it fixes a bug then PRs are created to backport the fix to the last two minor versions\n\nTesting:\n\n There are unit/integration tests that verify all acceptance criterias of the issue\n New tests are written to ensure backwards compatibility with further versions\n The behavior is tested manually\n The impact of the changes is verified by a benchmark\n\nDocumentation:\n\n The documentation is updated (e.g. BPMN reference, configuration, examples, get-started guides, etc.)\n New content is added to the release announcement", "createdAt": "2020-10-08T13:29:49Z", "url": "https://github.com/camunda-cloud/zeebe/pull/5550", "merged": true, "mergeCommit": {"oid": "c92ba0500de69ae829637fca2e2a2fb8a49b2556"}, "closed": true, "closedAt": "2020-10-09T10:05:28Z", "author": {"login": "korthout"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQiqTSABqjM4NTU4NDY0MDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQybQhgFqTUwNTQ5MzAzNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d61d2870b940007520d602f4a6b89934553456cd", "author": {"user": {"login": "korthout", "name": "Nico Korthout"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/d61d2870b940007520d602f4a6b89934553456cd", "committedDate": "2020-10-08T13:26:22Z", "message": "test(engine): fix flaky test again\n\nLimiting the records to 2, filtering them and then grabbing the first\ncould still mean that only 1 of the jobs exist. This commit first\nasserts that both jobs exists and then picks the one to continue with"}, "afterCommit": {"oid": "31d462e78e5f3dfdd43f5628a93b377af5cfa804", "author": {"user": {"login": "korthout", "name": "Nico Korthout"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/31d462e78e5f3dfdd43f5628a93b377af5cfa804", "committedDate": "2020-10-08T14:42:51Z", "message": "test(engine): fix flaky test again\n\nLimiting the records to 2, filtering them and then grabbing the first\ncould still mean that only 1 of the jobs exist. This commit first\nasserts that both jobs exists and then picks the one to continue with"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MzQ1Njg0", "url": "https://github.com/camunda-cloud/zeebe/pull/5550#pullrequestreview-505345684", "createdAt": "2020-10-09T03:46:24Z", "commit": {"oid": "31d462e78e5f3dfdd43f5628a93b377af5cfa804"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwMzo0NjoyNFrOHe6CqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwMzo0NjoyNFrOHe6CqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE3MDI4MQ==", "bodyText": "This assertion fails in the CI. Please have a look.", "url": "https://github.com/camunda-cloud/zeebe/pull/5550#discussion_r502170281", "createdAt": "2020-10-09T03:46:24Z", "author": {"login": "saig0"}, "path": "engine/src/test/java/io/zeebe/engine/processing/workflowinstance/CancelWorkflowInstanceConcurrentlyTest.java", "diffHunk": "@@ -141,10 +141,16 @@ public void init() {\n             .withElementType(BpmnElementType.SERVICE_TASK)\n             .getFirst();\n \n+    // wait for both jobs to appear\n+    assertThat(\n+            RecordingExporter.jobRecords(JobIntent.CREATED)\n+                .withWorkflowInstanceKey(workflowInstanceKey)\n+                .limit(2))\n+        .hasSize(2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d462e78e5f3dfdd43f5628a93b377af5cfa804"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29c8c389bfaadf58836618ef9991bd504d4e856d", "author": {"user": {"login": "korthout", "name": "Nico Korthout"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/29c8c389bfaadf58836618ef9991bd504d4e856d", "committedDate": "2020-10-09T08:16:15Z", "message": "test(engine): fix flaky test again\n\nThe test has multiple scenarios, and the sequential scenario actually\nonly expects 1 job to become activatable.\n\nIn addition, in the scenarios where we expect 2 jobs to become\nactivatable, it was not enough to just limit the stream to 2 when only\ngrabbing one specific one. This because it might not be clear which job\nis created first. Therefore, the tests should always first assert that\nall expected jobs have been created and then continue."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "31d462e78e5f3dfdd43f5628a93b377af5cfa804", "author": {"user": {"login": "korthout", "name": "Nico Korthout"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/31d462e78e5f3dfdd43f5628a93b377af5cfa804", "committedDate": "2020-10-08T14:42:51Z", "message": "test(engine): fix flaky test again\n\nLimiting the records to 2, filtering them and then grabbing the first\ncould still mean that only 1 of the jobs exist. This commit first\nasserts that both jobs exists and then picks the one to continue with"}, "afterCommit": {"oid": "29c8c389bfaadf58836618ef9991bd504d4e856d", "author": {"user": {"login": "korthout", "name": "Nico Korthout"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/29c8c389bfaadf58836618ef9991bd504d4e856d", "committedDate": "2020-10-09T08:16:15Z", "message": "test(engine): fix flaky test again\n\nThe test has multiple scenarios, and the sequential scenario actually\nonly expects 1 job to become activatable.\n\nIn addition, in the scenarios where we expect 2 jobs to become\nactivatable, it was not enough to just limit the stream to 2 when only\ngrabbing one specific one. This because it might not be clear which job\nis created first. Therefore, the tests should always first assert that\nall expected jobs have been created and then continue."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NDkzMDM0", "url": "https://github.com/camunda-cloud/zeebe/pull/5550#pullrequestreview-505493034", "createdAt": "2020-10-09T09:05:03Z", "commit": {"oid": "29c8c389bfaadf58836618ef9991bd504d4e856d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2442, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}