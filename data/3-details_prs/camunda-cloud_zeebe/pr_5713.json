{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExMzY3OTA0", "number": 5713, "title": "Add FNI metrics", "bodyText": "Description\nAdd flow node instance metrics to the build-in MetricExporter\nFNI's are counted for ELEMENT_COMPLETED and ELEMENT_TERMINATED.\nAdds also new metric panels to the dashboard to show the current FNI's overall partition but also per partition.\n\n\nRelated issues\n\ncloses #5684\nDefinition of Done\nNot all items need to be done depending on the issue and the pull request.\nCode changes:\n\n The changes are backwards compatibility with previous versions\n If it fixes a bug then PRs are created to backport the fix to the last two minor versions\n\nTesting:\n\n There are unit/integration tests that verify all acceptance criterias of the issue\n New tests are written to ensure backwards compatibility with further versions\n The behavior is tested manually\n The impact of the changes is verified by a benchmark\n\nDocumentation:\n\n The documentation is updated (e.g. BPMN reference, configuration, examples, get-started guides, etc.)\n New content is added to the release announcement", "createdAt": "2020-10-28T08:24:31Z", "url": "https://github.com/camunda-cloud/zeebe/pull/5713", "merged": true, "mergeCommit": {"oid": "d3f6375a02c3d1bb10bb879f07f45ce6f15be520"}, "closed": true, "closedAt": "2020-10-28T15:07:32Z", "author": {"login": "Zelldon"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdW5QXZABqjM5Mjk5NDY4ODk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdW-DkhgFqTUxODY5MjM5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1566aa50b6905535a54d3545d2da21a223248b72", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/1566aa50b6905535a54d3545d2da21a223248b72", "committedDate": "2020-10-28T08:22:58Z", "message": "chore(monitor): add FNI metrics panel's"}, "afterCommit": {"oid": "307589c50fc08a6e9305992881174ad3fd945f74", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/307589c50fc08a6e9305992881174ad3fd945f74", "committedDate": "2020-10-28T08:25:50Z", "message": "chore(monitor): add FNI metrics panel's"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4NTI5MzIz", "url": "https://github.com/camunda-cloud/zeebe/pull/5713#pullrequestreview-518529323", "createdAt": "2020-10-28T10:42:46Z", "commit": {"oid": "307589c50fc08a6e9305992881174ad3fd945f74"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxMDo0Mjo0N1rOHpj-mA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxMDo1MzozNlrOHpkXyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM0MzEyOA==", "bodyText": "We count FNI completed not for the process itself. I guess that we want to do the same for FNI terminated.", "url": "https://github.com/camunda-cloud/zeebe/pull/5713#discussion_r513343128", "createdAt": "2020-10-28T10:42:47Z", "author": {"login": "saig0"}, "path": "broker/src/main/java/io/zeebe/broker/exporter/metrics/MetricsExporter.java", "diffHunk": "@@ -82,11 +82,16 @@ private void handleWorkflowInstanceRecord(\n     if (currentIntent == WorkflowInstanceIntent.ELEMENT_ACTIVATING\n         && isWorkflowInstanceRecord(record)) {\n       storeWorkflowInstanceCreation(record.getTimestamp(), recordKey);\n-    } else if (currentIntent == WorkflowInstanceIntent.ELEMENT_COMPLETED\n-        && isWorkflowInstanceRecord(record)) {\n-      final var creationTime = workflowInstanceKeyToCreationTimeMap.remove(recordKey);\n-      executionLatencyMetrics.observeWorkflowInstanceExecutionTime(\n-          partitionId, creationTime, record.getTimestamp());\n+    } else if (currentIntent == WorkflowInstanceIntent.ELEMENT_COMPLETED) {\n+      if (isWorkflowInstanceRecord(record)) {\n+        final var creationTime = workflowInstanceKeyToCreationTimeMap.remove(recordKey);\n+        executionLatencyMetrics.observeWorkflowInstanceExecutionTime(\n+            partitionId, creationTime, record.getTimestamp());\n+      } else {\n+        FNIMetrics.addflowNodeInstanceCompleted(partitionId);\n+      }\n+    } else if (currentIntent == WorkflowInstanceIntent.ELEMENT_TERMINATED) {\n+      FNIMetrics.addflowNodeInstanceTerminated(partitionId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "307589c50fc08a6e9305992881174ad3fd945f74"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM0OTU3OA==", "bodyText": "Is there a difference between two counters and add a label for the type (completed|terminated)?\nLooking at the dashboard, I think it would make sense to merge the two views together into one.", "url": "https://github.com/camunda-cloud/zeebe/pull/5713#discussion_r513349578", "createdAt": "2020-10-28T10:53:36Z", "author": {"login": "saig0"}, "path": "broker/src/main/java/io/zeebe/broker/exporter/metrics/FNIMetrics.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.broker.exporter.metrics;\n+\n+import io.prometheus.client.Counter;\n+\n+public class FNIMetrics {\n+\n+  private static final Counter FLOW_NODE_INSTANCE_COMPLETED =\n+      Counter.build()\n+          .namespace(\"zeebe\")\n+          .name(\"flow_node_instance_completed\")\n+          .help(\"Number of flow node instances, which have been completed.\")\n+          .labelNames(\"partition\")\n+          .register();\n+\n+  private static final Counter FLOW_NODE_INSTANCE_TERMINATED =\n+      Counter.build()\n+          .namespace(\"zeebe\")\n+          .name(\"flow_node_instance_terminated\")\n+          .help(\"Number of flow node instances, which have been terminated.\")\n+          .labelNames(\"partition\")\n+          .register();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "307589c50fc08a6e9305992881174ad3fd945f74"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed04e6baf964966cd409fdedde574ae2e4bf9251", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/ed04e6baf964966cd409fdedde574ae2e4bf9251", "committedDate": "2020-10-28T13:54:02Z", "message": "chore(broker): add fni metrics\n\n Add flow node instance metrics to the build-in MetricExporter\n FNI's are counted for ELEMENT_COMPLETED and ELEMENT_TERMINATED."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2764fe8b4d55134e6d4920d47f2c88e9018c59a", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/c2764fe8b4d55134e6d4920d47f2c88e9018c59a", "committedDate": "2020-10-28T13:54:06Z", "message": "chore(monitor): add FNI metrics panel's"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "307589c50fc08a6e9305992881174ad3fd945f74", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/307589c50fc08a6e9305992881174ad3fd945f74", "committedDate": "2020-10-28T08:25:50Z", "message": "chore(monitor): add FNI metrics panel's"}, "afterCommit": {"oid": "c2764fe8b4d55134e6d4920d47f2c88e9018c59a", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/c2764fe8b4d55134e6d4920d47f2c88e9018c59a", "committedDate": "2020-10-28T13:54:06Z", "message": "chore(monitor): add FNI metrics panel's"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4NjkyMzk5", "url": "https://github.com/camunda-cloud/zeebe/pull/5713#pullrequestreview-518692399", "createdAt": "2020-10-28T14:01:35Z", "commit": {"oid": "c2764fe8b4d55134e6d4920d47f2c88e9018c59a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2322, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}