{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc2ODc0MjA2", "number": 5269, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwODozMTo1OFrOEfWAhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwODo1MjozN1rOEfWs_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxMzAxODk1OnYy", "diffSide": "RIGHT", "path": "broker/src/main/java/io/zeebe/broker/system/monitoring/DiskSpaceUsageMonitor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwODozMTo1OFrOHLkAkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxMToxNjo0NFrOHLqZaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg4NjM1Mw==", "bodyText": "Why this change? Why no longer do it immediately?", "url": "https://github.com/camunda-cloud/zeebe/pull/5269#discussion_r481886353", "createdAt": "2020-09-02T08:31:58Z", "author": {"login": "pihme"}, "path": "broker/src/main/java/io/zeebe/broker/system/monitoring/DiskSpaceUsageMonitor.java", "diffHunk": "@@ -56,11 +57,18 @@ private void checkDiskUsageAndNotifyListeners() {\n   }\n \n   public void addDiskUsageListener(final DiskSpaceUsageListener listener) {\n-    diskSpaceUsageListeners.add(listener);\n+    actor.call(\n+        () -> {\n+          diskSpaceUsageListeners.add(listener);\n+          // Listeners always assumes diskspace is available on start. So notify them if it is not.\n+          if (!currentDiskAvailableStatus) {\n+            listener.onDiskSpaceNotAvailable();\n+          }\n+        });\n   }\n \n   public void removeDiskUsageListener(final DiskSpaceUsageListener listener) {\n-    diskSpaceUsageListeners.remove(listener);\n+    actor.call(() -> diskSpaceUsageListeners.remove(listener));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a859c1d7b30ef680b7cfe897212611c4e0da533f"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MTAxNw==", "bodyText": "This will be invoked by other actors. So to prevent concurrent access to diskSpaceUsageListeners we submit the task to this actor so that only this actor can modify it.", "url": "https://github.com/camunda-cloud/zeebe/pull/5269#discussion_r481991017", "createdAt": "2020-09-02T11:16:44Z", "author": {"login": "deepthidevaki"}, "path": "broker/src/main/java/io/zeebe/broker/system/monitoring/DiskSpaceUsageMonitor.java", "diffHunk": "@@ -56,11 +57,18 @@ private void checkDiskUsageAndNotifyListeners() {\n   }\n \n   public void addDiskUsageListener(final DiskSpaceUsageListener listener) {\n-    diskSpaceUsageListeners.add(listener);\n+    actor.call(\n+        () -> {\n+          diskSpaceUsageListeners.add(listener);\n+          // Listeners always assumes diskspace is available on start. So notify them if it is not.\n+          if (!currentDiskAvailableStatus) {\n+            listener.onDiskSpaceNotAvailable();\n+          }\n+        });\n   }\n \n   public void removeDiskUsageListener(final DiskSpaceUsageListener listener) {\n-    diskSpaceUsageListeners.remove(listener);\n+    actor.call(() -> diskSpaceUsageListeners.remove(listener));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg4NjM1Mw=="}, "originalCommit": {"oid": "a859c1d7b30ef680b7cfe897212611c4e0da533f"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxMzA2ODA3OnYy", "diffSide": "RIGHT", "path": "qa/integration-tests/src/test/java/io/zeebe/broker/it/clustering/ClusteringRule.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwODo0MDo1N1rOHLkgiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxMjo0MTowNFrOHLtJ9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg5NDUzNg==", "bodyText": "Please let us talk about this.\nThe SpringBrokerBridge is intended to be treated like a Singleton, and managed by Spring. So nobody should call its constructor.", "url": "https://github.com/camunda-cloud/zeebe/pull/5269#discussion_r481894536", "createdAt": "2020-09-02T08:40:57Z", "author": {"login": "pihme"}, "path": "qa/integration-tests/src/test/java/io/zeebe/broker/it/clustering/ClusteringRule.java", "diffHunk": "@@ -114,6 +114,7 @@\n   private Gateway gateway;\n   private CountDownLatch partitionLatch;\n   private final Map<Integer, Leader> partitionLeader;\n+  private final Map<Integer, SpringBrokerBridge> springBrokerBridge;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a859c1d7b30ef680b7cfe897212611c4e0da533f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAzNjIxMw==", "bodyText": "Sorry, my bad. Didn't realize that we are in the test code.", "url": "https://github.com/camunda-cloud/zeebe/pull/5269#discussion_r482036213", "createdAt": "2020-09-02T12:41:04Z", "author": {"login": "pihme"}, "path": "qa/integration-tests/src/test/java/io/zeebe/broker/it/clustering/ClusteringRule.java", "diffHunk": "@@ -114,6 +114,7 @@\n   private Gateway gateway;\n   private CountDownLatch partitionLatch;\n   private final Map<Integer, Leader> partitionLeader;\n+  private final Map<Integer, SpringBrokerBridge> springBrokerBridge;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg5NDUzNg=="}, "originalCommit": {"oid": "a859c1d7b30ef680b7cfe897212611c4e0da533f"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxMzEzMjc3OnYy", "diffSide": "RIGHT", "path": "broker/src/main/java/io/zeebe/broker/system/monitoring/DiskSpaceUsageMonitor.java", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwODo1MjozN1rOHLlKWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxMjo1OToyMlrOHLt6Fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwNTI0Mg==", "bodyText": "This comment is actually for line 30 this.minFreeDiskSpaceRequired = dataCfg.getFreeDiskSpaceCommandWatermark(); (I don't know hot to add comments for lines that have not changed)\nI am pretty (albeit not a 100%) sure that this can be wrong. During out game days one of the interventions that the cloud team was able to do was to increase the PVC of the running broker. That means in the cloud the disk can grow (or shrink) at runtime, so this should become a supplier instead of a cached vale.", "url": "https://github.com/camunda-cloud/zeebe/pull/5269#discussion_r481905242", "createdAt": "2020-09-02T08:52:37Z", "author": {"login": "pihme"}, "path": "broker/src/main/java/io/zeebe/broker/system/monitoring/DiskSpaceUsageMonitor.java", "diffHunk": "@@ -34,6 +34,7 @@ public DiskSpaceUsageMonitor(final DataCfg dataCfg) {\n \n   @Override\n   protected void onActorStarted() {\n+    checkDiskUsageAndNotifyListeners();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a859c1d7b30ef680b7cfe897212611c4e0da533f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkxNzEzMA==", "bodyText": "Addendum: alistair is 99% sure this is done at runtime", "url": "https://github.com/camunda-cloud/zeebe/pull/5269#discussion_r481917130", "createdAt": "2020-09-02T09:05:47Z", "author": {"login": "pihme"}, "path": "broker/src/main/java/io/zeebe/broker/system/monitoring/DiskSpaceUsageMonitor.java", "diffHunk": "@@ -34,6 +34,7 @@ public DiskSpaceUsageMonitor(final DataCfg dataCfg) {\n \n   @Override\n   protected void onActorStarted() {\n+    checkDiskUsageAndNotifyListeners();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwNTI0Mg=="}, "originalCommit": {"oid": "a859c1d7b30ef680b7cfe897212611c4e0da533f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MjE0OA==", "bodyText": "Oh is it? I thought we have to restart the pod for the change to be in effect.", "url": "https://github.com/camunda-cloud/zeebe/pull/5269#discussion_r481992148", "createdAt": "2020-09-02T11:18:56Z", "author": {"login": "deepthidevaki"}, "path": "broker/src/main/java/io/zeebe/broker/system/monitoring/DiskSpaceUsageMonitor.java", "diffHunk": "@@ -34,6 +34,7 @@ public DiskSpaceUsageMonitor(final DataCfg dataCfg) {\n \n   @Override\n   protected void onActorStarted() {\n+    checkDiskUsageAndNotifyListeners();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwNTI0Mg=="}, "originalCommit": {"oid": "a859c1d7b30ef680b7cfe897212611c4e0da533f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5ODI2NA==", "bodyText": "Here what the cloud guys had to say: https://camunda.slack.com/archives/CKZK2E7RP/p1599037325041500", "url": "https://github.com/camunda-cloud/zeebe/pull/5269#discussion_r481998264", "createdAt": "2020-09-02T11:30:08Z", "author": {"login": "pihme"}, "path": "broker/src/main/java/io/zeebe/broker/system/monitoring/DiskSpaceUsageMonitor.java", "diffHunk": "@@ -34,6 +34,7 @@ public DiskSpaceUsageMonitor(final DataCfg dataCfg) {\n \n   @Override\n   protected void onActorStarted() {\n+    checkDiskUsageAndNotifyListeners();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwNTI0Mg=="}, "originalCommit": {"oid": "a859c1d7b30ef680b7cfe897212611c4e0da533f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAwMjYzNQ==", "bodyText": "I will create a new issue for it because it is unrelated to this PR.", "url": "https://github.com/camunda-cloud/zeebe/pull/5269#discussion_r482002635", "createdAt": "2020-09-02T11:38:33Z", "author": {"login": "deepthidevaki"}, "path": "broker/src/main/java/io/zeebe/broker/system/monitoring/DiskSpaceUsageMonitor.java", "diffHunk": "@@ -34,6 +34,7 @@ public DiskSpaceUsageMonitor(final DataCfg dataCfg) {\n \n   @Override\n   protected void onActorStarted() {\n+    checkDiskUsageAndNotifyListeners();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwNTI0Mg=="}, "originalCommit": {"oid": "a859c1d7b30ef680b7cfe897212611c4e0da533f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA0ODUzNQ==", "bodyText": "#5280", "url": "https://github.com/camunda-cloud/zeebe/pull/5269#discussion_r482048535", "createdAt": "2020-09-02T12:59:22Z", "author": {"login": "deepthidevaki"}, "path": "broker/src/main/java/io/zeebe/broker/system/monitoring/DiskSpaceUsageMonitor.java", "diffHunk": "@@ -34,6 +34,7 @@ public DiskSpaceUsageMonitor(final DataCfg dataCfg) {\n \n   @Override\n   protected void onActorStarted() {\n+    checkDiskUsageAndNotifyListeners();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwNTI0Mg=="}, "originalCommit": {"oid": "a859c1d7b30ef680b7cfe897212611c4e0da533f"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 339, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}