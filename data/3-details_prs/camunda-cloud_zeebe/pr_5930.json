{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4NTQ5Njkz", "number": 5930, "title": "feat(broker): a job worker is optional", "bodyText": "Description\nI remove the rejection of activation jobs if a job worker is absent.\nRelated issues\n\ncloses #5819\nDefinition of Done\nNot all items need to be done depending on the issue and the pull request.\nCode changes:\n\n The changes are backwards compatibility with previous versions\n If it fixes a bug then PRs are created to backport the fix to the last two minor versions. You can trigger a backport by assigning labels (e.g. backport stable/0.25) to the PR, in case that fails you need to create backports manually.\n\nTesting:\n\n There are unit/integration tests that verify all acceptance criterias of the issue\n New tests are written to ensure backwards compatibility with further versions\n The behavior is tested manually\n The impact of the changes is verified by a benchmark\n\nDocumentation:\n\n The documentation is updated (e.g. BPMN reference, configuration, examples, get-started guides, etc.)\n New content is added to the release announcement", "createdAt": "2020-11-27T11:10:19Z", "url": "https://github.com/camunda-cloud/zeebe/pull/5930", "merged": true, "mergeCommit": {"oid": "4fee6888c0e95f41852e6434daa890f32b218028"}, "closed": true, "closedAt": "2021-01-19T08:32:00Z", "author": {"login": "aivinog1"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgn3fNgFqTUzOTk1MzA0NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdxkP_DABqjQyMjA3MzY1MDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5OTUzMDQ1", "url": "https://github.com/camunda-cloud/zeebe/pull/5930#pullrequestreview-539953045", "createdAt": "2020-11-27T12:44:07Z", "commit": {"oid": "401685fc35abc71fb262914c974960848f51599a"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxMjo0NDowN1rOH69JRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxMzo0OTozNVrOH6_FEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU4MTI1Mw==", "bodyText": "Not sure this is useful, can you explain when someone would want this log message?", "url": "https://github.com/camunda-cloud/zeebe/pull/5930#discussion_r531581253", "createdAt": "2020-11-27T12:44:07Z", "author": {"login": "npepinpe"}, "path": "engine/src/main/java/io/zeebe/engine/processing/job/JobBatchActivateProcessor.java", "diffHunk": "@@ -130,6 +133,9 @@ private void collectJobsToActivate(\n         (key, jobRecord) -> {\n           int remainingAmount = amount.get();\n           final long deadline = record.getTimestamp() + value.getTimeout();\n+          if (value.getWorkerBuffer().capacity() == 0) {\n+            LOGGER.trace(String.format(\"A job worker for a record: %s is anonymous.\", value));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "401685fc35abc71fb262914c974960848f51599a"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU4NjMwNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void shouldNotRejectEmptyWorker() {\n          \n          \n            \n              public void shouldAcceptEmptyWorker() {\n          \n      \n    \n    \n  \n\nI find its always better to test the positive, i.e. it works without a worker, as opposed to it doesn't not work without a worker \ud83d\ude09 I know it's just semantics, but I think it's a little clearer.", "url": "https://github.com/camunda-cloud/zeebe/pull/5930#discussion_r531586305", "createdAt": "2020-11-27T12:55:32Z", "author": {"login": "npepinpe"}, "path": "engine/src/test/java/io/zeebe/engine/processing/job/ActivateJobsTest.java", "diffHunk": "@@ -111,16 +111,49 @@ public void shouldRejectInvalidType() {\n   }\n \n   @Test\n-  public void shouldRejectInvalidWorker() {\n+  public void shouldNotRejectEmptyWorker() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "401685fc35abc71fb262914c974960848f51599a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTYxMjk0NA==", "bodyText": "I think it's fine to not test these things - we already have tests covering this. Rule of thumb is to have many tests, each asserting as little as possible (the ideal is one assertion per test, but obviously that's not always possible). So in this case, what is our test covering? What are the things that we really need to assert?\nI would argue only care that one job was activated, and that its worker is nothing. The rest isn't important.", "url": "https://github.com/camunda-cloud/zeebe/pull/5930#discussion_r531612944", "createdAt": "2020-11-27T13:49:35Z", "author": {"login": "npepinpe"}, "path": "engine/src/test/java/io/zeebe/engine/processing/job/ActivateJobsTest.java", "diffHunk": "@@ -111,16 +111,49 @@ public void shouldRejectInvalidType() {\n   }\n \n   @Test\n-  public void shouldRejectInvalidWorker() {\n+  public void shouldNotRejectEmptyWorker() {\n+    // given\n+    ENGINE.deployment().withXmlResource(PROCESS_ID, MODEL_SUPPLIER.apply(taskType)).deploy();\n+    final long firstInstanceKey = createWorkflowInstances(3, \"{'foo':'bar'}\").get(0);\n+\n+    final long expectedJobKey =\n+        jobRecords(JobIntent.CREATED)\n+            .withType(taskType)\n+            .filter(r -> r.getValue().getWorkflowInstanceKey() == firstInstanceKey)\n+            .getFirst()\n+            .getKey();\n+\n+    final Duration timeout = Duration.ofMinutes(12);\n+\n     // when\n     final Record<JobBatchRecordValue> batchRecord =\n-        ENGINE.jobs().withType(taskType).byWorker(\"\").expectRejection().activate();\n+        ENGINE\n+            .jobs()\n+            .withType(taskType)\n+            .withTimeout(timeout.toMillis())\n+            .withMaxJobsToActivate(1)\n+            .activate();\n+\n+    final List<JobRecordValue> jobs = batchRecord.getValue().getJobs();\n+    final List<Long> jobKeys = batchRecord.getValue().getJobKeys();\n \n     // then\n-    assertThat(batchRecord)\n-        .hasRejectionType(RejectionType.INVALID_ARGUMENT)\n-        .hasRejectionReason(\n-            \"Expected to activate job batch with worker to be present, but it was blank\");\n+    assertThat(batchRecord.getIntent()).isEqualTo(JobBatchIntent.ACTIVATED);\n+\n+    assertThat(jobKeys).hasSize(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "401685fc35abc71fb262914c974960848f51599a"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY4NDM0NjU0", "url": "https://github.com/camunda-cloud/zeebe/pull/5930#pullrequestreview-568434654", "createdAt": "2021-01-14T16:57:54Z", "commit": {"oid": "9fd0e89a65e2cd7c4b9d5b02828d079cbcb64d7c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcwNjY5MDcx", "url": "https://github.com/camunda-cloud/zeebe/pull/5930#pullrequestreview-570669071", "createdAt": "2021-01-18T17:08:34Z", "commit": {"oid": "1dc1ae547a2a3e3de93c71c90e41df5bbd785042"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5f6e84d1fc24abd060887cc4c720425f85353e7", "author": {"user": {"login": "aivinog1", "name": "Alexey Vinogradov"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/b5f6e84d1fc24abd060887cc4c720425f85353e7", "committedDate": "2021-01-19T05:12:50Z", "message": "feat(broker): a job worker is optional"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1dc1ae547a2a3e3de93c71c90e41df5bbd785042", "author": {"user": {"login": "aivinog1", "name": "Alexey Vinogradov"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/1dc1ae547a2a3e3de93c71c90e41df5bbd785042", "committedDate": "2021-01-15T13:34:15Z", "message": "feat(clients/java): remove unnecessary logging"}, "afterCommit": {"oid": "b5f6e84d1fc24abd060887cc4c720425f85353e7", "author": {"user": {"login": "aivinog1", "name": "Alexey Vinogradov"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/b5f6e84d1fc24abd060887cc4c720425f85353e7", "committedDate": "2021-01-19T05:12:50Z", "message": "feat(broker): a job worker is optional"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2281, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}