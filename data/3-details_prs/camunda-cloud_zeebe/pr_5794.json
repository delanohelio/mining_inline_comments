{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3NjkxMDYx", "number": 5794, "title": "Lower log level of broker errors in the gateway based on the error code", "bodyText": "Description\nThis PR lowers the log level of broker errors in the gateway to trace for RESOURCE_EXHAUSTED and PARTITION_LEADER_MISMATCH, both of which are reported verbatim to the client and counted in our gateway metrics, such that logs are of little use.\nRelated issues\ncloses #5638\nDefinition of Done\nNot all items need to be done depending on the issue and the pull request.\nCode changes:\n\n The changes are backwards compatibility with previous versions\n If it fixes a bug then PRs are created to backport the fix to the last two minor versions\n\nTesting:\n\n There are unit/integration tests that verify all acceptance criterias of the issue\n New tests are written to ensure backwards compatibility with further versions\n The behavior is tested manually\n The impact of the changes is verified by a benchmark\n\nDocumentation:\n\n The documentation is updated (e.g. BPMN reference, configuration, examples, get-started guides, etc.)\n New content is added to the release announcement", "createdAt": "2020-11-09T11:23:21Z", "url": "https://github.com/camunda-cloud/zeebe/pull/5794", "merged": true, "mergeCommit": {"oid": "3369b6f852fef6f07b5c33acbc33c04d4f12c291"}, "closed": true, "closedAt": "2020-11-10T09:30:49Z", "author": {"login": "npepinpe"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABda0_QEgH2gAyNTE3NjkxMDYxOmYxZjBiY2FhMTY4Nzg0Mjc0ZWZjZGUyMGM4M2ZkZTg2ZmU3ZjJmMDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbEUUKAFqTUyNjkyMzk1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f1f0bcaa168784274efcde20c83fde86fe7f2f05", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/f1f0bcaa168784274efcde20c83fde86fe7f2f05", "committedDate": "2020-11-09T13:43:25Z", "message": "chore(gateway): lower log level based on broker error code"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9c4b8a1d81648dfbae279de48571ff78a5f5e295", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/9c4b8a1d81648dfbae279de48571ff78a5f5e295", "committedDate": "2020-11-09T13:37:09Z", "message": "chore(gateway): apply sonar hints"}, "afterCommit": {"oid": "f1f0bcaa168784274efcde20c83fde86fe7f2f05", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/f1f0bcaa168784274efcde20c83fde86fe7f2f05", "committedDate": "2020-11-09T13:43:25Z", "message": "chore(gateway): lower log level based on broker error code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MjY5MTgz", "url": "https://github.com/camunda-cloud/zeebe/pull/5794#pullrequestreview-526269183", "createdAt": "2020-11-09T13:44:40Z", "commit": {"oid": "f1f0bcaa168784274efcde20c83fde86fe7f2f05"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMzo0NDo0MVrOHvvicw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMzo0NDo0MVrOHvvicw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTgyMzk4Nw==", "bodyText": "One thing: I thought about setting it to debug, since it may be useful sometimes to know if we have leader mismatch - however you can see that via metrics, and here, well, we don't have request context info so I'm not sure it gives any more insight.", "url": "https://github.com/camunda-cloud/zeebe/pull/5794#discussion_r519823987", "createdAt": "2020-11-09T13:44:41Z", "author": {"login": "npepinpe"}, "path": "gateway/src/main/java/io/zeebe/gateway/grpc/GrpcErrorMapper.java", "diffHunk": "@@ -113,22 +105,20 @@ private Status mapBrokerErrorToStatus(final BrokerError error) {\n         break;\n       case RESOURCE_EXHAUSTED:\n         builder.setCode(Code.RESOURCE_EXHAUSTED_VALUE);\n+        logger.trace(\"Target broker is currently overloaded: {}\", error);\n         break;\n       case PARTITION_LEADER_MISMATCH:\n         // return UNAVAILABLE to indicate to the user that retrying might solve the issue, as this\n         // is usually a transient issue\n+        logger.trace(\"Target broker was not the leader of the partition: {}\", error);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1f0bcaa168784274efcde20c83fde86fe7f2f05"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MjY5OTY1", "url": "https://github.com/camunda-cloud/zeebe/pull/5794#pullrequestreview-526269965", "createdAt": "2020-11-09T13:45:30Z", "commit": {"oid": "f1f0bcaa168784274efcde20c83fde86fe7f2f05"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMzo0NTozMFrOHvvkrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMzo0NTozMFrOHvvkrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTgyNDU1OA==", "bodyText": "Normally I'd prefer having all cases, but in this case the non default cases are more the exceptions where we want different behaviour, so I think it makes sense to remove all explicit cases.", "url": "https://github.com/camunda-cloud/zeebe/pull/5794#discussion_r519824558", "createdAt": "2020-11-09T13:45:30Z", "author": {"login": "npepinpe"}, "path": "gateway/src/main/java/io/zeebe/gateway/grpc/GrpcErrorMapper.java", "diffHunk": "@@ -113,22 +105,20 @@ private Status mapBrokerErrorToStatus(final BrokerError error) {\n         break;\n       case RESOURCE_EXHAUSTED:\n         builder.setCode(Code.RESOURCE_EXHAUSTED_VALUE);\n+        logger.trace(\"Target broker is currently overloaded: {}\", error);\n         break;\n       case PARTITION_LEADER_MISMATCH:\n         // return UNAVAILABLE to indicate to the user that retrying might solve the issue, as this\n         // is usually a transient issue\n+        logger.trace(\"Target broker was not the leader of the partition: {}\", error);\n         builder.setCode(Code.UNAVAILABLE_VALUE);\n         break;\n-        // all the following are not errors which retrying (with the same gateway) will solve\n-      case INVALID_MESSAGE_TEMPLATE:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1f0bcaa168784274efcde20c83fde86fe7f2f05"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2OTIzOTU1", "url": "https://github.com/camunda-cloud/zeebe/pull/5794#pullrequestreview-526923955", "createdAt": "2020-11-10T07:35:00Z", "commit": {"oid": "f1f0bcaa168784274efcde20c83fde86fe7f2f05"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2370, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}