{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5NTMwMTcw", "number": 4549, "title": "chore(engine): migrate multi-instance processor", "bodyText": "Description\n\nreplace multi-instance BPMN step handler\nremove unused BPMN step handlers\nadjust termination of child instances to\n\nprevent a memory leak when a child instance is completed (in this case the event is not processed and the child instance is not removed from the state)\nnot terminated the element instance when a child instance is in already terminating or terminated\n\n\n\nRelated issues\ncloses #4469\nPull Request Checklist\n\n All commit messages match our commit message guidelines\n The submitting code follows our code style\n If submitting code, please run mvn clean install -DskipTests locally before committing", "createdAt": "2020-05-18T14:13:36Z", "url": "https://github.com/camunda-cloud/zeebe/pull/4549", "merged": true, "mergeCommit": {"oid": "35aba9d510747707e2aad51b69771d5ca9c7e4db"}, "closed": true, "closedAt": "2020-05-20T04:38:18Z", "author": {"login": "saig0"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABciwOyRAFqTQxMzc0OTUzMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjBMqXABqjMzNTQ2Mjg3MTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzNzQ5NTMw", "url": "https://github.com/camunda-cloud/zeebe/pull/4549#pullrequestreview-413749530", "createdAt": "2020-05-18T16:21:27Z", "commit": {"oid": "13a78a6fda2ba73c886c1d3f3087c48f18f0072e"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNjoyMToyOFrOGW-j-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwODoyODozNVrOGXVcww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc0Njg3NA==", "bodyText": "We don't seem to wait here, just consuming the pending 'child zombie' tokens. I think this comment should be changed. Also, Shouldn't the current element instance still transition to terminated at the end of this else block?", "url": "https://github.com/camunda-cloud/zeebe/pull/4549#discussion_r426746874", "createdAt": "2020-05-18T16:21:28Z", "author": {"login": "korthout"}, "path": "engine/src/main/java/io/zeebe/engine/nwe/behavior/BpmnStateTransitionBehavior.java", "diffHunk": "@@ -154,6 +154,42 @@ public ElementInstance activateChildInstance(\n     return stateBehavior.createChildElementInstance(context, childInstanceKey, childInstanceRecord);\n   }\n \n+  public void terminateChildInstances(final BpmnElementContext context) {\n+\n+    final var childInstances = stateBehavior.getChildInstances(context);\n+\n+    for (final BpmnElementContext childInstanceContext : childInstances) {\n+\n+      if (WorkflowInstanceLifecycle.canTransition(\n+          childInstanceContext.getIntent(), WorkflowInstanceIntent.ELEMENT_TERMINATING)) {\n+        transitionToTerminating(childInstanceContext);\n+\n+      } else if (childInstanceContext.getIntent() == WorkflowInstanceIntent.ELEMENT_COMPLETED) {\n+        // clean up the state because the completed event will not be processed\n+        stateBehavior.removeInstance(childInstanceContext);\n+      }\n+    }\n+\n+    final var elementInstance = stateBehavior.getElementInstance(context);\n+    final var activeChildInstances = elementInstance.getNumberOfActiveElementInstances();\n+\n+    if (activeChildInstances == 0) {\n+      // terminate element instance if all child instances are terminated\n+      transitionToTerminated(context);\n+\n+    } else {\n+      // wait for child instances to be terminated", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13a78a6fda2ba73c886c1d3f3087c48f18f0072e"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzEyMTg1OQ==", "bodyText": "Perhaps this is also the time to refactor to Either<Failure,OutputCollection> or something similar.", "url": "https://github.com/camunda-cloud/zeebe/pull/4549#discussion_r427121859", "createdAt": "2020-05-19T08:28:35Z", "author": {"login": "korthout"}, "path": "engine/src/main/java/io/zeebe/engine/nwe/container/MultiInstanceBodyProcessor.java", "diffHunk": "@@ -140,15 +140,86 @@ public void onCompleted(\n \n   @Override\n   public void onTerminating(\n-      final ExecutableMultiInstanceBody element, final BpmnElementContext context) {}\n+      final ExecutableMultiInstanceBody element, final BpmnElementContext context) {\n+\n+    eventSubscriptionBehavior.unsubscribeFromEvents(context);\n+\n+    stateTransitionBehavior.terminateChildInstances(context);\n+  }\n \n   @Override\n   public void onTerminated(\n-      final ExecutableMultiInstanceBody element, final BpmnElementContext context) {}\n+      final ExecutableMultiInstanceBody element, final BpmnElementContext context) {\n+\n+    eventSubscriptionBehavior.publishTriggeredBoundaryEvent(context);\n+\n+    incidentBehavior.resolveIncidents(context);\n+\n+    stateTransitionBehavior.onElementTerminated(element, context);\n+\n+    stateBehavior.consumeToken(context);\n+  }\n \n   @Override\n   public void onEventOccurred(\n-      final ExecutableMultiInstanceBody element, final BpmnElementContext context) {}\n+      final ExecutableMultiInstanceBody element, final BpmnElementContext context) {\n+\n+    eventSubscriptionBehavior.triggerBoundaryEvent(element, context);\n+  }\n+\n+  @Override\n+  public void onChildCompleted(\n+      final ExecutableMultiInstanceBody element,\n+      final BpmnElementContext flowScopeContext,\n+      final BpmnElementContext childContext) {\n+    final var loopCharacteristics = element.getLoopCharacteristics();\n+\n+    if (loopCharacteristics.isSequential()) {\n+\n+      final var inputCollectionVariable = readInputCollectionVariable(element, childContext);\n+      if (inputCollectionVariable.isEmpty()) {\n+        return;\n+      }\n+\n+      final var array = inputCollectionVariable.get();\n+      final var loopCounter =\n+          stateBehavior.getFlowScopeInstance(childContext).getMultiInstanceLoopCounter();\n+      if (loopCounter < array.size()) {\n+\n+        final var item = array.get(loopCounter);\n+        createInnerInstance(element, flowScopeContext, item);\n+      }\n+    }\n+\n+    final Optional<Boolean> updatedSuccessfully =\n+        loopCharacteristics\n+            .getOutputCollection()\n+            .map(variableName -> updateOutputCollection(element, childContext, variableName));\n+\n+    if (updatedSuccessfully.isPresent() && !updatedSuccessfully.get()) {\n+      // An incident was raised while updating the output collection, stop handling activity", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13a78a6fda2ba73c886c1d3f3087c48f18f0072e"}, "originalPosition": 64}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0NTI2MTQy", "url": "https://github.com/camunda-cloud/zeebe/pull/4549#pullrequestreview-414526142", "createdAt": "2020-05-19T14:49:11Z", "commit": {"oid": "a5597eed4a2818eea81406e0d2f44621c08411b2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95bed3d0eea134c03cf94ef1bd06ce700a047b69", "author": {"user": {"login": "saig0", "name": "Philipp Ossler"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/95bed3d0eea134c03cf94ef1bd06ce700a047b69", "committedDate": "2020-05-20T04:16:58Z", "message": "chore(engine): migrate multi-instance processor\n\n* replace multi-instance BPMN step handler\n* remove unused BPMN step handlers\n* adjust termination of child instances to prevent a memory leak (when a child is completed) and don't terminated when a child is terminating or terminated"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a5597eed4a2818eea81406e0d2f44621c08411b2", "author": {"user": {"login": "saig0", "name": "Philipp Ossler"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/a5597eed4a2818eea81406e0d2f44621c08411b2", "committedDate": "2020-05-19T13:03:56Z", "message": "chore(engine): apply code suggestion"}, "afterCommit": {"oid": "95bed3d0eea134c03cf94ef1bd06ce700a047b69", "author": {"user": {"login": "saig0", "name": "Philipp Ossler"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/95bed3d0eea134c03cf94ef1bd06ce700a047b69", "committedDate": "2020-05-20T04:16:58Z", "message": "chore(engine): migrate multi-instance processor\n\n* replace multi-instance BPMN step handler\n* remove unused BPMN step handlers\n* adjust termination of child instances to prevent a memory leak (when a child is completed) and don't terminated when a child is terminating or terminated"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2824, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}