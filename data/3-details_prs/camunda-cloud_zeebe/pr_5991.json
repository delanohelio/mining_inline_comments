{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1MjIyMjMw", "number": 5991, "title": "Don't write Job activated record", "bodyText": "Description\n\nThe job activated record is no longer written to the log. It is already present in JobBatchRecord.\nJob record is also not copied multiple times just wrapped without variables for state updates.\nFixed MetricExporter, since it relied on the Job.ACTIVATED event.\nFix several engine tests\n\n\nI run a benchmark and saw no problems, only with the Job activation metrics, which I have fixed afterwards.\nBase\nGeneral\n\n\nResources\n\nLatency\n\n\nNo activated job event\nGeneral\n\n\nResources\n\nLatency\n\n\nI set up a new benchmark with the metrics fix.\nRelated issues\n\ncloses #2182\nDefinition of Done\nNot all items need to be done depending on the issue and the pull request.\nCode changes:\n\n The changes are backwards compatibility with previous versions\n If it fixes a bug then PRs are created to backport the fix to the last two minor versions. You can trigger a backport by assigning labels (e.g. backport stable/0.25) to the PR, in case that fails you need to create backports manually.\n\nTesting:\n\n There are unit/integration tests that verify all acceptance criterias of the issue\n New tests are written to ensure backwards compatibility with further versions\n The behavior is tested manually\n The impact of the changes is verified by a benchmark\n\nDocumentation:\n\n The documentation is updated (e.g. BPMN reference, configuration, examples, get-started guides, etc.)\n New content is added to the release announcement", "createdAt": "2020-12-09T14:31:51Z", "url": "https://github.com/camunda-cloud/zeebe/pull/5991", "merged": true, "mergeCommit": {"oid": "d96032bf1f0ecbc119c121798e17f803e77cecba"}, "closed": true, "closedAt": "2020-12-10T07:33:42Z", "author": {"login": "Zelldon"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkZFfcAH2gAyNTM1MjIyMjMwOjc4MWY1MDZjMjU1Nzk2NDI1YzVhZDNlZmM3YTU1NzM2ZWMyOTdlMzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkt8ZCABqjQwOTM1MjE5NTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "781f506c255796425c5ad3efc7a55736ec297e31", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/781f506c255796425c5ad3efc7a55736ec297e31", "committedDate": "2020-12-09T06:52:08Z", "message": "chore(engine): do not write job activate record\n\n * job activated record is no longer written to the log. It is already\n   present in JobBatchRecord\n * Job record is also not copied multiple times just wrapped without\n   variables for state updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c333581ff5673505b0cfb51ce308809f202a896", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/6c333581ff5673505b0cfb51ce308809f202a896", "committedDate": "2020-12-09T20:09:49Z", "message": "chore(broker): fix metrics for job activation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bb830cf512a255caddf07cb3cd11620ab9d6e592", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/bb830cf512a255caddf07cb3cd11620ab9d6e592", "committedDate": "2020-12-09T14:26:51Z", "message": "chore(engine): fix engine tests\n\n Based on not writting job activated record tests are adjusted"}, "afterCommit": {"oid": "87cd9d1572882dcce08d13100ad216d7d6593770", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/87cd9d1572882dcce08d13100ad216d7d6593770", "committedDate": "2020-12-09T20:09:49Z", "message": "chore(engine): fix engine tests\n\n Based on not writting job activated record tests are adjusted"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4ODE3Nzk1", "url": "https://github.com/camunda-cloud/zeebe/pull/5991#pullrequestreview-548817795", "createdAt": "2020-12-10T04:54:10Z", "commit": {"oid": "87cd9d1572882dcce08d13100ad216d7d6593770"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwNDo1NDoxMFrOIC1fPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwNDo1NDoxMFrOIC1fPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg0NDQxMw==", "bodyText": "Verify the job types more strictly.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                final var types =\n          \n          \n            \n                    activatedJobBatch.getJobs().stream().map(JobRecordValue::getType).distinct().count();\n          \n          \n            \n                assertThat(types).isEqualTo(1);\n          \n          \n            \n                assertThat(activatedJobBatch.getJobs()).extracting(JobRecordValue::getType).containsOnly(taskType);", "url": "https://github.com/camunda-cloud/zeebe/pull/5991#discussion_r539844413", "createdAt": "2020-12-10T04:54:10Z", "author": {"login": "saig0"}, "path": "engine/src/test/java/io/zeebe/engine/processing/job/ActivateJobsTest.java", "diffHunk": "@@ -239,16 +238,14 @@ public void shouldOnlyReturnJobsOfCorrectType() {\n     final List<Long> jobs = activateJobs(taskType, 7);\n \n     // then\n-    assertThat(jobs).containsOnlyElementsOf(jobKeys);\n+    assertThat(jobs).containsExactly(jobKeys.toArray(new Long[0]));\n \n-    final List<Record<JobRecordValue>> records =\n-        jobRecords(JobIntent.ACTIVATED)\n-            .withType(taskType)\n-            .limit(jobKeys.size())\n-            .collect(Collectors.toList());\n+    final var activatedJobBatch = getActivatedJobBatch();\n+    assertThat(activatedJobBatch).hasJobKeys(jobKeys);\n \n-    assertThat(records).extracting(Record::getKey).containsOnlyElementsOf(jobKeys);\n-    assertThat(records).extracting(\"value.type\").containsOnly(taskType);\n+    final var types =\n+        activatedJobBatch.getJobs().stream().map(JobRecordValue::getType).distinct().count();\n+    assertThat(types).isEqualTo(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87cd9d1572882dcce08d13100ad216d7d6593770"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e389e7773369bb68d6fa5f74044da1358a975dd9", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/e389e7773369bb68d6fa5f74044da1358a975dd9", "committedDate": "2020-12-10T07:10:02Z", "message": "chore(engine): fix engine tests\n\n Based on not writting job activated record tests are adjusted"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "48c97f527805c2dac817f5e34e892ad60b54126d", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/48c97f527805c2dac817f5e34e892ad60b54126d", "committedDate": "2020-12-10T07:05:14Z", "message": "chore(engine): Update engine/src/test/java/io/zeebe/engine/processing/job/ActivateJobsTest.java\n\nCo-authored-by: Philipp Ossler <philipp.ossler@gmail.com>"}, "afterCommit": {"oid": "e389e7773369bb68d6fa5f74044da1358a975dd9", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/e389e7773369bb68d6fa5f74044da1358a975dd9", "committedDate": "2020-12-10T07:10:02Z", "message": "chore(engine): fix engine tests\n\n Based on not writting job activated record tests are adjusted"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2310, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}