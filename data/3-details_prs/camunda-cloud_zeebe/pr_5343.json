{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg2MDA3MDcz", "number": 5343, "title": "feat(clients/go, clients/java): Add message key to the response of publish message", "bodyText": "Description\n\nAdd the key to the response of the publish message method in the protobuf file.\nAdd the key to the response in the gateway\nAdd a new class of response in java client\nSome little tests.\n\nRelated issues\ncloses #4794\nDefinition of Done\nNot all items need to be done depending on the issue and the pull request.\nCode changes:\n\n The changes are backwards compatibility with previous versions\n If it fixes a bug then PRs are created to backport the fix to the last two minor versions\n\nTesting:\n\n There are unit/integration tests that verify all acceptance criterias of the issue\n New tests are written to ensure backwards compatibility with further versions\n The behavior is tested manually\n The impact of the changes is verified by a benchmark\n\nDocumentation:\n\n The documentation is updated (e.g. BPMN reference, configuration, examples, get-started guides, etc.)\n New content is added to the release announcement", "createdAt": "2020-09-12T19:52:59Z", "url": "https://github.com/camunda-cloud/zeebe/pull/5343", "merged": true, "mergeCommit": {"oid": "ea36b4fab5c4883d385e32dd9ead6e01dcfdbf26"}, "closed": true, "closedAt": "2020-09-30T04:07:38Z", "author": {"login": "aivinog1"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJrKLFgFqTQ5MDI0NjI4Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdN0YxHAFqTQ5OTA2MzQyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwMjQ2Mjg2", "url": "https://github.com/camunda-cloud/zeebe/pull/5343#pullrequestreview-490246286", "createdAt": "2020-09-17T05:09:04Z", "commit": {"oid": "c30f7eb1cb58d075d04d4966bf8ae1aa15fc500b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwNTowOTowNFrOHTRn7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwNToyMzo1NlrOHTR4EA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTk3Mzc0MQ==", "bodyText": "This is the third exception for the same type. We can replace them with one exception for the package to allow new methods in the interfaces:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              <difference>\n          \n          \n            \n                <className>io/zeebe/client/api/response/PublishMessageResponse</className>\n          \n          \n            \n                <method>long messageKey()</method>\n          \n          \n            \n                <differenceType>7012</differenceType>\n          \n          \n            \n              </difference>\n          \n          \n            \n             <difference>\n          \n          \n            \n               <className>io/zeebe/client/api/*</className>\n          \n          \n            \n               <method>*</method>\n          \n          \n            \n               <differenceType>7012</differenceType>\n          \n          \n            \n             </difference>", "url": "https://github.com/camunda-cloud/zeebe/pull/5343#discussion_r489973741", "createdAt": "2020-09-17T05:09:04Z", "author": {"login": "saig0"}, "path": "clients/java/ignored-changes.xml", "diffHunk": "@@ -28,4 +28,9 @@\n     <method>ZeebeClientCredentials(java.lang.String, long, java.lang.String, java.lang.String)</method>\n     <differenceType>7004</differenceType>\n   </difference>\n+  <difference>\n+    <className>io/zeebe/client/api/response/PublishMessageResponse</className>\n+    <method>long messageKey()</method>\n+    <differenceType>7012</differenceType>\n+  </difference>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c30f7eb1cb58d075d04d4966bf8ae1aa15fc500b"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTk3NDY5Ng==", "bodyText": "Please add some JavaDoc.\nFor example, Returns the record key of the message that was published.", "url": "https://github.com/camunda-cloud/zeebe/pull/5343#discussion_r489974696", "createdAt": "2020-09-17T05:12:30Z", "author": {"login": "saig0"}, "path": "clients/java/src/main/java/io/zeebe/client/api/response/PublishMessageResponse.java", "diffHunk": "@@ -15,4 +15,7 @@\n  */\n package io.zeebe.client.api.response;\n \n-public interface PublishMessageResponse {}\n+public interface PublishMessageResponse {\n+\n+  long messageKey();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c30f7eb1cb58d075d04d4966bf8ae1aa15fc500b"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTk3NjA2NQ==", "bodyText": "Let's make the class final.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class PublishMessageResponseImpl implements PublishMessageResponse {\n          \n          \n            \n            public final class PublishMessageResponseImpl implements PublishMessageResponse {", "url": "https://github.com/camunda-cloud/zeebe/pull/5343#discussion_r489976065", "createdAt": "2020-09-17T05:17:30Z", "author": {"login": "saig0"}, "path": "clients/java/src/main/java/io/zeebe/client/impl/response/PublishMessageResponseImpl.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * Copyright \u00a9 2017 camunda services GmbH (info@camunda.com)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.zeebe.client.impl.response;\n+\n+import io.zeebe.client.api.response.PublishMessageResponse;\n+import io.zeebe.gateway.protocol.GatewayOuterClass;\n+\n+public class PublishMessageResponseImpl implements PublishMessageResponse {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c30f7eb1cb58d075d04d4966bf8ae1aa15fc500b"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTk3Nzg3Mg==", "bodyText": "The new field must be optional to be backward compatible with older versions. Otherwise, the response of an older broker version would fail because it doesn't contain this new field.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              int64 key = 1;\n          \n          \n            \n              // the unique ID of the message that was published\n          \n          \n            \n              optional int64 key = 1 [default = -1];", "url": "https://github.com/camunda-cloud/zeebe/pull/5343#discussion_r489977872", "createdAt": "2020-09-17T05:23:56Z", "author": {"login": "saig0"}, "path": "gateway-protocol/src/main/proto/gateway.proto", "diffHunk": "@@ -226,6 +226,7 @@ message PublishMessageRequest {\n }\n \n message PublishMessageResponse {\n+  int64 key = 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c30f7eb1cb58d075d04d4966bf8ae1aa15fc500b"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c30f7eb1cb58d075d04d4966bf8ae1aa15fc500b", "author": {"user": {"login": "aivinog1", "name": "Alexey Vinogradov"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/c30f7eb1cb58d075d04d4966bf8ae1aa15fc500b", "committedDate": "2020-09-12T19:48:26Z", "message": "feat(clients/go, clients/java): Add message key to the response of publish message"}, "afterCommit": {"oid": "5ca8908ed1f126ef93a29db1eb62e09e10110573", "author": {"user": {"login": "aivinog1", "name": "Alexey Vinogradov"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/5ca8908ed1f126ef93a29db1eb62e09e10110573", "committedDate": "2020-09-18T06:40:21Z", "message": "feat(clients/go, clients/java): Add message key to the response of publish message"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5ca8908ed1f126ef93a29db1eb62e09e10110573", "author": {"user": {"login": "aivinog1", "name": "Alexey Vinogradov"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/5ca8908ed1f126ef93a29db1eb62e09e10110573", "committedDate": "2020-09-18T06:40:21Z", "message": "feat(clients/go, clients/java): Add message key to the response of publish message"}, "afterCommit": {"oid": "4486b2955c3285d6032b51665f66b3248ee60f9b", "author": {"user": {"login": "aivinog1", "name": "Alexey Vinogradov"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/4486b2955c3285d6032b51665f66b3248ee60f9b", "committedDate": "2020-09-18T07:21:00Z", "message": "feat(clients/go, clients/java): Add message key to the response of publish message"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4486b2955c3285d6032b51665f66b3248ee60f9b", "author": {"user": {"login": "aivinog1", "name": "Alexey Vinogradov"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/4486b2955c3285d6032b51665f66b3248ee60f9b", "committedDate": "2020-09-18T07:21:00Z", "message": "feat(clients/go, clients/java): Add message key to the response of publish message"}, "afterCommit": {"oid": "15356a755b1f99988a837a9897d4980877596964", "author": {"user": {"login": "aivinog1", "name": "Alexey Vinogradov"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/15356a755b1f99988a837a9897d4980877596964", "committedDate": "2020-09-28T04:57:18Z", "message": "feat(clients/go, clients/java): Add message key to the response of publish message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NDMxNzk0", "url": "https://github.com/camunda-cloud/zeebe/pull/5343#pullrequestreview-497431794", "createdAt": "2020-09-28T11:46:10Z", "commit": {"oid": "15356a755b1f99988a837a9897d4980877596964"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxMTo0NjoxMFrOHY6AYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxMTo0NjoxMFrOHY6AYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg3ODI0MA==", "bodyText": "Align the method name with the other responses.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              long messageKey();\n          \n          \n            \n              long getMessageKey();", "url": "https://github.com/camunda-cloud/zeebe/pull/5343#discussion_r495878240", "createdAt": "2020-09-28T11:46:10Z", "author": {"login": "saig0"}, "path": "clients/java/src/main/java/io/zeebe/client/api/response/PublishMessageResponse.java", "diffHunk": "@@ -15,4 +15,12 @@\n  */\n package io.zeebe.client.api.response;\n \n-public interface PublishMessageResponse {}\n+public interface PublishMessageResponse {\n+\n+  /**\n+   * Returns the record key of the message that was published.\n+   *\n+   * @return record key of the message.\n+   */\n+  long messageKey();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15356a755b1f99988a837a9897d4980877596964"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "15356a755b1f99988a837a9897d4980877596964", "author": {"user": {"login": "aivinog1", "name": "Alexey Vinogradov"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/15356a755b1f99988a837a9897d4980877596964", "committedDate": "2020-09-28T04:57:18Z", "message": "feat(clients/go, clients/java): Add message key to the response of publish message"}, "afterCommit": {"oid": "5af68ae406a023710049b900991785c31be5ccdf", "author": {"user": {"login": "aivinog1", "name": "Alexey Vinogradov"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/5af68ae406a023710049b900991785c31be5ccdf", "committedDate": "2020-09-29T06:44:35Z", "message": "feat(clients/go, clients/java): Add message key to the response of publish message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4Mzc4NzAw", "url": "https://github.com/camunda-cloud/zeebe/pull/5343#pullrequestreview-498378700", "createdAt": "2020-09-29T11:40:48Z", "commit": {"oid": "5af68ae406a023710049b900991785c31be5ccdf"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxMTo0MDo0OFrOHZpByg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxMjo0MTozMlrOHZrLQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY0ODY1MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void shouldReturnNonZeroMessageKey() {\n          \n          \n            \n              public void shouldReturnTheMessageKey() {", "url": "https://github.com/camunda-cloud/zeebe/pull/5343#discussion_r496648650", "createdAt": "2020-09-29T11:40:48Z", "author": {"login": "saig0"}, "path": "qa/integration-tests/src/test/java/io/zeebe/broker/it/client/command/MessageCorrelationTest.java", "diffHunk": "@@ -174,4 +174,20 @@ public void shouldRejectMessageWithSameId() {\n         .hasMessageContaining(\n             \"Expected to publish a new message with id 'foo', but a message with that id was already published\");\n   }\n+\n+  @Test\n+  public void shouldReturnNonZeroMessageKey() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5af68ae406a023710049b900991785c31be5ccdf"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY1NTA3Mg==", "bodyText": "We can compare the response key with the record key on the log stream.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                assertThat(response.getMessageKey()).isNotZero();\n          \n          \n            \n                final var messagePublished =\n          \n          \n            \n                    RecordingExporter.messageRecords(MessageIntent.PUBLISHED).getFirst();\n          \n          \n            \n            \n          \n          \n            \n                assertThat(response.getMessageKey()).isEqualTo(messagePublished.getKey());", "url": "https://github.com/camunda-cloud/zeebe/pull/5343#discussion_r496655072", "createdAt": "2020-09-29T11:52:57Z", "author": {"login": "saig0"}, "path": "qa/integration-tests/src/test/java/io/zeebe/broker/it/client/command/MessageCorrelationTest.java", "diffHunk": "@@ -174,4 +174,20 @@ public void shouldRejectMessageWithSameId() {\n         .hasMessageContaining(\n             \"Expected to publish a new message with id 'foo', but a message with that id was already published\");\n   }\n+\n+  @Test\n+  public void shouldReturnNonZeroMessageKey() {\n+    // when\n+    final PublishMessageResponse response =\n+        CLIENT_RULE\n+            .getClient()\n+            .newPublishMessageCommand()\n+            .messageName(MESSAGE_NAME)\n+            .correlationKey(correlationValue)\n+            .send()\n+            .join();\n+\n+    // then\n+    assertThat(response.getMessageKey()).isNotZero();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5af68ae406a023710049b900991785c31be5ccdf"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY4Mzg0Mg==", "bodyText": "Let's check that we return the correct key.\nFirst, we need to instrument the gateway:\n    // given\n    final long messageKey = 123L;\n    gatewayService.onPublishMessageRequest(messageKey);\n\nWhen we can check the response:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                assertThat(response.getMessageKey()).isZero();\n          \n          \n            \n                assertThat(response.getMessageKey()).isEqualTo(messageKey);\n          \n      \n    \n    \n  \n\nIn io.zeebe.client.util.RecordingGatewayService, we need to add the new method to control the response:\n  public void onPublishMessageRequest(final long key) {\n    addRequestHandler(\n        PublishMessageRequest.class,\n        request -> PublishMessageResponse.newBuilder().setKey(key).build());\n  }", "url": "https://github.com/camunda-cloud/zeebe/pull/5343#discussion_r496683842", "createdAt": "2020-09-29T12:41:32Z", "author": {"login": "saig0"}, "path": "clients/java/src/test/java/io/zeebe/client/workflow/PublishMessageTest.java", "diffHunk": "@@ -34,21 +35,23 @@\n   @Test\n   public void shouldPublishMessage() {\n     // when\n-    client\n-        .newPublishMessageCommand()\n-        .messageName(\"name\")\n-        .correlationKey(\"key\")\n-        .timeToLive(Duration.ofDays(1))\n-        .messageId(\"theId\")\n-        .send()\n-        .join();\n+    final PublishMessageResponse response =\n+        client\n+            .newPublishMessageCommand()\n+            .messageName(\"name\")\n+            .correlationKey(\"key\")\n+            .timeToLive(Duration.ofDays(1))\n+            .messageId(\"theId\")\n+            .send()\n+            .join();\n \n     // then\n     final PublishMessageRequest request = gatewayService.getLastRequest();\n     assertThat(request.getName()).isEqualTo(\"name\");\n     assertThat(request.getCorrelationKey()).isEqualTo(\"key\");\n     assertThat(request.getMessageId()).isEqualTo(\"theId\");\n     assertThat(request.getTimeToLive()).isEqualTo(Duration.ofDays(1).toMillis());\n+    assertThat(response.getMessageKey()).isZero();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5af68ae406a023710049b900991785c31be5ccdf"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b707c42bd0de7e9fc79b6f099eed3ebaad33066f", "author": {"user": {"login": "aivinog1", "name": "Alexey Vinogradov"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/b707c42bd0de7e9fc79b6f099eed3ebaad33066f", "committedDate": "2020-09-29T13:24:25Z", "message": "feat(clients/go, clients/java): Add message key to the response of publish message"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5af68ae406a023710049b900991785c31be5ccdf", "author": {"user": {"login": "aivinog1", "name": "Alexey Vinogradov"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/5af68ae406a023710049b900991785c31be5ccdf", "committedDate": "2020-09-29T06:44:35Z", "message": "feat(clients/go, clients/java): Add message key to the response of publish message"}, "afterCommit": {"oid": "b707c42bd0de7e9fc79b6f099eed3ebaad33066f", "author": {"user": {"login": "aivinog1", "name": "Alexey Vinogradov"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/b707c42bd0de7e9fc79b6f099eed3ebaad33066f", "committedDate": "2020-09-29T13:24:25Z", "message": "feat(clients/go, clients/java): Add message key to the response of publish message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5MDYzNDIx", "url": "https://github.com/camunda-cloud/zeebe/pull/5343#pullrequestreview-499063421", "createdAt": "2020-09-30T03:40:22Z", "commit": {"oid": "b707c42bd0de7e9fc79b6f099eed3ebaad33066f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2497, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}