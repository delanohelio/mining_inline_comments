{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzNTI4MDk4", "number": 4125, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNjoxNToxMlrODrSe_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNDo1MDoxOFrODrrm1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2NzE4MjA2OnYy", "diffSide": "RIGHT", "path": "clients/java/src/main/java/io/zeebe/client/impl/ZeebeClientCredentials.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNjoxNToxMlrOF7i_EA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwODowMjowNlrOF-1HuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk4MzUwNA==", "bodyText": "Is it in the spec that expiresIn is passed a seconds? Where is expires in coming from?", "url": "https://github.com/camunda-cloud/zeebe/pull/4125#discussion_r397983504", "createdAt": "2020-03-25T16:15:12Z", "author": {"login": "npepinpe"}, "path": "clients/java/src/main/java/io/zeebe/client/impl/ZeebeClientCredentials.java", "diffHunk": "@@ -50,9 +51,29 @@ public String getTokenType() {\n     return tokenType;\n   }\n \n+  @JsonSetter(\"expiry\")\n+  public void setExpiry(final String expiry) {\n+    this.expiry = ZonedDateTime.parse(expiry);\n+  }\n+\n+  @JsonSetter(\"expires_in\")\n+  public void setExpiresIn(final String expiresIn) {\n+    this.expiry = ZonedDateTime.now().plusSeconds(Long.parseLong(expiresIn));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1729e373b5daee58b5bcea7cef9cc7c790c6ebfc"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQyNjM2MQ==", "bodyText": "Yes, https://tools.ietf.org/html/rfc6749#section-5.1 . I'm not sure if this is what you mean by \"where is it coming from\" but it comes from the auth response, like the access token and the bearer type.", "url": "https://github.com/camunda-cloud/zeebe/pull/4125#discussion_r401426361", "createdAt": "2020-04-01T08:02:06Z", "author": {"login": "MiguelPires"}, "path": "clients/java/src/main/java/io/zeebe/client/impl/ZeebeClientCredentials.java", "diffHunk": "@@ -50,9 +51,29 @@ public String getTokenType() {\n     return tokenType;\n   }\n \n+  @JsonSetter(\"expiry\")\n+  public void setExpiry(final String expiry) {\n+    this.expiry = ZonedDateTime.parse(expiry);\n+  }\n+\n+  @JsonSetter(\"expires_in\")\n+  public void setExpiresIn(final String expiresIn) {\n+    this.expiry = ZonedDateTime.now().plusSeconds(Long.parseLong(expiresIn));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk4MzUwNA=="}, "originalCommit": {"oid": "1729e373b5daee58b5bcea7cef9cc7c790c6ebfc"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2NzE5MzY0OnYy", "diffSide": "RIGHT", "path": "clients/java/src/main/java/io/zeebe/client/impl/oauth/OAuthCredentialsProvider.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNjoxNzo0NVrOF7jGcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwODowNToyOFrOF-1PSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk4NTM5NQ==", "bodyText": "Can type be null?", "url": "https://github.com/camunda-cloud/zeebe/pull/4125#discussion_r397985395", "createdAt": "2020-03-25T16:17:45Z", "author": {"login": "npepinpe"}, "path": "clients/java/src/main/java/io/zeebe/client/impl/oauth/OAuthCredentialsProvider.java", "diffHunk": "@@ -72,9 +71,12 @@ public void applyCredentials(final Metadata headers) throws IOException {\n       loadCredentials();\n     }\n \n-    headers.put(\n-        HEADER_AUTH_KEY,\n-        String.format(\"%s %s\", credentials.getTokenType(), credentials.getAccessToken()));\n+    String type = credentials.getTokenType();\n+    if (!type.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1729e373b5daee58b5bcea7cef9cc7c790c6ebfc"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQyODI5Nw==", "bodyText": "Not unless something went wrong but I add a check nonetheless", "url": "https://github.com/camunda-cloud/zeebe/pull/4125#discussion_r401428297", "createdAt": "2020-04-01T08:05:28Z", "author": {"login": "MiguelPires"}, "path": "clients/java/src/main/java/io/zeebe/client/impl/oauth/OAuthCredentialsProvider.java", "diffHunk": "@@ -72,9 +71,12 @@ public void applyCredentials(final Metadata headers) throws IOException {\n       loadCredentials();\n     }\n \n-    headers.put(\n-        HEADER_AUTH_KEY,\n-        String.format(\"%s %s\", credentials.getTokenType(), credentials.getAccessToken()));\n+    String type = credentials.getTokenType();\n+    if (!type.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk4NTM5NQ=="}, "originalCommit": {"oid": "1729e373b5daee58b5bcea7cef9cc7c790c6ebfc"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2NzE5NzI1OnYy", "diffSide": "RIGHT", "path": "clients/java/src/main/java/io/zeebe/client/impl/oauth/OAuthCredentialsProvider.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNjoxODozNFrOF7jIww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwOTo0NzozMFrOF-4_AA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk4NTk4Nw==", "bodyText": "If type == 'c', I think this will throw an out of bounds exception when doing type.substring(1)?", "url": "https://github.com/camunda-cloud/zeebe/pull/4125#discussion_r397985987", "createdAt": "2020-03-25T16:18:34Z", "author": {"login": "npepinpe"}, "path": "clients/java/src/main/java/io/zeebe/client/impl/oauth/OAuthCredentialsProvider.java", "diffHunk": "@@ -72,9 +71,12 @@ public void applyCredentials(final Metadata headers) throws IOException {\n       loadCredentials();\n     }\n \n-    headers.put(\n-        HEADER_AUTH_KEY,\n-        String.format(\"%s %s\", credentials.getTokenType(), credentials.getAccessToken()));\n+    String type = credentials.getTokenType();\n+    if (!type.isEmpty()) {\n+      type = Character.toUpperCase(type.charAt(0)) + type.substring(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1729e373b5daee58b5bcea7cef9cc7c790c6ebfc"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQzMDQ4OQ==", "bodyText": "No, only if the index (1) was larger than the length (which we check in the line before)", "url": "https://github.com/camunda-cloud/zeebe/pull/4125#discussion_r401430489", "createdAt": "2020-04-01T08:09:27Z", "author": {"login": "MiguelPires"}, "path": "clients/java/src/main/java/io/zeebe/client/impl/oauth/OAuthCredentialsProvider.java", "diffHunk": "@@ -72,9 +71,12 @@ public void applyCredentials(final Metadata headers) throws IOException {\n       loadCredentials();\n     }\n \n-    headers.put(\n-        HEADER_AUTH_KEY,\n-        String.format(\"%s %s\", credentials.getTokenType(), credentials.getAccessToken()));\n+    String type = credentials.getTokenType();\n+    if (!type.isEmpty()) {\n+      type = Character.toUpperCase(type.charAt(0)) + type.substring(1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk4NTk4Nw=="}, "originalCommit": {"oid": "1729e373b5daee58b5bcea7cef9cc7c790c6ebfc"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ4OTY2NA==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/camunda-cloud/zeebe/pull/4125#discussion_r401489664", "createdAt": "2020-04-01T09:47:30Z", "author": {"login": "npepinpe"}, "path": "clients/java/src/main/java/io/zeebe/client/impl/oauth/OAuthCredentialsProvider.java", "diffHunk": "@@ -72,9 +71,12 @@ public void applyCredentials(final Metadata headers) throws IOException {\n       loadCredentials();\n     }\n \n-    headers.put(\n-        HEADER_AUTH_KEY,\n-        String.format(\"%s %s\", credentials.getTokenType(), credentials.getAccessToken()));\n+    String type = credentials.getTokenType();\n+    if (!type.isEmpty()) {\n+      type = Character.toUpperCase(type.charAt(0)) + type.substring(1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk4NTk4Nw=="}, "originalCommit": {"oid": "1729e373b5daee58b5bcea7cef9cc7c790c6ebfc"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2NzIyNDYwOnYy", "diffSide": "RIGHT", "path": "clients/java/src/main/java/io/zeebe/client/impl/oauth/OAuthCredentialsProvider.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNjoyNDoxMVrOF7jZ6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwODoxMToxMVrOF-1bqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk5MDM3OA==", "bodyText": "What a strange little API that takes a string for charset and not the charset type...", "url": "https://github.com/camunda-cloud/zeebe/pull/4125#discussion_r397990378", "createdAt": "2020-03-25T16:24:11Z", "author": {"login": "npepinpe"}, "path": "clients/java/src/main/java/io/zeebe/client/impl/oauth/OAuthCredentialsProvider.java", "diffHunk": "@@ -120,36 +122,48 @@ private boolean refreshCredentials() throws IOException {\n     final ZeebeClientCredentials fetchedCredentials = fetchCredentials();\n     credentialsCache.put(endpoint, fetchedCredentials).writeCache();\n \n-    if (fetchedCredentials.equals(credentials)) {\n-      return false;\n+    if (credentials == null || !credentials.isValid() || !fetchedCredentials.equals(credentials)) {\n+      credentials = fetchedCredentials;\n+      LOG.debug(\"Refreshed credentials.\");\n+\n+      return true;\n     }\n \n-    credentials = fetchedCredentials;\n-    LOG.debug(\"Refreshed credentials.\");\n-    return true;\n+    return false;\n   }\n \n-  private static String createJsonPayload(final OAuthCredentialsProviderBuilder builder)\n-      throws JsonProcessingException {\n+  private static String createParams(final OAuthCredentialsProviderBuilder builder) {\n     final Map<String, String> payload = new HashMap<>();\n     payload.put(\"client_id\", builder.getClientId());\n     payload.put(\"client_secret\", builder.getClientSecret());\n     payload.put(\"audience\", builder.getAudience());\n     payload.put(\"grant_type\", \"client_credentials\");\n \n-    return JSON_MAPPER.writeValueAsString(payload);\n+    final StringBuilder sb = new StringBuilder();\n+    payload.forEach((key, value) -> sb.append(String.format(\"%s=%s&\", encode(key), encode(value))));\n+    sb.deleteCharAt(sb.length() - 1);\n+    return sb.toString();\n+  }\n+\n+  private static String encode(final String param) {\n+    try {\n+      return URLEncoder.encode(param, StandardCharsets.UTF_8.name());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1729e373b5daee58b5bcea7cef9cc7c790c6ebfc"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQzMTQ2Nw==", "bodyText": "Later versions take the charset as well but only since java 10", "url": "https://github.com/camunda-cloud/zeebe/pull/4125#discussion_r401431467", "createdAt": "2020-04-01T08:11:11Z", "author": {"login": "MiguelPires"}, "path": "clients/java/src/main/java/io/zeebe/client/impl/oauth/OAuthCredentialsProvider.java", "diffHunk": "@@ -120,36 +122,48 @@ private boolean refreshCredentials() throws IOException {\n     final ZeebeClientCredentials fetchedCredentials = fetchCredentials();\n     credentialsCache.put(endpoint, fetchedCredentials).writeCache();\n \n-    if (fetchedCredentials.equals(credentials)) {\n-      return false;\n+    if (credentials == null || !credentials.isValid() || !fetchedCredentials.equals(credentials)) {\n+      credentials = fetchedCredentials;\n+      LOG.debug(\"Refreshed credentials.\");\n+\n+      return true;\n     }\n \n-    credentials = fetchedCredentials;\n-    LOG.debug(\"Refreshed credentials.\");\n-    return true;\n+    return false;\n   }\n \n-  private static String createJsonPayload(final OAuthCredentialsProviderBuilder builder)\n-      throws JsonProcessingException {\n+  private static String createParams(final OAuthCredentialsProviderBuilder builder) {\n     final Map<String, String> payload = new HashMap<>();\n     payload.put(\"client_id\", builder.getClientId());\n     payload.put(\"client_secret\", builder.getClientSecret());\n     payload.put(\"audience\", builder.getAudience());\n     payload.put(\"grant_type\", \"client_credentials\");\n \n-    return JSON_MAPPER.writeValueAsString(payload);\n+    final StringBuilder sb = new StringBuilder();\n+    payload.forEach((key, value) -> sb.append(String.format(\"%s=%s&\", encode(key), encode(value))));\n+    sb.deleteCharAt(sb.length() - 1);\n+    return sb.toString();\n+  }\n+\n+  private static String encode(final String param) {\n+    try {\n+      return URLEncoder.encode(param, StandardCharsets.UTF_8.name());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk5MDM3OA=="}, "originalCommit": {"oid": "1729e373b5daee58b5bcea7cef9cc7c790c6ebfc"}, "originalPosition": 117}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2NzI1MjE2OnYy", "diffSide": "RIGHT", "path": "clients/java/src/main/java/io/zeebe/client/impl/oauth/OAuthCredentialsProvider.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNjozMDowMFrOF7jrEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwODoxMzozMlrOF-1hDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk5NDc3MA==", "bodyText": "Nit: would this also work without having to deal with the awkward deletion of the last '&'?\n    payload.entrySet().stream()\n        .map(e -> encode(e.getKey()) + \"=\" + encode(e.getValue()))\n        .collect(Collectors.joining(\"&\"));\nDidn't test it, just off the top of my head, feel free to ignore if it seems more complicated - I just always find this extra deleting awkward", "url": "https://github.com/camunda-cloud/zeebe/pull/4125#discussion_r397994770", "createdAt": "2020-03-25T16:30:00Z", "author": {"login": "npepinpe"}, "path": "clients/java/src/main/java/io/zeebe/client/impl/oauth/OAuthCredentialsProvider.java", "diffHunk": "@@ -120,36 +122,48 @@ private boolean refreshCredentials() throws IOException {\n     final ZeebeClientCredentials fetchedCredentials = fetchCredentials();\n     credentialsCache.put(endpoint, fetchedCredentials).writeCache();\n \n-    if (fetchedCredentials.equals(credentials)) {\n-      return false;\n+    if (credentials == null || !credentials.isValid() || !fetchedCredentials.equals(credentials)) {\n+      credentials = fetchedCredentials;\n+      LOG.debug(\"Refreshed credentials.\");\n+\n+      return true;\n     }\n \n-    credentials = fetchedCredentials;\n-    LOG.debug(\"Refreshed credentials.\");\n-    return true;\n+    return false;\n   }\n \n-  private static String createJsonPayload(final OAuthCredentialsProviderBuilder builder)\n-      throws JsonProcessingException {\n+  private static String createParams(final OAuthCredentialsProviderBuilder builder) {\n     final Map<String, String> payload = new HashMap<>();\n     payload.put(\"client_id\", builder.getClientId());\n     payload.put(\"client_secret\", builder.getClientSecret());\n     payload.put(\"audience\", builder.getAudience());\n     payload.put(\"grant_type\", \"client_credentials\");\n \n-    return JSON_MAPPER.writeValueAsString(payload);\n+    final StringBuilder sb = new StringBuilder();\n+    payload.forEach((key, value) -> sb.append(String.format(\"%s=%s&\", encode(key), encode(value))));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1729e373b5daee58b5bcea7cef9cc7c790c6ebfc"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQzMjg0Ng==", "bodyText": "I agree, that's a better solution", "url": "https://github.com/camunda-cloud/zeebe/pull/4125#discussion_r401432846", "createdAt": "2020-04-01T08:13:32Z", "author": {"login": "MiguelPires"}, "path": "clients/java/src/main/java/io/zeebe/client/impl/oauth/OAuthCredentialsProvider.java", "diffHunk": "@@ -120,36 +122,48 @@ private boolean refreshCredentials() throws IOException {\n     final ZeebeClientCredentials fetchedCredentials = fetchCredentials();\n     credentialsCache.put(endpoint, fetchedCredentials).writeCache();\n \n-    if (fetchedCredentials.equals(credentials)) {\n-      return false;\n+    if (credentials == null || !credentials.isValid() || !fetchedCredentials.equals(credentials)) {\n+      credentials = fetchedCredentials;\n+      LOG.debug(\"Refreshed credentials.\");\n+\n+      return true;\n     }\n \n-    credentials = fetchedCredentials;\n-    LOG.debug(\"Refreshed credentials.\");\n-    return true;\n+    return false;\n   }\n \n-  private static String createJsonPayload(final OAuthCredentialsProviderBuilder builder)\n-      throws JsonProcessingException {\n+  private static String createParams(final OAuthCredentialsProviderBuilder builder) {\n     final Map<String, String> payload = new HashMap<>();\n     payload.put(\"client_id\", builder.getClientId());\n     payload.put(\"client_secret\", builder.getClientSecret());\n     payload.put(\"audience\", builder.getAudience());\n     payload.put(\"grant_type\", \"client_credentials\");\n \n-    return JSON_MAPPER.writeValueAsString(payload);\n+    final StringBuilder sb = new StringBuilder();\n+    payload.forEach((key, value) -> sb.append(String.format(\"%s=%s&\", encode(key), encode(value))));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk5NDc3MA=="}, "originalCommit": {"oid": "1729e373b5daee58b5bcea7cef9cc7c790c6ebfc"}, "originalPosition": 110}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MTI5ODEyOnYy", "diffSide": "RIGHT", "path": "clients/java/src/main/java/io/zeebe/client/impl/oauth/OAuthCredentialsProvider.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNDo1MDoxOFrOF8Ko2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwOToxNjo0NFrOF-3z0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYzMzE3Nw==", "bodyText": "Do we need to add the queryParams as query params if we pass them as body as well?", "url": "https://github.com/camunda-cloud/zeebe/pull/4125#discussion_r398633177", "createdAt": "2020-03-26T14:50:18Z", "author": {"login": "npepinpe"}, "path": "clients/java/src/main/java/io/zeebe/client/impl/oauth/OAuthCredentialsProvider.java", "diffHunk": "@@ -120,36 +122,48 @@ private boolean refreshCredentials() throws IOException {\n     final ZeebeClientCredentials fetchedCredentials = fetchCredentials();\n     credentialsCache.put(endpoint, fetchedCredentials).writeCache();\n \n-    if (fetchedCredentials.equals(credentials)) {\n-      return false;\n+    if (credentials == null || !credentials.isValid() || !fetchedCredentials.equals(credentials)) {\n+      credentials = fetchedCredentials;\n+      LOG.debug(\"Refreshed credentials.\");\n+\n+      return true;\n     }\n \n-    credentials = fetchedCredentials;\n-    LOG.debug(\"Refreshed credentials.\");\n-    return true;\n+    return false;\n   }\n \n-  private static String createJsonPayload(final OAuthCredentialsProviderBuilder builder)\n-      throws JsonProcessingException {\n+  private static String createParams(final OAuthCredentialsProviderBuilder builder) {\n     final Map<String, String> payload = new HashMap<>();\n     payload.put(\"client_id\", builder.getClientId());\n     payload.put(\"client_secret\", builder.getClientSecret());\n     payload.put(\"audience\", builder.getAudience());\n     payload.put(\"grant_type\", \"client_credentials\");\n \n-    return JSON_MAPPER.writeValueAsString(payload);\n+    final StringBuilder sb = new StringBuilder();\n+    payload.forEach((key, value) -> sb.append(String.format(\"%s=%s&\", encode(key), encode(value))));\n+    sb.deleteCharAt(sb.length() - 1);\n+    return sb.toString();\n+  }\n+\n+  private static String encode(final String param) {\n+    try {\n+      return URLEncoder.encode(param, StandardCharsets.UTF_8.name());\n+    } catch (UnsupportedEncodingException e) {\n+      throw new UncheckedIOException(\"Failed while encoding OAuth request parameters: \", e);\n+    }\n   }\n \n   private ZeebeClientCredentials fetchCredentials() throws IOException {\n     final HttpURLConnection connection =\n-        (HttpURLConnection) authorizationServerUrl.openConnection();\n+        (HttpURLConnection)\n+            new URL(String.format(\"%s?%s\", authorizationServerUrl, queryParams)).openConnection();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1729e373b5daee58b5bcea7cef9cc7c790c6ebfc"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ3MDQxOQ==", "bodyText": "No, that's a mistake. Thanks", "url": "https://github.com/camunda-cloud/zeebe/pull/4125#discussion_r401470419", "createdAt": "2020-04-01T09:16:44Z", "author": {"login": "MiguelPires"}, "path": "clients/java/src/main/java/io/zeebe/client/impl/oauth/OAuthCredentialsProvider.java", "diffHunk": "@@ -120,36 +122,48 @@ private boolean refreshCredentials() throws IOException {\n     final ZeebeClientCredentials fetchedCredentials = fetchCredentials();\n     credentialsCache.put(endpoint, fetchedCredentials).writeCache();\n \n-    if (fetchedCredentials.equals(credentials)) {\n-      return false;\n+    if (credentials == null || !credentials.isValid() || !fetchedCredentials.equals(credentials)) {\n+      credentials = fetchedCredentials;\n+      LOG.debug(\"Refreshed credentials.\");\n+\n+      return true;\n     }\n \n-    credentials = fetchedCredentials;\n-    LOG.debug(\"Refreshed credentials.\");\n-    return true;\n+    return false;\n   }\n \n-  private static String createJsonPayload(final OAuthCredentialsProviderBuilder builder)\n-      throws JsonProcessingException {\n+  private static String createParams(final OAuthCredentialsProviderBuilder builder) {\n     final Map<String, String> payload = new HashMap<>();\n     payload.put(\"client_id\", builder.getClientId());\n     payload.put(\"client_secret\", builder.getClientSecret());\n     payload.put(\"audience\", builder.getAudience());\n     payload.put(\"grant_type\", \"client_credentials\");\n \n-    return JSON_MAPPER.writeValueAsString(payload);\n+    final StringBuilder sb = new StringBuilder();\n+    payload.forEach((key, value) -> sb.append(String.format(\"%s=%s&\", encode(key), encode(value))));\n+    sb.deleteCharAt(sb.length() - 1);\n+    return sb.toString();\n+  }\n+\n+  private static String encode(final String param) {\n+    try {\n+      return URLEncoder.encode(param, StandardCharsets.UTF_8.name());\n+    } catch (UnsupportedEncodingException e) {\n+      throw new UncheckedIOException(\"Failed while encoding OAuth request parameters: \", e);\n+    }\n   }\n \n   private ZeebeClientCredentials fetchCredentials() throws IOException {\n     final HttpURLConnection connection =\n-        (HttpURLConnection) authorizationServerUrl.openConnection();\n+        (HttpURLConnection)\n+            new URL(String.format(\"%s?%s\", authorizationServerUrl, queryParams)).openConnection();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYzMzE3Nw=="}, "originalCommit": {"oid": "1729e373b5daee58b5bcea7cef9cc7c790c6ebfc"}, "originalPosition": 127}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4804, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}