{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5NTIwMTg3", "number": 5943, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxMjozNjo0OFrOE-omCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxMjozNjo0OFrOE-omCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MTEyMjY1OnYy", "diffSide": "RIGHT", "path": "clients/go/cmd/zbctl/internal/commands/status.go", "isResolved": false, "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxMjozNjo0OFrOH75N5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMDoxODoyOFrOIAfilA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjU2NTQ3OQ==", "bodyText": "I have to move it to a separate function because JSONPB marshals int64 as Go string. This breaks backward compatibility. See: https://developers.google.com/protocol-buffers/docs/proto3#json", "url": "https://github.com/camunda-cloud/zeebe/pull/5943#discussion_r532565479", "createdAt": "2020-11-30T12:36:48Z", "author": {"login": "aivinog1"}, "path": "clients/go/cmd/zbctl/internal/commands/status.go", "diffHunk": "@@ -117,3 +128,12 @@ func healthToString(health pb.Partition_PartitionBrokerHealth) string {\n \t\treturn unknownState\n \t}\n }\n+\n+func printTopologyJSON(resp *pb.TopologyResponse) error {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d53182e736282f73aa746a4bb61e59d38b75f70"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYyNTY1Mg==", "bodyText": "Do I understand correctly this means we cannot just replace the implementation of printJSON() in commands/root.go?", "url": "https://github.com/camunda-cloud/zeebe/pull/5943#discussion_r532625652", "createdAt": "2020-11-30T14:13:17Z", "author": {"login": "korthout"}, "path": "clients/go/cmd/zbctl/internal/commands/status.go", "diffHunk": "@@ -117,3 +128,12 @@ func healthToString(health pb.Partition_PartitionBrokerHealth) string {\n \t\treturn unknownState\n \t}\n }\n+\n+func printTopologyJSON(resp *pb.TopologyResponse) error {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjU2NTQ3OQ=="}, "originalCommit": {"oid": "4d53182e736282f73aa746a4bb61e59d38b75f70"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA4NDA3OA==", "bodyText": "Correct. For example, what the test show:\n        --- FAIL: TestZbctlWithInsecureGateway/TestCommonCommands/deploy_workflow (0.97s)\n            main_test.go:150: deploy workflow: diff (-want +got):\n                \u00a0\u00a0[]string{\n                \u00a0\u00a0      \"{\",\n                -\u00a0      `  \"key\": 2251799813685250,`,\n                +\u00a0      `  \"key\": \"2251799813685251\",`,\n                \u00a0\u00a0      `  \"workflows\": [`,\n                \u00a0\u00a0      \"    {\",\n                \u00a0\u00a0      `      \"bpmnProcessId\": \"process\",`,\n                \u00a0\u00a0      `      \"version\": 1,`,\n                -\u00a0      `      \"workflowKey\": 2251799813685345,`,\n                +\u00a0      `      \"workflowKey\": \"2251799813685249\",`,\n                \u00a0\u00a0      `      \"resourceName\": \"model.bpmn\"`,\n                \u00a0\u00a0      \"    },\",\n                \u00a0\u00a0      \"    {\",\n                \u00a0\u00a0      `      \"bpmnProcessId\": \"jobProcess\",`,\n                \u00a0\u00a0      `      \"version\": 1,`,\n                -\u00a0      `      \"workflowKey\": 2251799813685346,`,\n                +\u00a0      `      \"workflowKey\": \"2251799813685250\",`,\n                \u00a0\u00a0      `      \"resourceName\": \"job.bpmn\"`,\n                \u00a0\u00a0      \"    }\",\n                \u00a0\u00a0      ... // 3 identical elements\n                \u00a0\u00a0}\n\n\nAfter this diff:\nIndex: clients/go/cmd/zbctl/internal/commands/root.go\nIDEA additional info:\nSubsystem: com.intellij.openapi.diff.impl.patch.CharsetEP\n<+>UTF-8\n===================================================================\n--- clients/go/cmd/zbctl/internal/commands/root.go\t(revision 0d4eff5158bd87c7c7ae224a7bee9ed3953c7e7a)\n+++ clients/go/cmd/zbctl/internal/commands/root.go\t(date 1606800703955)\n@@ -15,9 +15,10 @@\n package commands\n \n import (\n-\t\"encoding/json\"\n \t\"fmt\"\n \t\"github.com/zeebe-io/zeebe/clients/go/pkg/zbc\"\n+\t\"google.golang.org/protobuf/encoding/protojson\"\n+\t\"google.golang.org/protobuf/reflect/protoreflect\"\n \t\"os\"\n \t\"strconv\"\n \t\"strings\"\n@@ -201,8 +202,9 @@\n \t}\n }\n \n-func printJSON(value interface{}) error {\n-\tvalueJSON, err := json.MarshalIndent(value, \"\", \"  \")\n+func printJSON(value protoreflect.ProtoMessage) error {\n+\tm := protojson.MarshalOptions{EmitUnpopulated: true, Indent: \"  \"}\n+\tvalueJSON, err := m.Marshal(value)\n \tif err == nil {\n \t\tfmt.Println(string(valueJSON))\n \t}", "url": "https://github.com/camunda-cloud/zeebe/pull/5943#discussion_r533084078", "createdAt": "2020-12-01T05:37:07Z", "author": {"login": "aivinog1"}, "path": "clients/go/cmd/zbctl/internal/commands/status.go", "diffHunk": "@@ -117,3 +128,12 @@ func healthToString(health pb.Partition_PartitionBrokerHealth) string {\n \t\treturn unknownState\n \t}\n }\n+\n+func printTopologyJSON(resp *pb.TopologyResponse) error {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjU2NTQ3OQ=="}, "originalCommit": {"oid": "4d53182e736282f73aa746a4bb61e59d38b75f70"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzE2NTMyMA==", "bodyText": "Thanks for this, very clear.\n@MiguelPires This change is backwards compatible this way, but it also means that json marshalling is done differently for this response compared to others. Should we keep backwards compatibility and introduce this inconsistency or should we break backwards compatibility and go for consistency? I'd love to hear what you think", "url": "https://github.com/camunda-cloud/zeebe/pull/5943#discussion_r533165320", "createdAt": "2020-12-01T08:49:11Z", "author": {"login": "korthout"}, "path": "clients/go/cmd/zbctl/internal/commands/status.go", "diffHunk": "@@ -117,3 +128,12 @@ func healthToString(health pb.Partition_PartitionBrokerHealth) string {\n \t\treturn unknownState\n \t}\n }\n+\n+func printTopologyJSON(resp *pb.TopologyResponse) error {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjU2NTQ3OQ=="}, "originalCommit": {"oid": "4d53182e736282f73aa746a4bb61e59d38b75f70"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzMyMjA2NA==", "bodyText": "I think right now our priority is maintaining backwards compatibility but @npepinpe can answer that better", "url": "https://github.com/camunda-cloud/zeebe/pull/5943#discussion_r537322064", "createdAt": "2020-12-07T08:40:07Z", "author": {"login": "MiguelPires"}, "path": "clients/go/cmd/zbctl/internal/commands/status.go", "diffHunk": "@@ -117,3 +128,12 @@ func healthToString(health pb.Partition_PartitionBrokerHealth) string {\n \t\treturn unknownState\n \t}\n }\n+\n+func printTopologyJSON(resp *pb.TopologyResponse) error {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjU2NTQ3OQ=="}, "originalCommit": {"oid": "4d53182e736282f73aa746a4bb61e59d38b75f70"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzMyMzkzOA==", "bodyText": "Backwards compat is pretty important, but primarily in the broker - in the client it really depends on what the impact is. I'm not really into the current topic, so how is backwards compatibility broken here? (let's ignore that I'm confused as to why int64 is converted to string \ud83d\ude05)", "url": "https://github.com/camunda-cloud/zeebe/pull/5943#discussion_r537323938", "createdAt": "2020-12-07T08:43:11Z", "author": {"login": "npepinpe"}, "path": "clients/go/cmd/zbctl/internal/commands/status.go", "diffHunk": "@@ -117,3 +128,12 @@ func healthToString(health pb.Partition_PartitionBrokerHealth) string {\n \t\treturn unknownState\n \t}\n }\n+\n+func printTopologyJSON(resp *pb.TopologyResponse) error {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjU2NTQ3OQ=="}, "originalCommit": {"oid": "4d53182e736282f73aa746a4bb61e59d38b75f70"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzMzMDg0OA==", "bodyText": "-       `  \"key\": 2251799813685250,`,\n                +       `  \"key\": \"2251799813685251\",`,\n\nJSONPB serializes the int64 fields as string and the standard one doesn't", "url": "https://github.com/camunda-cloud/zeebe/pull/5943#discussion_r537330848", "createdAt": "2020-12-07T08:54:14Z", "author": {"login": "MiguelPires"}, "path": "clients/go/cmd/zbctl/internal/commands/status.go", "diffHunk": "@@ -117,3 +128,12 @@ func healthToString(health pb.Partition_PartitionBrokerHealth) string {\n \t\treturn unknownState\n \t}\n }\n+\n+func printTopologyJSON(resp *pb.TopologyResponse) error {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjU2NTQ3OQ=="}, "originalCommit": {"oid": "4d53182e736282f73aa746a4bb61e59d38b75f70"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzMzODEwOA==", "bodyText": "Dumb question, but why is it using JSONPB and not just the standard one? Anyway, I assume we have to? And there's no way to change this behaviour? Because that's pretty weird.\nAt any rate, I imagine we're not going to use JSONPB for the other commands, right? So this only affects the topology? And only if we specify --json? Where does the backwards compatibility breaks?", "url": "https://github.com/camunda-cloud/zeebe/pull/5943#discussion_r537338108", "createdAt": "2020-12-07T09:05:25Z", "author": {"login": "npepinpe"}, "path": "clients/go/cmd/zbctl/internal/commands/status.go", "diffHunk": "@@ -117,3 +128,12 @@ func healthToString(health pb.Partition_PartitionBrokerHealth) string {\n \t\treturn unknownState\n \t}\n }\n+\n+func printTopologyJSON(resp *pb.TopologyResponse) error {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjU2NTQ3OQ=="}, "originalCommit": {"oid": "4d53182e736282f73aa746a4bb61e59d38b75f70"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM0Mzg1NA==", "bodyText": "Yes, the standard json printer doesn't do well with protobuf because of the enums. The issue is not with jsonpb, specifying int64 integers as string is part of the protobuf spec. From what I read, it's because in some browsers javascript had trouble reading int64s (that's something I read online, I didn't do any research on it).\nActually, if we can break compatibility I would suggest adding this flag everywhere and either print things in a human-readable or using JSONPB. It would avoid issues like #5888", "url": "https://github.com/camunda-cloud/zeebe/pull/5943#discussion_r537343854", "createdAt": "2020-12-07T09:14:24Z", "author": {"login": "MiguelPires"}, "path": "clients/go/cmd/zbctl/internal/commands/status.go", "diffHunk": "@@ -117,3 +128,12 @@ func healthToString(health pb.Partition_PartitionBrokerHealth) string {\n \t\treturn unknownState\n \t}\n }\n+\n+func printTopologyJSON(resp *pb.TopologyResponse) error {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjU2NTQ3OQ=="}, "originalCommit": {"oid": "4d53182e736282f73aa746a4bb61e59d38b75f70"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM4NzY2OA==", "bodyText": "Actually, if we can break compatibility I would suggest adding this flag everywhere and either print things in a human-readable or using JSONPB\n\nLet's do that, but I think this is maybe outside of scope here. Let's create a follow up issue, and for now let's implement this flag only for this command. wdyt?", "url": "https://github.com/camunda-cloud/zeebe/pull/5943#discussion_r537387668", "createdAt": "2020-12-07T10:18:28Z", "author": {"login": "npepinpe"}, "path": "clients/go/cmd/zbctl/internal/commands/status.go", "diffHunk": "@@ -117,3 +128,12 @@ func healthToString(health pb.Partition_PartitionBrokerHealth) string {\n \t\treturn unknownState\n \t}\n }\n+\n+func printTopologyJSON(resp *pb.TopologyResponse) error {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjU2NTQ3OQ=="}, "originalCommit": {"oid": "4d53182e736282f73aa746a4bb61e59d38b75f70"}, "originalPosition": 46}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 86, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}