{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4MDM0OTI0", "number": 4791, "title": "chore(Dockerfile): remove chgrp/chown layer", "bodyText": "Description\nThis PR slims down the Docker image by removing an unnecessary layer which was > 100Mb. When moving to non-root, we introduced a chgrp/chmod layer which effectively has the same size as the copy layer, resulting two large layers that need to be pushed on every change. Furthermore, it seems the container was still not running under the zeebe user by default, which is fixed, and the root folder is also given the correct permissions. This was done by changing the builder stage to a debian based image, and using the same permissions, which are they copied over properly (tested with and without BuildKit).\nRelated issues\ncloses #4788\nPull Request Checklist\n\n All commit messages match our commit message guidelines\n The submitting code follows our code style\n If submitting code, please run mvn clean install -DskipTests locally before committing", "createdAt": "2020-06-22T15:55:33Z", "url": "https://github.com/camunda-cloud/zeebe/pull/4791", "merged": true, "mergeCommit": {"oid": "858ae2c5162de9c64ccd6e4c1c9c095be33bcaaa"}, "closed": true, "closedAt": "2020-06-25T11:26:03Z", "author": {"login": "npepinpe"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcty_lrgBqjM0NjkwODA2NjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcusjLrgBqjM0ODE4NTE0OTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e45c1d0be3a08c20e3ca287277051df3b09185b9", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/e45c1d0be3a08c20e3ca287277051df3b09185b9", "committedDate": "2020-06-22T15:51:44Z", "message": "chore(Dockerfile): remove chgrp/chown layer\n\n- slims down the resulting image by copying files over with the correct\n  permissions already\n- sets the container's user to zeebe\n- corrects permissions for logs folder"}, "afterCommit": {"oid": "e73c180a382f6128b212df2c1f598599828c05e9", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/e73c180a382f6128b212df2c1f598599828c05e9", "committedDate": "2020-06-22T15:57:15Z", "message": "chore(Dockerfile): remove chgrp/chown layer\n\n- slims down the resulting image by copying files over with the correct\n  permissions already\n- sets the container's user to zeebe\n- corrects permissions for logs folder"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NDA3NjA5", "url": "https://github.com/camunda-cloud/zeebe/pull/4791#pullrequestreview-435407609", "createdAt": "2020-06-23T03:03:58Z", "commit": {"oid": "e73c180a382f6128b212df2c1f598599828c05e9"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwMzowMzo1OFrOGnXpTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwNTo0ODozNlrOGnaKRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzkzNTA1NQ==", "bodyText": "Isn't 0 == root? Why do you need to set the grp to root? And chmod -R should be recursive I would expect \ud83e\udd14", "url": "https://github.com/camunda-cloud/zeebe/pull/4791#discussion_r443935055", "createdAt": "2020-06-23T03:03:58Z", "author": {"login": "Zelldon"}, "path": "Dockerfile", "diffHunk": "@@ -12,9 +12,14 @@ RUN mkdir -p ${TMP_DIR} && \\\n     # already create volume dir to later have correct rights\n     mkdir ${TMP_DIR}/data\n \n+RUN groupadd -g 1000 zeebe && \\\n+    adduser -u 1000 zeebe --system --ingroup zeebe\n+\n ADD https://github.com/krallin/tini/releases/download/${TINI_VERSION}/tini ${TMP_DIR}/bin/tini\n COPY docker/utils/startup.sh ${TMP_DIR}/bin/startup.sh\n RUN chmod +x -R ${TMP_DIR}/bin/\n+RUN chgrp 0 ${TMP_DIR}/bin/startup.sh && chmod 0775 ${TMP_DIR}/bin/startup.sh", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e73c180a382f6128b212df2c1f598599828c05e9"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzkzNjMyOQ==", "bodyText": "Maybe we can add comments for some lines like these what was the reason to add this and what it is supposed to do.", "url": "https://github.com/camunda-cloud/zeebe/pull/4791#discussion_r443936329", "createdAt": "2020-06-23T03:09:31Z", "author": {"login": "Zelldon"}, "path": "Dockerfile", "diffHunk": "@@ -24,21 +29,22 @@ ENV ZB_HOME=/usr/local/zeebe \\\n     ZEEBE_STANDALONE_GATEWAY=false\n ENV PATH \"${ZB_HOME}/bin:${PATH}\"\n \n-RUN groupadd -g 1000 zeebe && \\\n-    adduser -u 1000 zeebe --system --ingroup zeebe\n-\n WORKDIR ${ZB_HOME}\n EXPOSE 26500 26501 26502\n VOLUME ${ZB_HOME}/data\n \n+RUN groupadd -g 1000 zeebe && \\\n+    adduser -u 1000 zeebe --system --ingroup zeebe\n+RUN chmod g=u /etc/passwd", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e73c180a382f6128b212df2c1f598599828c05e9"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzkzNzM1MQ==", "bodyText": "Do you know why we not copying the startup script from the builder?", "url": "https://github.com/camunda-cloud/zeebe/pull/4791#discussion_r443937351", "createdAt": "2020-06-23T03:14:01Z", "author": {"login": "Zelldon"}, "path": "Dockerfile", "diffHunk": "@@ -24,21 +29,22 @@ ENV ZB_HOME=/usr/local/zeebe \\\n     ZEEBE_STANDALONE_GATEWAY=false\n ENV PATH \"${ZB_HOME}/bin:${PATH}\"\n \n-RUN groupadd -g 1000 zeebe && \\\n-    adduser -u 1000 zeebe --system --ingroup zeebe\n-\n WORKDIR ${ZB_HOME}\n EXPOSE 26500 26501 26502\n VOLUME ${ZB_HOME}/data\n \n+RUN groupadd -g 1000 zeebe && \\\n+    adduser -u 1000 zeebe --system --ingroup zeebe\n+RUN chmod g=u /etc/passwd\n+RUN chown 1000:0 ${ZB_HOME} ${ZB_HOME}/data\n+\n+USER zeebe\n COPY --chown=1000:0 docker/utils/startup.sh /usr/local/bin", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e73c180a382f6128b212df2c1f598599828c05e9"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk3NjI2MQ==", "bodyText": "I'm not a docker expert. I think earlier it was told that RUN should be merged together, but it seems that this is in the newest versions no longer the case, is this right? Related https://stackoverflow.com/questions/39223249/multiple-run-vs-single-chained-run-in-dockerfile-what-is-better", "url": "https://github.com/camunda-cloud/zeebe/pull/4791#discussion_r443976261", "createdAt": "2020-06-23T05:48:36Z", "author": {"login": "Zelldon"}, "path": "Dockerfile", "diffHunk": "@@ -24,21 +29,22 @@ ENV ZB_HOME=/usr/local/zeebe \\\n     ZEEBE_STANDALONE_GATEWAY=false\n ENV PATH \"${ZB_HOME}/bin:${PATH}\"\n \n-RUN groupadd -g 1000 zeebe && \\\n-    adduser -u 1000 zeebe --system --ingroup zeebe\n-\n WORKDIR ${ZB_HOME}\n EXPOSE 26500 26501 26502\n VOLUME ${ZB_HOME}/data\n \n+RUN groupadd -g 1000 zeebe && \\\n+    adduser -u 1000 zeebe --system --ingroup zeebe\n+RUN chmod g=u /etc/passwd", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzkzNjMyOQ=="}, "originalCommit": {"oid": "e73c180a382f6128b212df2c1f598599828c05e9"}, "originalPosition": 34}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "18ceeec5d9c40fd9e28b3cfd84a87a1cdd8bbb6c", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/18ceeec5d9c40fd9e28b3cfd84a87a1cdd8bbb6c", "committedDate": "2020-06-23T07:13:49Z", "message": "chore(Dockerfile): simplify dockerfile"}, "afterCommit": {"oid": "e07c64f0a6539ff6b48af643911c8f60c79daa71", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/e07c64f0a6539ff6b48af643911c8f60c79daa71", "committedDate": "2020-06-23T07:14:44Z", "message": "chore(Dockerfile): simplify dockerfile"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NTI4NjIy", "url": "https://github.com/camunda-cloud/zeebe/pull/4791#pullrequestreview-435528622", "createdAt": "2020-06-23T07:51:57Z", "commit": {"oid": "e07c64f0a6539ff6b48af643911c8f60c79daa71"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NTYwMzUx", "url": "https://github.com/camunda-cloud/zeebe/pull/4791#pullrequestreview-435560351", "createdAt": "2020-06-23T08:32:46Z", "commit": {"oid": "e07c64f0a6539ff6b48af643911c8f60c79daa71"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwODozMjo0N1rOGne8yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwODo0MjoyMlrOGnfTug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA1NDczMQ==", "bodyText": "Why do we need this in the builder image?", "url": "https://github.com/camunda-cloud/zeebe/pull/4791#discussion_r444054731", "createdAt": "2020-06-23T08:32:47Z", "author": {"login": "menski"}, "path": "Dockerfile", "diffHunk": "@@ -16,9 +15,13 @@ RUN mkdir -p ${TMP_DIR} && \\\n     # already create volume dir to later have correct rights\n     mkdir ${TMP_DIR}/data\n \n+RUN groupadd -g 1000 zeebe && \\\n+    adduser -u 1000 zeebe --system --ingroup zeebe", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e07c64f0a6539ff6b48af643911c8f60c79daa71"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA1NjUzNA==", "bodyText": "I don't think we need to set the owner in the builder image as we set them on copy to the final image", "url": "https://github.com/camunda-cloud/zeebe/pull/4791#discussion_r444056534", "createdAt": "2020-06-23T08:35:43Z", "author": {"login": "menski"}, "path": "Dockerfile", "diffHunk": "@@ -16,9 +15,13 @@ RUN mkdir -p ${TMP_DIR} && \\\n     # already create volume dir to later have correct rights\n     mkdir ${TMP_DIR}/data\n \n+RUN groupadd -g 1000 zeebe && \\\n+    adduser -u 1000 zeebe --system --ingroup zeebe\n+\n ADD https://github.com/krallin/tini/releases/download/${TINI_VERSION}/tini ${TMP_DIR}/bin/tini\n COPY docker/utils/startup.sh ${TMP_DIR}/bin/startup.sh\n RUN chmod +x -R ${TMP_DIR}/bin/\n+RUN chown 1000:1000 -R ${TMP_DIR}/ && chmod -R 0775 ${TMP_DIR}/ ${TMP_DIR}/data", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e07c64f0a6539ff6b48af643911c8f60c79daa71"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA1ODY2Nw==", "bodyText": "The group has to be 0 for the non-root to work correctly, and I think we should set it after we copied the content, or maybe it's is even not needed, not sure how copy --chown works in docker out of my head.", "url": "https://github.com/camunda-cloud/zeebe/pull/4791#discussion_r444058667", "createdAt": "2020-06-23T08:39:10Z", "author": {"login": "menski"}, "path": "Dockerfile", "diffHunk": "@@ -39,21 +42,17 @@ ENV ZB_HOME=/usr/local/zeebe \\\n     ZEEBE_STANDALONE_GATEWAY=false\n ENV PATH \"${ZB_HOME}/bin:${PATH}\"\n \n-RUN groupadd -g 1000 zeebe && \\\n-    adduser -u 1000 zeebe --system --ingroup zeebe\n-\n WORKDIR ${ZB_HOME}\n EXPOSE 26500 26501 26502\n VOLUME ${ZB_HOME}/data\n \n-COPY --chown=1000:0 docker/utils/startup.sh /usr/local/bin\n-RUN chgrp 0 /usr/local/bin/startup.sh && chmod g=u /etc/passwd && chmod 0775 /usr/local/bin/startup.sh\n-COPY --from=builder --chown=1000:0 /tmp/zeebe ${ZB_HOME}\n-RUN chown 1000:0 -R ${ZB_HOME}/ && chmod 0775 ${ZB_HOME}/ ${ZB_HOME}/data\n+RUN groupadd -g 1000 zeebe && \\\n+    adduser -u 1000 zeebe --system --ingroup zeebe\n+RUN chmod g=u /etc/passwd\n+RUN chown -R 1000:1000 ${ZB_HOME}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e07c64f0a6539ff6b48af643911c8f60c79daa71"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA2MDYwMg==", "bodyText": "again group has to be 0, and maybe we can just keep the startup.sh in the ${ZB_HOME}/bin dir instead of copying it around as we also do it tini. we can adjust the ENTRYPOINT instead.", "url": "https://github.com/camunda-cloud/zeebe/pull/4791#discussion_r444060602", "createdAt": "2020-06-23T08:42:22Z", "author": {"login": "menski"}, "path": "Dockerfile", "diffHunk": "@@ -39,21 +42,17 @@ ENV ZB_HOME=/usr/local/zeebe \\\n     ZEEBE_STANDALONE_GATEWAY=false\n ENV PATH \"${ZB_HOME}/bin:${PATH}\"\n \n-RUN groupadd -g 1000 zeebe && \\\n-    adduser -u 1000 zeebe --system --ingroup zeebe\n-\n WORKDIR ${ZB_HOME}\n EXPOSE 26500 26501 26502\n VOLUME ${ZB_HOME}/data\n \n-COPY --chown=1000:0 docker/utils/startup.sh /usr/local/bin\n-RUN chgrp 0 /usr/local/bin/startup.sh && chmod g=u /etc/passwd && chmod 0775 /usr/local/bin/startup.sh\n-COPY --from=builder --chown=1000:0 /tmp/zeebe ${ZB_HOME}\n-RUN chown 1000:0 -R ${ZB_HOME}/ && chmod 0775 ${ZB_HOME}/ ${ZB_HOME}/data\n+RUN groupadd -g 1000 zeebe && \\\n+    adduser -u 1000 zeebe --system --ingroup zeebe\n+RUN chmod g=u /etc/passwd\n+RUN chown -R 1000:1000 ${ZB_HOME}\n \n-# Set execution flag (otherwise, if image is built in a Windows environment, the start scripts\n-# won't be executable)\n-RUN chmod +x ${ZB_HOME}/bin/broker\n-RUN chmod +x ${ZB_HOME}/bin/gateway\n+USER zeebe\n+COPY --from=builder --chown=1000:1000 /tmp/zeebe/bin/startup.sh /usr/local/bin\n+COPY --from=builder --chown=1000:1000 /tmp/zeebe ${ZB_HOME}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e07c64f0a6539ff6b48af643911c8f60c79daa71"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MzU0MzY1", "url": "https://github.com/camunda-cloud/zeebe/pull/4791#pullrequestreview-437354365", "createdAt": "2020-06-25T10:11:19Z", "commit": {"oid": "cec529648ed1e1382ee23c79860dc2f7cdc045f8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "535957913e74c82761af73613752cebe768a783f", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/535957913e74c82761af73613752cebe768a783f", "committedDate": "2020-06-25T11:00:25Z", "message": "chore(Dockerfile): remove chgrp/chown layer\n\n- slims down the resulting image by copying files over with the correct\n  permissions already"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cec529648ed1e1382ee23c79860dc2f7cdc045f8", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/cec529648ed1e1382ee23c79860dc2f7cdc045f8", "committedDate": "2020-06-23T12:51:19Z", "message": "chore(Dockerfile): allow running with any user"}, "afterCommit": {"oid": "535957913e74c82761af73613752cebe768a783f", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/535957913e74c82761af73613752cebe768a783f", "committedDate": "2020-06-25T11:00:25Z", "message": "chore(Dockerfile): remove chgrp/chown layer\n\n- slims down the resulting image by copying files over with the correct\n  permissions already"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2813, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}