{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyMzE2MTAx", "number": 4108, "title": "chore(broker): improve fault tolerance on snapshot replication errors", "bodyText": "Description\n\nadds FileUtil#ensureDirectoryExists: while Argona already provides something similar, it simply returns a boolean, so we cannot properly say what the error is. In some cases it may be useful to receive the error, hence the addition.\nhandles I/O errors when consuming snapshot chunks and invalidating the snapshot\n\nRelated issues\nRelated to many issues but will not close them - writing in different folders will do this. The motivation here is to make it more fault-tolerant so we don't close the partition, and to help us better diagnose issues.\nPull Request Checklist\n\n All commit messages match our commit message guidelines\n The submitting code follows our code style\n If submitting code, please run mvn clean install -DskipTests locally before committing", "createdAt": "2020-03-23T11:07:22Z", "url": "https://github.com/camunda-cloud/zeebe/pull/4108", "merged": true, "mergeCommit": {"oid": "14598ae9c3dffe1f2d2ba7186c42175ec32bebea"}, "closed": true, "closedAt": "2020-03-24T15:41:21Z", "author": {"login": "npepinpe"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQhpSVAFqTM3OTY0Mzk5MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQzc1-ABqjMxNTk4MTcwNTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NjQzOTkx", "url": "https://github.com/camunda-cloud/zeebe/pull/4108#pullrequestreview-379643991", "createdAt": "2020-03-23T17:16:15Z", "commit": {"oid": "1294ff39415d3736d3afe944268ee4898f7b4af7"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNzoxNjoxNlrOF6PrjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNzoxOTo1N1rOF6P1vQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYxODYzNw==", "bodyText": "We could also use this new utility in DbPendingSnapshot.", "url": "https://github.com/camunda-cloud/zeebe/pull/4108#discussion_r396618637", "createdAt": "2020-03-23T17:16:16Z", "author": {"login": "deepthidevaki"}, "path": "util/src/main/java/io/zeebe/util/FileUtil.java", "diffHunk": "@@ -31,16 +32,28 @@\n \n   public static final Logger LOG = Loggers.FILE_LOGGER;\n \n+  private FileUtil() {}\n+\n   public static void deleteFolder(final String path) throws IOException {\n     final Path directory = Paths.get(path);\n \n     deleteFolder(directory);\n   }\n \n+  public static void ensureDirectoryExists(final Path directory) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1294ff39415d3736d3afe944268ee4898f7b4af7"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYyMTI0NQ==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/camunda-cloud/zeebe/pull/4108#discussion_r396621245", "createdAt": "2020-03-23T17:19:57Z", "author": {"login": "deepthidevaki"}, "path": "broker/src/main/java/io/zeebe/broker/clustering/atomix/storage/snapshot/DbSnapshotStore.java", "diffHunk": "@@ -203,6 +205,15 @@ private DbSnapshot put(final Path directory, final DbSnapshotMetadata metadata)\n     return put(new DbSnapshot(destination, metadata));\n   }\n \n+  private void tryAtomicDirectoryMove(final Path directory, final Path destination)\n+      throws IOException {\n+    try {\n+      Files.move(directory, destination, StandardCopyOption.ATOMIC_MOVE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1294ff39415d3736d3afe944268ee4898f7b4af7"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d5f193a801dd53edcfc805b06320c4a18bd4d07", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/1d5f193a801dd53edcfc805b06320c4a18bd4d07", "committedDate": "2020-03-24T14:04:46Z", "message": "chore(util): add FileUtil#ensureDirectoryExists"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d61f0c9bacb7ee0abd41110dcf4f20f9f76c2b6", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/0d61f0c9bacb7ee0abd41110dcf4f20f9f76c2b6", "committedDate": "2020-03-24T14:05:23Z", "message": "chore(logstreams): invalidate snapshot on consume chunk failure\n\n- handles IOExceptions on consume chunk to invalid the snapshot\n- does not invalidate snapshot anymore if a chunk already exists"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "572d7d5fb3ba443d2c66cdb576bbf2d46fd158a4", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/572d7d5fb3ba443d2c66cdb576bbf2d46fd158a4", "committedDate": "2020-03-24T14:05:23Z", "message": "chore(broker): handle snapshot commit I/O errors\n\n- properly handles snapshot commit I/O related errors instead of letting\n  them bubble up\n- attempts to perform atomic move when committing snapshot to avoid\n  having partial snapshots where applicable, with a fallback to normal\n  copy method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "513a4cd55e6515b25a93804a437b41b76226d5ee", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/513a4cd55e6515b25a93804a437b41b76226d5ee", "committedDate": "2020-03-24T14:05:23Z", "message": "chore(broker): fail writing pending snapshot if directory cannot be created"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "356ad870cd95e61f6069c355a0f91500f0c92b6d", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/356ad870cd95e61f6069c355a0f91500f0c92b6d", "committedDate": "2020-03-23T17:29:03Z", "message": "chore(broker): fail writing pending snapshot if directory cannot be created"}, "afterCommit": {"oid": "513a4cd55e6515b25a93804a437b41b76226d5ee", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/513a4cd55e6515b25a93804a437b41b76226d5ee", "committedDate": "2020-03-24T14:05:23Z", "message": "chore(broker): fail writing pending snapshot if directory cannot be created"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2913, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}