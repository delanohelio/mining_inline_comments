{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzNzM4NzYz", "number": 5977, "title": "5964 wait for end of qa run", "bodyText": "Description\n\nExtends the QA script to wait for the result of the execution\nChanges node pool to stable nodes when QA tests are being run\n\nRelated issues\ncloses #5964\ncloses #5935\nDefinition of Done\nCode changes:\n\n The changes are backwards compatibility with previous versions\n If it fixes a bug then PRs are created to backport the fix to the last two minor versions. You can trigger a backport by assigning labels (e.g. backport stable/0.25) to the PR, in case that fails you need to create backports manually.\n\nTesting:\n\n There are unit/integration tests that verify all acceptance criterias of the issue\n New tests are written to ensure backwards compatibility with further versions\n The behavior is tested manually\n The impact of the changes is verified by a benchmark\n\nDocumentation:\n\n The documentation is updated (e.g. BPMN reference, configuration, examples, get-started guides, etc.)\n New content is added to the release announcement", "createdAt": "2020-12-07T15:03:06Z", "url": "https://github.com/camunda-cloud/zeebe/pull/5977", "merged": true, "mergeCommit": {"oid": "7ac37c37c9525038d2e7d4559701522c64437497"}, "closed": true, "closedAt": "2020-12-07T19:09:28Z", "author": {"login": "pihme"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdj3-4ngFqTU0NjI5OTk4NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdj6CICABqjQwODExMTI2Nzk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2Mjk5OTg1", "url": "https://github.com/camunda-cloud/zeebe/pull/5977#pullrequestreview-546299985", "createdAt": "2020-12-07T16:10:04Z", "commit": {"oid": "9a77749624029966dee4cd3010c095467cd790cd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNjoxMDowNFrOIAuT4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNjoxNjozMVrOIAunCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyOTY2Nw==", "bodyText": "Is error.txt used for anything? Or do you just want to silence it? If that's the case, you can just redirect to /dev/null, i.e.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                \"${zbctl}\"  activate jobs \"$businessKey\" > activationresponse.txt 2>error.txt\n          \n          \n            \n                \"${zbctl}\"  activate jobs \"$businessKey\" > activationresponse.txt 2>/dev/null", "url": "https://github.com/camunda-cloud/zeebe/pull/5977#discussion_r537629667", "createdAt": "2020-12-07T16:10:04Z", "author": {"login": "npepinpe"}, "path": ".ci/scripts/distribution/qa-testbench.sh", "diffHunk": "@@ -1,7 +1,50 @@\n-#!/bin/sh -eux\n+#!/bin/bash -eux\n \n chmod +x clients/go/cmd/zbctl/dist/zbctl\n \n-alias zbctl=\"clients/go/cmd/zbctl/dist/zbctl\"\n+zbctl=\"clients/go/cmd/zbctl/dist/zbctl\"\n \n-zbctl create instance qa-protocol --variables \"${QA_RUN_VARIABLES}\"\n+\"${zbctl}\" create instance external-tool-integration --variables \"${QA_RUN_VARIABLES}\"\n+\n+businessKey=\"${BUSINESS_KEY}\"\n+\n+waiting=1\n+\n+echo \"Waiting for result of $businessKey\"\n+\n+while [ $waiting -eq 1 ]; do\n+\n+    \"${zbctl}\"  activate jobs \"$businessKey\" > activationresponse.txt 2>error.txt", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a77749624029966dee4cd3010c095467cd790cd"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYzMjMzNA==", "bodyText": "You can do\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            while [ $waiting -eq 1 ]; do\n          \n          \n            \n            while true; do\n          \n      \n    \n    \n  \n\nAnd use a break statement to break out of the loop instead of setting the variable to 1. So for example:\nwhile true ; do\n    ...\n    if [ -z \"$key\" ]; then\n        ...\n    else\n        echo \"QA run completed\"\n        break\n    fi\ndone", "url": "https://github.com/camunda-cloud/zeebe/pull/5977#discussion_r537632334", "createdAt": "2020-12-07T16:13:33Z", "author": {"login": "npepinpe"}, "path": ".ci/scripts/distribution/qa-testbench.sh", "diffHunk": "@@ -1,7 +1,50 @@\n-#!/bin/sh -eux\n+#!/bin/bash -eux\n \n chmod +x clients/go/cmd/zbctl/dist/zbctl\n \n-alias zbctl=\"clients/go/cmd/zbctl/dist/zbctl\"\n+zbctl=\"clients/go/cmd/zbctl/dist/zbctl\"\n \n-zbctl create instance qa-protocol --variables \"${QA_RUN_VARIABLES}\"\n+\"${zbctl}\" create instance external-tool-integration --variables \"${QA_RUN_VARIABLES}\"\n+\n+businessKey=\"${BUSINESS_KEY}\"\n+\n+waiting=1\n+\n+echo \"Waiting for result of $businessKey\"\n+\n+while [ $waiting -eq 1 ]; do", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a77749624029966dee4cd3010c095467cd790cd"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYzMzQwNg==", "bodyText": "With the information we have here, can we link to the result page already? Could save you time if you can just immediately click to go and see your results. Here or in the build results, whichever.", "url": "https://github.com/camunda-cloud/zeebe/pull/5977#discussion_r537633406", "createdAt": "2020-12-07T16:14:55Z", "author": {"login": "npepinpe"}, "path": ".ci/scripts/distribution/qa-testbench.sh", "diffHunk": "@@ -1,7 +1,50 @@\n-#!/bin/sh -eux\n+#!/bin/bash -eux\n \n chmod +x clients/go/cmd/zbctl/dist/zbctl\n \n-alias zbctl=\"clients/go/cmd/zbctl/dist/zbctl\"\n+zbctl=\"clients/go/cmd/zbctl/dist/zbctl\"\n \n-zbctl create instance qa-protocol --variables \"${QA_RUN_VARIABLES}\"\n+\"${zbctl}\" create instance external-tool-integration --variables \"${QA_RUN_VARIABLES}\"\n+\n+businessKey=\"${BUSINESS_KEY}\"\n+\n+waiting=1\n+\n+echo \"Waiting for result of $businessKey\"\n+\n+while [ $waiting -eq 1 ]; do\n+\n+    \"${zbctl}\"  activate jobs \"$businessKey\" > activationresponse.txt 2>error.txt\n+\n+    key=$(jq -r '.key' < activationresponse.txt)\n+\n+    if [ -z \"$key\" ]; then\n+        echo \"Still waiting\"\n+        sleep 5m\n+    else\n+        echo \"QA run completed\"\n+        waiting=0\n+    fi\n+done\n+\n+key=$(jq -r '.key' < activationresponse.txt)\n+\n+echo \"Job key is: $key\"\n+\n+variables=$(jq -r '.variables' < activationresponse.txt)\n+\n+echo \"Job variables are: $variables\"\n+\n+testResult=$(echo \"$variables\" | jq -r '.aggregatedTestResult')\n+\n+echo \"Test result is: $testResult\"\n+\n+\"${zbctl}\"  complete job \"$key\"\n+\n+if [ \"$testResult\" == \"FAILED\" ]; then\n+  echo \"Test failed\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a77749624029966dee4cd3010c095467cd790cd"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYzNDU3MA==", "bodyText": "Is dropping the time out on purpose?", "url": "https://github.com/camunda-cloud/zeebe/pull/5977#discussion_r537634570", "createdAt": "2020-12-07T16:16:31Z", "author": {"login": "npepinpe"}, "path": "Jenkinsfile", "diffHunk": "@@ -278,33 +278,41 @@ pipeline {\n                 DOCKER_GCR = credentials(\"zeebe-gcr-serviceaccount-json\")\n                 ZEEBE_AUTHORIZATION_SERVER_URL = 'https://login.cloud.ultrawombat.com/oauth/token'\n                 ZEEBE_CLIENT_ID = 'W5a4JUc3I1NIetNnodo3YTvdsRIFb12w'\n-                QA_RUN_VARIABLES = \"{\\\"zeebeImage\\\": \\\"${env.IMAGE}:${env.TAG}\\\", \\\"generationTemplate\\\": \\\"${params.GENERATION_TEMPLATE}\\\", \\\"channel\\\": \\\"Internal Dev\\\", \" +\n-                    \"\\\"branch\\\": \\\"${env.BRANCH_NAME}\\\", \\\"build\\\": \\\"${currentBuild.absoluteUrl}\\\"}\"\n+                QA_RUN_VARIABLES = \"{\\\"zeebeImage\\\": \\\"${env.IMAGE}:${env.TAG}\\\", \\\"generationTemplate\\\": \\\"${params.GENERATION_TEMPLATE}\\\", \" +\n+                                    \"\\\"channel\\\": \\\"Internal Dev\\\", \\\"branch\\\": \\\"${env.BRANCH_NAME}\\\", \\\"build\\\": \\\"${currentBuild.absoluteUrl}\\\", \" +\n+                                    \"\\\"businessKey\\\": \\\"${currentBuild.absoluteUrl}\\\", \\\"processId\\\": \\\"qa-protocol\\\"}\"\n+                BUSINESS_KEY = \"${currentBuild.absoluteUrl}\"\n             }\n \n             steps {\n-                timeout(time: shortTimeoutMinutes, unit: 'MINUTES') {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a77749624029966dee4cd3010c095467cd790cd"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2Mzg1ODgz", "url": "https://github.com/camunda-cloud/zeebe/pull/5977#pullrequestreview-546385883", "createdAt": "2020-12-07T17:44:40Z", "commit": {"oid": "9a77749624029966dee4cd3010c095467cd790cd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6db520dcea77b6713b6b6f50a67f50b35f3a8438", "author": {"user": {"login": "pihme", "name": "Peter Ihme"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/6db520dcea77b6713b6b6f50a67f50b35f3a8438", "committedDate": "2020-12-07T18:41:02Z", "message": "chore(ci): automatically collect result of QA run"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4ed7b4e1f09a673fe02a9bc0d1e3d589ff2ba20c", "author": {"user": {"login": "pihme", "name": "Peter Ihme"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/4ed7b4e1f09a673fe02a9bc0d1e3d589ff2ba20c", "committedDate": "2020-12-07T18:39:54Z", "message": "chore(ci): incorporate review feedback"}, "afterCommit": {"oid": "6db520dcea77b6713b6b6f50a67f50b35f3a8438", "author": {"user": {"login": "pihme", "name": "Peter Ihme"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/6db520dcea77b6713b6b6f50a67f50b35f3a8438", "committedDate": "2020-12-07T18:41:02Z", "message": "chore(ci): automatically collect result of QA run"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2302, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}