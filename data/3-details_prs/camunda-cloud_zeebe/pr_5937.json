{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4NzM1MTgx", "number": 5937, "title": "Decrease parallelism in CI tests", "bodyText": "Description\nThis PR decreases the parallelism in the CI tests by overriding the environment variable MAVEN_PARALLELISM when running the unit and integration tests. It reduces it to 2 for both, which means we'll run tests for two modules in parallel, and each module will run $MAVEN_PARALLELISM / 2 forks, which totals one fork per CPU. It also enforces the number of forks to 6 via the environment variable SUREFIRE_FORKCOUNT. It also introduces the possibility of overriding the fork count via an environment variable so we can play around with different values without making new changes.\nDefinition of Done\nNot all items need to be done depending on the issue and the pull request.\nCode changes:\n\n The changes are backwards compatibility with previous versions\n If it fixes a bug then PRs are created to backport the fix to the last two minor versions. You can trigger a backport by assigning labels (e.g. backport stable/0.25) to the PR, in case that fails you need to create backports manually.\n\nTesting:\n\n There are unit/integration tests that verify all acceptance criterias of the issue\n New tests are written to ensure backwards compatibility with further versions\n The behavior is tested manually\n The impact of the changes is verified by a benchmark\n\nDocumentation:\n\n The documentation is updated (e.g. BPMN reference, configuration, examples, get-started guides, etc.)\n New content is added to the release announcement", "createdAt": "2020-11-27T18:02:57Z", "url": "https://github.com/camunda-cloud/zeebe/pull/5937", "merged": true, "mergeCommit": {"oid": "b53cc7344cd248e11805a13b398f5df5f074e450"}, "closed": true, "closedAt": "2020-12-03T13:09:20Z", "author": {"login": "npepinpe"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdg4NMBABqjQwNDc3OTc1OTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiiOkqgFqTU0Mzg5OTk1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8d35a3663372a33511b2f786d7d4af456da655e5", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/8d35a3663372a33511b2f786d7d4af456da655e5", "committedDate": "2020-11-27T17:59:48Z", "message": "chore(ci): allow overriding fork count via env var"}, "afterCommit": {"oid": "65802ccbb7035fed00bf4ecab536368fac99ebec", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/65802ccbb7035fed00bf4ecab536368fac99ebec", "committedDate": "2020-11-28T08:51:46Z", "message": "chore(ci): allow overriding fork count via env var"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "65802ccbb7035fed00bf4ecab536368fac99ebec", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/65802ccbb7035fed00bf4ecab536368fac99ebec", "committedDate": "2020-11-28T08:51:46Z", "message": "chore(ci): allow overriding fork count via env var"}, "afterCommit": {"oid": "9ae1b927a61bb0eff38ad8eca3a27255dd22ba94", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/9ae1b927a61bb0eff38ad8eca3a27255dd22ba94", "committedDate": "2020-11-28T09:10:20Z", "message": "chore(ci): allow overriding fork count via env var"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9ae1b927a61bb0eff38ad8eca3a27255dd22ba94", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/9ae1b927a61bb0eff38ad8eca3a27255dd22ba94", "committedDate": "2020-11-28T09:10:20Z", "message": "chore(ci): allow overriding fork count via env var"}, "afterCommit": {"oid": "d4fad77038837cefdf8fbeef5bfeab9740b9fc04", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/d4fad77038837cefdf8fbeef5bfeab9740b9fc04", "committedDate": "2020-11-28T09:35:55Z", "message": "chore(ci): allow overriding fork count via env var"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwODAwMzY2", "url": "https://github.com/camunda-cloud/zeebe/pull/5937#pullrequestreview-540800366", "createdAt": "2020-11-30T10:59:21Z", "commit": {"oid": "d4fad77038837cefdf8fbeef5bfeab9740b9fc04"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxMDo1OToyMVrOH716tQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxMTowMzoyMVrOH72D7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjUxMTQxMw==", "bodyText": "Can you explain this statement a bit? AFAIK it reads like:\nLIMITS_CPU is whatever you define or defaults to getconf _NPROCESSORS_ONLN\nbut what is this config?", "url": "https://github.com/camunda-cloud/zeebe/pull/5937#discussion_r532511413", "createdAt": "2020-11-30T10:59:21Z", "author": {"login": "korthout"}, "path": ".ci/scripts/distribution/it-java.sh", "diffHunk": "@@ -1,13 +1,19 @@\n #!/bin/bash -eux\n \n-\n-export JAVA_TOOL_OPTIONS=\"$JAVA_TOOL_OPTIONS -XX:MaxRAMFraction=$((LIMITS_CPU))\"\n-\n+LIMITS_CPU=${LIMITS_CPU:-$(getconf _NPROCESSORS_ONLN)}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4fad77038837cefdf8fbeef5bfeab9740b9fc04"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjUxMjMyNg==", "bodyText": "Perhaps we should just default this explicitly to 1", "url": "https://github.com/camunda-cloud/zeebe/pull/5937#discussion_r532512326", "createdAt": "2020-11-30T11:00:43Z", "author": {"login": "korthout"}, "path": ".ci/scripts/distribution/it-java.sh", "diffHunk": "@@ -1,13 +1,19 @@\n #!/bin/bash -eux\n \n-\n-export JAVA_TOOL_OPTIONS=\"$JAVA_TOOL_OPTIONS -XX:MaxRAMFraction=$((LIMITS_CPU))\"\n-\n+LIMITS_CPU=${LIMITS_CPU:-$(getconf _NPROCESSORS_ONLN)}\n+FORK_COUNT=${FORK_COUNT:-}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4fad77038837cefdf8fbeef5bfeab9740b9fc04"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjUxMzc3NA==", "bodyText": "Let's also set FORK_COUNT = 2  or so, currently this PR seems to slow down the IT by a lot.", "url": "https://github.com/camunda-cloud/zeebe/pull/5937#discussion_r532513774", "createdAt": "2020-11-30T11:03:21Z", "author": {"login": "korthout"}, "path": "Jenkinsfile", "diffHunk": "@@ -215,6 +216,7 @@ pipeline {\n                         stage('Test') {\n                             environment {\n                                 SUREFIRE_REPORT_NAME_SUFFIX = 'it-testrun'\n+                                LIMITS_CPU = 2", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4fad77038837cefdf8fbeef5bfeab9740b9fc04"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwODU0MjA3", "url": "https://github.com/camunda-cloud/zeebe/pull/5937#pullrequestreview-540854207", "createdAt": "2020-11-30T12:17:18Z", "commit": {"oid": "d4fad77038837cefdf8fbeef5bfeab9740b9fc04"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d4fad77038837cefdf8fbeef5bfeab9740b9fc04", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/d4fad77038837cefdf8fbeef5bfeab9740b9fc04", "committedDate": "2020-11-28T09:35:55Z", "message": "chore(ci): allow overriding fork count via env var"}, "afterCommit": {"oid": "8f81be61eec5ef7d1909068975dfdaaad5694e19", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/8f81be61eec5ef7d1909068975dfdaaad5694e19", "committedDate": "2020-11-30T13:26:47Z", "message": "chore(ci): fix merge conflicts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwOTI2Mzk2", "url": "https://github.com/camunda-cloud/zeebe/pull/5937#pullrequestreview-540926396", "createdAt": "2020-11-30T13:52:56Z", "commit": {"oid": "7406fa2033512ee92d361af155f49e1b0b855628"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7406fa2033512ee92d361af155f49e1b0b855628", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/7406fa2033512ee92d361af155f49e1b0b855628", "committedDate": "2020-11-30T13:47:27Z", "message": "chore(ci): use yaml string"}, "afterCommit": {"oid": "861e1db03c1861ea5e46c22074bdc998f73ce8c0", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/861e1db03c1861ea5e46c22074bdc998f73ce8c0", "committedDate": "2020-11-30T13:55:47Z", "message": "chore(ci): decrease parallelism in verification stage\n\n- allow overriding LIMITS_CPU and FORK_COUNT\n- hardcode LIMITS_CPU and FORK_COUNT to 2 and 6 for unit and integration\n  tests\n- limit the max heap percentage to 100 / (LIMITS_CPU * FORK_COUNT) to\n  ensure each JVM uses a safe amount of the RAM\n- remove ununsed shared directory\n- use template for IT"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyNzEzODcw", "url": "https://github.com/camunda-cloud/zeebe/pull/5937#pullrequestreview-542713870", "createdAt": "2020-12-02T10:49:31Z", "commit": {"oid": "36743d13fb6a93bbeb87623428d2e8e2b0761a9c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "36743d13fb6a93bbeb87623428d2e8e2b0761a9c", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/36743d13fb6a93bbeb87623428d2e8e2b0761a9c", "committedDate": "2020-12-01T16:38:58Z", "message": "chore(ci): specify required profiles for going offline"}, "afterCommit": {"oid": "b44e47a50ae664b52b93cf73e2dc03776d815195", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/b44e47a50ae664b52b93cf73e2dc03776d815195", "committedDate": "2020-12-02T12:04:22Z", "message": "chore(project): apply parallel-test profile to failsafe"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b44e47a50ae664b52b93cf73e2dc03776d815195", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/b44e47a50ae664b52b93cf73e2dc03776d815195", "committedDate": "2020-12-02T12:04:22Z", "message": "chore(project): apply parallel-test profile to failsafe"}, "afterCommit": {"oid": "ebd7d60f1c2c2d53a4ed06e0c1f8c2348262cdfa", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/ebd7d60f1c2c2d53a4ed06e0c1f8c2348262cdfa", "committedDate": "2020-12-02T13:29:19Z", "message": "chore(project): apply parallel-test profile to failsafe"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyODM1OTk5", "url": "https://github.com/camunda-cloud/zeebe/pull/5937#pullrequestreview-542835999", "createdAt": "2020-12-02T13:32:12Z", "commit": {"oid": "ebd7d60f1c2c2d53a4ed06e0c1f8c2348262cdfa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxMzozMjoxMlrOH9bCyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxMzozMjoxMlrOH9bCyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDE2ODI2NA==", "bodyText": "@npepinpe don't forget this change then for the other scripts.", "url": "https://github.com/camunda-cloud/zeebe/pull/5937#discussion_r534168264", "createdAt": "2020-12-02T13:32:12Z", "author": {"login": "korthout"}, "path": ".ci/scripts/distribution/it-java.sh", "diffHunk": "@@ -17,7 +29,7 @@ if grep -q \"\\[WARNING\\] Flakes:\" ${tmpfile}; then\n \n   awk '/^\\[WARNING\\] Flakes:.*$/{flag=1}/^\\[ERROR\\] Tests run:.*Flakes: [0-9]*$/{print;flag=0}flag' ${tmpfile} > ${tmpfile2}\n \n-  grep \"\\[ERROR\\]   Run 1: \" ${tmpfile} | awk '{print $4}' >> ./target/FlakyTests.txt\n+  grep \"\\[ERROR\\]   Run 1: \" ${tmpfile2} | awk '{print $4}' >> FlakyTests.txt", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebd7d60f1c2c2d53a4ed06e0c1f8c2348262cdfa"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d4c7b98f6a7eca30847c5ff05a22dddd82e20c7", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/8d4c7b98f6a7eca30847c5ff05a22dddd82e20c7", "committedDate": "2020-12-02T13:35:39Z", "message": "chore(ci): decrease parallelism in verification stage\n\n- allow overriding LIMITS_CPU and FORK_COUNT\n- hardcode LIMITS_CPU and FORK_COUNT to 2 and 6 for unit and integration\n  tests\n- limit the max heap percentage to 100 / (LIMITS_CPU * FORK_COUNT) to\n  ensure each JVM uses a safe amount of the RAM\n- remove ununsed shared directory\n- use template for IT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "216ab34b191534c50ddb890deae33f3aca52fe93", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/216ab34b191534c50ddb890deae33f3aca52fe93", "committedDate": "2020-12-02T13:35:40Z", "message": "chore(project): apply parallel-test profile to failsafe"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ebd7d60f1c2c2d53a4ed06e0c1f8c2348262cdfa", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/ebd7d60f1c2c2d53a4ed06e0c1f8c2348262cdfa", "committedDate": "2020-12-02T13:29:19Z", "message": "chore(project): apply parallel-test profile to failsafe"}, "afterCommit": {"oid": "216ab34b191534c50ddb890deae33f3aca52fe93", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/216ab34b191534c50ddb890deae33f3aca52fe93", "committedDate": "2020-12-02T13:35:40Z", "message": "chore(project): apply parallel-test profile to failsafe"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzODk5OTU2", "url": "https://github.com/camunda-cloud/zeebe/pull/5937#pullrequestreview-543899956", "createdAt": "2020-12-03T12:23:21Z", "commit": {"oid": "216ab34b191534c50ddb890deae33f3aca52fe93"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2284, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}