{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwNDA0Njg4", "number": 4071, "title": "chore(util): fix and add tests for health monitor", "bodyText": "Description\nfixed a bug when removing a component and added a test\nRelated issues\nPull Request Checklist\n\n All commit messages match our commit message guidelines\n The submitting code follows our code style\n If submitting code, please run mvn clean install -DskipTests locally before committing", "createdAt": "2020-03-18T12:25:03Z", "url": "https://github.com/camunda-cloud/zeebe/pull/4071", "merged": true, "mergeCommit": {"oid": "62d8ebae201254b92b9c146020ee879b193000d1"}, "closed": true, "closedAt": "2020-03-19T07:35:13Z", "author": {"login": "deepthidevaki"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcO2zt1gBqjMxNDEzMTc4NjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcO3FkagBqjMxNDEzODk1NzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "16a2d4c393d6aa3fac7f3263f6c34ce00e9efcf5", "author": {"user": {"login": "deepthidevaki", "name": "Deepthi Devaki Akkoorath"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/16a2d4c393d6aa3fac7f3263f6c34ce00e9efcf5", "committedDate": "2020-03-18T12:22:32Z", "message": "chore(util): fix and add tests for health monitor"}, "afterCommit": {"oid": "dcd056bb507bf9742a1c7c6872a95003a6c524ed", "author": {"user": {"login": "deepthidevaki", "name": "Deepthi Devaki Akkoorath"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/dcd056bb507bf9742a1c7c6872a95003a6c524ed", "committedDate": "2020-03-18T12:51:53Z", "message": "chore(util): fix and add tests for health monitor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2ODQxODg4", "url": "https://github.com/camunda-cloud/zeebe/pull/4071#pullrequestreview-376841888", "createdAt": "2020-03-18T13:04:57Z", "commit": {"oid": "dcd056bb507bf9742a1c7c6872a95003a6c524ed"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMzowNDo1N1rOF4D_vQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMzowNDo1N1rOF4D_vQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMzMDA0NQ==", "bodyText": "Nit: could we extract the closures to methods? e.g.\n@Override\npublic void onFailure() {\n  actor.run(this::onComponentFailure);\n}\n\nprivate void onComponentFailure() {\n  log.error(\"{} failed, marking it as unhealthy\", componentName);\n  componentHealth.computeIfPresent(componentName, (k, v) -> HealthStatus.UNHEALTHY);\n  calculateHealth();\n}\nI have no strong arguments other than I find it more readable, but could just be me \ud83d\ude05", "url": "https://github.com/camunda-cloud/zeebe/pull/4071#discussion_r394330045", "createdAt": "2020-03-18T13:04:57Z", "author": {"login": "npepinpe"}, "path": "util/src/main/java/io/zeebe/util/health/CriticalComponentsHealthMonitor.java", "diffHunk": "@@ -131,12 +114,22 @@ private HealthStatus getHealth(final String componentName) {\n \n     @Override\n     public void onFailure() {\n-      onComponentFailure(componentName);\n+      actor.run(\n+          () -> {\n+            log.error(\"{} failed, marking it as unhealthy\", componentName);\n+            componentHealth.computeIfPresent(componentName, (k, v) -> HealthStatus.UNHEALTHY);\n+            calculateHealth();\n+          });\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dcd056bb507bf9742a1c7c6872a95003a6c524ed"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2ODQyODgw", "url": "https://github.com/camunda-cloud/zeebe/pull/4071#pullrequestreview-376842880", "createdAt": "2020-03-18T13:06:17Z", "commit": {"oid": "dcd056bb507bf9742a1c7c6872a95003a6c524ed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMzowNjoxN1rOF4EC0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMzowNjoxN1rOF4EC0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMzMDgzNQ==", "bodyText": "I like this over ControlledActorScheduler imho \ud83d\udc4d good idea", "url": "https://github.com/camunda-cloud/zeebe/pull/4071#discussion_r394330835", "createdAt": "2020-03-18T13:06:17Z", "author": {"login": "npepinpe"}, "path": "util/src/test/java/io/zeebe/util/health/CriticalComponentsHealthMonitorTest.java", "diffHunk": "@@ -0,0 +1,173 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.util.health;\n+\n+import static io.zeebe.util.TestUtil.waitUntil;\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import io.zeebe.util.sched.Actor;\n+import io.zeebe.util.sched.ActorControl;\n+import io.zeebe.util.sched.testing.ActorSchedulerRule;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.slf4j.LoggerFactory;\n+\n+public class CriticalComponentsHealthMonitorTest {\n+\n+  @Rule public ActorSchedulerRule actorSchedulerRule = new ActorSchedulerRule();\n+  private CriticalComponentsHealthMonitor monitor;\n+  private ActorControl actorControl;\n+\n+  @Before\n+  public void setup() {\n+    final Actor testActor =\n+        new Actor() {\n+          @Override\n+          public String getName() {\n+            return \"test-actor\";\n+          }\n+\n+          @Override\n+          protected void onActorStarting() {\n+            monitor = new CriticalComponentsHealthMonitor(actor, LoggerFactory.getLogger(\"test\"));\n+            actorControl = actor;\n+          }\n+\n+          @Override\n+          protected void onActorStarted() {\n+            monitor.startMonitoring();\n+          }\n+        };\n+    actorSchedulerRule.submitActor(testActor).join();\n+  }\n+\n+  @Test\n+  public void shouldMonitorComponent() {\n+    // given\n+    final ControllableComponent component = new ControllableComponent();\n+    monitor.registerComponent(\"test\", component);\n+\n+    // when\n+    waitUntilAllDone();\n+    assertThat(monitor.getHealthStatus()).isEqualTo(HealthStatus.HEALTHY);\n+\n+    component.setHealthStatus(HealthStatus.UNHEALTHY);\n+    waitUntilAllDone();\n+\n+    // then\n+    assertThat(monitor.getHealthStatus()).isEqualTo(HealthStatus.UNHEALTHY);\n+  }\n+\n+  @Test\n+  public void shouldRecover() {\n+    // given\n+    final ControllableComponent component = new ControllableComponent();\n+    monitor.registerComponent(\"test\", component);\n+    waitUntilAllDone();\n+    component.setHealthStatus(HealthStatus.UNHEALTHY);\n+    waitUntilAllDone();\n+    assertThat(monitor.getHealthStatus()).isEqualTo(HealthStatus.UNHEALTHY);\n+\n+    // when\n+    component.setHealthStatus(HealthStatus.HEALTHY);\n+    waitUntilAllDone();\n+\n+    // then\n+    assertThat(monitor.getHealthStatus()).isEqualTo(HealthStatus.HEALTHY);\n+  }\n+\n+  @Test\n+  public void shouldMonitorMultipleComponent() {\n+    // given\n+    final ControllableComponent component1 = new ControllableComponent();\n+    final ControllableComponent component2 = new ControllableComponent();\n+\n+    monitor.registerComponent(\"test1\", component1);\n+    monitor.registerComponent(\"test2\", component2);\n+\n+    waitUntilAllDone();\n+    assertThat(monitor.getHealthStatus()).isEqualTo(HealthStatus.HEALTHY);\n+\n+    // when\n+    component2.setHealthStatus(HealthStatus.UNHEALTHY);\n+    waitUntilAllDone();\n+\n+    // then\n+    assertThat(monitor.getHealthStatus()).isEqualTo(HealthStatus.UNHEALTHY);\n+\n+    // when\n+    component2.setHealthStatus(HealthStatus.HEALTHY);\n+    component1.setHealthStatus(HealthStatus.UNHEALTHY);\n+    waitUntilAllDone();\n+\n+    // then\n+    assertThat(monitor.getHealthStatus()).isEqualTo(HealthStatus.UNHEALTHY);\n+\n+    // when\n+    component1.setHealthStatus(HealthStatus.HEALTHY);\n+    waitUntilAllDone();\n+\n+    // then\n+    assertThat(monitor.getHealthStatus()).isEqualTo(HealthStatus.HEALTHY);\n+  }\n+\n+  @Test\n+  public void shouldRemoveComponent() {\n+    // given\n+    final ControllableComponent component = new ControllableComponent();\n+    monitor.registerComponent(\"test\", component);\n+    waitUntil(() -> monitor.getHealthStatus() == HealthStatus.HEALTHY);\n+\n+    // when\n+    monitor.removeComponent(\"test\");\n+    component.setHealthStatus(HealthStatus.UNHEALTHY);\n+    waitUntilAllDone();\n+\n+    // then\n+    assertThat(monitor.getHealthStatus()).isEqualTo(HealthStatus.HEALTHY);\n+  }\n+\n+  private void waitUntilAllDone() {\n+    actorControl.call(() -> null).join();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dcd056bb507bf9742a1c7c6872a95003a6c524ed"}, "originalPosition": 137}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a101f86af62e60b85bac1d17d0b0245c1555c2af", "author": {"user": {"login": "deepthidevaki", "name": "Deepthi Devaki Akkoorath"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/a101f86af62e60b85bac1d17d0b0245c1555c2af", "committedDate": "2020-03-18T13:11:42Z", "message": "chore(util): fix and add tests for health monitor"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dcd056bb507bf9742a1c7c6872a95003a6c524ed", "author": {"user": {"login": "deepthidevaki", "name": "Deepthi Devaki Akkoorath"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/dcd056bb507bf9742a1c7c6872a95003a6c524ed", "committedDate": "2020-03-18T12:51:53Z", "message": "chore(util): fix and add tests for health monitor"}, "afterCommit": {"oid": "a101f86af62e60b85bac1d17d0b0245c1555c2af", "author": {"user": {"login": "deepthidevaki", "name": "Deepthi Devaki Akkoorath"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/a101f86af62e60b85bac1d17d0b0245c1555c2af", "committedDate": "2020-03-18T13:11:42Z", "message": "chore(util): fix and add tests for health monitor"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3083, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}