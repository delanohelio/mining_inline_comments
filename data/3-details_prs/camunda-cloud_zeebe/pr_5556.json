{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwNTU0OTUx", "number": 5556, "title": "chore(atomix): expose internal raft configs", "bodyText": "Description\nExposes the following configurations:\nThe MAX_APPENDS is used to limit how many appends are send to one follower at once. Currently it is static and set to two. It is likely that this configure can help to improve the throughput. In order to test different numbers we need to make it configurable.\nThe MAX_BATCH_SIZE is used to limit how many data is sent as a batch to a follower. Currently it is static and set to 32 kb. It is likely that this configure can help to improve the throughput. In order to test different numbers we need to make it configurable.\n\nRelated issues\n\ncloses #5477\ncloses #5472\nDefinition of Done\nNot all items need to be done depending on the issue and the pull request.\nCode changes:\n\n The changes are backwards compatibility with previous versions\n If it fixes a bug then PRs are created to backport the fix to the last two minor versions\n\nTesting:\n\n There are unit/integration tests that verify all acceptance criterias of the issue\n New tests are written to ensure backwards compatibility with further versions\n The behavior is tested manually\n The impact of the changes is verified by a benchmark\n\nDocumentation:\n\n The documentation is updated (e.g. BPMN reference, configuration, examples, get-started guides, etc.)\n New content is added to the release announcement", "createdAt": "2020-10-09T12:26:53Z", "url": "https://github.com/camunda-cloud/zeebe/pull/5556", "merged": true, "mergeCommit": {"oid": "2fcaac571a474cb28801aa1c861b936db5ffe31d"}, "closed": true, "closedAt": "2020-10-12T09:14:27Z", "author": {"login": "Zelldon"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQ1R4BgH2gAyNTAwNTU0OTUxOjA1MDQ2NjlmMmYxNzMxMWU2ZTQ0NmI2MDUyYjlmM2U4M2I4ZjZkN2M=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdRiTrkgFqTUwNjE5NzM2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0504669f2f17311e6e446b6052b9f3e83b8f6d7c", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/0504669f2f17311e6e446b6052b9f3e83b8f6d7c", "committedDate": "2020-10-09T12:24:31Z", "message": "chore(atomix): expose internal raft configs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NjI5MjM3", "url": "https://github.com/camunda-cloud/zeebe/pull/5556#pullrequestreview-505629237", "createdAt": "2020-10-09T12:34:19Z", "commit": {"oid": "0504669f2f17311e6e446b6052b9f3e83b8f6d7c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMjozNDoxOVrOHfHyXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMjo0NToxOFrOHfIJbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM5NTQ4NQ==", "bodyText": "Nit: maybe we can call appending instead inFlightAppendCount? Just from the name, I kind of expected it to be a boolean flag \ud83d\ude05 I know it was already like this, but if we're already changing this code... \ud83d\udc40", "url": "https://github.com/camunda-cloud/zeebe/pull/5556#discussion_r502395485", "createdAt": "2020-10-09T12:34:19Z", "author": {"login": "npepinpe"}, "path": "atomix/cluster/src/main/java/io/atomix/raft/cluster/impl/RaftMemberContext.java", "diffHunk": "@@ -96,8 +100,9 @@ public void resetState(final RaftLog log) {\n   public boolean canAppend() {\n     return appending == 0\n         || (appendSucceeded\n-            && appending < MAX_APPENDS\n-            && System.currentTimeMillis() - (timeStats.getMean() / MAX_APPENDS) >= appendTime);\n+            && appending < maxAppendsPerMember", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0504669f2f17311e6e446b6052b9f3e83b8f6d7c"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM5ODk5Nw==", "bodyText": "Random question, I know this has nothing to do with your PR, but...I found this kind of hard to read. So we can append if the last append succeeded, the current append count is less than max appends, and the time since the last append is greater than or equal to the mean of the 8 observed last append latencies divided by the max number of appends? Did I read that right?", "url": "https://github.com/camunda-cloud/zeebe/pull/5556#discussion_r502398997", "createdAt": "2020-10-09T12:40:57Z", "author": {"login": "npepinpe"}, "path": "atomix/cluster/src/main/java/io/atomix/raft/cluster/impl/RaftMemberContext.java", "diffHunk": "@@ -96,8 +100,9 @@ public void resetState(final RaftLog log) {\n   public boolean canAppend() {\n     return appending == 0\n         || (appendSucceeded\n-            && appending < MAX_APPENDS\n-            && System.currentTimeMillis() - (timeStats.getMean() / MAX_APPENDS) >= appendTime);\n+            && appending < maxAppendsPerMember\n+            && System.currentTimeMillis() - (timeStats.getMean() / maxAppendsPerMember)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0504669f2f17311e6e446b6052b9f3e83b8f6d7c"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQwMDY0Mw==", "bodyText": "iirc, these will get serialized by kryo right? just to be safe, this should be fine from now on with the new compatible serializer, but did we test this? i guess it only breaks rolling upgrade, which is broken now anyway though \ud83e\udd14", "url": "https://github.com/camunda-cloud/zeebe/pull/5556#discussion_r502400643", "createdAt": "2020-10-09T12:43:58Z", "author": {"login": "npepinpe"}, "path": "atomix/cluster/src/main/java/io/atomix/raft/partition/RaftPartitionGroupConfig.java", "diffHunk": "@@ -37,6 +37,8 @@\n   private Duration electionTimeout = DEFAULT_ELECTION_TIMEOUT;\n   private Duration heartbeatInterval = DEFAULT_HEARTBEAT_INTERVAL;\n   private RaftStorageConfig storageConfig = new RaftStorageConfig();\n+  private int maxAppendsPerFollower = 2;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0504669f2f17311e6e446b6052b9f3e83b8f6d7c"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQwMTE1Mg==", "bodyText": "I guess we can write the real value instead of Integer.MAX_VALUE :)", "url": "https://github.com/camunda-cloud/zeebe/pull/5556#discussion_r502401152", "createdAt": "2020-10-09T12:44:54Z", "author": {"login": "npepinpe"}, "path": "broker/src/main/java/io/zeebe/broker/system/SystemContext.java", "diffHunk": "@@ -34,6 +34,9 @@\n       \"Snapshot period %s needs to be larger then or equals to one minute.\";\n   private static final String MMAP_REPLICATION_ERROR_MSG =\n       \"Using memory mapped storage level is currently unsafe with replication enabled; if you wish to use replication, set useMmap flag to false (e.g. ZEEBE_BROKER_DATA_USEMMAP=false)\";\n+  private static final String MAX_BATCH_SIZE_ERROR_MSG =\n+      \"Expected to have an append batch size maximum which is non negative and smaller then Integer.MAX_VALUE, but was '%s'.\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0504669f2f17311e6e446b6052b9f3e83b8f6d7c"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQwMTM5MA==", "bodyText": "Any reason we validate just the batch size and not the max appends?", "url": "https://github.com/camunda-cloud/zeebe/pull/5556#discussion_r502401390", "createdAt": "2020-10-09T12:45:18Z", "author": {"login": "npepinpe"}, "path": "broker/src/main/java/io/zeebe/broker/system/SystemContext.java", "diffHunk": "@@ -76,6 +79,12 @@ private void validateConfiguration() {\n       throw new IllegalArgumentException(String.format(NODE_ID_ERROR_MSG, nodeId, clusterSize));\n     }\n \n+    final var maxAppendBatchSize = cluster.getMaxAppendBatchSize();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0504669f2f17311e6e446b6052b9f3e83b8f6d7c"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f97f37fd98a09bc540920e0598ba2ea9fd6d1ecc", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/f97f37fd98a09bc540920e0598ba2ea9fd6d1ecc", "committedDate": "2020-10-09T13:49:46Z", "message": "chore(broker): follow up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b15d77c985f28c9d9a7d6f4dd72401eefbb9dda1", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/b15d77c985f28c9d9a7d6f4dd72401eefbb9dda1", "committedDate": "2020-10-10T08:28:11Z", "message": "chore(broker): introduce experimental cfg\n\n * move new configurations for raft internals to experimental cfg\n * experimental cfg are subject to change and might also contain dangerous configurations so be aware if you change something in this"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "06cefd8bac4443a5d6e28b6a75b8b9a8574e4745", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/06cefd8bac4443a5d6e28b6a75b8b9a8574e4745", "committedDate": "2020-10-10T08:07:43Z", "message": "chore(broker): introduce experimental cfg\n\n * move new configurations for raft internals to experimental cfg\n * experimental cfg are subject to change and might also contain dangerous configurations so be aware if you change something in this"}, "afterCommit": {"oid": "b15d77c985f28c9d9a7d6f4dd72401eefbb9dda1", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/b15d77c985f28c9d9a7d6f4dd72401eefbb9dda1", "committedDate": "2020-10-10T08:28:11Z", "message": "chore(broker): introduce experimental cfg\n\n * move new configurations for raft internals to experimental cfg\n * experimental cfg are subject to change and might also contain dangerous configurations so be aware if you change something in this"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MTk3MzYz", "url": "https://github.com/camunda-cloud/zeebe/pull/5556#pullrequestreview-506197363", "createdAt": "2020-10-11T16:52:13Z", "commit": {"oid": "b15d77c985f28c9d9a7d6f4dd72401eefbb9dda1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2446, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}