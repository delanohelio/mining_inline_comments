{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2MzY0MzYy", "number": 5454, "title": "Lowers log level of RequestRetriesExhaustedException in the gateway", "bodyText": "Description\nThe RequestRetriesExhaustedException exception is thrown when requests which should be retried on different partitions (e.g. create workflow or job activation) fail on all partitions for retry-able errors (e.g. not rejections). So the primary case is when back pressure kicks in, which causes an enormous amount of logging (infra team reported our bill went up by 56%). I've lowered it to trace as it can be useful when tracing the gateway to figure out why this happens, and we can now change log levels dynamically.\nIt should be backported after the PR is approved.\nDefinition of Done\nNot all items need to be done depending on the issue and the pull request.\nCode changes:\n\n The changes are backwards compatibility with previous versions\n If it fixes a bug then PRs are created to backport the fix to the last two minor versions\n\nTesting:\n\n There are unit/integration tests that verify all acceptance criterias of the issue\n New tests are written to ensure backwards compatibility with further versions\n The behavior is tested manually\n The impact of the changes is verified by a benchmark\n\nDocumentation:\n\n The documentation is updated (e.g. BPMN reference, configuration, examples, get-started guides, etc.)\n New content is added to the release announcement", "createdAt": "2020-10-01T15:49:15Z", "url": "https://github.com/camunda-cloud/zeebe/pull/5454", "merged": true, "mergeCommit": {"oid": "bc9db08a8906c97341109fdff831b44fdb8513cc"}, "closed": true, "closedAt": "2020-10-21T09:05:33Z", "author": {"login": "npepinpe"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOgiCfgFqTUwMDg5OTE4NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdTAtRrgFqTUxMDE5NjU5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwODk5MTg0", "url": "https://github.com/camunda-cloud/zeebe/pull/5454#pullrequestreview-500899184", "createdAt": "2020-10-02T07:03:49Z", "commit": {"oid": "8c9e43728c95113c51a4a4e687cb488d737c490f"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNzowMzo0OVrOHbjA8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNzowNDo0NVrOHbjCHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY0NzI4MQ==", "bodyText": "Should we set the status then to resource exhausted? As we do with the BrokerResourceExhausted exception?", "url": "https://github.com/camunda-cloud/zeebe/pull/5454#discussion_r498647281", "createdAt": "2020-10-02T07:03:49Z", "author": {"login": "Zelldon"}, "path": "gateway/src/main/java/io/zeebe/gateway/EndpointManager.java", "diffHunk": "@@ -419,6 +420,12 @@ public static StatusRuntimeException convertThrowable(final Throwable cause) {\n       status = Status.NOT_FOUND.augmentDescription(cause.getMessage());\n       Loggers.GATEWAY_LOGGER.debug(\n           \"Expected to handle gRPC request, but request could not be delivered\", cause);\n+    } else if (cause instanceof RequestRetriesExhaustedException) {\n+      // this error occurs when all partitions have exhausted for requests which have no fixed\n+      // partitions - it will then also occur when back pressure kicks in, leading to a large burst\n+      // of error logs that is, in fact, expected\n+      Loggers.GATEWAY_LOGGER.trace(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c9e43728c95113c51a4a4e687cb488d737c490f"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY0NzM4Nw==", "bodyText": "Do you think it is necessary?", "url": "https://github.com/camunda-cloud/zeebe/pull/5454#discussion_r498647387", "createdAt": "2020-10-02T07:04:09Z", "author": {"login": "Zelldon"}, "path": "gateway/src/main/java/io/zeebe/gateway/impl/broker/RequestRetriesExhaustedException.java", "diffHunk": "@@ -9,7 +9,9 @@\n \n import io.zeebe.gateway.cmd.ClientException;\n \n-class RequestRetriesExhaustedException extends ClientException {\n+public class RequestRetriesExhaustedException extends ClientException {\n+\n+  private static final long serialVersionUID = 1493435667474886479L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c9e43728c95113c51a4a4e687cb488d737c490f"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY0NzU4Mw==", "bodyText": "Previous it was unexpected error occured or what was logged and returned?", "url": "https://github.com/camunda-cloud/zeebe/pull/5454#discussion_r498647583", "createdAt": "2020-10-02T07:04:45Z", "author": {"login": "Zelldon"}, "path": "gateway/src/main/java/io/zeebe/gateway/EndpointManager.java", "diffHunk": "@@ -419,6 +420,12 @@ public static StatusRuntimeException convertThrowable(final Throwable cause) {\n       status = Status.NOT_FOUND.augmentDescription(cause.getMessage());\n       Loggers.GATEWAY_LOGGER.debug(\n           \"Expected to handle gRPC request, but request could not be delivered\", cause);\n+    } else if (cause instanceof RequestRetriesExhaustedException) {\n+      // this error occurs when all partitions have exhausted for requests which have no fixed\n+      // partitions - it will then also occur when back pressure kicks in, leading to a large burst\n+      // of error logs that is, in fact, expected\n+      Loggers.GATEWAY_LOGGER.trace(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY0NzI4MQ=="}, "originalCommit": {"oid": "8c9e43728c95113c51a4a4e687cb488d737c490f"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7e38d82f292e9f2d7d5a08ee6daf893af1d5b50", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/b7e38d82f292e9f2d7d5a08ee6daf893af1d5b50", "committedDate": "2020-10-14T11:18:52Z", "message": "chore(gateway): log retries exhausted as debug only"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26307e22060c532cca8f4585ab8e839baa1431e5", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/26307e22060c532cca8f4585ab8e839baa1431e5", "committedDate": "2020-10-14T11:20:32Z", "message": "chore(gateway): further lower log level"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8c9e43728c95113c51a4a4e687cb488d737c490f", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/8c9e43728c95113c51a4a4e687cb488d737c490f", "committedDate": "2020-10-01T15:45:38Z", "message": "chore(gateway): further lower log level"}, "afterCommit": {"oid": "2665d46bd0770d0ae09aaa36c04ba40b380fd1df", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/2665d46bd0770d0ae09aaa36c04ba40b380fd1df", "committedDate": "2020-10-14T12:23:23Z", "message": "chore(gateway): introduce error details"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2665d46bd0770d0ae09aaa36c04ba40b380fd1df", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/2665d46bd0770d0ae09aaa36c04ba40b380fd1df", "committedDate": "2020-10-14T12:23:23Z", "message": "chore(gateway): introduce error details"}, "afterCommit": {"oid": "5e34c52b8943f956f0a1f35b918288e7bd03ae14", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/5e34c52b8943f956f0a1f35b918288e7bd03ae14", "committedDate": "2020-10-14T13:35:18Z", "message": "chore(gateway): introduce error details"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5e34c52b8943f956f0a1f35b918288e7bd03ae14", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/5e34c52b8943f956f0a1f35b918288e7bd03ae14", "committedDate": "2020-10-14T13:35:18Z", "message": "chore(gateway): introduce error details"}, "afterCommit": {"oid": "40640e19228d0982ed65bdf975d11d2ee16b326a", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/40640e19228d0982ed65bdf975d11d2ee16b326a", "committedDate": "2020-10-14T13:42:14Z", "message": "chore(gateway): introduce error details"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3e7f97a5d5803bc37ac85841854bf4297746681", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/a3e7f97a5d5803bc37ac85841854bf4297746681", "committedDate": "2020-10-14T13:56:23Z", "message": "chore(gateway): introduce error details"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "40640e19228d0982ed65bdf975d11d2ee16b326a", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/40640e19228d0982ed65bdf975d11d2ee16b326a", "committedDate": "2020-10-14T13:42:14Z", "message": "chore(gateway): introduce error details"}, "afterCommit": {"oid": "a3e7f97a5d5803bc37ac85841854bf4297746681", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/a3e7f97a5d5803bc37ac85841854bf4297746681", "committedDate": "2020-10-14T13:56:23Z", "message": "chore(gateway): introduce error details"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwMTk2NTkz", "url": "https://github.com/camunda-cloud/zeebe/pull/5454#pullrequestreview-510196593", "createdAt": "2020-10-16T06:51:15Z", "commit": {"oid": "a3e7f97a5d5803bc37ac85841854bf4297746681"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2542, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}