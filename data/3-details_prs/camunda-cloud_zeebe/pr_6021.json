{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxNDA4NzI5", "number": 6021, "title": "CI scripts/pipeline clean up", "bodyText": "Description\nThis PR is a clean up effort after the various changes made in the past 3 months. It reuses the new helper functions in the Jenkinsfile as much as possible, introduces a first script library to centralize how flaky tests are analysed for easier maintainability, moves the test-compile phase of the IT agent into its prepare stage so the test stage logs are only about testing, and makes sure the way we configure Maven in built/test scripts is consistent across all scripts.\nRelated issues\nDefinition of Done\nNot all items need to be done depending on the issue and the pull request.\nCode changes:\n\n The changes are backwards compatibility with previous versions\n If it fixes a bug then PRs are created to backport the fix to the last two minor versions. You can trigger a backport by assigning labels (e.g. backport stable/0.25) to the PR, in case that fails you need to create backports manually.\n\nTesting:\n\n There are unit/integration tests that verify all acceptance criterias of the issue\n New tests are written to ensure backwards compatibility with further versions\n The behavior is tested manually\n The change has been verified by a QA run\n The impact of the changes is verified by a benchmark\n\nDocumentation:\n\n The documentation is updated (e.g. BPMN reference, configuration, examples, get-started guides, etc.)\n New content is added to the release announcement", "createdAt": "2020-12-16T20:05:02Z", "url": "https://github.com/camunda-cloud/zeebe/pull/6021", "merged": true, "mergeCommit": {"oid": "d28de0d4f7ad00800a70b407915df88c0b3e6e4e"}, "closed": true, "closedAt": "2021-01-06T14:30:24Z", "author": {"login": "npepinpe"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdm1ZPrABqjQxMjE3MjcyNTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdtf6rzgBqjQxNzUzMTExNTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fe2e747e609a8a983329cae1ec893c3334347760", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/fe2e747e609a8a983329cae1ec893c3334347760", "committedDate": "2020-12-16T20:03:57Z", "message": "chore(ci): extract utility function"}, "afterCommit": {"oid": "f9971ab0094cc8e25e5ae963e5dc10ec43cd64f5", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/f9971ab0094cc8e25e5ae963e5dc10ec43cd64f5", "committedDate": "2020-12-16T20:58:40Z", "message": "chore(ci): extract utility function"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f9971ab0094cc8e25e5ae963e5dc10ec43cd64f5", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/f9971ab0094cc8e25e5ae963e5dc10ec43cd64f5", "committedDate": "2020-12-16T20:58:40Z", "message": "chore(ci): extract utility function"}, "afterCommit": {"oid": "5c2a58d6854e93f170f69232f9c86da32733a92c", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/5c2a58d6854e93f170f69232f9c86da32733a92c", "committedDate": "2020-12-16T21:03:26Z", "message": "chore(ci): extract utility function\n\n- centralizes how flaky tests are analyzed into a single utility\n  function"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ad5783db5a4bc132d9c64801ef05b60d362d99fa", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/ad5783db5a4bc132d9c64801ef05b60d362d99fa", "committedDate": "2020-12-17T08:58:26Z", "message": "chore(ci): use correct input file"}, "afterCommit": {"oid": "33d15bb5ecd6d24a3982239736d170cc55adc060", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/33d15bb5ecd6d24a3982239736d170cc55adc060", "committedDate": "2020-12-17T10:20:08Z", "message": "chore(ci): always stash results even if empty"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "240128edef12ee760d2c115ab308beb5848326f7", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/240128edef12ee760d2c115ab308beb5848326f7", "committedDate": "2020-12-17T11:35:29Z", "message": "chore(ci): use correct ir file"}, "afterCommit": {"oid": "ddcd99bbc040e52793937034049bc9d60b08f551", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/ddcd99bbc040e52793937034049bc9d60b08f551", "committedDate": "2020-12-17T12:09:06Z", "message": "chore(ci): dry up CI pipeline\n\n- comments variables and certain non obvious steps/ordering of steps\n- reuses helper functions as much as possible in Jenkinsfile\n- ensures maven is configured in a consistent way across multiple\n  scripts, whether building or testing\n- extract test-compile and prepare offline for the IT agent into the\n  prepare phase\n- centralizes how flaky tests are analyzed into a single utility\n  function"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NTU1MTA4", "url": "https://github.com/camunda-cloud/zeebe/pull/6021#pullrequestreview-554555108", "createdAt": "2020-12-17T12:25:14Z", "commit": {"oid": "ddcd99bbc040e52793937034049bc9d60b08f551"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMjoyNToxNFrOIHzPQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMjoyNToxNFrOIHzPQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA1MDQzNA==", "bodyText": "Moved here to avoid error if there are only flaky tests in the main agent, since you cannot test if a stash is present or not", "url": "https://github.com/camunda-cloud/zeebe/pull/6021#discussion_r545050434", "createdAt": "2020-12-17T12:25:14Z", "author": {"login": "npepinpe"}, "path": "Jenkinsfile", "diffHunk": "@@ -248,20 +259,19 @@ pipeline {\n \n                             steps {\n                                 timeout(time: longTimeoutMinutes, unit: 'MINUTES') {\n-                                    unstash name: \"zeebe-build\"\n                                     runMavenContainerCommand('.ci/scripts/distribution/it-java.sh')\n                                 }\n                             }\n \n                             post {\n                                 always {\n                                     junit testResults: \"**/*/TEST*${SUREFIRE_REPORT_NAME_SUFFIX}*.xml\", keepLongStdio: true\n+                                    stash allowEmpty: true, name: itFlakyTestStashName, includes: '**/FlakyTests.txt'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ddcd99bbc040e52793937034049bc9d60b08f551"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2OTU3MjI4", "url": "https://github.com/camunda-cloud/zeebe/pull/6021#pullrequestreview-556957228", "createdAt": "2020-12-22T09:58:18Z", "commit": {"oid": "ddcd99bbc040e52793937034049bc9d60b08f551"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwOTo1ODoxOFrOIJ1TRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwOTo1ODoxOFrOIJ1TRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE4MTM4MA==", "bodyText": "This variable does not appear to be used anywhere, previously it was exported (see prev L3) and I think that may be important. Please verify", "url": "https://github.com/camunda-cloud/zeebe/pull/6021#discussion_r547181380", "createdAt": "2020-12-22T09:58:18Z", "author": {"login": "korthout"}, "path": ".ci/scripts/distribution/test-java8.sh", "diffHunk": "@@ -1,29 +1,28 @@\n #!/bin/bash -eux\n \n-export JAVA_TOOL_OPTIONS=\"$JAVA_TOOL_OPTIONS -XX:MaxRAMFraction=$((LIMITS_CPU))\"\n-\n-mvn -v\n-\n+source \"${BASH_SOURCE%/*}/../lib/flaky-tests.sh\"\n+\n+# getconf is a POSIX way to get the number of processors available which works on both Linux and macOS\n+LIMITS_CPU=${LIMITS_CPU:-$(getconf _NPROCESSORS_ONLN)}\n+MAVEN_PARALLELISM=${MAVEN_PARALLELISM:-$LIMITS_CPU}\n+SUREFIRE_FORK_COUNT=${SUREFIRE_FORK_COUNT:-}\n+MAVEN_PROPERTIES=(\n+  -DtestMavenId=3\n+  -Dsurefire.rerunFailingTestsCount=7\n+)\n tmpfile=$(mktemp)\n \n-mvn -o -B --fail-never -T$LIMITS_CPU -s ${MAVEN_SETTINGS_XML} verify -pl clients/java -DtestMavenId=3 -Dsurefire.rerunFailingTestsCount=7 | tee ${tmpfile}\n+if [ ! -z \"$SUREFIRE_FORK_COUNT\" ]; then\n+  MAVEN_PROPERTIES+=(\"-DforkCount=$SUREFIRE_FORK_COUNT\")\n+  # if we know the fork count, we can limit the max heap for each fork to ensure we're not OOM killed\n+  JAVA_TOOL_OPTIONS=\"${JAVA_TOOL_OPTIONS} -XX:MaxRAMPercentage=$((100 / ($MAVEN_PARALLELISM * $SUREFIRE_FORK_COUNT)))\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ddcd99bbc040e52793937034049bc9d60b08f551"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f761296352ac5a826c431e53eaa1c5aa7bed71e5", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/f761296352ac5a826c431e53eaa1c5aa7bed71e5", "committedDate": "2021-01-06T13:54:51Z", "message": "chore(ci): dry up CI pipeline\n\n- comments variables and certain non obvious steps/ordering of steps\n- reuses helper functions as much as possible in Jenkinsfile\n- ensures maven is configured in a consistent way across multiple\n  scripts, whether building or testing\n- extract test-compile and prepare offline for the IT agent into the\n  prepare phase\n- centralizes how flaky tests are analyzed into a single utility\n  function"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e85d70fbc267502d3e46c38f086d63ce0211b76f", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/e85d70fbc267502d3e46c38f086d63ce0211b76f", "committedDate": "2021-01-06T13:01:12Z", "message": "chore(ci): export JAVA_TOOL_OPTIONS"}, "afterCommit": {"oid": "f761296352ac5a826c431e53eaa1c5aa7bed71e5", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/f761296352ac5a826c431e53eaa1c5aa7bed71e5", "committedDate": "2021-01-06T13:54:51Z", "message": "chore(ci): dry up CI pipeline\n\n- comments variables and certain non obvious steps/ordering of steps\n- reuses helper functions as much as possible in Jenkinsfile\n- ensures maven is configured in a consistent way across multiple\n  scripts, whether building or testing\n- extract test-compile and prepare offline for the IT agent into the\n  prepare phase\n- centralizes how flaky tests are analyzed into a single utility\n  function"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2240, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}