{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2Njg2MjA3", "number": 5908, "title": "Introduce new update test build agent", "bodyText": "Description\nThis PR introduces a new update test build agent. It also defines a new podSpec for each agent and attempts to balance resources properly. I think we still overprovision, but I erred on the side of caution here just in case.\n\nThe distribution pod spec now still has a dind daemon, but much smaller as we don't expect to make such heavy use of it. Modules making use of it are, for example, the Elasticsearch exporter, the Gateway, etc., all for the integration tests. It might be a good idea in the future to also run integration tests from other modules as part of the integration stage anyway, but I would say that's outside of scope here.\nThe update-test pod spec has only the maven and dind containers, and most of the resources are for the dind container.\nThe integration-test pod spec is the same but with a different split of resources, since the maven container there needs more.\n\nI tried initially to parallelize all the steps, but as agents are not reused across stages (and idleMinutes was a no go since the pods are not tied to the lifecycle of the job).\nAs a consequence, I ended up switching so that a single verification stage which is parallel, and inside we have the usual stages (e.g. BPMN TCK, unit tests, etc.), but the integration and update ones are split to a different agents, and comprised of multiple stages.\nOne thing which might seem odd - we build the docker image before the parallel stage. That's because the various parallel stages on the main pod require the docker image to be built. Unfortunately, we can't nest parallel stages inside a parallel stage, so to run the IT and update tests at the same time as we build the original docker image, we'd need to make all the other stages sequential, which isn't ideal.\nI also added DOCKER_BUILDKIT to the environment when building the docker images to speed it up, so having it copied is not much overhead (~30s).\nRelated issues\ncloses #5873\nDefinition of Done\nNot all items need to be done depending on the issue and the pull request.\nCode changes:\n\n The changes are backwards compatibility with previous versions\n If it fixes a bug then PRs are created to backport the fix to the last two minor versions. You can trigger a backport by assigning labels (e.g. backport stable/0.25) to the PR, in case that fails you need to create backports manually.\n\nTesting:\n\n There are unit/integration tests that verify all acceptance criterias of the issue\n New tests are written to ensure backwards compatibility with further versions\n The behavior is tested manually\n The impact of the changes is verified by a benchmark\n\nDocumentation:\n\n The documentation is updated (e.g. BPMN reference, configuration, examples, get-started guides, etc.)\n New content is added to the release announcement", "createdAt": "2020-11-24T18:48:26Z", "url": "https://github.com/camunda-cloud/zeebe/pull/5908", "merged": true, "mergeCommit": {"oid": "79bf07ae9256ac60abbc5de646909477a549bf5e"}, "closed": true, "closedAt": "2020-11-25T13:00:37Z", "author": {"login": "npepinpe"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfuW_dABqjQwMzQzMzYwNzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdf9jKNABqjQwMzc4NTYwNzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c27196145e4c9e58e8cf334f2937b8c8b5730f76", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/c27196145e4c9e58e8cf334f2937b8c8b5730f76", "committedDate": "2020-11-24T17:46:44Z", "message": "chore(ci): split update tests to a separate agent\n\n- introduce new podspec for integration tests and update tests\n- reduce resource usage based on what each agent needs\n- parallelize verification stages with sequential branches for IT and UT\n  agents"}, "afterCommit": {"oid": "f28abfa5093a5c5508e0a2e8944dfc2faa392557", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/f28abfa5093a5c5508e0a2e8944dfc2faa392557", "committedDate": "2020-11-24T18:49:28Z", "message": "chore(ci): split update tests to a separate agent\n\n- introduce new podspec for integration tests and update tests\n- reduce resource usage based on what each agent needs\n- parallelize verification stages with sequential branches for IT and UT\n  agents"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f28abfa5093a5c5508e0a2e8944dfc2faa392557", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/f28abfa5093a5c5508e0a2e8944dfc2faa392557", "committedDate": "2020-11-24T18:49:28Z", "message": "chore(ci): split update tests to a separate agent\n\n- introduce new podspec for integration tests and update tests\n- reduce resource usage based on what each agent needs\n- parallelize verification stages with sequential branches for IT and UT\n  agents"}, "afterCommit": {"oid": "cfc15ca479ea9b6f56945bfcbcfde4e50abd2915", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/cfc15ca479ea9b6f56945bfcbcfde4e50abd2915", "committedDate": "2020-11-24T19:12:30Z", "message": "chore(ci): split update tests to a separate agent\n\n- introduce new podspec for integration tests and update tests\n- reduce resource usage based on what each agent needs\n- parallelize verification stages with sequential branches for IT and UT\n  agents"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cfc15ca479ea9b6f56945bfcbcfde4e50abd2915", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/cfc15ca479ea9b6f56945bfcbcfde4e50abd2915", "committedDate": "2020-11-24T19:12:30Z", "message": "chore(ci): split update tests to a separate agent\n\n- introduce new podspec for integration tests and update tests\n- reduce resource usage based on what each agent needs\n- parallelize verification stages with sequential branches for IT and UT\n  agents"}, "afterCommit": {"oid": "2e02dc07931b8c64e15c6f17864369dc644494e3", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/2e02dc07931b8c64e15c6f17864369dc644494e3", "committedDate": "2020-11-24T19:46:47Z", "message": "chore(ci): split update tests to a separate agent\n\n- introduce new podspec for integration tests and update tests\n- reduce resource usage based on what each agent needs\n- parallelize verification stages with sequential branches for IT and UT\n  agents"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2e02dc07931b8c64e15c6f17864369dc644494e3", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/2e02dc07931b8c64e15c6f17864369dc644494e3", "committedDate": "2020-11-24T19:46:47Z", "message": "chore(ci): split update tests to a separate agent\n\n- introduce new podspec for integration tests and update tests\n- reduce resource usage based on what each agent needs\n- parallelize verification stages with sequential branches for IT and UT\n  agents"}, "afterCommit": {"oid": "6e9b013b520c86a6bbd931263921aa28c67ad1d0", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/6e9b013b520c86a6bbd931263921aa28c67ad1d0", "committedDate": "2020-11-24T20:04:39Z", "message": "chore(ci): split update tests to a separate agent\n\n- introduce new podspec for integration tests and update tests\n- reduce resource usage based on what each agent needs\n- parallelize verification stages with sequential branches for IT and UT\n  agents"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MjEzNjE5", "url": "https://github.com/camunda-cloud/zeebe/pull/5908#pullrequestreview-538213619", "createdAt": "2020-11-25T07:23:10Z", "commit": {"oid": "6e9b013b520c86a6bbd931263921aa28c67ad1d0"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNzoyMzoxMFrOH5mC5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNzoyMzoxMFrOH5mC5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE1NDIxMg==", "bodyText": "I think this should be removed based on the PR's description - it's not needed and will leave the pod running for 15min after a build finished but due to using the label \"zeebe-ci-build_${buildName}\" only one build will ever use this pod.", "url": "https://github.com/camunda-cloud/zeebe/pull/5908#discussion_r530154212", "createdAt": "2020-11-25T07:23:10Z", "author": {"login": "cmur2"}, "path": "Jenkinsfile", "diffHunk": "@@ -22,7 +22,10 @@ pipeline {\n             cloud 'zeebe-ci'\n             label \"zeebe-ci-build_${buildName}\"\n             defaultContainer 'jnlp'\n-            yamlFile '.ci/podSpecs/distribution.yml'\n+            yamlFile \".ci/podSpecs/distribution.yml\"\n+            // allows the pod to remain active for reuse until the configured number of minutes\n+            // has passed since the last step was executed on it.\n+            idleMinutes 15", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e9b013b520c86a6bbd931263921aa28c67ad1d0"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MjczODAz", "url": "https://github.com/camunda-cloud/zeebe/pull/5908#pullrequestreview-538273803", "createdAt": "2020-11-25T08:54:14Z", "commit": {"oid": "6e9b013b520c86a6bbd931263921aa28c67ad1d0"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwODo1NDoxNFrOH5o93Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwOTowNDoxMFrOH5pW2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIwMjA3Nw==", "bodyText": "I noticed you updated some of the other images to newer versions, should we also do that here? Consider maven is currently at 3.6.3", "url": "https://github.com/camunda-cloud/zeebe/pull/5908#discussion_r530202077", "createdAt": "2020-11-25T08:54:14Z", "author": {"login": "korthout"}, "path": ".ci/podSpecs/distribution.yml", "diffHunk": "@@ -8,9 +8,6 @@ spec:\n     - key: \"agents-n1-standard-32-netssd-preempt\"\n       operator: \"Exists\"\n       effect: \"NoSchedule\"\n-  volumes:\n-    - name: shared-data\n-      emptyDir: {}\n   containers:\n     - name: maven\n       image: maven:3.6.0-jdk-11", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e9b013b520c86a6bbd931263921aa28c67ad1d0"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIwODQ3Mg==", "bodyText": "Can we rename this to IT and Update Test to Update? Currently, it get's truncated on my relatively large laptop screen (16\" macbook pro).", "url": "https://github.com/camunda-cloud/zeebe/pull/5908#discussion_r530208472", "createdAt": "2020-11-25T09:04:10Z", "author": {"login": "korthout"}, "path": "Jenkinsfile", "diffHunk": "@@ -142,48 +156,104 @@ pipeline {\n                     }\n                 }\n \n-                stage('IT (Java)') {\n+                stage('Integration') {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e9b013b520c86a6bbd931263921aa28c67ad1d0"}, "originalPosition": 110}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NDIwMDQz", "url": "https://github.com/camunda-cloud/zeebe/pull/5908#pullrequestreview-538420043", "createdAt": "2020-11-25T11:53:22Z", "commit": {"oid": "8c6c18f325a72f95aa4a8465997ae0f4dc75782a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1381f1a36cfda896b6d66906fa269d3e6dd9b901", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/1381f1a36cfda896b6d66906fa269d3e6dd9b901", "committedDate": "2020-11-25T12:31:20Z", "message": "chore(project): fix editorconfig for Jenkinsfile"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b7809bc572c652b7fc191fe327bc22f8d89061a", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/8b7809bc572c652b7fc191fe327bc22f8d89061a", "committedDate": "2020-11-25T12:31:21Z", "message": "chore(ci): split update tests to a separate agent\n\n- introduce new podspec for integration tests and update tests\n- reduce resource usage based on what each agent needs\n- parallelize verification stages with sequential branches for IT and UT\n  agents"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8c6c18f325a72f95aa4a8465997ae0f4dc75782a", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/8c6c18f325a72f95aa4a8465997ae0f4dc75782a", "committedDate": "2020-11-25T11:13:55Z", "message": "chore(ci): revert go image"}, "afterCommit": {"oid": "8b7809bc572c652b7fc191fe327bc22f8d89061a", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/8b7809bc572c652b7fc191fe327bc22f8d89061a", "committedDate": "2020-11-25T12:31:21Z", "message": "chore(ci): split update tests to a separate agent\n\n- introduce new podspec for integration tests and update tests\n- reduce resource usage based on what each agent needs\n- parallelize verification stages with sequential branches for IT and UT\n  agents"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2262, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}