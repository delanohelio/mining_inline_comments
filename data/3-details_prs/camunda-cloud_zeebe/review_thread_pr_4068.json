{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwMjk3Mzgx", "number": 4068, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwNTo0Mzo1OFrODpYDVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwODoxNzoxNFrODpaFHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0NzEyMjc5OnYy", "diffSide": "RIGHT", "path": "engine/src/main/java/io/zeebe/engine/processor/workflow/CatchEventBehavior.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwNTo0Mzo1OFrOF4gyVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwOTo1MDozM1rOF5NRww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDgwMTc0OQ==", "bodyText": "No need to create a new buffer for every correlation key. The buffer is copied in the calling method extractMessageCorrelationKeys().\nWe can use BufferUtil.wrapString() and put the buffer in extractedCorrelationKeys. wrapString() creates a new buffer of the given string.", "url": "https://github.com/camunda-cloud/zeebe/pull/4068#discussion_r394801749", "createdAt": "2020-03-19T05:43:58Z", "author": {"login": "saig0"}, "path": "engine/src/main/java/io/zeebe/engine/processor/workflow/CatchEventBehavior.java", "diffHunk": "@@ -211,32 +215,16 @@ private boolean unsubscribeFromMessageEvent(\n \n   private DirectBuffer extractCorrelationKey(\n       final ExecutableMessage message, final MessageCorrelationKeyContext context) {\n-    final QueryResults results =\n-        queryProcessor.process(message.getCorrelationKey(), context.getVariablesAsDocument());\n-    final String errorMessage;\n-\n-    if (results.size() == 1) {\n-      final QueryResult result = results.getSingleResult();\n-      if (result.isString()) {\n-        return result.getString();\n-      }\n \n-      if (result.isLong()) {\n-        return result.getLongAsString();\n-      }\n+    final Expression correlationKeyExpression = message.getCorrelationKeyExpression();\n \n-      errorMessage = \"the value must be either a string or a number\";\n-    } else if (results.size() > 1) {\n-      errorMessage = \"multiple values found\";\n-    } else {\n-      errorMessage = \"no value found\";\n-    }\n+    final String correlationKey =\n+        expressionProcessor.evaluateExpression(\n+            correlationKeyExpression,\n+            context.getVariablesScopeKey(),\n+            new CorrelationKeyExtractionResultHandler(context));\n \n-    final String expression = bufferAsString(message.getCorrelationKey().getExpression());\n-    final String failureMessage =\n-        String.format(\n-            \"Failed to extract the correlation-key by '%s': %s\", expression, errorMessage);\n-    throw new MessageCorrelationKeyException(context, failureMessage);\n+    return new UnsafeBuffer(correlationKey.getBytes());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1f4a1b2d99125707f9ac357eebae3276331e32e"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ4NzgyOQ==", "bodyText": "Not sure whether I got you right here, BufferUtil.wrapString() also creates a new buffer.\nI now made the following changes;\n\nextractCorrelationKey will return a String\nin extractedCorrelationKeys this String is wrapped exactly once\n\nIf you had something different in mind, please let me know. Not sure I understand the buffers yet.", "url": "https://github.com/camunda-cloud/zeebe/pull/4068#discussion_r395487829", "createdAt": "2020-03-20T08:17:59Z", "author": {"login": "pihme"}, "path": "engine/src/main/java/io/zeebe/engine/processor/workflow/CatchEventBehavior.java", "diffHunk": "@@ -211,32 +215,16 @@ private boolean unsubscribeFromMessageEvent(\n \n   private DirectBuffer extractCorrelationKey(\n       final ExecutableMessage message, final MessageCorrelationKeyContext context) {\n-    final QueryResults results =\n-        queryProcessor.process(message.getCorrelationKey(), context.getVariablesAsDocument());\n-    final String errorMessage;\n-\n-    if (results.size() == 1) {\n-      final QueryResult result = results.getSingleResult();\n-      if (result.isString()) {\n-        return result.getString();\n-      }\n \n-      if (result.isLong()) {\n-        return result.getLongAsString();\n-      }\n+    final Expression correlationKeyExpression = message.getCorrelationKeyExpression();\n \n-      errorMessage = \"the value must be either a string or a number\";\n-    } else if (results.size() > 1) {\n-      errorMessage = \"multiple values found\";\n-    } else {\n-      errorMessage = \"no value found\";\n-    }\n+    final String correlationKey =\n+        expressionProcessor.evaluateExpression(\n+            correlationKeyExpression,\n+            context.getVariablesScopeKey(),\n+            new CorrelationKeyExtractionResultHandler(context));\n \n-    final String expression = bufferAsString(message.getCorrelationKey().getExpression());\n-    final String failureMessage =\n-        String.format(\n-            \"Failed to extract the correlation-key by '%s': %s\", expression, errorMessage);\n-    throw new MessageCorrelationKeyException(context, failureMessage);\n+    return new UnsafeBuffer(correlationKey.getBytes());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDgwMTc0OQ=="}, "originalCommit": {"oid": "c1f4a1b2d99125707f9ac357eebae3276331e32e"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUzMDY5MQ==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/camunda-cloud/zeebe/pull/4068#discussion_r395530691", "createdAt": "2020-03-20T09:50:33Z", "author": {"login": "saig0"}, "path": "engine/src/main/java/io/zeebe/engine/processor/workflow/CatchEventBehavior.java", "diffHunk": "@@ -211,32 +215,16 @@ private boolean unsubscribeFromMessageEvent(\n \n   private DirectBuffer extractCorrelationKey(\n       final ExecutableMessage message, final MessageCorrelationKeyContext context) {\n-    final QueryResults results =\n-        queryProcessor.process(message.getCorrelationKey(), context.getVariablesAsDocument());\n-    final String errorMessage;\n-\n-    if (results.size() == 1) {\n-      final QueryResult result = results.getSingleResult();\n-      if (result.isString()) {\n-        return result.getString();\n-      }\n \n-      if (result.isLong()) {\n-        return result.getLongAsString();\n-      }\n+    final Expression correlationKeyExpression = message.getCorrelationKeyExpression();\n \n-      errorMessage = \"the value must be either a string or a number\";\n-    } else if (results.size() > 1) {\n-      errorMessage = \"multiple values found\";\n-    } else {\n-      errorMessage = \"no value found\";\n-    }\n+    final String correlationKey =\n+        expressionProcessor.evaluateExpression(\n+            correlationKeyExpression,\n+            context.getVariablesScopeKey(),\n+            new CorrelationKeyExtractionResultHandler(context));\n \n-    final String expression = bufferAsString(message.getCorrelationKey().getExpression());\n-    final String failureMessage =\n-        String.format(\n-            \"Failed to extract the correlation-key by '%s': %s\", expression, errorMessage);\n-    throw new MessageCorrelationKeyException(context, failureMessage);\n+    return new UnsafeBuffer(correlationKey.getBytes());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDgwMTc0OQ=="}, "originalCommit": {"oid": "c1f4a1b2d99125707f9ac357eebae3276331e32e"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0NzEzOTk3OnYy", "diffSide": "RIGHT", "path": "engine/src/main/java/io/zeebe/engine/processor/workflow/CatchEventBehavior.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwNTo1MzoyOFrOF4g8Tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwODoxODo0NFrOF5Krrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDgwNDMwMw==", "bodyText": "Why do we have a special failure message if the result is an array?\nDoes it provides more value for the user than the other message The value must be either a string or a number, but was ...?", "url": "https://github.com/camunda-cloud/zeebe/pull/4068#discussion_r394804303", "createdAt": "2020-03-19T05:53:28Z", "author": {"login": "saig0"}, "path": "engine/src/main/java/io/zeebe/engine/processor/workflow/CatchEventBehavior.java", "diffHunk": "@@ -286,4 +274,48 @@ private boolean sendOpenMessageSubscription(\n \n     return extractedCorrelationKeys;\n   }\n+\n+  protected static final class CorrelationKeyExtractionResultHandler\n+      implements ExpressionResultHandler<String> {\n+\n+    private final MessageCorrelationKeyContext context;\n+\n+    protected CorrelationKeyExtractionResultHandler(MessageCorrelationKeyContext context) {\n+      this.context = context;\n+    }\n+\n+    @Override\n+    public String handleEvaluationResult(final EvaluationResult evaluationResult) {\n+      if (evaluationResult.isFailure()) {\n+        throw new MessageCorrelationKeyException(context, evaluationResult.getFailureMessage());\n+      }\n+      if (evaluationResult.getType() == ResultType.STRING) {\n+        return evaluationResult.getString();\n+      } else if (evaluationResult.getType() == ResultType.NUMBER) {\n+\n+        final Number correlationKeyNumber = evaluationResult.getNumber();\n+        if ((correlationKeyNumber instanceof Float) || (correlationKeyNumber instanceof Double)) {\n+          final String failureMessage =\n+              String.format(\n+                  \"Failed to extract the correlation key for '%s'. Value was not an integer: %f\",\n+                  evaluationResult.getExpression(), correlationKeyNumber);\n+          throw new MessageCorrelationKeyException(context, failureMessage);\n+        }\n+\n+        return Long.toString(correlationKeyNumber.longValue());\n+      } else if (evaluationResult.getType() == ResultType.ARRAY) {\n+        final String failureMessage =\n+            String.format(\n+                \"Failed to extract the correlation key for '%s': Array of multiple values found.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1f4a1b2d99125707f9ac357eebae3276331e32e"}, "originalPosition": 123}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ4ODE3NQ==", "bodyText": "probably not, will remove this case", "url": "https://github.com/camunda-cloud/zeebe/pull/4068#discussion_r395488175", "createdAt": "2020-03-20T08:18:44Z", "author": {"login": "pihme"}, "path": "engine/src/main/java/io/zeebe/engine/processor/workflow/CatchEventBehavior.java", "diffHunk": "@@ -286,4 +274,48 @@ private boolean sendOpenMessageSubscription(\n \n     return extractedCorrelationKeys;\n   }\n+\n+  protected static final class CorrelationKeyExtractionResultHandler\n+      implements ExpressionResultHandler<String> {\n+\n+    private final MessageCorrelationKeyContext context;\n+\n+    protected CorrelationKeyExtractionResultHandler(MessageCorrelationKeyContext context) {\n+      this.context = context;\n+    }\n+\n+    @Override\n+    public String handleEvaluationResult(final EvaluationResult evaluationResult) {\n+      if (evaluationResult.isFailure()) {\n+        throw new MessageCorrelationKeyException(context, evaluationResult.getFailureMessage());\n+      }\n+      if (evaluationResult.getType() == ResultType.STRING) {\n+        return evaluationResult.getString();\n+      } else if (evaluationResult.getType() == ResultType.NUMBER) {\n+\n+        final Number correlationKeyNumber = evaluationResult.getNumber();\n+        if ((correlationKeyNumber instanceof Float) || (correlationKeyNumber instanceof Double)) {\n+          final String failureMessage =\n+              String.format(\n+                  \"Failed to extract the correlation key for '%s'. Value was not an integer: %f\",\n+                  evaluationResult.getExpression(), correlationKeyNumber);\n+          throw new MessageCorrelationKeyException(context, failureMessage);\n+        }\n+\n+        return Long.toString(correlationKeyNumber.longValue());\n+      } else if (evaluationResult.getType() == ResultType.ARRAY) {\n+        final String failureMessage =\n+            String.format(\n+                \"Failed to extract the correlation key for '%s': Array of multiple values found.\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDgwNDMwMw=="}, "originalCommit": {"oid": "c1f4a1b2d99125707f9ac357eebae3276331e32e"}, "originalPosition": 123}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0NzE2MTg0OnYy", "diffSide": "RIGHT", "path": "engine/src/main/java/io/zeebe/engine/processor/workflow/CatchEventBehavior.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwNjowNDowMVrOF4hIhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxMzoyNToxOFrOF5Th-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDgwNzQyOA==", "bodyText": "As of today, this check will never be true. The evaluation result type number is of class BigDecimal.\nI think it is safe to just call evaluationResult.getNumber().longValue().", "url": "https://github.com/camunda-cloud/zeebe/pull/4068#discussion_r394807428", "createdAt": "2020-03-19T06:04:01Z", "author": {"login": "saig0"}, "path": "engine/src/main/java/io/zeebe/engine/processor/workflow/CatchEventBehavior.java", "diffHunk": "@@ -286,4 +274,48 @@ private boolean sendOpenMessageSubscription(\n \n     return extractedCorrelationKeys;\n   }\n+\n+  protected static final class CorrelationKeyExtractionResultHandler\n+      implements ExpressionResultHandler<String> {\n+\n+    private final MessageCorrelationKeyContext context;\n+\n+    protected CorrelationKeyExtractionResultHandler(MessageCorrelationKeyContext context) {\n+      this.context = context;\n+    }\n+\n+    @Override\n+    public String handleEvaluationResult(final EvaluationResult evaluationResult) {\n+      if (evaluationResult.isFailure()) {\n+        throw new MessageCorrelationKeyException(context, evaluationResult.getFailureMessage());\n+      }\n+      if (evaluationResult.getType() == ResultType.STRING) {\n+        return evaluationResult.getString();\n+      } else if (evaluationResult.getType() == ResultType.NUMBER) {\n+\n+        final Number correlationKeyNumber = evaluationResult.getNumber();\n+        if ((correlationKeyNumber instanceof Float) || (correlationKeyNumber instanceof Double)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1f4a1b2d99125707f9ac357eebae3276331e32e"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ5MTM1Ng==", "bodyText": "That's good you mention this.\nMy intention was to make sure that numbers with fractions don't get converted to Strings.\nI cannot imagine a case in which a value of \"42.5\" is a valid correlation key.\nThe only case I could imagine it is if you have something like an article number with a dot in it (e.g. \"178.452\") and then for some reason it appears as a number rather than a string in the message. Still it is far-fetched.\nI am slightly uncomfortable about the getNumber().longValue approach because BigDecimal.of(54.5).longValue() == 54, so I wouldn't catch the fraction and thus a potential developer error.", "url": "https://github.com/camunda-cloud/zeebe/pull/4068#discussion_r395491356", "createdAt": "2020-03-20T08:26:12Z", "author": {"login": "pihme"}, "path": "engine/src/main/java/io/zeebe/engine/processor/workflow/CatchEventBehavior.java", "diffHunk": "@@ -286,4 +274,48 @@ private boolean sendOpenMessageSubscription(\n \n     return extractedCorrelationKeys;\n   }\n+\n+  protected static final class CorrelationKeyExtractionResultHandler\n+      implements ExpressionResultHandler<String> {\n+\n+    private final MessageCorrelationKeyContext context;\n+\n+    protected CorrelationKeyExtractionResultHandler(MessageCorrelationKeyContext context) {\n+      this.context = context;\n+    }\n+\n+    @Override\n+    public String handleEvaluationResult(final EvaluationResult evaluationResult) {\n+      if (evaluationResult.isFailure()) {\n+        throw new MessageCorrelationKeyException(context, evaluationResult.getFailureMessage());\n+      }\n+      if (evaluationResult.getType() == ResultType.STRING) {\n+        return evaluationResult.getString();\n+      } else if (evaluationResult.getType() == ResultType.NUMBER) {\n+\n+        final Number correlationKeyNumber = evaluationResult.getNumber();\n+        if ((correlationKeyNumber instanceof Float) || (correlationKeyNumber instanceof Double)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDgwNzQyOA=="}, "originalCommit": {"oid": "c1f4a1b2d99125707f9ac357eebae3276331e32e"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTYzMzE0NA==", "bodyText": "will do as suggested", "url": "https://github.com/camunda-cloud/zeebe/pull/4068#discussion_r395633144", "createdAt": "2020-03-20T13:25:18Z", "author": {"login": "pihme"}, "path": "engine/src/main/java/io/zeebe/engine/processor/workflow/CatchEventBehavior.java", "diffHunk": "@@ -286,4 +274,48 @@ private boolean sendOpenMessageSubscription(\n \n     return extractedCorrelationKeys;\n   }\n+\n+  protected static final class CorrelationKeyExtractionResultHandler\n+      implements ExpressionResultHandler<String> {\n+\n+    private final MessageCorrelationKeyContext context;\n+\n+    protected CorrelationKeyExtractionResultHandler(MessageCorrelationKeyContext context) {\n+      this.context = context;\n+    }\n+\n+    @Override\n+    public String handleEvaluationResult(final EvaluationResult evaluationResult) {\n+      if (evaluationResult.isFailure()) {\n+        throw new MessageCorrelationKeyException(context, evaluationResult.getFailureMessage());\n+      }\n+      if (evaluationResult.getType() == ResultType.STRING) {\n+        return evaluationResult.getString();\n+      } else if (evaluationResult.getType() == ResultType.NUMBER) {\n+\n+        final Number correlationKeyNumber = evaluationResult.getNumber();\n+        if ((correlationKeyNumber instanceof Float) || (correlationKeyNumber instanceof Double)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDgwNzQyOA=="}, "originalCommit": {"oid": "c1f4a1b2d99125707f9ac357eebae3276331e32e"}, "originalPosition": 111}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0NzE3NjM0OnYy", "diffSide": "RIGHT", "path": "engine/src/main/java/io/zeebe/engine/processor/workflow/ExpressionResultHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwNjoxMzowMFrOF4hRXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwNjoxMzowMFrOF4hRXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDgwOTY5NA==", "bodyText": "No need to create a new interface. We can use the common interface Function<EvaluationResult, T>.", "url": "https://github.com/camunda-cloud/zeebe/pull/4068#discussion_r394809694", "createdAt": "2020-03-19T06:13:00Z", "author": {"login": "saig0"}, "path": "engine/src/main/java/io/zeebe/engine/processor/workflow/ExpressionResultHandler.java", "diffHunk": "@@ -0,0 +1,15 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.engine.processor.workflow;\n+\n+import io.zeebe.el.EvaluationResult;\n+\n+public interface ExpressionResultHandler<T> {\n+\n+  T handleEvaluationResult(final EvaluationResult evaluationResult);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1f4a1b2d99125707f9ac357eebae3276331e32e"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0NzI2MDQyOnYy", "diffSide": "RIGHT", "path": "engine/src/test/java/io/zeebe/engine/processor/workflow/deployment/model/validation/ZeebeRuntimeValidationTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwNjo1Nzo1OFrOF4iEEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxMzozMDo0MFrOF5TupA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDgyMjY3NQ==", "bodyText": "In addition, we should also verify that no static value is used as a correlation key (e.g. foo). It must be always as expression (e.g. =bar).", "url": "https://github.com/camunda-cloud/zeebe/pull/4068#discussion_r394822675", "createdAt": "2020-03-19T06:57:58Z", "author": {"login": "saig0"}, "path": "engine/src/test/java/io/zeebe/engine/processor/workflow/deployment/model/validation/ZeebeRuntimeValidationTest.java", "diffHunk": "@@ -121,20 +121,20 @@\n         Bpmn.createExecutableProcess(\"process\")\n             .startEvent()\n             .intermediateCatchEvent(\"catch\")\n-            .message(b -> b.name(\"message\").zeebeCorrelationKey(INVALID_PATH_QUERY))\n+            .message(b -> b.name(\"message\").zeebeCorrelationKey(INVALID_EXPRESSION))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1f4a1b2d99125707f9ac357eebae3276331e32e"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTYzNjM4OA==", "bodyText": "wil be done as part of #4048", "url": "https://github.com/camunda-cloud/zeebe/pull/4068#discussion_r395636388", "createdAt": "2020-03-20T13:30:40Z", "author": {"login": "pihme"}, "path": "engine/src/test/java/io/zeebe/engine/processor/workflow/deployment/model/validation/ZeebeRuntimeValidationTest.java", "diffHunk": "@@ -121,20 +121,20 @@\n         Bpmn.createExecutableProcess(\"process\")\n             .startEvent()\n             .intermediateCatchEvent(\"catch\")\n-            .message(b -> b.name(\"message\").zeebeCorrelationKey(INVALID_PATH_QUERY))\n+            .message(b -> b.name(\"message\").zeebeCorrelationKey(INVALID_EXPRESSION))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDgyMjY3NQ=="}, "originalCommit": {"oid": "c1f4a1b2d99125707f9ac357eebae3276331e32e"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0NzI3MjMwOnYy", "diffSide": "RIGHT", "path": "engine/src/test/java/io/zeebe/engine/processor/workflow/CatchEventBehaviorCorrelationKeyExtractionResultHandlerTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwNzowMzo1NVrOF4iLgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwODo0NDowNFrOF5LVwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDgyNDU3OA==", "bodyText": "Why do we need to change the default locale?", "url": "https://github.com/camunda-cloud/zeebe/pull/4068#discussion_r394824578", "createdAt": "2020-03-19T07:03:55Z", "author": {"login": "saig0"}, "path": "engine/src/test/java/io/zeebe/engine/processor/workflow/CatchEventBehaviorCorrelationKeyExtractionResultHandlerTest.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.engine.processor.workflow;\n+\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import io.zeebe.el.EvaluationResult;\n+import io.zeebe.el.ResultType;\n+import io.zeebe.engine.processor.workflow.CatchEventBehavior.CorrelationKeyExtractionResultHandler;\n+import io.zeebe.engine.processor.workflow.message.MessageCorrelationKeyContext;\n+import io.zeebe.engine.processor.workflow.message.MessageCorrelationKeyException;\n+import java.util.Locale;\n+import org.assertj.core.api.Assertions;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class CatchEventBehaviorCorrelationKeyExtractionResultHandlerTest {\n+\n+  public static final String TEST_EXPRESSION = \"expression\";\n+  @Mock MessageCorrelationKeyContext mockMessageCorrelationKeyContext;\n+\n+  CorrelationKeyExtractionResultHandler sutResultHandler;\n+\n+  Locale defaultLocaleToRestore;\n+\n+  @Before\n+  public void setUp() {\n+    sutResultHandler = new CorrelationKeyExtractionResultHandler(mockMessageCorrelationKeyContext);\n+    defaultLocaleToRestore = Locale.getDefault();\n+    Locale.setDefault(Locale.US);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1f4a1b2d99125707f9ac357eebae3276331e32e"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ5ODk0NQ==", "bodyText": "It was needed because one of the error messages formats the value that was the result of the evaluation expression. This value is formatted locale-dependent.\nI now removed this from the test and instead set the locale where the message is generated:\nString.format(Locale.US, \"Failed to extra...", "url": "https://github.com/camunda-cloud/zeebe/pull/4068#discussion_r395498945", "createdAt": "2020-03-20T08:44:04Z", "author": {"login": "pihme"}, "path": "engine/src/test/java/io/zeebe/engine/processor/workflow/CatchEventBehaviorCorrelationKeyExtractionResultHandlerTest.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.engine.processor.workflow;\n+\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import io.zeebe.el.EvaluationResult;\n+import io.zeebe.el.ResultType;\n+import io.zeebe.engine.processor.workflow.CatchEventBehavior.CorrelationKeyExtractionResultHandler;\n+import io.zeebe.engine.processor.workflow.message.MessageCorrelationKeyContext;\n+import io.zeebe.engine.processor.workflow.message.MessageCorrelationKeyException;\n+import java.util.Locale;\n+import org.assertj.core.api.Assertions;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class CatchEventBehaviorCorrelationKeyExtractionResultHandlerTest {\n+\n+  public static final String TEST_EXPRESSION = \"expression\";\n+  @Mock MessageCorrelationKeyContext mockMessageCorrelationKeyContext;\n+\n+  CorrelationKeyExtractionResultHandler sutResultHandler;\n+\n+  Locale defaultLocaleToRestore;\n+\n+  @Before\n+  public void setUp() {\n+    sutResultHandler = new CorrelationKeyExtractionResultHandler(mockMessageCorrelationKeyContext);\n+    defaultLocaleToRestore = Locale.getDefault();\n+    Locale.setDefault(Locale.US);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDgyNDU3OA=="}, "originalCommit": {"oid": "c1f4a1b2d99125707f9ac357eebae3276331e32e"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0NzI4MzgxOnYy", "diffSide": "RIGHT", "path": "engine/src/test/resources/mockito-extensions/org.mockito.plugins.MockMaker", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwNzowOTo1MlrOF4iS3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwODo0ODo1NFrOF5Legw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDgyNjQ2MA==", "bodyText": "I don't feel comfortable to open this box of pandora (mocking final classes). As far as I see, we don't need to mock the MessageCorrelationKeyContext for this test.", "url": "https://github.com/camunda-cloud/zeebe/pull/4068#discussion_r394826460", "createdAt": "2020-03-19T07:09:52Z", "author": {"login": "saig0"}, "path": "engine/src/test/resources/mockito-extensions/org.mockito.plugins.MockMaker", "diffHunk": "@@ -0,0 +1 @@\n+mock-maker-inline", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1f4a1b2d99125707f9ac357eebae3276331e32e"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUwMTE4Nw==", "bodyText": "Removed it again.\nBtw, this is no longer a pandora's box.", "url": "https://github.com/camunda-cloud/zeebe/pull/4068#discussion_r395501187", "createdAt": "2020-03-20T08:48:54Z", "author": {"login": "pihme"}, "path": "engine/src/test/resources/mockito-extensions/org.mockito.plugins.MockMaker", "diffHunk": "@@ -0,0 +1 @@\n+mock-maker-inline", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDgyNjQ2MA=="}, "originalCommit": {"oid": "c1f4a1b2d99125707f9ac357eebae3276331e32e"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0NzMxMjY1OnYy", "diffSide": "RIGHT", "path": "engine/src/test/java/io/zeebe/engine/processor/workflow/CatchEventBehaviorCorrelationKeyExtractionResultHandlerTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwNzoyMjo0NFrOF4ikfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwNzoyMjo0NFrOF4ikfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDgzMDk3Mw==", "bodyText": "I'm a bit unsure about the test. I see that it makes sense to verify this behavior in a unit test because writing an integration test is more effort.\nBut the test makes some assumptions about the dependent classes that are not true for the current system. EvaluationResult returns always a BigDecimal instead of an Integer, Double, etc. I think we can reduce the test cases a bit.", "url": "https://github.com/camunda-cloud/zeebe/pull/4068#discussion_r394830973", "createdAt": "2020-03-19T07:22:44Z", "author": {"login": "saig0"}, "path": "engine/src/test/java/io/zeebe/engine/processor/workflow/CatchEventBehaviorCorrelationKeyExtractionResultHandlerTest.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.engine.processor.workflow;\n+\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import io.zeebe.el.EvaluationResult;\n+import io.zeebe.el.ResultType;\n+import io.zeebe.engine.processor.workflow.CatchEventBehavior.CorrelationKeyExtractionResultHandler;\n+import io.zeebe.engine.processor.workflow.message.MessageCorrelationKeyContext;\n+import io.zeebe.engine.processor.workflow.message.MessageCorrelationKeyException;\n+import java.util.Locale;\n+import org.assertj.core.api.Assertions;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class CatchEventBehaviorCorrelationKeyExtractionResultHandlerTest {\n+\n+  public static final String TEST_EXPRESSION = \"expression\";\n+  @Mock MessageCorrelationKeyContext mockMessageCorrelationKeyContext;\n+\n+  CorrelationKeyExtractionResultHandler sutResultHandler;\n+\n+  Locale defaultLocaleToRestore;\n+\n+  @Before\n+  public void setUp() {\n+    sutResultHandler = new CorrelationKeyExtractionResultHandler(mockMessageCorrelationKeyContext);\n+    defaultLocaleToRestore = Locale.getDefault();\n+    Locale.setDefault(Locale.US);\n+  }\n+\n+  @After\n+  public void tearDown() {\n+    Locale.setDefault(defaultLocaleToRestore);\n+  }\n+\n+  @Test\n+  public void shouldReturnStringForStringResult() {\n+    // given\n+    final EvaluationResult mockEvaluationResult = mock(EvaluationResult.class);\n+    when(mockEvaluationResult.getType()).thenReturn(ResultType.STRING);\n+    when(mockEvaluationResult.getString()).thenReturn(\"test string\");\n+\n+    // when\n+    final String actual = sutResultHandler.handleEvaluationResult(mockEvaluationResult);\n+\n+    // then\n+    Assertions.assertThat(actual).isEqualTo(\"test string\");\n+  }\n+\n+  @Test\n+  public void shouldReturnStringForIntegerNumberResult() {\n+    // given\n+    final EvaluationResult mockEvaluationResult = mock(EvaluationResult.class);\n+    when(mockEvaluationResult.getType()).thenReturn(ResultType.NUMBER);\n+    when(mockEvaluationResult.getNumber()).thenReturn(Integer.valueOf(42));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1f4a1b2d99125707f9ac357eebae3276331e32e"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0NzQxMDg2OnYy", "diffSide": "RIGHT", "path": "engine/src/main/java/io/zeebe/engine/processor/workflow/ExpressionProcessor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwODowMToyMFrOF4jgow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwODowMToyMFrOF4jgow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg0NjM3MQ==", "bodyText": "JavaDoc is missing.", "url": "https://github.com/camunda-cloud/zeebe/pull/4068#discussion_r394846371", "createdAt": "2020-03-19T08:01:20Z", "author": {"login": "saig0"}, "path": "engine/src/main/java/io/zeebe/engine/processor/workflow/ExpressionProcessor.java", "diffHunk": "@@ -62,32 +65,20 @@ public ExpressionProcessor(\n       final Expression expression, final BpmnStepContext<?> context) {\n \n     return evaluateExpression(\n-        expression, context, ResultType.BOOLEAN, EvaluationResult::getBoolean);\n+        expression,\n+        context.getKey(),\n+        new ExpressionResultTypeVerifyingIncidentRaisingHandler<Boolean>(\n+            ResultType.BOOLEAN, context, EvaluationResult::getBoolean));\n   }\n \n-  private <T> Optional<T> evaluateExpression(\n+  public <T> T evaluateExpression(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1f4a1b2d99125707f9ac357eebae3276331e32e"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0NzQ1NTAxOnYy", "diffSide": "RIGHT", "path": "engine/src/main/java/io/zeebe/engine/processor/workflow/CatchEventBehavior.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwODoxNzoxNFrOF4j9RA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwOTowMzoyNlrOF5L37g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg1MzcwMA==", "bodyText": "Instead of externalizing the behavior here, we can also create a specific method in ExpressionProcessor. Then all expression related logic (here: extract string or long as string) can be in one place and it is easy to have consistent behavior. What do you think?", "url": "https://github.com/camunda-cloud/zeebe/pull/4068#discussion_r394853700", "createdAt": "2020-03-19T08:17:14Z", "author": {"login": "saig0"}, "path": "engine/src/main/java/io/zeebe/engine/processor/workflow/CatchEventBehavior.java", "diffHunk": "@@ -286,4 +274,48 @@ private boolean sendOpenMessageSubscription(\n \n     return extractedCorrelationKeys;\n   }\n+\n+  protected static final class CorrelationKeyExtractionResultHandler", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1f4a1b2d99125707f9ac357eebae3276331e32e"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUwNzY5NA==", "bodyText": "Here I have the strongest objections.\nTo be precise, my objections are not about the conversion logic, but about the side effects.\nIn the old code, whenever I wanted to get a String, I had to pass in a BpmnStepContext and as a side effect an Incident might be raised. I was very surprised by that.\nIf I added a new method to expression processor, then this method would need to get a MessageCorrelationKeyContect and again the side effect would be a surprise. Plus, I doubt this method can be reused in many places. But I might be wrong.\nI extracted it into a class, because it made it easier for me to write the test. Before that I had it as a methd in CatchEventBehavior. But when I wrote the unit test, I had to make so many things just to call the constructor, that the dedicated class clearly was the better options.\nI don't care much about where the class lives. I hid it here, because I didn't think it could be resued. If it can be reused, I would probably move it out and alongside ExpressionResultTypeVerifyingIncidentRaisingHandler.\nTo come back to your initital intent: I think the ExpressionProcessor would make more sense, if we can factor out the side effects (raising incidents, or exceptions). So in an ideal world it would return an Either<Result, ErroMessage>. But I didn't want to make this change given the pending refactoring.", "url": "https://github.com/camunda-cloud/zeebe/pull/4068#discussion_r395507694", "createdAt": "2020-03-20T09:03:26Z", "author": {"login": "pihme"}, "path": "engine/src/main/java/io/zeebe/engine/processor/workflow/CatchEventBehavior.java", "diffHunk": "@@ -286,4 +274,48 @@ private boolean sendOpenMessageSubscription(\n \n     return extractedCorrelationKeys;\n   }\n+\n+  protected static final class CorrelationKeyExtractionResultHandler", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg1MzcwMA=="}, "originalCommit": {"oid": "c1f4a1b2d99125707f9ac357eebae3276331e32e"}, "originalPosition": 92}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4921, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}