{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1MjY4NzU5", "number": 5758, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNTowODoxNFrOE1RCbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxMzo1NDo1OVrOE3PJzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0Mjg5MTM1OnYy", "diffSide": "RIGHT", "path": "engine/src/main/java/io/zeebe/engine/processing/deployment/distribute/DeploymentDistributeProcessor.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNTowODoxNFrOHtcXWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwNDo0NzozNFrOHtzaPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQxMjY5OA==", "bodyText": "This is not really the reason right. The reason is that we will write concurrently/async a DISTRIBUTED on reprocessing which totally breaks the detection.", "url": "https://github.com/camunda-cloud/zeebe/pull/5758#discussion_r517412698", "createdAt": "2020-11-04T15:08:14Z", "author": {"login": "Zelldon"}, "path": "engine/src/main/java/io/zeebe/engine/processing/deployment/distribute/DeploymentDistributeProcessor.java", "diffHunk": "@@ -75,7 +75,13 @@ public void processRecord(\n     final DirectBuffer bufferView = new UnsafeBuffer();\n     bufferView.wrap(buffer, 0, deploymentEvent.getLength());\n \n-    distributeDeployment(key, position, bufferView, streamWriter);\n+    // don't distribute the deployment on reprocessing because it may be already distributed\n+    // instead, distribute the pending deployments after the reprocessing", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3006fdc97f8dc5d8908892a6365a34df5b0cadf5"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQxMjgxMQ==", "bodyText": "Maybe we add a link to the github issue", "url": "https://github.com/camunda-cloud/zeebe/pull/5758#discussion_r517412811", "createdAt": "2020-11-04T15:08:24Z", "author": {"login": "Zelldon"}, "path": "engine/src/main/java/io/zeebe/engine/processing/deployment/distribute/DeploymentDistributeProcessor.java", "diffHunk": "@@ -75,7 +75,13 @@ public void processRecord(\n     final DirectBuffer bufferView = new UnsafeBuffer();\n     bufferView.wrap(buffer, 0, deploymentEvent.getLength());\n \n-    distributeDeployment(key, position, bufferView, streamWriter);\n+    // don't distribute the deployment on reprocessing because it may be already distributed\n+    // instead, distribute the pending deployments after the reprocessing", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQxMjY5OA=="}, "originalCommit": {"oid": "3006fdc97f8dc5d8908892a6365a34df5b0cadf5"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc5MDI2OA==", "bodyText": "It is for both reasons \ud83d\ude05", "url": "https://github.com/camunda-cloud/zeebe/pull/5758#discussion_r517790268", "createdAt": "2020-11-05T04:47:34Z", "author": {"login": "saig0"}, "path": "engine/src/main/java/io/zeebe/engine/processing/deployment/distribute/DeploymentDistributeProcessor.java", "diffHunk": "@@ -75,7 +75,13 @@ public void processRecord(\n     final DirectBuffer bufferView = new UnsafeBuffer();\n     bufferView.wrap(buffer, 0, deploymentEvent.getLength());\n \n-    distributeDeployment(key, position, bufferView, streamWriter);\n+    // don't distribute the deployment on reprocessing because it may be already distributed\n+    // instead, distribute the pending deployments after the reprocessing", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQxMjY5OA=="}, "originalCommit": {"oid": "3006fdc97f8dc5d8908892a6365a34df5b0cadf5"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjkzMDU0OnYy", "diffSide": "RIGHT", "path": "engine/src/test/java/io/zeebe/engine/processing/streamprocessor/ReprocessingIssueDetectionMultiplePartitionTest.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNToxNjo0NlrOHtcveQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxMzo0NDowNlrOHwdJcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQxODg3Mw==", "bodyText": "Not sure whether this test makes still sense? But I thought maybe we can have a different test where we verify that we not call distribute on reprocessing. I have new logic where I can await reprocessing, which means we know whether before distribute was called. What do you think?", "url": "https://github.com/camunda-cloud/zeebe/pull/5758#discussion_r517418873", "createdAt": "2020-11-04T15:16:46Z", "author": {"login": "Zelldon"}, "path": "engine/src/test/java/io/zeebe/engine/processing/streamprocessor/ReprocessingIssueDetectionMultiplePartitionTest.java", "diffHunk": "@@ -83,8 +83,7 @@ public void setup() {\n   @Test\n   public void shouldIgnoreDeploymentDistribution() {\n     // given\n-    // force that a deployment DISTRIBUTED event is written on reprocessing which was not written on\n-    // the log stream before\n+    // the deployment can be distributed on reprocessing", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3006fdc97f8dc5d8908892a6365a34df5b0cadf5"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc5MTUzNQ==", "bodyText": "I think the test still makes sense for the detection. However, I can add another that DeploymentDistributor is not called on reprocessing. Please point me to the example :)", "url": "https://github.com/camunda-cloud/zeebe/pull/5758#discussion_r517791535", "createdAt": "2020-11-05T04:52:39Z", "author": {"login": "saig0"}, "path": "engine/src/test/java/io/zeebe/engine/processing/streamprocessor/ReprocessingIssueDetectionMultiplePartitionTest.java", "diffHunk": "@@ -83,8 +83,7 @@ public void setup() {\n   @Test\n   public void shouldIgnoreDeploymentDistribution() {\n     // given\n-    // force that a deployment DISTRIBUTED event is written on reprocessing which was not written on\n-    // the log stream before\n+    // the deployment can be distributed on reprocessing", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQxODg3Mw=="}, "originalCommit": {"oid": "3006fdc97f8dc5d8908892a6365a34df5b0cadf5"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgyMTEzMQ==", "bodyText": "https://github.com/zeebe-io/zeebe/pull/5761/files#diff-b31c3c84b754243e651147040006e4acd695b0315a1f9832f63b6e20b0a3f7f3R199-R204", "url": "https://github.com/camunda-cloud/zeebe/pull/5758#discussion_r517821131", "createdAt": "2020-11-05T06:38:30Z", "author": {"login": "Zelldon"}, "path": "engine/src/test/java/io/zeebe/engine/processing/streamprocessor/ReprocessingIssueDetectionMultiplePartitionTest.java", "diffHunk": "@@ -83,8 +83,7 @@ public void setup() {\n   @Test\n   public void shouldIgnoreDeploymentDistribution() {\n     // given\n-    // force that a deployment DISTRIBUTED event is written on reprocessing which was not written on\n-    // the log stream before\n+    // the deployment can be distributed on reprocessing", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQxODg3Mw=="}, "originalCommit": {"oid": "3006fdc97f8dc5d8908892a6365a34df5b0cadf5"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgyMTIyMQ==", "bodyText": "I think we wait until this PR is merged than you can rebase", "url": "https://github.com/camunda-cloud/zeebe/pull/5758#discussion_r517821221", "createdAt": "2020-11-05T06:38:47Z", "author": {"login": "Zelldon"}, "path": "engine/src/test/java/io/zeebe/engine/processing/streamprocessor/ReprocessingIssueDetectionMultiplePartitionTest.java", "diffHunk": "@@ -83,8 +83,7 @@ public void setup() {\n   @Test\n   public void shouldIgnoreDeploymentDistribution() {\n     // given\n-    // force that a deployment DISTRIBUTED event is written on reprocessing which was not written on\n-    // the log stream before\n+    // the deployment can be distributed on reprocessing", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQxODg3Mw=="}, "originalCommit": {"oid": "3006fdc97f8dc5d8908892a6365a34df5b0cadf5"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU3MTI0OA==", "bodyText": "Ok Chris \ud83d\ude05 I rewrote the test to verify that the deployment distributor is not invoked on reprocessing. Please have a look :)", "url": "https://github.com/camunda-cloud/zeebe/pull/5758#discussion_r520571248", "createdAt": "2020-11-10T13:44:06Z", "author": {"login": "saig0"}, "path": "engine/src/test/java/io/zeebe/engine/processing/streamprocessor/ReprocessingIssueDetectionMultiplePartitionTest.java", "diffHunk": "@@ -83,8 +83,7 @@ public void setup() {\n   @Test\n   public void shouldIgnoreDeploymentDistribution() {\n     // given\n-    // force that a deployment DISTRIBUTED event is written on reprocessing which was not written on\n-    // the log stream before\n+    // the deployment can be distributed on reprocessing", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQxODg3Mw=="}, "originalCommit": {"oid": "3006fdc97f8dc5d8908892a6365a34df5b0cadf5"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2MzU1NDA3OnYy", "diffSide": "RIGHT", "path": "engine/src/test/java/io/zeebe/engine/processing/deployment/DeploymentReprocessingTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxMzo1NDo1OVrOHwdnsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwNDo1Mjo0N1rOHw-LXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU3ODk5Mg==", "bodyText": "We could reset the count after verification. What do you think?", "url": "https://github.com/camunda-cloud/zeebe/pull/5758#discussion_r520578992", "createdAt": "2020-11-10T13:54:59Z", "author": {"login": "Zelldon"}, "path": "engine/src/test/java/io/zeebe/engine/processing/deployment/DeploymentReprocessingTest.java", "diffHunk": "@@ -33,82 +30,57 @@\n import org.junit.Rule;\n import org.junit.Test;\n \n-public final class ReprocessingIssueDetectionMultiplePartitionTest {\n+public final class DeploymentReprocessingTest {\n \n-  private static final int PARTITION_COUNT = 2;\n+  private static final int PARTITION_COUNT = 1;\n+  private static final int DEPLOYMENT_DISTRIBUTION_ON_PROCESSING = 1;\n \n   @Rule\n   public final RecordingExporterTestWatcher recordingExporterTestWatcher =\n       new RecordingExporterTestWatcher();\n \n   private final DeploymentDistributorMock deploymentDistributorMock =\n-      new DeploymentDistributorMock();\n+      spy(new DeploymentDistributorMock());\n \n   @Rule\n   public final EngineRule engine =\n       EngineRule.multiplePartition(PARTITION_COUNT)\n           .withDeploymentDistributor(deploymentDistributorMock);\n \n-  private long workflowInstanceKey;\n-  private Record<JobRecordValue> jobCreated;\n-\n   @Before\n   public void setup() {\n-    // avoid that a deployment is distributed\n-    deploymentDistributorMock.pushDeploymentCallback = CompletableActorFuture::new;\n+    // complete the deployment distribution immediately to write the DISTRIBUTED event\n+    deploymentDistributorMock.pushDeploymentCallback = () -> CompletableActorFuture.completed(null);\n \n     engine\n         .deployment()\n-        .withXmlResource(\n-            Bpmn.createExecutableProcess(\"process\")\n-                .startEvent()\n-                .serviceTask(\"task\", t -> t.zeebeJobType(\"test\"))\n-                .done())\n+        .withXmlResource(Bpmn.createExecutableProcess(\"process\").startEvent().done())\n         .expectCreated()\n         .deploy();\n \n-    workflowInstanceKey = engine.workflowInstance().ofBpmnProcessId(\"process\").create();\n-    jobCreated = RecordingExporter.jobRecords(JobIntent.CREATED).getFirst();\n-\n-    assertThat(\n-            RecordingExporter.records()\n-                .limit(r -> r.getPosition() > jobCreated.getPosition())\n-                .withValueType(ValueType.DEPLOYMENT))\n-        .extracting(Record::getIntent)\n-        .doesNotContain(DeploymentIntent.DISTRIBUTED);\n+    RecordingExporter.deploymentRecords(DeploymentIntent.DISTRIBUTED).await();\n \n     engine.stop();\n+\n+    // the deployment is distributed once on processing\n+    verify(deploymentDistributorMock, times(DEPLOYMENT_DISTRIBUTION_ON_PROCESSING))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a31815d2695d882286d4662eb1377a1dfca83ec"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTExMjQxMg==", "bodyText": "Good point. I applied your hint. Please have a look \ud83d\udc40", "url": "https://github.com/camunda-cloud/zeebe/pull/5758#discussion_r521112412", "createdAt": "2020-11-11T04:52:47Z", "author": {"login": "saig0"}, "path": "engine/src/test/java/io/zeebe/engine/processing/deployment/DeploymentReprocessingTest.java", "diffHunk": "@@ -33,82 +30,57 @@\n import org.junit.Rule;\n import org.junit.Test;\n \n-public final class ReprocessingIssueDetectionMultiplePartitionTest {\n+public final class DeploymentReprocessingTest {\n \n-  private static final int PARTITION_COUNT = 2;\n+  private static final int PARTITION_COUNT = 1;\n+  private static final int DEPLOYMENT_DISTRIBUTION_ON_PROCESSING = 1;\n \n   @Rule\n   public final RecordingExporterTestWatcher recordingExporterTestWatcher =\n       new RecordingExporterTestWatcher();\n \n   private final DeploymentDistributorMock deploymentDistributorMock =\n-      new DeploymentDistributorMock();\n+      spy(new DeploymentDistributorMock());\n \n   @Rule\n   public final EngineRule engine =\n       EngineRule.multiplePartition(PARTITION_COUNT)\n           .withDeploymentDistributor(deploymentDistributorMock);\n \n-  private long workflowInstanceKey;\n-  private Record<JobRecordValue> jobCreated;\n-\n   @Before\n   public void setup() {\n-    // avoid that a deployment is distributed\n-    deploymentDistributorMock.pushDeploymentCallback = CompletableActorFuture::new;\n+    // complete the deployment distribution immediately to write the DISTRIBUTED event\n+    deploymentDistributorMock.pushDeploymentCallback = () -> CompletableActorFuture.completed(null);\n \n     engine\n         .deployment()\n-        .withXmlResource(\n-            Bpmn.createExecutableProcess(\"process\")\n-                .startEvent()\n-                .serviceTask(\"task\", t -> t.zeebeJobType(\"test\"))\n-                .done())\n+        .withXmlResource(Bpmn.createExecutableProcess(\"process\").startEvent().done())\n         .expectCreated()\n         .deploy();\n \n-    workflowInstanceKey = engine.workflowInstance().ofBpmnProcessId(\"process\").create();\n-    jobCreated = RecordingExporter.jobRecords(JobIntent.CREATED).getFirst();\n-\n-    assertThat(\n-            RecordingExporter.records()\n-                .limit(r -> r.getPosition() > jobCreated.getPosition())\n-                .withValueType(ValueType.DEPLOYMENT))\n-        .extracting(Record::getIntent)\n-        .doesNotContain(DeploymentIntent.DISTRIBUTED);\n+    RecordingExporter.deploymentRecords(DeploymentIntent.DISTRIBUTED).await();\n \n     engine.stop();\n+\n+    // the deployment is distributed once on processing\n+    verify(deploymentDistributorMock, times(DEPLOYMENT_DISTRIBUTION_ON_PROCESSING))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU3ODk5Mg=="}, "originalCommit": {"oid": "9a31815d2695d882286d4662eb1377a1dfca83ec"}, "originalPosition": 90}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 117, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}