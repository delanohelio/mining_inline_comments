{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzOTE1NzQz", "number": 5979, "title": "Fixes outdated topology when no new leader is assigned", "bodyText": "Description\nThis PR fixes a bug in the gateway topology. The topology manager keeps track of who is leader and follower for each partition. This information is gossiped by all nodes in the cluster. Normally, when a node which was leader for partition 1 sends that it is now follower, another node will send that it is leader. There's an edge case, however, when no other node sends that it is the leader. In this case, we end up with a topology where a node is both leader and follower. This means that we report the wrong topology and that the gateway will keep trying to route requests to the node. The case where no new node becomes leader can happen due to network partitioning, for example, and is an expected case we should be able to tolerate.\nThis PR adds more test coverage and fixes the issue by removing the old partition leader if, when adding a new follower, they have the same ID.\nRelated issues\n\ncloses #2501\nDefinition of Done\nNot all items need to be done depending on the issue and the pull request.\nCode changes:\n\n The changes are backwards compatibility with previous versions\n If it fixes a bug then PRs are created to backport the fix to the last two minor versions. You can trigger a backport by assigning labels (e.g. backport stable/0.25) to the PR, in case that fails you need to create backports manually.\n\nTesting:\n\n There are unit/integration tests that verify all acceptance criterias of the issue\n New tests are written to ensure backwards compatibility with further versions\n The behavior is tested manually\n The impact of the changes is verified by a benchmark\n\nDocumentation:\n\n The documentation is updated (e.g. BPMN reference, configuration, examples, get-started guides, etc.)\n New content is added to the release announcement", "createdAt": "2020-12-07T20:04:09Z", "url": "https://github.com/camunda-cloud/zeebe/pull/5979", "merged": true, "mergeCommit": {"oid": "c4ab98730d4defefbdea5e1cacb47f79fe21f168"}, "closed": true, "closedAt": "2020-12-14T13:50:09Z", "author": {"login": "npepinpe"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkZ3pZgFqTU0NzkwNzkxMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmFQhqABqjQxMDkwNjE4MTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3OTA3OTEx", "url": "https://github.com/camunda-cloud/zeebe/pull/5979#pullrequestreview-547907911", "createdAt": "2020-12-09T07:38:14Z", "commit": {"oid": "d7fcbce71211b6d7283b1335191cc35ed94e9b2c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwNzozODoxNVrOICGb3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwNzozODoxNVrOICGb3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA3MzUwMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        .filter(PartitionInfo::isLeader)\n          \n          \n            \n                        .filter(Predicate.not(PartitionInfo::isLeader))", "url": "https://github.com/camunda-cloud/zeebe/pull/5979#discussion_r539073501", "createdAt": "2020-12-09T07:38:15Z", "author": {"login": "deepthidevaki"}, "path": "test-util/src/main/java/io/zeebe/test/util/asserts/TopologyAssert.java", "diffHunk": "@@ -44,6 +47,25 @@ public final TopologyAssert isComplete(final int clusterSize, final int partitio\n           partitionCount, brokersWithUnexpectedPartitionCount);\n     }\n \n+    final Set<Integer> partitionsWithLeader =\n+        brokers.stream()\n+            .flatMap(b -> b.getPartitions().stream())\n+            .filter(PartitionInfo::isLeader)\n+            .map(PartitionInfo::getPartitionId)\n+            .collect(Collectors.toUnmodifiableSet());\n+    final Set<Integer> partitionsWithoutLeader =\n+        brokers.stream()\n+            .flatMap(b -> b.getPartitions().stream())\n+            .filter(PartitionInfo::isLeader)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7fcbce71211b6d7283b1335191cc35ed94e9b2c"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MTUwNjMy", "url": "https://github.com/camunda-cloud/zeebe/pull/5979#pullrequestreview-548150632", "createdAt": "2020-12-09T12:51:28Z", "commit": {"oid": "01dddc27c784d0ef163cdb0a1b8637665227ee1d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMjo1MToyOFrOICTERA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMjo1MToyOFrOICTERA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI4MDQ1Mg==", "bodyText": "The javadoc from failWithMessage actually recommends using throw failure instead, as the compiler can now realize we're throwing an error (whereas with failWithMessage it thinks execution will continue).", "url": "https://github.com/camunda-cloud/zeebe/pull/5979#discussion_r539280452", "createdAt": "2020-12-09T12:51:28Z", "author": {"login": "npepinpe"}, "path": "test-util/src/main/java/io/zeebe/test/util/asserts/TopologyAssert.java", "diffHunk": "@@ -30,7 +32,7 @@ public final TopologyAssert isComplete(final int clusterSize, final int partitio\n     final List<BrokerInfo> brokers = actual.getBrokers();\n \n     if (brokers.size() != clusterSize) {\n-      failWithMessage(\"Expected broker count to be <%s> but was <%s>\", clusterSize, brokers.size());\n+      throw failure(\"Expected broker count to be <%s> but was <%s>\", clusterSize, brokers.size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01dddc27c784d0ef163cdb0a1b8637665227ee1d"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MzQ0NzQx", "url": "https://github.com/camunda-cloud/zeebe/pull/5979#pullrequestreview-548344741", "createdAt": "2020-12-09T16:08:09Z", "commit": {"oid": "01dddc27c784d0ef163cdb0a1b8637665227ee1d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "01dddc27c784d0ef163cdb0a1b8637665227ee1d", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/01dddc27c784d0ef163cdb0a1b8637665227ee1d", "committedDate": "2020-12-09T12:44:19Z", "message": "chore(qa): simplify set difference"}, "afterCommit": {"oid": "11a295ac06530ae107caf4ba45564b55e4514276", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/11a295ac06530ae107caf4ba45564b55e4514276", "committedDate": "2020-12-09T16:09:50Z", "message": "chore(qa): add topology fault tolerance tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23abda69e10fc9a506d3af722781b0c7926af0ba", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/23abda69e10fc9a506d3af722781b0c7926af0ba", "committedDate": "2020-12-14T12:53:47Z", "message": "fix(gateway): fix outdated leader when no other leader\n\n- fixes an issue in the gateway topology when the old leader becomes\n  follower, and no new node is elected leader yet, by removing the new\n  follower if it's still identified as the leader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4285ff42c3d4e135e4bb563676992a8f3bd83828", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/4285ff42c3d4e135e4bb563676992a8f3bd83828", "committedDate": "2020-12-14T12:53:47Z", "message": "chore(test-util): update definition of complete topology\n\n- TopologyAssert#isComplete now also checks that all partitions have a\n  leader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87cddba911bbb50328fa968d39b99ef70e54d2e2", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/87cddba911bbb50328fa968d39b99ef70e54d2e2", "committedDate": "2020-12-14T12:53:48Z", "message": "chore(qa): add topology fault tolerance tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "11a295ac06530ae107caf4ba45564b55e4514276", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/11a295ac06530ae107caf4ba45564b55e4514276", "committedDate": "2020-12-09T16:09:50Z", "message": "chore(qa): add topology fault tolerance tests"}, "afterCommit": {"oid": "87cddba911bbb50328fa968d39b99ef70e54d2e2", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/87cddba911bbb50328fa968d39b99ef70e54d2e2", "committedDate": "2020-12-14T12:53:48Z", "message": "chore(qa): add topology fault tolerance tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2305, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}