{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyMzY4MTg3", "number": 5106, "title": "fix(broker): compact after exporters removed", "bodyText": "Description\nFirst installs exporter director to clean up the state correctly. Closes the exporter director afterwards, if no more exporters are configured.\n\nRelated issues\n\ncloses #5105\nDefinition of Done\nNot all items need to be done depending on the issue and the pull request.\nCode changes:\n\n The changes are backwards compatibility with previous versions\n If it fixes a bug then PRs are created to backport the fix to the last two minor versions\n\nTesting:\n\n There are unit/integration tests that verify all acceptance criterias of the issue\n New tests are written to ensure backwards compatibility with further versions\n The behavior is tested manually\n The impact of the changes is verified by a benchmark\n\nDocumentation:\n\n The documentation is updated (e.g. BPMN reference, configuration, examples, get-started guides, etc.)\n New content is added to the release announcement", "createdAt": "2020-08-03T19:58:17Z", "url": "https://github.com/camunda-cloud/zeebe/pull/5106", "merged": true, "mergeCommit": {"oid": "3fb0c49442cf47ecc7bda66411ddcbc6b03f7f5f"}, "closed": true, "closedAt": "2020-08-05T07:42:24Z", "author": {"login": "Zelldon"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7jHYMgFqTQ2MDYyMDI2Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc70d1iABqjM2MjMwNzQ2MTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNjIwMjYy", "url": "https://github.com/camunda-cloud/zeebe/pull/5106#pullrequestreview-460620262", "createdAt": "2020-08-04T08:50:20Z", "commit": {"oid": "6bec3f7e27d77eb13f5528b14ccb1289ca13da86"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwODo1MDoyMVrOG7XPHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwOToxMToxMFrOG7X-Dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg5OTg2OQ==", "bodyText": "I think you can use clusteringRule.restartBroker(0); here.", "url": "https://github.com/camunda-cloud/zeebe/pull/5106#discussion_r464899869", "createdAt": "2020-08-04T08:50:21Z", "author": {"login": "korthout"}, "path": "qa/integration-tests/src/test/java/io/zeebe/broker/it/clustering/SingleBrokerDataDeletionTest.java", "diffHunk": "@@ -113,12 +114,42 @@ public void shouldNotCompactNotExportedEvents() {\n                     .isLessThan(segmentsBeforeSnapshot));\n   }\n \n-  private void fillSegments(final Broker broker, final int segmentCount) {\n+  @Test\n+  public void shouldCompactWhenExporterHasBeenRemoved() {\n+    // given\n+    final Broker broker = clusteringRule.getBroker(0);\n+    ControllableExporter.updatePosition(true);\n+    fillSegments(broker, SEGMENT_COUNT);\n+    clusteringRule.getClock().addTime(SNAPSHOT_PERIOD);\n+    // create first snapshot with exporter positions\n+    final var firstSnapshot = clusteringRule.waitForSnapshotAtBroker(broker);\n \n-    while (getSegmentsCount(broker) <= segmentCount) {\n-      writeToLog();\n-      writtenRecords.incrementAndGet();\n-    }\n+    // restart with no exporter\n+    final var brokerCfg = clusteringRule.getBrokerCfg(0);\n+    brokerCfg.setExporters(Map.of());\n+    clusteringRule.stopBroker(0);\n+    clusteringRule.startBroker(0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bec3f7e27d77eb13f5528b14ccb1289ca13da86"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkxMTg4Ng==", "bodyText": "could we close the actor sooner if we anyways know there are no exporters? or is the point of this change to do this after the state.setPosition above here at line 222?", "url": "https://github.com/camunda-cloud/zeebe/pull/5106#discussion_r464911886", "createdAt": "2020-08-04T09:11:10Z", "author": {"login": "korthout"}, "path": "broker/src/main/java/io/zeebe/broker/exporter/stream/ExporterDirector.java", "diffHunk": "@@ -227,7 +227,11 @@ private void onSnapshotRecovered() {\n \n     clearExporterState();\n \n-    actor.submit(this::readNextEvent);\n+    if (state.hasExporters()) {\n+      actor.submit(this::readNextEvent);\n+    } else {\n+      actor.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bec3f7e27d77eb13f5528b14ccb1289ca13da86"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNjUxMjU3", "url": "https://github.com/camunda-cloud/zeebe/pull/5106#pullrequestreview-460651257", "createdAt": "2020-08-04T09:32:23Z", "commit": {"oid": "6bec3f7e27d77eb13f5528b14ccb1289ca13da86"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6aeea6ae4bbe8b2c30928ea086e6b1d491220386", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/6aeea6ae4bbe8b2c30928ea086e6b1d491220386", "committedDate": "2020-08-05T05:35:06Z", "message": "fix(broker): compact after exporters removed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6bec3f7e27d77eb13f5528b14ccb1289ca13da86", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/6bec3f7e27d77eb13f5528b14ccb1289ca13da86", "committedDate": "2020-08-03T19:56:22Z", "message": "fix(broker): compact after exporters removed"}, "afterCommit": {"oid": "6aeea6ae4bbe8b2c30928ea086e6b1d491220386", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/6aeea6ae4bbe8b2c30928ea086e6b1d491220386", "committedDate": "2020-08-05T05:35:06Z", "message": "fix(broker): compact after exporters removed"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2624, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}