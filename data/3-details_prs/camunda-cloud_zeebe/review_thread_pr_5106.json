{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyMzY4MTg3", "number": 5106, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwODo1MDoyMVrOEU6DoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwOToxMToxMFrOEU6hqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMzU4MTc2OnYy", "diffSide": "RIGHT", "path": "qa/integration-tests/src/test/java/io/zeebe/broker/it/clustering/SingleBrokerDataDeletionTest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwODo1MDoyMVrOG7XPHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwOTozMToyM1rOG7YsHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg5OTg2OQ==", "bodyText": "I think you can use clusteringRule.restartBroker(0); here.", "url": "https://github.com/camunda-cloud/zeebe/pull/5106#discussion_r464899869", "createdAt": "2020-08-04T08:50:21Z", "author": {"login": "korthout"}, "path": "qa/integration-tests/src/test/java/io/zeebe/broker/it/clustering/SingleBrokerDataDeletionTest.java", "diffHunk": "@@ -113,12 +114,42 @@ public void shouldNotCompactNotExportedEvents() {\n                     .isLessThan(segmentsBeforeSnapshot));\n   }\n \n-  private void fillSegments(final Broker broker, final int segmentCount) {\n+  @Test\n+  public void shouldCompactWhenExporterHasBeenRemoved() {\n+    // given\n+    final Broker broker = clusteringRule.getBroker(0);\n+    ControllableExporter.updatePosition(true);\n+    fillSegments(broker, SEGMENT_COUNT);\n+    clusteringRule.getClock().addTime(SNAPSHOT_PERIOD);\n+    // create first snapshot with exporter positions\n+    final var firstSnapshot = clusteringRule.waitForSnapshotAtBroker(broker);\n \n-    while (getSegmentsCount(broker) <= segmentCount) {\n-      writeToLog();\n-      writtenRecords.incrementAndGet();\n-    }\n+    // restart with no exporter\n+    final var brokerCfg = clusteringRule.getBrokerCfg(0);\n+    brokerCfg.setExporters(Map.of());\n+    clusteringRule.stopBroker(0);\n+    clusteringRule.startBroker(0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bec3f7e27d77eb13f5528b14ccb1289ca13da86"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkyMDU4MA==", "bodyText": "No I can't because It waits for a new leader, which is not possible on a single node. I tried it before with that :D", "url": "https://github.com/camunda-cloud/zeebe/pull/5106#discussion_r464920580", "createdAt": "2020-08-04T09:25:54Z", "author": {"login": "Zelldon"}, "path": "qa/integration-tests/src/test/java/io/zeebe/broker/it/clustering/SingleBrokerDataDeletionTest.java", "diffHunk": "@@ -113,12 +114,42 @@ public void shouldNotCompactNotExportedEvents() {\n                     .isLessThan(segmentsBeforeSnapshot));\n   }\n \n-  private void fillSegments(final Broker broker, final int segmentCount) {\n+  @Test\n+  public void shouldCompactWhenExporterHasBeenRemoved() {\n+    // given\n+    final Broker broker = clusteringRule.getBroker(0);\n+    ControllableExporter.updatePosition(true);\n+    fillSegments(broker, SEGMENT_COUNT);\n+    clusteringRule.getClock().addTime(SNAPSHOT_PERIOD);\n+    // create first snapshot with exporter positions\n+    final var firstSnapshot = clusteringRule.waitForSnapshotAtBroker(broker);\n \n-    while (getSegmentsCount(broker) <= segmentCount) {\n-      writeToLog();\n-      writtenRecords.incrementAndGet();\n-    }\n+    // restart with no exporter\n+    final var brokerCfg = clusteringRule.getBrokerCfg(0);\n+    brokerCfg.setExporters(Map.of());\n+    clusteringRule.stopBroker(0);\n+    clusteringRule.startBroker(0);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg5OTg2OQ=="}, "originalCommit": {"oid": "6bec3f7e27d77eb13f5528b14ccb1289ca13da86"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkyMzY3OA==", "bodyText": "Ah good point.", "url": "https://github.com/camunda-cloud/zeebe/pull/5106#discussion_r464923678", "createdAt": "2020-08-04T09:31:23Z", "author": {"login": "korthout"}, "path": "qa/integration-tests/src/test/java/io/zeebe/broker/it/clustering/SingleBrokerDataDeletionTest.java", "diffHunk": "@@ -113,12 +114,42 @@ public void shouldNotCompactNotExportedEvents() {\n                     .isLessThan(segmentsBeforeSnapshot));\n   }\n \n-  private void fillSegments(final Broker broker, final int segmentCount) {\n+  @Test\n+  public void shouldCompactWhenExporterHasBeenRemoved() {\n+    // given\n+    final Broker broker = clusteringRule.getBroker(0);\n+    ControllableExporter.updatePosition(true);\n+    fillSegments(broker, SEGMENT_COUNT);\n+    clusteringRule.getClock().addTime(SNAPSHOT_PERIOD);\n+    // create first snapshot with exporter positions\n+    final var firstSnapshot = clusteringRule.waitForSnapshotAtBroker(broker);\n \n-    while (getSegmentsCount(broker) <= segmentCount) {\n-      writeToLog();\n-      writtenRecords.incrementAndGet();\n-    }\n+    // restart with no exporter\n+    final var brokerCfg = clusteringRule.getBrokerCfg(0);\n+    brokerCfg.setExporters(Map.of());\n+    clusteringRule.stopBroker(0);\n+    clusteringRule.startBroker(0);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg5OTg2OQ=="}, "originalCommit": {"oid": "6bec3f7e27d77eb13f5528b14ccb1289ca13da86"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMzY1ODY3OnYy", "diffSide": "RIGHT", "path": "broker/src/main/java/io/zeebe/broker/exporter/stream/ExporterDirector.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwOToxMToxMFrOG7X-Dg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwOTozMjowNlrOG7Ytsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkxMTg4Ng==", "bodyText": "could we close the actor sooner if we anyways know there are no exporters? or is the point of this change to do this after the state.setPosition above here at line 222?", "url": "https://github.com/camunda-cloud/zeebe/pull/5106#discussion_r464911886", "createdAt": "2020-08-04T09:11:10Z", "author": {"login": "korthout"}, "path": "broker/src/main/java/io/zeebe/broker/exporter/stream/ExporterDirector.java", "diffHunk": "@@ -227,7 +227,11 @@ private void onSnapshotRecovered() {\n \n     clearExporterState();\n \n-    actor.submit(this::readNextEvent);\n+    if (state.hasExporters()) {\n+      actor.submit(this::readNextEvent);\n+    } else {\n+      actor.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bec3f7e27d77eb13f5528b14ccb1289ca13da86"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkyMTE0OQ==", "bodyText": "The point is after cleaning up the state to close the actor yes. Before we haven't done it, which caused this issue. Its about line 228.", "url": "https://github.com/camunda-cloud/zeebe/pull/5106#discussion_r464921149", "createdAt": "2020-08-04T09:26:56Z", "author": {"login": "Zelldon"}, "path": "broker/src/main/java/io/zeebe/broker/exporter/stream/ExporterDirector.java", "diffHunk": "@@ -227,7 +227,11 @@ private void onSnapshotRecovered() {\n \n     clearExporterState();\n \n-    actor.submit(this::readNextEvent);\n+    if (state.hasExporters()) {\n+      actor.submit(this::readNextEvent);\n+    } else {\n+      actor.close();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkxMTg4Ng=="}, "originalCommit": {"oid": "6bec3f7e27d77eb13f5528b14ccb1289ca13da86"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkyNDA4Mg==", "bodyText": "Thanks for explaining", "url": "https://github.com/camunda-cloud/zeebe/pull/5106#discussion_r464924082", "createdAt": "2020-08-04T09:32:06Z", "author": {"login": "korthout"}, "path": "broker/src/main/java/io/zeebe/broker/exporter/stream/ExporterDirector.java", "diffHunk": "@@ -227,7 +227,11 @@ private void onSnapshotRecovered() {\n \n     clearExporterState();\n \n-    actor.submit(this::readNextEvent);\n+    if (state.hasExporters()) {\n+      actor.submit(this::readNextEvent);\n+    } else {\n+      actor.close();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkxMTg4Ng=="}, "originalCommit": {"oid": "6bec3f7e27d77eb13f5528b14ccb1289ca13da86"}, "originalPosition": 8}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 380, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}