{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5MjkzODI0", "number": 5529, "title": "chore(broker): Add health info into BrokerInfo", "bodyText": "Description\nAdd health info into inter broker communication.\nRelated issues\ncloses #5481\nDefinition of Done\nNot all items need to be done depending on the issue and the pull request.\nCode changes:\n\n The changes are backwards compatibility with previous versions\n If it fixes a bug then PRs are created to backport the fix to the last two minor versions\n\nTesting:\n\n There are unit/integration tests that verify all acceptance criterias of the issue\n New tests are written to ensure backwards compatibility with further versions\n The behavior is tested manually\n The impact of the changes is verified by a benchmark\n\nDocumentation:\n\n The documentation is updated (e.g. BPMN reference, configuration, examples, get-started guides, etc.)\n New content is added to the release announcement", "createdAt": "2020-10-07T14:28:35Z", "url": "https://github.com/camunda-cloud/zeebe/pull/5529", "merged": true, "mergeCommit": {"oid": "197556cfdbd031335f85084b46ec80f20c277530"}, "closed": true, "closedAt": "2020-10-20T16:32:37Z", "author": {"login": "aivinog1"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQa1vJgBqjM4NTM1NjQ0NjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUbBjLgFqTUxMjg5OTI3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6d72734e188fc5b701033671db6c502840ecce6a", "author": {"user": {"login": "aivinog1", "name": "Alexey Vinogradov"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/6d72734e188fc5b701033671db6c502840ecce6a", "committedDate": "2020-10-07T14:26:57Z", "message": "chore(broker): Add health info into BrokerInfo"}, "afterCommit": {"oid": "2ed6ef59a8fb5fb1a73d49da544bd955b9a7bd5f", "author": {"user": {"login": "aivinog1", "name": "Alexey Vinogradov"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/2ed6ef59a8fb5fb1a73d49da544bd955b9a7bd5f", "committedDate": "2020-10-08T05:36:05Z", "message": "chore(broker): Add health info into BrokerInfo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2NDcxMjI2", "url": "https://github.com/camunda-cloud/zeebe/pull/5529#pullrequestreview-506471226", "createdAt": "2020-10-12T09:55:26Z", "commit": {"oid": "2ed6ef59a8fb5fb1a73d49da544bd955b9a7bd5f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQwOTo1NToyNlrOHf3ohQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxMDowMzoyMVrOHf37Zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE3OTM5Nw==", "bodyText": "Please also assert the partition health statuses at the end of this test.", "url": "https://github.com/camunda-cloud/zeebe/pull/5529#discussion_r503179397", "createdAt": "2020-10-12T09:55:26Z", "author": {"login": "korthout"}, "path": "protocol-impl/src/test/java/io/zeebe/protocol/impl/BrokerInfoTest.java", "diffHunk": "@@ -35,6 +36,10 @@ public void shouldEncodeDecodeBrokerInfo() {\n     partitionRoles.put(1, PartitionRole.FOLLOWER);\n     partitionRoles.put(2, PartitionRole.LEADER);\n     partitionRoles.put(231, PartitionRole.FOLLOWER);\n+    final Map<Integer, PartitionHealthStatus> partitionHealthStatuses = new HashMap<>();\n+    partitionHealthStatuses.put(1, PartitionHealthStatus.HEALTHY);\n+    partitionHealthStatuses.put(2, PartitionHealthStatus.UNHEALTHY);\n+    partitionHealthStatuses.put(123, PartitionHealthStatus.HEALTHY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ed6ef59a8fb5fb1a73d49da544bd955b9a7bd5f"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE4NDIzMA==", "bodyText": "I think that for this (and the other cases below), the changes to the localBroker data also need to be published. For example, this is also done by the TopologyManagerImpl when the partition role changes (i.e. becoming leader or follower). See TopologyManagerImpl#L218 to see how this is done.\n@deepthidevaki WDYT, is it necessary here to publish these changes explicitly?", "url": "https://github.com/camunda-cloud/zeebe/pull/5529#discussion_r503184230", "createdAt": "2020-10-12T10:03:21Z", "author": {"login": "korthout"}, "path": "broker/src/main/java/io/zeebe/broker/system/partitions/ZeebePartition.java", "diffHunk": "@@ -737,6 +737,7 @@ public void onFailure() {\n           if (failureListener != null) {\n             failureListener.onFailure();\n           }\n+          localBroker.setPartitionUnhealthy(partitionId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ed6ef59a8fb5fb1a73d49da544bd955b9a7bd5f"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2ed6ef59a8fb5fb1a73d49da544bd955b9a7bd5f", "author": {"user": {"login": "aivinog1", "name": "Alexey Vinogradov"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/2ed6ef59a8fb5fb1a73d49da544bd955b9a7bd5f", "committedDate": "2020-10-08T05:36:05Z", "message": "chore(broker): Add health info into BrokerInfo"}, "afterCommit": {"oid": "6439d43e795f9e754000d3036044792c64467bc2", "author": {"user": {"login": "aivinog1", "name": "Alexey Vinogradov"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/6439d43e795f9e754000d3036044792c64467bc2", "committedDate": "2020-10-12T13:20:38Z", "message": "chore(broker): Add health info into BrokerInfo"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6439d43e795f9e754000d3036044792c64467bc2", "author": {"user": {"login": "aivinog1", "name": "Alexey Vinogradov"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/6439d43e795f9e754000d3036044792c64467bc2", "committedDate": "2020-10-12T13:20:38Z", "message": "chore(broker): Add health info into BrokerInfo"}, "afterCommit": {"oid": "3e05cfebbd58577c15b137ce9cc4426545438114", "author": {"user": {"login": "aivinog1", "name": "Alexey Vinogradov"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/3e05cfebbd58577c15b137ce9cc4426545438114", "committedDate": "2020-10-14T12:40:10Z", "message": "chore(broker): Add health info into BrokerInfo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NDk2OTQy", "url": "https://github.com/camunda-cloud/zeebe/pull/5529#pullrequestreview-508496942", "createdAt": "2020-10-14T15:56:15Z", "commit": {"oid": "3e05cfebbd58577c15b137ce9cc4426545438114"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxNTo1NjoxNVrOHhaDbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxNjowMToyNlrOHhaSUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc5MTkxOQ==", "bodyText": "I'm not entirely sure about this, but it might be necessary to put these 2 lines in a actor.run block (see L234). This would make sure that the work is never concurrently executed with one of the other updates to localbroker. @deepthidevaki WDYK? does that fully solve the issue?", "url": "https://github.com/camunda-cloud/zeebe/pull/5529#discussion_r504791919", "createdAt": "2020-10-14T15:56:15Z", "author": {"login": "korthout"}, "path": "broker/src/main/java/io/zeebe/broker/clustering/topology/TopologyManagerImpl.java", "diffHunk": "@@ -249,4 +253,16 @@ private void notifyPartitionLeaderUpdated(final int partitionId, final BrokerInf\n       LogUtil.catchAndLog(LOG, () -> listener.onPartitionLeaderUpdated(partitionId, member));\n     }\n   }\n+\n+  @Override\n+  public void onHealthUp(final int partitionId) {\n+    localBroker.setPartitionHealthy(partitionId);\n+    publishTopologyChanges();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e05cfebbd58577c15b137ce9cc4426545438114"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc5NTcyOQ==", "bodyText": "I wonder whether we could (or want to) re-use the failure listener for this. Perhaps ZeebePartition should know a collection of failure listeners that get notified onFailure and onRecovered. That requires some additional refactoring, but at least doesn't add stuff to partition context. I'm not sure it would work though, so please have a try at it, and if it doesn't work that's also fine.", "url": "https://github.com/camunda-cloud/zeebe/pull/5529#discussion_r504795729", "createdAt": "2020-10-14T16:01:26Z", "author": {"login": "korthout"}, "path": "broker/src/main/java/io/zeebe/broker/system/partitions/ZeebePartition.java", "diffHunk": "@@ -231,6 +231,7 @@ public void onFailure() {\n           if (failureListener != null) {\n             failureListener.onFailure();\n           }\n+          context.getPartitionHealthListener().onHealthDown(getPartitionId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e05cfebbd58577c15b137ce9cc4426545438114"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwMjAzODg1", "url": "https://github.com/camunda-cloud/zeebe/pull/5529#pullrequestreview-510203885", "createdAt": "2020-10-16T07:05:13Z", "commit": {"oid": "b0055231d73899b28a1a90dc702ef972d0220925"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwNzowNToxM1rOHiqQtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwNzowNToxM1rOHiqQtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjEwNjAzOQ==", "bodyText": "This should be called after scheduleActor(zeebePartition). The reason is: it is executed with actor.run. If the actor is not started, it won't be executed.", "url": "https://github.com/camunda-cloud/zeebe/pull/5529#discussion_r506106039", "createdAt": "2020-10-16T07:05:13Z", "author": {"login": "deepthidevaki"}, "path": "broker/src/main/java/io/zeebe/broker/Broker.java", "diffHunk": "@@ -403,11 +404,12 @@ private AutoCloseable partitionsStep(\n                     partitionIndexes.get(partitionId),\n                     snapshotStoreSupplier,\n                     createFactory(topologyManager, clusterCfg, atomix, managementRequestHandler),\n-                    buildExporterRepository(brokerCfg),\n-                    topologyManager);\n+                    buildExporterRepository(brokerCfg));\n             final PartitionTransitionImpl transitionBehavior =\n                 new PartitionTransitionImpl(context, LEADER_STEPS, FOLLOWER_STEPS);\n             final ZeebePartition zeebePartition = new ZeebePartition(context, transitionBehavior);\n+            zeebePartition.addFailureListener(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0055231d73899b28a1a90dc702ef972d0220925"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e81a01a62b327257db8db9badbc7ddcf63b7966", "author": {"user": {"login": "aivinog1", "name": "Alexey Vinogradov"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/1e81a01a62b327257db8db9badbc7ddcf63b7966", "committedDate": "2020-10-20T13:35:50Z", "message": "chore(broker): Spread health info through BrokerInfo"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "988980c3b208015de7118118cf0d3fb8546d8517", "author": {"user": {"login": "aivinog1", "name": "Alexey Vinogradov"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/988980c3b208015de7118118cf0d3fb8546d8517", "committedDate": "2020-10-20T12:35:11Z", "message": "chore(broker): Add todos to fix ignoring Sonar issues"}, "afterCommit": {"oid": "1e81a01a62b327257db8db9badbc7ddcf63b7966", "author": {"user": {"login": "aivinog1", "name": "Alexey Vinogradov"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/1e81a01a62b327257db8db9badbc7ddcf63b7966", "committedDate": "2020-10-20T13:35:50Z", "message": "chore(broker): Spread health info through BrokerInfo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyODk4ODY5", "url": "https://github.com/camunda-cloud/zeebe/pull/5529#pullrequestreview-512898869", "createdAt": "2020-10-20T16:04:23Z", "commit": {"oid": "1e81a01a62b327257db8db9badbc7ddcf63b7966"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyODk5Mjcx", "url": "https://github.com/camunda-cloud/zeebe/pull/5529#pullrequestreview-512899271", "createdAt": "2020-10-20T16:04:51Z", "commit": {"oid": "1e81a01a62b327257db8db9badbc7ddcf63b7966"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2430, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}