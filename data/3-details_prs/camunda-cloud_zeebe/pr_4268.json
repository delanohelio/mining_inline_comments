{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwMjc3NDEy", "number": 4268, "title": "Only init variable names to nil for output element variable", "bodyText": "Description\nIntroduced a Optional<String> getVariableName() method to Expression that provides a name of the top most variable in the expression if it is a single variable or a nested property of a variable.\nThis method is in turn used to init the output element variable to nil at the local scope of a multi instance body, to make sure such a body can set a variable with that name at its own scope.\nRelated issues\ncloses #4100", "createdAt": "2020-04-07T13:45:26Z", "url": "https://github.com/camunda-cloud/zeebe/pull/4268", "merged": true, "mergeCommit": {"oid": "3bb62cb68f380bf5adc56b8e672cd46c8fbef729"}, "closed": true, "closedAt": "2020-04-15T11:01:37Z", "author": {"login": "korthout"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXelrlgFqTM5MjY1NjIwOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXlXH0gBqjMyMzE3MjA0NjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNjU2MjA5", "url": "https://github.com/camunda-cloud/zeebe/pull/4268#pullrequestreview-392656209", "createdAt": "2020-04-14T07:10:36Z", "commit": {"oid": "5a3e1be7d1678bcdde3f320c068687eb1d03ad83"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNzoxMDozN1rOGFBBnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNzoyMjo1NFrOGFBaGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkxMjg2MQ==", "bodyText": "Please add some unit tests for the different implementations.", "url": "https://github.com/camunda-cloud/zeebe/pull/4268#discussion_r407912861", "createdAt": "2020-04-14T07:10:37Z", "author": {"login": "saig0"}, "path": "expression-language/src/main/java/io/zeebe/el/Expression.java", "diffHunk": "@@ -7,12 +7,20 @@\n  */\n package io.zeebe.el;\n \n+import java.util.Optional;\n+\n /** A parsed expression. */\n public interface Expression {\n \n   /** @return the (raw) expression as string */\n   String getExpression();\n \n+  /**\n+   * @return optional of the name of the variable if expression is a single variable or a property\n+   *     of a single variable, otherwise empty\n+   */\n+  Optional<String> getVariableName();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a3e1be7d1678bcdde3f320c068687eb1d03ad83"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkxNzUyMQ==", "bodyText": "This check is done in completeJobs()", "url": "https://github.com/camunda-cloud/zeebe/pull/4268#discussion_r407917521", "createdAt": "2020-04-14T07:19:42Z", "author": {"login": "saig0"}, "path": "engine/src/test/java/io/zeebe/engine/processor/workflow/multiinstance/MultiInstanceActivityTest.java", "diffHunk": "@@ -518,6 +521,48 @@ public void shouldIterateOverNestedInputCollection() {\n         .containsExactlyElementsOf(INPUT_COLLECTION);\n   }\n \n+  @Test\n+  public void shouldCollectNestedOutputElements() {\n+    // given\n+    ENGINE\n+        .deployment()\n+        .withXmlResource(\n+            workflow(\n+                miBuilder.andThen(\n+                    m -> m.zeebeOutputElementExpression(OUTPUT_ELEMENT_EXPRESSION + \".nested\"))))\n+        .deploy();\n+\n+    final long workflowInstanceKey =\n+        ENGINE\n+            .workflowInstance()\n+            .ofBpmnProcessId(PROCESS_ID)\n+            .withVariable(INPUT_COLLECTION_EXPRESSION, INPUT_COLLECTION)\n+            .create();\n+\n+    RecordingExporter.jobRecords(JobIntent.CREATED)\n+        .withWorkflowInstanceKey(workflowInstanceKey)\n+        .limit(INPUT_COLLECTION.size())\n+        .exists();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a3e1be7d1678bcdde3f320c068687eb1d03ad83"}, "originalPosition": 196}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkxOTEzMQ==", "bodyText": "What do you want to check here?\nI think that we should verify that\n\nthe variable is created without .nested in its name (which is the issue that was fixed)\nthe variable is initialized with null\nthe values are collected in the output collection", "url": "https://github.com/camunda-cloud/zeebe/pull/4268#discussion_r407919131", "createdAt": "2020-04-14T07:22:54Z", "author": {"login": "saig0"}, "path": "engine/src/test/java/io/zeebe/engine/processor/workflow/multiinstance/MultiInstanceActivityTest.java", "diffHunk": "@@ -518,6 +521,48 @@ public void shouldIterateOverNestedInputCollection() {\n         .containsExactlyElementsOf(INPUT_COLLECTION);\n   }\n \n+  @Test\n+  public void shouldCollectNestedOutputElements() {\n+    // given\n+    ENGINE\n+        .deployment()\n+        .withXmlResource(\n+            workflow(\n+                miBuilder.andThen(\n+                    m -> m.zeebeOutputElementExpression(OUTPUT_ELEMENT_EXPRESSION + \".nested\"))))\n+        .deploy();\n+\n+    final long workflowInstanceKey =\n+        ENGINE\n+            .workflowInstance()\n+            .ofBpmnProcessId(PROCESS_ID)\n+            .withVariable(INPUT_COLLECTION_EXPRESSION, INPUT_COLLECTION)\n+            .create();\n+\n+    RecordingExporter.jobRecords(JobIntent.CREATED)\n+        .withWorkflowInstanceKey(workflowInstanceKey)\n+        .limit(INPUT_COLLECTION.size())\n+        .exists();\n+\n+    // complete job\n+    completeJobs(\n+        workflowInstanceKey,\n+        INPUT_COLLECTION.size(),\n+        i -> Map.of(\"nested\", OUTPUT_COLLECTION.get(i)));\n+\n+    // then\n+    final List<Long> scopeKeys =\n+        RecordingExporter.variableRecords(VariableIntent.CREATED)\n+            .withName(OUTPUT_ELEMENT_EXPRESSION)\n+            .map(Record::getValue)\n+            .map(VariableRecordValue::getScopeKey)\n+            .limit(3)\n+            .collect(Collectors.toList());\n+    assertThat(scopeKeys)\n+        .hasSize(3)\n+        .allSatisfy(scopeKey -> assertThat(scopeKeys).containsOnlyOnce(scopeKey));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a3e1be7d1678bcdde3f320c068687eb1d03ad83"}, "originalPosition": 214}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e38ab1f2d3ddcdd89014a15c24adf6fab829cb9a", "author": {"user": {"login": "korthout", "name": "Nico Korthout"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/e38ab1f2d3ddcdd89014a15c24adf6fab829cb9a", "committedDate": "2020-04-14T11:22:56Z", "message": "chore(engine): resolve review commments\n\n- remove unnecessary wait for jobs created\n- alter test to check for null and output collection result\n- add test to check no variables created for more complex expressions"}, "afterCommit": {"oid": "509f41cabfab36f2e1a33a905375b027e2f4035f", "author": {"user": {"login": "korthout", "name": "Nico Korthout"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/509f41cabfab36f2e1a33a905375b027e2f4035f", "committedDate": "2020-04-14T11:35:04Z", "message": "chore(engine): resolve review commments\n\n- remove unnecessary wait for jobs created\n- alter test to check for null and output collection result\n- add test to check no variables created for more complex expressions\n- add tests for Expression.getVariableName"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyODYxOTk5", "url": "https://github.com/camunda-cloud/zeebe/pull/4268#pullrequestreview-392861999", "createdAt": "2020-04-14T12:06:52Z", "commit": {"oid": "509f41cabfab36f2e1a33a905375b027e2f4035f"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxMjowNjo1MlrOGFLdtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxMjoxMjoyOVrOGFLpYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA4Mzg5NQ==", "bodyText": "That looks tricky \ud83d\ude02", "url": "https://github.com/camunda-cloud/zeebe/pull/4268#discussion_r408083895", "createdAt": "2020-04-14T12:06:52Z", "author": {"login": "saig0"}, "path": "engine/src/test/java/io/zeebe/engine/processor/workflow/multiinstance/MultiInstanceActivityTest.java", "diffHunk": "@@ -539,28 +539,67 @@ public void shouldCollectNestedOutputElements() {\n             .withVariable(INPUT_COLLECTION_EXPRESSION, INPUT_COLLECTION)\n             .create();\n \n-    RecordingExporter.jobRecords(JobIntent.CREATED)\n-        .withWorkflowInstanceKey(workflowInstanceKey)\n-        .limit(INPUT_COLLECTION.size())\n-        .exists();\n-\n-    // complete job\n+    // complete jobs\n     completeJobs(\n         workflowInstanceKey,\n         INPUT_COLLECTION.size(),\n         i -> Map.of(\"nested\", OUTPUT_COLLECTION.get(i)));\n \n     // then\n-    final List<Long> scopeKeys =\n-        RecordingExporter.variableRecords(VariableIntent.CREATED)\n-            .withName(OUTPUT_ELEMENT_EXPRESSION)\n-            .map(Record::getValue)\n-            .map(VariableRecordValue::getScopeKey)\n-            .limit(3)\n-            .collect(Collectors.toList());\n-    assertThat(scopeKeys)\n-        .hasSize(3)\n-        .allSatisfy(scopeKey -> assertThat(scopeKeys).containsOnlyOnce(scopeKey));\n+    assertThat(\n+            RecordingExporter.variableRecords(VariableIntent.CREATED)\n+                .withName(OUTPUT_ELEMENT_EXPRESSION) // without '.nested'\n+                .withValue(\"null\")\n+                .limit(INPUT_COLLECTION.size()))\n+        .hasSize(INPUT_COLLECTION.size());\n+\n+    assertThat(\n+            RecordingExporter.variableRecords()\n+                .withName(OUTPUT_COLLECTION_VARIABLE)\n+                .withScopeKey(workflowInstanceKey)\n+                .getFirst()\n+                .getValue())\n+        .hasValue(JsonUtil.toJson(OUTPUT_COLLECTION));\n+  }\n+\n+  @Test\n+  public void shouldCollectOutputElementsFromExpression() {\n+    // given\n+    ENGINE\n+        .deployment()\n+        .withXmlResource(\n+            workflow(\n+                miBuilder.andThen(\n+                    m ->\n+                        m.zeebeOutputElementExpression(\n+                            \"number(string(loopCounter) + string(loopCounter))\"))))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "509f41cabfab36f2e1a33a905375b027e2f4035f"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA4Njg4MA==", "bodyText": "Limiting the records to a specific number is a bit unsteady. Instead, we can limit the records from creating a workflow instance to its completion/termination.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        RecordingExporter.variableRecords(VariableIntent.CREATED)\n          \n          \n            \n                            .map(Record::getValue)\n          \n          \n            \n                            .map(VariableRecordValue::getName)\n          \n          \n            \n                            .limit(10))\n          \n          \n            \n                         RecordingExporter.records()\n          \n          \n            \n                            .limitToWorkflowInstance(workflowInstanceKey)\n          \n          \n            \n                            .variableRecords()\n          \n          \n            \n                            .map(Record::getValue)\n          \n          \n            \n                            .map(VariableRecordValue::getName))", "url": "https://github.com/camunda-cloud/zeebe/pull/4268#discussion_r408086880", "createdAt": "2020-04-14T12:12:29Z", "author": {"login": "saig0"}, "path": "engine/src/test/java/io/zeebe/engine/processor/workflow/multiinstance/MultiInstanceActivityTest.java", "diffHunk": "@@ -539,28 +539,67 @@ public void shouldCollectNestedOutputElements() {\n             .withVariable(INPUT_COLLECTION_EXPRESSION, INPUT_COLLECTION)\n             .create();\n \n-    RecordingExporter.jobRecords(JobIntent.CREATED)\n-        .withWorkflowInstanceKey(workflowInstanceKey)\n-        .limit(INPUT_COLLECTION.size())\n-        .exists();\n-\n-    // complete job\n+    // complete jobs\n     completeJobs(\n         workflowInstanceKey,\n         INPUT_COLLECTION.size(),\n         i -> Map.of(\"nested\", OUTPUT_COLLECTION.get(i)));\n \n     // then\n-    final List<Long> scopeKeys =\n-        RecordingExporter.variableRecords(VariableIntent.CREATED)\n-            .withName(OUTPUT_ELEMENT_EXPRESSION)\n-            .map(Record::getValue)\n-            .map(VariableRecordValue::getScopeKey)\n-            .limit(3)\n-            .collect(Collectors.toList());\n-    assertThat(scopeKeys)\n-        .hasSize(3)\n-        .allSatisfy(scopeKey -> assertThat(scopeKeys).containsOnlyOnce(scopeKey));\n+    assertThat(\n+            RecordingExporter.variableRecords(VariableIntent.CREATED)\n+                .withName(OUTPUT_ELEMENT_EXPRESSION) // without '.nested'\n+                .withValue(\"null\")\n+                .limit(INPUT_COLLECTION.size()))\n+        .hasSize(INPUT_COLLECTION.size());\n+\n+    assertThat(\n+            RecordingExporter.variableRecords()\n+                .withName(OUTPUT_COLLECTION_VARIABLE)\n+                .withScopeKey(workflowInstanceKey)\n+                .getFirst()\n+                .getValue())\n+        .hasValue(JsonUtil.toJson(OUTPUT_COLLECTION));\n+  }\n+\n+  @Test\n+  public void shouldCollectOutputElementsFromExpression() {\n+    // given\n+    ENGINE\n+        .deployment()\n+        .withXmlResource(\n+            workflow(\n+                miBuilder.andThen(\n+                    m ->\n+                        m.zeebeOutputElementExpression(\n+                            \"number(string(loopCounter) + string(loopCounter))\"))))\n+        .deploy();\n+\n+    final long workflowInstanceKey =\n+        ENGINE\n+            .workflowInstance()\n+            .ofBpmnProcessId(PROCESS_ID)\n+            .withVariable(INPUT_COLLECTION_EXPRESSION, INPUT_COLLECTION)\n+            .create();\n+\n+    // complete jobs\n+    completeJobs(workflowInstanceKey, INPUT_COLLECTION.size());\n+\n+    // then\n+    assertThat(\n+            RecordingExporter.variableRecords(VariableIntent.CREATED)\n+                .map(Record::getValue)\n+                .map(VariableRecordValue::getName)\n+                .limit(10))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "509f41cabfab36f2e1a33a905375b027e2f4035f"}, "originalPosition": 87}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e58220ef776cdf0d1f76a1028157ba271e433012", "author": {"user": {"login": "korthout", "name": "Nico Korthout"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/e58220ef776cdf0d1f76a1028157ba271e433012", "committedDate": "2020-04-14T15:33:55Z", "message": "chore(engine): improve test performance stability"}, "afterCommit": {"oid": "23f7a2e624cbbb30a7d7117a27eb3ef5d2ab600c", "author": {"user": {"login": "korthout", "name": "Nico Korthout"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/23f7a2e624cbbb30a7d7117a27eb3ef5d2ab600c", "committedDate": "2020-04-14T15:36:21Z", "message": "chore(engine): only init variable names to nil for output element"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75a61fb2cf7cd43a218299d99f70f69da5780106", "author": {"user": {"login": "korthout", "name": "Nico Korthout"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/75a61fb2cf7cd43a218299d99f70f69da5780106", "committedDate": "2020-04-14T15:37:56Z", "message": "chore(engine): only init variable names to nil for output element"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "23f7a2e624cbbb30a7d7117a27eb3ef5d2ab600c", "author": {"user": {"login": "korthout", "name": "Nico Korthout"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/23f7a2e624cbbb30a7d7117a27eb3ef5d2ab600c", "committedDate": "2020-04-14T15:36:21Z", "message": "chore(engine): only init variable names to nil for output element"}, "afterCommit": {"oid": "75a61fb2cf7cd43a218299d99f70f69da5780106", "author": {"user": {"login": "korthout", "name": "Nico Korthout"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/75a61fb2cf7cd43a218299d99f70f69da5780106", "committedDate": "2020-04-14T15:37:56Z", "message": "chore(engine): only init variable names to nil for output element"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2992, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}