{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwMTgyMjgw", "number": 6017, "title": "fix(broker): pick latest snapshot on load when multiple snapshots exists", "bodyText": "Description\n\nPick latest snapshot on startup when multiple snapshot exists\nDelete snapshot directory if atomic move fails. If snapshot was partially moved, it would be considered a valid snapshot after a restart.\n\nRelated issues\ncloses #5500\nDefinition of Done\nNot all items need to be done depending on the issue and the pull request.\nCode changes:\n\n The changes are backwards compatibility with previous versions\n If it fixes a bug then PRs are created to backport the fix to the last two minor versions. You can trigger a backport by assigning labels (e.g. backport stable/0.25) to the PR, in case that fails you need to create backports manually.\n\nTesting:\n\n There are unit/integration tests that verify all acceptance criterias of the issue\n New tests are written to ensure backwards compatibility with further versions\n The behavior is tested manually\n The change has been verified by a QA run\n The impact of the changes is verified by a benchmark\n\nDocumentation:\n\n The documentation is updated (e.g. BPMN reference, configuration, examples, get-started guides, etc.)\n New content is added to the release announcement", "createdAt": "2020-12-15T11:31:51Z", "url": "https://github.com/camunda-cloud/zeebe/pull/6017", "merged": true, "mergeCommit": {"oid": "01cd9bfa46b6d5c22c7a4c504e6ae897c76b1ab0"}, "closed": true, "closedAt": "2020-12-17T14:25:00Z", "author": {"login": "deepthidevaki"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmrnMSgBqjQxMTg3MTQ2ODI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnDkA4ABqjQxMjUxMDQ3NDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bb523201d046416bc5f9e70240237034b96cd98d", "author": {"user": {"login": "deepthidevaki", "name": "Deepthi Devaki Akkoorath"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/bb523201d046416bc5f9e70240237034b96cd98d", "committedDate": "2020-12-15T11:00:08Z", "message": "fix(broker): pick latest snapshot on load when multiple snapshots exists\n- Also try to delete the snapshot if atomic move fails. If snapshot was partially moved, it would be considered a valid snapshot after a restart."}, "afterCommit": {"oid": "3580ce37bb41608658b58d3377bf0313cdf359e8", "author": {"user": {"login": "deepthidevaki", "name": "Deepthi Devaki Akkoorath"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/3580ce37bb41608658b58d3377bf0313cdf359e8", "committedDate": "2020-12-16T09:34:16Z", "message": "fix(broker): pick latest snapshot on load when multiple snapshots exists\n- Also try to delete the snapshot if atomic move fails. If snapshot was partially moved, it would be considered a valid snapshot after a restart."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NDIwMTMw", "url": "https://github.com/camunda-cloud/zeebe/pull/6017#pullrequestreview-554420130", "createdAt": "2020-12-17T09:28:16Z", "commit": {"oid": "3580ce37bb41608658b58d3377bf0313cdf359e8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwOToyODoxNlrOIHsXQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwOToyODoxNlrOIHsXQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDkzNzc5NA==", "bodyText": "Couldn't we delete the snapshot here if it's less recent than the latestPersistedSnapshot?", "url": "https://github.com/camunda-cloud/zeebe/pull/6017#discussion_r544937794", "createdAt": "2020-12-17T09:28:16Z", "author": {"login": "MiguelPires"}, "path": "snapshot/src/main/java/io/zeebe/snapshots/broker/impl/FileBasedSnapshotStore.java", "diffHunk": "@@ -71,7 +71,14 @@ private FileBasedSnapshot loadLatestSnapshot(final Path snapshotDirectory) {\n     FileBasedSnapshot latestPersistedSnapshot = null;\n     try (final var stream = Files.newDirectoryStream(snapshotDirectory)) {\n       for (final var path : stream) {\n-        latestPersistedSnapshot = collectSnapshot(path);\n+        final var snapshot = collectSnapshot(path);\n+        if (latestPersistedSnapshot == null) {\n+          latestPersistedSnapshot = snapshot;\n+        } else if (snapshot != null", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3580ce37bb41608658b58d3377bf0313cdf359e8"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NTUzMTI0", "url": "https://github.com/camunda-cloud/zeebe/pull/6017#pullrequestreview-554553124", "createdAt": "2020-12-17T12:22:35Z", "commit": {"oid": "12062a1fa891729cc7fe37c14cbb279a2844c1a8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ff6326e24ed8ba07fbbcdba649e703eb89f1bce", "author": {"user": {"login": "deepthidevaki", "name": "Deepthi Devaki Akkoorath"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/4ff6326e24ed8ba07fbbcdba649e703eb89f1bce", "committedDate": "2020-12-17T13:28:59Z", "message": "fix(broker): pick latest snapshot on load when multiple snapshots exists\n- Also try to delete the snapshot if atomic move fails. If snapshot was partially moved, it would be considered a valid snapshot after a restart."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "12062a1fa891729cc7fe37c14cbb279a2844c1a8", "author": {"user": {"login": "deepthidevaki", "name": "Deepthi Devaki Akkoorath"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/12062a1fa891729cc7fe37c14cbb279a2844c1a8", "committedDate": "2020-12-17T12:12:40Z", "message": "chore(broker): delete all older snapshot on load"}, "afterCommit": {"oid": "4ff6326e24ed8ba07fbbcdba649e703eb89f1bce", "author": {"user": {"login": "deepthidevaki", "name": "Deepthi Devaki Akkoorath"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/4ff6326e24ed8ba07fbbcdba649e703eb89f1bce", "committedDate": "2020-12-17T13:28:59Z", "message": "fix(broker): pick latest snapshot on load when multiple snapshots exists\n- Also try to delete the snapshot if atomic move fails. If snapshot was partially moved, it would be considered a valid snapshot after a restart."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2233, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}