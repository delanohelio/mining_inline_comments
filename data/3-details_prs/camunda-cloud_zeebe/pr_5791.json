{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3MzUxMDA4", "number": 5791, "title": "Return UNAVAILABLE on publish message and create workflow instance commands if no partitions are known", "bodyText": "Description\nThis PR ensures we return UNAVAILABLE to clients on publish message and workflow instance creation commands if the gateway does not know any partitions. It also introduces a new system test for the gateway to check these cases, which can be extended to add more cases.\nRelated issues\ncloses #5783\ncloses #5788\ncloses #5789\nDefinition of Done\nNot all items need to be done depending on the issue and the pull request.\nCode changes:\n\n The changes are backwards compatibility with previous versions\n If it fixes a bug then PRs are created to backport the fix to the last two minor versions\n\nTesting:\n\n There are unit/integration tests that verify all acceptance criterias of the issue\n New tests are written to ensure backwards compatibility with further versions\n The behavior is tested manually\n The impact of the changes is verified by a benchmark\n\nDocumentation:\n\n The documentation is updated (e.g. BPMN reference, configuration, examples, get-started guides, etc.)\n New content is added to the release announcement", "createdAt": "2020-11-08T18:38:52Z", "url": "https://github.com/camunda-cloud/zeebe/pull/5791", "merged": true, "mergeCommit": {"oid": "338260de4ef0f40509c30aab286ea45fe5d2ec32"}, "closed": true, "closedAt": "2020-11-09T09:58:32Z", "author": {"login": "npepinpe"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdakkk6AH2gAyNTE3MzUxMDA4OmI2MWYyYTZkNTEyNTZlNzkwMjVhZmY5MjE0NmE3NzI2NjhhMTkzOGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdawJ6OABqjM5NzIzNzMyMjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b61f2a6d51256e79025aff92146a772668a1938a", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/b61f2a6d51256e79025aff92146a772668a1938a", "committedDate": "2020-11-08T18:35:48Z", "message": "chore(test-util): add custom assert for ClientStatusException"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "07afdf56bf9bb902cc43cf1294c4ac38d627377b", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/07afdf56bf9bb902cc43cf1294c4ac38d627377b", "committedDate": "2020-11-08T18:36:11Z", "message": "fix(gateway): return UNAVAILABLE on missing topology"}, "afterCommit": {"oid": "f000654a52c8dbd3f331ade6469f3e740998e02a", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/f000654a52c8dbd3f331ade6469f3e740998e02a", "committedDate": "2020-11-08T18:46:30Z", "message": "fix(gateway): return UNAVAILABLE on missing topology"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f000654a52c8dbd3f331ade6469f3e740998e02a", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/f000654a52c8dbd3f331ade6469f3e740998e02a", "committedDate": "2020-11-08T18:46:30Z", "message": "fix(gateway): return UNAVAILABLE on missing topology"}, "afterCommit": {"oid": "928b14cfad550d74bc353c00ba37b504ddfb5430", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/928b14cfad550d74bc353c00ba37b504ddfb5430", "committedDate": "2020-11-08T20:06:58Z", "message": "chore(qa): update outdated test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1OTgzMzc0", "url": "https://github.com/camunda-cloud/zeebe/pull/5791#pullrequestreview-525983374", "createdAt": "2020-11-09T07:29:16Z", "commit": {"oid": "928b14cfad550d74bc353c00ba37b504ddfb5430"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwNzoyOToxN1rOHvh5JA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwNzozNDowMFrOHviAyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYwMDQyMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      \"Expected to handle gRPC request, but the gateway does not know any partitions yet\");\n          \n          \n            \n                      \"Expected to handle gRPC request, but the gateway does not know any partitions yet\", error);", "url": "https://github.com/camunda-cloud/zeebe/pull/5791#discussion_r519600420", "createdAt": "2020-11-09T07:29:17Z", "author": {"login": "Zelldon"}, "path": "gateway/src/main/java/io/zeebe/gateway/grpc/GrpcErrorMapper.java", "diffHunk": "@@ -86,6 +87,10 @@ private Status mapErrorToStatus(final Throwable error, final Logger logger) {\n       // partitions - it will then also occur when back pressure kicks in, leading to a large burst\n       // of error logs that is, in fact, expected\n       logger.trace(\"Expected to handle gRPC request, but all retries have been exhausted\", error);\n+    } else if (error instanceof NoTopologyAvailableException) {\n+      builder.setCode(Code.UNAVAILABLE_VALUE).setMessage(error.getMessage());\n+      logger.trace(\n+          \"Expected to handle gRPC request, but the gateway does not know any partitions yet\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "928b14cfad550d74bc353c00ba37b504ddfb5430"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYwMjM3OA==", "bodyText": "What does this?", "url": "https://github.com/camunda-cloud/zeebe/pull/5791#discussion_r519602378", "createdAt": "2020-11-09T07:34:00Z", "author": {"login": "Zelldon"}, "path": "gateway/src/test/java/io/zeebe/gateway/api/UnavailableBrokersTest.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.gateway.api;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatCode;\n+\n+import io.atomix.cluster.AtomixCluster;\n+import io.grpc.Status.Code;\n+import io.zeebe.client.ZeebeClient;\n+import io.zeebe.client.api.ZeebeFuture;\n+import io.zeebe.client.api.command.ClientStatusException;\n+import io.zeebe.client.api.command.FinalCommandStep;\n+import io.zeebe.gateway.Gateway;\n+import io.zeebe.gateway.impl.configuration.GatewayCfg;\n+import io.zeebe.gateway.impl.configuration.NetworkCfg;\n+import io.zeebe.test.util.asserts.grpc.ClientStatusExceptionAssert;\n+import io.zeebe.test.util.socket.SocketUtil;\n+import io.zeebe.util.sched.ActorScheduler;\n+import java.io.IOException;\n+import java.net.InetAddress;\n+import java.util.concurrent.TimeUnit;\n+import java.util.stream.Stream;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.parallel.Execution;\n+import org.junit.jupiter.api.parallel.ExecutionMode;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.MethodSource;\n+\n+@Execution(ExecutionMode.CONCURRENT)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "928b14cfad550d74bc353c00ba37b504ddfb5430"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b1fbecd0ca57cf536bd679804aa4af1e081085b", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/1b1fbecd0ca57cf536bd679804aa4af1e081085b", "committedDate": "2020-11-09T08:05:23Z", "message": "fix(gateway): return UNAVAILABLE on missing topology"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a02311800ca343c37713b6387a3dae687452c9e", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/2a02311800ca343c37713b6387a3dae687452c9e", "committedDate": "2020-11-09T08:05:23Z", "message": "chore(qa): update outdated test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d3e9b362cd9beb9ca873d63175f3e3aad21c9d86", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/d3e9b362cd9beb9ca873d63175f3e3aad21c9d86", "committedDate": "2020-11-09T08:04:34Z", "message": "chore(gateway): make sure test cases return gateway error and not client"}, "afterCommit": {"oid": "2a02311800ca343c37713b6387a3dae687452c9e", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/2a02311800ca343c37713b6387a3dae687452c9e", "committedDate": "2020-11-09T08:05:23Z", "message": "chore(qa): update outdated test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2365, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}