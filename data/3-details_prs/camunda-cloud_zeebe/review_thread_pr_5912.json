{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2NzU0Mzgw", "number": 5912, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQyMDozNzo1NVrOE86a0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMDozNjoyOVrOFCP8pQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyMzA3MTU0OnYy", "diffSide": "RIGHT", "path": "update-tests/src/test/java/io/zeebe/test/ContainerState.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQyMDozNzo1NVrOH5URUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQyMDozNzo1NVrOH5URUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg2Mjk5Mg==", "bodyText": "In junit5, CloseableResource objects which are put in a store are automatically closed when the test lifecycle ends (so if it's on a parameter or field, when the test ends; if it's on a static field, when the class/suite ends).", "url": "https://github.com/camunda-cloud/zeebe/pull/5912#discussion_r529862992", "createdAt": "2020-11-24T20:37:55Z", "author": {"login": "npepinpe"}, "path": "update-tests/src/test/java/io/zeebe/test/ContainerState.java", "diffHunk": "@@ -18,13 +18,14 @@\n import java.util.regex.Pattern;\n import net.jodah.failsafe.Failsafe;\n import net.jodah.failsafe.RetryPolicy;\n+import org.junit.jupiter.api.extension.ExtensionContext.Store.CloseableResource;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import org.testcontainers.containers.ContainerFetchException;\n import org.testcontainers.containers.ContainerLaunchException;\n import org.testcontainers.containers.Network;\n \n-public class ContainerState {\n+public class ContainerState implements CloseableResource {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96f6d41a782003b0d0dfd40356c63dc0c306ec50"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyMzA3MzYyOnYy", "diffSide": "RIGHT", "path": "update-tests/src/test/java/io/zeebe/test/ContainerStateExtension.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQyMDozODo0MVrOH5USqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQyMDozODo0MVrOH5USqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg2MzMzNg==", "bodyText": "Easily extended if we need more by storing a collection. Note that we'd need to make the collection itself a CloseableResource to ensure everything is cleaned up.", "url": "https://github.com/camunda-cloud/zeebe/pull/5912#discussion_r529863336", "createdAt": "2020-11-24T20:38:41Z", "author": {"login": "npepinpe"}, "path": "update-tests/src/test/java/io/zeebe/test/ContainerStateExtension.java", "diffHunk": "@@ -8,39 +8,52 @@\n package io.zeebe.test;\n \n import io.zeebe.test.util.testcontainers.ManagedVolume;\n+import java.util.Optional;\n import org.junit.jupiter.api.extension.AfterTestExecutionCallback;\n-import org.junit.jupiter.api.extension.BeforeTestExecutionCallback;\n import org.junit.jupiter.api.extension.ExtensionContext;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n+import org.junit.jupiter.api.extension.ExtensionContext.Namespace;\n+import org.junit.jupiter.api.extension.ExtensionContext.Store;\n+import org.junit.jupiter.api.extension.ExtensionContext.Store.CloseableResource;\n+import org.junit.jupiter.api.extension.ParameterContext;\n+import org.junit.jupiter.api.extension.ParameterResolutionException;\n+import org.junit.jupiter.api.extension.ParameterResolver;\n \n-public class ContainerStateExtension\n-    implements BeforeTestExecutionCallback, AfterTestExecutionCallback {\n-  private static final Logger LOG = LoggerFactory.getLogger(ContainerStateExtension.class);\n-\n-  private final ContainerState state;\n-\n-  public ContainerStateExtension(final ContainerState state) {\n-    this.state = state;\n-  }\n+/**\n+ * This extension injects a new {@link ContainerState} at runtime into any test which adds a {@link\n+ * ContainerState} parameter, and stores it in a {@link Store}. This ensures that the resource is\n+ * properly closed (since {@link ContainerState} implements {@link CloseableResource}).\n+ *\n+ * <p>Note however that it currently only supports injecting a single state, since the stored state", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96f6d41a782003b0d0dfd40356c63dc0c306ec50"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2NDIyMDAwOnYy", "diffSide": "RIGHT", "path": "update-tests/src/test/java/io/zeebe/test/ContainerState.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNDo1NDo0M1rOH_UZWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNDo1NDo0M1rOH_UZWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE1NjUwNA==", "bodyText": "Fixes a warning about type erasure", "url": "https://github.com/camunda-cloud/zeebe/pull/5912#discussion_r536156504", "createdAt": "2020-12-04T14:54:43Z", "author": {"login": "npepinpe"}, "path": "update-tests/src/test/java/io/zeebe/test/ContainerState.java", "diffHunk": "@@ -18,15 +18,16 @@\n import java.util.regex.Pattern;\n import net.jodah.failsafe.Failsafe;\n import net.jodah.failsafe.RetryPolicy;\n+import org.junit.jupiter.api.extension.ExtensionContext.Store.CloseableResource;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import org.testcontainers.containers.ContainerFetchException;\n import org.testcontainers.containers.ContainerLaunchException;\n import org.testcontainers.containers.Network;\n \n-public class ContainerState {\n+final class ContainerState implements CloseableResource {\n   private static final RetryPolicy<Void> CONTAINER_START_RETRY_POLICY =\n-      new RetryPolicy().withMaxRetries(5).withBackoff(3, 30, ChronoUnit.SECONDS);\n+      new RetryPolicy<Void>().withMaxRetries(5).withBackoff(3, 30, ChronoUnit.SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b029dea5bc9753fda05dc00c9bf604035c887ac8"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2NDIyNDI5OnYy", "diffSide": "RIGHT", "path": "update-tests/src/test/java/io/zeebe/test/ContainerState.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNDo1NTo0NlrOH_Ub-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNDo1NTo0NlrOH_Ub-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE1NzE3Nw==", "bodyText": "In junit5, CloseableResource instances which are stored in an extension store will be automatically close at the end of the extension's lifecycle - in our case, with ContainerStateExtension, this means at the end of the test where the parameter is injected.\nSee https://junit.org/junit5/docs/current/api/org.junit.jupiter.api/org/junit/jupiter/api/extension/ExtensionContext.Store.CloseableResource.html", "url": "https://github.com/camunda-cloud/zeebe/pull/5912#discussion_r536157177", "createdAt": "2020-12-04T14:55:46Z", "author": {"login": "npepinpe"}, "path": "update-tests/src/test/java/io/zeebe/test/ContainerState.java", "diffHunk": "@@ -18,15 +18,16 @@\n import java.util.regex.Pattern;\n import net.jodah.failsafe.Failsafe;\n import net.jodah.failsafe.RetryPolicy;\n+import org.junit.jupiter.api.extension.ExtensionContext.Store.CloseableResource;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import org.testcontainers.containers.ContainerFetchException;\n import org.testcontainers.containers.ContainerLaunchException;\n import org.testcontainers.containers.Network;\n \n-public class ContainerState {\n+final class ContainerState implements CloseableResource {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b029dea5bc9753fda05dc00c9bf604035c887ac8"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2NDIzMTU0OnYy", "diffSide": "RIGHT", "path": "update-tests/src/test/java/io/zeebe/test/ContainerState.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNDo1NzoyM1rOH_Ugig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNDo1NzoyM1rOH_Ugig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE1ODM0Ng==", "bodyText": "These settings are known to improve performance - however they're not defaults as changing them would be non-backwards compatible. We can remove them here once that's the case.", "url": "https://github.com/camunda-cloud/zeebe/pull/5912#discussion_r536158346", "createdAt": "2020-12-04T14:57:23Z", "author": {"login": "npepinpe"}, "path": "update-tests/src/test/java/io/zeebe/test/ContainerState.java", "diffHunk": "@@ -92,6 +97,9 @@ public void start(final boolean enableDebug) {\n     broker =\n         new ZeebeContainer(\"camunda/zeebe:\" + brokerVersion)\n             .withEnv(\"ZEEBE_LOG_LEVEL\", \"DEBUG\")\n+            .withEnv(\"ZEEBE_BROKER_NETWORK_MAXMESSAGESIZE\", \"128KB\")\n+            .withEnv(\"ZEEBE_BROKER_DATA_USEMMAP\", \"true\")\n+            .withEnv(\"ZEEBE_BROKER_DATA_LOGSEGMENTSIZE\", \"64MB\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b029dea5bc9753fda05dc00c9bf604035c887ac8"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3OTAyNzU3OnYy", "diffSide": "RIGHT", "path": "update-tests/src/test/java/io/zeebe/test/ContainerState.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMDozNjoyOVrOIBSsqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMDo1Nzo1M1rOIBTsBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIyNTgzMg==", "bodyText": "Why not move the assignment to the declaration and remove the constructor altogether?", "url": "https://github.com/camunda-cloud/zeebe/pull/5912#discussion_r538225832", "createdAt": "2020-12-08T10:36:29Z", "author": {"login": "MiguelPires"}, "path": "update-tests/src/test/java/io/zeebe/test/ContainerState.java", "diffHunk": "@@ -45,19 +46,18 @@\n             });\n   }\n \n-  private final Network network;\n-\n   private ZeebeContainer broker;\n   private ZeebeGatewayContainer gateway;\n   private ZeebeClient client;\n   private PartitionsActuatorClient partitionsActuatorClient;\n   private ManagedVolume volume;\n+  private Network network;\n \n   private String brokerVersion;\n   private String gatewayVersion;\n \n-  public ContainerState(final Network network) {\n-    this.network = network;\n+  public ContainerState() {\n+    network = Network.SHARED;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32a30de35418f3691cad262078dd86c5e4833ee6"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODI0MjA1Mg==", "bodyText": "Ah, I think I had it final for a bit, and just didn't change it after.", "url": "https://github.com/camunda-cloud/zeebe/pull/5912#discussion_r538242052", "createdAt": "2020-12-08T10:57:53Z", "author": {"login": "npepinpe"}, "path": "update-tests/src/test/java/io/zeebe/test/ContainerState.java", "diffHunk": "@@ -45,19 +46,18 @@\n             });\n   }\n \n-  private final Network network;\n-\n   private ZeebeContainer broker;\n   private ZeebeGatewayContainer gateway;\n   private ZeebeClient client;\n   private PartitionsActuatorClient partitionsActuatorClient;\n   private ManagedVolume volume;\n+  private Network network;\n \n   private String brokerVersion;\n   private String gatewayVersion;\n \n-  public ContainerState(final Network network) {\n-    this.network = network;\n+  public ContainerState() {\n+    network = Network.SHARED;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIyNTgzMg=="}, "originalCommit": {"oid": "32a30de35418f3691cad262078dd86c5e4833ee6"}, "originalPosition": 38}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 67, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}