{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2NzYzMjQ5", "number": 5462, "title": "Don't update exporter position to smaller value", "bodyText": "Description\nSee #5294 (comment)\n\nIf we have exported all records, do a snapshot and restart the broker then there is nothing the export. The ElasticSearchExporter does an periodically flush, which also updates the lastExportedPosition, see here. If the elasticsearch exporter hasn't seen any records after restart it will update the position to -1, since this is the default value.\nIn the ExporterDirector we don't validate the position, whether it is smaller then the previous value which means we just update the position, see here.\n\n\nRelated issues\n\ncloses #5294\nDefinition of Done\nNot all items need to be done depending on the issue and the pull request.\nCode changes:\n\n The changes are backwards compatibility with previous versions\n If it fixes a bug then PRs are created to backport the fix to the last two minor versions\n\nTesting:\n\n There are unit/integration tests that verify all acceptance criterias of the issue\n New tests are written to ensure backwards compatibility with further versions\n The behavior is tested manually\n The impact of the changes is verified by a benchmark\n\nDocumentation:\n\n The documentation is updated (e.g. BPMN reference, configuration, examples, get-started guides, etc.)\n New content is added to the release announcement", "createdAt": "2020-10-02T08:28:06Z", "url": "https://github.com/camunda-cloud/zeebe/pull/5462", "merged": true, "mergeCommit": {"oid": "c29fc16a5cc71797bed157946d3ee17a77ca63e3"}, "closed": true, "closedAt": "2020-10-07T11:49:10Z", "author": {"login": "Zelldon"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOh_yfgH2gAyNDk2NzYzMjQ5OjVjNWZmZGU2YjUzMGM2ZmQ3NjE2MzQxY2M2NTI4YWVmZWFlNDAyYTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQIKXPgBqjM4NDkwODQxNjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5c5ffde6b530c6fd7616341cc6528aefeae402a7", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/5c5ffde6b530c6fd7616341cc6528aefeae402a7", "committedDate": "2020-10-02T08:48:43Z", "message": "fix(broker): don't update exporter pos to smaller value"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dca23299e365ede0ca0fde949db6bfd52f38dc56", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/dca23299e365ede0ca0fde949db6bfd52f38dc56", "committedDate": "2020-10-02T08:22:33Z", "message": "fix(broker): don't update exporter pos to smaller value"}, "afterCommit": {"oid": "5c5ffde6b530c6fd7616341cc6528aefeae402a7", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/5c5ffde6b530c6fd7616341cc6528aefeae402a7", "committedDate": "2020-10-02T08:48:43Z", "message": "fix(broker): don't update exporter pos to smaller value"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNzU5Njk0", "url": "https://github.com/camunda-cloud/zeebe/pull/5462#pullrequestreview-501759694", "createdAt": "2020-10-05T06:49:25Z", "commit": {"oid": "5c5ffde6b530c6fd7616341cc6528aefeae402a7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwNjo0OToyNVrOHcPclg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwNjo0OToyNVrOHcPclg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM3NTI1NA==", "bodyText": "These should be updated only if eventPosition is greater than the current.", "url": "https://github.com/camunda-cloud/zeebe/pull/5462#discussion_r499375254", "createdAt": "2020-10-05T06:49:25Z", "author": {"login": "deepthidevaki"}, "path": "broker/src/main/java/io/zeebe/broker/exporter/stream/ExporterDirector.java", "diffHunk": "@@ -463,7 +463,7 @@ private void updatePositionOnSkipIfUpToDate(final long eventPosition) {\n     }\n \n     private void updateExporterLastExportedRecordPosition(final long eventPosition) {\n-      state.setPosition(getId(), eventPosition);\n+      state.setPositionIfGreater(getId(), eventPosition);\n       metrics.setLastUpdatedExportedPosition(getId(), eventPosition);\n       position = eventPosition;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c5ffde6b530c6fd7616341cc6528aefeae402a7"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNTc1NzUw", "url": "https://github.com/camunda-cloud/zeebe/pull/5462#pullrequestreview-503575750", "createdAt": "2020-10-07T06:59:08Z", "commit": {"oid": "f1551f2081c6dfcd6debb3ecc02fc811352c8e94"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce11a07b3a6d3cc44bb22750f7978f2eb8448f0f", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/ce11a07b3a6d3cc44bb22750f7978f2eb8448f0f", "committedDate": "2020-10-07T07:50:17Z", "message": "chore(broker): extract ExporterContainer\n\n * create separate class for the ExporterContainer and logic of setting exporter positions etc\n * make it possible to test how position are set\n * add new test class to test ExporterContainer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f1551f2081c6dfcd6debb3ecc02fc811352c8e94", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/f1551f2081c6dfcd6debb3ecc02fc811352c8e94", "committedDate": "2020-10-06T07:09:48Z", "message": "chore(broker): extract ExporterContainer\n\n * create separate class for the ExporterContainer and logic of setting exporter positions etc\n * make it possible to test how position are set\n * add new test class to test ExporterContainer"}, "afterCommit": {"oid": "ce11a07b3a6d3cc44bb22750f7978f2eb8448f0f", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/ce11a07b3a6d3cc44bb22750f7978f2eb8448f0f", "committedDate": "2020-10-07T07:50:17Z", "message": "chore(broker): extract ExporterContainer\n\n * create separate class for the ExporterContainer and logic of setting exporter positions etc\n * make it possible to test how position are set\n * add new test class to test ExporterContainer"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2405, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}