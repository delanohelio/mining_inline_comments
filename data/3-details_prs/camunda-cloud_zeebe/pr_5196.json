{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5NTQ0NTcx", "number": 5196, "title": "chore(broker): add more specific logs for taking snapshot", "bodyText": "Description\nAdd more specific log messages for taking a snapshot. Makes more clear when something went wrong with help of more context.\n\nRelated issues\n\ncloses #5142\ncloses #4553\nDefinition of Done\nNot all items need to be done depending on the issue and the pull request.\nCode changes:\n\n The changes are backwards compatibility with previous versions\n If it fixes a bug then PRs are created to backport the fix to the last two minor versions\n\nTesting:\n\n There are unit/integration tests that verify all acceptance criterias of the issue\n New tests are written to ensure backwards compatibility with further versions\n The behavior is tested manually\n The impact of the changes is verified by a benchmark\n\nDocumentation:\n\n The documentation is updated (e.g. BPMN reference, configuration, examples, get-started guides, etc.)\n New content is added to the release announcement", "createdAt": "2020-08-18T14:41:57Z", "url": "https://github.com/camunda-cloud/zeebe/pull/5196", "merged": true, "mergeCommit": {"oid": "b655216c56fcc5e1a33198d4421bd80ebc345dad"}, "closed": true, "closedAt": "2020-08-19T10:48:26Z", "author": {"login": "Zelldon"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAWNuIAFqTQ3MDE2Njg3Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAY4juABqjM2NzAwODY3Nzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMTY2ODcy", "url": "https://github.com/camunda-cloud/zeebe/pull/5196#pullrequestreview-470166872", "createdAt": "2020-08-19T06:45:12Z", "commit": {"oid": "3285cd6f6dbf43bd82fe0d607f8a317c79d33b42"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNjo0NToxMlrOHC3gHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNzowOToyMlrOHC4qNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc2ODU0Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      \"Expected to take snapshot for lower bound position {}, but database was closed.\",\n          \n          \n            \n                      \"Expected to take snapshot for last processed position {}, but database was closed.\",", "url": "https://github.com/camunda-cloud/zeebe/pull/5196#discussion_r472768543", "createdAt": "2020-08-19T06:45:12Z", "author": {"login": "deepthidevaki"}, "path": "broker/src/main/java/io/zeebe/broker/system/partitions/impl/StateControllerImpl.java", "diffHunk": "@@ -71,29 +71,36 @@ public StateControllerImpl(\n   @Override\n   public Optional<TransientSnapshot> takeTransientSnapshot(final long lowerBoundSnapshotPosition) {\n     if (!isDbOpened()) {\n+      LOG.warn(\n+          \"Expected to take snapshot for lower bound position {}, but database was closed.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3285cd6f6dbf43bd82fe0d607f8a317c79d33b42"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc3MDE2Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      \"Expected to find an indexed entry for given snapshot position {}, but found no matching indexed entry which contains this position.\",\n          \n          \n            \n                      \"Failed to take snapshot. Expected to find an indexed entry for given snapshot position {}, but found no matching indexed entry which contains this position.\",", "url": "https://github.com/camunda-cloud/zeebe/pull/5196#discussion_r472770162", "createdAt": "2020-08-19T06:47:16Z", "author": {"login": "deepthidevaki"}, "path": "broker/src/main/java/io/zeebe/broker/system/partitions/impl/StateControllerImpl.java", "diffHunk": "@@ -71,29 +71,36 @@ public StateControllerImpl(\n   @Override\n   public Optional<TransientSnapshot> takeTransientSnapshot(final long lowerBoundSnapshotPosition) {\n     if (!isDbOpened()) {\n+      LOG.warn(\n+          \"Expected to take snapshot for lower bound position {}, but database was closed.\",\n+          lowerBoundSnapshotPosition);\n       return Optional.empty();\n     }\n \n-    final long exportedPosition = exporterPositionSupplier.applyAsLong(openDb());\n-    final long snapshotPosition = Math.min(exportedPosition, lowerBoundSnapshotPosition);\n-\n+    final long snapshotPosition = determineSnapshotPosition(lowerBoundSnapshotPosition);\n     final var optionalIndexed = entrySupplier.getIndexedEntry(snapshotPosition);\n+    if (optionalIndexed.isEmpty()) {\n+      LOG.warn(\n+          \"Expected to find an indexed entry for given snapshot position {}, but found no matching indexed entry which contains this position.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3285cd6f6dbf43bd82fe0d607f8a317c79d33b42"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc3MDU1Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    \"Based on lowest exporter position '{}' and lower bound snapshot position '{}', determined '{}' as snapshot position.\",\n          \n          \n            \n                    \"Based on lowest exporter position '{}' and last processed position '{}', determined '{}' as snapshot position.\",", "url": "https://github.com/camunda-cloud/zeebe/pull/5196#discussion_r472770557", "createdAt": "2020-08-19T06:47:53Z", "author": {"login": "deepthidevaki"}, "path": "broker/src/main/java/io/zeebe/broker/system/partitions/impl/StateControllerImpl.java", "diffHunk": "@@ -277,12 +264,23 @@ private ReplicationContext newReplication(\n     return new ReplicationContext(metrics, startTimestamp, transientSnapshot);\n   }\n \n+  private long determineSnapshotPosition(final long lowerBoundSnapshotPosition) {\n+    final long exportedPosition = exporterPositionSupplier.applyAsLong(openDb());\n+    final long snapshotPosition = Math.min(exportedPosition, lowerBoundSnapshotPosition);\n+    LOG.debug(\n+        \"Based on lowest exporter position '{}' and lower bound snapshot position '{}', determined '{}' as snapshot position.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3285cd6f6dbf43bd82fe0d607f8a317c79d33b42"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc4NjAzMA==", "bodyText": "Why is this removed?", "url": "https://github.com/camunda-cloud/zeebe/pull/5196#discussion_r472786030", "createdAt": "2020-08-19T07:07:31Z", "author": {"login": "deepthidevaki"}, "path": "broker/src/main/java/io/zeebe/broker/system/partitions/impl/StateControllerImpl.java", "diffHunk": "@@ -159,26 +166,6 @@ boolean isDbOpened() {\n     return db != null;\n   }\n \n-  private void createSnapshot(final TransientSnapshot snapshot) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3285cd6f6dbf43bd82fe0d607f8a317c79d33b42"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc4NzUxMA==", "bodyText": "I think this was removed by mistake \ud83d\ude42 . This is probably why tests are failing.", "url": "https://github.com/camunda-cloud/zeebe/pull/5196#discussion_r472787510", "createdAt": "2020-08-19T07:09:22Z", "author": {"login": "deepthidevaki"}, "path": "broker/src/main/java/io/zeebe/broker/system/partitions/impl/StateControllerImpl.java", "diffHunk": "@@ -71,29 +71,36 @@ public StateControllerImpl(\n   @Override\n   public Optional<TransientSnapshot> takeTransientSnapshot(final long lowerBoundSnapshotPosition) {\n     if (!isDbOpened()) {\n+      LOG.warn(\n+          \"Expected to take snapshot for lower bound position {}, but database was closed.\",\n+          lowerBoundSnapshotPosition);\n       return Optional.empty();\n     }\n \n-    final long exportedPosition = exporterPositionSupplier.applyAsLong(openDb());\n-    final long snapshotPosition = Math.min(exportedPosition, lowerBoundSnapshotPosition);\n-\n+    final long snapshotPosition = determineSnapshotPosition(lowerBoundSnapshotPosition);\n     final var optionalIndexed = entrySupplier.getIndexedEntry(snapshotPosition);\n+    if (optionalIndexed.isEmpty()) {\n+      LOG.warn(\n+          \"Expected to find an indexed entry for given snapshot position {}, but found no matching indexed entry which contains this position.\",\n+          lowerBoundSnapshotPosition);\n+      return Optional.empty();\n+    }\n \n-    final Long previousSnapshotIndex =\n+    final var snapshotIndexedEntry = optionalIndexed.get();\n+    final long previousSnapshotIndex =\n         store.getLatestSnapshot().map(PersistedSnapshot::getCompactionBound).orElse(-1L);\n+    if (snapshotIndexedEntry.index() == previousSnapshotIndex) {\n+      LOG.debug(\n+          \"Previous snapshot was taken for the same indexed entry {}, will not take snapshot.\",\n+          snapshotIndexedEntry);\n+      return Optional.empty();\n+    }\n \n-    final var optTransientSnapshot =\n-        optionalIndexed\n-            .filter(indexed -> indexed.index() != previousSnapshotIndex)\n-            .map(\n-                indexed ->\n-                    store.newTransientSnapshot(\n-                        indexed.index(),\n-                        indexed.entry().term(),\n-                        WallClockTimestamp.from(System.currentTimeMillis())));\n-\n-    optTransientSnapshot.ifPresent(this::createSnapshot);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3285cd6f6dbf43bd82fe0d607f8a317c79d33b42"}, "originalPosition": 43}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab9da4f9543cf2a8e402e8c15bcbdda9f268fbd9", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/ab9da4f9543cf2a8e402e8c15bcbdda9f268fbd9", "committedDate": "2020-08-19T07:20:58Z", "message": "chore(broker): apply suggestion\n\nCo-authored-by: Deepthi Devaki Akkoorath <deepthidevaki@users.noreply.github.com>"}, "afterCommit": {"oid": "09f3013618617efbddc2b48305796b81d4158a60", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/09f3013618617efbddc2b48305796b81d4158a60", "committedDate": "2020-08-19T07:33:46Z", "message": "chore(broker): add more specific logs for taking snapshot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd450d1c220f5a0aef888432c06814ef61cba8a9", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/dd450d1c220f5a0aef888432c06814ef61cba8a9", "committedDate": "2020-08-19T09:05:24Z", "message": "chore(broker): add more specific logs for taking snapshot"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMzA3NDc0", "url": "https://github.com/camunda-cloud/zeebe/pull/5196#pullrequestreview-470307474", "createdAt": "2020-08-19T10:00:53Z", "commit": {"oid": "5290668bda3ea01ab7e93826b4f7f99e79b30fcc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5290668bda3ea01ab7e93826b4f7f99e79b30fcc", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/5290668bda3ea01ab7e93826b4f7f99e79b30fcc", "committedDate": "2020-08-19T07:58:01Z", "message": "chore(broker): Update broker/src/main/java/io/zeebe/broker/system/partitions/impl/StateControllerImpl.java\n\nCo-authored-by: Deepthi Devaki Akkoorath <deepthidevaki@users.noreply.github.com>"}, "afterCommit": {"oid": "dd450d1c220f5a0aef888432c06814ef61cba8a9", "author": {"user": {"login": "Zelldon", "name": "Christopher Zell"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/dd450d1c220f5a0aef888432c06814ef61cba8a9", "committedDate": "2020-08-19T09:05:24Z", "message": "chore(broker): add more specific logs for taking snapshot"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2559, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}