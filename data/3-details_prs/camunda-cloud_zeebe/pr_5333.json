{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg0MjYzOTM0", "number": 5333, "title": "Fixes GatewayLivenessProbeIntegrationTest flaky test", "bodyText": "Description\nThis PR fixes a flaky integration test for the liveness probe of the gateway. My understanding is, as all the liveness indicators are DelayedHealthIndicator instances, scheduled at a fixed rate of 5 seconds, it may take up to 5 seconds after the gateway has found the broker (in the worst case scenario) for the indicator to go UP - so sometimes the check is a little too fast. I admit I'm not 100% familiar with that part of the code so correct me if I misunderstood how it works.\nIt also cleans up some dead code from a previous PR.\nRelated issues\ncloses #4632\nDefinition of Done\nNot all items need to be done depending on the issue and the pull request.\nCode changes:\n\n The changes are backwards compatibility with previous versions\n If it fixes a bug then PRs are created to backport the fix to the last two minor versions\n\nTesting:\n\n There are unit/integration tests that verify all acceptance criterias of the issue\n New tests are written to ensure backwards compatibility with further versions\n The behavior is tested manually\n The impact of the changes is verified by a benchmark\n\nDocumentation:\n\n The documentation is updated (e.g. BPMN reference, configuration, examples, get-started guides, etc.)\n New content is added to the release announcement", "createdAt": "2020-09-10T19:47:52Z", "url": "https://github.com/camunda-cloud/zeebe/pull/5333", "merged": true, "mergeCommit": {"oid": "186bf764e0105ab0b5ed8b94ed6a7ecf91ae78a7"}, "closed": true, "closedAt": "2020-09-15T08:53:43Z", "author": {"login": "npepinpe"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHvcDUgBqjM3NTQ1NTc3MTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJDFsIgBqjM3NjY5NDg4NTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "50cf047f5eb2b087784ff476d2f2194fb6df3eb4", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/50cf047f5eb2b087784ff476d2f2194fb6df3eb4", "committedDate": "2020-09-10T19:40:12Z", "message": "chore(qa): wait until all delayed indicators have been called"}, "afterCommit": {"oid": "fc8dfcc3cf9b51a2221b7170d3e4c7fdc4674e86", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/fc8dfcc3cf9b51a2221b7170d3e4c7fdc4674e86", "committedDate": "2020-09-11T06:30:45Z", "message": "chore(qa): wait until all delayed indicators have been called"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NTE1NDA2", "url": "https://github.com/camunda-cloud/zeebe/pull/5333#pullrequestreview-487515406", "createdAt": "2020-09-14T08:10:33Z", "commit": {"oid": "c72cc1cc481adc356191eebaf664d7cdd524301e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwODoxMDozM1rOHRIj-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwODoxMDozM1rOHRIj-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcyODEyMg==", "bodyText": "As discussed, please either add a timeout on the request or try once more if this assertion failed, because it could be that the request just took very long the first time and ends up with a non 200 value.", "url": "https://github.com/camunda-cloud/zeebe/pull/5333#discussion_r487728122", "createdAt": "2020-09-14T08:10:33Z", "author": {"login": "korthout"}, "path": "qa/integration-tests/src/test/java/io/zeebe/broker/it/gateway/GatewayLivenessProbeIntegrationTest.java", "diffHunk": "@@ -63,17 +56,25 @@ public void shouldReportLivenessUpIfConnectedToBroker() {\n             .build();\n \n     // --- when + then ---------------------------------------\n-    given().spec(gatewayServerSpec).when().get(PATH_LIVENESS_PROBE).then().statusCode(200);\n+    // most of the liveness probes use a delayed health indicator which is scheduled at a fixed\n+    // rate of 5 seconds, so it may take up to that and a bit more in the worst case once the\n+    // gateway finds the broker\n+    Awaitility.await(\"wait until status turns UP\")\n+        .atMost(Duration.ofSeconds(10))\n+        .pollInterval(Duration.ofMillis(100))\n+        .untilAsserted(\n+            () ->\n+                given()\n+                    .spec(gatewayServerSpec)\n+                    .when()\n+                    .get(PATH_LIVENESS_PROBE)\n+                    .then()\n+                    .statusCode(200));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c72cc1cc481adc356191eebaf664d7cdd524301e"}, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NTI2OTg5", "url": "https://github.com/camunda-cloud/zeebe/pull/5333#pullrequestreview-487526989", "createdAt": "2020-09-14T08:25:20Z", "commit": {"oid": "0550a074d1074c4c3c4841281ad9a85b5a4b4a8d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwODoyNToyMFrOHRJFzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwODoyNToyMFrOHRJFzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzczNjc4Mw==", "bodyText": "Just a quick check, but do we need this?", "url": "https://github.com/camunda-cloud/zeebe/pull/5333#discussion_r487736783", "createdAt": "2020-09-14T08:25:20Z", "author": {"login": "korthout"}, "path": "dist/src/main/resources/application.properties", "diffHunk": "@@ -6,9 +6,9 @@ management.endpoints.web.exposure.include=health,prometheus,loggers\n management.endpoint.prometheus.enabled=true\n management.metrics.export.prometheus.enabled=true\n management.endpoint.health.group.startup.include=gatewayStarted\n-management.endpoint.health.group.startup.show-details=never\n+management.endpoint.health.group.startup.show-details=always", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0550a074d1074c4c3c4841281ad9a85b5a4b4a8d"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c5666adea68654b056fcaf9afdbf449c7aef95d3", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/c5666adea68654b056fcaf9afdbf449c7aef95d3", "committedDate": "2020-09-14T08:48:57Z", "message": "chore(dist): remove debugging settings"}, "afterCommit": {"oid": "ba1d2ecabf4ce956022548cf979d4b7d697997a7", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/ba1d2ecabf4ce956022548cf979d4b7d697997a7", "committedDate": "2020-09-14T15:17:31Z", "message": "chore(parent): ignore other slf4j binding"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "477835cc6868b7e4a6a2b684cc0bea35993ede59", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/477835cc6868b7e4a6a2b684cc0bea35993ede59", "committedDate": "2020-09-15T07:58:13Z", "message": "chore(qa): wait until all delayed indicators have been called"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41bccb0523ca98f0604237d13b4a5ef02f084025", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/41bccb0523ca98f0604237d13b4a5ef02f084025", "committedDate": "2020-09-15T07:58:20Z", "message": "chore(parent): ignore other slf4j binding"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ba1d2ecabf4ce956022548cf979d4b7d697997a7", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/ba1d2ecabf4ce956022548cf979d4b7d697997a7", "committedDate": "2020-09-14T15:17:31Z", "message": "chore(parent): ignore other slf4j binding"}, "afterCommit": {"oid": "41bccb0523ca98f0604237d13b4a5ef02f084025", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/41bccb0523ca98f0604237d13b4a5ef02f084025", "committedDate": "2020-09-15T07:58:20Z", "message": "chore(parent): ignore other slf4j binding"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2489, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}