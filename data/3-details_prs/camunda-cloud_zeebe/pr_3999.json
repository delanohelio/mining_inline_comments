{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0ODI2OTUy", "number": 3999, "title": "Allow to fail activatable jobs", "bodyText": "Description\nFail job commands are always rejected if the job state is not ACTIVATED. This is inconsistent with the complete job command, where it is also allowed to have an ACTIVATABLE job state as precondition.\nThis change allows to send a fail job command for a job in the activatable state.\nRelated issues\ncloses #3757", "createdAt": "2020-03-06T13:42:00Z", "url": "https://github.com/camunda-cloud/zeebe/pull/3999", "merged": true, "mergeCommit": {"oid": "9b681a949538bc2ec1c1cc463aa2d0ba1d137782"}, "closed": true, "closedAt": "2020-03-10T17:06:49Z", "author": {"login": "korthout"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcLAWS0ABqjMxMDU0MDA5OTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMTef-gFqTM3MjAwOTcxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6389a38f033acd88e690c3e306e30804a6a2bac2", "author": {"user": {"login": "korthout", "name": "Nico Korthout"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/6389a38f033acd88e690c3e306e30804a6a2bac2", "committedDate": "2020-03-06T13:36:49Z", "message": "feat: allow to fail activatable jobs"}, "afterCommit": {"oid": "0820967a7013a69e50cf8063c4b48e62d94c489d", "author": {"user": {"login": "korthout", "name": "Nico Korthout"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/0820967a7013a69e50cf8063c4b48e62d94c489d", "committedDate": "2020-03-06T13:43:19Z", "message": "feat(broker): allow to fail activatable jobs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMzQxMzY2", "url": "https://github.com/camunda-cloud/zeebe/pull/3999#pullrequestreview-370341366", "createdAt": "2020-03-06T14:01:31Z", "commit": {"oid": "0820967a7013a69e50cf8063c4b48e62d94c489d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNDowMTozMVrOFy5q2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNDowMTozMVrOFy5q2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkxNzk3OA==", "bodyText": "Would be nice if we could just remove this conditional statement.", "url": "https://github.com/camunda-cloud/zeebe/pull/3999#discussion_r388917978", "createdAt": "2020-03-06T14:01:31Z", "author": {"login": "Zelldon"}, "path": "engine/src/main/java/io/zeebe/engine/processor/workflow/job/FailProcessor.java", "diffHunk": "@@ -35,7 +35,7 @@ public boolean onCommand(\n     final long key = command.getKey();\n     final JobState.State jobState = state.getState(key);\n \n-    if (jobState == State.ACTIVATED) {\n+    if (jobState == State.ACTIVATED || jobState == State.ACTIVATABLE) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0820967a7013a69e50cf8063c4b48e62d94c489d"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0820967a7013a69e50cf8063c4b48e62d94c489d", "author": {"user": {"login": "korthout", "name": "Nico Korthout"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/0820967a7013a69e50cf8063c4b48e62d94c489d", "committedDate": "2020-03-06T13:43:19Z", "message": "feat(broker): allow to fail activatable jobs"}, "afterCommit": {"oid": "4339fb1c31ae5a38f69b169e107d06659ccc8e70", "author": {"user": {"login": "korthout", "name": "Nico Korthout"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/4339fb1c31ae5a38f69b169e107d06659ccc8e70", "committedDate": "2020-03-06T15:27:00Z", "message": "chore(engine): allow to fail activatable jobs\n\nIntroduces DefaultJobCommandProcessor to remove duplication among\nJobCommandProcessors."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwOTMwODg5", "url": "https://github.com/camunda-cloud/zeebe/pull/3999#pullrequestreview-370930889", "createdAt": "2020-03-09T06:00:37Z", "commit": {"oid": "4339fb1c31ae5a38f69b169e107d06659ccc8e70"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwNjowMDozOFrOFzbqRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwNjowMDozOFrOFzbqRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ3NDg4NQ==", "bodyText": "I think throw an error for job this part is also dynamic, like fail and complete", "url": "https://github.com/camunda-cloud/zeebe/pull/3999#discussion_r389474885", "createdAt": "2020-03-09T06:00:38Z", "author": {"login": "Zelldon"}, "path": "engine/src/main/java/io/zeebe/engine/processor/workflow/job/DefaultJobCommandProcessor.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.engine.processor.workflow.job;\n+\n+import io.zeebe.engine.processor.CommandProcessor;\n+import io.zeebe.engine.processor.TypedRecord;\n+import io.zeebe.engine.state.instance.JobState;\n+import io.zeebe.engine.state.instance.JobState.State;\n+import io.zeebe.protocol.impl.record.value.job.JobRecord;\n+import io.zeebe.protocol.record.RejectionType;\n+import java.util.function.BiConsumer;\n+\n+/**\n+ * Default implementation to process JobCommands to reduce duplication in CommandProcessor\n+ * implementations.\n+ */\n+final class DefaultJobCommandProcessor<J extends JobRecord> implements CommandProcessor<J> {\n+\n+  private static final String NO_JOB_FOUND_MESSAGE =\n+      \"Expected to throw an error for job with key '%d', but no such job was found\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4339fb1c31ae5a38f69b169e107d06659ccc8e70"}, "originalPosition": 25}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4339fb1c31ae5a38f69b169e107d06659ccc8e70", "author": {"user": {"login": "korthout", "name": "Nico Korthout"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/4339fb1c31ae5a38f69b169e107d06659ccc8e70", "committedDate": "2020-03-06T15:27:00Z", "message": "chore(engine): allow to fail activatable jobs\n\nIntroduces DefaultJobCommandProcessor to remove duplication among\nJobCommandProcessors."}, "afterCommit": {"oid": "5c067bed513383ca15f0c682cbb8c42e48c0ea4b", "author": {"user": {"login": "korthout", "name": "Nico Korthout"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/5c067bed513383ca15f0c682cbb8c42e48c0ea4b", "committedDate": "2020-03-09T12:13:42Z", "message": "chore(engine): allow to fail activatable jobs\n\nIntroduces DefaultJobCommandProcessor to remove duplication among\nJobCommandProcessors."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5c067bed513383ca15f0c682cbb8c42e48c0ea4b", "author": {"user": {"login": "korthout", "name": "Nico Korthout"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/5c067bed513383ca15f0c682cbb8c42e48c0ea4b", "committedDate": "2020-03-09T12:13:42Z", "message": "chore(engine): allow to fail activatable jobs\n\nIntroduces DefaultJobCommandProcessor to remove duplication among\nJobCommandProcessors."}, "afterCommit": {"oid": "baff0c97fd24b9c666525fe611baf64870c32370", "author": {"user": {"login": "korthout", "name": "Nico Korthout"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/baff0c97fd24b9c666525fe611baf64870c32370", "committedDate": "2020-03-09T13:36:26Z", "message": "chore(engine): allow to fail activatable jobs\n\nIntroduces DefaultJobCommandProcessor to remove duplication among\nJobCommandProcessors."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNjkwMTM1", "url": "https://github.com/camunda-cloud/zeebe/pull/3999#pullrequestreview-371690135", "createdAt": "2020-03-10T05:31:40Z", "commit": {"oid": "baff0c97fd24b9c666525fe611baf64870c32370"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwNTozMTo0MFrOF0B_Aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwNTozNDo0NVrOF0CBqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEwMjc4Nw==", "bodyText": "Can here the correct type be interfered?", "url": "https://github.com/camunda-cloud/zeebe/pull/3999#discussion_r390102787", "createdAt": "2020-03-10T05:31:40Z", "author": {"login": "Zelldon"}, "path": "engine/src/main/java/io/zeebe/engine/processor/workflow/job/JobEventProcessors.java", "diffHunk": "@@ -35,10 +35,10 @@ public static JobErrorThrownProcessor addJobProcessors(\n         .onEvent(ValueType.JOB, JobIntent.CREATED, new JobCreatedProcessor(workflowState))\n         .onEvent(ValueType.JOB, JobIntent.COMPLETED, new JobCompletedEventProcessor(workflowState))\n         .onCommand(ValueType.JOB, JobIntent.CREATE, new CreateProcessor(jobState))\n-        .onCommand(ValueType.JOB, JobIntent.COMPLETE, new CompleteProcessor(jobState))\n-        .onCommand(ValueType.JOB, JobIntent.FAIL, new FailProcessor(jobState))\n+        .onCommand(ValueType.JOB, JobIntent.COMPLETE, new CompleteProcessor<>(jobState))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "baff0c97fd24b9c666525fe611baf64870c32370"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEwMzQ2NA==", "bodyText": "So we should now be able to fail a job without activating it. Could we re-add this one and assert that it is failed correctly.", "url": "https://github.com/camunda-cloud/zeebe/pull/3999#discussion_r390103464", "createdAt": "2020-03-10T05:34:45Z", "author": {"login": "Zelldon"}, "path": "engine/src/test/java/io/zeebe/engine/processor/workflow/job/FailJobTest.java", "diffHunk": "@@ -193,20 +193,6 @@ public void shouldRejectFailIfJobAlreadyFailed() {\n     assertThat(jobRecord.getRejectionReason()).contains(\"it is in state 'FAILED'\");\n   }\n \n-  @Test\n-  public void shouldRejectFailIfJobCreated() {\n-    // given\n-    final Record<JobRecordValue> job = ENGINE.createJob(jobType, PROCESS_ID);\n-\n-    // when\n-    final Record<JobRecordValue> jobRecord =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "baff0c97fd24b9c666525fe611baf64870c32370"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99038429abeb13721bf53fac1052ddafd2ce300c", "author": {"user": {"login": "korthout", "name": "Nico Korthout"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/99038429abeb13721bf53fac1052ddafd2ce300c", "committedDate": "2020-03-10T12:37:02Z", "message": "chore(engine): allow to fail activatable jobs\n\nIntroduces DefaultJobCommandProcessor to remove duplication among\nJobCommandProcessors."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "baff0c97fd24b9c666525fe611baf64870c32370", "author": {"user": {"login": "korthout", "name": "Nico Korthout"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/baff0c97fd24b9c666525fe611baf64870c32370", "committedDate": "2020-03-09T13:36:26Z", "message": "chore(engine): allow to fail activatable jobs\n\nIntroduces DefaultJobCommandProcessor to remove duplication among\nJobCommandProcessors."}, "afterCommit": {"oid": "99038429abeb13721bf53fac1052ddafd2ce300c", "author": {"user": {"login": "korthout", "name": "Nico Korthout"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/99038429abeb13721bf53fac1052ddafd2ce300c", "committedDate": "2020-03-10T12:37:02Z", "message": "chore(engine): allow to fail activatable jobs\n\nIntroduces DefaultJobCommandProcessor to remove duplication among\nJobCommandProcessors."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMDA5NzEy", "url": "https://github.com/camunda-cloud/zeebe/pull/3999#pullrequestreview-372009712", "createdAt": "2020-03-10T14:34:41Z", "commit": {"oid": "99038429abeb13721bf53fac1052ddafd2ce300c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3041, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}