{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxNjU5MTQ4", "number": 5576, "title": "Adds new experimental flag to disable explicit flush in the consensus module", "bodyText": "Description\nThis PR adds a new experimental flag as zeebe.broker.experimental.disableExplicitRaftFlush, which defaults to false. When true, it will disable explicit flushing on the Raft side - flushing on commit on the leader, and flushing on append on the follower.\nThe flag is worded in the negative, as the default behaviour is to always explicitly flush for correctness, and users should take care when disabling this. There is also a warning printed out if replication is enabled, as this can lead to inconsistency issues; when replication factor is 1, at worst you simply suffer data loss on crash.\nThere are unfortunately no acceptance tests, as I with the current set up I found it quite hard to add. Let me know if you have an idea there.\nIdeally we'd like this in 0.25 so users can already start experimenting with this - in some use cases, this can give a nice performance boost, and the consequences (e.g. data loss when replication is disabled) can be ignored.\nRelated issues\ncloses #5570\nDefinition of Done\nNot all items need to be done depending on the issue and the pull request.\nCode changes:\n\n The changes are backwards compatibility with previous versions\n If it fixes a bug then PRs are created to backport the fix to the last two minor versions\n\nTesting:\n\n There are unit/integration tests that verify all acceptance criterias of the issue\n New tests are written to ensure backwards compatibility with further versions\n The behavior is tested manually\n The impact of the changes is verified by a benchmark\n\nDocumentation:\n\n The documentation is updated (e.g. BPMN reference, configuration, examples, get-started guides, etc.)\n New content is added to the release announcement", "createdAt": "2020-10-12T15:42:20Z", "url": "https://github.com/camunda-cloud/zeebe/pull/5576", "merged": true, "mergeCommit": {"oid": "7927a3d4bfb68e469b3626613e611a6f3a562660"}, "closed": true, "closedAt": "2020-10-13T15:12:09Z", "author": {"login": "npepinpe"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSHH6ZgFqTUwNzMyNzg0Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSJniOABqjM4NzE3NDAwNDU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MzI3ODQ3", "url": "https://github.com/camunda-cloud/zeebe/pull/5576#pullrequestreview-507327847", "createdAt": "2020-10-13T11:20:10Z", "commit": {"oid": "b75e37228f1c18966fd12a7d356e009741ff41e6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMToyMDoxMFrOHghwNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMTozMTo1OFrOHgiKSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg2OTQ5Mw==", "bodyText": "It is not safe to enable this without replication also. I would warn also for replicationFactor = 1.", "url": "https://github.com/camunda-cloud/zeebe/pull/5576#discussion_r503869493", "createdAt": "2020-10-13T11:20:10Z", "author": {"login": "deepthidevaki"}, "path": "broker/src/main/java/io/zeebe/broker/system/SystemContext.java", "diffHunk": "@@ -119,6 +122,10 @@ private void validateConfiguration() {\n               \"diskUsageCommandWatermark (%f) must be less than diskUsageReplicationWatermark (%f)\",\n               diskUsageCommandWatermark, diskUsageReplicationWatermark));\n     }\n+\n+    if (replicationFactor > 1 && experimental.isDisableExplicitRaftFlush()) {\n+      LOG.warn(REPLICATION_WITH_DISABLED_FLUSH_WARNING);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b75e37228f1c18966fd12a7d356e009741ff41e6"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3MzY2NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private boolean flushExplicitly = DEFAULT_FLUSH_ON_COMMIT;\n          \n          \n            \n                private boolean flushExplicitly = DEFAULT_FLUSH_EXPLICITLY;", "url": "https://github.com/camunda-cloud/zeebe/pull/5576#discussion_r503873665", "createdAt": "2020-10-13T11:27:41Z", "author": {"login": "deepthidevaki"}, "path": "atomix/cluster/src/main/java/io/atomix/raft/storage/RaftStorage.java", "diffHunk": "@@ -389,7 +389,7 @@ public boolean isRetainStaleSnapshots() {\n     private int maxEntrySize = DEFAULT_MAX_ENTRY_SIZE;\n     private int maxEntriesPerSegment = DEFAULT_MAX_ENTRIES_PER_SEGMENT;\n     private long freeDiskSpace = DEFAULT_FREE_DISK_SPACE;\n-    private boolean flushOnCommit = DEFAULT_FLUSH_ON_COMMIT;\n+    private boolean flushExplicitly = DEFAULT_FLUSH_ON_COMMIT;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b75e37228f1c18966fd12a7d356e009741ff41e6"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3NjE2OQ==", "bodyText": "Documentation is not added yet. Would you do it in this PR or another?", "url": "https://github.com/camunda-cloud/zeebe/pull/5576#discussion_r503876169", "createdAt": "2020-10-13T11:31:58Z", "author": {"login": "deepthidevaki"}, "path": "broker/src/main/java/io/zeebe/broker/system/SystemContext.java", "diffHunk": "@@ -33,6 +33,9 @@\n       \"Snapshot period %s needs to be larger then or equals to one minute.\";\n   private static final String MAX_BATCH_SIZE_ERROR_MSG =\n       \"Expected to have an append batch size maximum which is non negative and smaller then '%d', but was '%s'.\";\n+  private static final String REPLICATION_WITH_DISABLED_FLUSH_WARNING =\n+      \"Disabling explicit flushing with replication enabled is an experimental feature and can lead to inconsistencies \"\n+          + \"in a lot of cases! Please refer to the documentation whether or not you should use this!\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b75e37228f1c18966fd12a7d356e009741ff41e6"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NDkxMTY2", "url": "https://github.com/camunda-cloud/zeebe/pull/5576#pullrequestreview-507491166", "createdAt": "2020-10-13T14:22:34Z", "commit": {"oid": "a0a83af11edc8a023d4d62095a63fd3bef722492"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNDoyMjozNFrOHgpXWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNDoyMjozNFrOHgpXWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk5NDIwMA==", "bodyText": "Please update the message.", "url": "https://github.com/camunda-cloud/zeebe/pull/5576#discussion_r503994200", "createdAt": "2020-10-13T14:22:34Z", "author": {"login": "deepthidevaki"}, "path": "broker/src/main/java/io/zeebe/broker/system/SystemContext.java", "diffHunk": "@@ -33,6 +33,9 @@\n       \"Snapshot period %s needs to be larger then or equals to one minute.\";\n   private static final String MAX_BATCH_SIZE_ERROR_MSG =\n       \"Expected to have an append batch size maximum which is non negative and smaller then '%d', but was '%s'.\";\n+  private static final String REPLICATION_WITH_DISABLED_FLUSH_WARNING =\n+      \"Disabling explicit flushing with replication enabled is an experimental feature and can lead to inconsistencies \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0a83af11edc8a023d4d62095a63fd3bef722492"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e5a8645054f822bef440f9c0223451de500bb69", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/6e5a8645054f822bef440f9c0223451de500bb69", "committedDate": "2020-10-13T14:40:00Z", "message": "chore(atomix): introduce flushExplicitly flag\n\n- new flag which controls if we flush explicitly on the leader commit\n  and follower appends; defaults to true\n- removes old flushOnCommit config flag"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ecaa3ebbb3458519ddcffd244427fbf2237698f", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/8ecaa3ebbb3458519ddcffd244427fbf2237698f", "committedDate": "2020-10-13T14:40:00Z", "message": "chore(logstreams): fix to use correct flag"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c15dbe3ced8db12079ac5e391821e6e7e07741c8", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/c15dbe3ced8db12079ac5e391821e6e7e07741c8", "committedDate": "2020-10-13T14:40:01Z", "message": "chore(broker): add new experimental config to control Raft explicit flush"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a785209b32cb8fedc2a72eff5db0fcf0889d104", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/9a785209b32cb8fedc2a72eff5db0fcf0889d104", "committedDate": "2020-10-13T14:31:46Z", "message": "chore(broker): update message"}, "afterCommit": {"oid": "c15dbe3ced8db12079ac5e391821e6e7e07741c8", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/c15dbe3ced8db12079ac5e391821e6e7e07741c8", "committedDate": "2020-10-13T14:40:01Z", "message": "chore(broker): add new experimental config to control Raft explicit flush"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2448, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}