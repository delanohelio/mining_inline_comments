{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzNTczNzgw", "number": 5974, "title": "Add more metrics for processing latency", "bodyText": "Description\nSince we have been speculating about several root causes/solutions for performance bottlenecks, I thought it would be good to added following metrics:\n\nTime taken for processing a record\nLatency to write a record to the log\nLatency to commit a record\n\nRelated issues\nDefinition of Done\nNot all items need to be done depending on the issue and the pull request.\nCode changes:\n\n The changes are backwards compatibility with previous versions\n If it fixes a bug then PRs are created to backport the fix to the last two minor versions. You can trigger a backport by assigning labels (e.g. backport stable/0.25) to the PR, in case that fails you need to create backports manually.\n\nTesting:\n\n There are unit/integration tests that verify all acceptance criterias of the issue\n New tests are written to ensure backwards compatibility with further versions\n The behavior is tested manually\n The impact of the changes is verified by a benchmark\n\nDocumentation:\n\n The documentation is updated (e.g. BPMN reference, configuration, examples, get-started guides, etc.)\n New content is added to the release announcement", "createdAt": "2020-12-07T10:45:42Z", "url": "https://github.com/camunda-cloud/zeebe/pull/5974", "merged": true, "mergeCommit": {"oid": "c4ab98730d4defefbdea5e1cacb47f79fe21f168"}, "closed": true, "closedAt": "2020-12-14T13:50:09Z", "author": {"login": "deepthidevaki"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdj1kregFqTU0NjE0NTU5NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmFfRBABqjQxMDkxMzI2NTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MTQ1NTk0", "url": "https://github.com/camunda-cloud/zeebe/pull/5974#pullrequestreview-546145594", "createdAt": "2020-12-07T13:27:46Z", "commit": {"oid": "0b5b3ac6cb50b28d4786244b3c9a0f25e970bcde"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMzoyNzo0NlrOIAms_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMzoyNzo0NlrOIAms_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUwNTAyMw==", "bodyText": "Can you explain the choice to include deserialization as part of the processing time?", "url": "https://github.com/camunda-cloud/zeebe/pull/5974#discussion_r537505023", "createdAt": "2020-12-07T13:27:46Z", "author": {"login": "npepinpe"}, "path": "engine/src/main/java/io/zeebe/engine/processing/streamprocessor/ProcessingStateMachine.java", "diffHunk": "@@ -217,8 +217,8 @@ private void processEvent(final LoggedEvent event) {\n       return;\n     }\n \n-    metrics.processingLatency(\n-        metadata.getRecordType(), event.getTimestamp(), ActorClock.currentTimeMillis());\n+    final long processingStartTime = ActorClock.currentTimeMillis();\n+    metrics.processingLatency(metadata.getRecordType(), event.getTimestamp(), processingStartTime);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b5b3ac6cb50b28d4786244b3c9a0f25e970bcde"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxMzQzNjE0", "url": "https://github.com/camunda-cloud/zeebe/pull/5974#pullrequestreview-551343614", "createdAt": "2020-12-14T13:02:59Z", "commit": {"oid": "81740e07b8879b803487431c4086e7bc6af8b625"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxMzowMjo1OVrOIFPZYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxMzowMjo1OVrOIFPZYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjM2NjA0OA==", "bodyText": "I think it would be interesting to find hotspots by adding value type/intent as labels - however I'm not sure if that creates too much dimensions/data explosion. We can definitely do that as a second iteration though.", "url": "https://github.com/camunda-cloud/zeebe/pull/5974#discussion_r542366048", "createdAt": "2020-12-14T13:02:59Z", "author": {"login": "npepinpe"}, "path": "engine/src/main/java/io/zeebe/engine/metrics/StreamProcessorMetrics.java", "diffHunk": "@@ -64,6 +72,13 @@ public void processingLatency(\n         .observe((processed - written) / 1000f);\n   }\n \n+  public void processingDuration(\n+      final RecordType recordType, final long started, final long processed) {\n+    PROCESSING_DURATION\n+        .labels(recordType.name(), partitionIdLabel)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81740e07b8879b803487431c4086e7bc6af8b625"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df654fe70e38b6c146a19fc29155d4bdc0f70840", "author": {"user": {"login": "deepthidevaki", "name": "Deepthi Devaki Akkoorath"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/df654fe70e38b6c146a19fc29155d4bdc0f70840", "committedDate": "2020-12-14T13:09:40Z", "message": "chore(broker): add commit latency metrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82b2cc2decae70e8d246857a75cc886fa35b6425", "author": {"user": {"login": "deepthidevaki", "name": "Deepthi Devaki Akkoorath"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/82b2cc2decae70e8d246857a75cc886fa35b6425", "committedDate": "2020-12-14T13:09:41Z", "message": "chore(monitor): add panels for commit latency metrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05dc428da2dc31de405d3e19374df391de8ced54", "author": {"user": {"login": "deepthidevaki", "name": "Deepthi Devaki Akkoorath"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/05dc428da2dc31de405d3e19374df391de8ced54", "committedDate": "2020-12-14T13:09:41Z", "message": "chore(monitor): filter by pod in latency panels"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "81740e07b8879b803487431c4086e7bc6af8b625", "author": {"user": {"login": "deepthidevaki", "name": "Deepthi Devaki Akkoorath"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/81740e07b8879b803487431c4086e7bc6af8b625", "committedDate": "2020-12-09T10:37:02Z", "message": "chore(broker): update processing duration metrics to include writeEvent and updateState"}, "afterCommit": {"oid": "05dc428da2dc31de405d3e19374df391de8ced54", "author": {"user": {"login": "deepthidevaki", "name": "Deepthi Devaki Akkoorath"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/05dc428da2dc31de405d3e19374df391de8ced54", "committedDate": "2020-12-14T13:09:41Z", "message": "chore(monitor): filter by pod in latency panels"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2298, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}