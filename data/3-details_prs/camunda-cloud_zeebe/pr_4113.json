{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyNDgzNDM0", "number": 4113, "title": "chore(broker): split snapshot replication destination folders", "bodyText": "Description\n\nsplits destination folders for the different snapshot replications as they run in different thread context and both need to modify the same on-disk state\nAtomix snapshot replication will now write to raft-pending/ folder\nZeebe snapshot replication will now write to pushed-pending/ folder\n\nRelated issues\ncloses #3531, #4078, #3887, #3764\nPull Request Checklist\n\n All commit messages match our commit message guidelines\n The submitting code follows our code style\n If submitting code, please run mvn clean install -DskipTests locally before committing", "createdAt": "2020-03-23T16:13:32Z", "url": "https://github.com/camunda-cloud/zeebe/pull/4113", "merged": true, "mergeCommit": {"oid": "77cc19a0a5ba5fc8fdb9c7e4d8b3d9d27ec1cc8e"}, "closed": true, "closedAt": "2020-03-25T10:47:04Z", "author": {"login": "npepinpe"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQhhabABqjMxNTYyMTk0ODE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRElsNgH2gAyMzkyNDgzNDM0OjJkMGVjNDI1MjljYmJkZGNmNmM4MmQ5YzkwMzhlYmE3YWY5ZWRmNzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c292c4ad3e16710e5513878a746410e34172115f", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/c292c4ad3e16710e5513878a746410e34172115f", "committedDate": "2020-03-23T16:10:00Z", "message": "chore(broker): split snapshot replication destination folders\n\n- splits destination folders for the different snapshot replications as\n  they run in different thread context and both need to modify the same\n  on-disk state\n- Atomix snapshot replication will now write to raft-pending/ folder\n- Zeebe snapshot replication will now write to pushed-pending/ folder"}, "afterCommit": {"oid": "fe1d54834c7de4d864f4423b359d527d2999f002", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/fe1d54834c7de4d864f4423b359d527d2999f002", "committedDate": "2020-03-23T17:11:59Z", "message": "chore(broker): split snapshot replication destination folders\n\n- splits destination folders for the different snapshot replications as\n  they run in different thread context and both need to modify the same\n  on-disk state\n- Atomix snapshot replication will now write to raft-pending/ folder\n- Zeebe snapshot replication will now write to pushed-pending/ folder"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fe1d54834c7de4d864f4423b359d527d2999f002", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/fe1d54834c7de4d864f4423b359d527d2999f002", "committedDate": "2020-03-23T17:11:59Z", "message": "chore(broker): split snapshot replication destination folders\n\n- splits destination folders for the different snapshot replications as\n  they run in different thread context and both need to modify the same\n  on-disk state\n- Atomix snapshot replication will now write to raft-pending/ folder\n- Zeebe snapshot replication will now write to pushed-pending/ folder"}, "afterCommit": {"oid": "14e63c141ebb764695e9e0592cdc18872fd293a6", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/14e63c141ebb764695e9e0592cdc18872fd293a6", "committedDate": "2020-03-23T17:17:24Z", "message": "chore(broker): split snapshot replication destination folders\n\n- splits destination folders for the different snapshot replications as\n  they run in different thread context and both need to modify the same\n  on-disk state\n- Atomix snapshot replication will now write to raft-pending/ folder\n- Zeebe snapshot replication will now write to pushed-pending/ folder"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "14e63c141ebb764695e9e0592cdc18872fd293a6", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/14e63c141ebb764695e9e0592cdc18872fd293a6", "committedDate": "2020-03-23T17:17:24Z", "message": "chore(broker): split snapshot replication destination folders\n\n- splits destination folders for the different snapshot replications as\n  they run in different thread context and both need to modify the same\n  on-disk state\n- Atomix snapshot replication will now write to raft-pending/ folder\n- Zeebe snapshot replication will now write to pushed-pending/ folder"}, "afterCommit": {"oid": "2dff011a5812e56dbd5bf97503ea45baa9881b10", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/2dff011a5812e56dbd5bf97503ea45baa9881b10", "committedDate": "2020-03-23T17:27:36Z", "message": "chore(broker): split snapshot replication destination folders\n\n- splits destination folders for the different snapshot replications as\n  they run in different thread context and both need to modify the same\n  on-disk state\n- Atomix snapshot replication will now write to raft-pending/ folder\n- Zeebe snapshot replication will now write to pushed-pending/ folder"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMTg0MDY5", "url": "https://github.com/camunda-cloud/zeebe/pull/4113#pullrequestreview-380184069", "createdAt": "2020-03-24T10:37:44Z", "commit": {"oid": "2dff011a5812e56dbd5bf97503ea45baa9881b10"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDozNzo0NFrOF6qNpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDo0NDoyMVrOF6qcvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA1MzM0OA==", "bodyText": "We can use FileUtil:ensureDirectoryExists which you added in another PR to be consistent.", "url": "https://github.com/camunda-cloud/zeebe/pull/4113#discussion_r397053348", "createdAt": "2020-03-24T10:37:44Z", "author": {"login": "deepthidevaki"}, "path": "broker/src/main/java/io/zeebe/broker/clustering/atomix/storage/snapshot/AtomixSnapshotStorage.java", "diffHunk": "@@ -23,32 +23,37 @@\n import java.util.Set;\n import java.util.concurrent.CopyOnWriteArraySet;\n import java.util.stream.Stream;\n+import org.agrona.IoUtil;\n import org.slf4j.Logger;\n \n public final class AtomixSnapshotStorage implements SnapshotStorage, SnapshotListener {\n \n   private static final Logger LOGGER = new ZbLogger(AtomixSnapshotStorage.class);\n \n   private final Path runtimeDirectory;\n+  private final Path pendingDirectory;\n   private final AtomixRecordEntrySupplier entrySupplier;\n   private final SnapshotStore store;\n   private final Set<SnapshotDeletionListener> deletionListeners;\n   private final SnapshotMetrics metrics;\n \n   public AtomixSnapshotStorage(\n       final Path runtimeDirectory,\n+      final Path pendingDirectory,\n       final SnapshotStore store,\n       final AtomixRecordEntrySupplier entrySupplier,\n       final SnapshotMetrics metrics) {\n     this.runtimeDirectory = runtimeDirectory;\n+    this.pendingDirectory = pendingDirectory;\n     this.entrySupplier = entrySupplier;\n     this.store = store;\n     this.metrics = metrics;\n \n     this.deletionListeners = new CopyOnWriteArraySet<>();\n-    this.store.addListener(this);\n \n+    IoUtil.ensureDirectoryExists(pendingDirectory.toFile(), \"push replication pending directory\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2dff011a5812e56dbd5bf97503ea45baa9881b10"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA1NzIxNA==", "bodyText": "Doesn't purgeSnapshot does the cleanup?", "url": "https://github.com/camunda-cloud/zeebe/pull/4113#discussion_r397057214", "createdAt": "2020-03-24T10:44:21Z", "author": {"login": "deepthidevaki"}, "path": "broker/src/main/java/io/zeebe/broker/clustering/atomix/storage/snapshot/AtomixSnapshotStorage.java", "diffHunk": "@@ -142,8 +147,13 @@ public void onNewSnapshot(\n     metrics.incrementSnapshotCount();\n     observeSnapshotSize(snapshot);\n \n-    LOGGER.debug(\"Purging snapshots older than {}\", snapshot);\n-    store.purgeSnapshots(snapshot);\n+    try {\n+      LOGGER.debug(\"Purging snapshots older than {}\", snapshot);\n+      store.purgeSnapshots(snapshot);\n+      DbSnapshotStore.cleanUpTemporarySnapshots(pendingDirectory, snapshot.index());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2dff011a5812e56dbd5bf97503ea45baa9881b10"}, "originalPosition": 64}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2dff011a5812e56dbd5bf97503ea45baa9881b10", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/2dff011a5812e56dbd5bf97503ea45baa9881b10", "committedDate": "2020-03-23T17:27:36Z", "message": "chore(broker): split snapshot replication destination folders\n\n- splits destination folders for the different snapshot replications as\n  they run in different thread context and both need to modify the same\n  on-disk state\n- Atomix snapshot replication will now write to raft-pending/ folder\n- Zeebe snapshot replication will now write to pushed-pending/ folder"}, "afterCommit": {"oid": "1f6b7d65e18afdbab1bb9d23ee730b5f0657aa06", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/1f6b7d65e18afdbab1bb9d23ee730b5f0657aa06", "committedDate": "2020-03-24T13:13:22Z", "message": "chore(broker): split snapshot replication destination folders\n\n- splits destination folders for the different snapshot replications as\n  they run in different thread context and both need to modify the same\n  on-disk state\n- Atomix snapshot replication will now write to raft-pending/ folder\n- Zeebe snapshot replication will now write to pushed-pending/ folder"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6beb4e17fe941d3891485bb0365acdd940da6627", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/6beb4e17fe941d3891485bb0365acdd940da6627", "committedDate": "2020-03-24T14:03:39Z", "message": "chore(broker): refactor purging orphaned snapshots"}, "afterCommit": {"oid": "8d2125c0e617700d33de0c6bd199c746c04a665b", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/8d2125c0e617700d33de0c6bd199c746c04a665b", "committedDate": "2020-03-24T14:13:43Z", "message": "chore(broker): refactor purging orphaned snapshots"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNDcyNjQx", "url": "https://github.com/camunda-cloud/zeebe/pull/4113#pullrequestreview-380472641", "createdAt": "2020-03-24T16:16:14Z", "commit": {"oid": "617be890a64e32e9f101b077a94ca7375025c6fc"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNjoxNjoxNFrOF64GOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNjoxNjoxNFrOF64GOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI4MDgyNg==", "bodyText": "This isn't used anymore. Can remove.", "url": "https://github.com/camunda-cloud/zeebe/pull/4113#discussion_r397280826", "createdAt": "2020-03-24T16:16:14Z", "author": {"login": "deepthidevaki"}, "path": "broker/src/main/java/io/zeebe/broker/clustering/atomix/storage/snapshot/DbSnapshotStore.java", "diffHunk": "@@ -170,6 +171,35 @@ public void removeListener(final SnapshotListener listener) {\n     listeners.remove(listener);\n   }\n \n+  private void purgePendingSnapshot(final Path pendingSnapshot) {\n+    try {\n+      FileUtil.deleteFolder(pendingSnapshot);\n+      LOGGER.debug(\"Delete not completed (orphaned) snapshot {}\", pendingSnapshot);\n+    } catch (final IOException e) {\n+      LOGGER.error(\"Failed to delete not completed (orphaned) snapshot {}\", pendingSnapshot);\n+    }\n+  }\n+\n+  static void cleanUpTemporarySnapshots(final Path pendingDirectory, final long cutoffIndex)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "617be890a64e32e9f101b077a94ca7375025c6fc"}, "originalPosition": 30}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2748085217fa5f9b2dfff6da940e0bf492a839be", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/2748085217fa5f9b2dfff6da940e0bf492a839be", "committedDate": "2020-03-24T16:48:21Z", "message": "chore(broker): fail partition installation if cannot created pending directory"}, "afterCommit": {"oid": "da6ef39160a811c438bd69ef38b217f0c24152aa", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/da6ef39160a811c438bd69ef38b217f0c24152aa", "committedDate": "2020-03-24T17:20:35Z", "message": "chore(broker): fail partition installation if cannot created pending directory"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwOTYyMDQ1", "url": "https://github.com/camunda-cloud/zeebe/pull/4113#pullrequestreview-380962045", "createdAt": "2020-03-25T09:05:19Z", "commit": {"oid": "bb1e45f7f6d6e78c97554511f79239b5c971f56f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca4048b03cf3c8f011e1f8242afcfc40df4ebefe", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/ca4048b03cf3c8f011e1f8242afcfc40df4ebefe", "committedDate": "2020-03-25T09:10:09Z", "message": "chore(broker): split snapshot replication destination folders\n\n- splits destination folders for the different snapshot replications as\n  they run in different thread context and both need to modify the same\n  on-disk state\n- Atomix snapshot replication will now write to raft-pending/ folder\n- Zeebe snapshot replication will now write to pushed-pending/ folder"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bb1e45f7f6d6e78c97554511f79239b5c971f56f", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/bb1e45f7f6d6e78c97554511f79239b5c971f56f", "committedDate": "2020-03-25T09:01:52Z", "message": "chore(broker): revert raft pending directory name"}, "afterCommit": {"oid": "ca4048b03cf3c8f011e1f8242afcfc40df4ebefe", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/ca4048b03cf3c8f011e1f8242afcfc40df4ebefe", "committedDate": "2020-03-25T09:10:09Z", "message": "chore(broker): split snapshot replication destination folders\n\n- splits destination folders for the different snapshot replications as\n  they run in different thread context and both need to modify the same\n  on-disk state\n- Atomix snapshot replication will now write to raft-pending/ folder\n- Zeebe snapshot replication will now write to pushed-pending/ folder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d0ec42529cbbddcf6c82d9c9038eba7af9edf77", "author": {"user": {"login": "npepinpe", "name": "Nicolas Pepin-Perreault"}}, "url": "https://github.com/camunda-cloud/zeebe/commit/2d0ec42529cbbddcf6c82d9c9038eba7af9edf77", "committedDate": "2020-03-25T10:03:35Z", "message": "chore(qa): fix potential race condition in tests\n\n- changes waitForNewSnapshot from waiting until a new snapshot is\n  committed without waiting for the older ones to be removed to\n  wait until a new snapshot has been committed AND the previous ones\n  removed; this fixes a potential race conditions when asserting the\n  checksum of available snapshots in tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2928, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}