{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2NjQ5MjEy", "number": 3152, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNjo0MzoxMlrOE9FWSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNjo0MzoxMlrOE9FWSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNDg2MjE2OnYy", "diffSide": "RIGHT", "path": "commons/src/main/java/org/eclipse/kapua/commons/configuration/AbstractKapuaConfigurableService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNjo0MzoxMlrOH5lHUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwOToxNzowOVrOH6SU3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzODk2Mw==", "bodyText": "I think that this message should be \"The configuration \"%s\" cannot be changed by this user in this account\" or something similar. What do you think?", "url": "https://github.com/eclipse/kapua/pull/3152#discussion_r530138963", "createdAt": "2020-11-25T06:43:12Z", "author": {"login": "LeoNerdoG"}, "path": "commons/src/main/java/org/eclipse/kapua/commons/configuration/AbstractKapuaConfigurableService.java", "diffHunk": "@@ -391,18 +393,35 @@ public void setConfigValues(KapuaId scopeId, KapuaId parentId, Map<String, Objec\n         KapuaLocator locator = KapuaLocator.getInstance();\n         AuthorizationService authorizationService = locator.getService(AuthorizationService.class);\n         PermissionFactory permissionFactory = locator.getFactory(PermissionFactory.class);\n-        UserService userService = locator.getService(UserService.class);\n+        KapuaTocd ocd = getConfigMetadata(scopeId, false);\n \n+        UserService userService = locator.getService(UserService.class);\n         String rootUserName = SystemSetting.getInstance().getString(SystemSettingKey.SYS_ADMIN_USERNAME);\n         User rootUser = KapuaSecurityUtils.doPrivileged(() -> userService.findByName(rootUserName));\n-        if (!KapuaSecurityUtils.getSession().getUserId().equals(rootUser.getId()) && KapuaSecurityUtils.getSession().getScopeId().equals(scopeId)) {\n-            // Prevent someone to change his own configurations, unless it's the root user\n-            throw KapuaException.internalError(\"An user cannot change service settings on his own account\");\n+\n+        Map<String, Object> originalValues = getConfigValues(scopeId);\n+\n+        for (KapuaTad ad : ocd.getAD()) {\n+            boolean allowSelfEdit = Boolean.parseBoolean(ad.getOtherAttributes().getOrDefault(new QName(\"allowSelfEdit\"), \"false\"));\n+\n+            boolean preventChange =\n+                    // if current user is not root user...\n+                    !KapuaSecurityUtils.getSession().getUserId().equals(rootUser.getId()) &&\n+                    // current configuration does not allow self edit...\n+                    !allowSelfEdit &&\n+                    // a configuration for the current logged account is about to be changed...\n+                    KapuaSecurityUtils.getSession().getScopeId().equals(scopeId) &&\n+                    // and the new value is different from the other one...\n+                    !originalValues.get(ad.getId()).equals(values.get(ad.getId()));\n+\n+            if (preventChange) {\n+                // ... prevent the change!\n+                throw KapuaException.internalError(String.format(\"The configuration \\\"%s\\\" cannot be changed from an user of the account\", ad.getId()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03132d2c3f37f8bca9fae09340ceef394e3e71e5"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg3OTcxMQ==", "bodyText": "Yes, this could work", "url": "https://github.com/eclipse/kapua/pull/3152#discussion_r530879711", "createdAt": "2020-11-26T09:17:09Z", "author": {"login": "lorthirk"}, "path": "commons/src/main/java/org/eclipse/kapua/commons/configuration/AbstractKapuaConfigurableService.java", "diffHunk": "@@ -391,18 +393,35 @@ public void setConfigValues(KapuaId scopeId, KapuaId parentId, Map<String, Objec\n         KapuaLocator locator = KapuaLocator.getInstance();\n         AuthorizationService authorizationService = locator.getService(AuthorizationService.class);\n         PermissionFactory permissionFactory = locator.getFactory(PermissionFactory.class);\n-        UserService userService = locator.getService(UserService.class);\n+        KapuaTocd ocd = getConfigMetadata(scopeId, false);\n \n+        UserService userService = locator.getService(UserService.class);\n         String rootUserName = SystemSetting.getInstance().getString(SystemSettingKey.SYS_ADMIN_USERNAME);\n         User rootUser = KapuaSecurityUtils.doPrivileged(() -> userService.findByName(rootUserName));\n-        if (!KapuaSecurityUtils.getSession().getUserId().equals(rootUser.getId()) && KapuaSecurityUtils.getSession().getScopeId().equals(scopeId)) {\n-            // Prevent someone to change his own configurations, unless it's the root user\n-            throw KapuaException.internalError(\"An user cannot change service settings on his own account\");\n+\n+        Map<String, Object> originalValues = getConfigValues(scopeId);\n+\n+        for (KapuaTad ad : ocd.getAD()) {\n+            boolean allowSelfEdit = Boolean.parseBoolean(ad.getOtherAttributes().getOrDefault(new QName(\"allowSelfEdit\"), \"false\"));\n+\n+            boolean preventChange =\n+                    // if current user is not root user...\n+                    !KapuaSecurityUtils.getSession().getUserId().equals(rootUser.getId()) &&\n+                    // current configuration does not allow self edit...\n+                    !allowSelfEdit &&\n+                    // a configuration for the current logged account is about to be changed...\n+                    KapuaSecurityUtils.getSession().getScopeId().equals(scopeId) &&\n+                    // and the new value is different from the other one...\n+                    !originalValues.get(ad.getId()).equals(values.get(ad.getId()));\n+\n+            if (preventChange) {\n+                // ... prevent the change!\n+                throw KapuaException.internalError(String.format(\"The configuration \\\"%s\\\" cannot be changed from an user of the account\", ad.getId()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzODk2Mw=="}, "originalCommit": {"oid": "03132d2c3f37f8bca9fae09340ceef394e3e71e5"}, "originalPosition": 72}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1682, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}