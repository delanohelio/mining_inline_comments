{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2OTM5MzA1", "number": 3022, "title": "Use index to search for AccessTokens", "bodyText": "This PR introduces an index in the ATHT_ACCESS_TOKEN table that is then used when looking for a specific Access Token, specifically during REST API authentication check and token refresh\nRelated Issue\nThis should really help #1537 but it's not 100% sure that this is the only cause of that issue. We may think to close it after we gather some feedback from the community\nDescription of the solution adopted\nChanging the query we do when looking for a specific AccessToken, filtering out already expired and invalidated tokens, will allow the DBMS to use the newly created index to perform the search, cutting down the search time.\nScreenshots\nThis from a brief test on my local machine:\nWithout the index and the optimized query:\nkapuadb> SELECT * FROM atht_access_token WHERE token_id = '...'\n[2020-07-09 11:33:05] 1 row retrieved starting from 1 in 6 s 714 ms (execution: 6 s 676 ms, fetching: 38 ms)\n\nWith the index and the optimized query:\nkapuadb> SELECT * FROM atht_access_token WHERE invalidated_on IS NULL AND expires_on > NOW() AND token_id = '...'\n[2020-07-09 11:32:29] 1 row retrieved starting from 1 in 60 ms (execution: 13 ms, fetching: 47 ms)", "createdAt": "2020-07-09T15:36:46Z", "url": "https://github.com/eclipse/kapua/pull/3022", "merged": true, "mergeCommit": {"oid": "bafa078b66a072ea005d6605274fbc45932f2a7d"}, "closed": true, "closedAt": "2020-07-15T07:42:30Z", "author": {"login": "lorthirk"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczckw1gFqTQ0NjEyNTYwNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1FsfDgFqTQ0ODcwNTE0NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MTI1NjA3", "url": "https://github.com/eclipse/kapua/pull/3022#pullrequestreview-446125607", "createdAt": "2020-07-10T05:12:55Z", "commit": {"oid": "ffbf0908976a23fddc003117b3eeabb1d270be8b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwNToxMjo1NVrOGvqElA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwNToxMzoyMlrOGvqE8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYyNTU1Ng==", "bodyText": "Please update the header of the file to \"2020\".", "url": "https://github.com/eclipse/kapua/pull/3022#discussion_r452625556", "createdAt": "2020-07-10T05:12:55Z", "author": {"login": "LeoNerdoG"}, "path": "service/security/authentication/api/src/main/java/org/eclipse/kapua/service/authentication/token/AccessTokenAttributes.java", "diffHunk": "@@ -22,5 +22,7 @@\n \n     public static final String TOKEN_ID = \"tokenId\";\n     public static final String USER_ID = \"userId\";\n+    public static final String EXPIRES_ON = \"expiresOn\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffbf0908976a23fddc003117b3eeabb1d270be8b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYyNTYwOQ==", "bodyText": "Please update the header of the file to \"2020\".", "url": "https://github.com/eclipse/kapua/pull/3022#discussion_r452625609", "createdAt": "2020-07-10T05:13:08Z", "author": {"login": "LeoNerdoG"}, "path": "service/security/shiro/src/main/java/org/eclipse/kapua/service/authentication/shiro/realm/AccessTokenAuthenticatingRealm.java", "diffHunk": "@@ -11,6 +11,8 @@\n  *******************************************************************************/\n package org.eclipse.kapua.service.authentication.shiro.realm;\n \n+import java.util.Date;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffbf0908976a23fddc003117b3eeabb1d270be8b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYyNTY1MQ==", "bodyText": "Please update the header of the file to \"2020\".", "url": "https://github.com/eclipse/kapua/pull/3022#discussion_r452625651", "createdAt": "2020-07-10T05:13:22Z", "author": {"login": "LeoNerdoG"}, "path": "service/security/shiro/src/main/resources/liquibase/changelog-authentication-master.xml", "diffHunk": "@@ -19,5 +19,6 @@\n     <include relativeToChangelogFile=\"true\" file=\"./0.3.0/changelog-authentication-0.3.0.xml\"/>\n     <include relativeToChangelogFile=\"true\" file=\"./1.0.0/changelog-authentication-1.0.0.xml\"/>\n     <include relativeToChangelogFile=\"true\" file=\"./1.2.0/changelog-authentication-1.2.0.xml\"/>\n+    <include relativeToChangelogFile=\"true\" file=\"./1.3.0/changelog-authentication-1.3.0.xml\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffbf0908976a23fddc003117b3eeabb1d270be8b"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8910ffefd03743a0a00386c513dcfc5d616bfcc", "author": {"user": {"login": "lorthirk", "name": "Claudio Mezzasalma"}}, "url": "https://github.com/eclipse/kapua/commit/a8910ffefd03743a0a00386c513dcfc5d616bfcc", "committedDate": "2020-07-10T08:23:39Z", "message": "Use index to search for AccessTokens\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ffbf0908976a23fddc003117b3eeabb1d270be8b", "author": {"user": {"login": "lorthirk", "name": "Claudio Mezzasalma"}}, "url": "https://github.com/eclipse/kapua/commit/ffbf0908976a23fddc003117b3eeabb1d270be8b", "committedDate": "2020-07-09T15:27:29Z", "message": "Use index to search for AccessTokens\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>"}, "afterCommit": {"oid": "a8910ffefd03743a0a00386c513dcfc5d616bfcc", "author": {"user": {"login": "lorthirk", "name": "Claudio Mezzasalma"}}, "url": "https://github.com/eclipse/kapua/commit/a8910ffefd03743a0a00386c513dcfc5d616bfcc", "committedDate": "2020-07-10T08:23:39Z", "message": "Use index to search for AccessTokens\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MzU1OTU2", "url": "https://github.com/eclipse/kapua/pull/3022#pullrequestreview-446355956", "createdAt": "2020-07-10T12:21:17Z", "commit": {"oid": "a8910ffefd03743a0a00386c513dcfc5d616bfcc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NzA1MTQ1", "url": "https://github.com/eclipse/kapua/pull/3022#pullrequestreview-448705145", "createdAt": "2020-07-15T07:42:11Z", "commit": {"oid": "a8910ffefd03743a0a00386c513dcfc5d616bfcc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 187, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}