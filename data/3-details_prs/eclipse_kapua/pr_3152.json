{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2NjQ5MjEy", "number": 3152, "title": "Extend accountSelfEdit support in Configurations", "bodyText": "Extending support for allowSelfEdit in Service configurations. A field marked with allowSelfEdit=\"true\" in the Service Metadata XML can be edited by users of the account itself, not only from the parent account. As a first use case, all the configurations of CredentialsService are now self-editable.\nAn user can edit its own allowSelfEdit=\"true\" configurations in the \"Settings\" view of the console, or via REST API.\nRelated Issue\nNo related issues", "createdAt": "2020-11-24T17:37:28Z", "url": "https://github.com/eclipse/kapua/pull/3152", "merged": true, "mergeCommit": {"oid": "e2ae855574bfff86c678c305adf4c2dc2aef9285"}, "closed": true, "closedAt": "2020-12-11T12:39:24Z", "author": {"login": "lorthirk"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdf8_rsgFqTUzODE5NDYzNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkbN90ABqjQwODg5MDM4Mzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MTk0NjM1", "url": "https://github.com/eclipse/kapua/pull/3152#pullrequestreview-538194635", "createdAt": "2020-11-25T06:43:12Z", "commit": {"oid": "03132d2c3f37f8bca9fae09340ceef394e3e71e5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNjo0MzoxMlrOH5lHUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNjo0MzoxMlrOH5lHUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzODk2Mw==", "bodyText": "I think that this message should be \"The configuration \"%s\" cannot be changed by this user in this account\" or something similar. What do you think?", "url": "https://github.com/eclipse/kapua/pull/3152#discussion_r530138963", "createdAt": "2020-11-25T06:43:12Z", "author": {"login": "LeoNerdoG"}, "path": "commons/src/main/java/org/eclipse/kapua/commons/configuration/AbstractKapuaConfigurableService.java", "diffHunk": "@@ -391,18 +393,35 @@ public void setConfigValues(KapuaId scopeId, KapuaId parentId, Map<String, Objec\n         KapuaLocator locator = KapuaLocator.getInstance();\n         AuthorizationService authorizationService = locator.getService(AuthorizationService.class);\n         PermissionFactory permissionFactory = locator.getFactory(PermissionFactory.class);\n-        UserService userService = locator.getService(UserService.class);\n+        KapuaTocd ocd = getConfigMetadata(scopeId, false);\n \n+        UserService userService = locator.getService(UserService.class);\n         String rootUserName = SystemSetting.getInstance().getString(SystemSettingKey.SYS_ADMIN_USERNAME);\n         User rootUser = KapuaSecurityUtils.doPrivileged(() -> userService.findByName(rootUserName));\n-        if (!KapuaSecurityUtils.getSession().getUserId().equals(rootUser.getId()) && KapuaSecurityUtils.getSession().getScopeId().equals(scopeId)) {\n-            // Prevent someone to change his own configurations, unless it's the root user\n-            throw KapuaException.internalError(\"An user cannot change service settings on his own account\");\n+\n+        Map<String, Object> originalValues = getConfigValues(scopeId);\n+\n+        for (KapuaTad ad : ocd.getAD()) {\n+            boolean allowSelfEdit = Boolean.parseBoolean(ad.getOtherAttributes().getOrDefault(new QName(\"allowSelfEdit\"), \"false\"));\n+\n+            boolean preventChange =\n+                    // if current user is not root user...\n+                    !KapuaSecurityUtils.getSession().getUserId().equals(rootUser.getId()) &&\n+                    // current configuration does not allow self edit...\n+                    !allowSelfEdit &&\n+                    // a configuration for the current logged account is about to be changed...\n+                    KapuaSecurityUtils.getSession().getScopeId().equals(scopeId) &&\n+                    // and the new value is different from the other one...\n+                    !originalValues.get(ad.getId()).equals(values.get(ad.getId()));\n+\n+            if (preventChange) {\n+                // ... prevent the change!\n+                throw KapuaException.internalError(String.format(\"The configuration \\\"%s\\\" cannot be changed from an user of the account\", ad.getId()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03132d2c3f37f8bca9fae09340ceef394e3e71e5"}, "originalPosition": 72}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "03132d2c3f37f8bca9fae09340ceef394e3e71e5", "author": {"user": {"login": "lorthirk", "name": "Claudio Mezzasalma"}}, "url": "https://github.com/eclipse/kapua/commit/03132d2c3f37f8bca9fae09340ceef394e3e71e5", "committedDate": "2020-11-24T17:29:35Z", "message": "Mark CredentialService configurations as \"allowSelfEdit\"\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>"}, "afterCommit": {"oid": "67ae331eaa809cca56f5311b24eccbdd5d67795f", "author": {"user": {"login": "lorthirk", "name": "Claudio Mezzasalma"}}, "url": "https://github.com/eclipse/kapua/commit/67ae331eaa809cca56f5311b24eccbdd5d67795f", "committedDate": "2020-11-26T10:57:09Z", "message": "Mark CredentialService configurations as \"allowSelfEdit\"\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5MjE5NTE3", "url": "https://github.com/eclipse/kapua/pull/3152#pullrequestreview-539219517", "createdAt": "2020-11-26T11:12:03Z", "commit": {"oid": "67ae331eaa809cca56f5311b24eccbdd5d67795f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5MjMxMzUx", "url": "https://github.com/eclipse/kapua/pull/3152#pullrequestreview-539231351", "createdAt": "2020-11-26T11:28:54Z", "commit": {"oid": "67ae331eaa809cca56f5311b24eccbdd5d67795f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "67ae331eaa809cca56f5311b24eccbdd5d67795f", "author": {"user": {"login": "lorthirk", "name": "Claudio Mezzasalma"}}, "url": "https://github.com/eclipse/kapua/commit/67ae331eaa809cca56f5311b24eccbdd5d67795f", "committedDate": "2020-11-26T10:57:09Z", "message": "Mark CredentialService configurations as \"allowSelfEdit\"\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>"}, "afterCommit": {"oid": "21c69b3c587523ef2ab4644b900879fc2692e073", "author": {"user": {"login": "lorthirk", "name": "Claudio Mezzasalma"}}, "url": "https://github.com/eclipse/kapua/commit/21c69b3c587523ef2ab4644b900879fc2692e073", "committedDate": "2020-11-29T09:53:19Z", "message": "Mark CredentialService configurations as \"allowSelfEdit\"\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "21c69b3c587523ef2ab4644b900879fc2692e073", "author": {"user": {"login": "lorthirk", "name": "Claudio Mezzasalma"}}, "url": "https://github.com/eclipse/kapua/commit/21c69b3c587523ef2ab4644b900879fc2692e073", "committedDate": "2020-11-29T09:53:19Z", "message": "Mark CredentialService configurations as \"allowSelfEdit\"\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>"}, "afterCommit": {"oid": "1fb31a938c818de2a3d8f4be3c91cee49057e3b3", "author": {"user": {"login": "lorthirk", "name": "Claudio Mezzasalma"}}, "url": "https://github.com/eclipse/kapua/commit/1fb31a938c818de2a3d8f4be3c91cee49057e3b3", "committedDate": "2020-11-30T08:15:16Z", "message": "Mark CredentialService configurations as \"allowSelfEdit\"\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1fb31a938c818de2a3d8f4be3c91cee49057e3b3", "author": {"user": {"login": "lorthirk", "name": "Claudio Mezzasalma"}}, "url": "https://github.com/eclipse/kapua/commit/1fb31a938c818de2a3d8f4be3c91cee49057e3b3", "committedDate": "2020-11-30T08:15:16Z", "message": "Mark CredentialService configurations as \"allowSelfEdit\"\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>"}, "afterCommit": {"oid": "4eab9efab6715fc09073ccb8eb1ff1143a13b39b", "author": {"user": {"login": "lorthirk", "name": "Claudio Mezzasalma"}}, "url": "https://github.com/eclipse/kapua/commit/4eab9efab6715fc09073ccb8eb1ff1143a13b39b", "committedDate": "2020-11-30T09:27:09Z", "message": "Mark CredentialService configurations as \"allowSelfEdit\"\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4eab9efab6715fc09073ccb8eb1ff1143a13b39b", "author": {"user": {"login": "lorthirk", "name": "Claudio Mezzasalma"}}, "url": "https://github.com/eclipse/kapua/commit/4eab9efab6715fc09073ccb8eb1ff1143a13b39b", "committedDate": "2020-11-30T09:27:09Z", "message": "Mark CredentialService configurations as \"allowSelfEdit\"\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>"}, "afterCommit": {"oid": "de537a81ea1099c30b3230cf5a1486b8c6b71eda", "author": {"user": {"login": "lorthirk", "name": "Claudio Mezzasalma"}}, "url": "https://github.com/eclipse/kapua/commit/de537a81ea1099c30b3230cf5a1486b8c6b71eda", "committedDate": "2020-11-30T13:51:05Z", "message": "Mark CredentialService configurations as \"allowSelfEdit\"\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de537a81ea1099c30b3230cf5a1486b8c6b71eda", "author": {"user": {"login": "lorthirk", "name": "Claudio Mezzasalma"}}, "url": "https://github.com/eclipse/kapua/commit/de537a81ea1099c30b3230cf5a1486b8c6b71eda", "committedDate": "2020-11-30T13:51:05Z", "message": "Mark CredentialService configurations as \"allowSelfEdit\"\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>"}, "afterCommit": {"oid": "203e1064cd85b1dc9960fbc629473b056c128e89", "author": {"user": {"login": "lorthirk", "name": "Claudio Mezzasalma"}}, "url": "https://github.com/eclipse/kapua/commit/203e1064cd85b1dc9960fbc629473b056c128e89", "committedDate": "2020-12-01T11:44:02Z", "message": "Mark CredentialService configurations as \"allowSelfEdit\"\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "203e1064cd85b1dc9960fbc629473b056c128e89", "author": {"user": {"login": "lorthirk", "name": "Claudio Mezzasalma"}}, "url": "https://github.com/eclipse/kapua/commit/203e1064cd85b1dc9960fbc629473b056c128e89", "committedDate": "2020-12-01T11:44:02Z", "message": "Mark CredentialService configurations as \"allowSelfEdit\"\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>"}, "afterCommit": {"oid": "eb6cc3878ced15dc8dec42de1240672e3192f302", "author": {"user": {"login": "lorthirk", "name": "Claudio Mezzasalma"}}, "url": "https://github.com/eclipse/kapua/commit/eb6cc3878ced15dc8dec42de1240672e3192f302", "committedDate": "2020-12-09T09:16:07Z", "message": "Mark CredentialService configurations as \"allowSelfEdit\"\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ceaf1c1aafef1a415e6ed6447329e74d82ca04e1", "author": {"user": {"login": "lorthirk", "name": "Claudio Mezzasalma"}}, "url": "https://github.com/eclipse/kapua/commit/ceaf1c1aafef1a415e6ed6447329e74d82ca04e1", "committedDate": "2020-12-09T09:20:46Z", "message": "More services should not be configurable\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20b6787656011661bc4315b042eb5ec83e66f20c", "author": {"user": {"login": "lorthirk", "name": "Claudio Mezzasalma"}}, "url": "https://github.com/eclipse/kapua/commit/20b6787656011661bc4315b042eb5ec83e66f20c", "committedDate": "2020-12-09T09:21:04Z", "message": "Extend \"allowSelfEdit\" support\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11a52e0ea8f5f6fe608f6ae5b97d95e00e598b82", "author": {"user": {"login": "lorthirk", "name": "Claudio Mezzasalma"}}, "url": "https://github.com/eclipse/kapua/commit/11a52e0ea8f5f6fe608f6ae5b97d95e00e598b82", "committedDate": "2020-12-09T09:21:04Z", "message": "Mark CredentialService configurations as \"allowSelfEdit\"\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eb6cc3878ced15dc8dec42de1240672e3192f302", "author": {"user": {"login": "lorthirk", "name": "Claudio Mezzasalma"}}, "url": "https://github.com/eclipse/kapua/commit/eb6cc3878ced15dc8dec42de1240672e3192f302", "committedDate": "2020-12-09T09:16:07Z", "message": "Mark CredentialService configurations as \"allowSelfEdit\"\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>"}, "afterCommit": {"oid": "11a52e0ea8f5f6fe608f6ae5b97d95e00e598b82", "author": {"user": {"login": "lorthirk", "name": "Claudio Mezzasalma"}}, "url": "https://github.com/eclipse/kapua/commit/11a52e0ea8f5f6fe608f6ae5b97d95e00e598b82", "committedDate": "2020-12-09T09:21:04Z", "message": "Mark CredentialService configurations as \"allowSelfEdit\"\n\nSigned-off-by: Claudio Mezzasalma <claudio.mezzasalma@eurotech.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 169, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}