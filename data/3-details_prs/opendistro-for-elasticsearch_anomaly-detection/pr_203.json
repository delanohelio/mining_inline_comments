{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0MjQ5ODg2", "number": 203, "title": "Allows window size to be set per detector.", "bodyText": "Description of changes:\n\nThis change adds a new windowSize instance variable to the AnomalyDetector class along with a public getter for this variable, which the model uses to determine the shingle size.\nThe Create Detector and Update Detector APIs allow window_size to be set per detector. If no window_size param is provided, the default is set to 8.\nThe Get Detector, Preview Detector, and Search Detector APIs will also reflect the window_size value in the API response.\nThe FeatureManager and ModelManager classes have shingleSize removed as instance variables, and instead gets the shingle size from the anomaly detector that is passed to their methods.\nThe maxMissingPoints (that determines how many data points can be missing and still form a valid shingle) is set to be at most 25% of the shingle size. The floor is still set to the same as before: max(2, shingleSize). The maxNeighborDistance (max number of intervals away that a data point value can be imputed to a missing data point) is the same as before: max(2, shingleSize).\n6 new unit tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-08-06T20:33:54Z", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/203", "merged": true, "mergeCommit": {"oid": "f03f63f33e036ae1046c15e688361681dbab1a67"}, "closed": true, "closedAt": "2020-08-13T20:27:49Z", "author": {"login": "LiuJoyceC"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8aAKjgFqTQ2Mjk2ODYyOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-lGdoAFqTQ2NzA2Mzg5Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyOTY4NjI5", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/203#pullrequestreview-462968629", "createdAt": "2020-08-07T00:54:04Z", "commit": {"oid": "126b3198bfa4ff66a640cb843bee6880686713ec"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwMDo1NDowNFrOG9I4fA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwMToxNDo1NVrOG9JNZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc2MTg1Mg==", "bodyText": "minor. why not follow the convention of other optional fields?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/203#discussion_r466761852", "createdAt": "2020-08-07T00:54:04Z", "author": {"login": "wnbts"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/AnomalyDetector.java", "diffHunk": "@@ -199,7 +206,7 @@ public static AnomalyDetector parse(XContentParser parser, String detectorId) th\n      * @throws IOException IOException if content can't be parsed correctly\n      */\n     public static AnomalyDetector parse(XContentParser parser, String detectorId, Long version) throws IOException {\n-        return parse(parser, detectorId, version, null, null);\n+        return parse(parser, detectorId, version, null, null, AnomalyDetectorSettings.DEFAULT_SHINGLE_SIZE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "126b3198bfa4ff66a640cb843bee6880686713ec"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc2Mjc4NQ==", "bodyText": "minor. 2 is a hardcoded magic number that should be avoided. if 2 becomes 3, it should be a configuration change and the class and the unit tests should not need to be changed.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/203#discussion_r466762785", "createdAt": "2020-08-07T00:57:51Z", "author": {"login": "wnbts"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/feature/FeatureManager.java", "diffHunk": "@@ -597,6 +594,20 @@ private long truncateToMinute(long epochMillis) {\n         return Instant.ofEpochMilli(epochMillis).truncatedTo(ChronoUnit.MINUTES).toEpochMilli();\n     }\n \n+    /**\n+     * @return max number of missing points allowed to generate a shingle\n+     */\n+    private int getMaxMissingPoints(int shingleSize) {\n+        return Math.max(Math.min(2, shingleSize), (int) Math.floor(shingleSize * 0.25));\n+    }\n+\n+    /**\n+     * @return max distance (number of intervals) between a missing point and a replacement neighbor\n+     */\n+    private int getMaxNeighborDistance(int shingleSize) {\n+        return Math.min(2, shingleSize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "126b3198bfa4ff66a640cb843bee6880686713ec"}, "originalPosition": 233}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc2NDA5NA==", "bodyText": "minor. if the value is from input, a validation can be used such as non-positive values.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/203#discussion_r466764094", "createdAt": "2020-08-07T01:03:06Z", "author": {"login": "wnbts"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/AnomalyDetector.java", "diffHunk": "@@ -285,6 +295,9 @@ public static AnomalyDetector parse(\n                 case WINDOW_DELAY_FIELD:\n                     windowDelay = TimeConfiguration.parse(parser);\n                     break;\n+                case WINDOW_SIZE_FIELD:\n+                    windowSize = parser.intValue();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "126b3198bfa4ff66a640cb843bee6880686713ec"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc2NzIwNQ==", "bodyText": "issue. Limit the imputed to up to 25%. The current value of 2 is based on shingle size 8. When shingle size is 1 ~ 3,  0 is the max. 4 ~ 7, 1.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/203#discussion_r466767205", "createdAt": "2020-08-07T01:14:55Z", "author": {"login": "wnbts"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/feature/FeatureManager.java", "diffHunk": "@@ -597,6 +594,20 @@ private long truncateToMinute(long epochMillis) {\n         return Instant.ofEpochMilli(epochMillis).truncatedTo(ChronoUnit.MINUTES).toEpochMilli();\n     }\n \n+    /**\n+     * @return max number of missing points allowed to generate a shingle\n+     */\n+    private int getMaxMissingPoints(int shingleSize) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "126b3198bfa4ff66a640cb843bee6880686713ec"}, "originalPosition": 225}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5275f5cedca704d80bc027efb3bac9392f5069d2", "author": {"user": {"login": "LiuJoyceC", "name": "Joyce Liu"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/5275f5cedca704d80bc027efb3bac9392f5069d2", "committedDate": "2020-08-08T19:39:38Z", "message": "Allows window size to be set per detector."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "126b3198bfa4ff66a640cb843bee6880686713ec", "author": {"user": {"login": "LiuJoyceC", "name": "Joyce Liu"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/126b3198bfa4ff66a640cb843bee6880686713ec", "committedDate": "2020-08-06T18:45:38Z", "message": "Allows window size to be set per detector."}, "afterCommit": {"oid": "e4fc1e2f14a332971973c6437f71a59f132c6d78", "author": {"user": {"login": "LiuJoyceC", "name": "Joyce Liu"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/e4fc1e2f14a332971973c6437f71a59f132c6d78", "committedDate": "2020-08-08T19:39:38Z", "message": "Changes: changes term window size to shingle size, moves hard-coded values to AnomalyDetectorSettings, limits maxMissingPoints to 25% for all shingleSizes,, validates shingle size is positive integer."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0Njc3MzMw", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/203#pullrequestreview-464677330", "createdAt": "2020-08-11T00:45:44Z", "commit": {"oid": "e4fc1e2f14a332971973c6437f71a59f132c6d78"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50101ad3336b609e99778ee36109f2af18d19ea0", "author": {"user": {"login": "LiuJoyceC", "name": "Joyce Liu"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/50101ad3336b609e99778ee36109f2af18d19ea0", "committedDate": "2020-08-12T02:36:11Z", "message": "Changes: changes term window size to shingle size, moves hard-coded values to AnomalyDetectorSettings, limits maxMissingPoints to 25% for all shingleSizes,, validates shingle size is positive integer."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae010a7844d1dc7a1f94c33796755b237513c5bf", "author": {"user": {"login": "LiuJoyceC", "name": "Joyce Liu"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/ae010a7844d1dc7a1f94c33796755b237513c5bf", "committedDate": "2020-08-12T05:47:50Z", "message": "Change: getShingleSize returns default shingle size if the anomaly detector does not have a shingleSize field."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e4fc1e2f14a332971973c6437f71a59f132c6d78", "author": {"user": {"login": "LiuJoyceC", "name": "Joyce Liu"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/e4fc1e2f14a332971973c6437f71a59f132c6d78", "committedDate": "2020-08-08T19:39:38Z", "message": "Changes: changes term window size to shingle size, moves hard-coded values to AnomalyDetectorSettings, limits maxMissingPoints to 25% for all shingleSizes,, validates shingle size is positive integer."}, "afterCommit": {"oid": "ae010a7844d1dc7a1f94c33796755b237513c5bf", "author": {"user": {"login": "LiuJoyceC", "name": "Joyce Liu"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/ae010a7844d1dc7a1f94c33796755b237513c5bf", "committedDate": "2020-08-12T05:47:50Z", "message": "Change: getShingleSize returns default shingle size if the anomaly detector does not have a shingleSize field."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MTE2ODI5", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/203#pullrequestreview-466116829", "createdAt": "2020-08-12T17:16:24Z", "commit": {"oid": "ae010a7844d1dc7a1f94c33796755b237513c5bf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNzoxNjoyNFrOG_q5Rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNzoxNjoyNFrOG_q5Rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQxNjI2Mw==", "bodyText": "Should the type be short as we don't expect shingle size exceed 32k?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/203#discussion_r469416263", "createdAt": "2020-08-12T17:16:24Z", "author": {"login": "kaituo"}, "path": "src/main/resources/mappings/anomaly-detectors.json", "diffHunk": "@@ -93,6 +93,9 @@\n         }\n       }\n     },\n+    \"shingle_size\": {\n+      \"type\": \"integer\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae010a7844d1dc7a1f94c33796755b237513c5bf"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MDYzODky", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/203#pullrequestreview-467063892", "createdAt": "2020-08-13T19:22:56Z", "commit": {"oid": "ae010a7844d1dc7a1f94c33796755b237513c5bf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1511, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}