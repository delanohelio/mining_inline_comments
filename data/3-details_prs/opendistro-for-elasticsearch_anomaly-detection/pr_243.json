{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwODcyNzAz", "number": 243, "title": "Adding RestActions support Create/Update Detector API", "bodyText": "*Issue #195 *\nDescription of changes:\nAdding RestActions support Create/Update Detector API which is needed to support AD FGAC\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-10-10T00:09:19Z", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/243", "merged": true, "mergeCommit": {"oid": "ebf145ad7f6068cdd45e7663f71b39b86ea6fc76"}, "closed": true, "closedAt": "2020-10-13T00:01:25Z", "author": {"login": "saratvemulapalli"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQyMKtAH2gAyNTAwODcyNzAzOmMzODBjOGZmNjkyNWMxMmY4NzcxMWFlNzM3ZDNhODkyNDAwMGFkZGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdR8-TNAFqTUwNjk4NTI2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c380c8ff6925c12f87711ae737d3a8924000adde", "author": {"user": {"login": "saratvemulapalli", "name": "Sarat Vemulapalli"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/c380c8ff6925c12f87711ae737d3a8924000adde", "committedDate": "2020-10-09T08:48:34Z", "message": "Adding RestActions support for Get Detector API"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1aeb38d6fcf745850c8ab1a839274aacfef38840", "author": {"user": {"login": "saratvemulapalli", "name": "Sarat Vemulapalli"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/1aeb38d6fcf745850c8ab1a839274aacfef38840", "committedDate": "2020-10-09T09:20:41Z", "message": "Updating JobScheduler version for depedent changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41ce6ac25a8f6a2e2e19c579e9976628ac229863", "author": {"user": {"login": "saratvemulapalli", "name": "Sarat Vemulapalli"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/41ce6ac25a8f6a2e2e19c579e9976628ac229863", "committedDate": "2020-10-09T09:28:31Z", "message": "Avoid import *"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14e6ad7a76b7c3cced6bc06b1d08cd24496454ab", "author": {"user": {"login": "saratvemulapalli", "name": "Sarat Vemulapalli"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/14e6ad7a76b7c3cced6bc06b1d08cd24496454ab", "committedDate": "2020-10-09T09:35:55Z", "message": "Adding Spotless changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a99bebb302522414d502b9c09488351a56fc3cb2", "author": {"user": {"login": "saratvemulapalli", "name": "Sarat Vemulapalli"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/a99bebb302522414d502b9c09488351a56fc3cb2", "committedDate": "2020-10-09T18:15:13Z", "message": "Adding Writeable implementations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8e30571a4efb1e59198d02e7e236d9ed6399f5d", "author": {"user": {"login": "saratvemulapalli", "name": "Sarat Vemulapalli"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/f8e30571a4efb1e59198d02e7e236d9ed6399f5d", "committedDate": "2020-10-10T00:06:02Z", "message": "Adding RestActions support Create Detector API"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MDQzODUy", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/243#pullrequestreview-506043852", "createdAt": "2020-10-10T00:11:51Z", "commit": {"oid": "f8e30571a4efb1e59198d02e7e236d9ed6399f5d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQwMDoxMTo1MVrOHfbhgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQwMDoxMTo1MVrOHfbhgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjcxODg1MQ==", "bodyText": "Added IndexAnomalyDetectorRequest using Powermock but JaCoCo doesnt read lines covered by Powermock tests.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/243#discussion_r502718851", "createdAt": "2020-10-10T00:11:51Z", "author": {"login": "saratvemulapalli"}, "path": "build.gradle", "diffHunk": "@@ -254,7 +254,8 @@ List<String> jacocoExclusions = [\n         'com.amazon.opendistroforelasticsearch.ad.transport.StatsAnomalyDetectorTransportAction',\n         'com.amazon.opendistroforelasticsearch.ad.transport.DeleteAnomalyDetectorTransportAction*',\n         'com.amazon.opendistroforelasticsearch.ad.transport.GetAnomalyDetectorTransportAction*',\n-        'com.amazon.opendistroforelasticsearch.ad.transport.GetAnomalyDetectorResponse'\n+        'com.amazon.opendistroforelasticsearch.ad.transport.GetAnomalyDetectorResponse',\n+        'com.amazon.opendistroforelasticsearch.ad.transport.IndexAnomalyDetectorRequest'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8e30571a4efb1e59198d02e7e236d9ed6399f5d"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2ODgzOTU1", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/243#pullrequestreview-506883955", "createdAt": "2020-10-12T20:04:57Z", "commit": {"oid": "f8e30571a4efb1e59198d02e7e236d9ed6399f5d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQyMDowNDo1N1rOHgLpHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQyMDowNDo1N1rOHgLpHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUwNzIyOA==", "bodyText": "Add xContentRegistry ? Same problem for other places", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/243#discussion_r503507228", "createdAt": "2020-10-12T20:04:57Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/rest/handler/AnomalyDetectorActionHandler.java", "diffHunk": "@@ -49,47 +49,57 @@\n      * @param clusterService ES cluster service\n      * @param client ES node client\n      * @param detectorId detector identifier\n-     * @param channel ES rest channel\n+     * @param listener Listener to send response\n      * @param function AD function\n      */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8e30571a4efb1e59198d02e7e236d9ed6399f5d"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2ODk2NjAy", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/243#pullrequestreview-506896602", "createdAt": "2020-10-12T20:30:59Z", "commit": {"oid": "f8e30571a4efb1e59198d02e7e236d9ed6399f5d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQyMDozMTowMFrOHgMSpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQyMDozMTowMFrOHgMSpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUxNzg2MQ==", "bodyText": "Remove System.out.println, check other places too", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/243#discussion_r503517861", "createdAt": "2020-10-12T20:31:00Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/rest/handler/IndexAnomalyDetectorActionHandler.java", "diffHunk": "@@ -132,11 +141,15 @@ public IndexAnomalyDetectorActionHandler(\n      */\n     public void start() throws IOException {\n         if (!anomalyDetectionIndices.doesAnomalyDetectorIndexExist()) {\n+            System.out.println(\"AnomalyDetector Indices do not exist\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8e30571a4efb1e59198d02e7e236d9ed6399f5d"}, "originalPosition": 123}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2OTAyNjQx", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/243#pullrequestreview-506902641", "createdAt": "2020-10-12T20:37:36Z", "commit": {"oid": "f8e30571a4efb1e59198d02e7e236d9ed6399f5d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQyMDozNzozNlrOHgMcUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQyMDozNzozNlrOHgMcUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUyMDMzNg==", "bodyText": "This log is for debugging? If yes, change to debug level or remove it. Same for line 251. Check other places as well", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/243#discussion_r503520336", "createdAt": "2020-10-12T20:37:36Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/rest/handler/IndexAnomalyDetectorActionHandler.java", "diffHunk": "@@ -183,28 +200,35 @@ private void onGetAnomalyDetectorResponse(GetResponse response) throws IOExcepti\n \n     private void createAnomalyDetector() {\n         try {\n+            logger.info(\"#198 Request Method is PUT \");\n             QueryBuilder query = QueryBuilders.matchAllQuery();\n             SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder().query(query).size(0).timeout(requestTimeout);\n \n             SearchRequest searchRequest = new SearchRequest(ANOMALY_DETECTORS_INDEX).source(searchSourceBuilder);\n \n-            client.search(searchRequest, ActionListener.wrap(response -> onSearchAdResponse(response), exception -> onFailure(exception)));\n+            client\n+                .search(\n+                    searchRequest,\n+                    ActionListener.wrap(response -> onSearchAdResponse(response), exception -> listener.onFailure(exception))\n+                );\n         } catch (Exception e) {\n-            onFailure(e);\n+            listener.onFailure(e);\n         }\n     }\n \n     private void onSearchAdResponse(SearchResponse response) throws IOException {\n+        logger.info(\"#211 onSearchAdResponse is called \");\n         if (response.getHits().getTotalHits().value >= maxAnomalyDetectors) {\n             String errorMsg = \"Can't create anomaly detector more than \" + maxAnomalyDetectors;\n             logger.error(errorMsg);\n-            onFailure(new IllegalArgumentException(errorMsg));\n+            listener.onFailure(new IllegalArgumentException(errorMsg));\n         } else {\n             searchAdInputIndices(null);\n         }\n     }\n \n     private void searchAdInputIndices(String detectorId) {\n+        logger.info(\"#222 searchAdInputIndices is called \");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8e30571a4efb1e59198d02e7e236d9ed6399f5d"}, "originalPosition": 218}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22ac7b42350be8ec70539c97f8d5e1e77f8089a3", "author": {"user": {"login": "saratvemulapalli", "name": "Sarat Vemulapalli"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/22ac7b42350be8ec70539c97f8d5e1e77f8089a3", "committedDate": "2020-10-12T20:37:44Z", "message": "Adding few comments and removing development logs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2OTA1MjI4", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/243#pullrequestreview-506905228", "createdAt": "2020-10-12T20:43:06Z", "commit": {"oid": "f8e30571a4efb1e59198d02e7e236d9ed6399f5d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQyMDo0MzowNlrOHgMkew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQyMDo0MzowNlrOHgMkew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUyMjQyNw==", "bodyText": "Change logger name to current class GetAnomalyDetectorTransportAction.class", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/243#discussion_r503522427", "createdAt": "2020-10-12T20:43:06Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/GetAnomalyDetectorTransportAction.java", "diffHunk": "@@ -0,0 +1,232 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.transport;\n+\n+import static com.amazon.opendistroforelasticsearch.ad.model.AnomalyDetector.ANOMALY_DETECTORS_INDEX;\n+import static com.amazon.opendistroforelasticsearch.ad.model.AnomalyDetectorJob.ANOMALY_DETECTOR_JOB_INDEX;\n+import static com.amazon.opendistroforelasticsearch.ad.util.RestHandlerUtils.PROFILE;\n+import static org.elasticsearch.common.xcontent.XContentParserUtils.ensureExpectedToken;\n+\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchStatusException;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.get.MultiGetItemResponse;\n+import org.elasticsearch.action.get.MultiGetRequest;\n+import org.elasticsearch.action.get.MultiGetResponse;\n+import org.elasticsearch.action.support.ActionFilters;\n+import org.elasticsearch.action.support.HandledTransportAction;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.CheckedConsumer;\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.inject.Inject;\n+import org.elasticsearch.common.xcontent.NamedXContentRegistry;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestResponse;\n+import org.elasticsearch.rest.RestStatus;\n+import org.elasticsearch.tasks.Task;\n+import org.elasticsearch.transport.TransportService;\n+\n+import com.amazon.opendistroforelasticsearch.ad.AnomalyDetectorProfileRunner;\n+import com.amazon.opendistroforelasticsearch.ad.model.AnomalyDetector;\n+import com.amazon.opendistroforelasticsearch.ad.model.AnomalyDetectorJob;\n+import com.amazon.opendistroforelasticsearch.ad.model.DetectorProfile;\n+import com.amazon.opendistroforelasticsearch.ad.model.ProfileName;\n+import com.amazon.opendistroforelasticsearch.ad.settings.AnomalyDetectorSettings;\n+import com.amazon.opendistroforelasticsearch.ad.util.DiscoveryNodeFilterer;\n+import com.amazon.opendistroforelasticsearch.ad.util.RestHandlerUtils;\n+import com.google.common.collect.Sets;\n+\n+public class GetAnomalyDetectorTransportAction extends HandledTransportAction<GetAnomalyDetectorRequest, GetAnomalyDetectorResponse> {\n+\n+    private static final Logger LOG = LogManager.getLogger(StopDetectorTransportAction.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8e30571a4efb1e59198d02e7e236d9ed6399f5d"}, "originalPosition": 62}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39a1f0bd04ccd737703b982e9b8c64b9f155b1a8", "author": {"user": {"login": "saratvemulapalli", "name": "Sarat Vemulapalli"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/39a1f0bd04ccd737703b982e9b8c64b9f155b1a8", "committedDate": "2020-10-12T20:49:05Z", "message": "Merging master to this branch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "389cee89e16862d7c2eced91f59a20a7d11e741d", "author": {"user": {"login": "saratvemulapalli", "name": "Sarat Vemulapalli"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/389cee89e16862d7c2eced91f59a20a7d11e741d", "committedDate": "2020-10-12T20:52:32Z", "message": "Merge branch 'master' into fgac-start-api"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2OTIzOTQ1", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/243#pullrequestreview-506923945", "createdAt": "2020-10-12T21:21:45Z", "commit": {"oid": "389cee89e16862d7c2eced91f59a20a7d11e741d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2OTg1MjY5", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/243#pullrequestreview-506985269", "createdAt": "2020-10-12T23:56:18Z", "commit": {"oid": "389cee89e16862d7c2eced91f59a20a7d11e741d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1563, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}