{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5NTE3MjU2", "number": 241, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwMDoyODoyOVrOEr11EA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwODoxODo0MlrOEr8wwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0NDA2MTYwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/AnomalyDetector.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwMDoyODoyOVrOHe1VrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxODo0OTo1M1rOHgJpSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA5MzIyOQ==", "bodyText": "You may refactor this constructor to\npublic AnomalyDetector(....,lastUpdateTime) {\n     new AnomalyDetector(....,lastUpdateTime, null);\n}", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/241#discussion_r502093229", "createdAt": "2020-10-09T00:28:29Z", "author": {"login": "yizheliu-amazon"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/AnomalyDetector.java", "diffHunk": "@@ -151,6 +210,7 @@ public AnomalyDetector(\n         this.uiMetadata = uiMetadata;\n         this.schemaVersion = schemaVersion;\n         this.lastUpdateTime = lastUpdateTime;\n+        this.categoryField = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c9214152b9256fee439dd545f942ad831aee1aa"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ3NDUwNA==", "bodyText": "Yes, changed.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/241#discussion_r503474504", "createdAt": "2020-10-12T18:49:53Z", "author": {"login": "kaituo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/AnomalyDetector.java", "diffHunk": "@@ -151,6 +210,7 @@ public AnomalyDetector(\n         this.uiMetadata = uiMetadata;\n         this.schemaVersion = schemaVersion;\n         this.lastUpdateTime = lastUpdateTime;\n+        this.categoryField = null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA5MzIyOQ=="}, "originalCommit": {"oid": "6c9214152b9256fee439dd545f942ad831aee1aa"}, "originalPosition": 97}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0NDA2MzgxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/AnomalyResult.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwMDoyOTo0NVrOHe1W8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxODo1ODozNVrOHgJ4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA5MzU1Mw==", "bodyText": "same comment as above to refactor constructor", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/241#discussion_r502093553", "createdAt": "2020-10-09T00:29:45Z", "author": {"login": "yizheliu-amazon"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/AnomalyResult.java", "diffHunk": "@@ -91,6 +95,55 @@ public AnomalyResult(\n         this.executionStartTime = executionStartTime;\n         this.executionEndTime = executionEndTime;\n         this.error = error;\n+        this.entity = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c9214152b9256fee439dd545f942ad831aee1aa"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ3ODMyOA==", "bodyText": "changed", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/241#discussion_r503478328", "createdAt": "2020-10-12T18:58:35Z", "author": {"login": "kaituo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/AnomalyResult.java", "diffHunk": "@@ -91,6 +95,55 @@ public AnomalyResult(\n         this.executionStartTime = executionStartTime;\n         this.executionEndTime = executionEndTime;\n         this.error = error;\n+        this.entity = null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA5MzU1Mw=="}, "originalCommit": {"oid": "6c9214152b9256fee439dd545f942ad831aee1aa"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0NTAzNzg4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/AnomalyDetector.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwNzozMTozNVrOHe-TVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxODo1MDoxN1rOHgJqIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI0MDA4NQ==", "bodyText": "This PR has some overlap with #240 ?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/241#discussion_r502240085", "createdAt": "2020-10-09T07:31:35Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/AnomalyDetector.java", "diffHunk": "@@ -105,7 +109,62 @@\n      * @param uiMetadata        metadata used by Kibana\n      * @param schemaVersion     anomaly detector index mapping version\n      * @param lastUpdateTime    detector's last update time\n+     * @param categoryField     a list of partition fields\n      */\n+    public AnomalyDetector(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c9214152b9256fee439dd545f942ad831aee1aa"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ3NDcyMQ==", "bodyText": "Yes, they have common dependencies.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/241#discussion_r503474721", "createdAt": "2020-10-12T18:50:17Z", "author": {"login": "kaituo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/AnomalyDetector.java", "diffHunk": "@@ -105,7 +109,62 @@\n      * @param uiMetadata        metadata used by Kibana\n      * @param schemaVersion     anomaly detector index mapping version\n      * @param lastUpdateTime    detector's last update time\n+     * @param categoryField     a list of partition fields\n      */\n+    public AnomalyDetector(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI0MDA4NQ=="}, "originalCommit": {"oid": "6c9214152b9256fee439dd545f942ad831aee1aa"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0NTA3MjQzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/AnomalyDetector.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwNzo0Mjo0MFrOHe-oaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxODo1Njo1MFrOHgJ1Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI0NTQ4MQ==", "bodyText": "How about we move this logic to detector constructor\uff1fAlways set shingle size as default value if it's null. Then this get method can return shingleSize directly; and we should persist shingle size in detector document even it's default shingle size in case the default shingle size changes in future.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/241#discussion_r502245481", "createdAt": "2020-10-09T07:42:40Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/AnomalyDetector.java", "diffHunk": "@@ -428,7 +497,9 @@ public TimeConfiguration getWindowDelay() {\n     }\n \n     public Integer getShingleSize() {\n-        return shingleSize == null ? DEFAULT_SHINGLE_SIZE : shingleSize;\n+        return shingleSize == null", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c9214152b9256fee439dd545f942ad831aee1aa"}, "originalPosition": 145}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ3NzU1NQ==", "bodyText": "good idea.  Changed.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/241#discussion_r503477555", "createdAt": "2020-10-12T18:56:50Z", "author": {"login": "kaituo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/AnomalyDetector.java", "diffHunk": "@@ -428,7 +497,9 @@ public TimeConfiguration getWindowDelay() {\n     }\n \n     public Integer getShingleSize() {\n-        return shingleSize == null ? DEFAULT_SHINGLE_SIZE : shingleSize;\n+        return shingleSize == null", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI0NTQ4MQ=="}, "originalCommit": {"oid": "6c9214152b9256fee439dd545f942ad831aee1aa"}, "originalPosition": 145}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0NTEzMzMwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/Entity.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwODowMDo1OFrOHe_N0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxOTo0OTozMFrOHgLJOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI1NTA1Nw==", "bodyText": "name is category field name and value is the entity's unique value? For example, name will be \"IP\" and value will be 53.230.198.42 ?\nIs it necessary to store same name for every AD result doc ? As high cardinality detector will generate too much AD results, I think it will save some disk usage if we remove such duplicate information (same for feature data).", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/241#discussion_r502255057", "createdAt": "2020-10-09T08:00:58Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/Entity.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.model;\n+\n+import static org.elasticsearch.common.xcontent.XContentParserUtils.ensureExpectedToken;\n+\n+import java.io.IOException;\n+\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.io.stream.Writeable;\n+import org.elasticsearch.common.xcontent.ToXContentObject;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+\n+import com.amazon.opendistroforelasticsearch.ad.annotation.Generated;\n+import com.google.common.base.Objects;\n+\n+/**\n+ * Categorical field name and its value\n+ * @author kaituo\n+ *\n+ */\n+public class Entity implements ToXContentObject, Writeable {\n+    public static final String ENTITY_NAME_FIELD = \"name\";\n+    public static final String ENTITY_VALUE_FIELD = \"value\";\n+\n+    private final String name;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c9214152b9256fee439dd545f942ad831aee1aa"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ4MDY5MA==", "bodyText": "yes, your understanding is correct.  I am mostly doing this for the future: in case we have multiple categorical fields and the parser knows which value belongs to which field.  Open to change if we have a solution.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/241#discussion_r503480690", "createdAt": "2020-10-12T19:04:17Z", "author": {"login": "kaituo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/Entity.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.model;\n+\n+import static org.elasticsearch.common.xcontent.XContentParserUtils.ensureExpectedToken;\n+\n+import java.io.IOException;\n+\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.io.stream.Writeable;\n+import org.elasticsearch.common.xcontent.ToXContentObject;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+\n+import com.amazon.opendistroforelasticsearch.ad.annotation.Generated;\n+import com.google.common.base.Objects;\n+\n+/**\n+ * Categorical field name and its value\n+ * @author kaituo\n+ *\n+ */\n+public class Entity implements ToXContentObject, Writeable {\n+    public static final String ENTITY_NAME_FIELD = \"name\";\n+    public static final String ENTITY_VALUE_FIELD = \"value\";\n+\n+    private final String name;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI1NTA1Nw=="}, "originalCommit": {"oid": "6c9214152b9256fee439dd545f942ad831aee1aa"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ5OTA2NQ==", "bodyText": "Let's keep it as is currently. Remove these duplicate fields needs some snapshot mechanism to track the old version of detector configuration. Let's discuss more to make a decision.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/241#discussion_r503499065", "createdAt": "2020-10-12T19:49:30Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/Entity.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.model;\n+\n+import static org.elasticsearch.common.xcontent.XContentParserUtils.ensureExpectedToken;\n+\n+import java.io.IOException;\n+\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.io.stream.Writeable;\n+import org.elasticsearch.common.xcontent.ToXContentObject;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+\n+import com.amazon.opendistroforelasticsearch.ad.annotation.Generated;\n+import com.google.common.base.Objects;\n+\n+/**\n+ * Categorical field name and its value\n+ * @author kaituo\n+ *\n+ */\n+public class Entity implements ToXContentObject, Writeable {\n+    public static final String ENTITY_NAME_FIELD = \"name\";\n+    public static final String ENTITY_VALUE_FIELD = \"value\";\n+\n+    private final String name;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI1NTA1Nw=="}, "originalCommit": {"oid": "6c9214152b9256fee439dd545f942ad831aee1aa"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0NTE5NzQ1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/ADResultBulkTransportAction.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwODoxODo0MlrOHe_1dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxOTowNToxM1rOHgKDNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI2NTIwNw==", "bodyText": "Check bulk request size, if no anomaly result, no need to execute bulk index.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/241#discussion_r502265207", "createdAt": "2020-10-09T08:18:42Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/ADResultBulkTransportAction.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.transport;\n+\n+import static com.amazon.opendistroforelasticsearch.ad.settings.AnomalyDetectorSettings.INDEX_PRESSURE_SOFT_LIMIT;\n+import static org.elasticsearch.common.xcontent.XContentFactory.jsonBuilder;\n+import static org.elasticsearch.index.IndexingPressure.MAX_INDEXING_BYTES;\n+\n+import java.io.IOException;\n+import java.util.Random;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.bulk.BulkAction;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.action.support.ActionFilters;\n+import org.elasticsearch.action.support.HandledTransportAction;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.inject.Inject;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.index.IndexingPressure;\n+import org.elasticsearch.tasks.Task;\n+import org.elasticsearch.threadpool.ThreadPool;\n+import org.elasticsearch.transport.TransportService;\n+\n+import com.amazon.opendistroforelasticsearch.ad.constant.CommonName;\n+import com.amazon.opendistroforelasticsearch.ad.model.AnomalyResult;\n+import com.amazon.opendistroforelasticsearch.ad.util.RestHandlerUtils;\n+\n+public class ADResultBulkTransportAction extends HandledTransportAction<ADResultBulkRequest, BulkResponse> {\n+\n+    private static final Logger LOG = LogManager.getLogger(ADResultBulkAction.class);\n+    private IndexingPressure indexingPressure;\n+    private final long primaryAndCoordinatingLimits;\n+    private float softLimit;\n+    private String indexName;\n+    private Client client;\n+\n+    @Inject\n+    public ADResultBulkTransportAction(\n+        TransportService transportService,\n+        ActionFilters actionFilters,\n+        IndexingPressure indexingPressure,\n+        Settings settings,\n+        ClusterService clusterService,\n+        Client client\n+    ) {\n+        super(ADResultBulkAction.NAME, transportService, actionFilters, ADResultBulkRequest::new, ThreadPool.Names.SAME);\n+        this.indexingPressure = indexingPressure;\n+        this.primaryAndCoordinatingLimits = MAX_INDEXING_BYTES.get(settings).getBytes();\n+        this.softLimit = INDEX_PRESSURE_SOFT_LIMIT.get(settings);\n+        this.indexName = CommonName.ANOMALY_RESULT_INDEX_ALIAS;\n+        this.client = client;\n+        clusterService.getClusterSettings().addSettingsUpdateConsumer(INDEX_PRESSURE_SOFT_LIMIT, it -> softLimit = it);\n+    }\n+\n+    @Override\n+    protected void doExecute(Task task, ADResultBulkRequest request, ActionListener<BulkResponse> listener) {\n+        // Concurrent indexing memory limit = 10% of heap\n+        // indexing pressure = indexing bytes / indexing limit\n+        // Write all until index pressure (global indexing memory pressure) is less than 80% of 10% of heap. Otherwise, index\n+        // all non-zero anomaly grade index requests and index zero anomaly grade index requests with probability (1 - index pressure).\n+        long totalBytes = indexingPressure.getCurrentCombinedCoordinatingAndPrimaryBytes() + indexingPressure.getCurrentReplicaBytes();\n+        LOG.info(primaryAndCoordinatingLimits + \" \" + totalBytes);\n+        float indexingPressurePercent = (float) totalBytes / primaryAndCoordinatingLimits;\n+\n+        BulkRequest bulkRequest = new BulkRequest();\n+\n+        if (indexingPressurePercent <= softLimit) {\n+            for (AnomalyResult result : request.getAnomalyResults()) {\n+                addResult(bulkRequest, result);\n+            }\n+        } else if (Float.compare(indexingPressurePercent, 1.0f) < 0) {\n+            // exceed soft limit (80%) but smaller than hard limit (100%)\n+            // random seed is 42. Can be any number\n+            Random random = new Random(42);\n+            float acceptProbability = 1 - indexingPressurePercent;\n+            for (AnomalyResult result : request.getAnomalyResults()) {\n+                if (result.getAnomalyGrade() > 0 || random.nextFloat() < acceptProbability) {\n+                    addResult(bulkRequest, result);\n+                }\n+            }\n+        } else {\n+            // if exceeding 100% of hard limit, try our luck and only index non-zero grade result\n+            for (AnomalyResult result : request.getAnomalyResults()) {\n+                if (result.getAnomalyGrade() > 0) {\n+                    addResult(bulkRequest, result);\n+                }\n+            }\n+        }\n+\n+        client", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c9214152b9256fee439dd545f942ad831aee1aa"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ4MTE0Mg==", "bodyText": "good catch.  Added.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/241#discussion_r503481142", "createdAt": "2020-10-12T19:05:13Z", "author": {"login": "kaituo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/ADResultBulkTransportAction.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.transport;\n+\n+import static com.amazon.opendistroforelasticsearch.ad.settings.AnomalyDetectorSettings.INDEX_PRESSURE_SOFT_LIMIT;\n+import static org.elasticsearch.common.xcontent.XContentFactory.jsonBuilder;\n+import static org.elasticsearch.index.IndexingPressure.MAX_INDEXING_BYTES;\n+\n+import java.io.IOException;\n+import java.util.Random;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.bulk.BulkAction;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.action.support.ActionFilters;\n+import org.elasticsearch.action.support.HandledTransportAction;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.inject.Inject;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.index.IndexingPressure;\n+import org.elasticsearch.tasks.Task;\n+import org.elasticsearch.threadpool.ThreadPool;\n+import org.elasticsearch.transport.TransportService;\n+\n+import com.amazon.opendistroforelasticsearch.ad.constant.CommonName;\n+import com.amazon.opendistroforelasticsearch.ad.model.AnomalyResult;\n+import com.amazon.opendistroforelasticsearch.ad.util.RestHandlerUtils;\n+\n+public class ADResultBulkTransportAction extends HandledTransportAction<ADResultBulkRequest, BulkResponse> {\n+\n+    private static final Logger LOG = LogManager.getLogger(ADResultBulkAction.class);\n+    private IndexingPressure indexingPressure;\n+    private final long primaryAndCoordinatingLimits;\n+    private float softLimit;\n+    private String indexName;\n+    private Client client;\n+\n+    @Inject\n+    public ADResultBulkTransportAction(\n+        TransportService transportService,\n+        ActionFilters actionFilters,\n+        IndexingPressure indexingPressure,\n+        Settings settings,\n+        ClusterService clusterService,\n+        Client client\n+    ) {\n+        super(ADResultBulkAction.NAME, transportService, actionFilters, ADResultBulkRequest::new, ThreadPool.Names.SAME);\n+        this.indexingPressure = indexingPressure;\n+        this.primaryAndCoordinatingLimits = MAX_INDEXING_BYTES.get(settings).getBytes();\n+        this.softLimit = INDEX_PRESSURE_SOFT_LIMIT.get(settings);\n+        this.indexName = CommonName.ANOMALY_RESULT_INDEX_ALIAS;\n+        this.client = client;\n+        clusterService.getClusterSettings().addSettingsUpdateConsumer(INDEX_PRESSURE_SOFT_LIMIT, it -> softLimit = it);\n+    }\n+\n+    @Override\n+    protected void doExecute(Task task, ADResultBulkRequest request, ActionListener<BulkResponse> listener) {\n+        // Concurrent indexing memory limit = 10% of heap\n+        // indexing pressure = indexing bytes / indexing limit\n+        // Write all until index pressure (global indexing memory pressure) is less than 80% of 10% of heap. Otherwise, index\n+        // all non-zero anomaly grade index requests and index zero anomaly grade index requests with probability (1 - index pressure).\n+        long totalBytes = indexingPressure.getCurrentCombinedCoordinatingAndPrimaryBytes() + indexingPressure.getCurrentReplicaBytes();\n+        LOG.info(primaryAndCoordinatingLimits + \" \" + totalBytes);\n+        float indexingPressurePercent = (float) totalBytes / primaryAndCoordinatingLimits;\n+\n+        BulkRequest bulkRequest = new BulkRequest();\n+\n+        if (indexingPressurePercent <= softLimit) {\n+            for (AnomalyResult result : request.getAnomalyResults()) {\n+                addResult(bulkRequest, result);\n+            }\n+        } else if (Float.compare(indexingPressurePercent, 1.0f) < 0) {\n+            // exceed soft limit (80%) but smaller than hard limit (100%)\n+            // random seed is 42. Can be any number\n+            Random random = new Random(42);\n+            float acceptProbability = 1 - indexingPressurePercent;\n+            for (AnomalyResult result : request.getAnomalyResults()) {\n+                if (result.getAnomalyGrade() > 0 || random.nextFloat() < acceptProbability) {\n+                    addResult(bulkRequest, result);\n+                }\n+            }\n+        } else {\n+            // if exceeding 100% of hard limit, try our luck and only index non-zero grade result\n+            for (AnomalyResult result : request.getAnomalyResults()) {\n+                if (result.getAnomalyGrade() > 0) {\n+                    addResult(bulkRequest, result);\n+                }\n+            }\n+        }\n+\n+        client", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI2NTIwNw=="}, "originalCommit": {"oid": "6c9214152b9256fee439dd545f942ad831aee1aa"}, "originalPosition": 110}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2954, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}