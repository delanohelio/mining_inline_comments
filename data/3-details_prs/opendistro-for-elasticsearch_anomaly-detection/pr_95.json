{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwMzk5NTcz", "number": 95, "title": "Integration with Ultrawarm", "bodyText": "Issue #, if available:\nDescription of changes:\nUltrawarm introduces warm nodes into the ES cluster. Currently, we distribute model partitions to all data nodes in the cluster randomly, which could cause a model performance downgrade issue once warm nodes are throttled due to resource limitations. The PR excludes warm nodes to place model partitions.\nSince index shards are hosted on hot nodes, AD's coordinating nodes are in hot nodes as well. We don't need to send HourlyCron job and stats requests to warm nodes anymore. This PR implements those changes.\nTesting done:\n\nVerified AD runs only in hot nodes.\nstats API and HourlyCron still works.\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-04-28T22:46:22Z", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/95", "merged": true, "mergeCommit": {"oid": "80997fd6fede82dc54e613118d48e992af323d9c"}, "closed": true, "closedAt": "2020-04-29T20:56:13Z", "author": {"login": "kaituo"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccL6cMgH2gAyNDEwMzk5NTczOjc2NjQzODIzNDc2MzUxYjI0NTY0YTk3MzNhZGJlZTc5ZGE5ZWI2OWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABccjRONgFqTQwMzEwMjAwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "76643823476351b24564a9733adbee79da9eb69c", "author": {"user": {"login": "kaituo", "name": "Kaituo Li"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/76643823476351b24564a9733adbee79da9eb69c", "committedDate": "2020-04-28T22:48:45Z", "message": "Integration with Ultrawarm\n\nUltrawarm introduces warm nodes into the ES cluster. Currently, we distribute model partitions to all data nodes in the cluster randomly, which could cause a model performance downgrade issue once warm nodes are throttled due to resource limitations. The PR excludes warm nodes to place model partitions.\n\nSince index shards are hosted on hot nodes, AD's coordinating nodes are in hot nodes as well. We don't need to send HourlyCron job and stats requests to warm nodes anymore. This PR implements those changes.\n\nTesting done:\n1. Verified AD runs only in hot nodes.\n2. stats API and HourlyCron still works."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c324ced3d5ce6dfff9cdd3dbd7c47c336806df93", "author": {"user": {"login": "kaituo", "name": "Kaituo Li"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/c324ced3d5ce6dfff9cdd3dbd7c47c336806df93", "committedDate": "2020-04-28T22:25:52Z", "message": "Integration with Ultrawarm\n\nUltrawarm introduces warm nodes into the ES cluster. Currently, we distribute model partitions to all data nodes in the cluster randomly, which could cause a model performance downgrade issue once warm nodes are throttled due to resource limitations. The PR excludes warm nodes to place model partitions.\n\nSince index shards are hosted on hot nodes, AD's coordinating nodes are in hot nodes as well. We don't need to send HourlyCron job and stats requests to warm nodes anymore. This PR implements those changes.\n\nTesting done:\n1. Verified AD runs only in hot nodes.\n2. stats API and HourlyCron still works."}, "afterCommit": {"oid": "76643823476351b24564a9733adbee79da9eb69c", "author": {"user": {"login": "kaituo", "name": "Kaituo Li"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/76643823476351b24564a9733adbee79da9eb69c", "committedDate": "2020-04-28T22:48:45Z", "message": "Integration with Ultrawarm\n\nUltrawarm introduces warm nodes into the ES cluster. Currently, we distribute model partitions to all data nodes in the cluster randomly, which could cause a model performance downgrade issue once warm nodes are throttled due to resource limitations. The PR excludes warm nodes to place model partitions.\n\nSince index shards are hosted on hot nodes, AD's coordinating nodes are in hot nodes as well. We don't need to send HourlyCron job and stats requests to warm nodes anymore. This PR implements those changes.\n\nTesting done:\n1. Verified AD runs only in hot nodes.\n2. stats API and HourlyCron still works."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyMjY4Nzg3", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/95#pullrequestreview-402268787", "createdAt": "2020-04-28T22:56:13Z", "commit": {"oid": "76643823476351b24564a9733adbee79da9eb69c"}, "state": "APPROVED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQyMjo1NjoxNFrOGNp_JQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQwMDoyNTowMVrOGNr1Pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk3MjU4MQ==", "bodyText": "Minor. Documentation is missing for public classes and methods.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/95#discussion_r416972581", "createdAt": "2020-04-28T22:56:14Z", "author": {"login": "wnbts"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClusterStateUtils.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.util;\n+\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.cluster.node.DiscoveryNode;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.collect.ImmutableOpenMap;\n+import org.elasticsearch.common.inject.Inject;\n+\n+import com.amazon.opendistroforelasticsearch.ad.constant.CommonName;\n+import com.carrotsearch.hppc.cursors.ObjectObjectCursor;\n+\n+public class ClusterStateUtils {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76643823476351b24564a9733adbee79da9eb69c"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk3MzU2Mw==", "bodyText": "Minor. The code will be more robust if this state is injected at constructor rather than hardcoded so when the config changes, constructor and unit tests do not need to change.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/95#discussion_r416973563", "createdAt": "2020-04-28T22:58:49Z", "author": {"login": "wnbts"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClusterStateUtils.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.util;\n+\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.cluster.node.DiscoveryNode;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.collect.ImmutableOpenMap;\n+import org.elasticsearch.common.inject.Inject;\n+\n+import com.amazon.opendistroforelasticsearch.ad.constant.CommonName;\n+import com.carrotsearch.hppc.cursors.ObjectObjectCursor;\n+\n+public class ClusterStateUtils {\n+    private static final Logger LOG = LogManager.getLogger(ClusterStateUtils.class);\n+    private final ClusterService clusterService;\n+    private final Map<String, String> ignoredAttributes = new HashMap<String, String>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76643823476351b24564a9733adbee79da9eb69c"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk3NTA0Nw==", "bodyText": "Question. Is this needed?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/95#discussion_r416975047", "createdAt": "2020-04-28T23:02:49Z", "author": {"login": "wnbts"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClusterStateUtils.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.util;\n+\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.cluster.node.DiscoveryNode;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.collect.ImmutableOpenMap;\n+import org.elasticsearch.common.inject.Inject;\n+\n+import com.amazon.opendistroforelasticsearch.ad.constant.CommonName;\n+import com.carrotsearch.hppc.cursors.ObjectObjectCursor;\n+\n+public class ClusterStateUtils {\n+    private static final Logger LOG = LogManager.getLogger(ClusterStateUtils.class);\n+    private final ClusterService clusterService;\n+    private final Map<String, String> ignoredAttributes = new HashMap<String, String>();\n+\n+    @Inject", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76643823476351b24564a9733adbee79da9eb69c"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk4MjE4MA==", "bodyText": "Question. Why not using Map or unmodifiableMap\u200b so the specific class doesn't leak into client code?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/95#discussion_r416982180", "createdAt": "2020-04-28T23:22:24Z", "author": {"login": "wnbts"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClusterStateUtils.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.util;\n+\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.cluster.node.DiscoveryNode;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.collect.ImmutableOpenMap;\n+import org.elasticsearch.common.inject.Inject;\n+\n+import com.amazon.opendistroforelasticsearch.ad.constant.CommonName;\n+import com.carrotsearch.hppc.cursors.ObjectObjectCursor;\n+\n+public class ClusterStateUtils {\n+    private static final Logger LOG = LogManager.getLogger(ClusterStateUtils.class);\n+    private final ClusterService clusterService;\n+    private final Map<String, String> ignoredAttributes = new HashMap<String, String>();\n+\n+    @Inject\n+    public ClusterStateUtils(ClusterService clusterService) {\n+        this.clusterService = clusterService;\n+        ignoredAttributes.put(CommonName.BOX_TYPE_KEY, CommonName.WARM_BOX_TYPE);\n+    }\n+\n+    public ImmutableOpenMap<String, DiscoveryNode> getEligibleDataNodes() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76643823476351b24564a9733adbee79da9eb69c"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk4MzIwNQ==", "bodyText": "Minor. isEligibleNode is easier to use than double negative.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/95#discussion_r416983205", "createdAt": "2020-04-28T23:25:13Z", "author": {"login": "wnbts"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClusterStateUtils.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.util;\n+\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.cluster.node.DiscoveryNode;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.collect.ImmutableOpenMap;\n+import org.elasticsearch.common.inject.Inject;\n+\n+import com.amazon.opendistroforelasticsearch.ad.constant.CommonName;\n+import com.carrotsearch.hppc.cursors.ObjectObjectCursor;\n+\n+public class ClusterStateUtils {\n+    private static final Logger LOG = LogManager.getLogger(ClusterStateUtils.class);\n+    private final ClusterService clusterService;\n+    private final Map<String, String> ignoredAttributes = new HashMap<String, String>();\n+\n+    @Inject\n+    public ClusterStateUtils(ClusterService clusterService) {\n+        this.clusterService = clusterService;\n+        ignoredAttributes.put(CommonName.BOX_TYPE_KEY, CommonName.WARM_BOX_TYPE);\n+    }\n+\n+    public ImmutableOpenMap<String, DiscoveryNode> getEligibleDataNodes() {\n+        ImmutableOpenMap<String, DiscoveryNode> dataNodes = clusterService.state().nodes().getDataNodes();\n+        ImmutableOpenMap.Builder<String, DiscoveryNode> modelNodes = ImmutableOpenMap.builder();\n+\n+        for (Iterator<ObjectObjectCursor<String, DiscoveryNode>> it = dataNodes.iterator(); it.hasNext();) {\n+            ObjectObjectCursor<String, DiscoveryNode> cursor = it.next();\n+            if (!isIgnoredNode(cursor.value)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76643823476351b24564a9733adbee79da9eb69c"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk4NDYyNg==", "bodyText": "Minor. Or if (entry.getValue().equals(attribute)) {...}", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/95#discussion_r416984626", "createdAt": "2020-04-28T23:29:06Z", "author": {"login": "wnbts"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClusterStateUtils.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.util;\n+\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.cluster.node.DiscoveryNode;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.collect.ImmutableOpenMap;\n+import org.elasticsearch.common.inject.Inject;\n+\n+import com.amazon.opendistroforelasticsearch.ad.constant.CommonName;\n+import com.carrotsearch.hppc.cursors.ObjectObjectCursor;\n+\n+public class ClusterStateUtils {\n+    private static final Logger LOG = LogManager.getLogger(ClusterStateUtils.class);\n+    private final ClusterService clusterService;\n+    private final Map<String, String> ignoredAttributes = new HashMap<String, String>();\n+\n+    @Inject\n+    public ClusterStateUtils(ClusterService clusterService) {\n+        this.clusterService = clusterService;\n+        ignoredAttributes.put(CommonName.BOX_TYPE_KEY, CommonName.WARM_BOX_TYPE);\n+    }\n+\n+    public ImmutableOpenMap<String, DiscoveryNode> getEligibleDataNodes() {\n+        ImmutableOpenMap<String, DiscoveryNode> dataNodes = clusterService.state().nodes().getDataNodes();\n+        ImmutableOpenMap.Builder<String, DiscoveryNode> modelNodes = ImmutableOpenMap.builder();\n+\n+        for (Iterator<ObjectObjectCursor<String, DiscoveryNode>> it = dataNodes.iterator(); it.hasNext();) {\n+            ObjectObjectCursor<String, DiscoveryNode> cursor = it.next();\n+            if (!isIgnoredNode(cursor.value)) {\n+                modelNodes.put(cursor.key, cursor.value);\n+            }\n+        }\n+        return modelNodes.build();\n+    }\n+\n+    public boolean isIgnoredNode(DiscoveryNode node) {\n+        if (!node.isDataNode()) {\n+            return true;\n+        }\n+        for (Map.Entry<String, String> entry : ignoredAttributes.entrySet()) {\n+            String attribute = node.getAttributes().get(entry.getKey());\n+            if (attribute != null && attribute.equals(entry.getValue())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76643823476351b24564a9733adbee79da9eb69c"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAwMjgxNA==", "bodyText": "Minor. clusterStateUtils", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/95#discussion_r417002814", "createdAt": "2020-04-29T00:25:01Z", "author": {"login": "wnbts"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/cluster/HourlyCron.java", "diffHunk": "@@ -21,27 +21,27 @@\n import org.elasticsearch.action.FailedNodeException;\n import org.elasticsearch.client.Client;\n import org.elasticsearch.cluster.node.DiscoveryNode;\n-import org.elasticsearch.cluster.service.ClusterService;\n \n import com.amazon.opendistroforelasticsearch.ad.transport.CronAction;\n import com.amazon.opendistroforelasticsearch.ad.transport.CronRequest;\n+import com.amazon.opendistroforelasticsearch.ad.util.ClusterStateUtils;\n \n public class HourlyCron implements Runnable {\n     private static final Logger LOG = LogManager.getLogger(HourlyCron.class);\n     static final String SUCCEEDS_LOG_MSG = \"Hourly maintenance succeeds\";\n     static final String NODE_EXCEPTION_LOG_MSG = \"Hourly maintenance of node has exception\";\n     static final String EXCEPTION_LOG_MSG = \"Hourly maintenance has exception.\";\n-    private ClusterService clusterService;\n+    private ClusterStateUtils clientStateUtils;\n     private Client client;\n \n-    public HourlyCron(ClusterService clusterService, Client client) {\n-        this.clusterService = clusterService;\n+    public HourlyCron(Client client, ClusterStateUtils clientStateUtils) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76643823476351b24564a9733adbee79da9eb69c"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzMDI0Njky", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/95#pullrequestreview-403024692", "createdAt": "2020-04-29T20:44:56Z", "commit": {"oid": "76643823476351b24564a9733adbee79da9eb69c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e74ce382d1bb794c8ca0fd4ec5d5487619a5f12", "author": {"user": {"login": "kaituo", "name": "Kaituo Li"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/4e74ce382d1bb794c8ca0fd4ec5d5487619a5f12", "committedDate": "2020-04-29T20:53:54Z", "message": "Address Lai's comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzMTAyMDAz", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/95#pullrequestreview-403102003", "createdAt": "2020-04-29T23:10:21Z", "commit": {"oid": "76643823476351b24564a9733adbee79da9eb69c"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQyMzoxMDoyMVrOGOUOdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQyMzo1NDozNlrOGOVGIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY2NDYzMQ==", "bodyText": "it looks like everywhere the map returned by getEligibleDataNodes() is converted to an array. Would be cleaner if we return an array from getEligibleDataNodes() itself.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/95#discussion_r417664631", "createdAt": "2020-04-29T23:10:21Z", "author": {"login": "sohami"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/rest/RestStatsAnomalyDetectorAction.java", "diffHunk": "@@ -73,15 +79,18 @@ protected RestChannelConsumer prepareRequest(RestRequest request, NodeClient cli\n      */\n     private ADStatsRequest getRequest(RestRequest request) {\n         // parse the nodes the user wants to query the stats for\n-        String[] nodeIdsArr = null;\n         String nodesIdsStr = request.param(\"nodeId\");\n         Set<String> validStats = adStats.getStats().keySet();\n \n+        ADStatsRequest adStatsRequest = null;\n         if (!Strings.isEmpty(nodesIdsStr)) {\n-            nodeIdsArr = nodesIdsStr.split(\",\");\n+            String[] nodeIdsArr = nodesIdsStr.split(\",\");\n+            adStatsRequest = new ADStatsRequest(nodeIdsArr);\n+        } else {\n+            DiscoveryNode[] dataNodes = clusterStateUtils.getEligibleDataNodes().values().toArray(DiscoveryNode.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76643823476351b24564a9733adbee79da9eb69c"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY2NjY2Ng==", "bodyText": "clientStateUtils -> clusterStateUtils ?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/95#discussion_r417666666", "createdAt": "2020-04-29T23:16:09Z", "author": {"login": "sohami"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/StopDetectorTransportAction.java", "diffHunk": "@@ -37,26 +38,26 @@\n     private static final Logger LOG = LogManager.getLogger(StopDetectorTransportAction.class);\n \n     private final Client client;\n-    private final ClusterService clusterService;\n+    private final ClusterStateUtils clientStateUtils;\n \n     @Inject\n     public StopDetectorTransportAction(\n         TransportService transportService,\n-        ClusterService clusterService,\n+        ClusterStateUtils clientStateUtils,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76643823476351b24564a9733adbee79da9eb69c"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY3ODg4MA==", "bodyText": "Since its a util class I would say you can just have a static methods in it and the caller doesn't have to create an instance of it. Something like this:\n\npublic final class DiscoveryNodeFilterer {\n\n         private DiscoveryNodeFilterer() {\n         }\n\n         public static DiscoveryNode[] getHotDataNodes(ClusterState state) {\n                   final List<DiscoveryNode> eligibleNodes = new ArrayList<>();\n                   final HotDataNodePredicate eligibleNodeFilter = new HotDataNodePredicate();\n                   for(DiscoveryNode node : state.nodes()) {\n                         if (eligibleNodeFilter.test(node)) {\n                                eligibleNodes.add(node);\n                         }\n                    }\n                   return eligibleNode.toArray(new DiscoveryNode[0]);\n         }\n\n        static class HotDataNodePredicate implements Predicate<DiscoveryNode> {\n              @Override\n              public boolean test(DiscoveryNode discoveryNode) {\n                    return discoveryNode.isDataNode() \n                         && discoveryNode.getAttributes().getOrDefault(CommonName.BOX_TYPE_KEY, CommonName.HOT_BOX_TYPE).equals(CommonName.HOT_BOX_TYPE);\n              }\n         }\n}\n\n\nOr if you want to support multiple attributes then you can use DiscoveryNodeFilters but the catch in this implementation is that it doesn't consider the DiscoveryNode with null value for attribute as an eligible node. Whereas in the case here a hot data node can have null value for box_type.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/95#discussion_r417678880", "createdAt": "2020-04-29T23:54:36Z", "author": {"login": "sohami"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClusterStateUtils.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.util;\n+\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.cluster.node.DiscoveryNode;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.collect.ImmutableOpenMap;\n+import org.elasticsearch.common.inject.Inject;\n+\n+import com.amazon.opendistroforelasticsearch.ad.constant.CommonName;\n+import com.carrotsearch.hppc.cursors.ObjectObjectCursor;\n+\n+public class ClusterStateUtils {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76643823476351b24564a9733adbee79da9eb69c"}, "originalPosition": 32}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1665, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}