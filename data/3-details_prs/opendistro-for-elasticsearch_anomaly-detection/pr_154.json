{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0NzE3NzU0", "number": 154, "title": "Fix retrying saving anomaly results", "bodyText": "Issue #, if available:\n#153\nDescription of changes:\nPreviously, AD throws an exception when retrying saving an anomaly result, indicating autoGeneratedTimestamp should not be set. We can see the exception because we reuse the same IndexRequest, where autoGeneratedTimestamp is already set. This PR creates a new IndexRequest by copying the original request without autoGeneratedTimestamp.\nThis PR also adds detector id to AnomalyDetectionException\u2019s toString method so that we can see the id in the log. This PR also adds more logging to SearchFeatureDao.\nTesting done:\n\nManually test to make sure the exception is gone after my fix.\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-06-15T19:02:15Z", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/154", "merged": true, "mergeCommit": {"oid": "0a5887131210f6ae81ea8cbcef8c215927a24e4c"}, "closed": true, "closedAt": "2020-06-15T20:41:17Z", "author": {"login": "kaituo"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcrlVHxgH2gAyNDM0NzE3NzU0Ojk1MTc4NThhNzUyNjA3YWUxOTlhYjY0NTZlMDE4ZTQ3ZGVmNzhkYWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcrmtUTgH2gAyNDM0NzE3NzU0OjgxMTJlZGJjYzM2OWEyYWI3ZTM3YTY5NWRiZDYzOTEzNzRkZDc4YWU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9517858a752607ae199ab6456e018e47def78dae", "author": {"user": {"login": "kaituo", "name": "Kaituo Li"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/9517858a752607ae199ab6456e018e47def78dae", "committedDate": "2020-06-15T18:54:23Z", "message": "Fix retrying saving anomaly results\n\nPreviously, AD throws an exception when retrying saving an anomaly result, indicating autoGeneratedTimestamp should not be set. We can see the exception because we reuse the same IndexRequest, where autoGeneratedTimestamp is already set. This PR creates a new IndexRequest by copying the original request without autoGeneratedTimestamp.\n\nThis PR also adds detector id to AnomalyDetectionException\u2019s toString method so that we can see the id in the log. This PR also adds more logging to SearchFeatureDao."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwOTU5MzMx", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/154#pullrequestreview-430959331", "createdAt": "2020-06-15T20:13:10Z", "commit": {"oid": "9517858a752607ae199ab6456e018e47def78dae"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMDoxMzoxMFrOGkBH2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMDoxMzoxMFrOGkBH2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQyMDMxNA==", "bodyText": "Minor. Should the index name be from the original index request?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/154#discussion_r440420314", "createdAt": "2020-06-15T20:13:10Z", "author": {"login": "wnbts"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/handler/AnomalyResultHandler.java", "diffHunk": "@@ -192,7 +192,12 @@ void saveDetectorResult(IndexRequest indexRequest, String context, Iterator<Time\n             } else {\n                 TimeValue nextDelay = backoff.next();\n                 LOG.warn(RETRY_SAVING_ERR_MSG + context, cause);\n-                threadPool.schedule(() -> saveDetectorResult(indexRequest, context, backoff), nextDelay, ThreadPool.Names.SAME);\n+                // copy original request's source without other information like autoGeneratedTimestamp\n+                // otherwise, an exception will be thrown indicating autoGeneratedTimestamp should not be set\n+                // while request id is already set (id is set because we have already sent the request before).\n+                IndexRequest newReuqest = new IndexRequest(AnomalyResult.ANOMALY_RESULT_INDEX);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9517858a752607ae199ab6456e018e47def78dae"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwOTY3NTgz", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/154#pullrequestreview-430967583", "createdAt": "2020-06-15T20:26:00Z", "commit": {"oid": "9517858a752607ae199ab6456e018e47def78dae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMDoyNjowMFrOGkBgxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMDoyNjowMFrOGkBgxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQyNjY5NQ==", "bodyText": "starting %d -> ending at %d?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/154#discussion_r440426695", "createdAt": "2020-06-15T20:26:00Z", "author": {"login": "yizheliu-amazon"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/feature/SearchFeatureDao.java", "diffHunk": "@@ -367,6 +380,7 @@ public void getFeaturesForSampledPeriods(\n         ActionListener<Optional<Entry<double[][], Integer>>> listener\n     ) {\n         Map<Long, double[]> cache = new HashMap<>();\n+        logger.info(String.format(\"Getting features for detector %s starting %d\", detector.getDetectorId(), endTime));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9517858a752607ae199ab6456e018e47def78dae"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwOTY5NDgw", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/154#pullrequestreview-430969480", "createdAt": "2020-06-15T20:28:47Z", "commit": {"oid": "9517858a752607ae199ab6456e018e47def78dae"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8112edbcc369a2ab7e37a695dbd6391374dd78ae", "author": {"user": {"login": "kaituo", "name": "Kaituo Li"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/8112edbcc369a2ab7e37a695dbd6391374dd78ae", "committedDate": "2020-06-15T20:30:43Z", "message": "Change from \"starting\" to \"ending at\""}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1469, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}