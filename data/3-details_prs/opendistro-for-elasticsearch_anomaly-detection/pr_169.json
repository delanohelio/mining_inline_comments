{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3MzQ4NTk2", "number": 169, "title": "Add setting for enabling/disabling circuit breaker", "bodyText": "Issue #, if available:\n#143\n#159\nDescription of changes:\nA circuit breaker is broken when heap memory usage exceeds 85%, and the related AD job would be disabled because of that. It is possible at one point the heap memory usage exceeds 85% and gets back to less than 85% soon afterward.\nThis PR mitigates the issue in the two following ways:\nFirst, only disable the AD job after the circuit breaker is broken for a consecutive number of times (3 times).\nSecond, add a setting for enabling/disabling circuit breaker.\nTesting done:\n\nAfter disabling circuit breaker, an open circuit breaker does not affect AD job execution.\nVerified an open circuit breaker wouldn't cause an AD job to be stopped immediately.\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-06-20T01:46:50Z", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/169", "merged": true, "mergeCommit": {"oid": "7c1d52496ce890d9de7291e5b0deb3603247558e"}, "closed": true, "closedAt": "2020-06-23T16:56:54Z", "author": {"login": "kaituo"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcs9bXbgH2gAyNDM3MzQ4NTk2OjNjYzdiMDdkYjZmODJiM2Q5ZjkxMDQ1OTcxZjYwYmE0M2I5MGY2ZTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuIRiuAH2gAyNDM3MzQ4NTk2OmUyYWE5ZDNmM2IwN2JhZTcxNzMwZGQ4YzA1NDgyZTdjMmRmZDRhN2I=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3cc7b07db6f82b3d9f91045971f60ba43b90f6e2", "author": {"user": {"login": "kaituo", "name": "Kaituo Li"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/3cc7b07db6f82b3d9f91045971f60ba43b90f6e2", "committedDate": "2020-06-20T01:32:51Z", "message": "Add setting for enabling/disabling circuit breaker\n\nA circuit breaker is broken when heap memory usage exceeds 85%, and the related AD job would be disabled because of that. It is possible at one point the heap memory usage exceeds 85% and gets back to less than 85% soon afterward.This PR mitigates the issue in the two following ways:First, only disable the AD job after the circuit breaker is broken for a consecutive number of times (3 times).Second, add a setting for enabling/disabling circuit breaker.\n\nTesting done:\n1. After disabling circuit breaker, an open circuit breaker does not affect AD job execution.\n2. Verified an open circuit breaker wouldn't cause an AD job to be stopped immediately."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MTE0MjY5", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/169#pullrequestreview-435114269", "createdAt": "2020-06-22T17:01:31Z", "commit": {"oid": "3cc7b07db6f82b3d9f91045971f60ba43b90f6e2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxNzowMTozMlrOGnJcpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxNzowMTozMlrOGnJcpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcwMjQzNg==", "bodyText": "issue. LTR seems to refer to AD.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/169#discussion_r443702436", "createdAt": "2020-06-22T17:01:32Z", "author": {"login": "wnbts"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/settings/EnabledSetting.java", "diffHunk": "@@ -45,12 +45,19 @@\n      */\n     public static final String AD_PLUGIN_ENABLED = \"opendistro.anomaly_detection.enabled\";\n \n+    public static final String AD_BREAKER_ENABLED = \"opendistro.anomaly_detection.breaker.enabled\";\n+\n     private final Map<String, Setting<?>> settings = unmodifiableMap(new HashMap<String, Setting<?>>() {\n         {\n             /**\n              * AD plugin enable/disable setting\n              */\n             put(AD_PLUGIN_ENABLED, Setting.boolSetting(AD_PLUGIN_ENABLED, true, NodeScope, Dynamic));\n+\n+            /**\n+             * LTR breaker enable/disable setting", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cc7b07db6f82b3d9f91045971f60ba43b90f6e2"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MTMyNzc0", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/169#pullrequestreview-435132774", "createdAt": "2020-06-22T17:27:53Z", "commit": {"oid": "3cc7b07db6f82b3d9f91045971f60ba43b90f6e2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "274d98de69760df92674691255f307897eb14c96", "author": {"user": {"login": "kaituo", "name": "Kaituo Li"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/274d98de69760df92674691255f307897eb14c96", "committedDate": "2020-06-22T18:09:55Z", "message": "Update comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "babb7de74d1e0f7f991a006593ebc70df356ddb2", "author": {"user": {"login": "kaituo", "name": "Kaituo Li"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/babb7de74d1e0f7f991a006593ebc70df356ddb2", "committedDate": "2020-06-22T20:10:18Z", "message": "Increase max retry attempts during end run exception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MjY5MzM5", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/169#pullrequestreview-435269339", "createdAt": "2020-06-22T20:59:11Z", "commit": {"oid": "babb7de74d1e0f7f991a006593ebc70df356ddb2"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQyMDo1OToxMVrOGnQyuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQyMTowMzozMlrOGnQ7Bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgyMjc3Nw==", "bodyText": "this is ok for now. but i think the number of allowed retries should be settable per exception object, i.e. the endrun exception contains a field for the number of retries, which can be specific to detector (interval), exception type (limit exceeded, other endrun), or root cause. Stop now being true would just be a special case that number of retries being 0.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/169#discussion_r443822777", "createdAt": "2020-06-22T20:59:11Z", "author": {"login": "wnbts"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/settings/AnomalyDetectorSettings.java", "diffHunk": "@@ -133,7 +133,7 @@ private AnomalyDetectorSettings() {}\n     public static final Setting<Integer> MAX_RETRY_FOR_END_RUN_EXCEPTION = Setting\n         .intSetting(\n             \"opendistro.anomaly_detection.max_retry_for_end_run_exception\",\n-            3,\n+            6,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "babb7de74d1e0f7f991a006593ebc70df356ddb2"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgyMzYyOQ==", "bodyText": "minor. and flag for stopping.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/169#discussion_r443823629", "createdAt": "2020-06-22T21:00:54Z", "author": {"login": "wnbts"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/common/exception/LimitExceededException.java", "diffHunk": "@@ -29,4 +29,15 @@\n     public LimitExceededException(String anomalyDetectorId, String message) {\n         super(anomalyDetectorId, message, true);\n     }\n+\n+    /**\n+     * Constructor with an anomaly detector ID and an explanation.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "babb7de74d1e0f7f991a006593ebc70df356ddb2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgyNDkwMg==", "bodyText": "Minor. Java doc for public interface is missing.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/169#discussion_r443824902", "createdAt": "2020-06-22T21:03:32Z", "author": {"login": "wnbts"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/settings/EnabledSetting.java", "diffHunk": "@@ -100,6 +107,10 @@ public static boolean isADPluginEnabled() {\n         return EnabledSetting.getInstance().getSettingValue(EnabledSetting.AD_PLUGIN_ENABLED);\n     }\n \n+    public static boolean isADBreakerEnabled() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "babb7de74d1e0f7f991a006593ebc70df356ddb2"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MzQ5MDg0", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/169#pullrequestreview-435349084", "createdAt": "2020-06-22T23:52:54Z", "commit": {"oid": "babb7de74d1e0f7f991a006593ebc70df356ddb2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2aa9d3f3b07bae71730dd8c05482e7c2dfd4a7b", "author": {"user": {"login": "kaituo", "name": "Kaituo Li"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/e2aa9d3f3b07bae71730dd8c05482e7c2dfd4a7b", "committedDate": "2020-06-23T16:45:00Z", "message": "Added java doc"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1482, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}