{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4MDg0OTU0", "number": 309, "title": "Fix for upgrading mapping", "bodyText": "Issue #, if available:\nDescription of changes:\nThis PR fixes two bugs of upgrading mapping:\nFirst, previously we only tried once when upgrading mapping.  It is possible we need to try a few more times.  The drawback is that if the code has a bug, we retry endlessly.  I should fix it in the future.\nSecond, we enclose the upgrade mapping function call under a user context in a recent commit.  Upgrade mapping will fail when security plugin is enabled since a regular user cannot upgrade mappings of system indices.\nThe PR also adds upper bounds to our dynamic settings if reasonable.\nTesting done:\n\nTested that upgrade mapping succeeds with new changes.\nTested the upper bounds of the changed settings are in effect.\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-11-09T22:42:11Z", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/309", "merged": true, "mergeCommit": {"oid": "75db58b6e4cf61ecc95c5b8b84b208394b0773a4"}, "closed": true, "closedAt": "2020-11-10T01:13:48Z", "author": {"login": "kaituo"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABda8pCwAH2gAyNTE4MDg0OTU0OmE0MmVlOTVmMjdkZTIzMGZiZTM2MGZhNGFiMzk0Yjg2NWZjMTNjYjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABda-pTvAFqTUyNjc3MjYyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a42ee95f27de230fbe360fa4ab394b865fc13cb6", "author": {"user": {"login": "kaituo", "name": "Kaituo Li"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/a42ee95f27de230fbe360fa4ab394b865fc13cb6", "committedDate": "2020-11-09T22:38:24Z", "message": "Fix for upgrading mapping\n\nThis PR fixes two bugs of upgrading mapping:\nFirst, previously we only tried once when upgrading mapping.\u00a0 It is possible we need to try a few more times.\u00a0 The drawback is that if the code has a bug, we retry endlessly.\u00a0 I should fix it in the future.\nSecond, we enclose the upgrade mapping function call under a user context in a recent commit.\u00a0 Upgrade mapping will fail when security plugin is enabled since a regular user cannot upgrade mappings of system indices.\n\nThe PR also adds upper bounds to our dynamic settings if reasonable.\nTesting done:\n1. Tested that upgrade mapping succeeds with new changes.\n2. Tested the upper bounds of the changed settings are in effect."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NzE4NzMy", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/309#pullrequestreview-526718732", "createdAt": "2020-11-09T22:51:08Z", "commit": {"oid": "a42ee95f27de230fbe360fa4ab394b865fc13cb6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NzE4OTk0", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/309#pullrequestreview-526718994", "createdAt": "2020-11-09T22:51:37Z", "commit": {"oid": "a42ee95f27de230fbe360fa4ab394b865fc13cb6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMjo1MTozOFrOHwEyAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMjo1MTozOFrOHwEyAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3MjAzNA==", "bodyText": "If remove this line, will not update index mapping if any exception happens?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/309#discussion_r520172034", "createdAt": "2020-11-09T22:51:38Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/indices/AnomalyDetectionIndices.java", "diffHunk": "@@ -578,7 +578,11 @@ public void updateMappingIfNecessary() {\n         }\n \n         final GroupedActionListener<Void> conglomerateListeneer = new GroupedActionListener<>(\n-            ActionListener.wrap(r -> updateRunning.set(false), exception -> logger.error(\"Fail to updatea all mappings\")),\n+            ActionListener.wrap(r -> updateRunning.set(false), exception -> {\n+                // TODO: don't retry endlessly. Can be annoying if there are too many exception logs.\n+                updateRunning.set(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a42ee95f27de230fbe360fa4ab394b865fc13cb6"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NzIxODU3", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/309#pullrequestreview-526721857", "createdAt": "2020-11-09T22:56:59Z", "commit": {"oid": "a42ee95f27de230fbe360fa4ab394b865fc13cb6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMjo1NzowMFrOHwE7bQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMjo1NzowMFrOHwE7bQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3NDQ0NQ==", "bodyText": "Add ad to the error message.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/309#discussion_r520174445", "createdAt": "2020-11-09T22:57:00Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/indices/AnomalyDetectionIndices.java", "diffHunk": "@@ -578,7 +578,11 @@ public void updateMappingIfNecessary() {\n         }\n \n         final GroupedActionListener<Void> conglomerateListeneer = new GroupedActionListener<>(\n-            ActionListener.wrap(r -> updateRunning.set(false), exception -> logger.error(\"Fail to updatea all mappings\")),\n+            ActionListener.wrap(r -> updateRunning.set(false), exception -> {\n+                // TODO: don't retry endlessly. Can be annoying if there are too many exception logs.\n+                updateRunning.set(false);\n+                logger.error(\"Fail to updatea all mappings\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a42ee95f27de230fbe360fa4ab394b865fc13cb6"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed6c3516a5bc1408e1fb5c509205afae323fc837", "author": {"user": {"login": "kaituo", "name": "Kaituo Li"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/ed6c3516a5bc1408e1fb5c509205afae323fc837", "committedDate": "2020-11-09T23:16:09Z", "message": "Update log message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NzcyNjI0", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/309#pullrequestreview-526772624", "createdAt": "2020-11-10T00:58:30Z", "commit": {"oid": "ed6c3516a5bc1408e1fb5c509205afae323fc837"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1428, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}