{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzMDM2MzA5", "number": 102, "title": "Fix that AD job cannot be terminated due to missing training data", "bodyText": "Issue #, if available:\nDescription of changes:\nWe expect an EndRunException to be thrown due to missing training data.  But the exception is not appropriately propagated back to AD job and results in InternalFailure instead.  This PR fixes the bug.\nTesting done:\n\nManually reproduced all  possible EndRunExceptions, check AD job is terminated, and check profile API status is correct.\nAdded unit tests to expose the bug.\n\nProfile output for init failures:\n[2020-05-02 14:17:31 PDT] [2020-05-02 21:17:31 UTC]\nkaituo@dev-dsk-kaituo-2a-74e3f324.us-west-2: ~/code/github/anomaly-detection\n% curl -X GET \"localhost:9200/_opendistro/_anomaly_detection/detectors/fu8z13EBn03yvIf6cLBm/_profile\"\n{\"state\":\"DISABLED\",\"error\":\"Stopped detector as job failed consecutively for more than 3 times: Cannot get training data\"}\n[2020-05-02 15:13:30 PDT] [2020-05-02 22:13:30 UTC]\nkaituo@dev-dsk-kaituo-2a-74e3f324.us-west-2: ~/code/github/anomaly-detection\n% curl -X GET \"localhost:9200/_opendistro/_anomaly_detection/detectors/cgdm13EBVQAb62q7oAbR/_profile\"\n{\"state\":\"DISABLED\",\"error\":\"Stopped detector as job failed consecutively for more than 3 times: Error while cold start\"}\n[2020-05-02 15:32:04 PDT] [2020-05-02 22:32:04 UTC]\nkaituo@dev-dsk-kaituo-2a-74e3f324.us-west-2: ~/code/github/anomaly-detection\n% curl -X GET \"localhost:9200/_opendistro/_anomaly_detection/detectors/4j1313EBhPlEUyl3nsX-/_profile\"\n{\"state\":\"DISABLED\",\"error\":\"Stopped detector: AD models memory usage exceeds our limit.\"}\n[2020-05-02 15:45:50 PDT] [2020-05-02 22:45:50 UTC]\nkaituo@dev-dsk-kaituo-2a-74e3f324.us-west-2: ~/code/github/anomaly-detection\n% curl -X GET \"localhost:9200/_opendistro/_anomaly_detection/detectors/DoOI13EBxc51Fte-eAry/_profile\"\n{\"state\":\"DISABLED\",\"error\":\"Stopped detector: limit_exceeded_exception: Exceeded memory limit. New size is 4456448 and max limit is 51897958.400000\"\n[2020-05-02 15:52:19 PDT] [2020-05-02 22:52:19 UTC]\nkaituo@dev-dsk-kaituo-2a-74e3f324.us-west-2: ~/code/github/anomaly-detection\n% curl -X GET \"localhost:9200/_opendistro/_anomaly_detection/detectors/5z-V13EBskgfiUUv6dRA/_profile\"\n{\"state\":\"DISABLED\",\"error\":\"Stopped detector: Having trouble querying data: no such index [server-metrics]\"}\n[2020-05-02 16:01:09 PDT] [2020-05-02 23:01:09 UTC]\nkaituo@dev-dsk-kaituo-2a-74e3f324.us-west-2: ~/code/github/anomaly-detection\n% curl -X GET \"localhost:9200/_opendistro/_anomaly_detection/detectors/xnuc13EB6HcqWQxXA0ot/_profile\"\n{\"state\":\"DISABLED\",\"error\":\"Stopped detector: Having trouble querying data because all of your features have been disabled.\"}\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-05-04T15:53:37Z", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/102", "merged": true, "mergeCommit": {"oid": "b351d409bb61453bb656ad5ac1acf067fd223f17"}, "closed": true, "closedAt": "2020-05-04T22:05:29Z", "author": {"login": "kaituo"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABceDRdqAFqTQwNTIxMzIzNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABceG3w6gBqjMzMDE4OTQyMDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MjEzMjM0", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/102#pullrequestreview-405213234", "createdAt": "2020-05-04T17:52:36Z", "commit": {"oid": "f3bd9fa59973d61e8f241c00c0c181d39f4b466b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MjU0NzI5", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/102#pullrequestreview-405254729", "createdAt": "2020-05-04T18:49:36Z", "commit": {"oid": "f3bd9fa59973d61e8f241c00c0c181d39f4b466b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxODo0OTozNlrOGQNhrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxODo0OTozNlrOGQNhrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY1MjAxNA==", "bodyText": "Can you log the matching exception as well?\nnit: my personal preference is to log as ERROR, since it is in the scope of 1 particular exception log, same as below.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/102#discussion_r419652014", "createdAt": "2020-05-04T18:49:36Z", "author": {"login": "yizheliu-amazon"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ColdStartRunner.java", "diffHunk": "@@ -80,8 +83,10 @@ public void shutDown() {\n         checkResult();\n \n         if (currentExceptions.containsKey(adID)) {\n-            LOG.error(\"Found matching exception for {}\", adID);\n+            LOG.info(\"Found a matching exception for {}\", adID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3bd9fa59973d61e8f241c00c0c181d39f4b466b"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MjU1MjA3", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/102#pullrequestreview-405255207", "createdAt": "2020-05-04T18:50:21Z", "commit": {"oid": "f3bd9fa59973d61e8f241c00c0c181d39f4b466b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf4889211d1af15459f187c7ce0d9dfc1700b545", "author": {"user": {"login": "kaituo", "name": "Kaituo Li"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/cf4889211d1af15459f187c7ce0d9dfc1700b545", "committedDate": "2020-05-04T21:55:36Z", "message": "Fix that AD job cannot be terminated due to missing training data\n\nWe expect an EndRunException to be thrown due to missing training data.  But the exception is not appropriately propagated back to AD job and results in InternalFailure instead.  This PR fixes the bug.\n\nTesting done:\n1. Manually reproduced all  possible EndRunExceptions, check AD job is terminated, and check profile API status is correct.\n2. Added unit tests to expose the bug."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f3bd9fa59973d61e8f241c00c0c181d39f4b466b", "author": {"user": {"login": "kaituo", "name": "Kaituo Li"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/f3bd9fa59973d61e8f241c00c0c181d39f4b466b", "committedDate": "2020-05-03T03:34:45Z", "message": "Fix that AD job cannot be terminated due to missing training data\n\nWe expect an EndRunException to be thrown due to missing training data.  But the exception is not appropriately propagated back to AD job and results in InternalFailure instead.  This PR fixes the bug.\n\nTesting done:\n1. Manually reproduced all  possible EndRunExceptions, check AD job is terminated, and check profile API status is correct.\n2. Added unit tests to expose the bug."}, "afterCommit": {"oid": "cf4889211d1af15459f187c7ce0d9dfc1700b545", "author": {"user": {"login": "kaituo", "name": "Kaituo Li"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/cf4889211d1af15459f187c7ce0d9dfc1700b545", "committedDate": "2020-05-04T21:55:36Z", "message": "Fix that AD job cannot be terminated due to missing training data\n\nWe expect an EndRunException to be thrown due to missing training data.  But the exception is not appropriately propagated back to AD job and results in InternalFailure instead.  This PR fixes the bug.\n\nTesting done:\n1. Manually reproduced all  possible EndRunExceptions, check AD job is terminated, and check profile API status is correct.\n2. Added unit tests to expose the bug."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1669, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}