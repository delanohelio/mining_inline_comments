{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5NDY0MDc1", "number": 240, "title": "Verifying multi-entity detectors", "bodyText": "Issue #, if available:\nDescription of changes:\nThis PR adds categorical fields' number and type check. We only support one categorical field, and the categorical field can only be of type keyword and ip.  We also limit the max multi-entity detectors to 10.\nTesting done:\n\nadded unit tests\ndid manual testing.\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-10-07T19:19:11Z", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240", "merged": true, "mergeCommit": {"oid": "85e38acd776ea134dcf3fa72f75b0251a2aff00f"}, "closed": true, "closedAt": "2020-10-13T21:24:18Z", "author": {"login": "kaituo"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQkBrFABqjM4NTYzMDg0NDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSPOWFgBqjM4NzM1ODEwNTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dce74693a60acaebe4460fde347510f96061b7e8", "author": {"user": {"login": "kaituo", "name": "Kaituo Li"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/dce74693a60acaebe4460fde347510f96061b7e8", "committedDate": "2020-10-07T19:16:18Z", "message": "Verifying Categorical field's type and total number\n\nThis PR adds categorical fields' number and length check. We only support one categorical field, and the categorical field can only be of type keyword and ip.\n\nTesting done:\n1. added unit tests\n2. did manual testing."}, "afterCommit": {"oid": "33ede2ceedda83e461b54f09251c7f55ada68377", "author": {"user": {"login": "kaituo", "name": "Kaituo Li"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/33ede2ceedda83e461b54f09251c7f55ada68377", "committedDate": "2020-10-08T16:17:50Z", "message": "Verifying multi-entity detectors\n\nThis PR adds categorical fields' number and length check. We only support one categorical field, and the categorical field can only be of type keyword and ip.  We also limit the max multi-entity detectors to 10.\n\nTesting done:\n1. added unit tests\n2. did manual testing."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MzU2MzU4", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#pullrequestreview-505356358", "createdAt": "2020-10-09T04:30:15Z", "commit": {"oid": "33ede2ceedda83e461b54f09251c7f55ada68377"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwNDozMDoxNVrOHe61jQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwNDozMDoxNVrOHe61jQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE4MzMwOQ==", "bodyText": "What does this comment mean?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#discussion_r502183309", "createdAt": "2020-10-09T04:30:15Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/rest/handler/IndexAnomalyDetectorActionHandler.java", "diffHunk": "@@ -178,32 +196,130 @@ private void onGetAnomalyDetectorResponse(GetResponse response) throws IOExcepti\n             return;\n         }\n \n-        searchAdInputIndices(detectorId);\n+        validateCategoricalField(detectorId);\n     }\n \n     private void createAnomalyDetector() {\n         try {\n-            QueryBuilder query = QueryBuilders.matchAllQuery();\n-            SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder().query(query).size(0).timeout(requestTimeout);\n+            List<String> categoricalFields = anomalyDetector.getCategoryField();\n+            if (categoricalFields != null && categoricalFields.size() > 0) {\n+                QueryBuilder query = QueryBuilders.boolQuery().filter(QueryBuilders.existsQuery(AnomalyDetector.CATEGORY_FIELD));\n \n-            SearchRequest searchRequest = new SearchRequest(ANOMALY_DETECTORS_INDEX).source(searchSourceBuilder);\n+                SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder().query(query).size(0).timeout(requestTimeout);\n \n-            client.search(searchRequest, ActionListener.wrap(response -> onSearchAdResponse(response), exception -> onFailure(exception)));\n+                SearchRequest searchRequest = new SearchRequest(ANOMALY_DETECTORS_INDEX).source(searchSourceBuilder);\n+\n+                client\n+                    .search(\n+                        searchRequest,\n+                        ActionListener.wrap(response -> onSearchMultiEntityAdResponse(response), exception -> { onFailure(exception); })\n+                    );\n+            } else {\n+                QueryBuilder query = QueryBuilders.matchAllQuery();\n+                SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder().query(query).size(0).timeout(requestTimeout);\n+\n+                SearchRequest searchRequest = new SearchRequest(ANOMALY_DETECTORS_INDEX).source(searchSourceBuilder);\n+\n+                client\n+                    .search(\n+                        searchRequest,\n+                        ActionListener.wrap(response -> onSearchSingleEntityAdResponse(response), exception -> onFailure(exception))\n+                    );\n+            }\n         } catch (Exception e) {\n             onFailure(e);\n         }\n     }\n \n-    private void onSearchAdResponse(SearchResponse response) throws IOException {\n-        if (response.getHits().getTotalHits().value >= maxAnomalyDetectors) {\n-            String errorMsg = \"Can't create anomaly detector more than \" + maxAnomalyDetectors;\n+    private void onSearchSingleEntityAdResponse(SearchResponse response) throws IOException {\n+        if (response.getHits().getTotalHits().value >= maxSingleEntityAnomalyDetectors) {\n+            String errorMsg = EXCEEDED_MAX_SINGLE_ENTITY_DETECTORS_PREFIX_MSG + maxSingleEntityAnomalyDetectors;\n             logger.error(errorMsg);\n             onFailure(new IllegalArgumentException(errorMsg));\n         } else {\n             searchAdInputIndices(null);\n         }\n     }\n \n+    private void onSearchMultiEntityAdResponse(SearchResponse response) throws IOException {\n+        if (response.getHits().getTotalHits().value >= maxMultiEntityAnomalyDetectors) {\n+            String errorMsg = EXCEEDED_MAX_MULTI_ENTITY_DETECTORS_PREFIX_MSG + maxMultiEntityAnomalyDetectors;\n+            logger.error(errorMsg);\n+            onFailure(new IllegalArgumentException(errorMsg));\n+        } else {\n+            validateCategoricalField(null);\n+        }\n+    }\n+\n+    /**\n+     * Precondition: anomalyDetector.getCategoryField() != null.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33ede2ceedda83e461b54f09251c7f55ada68377"}, "originalPosition": 157}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MzU3MTMx", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#pullrequestreview-505357131", "createdAt": "2020-10-09T04:33:19Z", "commit": {"oid": "33ede2ceedda83e461b54f09251c7f55ada68377"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwNDozMzoxOVrOHe64Bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwNDozMzoxOVrOHe64Bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE4Mzk0Mg==", "bodyText": "1 is magic number, how about we create CATEGORY_FIELD_LIMIT instant and use it at all other places. like IndexAnomalyDetectorActionHandler.java line 269:\nif (categoryField.size() != 1) {", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#discussion_r502183942", "createdAt": "2020-10-09T04:33:19Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/AnomalyDetector.java", "diffHunk": "@@ -105,7 +107,62 @@\n      * @param uiMetadata        metadata used by Kibana\n      * @param schemaVersion     anomaly detector index mapping version\n      * @param lastUpdateTime    detector's last update time\n+     * @param categoryField     a list of partition fields\n      */\n+    public AnomalyDetector(\n+        String detectorId,\n+        Long version,\n+        String name,\n+        String description,\n+        String timeField,\n+        List<String> indices,\n+        List<Feature> features,\n+        QueryBuilder filterQuery,\n+        TimeConfiguration detectionInterval,\n+        TimeConfiguration windowDelay,\n+        Integer shingleSize,\n+        Map<String, Object> uiMetadata,\n+        Integer schemaVersion,\n+        Instant lastUpdateTime,\n+        List<String> categoryField\n+    ) {\n+        if (Strings.isBlank(name)) {\n+            throw new IllegalArgumentException(\"Detector name should be set\");\n+        }\n+        if (timeField == null) {\n+            throw new IllegalArgumentException(\"Time field should be set\");\n+        }\n+        if (indices == null || indices.isEmpty()) {\n+            throw new IllegalArgumentException(\"Indices should be set\");\n+        }\n+        if (detectionInterval == null) {\n+            throw new IllegalArgumentException(\"Detection interval should be set\");\n+        }\n+        if (shingleSize != null && shingleSize < 1) {\n+            throw new IllegalArgumentException(\"Shingle size must be a positive integer\");\n+        }\n+        if (categoryField != null && categoryField.size() > 1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33ede2ceedda83e461b54f09251c7f55ada68377"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MzU3OTAw", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#pullrequestreview-505357900", "createdAt": "2020-10-09T04:36:20Z", "commit": {"oid": "33ede2ceedda83e461b54f09251c7f55ada68377"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwNDozNjoyMFrOHe66qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwNDozNjoyMFrOHe66qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE4NDYxOQ==", "bodyText": "minor: if we plan to support multiple category fields, should we name this as \"categoryFields\" ?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#discussion_r502184619", "createdAt": "2020-10-09T04:36:20Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/AnomalyDetector.java", "diffHunk": "@@ -87,6 +88,7 @@\n     private final Map<String, Object> uiMetadata;\n     private final Integer schemaVersion;\n     private final Instant lastUpdateTime;\n+    private final List<String> categoryField;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33ede2ceedda83e461b54f09251c7f55ada68377"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2Nzg3NzE3", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#pullrequestreview-506787717", "createdAt": "2020-10-12T17:08:12Z", "commit": {"oid": "33ede2ceedda83e461b54f09251c7f55ada68377"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2Nzg5MDMx", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#pullrequestreview-506789031", "createdAt": "2020-10-12T17:10:28Z", "commit": {"oid": "33ede2ceedda83e461b54f09251c7f55ada68377"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNzoxMDoyOFrOHgGziQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNzoxMDoyOFrOHgGziQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyNzk3Nw==", "bodyText": "I see we just use 1 category field today, do we see possible use cases of multiple category fields ?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#discussion_r503427977", "createdAt": "2020-10-12T17:10:28Z", "author": {"login": "saratvemulapalli"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/AnomalyDetector.java", "diffHunk": "@@ -87,6 +88,7 @@\n     private final Map<String, Object> uiMetadata;\n     private final Integer schemaVersion;\n     private final Instant lastUpdateTime;\n+    private final List<String> categoryField;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33ede2ceedda83e461b54f09251c7f55ada68377"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2ODY5OTU4", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#pullrequestreview-506869958", "createdAt": "2020-10-12T19:39:47Z", "commit": {"oid": "febd0a571a2432ff663ab8e4b6bef0c4349edc52"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxOTozOTo0N1rOHgK6nw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxOTozOTo0N1rOHgK6nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ5NTMyNw==", "bodyText": "Do we plan to write HC detector's result into another index?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#discussion_r503495327", "createdAt": "2020-10-12T19:39:47Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/constant/CommonName.java", "diffHunk": "@@ -22,6 +22,9 @@\n     // index name for anomaly checkpoint of each model. One model one document.\n     public static final String CHECKPOINT_INDEX_NAME = \".opendistro-anomaly-checkpoints\";\n \n+    // The alias of the index in which to write single-entity AD result history", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "febd0a571a2432ff663ab8e4b6bef0c4349edc52"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2ODcwMjU4", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#pullrequestreview-506870258", "createdAt": "2020-10-12T19:40:22Z", "commit": {"oid": "febd0a571a2432ff663ab8e4b6bef0c4349edc52"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxOTo0MDoyMlrOHgK7iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxOTo0MDoyMlrOHgK7iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ5NTU2Mw==", "bodyText": "Should we change to \"category_fields\" ? Same question for line 113, 130, and other places. Suggest to replace by searching all files.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#discussion_r503495563", "createdAt": "2020-10-12T19:40:22Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/AnomalyDetector.java", "diffHunk": "@@ -72,6 +75,7 @@\n     private static final String SHINGLE_SIZE_FIELD = \"shingle_size\";\n     private static final String LAST_UPDATE_TIME_FIELD = \"last_update_time\";\n     public static final String UI_METADATA_FIELD = \"ui_metadata\";\n+    public static final String CATEGORY_FIELD = \"category_field\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "febd0a571a2432ff663ab8e4b6bef0c4349edc52"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NzE5ODA1", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#pullrequestreview-507719805", "createdAt": "2020-10-13T18:28:41Z", "commit": {"oid": "febd0a571a2432ff663ab8e4b6bef0c4349edc52"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3ODIzMTQy", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/240#pullrequestreview-507823142", "createdAt": "2020-10-13T20:57:28Z", "commit": {"oid": "febd0a571a2432ff663ab8e4b6bef0c4349edc52"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "462dcc603c6854377254e670bfebfe88a72f3b4d", "author": {"user": {"login": "kaituo", "name": "Kaituo Li"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/462dcc603c6854377254e670bfebfe88a72f3b4d", "committedDate": "2020-10-13T21:01:08Z", "message": "Verifying multi-entity detectors\n\nThis PR adds categorical fields' number and length check. We only support one categorical field, and the categorical field can only be of type keyword and ip.  We also limit the max multi-entity detectors to 10.\n\nTesting done:\n1. added unit tests\n2. did manual testing."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2787219e95c709274e1173863a4bb4fcfd39c14", "author": {"user": {"login": "kaituo", "name": "Kaituo Li"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/b2787219e95c709274e1173863a4bb4fcfd39c14", "committedDate": "2020-10-13T21:01:08Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99c5a4494213cac58cbc2a0e8e2eaacf467779b0", "author": {"user": {"login": "kaituo", "name": "Kaituo Li"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/99c5a4494213cac58cbc2a0e8e2eaacf467779b0", "committedDate": "2020-10-13T21:01:08Z", "message": "Fix flaky test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff37fd3b3ac2065d1bd7f316696290715a2c6c01", "author": {"user": {"login": "kaituo", "name": "Kaituo Li"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/ff37fd3b3ac2065d1bd7f316696290715a2c6c01", "committedDate": "2020-10-13T21:01:08Z", "message": "Merge from Sarat"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "febd0a571a2432ff663ab8e4b6bef0c4349edc52", "author": {"user": {"login": "kaituo", "name": "Kaituo Li"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/febd0a571a2432ff663ab8e4b6bef0c4349edc52", "committedDate": "2020-10-12T19:21:11Z", "message": "Fix flaky test"}, "afterCommit": {"oid": "ff37fd3b3ac2065d1bd7f316696290715a2c6c01", "author": {"user": {"login": "kaituo", "name": "Kaituo Li"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/ff37fd3b3ac2065d1bd7f316696290715a2c6c01", "committedDate": "2020-10-13T21:01:08Z", "message": "Merge from Sarat"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1555, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}