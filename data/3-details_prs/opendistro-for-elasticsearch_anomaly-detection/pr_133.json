{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxNjA5MDIx", "number": 133, "title": "Add CI/CD workflows", "bodyText": "Issue #, if available:\n#104\nDescription of changes:\nThis PR adds CI/CD workflows. CI workflow builds a zip file, installs that on the official ODFE docker image, and runs rest test case. CI workflow is triggered by branch pushing. CD workflow builds zip, rpm, deb files, and uploads those files to s3. CD workflow is triggered by tag creation.\nThis PR also increases model initialization waiting time as needed on DetectionResultEvalutationIT as it can be long on a remote cluster.\nTesting done:\n\nran the scripts on CI/CD workflow manually and tested it works.\nmade sure local gradle build time does not increase due to my change in DetectionResultEvalutationIT.\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-05-21T21:57:08Z", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/133", "merged": true, "mergeCommit": {"oid": "8804725971e5cab543f6ce90caf69c2b87f3135f"}, "closed": true, "closedAt": "2020-05-26T19:38:07Z", "author": {"login": "kaituo"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjkyPAgH2gAyNDIxNjA5MDIxOmI1MzBhY2ZhZmQ3NWE1YjEwYzcyZWQ5OGUzZmI4ODAyOWM3OGEzMGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABclJ8jdAFqTQxODYyMDEyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b530acfafd75a5b10c72ed98e3fb88029c78a30f", "author": {"user": {"login": "kaituo", "name": "Kaituo Li"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/b530acfafd75a5b10c72ed98e3fb88029c78a30f", "committedDate": "2020-05-21T21:44:53Z", "message": "Added CI/CD workflows\n\nThis PR adds CI/CD workflows. CI workflow builds a zip file, installs that on the official odfe docker image, and runs rest test case.  CI workflow is triggered via branch pushing.  CD workflow builds zip, rpm, deb files and uploads those files to s3.  CD workflow is triggered via tag creation.\n\nThis PR also increases model initialization waiting time as needed on an rest test case as that time can be can be longer on a remote cluster.\n\nTesting done:\n1. run the scripts on CI/CD workflow on Mac and tested it works.\n2. make sure local gradle build time does not increase."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MDY2NzMz", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/133#pullrequestreview-417066733", "createdAt": "2020-05-22T17:13:22Z", "commit": {"oid": "b530acfafd75a5b10c72ed98e3fb88029c78a30f"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNzoxMzoyMlrOGZeQTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNzoxNDowNlrOGZeRjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2MzI3Ng==", "bodyText": "if it is timed out, is it better to fail fast?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/133#discussion_r429363276", "createdAt": "2020-05-22T17:13:22Z", "author": {"login": "wnbts"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/ad/e2e/DetectionResultEvalutationIT.java", "diffHunk": "@@ -172,7 +172,22 @@ private void startDetector(\n             } catch (Exception e) {}\n         }\n         Thread.sleep(5_000);\n-        getDetectionResult(detectorId, begin, end, client);\n+        // It takes more time to wait for model initialization on a remote cluster\n+        long startTime = System.currentTimeMillis();\n+        while (true) {\n+            try {\n+                getDetectionResult(detectorId, begin, end, client);\n+                break;\n+            } catch (Exception e) {\n+                long duration = System.currentTimeMillis() - startTime;\n+                // we wait at most 60 secs\n+                if (duration < 60_000) {\n+                    Thread.sleep(2_000);\n+                } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b530acfafd75a5b10c72ed98e3fb88029c78a30f"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2MzU5Ng==", "bodyText": "this wait can be merged to the wait below now", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/133#discussion_r429363596", "createdAt": "2020-05-22T17:14:06Z", "author": {"login": "wnbts"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/ad/e2e/DetectionResultEvalutationIT.java", "diffHunk": "@@ -172,7 +172,22 @@ private void startDetector(\n             } catch (Exception e) {}\n         }\n         Thread.sleep(5_000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b530acfafd75a5b10c72ed98e3fb88029c78a30f"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MjI4Mzc1", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/133#pullrequestreview-417228375", "createdAt": "2020-05-22T23:56:58Z", "commit": {"oid": "b530acfafd75a5b10c72ed98e3fb88029c78a30f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQyMzo1Njo1OFrOGZmIkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQyMzo1Njo1OFrOGZmIkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ5MjM3MQ==", "bodyText": "This won't run if the first one fails. just wanna confirm if this is what we expect", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/133#discussion_r429492371", "createdAt": "2020-05-22T23:56:58Z", "author": {"login": "weicongs-amazon"}, "path": ".github/workflows/CI.yml", "diffHunk": "@@ -0,0 +1,63 @@\n+name: Build and Test Anomaly detection\n+on:\n+  push:\n+    branches:\n+      - master\n+      - opendistro-*\n+\n+jobs:\n+  Build-ad:\n+    strategy:\n+      matrix:\n+        java: [14]\n+\n+    name: Build and Test Anomaly detection Plugin\n+    runs-on: ubuntu-latest\n+\n+    steps:\n+      - name: Checkout AD\n+        uses: actions/checkout@v1\n+\n+      - name: Setup Java ${{ matrix.java }}\n+        uses: actions/setup-java@v1\n+        with:\n+          java-version: ${{ matrix.java }}\n+\n+      - name: Run build\n+        run: |\n+          ./gradlew build\n+          ls -ltr build/distributions/\n+\n+      - name: Pull and Run Docker\n+        run: |\n+          plugin=`ls build/distributions/*.zip`\n+          version=`echo $plugin|awk -F- '{print $4}'| cut -d. -f 1-3`\n+          plugin_version=`echo $plugin|awk -F- '{print $4}'| cut -d. -f 1-4`\n+          echo $version\n+          cd ..\n+\n+          if docker pull opendistroforelasticsearch/opendistroforelasticsearch:$version\n+          then\n+            echo \"FROM opendistroforelasticsearch/opendistroforelasticsearch:$version\" >> Dockerfile\n+\n+            ## The ESRestTest Client uses http by default.\n+            ## Need to disable the security plugin to call the rest api over http.\n+            echo \"RUN if [ -d /usr/share/elasticsearch/plugins/opendistro_security ]; then /usr/share/elasticsearch/bin/elasticsearch-plugin remove opendistro_security; fi\" >> Dockerfile\n+            echo \"RUN if [ -d /usr/share/elasticsearch/plugins/opendistro-anomaly-detection ]; then /usr/share/elasticsearch/bin/elasticsearch-plugin remove opendistro-anomaly-detection; fi\" >> Dockerfile\n+            echo \"ADD anomaly-detection/build/distributions/opendistro-anomaly-detection-$plugin_version.zip /tmp/\" >> Dockerfile\n+            echo \"RUN /usr/share/elasticsearch/bin/elasticsearch-plugin install --batch file:/tmp/opendistro-anomaly-detection-$plugin_version.zip\" >> Dockerfile\n+\n+            docker build -t odfe-ad:test .\n+          fi\n+\n+      - name: Run Docker Image\n+        run: |\n+          cd ..\n+          docker run -p 9200:9200 -d -p 9600:9600 -e \"discovery.type=single-node\" odfe-ad:test\n+          sleep 90\n+          curl -XGET http://localhost:9200/_cat/plugins\n+\n+      - name: Run AD Test\n+        run: |\n+          ./gradlew ':integTestRunner' --tests \"com.amazon.opendistroforelasticsearch.ad.rest.*IT\" -Dtests.rest.cluster=localhost:9200 -Dtests.cluster=localhost:9200 -Dtests.clustername=\"docker-cluster\"\n+          ./gradlew :integTestRunner --tests \"com.amazon.opendistroforelasticsearch.ad.e2e.*IT\"  -Dtests.rest.cluster=localhost:9200 -Dtests.cluster=localhost:9200 -Dtests.clustername=\"docker-cluster\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b530acfafd75a5b10c72ed98e3fb88029c78a30f"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02b38770c3b9b078b1d03758c6e5d555e1e363d2", "author": {"user": {"login": "kaituo", "name": "Kaituo Li"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/02b38770c3b9b078b1d03758c6e5d555e1e363d2", "committedDate": "2020-05-23T02:39:28Z", "message": "Merge multiple test commands into one and refactor test case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4NDc0MTA5", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/133#pullrequestreview-418474109", "createdAt": "2020-05-26T16:31:02Z", "commit": {"oid": "02b38770c3b9b078b1d03758c6e5d555e1e363d2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4NjIwMTI3", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/133#pullrequestreview-418620127", "createdAt": "2020-05-26T19:36:34Z", "commit": {"oid": "02b38770c3b9b078b1d03758c6e5d555e1e363d2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1463, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}