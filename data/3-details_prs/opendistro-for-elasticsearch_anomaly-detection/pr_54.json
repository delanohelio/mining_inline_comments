{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0NTUzOTMz", "number": 54, "title": "Cancel query if given detector already have one", "bodyText": "Issue #55, if available:\nCancel running query if given detector already has one running.\nDescription of changes:\n\n./gradlew build\nstart my own cluster and tested with a 20sec delay query as long running query. If one detector is running a query, a second query request will cancel the previous one and start itself.\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-03-05T23:37:39Z", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54", "merged": true, "mergeCommit": {"oid": "f40c532f9a62ce4115e9a458bd6c1346e4e04e54"}, "closed": true, "closedAt": "2020-03-13T23:39:22Z", "author": {"login": "zhanghg08"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFpUDhgH2gAyMzg0NTUzOTMzOjMzNzUzOTYzMTg0NDM5ZGU1OGQ3NTIzNjZjOGQxNDc1NmE3MDc4MWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNYCwnAH2gAyMzg0NTUzOTMzOjA2NzM3NDE2OWU4Y2JmYWQyYzY4MjI2NjI5M2QyYTkyMjVlMmRjYjM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "33753963184439de58d752366c8d14756a70781a", "author": {"user": {"login": "zhanghg08", "name": "Hanguang Zhang"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/33753963184439de58d752366c8d14756a70781a", "committedDate": "2020-02-18T22:03:43Z", "message": "Add daily cron job to clean negative cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87badb1b216adba3a6f91573f2d4b471adeae8eb", "author": {"user": {"login": "zhanghg08", "name": "Hanguang Zhang"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/87badb1b216adba3a6f91573f2d4b471adeae8eb", "committedDate": "2020-02-18T22:22:21Z", "message": "Adding missing java doc and simplify code."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c189712552aa1a218b3df152db6bde43b347bb3", "author": {"user": {"login": "zhanghg08", "name": "Hanguang Zhang"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/4c189712552aa1a218b3df152db6bde43b347bb3", "committedDate": "2020-02-19T16:34:03Z", "message": "Create CancelQueryUtil to handle query canceling logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08dfb54192206f41eadb890dd1e1a7a28098d14c", "author": {"user": {"login": "zhanghg08", "name": "Hanguang Zhang"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/08dfb54192206f41eadb890dd1e1a7a28098d14c", "committedDate": "2020-02-19T23:00:19Z", "message": "Add cron job test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c64199e017d1dbd108e843d7368fa60ea328f0f", "author": {"user": {"login": "zhanghg08", "name": "Hanguang Zhang"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/8c64199e017d1dbd108e843d7368fa60ea328f0f", "committedDate": "2020-02-24T23:59:34Z", "message": "Add additional clean"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99e9487c3af27299a90ccab285757e5942b63d5c", "author": {"user": {"login": "zhanghg08", "name": "Hanguang Zhang"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/99e9487c3af27299a90ccab285757e5942b63d5c", "committedDate": "2020-02-25T16:49:46Z", "message": "Commit all changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df38d00fbdb9dd741c1ec85f9995b9d366faabb7", "author": {"user": {"login": "zhanghg08", "name": "Hanguang Zhang"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/df38d00fbdb9dd741c1ec85f9995b9d366faabb7", "committedDate": "2020-02-25T17:10:14Z", "message": "Merge branch 'cron' into cancel_query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d797543fc24e1c7213ad2053fb255b0b371e6df9", "author": {"user": {"login": "zhanghg08", "name": "Hanguang Zhang"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/d797543fc24e1c7213ad2053fb255b0b371e6df9", "committedDate": "2020-03-05T23:33:46Z", "message": "Cancel long running query if a new request coming for given detector id"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNjcxOTMx", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#pullrequestreview-371671931", "createdAt": "2020-03-10T04:12:56Z", "commit": {"oid": "d797543fc24e1c7213ad2053fb255b0b371e6df9"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwNDoxMjo1NlrOF0A_KQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwNToxNzo1N1rOF0ByMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA4NjQ0MQ==", "bodyText": "Would\n\"if (task.getHeaders().get(Task.X_OPAQUE_ID).equals(CommonName.ANOMALY_DETECTOR + \":\" + detectorId))\"\nimproves performance since you might need do this comparison a lot of times if there are a lot of tasks?\nequals is O(n), while contains can be O(n*m) where m is the string to match and n is the string to search.\nSee the implementation of contains (depends on indexOf):\nhttp://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/java/lang/String.java#l1740", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r390086441", "createdAt": "2020-03-10T04:12:56Z", "author": {"login": "kaituo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClientUtil.java", "diffHunk": "@@ -222,4 +244,80 @@ public ClientUtil(Settings setting, Client client, Throttler throttler) {\n     public boolean hasRunningQuery(AnomalyDetector detector) {\n         return throttler.getFilteredQuery(detector.getDetectorId()).isPresent();\n     }\n+\n+    /**\n+     * Cancel long running query for given detectorId\n+     * @param client Elasticsearch client\n+     * @param detectorId Anomaly Detector Id\n+     * @param LOG Logger\n+     */\n+    private void cancelRunningQuery(Client client, String detectorId, Logger LOG) {\n+        ListTasksRequest listTasksRequest = new ListTasksRequest();\n+        client\n+            .execute(\n+                ListTasksAction.INSTANCE,\n+                listTasksRequest,\n+                ActionListener.wrap(response -> { onListTaskResponse(response, detectorId, LOG); }, exception -> {\n+                    LOG.error(\"List Tasks failed.\", exception);\n+                    throw new InternalFailure(detectorId, \"Failed to list current tasks\", exception);\n+                })\n+            );\n+    }\n+\n+    /**\n+     * Helper function to handle ListTasksResponse\n+     * @param listTasksResponse ListTasksResponse\n+     * @param detectorId Anomaly Detector Id\n+     * @param LOG Logger\n+     */\n+    private void onListTaskResponse(ListTasksResponse listTasksResponse, String detectorId, Logger LOG) {\n+        List<TaskInfo> tasks = listTasksResponse.getTasks();\n+        TaskInfo matchedTask = null;\n+        for (TaskInfo task : tasks) {\n+            if (!task.getHeaders().isEmpty() && task.getHeaders().get(Task.X_OPAQUE_ID) != null) {\n+                if (task.getHeaders().get(Task.X_OPAQUE_ID).contains(detectorId)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d797543fc24e1c7213ad2053fb255b0b371e6df9"}, "originalPosition": 155}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA5MTcxMg==", "bodyText": "Return after cancelling since we don't know when the cancel would actually happen?  We might keep piling up new queries when the previous old queries are not cancelled.\nAlso, we need to send InternalFailure not EndRunException.  EndRunException is used for scenarios when we might need to terminate AD job running soon.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r390091712", "createdAt": "2020-03-10T04:38:34Z", "author": {"login": "kaituo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClientUtil.java", "diffHunk": "@@ -179,32 +197,36 @@ public ClientUtil(Settings setting, Client client, Throttler throttler) {\n         BiConsumer<Request, ActionListener<Response>> consumer,\n         AnomalyDetector detector\n     ) {\n+\n         try {\n-            // if key already exist, reject the request and throws exception\n-            if (!throttler.insertFilteredQuery(detector.getDetectorId(), request)) {\n-                LOG.error(\"There is one query running for detectorId: {}\", detector.getDetectorId());\n-                throw new EndRunException(detector.getDetectorId(), \"There is one query running on AnomalyDetector\", true);\n+            String detectorId = detector.getDetectorId();\n+            if (!throttler.insertFilteredQuery(detectorId, request)) {\n+                LOG.info(\"There is one query running for detectorId: {}. Trying to cancel the long running query\", detectorId);\n+                cancelRunningQuery(client, detectorId, LOG);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d797543fc24e1c7213ad2053fb255b0b371e6df9"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA5NDc1MQ==", "bodyText": "You can add some parameters to speed up task search:\n\ngroup_by=parents: so each group you only need to check header once\nactions=*search: since our queries are searches.  We don't care about write or update.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r390094751", "createdAt": "2020-03-10T04:53:39Z", "author": {"login": "kaituo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClientUtil.java", "diffHunk": "@@ -222,4 +244,80 @@ public ClientUtil(Settings setting, Client client, Throttler throttler) {\n     public boolean hasRunningQuery(AnomalyDetector detector) {\n         return throttler.getFilteredQuery(detector.getDetectorId()).isPresent();\n     }\n+\n+    /**\n+     * Cancel long running query for given detectorId\n+     * @param client Elasticsearch client\n+     * @param detectorId Anomaly Detector Id\n+     * @param LOG Logger\n+     */\n+    private void cancelRunningQuery(Client client, String detectorId, Logger LOG) {\n+        ListTasksRequest listTasksRequest = new ListTasksRequest();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d797543fc24e1c7213ad2053fb255b0b371e6df9"}, "originalPosition": 132}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA5OTUwNg==", "bodyText": "Is there a unit/integration test for the cancel mechanism?  If not, I strongly suggest we add one.\nYou can add an ESIntegTestCase where we\n\ndefine a SearchOperationListener such that index operations are delayed to simulate long running queries;\ncreate a fake plugin to use listener defined in 1)\nadd AD plugin and the fake plugin together\n... automate what you did on manual testing ..", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r390099506", "createdAt": "2020-03-10T05:17:57Z", "author": {"login": "kaituo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/AnomalyDetectorPlugin.java", "diffHunk": "@@ -199,7 +199,7 @@ private static Void initGson() {\n         Settings settings = environment.settings();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d797543fc24e1c7213ad2053fb255b0b371e6df9"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMjMwMDYz", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#pullrequestreview-372230063", "createdAt": "2020-03-10T18:48:21Z", "commit": {"oid": "d797543fc24e1c7213ad2053fb255b0b371e6df9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxODo0ODoyMlrOF0ccow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxODo0ODoyMlrOF0ccow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUzNjM1NQ==", "bodyText": "Please add more description about cancel request process", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r390536355", "createdAt": "2020-03-10T18:48:22Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClientUtil.java", "diffHunk": "@@ -162,11 +180,11 @@ public ClientUtil(Settings setting, Client client, Throttler throttler) {\n      * Send a nonblocking request with a timeout and return response. The request will first be put into\n      * the negative cache. Once the request complete, it will be removed from the negative cache.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d797543fc24e1c7213ad2053fb255b0b371e6df9"}, "originalPosition": 62}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMjMxODA0", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#pullrequestreview-372231804", "createdAt": "2020-03-10T18:50:38Z", "commit": {"oid": "d797543fc24e1c7213ad2053fb255b0b371e6df9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxODo1MDozOVrOF0ciLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxODo1MDozOVrOF0ciLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUzNzc3Mw==", "bodyText": "Remove empty line", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r390537773", "createdAt": "2020-03-10T18:50:39Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClientUtil.java", "diffHunk": "@@ -179,32 +197,36 @@ public ClientUtil(Settings setting, Client client, Throttler throttler) {\n         BiConsumer<Request, ActionListener<Response>> consumer,\n         AnomalyDetector detector\n     ) {\n+\n         try {\n-            // if key already exist, reject the request and throws exception\n-            if (!throttler.insertFilteredQuery(detector.getDetectorId(), request)) {\n-                LOG.error(\"There is one query running for detectorId: {}\", detector.getDetectorId());\n-                throw new EndRunException(detector.getDetectorId(), \"There is one query running on AnomalyDetector\", true);\n+            String detectorId = detector.getDetectorId();\n+            if (!throttler.insertFilteredQuery(detectorId, request)) {\n+                LOG.info(\"There is one query running for detectorId: {}. Trying to cancel the long running query\", detectorId);\n+                cancelRunningQuery(client, detectorId, LOG);\n             }\n             AtomicReference<Response> respReference = new AtomicReference<>();\n             final CountDownLatch latch = new CountDownLatch(1);\n \n-            try {\n+            try (ThreadContext.StoredContext context = threadPool.getThreadContext().stashContext()) {\n+                assert context != null;\n+                threadPool.getThreadContext().putHeader(Task.X_OPAQUE_ID, CommonName.ANOMALY_DETECTOR + \":\" + detectorId);\n                 consumer.accept(request, new LatchedActionListener<Response>(ActionListener.wrap(response -> {\n                     // clear negative cache\n-                    throttler.clearFilteredQuery(detector.getDetectorId());\n+                    throttler.clearFilteredQuery(detectorId);\n                     respReference.set(response);\n                 }, exception -> {\n                     // clear negative cache\n-                    throttler.clearFilteredQuery(detector.getDetectorId());\n+                    throttler.clearFilteredQuery(detectorId);\n                     LOG.error(\"Cannot get response for request {}, error: {}\", request, exception);\n                 }), latch));\n             } catch (Exception e) {\n-                LOG.error(\"Failed to process the request for detectorId: {}.\", detector.getDetectorId());\n-                throttler.clearFilteredQuery(detector.getDetectorId());\n+                LOG.error(\"Failed to process the request for detectorId: {}.\", detectorId);\n+                throttler.clearFilteredQuery(detectorId);\n                 throw e;\n             }\n \n             if (!latch.await(requestTimeout.getSeconds(), TimeUnit.SECONDS)) {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d797543fc24e1c7213ad2053fb255b0b371e6df9"}, "originalPosition": 116}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMjM2NjEx", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#pullrequestreview-372236611", "createdAt": "2020-03-10T18:57:19Z", "commit": {"oid": "d797543fc24e1c7213ad2053fb255b0b371e6df9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxODo1NzoxOVrOF0cx2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxODo1NzoxOVrOF0cx2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU0MTc4Nw==", "bodyText": "Is it possible the parent task has parent too? If yes, should we find the root task and kill all?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r390541787", "createdAt": "2020-03-10T18:57:19Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClientUtil.java", "diffHunk": "@@ -222,4 +244,80 @@ public ClientUtil(Settings setting, Client client, Throttler throttler) {\n     public boolean hasRunningQuery(AnomalyDetector detector) {\n         return throttler.getFilteredQuery(detector.getDetectorId()).isPresent();\n     }\n+\n+    /**\n+     * Cancel long running query for given detectorId\n+     * @param client Elasticsearch client\n+     * @param detectorId Anomaly Detector Id\n+     * @param LOG Logger\n+     */\n+    private void cancelRunningQuery(Client client, String detectorId, Logger LOG) {\n+        ListTasksRequest listTasksRequest = new ListTasksRequest();\n+        client\n+            .execute(\n+                ListTasksAction.INSTANCE,\n+                listTasksRequest,\n+                ActionListener.wrap(response -> { onListTaskResponse(response, detectorId, LOG); }, exception -> {\n+                    LOG.error(\"List Tasks failed.\", exception);\n+                    throw new InternalFailure(detectorId, \"Failed to list current tasks\", exception);\n+                })\n+            );\n+    }\n+\n+    /**\n+     * Helper function to handle ListTasksResponse\n+     * @param listTasksResponse ListTasksResponse\n+     * @param detectorId Anomaly Detector Id\n+     * @param LOG Logger\n+     */\n+    private void onListTaskResponse(ListTasksResponse listTasksResponse, String detectorId, Logger LOG) {\n+        List<TaskInfo> tasks = listTasksResponse.getTasks();\n+        TaskInfo matchedTask = null;\n+        for (TaskInfo task : tasks) {\n+            if (!task.getHeaders().isEmpty() && task.getHeaders().get(Task.X_OPAQUE_ID) != null) {\n+                if (task.getHeaders().get(Task.X_OPAQUE_ID).contains(detectorId)) {\n+                    matchedTask = task;\n+                    break;\n+                }\n+            }\n+        }\n+        // case 1: given detectorId is not in current task list\n+        if (matchedTask == null) {\n+            // log and then clear negative cache\n+            LOG.info(\"Couldn't find task for detectorId: {}. Clean this entry from Throttler\", detectorId);\n+            throttler.clearFilteredQuery(detectorId);\n+            return;\n+        }\n+        // case 2: we can find the task for given detectorId\n+        TaskId parentTaskId = matchedTask.getParentTaskId().isSet() ? matchedTask.getParentTaskId() : matchedTask.getTaskId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d797543fc24e1c7213ad2053fb255b0b371e6df9"}, "originalPosition": 169}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMjM5MDk5", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#pullrequestreview-372239099", "createdAt": "2020-03-10T19:00:52Z", "commit": {"oid": "d797543fc24e1c7213ad2053fb255b0b371e6df9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxOTowMDo1MlrOF0c58A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxOTowMDo1MlrOF0c58A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU0Mzg1Ng==", "bodyText": "Better to add some retry for these failed tasks. Otherwise, will wait for next detector run to cancel again.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r390543856", "createdAt": "2020-03-10T19:00:52Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClientUtil.java", "diffHunk": "@@ -222,4 +244,80 @@ public ClientUtil(Settings setting, Client client, Throttler throttler) {\n     public boolean hasRunningQuery(AnomalyDetector detector) {\n         return throttler.getFilteredQuery(detector.getDetectorId()).isPresent();\n     }\n+\n+    /**\n+     * Cancel long running query for given detectorId\n+     * @param client Elasticsearch client\n+     * @param detectorId Anomaly Detector Id\n+     * @param LOG Logger\n+     */\n+    private void cancelRunningQuery(Client client, String detectorId, Logger LOG) {\n+        ListTasksRequest listTasksRequest = new ListTasksRequest();\n+        client\n+            .execute(\n+                ListTasksAction.INSTANCE,\n+                listTasksRequest,\n+                ActionListener.wrap(response -> { onListTaskResponse(response, detectorId, LOG); }, exception -> {\n+                    LOG.error(\"List Tasks failed.\", exception);\n+                    throw new InternalFailure(detectorId, \"Failed to list current tasks\", exception);\n+                })\n+            );\n+    }\n+\n+    /**\n+     * Helper function to handle ListTasksResponse\n+     * @param listTasksResponse ListTasksResponse\n+     * @param detectorId Anomaly Detector Id\n+     * @param LOG Logger\n+     */\n+    private void onListTaskResponse(ListTasksResponse listTasksResponse, String detectorId, Logger LOG) {\n+        List<TaskInfo> tasks = listTasksResponse.getTasks();\n+        TaskInfo matchedTask = null;\n+        for (TaskInfo task : tasks) {\n+            if (!task.getHeaders().isEmpty() && task.getHeaders().get(Task.X_OPAQUE_ID) != null) {\n+                if (task.getHeaders().get(Task.X_OPAQUE_ID).contains(detectorId)) {\n+                    matchedTask = task;\n+                    break;\n+                }\n+            }\n+        }\n+        // case 1: given detectorId is not in current task list\n+        if (matchedTask == null) {\n+            // log and then clear negative cache\n+            LOG.info(\"Couldn't find task for detectorId: {}. Clean this entry from Throttler\", detectorId);\n+            throttler.clearFilteredQuery(detectorId);\n+            return;\n+        }\n+        // case 2: we can find the task for given detectorId\n+        TaskId parentTaskId = matchedTask.getParentTaskId().isSet() ? matchedTask.getParentTaskId() : matchedTask.getTaskId();\n+        CancelTasksRequest cancelTaskRequest = new CancelTasksRequest();\n+        cancelTaskRequest.setParentTaskId(parentTaskId);\n+        LOG.info(\"Start to cancel task for parentTaskId: {}\", parentTaskId);\n+        client\n+            .execute(\n+                CancelTasksAction.INSTANCE,\n+                cancelTaskRequest,\n+                ActionListener.wrap(response -> { onCancelTaskResponse(response, detectorId, LOG); }, exception -> {\n+                    LOG.error(\"Failed to cancel task for detectorId: \" + detectorId, exception);\n+                    throw new InternalFailure(detectorId, \"Failed to cancel current tasks\", exception);\n+                })\n+            );\n+    }\n+\n+    /**\n+     * Helper function to handle CancelTasksResponse\n+     * @param cancelTasksResponse CancelTasksResponse\n+     * @param detectorId Anomaly Detector Id\n+     * @param LOG Logger\n+     */\n+    private void onCancelTaskResponse(CancelTasksResponse cancelTasksResponse, String detectorId, Logger LOG) {\n+        List<ElasticsearchException> nodeFailures = cancelTasksResponse.getNodeFailures();\n+        List<TaskOperationFailure> taskFailures = cancelTasksResponse.getTaskFailures();\n+        if (nodeFailures.isEmpty() && taskFailures.isEmpty()) {\n+            LOG.info(\"Cancelling query for detectorId: {} succeeds. Clear entry from Throttler\", detectorId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d797543fc24e1c7213ad2053fb255b0b371e6df9"}, "originalPosition": 194}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMjUyNDc0", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#pullrequestreview-372252474", "createdAt": "2020-03-10T19:20:40Z", "commit": {"oid": "d797543fc24e1c7213ad2053fb255b0b371e6df9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxOToyMDo0MFrOF0dlVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxOToyMDo0MFrOF0dlVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU1NDk2Ng==", "bodyText": "It's possible the cancelRunningQuery in progress or fail when start a new request. If cancelRunningQuery is not time consuming, better to start a new request when we get respond of cancelRunningQuery. If it's heavy action, may need to monitor the cancelation status and retry if failed; so we can terminate unnecessary AD query to protect cluster performance. It's ok to add some todo&comments here and refactor it later if you think the change will be big.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r390554966", "createdAt": "2020-03-10T19:20:40Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClientUtil.java", "diffHunk": "@@ -179,32 +197,36 @@ public ClientUtil(Settings setting, Client client, Throttler throttler) {\n         BiConsumer<Request, ActionListener<Response>> consumer,\n         AnomalyDetector detector\n     ) {\n+\n         try {\n-            // if key already exist, reject the request and throws exception\n-            if (!throttler.insertFilteredQuery(detector.getDetectorId(), request)) {\n-                LOG.error(\"There is one query running for detectorId: {}\", detector.getDetectorId());\n-                throw new EndRunException(detector.getDetectorId(), \"There is one query running on AnomalyDetector\", true);\n+            String detectorId = detector.getDetectorId();\n+            if (!throttler.insertFilteredQuery(detectorId, request)) {\n+                LOG.info(\"There is one query running for detectorId: {}. Trying to cancel the long running query\", detectorId);\n+                cancelRunningQuery(client, detectorId, LOG);\n             }\n             AtomicReference<Response> respReference = new AtomicReference<>();\n             final CountDownLatch latch = new CountDownLatch(1);\n \n-            try {\n+            try (ThreadContext.StoredContext context = threadPool.getThreadContext().stashContext()) {\n+                assert context != null;\n+                threadPool.getThreadContext().putHeader(Task.X_OPAQUE_ID, CommonName.ANOMALY_DETECTOR + \":\" + detectorId);\n                 consumer.accept(request, new LatchedActionListener<Response>(ActionListener.wrap(response -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d797543fc24e1c7213ad2053fb255b0b371e6df9"}, "originalPosition": 96}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMjU1NDc5", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#pullrequestreview-372255479", "createdAt": "2020-03-10T19:25:14Z", "commit": {"oid": "d797543fc24e1c7213ad2053fb255b0b371e6df9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxOToyNToxNFrOF0du-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxOToyNToxNFrOF0du-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU1NzQzNQ==", "bodyText": "Just asking, will the X_OPAQUE_ID header be passed to child tasks?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r390557435", "createdAt": "2020-03-10T19:25:14Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClientUtil.java", "diffHunk": "@@ -179,32 +197,36 @@ public ClientUtil(Settings setting, Client client, Throttler throttler) {\n         BiConsumer<Request, ActionListener<Response>> consumer,\n         AnomalyDetector detector\n     ) {\n+\n         try {\n-            // if key already exist, reject the request and throws exception\n-            if (!throttler.insertFilteredQuery(detector.getDetectorId(), request)) {\n-                LOG.error(\"There is one query running for detectorId: {}\", detector.getDetectorId());\n-                throw new EndRunException(detector.getDetectorId(), \"There is one query running on AnomalyDetector\", true);\n+            String detectorId = detector.getDetectorId();\n+            if (!throttler.insertFilteredQuery(detectorId, request)) {\n+                LOG.info(\"There is one query running for detectorId: {}. Trying to cancel the long running query\", detectorId);\n+                cancelRunningQuery(client, detectorId, LOG);\n             }\n             AtomicReference<Response> respReference = new AtomicReference<>();\n             final CountDownLatch latch = new CountDownLatch(1);\n \n-            try {\n+            try (ThreadContext.StoredContext context = threadPool.getThreadContext().stashContext()) {\n+                assert context != null;\n+                threadPool.getThreadContext().putHeader(Task.X_OPAQUE_ID, CommonName.ANOMALY_DETECTOR + \":\" + detectorId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d797543fc24e1c7213ad2053fb255b0b371e6df9"}, "originalPosition": 95}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMjU5ODUz", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#pullrequestreview-372259853", "createdAt": "2020-03-10T19:31:38Z", "commit": {"oid": "d797543fc24e1c7213ad2053fb255b0b371e6df9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxOTozMTozOFrOF0d8Ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxOTozMTozOFrOF0d8Ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU2MDg1OQ==", "bodyText": "From line292, if matchedTask.getParentTaskId().isSet() is false, will get matchedTask.getTaskId()  as parentTaskId.  For this case, cancelTaskRequest.setParentTaskId(parentTaskId) will cancel tasks which has parent task id as matchedTask.getTaskId(). Is it possible the matchedTask has no child tasks? If it's possible, will cancelTaskRequest.setParentTaskId(parentTaskId) throw exception or cancel matchedTask ?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r390560859", "createdAt": "2020-03-10T19:31:38Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClientUtil.java", "diffHunk": "@@ -222,4 +244,80 @@ public ClientUtil(Settings setting, Client client, Throttler throttler) {\n     public boolean hasRunningQuery(AnomalyDetector detector) {\n         return throttler.getFilteredQuery(detector.getDetectorId()).isPresent();\n     }\n+\n+    /**\n+     * Cancel long running query for given detectorId\n+     * @param client Elasticsearch client\n+     * @param detectorId Anomaly Detector Id\n+     * @param LOG Logger\n+     */\n+    private void cancelRunningQuery(Client client, String detectorId, Logger LOG) {\n+        ListTasksRequest listTasksRequest = new ListTasksRequest();\n+        client\n+            .execute(\n+                ListTasksAction.INSTANCE,\n+                listTasksRequest,\n+                ActionListener.wrap(response -> { onListTaskResponse(response, detectorId, LOG); }, exception -> {\n+                    LOG.error(\"List Tasks failed.\", exception);\n+                    throw new InternalFailure(detectorId, \"Failed to list current tasks\", exception);\n+                })\n+            );\n+    }\n+\n+    /**\n+     * Helper function to handle ListTasksResponse\n+     * @param listTasksResponse ListTasksResponse\n+     * @param detectorId Anomaly Detector Id\n+     * @param LOG Logger\n+     */\n+    private void onListTaskResponse(ListTasksResponse listTasksResponse, String detectorId, Logger LOG) {\n+        List<TaskInfo> tasks = listTasksResponse.getTasks();\n+        TaskInfo matchedTask = null;\n+        for (TaskInfo task : tasks) {\n+            if (!task.getHeaders().isEmpty() && task.getHeaders().get(Task.X_OPAQUE_ID) != null) {\n+                if (task.getHeaders().get(Task.X_OPAQUE_ID).contains(detectorId)) {\n+                    matchedTask = task;\n+                    break;\n+                }\n+            }\n+        }\n+        // case 1: given detectorId is not in current task list\n+        if (matchedTask == null) {\n+            // log and then clear negative cache\n+            LOG.info(\"Couldn't find task for detectorId: {}. Clean this entry from Throttler\", detectorId);\n+            throttler.clearFilteredQuery(detectorId);\n+            return;\n+        }\n+        // case 2: we can find the task for given detectorId\n+        TaskId parentTaskId = matchedTask.getParentTaskId().isSet() ? matchedTask.getParentTaskId() : matchedTask.getTaskId();\n+        CancelTasksRequest cancelTaskRequest = new CancelTasksRequest();\n+        cancelTaskRequest.setParentTaskId(parentTaskId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d797543fc24e1c7213ad2053fb255b0b371e6df9"}, "originalPosition": 171}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMjY0MDI4", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#pullrequestreview-372264028", "createdAt": "2020-03-10T19:37:59Z", "commit": {"oid": "d797543fc24e1c7213ad2053fb255b0b371e6df9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxOTozNzo1OVrOF0eJZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxOTozNzo1OVrOF0eJZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU2NDE5Ng==", "bodyText": "log failures?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r390564196", "createdAt": "2020-03-10T19:37:59Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClientUtil.java", "diffHunk": "@@ -222,4 +244,80 @@ public ClientUtil(Settings setting, Client client, Throttler throttler) {\n     public boolean hasRunningQuery(AnomalyDetector detector) {\n         return throttler.getFilteredQuery(detector.getDetectorId()).isPresent();\n     }\n+\n+    /**\n+     * Cancel long running query for given detectorId\n+     * @param client Elasticsearch client\n+     * @param detectorId Anomaly Detector Id\n+     * @param LOG Logger\n+     */\n+    private void cancelRunningQuery(Client client, String detectorId, Logger LOG) {\n+        ListTasksRequest listTasksRequest = new ListTasksRequest();\n+        client\n+            .execute(\n+                ListTasksAction.INSTANCE,\n+                listTasksRequest,\n+                ActionListener.wrap(response -> { onListTaskResponse(response, detectorId, LOG); }, exception -> {\n+                    LOG.error(\"List Tasks failed.\", exception);\n+                    throw new InternalFailure(detectorId, \"Failed to list current tasks\", exception);\n+                })\n+            );\n+    }\n+\n+    /**\n+     * Helper function to handle ListTasksResponse\n+     * @param listTasksResponse ListTasksResponse\n+     * @param detectorId Anomaly Detector Id\n+     * @param LOG Logger\n+     */\n+    private void onListTaskResponse(ListTasksResponse listTasksResponse, String detectorId, Logger LOG) {\n+        List<TaskInfo> tasks = listTasksResponse.getTasks();\n+        TaskInfo matchedTask = null;\n+        for (TaskInfo task : tasks) {\n+            if (!task.getHeaders().isEmpty() && task.getHeaders().get(Task.X_OPAQUE_ID) != null) {\n+                if (task.getHeaders().get(Task.X_OPAQUE_ID).contains(detectorId)) {\n+                    matchedTask = task;\n+                    break;\n+                }\n+            }\n+        }\n+        // case 1: given detectorId is not in current task list\n+        if (matchedTask == null) {\n+            // log and then clear negative cache\n+            LOG.info(\"Couldn't find task for detectorId: {}. Clean this entry from Throttler\", detectorId);\n+            throttler.clearFilteredQuery(detectorId);\n+            return;\n+        }\n+        // case 2: we can find the task for given detectorId\n+        TaskId parentTaskId = matchedTask.getParentTaskId().isSet() ? matchedTask.getParentTaskId() : matchedTask.getTaskId();\n+        CancelTasksRequest cancelTaskRequest = new CancelTasksRequest();\n+        cancelTaskRequest.setParentTaskId(parentTaskId);\n+        LOG.info(\"Start to cancel task for parentTaskId: {}\", parentTaskId);\n+        client\n+            .execute(\n+                CancelTasksAction.INSTANCE,\n+                cancelTaskRequest,\n+                ActionListener.wrap(response -> { onCancelTaskResponse(response, detectorId, LOG); }, exception -> {\n+                    LOG.error(\"Failed to cancel task for detectorId: \" + detectorId, exception);\n+                    throw new InternalFailure(detectorId, \"Failed to cancel current tasks\", exception);\n+                })\n+            );\n+    }\n+\n+    /**\n+     * Helper function to handle CancelTasksResponse\n+     * @param cancelTasksResponse CancelTasksResponse\n+     * @param detectorId Anomaly Detector Id\n+     * @param LOG Logger\n+     */\n+    private void onCancelTaskResponse(CancelTasksResponse cancelTasksResponse, String detectorId, Logger LOG) {\n+        List<ElasticsearchException> nodeFailures = cancelTasksResponse.getNodeFailures();\n+        List<TaskOperationFailure> taskFailures = cancelTasksResponse.getTaskFailures();\n+        if (nodeFailures.isEmpty() && taskFailures.isEmpty()) {\n+            LOG.info(\"Cancelling query for detectorId: {} succeeds. Clear entry from Throttler\", detectorId);\n+            throttler.clearFilteredQuery(detectorId);\n+            return;\n+        }\n+        throw new InternalFailure(detectorId, \"Failed to cancel current tasks due to node or task failures\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d797543fc24e1c7213ad2053fb255b0b371e6df9"}, "originalPosition": 198}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b9d6992344e31ccede5f9fffd4782ebe1e9a9cb", "author": {"user": {"login": "zhanghg08", "name": "Hanguang Zhang"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/8b9d6992344e31ccede5f9fffd4782ebe1e9a9cb", "committedDate": "2020-03-12T21:03:47Z", "message": "Address feedback:\n1. Adding description to throttledTimedRequest\n2. Don't send new request if there is one running query. We only cancel the running one.\n3. Adding logic to deal with single task cancelling(no parent task)\n4. Adding log info/error and removing extra space."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MDI5MjQ2", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#pullrequestreview-374029246", "createdAt": "2020-03-13T03:21:49Z", "commit": {"oid": "8b9d6992344e31ccede5f9fffd4782ebe1e9a9cb"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwMzoyMTo0OVrOF12ibA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwMzoyMTo0OVrOF12ibA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjAxMjM5Ng==", "bodyText": "you meant we need to use \"actions=*search*\", right?  Yes, please do that.  Your current code uses \"*search\".", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#discussion_r392012396", "createdAt": "2020-03-13T03:21:49Z", "author": {"login": "kaituo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ClientUtil.java", "diffHunk": "@@ -222,4 +244,80 @@ public ClientUtil(Settings setting, Client client, Throttler throttler) {\n     public boolean hasRunningQuery(AnomalyDetector detector) {\n         return throttler.getFilteredQuery(detector.getDetectorId()).isPresent();\n     }\n+\n+    /**\n+     * Cancel long running query for given detectorId\n+     * @param client Elasticsearch client\n+     * @param detectorId Anomaly Detector Id\n+     * @param LOG Logger\n+     */\n+    private void cancelRunningQuery(Client client, String detectorId, Logger LOG) {\n+        ListTasksRequest listTasksRequest = new ListTasksRequest();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA5NDc1MQ=="}, "originalCommit": {"oid": "d797543fc24e1c7213ad2053fb255b0b371e6df9"}, "originalPosition": 132}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd1883bda8007a0c4ecb6499ad28128d59a1cda0", "author": {"user": {"login": "zhanghg08", "name": "Hanguang Zhang"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/fd1883bda8007a0c4ecb6499ad28128d59a1cda0", "committedDate": "2020-03-13T18:01:57Z", "message": "1. change listtask filter from \"*search\" to \"*search*\""}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NTc5MTMz", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/54#pullrequestreview-374579133", "createdAt": "2020-03-13T20:06:25Z", "commit": {"oid": "8b9d6992344e31ccede5f9fffd4782ebe1e9a9cb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "067374169e8cbfad2c682266293d2a9225e2dcb3", "author": {"user": {"login": "zhanghg08", "name": "Hanguang Zhang"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/067374169e8cbfad2c682266293d2a9225e2dcb3", "committedDate": "2020-03-13T22:27:50Z", "message": "Merge branch 'development' into cancel_query"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1628, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}