{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxNDk2MzI3", "number": 332, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQyMzoyNTozOVrOFGcdeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQyMzo0NjoxN1rOFGc0Rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQyMzAyMDc0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/AnomalyDetectorPlugin.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQyMzoyNTozOVrOIHdodA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwMTowNDo1NFrOIHf-Hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY5NjQzNg==", "bodyText": "these metrics will be added later?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/332#discussion_r544696436", "createdAt": "2020-12-16T23:25:39Z", "author": {"login": "yizheliu-amazon"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/AnomalyDetectorPlugin.java", "diffHunk": "@@ -460,6 +460,12 @@ private static Void initGson() {\n                 new ADStat<>(true, new IndexStatusSupplier(indexUtils, DetectorInternalState.DETECTOR_STATE_INDEX))\n             )\n             .put(StatNames.DETECTOR_COUNT.getName(), new ADStat<>(true, new SettableSupplier()))\n+            .put(StatNames.JVM_HEAP_USAGE.getName(), new ADStat<>(false, new SettableSupplier()))\n+            .put(StatNames.HISTORICAL_DETECTOR_COUNT.getName(), new ADStat<>(true, new SettableSupplier()))\n+            .put(StatNames.AD_EXECUTING_BATCH_TASK_COUNT.getName(), new ADStat<>(false, new CounterSupplier()))\n+            .put(StatNames.AD_CANCELED_BATCH_TASK_COUNT.getName(), new ADStat<>(false, new CounterSupplier()))\n+            .put(StatNames.AD_TOTAL_BATCH_TASK_EXECUTION_COUNT.getName(), new ADStat<>(false, new CounterSupplier()))\n+            .put(StatNames.AD_BATCH_TASK_FAILURE_COUNT.getName(), new ADStat<>(false, new CounterSupplier()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "237530aca98c411bf1cbb77b5cf1341ff9643bc5"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDczNDc1MA==", "bodyText": "Yes, these metrics will be added in following PRs.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/332#discussion_r544734750", "createdAt": "2020-12-17T01:04:54Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/AnomalyDetectorPlugin.java", "diffHunk": "@@ -460,6 +460,12 @@ private static Void initGson() {\n                 new ADStat<>(true, new IndexStatusSupplier(indexUtils, DetectorInternalState.DETECTOR_STATE_INDEX))\n             )\n             .put(StatNames.DETECTOR_COUNT.getName(), new ADStat<>(true, new SettableSupplier()))\n+            .put(StatNames.JVM_HEAP_USAGE.getName(), new ADStat<>(false, new SettableSupplier()))\n+            .put(StatNames.HISTORICAL_DETECTOR_COUNT.getName(), new ADStat<>(true, new SettableSupplier()))\n+            .put(StatNames.AD_EXECUTING_BATCH_TASK_COUNT.getName(), new ADStat<>(false, new CounterSupplier()))\n+            .put(StatNames.AD_CANCELED_BATCH_TASK_COUNT.getName(), new ADStat<>(false, new CounterSupplier()))\n+            .put(StatNames.AD_TOTAL_BATCH_TASK_EXECUTION_COUNT.getName(), new ADStat<>(false, new CounterSupplier()))\n+            .put(StatNames.AD_BATCH_TASK_FAILURE_COUNT.getName(), new ADStat<>(false, new CounterSupplier()))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY5NjQzNg=="}, "originalCommit": {"oid": "237530aca98c411bf1cbb77b5cf1341ff9643bc5"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQyMzAyNTE1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/ADStatsNodesTransportAction.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQyMzoyNzoxNFrOIHdq3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwNDowNToyNVrOIHjvXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY5NzA1NA==", "bodyText": "is it current heap usage? if yes, what's the purpose to have this?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/332#discussion_r544697054", "createdAt": "2020-12-16T23:27:14Z", "author": {"login": "weicongs-amazon"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/ADStatsNodesTransportAction.java", "diffHunk": "@@ -99,6 +104,12 @@ private ADStatsNodeResponse createADStatsNodeResponse(ADStatsRequest adStatsRequ\n         Map<String, Object> statValues = new HashMap<>();\n         Set<String> statsToBeRetrieved = adStatsRequest.getStatsToBeRetrieved();\n \n+        if (statsToBeRetrieved.contains(StatNames.JVM_HEAP_USAGE.getName())) {\n+            long heapUsedPercent = jvmService.stats().getMem().getHeapUsedPercent();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "237530aca98c411bf1cbb77b5cf1341ff9643bc5"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDczNTgyNQ==", "bodyText": "We will use this to decide which node has lowest load. The task will be distributed to node which\n\nJVM heap usage not exceeds limitation(85%)\nExecuting AD task count is minimum and if there are multiple nodes has the same minimum task count, will choose one which has lower JVM heap usage.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/332#discussion_r544735825", "createdAt": "2020-12-17T01:07:50Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/ADStatsNodesTransportAction.java", "diffHunk": "@@ -99,6 +104,12 @@ private ADStatsNodeResponse createADStatsNodeResponse(ADStatsRequest adStatsRequ\n         Map<String, Object> statValues = new HashMap<>();\n         Set<String> statsToBeRetrieved = adStatsRequest.getStatsToBeRetrieved();\n \n+        if (statsToBeRetrieved.contains(StatNames.JVM_HEAP_USAGE.getName())) {\n+            long heapUsedPercent = jvmService.stats().getMem().getHeapUsedPercent();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY5NzA1NA=="}, "originalCommit": {"oid": "237530aca98c411bf1cbb77b5cf1341ff9643bc5"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc2Mjc3MQ==", "bodyText": "but this is for stats requests, right? not sure how this JVM heap info is used after client receives it.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/332#discussion_r544762771", "createdAt": "2020-12-17T02:23:33Z", "author": {"login": "weicongs-amazon"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/ADStatsNodesTransportAction.java", "diffHunk": "@@ -99,6 +104,12 @@ private ADStatsNodeResponse createADStatsNodeResponse(ADStatsRequest adStatsRequ\n         Map<String, Object> statValues = new HashMap<>();\n         Set<String> statsToBeRetrieved = adStatsRequest.getStatsToBeRetrieved();\n \n+        if (statsToBeRetrieved.contains(StatNames.JVM_HEAP_USAGE.getName())) {\n+            long heapUsedPercent = jvmService.stats().getMem().getHeapUsedPercent();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY5NzA1NA=="}, "originalCommit": {"oid": "237530aca98c411bf1cbb77b5cf1341ff9643bc5"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc4MDIzMg==", "bodyText": "In next PR, the task manger will send AD stats transport action to get all data nodes' JVM heap info and executing task count to dispatch AD task.\nThe REST AD stats API is only for monitoring.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/332#discussion_r544780232", "createdAt": "2020-12-17T03:14:19Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/ADStatsNodesTransportAction.java", "diffHunk": "@@ -99,6 +104,12 @@ private ADStatsNodeResponse createADStatsNodeResponse(ADStatsRequest adStatsRequ\n         Map<String, Object> statValues = new HashMap<>();\n         Set<String> statsToBeRetrieved = adStatsRequest.getStatsToBeRetrieved();\n \n+        if (statsToBeRetrieved.contains(StatNames.JVM_HEAP_USAGE.getName())) {\n+            long heapUsedPercent = jvmService.stats().getMem().getHeapUsedPercent();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY5NzA1NA=="}, "originalCommit": {"oid": "237530aca98c411bf1cbb77b5cf1341ff9643bc5"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc5NjUxMQ==", "bodyText": "I see, thanks. our task manager will use the same one. MINOR: it's better to remove the jvm heap info from rest api since it's kind of confusing.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/332#discussion_r544796511", "createdAt": "2020-12-17T04:05:25Z", "author": {"login": "weicongs-amazon"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/ADStatsNodesTransportAction.java", "diffHunk": "@@ -99,6 +104,12 @@ private ADStatsNodeResponse createADStatsNodeResponse(ADStatsRequest adStatsRequ\n         Map<String, Object> statValues = new HashMap<>();\n         Set<String> statsToBeRetrieved = adStatsRequest.getStatsToBeRetrieved();\n \n+        if (statsToBeRetrieved.contains(StatNames.JVM_HEAP_USAGE.getName())) {\n+            long heapUsedPercent = jvmService.stats().getMem().getHeapUsedPercent();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY5NzA1NA=="}, "originalCommit": {"oid": "237530aca98c411bf1cbb77b5cf1341ff9643bc5"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQyMzAzMDgxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/StatsAnomalyDetectorResponse.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQyMzoyOToyMVrOIHduGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwMToxNDowNlrOIHgLDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY5Nzg4Mg==", "bodyText": "I see it's only for testing. Is protected method good enough?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/332#discussion_r544697882", "createdAt": "2020-12-16T23:29:21Z", "author": {"login": "weicongs-amazon"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/StatsAnomalyDetectorResponse.java", "diffHunk": "@@ -47,4 +47,8 @@ public XContentBuilder toXContent(XContentBuilder builder, Params params) throws\n         adStatsResponse.toXContent(builder, params);\n         return builder;\n     }\n+\n+    public ADStatsResponse getAdStatsResponse() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "237530aca98c411bf1cbb77b5cf1341ff9643bc5"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDczODA2MA==", "bodyText": "Yes, agree, will change to protected.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/332#discussion_r544738060", "createdAt": "2020-12-17T01:14:06Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/StatsAnomalyDetectorResponse.java", "diffHunk": "@@ -47,4 +47,8 @@ public XContentBuilder toXContent(XContentBuilder builder, Params params) throws\n         adStatsResponse.toXContent(builder, params);\n         return builder;\n     }\n+\n+    public ADStatsResponse getAdStatsResponse() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY5Nzg4Mg=="}, "originalCommit": {"oid": "237530aca98c411bf1cbb77b5cf1341ff9643bc5"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQyMzA2MzIyOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/StatsAnomalyDetectorTransportAction.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQyMzo0MDoyN1rOIHd_ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwMToxMzoxMVrOIHgJvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcwMjQwMw==", "bodyText": "why is prefix used here?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/332#discussion_r544702403", "createdAt": "2020-12-16T23:40:27Z", "author": {"login": "weicongs-amazon"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/StatsAnomalyDetectorTransportAction.java", "diffHunk": "@@ -120,23 +127,34 @@ private void getClusterStats(\n         ADStatsRequest adStatsRequest\n     ) {\n         ADStatsResponse adStatsResponse = new ADStatsResponse();\n-        if (adStatsRequest.getStatsToBeRetrieved().contains(StatNames.DETECTOR_COUNT.getName())) {\n-            if (clusterService.state().getRoutingTable().hasIndex(AnomalyDetector.ANOMALY_DETECTORS_INDEX)) {\n-                final SearchRequest request = client\n-                    .prepareSearch(AnomalyDetector.ANOMALY_DETECTORS_INDEX)\n-                    .setSize(0)\n-                    .setTrackTotalHits(true)\n-                    .request();\n-                client.search(request, ActionListener.wrap(indicesStatsResponse -> {\n-                    adStats.getStat(StatNames.DETECTOR_COUNT.getName()).setValue(indicesStatsResponse.getHits().getTotalHits().value);\n-                    adStatsResponse.setClusterStats(getClusterStatsMap(adStatsRequest));\n-                    listener.onResponse(adStatsResponse);\n-                }, e -> listener.onFailure(new RuntimeException(\"Failed to get AD cluster stats\", e))));\n-            } else {\n-                adStats.getStat(StatNames.DETECTOR_COUNT.getName()).setValue(0L);\n+        if ((adStatsRequest.getStatsToBeRetrieved().contains(StatNames.DETECTOR_COUNT.getName())\n+            || adStatsRequest.getStatsToBeRetrieved().contains(StatNames.HISTORICAL_DETECTOR_COUNT.getName()))\n+            && clusterService.state().getRoutingTable().hasIndex(AnomalyDetector.ANOMALY_DETECTORS_INDEX)) {\n+\n+            TermsAggregationBuilder termsAgg = AggregationBuilders.terms(DETECTOR_TYPE_AGG).field(AnomalyDetector.DETECTOR_TYPE_FIELD);\n+            SearchRequest request = new SearchRequest()\n+                .indices(AnomalyDetector.ANOMALY_DETECTORS_INDEX)\n+                .source(new SearchSourceBuilder().aggregation(termsAgg).size(0).trackTotalHits(true));\n+\n+            client.search(request, ActionListener.wrap(r -> {\n+                StringTerms aggregation = r.getAggregations().get(DETECTOR_TYPE_AGG);\n+                List<StringTerms.Bucket> buckets = aggregation.getBuckets();\n+                long totalDetectors = r.getHits().getTotalHits().value;\n+                long totalHistoricalDetectors = 0;\n+                for (StringTerms.Bucket b : buckets) {\n+                    if (b.getKeyAsString().contains(HISTORICAL_DETECTOR_TYPE_PREFIX)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "237530aca98c411bf1cbb77b5cf1341ff9643bc5"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDczNjE4OA==", "bodyText": "We may have historical single and multiple entity detector, both will be counted as historical detector.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/332#discussion_r544736188", "createdAt": "2020-12-17T01:08:58Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/StatsAnomalyDetectorTransportAction.java", "diffHunk": "@@ -120,23 +127,34 @@ private void getClusterStats(\n         ADStatsRequest adStatsRequest\n     ) {\n         ADStatsResponse adStatsResponse = new ADStatsResponse();\n-        if (adStatsRequest.getStatsToBeRetrieved().contains(StatNames.DETECTOR_COUNT.getName())) {\n-            if (clusterService.state().getRoutingTable().hasIndex(AnomalyDetector.ANOMALY_DETECTORS_INDEX)) {\n-                final SearchRequest request = client\n-                    .prepareSearch(AnomalyDetector.ANOMALY_DETECTORS_INDEX)\n-                    .setSize(0)\n-                    .setTrackTotalHits(true)\n-                    .request();\n-                client.search(request, ActionListener.wrap(indicesStatsResponse -> {\n-                    adStats.getStat(StatNames.DETECTOR_COUNT.getName()).setValue(indicesStatsResponse.getHits().getTotalHits().value);\n-                    adStatsResponse.setClusterStats(getClusterStatsMap(adStatsRequest));\n-                    listener.onResponse(adStatsResponse);\n-                }, e -> listener.onFailure(new RuntimeException(\"Failed to get AD cluster stats\", e))));\n-            } else {\n-                adStats.getStat(StatNames.DETECTOR_COUNT.getName()).setValue(0L);\n+        if ((adStatsRequest.getStatsToBeRetrieved().contains(StatNames.DETECTOR_COUNT.getName())\n+            || adStatsRequest.getStatsToBeRetrieved().contains(StatNames.HISTORICAL_DETECTOR_COUNT.getName()))\n+            && clusterService.state().getRoutingTable().hasIndex(AnomalyDetector.ANOMALY_DETECTORS_INDEX)) {\n+\n+            TermsAggregationBuilder termsAgg = AggregationBuilders.terms(DETECTOR_TYPE_AGG).field(AnomalyDetector.DETECTOR_TYPE_FIELD);\n+            SearchRequest request = new SearchRequest()\n+                .indices(AnomalyDetector.ANOMALY_DETECTORS_INDEX)\n+                .source(new SearchSourceBuilder().aggregation(termsAgg).size(0).trackTotalHits(true));\n+\n+            client.search(request, ActionListener.wrap(r -> {\n+                StringTerms aggregation = r.getAggregations().get(DETECTOR_TYPE_AGG);\n+                List<StringTerms.Bucket> buckets = aggregation.getBuckets();\n+                long totalDetectors = r.getHits().getTotalHits().value;\n+                long totalHistoricalDetectors = 0;\n+                for (StringTerms.Bucket b : buckets) {\n+                    if (b.getKeyAsString().contains(HISTORICAL_DETECTOR_TYPE_PREFIX)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcwMjQwMw=="}, "originalCommit": {"oid": "237530aca98c411bf1cbb77b5cf1341ff9643bc5"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDczNzcyNQ==", "bodyText": "I will change this to historical single entity detector, so we can track historical single/multi-entity detector separately.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/332#discussion_r544737725", "createdAt": "2020-12-17T01:13:11Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/StatsAnomalyDetectorTransportAction.java", "diffHunk": "@@ -120,23 +127,34 @@ private void getClusterStats(\n         ADStatsRequest adStatsRequest\n     ) {\n         ADStatsResponse adStatsResponse = new ADStatsResponse();\n-        if (adStatsRequest.getStatsToBeRetrieved().contains(StatNames.DETECTOR_COUNT.getName())) {\n-            if (clusterService.state().getRoutingTable().hasIndex(AnomalyDetector.ANOMALY_DETECTORS_INDEX)) {\n-                final SearchRequest request = client\n-                    .prepareSearch(AnomalyDetector.ANOMALY_DETECTORS_INDEX)\n-                    .setSize(0)\n-                    .setTrackTotalHits(true)\n-                    .request();\n-                client.search(request, ActionListener.wrap(indicesStatsResponse -> {\n-                    adStats.getStat(StatNames.DETECTOR_COUNT.getName()).setValue(indicesStatsResponse.getHits().getTotalHits().value);\n-                    adStatsResponse.setClusterStats(getClusterStatsMap(adStatsRequest));\n-                    listener.onResponse(adStatsResponse);\n-                }, e -> listener.onFailure(new RuntimeException(\"Failed to get AD cluster stats\", e))));\n-            } else {\n-                adStats.getStat(StatNames.DETECTOR_COUNT.getName()).setValue(0L);\n+        if ((adStatsRequest.getStatsToBeRetrieved().contains(StatNames.DETECTOR_COUNT.getName())\n+            || adStatsRequest.getStatsToBeRetrieved().contains(StatNames.HISTORICAL_DETECTOR_COUNT.getName()))\n+            && clusterService.state().getRoutingTable().hasIndex(AnomalyDetector.ANOMALY_DETECTORS_INDEX)) {\n+\n+            TermsAggregationBuilder termsAgg = AggregationBuilders.terms(DETECTOR_TYPE_AGG).field(AnomalyDetector.DETECTOR_TYPE_FIELD);\n+            SearchRequest request = new SearchRequest()\n+                .indices(AnomalyDetector.ANOMALY_DETECTORS_INDEX)\n+                .source(new SearchSourceBuilder().aggregation(termsAgg).size(0).trackTotalHits(true));\n+\n+            client.search(request, ActionListener.wrap(r -> {\n+                StringTerms aggregation = r.getAggregations().get(DETECTOR_TYPE_AGG);\n+                List<StringTerms.Bucket> buckets = aggregation.getBuckets();\n+                long totalDetectors = r.getHits().getTotalHits().value;\n+                long totalHistoricalDetectors = 0;\n+                for (StringTerms.Bucket b : buckets) {\n+                    if (b.getKeyAsString().contains(HISTORICAL_DETECTOR_TYPE_PREFIX)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcwMjQwMw=="}, "originalCommit": {"oid": "237530aca98c411bf1cbb77b5cf1341ff9643bc5"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQyMzA3MjY1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/stats/StatNames.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQyMzo0Mzo0NVrOIHeE8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwMTowNDoxNlrOIHf82g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcwMzcyOQ==", "bodyText": "do we need realtime detector count?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/332#discussion_r544703729", "createdAt": "2020-12-16T23:43:45Z", "author": {"login": "weicongs-amazon"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/stats/StatNames.java", "diffHunk": "@@ -32,7 +32,13 @@\n     MODELS_CHECKPOINT_INDEX_STATUS(\"models_checkpoint_index_status\"),\n     ANOMALY_DETECTION_JOB_INDEX_STATUS(\"anomaly_detection_job_index_status\"),\n     ANOMALY_DETECTION_STATE_STATUS(\"anomaly_detection_state_status\"),\n-    MODEL_INFORMATION(\"models\");\n+    MODEL_INFORMATION(\"models\"),\n+    JVM_HEAP_USAGE(\"jvm_heap_usage\"),\n+    HISTORICAL_DETECTOR_COUNT(\"historical_detector_count\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "237530aca98c411bf1cbb77b5cf1341ff9643bc5"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDczNDQyNg==", "bodyText": "This is for monitor usage, we can use this this to build some monitor/dashboard based on this. Currently our metrics shows only total detector count. Will add realtime detector count as well. But the old realtime detectors have no detector type filed, so we need to backfill these old detectors first if we want to get metrics for realtime single/multi-entity detector separately. Prefer to do that in another PR. Created an issue to track this: #333", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/332#discussion_r544734426", "createdAt": "2020-12-17T01:04:16Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/stats/StatNames.java", "diffHunk": "@@ -32,7 +32,13 @@\n     MODELS_CHECKPOINT_INDEX_STATUS(\"models_checkpoint_index_status\"),\n     ANOMALY_DETECTION_JOB_INDEX_STATUS(\"anomaly_detection_job_index_status\"),\n     ANOMALY_DETECTION_STATE_STATUS(\"anomaly_detection_state_status\"),\n-    MODEL_INFORMATION(\"models\");\n+    MODEL_INFORMATION(\"models\"),\n+    JVM_HEAP_USAGE(\"jvm_heap_usage\"),\n+    HISTORICAL_DETECTOR_COUNT(\"historical_detector_count\"),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcwMzcyOQ=="}, "originalCommit": {"oid": "237530aca98c411bf1cbb77b5cf1341ff9643bc5"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQyMzA3OTExOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/amazon/opendistroforelasticsearch/ad/transport/StatsAnomalyDetectorTransportActionTests.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQyMzo0NjoxN1rOIHeIfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwMToxMDozMlrOIHgF3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcwNDYzOA==", "bodyText": "btw, how to run this test case? Is it included in the \"build\" command?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/332#discussion_r544704638", "createdAt": "2020-12-16T23:46:17Z", "author": {"login": "weicongs-amazon"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/ad/transport/StatsAnomalyDetectorTransportActionTests.java", "diffHunk": "@@ -0,0 +1,150 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.transport;\n+\n+import static com.amazon.opendistroforelasticsearch.ad.util.RestHandlerUtils.XCONTENT_WITH_TYPE;\n+\n+import java.io.IOException;\n+import java.time.Instant;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.Map;\n+\n+import org.elasticsearch.action.admin.indices.create.CreateIndexResponse;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.action.index.IndexResponse;\n+import org.elasticsearch.action.support.WriteRequest;\n+import org.elasticsearch.common.xcontent.XContentFactory;\n+import org.elasticsearch.plugins.Plugin;\n+import org.elasticsearch.rest.RestStatus;\n+import org.elasticsearch.test.ESIntegTestCase;\n+import org.junit.Before;\n+\n+import com.amazon.opendistroforelasticsearch.ad.AnomalyDetectorPlugin;\n+import com.amazon.opendistroforelasticsearch.ad.TestHelpers;\n+import com.amazon.opendistroforelasticsearch.ad.indices.AnomalyDetectionIndices;\n+import com.amazon.opendistroforelasticsearch.ad.model.AnomalyDetector;\n+import com.amazon.opendistroforelasticsearch.ad.model.AnomalyDetectorType;\n+import com.amazon.opendistroforelasticsearch.ad.stats.StatNames;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+\n+public class StatsAnomalyDetectorTransportActionTests extends ESIntegTestCase {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "237530aca98c411bf1cbb77b5cf1341ff9643bc5"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDczNjczNQ==", "bodyText": "Yes, ./gradlew build will run this.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/332#discussion_r544736735", "createdAt": "2020-12-17T01:10:32Z", "author": {"login": "ylwu-amzn"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/ad/transport/StatsAnomalyDetectorTransportActionTests.java", "diffHunk": "@@ -0,0 +1,150 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.transport;\n+\n+import static com.amazon.opendistroforelasticsearch.ad.util.RestHandlerUtils.XCONTENT_WITH_TYPE;\n+\n+import java.io.IOException;\n+import java.time.Instant;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.Map;\n+\n+import org.elasticsearch.action.admin.indices.create.CreateIndexResponse;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.action.index.IndexResponse;\n+import org.elasticsearch.action.support.WriteRequest;\n+import org.elasticsearch.common.xcontent.XContentFactory;\n+import org.elasticsearch.plugins.Plugin;\n+import org.elasticsearch.rest.RestStatus;\n+import org.elasticsearch.test.ESIntegTestCase;\n+import org.junit.Before;\n+\n+import com.amazon.opendistroforelasticsearch.ad.AnomalyDetectorPlugin;\n+import com.amazon.opendistroforelasticsearch.ad.TestHelpers;\n+import com.amazon.opendistroforelasticsearch.ad.indices.AnomalyDetectionIndices;\n+import com.amazon.opendistroforelasticsearch.ad.model.AnomalyDetector;\n+import com.amazon.opendistroforelasticsearch.ad.model.AnomalyDetectorType;\n+import com.amazon.opendistroforelasticsearch.ad.stats.StatNames;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+\n+public class StatsAnomalyDetectorTransportActionTests extends ESIntegTestCase {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcwNDYzOA=="}, "originalCommit": {"oid": "237530aca98c411bf1cbb77b5cf1341ff9643bc5"}, "originalPosition": 45}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2835, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}