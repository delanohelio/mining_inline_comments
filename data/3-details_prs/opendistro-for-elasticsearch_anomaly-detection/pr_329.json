{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM3NDU2MTEy", "number": 329, "title": "add AD task and tune detector&AD result data model", "bodyText": "Issue #, if available:\nDescription of changes:\nCurrently we only have realtime detector which can take streaming data and detect anomaly in realtime way. For historical detector, user can feed historical data and detect historical anomalies. When user start historical detector, we will start an AD task at backend and run it asynchronously. This PR is to add AD task and tune detector and AD result to support historical detector.\n\n\nAD Task\nWhen user start a historical detector, we will create a new AD task. We will record task state, progress and detector snapshot in task.\n\n\nDetector changes\n\nAdd detection date range: user can specify the historical date range to run anomaly detection\nAdd detector type: this is to make the search and aggregation easier. When create detector, user doesn't need to fill this field, we will check detection_date_range and catetory_field to decide detector type automatically.\n\n\n\nAD result changes\n\nAdd task id: user can run historical detector multiple times, and for each run we will create a new AD task. We store task id in AD result, so user can query the latest AD task result with task id.\n\n\n\nTest\n1../gradlew build\n2../gradlew integTest -PnumNodes=3\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-12-11T21:56:27Z", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/329", "merged": true, "mergeCommit": {"oid": "9c3b972e7252ec95d9ee9997019386b4bf4e78e7"}, "closed": true, "closedAt": "2020-12-16T01:26:19Z", "author": {"login": "ylwu-amzn"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdlPDSaAH2gAyNTM3NDU2MTEyOjQ3MWE3NjdiZDg0MWVjYzNjZjcwYzRiOTU4YmY3NTdlZDdhNmU2YzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmkjaOgFqTU1MzI0NTY5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "471a767bd841ecc3cf70c4b958bf757ed7a6e6c4", "author": {"user": {"login": "ylwu-amzn", "name": "Yaliang"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/471a767bd841ecc3cf70c4b958bf757ed7a6e6c4", "committedDate": "2020-12-11T21:44:36Z", "message": "add AD task and tune detector&AD result data model"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3fbc478dc58dae220d5cf0dfad3137ce3eb20f8", "author": {"user": {"login": "ylwu-amzn", "name": "Yaliang"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/a3fbc478dc58dae220d5cf0dfad3137ce3eb20f8", "committedDate": "2020-12-11T22:37:41Z", "message": "remove lines which commented out"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cfb00798bd06ba72195bc98285c85c6f47da1f9", "author": {"user": {"login": "ylwu-amzn", "name": "Yaliang"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/0cfb00798bd06ba72195bc98285c85c6f47da1f9", "committedDate": "2020-12-11T22:58:40Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50ec0c88d681134e61e0e5581c41cfdcab59e278", "author": {"user": {"login": "ylwu-amzn", "name": "Yaliang"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/50ec0c88d681134e61e0e5581c41cfdcab59e278", "committedDate": "2020-12-14T22:03:39Z", "message": "fix null point bug in AD result; add more test cases"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxOTY1NDA5", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/329#pullrequestreview-551965409", "createdAt": "2020-12-14T23:00:22Z", "commit": {"oid": "50ec0c88d681134e61e0e5581c41cfdcab59e278"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQyMzowMDoyMlrOIFwV7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQyMzowMDoyMlrOIFwV7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkwNTgzNg==", "bodyText": "why implement static method, instead of just using public method like this.isRealTimeDetector()?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/329#discussion_r542905836", "createdAt": "2020-12-14T23:00:22Z", "author": {"login": "yizheliu-amazon"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/AnomalyDetector.java", "diffHunk": "@@ -596,7 +658,27 @@ public void setUser(User user) {\n         this.user = user;\n     }\n \n+    public String getDetectorType() {\n+        return detectorType;\n+    }\n+\n+    public DetectionDateRange getDetectionDateRange() {\n+        return detectionDateRange;\n+    }\n+\n     public boolean isMultientityDetector() {\n-        return getCategoryField() != null && getCategoryField().size() > 0;\n+        return AnomalyDetector.isMultientityDetector(getCategoryField());\n+    }\n+\n+    private static boolean isMultientityDetector(List<String> categoryFields) {\n+        return categoryFields != null && categoryFields.size() > 0;\n+    }\n+\n+    public boolean isRealTimeDetector() {\n+        return AnomalyDetector.isRealTimeDetector(getDetectionDateRange());\n+    }\n+\n+    private static boolean isRealTimeDetector(DetectionDateRange detectionDateRange) {\n+        return detectionDateRange == null || detectionDateRange.getEndTime() == null;\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50ec0c88d681134e61e0e5581c41cfdcab59e278"}, "originalPosition": 262}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxOTY2NjUx", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/329#pullrequestreview-551966651", "createdAt": "2020-12-14T23:02:51Z", "commit": {"oid": "50ec0c88d681134e61e0e5581c41cfdcab59e278"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a0db4ebaaa9364124e6adb7c0e57c6fc3623d0c", "author": {"user": {"login": "ylwu-amzn", "name": "Yaliang"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/8a0db4ebaaa9364124e6adb7c0e57c6fc3623d0c", "committedDate": "2020-12-15T08:15:47Z", "message": "add more checking"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNTg1Njk0", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/329#pullrequestreview-552585694", "createdAt": "2020-12-15T15:35:26Z", "commit": {"oid": "8a0db4ebaaa9364124e6adb7c0e57c6fc3623d0c"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNTozNToyNlrOIGRmAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNTo0Nzo0OFrOIGSOBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ1MDYyNw==", "bodyText": "what's different between created and init?  Is INIT for the model training state?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/329#discussion_r543450627", "createdAt": "2020-12-15T15:35:26Z", "author": {"login": "weicongs-amazon"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/ADTaskState.java", "diffHunk": "@@ -0,0 +1,25 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.model;\n+\n+public enum ADTaskState {\n+    CREATED,\n+    INIT,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a0db4ebaaa9364124e6adb7c0e57c6fc3623d0c"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ1Nzc4NQ==", "bodyText": "typo: SINGLE?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/329#discussion_r543457785", "createdAt": "2020-12-15T15:44:04Z", "author": {"login": "weicongs-amazon"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/AnomalyDetectorType.java", "diffHunk": "@@ -0,0 +1,23 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.model;\n+\n+public enum AnomalyDetectorType {\n+    REALTIME_SIGLE_ENTITY,\n+    REALTIME_MULTI_ENTITY,\n+    HISTORICAL_SIGLE_ENTITY,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a0db4ebaaa9364124e6adb7c0e57c6fc3623d0c"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ2MDg2OA==", "bodyText": "what's the reason that there is a null check in the first method, not in the second one?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/329#discussion_r543460868", "createdAt": "2020-12-15T15:47:48Z", "author": {"login": "weicongs-amazon"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/DetectionDateRange.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.model;\n+\n+import static org.elasticsearch.common.xcontent.XContentParserUtils.ensureExpectedToken;\n+\n+import java.io.IOException;\n+import java.time.Instant;\n+\n+import org.apache.commons.lang.builder.ToStringBuilder;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.io.stream.Writeable;\n+import org.elasticsearch.common.xcontent.ToXContentObject;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+\n+import com.amazon.opendistroforelasticsearch.ad.annotation.Generated;\n+import com.amazon.opendistroforelasticsearch.ad.util.ParseUtils;\n+import com.google.common.base.Objects;\n+\n+public class DetectionDateRange implements ToXContentObject, Writeable {\n+\n+    public static final String START_TIME_FIELD = \"start_time\";\n+    public static final String END_TIME_FIELD = \"end_time\";\n+\n+    private final Instant startTime;\n+    private final Instant endTime;\n+\n+    public DetectionDateRange(Instant startTime, Instant endTime) {\n+        this.startTime = startTime;\n+        this.endTime = endTime;\n+        if (startTime == null) {\n+            throw new IllegalArgumentException(\"Detection data range's start time must not be null\");\n+        }\n+        if (endTime == null) {\n+            throw new IllegalArgumentException(\"Detection data range's end time must not be null\");\n+        }\n+    }\n+\n+    public DetectionDateRange(StreamInput in) throws IOException {\n+        this.startTime = in.readOptionalInstant();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a0db4ebaaa9364124e6adb7c0e57c6fc3623d0c"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "813c50920410b3dd0b66c873b4b8f3e3d255a1b9", "author": {"user": {"login": "ylwu-amzn", "name": "Yaliang"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/813c50920410b3dd0b66c873b4b8f3e3d255a1b9", "committedDate": "2020-12-15T18:40:42Z", "message": "fix typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cd58aa6252aeeba0b879c69288f6be6de759fc3", "author": {"user": {"login": "ylwu-amzn", "name": "Yaliang"}}, "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/2cd58aa6252aeeba0b879c69288f6be6de759fc3", "committedDate": "2020-12-16T01:14:36Z", "message": "add java doc for task state"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzMjQ1MzE4", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/329#pullrequestreview-553245318", "createdAt": "2020-12-16T01:21:22Z", "commit": {"oid": "2cd58aa6252aeeba0b879c69288f6be6de759fc3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwMToyMToyM1rOIGnVfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwMToyMToyM1rOIGnVfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzgwNjg0Nw==", "bodyText": "minor: endTime can't be  null, right?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/329#discussion_r543806847", "createdAt": "2020-12-16T01:21:23Z", "author": {"login": "weicongs-amazon"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/AnomalyDetector.java", "diffHunk": "@@ -596,7 +661,27 @@ public void setUser(User user) {\n         this.user = user;\n     }\n \n+    public String getDetectorType() {\n+        return detectorType;\n+    }\n+\n+    public DetectionDateRange getDetectionDateRange() {\n+        return detectionDateRange;\n+    }\n+\n     public boolean isMultientityDetector() {\n-        return getCategoryField() != null && getCategoryField().size() > 0;\n+        return AnomalyDetector.isMultientityDetector(getCategoryField());\n+    }\n+\n+    private static boolean isMultientityDetector(List<String> categoryFields) {\n+        return categoryFields != null && categoryFields.size() > 0;\n+    }\n+\n+    public boolean isRealTimeDetector() {\n+        return AnomalyDetector.isRealTimeDetector(getDetectionDateRange());\n+    }\n+\n+    private static boolean isRealTimeDetector(DetectionDateRange detectionDateRange) {\n+        return detectionDateRange == null || detectionDateRange.getEndTime() == null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cd58aa6252aeeba0b879c69288f6be6de759fc3"}, "originalPosition": 271}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzMjQ1Njkz", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/329#pullrequestreview-553245693", "createdAt": "2020-12-16T01:21:37Z", "commit": {"oid": "2cd58aa6252aeeba0b879c69288f6be6de759fc3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1440, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}