{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ2MzE3MDg5", "number": 344, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQyMTowMTozOFrOFJ3b9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQyMTowMTozOFrOFJ3b9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ1ODg5NzgyOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/AnomalyResultTransportAction.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQyMTowMTozOFrOIMX58g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQyMjozNTo1M1rOIMZv9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg0NTQ5MA==", "bodyText": "Can we directly break out of the loop after this?", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/344#discussion_r549845490", "createdAt": "2020-12-29T21:01:38Z", "author": {"login": "kaituo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/AnomalyResultTransportAction.java", "diffHunk": "@@ -477,17 +483,52 @@ private CombinedRcfResult getCombinedResult(List<RCFResultResponse> rcfResults)\n         return modelManager.combineRcfResults(rcfResultLib);\n     }\n \n+    private void handleFailure(Exception exception, ActionListener<AnomalyResultResponse> listener, String adID) {\n+        if (exception instanceof IndexNotFoundException) {\n+            listener.onFailure(new EndRunException(adID, TROUBLE_QUERYING_ERR_MSG + exception.getMessage(), true).countedInStats(false));\n+        } else if (exception instanceof EndRunException) {\n+            // invalid feature query\n+            listener.onFailure(exception);\n+        } else {\n+            handleExecuteException(exception, listener, adID);\n+        }\n+    }\n+\n     void handleExecuteException(Exception ex, ActionListener<AnomalyResultResponse> listener, String adID) {\n         if (ex instanceof ClientException) {\n             listener.onFailure(ex);\n         } else if (ex instanceof AnomalyDetectionException) {\n             listener.onFailure(new InternalFailure((AnomalyDetectionException) ex));\n+        } else if (ex instanceof SearchPhaseExecutionException && invalidQuery((SearchPhaseExecutionException) ex)) {\n+            // This is to catch invalid aggregation on wrong field type. For example,\n+            // sum aggregation on text field. We should end detector run for such case.\n+            listener\n+                .onFailure(\n+                    new EndRunException(\n+                        adID,\n+                        INVALID_SEARCH_QUERY_MSG + ((SearchPhaseExecutionException) ex).getDetailedMessage(),\n+                        ex,\n+                        true\n+                    ).countedInStats(false)\n+                );\n         } else {\n             Throwable cause = ExceptionsHelper.unwrapCause(ex);\n             listener.onFailure(new InternalFailure(adID, cause));\n         }\n     }\n \n+    private boolean invalidQuery(SearchPhaseExecutionException ex) {\n+        boolean invalidQuery = true;\n+        // If all shards return bad request and failure cause is IllegalArgumentException, we\n+        // consider the feature query is invalid and will not count the error in failure stats.\n+        for (ShardSearchFailure failure : ex.shardFailures()) {\n+            if (RestStatus.BAD_REQUEST != failure.status() || !(failure.getCause() instanceof IllegalArgumentException)) {\n+                invalidQuery = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a24dd866335eaf6fdedbb41bf57de46f8641ce4"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg2MDM2OQ==", "bodyText": "Sure, will fix in a separate PR to make this backport PR clean", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/344#discussion_r549860369", "createdAt": "2020-12-29T21:45:19Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/AnomalyResultTransportAction.java", "diffHunk": "@@ -477,17 +483,52 @@ private CombinedRcfResult getCombinedResult(List<RCFResultResponse> rcfResults)\n         return modelManager.combineRcfResults(rcfResultLib);\n     }\n \n+    private void handleFailure(Exception exception, ActionListener<AnomalyResultResponse> listener, String adID) {\n+        if (exception instanceof IndexNotFoundException) {\n+            listener.onFailure(new EndRunException(adID, TROUBLE_QUERYING_ERR_MSG + exception.getMessage(), true).countedInStats(false));\n+        } else if (exception instanceof EndRunException) {\n+            // invalid feature query\n+            listener.onFailure(exception);\n+        } else {\n+            handleExecuteException(exception, listener, adID);\n+        }\n+    }\n+\n     void handleExecuteException(Exception ex, ActionListener<AnomalyResultResponse> listener, String adID) {\n         if (ex instanceof ClientException) {\n             listener.onFailure(ex);\n         } else if (ex instanceof AnomalyDetectionException) {\n             listener.onFailure(new InternalFailure((AnomalyDetectionException) ex));\n+        } else if (ex instanceof SearchPhaseExecutionException && invalidQuery((SearchPhaseExecutionException) ex)) {\n+            // This is to catch invalid aggregation on wrong field type. For example,\n+            // sum aggregation on text field. We should end detector run for such case.\n+            listener\n+                .onFailure(\n+                    new EndRunException(\n+                        adID,\n+                        INVALID_SEARCH_QUERY_MSG + ((SearchPhaseExecutionException) ex).getDetailedMessage(),\n+                        ex,\n+                        true\n+                    ).countedInStats(false)\n+                );\n         } else {\n             Throwable cause = ExceptionsHelper.unwrapCause(ex);\n             listener.onFailure(new InternalFailure(adID, cause));\n         }\n     }\n \n+    private boolean invalidQuery(SearchPhaseExecutionException ex) {\n+        boolean invalidQuery = true;\n+        // If all shards return bad request and failure cause is IllegalArgumentException, we\n+        // consider the feature query is invalid and will not count the error in failure stats.\n+        for (ShardSearchFailure failure : ex.shardFailures()) {\n+            if (RestStatus.BAD_REQUEST != failure.status() || !(failure.getCause() instanceof IllegalArgumentException)) {\n+                invalidQuery = false;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg0NTQ5MA=="}, "originalCommit": {"oid": "0a24dd866335eaf6fdedbb41bf57de46f8641ce4"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg3NTcwMQ==", "bodyText": "Fixed in this PR #348, will backport once PR approved.", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/344#discussion_r549875701", "createdAt": "2020-12-29T22:35:53Z", "author": {"login": "ylwu-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/AnomalyResultTransportAction.java", "diffHunk": "@@ -477,17 +483,52 @@ private CombinedRcfResult getCombinedResult(List<RCFResultResponse> rcfResults)\n         return modelManager.combineRcfResults(rcfResultLib);\n     }\n \n+    private void handleFailure(Exception exception, ActionListener<AnomalyResultResponse> listener, String adID) {\n+        if (exception instanceof IndexNotFoundException) {\n+            listener.onFailure(new EndRunException(adID, TROUBLE_QUERYING_ERR_MSG + exception.getMessage(), true).countedInStats(false));\n+        } else if (exception instanceof EndRunException) {\n+            // invalid feature query\n+            listener.onFailure(exception);\n+        } else {\n+            handleExecuteException(exception, listener, adID);\n+        }\n+    }\n+\n     void handleExecuteException(Exception ex, ActionListener<AnomalyResultResponse> listener, String adID) {\n         if (ex instanceof ClientException) {\n             listener.onFailure(ex);\n         } else if (ex instanceof AnomalyDetectionException) {\n             listener.onFailure(new InternalFailure((AnomalyDetectionException) ex));\n+        } else if (ex instanceof SearchPhaseExecutionException && invalidQuery((SearchPhaseExecutionException) ex)) {\n+            // This is to catch invalid aggregation on wrong field type. For example,\n+            // sum aggregation on text field. We should end detector run for such case.\n+            listener\n+                .onFailure(\n+                    new EndRunException(\n+                        adID,\n+                        INVALID_SEARCH_QUERY_MSG + ((SearchPhaseExecutionException) ex).getDetailedMessage(),\n+                        ex,\n+                        true\n+                    ).countedInStats(false)\n+                );\n         } else {\n             Throwable cause = ExceptionsHelper.unwrapCause(ex);\n             listener.onFailure(new InternalFailure(adID, cause));\n         }\n     }\n \n+    private boolean invalidQuery(SearchPhaseExecutionException ex) {\n+        boolean invalidQuery = true;\n+        // If all shards return bad request and failure cause is IllegalArgumentException, we\n+        // consider the feature query is invalid and will not count the error in failure stats.\n+        for (ShardSearchFailure failure : ex.shardFailures()) {\n+            if (RestStatus.BAD_REQUEST != failure.status() || !(failure.getCause() instanceof IllegalArgumentException)) {\n+                invalidQuery = false;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg0NTQ5MA=="}, "originalCommit": {"oid": "0a24dd866335eaf6fdedbb41bf57de46f8641ce4"}, "originalPosition": 127}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2851, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}