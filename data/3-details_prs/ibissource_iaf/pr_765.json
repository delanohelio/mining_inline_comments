{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzOTI4MzEx", "number": 765, "title": "Fix#525 support single pipeline soap and rest json/xml", "bodyText": "", "createdAt": "2020-05-27T15:21:57Z", "url": "https://github.com/ibissource/iaf/pull/765", "merged": true, "mergeCommit": {"oid": "0f62058273dfb78468a960b7fa7f4c888779acdd"}, "closed": true, "closedAt": "2020-05-29T13:02:06Z", "author": {"login": "gvanbrakel"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclWYc9AH2gAyNDIzOTI4MzExOjQyMTg3MmU4OGY0NzA0ZWMxZjcyYzRmZjg0ZDNiMmQyNDQyOWMzYjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcmCFofAFqTQyMDkyODUxNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "421872e88f4704ec1f72c4ff84d3b2d24429c3b9", "author": {"user": {"login": "gvanbrakel", "name": "Gerrit van Brakel"}}, "url": "https://github.com/ibissource/iaf/commit/421872e88f4704ec1f72c4ff84d3b2d24429c3b9", "committedDate": "2020-05-27T10:05:54Z", "message": "Fix #525 auto detect soap version and allow plain xml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86b88a64604c4d78083e9dcd43f8b6fec4928a76", "author": {"user": {"login": "gvanbrakel", "name": "Gerrit van Brakel"}}, "url": "https://github.com/ibissource/iaf/commit/86b88a64604c4d78083e9dcd43f8b6fec4928a76", "committedDate": "2020-05-27T15:21:14Z", "message": "fix #525 Automatic detection of soap version or plain xml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74c7167ed8ac87318dd35bf97f7dd5921b017c2a", "author": {"user": {"login": "gvanbrakel", "name": "Gerrit van Brakel"}}, "url": "https://github.com/ibissource/iaf/commit/74c7167ed8ac87318dd35bf97f7dd5921b017c2a", "committedDate": "2020-05-27T15:32:31Z", "message": "Fix Codacy issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b26c28e016835d22bee75ccb6abee8b75aab2453", "author": {"user": {"login": "gvanbrakel", "name": "Gerrit van Brakel"}}, "url": "https://github.com/ibissource/iaf/commit/b26c28e016835d22bee75ccb6abee8b75aab2453", "committedDate": "2020-05-28T06:41:04Z", "message": "Update RELEASES.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40c825184db9b4b5c476fbb4b9f80a3886f392aa", "author": {"user": {"login": "gvanbrakel", "name": "Gerrit van Brakel"}}, "url": "https://github.com/ibissource/iaf/commit/40c825184db9b4b5c476fbb4b9f80a3886f392aa", "committedDate": "2020-05-29T05:55:42Z", "message": "Use single validator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09db0d8fdc031d168c69d3d47e50d73544d6eade", "author": {"user": {"login": "gvanbrakel", "name": "Gerrit van Brakel"}}, "url": "https://github.com/ibissource/iaf/commit/09db0d8fdc031d168c69d3d47e50d73544d6eade", "committedDate": "2020-05-29T06:06:39Z", "message": "Cleanup config"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNzY0MjEw", "url": "https://github.com/ibissource/iaf/pull/765#pullrequestreview-420764210", "createdAt": "2020-05-29T08:45:14Z", "commit": {"oid": "09db0d8fdc031d168c69d3d47e50d73544d6eade"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwODo0NToxNFrOGcUHFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwOTowMTo1MlrOGcUrPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM0MjgwNg==", "bodyText": "Deze mag weg toch? Heb je hier boven anders uitgeschreven?", "url": "https://github.com/ibissource/iaf/pull/765#discussion_r432342806", "createdAt": "2020-05-29T08:45:14Z", "author": {"login": "nielsm5"}, "path": "core/src/main/java/nl/nn/adapterframework/soap/SoapWrapper.java", "diffHunk": "@@ -125,19 +126,37 @@ public void checkForSoapFault(String responseBody, Throwable nested) throws Send\n \t}\n \n \tpublic String getBody(String message) throws SAXException, TransformerException, IOException  {\n-\t\tString result = extractBody.transform(message,null,true);\n-\t\tif (StringUtils.isNotEmpty(result))\n-\t\t\treturn result;\n-\t\treturn extractBody2.transform(message,null,true);\n+\t\treturn getBody(message, false, null, null);\n \t}\n-\n-\tpublic String getBody(InputStream request) throws TransformerException, IOException {\n-\t\tString result = extractBody.transform(new StreamSource(request));\n-\t\tif (StringUtils.isNotEmpty(result))\n+\t\n+\tpublic String getBody(String message, boolean allowPlainXml, IPipeLineSession session, String soapNamespaceSessionKey) throws SAXException, TransformerException, IOException  {\n+\t\tString result = extractBodySoap11.transform(message,null,true);\n+\t\tif (StringUtils.isNotEmpty(result)) {\n+\t\t\tif (session!=null && StringUtils.isNotEmpty(soapNamespaceSessionKey)) {\n+\t\t\t\tsession.put(soapNamespaceSessionKey, SoapVersion.SOAP11.namespace);\n+\t\t\t}\n+\t\t\treturn result;\n+\t\t}\n+\t\tresult = extractBodySoap12.transform(message,null,true);\n+\t\tif (StringUtils.isNotEmpty(result)) {\n+\t\t\tif (session!=null && StringUtils.isNotEmpty(soapNamespaceSessionKey)) {\n+\t\t\t\tsession.put(soapNamespaceSessionKey, SoapVersion.SOAP12.namespace);\n+\t\t\t}\n \t\t\treturn result;\n-\t\treturn extractBody2.transform(new StreamSource(request));\n+\t\t}\n+\t\tif (session!=null && StringUtils.isNotEmpty(soapNamespaceSessionKey)) {\n+\t\t\tsession.put(soapNamespaceSessionKey, SoapVersion.NONE.namespace);\n+\t\t}\n+\t\treturn allowPlainXml ? message : \"\";\n \t}\n \n+//\tpublic String getBody(InputStream request) throws TransformerException, IOException {\n+//\t\tString result = extractBodySoap11.transform(new StreamSource(request));\n+//\t\tif (StringUtils.isNotEmpty(result))\n+//\t\t\treturn result;\n+//\t\treturn extractBodySoap12.transform(new StreamSource(request));\n+//\t}\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09db0d8fdc031d168c69d3d47e50d73544d6eade"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM0ODY0NQ==", "bodyText": "Ik vind het erg onduidelijk. Moest twee keer kijken wat er nou precies gebeurde. Er zijn dus twee namespaces voor de twee soap versies? Als er een inputvalidator is en hij is soap versie 2, alleen dan krijg je soap2? Zijn er ook andere manieren om deze wsdl klasse aan te roepen en is het handig die ook de mogelijkheid te geven soap1.2 te gebruiken?", "url": "https://github.com/ibissource/iaf/pull/765#discussion_r432348645", "createdAt": "2020-05-29T08:55:47Z", "author": {"login": "nielsm5"}, "path": "core/src/main/java/nl/nn/adapterframework/soap/Wsdl.java", "diffHunk": "@@ -305,10 +305,9 @@ public Wsdl(PipeLine pipeLine, String generationInfo) {\n         }\n         this.fileName = fileName;\n         this.targetNamespace = WsdlUtils.validUri(tns);\n-        if (inputValidator instanceof SoapValidator\n-                && \"1.2\".equals(((SoapValidator)inputValidator).getSoapVersion())) {\n-            soapNamespace = SOAP12_NAMESPACE;\n-            soapPrefix = SOAP12_NAMESPACE_PREFIX;\n+        if (inputValidator instanceof SoapValidator && ((SoapValidator)inputValidator).getSoapVersionEnum()==SoapVersion.SOAP12) {\n+            wsdlSoapNamespace = WSDL_SOAP12_NAMESPACE;\n+            wsdlSoapPrefix = WSDL_SOAP12_NAMESPACE_PREFIX;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09db0d8fdc031d168c69d3d47e50d73544d6eade"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM1MDY1OQ==", "bodyText": "Misschien kunnen deze namespaces ook aan de SoapVersion enum toegevoegd worden?", "url": "https://github.com/ibissource/iaf/pull/765#discussion_r432350659", "createdAt": "2020-05-29T08:59:25Z", "author": {"login": "nielsm5"}, "path": "core/src/main/java/nl/nn/adapterframework/soap/Wsdl.java", "diffHunk": "@@ -122,8 +122,8 @@\n \n     private final String targetNamespace;\n     private String targetNamespacePrefix = TARGET_NAMESPACE_PREFIX;\n-    private String soapNamespace = SOAP_NAMESPACE;\n-    private String soapPrefix = SOAP_NAMESPACE_PREFIX;\n+    private String wsdlSoapNamespace = WSDL_SOAP_NAMESPACE;\n+    private String wsdlSoapPrefix = WSDL_SOAP_NAMESPACE_PREFIX;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09db0d8fdc031d168c69d3d47e50d73544d6eade"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM1MjA2Mw==", "bodyText": "Misschien handig SOAPConstants.URI_NS_SOAP_1_2_ENVELOPE te gebruiken?", "url": "https://github.com/ibissource/iaf/pull/765#discussion_r432352063", "createdAt": "2020-05-29T09:01:52Z", "author": {"login": "nielsm5"}, "path": "core/src/main/java/nl/nn/adapterframework/soap/SoapVersion.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+   Copyright 2020 WeAreFrank!\n+\n+   Licensed under the Apache License, Version 2.0 (the \"License\");\n+   you may not use this file except in compliance with the License.\n+   You may obtain a copy of the License at\n+\n+       http://www.apache.org/licenses/LICENSE-2.0\n+\n+   Unless required by applicable law or agreed to in writing, software\n+   distributed under the License is distributed on an \"AS IS\" BASIS,\n+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+   See the License for the specific language governing permissions and\n+   limitations under the License.\n+*/\n+package nl.nn.adapterframework.soap;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+import org.apache.commons.lang.StringUtils;\n+\n+\n+public enum SoapVersion {\n+\t\n+\tSOAP11(\"1.1\", \"http://schemas.xmlsoap.org/soap/envelope/\", \"/xml/xsd/soap/envelope.xsd\"),\n+\tSOAP12(\"1.2\", \"http://www.w3.org/2003/05/soap-envelope\",   \"/xml/xsd/soap/envelope-1.2.xsd\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09db0d8fdc031d168c69d3d47e50d73544d6eade"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb1f4e33ae435c9a3c667d308b7719741e44ea9d", "author": {"user": {"login": "gvanbrakel", "name": "Gerrit van Brakel"}}, "url": "https://github.com/ibissource/iaf/commit/cb1f4e33ae435c9a3c667d308b7719741e44ea9d", "committedDate": "2020-05-29T10:23:16Z", "message": "Optimizations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwOTI4NTE2", "url": "https://github.com/ibissource/iaf/pull/765#pullrequestreview-420928516", "createdAt": "2020-05-29T13:01:10Z", "commit": {"oid": "cb1f4e33ae435c9a3c667d308b7719741e44ea9d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1228, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}