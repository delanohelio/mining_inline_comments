{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg3MjQ0NzA3", "number": 1063, "title": "Refactor JMX resources to use Spring instead of custom prutsel", "bodyText": "", "createdAt": "2020-09-15T11:56:44Z", "url": "https://github.com/ibissource/iaf/pull/1063", "merged": true, "mergeCommit": {"oid": "5e53c29ac2b25f0bee0e24e7bce373f7b23eb560"}, "closed": true, "closedAt": "2020-09-21T07:37:06Z", "author": {"login": "nielsm5"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJGKTJAH2gAyNDg3MjQ0NzA3OjIxNTk2N2UzOTc3NzAzMTNmMGYyMTBjYWRhNDYzN2I2ZGVhNzczZjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdK-X21gFqTQ5MjMzOTgyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "215967e397770313f0f210cada4637b6dea773f2", "author": {"user": {"login": "nielsm5", "name": "Niels"}}, "url": "https://github.com/ibissource/iaf/commit/215967e397770313f0f210cada4637b6dea773f2", "committedDate": "2020-09-15T11:33:14Z", "message": "Refactor JMX resources to use Spring instead of custom prutsel"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4NjY5MDI5", "url": "https://github.com/ibissource/iaf/pull/1063#pullrequestreview-488669029", "createdAt": "2020-09-15T13:15:15Z", "commit": {"oid": "215967e397770313f0f210cada4637b6dea773f2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxMzoxNToxNVrOHSBQdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxMzoxNjo0OVrOHSBUtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY1NzAxNQ==", "bodyText": "Dat zal de super toch wel doen?", "url": "https://github.com/ibissource/iaf/pull/1063#discussion_r488657015", "createdAt": "2020-09-15T13:15:15Z", "author": {"login": "gvanbrakel"}, "path": "core/src/main/java/nl/nn/adapterframework/configuration/BasicAdapterServiceImpl.java", "diffHunk": "@@ -1,47 +1,80 @@\n+/*\n+   Copyright 2020 WeAreFrank!\n+\n+   Licensed under the Apache License, Version 2.0 (the \"License\");\n+   you may not use this file except in compliance with the License.\n+   You may obtain a copy of the License at\n+\n+       http://www.apache.org/licenses/LICENSE-2.0\n+\n+   Unless required by applicable law or agreed to in writing, software\n+   distributed under the License is distributed on an \"AS IS\" BASIS,\n+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+   See the License for the specific language governing permissions and\n+   limitations under the License.\n+*/\n package nl.nn.adapterframework.configuration;\n \n-import nl.nn.adapterframework.core.IAdapter;\n-import nl.nn.adapterframework.util.LogUtil;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import javax.management.ObjectName;\n \n import org.apache.logging.log4j.Logger;\n+import org.springframework.beans.factory.BeanCreationException;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.context.ApplicationContext;\n+import org.springframework.context.ApplicationContextAware;\n+import org.springframework.jmx.export.MBeanExporter;\n+\n+import nl.nn.adapterframework.core.IAdapter;\n+import nl.nn.adapterframework.util.LogUtil;\n \n /**\n- * This implemention of {@link AdapterService} also registers the adapters to Jmx, and configures the registered Adapters.\n+ * This implementation of {@link AdapterService} also registers the adapters to a JMX server, and configures the registered Adapters.\n \n- * @author Michiel Meeuwissen\n+ * @author Niels Meijer\n  * @since 5.0.29\n  */\n-public class BasicAdapterServiceImpl extends AdapterServiceImpl {\n-\n-    private static final Logger LOG = LogUtil.getLogger(BasicAdapterServiceImpl.class);\n-\n-    @Override\n-    public void registerAdapter(IAdapter adapter) throws ConfigurationException {\n-        super.registerAdapter(adapter);\n-        try {\n-            // Throws javax.management.InstanceAlreadyExistsException when testing on\n-            // WebSphere 7. This code has probably never been enabled as previously it was\n-            // part of Configuration.java and was surrounded with \"if (isEnableJMX())\" with\n-            // enableJMX being false by default.\n-            LOG.debug(\"Registering adapter [\" + adapter.getName() + \"] to the JMX server\");\n-            JmxMbeanHelper.hookupAdapter(adapter);\n-            LOG.info(\"[\" + adapter.getName() + \"] registered to the JMX server\");\n-        } catch (Throwable t) {\n-            LOG.warn(t.getMessage());\n-        }\n-        adapter.configure();\n-    }\n-\n-    @Override\n-    public void unRegisterAdapter(IAdapter adapter) {\n-        super.unRegisterAdapter(adapter);\n-        try {\n-            JmxMbeanHelper.unhookAdapter(adapter);\n-        } catch (Throwable t) {\n-            LOG.warn(t.getMessage());\n-        }\n-    }\n+public class BasicAdapterServiceImpl extends AdapterServiceImpl implements ApplicationContextAware, InitializingBean {\n \n-}\n+\tprivate final Logger log = LogUtil.getLogger(BasicAdapterServiceImpl.class);\n+\tprivate MBeanExporter mBeanManager = null;\n+\tprivate static Map<IAdapter, ObjectName> registeredAdapters = new HashMap<>();\n+\n+\t@Override\n+\tpublic void afterPropertiesSet() throws Exception {\n+\t\tif(mBeanManager == null) {\n+\t\t\tthrow new BeanCreationException(\"unable to load JmxMBeanManager\");\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic void registerAdapter(IAdapter adapter) throws ConfigurationException {\n+\t\tsuper.registerAdapter(adapter);\n \n+\t\tlog.debug(\"Registering adapter [\" + adapter.getName() + \"] to the JMX server\");\n+\t\tsynchronized(registeredAdapters) {\n+\t\t\tObjectName name = mBeanManager.registerManagedResource(adapter);\n+\t\t\tregisteredAdapters.put(adapter, name);\n+\t\t}\n+\t\tlog.info(\"[\" + adapter.getName() + \"] registered to the JMX server\");\n \n+\t\tadapter.configure();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "215967e397770313f0f210cada4637b6dea773f2"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY1ODEwMg==", "bodyText": "Hier mag toch wel een stukje commentaar bij", "url": "https://github.com/ibissource/iaf/pull/1063#discussion_r488658102", "createdAt": "2020-09-15T13:16:49Z", "author": {"login": "gvanbrakel"}, "path": "core/src/main/java/nl/nn/adapterframework/configuration/Configuration.java", "diffHunk": "@@ -63,7 +63,7 @@\n     private final List<JobDef> scheduledJobs = new ArrayList<JobDef>();\n \n     private String name;\n-    private String version;\n+    private String version = Integer.toHexString(this.hashCode());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "215967e397770313f0f210cada4637b6dea773f2"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac225c6c430553b395c48c0e31802a930200a81b", "author": {"user": {"login": "nielsm5", "name": "Niels"}}, "url": "https://github.com/ibissource/iaf/commit/ac225c6c430553b395c48c0e31802a930200a81b", "committedDate": "2020-09-15T13:32:08Z", "message": "Fix Junit Tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c523c6cc9ee65a7256d32e764a5a124b575099b6", "author": {"user": {"login": "nielsm5", "name": "Niels"}}, "url": "https://github.com/ibissource/iaf/commit/c523c6cc9ee65a7256d32e764a5a124b575099b6", "committedDate": "2020-09-15T15:21:09Z", "message": "Fix more Junit tests and remove ScanningAdapterService"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c55f47da7cd5394f05a6ab0f568c21a59e548229", "author": {"user": {"login": "nielsm5", "name": "Niels"}}, "url": "https://github.com/ibissource/iaf/commit/c55f47da7cd5394f05a6ab0f568c21a59e548229", "committedDate": "2020-09-15T15:23:27Z", "message": "Add comment regarding configuration version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7fe889f76660f4718142c428d7f4e369edc41ac", "author": {"user": {"login": "nielsm5", "name": "Niels"}}, "url": "https://github.com/ibissource/iaf/commit/a7fe889f76660f4718142c428d7f4e369edc41ac", "committedDate": "2020-09-15T15:32:58Z", "message": "Add pipeline to test adapter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab3a03e78f25bdfcfd2cbd761ef622c4fe2aca4b", "author": {"user": {"login": "nielsm5", "name": "Niels"}}, "url": "https://github.com/ibissource/iaf/commit/ab3a03e78f25bdfcfd2cbd761ef622c4fe2aca4b", "committedDate": "2020-09-16T07:35:03Z", "message": "Remove version from configuration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb2b6093db49cb6b129130d2af9804ed5c406732", "author": {"user": {"login": "nielsm5", "name": "Niels"}}, "url": "https://github.com/ibissource/iaf/commit/fb2b6093db49cb6b129130d2af9804ed5c406732", "committedDate": "2020-09-16T07:52:19Z", "message": "Add ability to enable JmxAttribute setters"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyMzA4MjY5", "url": "https://github.com/ibissource/iaf/pull/1063#pullrequestreview-492308269", "createdAt": "2020-09-21T06:34:57Z", "commit": {"oid": "fb2b6093db49cb6b129130d2af9804ed5c406732"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwNjozNDo1N1rOHVCK0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwNjozNDo1N1rOHVCK0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTgxNzY4MQ==", "bodyText": "Laten we deze class JmxRegisteringAdapterService noemen, want dat is wat hij doet. Er is niks basics aan.", "url": "https://github.com/ibissource/iaf/pull/1063#discussion_r491817681", "createdAt": "2020-09-21T06:34:57Z", "author": {"login": "gvanbrakel"}, "path": "core/src/main/java/nl/nn/adapterframework/configuration/BasicAdapterServiceImpl.java", "diffHunk": "@@ -1,47 +1,77 @@\n+/*\n+   Copyright 2020 WeAreFrank!\n+\n+   Licensed under the Apache License, Version 2.0 (the \"License\");\n+   you may not use this file except in compliance with the License.\n+   You may obtain a copy of the License at\n+\n+       http://www.apache.org/licenses/LICENSE-2.0\n+\n+   Unless required by applicable law or agreed to in writing, software\n+   distributed under the License is distributed on an \"AS IS\" BASIS,\n+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+   See the License for the specific language governing permissions and\n+   limitations under the License.\n+*/\n package nl.nn.adapterframework.configuration;\n \n-import nl.nn.adapterframework.core.IAdapter;\n-import nl.nn.adapterframework.util.LogUtil;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import javax.management.ObjectName;\n \n import org.apache.logging.log4j.Logger;\n+import org.springframework.beans.factory.BeanCreationException;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.context.ApplicationContext;\n+import org.springframework.context.ApplicationContextAware;\n+import org.springframework.jmx.export.MBeanExporter;\n+\n+import nl.nn.adapterframework.core.IAdapter;\n+import nl.nn.adapterframework.util.LogUtil;\n \n /**\n- * This implemention of {@link AdapterService} also registers the adapters to Jmx, and configures the registered Adapters.\n+ * This implementation of {@link AdapterService} registers the adapters to a JMX server.\n \n- * @author Michiel Meeuwissen\n- * @since 5.0.29\n+ * @author Niels Meijer\n  */\n-public class BasicAdapterServiceImpl extends AdapterServiceImpl {\n-\n-    private static final Logger LOG = LogUtil.getLogger(BasicAdapterServiceImpl.class);\n-\n-    @Override\n-    public void registerAdapter(IAdapter adapter) throws ConfigurationException {\n-        super.registerAdapter(adapter);\n-        try {\n-            // Throws javax.management.InstanceAlreadyExistsException when testing on\n-            // WebSphere 7. This code has probably never been enabled as previously it was\n-            // part of Configuration.java and was surrounded with \"if (isEnableJMX())\" with\n-            // enableJMX being false by default.\n-            LOG.debug(\"Registering adapter [\" + adapter.getName() + \"] to the JMX server\");\n-            JmxMbeanHelper.hookupAdapter(adapter);\n-            LOG.info(\"[\" + adapter.getName() + \"] registered to the JMX server\");\n-        } catch (Throwable t) {\n-            LOG.warn(t.getMessage());\n-        }\n-        adapter.configure();\n-    }\n-\n-    @Override\n-    public void unRegisterAdapter(IAdapter adapter) {\n-        super.unRegisterAdapter(adapter);\n-        try {\n-            JmxMbeanHelper.unhookAdapter(adapter);\n-        } catch (Throwable t) {\n-            LOG.warn(t.getMessage());\n-        }\n-    }\n+public class BasicAdapterServiceImpl extends AdapterServiceImpl implements ApplicationContextAware, InitializingBean {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb2b6093db49cb6b129130d2af9804ed5c406732"}, "originalPosition": 73}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyMzM5ODI4", "url": "https://github.com/ibissource/iaf/pull/1063#pullrequestreview-492339828", "createdAt": "2020-09-21T07:36:39Z", "commit": {"oid": "fb2b6093db49cb6b129130d2af9804ed5c406732"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1091, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}