{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1Nzc5ODAw", "number": 377, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxMjozMzo1OVrODeyTtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMzowMTozM1rODtGQlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzNjA4MTE5OnYy", "diffSide": "RIGHT", "path": "ibm/src/main/java/nl/nn/adapterframework/extensions/ibm/IMSSender.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxMjozMzo1OVrOFoHR3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxMjozMzo1OVrOFoHR3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYwNjYyMA==", "bodyText": "Moet je hier niet ook de characterset uit JMS_IBM_Character_Set gebruiken?", "url": "https://github.com/ibissource/iaf/pull/377#discussion_r377606620", "createdAt": "2020-02-11T12:33:59Z", "author": {"login": "gvanbrakel"}, "path": "ibm/src/main/java/nl/nn/adapterframework/extensions/ibm/IMSSender.java", "diffHunk": "@@ -0,0 +1,209 @@\n+/*\n+   Copyright 2020 Integration Partners\n+\n+   Licensed under the Apache License, Version 2.0 (the \"License\");\n+   you may not use this file except in compliance with the License.\n+   You may obtain a copy of the License at\n+\n+       http://www.apache.org/licenses/LICENSE-2.0\n+\n+   Unless required by applicable law or agreed to in writing, software\n+   distributed under the License is distributed on an \"AS IS\" BASIS,\n+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+   See the License for the specific language governing permissions and\n+   limitations under the License.\n+*/\n+package nl.nn.adapterframework.extensions.ibm;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Map;\n+\n+import javax.jms.BytesMessage;\n+import javax.jms.JMSException;\n+import javax.jms.Message;\n+import javax.jms.Session;\n+import javax.naming.NamingException;\n+import javax.xml.transform.TransformerException;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.xml.sax.SAXException;\n+\n+import nl.nn.adapterframework.configuration.ConfigurationException;\n+import nl.nn.adapterframework.doc.IbisDoc;\n+import nl.nn.adapterframework.soap.SoapWrapper;\n+\n+/**\n+ * JMS sender which will add an IMS header to the message and call the MQ specific logic.\n+ *\n+ * <p>See {@link JMSSender} for configuration</p>\n+ *\n+ * @author Ricardo van Holst\n+ */\n+\n+public class IMSSender extends MQSender {\n+\t// IMS Header length\n+\tprivate static final int IIH_HEADERSIZE = 88;\n+\t\n+\t// IMS Header fields\n+\tprivate static final String\t  IIH_HEADER_STRUCT_ID\t\t= \"IIH \";\t\t// MQIIH_STRUC_ID (4 pos) \n+\tprivate static final int\t  IIH_HEADER_VERSION\t\t= 1;\t\t\t// MQIIH_VERSION_1 (4 pos)\n+\tprivate static final int\t  IIH_HEADER_LENGTH\t\t\t= 84;\t\t\t// MQIIH_LENGTH_1 (4 pos)\n+\tprivate static final int\t  IIH_HEADER_ENCODING\t\t= 0;\t\t\t// MQ reserved (4 pos)\n+\tprivate static final int\t  IIH_HEADER_CODECHARSET\t= 0;\t\t\t// MQ reserved (4 pos)\n+\tprivate static final String   IIH_HEADER_FORMAT\t\t\t= \"MQIMSVS \";\t// MQFMT-IMS-VAR-STRING (8 pos)\n+\tprivate\tstatic final int      IIH_HEADER_FLAGS\t\t\t= 0;\t\t\t// MQIIH-NONE (4 pos)\n+\tprivate static final String   IIH_HEADER_LTERM_OR\t\t= \"        \";\t// (8 pos)\n+\tprivate static final String   IIH_HEADER_MFS_MAPNAME\t= \"MQIMSVS \";\t// (8 pos)\n+\tprivate static final String   IIH_HEADER_REPLY_FORMAT\t= \"MQIMSVS \";\t// (8 pos)\n+\tprivate\tstatic final String   IIH_HEADER_MFS_AUTH\t\t= \"        \";\t// Password (8 pos)\n+\tprivate static final byte[]   IIH_HEADER_TRAN_INSTANCE\t= new byte[16];\t// Only relevant for conversation (16 pos)\n+\tprivate static final String   IIH_HEADER_TRAN_STATE\t\t= \" \";\t\t\t// MQITS_NOT_IN_CONVERSATION (1 pos)\n+\tprivate static final String   IIH_HEADER_COMMIT_MODE\t= \"1\";\t\t\t// MQICM-SEND-THEN-COMMIT (1 pos)\n+\tprivate static final String   IIH_HEADER_SECURITY_SCOPE\t= \"C\";\t\t\t// MQISS-CHECK (1 pos)\n+\tprivate static final String   IIH_HEADER_RESERVED\t\t= \" \";\t\t\t// Reserved (1 pos)\n+\t\n+\t// MQ Fields\n+\tprivate static final String MQC_MQFMT_IMS\t= \"MQIMS   \";\t// (8 pos)\n+\tprivate static final int MQENC_NATIVE = 273;\t\t\t\t// copied from com.ibm.mq.MQC in com.ibm.mq.jar\n+\tprivate static final int CCSID_ISO_8859_1 = 819;\n+\t\n+\tprivate String transactionCode;\n+\t\n+\t/**\n+\t * The transaction code that should be added in the header, must be 8 characters\n+\t */\n+\t@IbisDoc({\"transaction code that should be added to the header, must be 8 characters\", \"\"})\n+\tpublic String getTransactionCode() {\n+\t\treturn transactionCode;\n+\t}\n+\tpublic void setTransactionCode(String transactionCode) {\n+\t\tthis.transactionCode = transactionCode;\n+\t}\n+\n+\t@Override\n+\tpublic void configure() throws ConfigurationException {\n+\t\tif (StringUtils.isEmpty(getTransactionCode())) {\n+\t\t\tthrow new ConfigurationException(\"transactionCode must be specified\");\n+\t\t}\n+\t\tif (StringUtils.length(getTransactionCode()) != 8) {\n+\t\t\tthrow new ConfigurationException(\"transactionCode must be 8 positions, current code [\" + getTransactionCode() + \"] with length [\" + StringUtils.length(getTransactionCode()) + \"]\");\n+\t\t}\n+\t\tsuper.configure();\n+\t}\n+\t\n+\t@Override\n+\tpublic Message createMessage(Session session, String correlationID, String message)\n+\t\t\tthrows NamingException, JMSException {\n+\t\t\n+\t\tBytesMessage bytesMessage = null;\n+\t\tbytesMessage = session.createBytesMessage();\n+\t\t\n+\t\tsetMessageCorrelationID(bytesMessage, correlationID);\n+\t\t\n+\t\tByteArrayOutputStream bos = new ByteArrayOutputStream();\n+\t\t\n+\t\ttry {\n+\t\t\tbos.write(IIH_HEADER_STRUCT_ID.getBytes());\n+\t\t\tbos.write(intToBytes(IIH_HEADER_VERSION));\n+\t\t\tbos.write(intToBytes(IIH_HEADER_LENGTH));\n+\t\t\tbos.write(intToBytes(IIH_HEADER_ENCODING));\n+\t\t\tbos.write(intToBytes(IIH_HEADER_CODECHARSET));\n+\t\t\tbos.write(IIH_HEADER_FORMAT.getBytes());\n+\t\t\tbos.write(intToBytes(IIH_HEADER_FLAGS));\n+\t\t\tbos.write(IIH_HEADER_LTERM_OR.getBytes());\n+\t\t\tbos.write(IIH_HEADER_MFS_MAPNAME.getBytes());\n+\t\t\tbos.write(IIH_HEADER_REPLY_FORMAT.getBytes());\n+\t\t\tbos.write(IIH_HEADER_MFS_AUTH.getBytes());\n+\t\t\tbos.write(IIH_HEADER_TRAN_INSTANCE);\n+\t\t\tbos.write(IIH_HEADER_TRAN_STATE.getBytes());\n+\t\t\tbos.write(IIH_HEADER_COMMIT_MODE.getBytes());\n+\t\t\tbos.write(IIH_HEADER_SECURITY_SCOPE.getBytes());\n+\t\t\tbos.write(IIH_HEADER_RESERVED.getBytes());\n+\t\t\t\n+\t\t\tbyte[] data = message.getBytes();\n+\t\t\t\n+\t\t\tbos.write(shortToBytes(data.length + 13)); //LL, +13 is for LL, ZZ and transaction code bytes\n+\t\t\tbos.write(new byte[2]); //ZZ\n+\t\t\tbos.write((transactionCode + \" \").getBytes());\n+\t\t\t\n+\t\t\tbos.write(data);\n+\t\t\t\n+\t\t\tbos.toByteArray();\n+\t\t} catch (IOException e) {\n+\t\t\t// Should never happen\n+\t\t\tthrow new RuntimeException(e);\n+\t\t}\n+\t\t\n+\t\tbytesMessage.writeBytes(bos.toByteArray());\n+\t\t\n+\t\t// Set Properties\n+\t\tbytesMessage.setIntProperty(\"JMS_IBM_Encoding\", MQENC_NATIVE);\n+\t\tbytesMessage.setIntProperty(\"JMS_IBM_Character_Set\", CCSID_ISO_8859_1);\t\n+\t\tbytesMessage.setStringProperty(\"JMS_IBM_Format\", MQC_MQFMT_IMS);\t\n+\n+\t\treturn bytesMessage;\n+\t}\n+\n+\t@Override\n+\tpublic String getStringFromRawMessage(Object rawMessage, Map<String,Object> context, boolean soap, String soapHeaderSessionKey, SoapWrapper soapWrapper) throws JMSException, SAXException, TransformerException, IOException {\n+\t\tBytesMessage message;\n+\t\ttry {\n+\t\t\tmessage = (BytesMessage)rawMessage;\n+\t\t} catch (ClassCastException e) {\n+\t\t\tlog.error(\"message received by listener on [\"+ getDestinationName()+ \"] was not of type BytesMessage, but [\"+rawMessage.getClass().getName()+\"]\", e);\n+\t\t\treturn null;\n+\t\t}\n+\t\tbyte[] headerBuffer = new byte[IIH_HEADERSIZE];\n+\t\tmessage.readBytes(headerBuffer);\n+\t\t\n+\t\t// Put header fields in the context\n+\t\tByteBuffer byteBuffer = ByteBuffer.wrap(headerBuffer);\n+\t\tcontext.put(\"MQIIH_StrucID\", byteToString(byteBuffer, 4));\n+\t\tcontext.put(\"MQIIH_Version\", byteBuffer.getInt());\n+\t\tcontext.put(\"MQIIH_StrucLength\", byteBuffer.getInt());\n+\t\tcontext.put(\"MQIIH_Encoding\", byteBuffer.getInt());\n+\t\tcontext.put(\"MQIIH_CodedCharSetId\", byteBuffer.getInt());\n+\t\tcontext.put(\"MQIIH_Format\", byteToString(byteBuffer, 8));\n+\t\tcontext.put(\"MQIIH_Flags\", byteBuffer.getInt());\n+\t\tcontext.put(\"MQIIH_LTermOverride\", byteToString(byteBuffer, 8));\n+\t\tcontext.put(\"MQIIH_MFSMapName\", byteToString(byteBuffer, 8));\n+\t\tcontext.put(\"MQIIH_ReplyToFormat\", byteToString(byteBuffer, 8));\n+\t\tcontext.put(\"MQIIH_Authenticator\", byteToString(byteBuffer, 8));\n+\t\tcontext.put(\"MQIIH_TranInstanceId\", byteToString(byteBuffer, 16));\n+\t\tcontext.put(\"MQIIH_TranState\", byteToString(byteBuffer, 1));\n+\t\tcontext.put(\"MQIIH_CommitMode\", byteToString(byteBuffer, 1));\n+\t\tcontext.put(\"MQIIH_SecurityScope\", byteToString(byteBuffer, 1));\n+\t\tcontext.put(\"MQIIH_Reserved\", byteToString(byteBuffer, 1));\n+\t\t\n+\t\tint readBufferLength = (int)message.getBodyLength() - IIH_HEADERSIZE; // Get the length of the message to extract\n+\t\t\n+\t\tbyte[] readBuffer = new byte[readBufferLength];\n+\t\tmessage.readBytes(readBuffer);\n+\t\t\n+\t\tByteArrayOutputStream bos = new ByteArrayOutputStream();\n+\t\tbos.write(readBuffer);\n+\t\t\n+\t\treturn bos.toString(message.getStringProperty(\"JMS_IBM_Character_Set\"));\n+\t}\n+\t\n+\tprivate String byteToString(ByteBuffer byteBuffer, int size) {\n+\t\tbyte[] bytes = new byte[size];\n+\t\tbyteBuffer.get(bytes);\n+\t\t\n+\t\treturn new String(bytes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8a8e8256686e4d33c9552e5899a1a9956d440bc"}, "originalPosition": 195}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0MDE4NTQ5OnYy", "diffSide": "RIGHT", "path": "ibm/src/main/java/nl/nn/adapterframework/extensions/ibm/IMSSender.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxMzozMTo1NVrOFoumNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNTo0OTo0NlrOFrsciQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODI1MDgwNQ==", "bodyText": "Sorry, had het meteen moeten aanwijzen; Hier ook de character set gebruiken.\nEigenlijk altijd/overal wanneer er Strings naar bytes gaan, of andersom, dan moet je daarbij de characterset aangeven.\nHet beste maak je ook een test, waarin je in je message diacrieten (\u00e9\u00e8\u00ef) en het euro teken (\u20ac) gebruikt, Die moeten dan netjes heen en weer gaan.", "url": "https://github.com/ibissource/iaf/pull/377#discussion_r378250805", "createdAt": "2020-02-12T13:31:55Z", "author": {"login": "gvanbrakel"}, "path": "ibm/src/main/java/nl/nn/adapterframework/extensions/ibm/IMSSender.java", "diffHunk": "@@ -0,0 +1,210 @@\n+/*\n+   Copyright 2020 Integration Partners\n+\n+   Licensed under the Apache License, Version 2.0 (the \"License\");\n+   you may not use this file except in compliance with the License.\n+   You may obtain a copy of the License at\n+\n+       http://www.apache.org/licenses/LICENSE-2.0\n+\n+   Unless required by applicable law or agreed to in writing, software\n+   distributed under the License is distributed on an \"AS IS\" BASIS,\n+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+   See the License for the specific language governing permissions and\n+   limitations under the License.\n+*/\n+package nl.nn.adapterframework.extensions.ibm;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.UnsupportedEncodingException;\n+import java.nio.ByteBuffer;\n+import java.util.Map;\n+\n+import javax.jms.BytesMessage;\n+import javax.jms.JMSException;\n+import javax.jms.Message;\n+import javax.jms.Session;\n+import javax.naming.NamingException;\n+import javax.xml.transform.TransformerException;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.xml.sax.SAXException;\n+\n+import nl.nn.adapterframework.configuration.ConfigurationException;\n+import nl.nn.adapterframework.doc.IbisDoc;\n+import nl.nn.adapterframework.soap.SoapWrapper;\n+\n+/**\n+ * JMS sender which will add an IMS header to the message and call the MQ specific logic.\n+ *\n+ * <p>See {@link JMSSender} for configuration</p>\n+ *\n+ * @author Ricardo van Holst\n+ */\n+\n+public class IMSSender extends MQSender {\n+\t// IMS Header length\n+\tprivate static final int IIH_HEADERSIZE = 88;\n+\t\n+\t// IMS Header fields\n+\tprivate static final String\t  IIH_HEADER_STRUCT_ID\t\t= \"IIH \";\t\t// MQIIH_STRUC_ID (4 pos) \n+\tprivate static final int\t  IIH_HEADER_VERSION\t\t= 1;\t\t\t// MQIIH_VERSION_1 (4 pos)\n+\tprivate static final int\t  IIH_HEADER_LENGTH\t\t\t= 84;\t\t\t// MQIIH_LENGTH_1 (4 pos)\n+\tprivate static final int\t  IIH_HEADER_ENCODING\t\t= 0;\t\t\t// MQ reserved (4 pos)\n+\tprivate static final int\t  IIH_HEADER_CODECHARSET\t= 0;\t\t\t// MQ reserved (4 pos)\n+\tprivate static final String   IIH_HEADER_FORMAT\t\t\t= \"MQIMSVS \";\t// MQFMT-IMS-VAR-STRING (8 pos)\n+\tprivate\tstatic final int      IIH_HEADER_FLAGS\t\t\t= 0;\t\t\t// MQIIH-NONE (4 pos)\n+\tprivate static final String   IIH_HEADER_LTERM_OR\t\t= \"        \";\t// (8 pos)\n+\tprivate static final String   IIH_HEADER_MFS_MAPNAME\t= \"MQIMSVS \";\t// (8 pos)\n+\tprivate static final String   IIH_HEADER_REPLY_FORMAT\t= \"MQIMSVS \";\t// (8 pos)\n+\tprivate\tstatic final String   IIH_HEADER_MFS_AUTH\t\t= \"        \";\t// Password (8 pos)\n+\tprivate static final byte[]   IIH_HEADER_TRAN_INSTANCE\t= new byte[16];\t// Only relevant for conversation (16 pos)\n+\tprivate static final String   IIH_HEADER_TRAN_STATE\t\t= \" \";\t\t\t// MQITS_NOT_IN_CONVERSATION (1 pos)\n+\tprivate static final String   IIH_HEADER_COMMIT_MODE\t= \"1\";\t\t\t// MQICM-SEND-THEN-COMMIT (1 pos)\n+\tprivate static final String   IIH_HEADER_SECURITY_SCOPE\t= \"C\";\t\t\t// MQISS-CHECK (1 pos)\n+\tprivate static final String   IIH_HEADER_RESERVED\t\t= \" \";\t\t\t// Reserved (1 pos)\n+\t\n+\t// MQ Fields\n+\tprivate static final String MQC_MQFMT_IMS\t= \"MQIMS   \";\t// (8 pos)\n+\tprivate static final int MQENC_NATIVE = 273;\t\t\t\t// copied from com.ibm.mq.MQC in com.ibm.mq.jar\n+\tprivate static final int CCSID_ISO_8859_1 = 819;\n+\t\n+\tprivate String transactionCode;\n+\t\n+\t/**\n+\t * The transaction code that should be added in the header, must be 8 characters\n+\t */\n+\t@IbisDoc({\"transaction code that should be added to the header, must be 8 characters\", \"\"})\n+\tpublic String getTransactionCode() {\n+\t\treturn transactionCode;\n+\t}\n+\tpublic void setTransactionCode(String transactionCode) {\n+\t\tthis.transactionCode = transactionCode;\n+\t}\n+\n+\t@Override\n+\tpublic void configure() throws ConfigurationException {\n+\t\tif (StringUtils.isEmpty(getTransactionCode())) {\n+\t\t\tthrow new ConfigurationException(\"transactionCode must be specified\");\n+\t\t}\n+\t\tif (StringUtils.length(getTransactionCode()) != 8) {\n+\t\t\tthrow new ConfigurationException(\"transactionCode must be 8 positions, current code [\" + getTransactionCode() + \"] with length [\" + StringUtils.length(getTransactionCode()) + \"]\");\n+\t\t}\n+\t\tsuper.configure();\n+\t}\n+\t\n+\t@Override\n+\tpublic Message createMessage(Session session, String correlationID, String message)\n+\t\t\tthrows NamingException, JMSException {\n+\t\t\n+\t\tBytesMessage bytesMessage = null;\n+\t\tbytesMessage = session.createBytesMessage();\n+\t\t\n+\t\tsetMessageCorrelationID(bytesMessage, correlationID);\n+\t\t\n+\t\tByteArrayOutputStream bos = new ByteArrayOutputStream();\n+\t\t\n+\t\ttry {\n+\t\t\tbos.write(IIH_HEADER_STRUCT_ID.getBytes());\n+\t\t\tbos.write(intToBytes(IIH_HEADER_VERSION));\n+\t\t\tbos.write(intToBytes(IIH_HEADER_LENGTH));\n+\t\t\tbos.write(intToBytes(IIH_HEADER_ENCODING));\n+\t\t\tbos.write(intToBytes(IIH_HEADER_CODECHARSET));\n+\t\t\tbos.write(IIH_HEADER_FORMAT.getBytes());\n+\t\t\tbos.write(intToBytes(IIH_HEADER_FLAGS));\n+\t\t\tbos.write(IIH_HEADER_LTERM_OR.getBytes());\n+\t\t\tbos.write(IIH_HEADER_MFS_MAPNAME.getBytes());\n+\t\t\tbos.write(IIH_HEADER_REPLY_FORMAT.getBytes());\n+\t\t\tbos.write(IIH_HEADER_MFS_AUTH.getBytes());\n+\t\t\tbos.write(IIH_HEADER_TRAN_INSTANCE);\n+\t\t\tbos.write(IIH_HEADER_TRAN_STATE.getBytes());\n+\t\t\tbos.write(IIH_HEADER_COMMIT_MODE.getBytes());\n+\t\t\tbos.write(IIH_HEADER_SECURITY_SCOPE.getBytes());\n+\t\t\tbos.write(IIH_HEADER_RESERVED.getBytes());\n+\t\t\t\n+\t\t\tbyte[] data = message.getBytes();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7767a892d31c7e334c36e9409e181442e2e8ca50"}, "originalPosition": 126}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM2MTI4OQ==", "bodyText": "\u20ac is geen onderdeel van de ISO_8859_1, dus bij omzetten van de string naar bytes is deze al verloren.", "url": "https://github.com/ibissource/iaf/pull/377#discussion_r381361289", "createdAt": "2020-02-19T15:49:46Z", "author": {"login": "ricardovh"}, "path": "ibm/src/main/java/nl/nn/adapterframework/extensions/ibm/IMSSender.java", "diffHunk": "@@ -0,0 +1,210 @@\n+/*\n+   Copyright 2020 Integration Partners\n+\n+   Licensed under the Apache License, Version 2.0 (the \"License\");\n+   you may not use this file except in compliance with the License.\n+   You may obtain a copy of the License at\n+\n+       http://www.apache.org/licenses/LICENSE-2.0\n+\n+   Unless required by applicable law or agreed to in writing, software\n+   distributed under the License is distributed on an \"AS IS\" BASIS,\n+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+   See the License for the specific language governing permissions and\n+   limitations under the License.\n+*/\n+package nl.nn.adapterframework.extensions.ibm;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.UnsupportedEncodingException;\n+import java.nio.ByteBuffer;\n+import java.util.Map;\n+\n+import javax.jms.BytesMessage;\n+import javax.jms.JMSException;\n+import javax.jms.Message;\n+import javax.jms.Session;\n+import javax.naming.NamingException;\n+import javax.xml.transform.TransformerException;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.xml.sax.SAXException;\n+\n+import nl.nn.adapterframework.configuration.ConfigurationException;\n+import nl.nn.adapterframework.doc.IbisDoc;\n+import nl.nn.adapterframework.soap.SoapWrapper;\n+\n+/**\n+ * JMS sender which will add an IMS header to the message and call the MQ specific logic.\n+ *\n+ * <p>See {@link JMSSender} for configuration</p>\n+ *\n+ * @author Ricardo van Holst\n+ */\n+\n+public class IMSSender extends MQSender {\n+\t// IMS Header length\n+\tprivate static final int IIH_HEADERSIZE = 88;\n+\t\n+\t// IMS Header fields\n+\tprivate static final String\t  IIH_HEADER_STRUCT_ID\t\t= \"IIH \";\t\t// MQIIH_STRUC_ID (4 pos) \n+\tprivate static final int\t  IIH_HEADER_VERSION\t\t= 1;\t\t\t// MQIIH_VERSION_1 (4 pos)\n+\tprivate static final int\t  IIH_HEADER_LENGTH\t\t\t= 84;\t\t\t// MQIIH_LENGTH_1 (4 pos)\n+\tprivate static final int\t  IIH_HEADER_ENCODING\t\t= 0;\t\t\t// MQ reserved (4 pos)\n+\tprivate static final int\t  IIH_HEADER_CODECHARSET\t= 0;\t\t\t// MQ reserved (4 pos)\n+\tprivate static final String   IIH_HEADER_FORMAT\t\t\t= \"MQIMSVS \";\t// MQFMT-IMS-VAR-STRING (8 pos)\n+\tprivate\tstatic final int      IIH_HEADER_FLAGS\t\t\t= 0;\t\t\t// MQIIH-NONE (4 pos)\n+\tprivate static final String   IIH_HEADER_LTERM_OR\t\t= \"        \";\t// (8 pos)\n+\tprivate static final String   IIH_HEADER_MFS_MAPNAME\t= \"MQIMSVS \";\t// (8 pos)\n+\tprivate static final String   IIH_HEADER_REPLY_FORMAT\t= \"MQIMSVS \";\t// (8 pos)\n+\tprivate\tstatic final String   IIH_HEADER_MFS_AUTH\t\t= \"        \";\t// Password (8 pos)\n+\tprivate static final byte[]   IIH_HEADER_TRAN_INSTANCE\t= new byte[16];\t// Only relevant for conversation (16 pos)\n+\tprivate static final String   IIH_HEADER_TRAN_STATE\t\t= \" \";\t\t\t// MQITS_NOT_IN_CONVERSATION (1 pos)\n+\tprivate static final String   IIH_HEADER_COMMIT_MODE\t= \"1\";\t\t\t// MQICM-SEND-THEN-COMMIT (1 pos)\n+\tprivate static final String   IIH_HEADER_SECURITY_SCOPE\t= \"C\";\t\t\t// MQISS-CHECK (1 pos)\n+\tprivate static final String   IIH_HEADER_RESERVED\t\t= \" \";\t\t\t// Reserved (1 pos)\n+\t\n+\t// MQ Fields\n+\tprivate static final String MQC_MQFMT_IMS\t= \"MQIMS   \";\t// (8 pos)\n+\tprivate static final int MQENC_NATIVE = 273;\t\t\t\t// copied from com.ibm.mq.MQC in com.ibm.mq.jar\n+\tprivate static final int CCSID_ISO_8859_1 = 819;\n+\t\n+\tprivate String transactionCode;\n+\t\n+\t/**\n+\t * The transaction code that should be added in the header, must be 8 characters\n+\t */\n+\t@IbisDoc({\"transaction code that should be added to the header, must be 8 characters\", \"\"})\n+\tpublic String getTransactionCode() {\n+\t\treturn transactionCode;\n+\t}\n+\tpublic void setTransactionCode(String transactionCode) {\n+\t\tthis.transactionCode = transactionCode;\n+\t}\n+\n+\t@Override\n+\tpublic void configure() throws ConfigurationException {\n+\t\tif (StringUtils.isEmpty(getTransactionCode())) {\n+\t\t\tthrow new ConfigurationException(\"transactionCode must be specified\");\n+\t\t}\n+\t\tif (StringUtils.length(getTransactionCode()) != 8) {\n+\t\t\tthrow new ConfigurationException(\"transactionCode must be 8 positions, current code [\" + getTransactionCode() + \"] with length [\" + StringUtils.length(getTransactionCode()) + \"]\");\n+\t\t}\n+\t\tsuper.configure();\n+\t}\n+\t\n+\t@Override\n+\tpublic Message createMessage(Session session, String correlationID, String message)\n+\t\t\tthrows NamingException, JMSException {\n+\t\t\n+\t\tBytesMessage bytesMessage = null;\n+\t\tbytesMessage = session.createBytesMessage();\n+\t\t\n+\t\tsetMessageCorrelationID(bytesMessage, correlationID);\n+\t\t\n+\t\tByteArrayOutputStream bos = new ByteArrayOutputStream();\n+\t\t\n+\t\ttry {\n+\t\t\tbos.write(IIH_HEADER_STRUCT_ID.getBytes());\n+\t\t\tbos.write(intToBytes(IIH_HEADER_VERSION));\n+\t\t\tbos.write(intToBytes(IIH_HEADER_LENGTH));\n+\t\t\tbos.write(intToBytes(IIH_HEADER_ENCODING));\n+\t\t\tbos.write(intToBytes(IIH_HEADER_CODECHARSET));\n+\t\t\tbos.write(IIH_HEADER_FORMAT.getBytes());\n+\t\t\tbos.write(intToBytes(IIH_HEADER_FLAGS));\n+\t\t\tbos.write(IIH_HEADER_LTERM_OR.getBytes());\n+\t\t\tbos.write(IIH_HEADER_MFS_MAPNAME.getBytes());\n+\t\t\tbos.write(IIH_HEADER_REPLY_FORMAT.getBytes());\n+\t\t\tbos.write(IIH_HEADER_MFS_AUTH.getBytes());\n+\t\t\tbos.write(IIH_HEADER_TRAN_INSTANCE);\n+\t\t\tbos.write(IIH_HEADER_TRAN_STATE.getBytes());\n+\t\t\tbos.write(IIH_HEADER_COMMIT_MODE.getBytes());\n+\t\t\tbos.write(IIH_HEADER_SECURITY_SCOPE.getBytes());\n+\t\t\tbos.write(IIH_HEADER_RESERVED.getBytes());\n+\t\t\t\n+\t\t\tbyte[] data = message.getBytes();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODI1MDgwNQ=="}, "originalCommit": {"oid": "7767a892d31c7e334c36e9409e181442e2e8ca50"}, "originalPosition": 126}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4NjE0NTkyOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/nl/nn/adapterframework/jms/JMSFacade.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMzowMDoyNlrOF-UlAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMzowNTo0NVrOF-UzFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg5MzE4Ng==", "bodyText": "Zijn al deze changes puur tabs die omgezet zijn naar spaties?", "url": "https://github.com/ibissource/iaf/pull/377#discussion_r400893186", "createdAt": "2020-03-31T13:00:26Z", "author": {"login": "nielsm5"}, "path": "core/src/main/java/nl/nn/adapterframework/jms/JMSFacade.java", "diffHunk": "@@ -81,38 +81,38 @@\n \tprivate boolean jmsTransacted = false;\n \tprivate String subscriberType = \"DURABLE\"; // DURABLE or TRANSIENT\n \n-\tprivate int ackMode = Session.AUTO_ACKNOWLEDGE;\n-\tprivate boolean persistent;\n-\tprivate long messageTimeToLive = 0;\n-\tprivate String destinationName;\n-\tprivate boolean useTopicFunctions = false;\n-\tprivate String authAlias;\n-\tprivate boolean lookupDestination = true;\n-\n-\tprivate String destinationType = \"QUEUE\"; // QUEUE or TOPIC\n-\n-\tprotected MessagingSource messagingSource;\n-\tprivate Destination destination;\n-\n-\tprivate Map<String, ConnectionFactory> proxiedConnectionFactories;\n-\tprivate Map<String, String> proxiedDestinationNames;\n-\n-\t// ---------------------------------------------------------------------\n-\t// Queue fields\n-\t// ---------------------------------------------------------------------\n-\tprivate String queueConnectionFactoryName;\n-\t// ---------------------------------------------------------------------\n-\t// Topic fields\n-\t// ---------------------------------------------------------------------\n-\tprivate String topicConnectionFactoryName;\n-\n-\t// the MessageSelector will provide filter functionality, as specified\n-\t// javax.jms.Message.\n-\tprivate String messageSelector = null;\n-\n-\tprivate boolean correlationIdToHex = false;\n-\tprivate String correlationIdToHexPrefix = \"ID:\";\n-\tprivate int correlationIdMaxLength = -1;\n+    private int ackMode = Session.AUTO_ACKNOWLEDGE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82819e00c846e0d3a2a16d6c904bb3013ee21d59"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg5Njc4OQ==", "bodyText": "Volgens mij is de merge niet helemaal goed gegaan of staat bij jou 'show whitespaces' uit. In de pr lijkt het nu alsof gigantisch veel veranderd is", "url": "https://github.com/ibissource/iaf/pull/377#discussion_r400896789", "createdAt": "2020-03-31T13:05:45Z", "author": {"login": "nielsm5"}, "path": "core/src/main/java/nl/nn/adapterframework/jms/JMSFacade.java", "diffHunk": "@@ -81,38 +81,38 @@\n \tprivate boolean jmsTransacted = false;\n \tprivate String subscriberType = \"DURABLE\"; // DURABLE or TRANSIENT\n \n-\tprivate int ackMode = Session.AUTO_ACKNOWLEDGE;\n-\tprivate boolean persistent;\n-\tprivate long messageTimeToLive = 0;\n-\tprivate String destinationName;\n-\tprivate boolean useTopicFunctions = false;\n-\tprivate String authAlias;\n-\tprivate boolean lookupDestination = true;\n-\n-\tprivate String destinationType = \"QUEUE\"; // QUEUE or TOPIC\n-\n-\tprotected MessagingSource messagingSource;\n-\tprivate Destination destination;\n-\n-\tprivate Map<String, ConnectionFactory> proxiedConnectionFactories;\n-\tprivate Map<String, String> proxiedDestinationNames;\n-\n-\t// ---------------------------------------------------------------------\n-\t// Queue fields\n-\t// ---------------------------------------------------------------------\n-\tprivate String queueConnectionFactoryName;\n-\t// ---------------------------------------------------------------------\n-\t// Topic fields\n-\t// ---------------------------------------------------------------------\n-\tprivate String topicConnectionFactoryName;\n-\n-\t// the MessageSelector will provide filter functionality, as specified\n-\t// javax.jms.Message.\n-\tprivate String messageSelector = null;\n-\n-\tprivate boolean correlationIdToHex = false;\n-\tprivate String correlationIdToHexPrefix = \"ID:\";\n-\tprivate int correlationIdMaxLength = -1;\n+    private int ackMode = Session.AUTO_ACKNOWLEDGE;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg5MzE4Ng=="}, "originalCommit": {"oid": "82819e00c846e0d3a2a16d6c904bb3013ee21d59"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4NjE1MDYzOnYy", "diffSide": "RIGHT", "path": "ibm/src/main/java/nl/nn/adapterframework/extensions/ibm/IMSSender.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMzowMTozM1rOF-UnwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMzowNjowMlrOF-Uz1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg5Mzg4OA==", "bodyText": "Copyright 2020 WeAreFrank!", "url": "https://github.com/ibissource/iaf/pull/377#discussion_r400893888", "createdAt": "2020-03-31T13:01:33Z", "author": {"login": "nielsm5"}, "path": "ibm/src/main/java/nl/nn/adapterframework/extensions/ibm/IMSSender.java", "diffHunk": "@@ -0,0 +1,214 @@\n+/*\n+   Copyright 2020 Integration Partners", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82819e00c846e0d3a2a16d6c904bb3013ee21d59"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg5Njk4Mw==", "bodyText": "(en natuurlijk ook op andere plekken :) )", "url": "https://github.com/ibissource/iaf/pull/377#discussion_r400896983", "createdAt": "2020-03-31T13:06:02Z", "author": {"login": "nielsm5"}, "path": "ibm/src/main/java/nl/nn/adapterframework/extensions/ibm/IMSSender.java", "diffHunk": "@@ -0,0 +1,214 @@\n+/*\n+   Copyright 2020 Integration Partners", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg5Mzg4OA=="}, "originalCommit": {"oid": "82819e00c846e0d3a2a16d6c904bb3013ee21d59"}, "originalPosition": 2}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 516, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}