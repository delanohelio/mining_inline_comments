{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzMzAxMjk5", "number": 1275, "title": "Fix #848 handle BLOBs as bytes instead of characters", "bodyText": "", "createdAt": "2020-11-18T16:18:11Z", "url": "https://github.com/ibissource/iaf/pull/1275", "merged": true, "mergeCommit": {"oid": "cfe350303067d3145fd68c988371fb49b5ee0760"}, "closed": true, "closedAt": "2020-11-19T16:58:09Z", "author": {"login": "gvanbrakel"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddwTLnAH2gAyNTIzMzAxMjk5Ojk2Njc4YjA1MmY0ZjhiMzdhOWVjMWQxYTQyYzkxZmQxNDczODhhYzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeDjqhAFqTUzNDQ5NTA3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "96678b052f4f8b37a9ec1d1a42c91fd147388ac8", "author": {"user": {"login": "gvanbrakel", "name": "Gerrit van Brakel"}}, "url": "https://github.com/ibissource/iaf/commit/96678b052f4f8b37a9ec1d1a42c91fd147388ac8", "committedDate": "2020-11-18T15:57:26Z", "message": "Fix #848 handle BLOBs as bytes instead of characters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56ba0fd590a702d10721e777a58e7c7807cfc768", "author": {"user": {"login": "gvanbrakel", "name": "Gerrit van Brakel"}}, "url": "https://github.com/ibissource/iaf/commit/56ba0fd590a702d10721e777a58e7c7807cfc768", "committedDate": "2020-11-18T16:12:57Z", "message": "Merge branch 'master' into\nfix_#848_Handle_Blobs_as_bytes_instead_of_characters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "457d3c37088111d83252cdaa773d9236d8b5208f", "author": {"user": {"login": "gvanbrakel", "name": "Gerrit van Brakel"}}, "url": "https://github.com/ibissource/iaf/commit/457d3c37088111d83252cdaa773d9236d8b5208f", "committedDate": "2020-11-18T16:48:09Z", "message": "Remove unused imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6467d64f3e9e54d4c18bfe7e20a1db2bb0a86e58", "author": {"user": {"login": "gvanbrakel", "name": "Gerrit van Brakel"}}, "url": "https://github.com/ibissource/iaf/commit/6467d64f3e9e54d4c18bfe7e20a1db2bb0a86e58", "committedDate": "2020-11-19T07:27:50Z", "message": "Add warning about base64 encoding when blobCharset is set empty"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c916f1485f425cebaca6570b2b435df7b287824", "author": {"user": {"login": "gvanbrakel", "name": "Gerrit van Brakel"}}, "url": "https://github.com/ibissource/iaf/commit/3c916f1485f425cebaca6570b2b435df7b287824", "committedDate": "2020-11-19T07:41:21Z", "message": "Add test for returning blob directly from sender"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a2c2182b0cf8da3e7e7e36feec38235483062f3", "author": {"user": {"login": "gvanbrakel", "name": "Gerrit van Brakel"}}, "url": "https://github.com/ibissource/iaf/commit/5a2c2182b0cf8da3e7e7e36feec38235483062f3", "committedDate": "2020-11-19T08:20:53Z", "message": "remove unused imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MjY5NDM0", "url": "https://github.com/ibissource/iaf/pull/1275#pullrequestreview-534269434", "createdAt": "2020-11-19T10:17:49Z", "commit": {"oid": "5a2c2182b0cf8da3e7e7e36feec38235483062f3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMDoxNzo0OVrOH2WAEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMDozNTozMlrOH2WsYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc0NTYxOA==", "bodyText": "Graag even een stukje commentaar. Dit moet je niet op de maandag ochtend tegenkomen...", "url": "https://github.com/ibissource/iaf/pull/1275#discussion_r526745618", "createdAt": "2020-11-19T10:17:49Z", "author": {"login": "nielsm5"}, "path": "core/src/main/java/nl/nn/adapterframework/util/JdbcUtil.java", "diffHunk": "@@ -345,7 +346,7 @@ public static String getBlobAsString(final IDbmsSupport dbmsSupport, final Resul\n \t\t\tthrow e;\n \t\t}\n \t}\n-\tpublic static String getBlobAsString(final IDbmsSupport dbmsSupport, final ResultSet rs, String column, String charset, boolean xmlEncode, boolean blobIsCompressed, boolean blobSmartGet, boolean encodeBlobBase64) throws IOException, JdbcException, SQLException, JMSException {\n+\tpublic static String getBlobAsString(final IDbmsSupport dbmsSupport, final ResultSet rs, String column, String charset, boolean xmlEncode, boolean blobIsCompressed, boolean blobSmartGet, boolean encodeBlobBase64) throws IOException, JdbcException, SQLException {\n \t\ttry (InputStream blobStream = getBlobInputStream(dbmsSupport, rs, column, blobIsCompressed)) {\n \t\t\treturn getBlobAsString(blobStream, column, charset, xmlEncode, blobSmartGet, encodeBlobBase64);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a2c2182b0cf8da3e7e7e36feec38235483062f3"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc0NTcyMA==", "bodyText": "Ik denk dat de xmlEncode weg kan!", "url": "https://github.com/ibissource/iaf/pull/1275#discussion_r526745720", "createdAt": "2020-11-19T10:18:00Z", "author": {"login": "nielsm5"}, "path": "core/src/main/java/nl/nn/adapterframework/util/JdbcUtil.java", "diffHunk": "@@ -357,7 +358,7 @@ public static String getBlobAsString(final IDbmsSupport dbmsSupport, final Resul\n \t\t\tthrow e;\n \t\t}\n \t}\n-\tpublic static String getBlobAsString(final InputStream blobIntputStream, String column, String charset, boolean xmlEncode, boolean blobSmartGet, boolean encodeBlobBase64) throws IOException, JdbcException, SQLException, JMSException {\n+\tpublic static String getBlobAsString(final InputStream blobIntputStream, String column, String charset, boolean xmlEncode, boolean blobSmartGet, boolean encodeBlobBase64) throws IOException, JdbcException, SQLException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a2c2182b0cf8da3e7e7e36feec38235483062f3"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc0NzQ5Mw==", "bodyText": "Volgens Gerrit moet deze final weg", "url": "https://github.com/ibissource/iaf/pull/1275#discussion_r526747493", "createdAt": "2020-11-19T10:20:43Z", "author": {"login": "nielsm5"}, "path": "core/src/main/java/nl/nn/adapterframework/jdbc/FixedQuerySender.java", "diffHunk": "@@ -118,11 +120,22 @@ protected void closeStatementSet(QueryExecutionContext statementSet, IPipeLineSe\n \n \t@Override\n \tpublic Message sendMessage(QueryExecutionContext blockHandle, Message message, IPipeLineSession session) throws SenderException, TimeOutException {\n-\t\treturn executeStatementSet(blockHandle, message, session);\n+\t\treturn executeStatementSet(blockHandle, message, session, null).getResult();\n \t}\n \n \t@Override\n-\tprotected final Message sendMessageOnConnection(Connection connection, Message message, IPipeLineSession session) throws SenderException, TimeOutException {\n+\t// implements IStreamingSender.sendMessage(), currently without support for streaming the results to the next outputstream provider.\n+\tpublic final PipeRunResult sendMessage(Message message, IPipeLineSession session, IForwardTarget next) throws SenderException, TimeOutException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a2c2182b0cf8da3e7e7e36feec38235483062f3"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc0OTEzOQ==", "bodyText": "Deze deprecated maken?", "url": "https://github.com/ibissource/iaf/pull/1275#discussion_r526749139", "createdAt": "2020-11-19T10:23:18Z", "author": {"login": "nielsm5"}, "path": "core/src/main/java/nl/nn/adapterframework/jdbc/JdbcListener.java", "diffHunk": "@@ -402,31 +409,31 @@ public String getMessageField() {\n \t\treturn messageField;\n \t}\n \n-\t@IbisDoc({\"Type of the field containing the message data: either String, clob or blob\", \"<i>String</i>\"})\n+\t@IbisDoc({\"3\", \"Type of the field containing the message data: either String, clob or blob\", \"<i>String</i>\"})\n \tpublic void setMessageFieldType(String string) {\n \t\tmessageFieldType = string;\n \t}\n \tpublic String getMessageFieldType() {\n \t\treturn messageFieldType;\n \t}\n \n-\t@IbisDoc({\"Charset used to read blobs\", \"UTF-8\"})\n-\tpublic void setBlobCharset(String string) {\n-\t\tblobCharset = string;\n-\t}\n-\tpublic String getBlobCharset() {\n-\t\treturn blobCharset;\n-\t}\n-\n-\t@IbisDoc({\"Controls whether blobdata is considered stored compressed in the database\", \"true\"})\n+\t@IbisDoc({\"4\", \"Controls whether BLOB is considered stored compressed in the database\", \"true\"})\n \tpublic void setBlobsCompressed(boolean b) {\n \t\tblobsCompressed = b;\n \t}\n \tpublic boolean isBlobsCompressed() {\n \t\treturn blobsCompressed;\n \t}\n \n-\t@IbisDoc({\"Controls automatically whether blobdata is stored compressed and/or serialized in the database\", \"false\"})\n+\t@IbisDoc({\"5\", \"Charset used to read BLOB. When specified, then the BLOB will be converted into a string\", \"\"})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a2c2182b0cf8da3e7e7e36feec38235483062f3"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc1MTg1Ng==", "bodyText": "!empty van maken, zodat de code iets duidelijker wordt.", "url": "https://github.com/ibissource/iaf/pull/1275#discussion_r526751856", "createdAt": "2020-11-19T10:27:31Z", "author": {"login": "nielsm5"}, "path": "core/src/main/java/nl/nn/adapterframework/jdbc/JdbcQuerySenderBase.java", "diffHunk": "@@ -328,25 +325,25 @@ protected Message executeStatementSet(QueryExecutionContext queryExecutionContex\n \t\t\t\t\tHttpServletResponse response = (HttpServletResponse) session.get(IPipeLineSession.HTTP_RESPONSE_KEY);\n \t\t\t\t\tString contentType = (String) session.get(\"contentType\");\n \t\t\t\t\tString contentDisposition = (String) session.get(\"contentDisposition\");\n-\t\t\t\t\treturn executeSelectQuery(statement,blobSessionVar,clobSessionVar, response, contentType, contentDisposition);\n+\t\t\t\t\treturn executeSelectQuery(statement,blobSessionVar,clobSessionVar, response, contentType, contentDisposition, session, next);\n \t\t\t\t} else {\n-\t\t\t\t\treturn executeSelectQuery(statement,blobSessionVar,clobSessionVar);\n+\t\t\t\t\treturn executeSelectQuery(statement,blobSessionVar,clobSessionVar, session, next);\n \t\t\t\t}\n \t\t\t} \n \t\t\tif (\"updateBlob\".equalsIgnoreCase(queryExecutionContext.getQueryType())) {\n \t\t\t\tif (StringUtils.isEmpty(getBlobSessionKey())) {\n-\t\t\t\t\treturn executeUpdateBlobQuery(statement,message.asInputStream());\n+\t\t\t\t\treturn new PipeRunResult(null, executeUpdateBlobQuery(statement, message));\n \t\t\t\t} \n-\t\t\t\treturn executeUpdateBlobQuery(statement,session==null?null:session.get(getBlobSessionKey()));\n+\t\t\t\treturn new PipeRunResult(null, executeUpdateBlobQuery(statement,session==null?null:Message.asMessage(session.get(getBlobSessionKey()))));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a2c2182b0cf8da3e7e7e36feec38235483062f3"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc1MjYzMA==", "bodyText": "overal bij een leeg message Message.nullMessage()", "url": "https://github.com/ibissource/iaf/pull/1275#discussion_r526752630", "createdAt": "2020-11-19T10:28:47Z", "author": {"login": "nielsm5"}, "path": "core/src/main/java/nl/nn/adapterframework/jdbc/JdbcQuerySenderBase.java", "diffHunk": "@@ -458,54 +455,56 @@ protected Message getResult(ResultSet resultset) throws JdbcException, SQLExcept\n \t}\n \n \tprotected Message getResult(ResultSet resultset, Object blobSessionVar, Object clobSessionVar) throws JdbcException, SQLException, IOException, JMSException {\n-\t\treturn getResult(resultset, blobSessionVar, clobSessionVar, null, null, null);\n+\t\treturn getResult(resultset, blobSessionVar, clobSessionVar, null, null, null, null, null).getResult();\n \t}\n \n-\tprotected Message getResult(ResultSet resultset, Object blobSessionVar, Object clobSessionVar, HttpServletResponse response, String contentType, String contentDisposition) throws JdbcException, SQLException, IOException, JMSException {\n-\t\tString result=null;\n+\tprotected PipeRunResult getResult(ResultSet resultset, Object blobSessionVar, Object clobSessionVar, HttpServletResponse response, String contentType, String contentDisposition, IPipeLineSession session, IForwardTarget next) throws JdbcException, SQLException, IOException {\n \t\tif (isScalar()) {\n+\t\t\tString result=null;\n \t\t\tif (resultset.next()) {\n \t\t\t\t//result = resultset.getString(1);\n \t\t\t\tResultSetMetaData rsmeta = resultset.getMetaData();\n \t\t\t\tint numberOfColumns = rsmeta.getColumnCount();\n \t\t\t\tif(numberOfColumns > 1) {\n-\t\t\t\t\tlog.warn(getLogPrefix() + \"has the [scalar]=true. However, the resultset contains [\"+numberOfColumns+\"] columns. Consider optimizing the query.\");\n+\t\t\t\t\tlog.warn(getLogPrefix() + \"has set scalar=true. However, the resultset contains [\"+numberOfColumns+\"] columns. Consider optimizing the query.\");\n \t\t\t\t}\n \t\t\t\tif (JdbcUtil.isBlobType(resultset, 1, rsmeta)) {\n-\t\t\t\t\tif (response==null) {\n-\t\t\t\t\t\tif (blobSessionVar!=null) {\n-\t\t\t\t\t\t\tJdbcUtil.streamBlob(getDbmsSupport(), resultset, 1, getBlobCharset(), isBlobsCompressed(), getBlobBase64Direction(), blobSessionVar, isCloseOutputstreamOnExit());\n-\t\t\t\t\t\t\treturn new Message(\"\");\n-\t\t\t\t\t\t}\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tInputStream inputStream = JdbcUtil.getBlobInputStream(getDbmsSupport(), resultset, 1, isBlobsCompressed());\n+\t\t\t\t\tif (response!=null) {\n \t\t\t\t\t\tif (StringUtils.isNotEmpty(contentType)) {\n \t\t\t\t\t\t\tresponse.setHeader(\"Content-Type\", contentType); \n \t\t\t\t\t\t}\n \t\t\t\t\t\tif (StringUtils.isNotEmpty(contentDisposition)) {\n \t\t\t\t\t\t\tresponse.setHeader(\"Content-Disposition\", contentDisposition); \n \t\t\t\t\t\t}\n-\n-\t\t\t\t\t\tif(getBlobBase64Direction() != null) {\n-\t\t\t\t\t\t\tif (\"decode\".equalsIgnoreCase(getBlobBase64Direction())) {\n-\t\t\t\t\t\t\t\tinputStream = new Base64InputStream (inputStream);\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\telse if (\"encode\".equalsIgnoreCase(getBlobBase64Direction())) {\n-\t\t\t\t\t\t\t\tinputStream = new Base64InputStream (inputStream, true);\n-\t\t\t\t\t\t\t}\n+\t\t\t\t\t\tJdbcUtil.streamBlob(getDbmsSupport(), resultset, 1, getBlobCharset(), isBlobsCompressed(), getBlobBase64Direction(), response.getOutputStream(), isCloseOutputstreamOnExit());\n+\t\t\t\t\t\treturn new PipeRunResult(null, new Message(\"\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a2c2182b0cf8da3e7e7e36feec38235483062f3"}, "originalPosition": 171}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc1Njk2MQ==", "bodyText": "has set scalar=true and the query returned more than 1 row.", "url": "https://github.com/ibissource/iaf/pull/1275#discussion_r526756961", "createdAt": "2020-11-19T10:35:32Z", "author": {"login": "nielsm5"}, "path": "core/src/main/java/nl/nn/adapterframework/jdbc/JdbcQuerySenderBase.java", "diffHunk": "@@ -520,24 +519,29 @@ else if (\"encode\".equalsIgnoreCase(getBlobBase64Direction())) {\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t\tif (resultset.next()) {\n-\t\t\t\t\tlog.warn(getLogPrefix() + \"has the [scalar]=true. However, the query returns more than 1 row. Consider optimizing the query.\");\n+\t\t\t\t\tlog.warn(getLogPrefix() + \"has set scalar=true. However, the query returns more than 1 row. Consider optimizing the query.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a2c2182b0cf8da3e7e7e36feec38235483062f3"}, "originalPosition": 216}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c60f8ea0473439710228cdb9374b60010d71bba", "author": {"user": {"login": "gvanbrakel", "name": "Gerrit van Brakel"}}, "url": "https://github.com/ibissource/iaf/commit/2c60f8ea0473439710228cdb9374b60010d71bba", "committedDate": "2020-11-19T11:20:31Z", "message": "Fix issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9628ad2a8567fede570151f78e87a11f29818fd5", "author": {"user": {"login": "gvanbrakel", "name": "Gerrit van Brakel"}}, "url": "https://github.com/ibissource/iaf/commit/9628ad2a8567fede570151f78e87a11f29818fd5", "committedDate": "2020-11-19T13:34:54Z", "message": "Fix streaming output handling of BLOBs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0NDk1MDc1", "url": "https://github.com/ibissource/iaf/pull/1275#pullrequestreview-534495075", "createdAt": "2020-11-19T14:23:38Z", "commit": {"oid": "9628ad2a8567fede570151f78e87a11f29818fd5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1064, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}