{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0ODk2MTg1", "number": 1156, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwNzo1MzowOFrOEvMDOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwNzo1MzowOFrOEvMDOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3OTE1OTYzOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/nl/nn/adapterframework/receivers/ReceiverBase.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwNzo1MzowOFrOHkB7Hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwODowMDoyMFrOHkCMYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU0MjMwMg==", "bodyText": "Eigenlijk zou ik verwachten dat de txManager slimmer zou zijn, dwz dat hij in zijn commit methode eerst controlleert of hij marked as rollback is.", "url": "https://github.com/ibissource/iaf/pull/1156#discussion_r507542302", "createdAt": "2020-10-19T07:53:08Z", "author": {"login": "nielsm5"}, "path": "core/src/main/java/nl/nn/adapterframework/receivers/ReceiverBase.java", "diffHunk": "@@ -1033,28 +1035,34 @@ public void retryMessage(String messageId) throws ListenerException {\n \t\tTransactionStatus txStatus = itx.getStatus();\n \t\tSerializable msg=null;\n \t\tITransactionalStorage<Serializable> errorStorage = getErrorStorage();\n+\t\tthreadContext.put(\"retry\", \"true\");\n \t\ttry {\n \t\t\ttry {\n-\t\t\t\tmsg = errorStorage.getMessage(messageId);\n+\t\t\t\tmsg = errorStorage.getMessage(storageKey);\n \t\t\t\tprocessRawMessage(msg, threadContext, -1, true);\n \t\t\t} catch (Throwable t) {\n \t\t\t\ttxStatus.setRollbackOnly();\n \t\t\t\tthrow new ListenerException(t);\n \t\t\t} finally {\n-\t\t\t\ttxManager.commit(txStatus);\n+\t\t\t\tif (txStatus.isRollbackOnly()) {\n+\t\t\t\t\ttxManager.rollback(txStatus);\n+\t\t\t\t} else {\n+\t\t\t\t\ttxManager.commit(txStatus);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37a3227c755fd40b1e8f0e4e10f245e19bbe3b61"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU0NjcyMg==", "bodyText": "Dat doet hij ook wel, maar als dat dan zo is, dan rolt hij terug en zegt dat de rollback unexpected was", "url": "https://github.com/ibissource/iaf/pull/1156#discussion_r507546722", "createdAt": "2020-10-19T08:00:20Z", "author": {"login": "gvanbrakel"}, "path": "core/src/main/java/nl/nn/adapterframework/receivers/ReceiverBase.java", "diffHunk": "@@ -1033,28 +1035,34 @@ public void retryMessage(String messageId) throws ListenerException {\n \t\tTransactionStatus txStatus = itx.getStatus();\n \t\tSerializable msg=null;\n \t\tITransactionalStorage<Serializable> errorStorage = getErrorStorage();\n+\t\tthreadContext.put(\"retry\", \"true\");\n \t\ttry {\n \t\t\ttry {\n-\t\t\t\tmsg = errorStorage.getMessage(messageId);\n+\t\t\t\tmsg = errorStorage.getMessage(storageKey);\n \t\t\t\tprocessRawMessage(msg, threadContext, -1, true);\n \t\t\t} catch (Throwable t) {\n \t\t\t\ttxStatus.setRollbackOnly();\n \t\t\t\tthrow new ListenerException(t);\n \t\t\t} finally {\n-\t\t\t\ttxManager.commit(txStatus);\n+\t\t\t\tif (txStatus.isRollbackOnly()) {\n+\t\t\t\t\ttxManager.rollback(txStatus);\n+\t\t\t\t} else {\n+\t\t\t\t\ttxManager.commit(txStatus);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU0MjMwMg=="}, "originalCommit": {"oid": "37a3227c755fd40b1e8f0e4e10f245e19bbe3b61"}, "originalPosition": 63}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 575, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}