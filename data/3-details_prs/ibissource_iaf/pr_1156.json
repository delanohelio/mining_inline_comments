{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0ODk2MTg1", "number": 1156, "title": "Fix #1151 Use original messageid when resending message", "bodyText": "", "createdAt": "2020-10-16T14:36:50Z", "url": "https://github.com/ibissource/iaf/pull/1156", "merged": true, "mergeCommit": {"oid": "4dbeed5c9f277066bd63b012572620d0d71527ce"}, "closed": true, "closedAt": "2020-10-19T13:20:32Z", "author": {"login": "gvanbrakel"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdTHW56gH2gAyNTA0ODk2MTg1OjAzYzU4ZDNlMzQxYjg4ZTNiZTZmMGEzMjJlM2JkZjk2MTY2OWZhOWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdT_Ze7gFqTUxMTQ5NjI0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "03c58d3e341b88e3be6f0a322e3bdf961669fa9a", "author": {"user": {"login": "gvanbrakel", "name": "Gerrit van Brakel"}}, "url": "https://github.com/ibissource/iaf/commit/03c58d3e341b88e3be6f0a322e3bdf961669fa9a", "committedDate": "2020-10-16T14:36:09Z", "message": "Use original messageid when resending message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f54406ae0fa0feb353ab9ae0bc6db8a668b6ae8", "author": {"user": {"login": "gvanbrakel", "name": "Gerrit van Brakel"}}, "url": "https://github.com/ibissource/iaf/commit/1f54406ae0fa0feb353ab9ae0bc6db8a668b6ae8", "committedDate": "2020-10-16T14:57:36Z", "message": "improve legibility"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f38bdc25439ce12a3fbb4a7ed0f15055ca1e1f6", "author": {"user": {"login": "gvanbrakel", "name": "Gerrit van Brakel"}}, "url": "https://github.com/ibissource/iaf/commit/6f38bdc25439ce12a3fbb4a7ed0f15055ca1e1f6", "committedDate": "2020-10-16T15:12:11Z", "message": "Mark retries with session variable retry=true"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37a3227c755fd40b1e8f0e4e10f245e19bbe3b61", "author": {"user": {"login": "gvanbrakel", "name": "Gerrit van Brakel"}}, "url": "https://github.com/ibissource/iaf/commit/37a3227c755fd40b1e8f0e4e10f245e19bbe3b61", "committedDate": "2020-10-19T06:40:43Z", "message": "Rename storageMessageId into storageKey"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExNDk1ODIy", "url": "https://github.com/ibissource/iaf/pull/1156#pullrequestreview-511495822", "createdAt": "2020-10-19T07:53:08Z", "commit": {"oid": "37a3227c755fd40b1e8f0e4e10f245e19bbe3b61"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwNzo1MzowOFrOHkB7Hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwNzo1MzowOFrOHkB7Hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU0MjMwMg==", "bodyText": "Eigenlijk zou ik verwachten dat de txManager slimmer zou zijn, dwz dat hij in zijn commit methode eerst controlleert of hij marked as rollback is.", "url": "https://github.com/ibissource/iaf/pull/1156#discussion_r507542302", "createdAt": "2020-10-19T07:53:08Z", "author": {"login": "nielsm5"}, "path": "core/src/main/java/nl/nn/adapterframework/receivers/ReceiverBase.java", "diffHunk": "@@ -1033,28 +1035,34 @@ public void retryMessage(String messageId) throws ListenerException {\n \t\tTransactionStatus txStatus = itx.getStatus();\n \t\tSerializable msg=null;\n \t\tITransactionalStorage<Serializable> errorStorage = getErrorStorage();\n+\t\tthreadContext.put(\"retry\", \"true\");\n \t\ttry {\n \t\t\ttry {\n-\t\t\t\tmsg = errorStorage.getMessage(messageId);\n+\t\t\t\tmsg = errorStorage.getMessage(storageKey);\n \t\t\t\tprocessRawMessage(msg, threadContext, -1, true);\n \t\t\t} catch (Throwable t) {\n \t\t\t\ttxStatus.setRollbackOnly();\n \t\t\t\tthrow new ListenerException(t);\n \t\t\t} finally {\n-\t\t\t\ttxManager.commit(txStatus);\n+\t\t\t\tif (txStatus.isRollbackOnly()) {\n+\t\t\t\t\ttxManager.rollback(txStatus);\n+\t\t\t\t} else {\n+\t\t\t\t\ttxManager.commit(txStatus);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37a3227c755fd40b1e8f0e4e10f245e19bbe3b61"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExNDk2MjQ0", "url": "https://github.com/ibissource/iaf/pull/1156#pullrequestreview-511496244", "createdAt": "2020-10-19T07:53:39Z", "commit": {"oid": "37a3227c755fd40b1e8f0e4e10f245e19bbe3b61"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 989, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}