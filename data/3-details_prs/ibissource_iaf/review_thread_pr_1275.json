{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzMzAxMjk5", "number": 1275, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMDoxNzo0OVrOE6-Gzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMDozNTozMlrOE6-jXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMjcwNDE1OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/nl/nn/adapterframework/util/JdbcUtil.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMDoxNzo0OVrOH2WAEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMDoxNzo0OVrOH2WAEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc0NTYxOA==", "bodyText": "Graag even een stukje commentaar. Dit moet je niet op de maandag ochtend tegenkomen...", "url": "https://github.com/ibissource/iaf/pull/1275#discussion_r526745618", "createdAt": "2020-11-19T10:17:49Z", "author": {"login": "nielsm5"}, "path": "core/src/main/java/nl/nn/adapterframework/util/JdbcUtil.java", "diffHunk": "@@ -345,7 +346,7 @@ public static String getBlobAsString(final IDbmsSupport dbmsSupport, final Resul\n \t\t\tthrow e;\n \t\t}\n \t}\n-\tpublic static String getBlobAsString(final IDbmsSupport dbmsSupport, final ResultSet rs, String column, String charset, boolean xmlEncode, boolean blobIsCompressed, boolean blobSmartGet, boolean encodeBlobBase64) throws IOException, JdbcException, SQLException, JMSException {\n+\tpublic static String getBlobAsString(final IDbmsSupport dbmsSupport, final ResultSet rs, String column, String charset, boolean xmlEncode, boolean blobIsCompressed, boolean blobSmartGet, boolean encodeBlobBase64) throws IOException, JdbcException, SQLException {\n \t\ttry (InputStream blobStream = getBlobInputStream(dbmsSupport, rs, column, blobIsCompressed)) {\n \t\t\treturn getBlobAsString(blobStream, column, charset, xmlEncode, blobSmartGet, encodeBlobBase64);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a2c2182b0cf8da3e7e7e36feec38235483062f3"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMjcwNDY5OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/nl/nn/adapterframework/util/JdbcUtil.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMDoxODowMFrOH2WAeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMDoxODowMFrOH2WAeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc0NTcyMA==", "bodyText": "Ik denk dat de xmlEncode weg kan!", "url": "https://github.com/ibissource/iaf/pull/1275#discussion_r526745720", "createdAt": "2020-11-19T10:18:00Z", "author": {"login": "nielsm5"}, "path": "core/src/main/java/nl/nn/adapterframework/util/JdbcUtil.java", "diffHunk": "@@ -357,7 +358,7 @@ public static String getBlobAsString(final IDbmsSupport dbmsSupport, final Resul\n \t\t\tthrow e;\n \t\t}\n \t}\n-\tpublic static String getBlobAsString(final InputStream blobIntputStream, String column, String charset, boolean xmlEncode, boolean blobSmartGet, boolean encodeBlobBase64) throws IOException, JdbcException, SQLException, JMSException {\n+\tpublic static String getBlobAsString(final InputStream blobIntputStream, String column, String charset, boolean xmlEncode, boolean blobSmartGet, boolean encodeBlobBase64) throws IOException, JdbcException, SQLException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a2c2182b0cf8da3e7e7e36feec38235483062f3"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMjcxNTkxOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/nl/nn/adapterframework/jdbc/FixedQuerySender.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMDoyMDo0M1rOH2WHZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMDoyMDo0M1rOH2WHZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc0NzQ5Mw==", "bodyText": "Volgens Gerrit moet deze final weg", "url": "https://github.com/ibissource/iaf/pull/1275#discussion_r526747493", "createdAt": "2020-11-19T10:20:43Z", "author": {"login": "nielsm5"}, "path": "core/src/main/java/nl/nn/adapterframework/jdbc/FixedQuerySender.java", "diffHunk": "@@ -118,11 +120,22 @@ protected void closeStatementSet(QueryExecutionContext statementSet, IPipeLineSe\n \n \t@Override\n \tpublic Message sendMessage(QueryExecutionContext blockHandle, Message message, IPipeLineSession session) throws SenderException, TimeOutException {\n-\t\treturn executeStatementSet(blockHandle, message, session);\n+\t\treturn executeStatementSet(blockHandle, message, session, null).getResult();\n \t}\n \n \t@Override\n-\tprotected final Message sendMessageOnConnection(Connection connection, Message message, IPipeLineSession session) throws SenderException, TimeOutException {\n+\t// implements IStreamingSender.sendMessage(), currently without support for streaming the results to the next outputstream provider.\n+\tpublic final PipeRunResult sendMessage(Message message, IPipeLineSession session, IForwardTarget next) throws SenderException, TimeOutException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a2c2182b0cf8da3e7e7e36feec38235483062f3"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMjcyNjA5OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/nl/nn/adapterframework/jdbc/JdbcListener.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMDoyMzoxOFrOH2WN0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMDoyMzoxOFrOH2WN0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc0OTEzOQ==", "bodyText": "Deze deprecated maken?", "url": "https://github.com/ibissource/iaf/pull/1275#discussion_r526749139", "createdAt": "2020-11-19T10:23:18Z", "author": {"login": "nielsm5"}, "path": "core/src/main/java/nl/nn/adapterframework/jdbc/JdbcListener.java", "diffHunk": "@@ -402,31 +409,31 @@ public String getMessageField() {\n \t\treturn messageField;\n \t}\n \n-\t@IbisDoc({\"Type of the field containing the message data: either String, clob or blob\", \"<i>String</i>\"})\n+\t@IbisDoc({\"3\", \"Type of the field containing the message data: either String, clob or blob\", \"<i>String</i>\"})\n \tpublic void setMessageFieldType(String string) {\n \t\tmessageFieldType = string;\n \t}\n \tpublic String getMessageFieldType() {\n \t\treturn messageFieldType;\n \t}\n \n-\t@IbisDoc({\"Charset used to read blobs\", \"UTF-8\"})\n-\tpublic void setBlobCharset(String string) {\n-\t\tblobCharset = string;\n-\t}\n-\tpublic String getBlobCharset() {\n-\t\treturn blobCharset;\n-\t}\n-\n-\t@IbisDoc({\"Controls whether blobdata is considered stored compressed in the database\", \"true\"})\n+\t@IbisDoc({\"4\", \"Controls whether BLOB is considered stored compressed in the database\", \"true\"})\n \tpublic void setBlobsCompressed(boolean b) {\n \t\tblobsCompressed = b;\n \t}\n \tpublic boolean isBlobsCompressed() {\n \t\treturn blobsCompressed;\n \t}\n \n-\t@IbisDoc({\"Controls automatically whether blobdata is stored compressed and/or serialized in the database\", \"false\"})\n+\t@IbisDoc({\"5\", \"Charset used to read BLOB. When specified, then the BLOB will be converted into a string\", \"\"})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a2c2182b0cf8da3e7e7e36feec38235483062f3"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMjc0MzUyOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/nl/nn/adapterframework/jdbc/JdbcQuerySenderBase.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMDoyNzozMVrOH2WYcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMDoyNzozMVrOH2WYcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc1MTg1Ng==", "bodyText": "!empty van maken, zodat de code iets duidelijker wordt.", "url": "https://github.com/ibissource/iaf/pull/1275#discussion_r526751856", "createdAt": "2020-11-19T10:27:31Z", "author": {"login": "nielsm5"}, "path": "core/src/main/java/nl/nn/adapterframework/jdbc/JdbcQuerySenderBase.java", "diffHunk": "@@ -328,25 +325,25 @@ protected Message executeStatementSet(QueryExecutionContext queryExecutionContex\n \t\t\t\t\tHttpServletResponse response = (HttpServletResponse) session.get(IPipeLineSession.HTTP_RESPONSE_KEY);\n \t\t\t\t\tString contentType = (String) session.get(\"contentType\");\n \t\t\t\t\tString contentDisposition = (String) session.get(\"contentDisposition\");\n-\t\t\t\t\treturn executeSelectQuery(statement,blobSessionVar,clobSessionVar, response, contentType, contentDisposition);\n+\t\t\t\t\treturn executeSelectQuery(statement,blobSessionVar,clobSessionVar, response, contentType, contentDisposition, session, next);\n \t\t\t\t} else {\n-\t\t\t\t\treturn executeSelectQuery(statement,blobSessionVar,clobSessionVar);\n+\t\t\t\t\treturn executeSelectQuery(statement,blobSessionVar,clobSessionVar, session, next);\n \t\t\t\t}\n \t\t\t} \n \t\t\tif (\"updateBlob\".equalsIgnoreCase(queryExecutionContext.getQueryType())) {\n \t\t\t\tif (StringUtils.isEmpty(getBlobSessionKey())) {\n-\t\t\t\t\treturn executeUpdateBlobQuery(statement,message.asInputStream());\n+\t\t\t\t\treturn new PipeRunResult(null, executeUpdateBlobQuery(statement, message));\n \t\t\t\t} \n-\t\t\t\treturn executeUpdateBlobQuery(statement,session==null?null:session.get(getBlobSessionKey()));\n+\t\t\t\treturn new PipeRunResult(null, executeUpdateBlobQuery(statement,session==null?null:Message.asMessage(session.get(getBlobSessionKey()))));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a2c2182b0cf8da3e7e7e36feec38235483062f3"}, "originalPosition": 101}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMjc0ODM0OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/nl/nn/adapterframework/jdbc/JdbcQuerySenderBase.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMDoyODo0N1rOH2Wbdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMDoyODo0N1rOH2Wbdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc1MjYzMA==", "bodyText": "overal bij een leeg message Message.nullMessage()", "url": "https://github.com/ibissource/iaf/pull/1275#discussion_r526752630", "createdAt": "2020-11-19T10:28:47Z", "author": {"login": "nielsm5"}, "path": "core/src/main/java/nl/nn/adapterframework/jdbc/JdbcQuerySenderBase.java", "diffHunk": "@@ -458,54 +455,56 @@ protected Message getResult(ResultSet resultset) throws JdbcException, SQLExcept\n \t}\n \n \tprotected Message getResult(ResultSet resultset, Object blobSessionVar, Object clobSessionVar) throws JdbcException, SQLException, IOException, JMSException {\n-\t\treturn getResult(resultset, blobSessionVar, clobSessionVar, null, null, null);\n+\t\treturn getResult(resultset, blobSessionVar, clobSessionVar, null, null, null, null, null).getResult();\n \t}\n \n-\tprotected Message getResult(ResultSet resultset, Object blobSessionVar, Object clobSessionVar, HttpServletResponse response, String contentType, String contentDisposition) throws JdbcException, SQLException, IOException, JMSException {\n-\t\tString result=null;\n+\tprotected PipeRunResult getResult(ResultSet resultset, Object blobSessionVar, Object clobSessionVar, HttpServletResponse response, String contentType, String contentDisposition, IPipeLineSession session, IForwardTarget next) throws JdbcException, SQLException, IOException {\n \t\tif (isScalar()) {\n+\t\t\tString result=null;\n \t\t\tif (resultset.next()) {\n \t\t\t\t//result = resultset.getString(1);\n \t\t\t\tResultSetMetaData rsmeta = resultset.getMetaData();\n \t\t\t\tint numberOfColumns = rsmeta.getColumnCount();\n \t\t\t\tif(numberOfColumns > 1) {\n-\t\t\t\t\tlog.warn(getLogPrefix() + \"has the [scalar]=true. However, the resultset contains [\"+numberOfColumns+\"] columns. Consider optimizing the query.\");\n+\t\t\t\t\tlog.warn(getLogPrefix() + \"has set scalar=true. However, the resultset contains [\"+numberOfColumns+\"] columns. Consider optimizing the query.\");\n \t\t\t\t}\n \t\t\t\tif (JdbcUtil.isBlobType(resultset, 1, rsmeta)) {\n-\t\t\t\t\tif (response==null) {\n-\t\t\t\t\t\tif (blobSessionVar!=null) {\n-\t\t\t\t\t\t\tJdbcUtil.streamBlob(getDbmsSupport(), resultset, 1, getBlobCharset(), isBlobsCompressed(), getBlobBase64Direction(), blobSessionVar, isCloseOutputstreamOnExit());\n-\t\t\t\t\t\t\treturn new Message(\"\");\n-\t\t\t\t\t\t}\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tInputStream inputStream = JdbcUtil.getBlobInputStream(getDbmsSupport(), resultset, 1, isBlobsCompressed());\n+\t\t\t\t\tif (response!=null) {\n \t\t\t\t\t\tif (StringUtils.isNotEmpty(contentType)) {\n \t\t\t\t\t\t\tresponse.setHeader(\"Content-Type\", contentType); \n \t\t\t\t\t\t}\n \t\t\t\t\t\tif (StringUtils.isNotEmpty(contentDisposition)) {\n \t\t\t\t\t\t\tresponse.setHeader(\"Content-Disposition\", contentDisposition); \n \t\t\t\t\t\t}\n-\n-\t\t\t\t\t\tif(getBlobBase64Direction() != null) {\n-\t\t\t\t\t\t\tif (\"decode\".equalsIgnoreCase(getBlobBase64Direction())) {\n-\t\t\t\t\t\t\t\tinputStream = new Base64InputStream (inputStream);\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\telse if (\"encode\".equalsIgnoreCase(getBlobBase64Direction())) {\n-\t\t\t\t\t\t\t\tinputStream = new Base64InputStream (inputStream, true);\n-\t\t\t\t\t\t\t}\n+\t\t\t\t\t\tJdbcUtil.streamBlob(getDbmsSupport(), resultset, 1, getBlobCharset(), isBlobsCompressed(), getBlobBase64Direction(), response.getOutputStream(), isCloseOutputstreamOnExit());\n+\t\t\t\t\t\treturn new PipeRunResult(null, new Message(\"\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a2c2182b0cf8da3e7e7e36feec38235483062f3"}, "originalPosition": 171}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMjc3NzI1OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/nl/nn/adapterframework/jdbc/JdbcQuerySenderBase.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMDozNTozMlrOH2WsYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMDozNTozMlrOH2WsYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc1Njk2MQ==", "bodyText": "has set scalar=true and the query returned more than 1 row.", "url": "https://github.com/ibissource/iaf/pull/1275#discussion_r526756961", "createdAt": "2020-11-19T10:35:32Z", "author": {"login": "nielsm5"}, "path": "core/src/main/java/nl/nn/adapterframework/jdbc/JdbcQuerySenderBase.java", "diffHunk": "@@ -520,24 +519,29 @@ else if (\"encode\".equalsIgnoreCase(getBlobBase64Direction())) {\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t\tif (resultset.next()) {\n-\t\t\t\t\tlog.warn(getLogPrefix() + \"has the [scalar]=true. However, the query returns more than 1 row. Consider optimizing the query.\");\n+\t\t\t\t\tlog.warn(getLogPrefix() + \"has set scalar=true. However, the query returns more than 1 row. Consider optimizing the query.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a2c2182b0cf8da3e7e7e36feec38235483062f3"}, "originalPosition": 216}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 650, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}