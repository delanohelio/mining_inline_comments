{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzODYyODAw", "number": 9275, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQwOToxNzo1N1rOE0Sqyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMDoyMjoyNVrOE0UPlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIzMjY3Mjc1OnYy", "diffSide": "RIGHT", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/hierarchy/HierarchyMapper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQwOToxNzo1N1rOHr7-Cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMDoxNzoyMVrOHsULiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTgzMzM1NA==", "bodyText": "For the current implementation they are the result of DataProvider::getId(), aren't they? IdentifierProvider is not used currently in HierarchyMapper, so maybe better to refer to getId method?", "url": "https://github.com/vaadin/flow/pull/9275#discussion_r515833354", "createdAt": "2020-11-02T09:17:57Z", "author": {"login": "mshabarov"}, "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/hierarchy/HierarchyMapper.java", "diffHunk": "@@ -627,6 +627,18 @@ public void destroyAllData() {\n      * @return {@code true} if there is any expanded items.\n      */\n     public boolean hasExpandedItems() {\n-        return !expandedItemIds.isEmpty();\n+        return !expandedItems.isEmpty();\n+    }\n+\n+    /**\n+     * Returns the mappings between object-ids and their corresponding items for\n+     * the expanded items. Object ids are the result of applying data provider's\n+     * {@code IdentifierProvider} to the items.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ef33373560529c8f694deed074e0878f9c0610f"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzMDAyNw==", "bodyText": "Done.", "url": "https://github.com/vaadin/flow/pull/9275#discussion_r516230027", "createdAt": "2020-11-02T20:17:21Z", "author": {"login": "taefi"}, "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/hierarchy/HierarchyMapper.java", "diffHunk": "@@ -627,6 +627,18 @@ public void destroyAllData() {\n      * @return {@code true} if there is any expanded items.\n      */\n     public boolean hasExpandedItems() {\n-        return !expandedItemIds.isEmpty();\n+        return !expandedItems.isEmpty();\n+    }\n+\n+    /**\n+     * Returns the mappings between object-ids and their corresponding items for\n+     * the expanded items. Object ids are the result of applying data provider's\n+     * {@code IdentifierProvider} to the items.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTgzMzM1NA=="}, "originalCommit": {"oid": "2ef33373560529c8f694deed074e0878f9c0610f"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIzMjcxMzE4OnYy", "diffSide": "RIGHT", "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/hierarchy/HierarchyMapperWithDataTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQwOToyNzo1MVrOHr8VhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMDoxNzoyNFrOHsULng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTgzOTM2NA==", "bodyText": "Is this sout a leftover after debugging? Let's remove it", "url": "https://github.com/vaadin/flow/pull/9275#discussion_r515839364", "createdAt": "2020-11-02T09:27:51Z", "author": {"login": "mshabarov"}, "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/hierarchy/HierarchyMapperWithDataTest.java", "diffHunk": "@@ -224,6 +232,137 @@ public void fetchWithFilter() {\n         verifyFetchIsCorrect(expectedResult, range);\n     }\n \n+    @Test\n+    public void expandingItems_getExpandedItems_shouldReturnCorrectExpandedItems() {\n+\n+        TreeNode root = new TreeNode(\"root\", null);\n+        TreeNode first1 = new TreeNode(\"first-1\", root);\n+        TreeNode second1 = new TreeNode(\"second-1\", root);\n+        TreeNode first11 = new TreeNode(\"first-1-1\", first1);\n+        TreeNode second11 = new TreeNode(\"second-1-1\", second1);\n+\n+        HierarchicalDataProvider<TreeNode, Void> dataProvider =\n+                new AbstractBackEndHierarchicalDataProvider<TreeNode, Void>() {\n+\n+                    @Override\n+                    public int getChildCount(HierarchicalQuery<TreeNode, Void>\n+                                                     query) {\n+                        if (query.getParent() == null) {\n+                            return 2;\n+                        }\n+                        if (query.getParent().getName().equals(\"first-1\") ||\n+                            query.getParent().getName().equals(\"second-1\")) {\n+                            return 1;\n+                        }\n+                        return 0;\n+                    }\n+\n+                    @Override\n+                    public boolean hasChildren(TreeNode item) {\n+                        return item.getParent() == null ||\n+                                item.getName().equals(\"first-1\") ||\n+                                item.getName().equals(\"second-1\");\n+                    }\n+\n+                    @Override\n+                    protected Stream<TreeNode> fetchChildrenFromBackEnd(\n+                            HierarchicalQuery<TreeNode, Void> query) {\n+                        if (query.getParent() == null) {\n+                            return Arrays.stream(new TreeNode[]{\n+                                    first1, second1\n+                            });\n+                        }\n+                        if (query.getParent().getName().equals(\"first-1\")) {\n+                            return Arrays.stream(new TreeNode[]{first11});\n+                        }\n+                        if (query.getParent().getName().equals(\"second-1\")) {\n+                            return Arrays.stream(new TreeNode[]{second11});\n+                        }\n+                        return Stream.<TreeNode>builder().build();\n+                    }\n+                };\n+\n+        HierarchyMapper<TreeNode, Void> hierarchyMapper = new HierarchyMapper<>(\n+                dataProvider\n+        );\n+\n+        Map<Object, TreeNode> expandedItems = hierarchyMapper.getExpandedItems();\n+        Assert.assertEquals(0L, expandedItems.keySet().size());\n+\n+        hierarchyMapper.expand(root);\n+        hierarchyMapper.expand(second1);\n+\n+        System.out.println(hierarchyMapper.getExpandedItems());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ef33373560529c8f694deed074e0878f9c0610f"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzMDA0Ng==", "bodyText": "How did I miss that?!\nDone.", "url": "https://github.com/vaadin/flow/pull/9275#discussion_r516230046", "createdAt": "2020-11-02T20:17:24Z", "author": {"login": "taefi"}, "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/hierarchy/HierarchyMapperWithDataTest.java", "diffHunk": "@@ -224,6 +232,137 @@ public void fetchWithFilter() {\n         verifyFetchIsCorrect(expectedResult, range);\n     }\n \n+    @Test\n+    public void expandingItems_getExpandedItems_shouldReturnCorrectExpandedItems() {\n+\n+        TreeNode root = new TreeNode(\"root\", null);\n+        TreeNode first1 = new TreeNode(\"first-1\", root);\n+        TreeNode second1 = new TreeNode(\"second-1\", root);\n+        TreeNode first11 = new TreeNode(\"first-1-1\", first1);\n+        TreeNode second11 = new TreeNode(\"second-1-1\", second1);\n+\n+        HierarchicalDataProvider<TreeNode, Void> dataProvider =\n+                new AbstractBackEndHierarchicalDataProvider<TreeNode, Void>() {\n+\n+                    @Override\n+                    public int getChildCount(HierarchicalQuery<TreeNode, Void>\n+                                                     query) {\n+                        if (query.getParent() == null) {\n+                            return 2;\n+                        }\n+                        if (query.getParent().getName().equals(\"first-1\") ||\n+                            query.getParent().getName().equals(\"second-1\")) {\n+                            return 1;\n+                        }\n+                        return 0;\n+                    }\n+\n+                    @Override\n+                    public boolean hasChildren(TreeNode item) {\n+                        return item.getParent() == null ||\n+                                item.getName().equals(\"first-1\") ||\n+                                item.getName().equals(\"second-1\");\n+                    }\n+\n+                    @Override\n+                    protected Stream<TreeNode> fetchChildrenFromBackEnd(\n+                            HierarchicalQuery<TreeNode, Void> query) {\n+                        if (query.getParent() == null) {\n+                            return Arrays.stream(new TreeNode[]{\n+                                    first1, second1\n+                            });\n+                        }\n+                        if (query.getParent().getName().equals(\"first-1\")) {\n+                            return Arrays.stream(new TreeNode[]{first11});\n+                        }\n+                        if (query.getParent().getName().equals(\"second-1\")) {\n+                            return Arrays.stream(new TreeNode[]{second11});\n+                        }\n+                        return Stream.<TreeNode>builder().build();\n+                    }\n+                };\n+\n+        HierarchyMapper<TreeNode, Void> hierarchyMapper = new HierarchyMapper<>(\n+                dataProvider\n+        );\n+\n+        Map<Object, TreeNode> expandedItems = hierarchyMapper.getExpandedItems();\n+        Assert.assertEquals(0L, expandedItems.keySet().size());\n+\n+        hierarchyMapper.expand(root);\n+        hierarchyMapper.expand(second1);\n+\n+        System.out.println(hierarchyMapper.getExpandedItems());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTgzOTM2NA=="}, "originalCommit": {"oid": "2ef33373560529c8f694deed074e0878f9c0610f"}, "originalPosition": 95}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIzMjcyNTA0OnYy", "diffSide": "RIGHT", "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/hierarchy/HierarchyMapperWithDataTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQwOTozMDo0MVrOHr8ceA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMDoxNzoyNlrOHsULrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg0MTE0NA==", "bodyText": "Good to add a Assert.assertNotNull(expandedItems); right away", "url": "https://github.com/vaadin/flow/pull/9275#discussion_r515841144", "createdAt": "2020-11-02T09:30:41Z", "author": {"login": "mshabarov"}, "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/hierarchy/HierarchyMapperWithDataTest.java", "diffHunk": "@@ -224,6 +232,137 @@ public void fetchWithFilter() {\n         verifyFetchIsCorrect(expectedResult, range);\n     }\n \n+    @Test\n+    public void expandingItems_getExpandedItems_shouldReturnCorrectExpandedItems() {\n+\n+        TreeNode root = new TreeNode(\"root\", null);\n+        TreeNode first1 = new TreeNode(\"first-1\", root);\n+        TreeNode second1 = new TreeNode(\"second-1\", root);\n+        TreeNode first11 = new TreeNode(\"first-1-1\", first1);\n+        TreeNode second11 = new TreeNode(\"second-1-1\", second1);\n+\n+        HierarchicalDataProvider<TreeNode, Void> dataProvider =\n+                new AbstractBackEndHierarchicalDataProvider<TreeNode, Void>() {\n+\n+                    @Override\n+                    public int getChildCount(HierarchicalQuery<TreeNode, Void>\n+                                                     query) {\n+                        if (query.getParent() == null) {\n+                            return 2;\n+                        }\n+                        if (query.getParent().getName().equals(\"first-1\") ||\n+                            query.getParent().getName().equals(\"second-1\")) {\n+                            return 1;\n+                        }\n+                        return 0;\n+                    }\n+\n+                    @Override\n+                    public boolean hasChildren(TreeNode item) {\n+                        return item.getParent() == null ||\n+                                item.getName().equals(\"first-1\") ||\n+                                item.getName().equals(\"second-1\");\n+                    }\n+\n+                    @Override\n+                    protected Stream<TreeNode> fetchChildrenFromBackEnd(\n+                            HierarchicalQuery<TreeNode, Void> query) {\n+                        if (query.getParent() == null) {\n+                            return Arrays.stream(new TreeNode[]{\n+                                    first1, second1\n+                            });\n+                        }\n+                        if (query.getParent().getName().equals(\"first-1\")) {\n+                            return Arrays.stream(new TreeNode[]{first11});\n+                        }\n+                        if (query.getParent().getName().equals(\"second-1\")) {\n+                            return Arrays.stream(new TreeNode[]{second11});\n+                        }\n+                        return Stream.<TreeNode>builder().build();\n+                    }\n+                };\n+\n+        HierarchyMapper<TreeNode, Void> hierarchyMapper = new HierarchyMapper<>(\n+                dataProvider\n+        );\n+\n+        Map<Object, TreeNode> expandedItems = hierarchyMapper.getExpandedItems();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ef33373560529c8f694deed074e0878f9c0610f"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzMDA2MQ==", "bodyText": "Done.", "url": "https://github.com/vaadin/flow/pull/9275#discussion_r516230061", "createdAt": "2020-11-02T20:17:26Z", "author": {"login": "taefi"}, "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/hierarchy/HierarchyMapperWithDataTest.java", "diffHunk": "@@ -224,6 +232,137 @@ public void fetchWithFilter() {\n         verifyFetchIsCorrect(expectedResult, range);\n     }\n \n+    @Test\n+    public void expandingItems_getExpandedItems_shouldReturnCorrectExpandedItems() {\n+\n+        TreeNode root = new TreeNode(\"root\", null);\n+        TreeNode first1 = new TreeNode(\"first-1\", root);\n+        TreeNode second1 = new TreeNode(\"second-1\", root);\n+        TreeNode first11 = new TreeNode(\"first-1-1\", first1);\n+        TreeNode second11 = new TreeNode(\"second-1-1\", second1);\n+\n+        HierarchicalDataProvider<TreeNode, Void> dataProvider =\n+                new AbstractBackEndHierarchicalDataProvider<TreeNode, Void>() {\n+\n+                    @Override\n+                    public int getChildCount(HierarchicalQuery<TreeNode, Void>\n+                                                     query) {\n+                        if (query.getParent() == null) {\n+                            return 2;\n+                        }\n+                        if (query.getParent().getName().equals(\"first-1\") ||\n+                            query.getParent().getName().equals(\"second-1\")) {\n+                            return 1;\n+                        }\n+                        return 0;\n+                    }\n+\n+                    @Override\n+                    public boolean hasChildren(TreeNode item) {\n+                        return item.getParent() == null ||\n+                                item.getName().equals(\"first-1\") ||\n+                                item.getName().equals(\"second-1\");\n+                    }\n+\n+                    @Override\n+                    protected Stream<TreeNode> fetchChildrenFromBackEnd(\n+                            HierarchicalQuery<TreeNode, Void> query) {\n+                        if (query.getParent() == null) {\n+                            return Arrays.stream(new TreeNode[]{\n+                                    first1, second1\n+                            });\n+                        }\n+                        if (query.getParent().getName().equals(\"first-1\")) {\n+                            return Arrays.stream(new TreeNode[]{first11});\n+                        }\n+                        if (query.getParent().getName().equals(\"second-1\")) {\n+                            return Arrays.stream(new TreeNode[]{second11});\n+                        }\n+                        return Stream.<TreeNode>builder().build();\n+                    }\n+                };\n+\n+        HierarchyMapper<TreeNode, Void> hierarchyMapper = new HierarchyMapper<>(\n+                dataProvider\n+        );\n+\n+        Map<Object, TreeNode> expandedItems = hierarchyMapper.getExpandedItems();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg0MTE0NA=="}, "originalCommit": {"oid": "2ef33373560529c8f694deed074e0878f9c0610f"}, "originalPosition": 89}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIzMjczNTE5OnYy", "diffSide": "RIGHT", "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/hierarchy/HierarchyMapperWithDataTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQwOTozMzoxMFrOHr8iTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMDoxNzoyOFrOHsULvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg0MjYzOQ==", "bodyText": "Should the test name be like getExpandedItems_expandSomeItems_returnsCorrectExpandedItems", "url": "https://github.com/vaadin/flow/pull/9275#discussion_r515842639", "createdAt": "2020-11-02T09:33:10Z", "author": {"login": "mshabarov"}, "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/hierarchy/HierarchyMapperWithDataTest.java", "diffHunk": "@@ -224,6 +232,137 @@ public void fetchWithFilter() {\n         verifyFetchIsCorrect(expectedResult, range);\n     }\n \n+    @Test\n+    public void expandingItems_getExpandedItems_shouldReturnCorrectExpandedItems() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ef33373560529c8f694deed074e0878f9c0610f"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzMDA3OA==", "bodyText": "Done.", "url": "https://github.com/vaadin/flow/pull/9275#discussion_r516230078", "createdAt": "2020-11-02T20:17:28Z", "author": {"login": "taefi"}, "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/hierarchy/HierarchyMapperWithDataTest.java", "diffHunk": "@@ -224,6 +232,137 @@ public void fetchWithFilter() {\n         verifyFetchIsCorrect(expectedResult, range);\n     }\n \n+    @Test\n+    public void expandingItems_getExpandedItems_shouldReturnCorrectExpandedItems() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg0MjYzOQ=="}, "originalCommit": {"oid": "2ef33373560529c8f694deed074e0878f9c0610f"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIzMjc0NTQwOnYy", "diffSide": "RIGHT", "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/hierarchy/HierarchyMapperWithDataTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQwOTozNTo1MFrOHr8oLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMDoxNzo0MVrOHsUMGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg0NDE0Mg==", "bodyText": "Since this data provider is used more than once, is it better to extract it to an inner class and reuse?", "url": "https://github.com/vaadin/flow/pull/9275#discussion_r515844142", "createdAt": "2020-11-02T09:35:50Z", "author": {"login": "mshabarov"}, "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/hierarchy/HierarchyMapperWithDataTest.java", "diffHunk": "@@ -224,6 +232,137 @@ public void fetchWithFilter() {\n         verifyFetchIsCorrect(expectedResult, range);\n     }\n \n+    @Test\n+    public void expandingItems_getExpandedItems_shouldReturnCorrectExpandedItems() {\n+\n+        TreeNode root = new TreeNode(\"root\", null);\n+        TreeNode first1 = new TreeNode(\"first-1\", root);\n+        TreeNode second1 = new TreeNode(\"second-1\", root);\n+        TreeNode first11 = new TreeNode(\"first-1-1\", first1);\n+        TreeNode second11 = new TreeNode(\"second-1-1\", second1);\n+\n+        HierarchicalDataProvider<TreeNode, Void> dataProvider =\n+                new AbstractBackEndHierarchicalDataProvider<TreeNode, Void>() {\n+\n+                    @Override\n+                    public int getChildCount(HierarchicalQuery<TreeNode, Void>\n+                                                     query) {\n+                        if (query.getParent() == null) {\n+                            return 2;\n+                        }\n+                        if (query.getParent().getName().equals(\"first-1\") ||\n+                            query.getParent().getName().equals(\"second-1\")) {\n+                            return 1;\n+                        }\n+                        return 0;\n+                    }\n+\n+                    @Override\n+                    public boolean hasChildren(TreeNode item) {\n+                        return item.getParent() == null ||\n+                                item.getName().equals(\"first-1\") ||\n+                                item.getName().equals(\"second-1\");\n+                    }\n+\n+                    @Override\n+                    protected Stream<TreeNode> fetchChildrenFromBackEnd(\n+                            HierarchicalQuery<TreeNode, Void> query) {\n+                        if (query.getParent() == null) {\n+                            return Arrays.stream(new TreeNode[]{\n+                                    first1, second1\n+                            });\n+                        }\n+                        if (query.getParent().getName().equals(\"first-1\")) {\n+                            return Arrays.stream(new TreeNode[]{first11});\n+                        }\n+                        if (query.getParent().getName().equals(\"second-1\")) {\n+                            return Arrays.stream(new TreeNode[]{second11});\n+                        }\n+                        return Stream.<TreeNode>builder().build();\n+                    }\n+                };\n+\n+        HierarchyMapper<TreeNode, Void> hierarchyMapper = new HierarchyMapper<>(\n+                dataProvider\n+        );\n+\n+        Map<Object, TreeNode> expandedItems = hierarchyMapper.getExpandedItems();\n+        Assert.assertEquals(0L, expandedItems.keySet().size());\n+\n+        hierarchyMapper.expand(root);\n+        hierarchyMapper.expand(second1);\n+\n+        System.out.println(hierarchyMapper.getExpandedItems());\n+\n+        expandedItems = hierarchyMapper.getExpandedItems();\n+        Assert.assertNotNull(expandedItems);\n+        Assert.assertEquals(2L, expandedItems.keySet().size());\n+        Assert.assertArrayEquals(new Object[]{\"root\", \"second-1\"},\n+                expandedItems.values().stream()\n+                        .map(TreeNode::getName)\n+                        .sorted().toArray());\n+    }\n+\n+    @Test\n+    public void getExpandedItems_tryToAddItemsToCollection_shouldThrowException() {\n+\n+        exceptionRule.expect(UnsupportedOperationException.class);\n+\n+        TreeNode root = new TreeNode(\"root\", null);\n+        TreeNode first1 = new TreeNode(\"first-1\", root);\n+        TreeNode second1 = new TreeNode(\"second-2\", root);\n+        TreeNode first11 = new TreeNode(\"first-1-1\", first1);\n+        TreeNode second11 = new TreeNode(\"second-1-1\", second1);\n+\n+        HierarchicalDataProvider<TreeNode, Void> dataProvider =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ef33373560529c8f694deed074e0878f9c0610f"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzMDE3MQ==", "bodyText": "Done.", "url": "https://github.com/vaadin/flow/pull/9275#discussion_r516230171", "createdAt": "2020-11-02T20:17:41Z", "author": {"login": "taefi"}, "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/hierarchy/HierarchyMapperWithDataTest.java", "diffHunk": "@@ -224,6 +232,137 @@ public void fetchWithFilter() {\n         verifyFetchIsCorrect(expectedResult, range);\n     }\n \n+    @Test\n+    public void expandingItems_getExpandedItems_shouldReturnCorrectExpandedItems() {\n+\n+        TreeNode root = new TreeNode(\"root\", null);\n+        TreeNode first1 = new TreeNode(\"first-1\", root);\n+        TreeNode second1 = new TreeNode(\"second-1\", root);\n+        TreeNode first11 = new TreeNode(\"first-1-1\", first1);\n+        TreeNode second11 = new TreeNode(\"second-1-1\", second1);\n+\n+        HierarchicalDataProvider<TreeNode, Void> dataProvider =\n+                new AbstractBackEndHierarchicalDataProvider<TreeNode, Void>() {\n+\n+                    @Override\n+                    public int getChildCount(HierarchicalQuery<TreeNode, Void>\n+                                                     query) {\n+                        if (query.getParent() == null) {\n+                            return 2;\n+                        }\n+                        if (query.getParent().getName().equals(\"first-1\") ||\n+                            query.getParent().getName().equals(\"second-1\")) {\n+                            return 1;\n+                        }\n+                        return 0;\n+                    }\n+\n+                    @Override\n+                    public boolean hasChildren(TreeNode item) {\n+                        return item.getParent() == null ||\n+                                item.getName().equals(\"first-1\") ||\n+                                item.getName().equals(\"second-1\");\n+                    }\n+\n+                    @Override\n+                    protected Stream<TreeNode> fetchChildrenFromBackEnd(\n+                            HierarchicalQuery<TreeNode, Void> query) {\n+                        if (query.getParent() == null) {\n+                            return Arrays.stream(new TreeNode[]{\n+                                    first1, second1\n+                            });\n+                        }\n+                        if (query.getParent().getName().equals(\"first-1\")) {\n+                            return Arrays.stream(new TreeNode[]{first11});\n+                        }\n+                        if (query.getParent().getName().equals(\"second-1\")) {\n+                            return Arrays.stream(new TreeNode[]{second11});\n+                        }\n+                        return Stream.<TreeNode>builder().build();\n+                    }\n+                };\n+\n+        HierarchyMapper<TreeNode, Void> hierarchyMapper = new HierarchyMapper<>(\n+                dataProvider\n+        );\n+\n+        Map<Object, TreeNode> expandedItems = hierarchyMapper.getExpandedItems();\n+        Assert.assertEquals(0L, expandedItems.keySet().size());\n+\n+        hierarchyMapper.expand(root);\n+        hierarchyMapper.expand(second1);\n+\n+        System.out.println(hierarchyMapper.getExpandedItems());\n+\n+        expandedItems = hierarchyMapper.getExpandedItems();\n+        Assert.assertNotNull(expandedItems);\n+        Assert.assertEquals(2L, expandedItems.keySet().size());\n+        Assert.assertArrayEquals(new Object[]{\"root\", \"second-1\"},\n+                expandedItems.values().stream()\n+                        .map(TreeNode::getName)\n+                        .sorted().toArray());\n+    }\n+\n+    @Test\n+    public void getExpandedItems_tryToAddItemsToCollection_shouldThrowException() {\n+\n+        exceptionRule.expect(UnsupportedOperationException.class);\n+\n+        TreeNode root = new TreeNode(\"root\", null);\n+        TreeNode first1 = new TreeNode(\"first-1\", root);\n+        TreeNode second1 = new TreeNode(\"second-2\", root);\n+        TreeNode first11 = new TreeNode(\"first-1-1\", first1);\n+        TreeNode second11 = new TreeNode(\"second-1-1\", second1);\n+\n+        HierarchicalDataProvider<TreeNode, Void> dataProvider =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg0NDE0Mg=="}, "originalCommit": {"oid": "2ef33373560529c8f694deed074e0878f9c0610f"}, "originalPosition": 117}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIzMjc1OTQ3OnYy", "diffSide": "RIGHT", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/hierarchy/HierarchicalDataCommunicator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQwOTozOTozNlrOHr8wxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMDoxNzo1MVrOHsUMbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg0NjM0MQ==", "bodyText": "Does it make sense to add one more unit test to verify that the update contains the proper bunch of JsonObject for expanded items after reset()?", "url": "https://github.com/vaadin/flow/pull/9275#discussion_r515846341", "createdAt": "2020-11-02T09:39:36Z", "author": {"login": "mshabarov"}, "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/hierarchy/HierarchicalDataCommunicator.java", "diffHunk": "@@ -158,6 +158,19 @@ public void reset() {\n             HierarchicalUpdate update = arrayUpdater\n                     .startUpdate(getHierarchyMapper().getRootSize());\n             update.enqueue(\"$connector.ensureHierarchy\");\n+\n+            Collection<T> expandedItems = getHierarchyMapper().getExpandedItems().values();\n+            update.enqueue(\"$connector.expandItems\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ef33373560529c8f694deed074e0878f9c0610f"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzMDI1Mw==", "bodyText": "Done.\nCreated a test in HierarchicalCommunicatorTest.java to verify it.", "url": "https://github.com/vaadin/flow/pull/9275#discussion_r516230253", "createdAt": "2020-11-02T20:17:51Z", "author": {"login": "taefi"}, "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/hierarchy/HierarchicalDataCommunicator.java", "diffHunk": "@@ -158,6 +158,19 @@ public void reset() {\n             HierarchicalUpdate update = arrayUpdater\n                     .startUpdate(getHierarchyMapper().getRootSize());\n             update.enqueue(\"$connector.ensureHierarchy\");\n+\n+            Collection<T> expandedItems = getHierarchyMapper().getExpandedItems().values();\n+            update.enqueue(\"$connector.expandItems\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg0NjM0MQ=="}, "originalCommit": {"oid": "2ef33373560529c8f694deed074e0878f9c0610f"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIzMjkzMDc5OnYy", "diffSide": "RIGHT", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/hierarchy/HierarchyMapper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMDoyMjoyNVrOHr-XJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMDoxNzo1OFrOHsUMog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg3MjU0OQ==", "bodyText": "I believe that it's better to return the collection of items, not a whole mapping. From a client code perspective, it's not that necessary to have a mapping (someone can recalculate the object ids if needed), but to know which items are expanded. So I would suggest to limit this method to return Collection<T>", "url": "https://github.com/vaadin/flow/pull/9275#discussion_r515872549", "createdAt": "2020-11-02T10:22:25Z", "author": {"login": "mshabarov"}, "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/hierarchy/HierarchyMapper.java", "diffHunk": "@@ -627,6 +627,18 @@ public void destroyAllData() {\n      * @return {@code true} if there is any expanded items.\n      */\n     public boolean hasExpandedItems() {\n-        return !expandedItemIds.isEmpty();\n+        return !expandedItems.isEmpty();\n+    }\n+\n+    /**\n+     * Returns the mappings between object-ids and their corresponding items for\n+     * the expanded items. Object ids are the result of applying data provider's\n+     * {@code IdentifierProvider} to the items.\n+     *\n+     * @return an unmodifiable {@code Map} between object-ids and their\n+     * items corresponding items for the expanded items.\n+     */\n+    public Map<Object, T> getExpandedItems() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ef33373560529c8f694deed074e0878f9c0610f"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzMDMwNg==", "bodyText": "Nice one!\nDone.", "url": "https://github.com/vaadin/flow/pull/9275#discussion_r516230306", "createdAt": "2020-11-02T20:17:58Z", "author": {"login": "taefi"}, "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/hierarchy/HierarchyMapper.java", "diffHunk": "@@ -627,6 +627,18 @@ public void destroyAllData() {\n      * @return {@code true} if there is any expanded items.\n      */\n     public boolean hasExpandedItems() {\n-        return !expandedItemIds.isEmpty();\n+        return !expandedItems.isEmpty();\n+    }\n+\n+    /**\n+     * Returns the mappings between object-ids and their corresponding items for\n+     * the expanded items. Object ids are the result of applying data provider's\n+     * {@code IdentifierProvider} to the items.\n+     *\n+     * @return an unmodifiable {@code Map} between object-ids and their\n+     * items corresponding items for the expanded items.\n+     */\n+    public Map<Object, T> getExpandedItems() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg3MjU0OQ=="}, "originalCommit": {"oid": "2ef33373560529c8f694deed074e0878f9c0610f"}, "originalPosition": 79}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2959, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}