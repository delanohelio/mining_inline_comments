{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0NzMzMzkx", "number": 7916, "title": "Run (p)npm install and webpack dev server in a separate thread", "bodyText": "Run (p)npm install and webpack dev server in a separate thread without blocking servlet container initializer\nFixes #6369\n\n\nThis change is\u2002", "createdAt": "2020-03-27T12:45:32Z", "url": "https://github.com/vaadin/flow/pull/7916", "merged": true, "mergeCommit": {"oid": "8d5ed197eca27ce310dbeb1cef954120ea637f8b"}, "closed": true, "closedAt": "2020-04-02T08:02:43Z", "author": {"login": "denis-anisimov"}, "timelineItems": {"totalCount": 40, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRwYeJAFqTM4MjgzNzMyOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTnl8RgFqTM4NjE4Nzk3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyODM3MzI4", "url": "https://github.com/vaadin/flow/pull/7916#pullrequestreview-382837328", "createdAt": "2020-03-27T13:04:58Z", "commit": {"oid": "97ea20ee3b8d04dc4618e0e9135232917ce0dda0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMzowNDo1OFrOF8wNgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMzowNDo1OFrOF8wNgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI0ODc2OQ==", "bodyText": "Possible null pointer dereference in com.vaadin.flow.server.frontend.TaskRunNpmInstall.cleanUp() due to return value of called method", "url": "https://github.com/vaadin/flow/pull/7916#discussion_r399248769", "createdAt": "2020-03-27T13:04:58Z", "author": {"login": "vaadin-bot"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/TaskRunNpmInstall.java", "diffHunk": "@@ -279,8 +279,17 @@ private void cleanUp() throws IOException {\n         File modulesYaml = new File(packageUpdater.nodeModulesFolder,\n                 MODULES_YAML);\n         boolean hasModulesYaml = modulesYaml.exists() && modulesYaml.isFile();\n-        if (hasModulesYaml != enablePnpm) {\n+        if (!enablePnpm && hasModulesYaml) {\n             FileUtils.forceDelete(packageUpdater.nodeModulesFolder);\n+        } else if (enablePnpm && !hasModulesYaml) {\n+            // presence of .staging dir with a \"pnpm-*\" folder means that pnpm\n+            // download is in progress, don't remove anything in this case\n+            File staging = new File(packageUpdater.nodeModulesFolder,\n+                    \".staging\");\n+            if (!staging.isDirectory() || staging.listFiles(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97ea20ee3b8d04dc4618e0e9135232917ce0dda0"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyODM3MzQ4", "url": "https://github.com/vaadin/flow/pull/7916#pullrequestreview-382837348", "createdAt": "2020-03-27T13:04:59Z", "commit": {"oid": "97ea20ee3b8d04dc4618e0e9135232917ce0dda0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMzowNDo1OVrOF8wNkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMzowNDo1OVrOF8wNkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI0ODc4NQ==", "bodyText": "Null passed for non-null parameter of java.util.concurrent.CompletableFuture.getNow(Object) in com.vaadin.flow.server.DevModeHandler.handleRequest(VaadinSession, VaadinRequest, VaadinResponse)", "url": "https://github.com/vaadin/flow/pull/7916#discussion_r399248785", "createdAt": "2020-03-27T13:04:59Z", "author": {"login": "vaadin-bot"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java", "diffHunk": "@@ -274,45 +187,44 @@ public static DevModeHandler getDevModeHandler() {\n         return atomicHandler.get();\n     }\n \n+    @Override\n+    public boolean handleRequest(VaadinSession session, VaadinRequest request,\n+            VaadinResponse response) throws IOException {\n+        if (devServerStartFuture.isDone()) {\n+            try {\n+                devServerStartFuture.getNow(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97ea20ee3b8d04dc4618e0e9135232917ce0dda0"}, "originalPosition": 237}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyODM3Mzcx", "url": "https://github.com/vaadin/flow/pull/7916#pullrequestreview-382837371", "createdAt": "2020-03-27T13:05:01Z", "commit": {"oid": "97ea20ee3b8d04dc4618e0e9135232917ce0dda0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMzowNTowMVrOF8wNoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMzowNTowMVrOF8wNoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI0ODgwMQ==", "bodyText": "Make \"devServerStartFuture\" transient or serializable.", "url": "https://github.com/vaadin/flow/pull/7916#discussion_r399248801", "createdAt": "2020-03-27T13:05:01Z", "author": {"login": "vaadin-bot"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java", "diffHunk": "@@ -97,134 +102,35 @@\n \n     private boolean notified = false;\n \n-    private String failedOutput;\n+    private volatile String failedOutput;\n \n     /**\n      * The local installation path of the webpack-dev-server node script.\n      */\n     public static final String WEBPACK_SERVER = \"node_modules/webpack-dev-server/bin/webpack-dev-server.js\";\n \n-    private int port;\n-    private Process webpackProcess;\n+    private volatile int port;\n+    private final AtomicReference<Process> webpackProcess = new AtomicReference<>();\n     private final boolean reuseDevServer;\n-    private DevServerWatchDog watchDog;\n+    private final AtomicReference<DevServerWatchDog> watchDog = new AtomicReference<>();\n \n     private StringBuilder cumulativeOutput = new StringBuilder();\n \n+    private final CompletableFuture<Void> devServerStartFuture;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97ea20ee3b8d04dc4618e0e9135232917ce0dda0"}, "originalPosition": 60}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab98f11297c09f8bf092bb50589d94c942829945", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/ab98f11297c09f8bf092bb50589d94c942829945", "committedDate": "2020-03-27T13:30:12Z", "message": "Update stub pnpm version"}, "afterCommit": {"oid": "8763d175a57cbb9a91c38c61a58846f401612b64", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/8763d175a57cbb9a91c38c61a58846f401612b64", "committedDate": "2020-03-30T09:33:00Z", "message": "Update stub pnpm version"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NDY5NjE5", "url": "https://github.com/vaadin/flow/pull/7916#pullrequestreview-385469619", "createdAt": "2020-04-01T10:47:05Z", "commit": {"oid": "8763d175a57cbb9a91c38c61a58846f401612b64"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8763d175a57cbb9a91c38c61a58846f401612b64", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/8763d175a57cbb9a91c38c61a58846f401612b64", "committedDate": "2020-03-30T09:33:00Z", "message": "Update stub pnpm version"}, "afterCommit": {"oid": "c394b663d0100bb40b0dbcb888f5e4a147876eb6", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/c394b663d0100bb40b0dbcb888f5e4a147876eb6", "committedDate": "2020-04-01T10:48:42Z", "message": "Don't remove node_modules if pnpm is enabled and it's downloading\nresources."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NDg4MTIz", "url": "https://github.com/vaadin/flow/pull/7916#pullrequestreview-385488123", "createdAt": "2020-04-01T11:16:14Z", "commit": {"oid": "c394b663d0100bb40b0dbcb888f5e4a147876eb6"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NDkzNzA3", "url": "https://github.com/vaadin/flow/pull/7916#pullrequestreview-385493707", "createdAt": "2020-04-01T11:25:08Z", "commit": {"oid": "aa1484ffaa4517a8ee052f3bb54e4d5160a03189"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NTAzMDk0", "url": "https://github.com/vaadin/flow/pull/7916#pullrequestreview-385503094", "createdAt": "2020-04-01T11:40:37Z", "commit": {"oid": "076f24e2aba37e9b13a58be5999294fc844a615e"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b865d4b415edd55a9b6d883a13bf2de4f4325d89", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/b865d4b415edd55a9b6d883a13bf2de4f4325d89", "committedDate": "2020-04-02T06:07:40Z", "message": "Run (p)npm install and webpack dev server in a separate thread without\nblocking servlet container initializer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4067abda4ff0293595f094e6cd571562b6261c97", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/4067abda4ff0293595f094e6cd571562b6261c97", "committedDate": "2020-04-02T06:07:40Z", "message": "Read a file from the classpath instead of hardcoding the content."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eec2789db7ca244a29dfe6330b83b96f0a6a6476", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/eec2789db7ca244a29dfe6330b83b96f0a6a6476", "committedDate": "2020-04-02T06:07:40Z", "message": "Update unit tests and rewrite exception throwing."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9143f7bcf5432210afb269bc8fdc8440a7f1223", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/c9143f7bcf5432210afb269bc8fdc8440a7f1223", "committedDate": "2020-04-02T06:07:40Z", "message": "Fixes after rebase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5e08ad6b54dece381efc5d8dcb4b9ffd419ed34", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/a5e08ad6b54dece381efc5d8dcb4b9ffd419ed34", "committedDate": "2020-04-02T06:07:40Z", "message": "Add lost file after rebase back.\nThank you git so much..."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04c3e305c1598ebbdc2011f97423c387fb0b027f", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/04c3e305c1598ebbdc2011f97423c387fb0b027f", "committedDate": "2020-04-02T06:07:40Z", "message": "Revert unneeded bootstrap handler changes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc9c5ef66a7ac1633d765002523cb0fd00b839a6", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/bc9c5ef66a7ac1633d765002523cb0fd00b839a6", "committedDate": "2020-04-02T06:07:40Z", "message": "Remove TODO"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "879c1897935c87113fbe467487341d21c60d8374", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/879c1897935c87113fbe467487341d21c60d8374", "committedDate": "2020-04-02T06:07:40Z", "message": "Revert code which was reverted by git rebase.\nThank you git one one more time."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf381abccff971e86aea45b3ba3f64f9ab7de806", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/cf381abccff971e86aea45b3ba3f64f9ab7de806", "committedDate": "2020-04-02T06:07:40Z", "message": "Fix tests and update the code."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73ead842db2ad235102374a3c96f9c5aab3272bc", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/73ead842db2ad235102374a3c96f9c5aab3272bc", "committedDate": "2020-04-02T06:07:40Z", "message": "Fix pnpm unit test in case of globally installed pnpm."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6f190db60cee56b33f5c00ffd2a898916f6ee09", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/d6f190db60cee56b33f5c00ffd2a898916f6ee09", "committedDate": "2020-04-02T06:07:40Z", "message": "Correct unit tests to expect exception instead of null handler."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30853a2b9891ae4bcf8e8e3161c9aa1cadbd336a", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/30853a2b9891ae4bcf8e8e3161c9aa1cadbd336a", "committedDate": "2020-04-02T06:07:40Z", "message": "Update ITs to wait until dev server is started"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17e89ee8b44ec58c038ebc08f1916a102828ba6b", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/17e89ee8b44ec58c038ebc08f1916a102828ba6b", "committedDate": "2020-04-02T06:07:40Z", "message": "Correct waitForDevServer and add javadocs for dev mode handler CTOR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5ca296aa3e31c6bae1405b597c5b4b4a4a9e2c4", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/a5ca296aa3e31c6bae1405b597c5b4b4a4a9e2c4", "committedDate": "2020-04-02T06:07:40Z", "message": "Disable flow-client tests which are broken."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e8931e8760c5212b6c67945b90426ee38448955", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/1e8931e8760c5212b6c67945b90426ee38448955", "committedDate": "2020-04-02T06:07:40Z", "message": "Use the correct waitForDevServer method impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "873ce912560e44ca0255ebcd0803536caceb3821", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/873ce912560e44ca0255ebcd0803536caceb3821", "committedDate": "2020-04-02T06:07:40Z", "message": "Use find() instead of match()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a959f57197126fb0525294ac1c3bb912952000b", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/7a959f57197126fb0525294ac1c3bb912952000b", "committedDate": "2020-04-02T06:07:40Z", "message": "Correct log message in the dev mode handler and startup performance test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9082f4a1ddb0aba8b9d43ed0874e273ed9b2ad4", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/f9082f4a1ddb0aba8b9d43ed0874e273ed9b2ad4", "committedDate": "2020-04-02T06:07:40Z", "message": "More corrections."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6d4ccdbcfb447250880d7c061a2c0641a5ba9a8", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/c6d4ccdbcfb447250880d7c061a2c0641a5ba9a8", "committedDate": "2020-04-02T06:07:40Z", "message": "Try to enable flow-client tests back."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06ae4ee4c8c654363b1e3f936028385f93220389", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/06ae4ee4c8c654363b1e3f936028385f93220389", "committedDate": "2020-04-02T06:07:40Z", "message": "Fix SQ complains."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2cb54482c6229f47f2458f06c9dabef3397477d", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/c2cb54482c6229f47f2458f06c9dabef3397477d", "committedDate": "2020-04-02T06:07:40Z", "message": "Don't throw an exception on getCause but just return it"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2479031a1e049b35a9ad27134d344dd74135283a", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/2479031a1e049b35a9ad27134d344dd74135283a", "committedDate": "2020-04-02T06:07:40Z", "message": "Check that an exception in the prepare tasks ((p)npm install) is\nrethrown on request handling."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41a01c31b39efd556d709ed0246856b72a007e04", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/41a01c31b39efd556d709ed0246856b72a007e04", "committedDate": "2020-04-02T06:07:40Z", "message": "Remove extra javadocs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7993d908622073893927241c3eed8450fcc41992", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/7993d908622073893927241c3eed8450fcc41992", "committedDate": "2020-04-02T06:07:40Z", "message": "Fixes based on review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13485ff1fffa95e9b222b98792ffedb4c894bf59", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/13485ff1fffa95e9b222b98792ffedb4c894bf59", "committedDate": "2020-04-02T06:07:40Z", "message": "Schedule page reload without onload"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea38a30080634fefdf7c90620818d0c995fd96ef", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/ea38a30080634fefdf7c90620818d0c995fd96ef", "committedDate": "2020-04-02T06:07:40Z", "message": "Don't remove node_modules if pnpm is enabled and it's downloading\nresources."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b74d7b70092029cc2dee5aa80d2dffb9c916dac", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/3b74d7b70092029cc2dee5aa80d2dffb9c916dac", "committedDate": "2020-04-02T06:07:40Z", "message": "Correct code based on review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8336003b79d1961624e3886704dc0a7312ab4722", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/8336003b79d1961624e3886704dc0a7312ab4722", "committedDate": "2020-04-02T06:07:40Z", "message": "Fix merge conflicts"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "076f24e2aba37e9b13a58be5999294fc844a615e", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/076f24e2aba37e9b13a58be5999294fc844a615e", "committedDate": "2020-04-01T11:35:49Z", "message": "Fix merge conflicts"}, "afterCommit": {"oid": "8336003b79d1961624e3886704dc0a7312ab4722", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/8336003b79d1961624e3886704dc0a7312ab4722", "committedDate": "2020-04-02T06:07:40Z", "message": "Fix merge conflicts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MTg2NTEz", "url": "https://github.com/vaadin/flow/pull/7916#pullrequestreview-386186513", "createdAt": "2020-04-02T07:56:19Z", "commit": {"oid": "076f24e2aba37e9b13a58be5999294fc844a615e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MTg3OTc1", "url": "https://github.com/vaadin/flow/pull/7916#pullrequestreview-386187975", "createdAt": "2020-04-02T07:58:23Z", "commit": {"oid": "8336003b79d1961624e3886704dc0a7312ab4722"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 629, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}