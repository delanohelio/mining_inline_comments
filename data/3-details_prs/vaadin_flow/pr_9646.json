{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5NDMwMzYz", "number": 9646, "title": "test: add document.css level styles tests", "bodyText": "Adds a tests for checking that the document.css file is injected to the document scope and not injected to embedded element shadow root.\nFixes: #9552", "createdAt": "2020-12-14T12:56:31Z", "url": "https://github.com/vaadin/flow/pull/9646", "merged": true, "mergeCommit": {"oid": "6e30cf1182b3b61c83896ddeec42b88ba85b6b7a"}, "closed": true, "closedAt": "2020-12-15T13:12:50Z", "author": {"login": "mshabarov"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmFSU5AH2gAyNTM5NDMwMzYzOjgyN2YwNmNiYmQwYjRiNmY3NDA0NTAyMWY2OWUzMTUyZjAzNzUwYmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmaHzqgFqTU1MjQzNDA3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "827f06cbbd0b4b6f74045021f69e3152f03750bb", "author": {"user": {"login": "mshabarov", "name": "Mikhail Shabarov"}}, "url": "https://github.com/vaadin/flow/commit/827f06cbbd0b4b6f74045021f69e3152f03750bb", "committedDate": "2020-12-14T12:55:54Z", "message": "test: add document.css level styles tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMTE0NDU3", "url": "https://github.com/vaadin/flow/pull/9646#pullrequestreview-552114457", "createdAt": "2020-12-15T05:22:21Z", "commit": {"oid": "827f06cbbd0b4b6f74045021f69e3152f03750bb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNToyMjoyMVrOIF5dDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNToyMjoyMVrOIF5dDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA1NTExNw==", "bodyText": "Is there a reason to change the font away form Ostrich?\nAlso now that you didn't update the global.css that uses Ostrich the feature can't be validated visually by opening the application.", "url": "https://github.com/vaadin/flow/pull/9646#discussion_r543055117", "createdAt": "2020-12-15T05:22:21Z", "author": {"login": "caalador"}, "path": "flow-tests/test-embedding/test-embedding-application-theme/frontend/themes/embedded-theme/document.css", "diffHunk": "@@ -1,4 +1,4 @@\n @font-face {\n-    font-family: \"Ostrich\";\n-    src: url(\"./font/ostrich-sans-regular.ttf\") format(\"TrueType\");\n+    font-family: \"Open Sans\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "827f06cbbd0b4b6f74045021f69e3152f03750bb"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7eadfbfae4e2e16aca97494da46e9b4bd7a6b23b", "author": {"user": {"login": "mshabarov", "name": "Mikhail Shabarov"}}, "url": "https://github.com/vaadin/flow/commit/7eadfbfae4e2e16aca97494da46e9b4bd7a6b23b", "committedDate": "2020-12-15T09:30:52Z", "message": "The font defined in global.css should be applied to embedded component"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMzIwMTQx", "url": "https://github.com/vaadin/flow/pull/9646#pullrequestreview-552320141", "createdAt": "2020-12-15T10:41:27Z", "commit": {"oid": "7eadfbfae4e2e16aca97494da46e9b4bd7a6b23b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMDo0MToyOFrOIGEXZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMDo0MjoxOFrOIGEZ8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzIzMzg5NA==", "bodyText": "I feel this doesn't check that the @font-face declaration has been inserted only that some arbitrary rule in position 0 contains ostrich as a string part.\nExpecting it to always be in index 0 is also easily broken by some minor change.\nI would propose to make it more robust by using for instance\nlet found = false;\nfor (let as=0; as<document.adoptedStyleSheets.length;++as) {\n    let styleSheetRules = document.adoptedStyleSheets[as].rules;\n    for (var ss = 0; ss < styleSheetRules.length; ++ss) {\n        let cssRule = styleSheetRules[ss];\n            if (cssRule instanceof CSSFontFaceRule && cssRule.cssText.startsWith(\"@font-face { font-family: Ostrich;\")) {\n                found = true;\n            } \n    }\n}\nreturn found;\n\nThis would guarantee that it is the @font-face declaration.", "url": "https://github.com/vaadin/flow/pull/9646#discussion_r543233894", "createdAt": "2020-12-15T10:41:28Z", "author": {"login": "caalador"}, "path": "flow-tests/test-embedding/test-embedding-application-theme/src/test/java/com/vaadin/flow/webcomponent/ApplicationThemeComponentIT.java", "diffHunk": "@@ -88,4 +88,42 @@ public void componentThemeIsApplied_forPolymerAndLit() {\n         Assert.assertEquals(\"Lit radiobutton should have red background\",\n             \"rgba(255, 0, 0, 1)\", radio.getCssValue(\"background-color\"));\n     }\n+\n+    @Test\n+    public void documentCssFonts_fromLocalCssFile_fontAppliedToDocumentRoot() {\n+        open();\n+\n+        Long adoptedStyles = (Long) getCommandExecutor().executeScript(\n+                \"return document.adoptedStyleSheets !== undefined ? document\"\n+                        + \".adoptedStyleSheets.length : 0\");\n+\n+        Assert.assertTrue(\n+                \"Expected the document root to have the adopted styles\",\n+                adoptedStyles > 0);\n+\n+        Object ostrichFontStylesFound = getCommandExecutor().executeScript(\n+                \"return document.adoptedStyleSheets.map(styleSheet => styleSheet\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7eadfbfae4e2e16aca97494da46e9b4bd7a6b23b"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzIzNDU0Nw==", "bodyText": "Same script as above, but the result should be false as the @font-face declaration should not be added to the embedded component.", "url": "https://github.com/vaadin/flow/pull/9646#discussion_r543234547", "createdAt": "2020-12-15T10:42:18Z", "author": {"login": "caalador"}, "path": "flow-tests/test-embedding/test-embedding-application-theme/src/test/java/com/vaadin/flow/webcomponent/ApplicationThemeComponentIT.java", "diffHunk": "@@ -88,4 +88,42 @@ public void componentThemeIsApplied_forPolymerAndLit() {\n         Assert.assertEquals(\"Lit radiobutton should have red background\",\n             \"rgba(255, 0, 0, 1)\", radio.getCssValue(\"background-color\"));\n     }\n+\n+    @Test\n+    public void documentCssFonts_fromLocalCssFile_fontAppliedToDocumentRoot() {\n+        open();\n+\n+        Long adoptedStyles = (Long) getCommandExecutor().executeScript(\n+                \"return document.adoptedStyleSheets !== undefined ? document\"\n+                        + \".adoptedStyleSheets.length : 0\");\n+\n+        Assert.assertTrue(\n+                \"Expected the document root to have the adopted styles\",\n+                adoptedStyles > 0);\n+\n+        Object ostrichFontStylesFound = getCommandExecutor().executeScript(\n+                \"return document.adoptedStyleSheets.map(styleSheet => styleSheet\"\n+                        + \".cssRules[0].cssText).filter(cssText => cssText\"\n+                        + \".indexOf('Ostrich') > 0).length > 0;\");\n+\n+        Assert.assertEquals(\n+                \"Expected Ostrich font to be applied to document root element\",\n+                Boolean.TRUE, ostrichFontStylesFound);\n+    }\n+\n+    @Test\n+    public void documentCssFonts_fromLocalCssFile_fontAppliedToEmbeddedComponent() {\n+        open();\n+\n+        Object ostrichFontStylesFoundForEmbedded = getCommandExecutor()\n+                .executeScript(\n+                        \"return document.getElementsByTagName('themed-component')[0]\"\n+                                + \".shadowRoot.adoptedStyleSheets.map(styleSheet => \"\n+                                + \"styleSheet.cssRules[0].cssText).filter(cssText => \"\n+                                + \"cssText.indexOf('Ostrich') > 0).length > 0;\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7eadfbfae4e2e16aca97494da46e9b4bd7a6b23b"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a3da01d5e67e4e62a1f4937bcecc6010078773c", "author": {"user": {"login": "mshabarov", "name": "Mikhail Shabarov"}}, "url": "https://github.com/vaadin/flow/commit/2a3da01d5e67e4e62a1f4937bcecc6010078773c", "committedDate": "2020-12-15T11:19:59Z", "message": "Make the script more robust"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNDM0MDc3", "url": "https://github.com/vaadin/flow/pull/9646#pullrequestreview-552434077", "createdAt": "2020-12-15T13:12:25Z", "commit": {"oid": "2a3da01d5e67e4e62a1f4937bcecc6010078773c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 763, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}