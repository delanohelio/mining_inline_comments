{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc2MjM5ODYz", "number": 8925, "title": "Cherry picks for starting web pack dev server and (p)npm install command in the separate thread", "bodyText": "Fixes #8859", "createdAt": "2020-08-31T11:33:47Z", "url": "https://github.com/vaadin/flow/pull/8925", "merged": true, "mergeCommit": {"oid": "6cd4436504b53bd0b58f1e7105634c083c9497f4"}, "closed": true, "closedAt": "2020-09-03T07:17:02Z", "author": {"login": "denis-anisimov"}, "timelineItems": {"totalCount": 33, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdERNRggH2gAyNDc2MjM5ODYzOjg5NDcxNGQ4NTYxZmJkYmQ3NTUxNDA5OTNlYWQxYjQ0ZmQyN2Y0YWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFKoafgFqTQ4MTUyNzc4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "894714d8561fbdbd755140993ead1b44fd27f4ac", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/894714d8561fbdbd755140993ead1b44fd27f4ac", "committedDate": "2020-08-31T11:35:49Z", "message": "Update Flow to version 2.4"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e58e724a84d98ba78cb9a7394e58dfaa8c122881", "author": {"user": {"login": "caalador", "name": null}}, "url": "https://github.com/vaadin/flow/commit/e58e724a84d98ba78cb9a7394e58dfaa8c122881", "committedDate": "2020-08-31T11:35:50Z", "message": "Only connect to devServer when it is started\n\nDo not try to connect to the dev server\nif it hasn't started yet or startup has failed.\n\nFixes #8858\n\n# Conflicts:\n#\tflow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "970263bd21c4c69d189bf0865b387880bb7a2c92", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/970263bd21c4c69d189bf0865b387880bb7a2c92", "committedDate": "2020-08-31T11:35:50Z", "message": "Don't handle dynamic resources by the DevModeHandler (#8599)\n\n* Do not serve static resources if it's known that dev server start\nfailed\n\nFixed #8297\n\n* Add a unit test for serveDevModeRequest\n\n* Improve comments\n# Conflicts:\n#\tflow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "18d2995500e758f5fab6d3b243f2c572bca19313", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/18d2995500e758f5fab6d3b243f2c572bca19313", "committedDate": "2020-08-31T11:32:03Z", "message": "Don't handle dynamic resources by the DevModeHandler (#8599)\n\n* Do not serve static resources if it's known that dev server start\nfailed\n\nFixed #8297\n\n* Add a unit test for serveDevModeRequest\n\n* Improve comments\n# Conflicts:\n#\tflow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java"}, "afterCommit": {"oid": "970263bd21c4c69d189bf0865b387880bb7a2c92", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/970263bd21c4c69d189bf0865b387880bb7a2c92", "committedDate": "2020-08-31T11:35:50Z", "message": "Don't handle dynamic resources by the DevModeHandler (#8599)\n\n* Do not serve static resources if it's known that dev server start\nfailed\n\nFixed #8297\n\n* Add a unit test for serveDevModeRequest\n\n* Improve comments\n# Conflicts:\n#\tflow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cdde7f80ab4807cf621bc670cde745aa9a9cd567", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/cdde7f80ab4807cf621bc670cde745aa9a9cd567", "committedDate": "2020-08-31T11:40:14Z", "message": "Skip unrelated changes"}, "afterCommit": {"oid": "c9a4b3b4a67d51789019d5d9ba965fbaa9a868fc", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/c9a4b3b4a67d51789019d5d9ba965fbaa9a868fc", "committedDate": "2020-08-31T11:41:21Z", "message": "Skip unrelated changes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c9a4b3b4a67d51789019d5d9ba965fbaa9a868fc", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/c9a4b3b4a67d51789019d5d9ba965fbaa9a868fc", "committedDate": "2020-08-31T11:41:21Z", "message": "Skip unrelated changes"}, "afterCommit": {"oid": "5f9794cafaa0f117a28f615e35a87b0fae287c85", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/5f9794cafaa0f117a28f615e35a87b0fae287c85", "committedDate": "2020-08-31T11:44:09Z", "message": "Skip unrelated changes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5f9794cafaa0f117a28f615e35a87b0fae287c85", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/5f9794cafaa0f117a28f615e35a87b0fae287c85", "committedDate": "2020-08-31T11:44:09Z", "message": "Skip unrelated changes"}, "afterCommit": {"oid": "0fc57cdf81a7424621d49166cecfe9982546e8b8", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/0fc57cdf81a7424621d49166cecfe9982546e8b8", "committedDate": "2020-08-31T11:45:07Z", "message": "Skip unrelated changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce23519b328246b7b7a0679e66855bf4d3552d80", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/ce23519b328246b7b7a0679e66855bf4d3552d80", "committedDate": "2020-08-31T11:46:46Z", "message": "Skip unrelated changes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0fc57cdf81a7424621d49166cecfe9982546e8b8", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/0fc57cdf81a7424621d49166cecfe9982546e8b8", "committedDate": "2020-08-31T11:45:07Z", "message": "Skip unrelated changes"}, "afterCommit": {"oid": "ce23519b328246b7b7a0679e66855bf4d3552d80", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/ce23519b328246b7b7a0679e66855bf4d3552d80", "committedDate": "2020-08-31T11:46:46Z", "message": "Skip unrelated changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57d294a49f29a2593cccc3ef2936c8348cbb108a", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/57d294a49f29a2593cccc3ef2936c8348cbb108a", "committedDate": "2020-08-31T11:56:56Z", "message": "Remove extra tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "271145d41b25e742d115c268adca0ffa9a470fe1", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/271145d41b25e742d115c268adca0ffa9a470fe1", "committedDate": "2020-08-31T12:09:54Z", "message": "Correct unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02098c875d20812547a83cc5cc3139d99818abe6", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/02098c875d20812547a83cc5cc3139d99818abe6", "committedDate": "2020-09-01T05:45:51Z", "message": "Store handler instance in test and reuse it"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00358b8b0128e68ac4cac723b4b186c0e00c0170", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/00358b8b0128e68ac4cac723b4b186c0e00c0170", "committedDate": "2020-09-01T06:17:56Z", "message": "Avoid handler instantiation on every \"start\" call"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd0f74ca1ee15d38a41ba4037b002a7726dbcc4c", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/fd0f74ca1ee15d38a41ba4037b002a7726dbcc4c", "committedDate": "2020-09-01T06:27:54Z", "message": "Add missed fixes from original commit for pnpm install logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "337e714c406eea1d055b58dec695aaf787232899", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/337e714c406eea1d055b58dec695aaf787232899", "committedDate": "2020-09-01T06:40:29Z", "message": "Temp changes to detect an error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "659d9496b3db21119a4f2cc1b512b12c175c1924", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/659d9496b3db21119a4f2cc1b512b12c175c1924", "committedDate": "2020-09-01T07:06:29Z", "message": "Revert back temp logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "050ae1b90669f21a32d1d26800cb9390a430805f", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/050ae1b90669f21a32d1d26800cb9390a430805f", "committedDate": "2020-09-01T07:47:10Z", "message": "Style dev mode waiting page (#8057)\n\nFixes #7962"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "314eeab7a3ee24c6a5315a23ef79af1e08f6a713", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/314eeab7a3ee24c6a5315a23ef79af1e08f6a713", "committedDate": "2020-09-01T08:09:28Z", "message": "Set dev mode hander at the correct place: before bootstrap handler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab1db092a12bd72e6cb072abc253a74f43b7b23e", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/ab1db092a12bd72e6cb072abc253a74f43b7b23e", "committedDate": "2020-09-01T08:48:10Z", "message": "Clean up dev mode handler instance before running should_Run_Updaters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98897f9c38b91c5124f97f309d158bb21703be02", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/98897f9c38b91c5124f97f309d158bb21703be02", "committedDate": "2020-09-01T09:26:51Z", "message": "Remove non existent method call"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c621ec69eec7734aa2c1e71757aae44c932d01d9", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/c621ec69eec7734aa2c1e71757aae44c932d01d9", "committedDate": "2020-09-01T10:21:48Z", "message": "Revert code which does nothing and add tests specific code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd33b7fb1e92dce8889bbe0460d4546af37f4949", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/dd33b7fb1e92dce8889bbe0460d4546af37f4949", "committedDate": "2020-09-02T05:43:47Z", "message": "Don't store webpack server port if it has not been started"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02b20415d22be05696c9c487b7bbc2df8149d4ac", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/02b20415d22be05696c9c487b7bbc2df8149d4ac", "committedDate": "2020-09-02T08:42:11Z", "message": "Add a test for avoid storing webpack dev server port"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "777ceac82e75e1671325d3ccdc69095fc90cdfac", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/777ceac82e75e1671325d3ccdc69095fc90cdfac", "committedDate": "2020-09-02T08:44:19Z", "message": "Add comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNjIzMzU1", "url": "https://github.com/vaadin/flow/pull/8925#pullrequestreview-480623355", "createdAt": "2020-09-02T09:02:00Z", "commit": {"oid": "777ceac82e75e1671325d3ccdc69095fc90cdfac"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwOTowMjowMFrOHLlsUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwOTowNjoyMVrOHLl6ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkxMzkzNw==", "bodyText": "Should this be somehow reformulated to include pnpm as it's the default now?\n(p)npm install or pnpm/npm install or just check it from the configuration and give the correct one expected to be used. As running the wrong one will create slowness and possibly even mess up the node_modules folder.", "url": "https://github.com/vaadin/flow/pull/8925#discussion_r481913937", "createdAt": "2020-09-02T09:02:00Z", "author": {"login": "caalador"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java", "diffHunk": "@@ -570,6 +505,162 @@ private void saveRunningDevServerPort() {\n         }\n     }\n \n+    private void doStartDevModeServer(DeploymentConfiguration config)\n+            throws ExecutionFailedException {\n+        // If port is defined, means that webpack is already running\n+        if (port > 0) {\n+            if (checkWebpackConnection()) {\n+                getLogger().info(\"Reusing webpack-dev-server running at {}:{}\",\n+                        WEBPACK_HOST, port);\n+\n+                // Save running port for next usage\n+                saveRunningDevServerPort();\n+                watchDog.set(null);\n+                return;\n+            }\n+            throw new IllegalStateException(String.format(\n+                    \"%s webpack-dev-server port '%d' is defined but it's not working properly\",\n+                    START_FAILURE, port));\n+        }\n+        // here the port == 0\n+        Pair<File, File> webPackFiles = validateFiles(npmFolder);\n+\n+        long start = System.nanoTime();\n+        getLogger().info(\"Starting webpack-dev-server\");\n+\n+        watchDog.set(new DevServerWatchDog());\n+\n+        // Look for a free port\n+        port = getFreePort();\n+\n+        ProcessBuilder processBuilder = new ProcessBuilder()\n+                .directory(npmFolder);\n+\n+        FrontendTools tools = new FrontendTools(npmFolder.getAbsolutePath(),\n+                () -> FrontendUtils.getVaadinHomeDirectory().getAbsolutePath());\n+        tools.validateNodeAndNpmVersion();\n+\n+        boolean useHomeNodeExec = config.getBooleanProperty(\n+                InitParameters.REQUIRE_HOME_NODE_EXECUTABLE, false);\n+\n+        String nodeExec = null;\n+        if (useHomeNodeExec) {\n+            nodeExec = tools.forceAlternativeNodeExecutable();\n+        } else {\n+            nodeExec = tools.getNodeExecutable();\n+        }\n+\n+        List<String> command = makeCommands(config, webPackFiles.getFirst(),\n+                webPackFiles.getSecond(), nodeExec);\n+\n+        console(GREEN, START);\n+        if (getLogger().isDebugEnabled()) {\n+            getLogger().debug(\n+                    commandToString(npmFolder.getAbsolutePath(), command));\n+        }\n+\n+        processBuilder.command(command);\n+        try {\n+            webpackProcess.set(\n+                    processBuilder.redirectError(ProcessBuilder.Redirect.PIPE)\n+                            .redirectErrorStream(true).start());\n+\n+            // We only can save the webpackProcess reference the first time that\n+            // the DevModeHandler is created. There is no way to store\n+            // it in the servlet container, and we do not want to save it in the\n+            // global JVM.\n+            // We instruct the JVM to stop the webpack-dev-server daemon when\n+            // the JVM stops, to avoid leaving daemons running in the system.\n+            // NOTE: that in the corner case that the JVM crashes or it is\n+            // killed\n+            // the daemon will be kept running. But anyways it will also happens\n+            // if the system was configured to be stop the daemon when the\n+            // servlet context is destroyed.\n+            Runtime.getRuntime().addShutdownHook(new Thread(this::stop));\n+\n+            Pattern succeed = Pattern.compile(config.getStringProperty(\n+                    SERVLET_PARAMETER_DEVMODE_WEBPACK_SUCCESS_PATTERN,\n+                    DEFAULT_OUTPUT_PATTERN));\n+\n+            Pattern failure = Pattern.compile(config.getStringProperty(\n+                    SERVLET_PARAMETER_DEVMODE_WEBPACK_ERROR_PATTERN,\n+                    DEFAULT_ERROR_PATTERN));\n+\n+            logStream(webpackProcess.get().getInputStream(), succeed, failure);\n+\n+            getLogger().info(LOG_START);\n+            synchronized (this) {\n+                this.wait(Integer.parseInt(config.getStringProperty( // NOSONAR\n+                        SERVLET_PARAMETER_DEVMODE_WEBPACK_TIMEOUT,\n+                        DEFAULT_TIMEOUT_FOR_PATTERN)));\n+            }\n+\n+            if (!webpackProcess.get().isAlive()) {\n+                throw new IllegalStateException(\"Webpack exited prematurely\");\n+            }\n+\n+            long ms = (System.nanoTime() - start) / 1000000;\n+            getLogger().info(LOG_END, ms);\n+            saveRunningDevServerPort();\n+        } catch (IOException | InterruptedException e) {\n+            getLogger().error(\"Failed to start the webpack process\", e);\n+        }\n+    }\n+\n+    private List<String> makeCommands(DeploymentConfiguration config,\n+            File webpack, File webpackConfig, String nodeExec) {\n+        List<String> command = new ArrayList<>();\n+        command.add(nodeExec);\n+        command.add(webpack.getAbsolutePath());\n+        command.add(\"--config\");\n+        command.add(webpackConfig.getAbsolutePath());\n+        command.add(\"--port\");\n+        command.add(String.valueOf(port));\n+        command.add(\"--watchDogPort=\" + watchDog.get().getWatchDogPort());\n+        command.addAll(Arrays.asList(config\n+                .getStringProperty(SERVLET_PARAMETER_DEVMODE_WEBPACK_OPTIONS,\n+                        \"-d --inline=false\")\n+                .split(\" +\")));\n+        return command;\n+    }\n+\n+    private Pair<File, File> validateFiles(File npmFolder)\n+            throws ExecutionFailedException {\n+        assert port == 0;\n+        // Skip checks if we have a webpack-dev-server already running\n+        File webpack = new File(npmFolder, WEBPACK_SERVER);\n+        File webpackConfig = new File(npmFolder, FrontendUtils.WEBPACK_CONFIG);\n+        if (!npmFolder.exists()) {\n+            getLogger().warn(\"No project folder '{}' exists\", npmFolder);\n+            throw new ExecutionFailedException(START_FAILURE\n+                    + \" the target execution folder doesn't exist.\");\n+        }\n+        if (!webpack.exists()) {\n+            getLogger().warn(\"'{}' doesn't exist. Did you run `npm install`?\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "777ceac82e75e1671325d3ccdc69095fc90cdfac"}, "originalPosition": 543}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkxNzYwMw==", "bodyText": "Unrelated formatting changes in File.", "url": "https://github.com/vaadin/flow/pull/8925#discussion_r481917603", "createdAt": "2020-09-02T09:06:21Z", "author": {"login": "caalador"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/FrontendToolsLocator.java", "diffHunk": "@@ -154,10 +154,11 @@ boolean isWindows() {\n         }\n         List<String> stdout = new ArrayList<>();\n         try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "777ceac82e75e1671325d3ccdc69095fc90cdfac"}, "originalPosition": 3}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fc7f5835f53b03a6cac7f74997153e0f1bdb020", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/5fc7f5835f53b03a6cac7f74997153e0f1bdb020", "committedDate": "2020-09-02T09:33:09Z", "message": "Revert back unrelated changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNzIwNDg2", "url": "https://github.com/vaadin/flow/pull/8925#pullrequestreview-480720486", "createdAt": "2020-09-02T11:19:14Z", "commit": {"oid": "5fc7f5835f53b03a6cac7f74997153e0f1bdb020"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxMToxOToxNVrOHLqelg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxMzo1Njo0M1rOHLwYwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MjM0Mg==", "bodyText": "Non-blocking: we should try to avoid double negation, this should have been devServerIsLoaded but not worth to change it now", "url": "https://github.com/vaadin/flow/pull/8925#discussion_r481992342", "createdAt": "2020-09-02T11:19:15Z", "author": {"login": "pleku"}, "path": "flow-server/src/main/resources/com/vaadin/flow/server/dev-mode-not-ready.html", "diffHunk": "@@ -0,0 +1,62 @@\n+<html>\n+<head>\n+<style>\n+.flex-center {\n+    display: flex;\n+    width: 100%;\n+    justify-content: center;\n+    margin-top: 1rem;\n+}\n+\n+.message {\n+    position: relative;\n+    background-color: rgba(50,50,50,1);\n+    color: rgba(255,255,255,.9);\n+    border-radius: 1rem;\n+    box-sizing: border-box;\n+    padding: 0.5em 1em 0.5em 2.25em;\n+    line-height: 1;\n+    font-family: system-ui;\n+}\n+\n+/* Spinner */\n+.message:before {\n+  content: '';\n+  box-sizing: border-box;\n+  position: absolute;\n+  top: 50%;\n+  left: 1rem;\n+  width: 20px;\n+  height: 20px;\n+  margin-top: -10px;\n+  margin-left: -10px;\n+  border-radius: 50%;\n+  border: 2px solid #2CA6FF;\n+  border-top-color: rgba(50,50,50,1);\n+  animation: spinner .6s linear infinite;\n+}\n+\n+@keyframes spinner {\n+  to {transform: rotate(360deg);}\n+}\n+</style>\n+<script type=\"text/javascript\">\n+\n+// Set specific flag for TB and make sure that there are no any clients.\n+// It allows to work correct waitForVaadin in TB\n+window.Vaadin = {Flow: {devServerIsNotLoaded: true}};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5fc7f5835f53b03a6cac7f74997153e0f1bdb020"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA2NzU2Mw==", "bodyText": "Just a note that now the start time is recorded during a different phase, it used to be just before the processbuilder.command(command);.\nIs this change intentional and why ? I know it hardly matters for the execution itself, just curious as there is some additional things now done after that compared to before.", "url": "https://github.com/vaadin/flow/pull/8925#discussion_r482067563", "createdAt": "2020-09-02T13:27:29Z", "author": {"login": "pleku"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java", "diffHunk": "@@ -570,6 +505,162 @@ private void saveRunningDevServerPort() {\n         }\n     }\n \n+    private void doStartDevModeServer(DeploymentConfiguration config)\n+            throws ExecutionFailedException {\n+        // If port is defined, means that webpack is already running\n+        if (port > 0) {\n+            if (checkWebpackConnection()) {\n+                getLogger().info(\"Reusing webpack-dev-server running at {}:{}\",\n+                        WEBPACK_HOST, port);\n+\n+                // Save running port for next usage\n+                saveRunningDevServerPort();\n+                watchDog.set(null);\n+                return;\n+            }\n+            throw new IllegalStateException(String.format(\n+                    \"%s webpack-dev-server port '%d' is defined but it's not working properly\",\n+                    START_FAILURE, port));\n+        }\n+        // here the port == 0\n+        Pair<File, File> webPackFiles = validateFiles(npmFolder);\n+\n+        long start = System.nanoTime();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5fc7f5835f53b03a6cac7f74997153e0f1bdb020"}, "originalPosition": 432}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA3MzkwMw==", "bodyText": "I'm sure this has been discussed earlier too, but I'm going still ask: why do we need to explicitly wait for it in tests instead of just fixing TB or Flow's wait for Vaadin to handle it automatically when devserver is being run ?", "url": "https://github.com/vaadin/flow/pull/8925#discussion_r482073903", "createdAt": "2020-09-02T13:36:13Z", "author": {"login": "pleku"}, "path": "flow-test-util/src/main/java/com/vaadin/flow/testutil/TestBenchHelpers.java", "diffHunk": "@@ -398,6 +398,19 @@ protected void checkLogsForErrors() {\n         checkLogsForErrors(msg -> false);\n     }\n \n+    /**\n+     * If dev server start in progress wait until it's started. Otherwise return\n+     * immidiately.\n+     */\n+    protected void waitForDevServer() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5fc7f5835f53b03a6cac7f74997153e0f1bdb020"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA3OTE0MQ==", "bodyText": "Maybe might be a good clarifying comment to the test that this is not really part of the test, but instead just for waiting for the devserver to be done", "url": "https://github.com/vaadin/flow/pull/8925#discussion_r482079141", "createdAt": "2020-09-02T13:43:40Z", "author": {"login": "pleku"}, "path": "flow-tests/test-npm-only-features/test-npm-performance-regression/src/test/java/com/vaadin/flow/testnpmonlyfeatures/performanceregression/StartupPerformanceIT.java", "diffHunk": "@@ -25,18 +25,29 @@\n \n import org.junit.Assert;\n import org.junit.Test;\n+import org.openqa.selenium.By;\n \n-public class StartupPerformanceIT {\n+import com.vaadin.flow.testutil.ChromeBrowserTest;\n+\n+public class StartupPerformanceIT extends ChromeBrowserTest {\n     @Test\n-    public void devModeInitializerToWebpackUpIsBelow5500ms() {\n+    public void devModeInitializerToWebpackUpIsBelowThreshold() {\n+        getDriver().get(getRootURL());\n+        waitForDevServer();\n+\n+        long timeoutTime = System.currentTimeMillis() + 20000;\n+        while (System.currentTimeMillis() < timeoutTime\n+                && !isElementPresent(By.id(\"performance-component\"))) {\n+            getDriver().navigate().refresh();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5fc7f5835f53b03a6cac7f74997153e0f1bdb020"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA4OTE1Mw==", "bodyText": "This test class is ignored for flakiness for Java 11 and PR validation (?).\nIt could instead be configured for the surefire plugin to be included/excluded in certain JDK version activated profile. Now it seems to me we are never running this test even though it might pass.\nBut I suppose this is a non-blocking comment...", "url": "https://github.com/vaadin/flow/pull/8925#discussion_r482089153", "createdAt": "2020-09-02T13:56:43Z", "author": {"login": "pleku"}, "path": "flow-server/src/test/java/com/vaadin/flow/server/DevModeHandlerStopTest.java", "diffHunk": "@@ -93,7 +94,8 @@ public void devModeHandler_should_StopWebPack() throws Exception {\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5fc7f5835f53b03a6cac7f74997153e0f1bdb020"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77b08605d70c92f0eaa8a659e88266ad88489a0b", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/77b08605d70c92f0eaa8a659e88266ad88489a0b", "committedDate": "2020-09-03T05:58:14Z", "message": "Start execution time measurement along with web pack process start"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2729a22dd4f0c916e3251240b17f0646f70a71b7", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/2729a22dd4f0c916e3251240b17f0646f70a71b7", "committedDate": "2020-09-03T06:04:29Z", "message": "add a comment for waiting dev server"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxNTE5MzE3", "url": "https://github.com/vaadin/flow/pull/8925#pullrequestreview-481519317", "createdAt": "2020-09-03T06:12:31Z", "commit": {"oid": "2729a22dd4f0c916e3251240b17f0646f70a71b7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwNjoxMjozMVrOHMXSzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwNjoxMjozMVrOHMXSzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcyNjYwNA==", "bodyText": "But this issue is for 15+ so why is it picked for 14 ??? It should not be here. 14 should have 5500", "url": "https://github.com/vaadin/flow/pull/8925#discussion_r482726604", "createdAt": "2020-09-03T06:12:31Z", "author": {"login": "pleku"}, "path": "flow-tests/test-npm-only-features/test-npm-performance-regression/src/test/java/com/vaadin/flow/testnpmonlyfeatures/performanceregression/StartupPerformanceIT.java", "diffHunk": "@@ -25,22 +25,37 @@\n \n import org.junit.Assert;\n import org.junit.Test;\n+import org.openqa.selenium.By;\n \n-public class StartupPerformanceIT {\n+import com.vaadin.flow.testutil.ChromeBrowserTest;\n+\n+public class StartupPerformanceIT extends ChromeBrowserTest {\n     @Test\n-    public void devModeInitializerToWebpackUpIsBelow5500ms() {\n+    public void devModeInitializerToWebpackUpIsBelowThreshold() {\n+        getDriver().get(getRootURL());\n+        waitForDevServer();\n+\n+        // wait until dev server is ready and the component is rendered\n+        long timeoutTime = System.currentTimeMillis() + 20000;\n+        while (System.currentTimeMillis() < timeoutTime\n+                && !isElementPresent(By.id(\"performance-component\"))) {\n+            getDriver().navigate().refresh();\n+        }\n+\n         int startupTime = measureLogEntryTimeDistance(\n                 \"- Starting dev-mode updaters in\",\n                 \"- (Started|Reusing) webpack-dev-server\", true);\n \n         int npmInstallTime = measureLogEntryTimeDistance(\n                 \"- Running `pnpm install`\",\n-                \"- Frontend dependencies resolved successfully\",\n-                false);\n+                \"- Frontend dependencies resolved successfully\", false);\n \n         int startupTimeWithoutNpmInstallTime = startupTime - npmInstallTime;\n \n-        final int thresholdMs = 5500;\n+        // https://github.com/vaadin/flow/issues/7596", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2729a22dd4f0c916e3251240b17f0646f70a71b7"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba109798705996eaa2c39b0ca0fe52027f6caaa1", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/ba109798705996eaa2c39b0ca0fe52027f6caaa1", "committedDate": "2020-09-03T06:20:24Z", "message": "Remove CCDM code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2150390d7066b1c4d1fade1e25c90cbca02016bc", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/2150390d7066b1c4d1fade1e25c90cbca02016bc", "committedDate": "2020-09-03T06:26:49Z", "message": "Add a comment about dev server waiting workaround"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxNTI3Nzg3", "url": "https://github.com/vaadin/flow/pull/8925#pullrequestreview-481527787", "createdAt": "2020-09-03T06:30:03Z", "commit": {"oid": "2150390d7066b1c4d1fade1e25c90cbca02016bc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 123, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}