{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxMjU0NzA4", "number": 9558, "title": "feat: Resource handling to not need plugin copying", "bodyText": "Fixed the url handling so that theme resources\nget prepended with theme/[themeName] while\nhaving the correct absolute path. With this we can handle\nthese url resources with the css-loader which in turn\nleads to file-loader gettign the files for copying.\nExternal url are still not touched in any way.\npart of #9410 and #9533", "createdAt": "2020-12-02T19:55:38Z", "url": "https://github.com/vaadin/flow/pull/9558", "merged": true, "mergeCommit": {"oid": "a635dc68edca91cb74af6dec4f4150e756fbf579"}, "closed": true, "closedAt": "2020-12-04T07:07:49Z", "author": {"login": "caalador"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdibzPeAH2gAyNTMxMjU0NzA4OjJjM2ExYjY2OGM1MDZiMDcwMTE4NjZlOTJhYTlhYWZkM2MyZjY4NTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiyDlrAFqTU0NDY5NDc3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2c3a1b668c506b07011866e92aa9aafd3c2f6855", "author": {"user": {"login": "caalador", "name": null}}, "url": "https://github.com/vaadin/flow/commit/2c3a1b668c506b07011866e92aa9aafd3c2f6855", "committedDate": "2020-12-03T04:54:04Z", "message": "feat: Resource handling to not need plugin copying\n\nFixed the url handling so that theme resources\nget prepended with theme/[themeName] while\nhaving the correct absolute path. With this we can handle\nthese url resources with the css-loader which in turn\nleads to file-loader gettign the files for copying.\n\nExternal url are still not touched in any way.\n\nOnly negative is now we loose any folder the resources\nwere located at."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "446164f423a5f8a3d3266eaea3aad6e8721820fc", "author": {"user": {"login": "caalador", "name": null}}, "url": "https://github.com/vaadin/flow/commit/446164f423a5f8a3d3266eaea3aad6e8721820fc", "committedDate": "2020-12-02T19:54:19Z", "message": "feat: Resource handling to not need plugin copying\n\nFixed the url handling so that theme resources\nget prepended with theme/[themeName] while\nhaving the correct absolute path. With this we can handle\nthese url resources with the css-loader which in turn\nleads to file-loader gettign the files for copying.\n\nExternal url are still not touched in any way.\n\nOnly negative is now we loose any folder the resources\nwere located at."}, "afterCommit": {"oid": "2c3a1b668c506b07011866e92aa9aafd3c2f6855", "author": {"user": {"login": "caalador", "name": null}}, "url": "https://github.com/vaadin/flow/commit/2c3a1b668c506b07011866e92aa9aafd3c2f6855", "committedDate": "2020-12-03T04:54:04Z", "message": "feat: Resource handling to not need plugin copying\n\nFixed the url handling so that theme resources\nget prepended with theme/[themeName] while\nhaving the correct absolute path. With this we can handle\nthese url resources with the css-loader which in turn\nleads to file-loader gettign the files for copying.\n\nExternal url are still not touched in any way.\n\nOnly negative is now we loose any folder the resources\nwere located at."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzNzgwOTcy", "url": "https://github.com/vaadin/flow/pull/9558#pullrequestreview-543780972", "createdAt": "2020-12-03T09:52:54Z", "commit": {"oid": "2c3a1b668c506b07011866e92aa9aafd3c2f6855"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwOTo1Mjo1NFrOH-PjUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMDowMDowMFrOH-QEjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTAyODU2MA==", "bodyText": "Should the docs above be updated to mention that this copies only node modules files ?", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535028560", "createdAt": "2020-12-03T09:52:54Z", "author": {"login": "pleku"}, "path": "flow-server/src/main/resources/plugins/application-theme-plugin/theme-copy.js", "diffHunk": "@@ -23,44 +23,6 @@ const fs = require('fs');\n const path = require('path');\n const glob = require('glob');\n \n-/**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c3a1b668c506b07011866e92aa9aafd3c2f6855"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTAzMjAxNQ==", "bodyText": "Not sure if these checks could be just combined to one debug log that outputs what is happening (also NIT missing whitespace)", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535032015", "createdAt": "2020-12-03T09:55:47Z", "author": {"login": "pleku"}, "path": "flow-server/src/main/resources/webpack.generated.js", "diffHunk": "@@ -179,7 +179,14 @@ module.exports = {\n             options: {\n               url: (url, resourcePath) => {\n                 // Only translate files from node_modules\n-                return resourcePath.includes('/node_modules/');\n+                const resolve = resourcePath.match(/(\\\\|\\/)node_modules\\1/);\n+                const themResource = resourcePath.match(/(\\\\|\\/)theme\\1[\\s\\S]*?\\1/) && url.match(/theme\\/[\\s\\S]*?\\//);\n+                if(resolve) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c3a1b668c506b07011866e92aa9aafd3c2f6855"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTAzNzA3MQ==", "bodyText": "If I understood correctly, the comments for the theme-loader below are not valid anymore as it is not aboud VAADIN/static but the  theme/[themeFolder]", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535037071", "createdAt": "2020-12-03T10:00:00Z", "author": {"login": "pleku"}, "path": "flow-server/src/main/resources/webpack.generated.js", "diffHunk": "@@ -179,7 +179,14 @@ module.exports = {\n             options: {\n               url: (url, resourcePath) => {\n                 // Only translate files from node_modules\n-                return resourcePath.includes('/node_modules/');\n+                const resolve = resourcePath.match(/(\\\\|\\/)node_modules\\1/);\n+                const themResource = resourcePath.match(/(\\\\|\\/)theme\\1[\\s\\S]*?\\1/) && url.match(/theme\\/[\\s\\S]*?\\//);\n+                if(resolve) {\n+                  console.debug(\"Inlining node_module resource: \", url);\n+                } else if(themResource) {\n+                  console.debug(\"Handling theme resource: \", url);\n+                }\n+                return resolve || themResource;\n               },\n               // use theme-loader to also handle any imports in css files\n               importLoaders: 1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c3a1b668c506b07011866e92aa9aafd3c2f6855"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fcbdc3600817dadf2b01ff8e13a2be69237263b", "author": {"user": {"login": "caalador", "name": null}}, "url": "https://github.com/vaadin/flow/commit/0fcbdc3600817dadf2b01ff8e13a2be69237263b", "committedDate": "2020-12-03T10:42:05Z", "message": "Update comments and logging."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "daec031b9b2c3b459786e3e466b4eb1c89a59164", "author": {"user": {"login": "caalador", "name": null}}, "url": "https://github.com/vaadin/flow/commit/daec031b9b2c3b459786e3e466b4eb1c89a59164", "committedDate": "2020-12-03T11:03:46Z", "message": "Fix file loader to use the correct path."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzODE4NDkw", "url": "https://github.com/vaadin/flow/pull/9558#pullrequestreview-543818490", "createdAt": "2020-12-03T10:35:54Z", "commit": {"oid": "2c3a1b668c506b07011866e92aa9aafd3c2f6855"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMDozNTo1NFrOH-Si2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMDo0MTo0OVrOH-S82Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTA3NzU5Mw==", "bodyText": "It's still valid as the theme-loader handles the resources to be in the theme/my-theme format and css loader should give it any css imports to check also.", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535077593", "createdAt": "2020-12-03T10:35:54Z", "author": {"login": "caalador"}, "path": "flow-server/src/main/resources/webpack.generated.js", "diffHunk": "@@ -179,7 +179,14 @@ module.exports = {\n             options: {\n               url: (url, resourcePath) => {\n                 // Only translate files from node_modules\n-                return resourcePath.includes('/node_modules/');\n+                const resolve = resourcePath.match(/(\\\\|\\/)node_modules\\1/);\n+                const themResource = resourcePath.match(/(\\\\|\\/)theme\\1[\\s\\S]*?\\1/) && url.match(/theme\\/[\\s\\S]*?\\//);\n+                if(resolve) {\n+                  console.debug(\"Inlining node_module resource: \", url);\n+                } else if(themResource) {\n+                  console.debug(\"Handling theme resource: \", url);\n+                }\n+                return resolve || themResource;\n               },\n               // use theme-loader to also handle any imports in css files\n               importLoaders: 1", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTAzNzA3MQ=="}, "originalCommit": {"oid": "2c3a1b668c506b07011866e92aa9aafd3c2f6855"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTA3OTQ4OA==", "bodyText": "But they are 2 different handles so you get more information about what is happening when they are differentiated as the url printed won't give you the path info and you don't really want or need the full resource path in the log.", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535079488", "createdAt": "2020-12-03T10:37:33Z", "author": {"login": "caalador"}, "path": "flow-server/src/main/resources/webpack.generated.js", "diffHunk": "@@ -179,7 +179,14 @@ module.exports = {\n             options: {\n               url: (url, resourcePath) => {\n                 // Only translate files from node_modules\n-                return resourcePath.includes('/node_modules/');\n+                const resolve = resourcePath.match(/(\\\\|\\/)node_modules\\1/);\n+                const themResource = resourcePath.match(/(\\\\|\\/)theme\\1[\\s\\S]*?\\1/) && url.match(/theme\\/[\\s\\S]*?\\//);\n+                if(resolve) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTAzMjAxNQ=="}, "originalCommit": {"oid": "2c3a1b668c506b07011866e92aa9aafd3c2f6855"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTA4MTU3NA==", "bodyText": "updated that any copy functions should be here.", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535081574", "createdAt": "2020-12-03T10:39:28Z", "author": {"login": "caalador"}, "path": "flow-server/src/main/resources/plugins/application-theme-plugin/theme-copy.js", "diffHunk": "@@ -23,44 +23,6 @@ const fs = require('fs');\n const path = require('path');\n const glob = require('glob');\n \n-/**", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTAyODU2MA=="}, "originalCommit": {"oid": "2c3a1b668c506b07011866e92aa9aafd3c2f6855"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTA4NDI0OQ==", "bodyText": "Dropped the log altogether as it is not clear how it would help the developer in any way.", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535084249", "createdAt": "2020-12-03T10:41:49Z", "author": {"login": "caalador"}, "path": "flow-server/src/main/resources/webpack.generated.js", "diffHunk": "@@ -179,7 +179,14 @@ module.exports = {\n             options: {\n               url: (url, resourcePath) => {\n                 // Only translate files from node_modules\n-                return resourcePath.includes('/node_modules/');\n+                const resolve = resourcePath.match(/(\\\\|\\/)node_modules\\1/);\n+                const themResource = resourcePath.match(/(\\\\|\\/)theme\\1[\\s\\S]*?\\1/) && url.match(/theme\\/[\\s\\S]*?\\//);\n+                if(resolve) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTAzMjAxNQ=="}, "originalCommit": {"oid": "2c3a1b668c506b07011866e92aa9aafd3c2f6855"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8192a95215fa3e39a2a243e5ec25a3e502fc6d1d", "author": {"user": {"login": "caalador", "name": null}}, "url": "https://github.com/vaadin/flow/commit/8192a95215fa3e39a2a243e5ec25a3e502fc6d1d", "committedDate": "2020-12-03T11:06:54Z", "message": "Revert test paths"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzODg2MDE2", "url": "https://github.com/vaadin/flow/pull/9558#pullrequestreview-543886016", "createdAt": "2020-12-03T12:04:56Z", "commit": {"oid": "8192a95215fa3e39a2a243e5ec25a3e502fc6d1d"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMjowNDo1NlrOH-YDug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMjoyMTozNFrOH-Y_Rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE2NzkzMA==", "bodyText": "typo", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535167930", "createdAt": "2020-12-03T12:04:56Z", "author": {"login": "pleku"}, "path": "flow-server/src/main/resources/webpack.generated.js", "diffHunk": "@@ -179,7 +179,9 @@ module.exports = {\n             options: {\n               url: (url, resourcePath) => {\n                 // Only translate files from node_modules\n-                return resourcePath.includes('/node_modules/');\n+                const resolve = resourcePath.match(/(\\\\|\\/)node_modules\\1/);\n+                const themResource = resourcePath.match(/(\\\\|\\/)theme\\1[\\s\\S]*?\\1/) && url.match(/theme\\/[\\s\\S]*?\\//);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8192a95215fa3e39a2a243e5ec25a3e502fc6d1d"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE2OTc2Mg==", "bodyText": "Should this regex be somewhere so that it is named and shared for both usage (this & css-loader) ?", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535169762", "createdAt": "2020-12-03T12:06:57Z", "author": {"login": "pleku"}, "path": "flow-server/src/main/resources/webpack.generated.js", "diffHunk": "@@ -195,6 +197,23 @@ module.exports = {\n           }\n         ],\n       },\n+      {\n+        // File-loader only copies files used as imports in .js files or handled by css-loader\n+        test: /\\.(png|gif|jpg|jpeg|svg|eot|woff|woff2|ttf)$/,\n+        use: [{\n+          loader: 'file-loader',\n+          options: {\n+            outputPath: 'static/',\n+            name(resourcePath, resourceQuery) {\n+              const urlResource = resourcePath.substring(frontendFolder.length);\n+              if(urlResource.match(/(\\\\|\\/)theme\\1[\\s\\S]*?\\1/)){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8192a95215fa3e39a2a243e5ec25a3e502fc6d1d"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE4MjE3NA==", "bodyText": "Just to make sure, the frontendFolder will never end with / or \\ ?", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535182174", "createdAt": "2020-12-03T12:19:58Z", "author": {"login": "pleku"}, "path": "flow-server/src/main/resources/webpack.generated.js", "diffHunk": "@@ -195,6 +197,23 @@ module.exports = {\n           }\n         ],\n       },\n+      {\n+        // File-loader only copies files used as imports in .js files or handled by css-loader\n+        test: /\\.(png|gif|jpg|jpeg|svg|eot|woff|woff2|ttf)$/,\n+        use: [{\n+          loader: 'file-loader',\n+          options: {\n+            outputPath: 'static/',\n+            name(resourcePath, resourceQuery) {\n+              const urlResource = resourcePath.substring(frontendFolder.length);\n+              if(urlResource.match(/(\\\\|\\/)theme\\1[\\s\\S]*?\\1/)){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8192a95215fa3e39a2a243e5ec25a3e502fc6d1d"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE4MjY0Mw==", "bodyText": "Would it make sense to either use the output from the match above so there is only one regex operation ?", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535182643", "createdAt": "2020-12-03T12:20:45Z", "author": {"login": "pleku"}, "path": "flow-server/src/main/resources/webpack.generated.js", "diffHunk": "@@ -195,6 +197,23 @@ module.exports = {\n           }\n         ],\n       },\n+      {\n+        // File-loader only copies files used as imports in .js files or handled by css-loader\n+        test: /\\.(png|gif|jpg|jpeg|svg|eot|woff|woff2|ttf)$/,\n+        use: [{\n+          loader: 'file-loader',\n+          options: {\n+            outputPath: 'static/',\n+            name(resourcePath, resourceQuery) {\n+              const urlResource = resourcePath.substring(frontendFolder.length);\n+              if(urlResource.match(/(\\\\|\\/)theme\\1[\\s\\S]*?\\1/)){\n+                return /[\\s\\S]*(\\\\|\\/)theme\\1[\\s\\S]*?\\1(.*)/.exec(resourcePath)[2];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8192a95215fa3e39a2a243e5ec25a3e502fc6d1d"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE4MzE3NQ==", "bodyText": "Will this code be only executed for the currently active theme's resources as the theme name is not checked here ? I think so but just checking", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535183175", "createdAt": "2020-12-03T12:21:34Z", "author": {"login": "pleku"}, "path": "flow-server/src/main/resources/webpack.generated.js", "diffHunk": "@@ -195,6 +197,23 @@ module.exports = {\n           }\n         ],\n       },\n+      {\n+        // File-loader only copies files used as imports in .js files or handled by css-loader\n+        test: /\\.(png|gif|jpg|jpeg|svg|eot|woff|woff2|ttf)$/,\n+        use: [{\n+          loader: 'file-loader',\n+          options: {\n+            outputPath: 'static/',\n+            name(resourcePath, resourceQuery) {\n+              const urlResource = resourcePath.substring(frontendFolder.length);\n+              if(urlResource.match(/(\\\\|\\/)theme\\1[\\s\\S]*?\\1/)){\n+                return /[\\s\\S]*(\\\\|\\/)theme\\1[\\s\\S]*?\\1(.*)/.exec(resourcePath)[2];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8192a95215fa3e39a2a243e5ec25a3e502fc6d1d"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6dd25aa8caf03372e98202538ca61ed6db6fee21", "author": {"user": {"login": "caalador", "name": null}}, "url": "https://github.com/vaadin/flow/commit/6dd25aa8caf03372e98202538ca61ed6db6fee21", "committedDate": "2020-12-03T12:54:39Z", "message": "Use single regex for file- and css-loader\n\nUpdate url matcher to require that\ntheme/my-theme is in the beginning."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzOTQ5OTM2", "url": "https://github.com/vaadin/flow/pull/9558#pullrequestreview-543949936", "createdAt": "2020-12-03T13:26:56Z", "commit": {"oid": "6dd25aa8caf03372e98202538ca61ed6db6fee21"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d93000be9985d921dc485cec69ae3b4f7bdad69", "author": {"user": {"login": "caalador", "name": null}}, "url": "https://github.com/vaadin/flow/commit/6d93000be9985d921dc485cec69ae3b4f7bdad69", "committedDate": "2020-12-04T05:59:30Z", "message": "Update file path + name regex\n\nUpdated regex so we don't have a possible\nsuper-linear problem. (even though we handle file system paths not input)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0Njk0Nzc3", "url": "https://github.com/vaadin/flow/pull/9558#pullrequestreview-544694777", "createdAt": "2020-12-04T06:49:50Z", "commit": {"oid": "6d93000be9985d921dc485cec69ae3b4f7bdad69"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4598, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}