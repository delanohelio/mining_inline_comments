{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0NTg5MTY1", "number": 9451, "title": "feat: Serve theme static files from VAADIN/static", "bodyText": "Static files in META-INF/VAADIN/static will now be served\non request to VAADIN/static.\nAdded new webpack loader that changes app theme\ncss urls targeting ./ to be VAADIN/static/ instead.\nFixes #9405\nCloses #9286\nTouches #9430 which will still require the test.", "createdAt": "2020-11-20T09:58:34Z", "url": "https://github.com/vaadin/flow/pull/9451", "merged": true, "mergeCommit": {"oid": "18ee55985eaafba645535560d0ee7954406e2aa3"}, "closed": true, "closedAt": "2020-11-24T06:09:25Z", "author": {"login": "caalador"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeUWR6AH2gAyNTI0NTg5MTY1OmIwODhkODA1NjUyYjdkYjdhNjQyYjc3MmU1NjM1YjBkZDU1NzZhZDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfU82NgFqTUzNjQ1OTI5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b088d805652b7db7a642b772e5635b0dd5576ad3", "author": {"user": {"login": "caalador", "name": null}}, "url": "https://github.com/vaadin/flow/commit/b088d805652b7db7a642b772e5635b0dd5576ad3", "committedDate": "2020-11-20T09:57:24Z", "message": "feat: Serve theme static files from VAADIN/static\n\nStatic files in META-INF/VAADIN/static will now be served\non request to VAADIN/static.\nAdded new webpack loader that changes app theme\ncss urls targeting ./ to be VAADIN/static/ instead.\n\nFixes #9405"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1Mjk4ODY0", "url": "https://github.com/vaadin/flow/pull/9451#pullrequestreview-535298864", "createdAt": "2020-11-20T10:18:42Z", "commit": {"oid": "b088d805652b7db7a642b772e5635b0dd5576ad3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMDoxODo0MlrOH3Jn6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMDoxODo0MlrOH3Jn6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU5MTQwMg==", "bodyText": "Isn't that exactly the opposite of #9430?  @pleku", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r527591402", "createdAt": "2020-11-20T10:18:42Z", "author": {"login": "knoobie"}, "path": "flow-tests/test-themes/frontend/theme/app-theme/global.css", "diffHunk": "@@ -1,3 +1,3 @@\n body {\n-    background-image: url('theme/app-theme/img/bg.jpg');\n+    background-image: url(\"./img/bg.jpg\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b088d805652b7db7a642b772e5635b0dd5576ad3"}, "originalPosition": 3}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d25cc506118629a906121cd36f1e5830578da70a", "author": {"user": {"login": "caalador", "name": null}}, "url": "https://github.com/vaadin/flow/commit/d25cc506118629a906121cd36f1e5830578da70a", "committedDate": "2020-11-20T10:30:26Z", "message": "expect theme-loader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84588d133fa429fecfdc340fafd74f85c5ae00b3", "author": {"user": {"login": "caalador", "name": null}}, "url": "https://github.com/vaadin/flow/commit/84588d133fa429fecfdc340fafd74f85c5ae00b3", "committedDate": "2020-11-20T12:05:03Z", "message": "update: theme-loader only updates url if file exists by path."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25d12923738b3e98c65c1bfcaac93d76a4ae316b", "author": {"user": {"login": "caalador", "name": null}}, "url": "https://github.com/vaadin/flow/commit/25d12923738b3e98c65c1bfcaac93d76a4ae316b", "committedDate": "2020-11-20T12:52:07Z", "message": "Merge branch 'master' into issues/9405_theme_static_files\n\n# Conflicts:\n#\tflow-tests/test-themes/frontend/theme/app-theme/global.css"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb7d2d50f91fc64c5bb9e458a84af10e40846215", "author": {"user": {"login": "caalador", "name": null}}, "url": "https://github.com/vaadin/flow/commit/cb7d2d50f91fc64c5bb9e458a84af10e40846215", "committedDate": "2020-11-20T12:53:20Z", "message": "Fix theme test paths"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1Mzk5NjI2", "url": "https://github.com/vaadin/flow/pull/9451#pullrequestreview-535399626", "createdAt": "2020-11-20T12:49:09Z", "commit": {"oid": "84588d133fa429fecfdc340fafd74f85c5ae00b3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMjo0OTowOVrOH3OZNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMzoxNDozN1rOH3PLGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY2OTU1OQ==", "bodyText": "We could verify that a file that is not intended to be copied is not actually copied (and served), maybe like .css or theme.json", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r527669559", "createdAt": "2020-11-20T12:49:09Z", "author": {"login": "pleku"}, "path": "flow-server/src/test/java/com/vaadin/flow/server/StaticFileServerTest.java", "diffHunk": "@@ -488,6 +488,37 @@ public void serveStaticBundleBuildResource() throws IOException {\n         assertBundleBuildResource(pathInfo);\n     }\n \n+    @Test\n+    public void contextAndServletPath_serveStaticFileResource()\n+            throws IOException {\n+        String pathInfo = \"/VAADIN/static/img/bg.jpg\";\n+        setupRequestURI(\"/context\", \"/servlet\", pathInfo);\n+        assertBundleBuildResource(pathInfo);\n+    }\n+\n+    @Test\n+    public void ServletPath_serveStaticFileResource()\n+            throws IOException {\n+        String pathInfo = \"/VAADIN/static/img/bg.jpg\";\n+        setupRequestURI(\"\", \"/servlet\", pathInfo);\n+        assertBundleBuildResource(pathInfo);\n+    }\n+\n+    @Test\n+    public void contextPath_serveStaticFileResource()\n+            throws IOException {\n+        String pathInfo = \"/VAADIN/static/img/bg.jpg\";\n+        setupRequestURI(\"/context\", \"\", pathInfo);\n+        assertBundleBuildResource(pathInfo);\n+    }\n+\n+    @Test\n+    public void serveStaticFileResource() throws IOException {\n+        String pathInfo = \"/VAADIN/static/img/bg.jpg\";\n+        setupRequestURI(\"\", \"\", pathInfo);\n+        assertBundleBuildResource(pathInfo);\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84588d133fa429fecfdc340fafd74f85c5ae00b3"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY3MTI5MQ==", "bodyText": "I think if we check that the file exists either in the folder or inside a the parent theme .jar \ud83d\udc40 and only modify it then, we would be handling only the URLs that we should. But then ofc. it might be quite hard for the users to detect typos (?) if those only result in 404 on the page. Could do something for that, e.g. make them more visible in development mode", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r527671291", "createdAt": "2020-11-20T12:52:32Z", "author": {"login": "pleku"}, "path": "flow-tests/test-themes/frontend/theme/app-theme/global.css", "diffHunk": "@@ -1,3 +1,3 @@\n body {\n-    background-image: url('theme/app-theme/img/bg.jpg');\n+    background-image: url(\"./img/bg.jpg\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU5MTQwMg=="}, "originalCommit": {"oid": "b088d805652b7db7a642b772e5635b0dd5576ad3"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY3NjA0Mg==", "bodyText": "maybe clarify what theme files will be copied", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r527676042", "createdAt": "2020-11-20T13:01:56Z", "author": {"login": "pleku"}, "path": "flow-server/src/main/resources/plugins/application-theme-plugin/theme-copy.js", "diffHunk": "@@ -16,30 +16,23 @@\n \n /**\n  * This file handles copying of theme files to\n- * [staticResourcesFolder]/theme/[theme-name]\n+ * [staticResourcesFolder]\n  */\n \n const fs = require('fs');\n const path = require('path');\n \n /**\n- * create theme/themeName folders and copy theme files there.\n+ * copy theme files  to static assets folder.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb7d2d50f91fc64c5bb9e458a84af10e40846215"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY4MTExNA==", "bodyText": "I think to be reused you would have to make a new Regexp(...)", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r527681114", "createdAt": "2020-11-20T13:12:06Z", "author": {"login": "pleku"}, "path": "flow-server/src/main/resources/plugins/theme-loader/theme-loader.js", "diffHunk": "@@ -0,0 +1,26 @@\n+const fs = require('fs');\n+const path = require('path');\n+\n+const urlMatcher = /(url\\()(\\'|\\\")?(\\.\\/)(.*\\2\\))/g;\n+\n+module.exports = function (source, map) {\n+  const handledResourceFolder = path.dirname(this._module.resource);\n+  const logger = this.getLogger(\"theme-loader\");\n+\n+  // Collect groups [url(] [ |'|\"]optional './' and end of url\n+  source = source.replace(urlMatcher, function (match, url, quoteMark, replace, endString) {\n+    // for some reason this matcher can not be reused as a constant", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb7d2d50f91fc64c5bb9e458a84af10e40846215"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY4MjMzMA==", "bodyText": "Lets add another test which verifies that `url(\"../icons/icon.png\"); or similar works", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r527682330", "createdAt": "2020-11-20T13:14:37Z", "author": {"login": "pleku"}, "path": "flow-tests/test-themes/frontend/theme/app-theme/global.css", "diffHunk": "@@ -1,9 +1,9 @@\n @font-face {\n     font-family: \"Ostrich\";\n-    src: url(\"theme/app-theme/font/ostrich-sans-regular.ttf\") format(\"TrueType\");\n+    src: url(\"./font/ostrich-sans-regular.ttf\") format(\"TrueType\");\n }\n \n body {\n-    background-image: url('theme/app-theme/img/bg.jpg');\n+    background-image: url(\"./img/bg.jpg\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb7d2d50f91fc64c5bb9e458a84af10e40846215"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e63eb7c5408f09431f4d4c03f7fa00b19cbe725", "author": {"user": {"login": "caalador", "name": null}}, "url": "https://github.com/vaadin/flow/commit/7e63eb7c5408f09431f4d4c03f7fa00b19cbe725", "committedDate": "2020-11-23T09:34:33Z", "message": "Handle CSS imports with theme-loader\n\ncorrectly update urls with path navigation."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NDM3Njcw", "url": "https://github.com/vaadin/flow/pull/9451#pullrequestreview-536437670", "createdAt": "2020-11-23T12:44:14Z", "commit": {"oid": "7e63eb7c5408f09431f4d4c03f7fa00b19cbe725"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMjo0NDoxNFrOH4L3Yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMjo0NTozNFrOH4L6lA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY3NjcwNg==", "bodyText": "As looking at url(...) examples from MDN, it has\nlist-style-image: url('../images/bullet.jpg');\nso I think we should be able to have the same, ../ is less things to type than ./../.", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r528676706", "createdAt": "2020-11-23T12:44:14Z", "author": {"login": "pleku"}, "path": "flow-tests/test-themes/frontend/theme/app-theme/sub-css/sub.css", "diffHunk": "@@ -0,0 +1,6 @@\n+#sub-component {\n+    background: url('./../icons/archive.png') left top;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e63eb7c5408f09431f4d4c03f7fa00b19cbe725"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY3NzUyNA==", "bodyText": "So this IMO should handle ../ too and not just ./", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r528677524", "createdAt": "2020-11-23T12:45:34Z", "author": {"login": "pleku"}, "path": "flow-server/src/main/resources/plugins/theme-loader/theme-loader.js", "diffHunk": "@@ -1,23 +1,34 @@\n+const loaderUtils = require(\"loader-utils\");\n const fs = require('fs');\n const path = require('path');\n \n-const urlMatcher = /(url\\()(\\'|\\\")?(\\.\\/)(.*\\2\\))/g;\n+// Collect groups [url(] [ |'|\"]optional './', file part and end of url\n+const urlMatcher = /(url\\()(\\'|\\\")?(\\.\\/)(\\S*)(\\2\\))/g;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e63eb7c5408f09431f4d4c03f7fa00b19cbe725"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9563620d6e7b27d3df59da538c1acd2d0c9f2199", "author": {"user": {"login": "caalador", "name": null}}, "url": "https://github.com/vaadin/flow/commit/9563620d6e7b27d3df59da538c1acd2d0c9f2199", "committedDate": "2020-11-23T13:05:49Z", "message": "Accept ./ and ../ on URL"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NDU5Mjk3", "url": "https://github.com/vaadin/flow/pull/9451#pullrequestreview-536459297", "createdAt": "2020-11-23T13:13:27Z", "commit": {"oid": "9563620d6e7b27d3df59da538c1acd2d0c9f2199"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4524, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}