{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExNjIxMDIy", "number": 9258, "title": "fix(offline): resolve offlineResources at runtime", "bodyText": "Depending on servlet container type and configuration, offline resources\nmay be served from multiple different file system locations, which cannot\nbe predicted for the resources to be handled by webpack. Revert to runtime\nresolution by the applicatiton.\nFixes #8996.", "createdAt": "2020-10-28T15:09:01Z", "url": "https://github.com/vaadin/flow/pull/9258", "merged": true, "mergeCommit": {"oid": "2c4db5ae903750a44fb223b157cd3d669389e6fb"}, "closed": true, "closedAt": "2020-10-30T11:08:07Z", "author": {"login": "joheriks"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdW_pzfgBqjM5MzIwMzk0OTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXkYJXgFqTUyMDU0OTQzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b0642098929eac12c6288ec87a4f5f84b568f681", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/b0642098929eac12c6288ec87a4f5f84b568f681", "committedDate": "2020-10-28T15:07:01Z", "message": "fix: resolve offlineResources at runtime"}, "afterCommit": {"oid": "ef27d8b7498544e7bc358a4267c400aa7c5fb724", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/ef27d8b7498544e7bc358a4267c400aa7c5fb724", "committedDate": "2020-10-28T15:52:49Z", "message": "fix: resolve offlineResources at runtime"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4ODIxMDcw", "url": "https://github.com/vaadin/flow/pull/9258#pullrequestreview-518821070", "createdAt": "2020-10-28T15:56:09Z", "commit": {"oid": "ef27d8b7498544e7bc358a4267c400aa7c5fb724"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNTo1NjowOVrOHpxRtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNTo1NjowOVrOHpxRtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU2MTAxMg==", "bodyText": "Note. I have replaced the previous version of exists which checked for existence by connecting directly to the server with one that goes via the browser. This makes the test more end-to-end, and allows testing the caching of resources in offline mode.", "url": "https://github.com/vaadin/flow/pull/9258#discussion_r513561012", "createdAt": "2020-10-28T15:56:09Z", "author": {"login": "joheriks"}, "path": "flow-tests/test-pwa/src/test/java/com/vaadin/flow/pwatest/ui/PwaTestIT.java", "diffHunk": "@@ -202,22 +222,22 @@ private void checkIcons(List<WebElement> icons, int expected) {\n         }\n     }\n \n-    private boolean exists(String URLName) {\n-        URLName = URLName.startsWith(\"http\") ? URLName\n-                : getRootURL() + \"/\" + URLName;\n-        try {\n-            HttpURLConnection.setFollowRedirects(false);\n-            HttpURLConnection con = (HttpURLConnection) new URL(URLName)\n-                    .openConnection();\n-            con.setInstanceFollowRedirects(false);\n-            con.setRequestMethod(\"HEAD\");\n-            return (con.getResponseCode() == HttpURLConnection.HTTP_OK);\n-        } catch (Exception e) {\n-            e.printStackTrace();\n-            return false;\n+    private void checkResources(String... resources) {\n+        for (String url : resources) {\n+            Assert.assertTrue(url + \" didn't respond with resource\",\n+                    exists(url));\n         }\n     }\n \n+    private boolean exists(String url) {\n+        final String script = \"const resolve = arguments[0];\" + \"fetch('\" + url\n+                + \"', {method: 'HEAD'})\"\n+                + \".then(response => resolve(response.status===200 && !response.redirected))\"\n+                + \".catch(err => resolve(false));\";\n+        return (boolean) ((JavascriptExecutor) getDriver())\n+                .executeAsyncScript(script);\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef27d8b7498544e7bc358a4267c400aa7c5fb724"}, "originalPosition": 93}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ef27d8b7498544e7bc358a4267c400aa7c5fb724", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/ef27d8b7498544e7bc358a4267c400aa7c5fb724", "committedDate": "2020-10-28T15:52:49Z", "message": "fix: resolve offlineResources at runtime"}, "afterCommit": {"oid": "ede0d14200a68599849a3b9d62facc4e83bc611f", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/ede0d14200a68599849a3b9d62facc4e83bc611f", "committedDate": "2020-10-28T16:56:27Z", "message": "fix: resolve offlineResources at runtime"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8e3119fd750d07b569c18f3883d4934f036bfa4f", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/8e3119fd750d07b569c18f3883d4934f036bfa4f", "committedDate": "2020-10-28T20:04:12Z", "message": "Attempt --disable-dev-shm-usage"}, "afterCommit": {"oid": "9caa83b522d57d3915770b1ac04882918c35ade3", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/9caa83b522d57d3915770b1ac04882918c35ade3", "committedDate": "2020-10-28T20:43:27Z", "message": "Attempt --no-sandbox --disable-dev-shm-usage"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9caa83b522d57d3915770b1ac04882918c35ade3", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/9caa83b522d57d3915770b1ac04882918c35ade3", "committedDate": "2020-10-28T20:43:27Z", "message": "Attempt --no-sandbox --disable-dev-shm-usage"}, "afterCommit": {"oid": "043a9f633c2f9252f68e568a7ec0ed858121744a", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/043a9f633c2f9252f68e568a7ec0ed858121744a", "committedDate": "2020-10-28T21:11:50Z", "message": "fix: resolve offlineResources at runtime"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b40906e30a983f2f87ecc50a2c57f43f483f2b3c", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/b40906e30a983f2f87ecc50a2c57f43f483f2b3c", "committedDate": "2020-10-28T21:32:00Z", "message": "Run ITs in sequence"}, "afterCommit": {"oid": "87967433547b16cddd679ef7d1cfe00aeb3d56ce", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/87967433547b16cddd679ef7d1cfe00aeb3d56ce", "committedDate": "2020-10-29T07:17:18Z", "message": "Run ITs in sequence"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5NDQ0Mjc0", "url": "https://github.com/vaadin/flow/pull/9258#pullrequestreview-519444274", "createdAt": "2020-10-29T08:49:37Z", "commit": {"oid": "87967433547b16cddd679ef7d1cfe00aeb3d56ce"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwODo0OTozN1rOHqRvuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwOTowMDoxOFrOHqSJRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA5Mjk4NA==", "bodyText": "When checking for these resources, it would be nice to check that it's actually the correct content returned (check content hash or at least content length) as it's possible to introduce bugs in the service worker that would return the same, or just some incorrect HTTP 200, response for any URL.\nJust a thought. We could add another test later specifically for testing that, so no change would be needed here necessarily.", "url": "https://github.com/vaadin/flow/pull/9258#discussion_r514092984", "createdAt": "2020-10-29T08:49:37Z", "author": {"login": "Haprog"}, "path": "flow-tests/test-pwa/src/test/java/com/vaadin/flow/pwatest/ui/PwaTestIT.java", "diffHunk": "@@ -202,22 +239,22 @@ private void checkIcons(List<WebElement> icons, int expected) {\n         }\n     }\n \n-    private boolean exists(String URLName) {\n-        URLName = URLName.startsWith(\"http\") ? URLName\n-                : getRootURL() + \"/\" + URLName;\n-        try {\n-            HttpURLConnection.setFollowRedirects(false);\n-            HttpURLConnection con = (HttpURLConnection) new URL(URLName)\n-                    .openConnection();\n-            con.setInstanceFollowRedirects(false);\n-            con.setRequestMethod(\"HEAD\");\n-            return (con.getResponseCode() == HttpURLConnection.HTTP_OK);\n-        } catch (Exception e) {\n-            e.printStackTrace();\n-            return false;\n+    private void checkResources(String... resources) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87967433547b16cddd679ef7d1cfe00aeb3d56ce"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA5NzA3MQ==", "bodyText": "I think we should check that getOfflinePath() is not an empty string (or null) before we try to precache it.", "url": "https://github.com/vaadin/flow/pull/9258#discussion_r514097071", "createdAt": "2020-10-29T08:56:27Z", "author": {"login": "Haprog"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/PwaRegistry.java", "diffHunk": "@@ -226,17 +227,31 @@ private JsonObject initializeManifest() {\n         return manifestData;\n     }\n \n-    private String initializeRuntimeServiceWorker() {\n+    private String initializeRuntimeServiceWorker(ServletContext servletContext) {\n         StringBuilder stringBuilder = new StringBuilder();\n \n         // List of icons for precache\n         List<String> filesToCache = getIcons().stream()\n                 .filter(PwaIcon::shouldBeCached).map(PwaIcon::getCacheFormat)\n                 .collect(Collectors.toList());\n \n+        // When offlinePath is in use, it is also an offline resource to\n+        // precache\n+        if (pwaConfiguration.isEnabled()) {\n+            filesToCache.add(offlinePageCache());\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87967433547b16cddd679ef7d1cfe00aeb3d56ce"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA5OTUyNQ==", "bodyText": "What does this (and the above @NotThreadSafe) actually do?", "url": "https://github.com/vaadin/flow/pull/9258#discussion_r514099525", "createdAt": "2020-10-29T09:00:18Z", "author": {"login": "Haprog"}, "path": "flow-tests/test-pwa/src/test/java/com/vaadin/flow/pwatest/ui/PwaTestIT.java", "diffHunk": "@@ -38,12 +43,24 @@\n import com.google.gwt.thirdparty.json.JSONObject;\n import com.vaadin.flow.testutil.ChromeDeviceTest;\n \n+@NotThreadSafe\n public class PwaTestIT extends ChromeDeviceTest {\n \n+    static private Lock lock = new ReentrantLock();\n+\n+    @Before\n+    public void start() {\n+        lock.lock();\n+    }\n+\n+    @After\n+    public void done() {\n+        lock.unlock();\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87967433547b16cddd679ef7d1cfe00aeb3d56ce"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5NjE1MTI0", "url": "https://github.com/vaadin/flow/pull/9258#pullrequestreview-519615124", "createdAt": "2020-10-29T12:32:49Z", "commit": {"oid": "94c78ab57331aae4489a231f78ee6df0449c9577"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5d6317184b059e1922591e0f5b9f246e80f314c5", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/5d6317184b059e1922591e0f5b9f246e80f314c5", "committedDate": "2020-10-29T13:41:21Z", "message": "Extracted waitForServiceWorkerReady"}, "afterCommit": {"oid": "4522e1130b5fa4d500baa43fe7a44c8b0d361588", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/4522e1130b5fa4d500baa43fe7a44c8b0d361588", "committedDate": "2020-10-29T13:42:45Z", "message": "Extracted waitForServiceWorkerReady"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4522e1130b5fa4d500baa43fe7a44c8b0d361588", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/4522e1130b5fa4d500baa43fe7a44c8b0d361588", "committedDate": "2020-10-29T13:42:45Z", "message": "Extracted waitForServiceWorkerReady"}, "afterCommit": {"oid": "a1939f2025ef0483d5fa4ba7399fd2a2a6b92565", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/a1939f2025ef0483d5fa4ba7399fd2a2a6b92565", "committedDate": "2020-10-29T21:03:53Z", "message": "Extracted waitForServiceWorkerReady"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a1939f2025ef0483d5fa4ba7399fd2a2a6b92565", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/a1939f2025ef0483d5fa4ba7399fd2a2a6b92565", "committedDate": "2020-10-29T21:03:53Z", "message": "Extracted waitForServiceWorkerReady"}, "afterCommit": {"oid": "e41e251c9a502e709c3fcb7af9e119b9e5606aef", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/e41e251c9a502e709c3fcb7af9e119b9e5606aef", "committedDate": "2020-10-29T21:12:29Z", "message": "Extracted waitForServiceWorkerReady"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "060268916a5af890bf472177b4af7c07df5eef38", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/060268916a5af890bf472177b4af7c07df5eef38", "committedDate": "2020-10-30T09:41:52Z", "message": "fix: resolve offlineResources at runtime"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4efe4e6d0231a2b69bbcaba9fb0ab0d9f61c9cd", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/f4efe4e6d0231a2b69bbcaba9fb0ab0d9f61c9cd", "committedDate": "2020-10-30T09:41:52Z", "message": "Run ITs in sequence"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e1fe8806afe52b1e58d29f8f8e9c4c32114958e", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/2e1fe8806afe52b1e58d29f8f8e9c4c32114958e", "committedDate": "2020-10-30T09:41:52Z", "message": "Check isOfflinePathEnabled when deciding about precaching offline html"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58aebe95702450943a168fad487302cdaba2d5b1", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/58aebe95702450943a168fad487302cdaba2d5b1", "committedDate": "2020-10-30T09:41:52Z", "message": "Removed IT sequential forcing, added mimeType check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2535ae45e97e76369fe456265e6cf81fd9ac5592", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/2535ae45e97e76369fe456265e6cf81fd9ac5592", "committedDate": "2020-10-30T09:45:16Z", "message": "waitForServiceWorkerReady"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e41e251c9a502e709c3fcb7af9e119b9e5606aef", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/e41e251c9a502e709c3fcb7af9e119b9e5606aef", "committedDate": "2020-10-29T21:12:29Z", "message": "Extracted waitForServiceWorkerReady"}, "afterCommit": {"oid": "2535ae45e97e76369fe456265e6cf81fd9ac5592", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/2535ae45e97e76369fe456265e6cf81fd9ac5592", "committedDate": "2020-10-30T09:45:16Z", "message": "waitForServiceWorkerReady"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNTQ5NDMy", "url": "https://github.com/vaadin/flow/pull/9258#pullrequestreview-520549432", "createdAt": "2020-10-30T10:40:27Z", "commit": {"oid": "2535ae45e97e76369fe456265e6cf81fd9ac5592"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4747, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}