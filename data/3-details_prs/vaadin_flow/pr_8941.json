{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4NTQ3OTc3", "number": 8941, "title": "feat(offline): emit offline resources list in generated webpack config", "bodyText": "Connected to #8912\nThis does a necessary ground work for emitting PWA configuration in webpack.generated.js. Done so far:\n\nPwaConfiguration is now public, to enable usage from TaskUpdateWebpack\nPwaConfiguration does not depend on ServiceContext, which is unavailable during build. PwaRegistry is changed accordingly.\nTaskUpdateWeback is moved from prepare-frontend to build-frontend, so that it could find the annotation in compiled classes\nwebpack.generated.js template now includes a list of offline resources coming from PwaConfiguration\nIn NodeTasks, the TaskUpdateWebpack is now enqueued using a default PwaConfiguration\nDevModeInitializer always runs TaskUpdateWebpack, to ensure that it is up-to-date\n\nRemains TBD in scope of the ticket: use frontend scanner to find the @PWA annotation and construct PwaConfiguration based on that. I guess this is coming in a separate PR, as this quite big already.", "createdAt": "2020-09-03T11:02:38Z", "url": "https://github.com/vaadin/flow/pull/8941", "merged": true, "mergeCommit": {"oid": "b937ebb03ce29fe8e4e2fbccef6209a39b21e5f7"}, "closed": true, "closedAt": "2020-09-08T13:07:32Z", "author": {"login": "platosha"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFRSk6ABqjM3MjQ5NjUwOTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdG3SBvgFqTQ4NDExMTE5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "428821070a329c0931706ffeb0ed01b4e09a3b91", "author": {"user": {"login": "platosha", "name": "Anton Platonov"}}, "url": "https://github.com/vaadin/flow/commit/428821070a329c0931706ffeb0ed01b4e09a3b91", "committedDate": "2020-09-03T10:59:40Z", "message": "--wip-- [skip ci] feat(TypeScript): emit offline resources list in generated webpack config"}, "afterCommit": {"oid": "53bf3edcfd3f6ad08cef0470cbc1241e25c21e16", "author": {"user": {"login": "platosha", "name": "Anton Platonov"}}, "url": "https://github.com/vaadin/flow/commit/53bf3edcfd3f6ad08cef0470cbc1241e25c21e16", "committedDate": "2020-09-03T14:15:15Z", "message": "--wip-- [skip ci] feat(TypeScript): emit offline resources list in generated webpack config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1183fea3f8165d2502a6ca9dcf87dc45eabe3cb9", "author": {"user": {"login": "platosha", "name": "Anton Platonov"}}, "url": "https://github.com/vaadin/flow/commit/1183fea3f8165d2502a6ca9dcf87dc45eabe3cb9", "committedDate": "2020-09-04T11:41:54Z", "message": "feat(TypeScript): emit offline resources list in generated webpack config"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "53bf3edcfd3f6ad08cef0470cbc1241e25c21e16", "author": {"user": {"login": "platosha", "name": "Anton Platonov"}}, "url": "https://github.com/vaadin/flow/commit/53bf3edcfd3f6ad08cef0470cbc1241e25c21e16", "committedDate": "2020-09-03T14:15:15Z", "message": "--wip-- [skip ci] feat(TypeScript): emit offline resources list in generated webpack config"}, "afterCommit": {"oid": "1183fea3f8165d2502a6ca9dcf87dc45eabe3cb9", "author": {"user": {"login": "platosha", "name": "Anton Platonov"}}, "url": "https://github.com/vaadin/flow/commit/1183fea3f8165d2502a6ca9dcf87dc45eabe3cb9", "committedDate": "2020-09-04T11:41:54Z", "message": "feat(TypeScript): emit offline resources list in generated webpack config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed14081e923608a62f56f21d920660dbe702ca24", "author": {"user": {"login": "platosha", "name": "Anton Platonov"}}, "url": "https://github.com/vaadin/flow/commit/ed14081e923608a62f56f21d920660dbe702ca24", "committedDate": "2020-09-07T07:03:43Z", "message": "Move TaskUpdateWebpack from prepare-frontend to build-frontend"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7af567e3983836046dfd85d0afb661911a57e0bf", "author": {"user": {"login": "platosha", "name": "Anton Platonov"}}, "url": "https://github.com/vaadin/flow/commit/7af567e3983836046dfd85d0afb661911a57e0bf", "committedDate": "2020-09-07T12:01:00Z", "message": "Fix frontend build tests after moving TaskUpdateWebpack"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5c99402355388a6bcd97a026617ade974642300", "author": {"user": {"login": "platosha", "name": "Anton Platonov"}}, "url": "https://github.com/vaadin/flow/commit/c5c99402355388a6bcd97a026617ade974642300", "committedDate": "2020-09-08T08:25:42Z", "message": "Apply code analysis suggestions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "277ddb41c9f6256e5bbc353e456bea87646643c7", "author": {"user": {"login": "platosha", "name": "Anton Platonov"}}, "url": "https://github.com/vaadin/flow/commit/277ddb41c9f6256e5bbc353e456bea87646643c7", "committedDate": "2020-09-08T08:25:53Z", "message": "Always generate webpack config in DevModeInitialiser"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b7ae821ffa2990b49bc00304f4016239f1378e4b", "author": {"user": {"login": "platosha", "name": "Anton Platonov"}}, "url": "https://github.com/vaadin/flow/commit/b7ae821ffa2990b49bc00304f4016239f1378e4b", "committedDate": "2020-09-07T15:12:32Z", "message": "Apply code analysis suggestions"}, "afterCommit": {"oid": "277ddb41c9f6256e5bbc353e456bea87646643c7", "author": {"user": {"login": "platosha", "name": "Anton Platonov"}}, "url": "https://github.com/vaadin/flow/commit/277ddb41c9f6256e5bbc353e456bea87646643c7", "committedDate": "2020-09-08T08:25:53Z", "message": "Always generate webpack config in DevModeInitialiser"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1751c67bcf43cda5b66db91770e787e24fc85da", "author": {"user": {"login": "platosha", "name": "Anton Platonov"}}, "url": "https://github.com/vaadin/flow/commit/a1751c67bcf43cda5b66db91770e787e24fc85da", "committedDate": "2020-09-08T10:45:31Z", "message": "Increase duration threshold in StartupPerformanceIT"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0MDQ2MzI2", "url": "https://github.com/vaadin/flow/pull/8941#pullrequestreview-484046326", "createdAt": "2020-09-08T11:37:10Z", "commit": {"oid": "a1751c67bcf43cda5b66db91770e787e24fc85da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMTozNzoxMFrOHOY2pw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMTozNzoxMFrOHOY2pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg0OTMxOQ==", "bodyText": "Immediately return this expression instead of assigning it to the temporary variable \"relativePath\".", "url": "https://github.com/vaadin/flow/pull/8941#discussion_r484849319", "createdAt": "2020-09-08T11:37:10Z", "author": {"login": "vaadin-bot"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/TaskUpdateWebpack.java", "diffHunk": "@@ -139,82 +150,83 @@ private void createWebpackConfig() throws IOException {\n     private List<String> modifyWebpackConfig(File generatedFile)\n             throws IOException {\n         List<String> lines = FileUtils.readLines(generatedFile, \"UTF-8\");\n+        List<Pair<String, String>> replacements = getReplacements();\n+        String declaration = \"%s = %s;\";\n \n-        String frontendLine = \"const frontendFolder = require('path').resolve(__dirname, '\"\n-                + getEscapedRelativeWebpackPath(frontendDirectory) + \"');\";\n-\n-        String outputLine = \"const mavenOutputFolderForFlowBundledFiles = require('path').resolve(__dirname, '\"\n-                + getEscapedRelativeWebpackPath(webpackOutputPath) + \"');\";\n-        String mainLine = \"const fileNameOfTheFlowGeneratedMainEntryPoint = require('path').resolve(__dirname, '\"\n-                + getEscapedRelativeWebpackPath(flowImportsFilePath) + \"');\";\n-        String isClientSideBootstrapModeLine = \"const useClientSideIndexFileForBootstrapping = \"\n-                + !useV14Bootstrapping + \";\";\n-        String devModeGizmoJSLine = \"const devmodeGizmoJS = require('path').resolve(__dirname, '\"\n-                + getEscapedRelativeWebpackPath(\n-                        flowResourcesFolder.resolve(\"VaadinDevmodeGizmo.js\"))\n-                + \"');\";\n         for (int i = 0; i < lines.size(); i++) {\n-            if (lines.get(i).startsWith(\n-                    \"const fileNameOfTheFlowGeneratedMainEntryPoint\")) {\n-                lines.set(i, mainLine);\n-            }\n-            if (lines.get(i)\n-                    .startsWith(\"const mavenOutputFolderForFlowBundledFiles\")) {\n-                lines.set(i, outputLine);\n-            }\n-            if (lines.get(i).startsWith(\"const frontendFolder\")) {\n-                lines.set(i, frontendLine);\n-            }\n-            if (lines.get(i).startsWith(\"const useClientSideIndexFileForBootstrapping\")) {\n-                lines.set(i, isClientSideBootstrapModeLine);\n-            }\n-            if (lines.get(i).startsWith(\"const clientSideIndexHTML\")) {\n-                lines.set(i, getIndexHtmlPath());\n-            }\n-\n-            if (lines.get(i).startsWith(\"const clientSideIndexEntryPoint\")) {\n-                lines.set(i, getClientEntryPoint());\n-            }\n-\n-            if (lines.get(i).startsWith(\"const devmodeGizmoJS\")) {\n-                lines.set(i, devModeGizmoJSLine);\n+            for (int j = 0; j < replacements.size(); j++) {\n+                Pair<String, String> pair = replacements.get(j);\n+                if (lines.get(i).startsWith(pair.getFirst())) {\n+                    lines.set(i, String.format(declaration, pair.getFirst(),\n+                            pair.getSecond()));\n+                }\n             }\n         }\n         return lines;\n     }\n \n+    private List<Pair<String, String>> getReplacements() {\n+        return Arrays.asList(\n+                new Pair<>(\"const frontendFolder\",\n+                        \"require('path').resolve\" + \"(__dirname, '\"\n+                                + getEscapedRelativeWebpackPath(\n+                                        frontendDirectory)\n+                                + \"')\"),\n+                new Pair<>(\"const mavenOutputFolderForFlowBundledFiles\",\n+                        \"require('path').resolve(__dirname, '\"\n+                                + getEscapedRelativeWebpackPath(\n+                                        webpackOutputPath)\n+                                + \"')\"),\n+                new Pair<>(\"const fileNameOfTheFlowGeneratedMainEntryPoint\",\n+                        \"require('path').resolve(__dirname, '\"\n+                                + getEscapedRelativeWebpackPath(\n+                                        flowImportsFilePath)\n+                                + \"')\"),\n+                new Pair<>(\"const useClientSideIndexFileForBootstrapping\",\n+                        Boolean.toString(!useV14Bootstrapping)),\n+                new Pair<>(\"const clientSideIndexHTML\", getIndexHtmlPath()),\n+                new Pair<>(\"const clientSideIndexEntryPoint\",\n+                        getClientEntryPoint()),\n+                new Pair<>(\"const devmodeGizmoJS\",\n+                        \"require('path').resolve(__dirname, '\"\n+                                + getEscapedRelativeWebpackPath(\n+                                        flowResourcesFolder.resolve(\n+                                                \"VaadinDevmodeGizmo.js\"))\n+                                + \"')\"),\n+                new Pair<>(\"const offlineResources\",\n+                        getOfflineResourcesJsArray()));\n+    }\n+\n     private String getIndexHtmlPath() {\n         boolean exists = new File(frontendDirectory.toFile(), INDEX_HTML)\n                 .exists();\n-        String declaration = \"const clientSideIndexHTML = %s;\";\n         if (!exists) {\n             Path path = Paths.get(\n                     getEscapedRelativeWebpackPath(webpackConfigPath), TARGET,\n                     INDEX_HTML);\n             String relativePath = String.format(\n                     \"require('path').resolve(__dirname, '%s')\",\n                     getEscapedRelativeWebpackPath(path));\n-            return String.format(declaration, relativePath);\n+            return relativePath;\n         } else {\n-            return String.format(declaration, \"'./\" + INDEX_HTML +\"'\");\n+            return \"'./\" + INDEX_HTML +\"'\";\n         }\n     }\n \n     private String getClientEntryPoint() {\n         boolean exists = new File(frontendDirectory.toFile(), INDEX_TS)\n                 .exists()\n                 || new File(frontendDirectory.toFile(), INDEX_JS).exists();\n-        String declaration = \"const clientSideIndexEntryPoint = %s;\";\n         if (!exists) {\n             Path path = Paths.get(\n                     getEscapedRelativeWebpackPath(webpackConfigPath), TARGET,\n                     INDEX_TS);\n             String relativePath = String.format(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1751c67bcf43cda5b66db91770e787e24fc85da"}, "originalPosition": 166}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b87a830c37f854b75e7077ef7b98b609b489d20d", "author": {"user": {"login": "platosha", "name": "Anton Platonov"}}, "url": "https://github.com/vaadin/flow/commit/b87a830c37f854b75e7077ef7b98b609b489d20d", "committedDate": "2020-09-08T12:04:40Z", "message": "Remove unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e2807fa26293ee403dc4b5403626e522454477a", "author": {"user": {"login": "platosha", "name": "Anton Platonov"}}, "url": "https://github.com/vaadin/flow/commit/2e2807fa26293ee403dc4b5403626e522454477a", "committedDate": "2020-09-08T12:06:51Z", "message": "Apply analysis suggestion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0MTExMTkw", "url": "https://github.com/vaadin/flow/pull/8941#pullrequestreview-484111190", "createdAt": "2020-09-08T13:05:15Z", "commit": {"oid": "2e2807fa26293ee403dc4b5403626e522454477a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 142, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}