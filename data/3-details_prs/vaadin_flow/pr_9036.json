{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5NTMzNjI0", "number": 9036, "title": "feat: submit cached endpoint requests in window online listener", "bodyText": "Fixes #8952\n\nremoved uuid and idb-keyval, use idb instead\nuse indexeddb transaction to avoid duplicated submissions\nAdd tests", "createdAt": "2020-09-18T20:47:37Z", "url": "https://github.com/vaadin/flow/pull/9036", "merged": true, "mergeCommit": {"oid": "d617b27fc39cc8b3b8b87ce8cc53692afbc63e6c"}, "closed": true, "closedAt": "2020-09-30T08:01:49Z", "author": {"login": "haijian-vaadin"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdKLvurAH2gAyNDg5NTMzNjI0OmI5ZDI3NzM4YTAzOTg2ZWNlMzAxMDMzMmI5ZDRiOGRmYmNkZTkyYWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdN3SVFgH2gAyNDg5NTMzNjI0OjIzZGFkZWVmMTM5MDc2OThkYWFmNzdhZjlkMWNhMDA0MWFiMzFmNzk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b9d27738a03986ece3010332b9d4b8dfbcde92ad", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/b9d27738a03986ece3010332b9d4b8dfbcde92ad", "committedDate": "2020-09-18T20:37:34Z", "message": "submit cached requests in window online listner"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "310adcf8d078abca5feb3f278571174f76bc1dc1", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/310adcf8d078abca5feb3f278571174f76bc1dc1", "committedDate": "2020-09-18T20:37:51Z", "message": "use idb transaction to avoid duplicated submission"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "845aae9f825078b6a6a77d4082bc664fa3659696", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/845aae9f825078b6a6a77d4082bc664fa3659696", "committedDate": "2020-09-18T20:38:16Z", "message": "add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f838c560b2953b36cf5c16718f5b52e862cef477", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/f838c560b2953b36cf5c16718f5b52e862cef477", "committedDate": "2020-09-18T20:42:01Z", "message": "add more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bc4758d3744bf3d3e2f7d15826fad5fe2cdafaf", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/0bc4758d3744bf3d3e2f7d15826fad5fe2cdafaf", "committedDate": "2020-09-18T20:42:41Z", "message": "remove used import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2c92d06c22c1c638acb6bff4d51cec358d32449", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/d2c92d06c22c1c638acb6bff4d51cec358d32449", "committedDate": "2020-09-18T20:49:03Z", "message": "add new line"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4133da4e78fadd8d90cef403de046bd95290b2c6", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/4133da4e78fadd8d90cef403de046bd95290b2c6", "committedDate": "2020-09-19T20:32:14Z", "message": "always setup the request queue  upon read/write"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "178fc87d9470a3e761cd24c3832a32a49ea04c4e", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/178fc87d9470a3e761cd24c3832a32a49ea04c4e", "committedDate": "2020-09-21T15:09:05Z", "message": "submit requests in sequence"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d09cc3be2c76d9979b69b7981d4c58ee9aa5e152", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/d09cc3be2c76d9979b69b7981d4c58ee9aa5e152", "committedDate": "2020-09-21T18:01:26Z", "message": "fake endpoint call with delay"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbb86893934546f8b4c4f39209fc29ef70c8e7cb", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/dbb86893934546f8b4c4f39209fc29ef70c8e7cb", "committedDate": "2020-09-21T18:06:58Z", "message": "add comment to explain the idb transaction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8051df2b8d1b5a61048f6252c3d20ef56e59258", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/b8051df2b8d1b5a61048f6252c3d20ef56e59258", "committedDate": "2020-09-21T18:44:45Z", "message": "generalise binder.submitTo method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "010170147fef7c31cea3cfa1a8fbddeddcf7db88", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/010170147fef7c31cea3cfa1a8fbddeddcf7db88", "committedDate": "2020-09-29T11:47:17Z", "message": "fix: fail access check when no csrf token in session"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4NDM4OTg4", "url": "https://github.com/vaadin/flow/pull/9036#pullrequestreview-498438988", "createdAt": "2020-09-29T12:57:59Z", "commit": {"oid": "b8051df2b8d1b5a61048f6252c3d20ef56e59258"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4MzgyMzMx", "url": "https://github.com/vaadin/flow/pull/9036#pullrequestreview-498382331", "createdAt": "2020-09-29T11:46:07Z", "commit": {"oid": "b8051df2b8d1b5a61048f6252c3d20ef56e59258"}, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxMTo0NjowN1rOHZpNMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxMTo1MTo1OFrOHZpZJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY1MTU3MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if(shouldSubmit){\n          \n          \n            \n                if (shouldSubmit) {", "url": "https://github.com/vaadin/flow/pull/9036#discussion_r496651571", "createdAt": "2020-09-29T11:46:07Z", "author": {"login": "Haprog"}, "path": "flow-client/src/main/resources/META-INF/resources/frontend/Connect.ts", "diffHunk": "@@ -407,15 +411,75 @@ export class ConnectClient {\n     return navigator.onLine;\n   }\n \n-  private async cacheEndpointRequest(endpointRequest: EndpointRequest) {\n-    await set(endpointRequest.id, endpointRequest, this.getOrCreateEndpointRequetsQueue());\n+  private async cacheEndpointRequest(endpointRequest: EndpointRequest): Promise<EndpointRequest>{\n+    const db = await this.openOrCreateDB();\n+    const id = await db.add(REQUEST_QUEUE_STORE_NAME, endpointRequest);\n+    db.close();\n+    endpointRequest.id = id;\n+    return endpointRequest;\n   }\n \n-  private getOrCreateEndpointRequetsQueue(): Store {\n-    if (!this.endpointRequetsQueue) {\n-      this.endpointRequetsQueue = new Store('cached-vaadin-endpoint-requests');\n+  private async openOrCreateDB(): Promise<IDBPDatabase<RequestQueueDB>> {\n+    return openDB<RequestQueueDB>(REQUEST_QUEUE_DB_NAME, 1, {\n+      upgrade(db) {\n+        db.createObjectStore(REQUEST_QUEUE_STORE_NAME, {\n+          keyPath: 'id',\n+          autoIncrement: true\n+        });\n+      },\n+    });\n+  }\n+\n+  private async checkAndSubmitCachedRequests(){\n+    const db = await this.openOrCreateDB();\n+\n+    /**\n+     * Cannot wait for submitting the cached requests in the indexed db transaction, \n+     * as the transaction only wait for db operations. \n+     * See https://github.com/jakearchibald/idb#transaction-lifetime\n+     */\n+    const shouldSubmit = await this.shouldSubmitCachedRequests(db);\n+\n+    if(shouldSubmit){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8051df2b8d1b5a61048f6252c3d20ef56e59258"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY1NDYyOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(!request.id){\n          \n          \n            \n                    if (!request.id) {", "url": "https://github.com/vaadin/flow/pull/9036#discussion_r496654629", "createdAt": "2020-09-29T11:51:58Z", "author": {"login": "Haprog"}, "path": "flow-client/src/test/frontend/ConnectTests.ts", "diffHunk": "@@ -508,19 +508,19 @@ describe('ConnectClient', () => {\n \n   describe(\"Defer Request\", () => {\n     let client: ConnectClient;\n-    const offlineRequestQueue = new Store('cached-vaadin-endpoint-requests');\n \n     beforeEach(() => {\n       client = new ConnectClient();\n     });\n \n-    afterEach(() => {\n-      fetchMock.restore();\n-      clear(offlineRequestQueue);\n-    });\n-\n     it(\"Should return a DeferrableResult that retains request meta when invoking deferRequest offline\", async () => {\n       sinon.stub(client, \"checkOnline\").callsFake(() => false);\n+      sinon.stub(client, \"cacheEndpointRequest\").callsFake((request:any) => {\n+        if(!request.id){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8051df2b8d1b5a61048f6252c3d20ef56e59258"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a71eb8f1b038afb1e7a8908d8c08bd89de02deea", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/a71eb8f1b038afb1e7a8908d8c08bd89de02deea", "committedDate": "2020-09-30T07:02:18Z", "message": "chore: code format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23dadeef13907698daaf77af9d1ca0041ab31f79", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/23dadeef13907698daaf77af9d1ca0041ab31f79", "committedDate": "2020-09-30T07:03:03Z", "message": "Merge branch 'feature/offline' into haijian/submit-cached-offline-requests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4923, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}