{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0NDQ4MzI2", "number": 9072, "title": "fix: fail access check when no csrf token in session", "bodyText": "use request.getSesssion(false) instead of request.getSesssion() so that it won't create a new session for access check.\nfix a bug that when there is no csrf token in the session (e.g. when session is expired), it's considered valid.\nallow empty csrf token in the request header when there is no session (e.g. using curl).", "createdAt": "2020-09-28T23:05:15Z", "url": "https://github.com/vaadin/flow/pull/9072", "merged": true, "mergeCommit": {"oid": "49469947a63313e97ac29b8b3953560884bc9ba6"}, "closed": true, "closedAt": "2020-09-30T13:51:21Z", "author": {"login": "haijian-vaadin"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNb2FrAH2gAyNDk0NDQ4MzI2OjNlOTcyZGYwZmVlYjg5YTE4MzE0MzMzMzg0ZWM1NDgwNzM1MmQyNDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdN8dbhAFqTQ5OTQwNjMyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3e972df0feeb89a18314333384ec54807352d244", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/3e972df0feeb89a18314333384ec54807352d244", "committedDate": "2020-09-28T23:04:46Z", "message": "fix: fail access check when no csrf token in session"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4NDMyMTc1", "url": "https://github.com/vaadin/flow/pull/9072#pullrequestreview-498432175", "createdAt": "2020-09-29T12:50:15Z", "commit": {"oid": "3e972df0feeb89a18314333384ec54807352d244"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxMjo1MDoxNlrOHZrhKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxMjo1MDoxNlrOHZrhKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY4OTQ1MQ==", "bodyText": "This fails requests with a token header when there is no session. Any reasons behind it?\nIMO it would read more logical if in case of empty session we return early before checking the header:\nHttpSession session = request.getSession(false);\nif (session == null) {\n  return false;\n}\n\nString csrfToken = (String) request.getSession();\nreturn csrfToken == null || !csrfToken.equals(request.getHeader(\"X-CSRF-Token\"));", "url": "https://github.com/vaadin/flow/pull/9072#discussion_r496689451", "createdAt": "2020-09-29T12:50:16Z", "author": {"login": "platosha"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/connect/auth/VaadinConnectAccessChecker.java", "diffHunk": "@@ -138,9 +139,14 @@ private boolean requestForbidden(HttpServletRequest request) {\n         if (!xsrfProtectionEnabled) {\n             return false;\n         }\n-        String csrfToken = (String) request.getSession()\n-                .getAttribute(VaadinService.getCsrfTokenAttributeName());\n-        return csrfToken != null && !csrfToken.equals(request.getHeader(\"X-CSRF-Token\"));\n+        HttpSession session = request.getSession(false);\n+        String csrfTokenInHeader = request.getHeader(\"X-CSRF-Token\");\n+        if (session == null) {\n+            return csrfTokenInHeader != null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e972df0feeb89a18314333384ec54807352d244"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ea0699ddfba2f08b1a15690a516546c5c0cf2a0", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/6ea0699ddfba2f08b1a15690a516546c5c0cf2a0", "committedDate": "2020-09-30T11:51:11Z", "message": "apply code review suggestion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NDA2MzIy", "url": "https://github.com/vaadin/flow/pull/9072#pullrequestreview-499406322", "createdAt": "2020-09-30T13:04:42Z", "commit": {"oid": "6ea0699ddfba2f08b1a15690a516546c5c0cf2a0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4954, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}