{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0NDQ4MzI2", "number": 9072, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxMjo1MDoxNlrOEoiJ6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxMjo1MDoxNlrOEoiJ6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwOTM4MDkwOnYy", "diffSide": "RIGHT", "path": "flow-server/src/main/java/com/vaadin/flow/server/connect/auth/VaadinConnectAccessChecker.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxMjo1MDoxNlrOHZrhKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNzoxMToyMFrOHaQFrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY4OTQ1MQ==", "bodyText": "This fails requests with a token header when there is no session. Any reasons behind it?\nIMO it would read more logical if in case of empty session we return early before checking the header:\nHttpSession session = request.getSession(false);\nif (session == null) {\n  return false;\n}\n\nString csrfToken = (String) request.getSession();\nreturn csrfToken == null || !csrfToken.equals(request.getHeader(\"X-CSRF-Token\"));", "url": "https://github.com/vaadin/flow/pull/9072#discussion_r496689451", "createdAt": "2020-09-29T12:50:16Z", "author": {"login": "platosha"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/connect/auth/VaadinConnectAccessChecker.java", "diffHunk": "@@ -138,9 +139,14 @@ private boolean requestForbidden(HttpServletRequest request) {\n         if (!xsrfProtectionEnabled) {\n             return false;\n         }\n-        String csrfToken = (String) request.getSession()\n-                .getAttribute(VaadinService.getCsrfTokenAttributeName());\n-        return csrfToken != null && !csrfToken.equals(request.getHeader(\"X-CSRF-Token\"));\n+        HttpSession session = request.getSession(false);\n+        String csrfTokenInHeader = request.getHeader(\"X-CSRF-Token\");\n+        if (session == null) {\n+            return csrfTokenInHeader != null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e972df0feeb89a18314333384ec54807352d244"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY5NjIxNw==", "bodyText": "This fails requests with a token header when there is no session. Any reasons behind it?\n\nIsn't this exactly the case that the session has expired, and a cached request is being submitted (with an outdated csrf token)?\nit could be fine when there is no csrf token in the request header, e.g. using curl.", "url": "https://github.com/vaadin/flow/pull/9072#discussion_r496696217", "createdAt": "2020-09-29T13:00:12Z", "author": {"login": "haijian-vaadin"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/connect/auth/VaadinConnectAccessChecker.java", "diffHunk": "@@ -138,9 +139,14 @@ private boolean requestForbidden(HttpServletRequest request) {\n         if (!xsrfProtectionEnabled) {\n             return false;\n         }\n-        String csrfToken = (String) request.getSession()\n-                .getAttribute(VaadinService.getCsrfTokenAttributeName());\n-        return csrfToken != null && !csrfToken.equals(request.getHeader(\"X-CSRF-Token\"));\n+        HttpSession session = request.getSession(false);\n+        String csrfTokenInHeader = request.getHeader(\"X-CSRF-Token\");\n+        if (session == null) {\n+            return csrfTokenInHeader != null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY4OTQ1MQ=="}, "originalCommit": {"oid": "3e972df0feeb89a18314333384ec54807352d244"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI4ODYyMQ==", "bodyText": "If the session has expired, it should fail elsewhere in isLoggedIn kind of check.", "url": "https://github.com/vaadin/flow/pull/9072#discussion_r497288621", "createdAt": "2020-09-30T07:11:20Z", "author": {"login": "platosha"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/connect/auth/VaadinConnectAccessChecker.java", "diffHunk": "@@ -138,9 +139,14 @@ private boolean requestForbidden(HttpServletRequest request) {\n         if (!xsrfProtectionEnabled) {\n             return false;\n         }\n-        String csrfToken = (String) request.getSession()\n-                .getAttribute(VaadinService.getCsrfTokenAttributeName());\n-        return csrfToken != null && !csrfToken.equals(request.getHeader(\"X-CSRF-Token\"));\n+        HttpSession session = request.getSession(false);\n+        String csrfTokenInHeader = request.getHeader(\"X-CSRF-Token\");\n+        if (session == null) {\n+            return csrfTokenInHeader != null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY4OTQ1MQ=="}, "originalCommit": {"oid": "3e972df0feeb89a18314333384ec54807352d244"}, "originalPosition": 18}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3103, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}