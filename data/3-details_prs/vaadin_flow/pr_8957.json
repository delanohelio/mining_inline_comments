{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgxMjg4Njk5", "number": 8957, "title": "Read attribute value from template", "bodyText": "Fixes #3735", "createdAt": "2020-09-07T11:01:57Z", "url": "https://github.com/vaadin/flow/pull/8957", "merged": true, "mergeCommit": {"oid": "af11c30bd7b21a5a35ed7343331cc25c48c845b3"}, "closed": true, "closedAt": "2020-09-08T08:37:38Z", "author": {"login": "denis-anisimov"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdGegNjgH2gAyNDgxMjg4Njk5OjVlYjI2OWJhNzUwZjVjNTg0ZmYwNGM2MjQ1YzdkNDIxMzEzZmE2MDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdGyvfBAFqTQ4Mzg3Nzg5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5eb269ba750f5c584ff04c6245c7d421313fa606", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/5eb269ba750f5c584ff04c6245c7d421313fa606", "committedDate": "2020-09-07T08:13:07Z", "message": "Read static attributes values for @Id mapped elements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b1ce09295a58c0a139bd502f21f2de936d01191", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/8b1ce09295a58c0a139bd502f21f2de936d01191", "committedDate": "2020-09-07T08:21:06Z", "message": "Add test for attribute values in template"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70eaf651764c5ec35e3996258258ebf4725b4e08", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/70eaf651764c5ec35e3996258258ebf4725b4e08", "committedDate": "2020-09-07T08:26:35Z", "message": "Fix for CTOR call in lit template"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e2d8f59f356a708957260a8e7eff0991c2155b1", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/8e2d8f59f356a708957260a8e7eff0991c2155b1", "committedDate": "2020-09-07T09:51:53Z", "message": "Add IT test for template attribute reading"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNTEyNjY2", "url": "https://github.com/vaadin/flow/pull/8957#pullrequestreview-483512666", "createdAt": "2020-09-07T12:20:38Z", "commit": {"oid": "8e2d8f59f356a708957260a8e7eff0991c2155b1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxMjoyMDozOFrOHN9THg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxMjoyMDozOFrOHN9THg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDM5Nzg1NA==", "bodyText": "Call \"tagName.isPresent()\" before accessing the value.", "url": "https://github.com/vaadin/flow/pull/8957#discussion_r484397854", "createdAt": "2020-09-07T12:20:38Z", "author": {"login": "vaadin-bot"}, "path": "flow-server/src/main/java/com/vaadin/flow/component/polymertemplate/IdCollector.java", "diffHunk": "@@ -121,16 +124,18 @@ private void collectedInjectedId(Field field,\n      * @return <code>false</code> if the mapping did not pass validation,\n      *         <code>true</code> otherwise\n      */\n-    private boolean addTagName(String id, Field field) {\n+    private boolean collectElementData(String id, Field field) {\n         idByField.put(field, id);\n         if (templateRoot != null) {\n             // The template is available for parsing so check up front if the id\n             // exists\n-            Optional<String> tagName = Optional\n-                    .ofNullable(templateRoot.getElementById(id))\n+            Optional<Element> element = Optional\n+                    .ofNullable(templateRoot.getElementById(id));\n+            Optional<String> tagName = element\n                     .map(org.jsoup.nodes.Element::tagName);\n-            if (tagName.isPresent()) {\n+            if (element.isPresent()) {\n                 tagById.put(id, tagName.get());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e2d8f59f356a708957260a8e7eff0991c2155b1"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNzgxODg1", "url": "https://github.com/vaadin/flow/pull/8957#pullrequestreview-483781885", "createdAt": "2020-09-08T04:07:46Z", "commit": {"oid": "8e2d8f59f356a708957260a8e7eff0991c2155b1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNDowNzo0NlrOHOMAIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNToyNDo1MFrOHONHKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYzODc1NQ==", "bodyText": "This should stay as tagName.isPresent() and the fetchAttributes be put in it's own if(element.isPresent()) as now we may store a null tagName", "url": "https://github.com/vaadin/flow/pull/8957#discussion_r484638755", "createdAt": "2020-09-08T04:07:46Z", "author": {"login": "caalador"}, "path": "flow-server/src/main/java/com/vaadin/flow/component/polymertemplate/IdCollector.java", "diffHunk": "@@ -121,16 +124,18 @@ private void collectedInjectedId(Field field,\n      * @return <code>false</code> if the mapping did not pass validation,\n      *         <code>true</code> otherwise\n      */\n-    private boolean addTagName(String id, Field field) {\n+    private boolean collectElementData(String id, Field field) {\n         idByField.put(field, id);\n         if (templateRoot != null) {\n             // The template is available for parsing so check up front if the id\n             // exists\n-            Optional<String> tagName = Optional\n-                    .ofNullable(templateRoot.getElementById(id))\n+            Optional<Element> element = Optional\n+                    .ofNullable(templateRoot.getElementById(id));\n+            Optional<String> tagName = element\n                     .map(org.jsoup.nodes.Element::tagName);\n-            if (tagName.isPresent()) {\n+            if (element.isPresent()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e2d8f59f356a708957260a8e7eff0991c2155b1"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY1NDA5NA==", "bodyText": "Could we add debug log for skipped attributes so that if there comes confusion on the issue it could be seen in the devug level logs.", "url": "https://github.com/vaadin/flow/pull/8957#discussion_r484654094", "createdAt": "2020-09-08T05:14:31Z", "author": {"login": "caalador"}, "path": "flow-server/src/main/java/com/vaadin/flow/component/polymertemplate/TemplateInitializer.java", "diffHunk": "@@ -153,9 +153,32 @@ private void attachComponentIfUses(Element element) {\n     /* Map declared fields marked @Id */\n \n     private void mapComponents() {\n-        parserData.forEachInjectedField(\n-                (field, id, tag) -> idMapper.mapComponentOrElement(field, id,\n-                        tag, this::attachComponentIfUses));\n+        parserData.forEachInjectedField((field, id, tag) -> idMapper\n+                .mapComponentOrElement(field, id, tag, element -> {\n+                    Map<String, String> attributes = parserData\n+                            .getAttributes(id);\n+                    attributes.forEach((name, value) -> setAttribute(element,\n+                            name, value));\n+                    attachComponentIfUses(element);\n+                }));\n+    }\n+\n+    private void setAttribute(Element element, String name, String value) {\n+        if (name.endsWith(\"$\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e2d8f59f356a708957260a8e7eff0991c2155b1"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY1NTAwOQ==", "bodyText": "Parameter is missing documentation should be filled even for privates if javadoc added.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @param beforeInject\n          \n          \n            \n                 * @param beforeInject\n          \n          \n            \n                 *            a callback invoked before assigning the element/component to\n          \n          \n            \n                 *            the field", "url": "https://github.com/vaadin/flow/pull/8957#discussion_r484655009", "createdAt": "2020-09-08T05:17:47Z", "author": {"login": "caalador"}, "path": "flow-server/src/main/java/com/vaadin/flow/component/polymertemplate/IdMapper.java", "diffHunk": "@@ -129,10 +131,10 @@ private Element getElement() {\n      *            id of element to attach to\n      * @param field\n      *            field to attach {@code Element} or {@code Component} to\n-     * @param beforeComponentInject\n+     * @param beforeInject", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e2d8f59f356a708957260a8e7eff0991c2155b1"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY1NjY3Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                + \"' someattrtibute></dom-module>\");\n          \n          \n            \n                                + \"' someattribute></dom-module>\");\n          \n      \n    \n    \n  \n\nTypo", "url": "https://github.com/vaadin/flow/pull/8957#discussion_r484656676", "createdAt": "2020-09-08T05:24:04Z", "author": {"login": "caalador"}, "path": "flow-server/src/test/java/com/vaadin/flow/component/polymertemplate/PolymerTemplateTest.java", "diffHunk": "@@ -100,7 +100,8 @@ public TemplateData getTemplateContent(\n     private static class SimpleTemplateParser extends TestTemplateParser {\n \n         SimpleTemplateParser() {\n-            super(tag -> \"<dom-module id='\" + tag + \"' someattrtibute></dom-module>\");\n+            super(tag -> \"<dom-module id='\" + tag\n+                    + \"' someattrtibute></dom-module>\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e2d8f59f356a708957260a8e7eff0991c2155b1"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY1Njc0Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                        + \"'><label id='labelId' someattrtibute property-binding='[[foo]]' \"\n          \n          \n            \n                                        + \"'><label id='labelId' someattribute property-binding='[[foo]]' \"", "url": "https://github.com/vaadin/flow/pull/8957#discussion_r484656743", "createdAt": "2020-09-08T05:24:17Z", "author": {"login": "caalador"}, "path": "flow-server/src/test/java/com/vaadin/flow/component/polymertemplate/PolymerTemplateTest.java", "diffHunk": "@@ -312,7 +313,9 @@ public TextNodesInHtmlTemplate(TestTemplateParser parser) {\n         public IdElementTemplate() {\n             this((clazz, tag, service) -> new TemplateData(\"\",\n                     Jsoup.parse(\"<dom-module id='\" + tag\n-                            + \"'><label id='labelId' someattrtibute></dom-module>\")));\n+                            + \"'><label id='labelId' someattrtibute property-binding='[[foo]]' \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e2d8f59f356a708957260a8e7eff0991c2155b1"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY1NjkzOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Assert.assertTrue(template.label.hasAttribute(\"someattrtibute\"));\n          \n          \n            \n                    Assert.assertNotNull(template.label.getAttribute(\"someattrtibute\"));\n          \n          \n            \n                    Assert.assertTrue(\n          \n          \n            \n                            template.label.getAttribute(\"someattrtibute\").isEmpty());\n          \n          \n            \n                    Assert.assertTrue(template.label.hasAttribute(\"someattribute\"));\n          \n          \n            \n                    Assert.assertNotNull(template.label.getAttribute(\"someattribute\"));\n          \n          \n            \n                    Assert.assertTrue(\n          \n          \n            \n                            template.label.getAttribute(\"someattribute\").isEmpty());", "url": "https://github.com/vaadin/flow/pull/8957#discussion_r484656938", "createdAt": "2020-09-08T05:24:50Z", "author": {"login": "caalador"}, "path": "flow-server/src/test/java/com/vaadin/flow/component/polymertemplate/PolymerTemplateTest.java", "diffHunk": "@@ -765,6 +766,31 @@ public void attachExistingElement_elementIsCreatedAndSetAsVirtualChild() {\n         assertElementData(child, NodeProperties.INJECT_BY_ID, \"labelId\");\n     }\n \n+    @Test\n+    public void attachExistingElementWithAttributeValue_elementHasAttribute() {\n+        IdElementTemplate template = new IdElementTemplate();\n+\n+        Assert.assertTrue(template.label.hasAttribute(\"someattrtibute\"));\n+        Assert.assertNotNull(template.label.getAttribute(\"someattrtibute\"));\n+        Assert.assertTrue(\n+                template.label.getAttribute(\"someattrtibute\").isEmpty());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e2d8f59f356a708957260a8e7eff0991c2155b1"}, "originalPosition": 68}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7a86bc75be4037cbf4e73fdd433ad4277555cae", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/d7a86bc75be4037cbf4e73fdd433ad4277555cae", "committedDate": "2020-09-08T05:53:10Z", "message": "Corrections based on review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzODI0OTMx", "url": "https://github.com/vaadin/flow/pull/8957#pullrequestreview-483824931", "createdAt": "2020-09-08T06:22:04Z", "commit": {"oid": "d7a86bc75be4037cbf4e73fdd433ad4277555cae"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNjoyMjowNFrOHOOTRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNjoyNTo0N1rOHOOY4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY3NjQyMA==", "bodyText": "info might bring too much logs, but this will become apparent quite early on I expect.", "url": "https://github.com/vaadin/flow/pull/8957#discussion_r484676420", "createdAt": "2020-09-08T06:22:04Z", "author": {"login": "caalador"}, "path": "flow-server/src/main/java/com/vaadin/flow/component/polymertemplate/TemplateInitializer.java", "diffHunk": "@@ -153,9 +156,44 @@ private void attachComponentIfUses(Element element) {\n     /* Map declared fields marked @Id */\n \n     private void mapComponents() {\n-        parserData.forEachInjectedField(\n-                (field, id, tag) -> idMapper.mapComponentOrElement(field, id,\n-                        tag, this::attachComponentIfUses));\n+        parserData.forEachInjectedField((field, id, tag) -> idMapper\n+                .mapComponentOrElement(field, id, tag, element -> {\n+                    Map<String, String> attributes = parserData\n+                            .getAttributes(id);\n+                    attributes.forEach((name, value) -> setAttribute(element,\n+                            name, value));\n+                    attachComponentIfUses(element);\n+                }));\n+    }\n+\n+    private void setAttribute(Element element, String name, String value) {\n+        if (name.endsWith(\"$\")) {\n+            // this is an attribute binding, ignore it since we don't support\n+            // bindings: the value is not an expression\n+            getLogger().info(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7a86bc75be4037cbf4e73fdd433ad4277555cae"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY3Nzg1OA==", "bodyText": "Going by the normal creation methods tag is always needed. But should the end return be changed to element.isPresent instead of tagName.isPresent and handle the tagName inside the if clause", "url": "https://github.com/vaadin/flow/pull/8957#discussion_r484677858", "createdAt": "2020-09-08T06:25:47Z", "author": {"login": "caalador"}, "path": "flow-server/src/main/java/com/vaadin/flow/component/polymertemplate/IdCollector.java", "diffHunk": "@@ -121,16 +124,18 @@ private void collectedInjectedId(Field field,\n      * @return <code>false</code> if the mapping did not pass validation,\n      *         <code>true</code> otherwise\n      */\n-    private boolean addTagName(String id, Field field) {\n+    private boolean collectElementData(String id, Field field) {\n         idByField.put(field, id);\n         if (templateRoot != null) {\n             // The template is available for parsing so check up front if the id\n             // exists\n-            Optional<String> tagName = Optional\n-                    .ofNullable(templateRoot.getElementById(id))\n+            Optional<Element> element = Optional\n+                    .ofNullable(templateRoot.getElementById(id));\n+            Optional<String> tagName = element\n                     .map(org.jsoup.nodes.Element::tagName);\n-            if (tagName.isPresent()) {\n+            if (element.isPresent()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYzODc1NQ=="}, "originalCommit": {"oid": "8e2d8f59f356a708957260a8e7eff0991c2155b1"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "533e9e98a3bcc8c130a2e1c2f5d1a9d02cc1a733", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/533e9e98a3bcc8c130a2e1c2f5d1a9d02cc1a733", "committedDate": "2020-09-08T06:28:21Z", "message": "Use debug for logging ignored attributes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04104b6a7e539aef5f59191866860ac76f043015", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/04104b6a7e539aef5f59191866860ac76f043015", "committedDate": "2020-09-08T06:31:13Z", "message": "Improve the code a bit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzODM2ODAx", "url": "https://github.com/vaadin/flow/pull/8957#pullrequestreview-483836801", "createdAt": "2020-09-08T06:45:12Z", "commit": {"oid": "04104b6a7e539aef5f59191866860ac76f043015"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68f8fd982262eb120680927a57b83a79b70486b5", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/68f8fd982262eb120680927a57b83a79b70486b5", "committedDate": "2020-09-08T07:15:39Z", "message": "Increase threshold"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzODc3ODk2", "url": "https://github.com/vaadin/flow/pull/8957#pullrequestreview-483877896", "createdAt": "2020-09-08T07:47:54Z", "commit": {"oid": "68f8fd982262eb120680927a57b83a79b70486b5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 144, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}