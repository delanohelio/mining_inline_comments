{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4NjY3MTk3", "number": 8715, "title": "Make it easier to use to paged repositories for data provider data #8557", "bodyText": "Fixes #8557", "createdAt": "2020-07-14T06:07:25Z", "url": "https://github.com/vaadin/flow/pull/8715", "merged": true, "mergeCommit": {"oid": "132bcaef1b58fbdb126c3de39b2904ca515b23d3"}, "closed": true, "closedAt": "2020-07-14T09:13:10Z", "author": {"login": "mshabarov"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0dZgXgH2gAyNDQ4NjY3MTk3OjIxZGY5NTcwNDc4YzQ4YWNiMDQ3NTM4NDU2ZmY1MDcyOGM3YTNjYzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc0xm3wgFqTQ0Nzg4OTQ0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "21df9570478c48acb047538456ff50728c7a3cc0", "author": {"user": {"login": "mstahv", "name": "Matti Tahvonen"}}, "url": "https://github.com/vaadin/flow/commit/21df9570478c48acb047538456ff50728c7a3cc0", "committedDate": "2020-07-13T08:45:15Z", "message": "Added shorthands for page index and pagesize\n\nAdded small helpers for those making lazy data binding to \"paging backends\"."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d3e2b5e52f15e5e7fd10cf48e87cc9d2222bc9f", "author": {"user": {"login": "mstahv", "name": "Matti Tahvonen"}}, "url": "https://github.com/vaadin/flow/commit/5d3e2b5e52f15e5e7fd10cf48e87cc9d2222bc9f", "committedDate": "2020-07-13T09:00:04Z", "message": "using methods instead of fields directly to pass runtime checks by framework"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "218d20d8fdb2dcde1a87c3f80c6c4a84b12ac326", "author": {"user": {"login": "mshabarov", "name": "Mikhail Shabarov"}}, "url": "https://github.com/vaadin/flow/commit/218d20d8fdb2dcde1a87c3f80c6c4a84b12ac326", "committedDate": "2020-07-14T06:04:24Z", "message": "Make it easier to use to paged repositories for data provider data #8557"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3ODI1OTM3", "url": "https://github.com/vaadin/flow/pull/8715#pullrequestreview-447825937", "createdAt": "2020-07-14T06:37:11Z", "commit": {"oid": "218d20d8fdb2dcde1a87c3f80c6c4a84b12ac326"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwNjozNzoxMVrOGxGLJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwNjozNzoxMVrOGxGLJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEzNDU2NQ==", "bodyText": "This and related change in QueryTrace is obsolete as the methods are basically aliases \ud83e\udd14\nBut I'm fine having it this way as well.", "url": "https://github.com/vaadin/flow/pull/8715#discussion_r454134565", "createdAt": "2020-07-14T06:37:11Z", "author": {"login": "mstahv"}, "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/DataCommunicator.java", "diffHunk": "@@ -682,20 +707,21 @@ protected Object getFilter() {\n             assert !stream.isParallel();\n         }\n \n-        SizeVerifier verifier = new SizeVerifier<>(limit);\n+        // the number of results can be in range from 0 to pages * pageSize\n+        SizeVerifier verifier = new SizeVerifier<>(pages * pageSize);\n         stream = stream.peek(verifier);\n \n         /*\n          * These restrictions are used to help users to see that they have done\n          * a mistake instead of just letting things work in an unintended way.\n          */\n-        if (!query.isLimitCalled()) {\n+        if (!query.isLimitCalled() && !query.isPageSizeCalled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "218d20d8fdb2dcde1a87c3f80c6c4a84b12ac326"}, "originalPosition": 89}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed0949a7415125d4705aa2af6e90ea1d19f5503b", "author": {"user": {"login": "mshabarov", "name": "Mikhail Shabarov"}}, "url": "https://github.com/vaadin/flow/commit/ed0949a7415125d4705aa2af6e90ea1d19f5503b", "committedDate": "2020-07-14T07:14:07Z", "message": "Page getters verification removed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3ODU4NzQ2", "url": "https://github.com/vaadin/flow/pull/8715#pullrequestreview-447858746", "createdAt": "2020-07-14T07:33:23Z", "commit": {"oid": "218d20d8fdb2dcde1a87c3f80c6c4a84b12ac326"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwNzozMzoyNFrOGxHyNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwNzozMzoyNFrOGxHyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE2MDk1MA==", "bodyText": "This can be achieved with only integer division, by adding the divisor minus one before dividing to ensure upwards rounding:\nfinal int pages = (limit + pageSize-1) / pageSize;\n\nDrawback is it reads less obviously, so would need comment, but I would prefer to do it this way to avoid int \u2194\ufe0e double\u2194\ufe0eint cross-conversion. Alternatively division may not be needed if the below loop is modified to something like:\nfor (int newOffset = offset; newOffset < offset + limit; newOffset += pageSize) {\n ...\n}", "url": "https://github.com/vaadin/flow/pull/8715#discussion_r454160950", "createdAt": "2020-07-14T07:33:24Z", "author": {"login": "joheriks"}, "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/DataCommunicator.java", "diffHunk": "@@ -660,19 +660,44 @@ protected Object getFilter() {\n \n     /**\n      * Fetches a list of items from the DataProvider.\n+     * <p>\n+     * <em>NOTE:</em> the {@code limit} parameter shows how many items the\n+     * client wants to fetch, but the actual number of results may be greater,\n+     * and vary from {@code 0 to pages * pageSize}.\n      *\n      * @param offset\n      *            the starting index of the range\n      * @param limit\n-     *            the max number of results\n+     *            the desired number of results\n      * @return the list of items in given range\n      *\n      */\n     @SuppressWarnings({ \"rawtypes\", \"unchecked\" })\n     protected Stream<T> fetchFromProvider(int offset, int limit) {\n-        QueryTrace query = new QueryTrace(offset, limit, backEndSorting,\n+        Stream<T> stream = Stream.empty();\n+        QueryTrace query = new QueryTrace(offset, pageSize, backEndSorting,\n                 inMemorySorting, filter);\n-        Stream<T> stream = getDataProvider().fetch(query);\n+        /*\n+         * Items limit value may not be necessarily multiply of page size,\n+         * and thus the pages count is rounded to closest smallest integer.\n+         */\n+        final int pages = (int) Math.ceil((double) limit / pageSize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "218d20d8fdb2dcde1a87c3f80c6c4a84b12ac326"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a0f1901262553a99203ede60ce67b3d1e2efee7", "author": {"user": {"login": "mshabarov", "name": "Mikhail Shabarov"}}, "url": "https://github.com/vaadin/flow/commit/4a0f1901262553a99203ede60ce67b3d1e2efee7", "committedDate": "2020-07-14T08:12:50Z", "message": "Improve page count calculation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3ODg5NDQx", "url": "https://github.com/vaadin/flow/pull/8715#pullrequestreview-447889441", "createdAt": "2020-07-14T08:17:57Z", "commit": {"oid": "4a0f1901262553a99203ede60ce67b3d1e2efee7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 296, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}