{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzNTYzNjU1", "number": 9583, "title": "fix: encode attribute value during transfer from embedded web app", "bodyText": "", "createdAt": "2020-12-07T10:29:36Z", "url": "https://github.com/vaadin/flow/pull/9583", "merged": true, "mergeCommit": {"oid": "a3735611f8d945b13cb1d40ffceb5b217d48d46e"}, "closed": true, "closedAt": "2020-12-08T10:08:11Z", "author": {"login": "denis-anisimov"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdjy_bTgH2gAyNTMzNTYzNjU1OjgzZGU1ZmNjZjdiYmFhMDE2NzE3YjA5MmQyNmIzZmNlMDVlNWUwZjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkHSDnAFqTU0NzAwNTEyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "83de5fccf7bbaa016717b092d26b3fce05e5e0f3", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/83de5fccf7bbaa016717b092d26b3fce05e5e0f3", "committedDate": "2020-12-07T10:29:07Z", "message": "fix: encode attribute value during transfer from embedded web app"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27c415d30a88b44534a9a8271d4b385bfc94d31f", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/27c415d30a88b44534a9a8271d4b385bfc94d31f", "committedDate": "2020-12-07T13:59:27Z", "message": "fix: encode only path and query separately"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MjI5NDk5", "url": "https://github.com/vaadin/flow/pull/9583#pullrequestreview-546229499", "createdAt": "2020-12-07T14:57:53Z", "commit": {"oid": "27c415d30a88b44534a9a8271d4b385bfc94d31f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNDo1Nzo1M1rOIAq0FA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNDo1ODo1NVrOIAq3DQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU3MjM3Mg==", "bodyText": "Hm. URLEncoder.encode is for encoding parameters for using in application/x-www-form-urlencoded data, it changes forward slash (perfectly valid in path part of URL) to %2f.", "url": "https://github.com/vaadin/flow/pull/9583#discussion_r537572372", "createdAt": "2020-12-07T14:57:53Z", "author": {"login": "fluorumlabs"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/communication/WebComponentBootstrapHandler.java", "diffHunk": "@@ -378,16 +381,28 @@ private void transferAttribute(Writer writer, String elementRef,\n      * @param path\n      *            original resource path\n      * @return new resource path, relative to basePath\n+     * @throws UnsupportedEncodingException\n      */\n-    protected String modifyPath(String basePath, String path) {\n+    protected String modifyPath(String basePath, String path)\n+            throws UnsupportedEncodingException {\n         int vaadinIndex = path.indexOf(Constants.VAADIN_MAPPING);\n+        String suffix = path;\n         if (vaadinIndex > 0) {\n-            String subPath = path.substring(vaadinIndex);\n-            return URI.create(basePath + subPath).toString();\n-        } else {\n-            return URI.create(basePath + path).toString();\n+            suffix = suffix.substring(vaadinIndex);\n+        }\n+        int queryIndex = suffix.indexOf('?');\n+        if (queryIndex > 0) {\n+            suffix = encode(suffix.substring(0, queryIndex)) + '?'\n+                    + encode(suffix.substring(queryIndex + 1));\n+        }\n+        return URI.create(basePath + suffix).toString();\n+    }\n \n+    private String encode(String str) throws UnsupportedEncodingException {\n+        if (str == null) {\n+            return null;\n         }\n+        return URLEncoder.encode(str, StandardCharsets.UTF_8.name());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27c415d30a88b44534a9a8271d4b385bfc94d31f"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU3MzEzMw==", "bodyText": "Would be nice to see the test with a real URL (with protocol, path parameters etc.)", "url": "https://github.com/vaadin/flow/pull/9583#discussion_r537573133", "createdAt": "2020-12-07T14:58:55Z", "author": {"login": "fluorumlabs"}, "path": "flow-server/src/test/java/com/vaadin/flow/server/communication/WebComponentBootstrapHandlerTest.java", "diffHunk": "@@ -102,6 +103,27 @@ public void writeBootstrapPage_skipMetaAndStyleHeaderElements()\n                 CoreMatchers.not(CoreMatchers.containsString(\"http-equiv\")));\n     }\n \n+    @Test\n+    public void writeBootstrapPage_escapeAttributeValue() throws IOException {\n+        WebComponentBootstrapHandler handler = new WebComponentBootstrapHandler();\n+\n+        ByteArrayOutputStream stream = new ByteArrayOutputStream();\n+\n+        Element head = new Document(\"\").normalise().head();\n+\n+        Element script = head.ownerDocument().createElement(\"script\");\n+        head.appendChild(script);\n+        script.attr(\"src\", \"foo'bar %27?baz%22\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27c415d30a88b44534a9a8271d4b385bfc94d31f"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "213e2f3c704af6b864b48bf1c08ef986de6288bd", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/213e2f3c704af6b864b48bf1c08ef986de6288bd", "committedDate": "2020-12-08T07:05:21Z", "message": "fix: use double quotes for the attribute value in the generated code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2ODMyNTk1", "url": "https://github.com/vaadin/flow/pull/9583#pullrequestreview-546832595", "createdAt": "2020-12-08T08:00:29Z", "commit": {"oid": "213e2f3c704af6b864b48bf1c08ef986de6288bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwODowMDoyOVrOIBL-kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwODowMDoyOVrOIBL-kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODExNTczMQ==", "bodyText": "Remove the declaration of thrown exception 'java.io.UnsupportedEncodingException', as it cannot be thrown from method's body.", "url": "https://github.com/vaadin/flow/pull/9583#discussion_r538115731", "createdAt": "2020-12-08T08:00:29Z", "author": {"login": "vaadin-bot"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/communication/WebComponentBootstrapHandler.java", "diffHunk": "@@ -378,16 +379,27 @@ private void transferAttribute(Writer writer, String elementRef,\n      * @param path\n      *            original resource path\n      * @return new resource path, relative to basePath\n+     * @throws UnsupportedEncodingException\n      */\n-    protected String modifyPath(String basePath, String path) {\n+    protected String modifyPath(String basePath, String path)\n+            throws UnsupportedEncodingException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "213e2f3c704af6b864b48bf1c08ef986de6288bd"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2ODMwMzg3", "url": "https://github.com/vaadin/flow/pull/9583#pullrequestreview-546830387", "createdAt": "2020-12-08T07:56:56Z", "commit": {"oid": "213e2f3c704af6b864b48bf1c08ef986de6288bd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwNzo1Njo1NlrOIBL29A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwODowMDozMVrOIBL-tQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODExMzc4MA==", "bodyText": "Are you sure that's the correct assert condition? It's negated, so it won't catch regressions unless they will yield exact string.", "url": "https://github.com/vaadin/flow/pull/9583#discussion_r538113780", "createdAt": "2020-12-08T07:56:56Z", "author": {"login": "fluorumlabs"}, "path": "flow-server/src/test/java/com/vaadin/flow/server/communication/WebComponentBootstrapHandlerTest.java", "diffHunk": "@@ -113,15 +114,31 @@ public void writeBootstrapPage_escapeAttributeValue() throws IOException {\n \n         Element script = head.ownerDocument().createElement(\"script\");\n         head.appendChild(script);\n-        script.attr(\"src\", \"foo'bar %27?baz%22\");\n+        script.attr(\"src\", \"foo'bar%20%27?baz%22\");\n \n         VaadinResponse response = getMockResponse(stream);\n         handler.writeBootstrapPage(\"\", response, head, \"\");\n \n         String resultingScript = stream.toString(StandardCharsets.UTF_8.name());\n+        MatcherAssert.assertThat(resultingScript, CoreMatchers\n+                .not(CoreMatchers.containsString(\"foo'bar %27?baz%22\")));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "213e2f3c704af6b864b48bf1c08ef986de6288bd"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODExNTc2NQ==", "bodyText": "Since this method doesn't returns argument as is, it should probably return boolean instead and called isUrlUnsafe to align with com.vaadin.flow.server.HandlerHelper#isPathUnsafe. The IllegalArgumentException should be thrown in modifyPath then.", "url": "https://github.com/vaadin/flow/pull/9583#discussion_r538115765", "createdAt": "2020-12-08T08:00:31Z", "author": {"login": "fluorumlabs"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/communication/WebComponentBootstrapHandler.java", "diffHunk": "@@ -390,19 +388,18 @@ protected String modifyPath(String basePath, String path)\n         if (vaadinIndex > 0) {\n             suffix = suffix.substring(vaadinIndex);\n         }\n-        int queryIndex = suffix.indexOf('?');\n-        if (queryIndex > 0) {\n-            suffix = encode(suffix.substring(0, queryIndex)) + '?'\n-                    + encode(suffix.substring(queryIndex + 1));\n-        }\n-        return URI.create(basePath + suffix).toString();\n+        return URI.create(checkURL(basePath + suffix)).toString();\n     }\n \n-    private String encode(String str) throws UnsupportedEncodingException {\n-        if (str == null) {\n+    private String checkURL(String url) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "213e2f3c704af6b864b48bf1c08ef986de6288bd"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d58ec008e5524e5b5dc693eedc4087b93472f35d", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/d58ec008e5524e5b5dc693eedc4087b93472f35d", "committedDate": "2020-12-08T08:49:27Z", "message": "fix: correct assertion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MDA1MTI5", "url": "https://github.com/vaadin/flow/pull/9583#pullrequestreview-547005129", "createdAt": "2020-12-08T10:07:34Z", "commit": {"oid": "d58ec008e5524e5b5dc693eedc4087b93472f35d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4634, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}