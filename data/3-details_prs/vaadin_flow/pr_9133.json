{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5NDgxMjY0", "number": 9133, "title": "fix: store app shell title into UI instead of AppShellRegistry", "bodyText": "The app shell title is currently stored in AppShellRegistry which makes it a singleton. The fix is to store it into UI instead.\n\nNormally the app shell title is passed from client to server viaflowRoot.$server.connectClient(this.container.localName, this.container.id, this.getFlowRoute(ctx), document.title); in Flow.ts\nWhen eagerServerLoad is set, the app shell title is passed via IndexHtmlHandler, since the UI is already available then and document.title is empty.", "createdAt": "2020-10-07T19:53:44Z", "url": "https://github.com/vaadin/flow/pull/9133", "merged": true, "mergeCommit": {"oid": "f617010cdff589bf8b8d714081d1a2d1488ca156"}, "closed": true, "closedAt": "2020-10-09T15:32:23Z", "author": {"login": "haijian-vaadin"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQSafbgH2gAyNDk5NDgxMjY0OjQ1ODA0MGJhN2I2YTBlZTUyNDBhODY3MzliYzExZDEwYjRjYzgzNDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQ39ALAFqTUwNTc4MTYwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "458040ba7b6a0ee5240a86739bc11d10b4cc8343", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/458040ba7b6a0ee5240a86739bc11d10b4cc8343", "committedDate": "2020-10-07T19:47:15Z", "message": "fix: store app shell title into UI instead of AppShellRegistry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bf4664c8a37460f6e9ae24b4e9e94f08c249ce7", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/5bf4664c8a37460f6e9ae24b4e9e94f08c249ce7", "committedDate": "2020-10-07T19:56:41Z", "message": "Merge branch 'master' into haijian/fix-singleton-app-shell-title"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78c7597fd9f8c74dd71d929761525a12293ef8a8", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/78c7597fd9f8c74dd71d929761525a12293ef8a8", "committedDate": "2020-10-07T20:14:37Z", "message": "fix compile errors after merge"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NTIwOTEz", "url": "https://github.com/vaadin/flow/pull/9133#pullrequestreview-504520913", "createdAt": "2020-10-08T08:01:10Z", "commit": {"oid": "78c7597fd9f8c74dd71d929761525a12293ef8a8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NTIzNDY3", "url": "https://github.com/vaadin/flow/pull/9133#pullrequestreview-504523467", "createdAt": "2020-10-08T08:04:32Z", "commit": {"oid": "78c7597fd9f8c74dd71d929761525a12293ef8a8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwODowNDozMlrOHeSm8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwODowNDozMlrOHeSm8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUyNDIxMA==", "bodyText": "Note: this is technically a breaking change now that AppShellRegistry#getTitle() is removed.\nShould we deprecate it instead for now?", "url": "https://github.com/vaadin/flow/pull/9133#discussion_r501524210", "createdAt": "2020-10-08T08:04:32Z", "author": {"login": "platosha"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/AppShellRegistry.java", "diffHunk": "@@ -162,15 +160,6 @@ public boolean isShell(Class<?> clz) {\n         }\n     }\n \n-    /**\n-     * Return the text content of the title tag in the application shell.\n-     *\n-     * @return title;\n-     */\n-    public String getTitle() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78c7597fd9f8c74dd71d929761525a12293ef8a8"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NzM1MTI1", "url": "https://github.com/vaadin/flow/pull/9133#pullrequestreview-504735125", "createdAt": "2020-10-08T12:36:44Z", "commit": {"oid": "78c7597fd9f8c74dd71d929761525a12293ef8a8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMjozNjo0NFrOHeccUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMjozNjo0NFrOHeccUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY4NTMyOA==", "bodyText": "Isn't this too late ? If a client side view sets another title instead of the one provided by the AppShell from Java, then that title would be set as the \"app title\" instead ? So basically the document.title should be captured somewhere after the initial index page with the appshell provided title comes (like I said yesterday in the call). Or what am I missing ?", "url": "https://github.com/vaadin/flow/pull/9133#discussion_r501685328", "createdAt": "2020-10-08T12:36:44Z", "author": {"login": "pleku"}, "path": "flow-client/src/main/resources/META-INF/resources/frontend/Flow.ts", "diffHunk": "@@ -170,7 +170,7 @@ export class Flow {\n \n       // Call server side to navigate to the given route\n       flowRoot.$server\n-          .connectClient(this.container.localName, this.container.id, this.getFlowRoute(ctx));\n+          .connectClient(this.container.localName, this.container.id, this.getFlowRoute(ctx), document.title);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78c7597fd9f8c74dd71d929761525a12293ef8a8"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7208b0bed573c1390101ca0b85bcd1f7a208a2bf", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/7208b0bed573c1390101ca0b85bcd1f7a208a2bf", "committedDate": "2020-10-08T18:51:46Z", "message": "apply code review suggestions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NDg1ODM3", "url": "https://github.com/vaadin/flow/pull/9133#pullrequestreview-505485837", "createdAt": "2020-10-09T08:55:23Z", "commit": {"oid": "7208b0bed573c1390101ca0b85bcd1f7a208a2bf"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwODo1NToyM1rOHfBGvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwOTowMzo0OFrOHfBZdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI4NjAxNA==", "bodyText": "This (currently returning null) will make this also a breaking change since most likely most code using this method will end up NPE. Then I wonder if the method should be just removed ? As keeping it for \"backwards compatibility\" but then also making it break apps that use it is a bit weird. So instead of returning a null, you could just throw and exception with a clear message that says \"use xyz instead\". But as this change is targeted for master so IMO it is even fine to remove the method in this PR, and use the deprecation in the change for 4.0 with either a clear error thrown or returning the old value.\nAnyway what happens here should be in the release notes.", "url": "https://github.com/vaadin/flow/pull/9133#discussion_r502286014", "createdAt": "2020-10-09T08:55:23Z", "author": {"login": "pleku"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/AppShellRegistry.java", "diffHunk": "@@ -162,15 +160,6 @@ public boolean isShell(Class<?> clz) {\n         }\n     }\n \n-    /**\n-     * Return the text content of the title tag in the application shell.\n-     *\n-     * @return title;\n-     */\n-    public String getTitle() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUyNDIxMA=="}, "originalCommit": {"oid": "78c7597fd9f8c74dd71d929761525a12293ef8a8"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI4OTQwNg==", "bodyText": "a) Isn't this always null unless the legacy bootstrapping is used ? If the code calling this method cannot be moved inside the if-else that checks that checks the bootstrapping mode, a comment could point here that \"this is only for the legacy bootstrapping\"\nb) IMO UI.getCurrent().ifPresent(ui -> ... would be cleaner code\nc) this code is not formatted", "url": "https://github.com/vaadin/flow/pull/9133#discussion_r502289406", "createdAt": "2020-10-09T09:01:05Z", "author": {"login": "pleku"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/communication/IndexHtmlRequestHandler.java", "diffHunk": "@@ -126,6 +130,16 @@ public boolean synchronizedHandleRequest(VaadinSession session,\n         return true;\n     }\n \n+    private void storeAppShellTitleToUI(Document indexDocument) {\n+        if(UI.getCurrent()!=null){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7208b0bed573c1390101ca0b85bcd1f7a208a2bf"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI5MDgwNQ==", "bodyText": "This code / feature is not tested anyway, so it can be accidentally removed and nobody will notice the regression before a user reports it. So an IT should be IMO added", "url": "https://github.com/vaadin/flow/pull/9133#discussion_r502290805", "createdAt": "2020-10-09T09:03:48Z", "author": {"login": "pleku"}, "path": "flow-client/src/main/resources/META-INF/resources/frontend/Flow.ts", "diffHunk": "@@ -87,7 +88,7 @@ export class Flow {\n         // IE11 does not support document.baseURI\n         (document.baseURI || elm && elm.href || '/')\n             .replace(/^https?:\\/\\/[^\\/]+/i, ''));\n-\n+    this.appShellTitle = document.title;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7208b0bed573c1390101ca0b85bcd1f7a208a2bf"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c66056755e09098169fb9a5e0561b0c3ebe0fdd", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/7c66056755e09098169fb9a5e0561b0c3ebe0fdd", "committedDate": "2020-10-09T11:10:40Z", "message": "add IT tests, apply code review suggestions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NTg3Mzg2", "url": "https://github.com/vaadin/flow/pull/9133#pullrequestreview-505587386", "createdAt": "2020-10-09T11:27:51Z", "commit": {"oid": "7c66056755e09098169fb9a5e0561b0c3ebe0fdd"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NTg5NDUx", "url": "https://github.com/vaadin/flow/pull/9133#pullrequestreview-505589451", "createdAt": "2020-10-09T11:31:17Z", "commit": {"oid": "7c66056755e09098169fb9a5e0561b0c3ebe0fdd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMTozMToxOFrOHfF7PQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMTozMToxOFrOHfF7PQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM2NDk4OQ==", "bodyText": "Slightly nit picking and thus not blocking: could verify that the title has been changed here in the middle, since if it for some reason would not be changed from the initial, then this test would not add anything extra to the previous test", "url": "https://github.com/vaadin/flow/pull/9133#discussion_r502364989", "createdAt": "2020-10-09T11:31:18Z", "author": {"login": "pleku"}, "path": "flow-tests/test-ccdm/src/test/java/com/vaadin/flow/ccdmtest/NavigateToServerSideViewWithoutTitleIT.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Copyright 2000-2020 Vaadin Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+package com.vaadin.flow.ccdmtest;\n+\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.openqa.selenium.By;\n+\n+public class NavigateToServerSideViewWithoutTitleIT extends CCDMTest {\n+\n+    @Test\n+    public void should_showAppShellTitle_when_navigateToAServerSideViewWithoutTitle() {\n+        openVaadinRouter();\n+\n+        findAnchor(\"view-with-server-view-button\").click();\n+\n+        // \"app-shell-title\" is defined in AppShell\n+        Assert.assertEquals(\"Shoul use app shell title\", \"app-shell-title\",\n+                getDriver().getTitle());\n+    }\n+\n+    @Test\n+    public void should_showAppShellTitle_after_titleHasBeenChangedOnTheClientSide_when_navigateToAServerSideViewWithoutTitle() {\n+        openVaadinRouter();\n+\n+        // update document.title on the client-side\n+        findElement(By.id(\"updatePageTitle\")).click();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c66056755e09098169fb9a5e0561b0c3ebe0fdd"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "789253b6b0dcc84e197816f1019c0dbf6750c99a", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/789253b6b0dcc84e197816f1019c0dbf6750c99a", "committedDate": "2020-10-09T11:41:56Z", "message": "verify document.title was updated on the client-side"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb559847c8e355b7ca44dd3eeb7a589d195f2ad0", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/bb559847c8e355b7ca44dd3eeb7a589d195f2ad0", "committedDate": "2020-10-09T11:42:36Z", "message": "fix typo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NjEwNjAy", "url": "https://github.com/vaadin/flow/pull/9133#pullrequestreview-505610602", "createdAt": "2020-10-09T12:05:59Z", "commit": {"oid": "bb559847c8e355b7ca44dd3eeb7a589d195f2ad0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMjowNTo1OVrOHfG6Ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMjowNTo1OVrOHfG6Ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM4MTExNQ==", "bodyText": "Do not forget to remove this deprecated code someday.", "url": "https://github.com/vaadin/flow/pull/9133#discussion_r502381115", "createdAt": "2020-10-09T12:05:59Z", "author": {"login": "vaadin-bot"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/AppShellRegistry.java", "diffHunk": "@@ -163,12 +161,16 @@ public boolean isShell(Class<?> clz) {\n     }\n \n     /**\n-     * Return the text content of the title tag in the application shell.\n-     *\n-     * @return title;\n+     * @return {code null};\n+     * \n+     * @deprecated this method does not work, to get the application shell title, \n+     * use {code UI.getCurrent().getInternals().getAppShellTitle()} instead.\n      */\n+    @Deprecated\n     public String getTitle() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb559847c8e355b7ca44dd3eeb7a589d195f2ad0"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NjcxNzg1", "url": "https://github.com/vaadin/flow/pull/9133#pullrequestreview-505671785", "createdAt": "2020-10-09T13:27:49Z", "commit": {"oid": "bb559847c8e355b7ca44dd3eeb7a589d195f2ad0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NzgxNjAw", "url": "https://github.com/vaadin/flow/pull/9133#pullrequestreview-505781600", "createdAt": "2020-10-09T15:31:27Z", "commit": {"oid": "bb559847c8e355b7ca44dd3eeb7a589d195f2ad0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 13, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}