{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0MTQ4MDc3", "number": 7904, "title": "Make a workaround for skinnywar/Wildfly", "bodyText": "Fixes #7805\n\n\nThis change is\u2002", "createdAt": "2020-03-26T12:45:16Z", "url": "https://github.com/vaadin/flow/pull/7904", "merged": true, "mergeCommit": {"oid": "571e1d72227eb5c702fa3f8edd3604f43d540a9e"}, "closed": true, "closedAt": "2020-03-31T07:24:43Z", "author": {"login": "denis-anisimov"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRZ2MegH2gAyMzk0MTQ4MDc3OjVmNDhkNDQyYWRkZThkZDE0ODY4YTU4Mzc5ZGRlOTNiNDRkM2Q5OWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcS96AOgFqTM4NDQ2MzQ4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5f48d442adde8dd14868a58379dde93b44d3d99b", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/5f48d442adde8dd14868a58379dde93b44d3d99b", "committedDate": "2020-03-26T10:49:37Z", "message": "Make a workaround for skinnywar/Wildfly\n\nFixes #7805"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxOTc4MzEy", "url": "https://github.com/vaadin/flow/pull/7904#pullrequestreview-381978312", "createdAt": "2020-03-26T12:54:29Z", "commit": {"oid": "109e708d2bbab78949b00a2a5074040d0494d287"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjo1NDoyOVrOF8Fekw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjo1NDoyOVrOF8Fekw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU0ODYyNw==", "bodyText": "Use the built-in formatting to construct this argument.", "url": "https://github.com/vaadin/flow/pull/7904#discussion_r398548627", "createdAt": "2020-03-26T12:54:29Z", "author": {"login": "vaadin-bot"}, "path": "flow-test-generic/src/main/java/com/vaadin/flow/testutil/ClassFinder.java", "diffHunk": "@@ -0,0 +1,204 @@\n+/*\n+ * Copyright 2000-2020 Vaadin Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package com.vaadin.flow.testutil;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Type;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.Enumeration;\n+import java.util.List;\n+import java.util.jar.JarEntry;\n+import java.util.jar.JarFile;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.junit.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.junit.Assert.assertNotNull;\n+\n+public abstract class ClassFinder {\n+\n+    private final Logger logger = LoggerFactory.getLogger(ClassFinder.class);\n+\n+    protected boolean isTestClassPath(String classPath) {\n+        File file = new File(classPath);\n+        return \"test-classes\".equals(file.getName());\n+    }\n+\n+    protected static boolean isFunctionalType(Type type) {\n+        return type.getTypeName().contains(\"java.util.function\");\n+    }\n+\n+    /**\n+     * Lists all class path entries by splitting the class path string.\n+     * <p>\n+     * Adapted from ClassPathExplorer.getRawClasspathEntries(), but without\n+     * filtering.\n+     *\n+     * @return List of class path segment strings\n+     */\n+    protected static List<String> getRawClasspathEntries() {\n+        // try to keep the order of the classpath\n+\n+        String pathSep = System.getProperty(\"path.separator\");\n+        String classpath = System.getProperty(\"java.class.path\");\n+\n+        if (classpath.startsWith(\"\\\"\")) {\n+            classpath = classpath.substring(1);\n+        }\n+        if (classpath.endsWith(\"\\\"\")) {\n+            classpath = classpath.substring(0, classpath.length() - 1);\n+        }\n+\n+        String[] split = classpath.split(pathSep);\n+        return Arrays.asList(split);\n+    }\n+\n+    /**\n+     * Lists class names (based on .class files) in a directory (a package path\n+     * root).\n+     *\n+     * @param parentPackage\n+     *            parent package name or null at root of hierarchy, used by\n+     *            recursion\n+     * @param parent\n+     *            File representing the directory to scan\n+     * @return collection of fully qualified class names in the directory\n+     */\n+    private static Collection<String> findClassesInDirectory(\n+            String parentPackage, File parent) {\n+        if (parent.isHidden()\n+                || parent.getPath().contains(File.separator + \".\")) {\n+            return Collections.emptyList();\n+        }\n+\n+        if (parentPackage == null) {\n+            parentPackage = \"\";\n+        } else {\n+            parentPackage += \".\";\n+        }\n+\n+        Collection<String> classNames = new ArrayList<>();\n+\n+        // add all directories recursively\n+        File[] files = parent.listFiles();\n+        assertNotNull(files);\n+        for (File child : files) {\n+            if (child.isDirectory()) {\n+                classNames.addAll(findClassesInDirectory(\n+                        parentPackage + child.getName(), child));\n+            } else if (child.getName().endsWith(\".class\")) {\n+                classNames.add(parentPackage.replace(File.separatorChar, '.')\n+                        + child.getName().replaceAll(\"\\\\.class\", \"\"));\n+            }\n+        }\n+\n+        return classNames;\n+    }\n+\n+    /**\n+     * JARs that will be scanned for classes to test, in addition to classpath\n+     * directories.\n+     *\n+     * @return the compiled pattern\n+     */\n+    @SuppressWarnings(\"WeakerAccess\")\n+    protected Pattern getJarPattern() {\n+        return Pattern.compile(\"(.*vaadin.*)|(.*flow.*)\\\\.jar\");\n+    }\n+\n+    @SuppressWarnings(\"WeakerAccess\")\n+    protected Stream<String> getBasePackages() {\n+        return Stream.of(\"com.vaadin\");\n+    }\n+\n+    protected boolean isTestClass(Class<?> cls) {\n+        if (cls.getEnclosingClass() != null\n+                && isTestClass(cls.getEnclosingClass())) {\n+            return true;\n+        }\n+\n+        // Test classes with a @Test annotation on some method\n+        for (Method method : cls.getMethods()) {\n+            if (method.isAnnotationPresent(Test.class)) {\n+                return true;\n+            }\n+        }\n+\n+        return false;\n+    }\n+\n+    /**\n+     * Finds the server side classes/interfaces under a class path entry -\n+     * either a directory or a JAR that matches {@link #getJarPattern()}.\n+     * <p>\n+     * Only classes under {@link #getBasePackages} are considered, and those\n+     * matching {@link #getExcludedPatterns()} are filtered out.\n+     */\n+    protected List<String> findServerClasses(String classpathEntry,\n+            Collection<Pattern> excludes) throws IOException {\n+        Collection<String> classes;\n+\n+        File file = new File(classpathEntry);\n+        if (file.isDirectory()) {\n+            classes = findClassesInDirectory(null, file);\n+        } else if (getJarPattern().matcher(file.getName()).matches()) {\n+            classes = findClassesInJar(file);\n+        } else {\n+            logger.debug(\"Ignoring \" + classpathEntry);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "109e708d2bbab78949b00a2a5074040d0494d287"}, "originalPosition": 169}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "109e708d2bbab78949b00a2a5074040d0494d287", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/109e708d2bbab78949b00a2a5074040d0494d287", "committedDate": "2020-03-26T11:00:25Z", "message": "Add unit test for checking that any initializer implements Fixed\ninitializer"}, "afterCommit": {"oid": "3ca179a35af9fa10e69e5b67a10bb1198b5decbd", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/3ca179a35af9fa10e69e5b67a10bb1198b5decbd", "committedDate": "2020-03-26T13:16:54Z", "message": "Add unit test for checking that any initializer implements Fixed\ninitializer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3ca179a35af9fa10e69e5b67a10bb1198b5decbd", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/3ca179a35af9fa10e69e5b67a10bb1198b5decbd", "committedDate": "2020-03-26T13:16:54Z", "message": "Add unit test for checking that any initializer implements Fixed\ninitializer"}, "afterCommit": {"oid": "21260de18210c7cfd9f8492888e15e6ffc1bd3d6", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/21260de18210c7cfd9f8492888e15e6ffc1bd3d6", "committedDate": "2020-03-26T18:11:40Z", "message": "Add unit test for checking that any initializer implements Fixed\ninitializer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a2fc075bd6b632d24d06d674c5d9077ae325517", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/9a2fc075bd6b632d24d06d674c5d9077ae325517", "committedDate": "2020-03-26T18:14:24Z", "message": "Add unit test for checking that any initializer implements Fixed\ninitializer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6f06359dbdc808b7332a6d4a05ce5bdd7bb4876", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/d6f06359dbdc808b7332a6d4a05ce5bdd7bb4876", "committedDate": "2020-03-27T05:50:38Z", "message": "Update unit tests to avoid direct call onStartUp."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "21260de18210c7cfd9f8492888e15e6ffc1bd3d6", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/21260de18210c7cfd9f8492888e15e6ffc1bd3d6", "committedDate": "2020-03-26T18:11:40Z", "message": "Add unit test for checking that any initializer implements Fixed\ninitializer"}, "afterCommit": {"oid": "d6f06359dbdc808b7332a6d4a05ce5bdd7bb4876", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/d6f06359dbdc808b7332a6d4a05ce5bdd7bb4876", "committedDate": "2020-03-27T05:50:38Z", "message": "Update unit tests to avoid direct call onStartUp."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "624f0c354038ab17e25eb31a32d38a497e6060e0", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/624f0c354038ab17e25eb31a32d38a497e6060e0", "committedDate": "2020-03-27T06:04:15Z", "message": "Add javadocs to test class."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNTk4MjMz", "url": "https://github.com/vaadin/flow/pull/7904#pullrequestreview-382598233", "createdAt": "2020-03-27T06:04:45Z", "commit": {"oid": "624f0c354038ab17e25eb31a32d38a497e6060e0"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab01d2b6805cff9d2a4dd20e507ec10cdc00f90d", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/ab01d2b6805cff9d2a4dd20e507ec10cdc00f90d", "committedDate": "2020-03-27T06:19:18Z", "message": "Fix tests in 1000th time"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8693c8936f99ecee5688de65466539177c28e2c8", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/8693c8936f99ecee5688de65466539177c28e2c8", "committedDate": "2020-03-27T06:37:02Z", "message": "Fix tests in 1001th time"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyODkwNTI4", "url": "https://github.com/vaadin/flow/pull/7904#pullrequestreview-382890528", "createdAt": "2020-03-27T14:09:00Z", "commit": {"oid": "8693c8936f99ecee5688de65466539177c28e2c8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzNDM5MzM2", "url": "https://github.com/vaadin/flow/pull/7904#pullrequestreview-383439336", "createdAt": "2020-03-29T18:14:01Z", "commit": {"oid": "8693c8936f99ecee5688de65466539177c28e2c8"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzNDM5ODM1", "url": "https://github.com/vaadin/flow/pull/7904#pullrequestreview-383439835", "createdAt": "2020-03-29T18:19:32Z", "commit": {"oid": "df2ec09f60fd8c2adb6de5b63372484be3f1bc9a"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzNDQwMjc0", "url": "https://github.com/vaadin/flow/pull/7904#pullrequestreview-383440274", "createdAt": "2020-03-29T18:24:21Z", "commit": {"oid": "df2ec09f60fd8c2adb6de5b63372484be3f1bc9a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOVQxODoyNDoyMVrOF9T9Zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOVQxODoyNDoyMVrOF9T9Zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTgzNDQ3MQ==", "bodyText": "Call \"Optional#isPresent()\" before accessing the value.", "url": "https://github.com/vaadin/flow/pull/7904#discussion_r399834471", "createdAt": "2020-03-29T18:24:21Z", "author": {"login": "vaadin-bot"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/startup/ClassLoaderAwareServletContainerInitializer.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright 2000-2020 Vaadin Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package com.vaadin.flow.server.startup;\n+\n+import javax.servlet.ServletContainerInitializer;\n+import javax.servlet.ServletContext;\n+import javax.servlet.ServletException;\n+\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.util.Set;\n+import java.util.stream.Stream;\n+\n+/**\n+ * Allows to load the implementation class by one classloader but accepts\n+ * classes in {@link #onStartup(Set, ServletContext)} method loaded by another\n+ * classloader.\n+ * <p>\n+ * Workaround for https://github.com/vaadin/flow/issues/7805.\n+ *\n+ * @author Vaadin Ltd\n+ *\n+ */\n+public interface ClassLoaderAwareServletContainerInitializer\n+        extends ServletContainerInitializer {\n+\n+    /**\n+     * Overridden to use different classloaders if needed.\n+     * <p>\n+     * {@inheritdoc}\n+     */\n+    @Override\n+    default void onStartup(Set<Class<?>> set, ServletContext ctx)\n+            throws ServletException {\n+        ClassLoader webClassLoader = ctx.getClassLoader();\n+        ClassLoader classLoader = getClass().getClassLoader();\n+\n+        /*\n+         * Hack is needed to make a workaround for weird behavior of WildFly\n+         * with skinnywar See https://github.com/vaadin/flow/issues/7805\n+         */\n+        boolean noHack = false;\n+        while (classLoader != null) {\n+            if (classLoader.equals(webClassLoader)) {\n+                noHack = true;\n+                break;\n+            } else {\n+                /*\n+                 * The classloader which has loaded this class ({@code\n+                 * classLoader}) should be either the {@code webClassLoader} or\n+                 * its child: in this case it knows how to handle the classes\n+                 * loaded by the {@code webClassLoader} : it either is able to\n+                 * load them itself or delegate to its parent (which is the\n+                 * {@code webClassLoader}): in this case hack is not needed and\n+                 * the {@link #process(Set, ServletContext)} method can be\n+                 * called directly.\n+                 */\n+                classLoader = classLoader.getParent();\n+            }\n+        }\n+\n+        if (noHack) {\n+            process(set, ctx);\n+            return;\n+        }\n+\n+        try {\n+            Class<?> initializer = ctx.getClassLoader()\n+                    .loadClass(getClass().getName());\n+\n+            String processMethodName = Stream", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df2ec09f60fd8c2adb6de5b63372484be3f1bc9a"}, "originalPosition": 84}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "df2ec09f60fd8c2adb6de5b63372484be3f1bc9a", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/df2ec09f60fd8c2adb6de5b63372484be3f1bc9a", "committedDate": "2020-03-29T18:14:25Z", "message": "Corrections based on review"}, "afterCommit": {"oid": "038e0e31d94aac92929a91c654ae11de8116e887", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/038e0e31d94aac92929a91c654ae11de8116e887", "committedDate": "2020-03-29T18:48:42Z", "message": "Corrections based on review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "382ee73f2de82685b266c7bf0ff14eeec0d13897", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/382ee73f2de82685b266c7bf0ff14eeec0d13897", "committedDate": "2020-03-30T05:14:34Z", "message": "Corrections based on review"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "038e0e31d94aac92929a91c654ae11de8116e887", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/038e0e31d94aac92929a91c654ae11de8116e887", "committedDate": "2020-03-29T18:48:42Z", "message": "Corrections based on review"}, "afterCommit": {"oid": "382ee73f2de82685b266c7bf0ff14eeec0d13897", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/382ee73f2de82685b266c7bf0ff14eeec0d13897", "committedDate": "2020-03-30T05:14:34Z", "message": "Corrections based on review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzNjU5Njkz", "url": "https://github.com/vaadin/flow/pull/7904#pullrequestreview-383659693", "createdAt": "2020-03-30T09:04:26Z", "commit": {"oid": "382ee73f2de82685b266c7bf0ff14eeec0d13897"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NDU5MDA0", "url": "https://github.com/vaadin/flow/pull/7904#pullrequestreview-384459004", "createdAt": "2020-03-31T07:17:03Z", "commit": {"oid": "382ee73f2de82685b266c7bf0ff14eeec0d13897"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NDYzMjIx", "url": "https://github.com/vaadin/flow/pull/7904#pullrequestreview-384463221", "createdAt": "2020-03-31T07:23:51Z", "commit": {"oid": "382ee73f2de82685b266c7bf0ff14eeec0d13897"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NDYzNDg4", "url": "https://github.com/vaadin/flow/pull/7904#pullrequestreview-384463488", "createdAt": "2020-03-31T07:24:17Z", "commit": {"oid": "382ee73f2de82685b266c7bf0ff14eeec0d13897"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 623, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}