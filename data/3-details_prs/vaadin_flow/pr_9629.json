{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1ODc1NDgw", "number": 9629, "title": "fix(offline): do not cache CSRF token and clear on offline logout", "bodyText": "Fixes #9537.", "createdAt": "2020-12-10T11:42:09Z", "url": "https://github.com/vaadin/flow/pull/9629", "merged": true, "mergeCommit": {"oid": "0467a2f9c8647513ece59b219c6e06c5becf3221"}, "closed": true, "closedAt": "2020-12-14T09:42:59Z", "author": {"login": "joheriks"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkx5t7ABqjQwOTQ2ODc1ODU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmBdBrAH2gAyNTM1ODc1NDgwOjU2MTU5ODczY2NlOGY4MzQ1NzdmNzY0YWY3MzgzODg5ZDM1NzYyOWY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6a6e085a38e41a0c9ed3ffbc4277e9dc6694a8cb", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/6a6e085a38e41a0c9ed3ffbc4277e9dc6694a8cb", "committedDate": "2020-12-10T11:41:17Z", "message": "fix: do not cache CSRF token and clear on offline logout"}, "afterCommit": {"oid": "96d656a3b9bfc80bb9b82b312a38262af31b1def", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/96d656a3b9bfc80bb9b82b312a38262af31b1def", "committedDate": "2020-12-10T11:46:39Z", "message": "fix: do not cache CSRF token and clear on offline logout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a0c9a5c8a19cd68ecf8592cdf849ad2902904b6", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/0a0c9a5c8a19cd68ecf8592cdf849ad2902904b6", "committedDate": "2020-12-10T12:01:10Z", "message": "fix: do not cache CSRF token and clear on offline logout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "96d656a3b9bfc80bb9b82b312a38262af31b1def", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/96d656a3b9bfc80bb9b82b312a38262af31b1def", "committedDate": "2020-12-10T11:46:39Z", "message": "fix: do not cache CSRF token and clear on offline logout"}, "afterCommit": {"oid": "0a0c9a5c8a19cd68ecf8592cdf849ad2902904b6", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/0a0c9a5c8a19cd68ecf8592cdf849ad2902904b6", "committedDate": "2020-12-10T12:01:10Z", "message": "fix: do not cache CSRF token and clear on offline logout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5NTU4MTk2", "url": "https://github.com/vaadin/flow/pull/9629#pullrequestreview-549558196", "createdAt": "2020-12-10T20:04:01Z", "commit": {"oid": "0a0c9a5c8a19cd68ecf8592cdf849ad2902904b6"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwMTAyNjAy", "url": "https://github.com/vaadin/flow/pull/9629#pullrequestreview-550102602", "createdAt": "2020-12-11T13:36:57Z", "commit": {"oid": "0a0c9a5c8a19cd68ecf8592cdf849ad2902904b6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxMzozNjo1N1rOID5D4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxMzozNjo1N1rOID5D4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk1MTUyMw==", "bodyText": "I wonder is it guaranteed that this way of detecting request from SW will keep working in all supported browsers? Have we tested this on Chrome, Firefox and Safari? Any idea if this referer header for SW initiated requests is part of some spec?\nI also started wondering does the user need to download the index page twice now on first load (first normally with the token and then SW would load and precache it without the token)? If so it would be good if we can somehow avoid the double load but that could be a new issue.\nOtherwise the code seems good to me. If it works like intended on all supported browsers now, I'm ok with merging this.", "url": "https://github.com/vaadin/flow/pull/9629#discussion_r540951523", "createdAt": "2020-12-11T13:36:57Z", "author": {"login": "Haprog"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/communication/IndexHtmlRequestHandler.java", "diffHunk": "@@ -162,10 +162,15 @@ private void addDevmodeGizmo(Document indexDocument, VaadinSession session,\n     }\n \n     private void addInitialFlow(JsonObject initialJson, Document indexDocument,\n-                                VaadinSession session) {\n-        String csrfToken = session.getCsrfToken();\n-        if (csrfToken != null) {\n-            initialJson.put(CSRF_TOKEN, csrfToken);\n+                                VaadinSession session, VaadinRequest request) {\n+        // Do not add the CSRF token if the request comes from the service\n+        // worker, to not have the token cached locally (#9537)\n+        String referer = request.getHeader(\"referer\");\n+        if (referer == null || !referer.endsWith(\"/sw.js\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a0c9a5c8a19cd68ecf8592cdf849ad2902904b6"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwMTA1NTYw", "url": "https://github.com/vaadin/flow/pull/9629#pullrequestreview-550105560", "createdAt": "2020-12-11T13:40:51Z", "commit": {"oid": "0a0c9a5c8a19cd68ecf8592cdf849ad2902904b6"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxMzo0MDo1MVrOID5NZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxMzo0MDo1MVrOID5NZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk1Mzk1Nw==", "bodyText": "BTW not blocking, but looks like try { await .... } catch { } would fit here, making for less code not requiring inline callbacks.", "url": "https://github.com/vaadin/flow/pull/9629#discussion_r540953957", "createdAt": "2020-12-11T13:40:51Z", "author": {"login": "platosha"}, "path": "flow-client/src/main/resources/META-INF/resources/frontend/Authentication.ts", "diffHunk": "@@ -81,12 +81,17 @@ export async function login(username: string, password: string, options?: LoginO\n export async function logout(options?: LogoutOptions) {\n   // this assumes the default Spring Security logout configuration (handler URL)\n   const logoutUrl = options && options.logoutUrl ? options.logoutUrl : '/logout';\n-  const response = await fetch(logoutUrl);\n \n-  // TODO: find a more efficient way to get a new CSRF token\n-  // parsing the full response body just to get a token may be wasteful\n-  const token = getCsrfTokenFromResponseBody(await response.text());\n-  (window as any).Vaadin.TypeScript.csrfToken = token;\n+  await fetch(logoutUrl).then(async response => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a0c9a5c8a19cd68ecf8592cdf849ad2902904b6"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c6f748139bb3929669f77f7efaefd53e67a5743", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/6c6f748139bb3929669f77f7efaefd53e67a5743", "committedDate": "2020-12-11T14:07:42Z", "message": "Merge branch 'feature/offline' into joheriks/9537-clear-cstrf-token-on-failed-logout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a029c0108e92bf76ab140bb1f2f550d8342522c2", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/a029c0108e92bf76ab140bb1f2f550d8342522c2", "committedDate": "2020-12-11T14:13:29Z", "message": "chore: use try-catch instead of then-catch handlers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwMTU2MTUw", "url": "https://github.com/vaadin/flow/pull/9629#pullrequestreview-550156150", "createdAt": "2020-12-11T14:41:23Z", "commit": {"oid": "a029c0108e92bf76ab140bb1f2f550d8342522c2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNDg3MjM5", "url": "https://github.com/vaadin/flow/pull/9629#pullrequestreview-550487239", "createdAt": "2020-12-11T18:57:15Z", "commit": {"oid": "a029c0108e92bf76ab140bb1f2f550d8342522c2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56159873cce8f834577f764af7383889d357629f", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/56159873cce8f834577f764af7383889d357629f", "committedDate": "2020-12-14T08:27:58Z", "message": "Merge branch 'feature/offline' into joheriks/9537-clear-cstrf-token-on-failed-logout"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4674, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}