{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyMDEyOTQ0", "number": 8806, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMDowOToxN1rOEU7zYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwODoxMzo1NFrOEWH37Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMzg2Nzg1OnYy", "diffSide": "RIGHT", "path": "flow-client/src/main/resources/META-INF/resources/frontend/Connect.ts", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMDowOToxN1rOG7Z-sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMTozMDoyNFrOG7cVvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk0NDgxOQ==", "bodyText": "Why export const login instead of export async function login?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            export const login = async (username: string, password: string): Promise<LoginResult> => {\n          \n          \n            \n            export async function login(username: string, password: string): Promise<LoginResult> {", "url": "https://github.com/vaadin/flow/pull/8806#discussion_r464944819", "createdAt": "2020-08-04T10:09:17Z", "author": {"login": "Haprog"}, "path": "flow-client/src/main/resources/META-INF/resources/frontend/Connect.ts", "diffHunk": "@@ -369,3 +369,93 @@ export class ConnectClient {\n     }\n   }\n }\n+\n+export interface LoginResult {\n+  token?: string;\n+  error: boolean;\n+  errorTitle: string;\n+  errorMessage: string;\n+}\n+\n+export const login = async (username: string, password: string): Promise<LoginResult> => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ecf52ffd0d0cc44739532e08faf4b30e1534997"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk4MzQ4NQ==", "bodyText": "done", "url": "https://github.com/vaadin/flow/pull/8806#discussion_r464983485", "createdAt": "2020-08-04T11:30:24Z", "author": {"login": "haijian-vaadin"}, "path": "flow-client/src/main/resources/META-INF/resources/frontend/Connect.ts", "diffHunk": "@@ -369,3 +369,93 @@ export class ConnectClient {\n     }\n   }\n }\n+\n+export interface LoginResult {\n+  token?: string;\n+  error: boolean;\n+  errorTitle: string;\n+  errorMessage: string;\n+}\n+\n+export const login = async (username: string, password: string): Promise<LoginResult> => {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk0NDgxOQ=="}, "originalCommit": {"oid": "9ecf52ffd0d0cc44739532e08faf4b30e1534997"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMzg4NTkyOnYy", "diffSide": "RIGHT", "path": "flow-client/src/main/resources/META-INF/resources/frontend/Connect.ts", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMDoxNTowN1rOG7aJuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxNDowMToyM1rOG806qQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk0NzY0Mw==", "bodyText": "I think this is ok for a first version so not a blocker, but this catching could be improved to check for some type of errors (like specifically network errors) so we could give a bit more meaningful error messages (different message for actual network errors and different for other errors that may be caused by bugs in our logic. Maybe wrap only smaller parts of the code in try/catch block.\nNow this always results in \"Communication error\" even if there's a bug in the try block that throws for other reason like  trying to access properties in undefined objects.", "url": "https://github.com/vaadin/flow/pull/8806#discussion_r464947643", "createdAt": "2020-08-04T10:15:07Z", "author": {"login": "Haprog"}, "path": "flow-client/src/main/resources/META-INF/resources/frontend/Connect.ts", "diffHunk": "@@ -369,3 +369,93 @@ export class ConnectClient {\n     }\n   }\n }\n+\n+export interface LoginResult {\n+  token?: string;\n+  error: boolean;\n+  errorTitle: string;\n+  errorMessage: string;\n+}\n+\n+export const login = async (username: string, password: string): Promise<LoginResult> => {\n+  let result;\n+  try {\n+    // this assumes the default Spring Security form login configuration (parameter names)\n+    const data = new FormData();\n+    data.append('username', username);\n+    data.append('password', password);\n+\n+    const response = await fetch('/login', {method: 'POST', body: data});\n+\n+    // this assumes the default Spring Security form login configuration (handler URL and responses)\n+    if (response.ok && response.redirected && response.url.endsWith('/login?error')) {\n+      result = {\n+        error: true,\n+        errorTitle: 'Incorrect username or password.',\n+        errorMessage: 'Check that you have entered the correct username and password and try again.'\n+      };\n+    } else if (response.ok && response.redirected && response.url.endsWith('/')) {\n+      // TODO: find a more efficient way to get a new CSRF token\n+      // parsing the full response body just to get a token may be wasteful\n+      const token = getCsrfTokenFromResponseBody(await response.text());\n+      if (token) {\n+        (window as any).Vaadin.TypeScript = (window as any).Vaadin.TypeScript || {};\n+        (window as any).Vaadin.TypeScript.csrfToken = token;\n+        result = {\n+          error: false,\n+          errorTitle: '',\n+          errorMessage: '',\n+          token\n+        };\n+      }\n+    }\n+  } catch (e) {\n+    // eat the exception\n+  }\n+\n+  return result || {\n+    error: true,\n+    errorTitle: 'Communication error.',\n+    errorMessage: 'Please check your network connection and try again.',\n+  };", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ecf52ffd0d0cc44739532e08faf4b30e1534997"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk5MjE1MQ==", "bodyText": "did some change, now returns a different result in the catch block", "url": "https://github.com/vaadin/flow/pull/8806#discussion_r464992151", "createdAt": "2020-08-04T11:48:42Z", "author": {"login": "haijian-vaadin"}, "path": "flow-client/src/main/resources/META-INF/resources/frontend/Connect.ts", "diffHunk": "@@ -369,3 +369,93 @@ export class ConnectClient {\n     }\n   }\n }\n+\n+export interface LoginResult {\n+  token?: string;\n+  error: boolean;\n+  errorTitle: string;\n+  errorMessage: string;\n+}\n+\n+export const login = async (username: string, password: string): Promise<LoginResult> => {\n+  let result;\n+  try {\n+    // this assumes the default Spring Security form login configuration (parameter names)\n+    const data = new FormData();\n+    data.append('username', username);\n+    data.append('password', password);\n+\n+    const response = await fetch('/login', {method: 'POST', body: data});\n+\n+    // this assumes the default Spring Security form login configuration (handler URL and responses)\n+    if (response.ok && response.redirected && response.url.endsWith('/login?error')) {\n+      result = {\n+        error: true,\n+        errorTitle: 'Incorrect username or password.',\n+        errorMessage: 'Check that you have entered the correct username and password and try again.'\n+      };\n+    } else if (response.ok && response.redirected && response.url.endsWith('/')) {\n+      // TODO: find a more efficient way to get a new CSRF token\n+      // parsing the full response body just to get a token may be wasteful\n+      const token = getCsrfTokenFromResponseBody(await response.text());\n+      if (token) {\n+        (window as any).Vaadin.TypeScript = (window as any).Vaadin.TypeScript || {};\n+        (window as any).Vaadin.TypeScript.csrfToken = token;\n+        result = {\n+          error: false,\n+          errorTitle: '',\n+          errorMessage: '',\n+          token\n+        };\n+      }\n+    }\n+  } catch (e) {\n+    // eat the exception\n+  }\n+\n+  return result || {\n+    error: true,\n+    errorTitle: 'Communication error.',\n+    errorMessage: 'Please check your network connection and try again.',\n+  };", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk0NzY0Mw=="}, "originalCommit": {"oid": "9ecf52ffd0d0cc44739532e08faf4b30e1534997"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ3ODQxMA==", "bodyText": "I think it's better now, but I just realized the \"Please check your network connection and try again.\" is only shown in case the network request does not fail (the server does respond) but when the response doesn't match either of the two expected redirection cases above. So basically if the response is not \"ok\" (like it is a 404 or 500) or if it's not a redirection, then this message is shown.\nSo this message should be something else since actual network failures are caught in the catch block I think.", "url": "https://github.com/vaadin/flow/pull/8806#discussion_r465478410", "createdAt": "2020-08-05T05:17:58Z", "author": {"login": "Haprog"}, "path": "flow-client/src/main/resources/META-INF/resources/frontend/Connect.ts", "diffHunk": "@@ -369,3 +369,93 @@ export class ConnectClient {\n     }\n   }\n }\n+\n+export interface LoginResult {\n+  token?: string;\n+  error: boolean;\n+  errorTitle: string;\n+  errorMessage: string;\n+}\n+\n+export const login = async (username: string, password: string): Promise<LoginResult> => {\n+  let result;\n+  try {\n+    // this assumes the default Spring Security form login configuration (parameter names)\n+    const data = new FormData();\n+    data.append('username', username);\n+    data.append('password', password);\n+\n+    const response = await fetch('/login', {method: 'POST', body: data});\n+\n+    // this assumes the default Spring Security form login configuration (handler URL and responses)\n+    if (response.ok && response.redirected && response.url.endsWith('/login?error')) {\n+      result = {\n+        error: true,\n+        errorTitle: 'Incorrect username or password.',\n+        errorMessage: 'Check that you have entered the correct username and password and try again.'\n+      };\n+    } else if (response.ok && response.redirected && response.url.endsWith('/')) {\n+      // TODO: find a more efficient way to get a new CSRF token\n+      // parsing the full response body just to get a token may be wasteful\n+      const token = getCsrfTokenFromResponseBody(await response.text());\n+      if (token) {\n+        (window as any).Vaadin.TypeScript = (window as any).Vaadin.TypeScript || {};\n+        (window as any).Vaadin.TypeScript.csrfToken = token;\n+        result = {\n+          error: false,\n+          errorTitle: '',\n+          errorMessage: '',\n+          token\n+        };\n+      }\n+    }\n+  } catch (e) {\n+    // eat the exception\n+  }\n+\n+  return result || {\n+    error: true,\n+    errorTitle: 'Communication error.',\n+    errorMessage: 'Please check your network connection and try again.',\n+  };", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk0NzY0Mw=="}, "originalCommit": {"oid": "9ecf52ffd0d0cc44739532e08faf4b30e1534997"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQzNDcyOQ==", "bodyText": "updated with a more generic message.", "url": "https://github.com/vaadin/flow/pull/8806#discussion_r466434729", "createdAt": "2020-08-06T14:01:23Z", "author": {"login": "haijian-vaadin"}, "path": "flow-client/src/main/resources/META-INF/resources/frontend/Connect.ts", "diffHunk": "@@ -369,3 +369,93 @@ export class ConnectClient {\n     }\n   }\n }\n+\n+export interface LoginResult {\n+  token?: string;\n+  error: boolean;\n+  errorTitle: string;\n+  errorMessage: string;\n+}\n+\n+export const login = async (username: string, password: string): Promise<LoginResult> => {\n+  let result;\n+  try {\n+    // this assumes the default Spring Security form login configuration (parameter names)\n+    const data = new FormData();\n+    data.append('username', username);\n+    data.append('password', password);\n+\n+    const response = await fetch('/login', {method: 'POST', body: data});\n+\n+    // this assumes the default Spring Security form login configuration (handler URL and responses)\n+    if (response.ok && response.redirected && response.url.endsWith('/login?error')) {\n+      result = {\n+        error: true,\n+        errorTitle: 'Incorrect username or password.',\n+        errorMessage: 'Check that you have entered the correct username and password and try again.'\n+      };\n+    } else if (response.ok && response.redirected && response.url.endsWith('/')) {\n+      // TODO: find a more efficient way to get a new CSRF token\n+      // parsing the full response body just to get a token may be wasteful\n+      const token = getCsrfTokenFromResponseBody(await response.text());\n+      if (token) {\n+        (window as any).Vaadin.TypeScript = (window as any).Vaadin.TypeScript || {};\n+        (window as any).Vaadin.TypeScript.csrfToken = token;\n+        result = {\n+          error: false,\n+          errorTitle: '',\n+          errorMessage: '',\n+          token\n+        };\n+      }\n+    }\n+  } catch (e) {\n+    // eat the exception\n+  }\n+\n+  return result || {\n+    error: true,\n+    errorTitle: 'Communication error.',\n+    errorMessage: 'Please check your network connection and try again.',\n+  };", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk0NzY0Mw=="}, "originalCommit": {"oid": "9ecf52ffd0d0cc44739532e08faf4b30e1534997"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMzk0MDAxOnYy", "diffSide": "RIGHT", "path": "flow-client/src/main/resources/META-INF/resources/frontend/Connect.ts", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMDozMjoyNFrOG7aqng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxNDowMjoxMVrOG808vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk1NjA2Mg==", "bodyText": "I wonder if there should be some \"base URL\" prefix for this so it works even if the app is hosted in different directory? Or does Spring always have /login at the root? Or should this login path be configurable?", "url": "https://github.com/vaadin/flow/pull/8806#discussion_r464956062", "createdAt": "2020-08-04T10:32:24Z", "author": {"login": "Haprog"}, "path": "flow-client/src/main/resources/META-INF/resources/frontend/Connect.ts", "diffHunk": "@@ -369,3 +369,93 @@ export class ConnectClient {\n     }\n   }\n }\n+\n+export interface LoginResult {\n+  token?: string;\n+  error: boolean;\n+  errorTitle: string;\n+  errorMessage: string;\n+}\n+\n+export const login = async (username: string, password: string): Promise<LoginResult> => {\n+  let result;\n+  try {\n+    // this assumes the default Spring Security form login configuration (parameter names)\n+    const data = new FormData();\n+    data.append('username', username);\n+    data.append('password', password);\n+\n+    const response = await fetch('/login', {method: 'POST', body: data});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ecf52ffd0d0cc44739532e08faf4b30e1534997"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk2OTAyMQ==", "bodyText": "very good catch!\nDo you have experience in how to get the context root?", "url": "https://github.com/vaadin/flow/pull/8806#discussion_r464969021", "createdAt": "2020-08-04T10:59:37Z", "author": {"login": "haijian-vaadin"}, "path": "flow-client/src/main/resources/META-INF/resources/frontend/Connect.ts", "diffHunk": "@@ -369,3 +369,93 @@ export class ConnectClient {\n     }\n   }\n }\n+\n+export interface LoginResult {\n+  token?: string;\n+  error: boolean;\n+  errorTitle: string;\n+  errorMessage: string;\n+}\n+\n+export const login = async (username: string, password: string): Promise<LoginResult> => {\n+  let result;\n+  try {\n+    // this assumes the default Spring Security form login configuration (parameter names)\n+    const data = new FormData();\n+    data.append('username', username);\n+    data.append('password', password);\n+\n+    const response = await fetch('/login', {method: 'POST', body: data});", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk1NjA2Mg=="}, "originalCommit": {"oid": "9ecf52ffd0d0cc44739532e08faf4b30e1534997"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ3NTgzMQ==", "bodyText": "Unfortunately I don't know much about this since I haven't done that much web dev on the Java side.", "url": "https://github.com/vaadin/flow/pull/8806#discussion_r465475831", "createdAt": "2020-08-05T05:08:41Z", "author": {"login": "Haprog"}, "path": "flow-client/src/main/resources/META-INF/resources/frontend/Connect.ts", "diffHunk": "@@ -369,3 +369,93 @@ export class ConnectClient {\n     }\n   }\n }\n+\n+export interface LoginResult {\n+  token?: string;\n+  error: boolean;\n+  errorTitle: string;\n+  errorMessage: string;\n+}\n+\n+export const login = async (username: string, password: string): Promise<LoginResult> => {\n+  let result;\n+  try {\n+    // this assumes the default Spring Security form login configuration (parameter names)\n+    const data = new FormData();\n+    data.append('username', username);\n+    data.append('password', password);\n+\n+    const response = await fetch('/login', {method: 'POST', body: data});", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk1NjA2Mg=="}, "originalCommit": {"oid": "9ecf52ffd0d0cc44739532e08faf4b30e1534997"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQzNTI2Mg==", "bodyText": "Made login/logout parameters configurable.", "url": "https://github.com/vaadin/flow/pull/8806#discussion_r466435262", "createdAt": "2020-08-06T14:02:11Z", "author": {"login": "haijian-vaadin"}, "path": "flow-client/src/main/resources/META-INF/resources/frontend/Connect.ts", "diffHunk": "@@ -369,3 +369,93 @@ export class ConnectClient {\n     }\n   }\n }\n+\n+export interface LoginResult {\n+  token?: string;\n+  error: boolean;\n+  errorTitle: string;\n+  errorMessage: string;\n+}\n+\n+export const login = async (username: string, password: string): Promise<LoginResult> => {\n+  let result;\n+  try {\n+    // this assumes the default Spring Security form login configuration (parameter names)\n+    const data = new FormData();\n+    data.append('username', username);\n+    data.append('password', password);\n+\n+    const response = await fetch('/login', {method: 'POST', body: data});", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk1NjA2Mg=="}, "originalCommit": {"oid": "9ecf52ffd0d0cc44739532e08faf4b30e1534997"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwNzMxNzgwOnYy", "diffSide": "RIGHT", "path": "flow-client/src/test/frontend/ConnectTests.ts", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNToyNTo1MlrOG76sBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxNDowMjoyM1rOG809PQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ4MDcxMA==", "bodyText": "Prefer to continue the convention that test descriptions are naturally readable like \"it should do [this] when [that]\" or so. So try to start with it('should ... or similar. For example in this case I'd maybe write something like:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  it('on invalid credential', async () => {\n          \n          \n            \n                  it('should return an error on invalid credentials', async () => {", "url": "https://github.com/vaadin/flow/pull/8806#discussion_r465480710", "createdAt": "2020-08-05T05:25:52Z", "author": {"login": "Haprog"}, "path": "flow-client/src/test/frontend/ConnectTests.ts", "diffHunk": "@@ -396,5 +395,111 @@ describe('ConnectClient', () => {\n         await client.call('FooEndpoint', 'fooMethod', {fooParam: 'foo'});\n       });\n     });\n+\n+    describe('login', () => {\n+      afterEach(() => fetchMock.restore());\n+\n+      it('on invalid credential', async () => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93890bab03ed581bed3cccd486845a46010002a4"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQzNTM4OQ==", "bodyText": "done", "url": "https://github.com/vaadin/flow/pull/8806#discussion_r466435389", "createdAt": "2020-08-06T14:02:23Z", "author": {"login": "haijian-vaadin"}, "path": "flow-client/src/test/frontend/ConnectTests.ts", "diffHunk": "@@ -396,5 +395,111 @@ describe('ConnectClient', () => {\n         await client.call('FooEndpoint', 'fooMethod', {fooParam: 'foo'});\n       });\n     });\n+\n+    describe('login', () => {\n+      afterEach(() => fetchMock.restore());\n+\n+      it('on invalid credential', async () => {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ4MDcxMA=="}, "originalCommit": {"oid": "93890bab03ed581bed3cccd486845a46010002a4"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwNzMyNjE4OnYy", "diffSide": "RIGHT", "path": "flow-client/src/test/frontend/ConnectTests.ts", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNTozMDowM1rOG76w7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxNDowMjoyN1rOG809cw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ4MTk2Ng==", "bodyText": "Suggestion for more natural description.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  it('on valid credential', async () => {\n          \n          \n            \n                  it('should return a CSRF token on valid credentials', async () => {\n          \n      \n    \n    \n  \n\n(btw I'm not 100% sure how this CSRF protection should work in our case. At least some Spring example I saw included the token in the login POST request already along with the username and password. Not sure if we should do it like that too? Now we're just expecting it back in the response, not sending it in the request)", "url": "https://github.com/vaadin/flow/pull/8806#discussion_r465481966", "createdAt": "2020-08-05T05:30:03Z", "author": {"login": "Haprog"}, "path": "flow-client/src/test/frontend/ConnectTests.ts", "diffHunk": "@@ -396,5 +395,111 @@ describe('ConnectClient', () => {\n         await client.call('FooEndpoint', 'fooMethod', {fooParam: 'foo'});\n       });\n     });\n+\n+    describe('login', () => {\n+      afterEach(() => fetchMock.restore());\n+\n+      it('on invalid credential', async () => {\n+        fetchMock.post('/login', { redirectUrl: '/login?error' });\n+        const result = await login('invalid-username', 'invalid-password');\n+        const expectedResult = {\n+          error: true,\n+          errorTitle: 'Incorrect username or password.',\n+          errorMessage: 'Check that you have entered the correct username and password and try again.'\n+        };\n+\n+        expect(fetchMock.calls()).to.have.lengthOf(1);\n+        expect(result).to.deep.equal(expectedResult);\n+      })\n+\n+      it('on valid credential', async () => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93890bab03ed581bed3cccd486845a46010002a4"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQzNTQ0Mw==", "bodyText": "done", "url": "https://github.com/vaadin/flow/pull/8806#discussion_r466435443", "createdAt": "2020-08-06T14:02:27Z", "author": {"login": "haijian-vaadin"}, "path": "flow-client/src/test/frontend/ConnectTests.ts", "diffHunk": "@@ -396,5 +395,111 @@ describe('ConnectClient', () => {\n         await client.call('FooEndpoint', 'fooMethod', {fooParam: 'foo'});\n       });\n     });\n+\n+    describe('login', () => {\n+      afterEach(() => fetchMock.restore());\n+\n+      it('on invalid credential', async () => {\n+        fetchMock.post('/login', { redirectUrl: '/login?error' });\n+        const result = await login('invalid-username', 'invalid-password');\n+        const expectedResult = {\n+          error: true,\n+          errorTitle: 'Incorrect username or password.',\n+          errorMessage: 'Check that you have entered the correct username and password and try again.'\n+        };\n+\n+        expect(fetchMock.calls()).to.have.lengthOf(1);\n+        expect(result).to.deep.equal(expectedResult);\n+      })\n+\n+      it('on valid credential', async () => {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ4MTk2Ng=="}, "originalCommit": {"oid": "93890bab03ed581bed3cccd486845a46010002a4"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwNzMyOTQzOnYy", "diffSide": "RIGHT", "path": "flow-client/src/test/frontend/ConnectTests.ts", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNTozMTozOFrOG76y2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxNDowMjozMlrOG809qA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ4MjQ1Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  it('on other erros', async () => {\n          \n          \n            \n                  it('should return an error on other unexpected responses', async () => {", "url": "https://github.com/vaadin/flow/pull/8806#discussion_r465482457", "createdAt": "2020-08-05T05:31:38Z", "author": {"login": "Haprog"}, "path": "flow-client/src/test/frontend/ConnectTests.ts", "diffHunk": "@@ -396,5 +395,111 @@ describe('ConnectClient', () => {\n         await client.call('FooEndpoint', 'fooMethod', {fooParam: 'foo'});\n       });\n     });\n+\n+    describe('login', () => {\n+      afterEach(() => fetchMock.restore());\n+\n+      it('on invalid credential', async () => {\n+        fetchMock.post('/login', { redirectUrl: '/login?error' });\n+        const result = await login('invalid-username', 'invalid-password');\n+        const expectedResult = {\n+          error: true,\n+          errorTitle: 'Incorrect username or password.',\n+          errorMessage: 'Check that you have entered the correct username and password and try again.'\n+        };\n+\n+        expect(fetchMock.calls()).to.have.lengthOf(1);\n+        expect(result).to.deep.equal(expectedResult);\n+      })\n+\n+      it('on valid credential', async () => {\n+        fetchMock.post('/login', {\n+          body: 'window.Vaadin = {TypeScript: {\"csrfToken\":\"6a60700e-852b-420f-a126-a1c61b73d1ba\"}};',\n+          redirectUrl: '/'\n+        });\n+        const result = await login('valid-username', 'valid-password');\n+        const expectedResult = {\n+          error: false,\n+          errorTitle: '',\n+          errorMessage: '',\n+          token: '6a60700e-852b-420f-a126-a1c61b73d1ba'\n+        };\n+\n+        expect(fetchMock.calls()).to.have.lengthOf(1);\n+        expect(result).to.deep.equal(expectedResult);\n+      })\n+\n+      it('on other erros', async () => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93890bab03ed581bed3cccd486845a46010002a4"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQzNTQ5Ng==", "bodyText": "done", "url": "https://github.com/vaadin/flow/pull/8806#discussion_r466435496", "createdAt": "2020-08-06T14:02:32Z", "author": {"login": "haijian-vaadin"}, "path": "flow-client/src/test/frontend/ConnectTests.ts", "diffHunk": "@@ -396,5 +395,111 @@ describe('ConnectClient', () => {\n         await client.call('FooEndpoint', 'fooMethod', {fooParam: 'foo'});\n       });\n     });\n+\n+    describe('login', () => {\n+      afterEach(() => fetchMock.restore());\n+\n+      it('on invalid credential', async () => {\n+        fetchMock.post('/login', { redirectUrl: '/login?error' });\n+        const result = await login('invalid-username', 'invalid-password');\n+        const expectedResult = {\n+          error: true,\n+          errorTitle: 'Incorrect username or password.',\n+          errorMessage: 'Check that you have entered the correct username and password and try again.'\n+        };\n+\n+        expect(fetchMock.calls()).to.have.lengthOf(1);\n+        expect(result).to.deep.equal(expectedResult);\n+      })\n+\n+      it('on valid credential', async () => {\n+        fetchMock.post('/login', {\n+          body: 'window.Vaadin = {TypeScript: {\"csrfToken\":\"6a60700e-852b-420f-a126-a1c61b73d1ba\"}};',\n+          redirectUrl: '/'\n+        });\n+        const result = await login('valid-username', 'valid-password');\n+        const expectedResult = {\n+          error: false,\n+          errorTitle: '',\n+          errorMessage: '',\n+          token: '6a60700e-852b-420f-a126-a1c61b73d1ba'\n+        };\n+\n+        expect(fetchMock.calls()).to.have.lengthOf(1);\n+        expect(result).to.deep.equal(expectedResult);\n+      })\n+\n+      it('on other erros', async () => {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ4MjQ1Nw=="}, "originalCommit": {"oid": "93890bab03ed581bed3cccd486845a46010002a4"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNjA3NjAzOnYy", "diffSide": "RIGHT", "path": "flow-client/src/main/resources/META-INF/resources/frontend/Connect.ts", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwNjo0NjowOFrOG9ObkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwODowMDoyNFrOG9Qaww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg1Mjc1Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * It takes a <code>EndpointCallContinue</code> paramter, which can be \n          \n          \n            \n             * It takes an <code>EndpointCallContinue</code> parameter, which can be", "url": "https://github.com/vaadin/flow/pull/8806#discussion_r466852753", "createdAt": "2020-08-07T06:46:08Z", "author": {"login": "Haprog"}, "path": "flow-client/src/main/resources/META-INF/resources/frontend/Connect.ts", "diffHunk": "@@ -439,27 +465,38 @@ const getCsrfTokenFromResponseBody = (body: string): string | undefined => {\n   return match ? match[1] : undefined;\n }\n \n-export type EndpointCallContinue = (token: string) => void;\n+type EndpointCallContinue = (token: string) => void;\n+\n+/**\n+ * It defines what to do when it detects a session is invalid. E.g., \n+ * show a login view.\n+ * It takes a <code>EndpointCallContinue</code> paramter, which can be ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5db5e87df2cf4f20dfef957aca06a11dd96b915"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg4NTMxNQ==", "bodyText": "done", "url": "https://github.com/vaadin/flow/pull/8806#discussion_r466885315", "createdAt": "2020-08-07T08:00:24Z", "author": {"login": "haijian-vaadin"}, "path": "flow-client/src/main/resources/META-INF/resources/frontend/Connect.ts", "diffHunk": "@@ -439,27 +465,38 @@ const getCsrfTokenFromResponseBody = (body: string): string | undefined => {\n   return match ? match[1] : undefined;\n }\n \n-export type EndpointCallContinue = (token: string) => void;\n+type EndpointCallContinue = (token: string) => void;\n+\n+/**\n+ * It defines what to do when it detects a session is invalid. E.g., \n+ * show a login view.\n+ * It takes a <code>EndpointCallContinue</code> paramter, which can be ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg1Mjc1Mw=="}, "originalCommit": {"oid": "b5db5e87df2cf4f20dfef957aca06a11dd96b915"}, "originalPosition": 110}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNjA3Njc2OnYy", "diffSide": "RIGHT", "path": "flow-client/src/main/resources/META-INF/resources/frontend/Connect.ts", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwNjo0NjoyNFrOG9Ob-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwODowMDozMVrOG9QbCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg1Mjg1Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * used to continune the endpoint call.  \n          \n          \n            \n             * used to continue the endpoint call.", "url": "https://github.com/vaadin/flow/pull/8806#discussion_r466852856", "createdAt": "2020-08-07T06:46:24Z", "author": {"login": "Haprog"}, "path": "flow-client/src/main/resources/META-INF/resources/frontend/Connect.ts", "diffHunk": "@@ -439,27 +465,38 @@ const getCsrfTokenFromResponseBody = (body: string): string | undefined => {\n   return match ? match[1] : undefined;\n }\n \n-export type EndpointCallContinue = (token: string) => void;\n+type EndpointCallContinue = (token: string) => void;\n+\n+/**\n+ * It defines what to do when it detects a session is invalid. E.g., \n+ * show a login view.\n+ * It takes a <code>EndpointCallContinue</code> paramter, which can be \n+ * used to continune the endpoint call.  ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5db5e87df2cf4f20dfef957aca06a11dd96b915"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg4NTM4NA==", "bodyText": "done", "url": "https://github.com/vaadin/flow/pull/8806#discussion_r466885384", "createdAt": "2020-08-07T08:00:31Z", "author": {"login": "haijian-vaadin"}, "path": "flow-client/src/main/resources/META-INF/resources/frontend/Connect.ts", "diffHunk": "@@ -439,27 +465,38 @@ const getCsrfTokenFromResponseBody = (body: string): string | undefined => {\n   return match ? match[1] : undefined;\n }\n \n-export type EndpointCallContinue = (token: string) => void;\n+type EndpointCallContinue = (token: string) => void;\n+\n+/**\n+ * It defines what to do when it detects a session is invalid. E.g., \n+ * show a login view.\n+ * It takes a <code>EndpointCallContinue</code> paramter, which can be \n+ * used to continune the endpoint call.  ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg1Mjg1Ng=="}, "originalCommit": {"oid": "b5db5e87df2cf4f20dfef957aca06a11dd96b915"}, "originalPosition": 111}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNjMyNDg2OnYy", "diffSide": "RIGHT", "path": "flow-client/src/main/resources/META-INF/resources/frontend/Connect.ts", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwODoxMTo0M1rOG9QvmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwODoxMTo0M1rOG9QvmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg5MDY0OQ==", "bodyText": "I think this also needs to be exported still. Otherwise users can't do class MyMiddleware implements MiddlewareClass, right?", "url": "https://github.com/vaadin/flow/pull/8806#discussion_r466890649", "createdAt": "2020-08-07T08:11:43Z", "author": {"login": "Haprog"}, "path": "flow-client/src/main/resources/META-INF/resources/frontend/Connect.ts", "diffHunk": "@@ -207,18 +207,29 @@ export interface MiddlewareContext {\n export type MiddlewareNext = (context: MiddlewareContext) =>\n   Promise<Response> | Response;\n \n-/**\n- * An async callback function that can intercept the request and response\n- * of a call.\n- */\n-export interface Middleware {\n+\n+\n+interface MiddlewareClass {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3292139571f88518a4f7d71e4f31ae87c31b99c3"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNjMzMTMzOnYy", "diffSide": "RIGHT", "path": "flow-client/src/main/resources/META-INF/resources/frontend/Connect.ts", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwODoxMzo1NFrOG9Qzdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwODozNDozMFrOG9RbGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg5MTYzOQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            export class InvalidSessionMiddleWare implements MiddlewareClass {\n          \n          \n            \n            export class InvalidSessionMiddleware implements MiddlewareClass {\n          \n      \n    \n    \n  \n\nI just noticed this is the only place where middleware is written like MiddleWare, in all other places it's Middleware.", "url": "https://github.com/vaadin/flow/pull/8806#discussion_r466891639", "createdAt": "2020-08-07T08:13:54Z", "author": {"login": "Haprog"}, "path": "flow-client/src/main/resources/META-INF/resources/frontend/Connect.ts", "diffHunk": "@@ -480,10 +497,10 @@ export type OnInvalidSessionCallback = (continueFunc: EndpointCallContinue) => v\n  * E.g., you can use this to show user a login page when the session has expired.\n  * Use <code>InvalidSessionMiddleWare.create()</code> to create the middleware.\n  */\n-export class InvalidSessionMiddleWare implements Middleware {\n+export class InvalidSessionMiddleWare implements MiddlewareClass {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3292139571f88518a4f7d71e4f31ae87c31b99c3"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg5NzY0Ng==", "bodyText": "good point, done", "url": "https://github.com/vaadin/flow/pull/8806#discussion_r466897646", "createdAt": "2020-08-07T08:26:08Z", "author": {"login": "haijian-vaadin"}, "path": "flow-client/src/main/resources/META-INF/resources/frontend/Connect.ts", "diffHunk": "@@ -480,10 +497,10 @@ export type OnInvalidSessionCallback = (continueFunc: EndpointCallContinue) => v\n  * E.g., you can use this to show user a login page when the session has expired.\n  * Use <code>InvalidSessionMiddleWare.create()</code> to create the middleware.\n  */\n-export class InvalidSessionMiddleWare implements Middleware {\n+export class InvalidSessionMiddleWare implements MiddlewareClass {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg5MTYzOQ=="}, "originalCommit": {"oid": "3292139571f88518a4f7d71e4f31ae87c31b99c3"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkwMTc4NA==", "bodyText": "Missing same rename in tests where it's used.", "url": "https://github.com/vaadin/flow/pull/8806#discussion_r466901784", "createdAt": "2020-08-07T08:34:30Z", "author": {"login": "Haprog"}, "path": "flow-client/src/main/resources/META-INF/resources/frontend/Connect.ts", "diffHunk": "@@ -480,10 +497,10 @@ export type OnInvalidSessionCallback = (continueFunc: EndpointCallContinue) => v\n  * E.g., you can use this to show user a login page when the session has expired.\n  * Use <code>InvalidSessionMiddleWare.create()</code> to create the middleware.\n  */\n-export class InvalidSessionMiddleWare implements Middleware {\n+export class InvalidSessionMiddleWare implements MiddlewareClass {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg5MTYzOQ=="}, "originalCommit": {"oid": "3292139571f88518a4f7d71e4f31ae87c31b99c3"}, "originalPosition": 76}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3163, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}