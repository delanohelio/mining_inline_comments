{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2NzY3OTI2", "number": 8708, "title": "Fix recursive ObjectModel initialisation", "bodyText": "Fixes #8644", "createdAt": "2020-07-09T10:24:42Z", "url": "https://github.com/vaadin/flow/pull/8708", "merged": true, "mergeCommit": {"oid": "8cd390bf01a8a13514b08d468ba202c64df0d213"}, "closed": true, "closedAt": "2020-07-17T17:52:31Z", "author": {"login": "platosha"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczMZcGAH2gAyNDQ2NzY3OTI2OjBjY2QxYWMzNzY0NGY5MjBjZjY2NzQzNmM4ZmE0Njg2YTk3ZjMzNjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc10XCtAH2gAyNDQ2NzY3OTI2OjMzNmQ1NjAzMzQzZmEwOWVlY2U3NzFjNWJiOTI0ODMzOGY5YWZiZWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0ccd1ac37644f920cf667436c8fa4686a97f3368", "author": {"user": {"login": "platosha", "name": "Anton Platonov"}}, "url": "https://github.com/vaadin/flow/commit/0ccd1ac37644f920cf667436c8fa4686a97f3368", "committedDate": "2020-07-09T10:22:52Z", "message": "Enable lazy initialisation of ObjectModel keys"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NjA4MTgx", "url": "https://github.com/vaadin/flow/pull/8708#pullrequestreview-445608181", "createdAt": "2020-07-09T13:21:23Z", "commit": {"oid": "0ccd1ac37644f920cf667436c8fa4686a97f3368"}, "state": "DISMISSED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMzoyMToyM1rOGvQ17g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNDo0NDowMlrOGvUboA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjIxMjIwNg==", "bodyText": "Are these symbols a part of the public API? What's the main reason to add the symbol postfix? It looks unnecessary, at least in the auto-completion list.\n\nI would like to see shorter API names where possible, e.g. this.binder.model[keys] instead of this.binder.model[keysSymbol]. What would be the downside of renaming all xyzSymbol into xyz?", "url": "https://github.com/vaadin/flow/pull/8708#discussion_r452212206", "createdAt": "2020-07-09T13:21:23Z", "author": {"login": "vlukashov"}, "path": "flow-client/src/main/resources/META-INF/resources/frontend/form/Models.ts", "diffHunk": "@@ -7,6 +7,7 @@ export const ItemModelSymbol = Symbol('ItemModel');\n export const parentSymbol = Symbol('parent');\n \n export const keySymbol = Symbol('key');\n+export const keysSymbol = Symbol('keys');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ccd1ac37644f920cf667436c8fa4686a97f3368"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI1MzIwOA==", "bodyText": "In what situation would this be useful as a public API? Can we make it private?", "url": "https://github.com/vaadin/flow/pull/8708#discussion_r452253208", "createdAt": "2020-07-09T14:19:26Z", "author": {"login": "vlukashov"}, "path": "flow-client/src/main/resources/META-INF/resources/frontend/form/Models.ts", "diffHunk": "@@ -80,14 +81,35 @@ export class StringModel extends PrimitiveModel<string> implements HasFromString\n \n export class ObjectModel<T> extends AbstractModel<T> {\n   static createEmptyValue() {\n-    const modelInstance = new this({value: undefined as any}, 'value')\n-    return Object.keys(modelInstance).reduce(\n-      (obj: any, key: keyof any) => {\n-        (obj = (obj || {}))[key] = (\n-          (modelInstance as any)[key].constructor as ModelConstructor<any, AbstractModel<any>>\n-        ).createEmptyValue();\n-        return obj;\n-      }, null);\n+    const modelInstance = new this({value: undefined as any}, 'value');\n+    let obj = {};\n+    for (let proto = Object.getPrototypeOf(modelInstance); proto !== ObjectModel.prototype; proto = Object.getPrototypeOf(proto)) {\n+      obj = Object.getOwnPropertyNames(proto)\n+        .filter(propertyName => propertyName !== 'constructor')\n+        .reduce((o, propertyName) => {\n+          (o as any)[propertyName] = (\n+            (modelInstance as any)[propertyName]\n+              .constructor as ModelConstructor<any, AbstractModel<any>>\n+          ).createEmptyValue();\n+          return o;\n+        }, obj)\n+    }\n+    return obj;\n+  }\n+\n+  [keysSymbol]: {[key in keyof T]?: AbstractModel<T[key]>} = {};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ccd1ac37644f920cf667436c8fa4686a97f3368"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI1NjM4Mw==", "bodyText": "This would benefit from a comment explaining what this loop does and why.", "url": "https://github.com/vaadin/flow/pull/8708#discussion_r452256383", "createdAt": "2020-07-09T14:23:53Z", "author": {"login": "vlukashov"}, "path": "flow-client/src/main/resources/META-INF/resources/frontend/form/Models.ts", "diffHunk": "@@ -80,14 +81,35 @@ export class StringModel extends PrimitiveModel<string> implements HasFromString\n \n export class ObjectModel<T> extends AbstractModel<T> {\n   static createEmptyValue() {\n-    const modelInstance = new this({value: undefined as any}, 'value')\n-    return Object.keys(modelInstance).reduce(\n-      (obj: any, key: keyof any) => {\n-        (obj = (obj || {}))[key] = (\n-          (modelInstance as any)[key].constructor as ModelConstructor<any, AbstractModel<any>>\n-        ).createEmptyValue();\n-        return obj;\n-      }, null);\n+    const modelInstance = new this({value: undefined as any}, 'value');\n+    let obj = {};\n+    for (let proto = Object.getPrototypeOf(modelInstance); proto !== ObjectModel.prototype; proto = Object.getPrototypeOf(proto)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ccd1ac37644f920cf667436c8fa4686a97f3368"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI1OTkwNQ==", "bodyText": "The symbol name keys is very similar to key, which makes it easy to assume they are of the same type / closely related, and which seems like a wrong assumption.\nDo I understand it right that key is the own name of the modeled field, i.e. a string like 'customer', whereas keys is an object with initialized models for subfields, like { firstname: StringModel }?\nIf so, can one of them or both be renamed to avoid the possible confusion? Maybe name and properties / fields / keys?", "url": "https://github.com/vaadin/flow/pull/8708#discussion_r452259905", "createdAt": "2020-07-09T14:28:52Z", "author": {"login": "vlukashov"}, "path": "flow-client/src/main/resources/META-INF/resources/frontend/form/Models.ts", "diffHunk": "@@ -7,6 +7,7 @@ export const ItemModelSymbol = Symbol('ItemModel');\n export const parentSymbol = Symbol('parent');\n \n export const keySymbol = Symbol('key');\n+export const keysSymbol = Symbol('keys');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ccd1ac37644f920cf667436c8fa4686a97f3368"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI2Njc0MA==", "bodyText": "How can we ensure no name collision could happen if a Java bean has a property called getKey? Should this be a symbol-named method?", "url": "https://github.com/vaadin/flow/pull/8708#discussion_r452266740", "createdAt": "2020-07-09T14:38:18Z", "author": {"login": "vlukashov"}, "path": "flow-client/src/main/resources/META-INF/resources/frontend/form/Models.ts", "diffHunk": "@@ -80,14 +81,35 @@ export class StringModel extends PrimitiveModel<string> implements HasFromString\n \n export class ObjectModel<T> extends AbstractModel<T> {\n   static createEmptyValue() {\n-    const modelInstance = new this({value: undefined as any}, 'value')\n-    return Object.keys(modelInstance).reduce(\n-      (obj: any, key: keyof any) => {\n-        (obj = (obj || {}))[key] = (\n-          (modelInstance as any)[key].constructor as ModelConstructor<any, AbstractModel<any>>\n-        ).createEmptyValue();\n-        return obj;\n-      }, null);\n+    const modelInstance = new this({value: undefined as any}, 'value');\n+    let obj = {};\n+    for (let proto = Object.getPrototypeOf(modelInstance); proto !== ObjectModel.prototype; proto = Object.getPrototypeOf(proto)) {\n+      obj = Object.getOwnPropertyNames(proto)\n+        .filter(propertyName => propertyName !== 'constructor')\n+        .reduce((o, propertyName) => {\n+          (o as any)[propertyName] = (\n+            (modelInstance as any)[propertyName]\n+              .constructor as ModelConstructor<any, AbstractModel<any>>\n+          ).createEmptyValue();\n+          return o;\n+        }, obj)\n+    }\n+    return obj;\n+  }\n+\n+  [keysSymbol]: {[key in keyof T]?: AbstractModel<T[key]>} = {};\n+\n+  protected getKey<", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ccd1ac37644f920cf667436c8fa4686a97f3368"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI3MTAwOA==", "bodyText": "+1\nI'm slightly in favor of using a helper method over a direct implementation in each generated property getter, like\nget idString() {\n  return this[keysSymbol]['idString'] ||\n    this[keysSymbol]['idString'] = new StringModel(this, 'idString');\n}\nArguably, a helper method like getKey() would be easier to understand and more size-efficient compared to a direct alternative.", "url": "https://github.com/vaadin/flow/pull/8708#discussion_r452271008", "createdAt": "2020-07-09T14:44:02Z", "author": {"login": "vlukashov"}, "path": "flow-client/src/test/frontend/form/TestModels.ts", "diffHunk": "@@ -17,7 +18,9 @@ export interface IdEntity {\n }\n export class IdEntityModel<T extends IdEntity = IdEntity> extends ObjectModel<T> {\n   static createEmptyValue: () => IdEntity;\n-  readonly idString = new StringModel(this, 'idString');\n+  get idString(): StringModel {\n+    return this.getKey('idString', StringModel, []);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ccd1ac37644f920cf667436c8fa4686a97f3368"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9bec9775e6e5d8550c16e1578181a22652d32e63", "author": {"user": {"login": "platosha", "name": "Anton Platonov"}}, "url": "https://github.com/vaadin/flow/commit/9bec9775e6e5d8550c16e1578181a22652d32e63", "committedDate": "2020-07-09T17:46:47Z", "message": "Introduce getKeyModelSymbol to prevent naming collisions with user fields"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d76c8539123e53ebb9fdcc0382c3a0e3c1d546cc", "author": {"user": {"login": "platosha", "name": "Anton Platonov"}}, "url": "https://github.com/vaadin/flow/commit/d76c8539123e53ebb9fdcc0382c3a0e3c1d546cc", "committedDate": "2020-07-09T17:47:53Z", "message": "Generate lazy-initialised bean models"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cab6c447f8bc3336caa23cc0d0de9e8e1a902509", "author": {"user": {"login": "platosha", "name": "Anton Platonov"}}, "url": "https://github.com/vaadin/flow/commit/cab6c447f8bc3336caa23cc0d0de9e8e1a902509", "committedDate": "2020-07-10T08:49:06Z", "message": "Apply review suggestions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfee8cc1d7e14ddf8b53cfd9a241f713290998fc", "author": {"user": {"login": "platosha", "name": "Anton Platonov"}}, "url": "https://github.com/vaadin/flow/commit/cfee8cc1d7e14ddf8b53cfd9a241f713290998fc", "committedDate": "2020-07-10T17:04:03Z", "message": "Support optional properties in form models"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb7e43d1dc8889bc24fa99b310014a95821cde8d", "author": {"user": {"login": "platosha", "name": "Anton Platonov"}}, "url": "https://github.com/vaadin/flow/commit/bb7e43d1dc8889bc24fa99b310014a95821cde8d", "committedDate": "2020-07-13T10:43:47Z", "message": "Test for optional form properties initialization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "794d8afa6157559ba2e408bb8813485208ec58f7", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/794d8afa6157559ba2e408bb8813485208ec58f7", "committedDate": "2020-07-13T11:38:28Z", "message": "Merge branch 'master' into ap/fix/forms/self-reference-recursion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "303ec9f296b4c6911ec0641e9adaa1cf91531dc6", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/303ec9f296b4c6911ec0641e9adaa1cf91531dc6", "committedDate": "2020-07-14T08:25:25Z", "message": "fix optional parsing in model generator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f874cbcd7ba8798e5e3fb0452fd40c25b889e763", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/f874cbcd7ba8798e5e3fb0452fd40c25b889e763", "committedDate": "2020-07-14T09:31:43Z", "message": "fix a failed test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NDUxNjU0", "url": "https://github.com/vaadin/flow/pull/8708#pullrequestreview-448451654", "createdAt": "2020-07-14T20:44:32Z", "commit": {"oid": "f874cbcd7ba8798e5e3fb0452fd40c25b889e763"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQyMDo0NDozMlrOGxknwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQyMDo0NDozMlrOGxknwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDYzMzQxMA==", "bodyText": "I suggest to keep consistency in naming symbols. I think it's better to pick a naming convention and follow it with all symbols used in this module. i.e. either all are called abcSymbol or all are called abc, but not a mix of those.", "url": "https://github.com/vaadin/flow/pull/8708#discussion_r454633410", "createdAt": "2020-07-14T20:44:32Z", "author": {"login": "vlukashov"}, "path": "flow-client/src/main/resources/META-INF/resources/frontend/form/Models.ts", "diffHunk": "@@ -10,21 +10,25 @@ export const keySymbol = Symbol('key');\n export const fromStringSymbol = Symbol('fromString');\n export const validatorsSymbol = Symbol('validators');\n export const binderNodeSymbol = Symbol('binderNode');\n+export const optionalSymbol = Symbol('optional');\n+\n+export const getPropertyModel = Symbol('getPropertyModel');\n+const properties = Symbol('properties');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f874cbcd7ba8798e5e3fb0452fd40c25b889e763"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "483269dd8813e7ad8e82e2fa73f87757cc6b9bad", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/483269dd8813e7ad8e82e2fa73f87757cc6b9bad", "committedDate": "2020-07-15T05:52:08Z", "message": "fix compile errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfae29d0735198fb2899be5994b37dd924257805", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/bfae29d0735198fb2899be5994b37dd924257805", "committedDate": "2020-07-15T06:18:31Z", "message": "fix compile errors in the generated code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d8d6c8ecac9cb6bb909ad772d2747f1e765b354", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/8d8d6c8ecac9cb6bb909ad772d2747f1e765b354", "committedDate": "2020-07-15T06:28:02Z", "message": "chore: make symbols naming consistent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc3295131209d2c5041fb3d055f2465a29967317", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/dc3295131209d2c5041fb3d055f2465a29967317", "committedDate": "2020-07-17T12:11:16Z", "message": "fix array item default value undefined problem"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwNjY2MTc4", "url": "https://github.com/vaadin/flow/pull/8708#pullrequestreview-450666178", "createdAt": "2020-07-17T13:40:27Z", "commit": {"oid": "dc3295131209d2c5041fb3d055f2465a29967317"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "336d5603343fa09eece771c5bb9248338f9afbea", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/336d5603343fa09eece771c5bb9248338f9afbea", "committedDate": "2020-07-17T14:04:18Z", "message": "Merge branch 'master' into ap/fix/forms/self-reference-recursion"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 292, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}