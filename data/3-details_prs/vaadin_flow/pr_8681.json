{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzNDk0ODEy", "number": 8681, "title": "Fall back to user.dir / cwd as frontend build base directory only if it is a project directory", "bodyText": "Part of #8403. Fixes #8249.", "createdAt": "2020-07-02T12:47:47Z", "url": "https://github.com/vaadin/flow/pull/8681", "merged": true, "mergeCommit": {"oid": "beba51aee1bfee6732ea62fbe0d16d48c5a5ffa8"}, "closed": true, "closedAt": "2020-07-07T14:22:47Z", "author": {"login": "joheriks"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcw-F7PAH2gAyNDQzNDk0ODEyOmU4N2NkOTYxZGJmOTJmYWJlOTVmNDBmNzM3ODg5ZWUzYzY2ODgyYzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcymAcDAFqTQ0Mzg5OTA4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e87cd961dbf92fabe95f40f737889ee3c66882c7", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/e87cd961dbf92fabe95f40f737889ee3c66882c7", "committedDate": "2020-07-02T12:35:02Z", "message": "Fall back to user.dir / cwd as frontend build base directory only if it is a project directory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f62cf0bf009959e03c0e2107c9cf22f18f91f7d", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/3f62cf0bf009959e03c0e2107c9cf22f18f91f7d", "committedDate": "2020-07-02T14:03:45Z", "message": "Apply Sonar suggestion to not use NIO for file existence for JDK8 performance issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNzg4NzEx", "url": "https://github.com/vaadin/flow/pull/8681#pullrequestreview-443788711", "createdAt": "2020-07-07T11:09:05Z", "commit": {"oid": "3f62cf0bf009959e03c0e2107c9cf22f18f91f7d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMTowOTowNVrOGt5waA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMToxNDozMlrOGt56lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc4NTM4NA==", "bodyText": "Could we simplify this by placing getBaseDirectoryFallback() directly as a second parameter of method instead of null?", "url": "https://github.com/vaadin/flow/pull/8681#discussion_r450785384", "createdAt": "2020-07-07T11:09:05Z", "author": {"login": "mshabarov"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/startup/DevModeInitializer.java", "diffHunk": "@@ -267,8 +267,10 @@ public static void initDevModeHandler(Set<Class<?>> classes,\n             return;\n         }\n \n-        String baseDir = config.getStringProperty(FrontendUtils.PROJECT_BASEDIR,\n-                System.getProperty(\"user.dir\", \".\"));\n+        String baseDir = config.getStringProperty(FrontendUtils.PROJECT_BASEDIR, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f62cf0bf009959e03c0e2107c9cf22f18f91f7d"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc4NzAzMg==", "bodyText": "I propose to explicitly add the mention of flow-build-info.json: \"... prepare-frontend Maven goal which generates 'flow-build-info.json' file prior to deploying ...\"", "url": "https://github.com/vaadin/flow/pull/8681#discussion_r450787032", "createdAt": "2020-07-07T11:12:25Z", "author": {"login": "mshabarov"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/startup/DevModeInitializer.java", "diffHunk": "@@ -423,6 +425,29 @@ public void contextDestroyed(ServletContextEvent ctx) {\n         }\n     }\n \n+    /*\n+     * Accept user.dir or cwd as a fallback only if the directory seems to be a\n+     * Maven or Gradle project. Check to avoid cluttering server directories\n+     * (see tickets #8249, #8403).\n+     */\n+    private static String getBaseDirectoryFallback() {\n+        String baseDirCandidate = System.getProperty(\"user.dir\", \".\");\n+        Path path = Paths.get(baseDirCandidate);\n+        if (path.toFile().isDirectory()\n+                && (path.resolve(\"pom.xml\").toFile().exists()\n+                        || path.resolve(\"build.gradle\").toFile().exists())) {\n+            return path.toString();\n+        } else {\n+            throw new IllegalStateException(String.format(\n+                    \"Failed to determine project directory for dev mode. \"\n+                            + \"Directory '%s' does not look like a Maven or \"\n+                            + \"Gradle project. Ensure that you have run the \"\n+                            + \"prepare-frontend Maven goal prior to deploying \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f62cf0bf009959e03c0e2107c9cf22f18f91f7d"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc4Nzk5MQ==", "bodyText": "Let's add the gradle case as well", "url": "https://github.com/vaadin/flow/pull/8681#discussion_r450787991", "createdAt": "2020-07-07T11:14:32Z", "author": {"login": "mshabarov"}, "path": "flow-server/src/test/java/com/vaadin/flow/server/startup/DevModeInitializerTest.java", "diffHunk": "@@ -396,6 +397,47 @@ public void onStartup_devModeAlreadyStarted_shouldBeTrueWhenStarted() throws Exc\n         assertTrue(DevModeInitializer.isDevModeAlreadyStarted(servletContext));\n     }\n \n+    @Test(expected = IllegalStateException.class)\n+    public void onStartup_fallbackBaseDirIsNotProjectDirectory_throws()\n+            throws Exception {\n+        initParams.remove(FrontendUtils.PROJECT_BASEDIR);\n+        TemporaryFolder tmp = new TemporaryFolder();\n+        tmp.create();\n+        baseDir = tmp.getRoot().getPath();\n+\n+        String originalUserDirValue = null;\n+        try {\n+            originalUserDirValue = System.getProperty(\"user.dir\");\n+            System.setProperty(\"user.dir\", baseDir);\n+            devModeInitializer.onStartup(classes, servletContext);\n+        } finally {\n+            if (originalUserDirValue != null) {\n+                System.setProperty(\"user.dir\", originalUserDirValue);\n+            }\n+        }\n+    }\n+\n+    @Test\n+    public void onStartup_fallbackBaseDirIsMavenProjectDirectory_isAccepted()\n+            throws Exception {\n+        initParams.remove(FrontendUtils.PROJECT_BASEDIR);\n+        TemporaryFolder tmp = new TemporaryFolder();\n+        tmp.create();\n+        tmp.newFile(\"pom.xml\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f62cf0bf009959e03c0e2107c9cf22f18f91f7d"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1e2147796836158636200e5c84175d4d43fa151", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/c1e2147796836158636200e5c84175d4d43fa151", "committedDate": "2020-07-07T13:30:30Z", "message": "Improved exception message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "164c07db27723fe3e528ba9bc79d00222b56bdc7", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/164c07db27723fe3e528ba9bc79d00222b56bdc7", "committedDate": "2020-07-07T13:30:47Z", "message": "Unit test for build.gradle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzODk5MDg4", "url": "https://github.com/vaadin/flow/pull/8681#pullrequestreview-443899088", "createdAt": "2020-07-07T13:39:10Z", "commit": {"oid": "164c07db27723fe3e528ba9bc79d00222b56bdc7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 271, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}