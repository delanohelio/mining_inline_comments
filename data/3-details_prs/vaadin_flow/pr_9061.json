{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyMjY0MTM0", "number": 9061, "title": "Restructure dev mode handler logic to avoid starting webpack twice", "bodyText": "Fixes #8981", "createdAt": "2020-09-24T08:05:06Z", "url": "https://github.com/vaadin/flow/pull/9061", "merged": true, "mergeCommit": {"oid": "9c7191619258cf2317eccdf603931ca74d662ec6"}, "closed": true, "closedAt": "2020-09-25T10:10:03Z", "author": {"login": "denis-anisimov"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdL8kP9AH2gAyNDkyMjY0MTM0OmFhMzRiYTMzOThiNDA4NjA2NTY4ODFhODU3MjNkOWI2NjQyYmE4Y2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMSYqEgFqTQ5NjI1OTU3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "aa34ba3398b40860656881a85723d9b6642ba8cb", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/aa34ba3398b40860656881a85723d9b6642ba8cb", "committedDate": "2020-09-24T08:04:18Z", "message": "Restructure dev mode handler logic to avoid starting webpack twice\n\nFixes #8981"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MzYxNTQ1", "url": "https://github.com/vaadin/flow/pull/9061#pullrequestreview-495361545", "createdAt": "2020-09-24T08:58:38Z", "commit": {"oid": "aa34ba3398b40860656881a85723d9b6642ba8cb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwODo1ODozOFrOHXQrog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwODo1ODozOFrOHXQrog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE1MjYxMA==", "bodyText": "Remove this use of \"Thread.sleep()\".", "url": "https://github.com/vaadin/flow/pull/9061#discussion_r494152610", "createdAt": "2020-09-24T08:58:38Z", "author": {"login": "vaadin-bot"}, "path": "flow-server/src/test/java/com/vaadin/flow/server/DevModeHandlerTest.java", "diffHunk": "@@ -477,6 +481,80 @@ public void serveDevModeRequest_prepareTasksThrows_serveDevModeReturnsFalseAndDo\n         Assert.assertFalse(handler.serveDevModeRequest(request, response));\n     }\n \n+    @Test\n+    public void start_twoTimes_onlyOneHandlerInstanceIsCreated() {\n+        MockDeploymentConfiguration configuration = Mockito\n+                .spy(MockDeploymentConfiguration.class);\n+        DevModeHandler handler = DevModeHandler.start(0, configuration,\n+                npmFolder, CompletableFuture.completedFuture(null));\n+        handler.join();\n+\n+        // This is how new server handler instantiation checked:\n+        Mockito.verify(configuration).reuseDevServer();\n+\n+        // \"start\" one more time: there should not be another instance of dev\n+        // mode handler created\n+        DevModeHandler anotherHandler = DevModeHandler.start(0, configuration,\n+                npmFolder, CompletableFuture.completedFuture(null));\n+        anotherHandler.join();\n+\n+        // The handler instances are the same but there should be no attempt to\n+        // create another instance (which won't be stored anywhere), see below\n+        Assert.assertSame(handler, anotherHandler);\n+\n+        // No more \"reuseDevServer\" calls are done: see above, it has been\n+        // already called one time\n+        Mockito.verify(configuration).reuseDevServer();\n+    }\n+\n+    @Test\n+    public void start_twoInstances_secondInstanceUsesAnotherPort()\n+            throws Exception {\n+\n+        // start the first instance\n+        DevModeHandler handler = DevModeHandler.start(0, configuration,\n+                npmFolder, CompletableFuture.completedFuture(null));\n+\n+        // remove the \"singleton\" instance to be able to start another one\n+        removeDevModeHandlerInstance();\n+\n+        // since the timeout is quite big the server port still should be\n+        // available and the second instance should try to reuse it\n+\n+        DevModeHandler.start(0, configuration, npmFolder,\n+                CompletableFuture.completedFuture(null));\n+\n+        // make checks only if webpack has not yet completed\n+\n+        DevModeHandler anotherHandler = DevModeHandler.start(0, configuration,\n+                npmFolder, CompletableFuture.completedFuture(null));\n+\n+        while (handler.getPort() == 0) {\n+            Thread.sleep(100);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa34ba3398b40860656881a85723d9b6642ba8cb"}, "originalPosition": 137}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MzYxNTYw", "url": "https://github.com/vaadin/flow/pull/9061#pullrequestreview-495361560", "createdAt": "2020-09-24T08:58:39Z", "commit": {"oid": "aa34ba3398b40860656881a85723d9b6642ba8cb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwODo1ODozOVrOHXQrrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwODo1ODozOVrOHXQrrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE1MjYyMw==", "bodyText": "Remove this unused private \"checkPort\" method.", "url": "https://github.com/vaadin/flow/pull/9061#discussion_r494152623", "createdAt": "2020-09-24T08:58:39Z", "author": {"login": "vaadin-bot"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java", "diffHunk": "@@ -523,22 +522,45 @@ private void saveRunningDevServerPort() {\n         }\n     }\n \n-    private void doStartDevModeServer(DeploymentConfiguration config,\n-            File npmFolder) throws ExecutionFailedException {\n+    private boolean checkPort() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa34ba3398b40860656881a85723d9b6642ba8cb"}, "originalPosition": 119}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2MTkzNjkx", "url": "https://github.com/vaadin/flow/pull/9061#pullrequestreview-496193691", "createdAt": "2020-09-25T07:59:24Z", "commit": {"oid": "aa34ba3398b40860656881a85723d9b6642ba8cb"}, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQwNzo1OToyNFrOHX5H0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQwOTowMTozMlrOHX7OvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgxNTE4Ng==", "bodyText": "Minor: Perhaps rename to doStartWebpack for consistency.", "url": "https://github.com/vaadin/flow/pull/9061#discussion_r494815186", "createdAt": "2020-09-25T07:59:24Z", "author": {"login": "joheriks"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java", "diffHunk": "@@ -550,7 +572,21 @@ private void doStartDevModeServer(DeploymentConfiguration config,\n \n         // Look for a free port\n         port = getFreePort();\n+        // save the port immediately before start a webpack server, see #8981\n+        saveRunningDevServerPort();\n+        boolean success = false;\n+\n+        try {\n+            success = doStartWebPack(config, webPackFiles, start);\n+        } finally {\n+            if (!success) {\n+                removeRunningDevServerPort();\n+            }\n+        }\n+    }\n \n+    private boolean doStartWebPack(DeploymentConfiguration config,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa34ba3398b40860656881a85723d9b6642ba8cb"}, "originalPosition": 187}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDg0OTcyNA==", "bodyText": "Minor: Because of the added null check (I assume to avoid calling createInstance in not null case as there is no lazy compareAndSet available), could the inner code be simplified to atomicHandler.set(...)", "url": "https://github.com/vaadin/flow/pull/9061#discussion_r494849724", "createdAt": "2020-09-25T09:01:32Z", "author": {"login": "joheriks"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java", "diffHunk": "@@ -188,8 +191,10 @@ public static DevModeHandler start(int runningPort,\n                 || !configuration.enableDevServer()) {\n             return null;\n         }\n-        atomicHandler.compareAndSet(null,\n-                createInstance(runningPort, configuration, npmFolder, waitFor));\n+        if (atomicHandler.get() == null) {\n+            atomicHandler.compareAndSet(null, createInstance(runningPort,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa34ba3398b40860656881a85723d9b6642ba8cb"}, "originalPosition": 82}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0a5d8475b3697054c57e24b2c74806da15aa5ac", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/c0a5d8475b3697054c57e24b2c74806da15aa5ac", "committedDate": "2020-09-25T09:15:06Z", "message": "Rename method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2MjU5NTcy", "url": "https://github.com/vaadin/flow/pull/9061#pullrequestreview-496259572", "createdAt": "2020-09-25T09:29:33Z", "commit": {"oid": "c0a5d8475b3697054c57e24b2c74806da15aa5ac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4947, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}