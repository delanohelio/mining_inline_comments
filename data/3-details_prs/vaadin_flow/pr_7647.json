{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4MzA4MDM3", "number": 7647, "title": "Don't block DevModeInitializer but spawn a thread where all long running tasks are executed", "bodyText": "Fixes #6369\n\n\nThis change is\u2002", "createdAt": "2020-02-21T14:24:19Z", "url": "https://github.com/vaadin/flow/pull/7647", "merged": true, "mergeCommit": {"oid": "01d52df05c7cd55eca1bf18c8ab7de2f1297d6c8"}, "closed": true, "closedAt": "2020-02-24T13:54:23Z", "author": {"login": "denis-anisimov"}, "timelineItems": {"totalCount": 40, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGgrvbAFqTM2MjY3MDM1Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHd33QgFqTM2MzQwMTQ5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyNjcwMzU3", "url": "https://github.com/vaadin/flow/pull/7647#pullrequestreview-362670357", "createdAt": "2020-02-21T14:34:22Z", "commit": {"oid": "39edc3cb9c00e383b7cf5ba2e69e68016f28e3ba"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxNDozNDoyMlrOFs42rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxNDozNDoyMlrOFs42rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjYxMzE2Nw==", "bodyText": "Make \"devServerStartFuture\" transient or serializable.", "url": "https://github.com/vaadin/flow/pull/7647#discussion_r382613167", "createdAt": "2020-02-21T14:34:22Z", "author": {"login": "vaadin-bot"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java", "diffHunk": "@@ -99,129 +102,34 @@\n \n     private boolean notified = false;\n \n-    private String failedOutput;\n+    private volatile String failedOutput;\n \n     /**\n      * The local installation path of the webpack-dev-server node script.\n      */\n     public static final String WEBPACK_SERVER = \"node_modules/webpack-dev-server/bin/webpack-dev-server.js\";\n \n-    private int port;\n-    private Process webpackProcess;\n+    private volatile int port;\n+    private final AtomicReference<Process> webpackProcess = new AtomicReference<>();\n     private final boolean reuseDevServer;\n-    private DevServerWatchDog watchDog;\n+    private final AtomicReference<DevServerWatchDog> watchDog = new AtomicReference<>();\n \n     private StringBuilder cumulativeOutput = new StringBuilder();\n \n+    private final CompletableFuture<Void> devServerStartFuture;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39edc3cb9c00e383b7cf5ba2e69e68016f28e3ba"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyNjcwMzc3", "url": "https://github.com/vaadin/flow/pull/7647#pullrequestreview-362670377", "createdAt": "2020-02-21T14:34:23Z", "commit": {"oid": "39edc3cb9c00e383b7cf5ba2e69e68016f28e3ba"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxNDozNDoyM1rOFs42vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxNDozNDoyM1rOFs42vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjYxMzE4Mg==", "bodyText": "Null passed for non-null parameter of java.util.concurrent.CompletableFuture.getNow(Object) in com.vaadin.flow.server.DevModeHandler.handleRequest(VaadinSession, VaadinRequest, VaadinResponse)", "url": "https://github.com/vaadin/flow/pull/7647#discussion_r382613182", "createdAt": "2020-02-21T14:34:23Z", "author": {"login": "vaadin-bot"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java", "diffHunk": "@@ -271,45 +183,44 @@ public static DevModeHandler getDevModeHandler() {\n         return atomicHandler.get();\n     }\n \n+    @Override\n+    public boolean handleRequest(VaadinSession session, VaadinRequest request,\n+            VaadinResponse response) throws IOException {\n+        if (devServerStartFuture.isDone()) {\n+            try {\n+                devServerStartFuture.getNow(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39edc3cb9c00e383b7cf5ba2e69e68016f28e3ba"}, "originalPosition": 223}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ea20aa0db1309a0876dcdb662307d1191ec5dba", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/2ea20aa0db1309a0876dcdb662307d1191ec5dba", "committedDate": "2020-02-21T15:14:42Z", "message": "Run (p)npm install and webpack dev server in a separate thread without\nblocking servlet container initializer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3db3aa04876bbce9ae9f5b2e02e31c2f61eaf6e3", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/3db3aa04876bbce9ae9f5b2e02e31c2f61eaf6e3", "committedDate": "2020-02-21T15:14:42Z", "message": "Read a file from the classpath instead of hardcoding the content."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe3e9e36561d13d1225c3a52a2053b5a9d682f8c", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/fe3e9e36561d13d1225c3a52a2053b5a9d682f8c", "committedDate": "2020-02-21T15:14:42Z", "message": "Update unit tests and rewrite exception throwing."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fab88d5ecb2fc2986fc2530e76a0b72f531e45a", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/4fab88d5ecb2fc2986fc2530e76a0b72f531e45a", "committedDate": "2020-02-21T15:15:25Z", "message": "Fixes after rebase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e02d39bad92054b222625c8e0a7f87ba362b2e36", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/e02d39bad92054b222625c8e0a7f87ba362b2e36", "committedDate": "2020-02-21T15:15:25Z", "message": "Add lost file after rebase back.\nThank you git so much..."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5391d1ef8a067783038e7303bbb3d8c83dd47c0", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/b5391d1ef8a067783038e7303bbb3d8c83dd47c0", "committedDate": "2020-02-21T15:15:25Z", "message": "Revert unneeded bootstrap handler changes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f640ccfd13f67bcb31d7f9f9e67819d9dfae17b1", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/f640ccfd13f67bcb31d7f9f9e67819d9dfae17b1", "committedDate": "2020-02-21T15:15:25Z", "message": "Remove TODO"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6a4103b9c63bf23d1acae833645a2fbaabe8ae0", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/b6a4103b9c63bf23d1acae833645a2fbaabe8ae0", "committedDate": "2020-02-21T15:15:25Z", "message": "Revert code which was reverted by git rebase.\nThank you git one one more time."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4287fe8d219a80802318ac26399acc761b2cef75", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/4287fe8d219a80802318ac26399acc761b2cef75", "committedDate": "2020-02-21T15:15:25Z", "message": "Fix tests and update the code."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22c79c9fa0ca422fb4c37a8d7c36040d56e6e37d", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/22c79c9fa0ca422fb4c37a8d7c36040d56e6e37d", "committedDate": "2020-02-21T15:15:25Z", "message": "Fix pnpm unit test in case of globally installed pnpm."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a87a8d3c3464969f19e329c2027445d683e0ec50", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/a87a8d3c3464969f19e329c2027445d683e0ec50", "committedDate": "2020-02-21T15:15:25Z", "message": "Correct unit tests to expect exception instead of null handler."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f823f001a829e2e3f670e52fc8e518ace6dd7f2", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/5f823f001a829e2e3f670e52fc8e518ace6dd7f2", "committedDate": "2020-02-21T15:15:25Z", "message": "Update ITs to wait until dev server is started"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b97ea779d71edad3f94790d8c3bbfefbaad3d69", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/4b97ea779d71edad3f94790d8c3bbfefbaad3d69", "committedDate": "2020-02-21T15:15:25Z", "message": "Correct waitForDevServer and add javadocs for dev mode handler CTOR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22ab685d1400321e7f3723ac29ecb330dd0da436", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/22ab685d1400321e7f3723ac29ecb330dd0da436", "committedDate": "2020-02-21T15:15:25Z", "message": "Disable flow-client tests which are broken."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d3c67caa0d9f2997268f3922f08fb9bd93af827", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/2d3c67caa0d9f2997268f3922f08fb9bd93af827", "committedDate": "2020-02-21T15:15:25Z", "message": "Use the correct waitForDevServer method impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfed29a1e7a5a53c53a168ee4e1aa9bb0c68eb43", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/dfed29a1e7a5a53c53a168ee4e1aa9bb0c68eb43", "committedDate": "2020-02-21T15:15:25Z", "message": "Use find() instead of match()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "528e2940868b156bacaf57ba41440107e592cebd", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/528e2940868b156bacaf57ba41440107e592cebd", "committedDate": "2020-02-21T15:15:25Z", "message": "Correct log message in the dev mode handler and startup performance test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efcda61d2072cb6283e5fb76439c1c280add3ea7", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/efcda61d2072cb6283e5fb76439c1c280add3ea7", "committedDate": "2020-02-21T15:15:25Z", "message": "More corrections."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7b02d244c007f8e4fbf81f1f855c0d408f756aa", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/b7b02d244c007f8e4fbf81f1f855c0d408f756aa", "committedDate": "2020-02-21T15:19:19Z", "message": "1000th attempt to merge with master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb5a404674b267ffbdf4e6c14a9e6a4e4da07a62", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/bb5a404674b267ffbdf4e6c14a9e6a4e4da07a62", "committedDate": "2020-02-21T15:22:23Z", "message": "Try to enable flow-client tests back."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "39edc3cb9c00e383b7cf5ba2e69e68016f28e3ba", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/39edc3cb9c00e383b7cf5ba2e69e68016f28e3ba", "committedDate": "2020-02-21T13:24:30Z", "message": "More corrections."}, "afterCommit": {"oid": "bb5a404674b267ffbdf4e6c14a9e6a4e4da07a62", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/bb5a404674b267ffbdf4e6c14a9e6a4e4da07a62", "committedDate": "2020-02-21T15:22:23Z", "message": "Try to enable flow-client tests back."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d57961470bd32de9be112a7c588192fa3258b251", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/d57961470bd32de9be112a7c588192fa3258b251", "committedDate": "2020-02-22T14:35:27Z", "message": "Fix SQ complains."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f17c3fc5335f92e380520828171d87171b886389", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/f17c3fc5335f92e380520828171d87171b886389", "committedDate": "2020-02-22T16:06:55Z", "message": "Don't throw an exception on getCause but just return it"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "749e81206e42b62ae6b3d0341a5245af8aeed410", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/749e81206e42b62ae6b3d0341a5245af8aeed410", "committedDate": "2020-02-24T06:36:24Z", "message": "Check that an exception in the prepare tasks ((p)npm install) is\nrethrown on request handling."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6dc94b5dd3003d45f659c0be017e68445addf456", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/6dc94b5dd3003d45f659c0be017e68445addf456", "committedDate": "2020-02-24T07:29:11Z", "message": "Remove extra javadocs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMjQwOTI1", "url": "https://github.com/vaadin/flow/pull/7647#pullrequestreview-363240925", "createdAt": "2020-02-24T09:08:46Z", "commit": {"oid": "6dc94b5dd3003d45f659c0be017e68445addf456"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMjUyMzYz", "url": "https://github.com/vaadin/flow/pull/7647#pullrequestreview-363252363", "createdAt": "2020-02-24T09:29:19Z", "commit": {"oid": "6dc94b5dd3003d45f659c0be017e68445addf456"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "048f624c75339739f311cf943b3715efbf20d66d", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/048f624c75339739f311cf943b3715efbf20d66d", "committedDate": "2020-02-24T09:29:51Z", "message": "Fixes based on review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMjgwNDU0", "url": "https://github.com/vaadin/flow/pull/7647#pullrequestreview-363280454", "createdAt": "2020-02-24T10:14:28Z", "commit": {"oid": "048f624c75339739f311cf943b3715efbf20d66d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMjg1MjY2", "url": "https://github.com/vaadin/flow/pull/7647#pullrequestreview-363285266", "createdAt": "2020-02-24T10:22:11Z", "commit": {"oid": "048f624c75339739f311cf943b3715efbf20d66d"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4de3f16399162993ddc8f2ee3abd98b4eb77094", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/c4de3f16399162993ddc8f2ee3abd98b4eb77094", "committedDate": "2020-02-24T10:27:08Z", "message": "Schedule page reload without onload"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMjg4ODEx", "url": "https://github.com/vaadin/flow/pull/7647#pullrequestreview-363288811", "createdAt": "2020-02-24T10:27:40Z", "commit": {"oid": "048f624c75339739f311cf943b3715efbf20d66d"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMzA4NzU2", "url": "https://github.com/vaadin/flow/pull/7647#pullrequestreview-363308756", "createdAt": "2020-02-24T11:00:40Z", "commit": {"oid": "c4de3f16399162993ddc8f2ee3abd98b4eb77094"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMzE0Mzc4", "url": "https://github.com/vaadin/flow/pull/7647#pullrequestreview-363314378", "createdAt": "2020-02-24T11:11:11Z", "commit": {"oid": "cfca85e8c26a8486181641cd917875e5af3cc1e1"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMzE3OTQ4", "url": "https://github.com/vaadin/flow/pull/7647#pullrequestreview-363317948", "createdAt": "2020-02-24T11:17:56Z", "commit": {"oid": "cfca85e8c26a8486181641cd917875e5af3cc1e1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMToxNzo1NlrOFtdMsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMToxNzo1NlrOFtdMsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIwODYyNg==", "bodyText": "Possible null pointer dereference in com.vaadin.flow.server.frontend.TaskRunNpmInstall.cleanUp() due to return value of called method", "url": "https://github.com/vaadin/flow/pull/7647#discussion_r383208626", "createdAt": "2020-02-24T11:17:56Z", "author": {"login": "vaadin-bot"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/TaskRunNpmInstall.java", "diffHunk": "@@ -269,8 +269,16 @@ private void cleanUp() throws IOException {\n         File modulesYaml = new File(packageUpdater.nodeModulesFolder,\n                 MODULES_YAML);\n         boolean hasModulesYaml = modulesYaml.exists() && modulesYaml.isFile();\n-        if (hasModulesYaml != enablePnpm) {\n+        if (!enablePnpm && hasModulesYaml) {\n             FileUtils.forceDelete(packageUpdater.nodeModulesFolder);\n+        } else if (enablePnpm && !hasModulesYaml) {\n+            // presence of .staging dir with a \"pnpm-*\" folder means that pnpm\n+            // download is in progress, don't remove anything in this case\n+            File staging = new File(\".staging\");\n+            if (!staging.isDirectory() || staging.listFiles(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfca85e8c26a8486181641cd917875e5af3cc1e1"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fbaeccb8fbb7daef7c6277203425241a4354601", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/7fbaeccb8fbb7daef7c6277203425241a4354601", "committedDate": "2020-02-24T11:45:24Z", "message": "Don't remove node_modules if pnpm is enabled and it's downloading\nresources."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cfca85e8c26a8486181641cd917875e5af3cc1e1", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/cfca85e8c26a8486181641cd917875e5af3cc1e1", "committedDate": "2020-02-24T11:08:12Z", "message": "Don't remove node_modules if pnpm is enabled and it's downloading\nresources."}, "afterCommit": {"oid": "7fbaeccb8fbb7daef7c6277203425241a4354601", "author": {"user": null}, "url": "https://github.com/vaadin/flow/commit/7fbaeccb8fbb7daef7c6277203425241a4354601", "committedDate": "2020-02-24T11:45:24Z", "message": "Don't remove node_modules if pnpm is enabled and it's downloading\nresources."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNDAxNDk5", "url": "https://github.com/vaadin/flow/pull/7647#pullrequestreview-363401499", "createdAt": "2020-02-24T13:51:49Z", "commit": {"oid": "7fbaeccb8fbb7daef7c6277203425241a4354601"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 712, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}