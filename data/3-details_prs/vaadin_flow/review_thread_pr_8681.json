{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzNDk0ODEy", "number": 8681, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMTowOTowNVrOEMB38Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMToxNDozMlrOEMB-TA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMDQ5MDczOnYy", "diffSide": "RIGHT", "path": "flow-server/src/main/java/com/vaadin/flow/server/startup/DevModeInitializer.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMTowOTowNVrOGt5waA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMjowMToyNFrOGt7WGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc4NTM4NA==", "bodyText": "Could we simplify this by placing getBaseDirectoryFallback() directly as a second parameter of method instead of null?", "url": "https://github.com/vaadin/flow/pull/8681#discussion_r450785384", "createdAt": "2020-07-07T11:09:05Z", "author": {"login": "mshabarov"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/startup/DevModeInitializer.java", "diffHunk": "@@ -267,8 +267,10 @@ public static void initDevModeHandler(Set<Class<?>> classes,\n             return;\n         }\n \n-        String baseDir = config.getStringProperty(FrontendUtils.PROJECT_BASEDIR,\n-                System.getProperty(\"user.dir\", \".\"));\n+        String baseDir = config.getStringProperty(FrontendUtils.PROJECT_BASEDIR, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f62cf0bf009959e03c0e2107c9cf22f18f91f7d"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgwODQ3NA==", "bodyText": "No. getBaseDirectoryFallback() should be evaluated lazily, as it throws on failure.", "url": "https://github.com/vaadin/flow/pull/8681#discussion_r450808474", "createdAt": "2020-07-07T11:55:46Z", "author": {"login": "joheriks"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/startup/DevModeInitializer.java", "diffHunk": "@@ -267,8 +267,10 @@ public static void initDevModeHandler(Set<Class<?>> classes,\n             return;\n         }\n \n-        String baseDir = config.getStringProperty(FrontendUtils.PROJECT_BASEDIR,\n-                System.getProperty(\"user.dir\", \".\"));\n+        String baseDir = config.getStringProperty(FrontendUtils.PROJECT_BASEDIR, null);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc4NTM4NA=="}, "originalCommit": {"oid": "3f62cf0bf009959e03c0e2107c9cf22f18f91f7d"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgxMTQxOA==", "bodyText": "You're right! Thanks", "url": "https://github.com/vaadin/flow/pull/8681#discussion_r450811418", "createdAt": "2020-07-07T12:01:24Z", "author": {"login": "mshabarov"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/startup/DevModeInitializer.java", "diffHunk": "@@ -267,8 +267,10 @@ public static void initDevModeHandler(Set<Class<?>> classes,\n             return;\n         }\n \n-        String baseDir = config.getStringProperty(FrontendUtils.PROJECT_BASEDIR,\n-                System.getProperty(\"user.dir\", \".\"));\n+        String baseDir = config.getStringProperty(FrontendUtils.PROJECT_BASEDIR, null);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc4NTM4NA=="}, "originalCommit": {"oid": "3f62cf0bf009959e03c0e2107c9cf22f18f91f7d"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMDUwMDk3OnYy", "diffSide": "RIGHT", "path": "flow-server/src/main/java/com/vaadin/flow/server/startup/DevModeInitializer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMToxMjoyNVrOGt522A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMzozMTowMVrOGt-pgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc4NzAzMg==", "bodyText": "I propose to explicitly add the mention of flow-build-info.json: \"... prepare-frontend Maven goal which generates 'flow-build-info.json' file prior to deploying ...\"", "url": "https://github.com/vaadin/flow/pull/8681#discussion_r450787032", "createdAt": "2020-07-07T11:12:25Z", "author": {"login": "mshabarov"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/startup/DevModeInitializer.java", "diffHunk": "@@ -423,6 +425,29 @@ public void contextDestroyed(ServletContextEvent ctx) {\n         }\n     }\n \n+    /*\n+     * Accept user.dir or cwd as a fallback only if the directory seems to be a\n+     * Maven or Gradle project. Check to avoid cluttering server directories\n+     * (see tickets #8249, #8403).\n+     */\n+    private static String getBaseDirectoryFallback() {\n+        String baseDirCandidate = System.getProperty(\"user.dir\", \".\");\n+        Path path = Paths.get(baseDirCandidate);\n+        if (path.toFile().isDirectory()\n+                && (path.resolve(\"pom.xml\").toFile().exists()\n+                        || path.resolve(\"build.gradle\").toFile().exists())) {\n+            return path.toString();\n+        } else {\n+            throw new IllegalStateException(String.format(\n+                    \"Failed to determine project directory for dev mode. \"\n+                            + \"Directory '%s' does not look like a Maven or \"\n+                            + \"Gradle project. Ensure that you have run the \"\n+                            + \"prepare-frontend Maven goal prior to deploying \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f62cf0bf009959e03c0e2107c9cf22f18f91f7d"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg2NTUzOQ==", "bodyText": "Done.", "url": "https://github.com/vaadin/flow/pull/8681#discussion_r450865539", "createdAt": "2020-07-07T13:31:01Z", "author": {"login": "joheriks"}, "path": "flow-server/src/main/java/com/vaadin/flow/server/startup/DevModeInitializer.java", "diffHunk": "@@ -423,6 +425,29 @@ public void contextDestroyed(ServletContextEvent ctx) {\n         }\n     }\n \n+    /*\n+     * Accept user.dir or cwd as a fallback only if the directory seems to be a\n+     * Maven or Gradle project. Check to avoid cluttering server directories\n+     * (see tickets #8249, #8403).\n+     */\n+    private static String getBaseDirectoryFallback() {\n+        String baseDirCandidate = System.getProperty(\"user.dir\", \".\");\n+        Path path = Paths.get(baseDirCandidate);\n+        if (path.toFile().isDirectory()\n+                && (path.resolve(\"pom.xml\").toFile().exists()\n+                        || path.resolve(\"build.gradle\").toFile().exists())) {\n+            return path.toString();\n+        } else {\n+            throw new IllegalStateException(String.format(\n+                    \"Failed to determine project directory for dev mode. \"\n+                            + \"Directory '%s' does not look like a Maven or \"\n+                            + \"Gradle project. Ensure that you have run the \"\n+                            + \"prepare-frontend Maven goal prior to deploying \"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc4NzAzMg=="}, "originalCommit": {"oid": "3f62cf0bf009959e03c0e2107c9cf22f18f91f7d"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMDUwNzAwOnYy", "diffSide": "RIGHT", "path": "flow-server/src/test/java/com/vaadin/flow/server/startup/DevModeInitializerTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMToxNDozMlrOGt56lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMzozMTowNlrOGt-pvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc4Nzk5MQ==", "bodyText": "Let's add the gradle case as well", "url": "https://github.com/vaadin/flow/pull/8681#discussion_r450787991", "createdAt": "2020-07-07T11:14:32Z", "author": {"login": "mshabarov"}, "path": "flow-server/src/test/java/com/vaadin/flow/server/startup/DevModeInitializerTest.java", "diffHunk": "@@ -396,6 +397,47 @@ public void onStartup_devModeAlreadyStarted_shouldBeTrueWhenStarted() throws Exc\n         assertTrue(DevModeInitializer.isDevModeAlreadyStarted(servletContext));\n     }\n \n+    @Test(expected = IllegalStateException.class)\n+    public void onStartup_fallbackBaseDirIsNotProjectDirectory_throws()\n+            throws Exception {\n+        initParams.remove(FrontendUtils.PROJECT_BASEDIR);\n+        TemporaryFolder tmp = new TemporaryFolder();\n+        tmp.create();\n+        baseDir = tmp.getRoot().getPath();\n+\n+        String originalUserDirValue = null;\n+        try {\n+            originalUserDirValue = System.getProperty(\"user.dir\");\n+            System.setProperty(\"user.dir\", baseDir);\n+            devModeInitializer.onStartup(classes, servletContext);\n+        } finally {\n+            if (originalUserDirValue != null) {\n+                System.setProperty(\"user.dir\", originalUserDirValue);\n+            }\n+        }\n+    }\n+\n+    @Test\n+    public void onStartup_fallbackBaseDirIsMavenProjectDirectory_isAccepted()\n+            throws Exception {\n+        initParams.remove(FrontendUtils.PROJECT_BASEDIR);\n+        TemporaryFolder tmp = new TemporaryFolder();\n+        tmp.create();\n+        tmp.newFile(\"pom.xml\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f62cf0bf009959e03c0e2107c9cf22f18f91f7d"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg2NTU5Ng==", "bodyText": "Done.", "url": "https://github.com/vaadin/flow/pull/8681#discussion_r450865596", "createdAt": "2020-07-07T13:31:06Z", "author": {"login": "joheriks"}, "path": "flow-server/src/test/java/com/vaadin/flow/server/startup/DevModeInitializerTest.java", "diffHunk": "@@ -396,6 +397,47 @@ public void onStartup_devModeAlreadyStarted_shouldBeTrueWhenStarted() throws Exc\n         assertTrue(DevModeInitializer.isDevModeAlreadyStarted(servletContext));\n     }\n \n+    @Test(expected = IllegalStateException.class)\n+    public void onStartup_fallbackBaseDirIsNotProjectDirectory_throws()\n+            throws Exception {\n+        initParams.remove(FrontendUtils.PROJECT_BASEDIR);\n+        TemporaryFolder tmp = new TemporaryFolder();\n+        tmp.create();\n+        baseDir = tmp.getRoot().getPath();\n+\n+        String originalUserDirValue = null;\n+        try {\n+            originalUserDirValue = System.getProperty(\"user.dir\");\n+            System.setProperty(\"user.dir\", baseDir);\n+            devModeInitializer.onStartup(classes, servletContext);\n+        } finally {\n+            if (originalUserDirValue != null) {\n+                System.setProperty(\"user.dir\", originalUserDirValue);\n+            }\n+        }\n+    }\n+\n+    @Test\n+    public void onStartup_fallbackBaseDirIsMavenProjectDirectory_isAccepted()\n+            throws Exception {\n+        initParams.remove(FrontendUtils.PROJECT_BASEDIR);\n+        TemporaryFolder tmp = new TemporaryFolder();\n+        tmp.create();\n+        tmp.newFile(\"pom.xml\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc4Nzk5MQ=="}, "originalCommit": {"oid": "3f62cf0bf009959e03c0e2107c9cf22f18f91f7d"}, "originalPosition": 38}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3346, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}