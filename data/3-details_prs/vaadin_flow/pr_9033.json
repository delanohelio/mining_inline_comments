{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5MjkxMTA3", "number": 9033, "title": "Force size re-estimate when requested range end equals assumed size", "bodyText": "Since the Range is exclusive at the end, it may happen that the range end is the same as the assumed size. It that case the flush() would not be invoked, although it should. Requested range strategy generally speaking depends on web component and there may be the case when the component requests, for example [5700...5800] and the assumed size is already 5800. This situation reflects the case when the user scroll to the end and then he jumps to undefined size. Then it should force the size re-estimation. And thus this code change occurred.", "createdAt": "2020-09-18T12:42:20Z", "url": "https://github.com/vaadin/flow/pull/9033", "merged": true, "mergeCommit": {"oid": "339ccc8b339701840bc0b469afbacffe4b4914e8"}, "closed": true, "closedAt": "2020-09-24T05:40:23Z", "author": {"login": "mshabarov"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdKE2CHgH2gAyNDg5MjkxMTA3OjY2N2UzMGMyNGI1YjdjZDA2YWM1MDI3ZGE2ZDc3ZjRlODNmYzM1Mzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdL6gF8gFqTQ5NTIzMzM3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "667e30c24b5b7cd06ac5027da6d77f4e83fc3538", "author": {"user": {"login": "mshabarov", "name": "Mikhail Shabarov"}}, "url": "https://github.com/vaadin/flow/commit/667e30c24b5b7cd06ac5027da6d77f4e83fc3538", "committedDate": "2020-09-18T12:35:07Z", "message": "Force size re-estimate when requested range end equals assumed size"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNDA1MTIx", "url": "https://github.com/vaadin/flow/pull/9033#pullrequestreview-492405121", "createdAt": "2020-09-21T09:09:25Z", "commit": {"oid": "667e30c24b5b7cd06ac5027da6d77f4e83fc3538"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwOTowOToyNVrOHVGvww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwOTowOToyNVrOHVGvww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg5MjY3NQ==", "bodyText": "Good catch but where is the unit test ?", "url": "https://github.com/vaadin/flow/pull/9033#discussion_r491892675", "createdAt": "2020-09-21T09:09:25Z", "author": {"login": "pleku"}, "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/DataCommunicator.java", "diffHunk": "@@ -541,7 +541,7 @@ public void setDefinedSize(boolean definedSize) {\n              * estimated size. If there was a previous defined size used, then\n              * that is kept until a reset occurs.\n              */\n-            if (requestedRange.contains(assumedSize)) {\n+            if (requestedRange.contains(assumedSize - 1)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "667e30c24b5b7cd06ac5027da6d77f4e83fc3538"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f236d1a0974014ff221a8456655bff22ac8e1a3c", "author": {"user": {"login": "mshabarov", "name": "Mikhail Shabarov"}}, "url": "https://github.com/vaadin/flow/commit/f236d1a0974014ff221a8456655bff22ac8e1a3c", "committedDate": "2020-09-22T06:02:42Z", "message": "Unit test added"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMjQ4OTk2", "url": "https://github.com/vaadin/flow/pull/9033#pullrequestreview-493248996", "createdAt": "2020-09-22T08:49:46Z", "commit": {"oid": "f236d1a0974014ff221a8456655bff22ac8e1a3c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwODo0OTo0NlrOHVwP1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwODo0OTo0OVrOHVwP8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3MjYzMA==", "bodyText": "Could have been nice to add a comment here that states that // the size will be 100 so it makes it very clear how this test works", "url": "https://github.com/vaadin/flow/pull/9033#discussion_r492572630", "createdAt": "2020-09-22T08:49:46Z", "author": {"login": "pleku"}, "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/DataCommunicatorTest.java", "diffHunk": "@@ -1072,6 +1073,30 @@ public void itemCountChangeEvent_estimatedCount_estimateUsedUntilEndReached() {\n         Assert.assertFalse(event.isItemCountEstimated());\n     }\n \n+    @Test\n+    public void setDefinedSize_rangeEndEqualsAssumedSize_flushRequested() {\n+        // trigger client communication in order to initialise it and avoid\n+        // infinite loop inside 'requestFlush()'\n+        fakeClientCommunication();\n+\n+        StateNode stateNode = Mockito.spy(element.getNode());\n+        DataCommunicator<Item> dataCommunicator = new DataCommunicator<>(\n+                dataGenerator, arrayUpdater, data -> {}, stateNode);\n+        dataCommunicator.setPageSize(pageSize);\n+        dataCommunicator.setDataProvider(createDataProvider(), null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f236d1a0974014ff221a8456655bff22ac8e1a3c"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3MjY1Ng==", "bodyText": "Like (most?) other tests here, shouldn't this very that the (estimated) count is increased properly too (which is the desired outcome in terms of internal DC logic) instead of just relying that call to flush has been done ?", "url": "https://github.com/vaadin/flow/pull/9033#discussion_r492572656", "createdAt": "2020-09-22T08:49:49Z", "author": {"login": "pleku"}, "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/DataCommunicatorTest.java", "diffHunk": "@@ -1072,6 +1073,30 @@ public void itemCountChangeEvent_estimatedCount_estimateUsedUntilEndReached() {\n         Assert.assertFalse(event.isItemCountEstimated());\n     }\n \n+    @Test\n+    public void setDefinedSize_rangeEndEqualsAssumedSize_flushRequested() {\n+        // trigger client communication in order to initialise it and avoid\n+        // infinite loop inside 'requestFlush()'\n+        fakeClientCommunication();\n+\n+        StateNode stateNode = Mockito.spy(element.getNode());\n+        DataCommunicator<Item> dataCommunicator = new DataCommunicator<>(\n+                dataGenerator, arrayUpdater, data -> {}, stateNode);\n+        dataCommunicator.setPageSize(pageSize);\n+        dataCommunicator.setDataProvider(createDataProvider(), null);\n+        // Trigger flush() to set the assumedSize\n+        fakeClientCommunication();\n+\n+        dataCommunicator.setRequestedRange(0, 100);\n+        // clean flushRequest\n+        fakeClientCommunication();\n+\n+        Mockito.reset(stateNode);\n+        dataCommunicator.setDefinedSize(false);\n+        // Verify that requestFlush has been invoked\n+        Mockito.verify(stateNode).runWhenAttached(Mockito.anyObject());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f236d1a0974014ff221a8456655bff22ac8e1a3c"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d56f83100d8448c57539d5bdfcab02884ba2e5c", "author": {"user": {"login": "mshabarov", "name": "Mikhail Shabarov"}}, "url": "https://github.com/vaadin/flow/commit/6d56f83100d8448c57539d5bdfcab02884ba2e5c", "committedDate": "2020-09-23T14:52:55Z", "message": "Estimated count verification added"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MjMzMzc4", "url": "https://github.com/vaadin/flow/pull/9033#pullrequestreview-495233378", "createdAt": "2020-09-24T05:39:57Z", "commit": {"oid": "6d56f83100d8448c57539d5bdfcab02884ba2e5c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4919, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}