{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzOTk3MTAy", "number": 9280, "title": "Fix navigation fallback", "bodyText": "Fixes #9218.\nThis makes navigation fallback (offline start) use the same service worker logic as we use for offlinePath, just using the app shell route / instead of the route to offline page for the cache entry to be returned. I did some manual testing and this does seem to fix the issues described in #9218.\nThe added IT is still a work in progress as it seems to be a false negative (always passes) and doesn't fail even without the fix. If I try to do the same manually when running the test view, it fails as it should. So the test still needs some work.", "createdAt": "2020-11-02T11:34:53Z", "url": "https://github.com/vaadin/flow/pull/9280", "merged": true, "mergeCommit": {"oid": "ed455ad82883d54fc02c9c5838a8411951a9d9e7"}, "closed": true, "closedAt": "2020-11-04T15:29:10Z", "author": {"login": "Haprog"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYi2BoAH2gAyNTEzOTk3MTAyOmI0M2VjYjU0NjcyODYzZDJiYmVkODgxM2Q2N2U3MGMwNTNkODc5Yjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZN5q9AH2gAyNTEzOTk3MTAyOmM5NDFlYWNmMDY1ZDRiYWQ3NDJmNTc1NDAzZTMxOGZlZWYyNWI5OTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b43ecb54672863d2bbed8813d67e70c053d879b8", "author": {"user": {"login": "Haprog", "name": "Kari S\u00f6derholm"}}, "url": "https://github.com/vaadin/flow/commit/b43ecb54672863d2bbed8813d67e70c053d879b8", "committedDate": "2020-11-02T11:27:12Z", "message": "test: add IT for offline start at non-root URL\n\nShould fail for the issue described in #9218 but currently this is a false positive. Needs a bit more work."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d6e29114d794b9a97044846c08dcc1df8b413bd", "author": {"user": {"login": "Haprog", "name": "Kari S\u00f6derholm"}}, "url": "https://github.com/vaadin/flow/commit/7d6e29114d794b9a97044846c08dcc1df8b413bd", "committedDate": "2020-11-02T11:27:52Z", "message": "fix: navigation fallback\n\nFixes #9218"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNTU2Njc4", "url": "https://github.com/vaadin/flow/pull/9280#pullrequestreview-521556678", "createdAt": "2020-11-02T11:42:57Z", "commit": {"oid": "7d6e29114d794b9a97044846c08dcc1df8b413bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMTo0Mjo1N1rOHsBCQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMTo0Mjo1N1rOHsBCQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTkxNjM1Mg==", "bodyText": "This is the main change here.\nThe else block (which used to separately handle offline start situation) from previous if (OFFLINE_PATH_ENABLED) { is removed. The main condition is now on this line. Otherwise the contents that were inside the if is kept as is.", "url": "https://github.com/vaadin/flow/pull/9280#discussion_r515916352", "createdAt": "2020-11-02T11:42:57Z", "author": {"login": "Haprog"}, "path": "flow-server/src/main/resources/sw.ts", "diffHunk": "@@ -5,43 +5,33 @@ import {skipWaiting, clientsClaim} from 'workbox-core';\n import {matchPrecache, precacheAndRoute} from 'workbox-precaching';\n import {NavigationRoute, registerRoute} from 'workbox-routing';\n import {PrecacheEntry} from 'workbox-precaching/_types';\n-import {NetworkFirst, NetworkOnly} from 'workbox-strategies';\n+import {NetworkOnly} from 'workbox-strategies';\n \n skipWaiting();\n clientsClaim();\n \n-let navigationFallback;\n-// @ts-ignore: OFFLINE_PATH_ENABLED is defined by webpack.generated.js\n-if (OFFLINE_PATH_ENABLED) {\n-  // @ts-ignore\n-  const offlinePath = '/' + OFFLINE_PATH;\n-  const networkOnly = new NetworkOnly();\n-  navigationFallback = new NavigationRoute(async (params: any) => {\n-    // Use offlinePath fallback if offline was detected\n-    if (!self.navigator.onLine) {\n-      const offlinePathPrecachedResponse = await matchPrecache(offlinePath);\n-      if (offlinePathPrecachedResponse) {\n-        return offlinePathPrecachedResponse;\n-      }\n+const appShellPath = '/';\n+// @ts-ignore: OFFLINE_PATH_ENABLED and OFFLINE_PATH are defined by webpack.generated.js\n+const offlinePath = OFFLINE_PATH_ENABLED ? '/' + OFFLINE_PATH : appShellPath;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d6e29114d794b9a97044846c08dcc1df8b413bd"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMzU5NjMx", "url": "https://github.com/vaadin/flow/pull/9280#pullrequestreview-523359631", "createdAt": "2020-11-04T13:29:54Z", "commit": {"oid": "7d6e29114d794b9a97044846c08dcc1df8b413bd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea104a67ba54e9483a4f4d2c8cd6258de003e73c", "author": {"user": {"login": "haijian-vaadin", "name": "Haijian Wang"}}, "url": "https://github.com/vaadin/flow/commit/ea104a67ba54e9483a4f4d2c8cd6258de003e73c", "committedDate": "2020-11-04T13:35:40Z", "message": "deferred call submission status API refactor (#9304)\n\n- use DeferredCallHandler class instead of a callback function\r\n- instead of relying on re-throwing error to keep the deferred request in the queue, \r\n  now it uses deferredCallSubmitter.keepDeferredCallInTheQueue();\r\n- renamed EndpointRequest to DeferredCall\r\n- created a common interface EndpointCallMetaInfo for holding the meta info of an \r\n  endpoint call. Both MiddlewareContext and DeferredCall extend from it.\r\n- split offline related code to a separate Offline.ts file\r\n\r\nFixes #9243."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c941eacf065d4bad742f575403e318feef25b993", "author": {"user": {"login": "joheriks", "name": "Johannes Eriksson"}}, "url": "https://github.com/vaadin/flow/commit/c941eacf065d4bad742f575403e318feef25b993", "committedDate": "2020-11-04T13:37:06Z", "message": "Merge branch 'feature/offline' into haprog/fix-nav-fallback"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4761, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}