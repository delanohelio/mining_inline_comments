{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4ODYxMzQ0", "number": 5027, "title": "Do not derive host/port from instance id in HelixServerStarter", "bodyText": "Currently host/port can be derived from instance id, and instance id\ncan also be derived from host/port, which makes ServerConf hard to\nconfig.\nInstead, with the change:\n\nHost is always from config or generated by NetUtil\nPort is always from config or using default (8098)\nInstance id is always from config or of format Server_<host>_<port>\nHost will no longer have the Server_ prefix in InstanceConfig\n\nBACKWARD-INCOMPATIBLE CHANGE:\n\nHost/port will no longer be derived from the instance id configuration if they are not configured: please add host/port configuration\nHost will no longer have the Server_ prefix in InstanceConfig: this has no impact for Pinot as both formats are supported, but might affect client side code that expects Server_ prefix for host in InstanceConfig", "createdAt": "2020-01-30T02:44:30Z", "url": "https://github.com/apache/pinot/pull/5027", "merged": true, "mergeCommit": {"oid": "bef6fdab765458bb6be9cdc8cd6280406a5d42bb"}, "closed": true, "closedAt": "2020-01-31T01:34:05Z", "author": {"login": "Jackie-Jiang"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_evXpgBqjI5OTQ0MDY2NjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_k7D3gFqTM1MTI1MDU2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9080f77c573e1670a632df9eec8ead122b80281b", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/9080f77c573e1670a632df9eec8ead122b80281b", "committedDate": "2020-01-30T02:29:26Z", "message": "Do not derive host/port from instance id in HelixServerStarter\n\nCurrently host/port can be derived from instance id, and instance id\ncan also be derived from host/port, which makes ServerConf hard to\nconfig.\n\nInstead, with the change:\n- Host is always from config or generated by NetUtil\n- Port is always from config or using default (8098)\n- Instance id is always from config or of format 'Server_<host>_<port>'\n- Host will no longer have the 'Server_' prefix in InstanceConfig\n\nBACKWARD-INCOMPATIBLE CHANGE:\n- Host/port will no longer be derived from the instance id configuration\n- Host will no longer have the 'Server_' prefix in InstanceConfig"}, "afterCommit": {"oid": "b4bef2f89e3ebde48202db0ef827f8700714d2bc", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/b4bef2f89e3ebde48202db0ef827f8700714d2bc", "committedDate": "2020-01-30T18:19:50Z", "message": "Do not derive host/port from instance id in HelixServerStarter\n\nCurrently host/port can be derived from instance id, and instance id\ncan also be derived from host/port, which makes ServerConf hard to\nconfig.\n\nInstead, with the change:\n- Host is always from config or generated by NetUtil\n- Port is always from config or using default (8098)\n- Instance id is always from config or of format 'Server_<host>_<port>'\n- Host will no longer have the 'Server_' prefix in InstanceConfig\n\nBACKWARD-INCOMPATIBLE CHANGE:\n- Host/port will no longer be derived from the instance id configuration\n- Host will no longer have the 'Server_' prefix in InstanceConfig"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMDgwNzI1", "url": "https://github.com/apache/pinot/pull/5027#pullrequestreview-351080725", "createdAt": "2020-01-30T19:24:00Z", "commit": {"oid": "9080f77c573e1670a632df9eec8ead122b80281b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxOToyNDo0NVrOFj3Czw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxOToyNDo0NVrOFj3Czw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE0NjMxOQ==", "bodyText": "It is better to put stop() before assertion() to stop the HelixServerStarter. Otherwise, if the assertion fails, it will cause cascading failures to other tests as well: which just caused confusion to real issues.", "url": "https://github.com/apache/pinot/pull/5027#discussion_r373146319", "createdAt": "2020-01-30T19:24:45Z", "author": {"login": "chenboat"}, "path": "pinot-integration-tests/src/test/java/org/apache/pinot/integration/tests/ServerStarterIntegrationTest.java", "diffHunk": "@@ -33,119 +29,105 @@\n import org.testng.annotations.BeforeClass;\n import org.testng.annotations.Test;\n \n-import static org.apache.pinot.common.utils.CommonConstants.Helix.KEY_OF_SERVER_NETTY_HOST;\n-import static org.apache.pinot.common.utils.CommonConstants.Helix.KEY_OF_SERVER_NETTY_PORT;\n+import static org.apache.pinot.common.utils.CommonConstants.Helix.*;\n import static org.apache.pinot.common.utils.CommonConstants.Server.CONFIG_OF_INSTANCE_ID;\n import static org.testng.Assert.assertEquals;\n \n \n public class ServerStarterIntegrationTest extends ControllerTest {\n-  public static final String SERVER1 = \"Server1\";\n+  private static final String CUSTOM_INSTANCE_ID = \"CustomInstance\";\n+  private static final String CUSTOM_HOST = \"CustomHost\";\n+  private static final int CUSTOM_PORT = 10001;\n \n   @BeforeClass\n-  public void setUp()\n-      throws Exception {\n+  public void setUp() {\n     startZk();\n     startController();\n   }\n \n   @AfterClass\n-  public void tearDown()\n-      throws Exception {\n+  public void tearDown() {\n     stopController();\n     stopZk();\n   }\n \n-  private void verifyZkConfigData(HelixServerStarter helixServerStarter, String expectedInstanceName,\n-      String expectedHostname, String expectedPort) {\n-    // Verify the serverId, host and port are set correctly in Zk.\n-    HelixManager helixManager = helixServerStarter.getHelixManager();\n-    PropertyKey.Builder keyBuilder = helixManager.getHelixDataAccessor().keyBuilder();\n-    InstanceConfig config = helixManager.getHelixDataAccessor().\n-        getProperty(keyBuilder.instanceConfig(helixServerStarter.getHelixManager().getInstanceName()));\n-    helixServerStarter.stop();\n+  private void verifyInstanceConfig(HelixServerStarter helixServerStarter, String expectedInstanceId,\n+      String expectedHost, int expectedPort) {\n+    assertEquals(helixServerStarter.getInstanceId(), expectedInstanceId);\n+\n+    InstanceConfig instanceConfig =\n+        _helixDataAccessor.getProperty(_helixDataAccessor.keyBuilder().instanceConfig(expectedInstanceId));\n+    assertEquals(instanceConfig.getHostName(), expectedHost);\n+    assertEquals(Integer.parseInt(instanceConfig.getPort()), expectedPort);\n \n-    assertEquals(config.getInstanceName(), expectedInstanceName);\n-    // By default (auto joined instances), server instance name is of format: {@code Server_<hostname>_<port>}, e.g.\n-    // {@code Server_localhost_12345}, hostname is of format: {@code Server_<hostname>}, e.g. {@code Server_localhost}.\n-    // More details refer to the class ServerInstance.\n-    assertEquals(config.getHostName(), expectedHostname);\n-    assertEquals(config.getPort(), expectedPort);\n+    helixServerStarter.stop();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4bef2f89e3ebde48202db0ef827f8700714d2bc"}, "originalPosition": 71}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6586b90193be28d78eddc5f754b52089cc50d23", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/b6586b90193be28d78eddc5f754b52089cc50d23", "committedDate": "2020-01-30T20:12:34Z", "message": "Do not derive host/port from instance id in HelixServerStarter\n\nCurrently host/port can be derived from instance id, and instance id\ncan also be derived from host/port, which makes ServerConf hard to\nconfig.\n\nInstead, with the change:\n- Host is always from config or generated by NetUtil\n- Port is always from config or using default (8098)\n- Instance id is always from config or of format 'Server_<host>_<port>'\n- Host will no longer have the 'Server_' prefix in InstanceConfig\n\nBACKWARD-INCOMPATIBLE CHANGE:\n- Host/port will no longer be derived from the instance id configuration\n- Host will no longer have the 'Server_' prefix in InstanceConfig"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b4bef2f89e3ebde48202db0ef827f8700714d2bc", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/b4bef2f89e3ebde48202db0ef827f8700714d2bc", "committedDate": "2020-01-30T18:19:50Z", "message": "Do not derive host/port from instance id in HelixServerStarter\n\nCurrently host/port can be derived from instance id, and instance id\ncan also be derived from host/port, which makes ServerConf hard to\nconfig.\n\nInstead, with the change:\n- Host is always from config or generated by NetUtil\n- Port is always from config or using default (8098)\n- Instance id is always from config or of format 'Server_<host>_<port>'\n- Host will no longer have the 'Server_' prefix in InstanceConfig\n\nBACKWARD-INCOMPATIBLE CHANGE:\n- Host/port will no longer be derived from the instance id configuration\n- Host will no longer have the 'Server_' prefix in InstanceConfig"}, "afterCommit": {"oid": "b6586b90193be28d78eddc5f754b52089cc50d23", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/b6586b90193be28d78eddc5f754b52089cc50d23", "committedDate": "2020-01-30T20:12:34Z", "message": "Do not derive host/port from instance id in HelixServerStarter\n\nCurrently host/port can be derived from instance id, and instance id\ncan also be derived from host/port, which makes ServerConf hard to\nconfig.\n\nInstead, with the change:\n- Host is always from config or generated by NetUtil\n- Port is always from config or using default (8098)\n- Instance id is always from config or of format 'Server_<host>_<port>'\n- Host will no longer have the 'Server_' prefix in InstanceConfig\n\nBACKWARD-INCOMPATIBLE CHANGE:\n- Host/port will no longer be derived from the instance id configuration\n- Host will no longer have the 'Server_' prefix in InstanceConfig"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMTYzMzc3", "url": "https://github.com/apache/pinot/pull/5027#pullrequestreview-351163377", "createdAt": "2020-01-30T21:44:48Z", "commit": {"oid": "b6586b90193be28d78eddc5f754b52089cc50d23"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMjUwNTY4", "url": "https://github.com/apache/pinot/pull/5027#pullrequestreview-351250568", "createdAt": "2020-01-31T01:33:15Z", "commit": {"oid": "b6586b90193be28d78eddc5f754b52089cc50d23"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1557, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}