{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyOTEwMjI3", "number": 4984, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwMjoxNDowMVrODYC61w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQyMToyNzo1M1rODYUVlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NTQwMjQ3OnYy", "diffSide": "RIGHT", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskScheduler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwMjoxNDowMVrOFdrlBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNzoyNTo1NVrOFeATlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY2NzAxMw==", "bodyText": "Using Pair<Long, Long> for <last refresh time, last refresh event time> may make the code a little hard to read without context. Would it be better to create a class for this instead?", "url": "https://github.com/apache/pinot/pull/4984#discussion_r366667013", "createdAt": "2020-01-15T02:14:01Z", "author": {"login": "bxji"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskScheduler.java", "diffHunk": "@@ -80,7 +85,7 @@ public DataAvailabilityTaskScheduler(long delayInSec, long fallBackTimeInSec) {\n   @Override\n   public void run() {\n     Map<DetectionConfigDTO, Set<String>> detection2DatasetMap = new HashMap<>();\n-    Map<String, Long> dataset2RefreshTimeMap = new HashMap<>();\n+    Map<String, Pair<Long, Long>> dataset2RefreshTimeMap = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8eada57061c1e2cd32369dbb3800586ee16f1ae"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAwNjYxNQ==", "bodyText": "+1\nLet's use a class since it is complex enough now.", "url": "https://github.com/apache/pinot/pull/4984#discussion_r367006615", "createdAt": "2020-01-15T17:25:55Z", "author": {"login": "xiaohui-sun"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskScheduler.java", "diffHunk": "@@ -80,7 +85,7 @@ public DataAvailabilityTaskScheduler(long delayInSec, long fallBackTimeInSec) {\n   @Override\n   public void run() {\n     Map<DetectionConfigDTO, Set<String>> detection2DatasetMap = new HashMap<>();\n-    Map<String, Long> dataset2RefreshTimeMap = new HashMap<>();\n+    Map<String, Pair<Long, Long>> dataset2RefreshTimeMap = new HashMap<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY2NzAxMw=="}, "originalCommit": {"oid": "d8eada57061c1e2cd32369dbb3800586ee16f1ae"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NzU2ODE0OnYy", "diffSide": "RIGHT", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskScheduler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNzoyMzowNlrOFeAN6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNzoyMzowNlrOFeAN6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAwNTE2Mg==", "bodyText": ".max() should work", "url": "https://github.com/apache/pinot/pull/4984#discussion_r367005162", "createdAt": "2020-01-15T17:23:06Z", "author": {"login": "xiaohui-sun"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskScheduler.java", "diffHunk": "@@ -214,4 +224,11 @@ private boolean needFallback(DetectionConfigDTO detectionConfig) throws Exceptio\n     long lastRunTime = taskLastCreateTimeMap.get(detectionConfigId);\n     return (System.currentTimeMillis() - lastRunTime >= notRunThreshold);\n   }\n+\n+  private boolean isWithinSchedulingWindow(Set<String> datasets, Map<String, Pair<Long, Long>> dataset2RefreshTimeMap) {\n+    long maxEventTime = datasets.stream()\n+        .map(dataset -> dataset2RefreshTimeMap.get(dataset).getRight())\n+        .reduce((v1, v2) -> (v1 > v2) ? v1 : v2).orElse(0L);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8eada57061c1e2cd32369dbb3800586ee16f1ae"}, "originalPosition": 108}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NzU2ODczOnYy", "diffSide": "RIGHT", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskScheduler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNzoyMzoxNlrOFeAOQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNzoyMzoxNlrOFeAOQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAwNTI0OQ==", "bodyText": "Add some comments", "url": "https://github.com/apache/pinot/pull/4984#discussion_r367005249", "createdAt": "2020-01-15T17:23:16Z", "author": {"login": "xiaohui-sun"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskScheduler.java", "diffHunk": "@@ -214,4 +224,11 @@ private boolean needFallback(DetectionConfigDTO detectionConfig) throws Exceptio\n     long lastRunTime = taskLastCreateTimeMap.get(detectionConfigId);\n     return (System.currentTimeMillis() - lastRunTime >= notRunThreshold);\n   }\n+\n+  private boolean isWithinSchedulingWindow(Set<String> datasets, Map<String, Pair<Long, Long>> dataset2RefreshTimeMap) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8eada57061c1e2cd32369dbb3800586ee16f1ae"}, "originalPosition": 105}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NzU3MTQyOnYy", "diffSide": "RIGHT", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/utils/DataAvailabilitySchedulingConfiguration.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNzoyNDowM1rOFeAP_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNzoyNDowM1rOFeAP_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAwNTY5NQ==", "bodyText": "More concrete comments please.\nAdd the motivation for this field.", "url": "https://github.com/apache/pinot/pull/4984#discussion_r367005695", "createdAt": "2020-01-15T17:24:03Z", "author": {"login": "xiaohui-sun"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/utils/DataAvailabilitySchedulingConfiguration.java", "diffHunk": "@@ -37,9 +37,11 @@\n   private List<String> dataSourceWhitelist;\n   private List<String> filterClassList;\n   // delay time after each run for the scheduler to reduce DB polling\n-  private long schedulerDelayInSec = 300; // 5 minute\n+  private long schedulerDelayInSec = 300; // 5 minutes\n   // default threshold if detection level threshold is not set\n   private long taskTriggerFallBackTimeInSec = 24 * 60 * 60; // 1 day\n+  // scheduling window for data availability scheduling", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8eada57061c1e2cd32369dbb3800586ee16f1ae"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NzU3Mzk2OnYy", "diffSide": "RIGHT", "path": "thirdeye/thirdeye-pinot/src/test/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskSchedulerTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNzoyNDo1OVrOFeARwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxOTo1OTowN1rOFeEq0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAwNjE0NA==", "bodyText": "Why two TEST_TIME. Normally the two times should be different.", "url": "https://github.com/apache/pinot/pull/4984#discussion_r367006144", "createdAt": "2020-01-15T17:24:59Z", "author": {"login": "xiaohui-sun"}, "path": "thirdeye/thirdeye-pinot/src/test/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskSchedulerTest.java", "diffHunk": "@@ -110,8 +110,8 @@ public void testCreateMultipleTasks() {\n     long detection2 = createDetection(2, metrics1, oneDayAgo, 0);\n     List<Long> singleMetric = Collections.singletonList(metricId2);\n     long detection3 = createDetection(3, singleMetric, oneDayAgo, 0);\n-    createDataset(1, TEST_TIME);\n-    createDataset(2, TEST_TIME);\n+    createDataset(1, TEST_TIME, TEST_TIME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8eada57061c1e2cd32369dbb3800586ee16f1ae"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA3ODA5Ng==", "bodyText": "Yes, they are always different in production. I simplify it in test case to make them the same, since we never compare those two timestamps anyway.", "url": "https://github.com/apache/pinot/pull/4984#discussion_r367078096", "createdAt": "2020-01-15T19:59:07Z", "author": {"login": "vincentchenjl"}, "path": "thirdeye/thirdeye-pinot/src/test/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskSchedulerTest.java", "diffHunk": "@@ -110,8 +110,8 @@ public void testCreateMultipleTasks() {\n     long detection2 = createDetection(2, metrics1, oneDayAgo, 0);\n     List<Long> singleMetric = Collections.singletonList(metricId2);\n     long detection3 = createDetection(3, singleMetric, oneDayAgo, 0);\n-    createDataset(1, TEST_TIME);\n-    createDataset(2, TEST_TIME);\n+    createDataset(1, TEST_TIME, TEST_TIME);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAwNjE0NA=="}, "originalCommit": {"oid": "d8eada57061c1e2cd32369dbb3800586ee16f1ae"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2Nzc4MDYwOnYy", "diffSide": "RIGHT", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/utils/DataAvailabilitySchedulingConfiguration.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxODozNTowM1rOFeCT9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxOTo1NzowM1rOFeEnKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzOTQ3OA==", "bodyText": "Maybe it's better to use TimeUnit.MINUTES.toSeconds(15) than calculating seconds by multiplication.", "url": "https://github.com/apache/pinot/pull/4984#discussion_r367039478", "createdAt": "2020-01-15T18:35:03Z", "author": {"login": "jihaozh"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/utils/DataAvailabilitySchedulingConfiguration.java", "diffHunk": "@@ -37,9 +37,11 @@\n   private List<String> dataSourceWhitelist;\n   private List<String> filterClassList;\n   // delay time after each run for the scheduler to reduce DB polling\n-  private long schedulerDelayInSec = 300; // 5 minute\n+  private long schedulerDelayInSec = 300; // 5 minutes\n   // default threshold if detection level threshold is not set\n   private long taskTriggerFallBackTimeInSec = 24 * 60 * 60; // 1 day\n+  // scheduling window for data availability scheduling\n+  private long schedulingWindowInSec = 15 * 60; // 15 minutes", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8eada57061c1e2cd32369dbb3800586ee16f1ae"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA3NzE2MQ==", "bodyText": "Good call!", "url": "https://github.com/apache/pinot/pull/4984#discussion_r367077161", "createdAt": "2020-01-15T19:57:03Z", "author": {"login": "vincentchenjl"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/utils/DataAvailabilitySchedulingConfiguration.java", "diffHunk": "@@ -37,9 +37,11 @@\n   private List<String> dataSourceWhitelist;\n   private List<String> filterClassList;\n   // delay time after each run for the scheduler to reduce DB polling\n-  private long schedulerDelayInSec = 300; // 5 minute\n+  private long schedulerDelayInSec = 300; // 5 minutes\n   // default threshold if detection level threshold is not set\n   private long taskTriggerFallBackTimeInSec = 24 * 60 * 60; // 1 day\n+  // scheduling window for data availability scheduling\n+  private long schedulingWindowInSec = 15 * 60; // 15 minutes", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzOTQ3OA=="}, "originalCommit": {"oid": "d8eada57061c1e2cd32369dbb3800586ee16f1ae"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2Nzc4Mjc3OnYy", "diffSide": "RIGHT", "path": "thirdeye/thirdeye-pinot/src/test/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskSchedulerTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxODozNTo1MFrOFeCVXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxODozNTo1MFrOFeCVXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzOTgzNg==", "bodyText": "Same as above, how about using TimeUnit class to convert to seconds?", "url": "https://github.com/apache/pinot/pull/4984#discussion_r367039836", "createdAt": "2020-01-15T18:35:50Z", "author": {"login": "jihaozh"}, "path": "thirdeye/thirdeye-pinot/src/test/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskSchedulerTest.java", "diffHunk": "@@ -79,7 +79,7 @@ public void beforeMethod() {\n     metric1.setDerived(false);\n     metric2.setAlias(\"\");\n     metricId2 = metricConfigManager.save(metric2);\n-    dataAvailabilityTaskScheduler = new DataAvailabilityTaskScheduler(60, 24 * 60 * 60);\n+    dataAvailabilityTaskScheduler = new DataAvailabilityTaskScheduler(60, 24 * 60 * 60, 15 * 60);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8eada57061c1e2cd32369dbb3800586ee16f1ae"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2ODIyNTQ1OnYy", "diffSide": "RIGHT", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskScheduler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQyMToxNjozM1rOFeGr7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwMDoyNzoyMlrOFeKrRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzExMTE1MA==", "bodyText": "Add comments.", "url": "https://github.com/apache/pinot/pull/4984#discussion_r367111150", "createdAt": "2020-01-15T21:16:33Z", "author": {"login": "xiaohui-sun"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskScheduler.java", "diffHunk": "@@ -58,18 +59,29 @@\n   private ScheduledExecutorService executorService;\n   private long delayInSec;\n   private long fallBackTimeInSec;\n+  private long schedulingWindowInSec;\n   private Map<Long, Long> taskLastCreateTimeMap;\n   private TaskManager taskDAO;\n   private DetectionConfigManager detectionConfigDAO;\n   private DatasetConfigManager datasetConfigDAO;\n+\n+  private class DatasetUpdateStatus {\n+    long lastDataTs;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d9f14442b1d6845c04f2c47d54ff71fdc54e4fd"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE3NjUxOA==", "bodyText": "It is removed.", "url": "https://github.com/apache/pinot/pull/4984#discussion_r367176518", "createdAt": "2020-01-16T00:27:22Z", "author": {"login": "vincentchenjl"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskScheduler.java", "diffHunk": "@@ -58,18 +59,29 @@\n   private ScheduledExecutorService executorService;\n   private long delayInSec;\n   private long fallBackTimeInSec;\n+  private long schedulingWindowInSec;\n   private Map<Long, Long> taskLastCreateTimeMap;\n   private TaskManager taskDAO;\n   private DetectionConfigManager detectionConfigDAO;\n   private DatasetConfigManager datasetConfigDAO;\n+\n+  private class DatasetUpdateStatus {\n+    long lastDataTs;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzExMTE1MA=="}, "originalCommit": {"oid": "5d9f14442b1d6845c04f2c47d54ff71fdc54e4fd"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2ODIzNTI0OnYy", "diffSide": "RIGHT", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskScheduler.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQyMToxOTo1MlrOFeGx-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxODo1MDo0OVrOFej4Jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzExMjY5OA==", "bodyText": "Should we log it? Will it creates lots of logs?", "url": "https://github.com/apache/pinot/pull/4984#discussion_r367112698", "createdAt": "2020-01-15T21:19:52Z", "author": {"login": "xiaohui-sun"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskScheduler.java", "diffHunk": "@@ -89,12 +101,16 @@ public void run() {\n         long detectionConfigId = detectionConfig.getId();\n         if (!runningDetection.containsKey(detectionConfigId)) {\n           if (isAllDatasetUpdated(detectionConfig, detection2DatasetMap.get(detectionConfig), dataset2RefreshTimeMap)) {\n-            //TODO: additional check is required if detection is based on aggregated value across multiple data points\n-            createDetectionTask(detectionConfig);\n-            ThirdeyeMetricsUtil.eventScheduledTaskCounter.inc();\n-            taskCount++;\n+            if (isWithinSchedulingWindow(detection2DatasetMap.get(detectionConfig), dataset2RefreshTimeMap)) {\n+              //TODO: additional check is required if detection is based on aggregated value across multiple data points\n+              createDetectionTask(detectionConfig);\n+              ThirdeyeMetricsUtil.eventScheduledTaskCounter.inc();\n+              taskCount++;\n+            } else {\n+              LOG.warn(\"Unable to schedule a task for {}, because it is out of scheduling window.\", detectionConfigId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d9f14442b1d6845c04f2c47d54ff71fdc54e4fd"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE3NzMzMg==", "bodyText": "It will only generate logs when the scheduler runs, namely every 5 minutes. This line will only be printed when the watermark is not moving forward, which should be minor case.", "url": "https://github.com/apache/pinot/pull/4984#discussion_r367177332", "createdAt": "2020-01-16T00:30:35Z", "author": {"login": "vincentchenjl"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskScheduler.java", "diffHunk": "@@ -89,12 +101,16 @@ public void run() {\n         long detectionConfigId = detectionConfig.getId();\n         if (!runningDetection.containsKey(detectionConfigId)) {\n           if (isAllDatasetUpdated(detectionConfig, detection2DatasetMap.get(detectionConfig), dataset2RefreshTimeMap)) {\n-            //TODO: additional check is required if detection is based on aggregated value across multiple data points\n-            createDetectionTask(detectionConfig);\n-            ThirdeyeMetricsUtil.eventScheduledTaskCounter.inc();\n-            taskCount++;\n+            if (isWithinSchedulingWindow(detection2DatasetMap.get(detectionConfig), dataset2RefreshTimeMap)) {\n+              //TODO: additional check is required if detection is based on aggregated value across multiple data points\n+              createDetectionTask(detectionConfig);\n+              ThirdeyeMetricsUtil.eventScheduledTaskCounter.inc();\n+              taskCount++;\n+            } else {\n+              LOG.warn(\"Unable to schedule a task for {}, because it is out of scheduling window.\", detectionConfigId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzExMjY5OA=="}, "originalCommit": {"oid": "5d9f14442b1d6845c04f2c47d54ff71fdc54e4fd"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU4OTQxNA==", "bodyText": "That's fine. Thanks.", "url": "https://github.com/apache/pinot/pull/4984#discussion_r367589414", "createdAt": "2020-01-16T18:50:49Z", "author": {"login": "xiaohui-sun"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskScheduler.java", "diffHunk": "@@ -89,12 +101,16 @@ public void run() {\n         long detectionConfigId = detectionConfig.getId();\n         if (!runningDetection.containsKey(detectionConfigId)) {\n           if (isAllDatasetUpdated(detectionConfig, detection2DatasetMap.get(detectionConfig), dataset2RefreshTimeMap)) {\n-            //TODO: additional check is required if detection is based on aggregated value across multiple data points\n-            createDetectionTask(detectionConfig);\n-            ThirdeyeMetricsUtil.eventScheduledTaskCounter.inc();\n-            taskCount++;\n+            if (isWithinSchedulingWindow(detection2DatasetMap.get(detectionConfig), dataset2RefreshTimeMap)) {\n+              //TODO: additional check is required if detection is based on aggregated value across multiple data points\n+              createDetectionTask(detectionConfig);\n+              ThirdeyeMetricsUtil.eventScheduledTaskCounter.inc();\n+              taskCount++;\n+            } else {\n+              LOG.warn(\"Unable to schedule a task for {}, because it is out of scheduling window.\", detectionConfigId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzExMjY5OA=="}, "originalCommit": {"oid": "5d9f14442b1d6845c04f2c47d54ff71fdc54e4fd"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2ODI1NjIzOnYy", "diffSide": "RIGHT", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskScheduler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQyMToyNzo1M1rOFeG_Ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwMDoyNzozMFrOFeKrcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzExNjExNA==", "bodyText": "I have a feeling we are creating too many customized objects. Can we just reuse the DatasetConfigDTO and get rid of DatasetUpdateStatus? The DatasetConfigDTO should contain everything you need.", "url": "https://github.com/apache/pinot/pull/4984#discussion_r367116114", "createdAt": "2020-01-15T21:27:53Z", "author": {"login": "xiaohui-sun"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskScheduler.java", "diffHunk": "@@ -119,7 +135,8 @@ public void close() {\n   }\n \n   private void populateDetectionMapAndDataset2RefreshTimeMap(\n-      Map<DetectionConfigDTO, Set<String>> dataset2DetectionMap, Map<String, Long> dataset2RefreshTimeMap) {\n+      Map<DetectionConfigDTO, Set<String>> dataset2DetectionMap,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d9f14442b1d6845c04f2c47d54ff71fdc54e4fd"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE3NjU2MA==", "bodyText": "Good suggestion.", "url": "https://github.com/apache/pinot/pull/4984#discussion_r367176560", "createdAt": "2020-01-16T00:27:30Z", "author": {"login": "vincentchenjl"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskScheduler.java", "diffHunk": "@@ -119,7 +135,8 @@ public void close() {\n   }\n \n   private void populateDetectionMapAndDataset2RefreshTimeMap(\n-      Map<DetectionConfigDTO, Set<String>> dataset2DetectionMap, Map<String, Long> dataset2RefreshTimeMap) {\n+      Map<DetectionConfigDTO, Set<String>> dataset2DetectionMap,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzExNjExNA=="}, "originalCommit": {"oid": "5d9f14442b1d6845c04f2c47d54ff71fdc54e4fd"}, "originalPosition": 75}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3587, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}