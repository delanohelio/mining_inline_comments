{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3ODc2ODA0", "number": 5864, "title": "Fixing the race condition that segment finished before ControllerLeaderLocator created.", "bodyText": "Description\nCurrent Pinot server start ServerInstance before ControllerLeaderLocator creation.\nThis is typically ok but in one extreme case that during realtime server bootstrap, one segment is consumed to threshold and trying to persist, it will use ControllerLeaderLocator in ServerSegmentCompletionProtocolHandler.createSegmentCompletionUrl(...) which may not be created yet.\nBelow is a sample logs:\n2020/08/14 00:20:05.855 INFO [PluginManager] [main] Plugins root dir is [/opt/pinot/plugins]\n2020/08/14 00:20:05.869 INFO [PluginManager] [main] Loading all plugins. Please use env variable 'plugins.include' to customize.\n2020/08/14 00:20:05.869 INFO [PluginManager] [main] Trying to load plugin [pinot-batch-ingestion-hadoop] from location [/opt/pinot/plugins/pinot-batch-ingestion/pinot-batch-ingestion-hadoop]\n2020/08/14 00:20:05.870 INFO [PluginManager] [main] Successfully loaded plugin [pinot-batch-ingestion-hadoop] from jar file [/opt/pinot/plugins/pinot-batch-ingestion/pinot-batch-ingestion-hadoop/pinot-batch-ingestion-hadoop-0.5.0-SNAPSHOT-shaded.jar]\n...\n...\n2020/08/14 00:20:06.199 INFO [ServerInstance] [main] Initializing server instance\n2020/08/14 00:20:06.199 INFO [ServerInstance] [main] Initializing server metrics\n2020/08/14 00:20:06.220 INFO [ServerInstance] [main] Initializing instance data manager of class: org.apache.pinot.server.starter.helix.HelixInstanceDataManager\n2020/08/14 00:20:06.223 INFO [HelixInstanceDataManager] [main] Initializing Helix instance data manager\n2020/08/14 00:20:06.224 INFO [HelixInstanceDataManagerConfig] [main] InstanceDataManagerConfig, key: datadir , value: /var/pinot/server/data/index\n2020/08/14 00:20:06.225 INFO [HelixInstanceDataManagerConfig] [main] InstanceDataManagerConfig, key: segmenttardir , value: /var/pinot/server/data/segment\n2020/08/14 00:20:06.225 INFO [HelixInstanceDataManagerConfig] [main] InstanceDataManagerConfig, key: data.manager.class , value: org.apache.pinot.server.starter.helix.HelixInstanceDataManager\n...\n2020/08/14 00:20:08.114 INFO [HelixTaskExecutor] [main] Scheduling message 553a8091-14b7-48a9-91b6-61c9c722112d: testTable_REALTIME:testTable__0__4__20200813T2127Z, OFFLINE->CONSUMING\n2020/08/14 00:20:08.115 INFO [HelixTaskExecutor] [main] Submit task: 553a8091-14b7-48a9-91b6-61c9c722112d to pool: java.util.concurrent.ThreadPoolExecutor@48b0e701[Running, pool size = 1, active threads = 1, queued tasks = 0, completed tasks = 0]\n2020/08/14 00:20:08.203 INFO [HelixStateTransitionHandler] [HelixTaskExecutor-message_handle_thread] Instance Server_my-host-server-0.my-host-server-headless.my-host.svc.cluster.local_8098, partition testTable__0__4__20200813T2127Z received state transition from OFFLINE to CONSUMING on session 100e1f0f4d00022, message id: 553a8091-14b7-48a9-91b6-61c9c722112d\n2020/08/14 00:20:08.203 INFO [SegmentOnlineOfflineStateModelFactory$SegmentOnlineOfflineStateModel] [HelixTaskExecutor-message_handle_thread] SegmentOnlineOfflineStateModel.onBecomeConsumingFromOffline() : ZnRecord=553a8091-14b7-48a9-91b6-61c9c722112d, {CREATE_TIMESTAMP=1597364407619, ClusterEventName=CurrentStateChange, EXECUTE_START_TIMESTAMP=1597364408128, EXE_SESSION_ID=100e1f0f4d00022, FROM_STATE=OFFLINE, MSG_ID=553a8091-14b7-48a9-91b6-61c9c722112d, MSG_STATE=read, MSG_TYPE=STATE_TRANSITION, PARTITION_NAME=testTable__0__4__20200813T2127Z, READ_TIMESTAMP=1597364407995, RESOURCE_NAME=testTable_REALTIME, RESOURCE_TAG=testTable_REALTIME, SRC_NAME=my-host-controller-0.my-host-controller-headless.my-host.svc.cluster.local_9000, SRC_SESSION_ID=100e1f0f4d0001e, STATE_MODEL_DEF=SegmentOnlineOfflineStateModel, STATE_MODEL_FACTORY_NAME=DEFAULT, TGT_NAME=Server_my-host-server-0.my-host-server-headless.my-host.svc.cluster.local_8098, TGT_SESSION_ID=100e1f0f4d00022, TO_STATE=CONSUMING}{}{}, Stat=Stat {_version=0, _creationTime=1597364407632, _modifiedTime=1597364407632, _ephemeralOwner=0}\n2020/08/14 00:20:08.203 INFO [SegmentOnlineOfflineStateModelFactory$SegmentOnlineOfflineStateModel] [HelixTaskExecutor-message_handle_thread] SegmentOnlineOfflineStateModel.onBecomeOnlineFromOffline() : ZnRecord=553a8091-14b7-48a9-91b6-61c9c722112d, {CREATE_TIMESTAMP=1597364407619, ClusterEventName=CurrentStateChange, EXECUTE_START_TIMESTAMP=1597364408128, EXE_SESSION_ID=100e1f0f4d00022, FROM_STATE=OFFLINE, MSG_ID=553a8091-14b7-48a9-91b6-61c9c722112d, MSG_STATE=read, MSG_TYPE=STATE_TRANSITION, PARTITION_NAME=testTable__0__4__20200813T2127Z, READ_TIMESTAMP=1597364407995, RESOURCE_NAME=testTable_REALTIME, RESOURCE_TAG=testTable_REALTIME, SRC_NAME=my-host-controller-0.my-host-controller-headless.my-host.svc.cluster.local_9000, SRC_SESSION_ID=100e1f0f4d0001e, STATE_MODEL_DEF=SegmentOnlineOfflineStateModel, STATE_MODEL_FACTORY_NAME=DEFAULT, TGT_NAME=Server_my-host-server-0.my-host-server-headless.my-host.svc.cluster.local_8098, TGT_SESSION_ID=100e1f0f4d00022, TO_STATE=CONSUMING}{}{}, Stat=Stat {_version=0, _creationTime=1597364407632, _modifiedTime=1597364407632, _ephemeralOwner=0}\n2020/08/14 00:20:08.203 INFO [HelixInstanceDataManager] [HelixTaskExecutor-message_handle_thread] Adding segment: testTable__0__4__20200813T2127Z to table: testTable_REALTIME\n2020/08/14 00:20:09.093 INFO [LLRealtimeSegmentDataManager_testTable__0__4__20200813T2127Z] [HelixTaskExecutor-message_handle_thread] RealtimeDataResourceZKMetadata contains no information about sorted column for segment testTable__0__4__20200813T2127Z\n2020/08/14 00:20:09.099 INFO [LLRealtimeSegmentDataManager_testTable__0__4__20200813T2127Z] [HelixTaskExecutor-message_handle_thread] Creating new stream consumer, reason: Starting\n2020/08/14 00:20:09.129 INFO [LLRealtimeSegmentDataManager_testTable__0__4__20200813T2127Z] [HelixTaskExecutor-message_handle_thread] Creating new stream metadata provider, reason: Starting\n...\n2020/08/14 00:20:09.173 INFO [FixedByteSVMutableForwardIndex] [HelixTaskExecutor-message_handle_thread] Allocating 200000 bytes for: testTable__0__4__20200813T2127Z:column1.sv.unsorted.fwd\n...\n2020/08/14 00:20:09.228 INFO [MutableSegmentImpl_testTable__0__4__20200813T2127Z_testTables] [HelixTaskExecutor-message_handle_thread] Metrics aggregation is disabled.\n2020/08/14 00:20:09.272 INFO [LLRealtimeSegmentDataManager_testTable__0__4__20200813T2127Z] [HelixTaskExecutor-message_handle_thread] Starting consumption on realtime consuming segment testTable__0__4__20200813T2127Z maxRowCount 50000 maxEndTime 2020-08-14T00:30:09.229Z\n2020/08/14 00:20:09.292 INFO [LLRealtimeSegmentDataManager_testTable__0__4__20200813T2127Z] [HelixTaskExecutor-message_handle_thread] Created new consumer thread Thread[testTable__0__4__20200813T2127Z,5,main] for org.apache.pinot.core.data.manager.realtime.LLRealtimeSegmentDataManager@a12cbb0\n2020/08/14 00:20:09.299 INFO [testTable_REALTIME-RealtimeTableDataManager] [HelixTaskExecutor-message_handle_thread] Initialize RealtimeSegmentDataManager - testTable__0__4__20200813T2127Z\n2020/08/14 00:20:09.299 INFO [HelixInstanceDataManager] [HelixTaskExecutor-message_handle_thread] Added segment: testTable__0__4__20200813T2127Z to table: testTable_REALTIME\n2020/08/14 00:20:09.300 INFO [LLRealtimeSegmentDataManager_testTable__0__4__20200813T2127Z] [testTable__0__4__20200813T2127Z] Starting consumption loop start offset 200000, finalOffset null\n2020/08/14 00:20:09.383 INFO [HelixTask] [HelixTaskExecutor-message_handle_thread] Message: 553a8091-14b7-48a9-91b6-61c9c722112d (parent: null) handling task for testTable_REALTIME:testTable__0__4__20200813T2127Z completed at: 1597364409383, results: true. FrameworkTime: 53 ms; HandlerTime: 1211 ms.\n2020/08/14 00:20:09.717 INFO [Metadata] [testTable__0__4__20200813T2127Z] Cluster ID: 21TWeeruS9eTKd-gAXF1qQ\n2020/08/14 00:20:14.127 INFO [AbstractCoordinator] [testTable__0__4__20200813T2127Z] [Consumer clientId=consumer-2, groupId=] Discovered group coordinator my-kafka:9092 (id: 2147483644 rack: null)\n2020/08/14 00:20:18.489 INFO [LLRealtimeSegmentDataManager_testTable__0__4__20200813T2127Z] [testTable__0__4__20200813T2127Z] Stopping consumption due to row limit nRows=50000 numRowsIndexed=50000, numRowsConsumed=50000\n2020/08/14 00:20:18.489 INFO [LLRealtimeSegmentDataManager_testTable__0__4__20200813T2127Z] [testTable__0__4__20200813T2127Z] Stopping consumption due to row limit nRows=50000 numRowsIndexed=50000, numRowsConsumed=50000\n2020/08/14 00:20:18.489 ERROR [LLRealtimeSegmentDataManager_testTable__0__4__20200813T2127Z] [testTable__0__4__20200813T2127Z] Exception while in work\njava.lang.RuntimeException: Not yet created\n\tat org.apache.pinot.server.realtime.ControllerLeaderLocator.getInstance(ControllerLeaderLocator.java:79) ~[pinot-all-0.5.0-SNAPSHOT-jar-with-dependencies.jar:0.5.0-SNAPSHOT-8ab032fa05b514ab6614396d632b9c9e52b9100d]\n\tat org.apache.pinot.server.realtime.ServerSegmentCompletionProtocolHandler.createSegmentCompletionUrl(ServerSegmentCompletionProtocolHandler.java:188) ~[pinot-all-0.5.0-SNAPSHOT-jar-with-dependencies.jar:0.5.0-SNAPSHOT-8ab032fa05b514ab6614396d632b9c9e52b9100d]\n\tat org.apache.pinot.server.realtime.ServerSegmentCompletionProtocolHandler.segmentConsumed(ServerSegmentCompletionProtocolHandler.java:170) ~[pinot-all-0.5.0-SNAPSHOT-jar-with-dependencies.jar:0.5.0-SNAPSHOT-8ab032fa05b514ab6614396d632b9c9e52b9100d]\n\tat org.apache.pinot.core.data.manager.realtime.LLRealtimeSegmentDataManager.postSegmentConsumedMsg(LLRealtimeSegmentDataManager.java:926) ~[pinot-all-0.5.0-SNAPSHOT-jar-with-dependencies.jar:0.5.0-SNAPSHOT-8ab032fa05b514ab6614396d632b9c9e52b9100d]\n\tat org.apache.pinot.core.data.manager.realtime.LLRealtimeSegmentDataManager$PartitionConsumer.run(LLRealtimeSegmentDataManager.java:553) [pinot-all-0.5.0-SNAPSHOT-jar-with-dependencies.jar:0.5.0-SNAPSHOT-8ab032fa05b514ab6614396d632b9c9e52b9100d]\n\tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_265]", "createdAt": "2020-08-14T09:24:41Z", "url": "https://github.com/apache/pinot/pull/5864", "merged": true, "mergeCommit": {"oid": "c5a8b02a491d22454174bcbb07927a90a339ec9e"}, "closed": true, "closedAt": "2020-08-20T00:05:41Z", "author": {"login": "xiangfu0"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-w_oeAH2gAyNDY3ODc2ODA0OjYxN2Y3NmJiMzI2ZThmOGY0YzBjNjdlODM1OTk2YzM3ODAwODEwMGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAkjbhgFqTQ3MTAzODcxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "617f76bb326e8f8f4c0c67e835996c378008100c", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/617f76bb326e8f8f4c0c67e835996c378008100c", "committedDate": "2020-08-14T09:14:20Z", "message": "Fixing the race condition that segment finished before ControllerLeaderLocator created."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NjkzODgx", "url": "https://github.com/apache/pinot/pull/5864#pullrequestreview-467693881", "createdAt": "2020-08-14T16:02:38Z", "commit": {"oid": "617f76bb326e8f8f4c0c67e835996c378008100c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNjowMjozOFrOHA6Lsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNjowMjozOFrOHA6Lsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDcxNTMxNQ==", "bodyText": "ControllerLeaderLocator uses helixManager to get the controller resource status, so you need to have the helix manager connected before any leader locator functionality is invoked. So your use case will not work if the same race condition happens again.", "url": "https://github.com/apache/pinot/pull/5864#discussion_r470715315", "createdAt": "2020-08-14T16:02:38Z", "author": {"login": "mcvsubbu"}, "path": "pinot-server/src/main/java/org/apache/pinot/server/starter/helix/HelixServerStarter.java", "diffHunk": "@@ -363,6 +363,7 @@ public void start()\n \n     LOGGER.info(\"Initializing server instance and registering state model factory\");\n     Utils.logVersions();\n+    ControllerLeaderLocator.create(_helixManager);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "617f76bb326e8f8f4c0c67e835996c378008100c"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMDM4NzE1", "url": "https://github.com/apache/pinot/pull/5864#pullrequestreview-471038715", "createdAt": "2020-08-19T23:52:31Z", "commit": {"oid": "617f76bb326e8f8f4c0c67e835996c378008100c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 183, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}