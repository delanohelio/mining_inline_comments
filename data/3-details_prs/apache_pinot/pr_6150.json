{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0OTc0NjMx", "number": 6150, "title": "Adding grpcPort in controller instance API response", "bodyText": "Description\nAdding field \"grpcPort\" in controller's /instance API responses.\nSo external services can get the grpc port used for the given pinot server.\nThe default grpc port is 8090 if enabled, for non-enabled server instances, will put -1 there.", "createdAt": "2020-10-16T16:53:33Z", "url": "https://github.com/apache/pinot/pull/6150", "merged": true, "mergeCommit": {"oid": "bb835df5f903d55c08ab263d81b1db4d61e44ff2"}, "closed": true, "closedAt": "2020-10-17T21:35:59Z", "author": {"login": "xiangfu0"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdTJTYtgH2gAyNTA0OTc0NjMxOjk3OTZjYmZjZWJlMTY3YWQ2YzVhZDRmODAyOWM4NWZhMjY2NjE0YWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdTgd_bgH2gAyNTA0OTc0NjMxOjMwNzFiYWI3MWFhMzhhNjdmOTY0ZTc5YTQ1NWEzMjIyZWFiYWM5NWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9796cbfcebe167ad6c5ad4f8029c85fa266614af", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/9796cbfcebe167ad6c5ad4f8029c85fa266614af", "committedDate": "2020-10-16T16:52:07Z", "message": "Adding grpcPort in controller instance API response"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNzUyNzk1", "url": "https://github.com/apache/pinot/pull/6150#pullrequestreview-510752795", "createdAt": "2020-10-16T19:41:12Z", "commit": {"oid": "9796cbfcebe167ad6c5ad4f8029c85fa266614af"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxOTo0MToxMlrOHjNpLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxOTo1MDowMFrOHjN4eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY4NTc0Mg==", "bodyText": "Not related to this PR, but we might want to provide a new API to return the Instance to be in-sync with the setter API.", "url": "https://github.com/apache/pinot/pull/6150#discussion_r506685742", "createdAt": "2020-10-16T19:41:12Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotInstanceRestletResource.java", "diffHunk": "@@ -101,6 +101,7 @@ public String getInstance(\n     response.put(\"port\", instanceConfig.getPort());\n     response.set(\"tags\", JsonUtils.objectToJsonNode(instanceConfig.getTags()));\n     response.set(\"pools\", JsonUtils.objectToJsonNode(instanceConfig.getRecord().getMapField(InstanceUtils.POOL_KEY)));\n+    response.put(\"grpcPort\", instanceConfig.getRecord().getSimpleField(InstanceUtils.GRPC_PORT_KEY));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9796cbfcebe167ad6c5ad4f8029c85fa266614af"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY4NjUzMA==", "bodyText": "Remove the static import\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                checkInstanceInfo(instanceName, hostName, port, tags, pools, poolValues, NOT_SET_GRPC_PORT_VALUE);\n          \n          \n            \n                checkInstanceInfo(instanceName, hostName, port, tags, pools, poolValues, Instance.NOT_SET_GRPC_PORT_VALUE);", "url": "https://github.com/apache/pinot/pull/6150#discussion_r506686530", "createdAt": "2020-10-16T19:43:04Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-controller/src/test/java/org/apache/pinot/controller/api/PinotInstanceRestletResourceTest.java", "diffHunk": "@@ -144,14 +148,18 @@ public void testInstanceListingAndCreation()\n     String serverInstanceUpdateTagsUrl = _controllerRequestURLBuilder.forInstanceUpdateTags(serverInstanceId,\n         Lists.newArrayList(\"tag_REALTIME\", \"newTag_OFFLINE\", \"newTag_REALTIME\"));\n     sendPutRequest(serverInstanceUpdateTagsUrl);\n-    checkInstanceInfo(brokerInstanceId, \"Broker_1.2.3.4\", 1234, new String[]{\"tag_BROKER\", \"newTag_BROKER\"}, null,\n-        null);\n+    checkInstanceInfo(brokerInstanceId, \"Broker_1.2.3.4\", 1234, new String[]{\"tag_BROKER\", \"newTag_BROKER\"}, null, null);\n     checkInstanceInfo(serverInstanceId, \"Server_1.2.3.4\", 2345,\n-        new String[]{\"tag_REALTIME\", \"newTag_OFFLINE\", \"newTag_REALTIME\"}, null, null);\n+        new String[]{\"tag_REALTIME\", \"newTag_OFFLINE\", \"newTag_REALTIME\"}, null, null, 28090);\n   }\n \n   private void checkInstanceInfo(String instanceName, String hostName, int port, String[] tags, String[] pools,\n       int[] poolValues) {\n+    checkInstanceInfo(instanceName, hostName, port, tags, pools, poolValues, NOT_SET_GRPC_PORT_VALUE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9796cbfcebe167ad6c5ad4f8029c85fa266614af"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY4ODM3Mg==", "bodyText": "This will be set to 0 from the json if grpcPort is not set. You can check for 0 and put -1", "url": "https://github.com/apache/pinot/pull/6150#discussion_r506688372", "createdAt": "2020-10-16T19:47:14Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-spi/src/main/java/org/apache/pinot/spi/config/instance/Instance.java", "diffHunk": "@@ -38,29 +38,40 @@\n  *   \"tags\": [\"example_OFFLINE\"],\n  *   \"pools\": {\n  *     \"example_OFFLINE\": 0\n- *   }\n+ *   },\n+ *   \"grpcPort\": 8090\n  * }\n  * </pre>\n  */\n public class Instance extends BaseJsonConfig {\n+  public static int NOT_SET_GRPC_PORT_VALUE = -1;\n+\n   private final String _host;\n   private final int _port;\n   private final InstanceType _type;\n   private final List<String> _tags;\n   private final Map<String, Integer> _pools;\n+  private final int _grpcPort;\n+\n+\n+  public Instance(String host, int port, InstanceType type, List<String> tags, Map<String, Integer> pools) {\n+    this(host, port, type, tags, pools, NOT_SET_GRPC_PORT_VALUE);\n+  }\n \n   @JsonCreator\n   public Instance(@JsonProperty(value = \"host\", required = true) String host,\n       @JsonProperty(value = \"port\", required = true) int port,\n       @JsonProperty(value = \"type\", required = true) InstanceType type,\n-      @JsonProperty(\"tags\") @Nullable List<String> tags, @JsonProperty(\"pools\") @Nullable Map<String, Integer> pools) {\n+      @JsonProperty(\"tags\") @Nullable List<String> tags, @JsonProperty(\"pools\") @Nullable Map<String, Integer> pools,\n+      @JsonProperty(\"grpcPort\") int grpcPort) {\n     Preconditions.checkArgument(host != null, \"'host' must be configured\");\n     Preconditions.checkArgument(type != null, \"'type' must be configured\");\n     _host = host;\n     _port = port;\n     _type = type;\n     _tags = tags;\n     _pools = pools;\n+    _grpcPort = grpcPort;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9796cbfcebe167ad6c5ad4f8029c85fa266614af"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY4OTY1OA==", "bodyText": "Recommend removing this constructor. This class is always deserialized from json", "url": "https://github.com/apache/pinot/pull/6150#discussion_r506689658", "createdAt": "2020-10-16T19:50:00Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-spi/src/main/java/org/apache/pinot/spi/config/instance/Instance.java", "diffHunk": "@@ -38,29 +38,40 @@\n  *   \"tags\": [\"example_OFFLINE\"],\n  *   \"pools\": {\n  *     \"example_OFFLINE\": 0\n- *   }\n+ *   },\n+ *   \"grpcPort\": 8090\n  * }\n  * </pre>\n  */\n public class Instance extends BaseJsonConfig {\n+  public static int NOT_SET_GRPC_PORT_VALUE = -1;\n+\n   private final String _host;\n   private final int _port;\n   private final InstanceType _type;\n   private final List<String> _tags;\n   private final Map<String, Integer> _pools;\n+  private final int _grpcPort;\n+\n+\n+  public Instance(String host, int port, InstanceType type, List<String> tags, Map<String, Integer> pools) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9796cbfcebe167ad6c5ad4f8029c85fa266614af"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "845320e1881315f9a682a71c0bd17d0932f0d085", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/845320e1881315f9a682a71c0bd17d0932f0d085", "committedDate": "2020-10-16T22:01:00Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwODU1MTQx", "url": "https://github.com/apache/pinot/pull/6150#pullrequestreview-510855141", "createdAt": "2020-10-17T00:18:27Z", "commit": {"oid": "845320e1881315f9a682a71c0bd17d0932f0d085"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3071bab71aa38a67f964e79a455a3222eabac95d", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/3071bab71aa38a67f964e79a455a3222eabac95d", "committedDate": "2020-10-17T19:51:31Z", "message": "make grpcPort returns -1 if not set"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1606, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}