{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg0NzExODA3", "number": 6002, "title": "Fixing S3PinotFS List API returned partial results", "bodyText": "Description\nS3 API has a bounded limit(1000) for the objects returned in ListObject API, which means each call may at most returned 1000 S3 objects.\nThis PR will check ListObjectsV2Response and fetch next batch when necessary.\nAWS API Ref: https://docs.aws.amazon.com/AmazonS3/latest/API/API_ListObjectsV2.html", "createdAt": "2020-09-11T06:45:34Z", "url": "https://github.com/apache/pinot/pull/6002", "merged": true, "mergeCommit": {"oid": "11fd62b77d84ba714828d0f85341e205f83c6c4e"}, "closed": true, "closedAt": "2020-09-11T09:37:46Z", "author": {"login": "xiangfu0"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHvwCngFqTQ4NjUxNzg5OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHv9h5gBqjM3NTQ2NzY3ODE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NTE3ODk4", "url": "https://github.com/apache/pinot/pull/6002#pullrequestreview-486517898", "createdAt": "2020-09-11T06:52:34Z", "commit": {"oid": "86659186e8e2196b199a5c2bb011dd560a5a524f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwNjo1MjozNFrOHQQjcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwNjo1MjozNFrOHQQjcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgxMDQ4Mw==", "bodyText": "will be good to log the total number of files listed as info", "url": "https://github.com/apache/pinot/pull/6002#discussion_r486810483", "createdAt": "2020-09-11T06:52:34Z", "author": {"login": "kishoreg"}, "path": "pinot-plugins/pinot-file-system/pinot-s3/src/main/java/org/apache/pinot/plugin/filesystem/S3PinotFS.java", "diffHunk": "@@ -374,33 +375,39 @@ public long length(URI fileUri)\n       throws IOException {\n     try {\n       ImmutableList.Builder<String> builder = ImmutableList.builder();\n+      String continuationToken = null;\n+      boolean isDone = false;\n       String prefix = normalizeToDirectoryPrefix(fileUri);\n-\n-      ListObjectsV2Response listObjectsV2Response;\n-      ListObjectsV2Request.Builder listObjectsV2RequestBuilder =\n-          ListObjectsV2Request.builder().bucket(fileUri.getHost());\n-\n-      if (!prefix.equals(DELIMITER)) {\n-        listObjectsV2RequestBuilder = listObjectsV2RequestBuilder.prefix(prefix);\n-      }\n-\n-      if (!recursive) {\n-        listObjectsV2RequestBuilder = listObjectsV2RequestBuilder.delimiter(DELIMITER);\n-      }\n-\n-      ListObjectsV2Request listObjectsV2Request = listObjectsV2RequestBuilder.build();\n-      listObjectsV2Response = _s3Client.listObjectsV2(listObjectsV2Request);\n-\n-      listObjectsV2Response.contents().stream().forEach(object -> {\n-        //Only add files and not directories\n-        if (!object.key().equals(fileUri.getPath()) && !object.key().endsWith(DELIMITER)) {\n-          String fileKey = object.key();\n-          if (fileKey.startsWith(DELIMITER)) {\n-            fileKey = fileKey.substring(1);\n-          }\n-          builder.add(S3_SCHEME + fileUri.getHost() + DELIMITER + fileKey);\n+      while(!isDone) {\n+        ListObjectsV2Request.Builder listObjectsV2RequestBuilder =\n+            ListObjectsV2Request.builder().bucket(fileUri.getHost());\n+        if (!prefix.equals(DELIMITER)) {\n+          listObjectsV2RequestBuilder = listObjectsV2RequestBuilder.prefix(prefix);\n+        }\n+        if (!recursive) {\n+          listObjectsV2RequestBuilder = listObjectsV2RequestBuilder.delimiter(DELIMITER);\n         }\n-      });\n+        if (continuationToken != null) {\n+          listObjectsV2RequestBuilder.continuationToken(continuationToken);\n+        }\n+        ListObjectsV2Request listObjectsV2Request = listObjectsV2RequestBuilder.build();\n+        LOGGER.debug(\"Trying to send ListObjectsV2Request {}\", listObjectsV2Request);\n+        ListObjectsV2Response listObjectsV2Response = _s3Client.listObjectsV2(listObjectsV2Request);\n+        LOGGER.debug(\"Getting ListObjectsV2Response: {}\", listObjectsV2Response);\n+        List<S3Object> filesReturned = listObjectsV2Response.contents();\n+        filesReturned.stream().forEach(object -> {\n+          //Only add files and not directories\n+          if (!object.key().equals(fileUri.getPath()) && !object.key().endsWith(DELIMITER)) {\n+            String fileKey = object.key();\n+            if (fileKey.startsWith(DELIMITER)) {\n+              fileKey = fileKey.substring(1);\n+            }\n+            builder.add(S3_SCHEME + fileUri.getHost() + DELIMITER + fileKey);\n+          }\n+        });\n+        isDone = !listObjectsV2Response.isTruncated();\n+        continuationToken = listObjectsV2Response.nextContinuationToken();\n+      }\n       return builder.build().toArray(new String[0]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86659186e8e2196b199a5c2bb011dd560a5a524f"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02269258463cb2aa1e70c01503cdc60bce14bb0f", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/02269258463cb2aa1e70c01503cdc60bce14bb0f", "committedDate": "2020-09-11T07:07:16Z", "message": "Fix S3PinotFS List API may not return full results"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "86659186e8e2196b199a5c2bb011dd560a5a524f", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/86659186e8e2196b199a5c2bb011dd560a5a524f", "committedDate": "2020-09-11T06:38:37Z", "message": "Fix S3PinotFS List API may not return full results"}, "afterCommit": {"oid": "02269258463cb2aa1e70c01503cdc60bce14bb0f", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/02269258463cb2aa1e70c01503cdc60bce14bb0f", "committedDate": "2020-09-11T07:07:16Z", "message": "Fix S3PinotFS List API may not return full results"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 12, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}