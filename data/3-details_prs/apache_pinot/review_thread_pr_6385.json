{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ1NTU0NTc4", "number": 6385, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNVQyMToxNjo0N1rOFJMB5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yN1QxODowOTo0N1rOFJYdBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ1MTc4NTk4OnYy", "diffSide": "RIGHT", "path": "pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNVQyMToxNjo0N1rOILe9tA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQwOToxOToxOVrOILiCyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxMjU2NA==", "bodyText": "this one assumes the tar file is on local disk, which may not be true always. E.g. the tar file could be on S3.\nThe path is s3://<my-bucket>/<my-tar>.tar.gz\nIn this case, you need to use PinotFs to delete the tar file.", "url": "https://github.com/apache/pinot/pull/6385#discussion_r548912564", "createdAt": "2020-12-25T21:16:47Z", "author": {"login": "xiangfu0"}, "path": "pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java", "diffHunk": "@@ -134,6 +135,8 @@ public static void pushSegments(SegmentGenerationJobSpec spec, PinotFS fileSyste\n                       segmentName, controllerURI, e);\n               throw e;\n             }\n+          } finally {\n+            FileUtils.deleteQuietly(tarFile);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "940328dd79b122777379e4d4713c589370dec6ec"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk2MzAxNg==", "bodyText": "Thanks for the review and pointing out to use PinotFS. Fixed.", "url": "https://github.com/apache/pinot/pull/6385#discussion_r548963016", "createdAt": "2020-12-26T09:19:19Z", "author": {"login": "amarnathkarthik"}, "path": "pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java", "diffHunk": "@@ -134,6 +135,8 @@ public static void pushSegments(SegmentGenerationJobSpec spec, PinotFS fileSyste\n                       segmentName, controllerURI, e);\n               throw e;\n             }\n+          } finally {\n+            FileUtils.deleteQuietly(tarFile);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxMjU2NA=="}, "originalCommit": {"oid": "940328dd79b122777379e4d4713c589370dec6ec"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ1MTc4NjE5OnYy", "diffSide": "RIGHT", "path": "pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNVQyMToxNjo1OFrOILe9yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQwOToxOToyN1rOILiCzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxMjU4Nw==", "bodyText": "Same above.", "url": "https://github.com/apache/pinot/pull/6385#discussion_r548912587", "createdAt": "2020-12-25T21:16:58Z", "author": {"login": "xiangfu0"}, "path": "pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java", "diffHunk": "@@ -183,6 +187,8 @@ public static void sendSegmentUris(SegmentGenerationJobSpec spec, List<String> s\n                   tableName, segmentUri, controllerURI, e);\n               throw e;\n             }\n+          } finally {\n+            FileUtils.deleteQuietly(segmentPath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "940328dd79b122777379e4d4713c589370dec6ec"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk2MzAyMA==", "bodyText": "Fixed", "url": "https://github.com/apache/pinot/pull/6385#discussion_r548963020", "createdAt": "2020-12-26T09:19:27Z", "author": {"login": "amarnathkarthik"}, "path": "pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java", "diffHunk": "@@ -183,6 +187,8 @@ public static void sendSegmentUris(SegmentGenerationJobSpec spec, List<String> s\n                   tableName, segmentUri, controllerURI, e);\n               throw e;\n             }\n+          } finally {\n+            FileUtils.deleteQuietly(segmentPath);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxMjU4Nw=="}, "originalCommit": {"oid": "940328dd79b122777379e4d4713c589370dec6ec"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ1MTc4ODM3OnYy", "diffSide": "RIGHT", "path": "pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNVQyMToyMTowNVrOILe-uQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQwOToyMTowN1rOILiDJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxMjgyNQ==", "bodyText": "Please use flag to turn on/off this deletion.", "url": "https://github.com/apache/pinot/pull/6385#discussion_r548912825", "createdAt": "2020-12-25T21:21:05Z", "author": {"login": "xiangfu0"}, "path": "pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java", "diffHunk": "@@ -134,6 +135,8 @@ public static void pushSegments(SegmentGenerationJobSpec spec, PinotFS fileSyste\n                       segmentName, controllerURI, e);\n               throw e;\n             }\n+          } finally {\n+            FileUtils.deleteQuietly(tarFile);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "940328dd79b122777379e4d4713c589370dec6ec"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk2MzExMQ==", "bodyText": "Added _cleanUpOutputDir in jobSpec and defaults to false. Have tested for jobType SegmentCreationAndTarPush and SegmentCreationAndUriPush with _cleanUpOutputDir=true/false", "url": "https://github.com/apache/pinot/pull/6385#discussion_r548963111", "createdAt": "2020-12-26T09:21:07Z", "author": {"login": "amarnathkarthik"}, "path": "pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java", "diffHunk": "@@ -134,6 +135,8 @@ public static void pushSegments(SegmentGenerationJobSpec spec, PinotFS fileSyste\n                       segmentName, controllerURI, e);\n               throw e;\n             }\n+          } finally {\n+            FileUtils.deleteQuietly(tarFile);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxMjgyNQ=="}, "originalCommit": {"oid": "940328dd79b122777379e4d4713c589370dec6ec"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ1MzgyMTUwOnYy", "diffSide": "RIGHT", "path": "pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yN1QxODowOTo0N1rOILtTXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yN1QxOToxMjoyM1rOILtqqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTE0NzQ4Ng==", "bodyText": "Any specific reason to create this variable, as opposed to using spec.isCleanupOutputDir() inline, given that it is just used in one place?", "url": "https://github.com/apache/pinot/pull/6385#discussion_r549147486", "createdAt": "2020-12-27T18:09:47Z", "author": {"login": "mayankshriv"}, "path": "pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java", "diffHunk": "@@ -87,6 +89,7 @@ public static URI generateSegmentTarURI(URI dirURI, URI fileURI, String prefix,\n   public static void pushSegments(SegmentGenerationJobSpec spec, PinotFS fileSystem, List<String> tarFilePaths)\n       throws RetriableOperationException, AttemptsExceededException {\n     String tableName = spec.getTableSpec().getTableName();\n+    boolean cleanUpOutputDir = spec.isCleanUpOutputDir();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8cbe1b9cd3be11e4a618e95ac5884a8ac1690af"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTE1MzQ0OA==", "bodyText": "For readability and spec.isCleanUpOutputDir() is a kind of constant within the method which does not change in the nested for-loop thought defining a variable in outer scope will be helpful. Let me know if you would want to just go with  spec.isCleanUpOutputDir().", "url": "https://github.com/apache/pinot/pull/6385#discussion_r549153448", "createdAt": "2020-12-27T19:12:23Z", "author": {"login": "amarnathkarthik"}, "path": "pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java", "diffHunk": "@@ -87,6 +89,7 @@ public static URI generateSegmentTarURI(URI dirURI, URI fileURI, String prefix,\n   public static void pushSegments(SegmentGenerationJobSpec spec, PinotFS fileSystem, List<String> tarFilePaths)\n       throws RetriableOperationException, AttemptsExceededException {\n     String tableName = spec.getTableSpec().getTableName();\n+    boolean cleanUpOutputDir = spec.isCleanUpOutputDir();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTE0NzQ4Ng=="}, "originalCommit": {"oid": "e8cbe1b9cd3be11e4a618e95ac5884a8ac1690af"}, "originalPosition": 22}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3056, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}