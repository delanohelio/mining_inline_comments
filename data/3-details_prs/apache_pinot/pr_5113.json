{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzOTk5NDEx", "number": 5113, "title": "[TE] added a couple of validations to check if detection is subscribed & valid; cleaned up other validations", "bodyText": "Validations added:\n\nMake sure subscription group subscribes to the detectionName while creating an alert\nMake sure all the subscribed detections are valid\nrecipients should be configured under the EMAIL scheme params and not at the root level\n\nValidations removed:\n\ntype is not compulsory in subscription group\ntype is not compulsory for sub-entity alerts.\n\nAdded unit tests for newly added validations", "createdAt": "2020-03-05T00:23:13Z", "url": "https://github.com/apache/pinot/pull/5113", "merged": true, "mergeCommit": {"oid": "8ec849968f6025ca471929b6861c0ae1b5f993d0"}, "closed": true, "closedAt": "2020-03-06T17:46:49Z", "author": {"login": "akshayrai"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKgVAhABqjMwOTkxOTAzOTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcLDuZ3gFqTM3MDUwNTc3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c7fc6df4a92ea544f99fd9e0c7724069e38cd327", "author": {"user": {"login": "akshayrai", "name": "Akshay Rai"}}, "url": "https://github.com/apache/pinot/commit/c7fc6df4a92ea544f99fd9e0c7724069e38cd327", "committedDate": "2020-03-05T00:15:22Z", "message": "[TE] add validation to check if detection is subscribed before creating a new alert; clean up older validations"}, "afterCommit": {"oid": "f09723800f0f71f8237ce6bbcc31788e409d77f6", "author": {"user": {"login": "akshayrai", "name": "Akshay Rai"}}, "url": "https://github.com/apache/pinot/commit/f09723800f0f71f8237ce6bbcc31788e409d77f6", "committedDate": "2020-03-05T00:24:59Z", "message": "[TE] add validation to check if detection is subscribed before creating a new alert; clean up older validations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NzI1MTM4", "url": "https://github.com/apache/pinot/pull/5113#pullrequestreview-369725138", "createdAt": "2020-03-05T16:33:50Z", "commit": {"oid": "f09723800f0f71f8237ce6bbcc31788e409d77f6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNjozMzo1MFrOFya2Rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNjozMzo1MFrOFya2Rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQxMjk5OQ==", "bodyText": "There are some use cases (e.g, DHM) that they only want to create alert w/o subscription groups.", "url": "https://github.com/apache/pinot/pull/5113#discussion_r388412999", "createdAt": "2020-03-05T16:33:50Z", "author": {"login": "xiaohui-sun"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/yaml/YamlResource.java", "diffHunk": "@@ -262,6 +263,23 @@ private Response processBadAuthorizationResponse(String type, String operation,\n     return Response.status(Response.Status.UNAUTHORIZED).entity(responseMessage).build();\n   }\n \n+  /**\n+   * Perform some basic validations on the create alert payload\n+   */\n+  public void validateCreateAlertYaml(Map<String, String> config) throws IOException {\n+    Preconditions.checkArgument(config.containsKey(PROP_DETECTION), \"Detection pipeline yaml is missing\");\n+    Preconditions.checkArgument(config.containsKey(PROP_SUBSCRIPTION), \"Subscription group yaml is missing.\");\n+\n+    // check if subscription group has subscribed to the detection\n+    Map<String, Object> detectionConfigMap = new HashMap<>(ConfigUtils.getMap(this.yaml.load(config.get(PROP_DETECTION))));\n+    String detectionName = MapUtils.getString(detectionConfigMap, PROP_DETECTION_NAME);\n+    Map<String, Object> subscriptionConfigMap = new HashMap<>(ConfigUtils.getMap(this.yaml.load(config.get(PROP_SUBSCRIPTION))));\n+    List<String> detectionNames = ConfigUtils.getList(subscriptionConfigMap.get(PROP_DETECTION_NAMES));\n+    Preconditions.checkArgument(detectionNames.contains(detectionName),\n+        \"You have not subscribed to the alert. Please copy-paste the detectionName under the \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f09723800f0f71f8237ce6bbcc31788e409d77f6"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca720c22d9fec05d3690fd2ec1ba8dfb9bcdd071", "author": {"user": {"login": "akshayrai", "name": "Akshay Rai"}}, "url": "https://github.com/apache/pinot/commit/ca720c22d9fec05d3690fd2ec1ba8dfb9bcdd071", "committedDate": "2020-03-05T18:18:24Z", "message": "[TE] add validation to check if detection is subscribed before creating a new alert; clean up older validations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f09723800f0f71f8237ce6bbcc31788e409d77f6", "author": {"user": {"login": "akshayrai", "name": "Akshay Rai"}}, "url": "https://github.com/apache/pinot/commit/f09723800f0f71f8237ce6bbcc31788e409d77f6", "committedDate": "2020-03-05T00:24:59Z", "message": "[TE] add validation to check if detection is subscribed before creating a new alert; clean up older validations"}, "afterCommit": {"oid": "ca720c22d9fec05d3690fd2ec1ba8dfb9bcdd071", "author": {"user": {"login": "akshayrai", "name": "Akshay Rai"}}, "url": "https://github.com/apache/pinot/commit/ca720c22d9fec05d3690fd2ec1ba8dfb9bcdd071", "committedDate": "2020-03-05T18:18:24Z", "message": "[TE] add validation to check if detection is subscribed before creating a new alert; clean up older validations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9866af80fd64d55de2212da64f39ef34ed16ac2e", "author": {"user": {"login": "akshayrai", "name": "Akshay Rai"}}, "url": "https://github.com/apache/pinot/commit/9866af80fd64d55de2212da64f39ef34ed16ac2e", "committedDate": "2020-03-05T19:44:15Z", "message": "rebase changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNTA1Nzc4", "url": "https://github.com/apache/pinot/pull/5113#pullrequestreview-370505778", "createdAt": "2020-03-06T17:39:39Z", "commit": {"oid": "9866af80fd64d55de2212da64f39ef34ed16ac2e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1334, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}