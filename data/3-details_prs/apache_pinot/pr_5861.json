{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3NzEzOTky", "number": 5861, "title": "[TE] merge time series snapshot when merging anomalies", "bodyText": "This PR is to provide quick fix for merging time series snapshot when merging anomalies.", "createdAt": "2020-08-14T01:15:39Z", "url": "https://github.com/apache/pinot/pull/5861", "merged": true, "mergeCommit": {"oid": "7eff80672cfa0229a0dce5bc0d324fbe28f3a7ba"}, "closed": true, "closedAt": "2020-08-17T20:28:12Z", "author": {"login": "vincentchenjl"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-qD_5AH2gAyNDY3NzEzOTkyOmFkMmVhNTc2YTU2MTliNzA4YjRmNmEwMTY0ZmZlNTVhZjI3NjI2YmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc_4bfGgFqTQ2ODgwOTc1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ad2ea576a5619b708b4f6a0164ffe55af27626bb", "author": {"user": {"login": "vincentchenjl", "name": "Vincent Chen"}}, "url": "https://github.com/apache/pinot/commit/ad2ea576a5619b708b4f6a0164ffe55af27626bb", "committedDate": "2020-08-14T01:09:46Z", "message": "[TE] merge time series snapshot when merging anomalies"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NzkwNDI2", "url": "https://github.com/apache/pinot/pull/5861#pullrequestreview-467790426", "createdAt": "2020-08-14T18:23:56Z", "commit": {"oid": "ad2ea576a5619b708b4f6a0164ffe55af27626bb"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxODoyMzo1N1rOHA-qJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxODoyOToxM1rOHA-7lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc4ODY0Ng==", "bodyText": "Probably better to compare with absolute difference: abs(actual - expected) < 0.00001. Or better:\nwe can use Assert.assertEquals(actual, expected, delta)", "url": "https://github.com/apache/pinot/pull/5861#discussion_r470788646", "createdAt": "2020-08-14T18:23:57Z", "author": {"login": "Ruoyingw"}, "path": "thirdeye/thirdeye-pinot/src/test/java/org/apache/pinot/thirdeye/util/ThirdEyeUtilsTest.java", "diffHunk": "@@ -176,21 +179,51 @@ public void testExceptionToStringLimited() {\n   }\n \n   @Test\n-  public void testMergeAnomalyProperties() {\n+  public void testMergeAnomalyProperties() throws Exception {\n+    final long now = System.currentTimeMillis();\n+    final long bucketSize = 300_000;\n+    final double parentVal = 1.0, childVal = 2.0;\n+\n     Map<String, String> parentProperties = new HashMap<>();\n     parentProperties.put(\"p1\", \"value1\");\n     parentProperties.put(\"p2\", \"value2\");\n     parentProperties.put(\"detectorComponentName\", \"rule1\");\n+    parentProperties.put(\"anomalyTimelinesView\",\n+        generateAnomalyTimelineView(now, bucketSize, 10, parentVal).toJsonString());\n+\n \n     Map<String, String> childProperties = new HashMap<>();\n     childProperties.put(\"p1\", \"value3\");\n     childProperties.put(\"c1\", \"value4\");\n     childProperties.put(\"detectorComponentName\", \"rule2\");\n+    childProperties.put(\"anomalyTimelinesView\",\n+        generateAnomalyTimelineView(now + bucketSize, bucketSize, 10,  childVal).toJsonString());\n \n     ThirdEyeUtils.mergeAnomalyProperties(parentProperties, childProperties);\n     Assert.assertEquals(parentProperties.get(\"p1\"), \"value1\");\n     Assert.assertEquals(parentProperties.get(\"p2\"), \"value2\");\n     Assert.assertEquals(parentProperties.get(\"c1\"), \"value4\");\n     Assert.assertEquals(parentProperties.get(\"detectorComponentName\"), \"rule1,rule2\");\n+    AnomalyTimelinesView merged = AnomalyTimelinesView.fromJsonString(parentProperties.get(\"anomalyTimelinesView\"));\n+    Assert.assertEquals(merged.getTimeBuckets().size(), 11);\n+    Assert.assertTrue(merged.getCurrentValues().get(0) - parentVal < 0.00001);\n+    Assert.assertTrue(merged.getCurrentValues().get(1) - parentVal < 0.00001);\n+    Assert.assertTrue(merged.getCurrentValues().get(10) - childVal < 0.00001);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad2ea576a5619b708b4f6a0164ffe55af27626bb"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc5MzExMA==", "bodyText": "Can we add another unit test case where the child anomaly has a gap with parent? say\nchildProperties.put(\"anomalyTimelinesView\", generateAnomalyTimelineView(now + bucketSize * 20, bucketSize, 10,  childVal).toJsonString());", "url": "https://github.com/apache/pinot/pull/5861#discussion_r470793110", "createdAt": "2020-08-14T18:29:13Z", "author": {"login": "Ruoyingw"}, "path": "thirdeye/thirdeye-pinot/src/test/java/org/apache/pinot/thirdeye/util/ThirdEyeUtilsTest.java", "diffHunk": "@@ -176,21 +179,51 @@ public void testExceptionToStringLimited() {\n   }\n \n   @Test\n-  public void testMergeAnomalyProperties() {\n+  public void testMergeAnomalyProperties() throws Exception {\n+    final long now = System.currentTimeMillis();\n+    final long bucketSize = 300_000;\n+    final double parentVal = 1.0, childVal = 2.0;\n+\n     Map<String, String> parentProperties = new HashMap<>();\n     parentProperties.put(\"p1\", \"value1\");\n     parentProperties.put(\"p2\", \"value2\");\n     parentProperties.put(\"detectorComponentName\", \"rule1\");\n+    parentProperties.put(\"anomalyTimelinesView\",\n+        generateAnomalyTimelineView(now, bucketSize, 10, parentVal).toJsonString());\n+\n \n     Map<String, String> childProperties = new HashMap<>();\n     childProperties.put(\"p1\", \"value3\");\n     childProperties.put(\"c1\", \"value4\");\n     childProperties.put(\"detectorComponentName\", \"rule2\");\n+    childProperties.put(\"anomalyTimelinesView\",\n+        generateAnomalyTimelineView(now + bucketSize, bucketSize, 10,  childVal).toJsonString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad2ea576a5619b708b4f6a0164ffe55af27626bb"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3ODA3MjAw", "url": "https://github.com/apache/pinot/pull/5861#pullrequestreview-467807200", "createdAt": "2020-08-14T18:53:20Z", "commit": {"oid": "ad2ea576a5619b708b4f6a0164ffe55af27626bb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0348d62d5ad8b64073b874c0cb8041b23a6d51ab", "author": {"user": {"login": "vincentchenjl", "name": "Vincent Chen"}}, "url": "https://github.com/apache/pinot/commit/0348d62d5ad8b64073b874c0cb8041b23a6d51ab", "committedDate": "2020-08-14T22:20:48Z", "message": "add one more test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4ODA5NzU4", "url": "https://github.com/apache/pinot/pull/5861#pullrequestreview-468809758", "createdAt": "2020-08-17T20:28:01Z", "commit": {"oid": "0348d62d5ad8b64073b874c0cb8041b23a6d51ab"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 177, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}