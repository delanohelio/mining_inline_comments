{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyNDEwODA3", "number": 4979, "reviewThreads": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwMjo1MzoxMVrODXuEZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQyMjo1NjowMFrODZEr0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2MTk4NjI5OnYy", "diffSide": "RIGHT", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/HelixExternalViewBasedQueryQuotaManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwMjo1MzoxMVrOFdK5RA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwMjo1MzoxMVrOFdK5RA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEzMTUyNA==", "bodyText": "You may cache it at class level as a member variable", "url": "https://github.com/apache/pinot/pull/4979#discussion_r366131524", "createdAt": "2020-01-14T02:53:11Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/HelixExternalViewBasedQueryQuotaManager.java", "diffHunk": "@@ -78,17 +81,18 @@ public void initTableQueryQuota(TableConfig tableConfig, ExternalView brokerReso\n     String tableNameWithType = tableConfig.getTableName();\n     String rawTableName = TableNameBuilder.extractRawTableName(tableNameWithType);\n     LOGGER.info(\"Initializing rate limiter for table {}\", tableNameWithType);\n+    ZkHelixPropertyStore<ZNRecord> propertyStore = _helixManager.getHelixPropertyStore();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2733c542c0b9a430baeae9a2173aa41ede5c2fb"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2MTk5MTY4OnYy", "diffSide": "RIGHT", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/HelixExternalViewBasedQueryQuotaManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwMjo1NjozNVrOFdK8eg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwMDo1Nzo0NFrOFesHKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEzMjM0Ng==", "bodyText": "Could this message flood the log?", "url": "https://github.com/apache/pinot/pull/4979#discussion_r366132346", "createdAt": "2020-01-14T02:56:35Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/HelixExternalViewBasedQueryQuotaManager.java", "diffHunk": "@@ -323,11 +322,34 @@ public void processQueryQuotaChange() {\n       }\n       int onlineBrokerCount = otherOnlineBrokerCount + 1;\n \n+      // Get stat from property store\n+      String tableConfigPath = constructTableConfigPath(rawTableName, tableType);\n+      Stat stat = propertyStore.getStat(tableConfigPath, AccessOption.PERSISTENT);\n+      if (onlineBrokerCount == queryQuotaConfig.getNumOnlineBrokers() && stat.getVersion() == queryQuotaConfig\n+          .getTableConfigStatVersion()) {\n+        LOGGER.info(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2733c542c0b9a430baeae9a2173aa41ede5c2fb"}, "originalPosition": 116}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzcyNDMyOQ==", "bodyText": "Removed.", "url": "https://github.com/apache/pinot/pull/4979#discussion_r367724329", "createdAt": "2020-01-17T00:57:44Z", "author": {"login": "jackjlli"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/HelixExternalViewBasedQueryQuotaManager.java", "diffHunk": "@@ -323,11 +322,34 @@ public void processQueryQuotaChange() {\n       }\n       int onlineBrokerCount = otherOnlineBrokerCount + 1;\n \n+      // Get stat from property store\n+      String tableConfigPath = constructTableConfigPath(rawTableName, tableType);\n+      Stat stat = propertyStore.getStat(tableConfigPath, AccessOption.PERSISTENT);\n+      if (onlineBrokerCount == queryQuotaConfig.getNumOnlineBrokers() && stat.getVersion() == queryQuotaConfig\n+          .getTableConfigStatVersion()) {\n+        LOGGER.info(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEzMjM0Ng=="}, "originalCommit": {"oid": "c2733c542c0b9a430baeae9a2173aa41ede5c2fb"}, "originalPosition": 116}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2MjAwMTUzOnYy", "diffSide": "RIGHT", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/HelixExternalViewBasedQueryQuotaManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwMzowNTo0MVrOFdLC0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwMDo1NzozNVrOFesG-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEzMzk3MQ==", "bodyText": "This might be null if table got deleted", "url": "https://github.com/apache/pinot/pull/4979#discussion_r366133971", "createdAt": "2020-01-14T03:05:41Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/HelixExternalViewBasedQueryQuotaManager.java", "diffHunk": "@@ -323,11 +322,34 @@ public void processQueryQuotaChange() {\n       }\n       int onlineBrokerCount = otherOnlineBrokerCount + 1;\n \n+      // Get stat from property store\n+      String tableConfigPath = constructTableConfigPath(rawTableName, tableType);\n+      Stat stat = propertyStore.getStat(tableConfigPath, AccessOption.PERSISTENT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2733c542c0b9a430baeae9a2173aa41ede5c2fb"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzcyNDI4MQ==", "bodyText": "Updated.", "url": "https://github.com/apache/pinot/pull/4979#discussion_r367724281", "createdAt": "2020-01-17T00:57:35Z", "author": {"login": "jackjlli"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/HelixExternalViewBasedQueryQuotaManager.java", "diffHunk": "@@ -323,11 +322,34 @@ public void processQueryQuotaChange() {\n       }\n       int onlineBrokerCount = otherOnlineBrokerCount + 1;\n \n+      // Get stat from property store\n+      String tableConfigPath = constructTableConfigPath(rawTableName, tableType);\n+      Stat stat = propertyStore.getStat(tableConfigPath, AccessOption.PERSISTENT);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEzMzk3MQ=="}, "originalCommit": {"oid": "c2733c542c0b9a430baeae9a2173aa41ede5c2fb"}, "originalPosition": 113}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2MjAwMzAxOnYy", "diffSide": "RIGHT", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/HelixExternalViewBasedQueryQuotaManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwMzowNjo1NlrOFdLDrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwMDo1NzoxOVrOFesGvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEzNDE4OA==", "bodyText": "You don't need to fetch a new quota config if version matches but numOnlineBrokers changed", "url": "https://github.com/apache/pinot/pull/4979#discussion_r366134188", "createdAt": "2020-01-14T03:06:56Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/HelixExternalViewBasedQueryQuotaManager.java", "diffHunk": "@@ -323,11 +322,34 @@ public void processQueryQuotaChange() {\n       }\n       int onlineBrokerCount = otherOnlineBrokerCount + 1;\n \n+      // Get stat from property store\n+      String tableConfigPath = constructTableConfigPath(rawTableName, tableType);\n+      Stat stat = propertyStore.getStat(tableConfigPath, AccessOption.PERSISTENT);\n+      if (onlineBrokerCount == queryQuotaConfig.getNumOnlineBrokers() && stat.getVersion() == queryQuotaConfig\n+          .getTableConfigStatVersion()) {\n+        LOGGER.info(\n+            \"Number of brokers remains the same. Table config remains the same. No need to update quota for Table {}.\",\n+            tableNameWithType);\n+        continue;\n+      }\n+\n+      // Get latest quota config for table.\n+      QuotaConfig quotaConfig = getQuotaConfigFromPropertyStore(propertyStore, rawTableName, tableType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2733c542c0b9a430baeae9a2173aa41ede5c2fb"}, "originalPosition": 123}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzcyNDIyMQ==", "bodyText": "Good idea. \ud83d\udc4d Done.", "url": "https://github.com/apache/pinot/pull/4979#discussion_r367724221", "createdAt": "2020-01-17T00:57:19Z", "author": {"login": "jackjlli"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/HelixExternalViewBasedQueryQuotaManager.java", "diffHunk": "@@ -323,11 +322,34 @@ public void processQueryQuotaChange() {\n       }\n       int onlineBrokerCount = otherOnlineBrokerCount + 1;\n \n+      // Get stat from property store\n+      String tableConfigPath = constructTableConfigPath(rawTableName, tableType);\n+      Stat stat = propertyStore.getStat(tableConfigPath, AccessOption.PERSISTENT);\n+      if (onlineBrokerCount == queryQuotaConfig.getNumOnlineBrokers() && stat.getVersion() == queryQuotaConfig\n+          .getTableConfigStatVersion()) {\n+        LOGGER.info(\n+            \"Number of brokers remains the same. Table config remains the same. No need to update quota for Table {}.\",\n+            tableNameWithType);\n+        continue;\n+      }\n+\n+      // Get latest quota config for table.\n+      QuotaConfig quotaConfig = getQuotaConfigFromPropertyStore(propertyStore, rawTableName, tableType);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEzNDE4OA=="}, "originalCommit": {"oid": "c2733c542c0b9a430baeae9a2173aa41ede5c2fb"}, "originalPosition": 123}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2MjAwNDI3OnYy", "diffSide": "RIGHT", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/QueryQuotaConfig.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwMzowODoyNFrOFdLEcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwMDo1NzowNFrOFesGiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEzNDM4Ng==", "bodyText": "(nit) remove the nonnull annotation", "url": "https://github.com/apache/pinot/pull/4979#discussion_r366134386", "createdAt": "2020-01-14T03:08:24Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/QueryQuotaConfig.java", "diffHunk": "@@ -20,16 +20,21 @@\n \n import com.google.common.util.concurrent.RateLimiter;\n import javax.annotation.Nonnull;\n+import org.apache.pinot.common.utils.CommonConstants;\n \n \n public class QueryQuotaConfig {\n \n   private RateLimiter _rateLimiter;\n   private HitCounter _hitCounter;\n+  private int _numOnlineBrokers;\n+  private int _tableConfigStatVersion;\n \n-  public QueryQuotaConfig(@Nonnull RateLimiter rateLimiter, @Nonnull HitCounter hitCounter) {\n+  public QueryQuotaConfig(@Nonnull RateLimiter rateLimiter, @Nonnull HitCounter hitCounter, @Nonnull int numOnlineBrokers, @Nonnull int tableConfigStatVersion) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2733c542c0b9a430baeae9a2173aa41ede5c2fb"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzcyNDE2OA==", "bodyText": "Done.", "url": "https://github.com/apache/pinot/pull/4979#discussion_r367724168", "createdAt": "2020-01-17T00:57:04Z", "author": {"login": "jackjlli"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/QueryQuotaConfig.java", "diffHunk": "@@ -20,16 +20,21 @@\n \n import com.google.common.util.concurrent.RateLimiter;\n import javax.annotation.Nonnull;\n+import org.apache.pinot.common.utils.CommonConstants;\n \n \n public class QueryQuotaConfig {\n \n   private RateLimiter _rateLimiter;\n   private HitCounter _hitCounter;\n+  private int _numOnlineBrokers;\n+  private int _tableConfigStatVersion;\n \n-  public QueryQuotaConfig(@Nonnull RateLimiter rateLimiter, @Nonnull HitCounter hitCounter) {\n+  public QueryQuotaConfig(@Nonnull RateLimiter rateLimiter, @Nonnull HitCounter hitCounter, @Nonnull int numOnlineBrokers, @Nonnull int tableConfigStatVersion) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEzNDM4Ng=="}, "originalCommit": {"oid": "c2733c542c0b9a430baeae9a2173aa41ede5c2fb"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NjE2NTI5OnYy", "diffSide": "RIGHT", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/HelixExternalViewBasedQueryQuotaManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQyMjozMzo1OVrOFfQ_Lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxNzo1ODoxOVrOFgDZAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMyODQ5NA==", "bodyText": "I remember some discussions from before that the property store handle is stale if helix loses zk connection. Has that assumption changed (or is my recollection wrong)? Helix code seems to be resetting the handle on disconnect() as well.", "url": "https://github.com/apache/pinot/pull/4979#discussion_r368328494", "createdAt": "2020-01-19T22:33:59Z", "author": {"login": "mcvsubbu"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/HelixExternalViewBasedQueryQuotaManager.java", "diffHunk": "@@ -122,15 +133,11 @@ private void removeRateLimiter(String tableNameWithType) {\n \n   /**\n    * Get QuotaConfig from property store.\n-   * @param rawTableName table name without table type.\n-   * @param tableType table type: offline or real-time.\n+   * @param tableNameWithType table name with table type.\n    * @return QuotaConfig, which could be null.\n    */\n-  private QuotaConfig getQuotaConfigFromPropertyStore(String rawTableName, CommonConstants.Helix.TableType tableType) {\n-    ZkHelixPropertyStore<ZNRecord> propertyStore = _helixManager.getHelixPropertyStore();\n-\n-    String tableNameWithType = TableNameBuilder.forType(tableType).tableNameWithType(rawTableName);\n-    TableConfig tableConfig = ZKMetadataProvider.getTableConfig(propertyStore, tableNameWithType);\n+  private QuotaConfig getQuotaConfigFromPropertyStore(String tableNameWithType) {\n+    TableConfig tableConfig = ZKMetadataProvider.getTableConfig(_propertyStore, tableNameWithType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "003d35ce828f1025a805704e3faf0d44bacbca1d"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE1NDMwNQ==", "bodyText": "Even when the zk connection is lost, some exceptions will be thrown. In that case, nothing change in this class. So it'd be fine here.", "url": "https://github.com/apache/pinot/pull/4979#discussion_r369154305", "createdAt": "2020-01-21T17:58:19Z", "author": {"login": "jackjlli"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/HelixExternalViewBasedQueryQuotaManager.java", "diffHunk": "@@ -122,15 +133,11 @@ private void removeRateLimiter(String tableNameWithType) {\n \n   /**\n    * Get QuotaConfig from property store.\n-   * @param rawTableName table name without table type.\n-   * @param tableType table type: offline or real-time.\n+   * @param tableNameWithType table name with table type.\n    * @return QuotaConfig, which could be null.\n    */\n-  private QuotaConfig getQuotaConfigFromPropertyStore(String rawTableName, CommonConstants.Helix.TableType tableType) {\n-    ZkHelixPropertyStore<ZNRecord> propertyStore = _helixManager.getHelixPropertyStore();\n-\n-    String tableNameWithType = TableNameBuilder.forType(tableType).tableNameWithType(rawTableName);\n-    TableConfig tableConfig = ZKMetadataProvider.getTableConfig(propertyStore, tableNameWithType);\n+  private QuotaConfig getQuotaConfigFromPropertyStore(String tableNameWithType) {\n+    TableConfig tableConfig = ZKMetadataProvider.getTableConfig(_propertyStore, tableNameWithType);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMyODQ5NA=="}, "originalCommit": {"oid": "003d35ce828f1025a805704e3faf0d44bacbca1d"}, "originalPosition": 89}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NjE2NjgwOnYy", "diffSide": "RIGHT", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/HelixExternalViewBasedQueryQuotaManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQyMjozNzoyMlrOFfQ_8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQyMjozNzoyMlrOFfQ_8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMyODY4OA==", "bodyText": "Add the version to the log line below", "url": "https://github.com/apache/pinot/pull/4979#discussion_r368328688", "createdAt": "2020-01-19T22:37:22Z", "author": {"login": "mcvsubbu"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/HelixExternalViewBasedQueryQuotaManager.java", "diffHunk": "@@ -180,10 +187,15 @@ private void createRateLimiter(String tableNameWithType, ExternalView brokerReso\n       return;\n     }\n \n+    // Get stat from property store\n+    String tableConfigPath = constructTableConfigPath(tableNameWithType);\n+    Stat stat = _propertyStore.getStat(tableConfigPath, AccessOption.PERSISTENT);\n+\n     double perBrokerRate = overallRate / onlineCount;\n-    QueryQuotaConfig queryQuotaConfig =\n-        new QueryQuotaConfig(RateLimiter.create(perBrokerRate), new HitCounter(TIME_RANGE_IN_SECOND));\n-    _rateLimiterMap.put(tableNameWithType, queryQuotaConfig);\n+    QueryQuotaEntity queryQuotaEntity =\n+        new QueryQuotaEntity(RateLimiter.create(perBrokerRate), new HitCounter(TIME_RANGE_IN_SECOND), onlineCount,\n+            overallRate, stat.getVersion());\n+    _rateLimiterMap.put(tableNameWithType, queryQuotaEntity);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "003d35ce828f1025a805704e3faf0d44bacbca1d"}, "originalPosition": 108}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NjE2OTA2OnYy", "diffSide": "RIGHT", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/HelixExternalViewBasedQueryQuotaManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQyMjo0MTo1N1rOFfRBJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQyMjo0MTo1N1rOFfRBJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMyODk5Ng==", "bodyText": "suggest rename currentBrokerResource to brokerResourceEV", "url": "https://github.com/apache/pinot/pull/4979#discussion_r368328996", "createdAt": "2020-01-19T22:41:57Z", "author": {"login": "mcvsubbu"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/HelixExternalViewBasedQueryQuotaManager.java", "diffHunk": "@@ -39,34 +41,43 @@\n import org.apache.pinot.common.metrics.BrokerMetrics;\n import org.apache.pinot.common.utils.CommonConstants;\n import org.apache.pinot.common.utils.helix.HelixHelper;\n+import org.apache.zookeeper.data.Stat;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import static org.apache.pinot.common.utils.CommonConstants.Helix.BROKER_RESOURCE_INSTANCE;\n-import static org.apache.pinot.common.utils.CommonConstants.Helix.TableType;\n-\n \n+/**\n+ * This class is to support the qps quota feature.\n+ * It depends on the broker source change to update the dynamic rate limit,\n+ *  which means it only gets updated when a new table added or a broker restarted.\n+ * TODO: support adding new rate limiter for existing tables without restarting the broker.\n+ */\n public class HelixExternalViewBasedQueryQuotaManager implements ClusterChangeHandler, QueryQuotaManager {\n   private static final Logger LOGGER = LoggerFactory.getLogger(HelixExternalViewBasedQueryQuotaManager.class);\n   private static final int TIME_RANGE_IN_SECOND = 1;\n \n   private final AtomicInteger _lastKnownBrokerResourceVersion = new AtomicInteger(-1);\n-  private final Map<String, QueryQuotaConfig> _rateLimiterMap = new ConcurrentHashMap<>();\n+  private final Map<String, QueryQuotaEntity> _rateLimiterMap = new ConcurrentHashMap<>();\n \n   private HelixManager _helixManager;\n+  private ZkHelixPropertyStore<ZNRecord> _propertyStore;\n   private BrokerMetrics _brokerMetrics;\n \n   @Override\n   public void init(HelixManager helixManager) {\n     Preconditions.checkState(_helixManager == null, \"HelixExternalViewBasedQueryQuotaManager is already initialized\");\n     _helixManager = helixManager;\n+    _propertyStore = _helixManager.getHelixPropertyStore();\n   }\n \n   @Override\n   public void processClusterChange(HelixConstants.ChangeType changeType) {\n     Preconditions\n         .checkState(changeType == HelixConstants.ChangeType.EXTERNAL_VIEW, \"Illegal change type: \" + changeType);\n-    processQueryQuotaChange();\n+    ExternalView currentBrokerResource = HelixHelper", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "003d35ce828f1025a805704e3faf0d44bacbca1d"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NjE3MTg4OnYy", "diffSide": "RIGHT", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/HelixExternalViewBasedQueryQuotaManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQyMjo0NzoxMFrOFfRCoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQyMjo0NzoxMFrOFfRCoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMyOTM3Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    LOGGER.info(\"Table {} gets deleted from property store. Removing its rate limit.\", tableNameWithType);\n          \n          \n            \n                    LOGGER.info(\"Table {} has been deleted from property store. Removing its rate limit.\", tableNameWithType);", "url": "https://github.com/apache/pinot/pull/4979#discussion_r368329377", "createdAt": "2020-01-19T22:47:10Z", "author": {"login": "mcvsubbu"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/HelixExternalViewBasedQueryQuotaManager.java", "diffHunk": "@@ -323,11 +321,43 @@ public void processQueryQuotaChange() {\n       }\n       int onlineBrokerCount = otherOnlineBrokerCount + 1;\n \n-      double overallRate = Double.parseDouble(quotaConfig.getMaxQueriesPerSecond());\n+      // Get stat from property store\n+      String tableConfigPath = constructTableConfigPath(tableNameWithType);\n+      Stat stat = _propertyStore.getStat(tableConfigPath, AccessOption.PERSISTENT);\n+      if (stat == null) {\n+        LOGGER.info(\"Table {} gets deleted from property store. Removing its rate limit.\", tableNameWithType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "003d35ce828f1025a805704e3faf0d44bacbca1d"}, "originalPosition": 228}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NjE3MzkyOnYy", "diffSide": "RIGHT", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/HelixExternalViewBasedQueryQuotaManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQyMjo1MDo1MlrOFfRDpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMTowNDowMlrOFfsDhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMyOTYzNw==", "bodyText": "It may be useful to add a log line here with the version", "url": "https://github.com/apache/pinot/pull/4979#discussion_r368329637", "createdAt": "2020-01-19T22:50:52Z", "author": {"login": "mcvsubbu"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/HelixExternalViewBasedQueryQuotaManager.java", "diffHunk": "@@ -323,11 +321,43 @@ public void processQueryQuotaChange() {\n       }\n       int onlineBrokerCount = otherOnlineBrokerCount + 1;\n \n-      double overallRate = Double.parseDouble(quotaConfig.getMaxQueriesPerSecond());\n+      // Get stat from property store\n+      String tableConfigPath = constructTableConfigPath(tableNameWithType);\n+      Stat stat = _propertyStore.getStat(tableConfigPath, AccessOption.PERSISTENT);\n+      if (stat == null) {\n+        LOGGER.info(\"Table {} gets deleted from property store. Removing its rate limit.\", tableNameWithType);\n+        it.remove();\n+        continue;\n+      }\n+\n+      // If number of online brokers and table config don't change, there is no need to re-calculate the dynamic rate.\n+      if (onlineBrokerCount == queryQuotaEntity.getNumOnlineBrokers() && stat.getVersion() == queryQuotaEntity\n+          .getTableConfigStatVersion()) {\n+        continue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "003d35ce828f1025a805704e3faf0d44bacbca1d"}, "originalPosition": 236}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc3MTk3Mg==", "bodyText": "It'll flush the log as there might be a lot of tables having qps quotas and their dynamic rate limiters don't need to be changed.", "url": "https://github.com/apache/pinot/pull/4979#discussion_r368771972", "createdAt": "2020-01-21T01:04:02Z", "author": {"login": "jackjlli"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/HelixExternalViewBasedQueryQuotaManager.java", "diffHunk": "@@ -323,11 +321,43 @@ public void processQueryQuotaChange() {\n       }\n       int onlineBrokerCount = otherOnlineBrokerCount + 1;\n \n-      double overallRate = Double.parseDouble(quotaConfig.getMaxQueriesPerSecond());\n+      // Get stat from property store\n+      String tableConfigPath = constructTableConfigPath(tableNameWithType);\n+      Stat stat = _propertyStore.getStat(tableConfigPath, AccessOption.PERSISTENT);\n+      if (stat == null) {\n+        LOGGER.info(\"Table {} gets deleted from property store. Removing its rate limit.\", tableNameWithType);\n+        it.remove();\n+        continue;\n+      }\n+\n+      // If number of online brokers and table config don't change, there is no need to re-calculate the dynamic rate.\n+      if (onlineBrokerCount == queryQuotaEntity.getNumOnlineBrokers() && stat.getVersion() == queryQuotaEntity\n+          .getTableConfigStatVersion()) {\n+        continue;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMyOTYzNw=="}, "originalCommit": {"oid": "003d35ce828f1025a805704e3faf0d44bacbca1d"}, "originalPosition": 236}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NjE3NzQ2OnYy", "diffSide": "RIGHT", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/HelixExternalViewBasedQueryQuotaManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQyMjo1NjowMFrOFfRFbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwMToxMzoyNVrOFfsJlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMzMDA5Mg==", "bodyText": "Even if we don't update the rate due to small difference, should we not update the tableConfigStatVersion?", "url": "https://github.com/apache/pinot/pull/4979#discussion_r368330092", "createdAt": "2020-01-19T22:56:00Z", "author": {"login": "mcvsubbu"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/HelixExternalViewBasedQueryQuotaManager.java", "diffHunk": "@@ -323,11 +321,43 @@ public void processQueryQuotaChange() {\n       }\n       int onlineBrokerCount = otherOnlineBrokerCount + 1;\n \n-      double overallRate = Double.parseDouble(quotaConfig.getMaxQueriesPerSecond());\n+      // Get stat from property store\n+      String tableConfigPath = constructTableConfigPath(tableNameWithType);\n+      Stat stat = _propertyStore.getStat(tableConfigPath, AccessOption.PERSISTENT);\n+      if (stat == null) {\n+        LOGGER.info(\"Table {} gets deleted from property store. Removing its rate limit.\", tableNameWithType);\n+        it.remove();\n+        continue;\n+      }\n+\n+      // If number of online brokers and table config don't change, there is no need to re-calculate the dynamic rate.\n+      if (onlineBrokerCount == queryQuotaEntity.getNumOnlineBrokers() && stat.getVersion() == queryQuotaEntity\n+          .getTableConfigStatVersion()) {\n+        continue;\n+      }\n+\n+      double overallRate;\n+      // Get latest quota config only if stat don't match.\n+      if (stat.getVersion() != queryQuotaEntity.getTableConfigStatVersion()) {\n+        QuotaConfig quotaConfig = getQuotaConfigFromPropertyStore(tableNameWithType);\n+        if (quotaConfig == null || quotaConfig.getMaxQueriesPerSecond() == null || !quotaConfig\n+            .isMaxQueriesPerSecondValid()) {\n+          LOGGER.info(\"No query quota config or the config is invalid for Table {}. Removing its rate limit.\",\n+              tableNameWithType);\n+          it.remove();\n+          continue;\n+        }\n+        overallRate = Double.parseDouble(quotaConfig.getMaxQueriesPerSecond());\n+      } else {\n+        overallRate = queryQuotaEntity.getOverallRate();\n+      }\n       double latestRate = overallRate / onlineBrokerCount;\n-      double previousRate = queryQuotaConfig.getRateLimiter().getRate();\n+      double previousRate = queryQuotaEntity.getRateLimiter().getRate();\n       if (Math.abs(latestRate - previousRate) > 0.001) {\n-        queryQuotaConfig.getRateLimiter().setRate(latestRate);\n+        queryQuotaEntity.getRateLimiter().setRate(latestRate);\n+        queryQuotaEntity.setNumOnlineBrokers(onlineBrokerCount);\n+        queryQuotaEntity.setOverallRate(overallRate);\n+        queryQuotaEntity.setTableConfigStatVersion(stat.getVersion());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "003d35ce828f1025a805704e3faf0d44bacbca1d"}, "originalPosition": 262}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc3MzUyNA==", "bodyText": "Table config change won't trigger qps limiter change. Only when there's a broker resource change should this method be triggered, i.e. when broker resource change happens triggered by either broker online/offline or new table added, this method will check the stat and update the stat version. There is no need to keep the stat version update all the time, because there's no listener on table configs, nor it isn't a good idea to have a table config listener.", "url": "https://github.com/apache/pinot/pull/4979#discussion_r368773524", "createdAt": "2020-01-21T01:13:25Z", "author": {"login": "jackjlli"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/HelixExternalViewBasedQueryQuotaManager.java", "diffHunk": "@@ -323,11 +321,43 @@ public void processQueryQuotaChange() {\n       }\n       int onlineBrokerCount = otherOnlineBrokerCount + 1;\n \n-      double overallRate = Double.parseDouble(quotaConfig.getMaxQueriesPerSecond());\n+      // Get stat from property store\n+      String tableConfigPath = constructTableConfigPath(tableNameWithType);\n+      Stat stat = _propertyStore.getStat(tableConfigPath, AccessOption.PERSISTENT);\n+      if (stat == null) {\n+        LOGGER.info(\"Table {} gets deleted from property store. Removing its rate limit.\", tableNameWithType);\n+        it.remove();\n+        continue;\n+      }\n+\n+      // If number of online brokers and table config don't change, there is no need to re-calculate the dynamic rate.\n+      if (onlineBrokerCount == queryQuotaEntity.getNumOnlineBrokers() && stat.getVersion() == queryQuotaEntity\n+          .getTableConfigStatVersion()) {\n+        continue;\n+      }\n+\n+      double overallRate;\n+      // Get latest quota config only if stat don't match.\n+      if (stat.getVersion() != queryQuotaEntity.getTableConfigStatVersion()) {\n+        QuotaConfig quotaConfig = getQuotaConfigFromPropertyStore(tableNameWithType);\n+        if (quotaConfig == null || quotaConfig.getMaxQueriesPerSecond() == null || !quotaConfig\n+            .isMaxQueriesPerSecondValid()) {\n+          LOGGER.info(\"No query quota config or the config is invalid for Table {}. Removing its rate limit.\",\n+              tableNameWithType);\n+          it.remove();\n+          continue;\n+        }\n+        overallRate = Double.parseDouble(quotaConfig.getMaxQueriesPerSecond());\n+      } else {\n+        overallRate = queryQuotaEntity.getOverallRate();\n+      }\n       double latestRate = overallRate / onlineBrokerCount;\n-      double previousRate = queryQuotaConfig.getRateLimiter().getRate();\n+      double previousRate = queryQuotaEntity.getRateLimiter().getRate();\n       if (Math.abs(latestRate - previousRate) > 0.001) {\n-        queryQuotaConfig.getRateLimiter().setRate(latestRate);\n+        queryQuotaEntity.getRateLimiter().setRate(latestRate);\n+        queryQuotaEntity.setNumOnlineBrokers(onlineBrokerCount);\n+        queryQuotaEntity.setOverallRate(overallRate);\n+        queryQuotaEntity.setTableConfigStatVersion(stat.getVersion());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMzMDA5Mg=="}, "originalCommit": {"oid": "003d35ce828f1025a805704e3faf0d44bacbca1d"}, "originalPosition": 262}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3580, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}