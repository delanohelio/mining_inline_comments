{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4MDk1ODgz", "number": 5765, "title": "Optimize DistinctCount to store dictIds within segment", "bodyText": "Description\nFor DistinctCount aggregation function, we can store dictIds within segment without fetching the values, and read the values from dictionary before returning the result for the segment.\nPerformance comparison:\nWith the data in OfflineClusterIntegrationTest, for query: select distinctcountmv(DivAirports) from mytable, latency dropped from 18ms to 6ms.", "createdAt": "2020-07-28T22:41:45Z", "url": "https://github.com/apache/pinot/pull/5765", "merged": true, "mergeCommit": {"oid": "a8fbdaeffaf99c1df4258f60ecbbab1f553d7696"}, "closed": true, "closedAt": "2020-07-29T07:34:11Z", "author": {"login": "Jackie-Jiang"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5hu6AAFqTQ1NzE1NDM0NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5lSoOABqjM1OTc1MzAyNzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MTU0MzQ0", "url": "https://github.com/apache/pinot/pull/5765#pullrequestreview-457154344", "createdAt": "2020-07-29T02:35:06Z", "commit": {"oid": "ce53fd0f2ced9b85f4504ad753c3268f1840bfe5"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMjozNTowNlrOG4mZeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMjozNzoyMlrOG4mbiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwMjU1Mw==", "bodyText": "probably not relevant to this PR but we should try to move towards using Block instead of DataSource", "url": "https://github.com/apache/pinot/pull/5765#discussion_r462002553", "createdAt": "2020-07-29T02:35:06Z", "author": {"login": "kishoreg"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/operator/blocks/ProjectionBlock.java", "diffHunk": "@@ -25,22 +25,22 @@\n import org.apache.pinot.core.common.BlockMetadata;\n import org.apache.pinot.core.common.BlockValSet;\n import org.apache.pinot.core.common.DataBlockCache;\n-import org.apache.pinot.core.common.DataSourceMetadata;\n+import org.apache.pinot.core.common.DataSource;\n import org.apache.pinot.core.operator.docvalsets.ProjectionBlockValSet;\n-import org.apache.pinot.spi.data.FieldSpec;\n \n \n /**\n  * ProjectionBlock holds a column name to Block Map.\n  * It provides DocIdSetBlock for a given column.\n  */\n public class ProjectionBlock implements Block {\n-  private final Map<String, DataSourceMetadata> _dataSourceMetadataMap;\n+  private final Map<String, DataSource> _dataSourceMap;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce53fd0f2ced9b85f4504ad753c3268f1840bfe5"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwMjgzNQ==", "bodyText": "how come we never needed this? For group by, we already have the optimization to work on dictionary ids right?", "url": "https://github.com/apache/pinot/pull/5765#discussion_r462002835", "createdAt": "2020-07-29T02:36:18Z", "author": {"login": "kishoreg"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/operator/docvalsets/ProjectionBlockValSet.java", "diffHunk": "@@ -32,32 +35,33 @@\n public class ProjectionBlockValSet implements BlockValSet {\n   private final DataBlockCache _dataBlockCache;\n   private final String _column;\n-  private final DataType _dataType;\n-  private final boolean _singleValue;\n+  private final DataSource _dataSource;\n \n   /**\n    * Constructor for the class.\n-   * The dataBlockCache argument is initialized in {@link ProjectionOperator},\n-   * so that it can be reused across multiple calls to {@link ProjectionOperator#nextBlock()}.\n-   *\n-   * @param dataBlockCache data block cache\n-   * @param column Projection column.\n+   * The dataBlockCache is initialized in {@link ProjectionOperator} so that it can be reused across multiple calls to\n+   * {@link ProjectionOperator#nextBlock()}.\n    */\n-  public ProjectionBlockValSet(DataBlockCache dataBlockCache, String column, DataType dataType, boolean singleValue) {\n+  public ProjectionBlockValSet(DataBlockCache dataBlockCache, String column, DataSource dataSource) {\n     _dataBlockCache = dataBlockCache;\n     _column = column;\n-    _dataType = dataType;\n-    _singleValue = singleValue;\n+    _dataSource = dataSource;\n   }\n \n   @Override\n   public DataType getValueType() {\n-    return _dataType;\n+    return _dataSource.getDataSourceMetadata().getDataType();\n   }\n \n   @Override\n   public boolean isSingleValue() {\n-    return _singleValue;\n+    return _dataSource.getDataSourceMetadata().isSingleValue();\n+  }\n+\n+  @Nullable\n+  @Override\n+  public Dictionary getDictionary() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce53fd0f2ced9b85f4504ad753c3268f1840bfe5"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwMzA4Mw==", "bodyText": "java doc for this?", "url": "https://github.com/apache/pinot/pull/5765#discussion_r462003083", "createdAt": "2020-07-29T02:37:22Z", "author": {"login": "kishoreg"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountAggregationFunction.java", "diffHunk": "@@ -212,11 +259,57 @@ public IntOpenHashSet extractGroupByResult(GroupByResultHolder groupByResultHold\n     IntOpenHashSet valueSet = groupByResultHolder.getResult(groupKey);\n     if (valueSet == null) {\n       return new IntOpenHashSet();\n+    }\n+\n+    if (_dictionary != null) {\n+      // For dictionary-encoded expression, convert dictionary ids to values\n+      return convertToValueSet(valueSet);\n     } else {\n       return valueSet;\n     }\n   }\n \n+  private IntOpenHashSet convertToValueSet(IntOpenHashSet dictIdSet) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce53fd0f2ced9b85f4504ad753c3268f1840bfe5"}, "originalPosition": 122}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ce53fd0f2ced9b85f4504ad753c3268f1840bfe5", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/ce53fd0f2ced9b85f4504ad753c3268f1840bfe5", "committedDate": "2020-07-28T22:30:05Z", "message": "Optimize DistinctCount to store dictIds within segment"}, "afterCommit": {"oid": "8dbbeb332b072e97ff02a08a289372dbddb42801", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/8dbbeb332b072e97ff02a08a289372dbddb42801", "committedDate": "2020-07-29T06:07:02Z", "message": "Optimize DistinctCount to store dictIds within segment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MjIzNzg2", "url": "https://github.com/apache/pinot/pull/5765#pullrequestreview-457223786", "createdAt": "2020-07-29T06:19:07Z", "commit": {"oid": "8dbbeb332b072e97ff02a08a289372dbddb42801"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8dbbeb332b072e97ff02a08a289372dbddb42801", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/8dbbeb332b072e97ff02a08a289372dbddb42801", "committedDate": "2020-07-29T06:07:02Z", "message": "Optimize DistinctCount to store dictIds within segment"}, "afterCommit": {"oid": "65bcf75bc98ee30ee0f7881dda0dcd94249da69d", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/65bcf75bc98ee30ee0f7881dda0dcd94249da69d", "committedDate": "2020-07-29T06:40:55Z", "message": "Optimize DistinctCount to store dictIds within segment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "503829c3d75a15eeae25e3b8f8e2650bfbc252a1", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/503829c3d75a15eeae25e3b8f8e2650bfbc252a1", "committedDate": "2020-07-29T06:46:24Z", "message": "Optimize DistinctCount to store dictIds within segment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "65bcf75bc98ee30ee0f7881dda0dcd94249da69d", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/65bcf75bc98ee30ee0f7881dda0dcd94249da69d", "committedDate": "2020-07-29T06:40:55Z", "message": "Optimize DistinctCount to store dictIds within segment"}, "afterCommit": {"oid": "503829c3d75a15eeae25e3b8f8e2650bfbc252a1", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/503829c3d75a15eeae25e3b8f8e2650bfbc252a1", "committedDate": "2020-07-29T06:46:24Z", "message": "Optimize DistinctCount to store dictIds within segment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 482, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}