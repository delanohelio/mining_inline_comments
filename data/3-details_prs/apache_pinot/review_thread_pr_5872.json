{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4NDIxNTAw", "number": 5872, "reviewThreads": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNjo0OTo0OFrOEY6Vsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMTowMjowMVrOEaP3Kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NTU3MTA3OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ObjectSerDeUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNjo0OTo0OFrOHBbqDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNjo0OTo0OFrOHBbqDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI2Mzc1OQ==", "bodyText": "Float.BYTES", "url": "https://github.com/apache/pinot/pull/5872#discussion_r471263759", "createdAt": "2020-08-17T06:49:48Z", "author": {"login": "xiangfu0"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ObjectSerDeUtils.java", "diffHunk": "@@ -452,6 +478,142 @@ public IntSet deserialize(ByteBuffer byteBuffer) {\n     }\n   };\n \n+  public static final ObjectSerDe<LongSet> LONG_SET_SER_DE = new ObjectSerDe<LongSet>() {\n+\n+    @Override\n+    public byte[] serialize(LongSet longSet) {\n+      int size = longSet.size();\n+      byte[] bytes = new byte[Integer.BYTES + size * Long.BYTES];\n+      ByteBuffer byteBuffer = ByteBuffer.wrap(bytes);\n+      byteBuffer.putInt(size);\n+      LongIterator iterator = longSet.iterator();\n+      while (iterator.hasNext()) {\n+        byteBuffer.putLong(iterator.nextLong());\n+      }\n+      return bytes;\n+    }\n+\n+    @Override\n+    public LongSet deserialize(byte[] bytes) {\n+      return deserialize(ByteBuffer.wrap(bytes));\n+    }\n+\n+    @Override\n+    public LongSet deserialize(ByteBuffer byteBuffer) {\n+      int size = byteBuffer.getInt();\n+      LongSet longSet = new LongOpenHashSet(size);\n+      for (int i = 0; i < size; i++) {\n+        longSet.add(byteBuffer.getLong());\n+      }\n+      return longSet;\n+    }\n+  };\n+\n+  public static final ObjectSerDe<FloatSet> FLOAT_SET_SER_DE = new ObjectSerDe<FloatSet>() {\n+\n+    @Override\n+    public byte[] serialize(FloatSet floatSet) {\n+      int size = floatSet.size();\n+      byte[] bytes = new byte[Integer.BYTES + size * Long.BYTES];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef30e07e696bb80f5fb31f6557676768cf4ad457"}, "originalPosition": 100}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NTU3MjE4OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ObjectSerDeUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNjo1MDoxN1rOHBbqtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNjo1MDoxN1rOHBbqtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI2MzkyNA==", "bodyText": "byteBuffer.getFloat()", "url": "https://github.com/apache/pinot/pull/5872#discussion_r471263924", "createdAt": "2020-08-17T06:50:17Z", "author": {"login": "xiangfu0"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ObjectSerDeUtils.java", "diffHunk": "@@ -452,6 +478,142 @@ public IntSet deserialize(ByteBuffer byteBuffer) {\n     }\n   };\n \n+  public static final ObjectSerDe<LongSet> LONG_SET_SER_DE = new ObjectSerDe<LongSet>() {\n+\n+    @Override\n+    public byte[] serialize(LongSet longSet) {\n+      int size = longSet.size();\n+      byte[] bytes = new byte[Integer.BYTES + size * Long.BYTES];\n+      ByteBuffer byteBuffer = ByteBuffer.wrap(bytes);\n+      byteBuffer.putInt(size);\n+      LongIterator iterator = longSet.iterator();\n+      while (iterator.hasNext()) {\n+        byteBuffer.putLong(iterator.nextLong());\n+      }\n+      return bytes;\n+    }\n+\n+    @Override\n+    public LongSet deserialize(byte[] bytes) {\n+      return deserialize(ByteBuffer.wrap(bytes));\n+    }\n+\n+    @Override\n+    public LongSet deserialize(ByteBuffer byteBuffer) {\n+      int size = byteBuffer.getInt();\n+      LongSet longSet = new LongOpenHashSet(size);\n+      for (int i = 0; i < size; i++) {\n+        longSet.add(byteBuffer.getLong());\n+      }\n+      return longSet;\n+    }\n+  };\n+\n+  public static final ObjectSerDe<FloatSet> FLOAT_SET_SER_DE = new ObjectSerDe<FloatSet>() {\n+\n+    @Override\n+    public byte[] serialize(FloatSet floatSet) {\n+      int size = floatSet.size();\n+      byte[] bytes = new byte[Integer.BYTES + size * Long.BYTES];\n+      ByteBuffer byteBuffer = ByteBuffer.wrap(bytes);\n+      byteBuffer.putInt(size);\n+      FloatIterator iterator = floatSet.iterator();\n+      while (iterator.hasNext()) {\n+        byteBuffer.putFloat(iterator.nextFloat());\n+      }\n+      return bytes;\n+    }\n+\n+    @Override\n+    public FloatSet deserialize(byte[] bytes) {\n+      return deserialize(ByteBuffer.wrap(bytes));\n+    }\n+\n+    @Override\n+    public FloatSet deserialize(ByteBuffer byteBuffer) {\n+      int size = byteBuffer.getInt();\n+      FloatSet floatSet = new FloatOpenHashSet(size);\n+      for (int i = 0; i < size; i++) {\n+        floatSet.add(byteBuffer.getLong());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef30e07e696bb80f5fb31f6557676768cf4ad457"}, "originalPosition": 120}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NTU3MjY3OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ObjectSerDeUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNjo1MDoyOFrOHBbq-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNjo1MDoyOFrOHBbq-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI2Mzk5NQ==", "bodyText": "Double.BYTES", "url": "https://github.com/apache/pinot/pull/5872#discussion_r471263995", "createdAt": "2020-08-17T06:50:28Z", "author": {"login": "xiangfu0"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ObjectSerDeUtils.java", "diffHunk": "@@ -452,6 +478,142 @@ public IntSet deserialize(ByteBuffer byteBuffer) {\n     }\n   };\n \n+  public static final ObjectSerDe<LongSet> LONG_SET_SER_DE = new ObjectSerDe<LongSet>() {\n+\n+    @Override\n+    public byte[] serialize(LongSet longSet) {\n+      int size = longSet.size();\n+      byte[] bytes = new byte[Integer.BYTES + size * Long.BYTES];\n+      ByteBuffer byteBuffer = ByteBuffer.wrap(bytes);\n+      byteBuffer.putInt(size);\n+      LongIterator iterator = longSet.iterator();\n+      while (iterator.hasNext()) {\n+        byteBuffer.putLong(iterator.nextLong());\n+      }\n+      return bytes;\n+    }\n+\n+    @Override\n+    public LongSet deserialize(byte[] bytes) {\n+      return deserialize(ByteBuffer.wrap(bytes));\n+    }\n+\n+    @Override\n+    public LongSet deserialize(ByteBuffer byteBuffer) {\n+      int size = byteBuffer.getInt();\n+      LongSet longSet = new LongOpenHashSet(size);\n+      for (int i = 0; i < size; i++) {\n+        longSet.add(byteBuffer.getLong());\n+      }\n+      return longSet;\n+    }\n+  };\n+\n+  public static final ObjectSerDe<FloatSet> FLOAT_SET_SER_DE = new ObjectSerDe<FloatSet>() {\n+\n+    @Override\n+    public byte[] serialize(FloatSet floatSet) {\n+      int size = floatSet.size();\n+      byte[] bytes = new byte[Integer.BYTES + size * Long.BYTES];\n+      ByteBuffer byteBuffer = ByteBuffer.wrap(bytes);\n+      byteBuffer.putInt(size);\n+      FloatIterator iterator = floatSet.iterator();\n+      while (iterator.hasNext()) {\n+        byteBuffer.putFloat(iterator.nextFloat());\n+      }\n+      return bytes;\n+    }\n+\n+    @Override\n+    public FloatSet deserialize(byte[] bytes) {\n+      return deserialize(ByteBuffer.wrap(bytes));\n+    }\n+\n+    @Override\n+    public FloatSet deserialize(ByteBuffer byteBuffer) {\n+      int size = byteBuffer.getInt();\n+      FloatSet floatSet = new FloatOpenHashSet(size);\n+      for (int i = 0; i < size; i++) {\n+        floatSet.add(byteBuffer.getLong());\n+      }\n+      return floatSet;\n+    }\n+  };\n+\n+  public static final ObjectSerDe<DoubleSet> DOUBLE_SET_SER_DE = new ObjectSerDe<DoubleSet>() {\n+\n+    @Override\n+    public byte[] serialize(DoubleSet doubleSet) {\n+      int size = doubleSet.size();\n+      byte[] bytes = new byte[Integer.BYTES + size * Long.BYTES];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef30e07e696bb80f5fb31f6557676768cf4ad457"}, "originalPosition": 131}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0ODEyNTM5OnYy", "diffSide": "RIGHT", "path": "pinot-common/src/main/java/org/apache/pinot/common/function/AggregationFunctionType.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNzo1MzozM1rOHBz6tA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxOTo0NjoyNFrOHB4gXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY2MTIzNg==", "bodyText": "What is this for?", "url": "https://github.com/apache/pinot/pull/5872#discussion_r471661236", "createdAt": "2020-08-17T17:53:33Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/function/AggregationFunctionType.java", "diffHunk": "@@ -61,7 +61,8 @@\n   PERCENTILEMV(\"percentileMV\"),\n   PERCENTILEESTMV(\"percentileEstMV\"),\n   PERCENTILETDIGESTMV(\"percentileTDigestMV\"),\n-  DISTINCT(\"distinct\");\n+  DISTINCT(\"distinct\"),\n+  DISTINCTRAWBLOOMFILTER(\"distinctRawBloomFilter\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c531f32b734be6004add1f3e138f42bf9e7c1f6"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTczNjQxMg==", "bodyText": "removed it", "url": "https://github.com/apache/pinot/pull/5872#discussion_r471736412", "createdAt": "2020-08-17T19:46:24Z", "author": {"login": "kishoreg"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/function/AggregationFunctionType.java", "diffHunk": "@@ -61,7 +61,8 @@\n   PERCENTILEMV(\"percentileMV\"),\n   PERCENTILEESTMV(\"percentileEstMV\"),\n   PERCENTILETDIGESTMV(\"percentileTDigestMV\"),\n-  DISTINCT(\"distinct\");\n+  DISTINCT(\"distinct\"),\n+  DISTINCTRAWBLOOMFILTER(\"distinctRawBloomFilter\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY2MTIzNg=="}, "originalCommit": {"oid": "3c531f32b734be6004add1f3e138f42bf9e7c1f6"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0ODE0MzExOnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ObjectSerDeUtils.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNzo1ODoxOVrOHB0FSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNzo1ODoxOVrOHB0FSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY2Mzk0NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  } else if (value instanceof it.unimi.dsi.fastutil.floats.FloatSet) {\n          \n          \n            \n                  } else if (value instanceof FloatSet) {", "url": "https://github.com/apache/pinot/pull/5872#discussion_r471663944", "createdAt": "2020-08-17T17:58:19Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ObjectSerDeUtils.java", "diffHunk": "@@ -111,6 +127,14 @@ public static ObjectType getObjectType(Object value) {\n         return ObjectType.Geometry;\n       } else if (value instanceof RoaringBitmap) {\n         return ObjectType.RoaringBitmap;\n+      } else if (value instanceof LongSet) {\n+        return ObjectType.LongSet;\n+      } else if (value instanceof it.unimi.dsi.fastutil.floats.FloatSet) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c531f32b734be6004add1f3e138f42bf9e7c1f6"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0ODE0MzY5OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ObjectSerDeUtils.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNzo1ODoyOVrOHB0Fmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNzo1ODoyOVrOHB0Fmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY2NDAyNw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  } else if (value instanceof it.unimi.dsi.fastutil.doubles.DoubleSet) {\n          \n          \n            \n                  } else if (value instanceof DoubleSet) {", "url": "https://github.com/apache/pinot/pull/5872#discussion_r471664027", "createdAt": "2020-08-17T17:58:29Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ObjectSerDeUtils.java", "diffHunk": "@@ -111,6 +127,14 @@ public static ObjectType getObjectType(Object value) {\n         return ObjectType.Geometry;\n       } else if (value instanceof RoaringBitmap) {\n         return ObjectType.RoaringBitmap;\n+      } else if (value instanceof LongSet) {\n+        return ObjectType.LongSet;\n+      } else if (value instanceof it.unimi.dsi.fastutil.floats.FloatSet) {\n+        return ObjectType.FloatSet;\n+      } else if (value instanceof it.unimi.dsi.fastutil.doubles.DoubleSet) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c531f32b734be6004add1f3e138f42bf9e7c1f6"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0ODE0OTUzOnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ObjectSerDeUtils.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxODowMDoxMlrOHB0JSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxODowMDoxMlrOHB0JSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY2NDk3MQ==", "bodyText": "Revert this reformat (you may want to enable formatter markers in comments in your IDE)", "url": "https://github.com/apache/pinot/pull/5872#discussion_r471664971", "createdAt": "2020-08-17T18:00:12Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ObjectSerDeUtils.java", "diffHunk": "@@ -538,23 +695,8 @@ public RoaringBitmap deserialize(ByteBuffer byteBuffer) {\n \n   // NOTE: DO NOT change the order, it has to be the same order as the ObjectType\n   //@formatter:off\n-  private static final ObjectSerDe[] SER_DES = {\n-      STRING_SER_DE,\n-      LONG_SER_DE,\n-      DOUBLE_SER_DE,\n-      DOUBLE_ARRAY_LIST_SER_DE,\n-      AVG_PAIR_SER_DE,\n-      MIN_MAX_RANGE_PAIR_SER_DE,\n-      HYPER_LOG_LOG_SER_DE,\n-      QUANTILE_DIGEST_SER_DE,\n-      MAP_SER_DE,\n-      INT_SET_SER_DE,\n-      TDIGEST_SER_DE,\n-      DISTINCT_TABLE_SER_DE,\n-      DATA_SKETCH_SER_DE,\n-      GEOMETRY_SER_DE,\n-      ROARING_BITMAP_SER_DE\n-  };\n+  private static final ObjectSerDe[] SER_DES =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c531f32b734be6004add1f3e138f42bf9e7c1f6"}, "originalPosition": 211}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0ODE1NDcxOnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/operator/query/DictionaryBasedAggregationOperator.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxODowMTozOFrOHB0MWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxODowMjozM1rOHB0OGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY2NTc1NQ==", "bodyText": "Suggest using ByteArray instead of ByteBuffer to store bytes", "url": "https://github.com/apache/pinot/pull/5872#discussion_r471665755", "createdAt": "2020-08-17T18:01:38Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/operator/query/DictionaryBasedAggregationOperator.java", "diffHunk": "@@ -77,36 +83,42 @@ protected IntermediateResultsBlock getNextBlock() {\n               .add(new MinMaxRangePair(dictionary.getDoubleValue(0), dictionary.getDoubleValue(dictionarySize - 1)));\n           break;\n         case DISTINCTCOUNT:\n-          IntOpenHashSet set = new IntOpenHashSet(dictionarySize);\n+          AbstractCollection set;\n           switch (dictionary.getValueType()) {\n             case INT:\n+              set = new IntOpenHashSet(dictionarySize);\n               for (int dictId = 0; dictId < dictionarySize; dictId++) {\n                 set.add(dictionary.getIntValue(dictId));\n               }\n               break;\n             case LONG:\n+              set = new LongOpenHashSet(dictionarySize);\n               for (int dictId = 0; dictId < dictionarySize; dictId++) {\n-                set.add(Long.hashCode(dictionary.getLongValue(dictId)));\n+                set.add(dictionary.getLongValue(dictId));\n               }\n               break;\n             case FLOAT:\n+              set = new FloatOpenHashSet(dictionarySize);\n               for (int dictId = 0; dictId < dictionarySize; dictId++) {\n-                set.add(Float.hashCode(dictionary.getFloatValue(dictId)));\n+                set.add(dictionary.getFloatValue(dictId));\n               }\n               break;\n             case DOUBLE:\n+              set = new DoubleOpenHashSet(dictionarySize);\n               for (int dictId = 0; dictId < dictionarySize; dictId++) {\n-                set.add(Double.hashCode(dictionary.getDoubleValue(dictId)));\n+                set.add(dictionary.getDoubleValue(dictId));\n               }\n               break;\n             case STRING:\n+              set = new ObjectOpenHashSet<ByteBuffer>(dictionarySize);\n               for (int dictId = 0; dictId < dictionarySize; dictId++) {\n-                set.add(dictionary.getStringValue(dictId).hashCode());\n+                set.add(ByteBuffer.wrap(dictionary.getStringValue(dictId).getBytes(Charsets.UTF_8)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c531f32b734be6004add1f3e138f42bf9e7c1f6"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY2NjIwMQ==", "bodyText": "Use StringUtils.encodeUtf8() to encode string for better performance", "url": "https://github.com/apache/pinot/pull/5872#discussion_r471666201", "createdAt": "2020-08-17T18:02:33Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/operator/query/DictionaryBasedAggregationOperator.java", "diffHunk": "@@ -77,36 +83,42 @@ protected IntermediateResultsBlock getNextBlock() {\n               .add(new MinMaxRangePair(dictionary.getDoubleValue(0), dictionary.getDoubleValue(dictionarySize - 1)));\n           break;\n         case DISTINCTCOUNT:\n-          IntOpenHashSet set = new IntOpenHashSet(dictionarySize);\n+          AbstractCollection set;\n           switch (dictionary.getValueType()) {\n             case INT:\n+              set = new IntOpenHashSet(dictionarySize);\n               for (int dictId = 0; dictId < dictionarySize; dictId++) {\n                 set.add(dictionary.getIntValue(dictId));\n               }\n               break;\n             case LONG:\n+              set = new LongOpenHashSet(dictionarySize);\n               for (int dictId = 0; dictId < dictionarySize; dictId++) {\n-                set.add(Long.hashCode(dictionary.getLongValue(dictId)));\n+                set.add(dictionary.getLongValue(dictId));\n               }\n               break;\n             case FLOAT:\n+              set = new FloatOpenHashSet(dictionarySize);\n               for (int dictId = 0; dictId < dictionarySize; dictId++) {\n-                set.add(Float.hashCode(dictionary.getFloatValue(dictId)));\n+                set.add(dictionary.getFloatValue(dictId));\n               }\n               break;\n             case DOUBLE:\n+              set = new DoubleOpenHashSet(dictionarySize);\n               for (int dictId = 0; dictId < dictionarySize; dictId++) {\n-                set.add(Double.hashCode(dictionary.getDoubleValue(dictId)));\n+                set.add(dictionary.getDoubleValue(dictId));\n               }\n               break;\n             case STRING:\n+              set = new ObjectOpenHashSet<ByteBuffer>(dictionarySize);\n               for (int dictId = 0; dictId < dictionarySize; dictId++) {\n-                set.add(dictionary.getStringValue(dictId).hashCode());\n+                set.add(ByteBuffer.wrap(dictionary.getStringValue(dictId).getBytes(Charsets.UTF_8)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY2NTc1NQ=="}, "originalCommit": {"oid": "3c531f32b734be6004add1f3e138f42bf9e7c1f6"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0ODE3NTI5OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountAggregationFunction.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxODowNzoyN1rOHB0Yyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxODowNzoyN1rOHB0Yyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY2ODkzOA==", "bodyText": "I don't think this works for ser/de. You need to construct a type specific set based on the data type", "url": "https://github.com/apache/pinot/pull/5872#discussion_r471668938", "createdAt": "2020-08-17T18:07:27Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountAggregationFunction.java", "diffHunk": "@@ -233,41 +241,103 @@ public void aggregateGroupByMV(int length, int[][] groupKeysArray, GroupByResult\n   }\n \n   @Override\n-  public IntOpenHashSet extractAggregationResult(AggregationResultHolder aggregationResultHolder) {\n+  public AbstractCollection extractAggregationResult(AggregationResultHolder aggregationResultHolder) {\n     Object result = aggregationResultHolder.getResult();\n     if (result == null) {\n-      return new IntOpenHashSet();\n+      return emptyCollection();\n     }\n \n     if (result instanceof DictIdsWrapper) {\n       // For dictionary-encoded expression, convert dictionary ids to hash code of the values\n       return convertToValueSet((DictIdsWrapper) result);\n     } else {\n       // For non-dictionary-encoded expression, directly return the value set\n-      return (IntOpenHashSet) result;\n+      return (AbstractCollection) result;\n     }\n   }\n \n+  private AbstractCollection emptyCollection() {\n+    return new AbstractCollection() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c531f32b734be6004add1f3e138f42bf9e7c1f6"}, "originalPosition": 187}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0ODk3MDgzOnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ObjectSerDeUtils.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QyMTo1NjoxN1rOHB8Myw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMDowMDoxMlrOHDhTkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc5NjkzOQ==", "bodyText": "Wondering if we should have a single ser/de for different data types, by writing the data type as part of header. Not sure if the iterators share the same interface to be able to share the same serialize().", "url": "https://github.com/apache/pinot/pull/5872#discussion_r471796939", "createdAt": "2020-08-17T21:56:17Z", "author": {"login": "mayankshriv"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ObjectSerDeUtils.java", "diffHunk": "@@ -452,6 +476,139 @@ public IntSet deserialize(ByteBuffer byteBuffer) {\n     }\n   };\n \n+  public static final ObjectSerDe<LongSet> LONG_SET_SER_DE = new ObjectSerDe<LongSet>() {\n+\n+    @Override\n+    public byte[] serialize(LongSet longSet) {\n+      int size = longSet.size();\n+      byte[] bytes = new byte[Integer.BYTES + size * Long.BYTES];\n+      ByteBuffer byteBuffer = ByteBuffer.wrap(bytes);\n+      byteBuffer.putInt(size);\n+      LongIterator iterator = longSet.iterator();\n+      while (iterator.hasNext()) {\n+        byteBuffer.putLong(iterator.nextLong());\n+      }\n+      return bytes;\n+    }\n+\n+    @Override\n+    public LongSet deserialize(byte[] bytes) {\n+      return deserialize(ByteBuffer.wrap(bytes));\n+    }\n+\n+    @Override\n+    public LongSet deserialize(ByteBuffer byteBuffer) {\n+      int size = byteBuffer.getInt();\n+      LongSet longSet = new LongOpenHashSet(size);\n+      for (int i = 0; i < size; i++) {\n+        longSet.add(byteBuffer.getLong());\n+      }\n+      return longSet;\n+    }\n+  };\n+\n+  public static final ObjectSerDe<FloatSet> FLOAT_SET_SER_DE = new ObjectSerDe<FloatSet>() {\n+\n+    @Override\n+    public byte[] serialize(FloatSet floatSet) {\n+      int size = floatSet.size();\n+      byte[] bytes = new byte[Integer.BYTES + size * Float.BYTES];\n+      ByteBuffer byteBuffer = ByteBuffer.wrap(bytes);\n+      byteBuffer.putInt(size);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5fd3a07afc50ea06daf3b379b534be3e28cdb8d"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ1MzQ1Ng==", "bodyText": "We are using fastutil Sets for better performance, and each Set has its own iterator class. Keeping them separate is more readable IMO. The ObjectType info is already maintained in the header, no need to introduce another level of type info.", "url": "https://github.com/apache/pinot/pull/5872#discussion_r473453456", "createdAt": "2020-08-20T00:00:12Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ObjectSerDeUtils.java", "diffHunk": "@@ -452,6 +476,139 @@ public IntSet deserialize(ByteBuffer byteBuffer) {\n     }\n   };\n \n+  public static final ObjectSerDe<LongSet> LONG_SET_SER_DE = new ObjectSerDe<LongSet>() {\n+\n+    @Override\n+    public byte[] serialize(LongSet longSet) {\n+      int size = longSet.size();\n+      byte[] bytes = new byte[Integer.BYTES + size * Long.BYTES];\n+      ByteBuffer byteBuffer = ByteBuffer.wrap(bytes);\n+      byteBuffer.putInt(size);\n+      LongIterator iterator = longSet.iterator();\n+      while (iterator.hasNext()) {\n+        byteBuffer.putLong(iterator.nextLong());\n+      }\n+      return bytes;\n+    }\n+\n+    @Override\n+    public LongSet deserialize(byte[] bytes) {\n+      return deserialize(ByteBuffer.wrap(bytes));\n+    }\n+\n+    @Override\n+    public LongSet deserialize(ByteBuffer byteBuffer) {\n+      int size = byteBuffer.getInt();\n+      LongSet longSet = new LongOpenHashSet(size);\n+      for (int i = 0; i < size; i++) {\n+        longSet.add(byteBuffer.getLong());\n+      }\n+      return longSet;\n+    }\n+  };\n+\n+  public static final ObjectSerDe<FloatSet> FLOAT_SET_SER_DE = new ObjectSerDe<FloatSet>() {\n+\n+    @Override\n+    public byte[] serialize(FloatSet floatSet) {\n+      int size = floatSet.size();\n+      byte[] bytes = new byte[Integer.BYTES + size * Float.BYTES];\n+      ByteBuffer byteBuffer = ByteBuffer.wrap(bytes);\n+      byteBuffer.putInt(size);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc5NjkzOQ=="}, "originalCommit": {"oid": "e5fd3a07afc50ea06daf3b379b534be3e28cdb8d"}, "originalPosition": 92}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0ODk3ODkyOnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/operator/query/DictionaryBasedAggregationOperator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QyMTo1OToxN1rOHB8RiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QyMTo1OToxN1rOHB8RiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc5ODE1Mw==", "bodyText": "why not byte[]?", "url": "https://github.com/apache/pinot/pull/5872#discussion_r471798153", "createdAt": "2020-08-17T21:59:17Z", "author": {"login": "mayankshriv"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/operator/query/DictionaryBasedAggregationOperator.java", "diffHunk": "@@ -77,36 +83,42 @@ protected IntermediateResultsBlock getNextBlock() {\n               .add(new MinMaxRangePair(dictionary.getDoubleValue(0), dictionary.getDoubleValue(dictionarySize - 1)));\n           break;\n         case DISTINCTCOUNT:\n-          IntOpenHashSet set = new IntOpenHashSet(dictionarySize);\n+          AbstractCollection set;\n           switch (dictionary.getValueType()) {\n             case INT:\n+              set = new IntOpenHashSet(dictionarySize);\n               for (int dictId = 0; dictId < dictionarySize; dictId++) {\n                 set.add(dictionary.getIntValue(dictId));\n               }\n               break;\n             case LONG:\n+              set = new LongOpenHashSet(dictionarySize);\n               for (int dictId = 0; dictId < dictionarySize; dictId++) {\n-                set.add(Long.hashCode(dictionary.getLongValue(dictId)));\n+                set.add(dictionary.getLongValue(dictId));\n               }\n               break;\n             case FLOAT:\n+              set = new FloatOpenHashSet(dictionarySize);\n               for (int dictId = 0; dictId < dictionarySize; dictId++) {\n-                set.add(Float.hashCode(dictionary.getFloatValue(dictId)));\n+                set.add(dictionary.getFloatValue(dictId));\n               }\n               break;\n             case DOUBLE:\n+              set = new DoubleOpenHashSet(dictionarySize);\n               for (int dictId = 0; dictId < dictionarySize; dictId++) {\n-                set.add(Double.hashCode(dictionary.getDoubleValue(dictId)));\n+                set.add(dictionary.getDoubleValue(dictId));\n               }\n               break;\n             case STRING:\n+              set = new ObjectOpenHashSet<ByteBuffer>(dictionarySize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5fd3a07afc50ea06daf3b379b534be3e28cdb8d"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1OTU4MzE0OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ObjectSerDeUtils.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMTowMjowMVrOHDjwyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMjoyNjo1NlrOHDnFWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ5MzcwNQ==", "bodyText": "will this be a problem as we always return StringSet for empty value?", "url": "https://github.com/apache/pinot/pull/5872#discussion_r473493705", "createdAt": "2020-08-20T01:02:01Z", "author": {"login": "xiangfu0"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ObjectSerDeUtils.java", "diffHunk": "@@ -111,6 +131,19 @@ public static ObjectType getObjectType(Object value) {\n         return ObjectType.Geometry;\n       } else if (value instanceof RoaringBitmap) {\n         return ObjectType.RoaringBitmap;\n+      } else if (value instanceof LongSet) {\n+        return ObjectType.LongSet;\n+      } else if (value instanceof FloatSet) {\n+        return ObjectType.FloatSet;\n+      } else if (value instanceof DoubleSet) {\n+        return ObjectType.DoubleSet;\n+      } else if (value instanceof ObjectSet) {\n+        ObjectSet objectSet = (ObjectSet) value;\n+        if (objectSet.isEmpty() || objectSet.iterator().next() instanceof String) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18105504b22008b45a585cd592b4e10cd4bf337a"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU0ODEyMQ==", "bodyText": "It is fine for empty set as empty string set and empty bytes set are the same (both are empty ObjectOpenHashSet)", "url": "https://github.com/apache/pinot/pull/5872#discussion_r473548121", "createdAt": "2020-08-20T02:26:56Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ObjectSerDeUtils.java", "diffHunk": "@@ -111,6 +131,19 @@ public static ObjectType getObjectType(Object value) {\n         return ObjectType.Geometry;\n       } else if (value instanceof RoaringBitmap) {\n         return ObjectType.RoaringBitmap;\n+      } else if (value instanceof LongSet) {\n+        return ObjectType.LongSet;\n+      } else if (value instanceof FloatSet) {\n+        return ObjectType.FloatSet;\n+      } else if (value instanceof DoubleSet) {\n+        return ObjectType.DoubleSet;\n+      } else if (value instanceof ObjectSet) {\n+        ObjectSet objectSet = (ObjectSet) value;\n+        if (objectSet.isEmpty() || objectSet.iterator().next() instanceof String) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ5MzcwNQ=="}, "originalCommit": {"oid": "18105504b22008b45a585cd592b4e10cd4bf337a"}, "originalPosition": 72}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4011, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}