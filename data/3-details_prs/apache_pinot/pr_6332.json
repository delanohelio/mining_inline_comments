{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0MTY1OTU4", "number": 6332, "title": "Simplify batch config and corresponding utils", "bodyText": "Description\nSimplify batch ingestion config by removing the redundant prefixes.\nThis is the referral link for pull based ingestion discussion: https://docs.google.com/document/d/1d7ThRbP1CRzJejx9hZy-XXkln2srvvUzTWGDPo9h3FY/edit?usp=sharing\nSample configs:\n \"batch\": {\n       \"segmentPushType\": \"APPEND\",  \n       \"segmentPushFrequency\": \"HOURLY\",  \n       \"batchConfigs\": [{\n          \u201cinputDirURI\": \"s3://pinot-bucket/pinot-ingestion/batch-input/\",\n          \u201cinput.fs.className\u201d: \u201corg.apache.pinot.plugin.filesystem.S3PinotFS\u201d,\n          \u201cinput.fs.prop.region\u201d: \u201cus-west-2\u201d,\n          \u201cinput.fs.prop.accessKey\u201d: \u201c${AWS_ACCESS_KEY}\u201d,\n          \u201cinput.fs.prop.secretKey\u201d: \u201c${AWS_SECRET_KEY}\u201d,\n          \u201cincludeFileNamePattern\": \"glob:**/*.csv\",\n          \u201cexcludeFileNamePattern\": \"glob:**/*.tmp\",\n          \u201cinputFormat\u201d: \u201ccsv\u201d,\n          \u201crecordReader.className\u201d: \u201corg.apache.pinot.plugin.inputformat.csv.CSVRecordReader\u201d,\n          \u201crecordReader.configClassName\u201d: \u201corg.apache.pinot.plugin.inputformat.csv.CSVRecordReaderConfig\u201d,\n          \u201crecordReader.prop.delimiter\u201d: \u201c|\u201d,\n          \u201coutputDirURI\": \"s3://pinot-bucket/pinot-ingestion/batch-output/\",\n          \u201coutput.fs.className\u201d: \u201corg.apache.pinot.plugin.filesystem.S3PinotFS\u201d,\n          \u201coutput.fs.prop.region\u201d: \u201cus-east-2\u201d,\n          \u201coutput.fs.prop.accessKey\u201d: \u201c${OTHER_AWS_ACCESS_KEY}\u201d,\n          \u201coutput.fs.prop.secretKey\u201d: \u201c${OTHER_AWS_SECRET_KEY}\u201d,\n          \u201csegmentNameGenerator.type\u201d: \u201cNormalizedDate\u201d,\n          \u201csegmentNameGenerator.configs.local.directory.sequence.id\u201d: \u201c1\u201d,\n          \u201cpush.mode\u201d: \u201cmetadata\u201d\n       }],\n     }\n\n\n\n\nBatch Config\nDescription\n\n\n\n\ninputDirURI\nRequired. Input data files directory URI. If scheme is not specified, then default to local fs: file://...\n\n\nincludeFileNamePattern\nOptional. Include files with the given pattern.\n\n\nexcludeFileNamePattern\nOptional. Exclude files with the given pattern.\n\n\ninputFormat\nRequired. Pinot supported input file format(CSV/JSON/Avro/Parquet/ORC). This is information is used to auto-fill record reader related configs.\n\n\noutputDirURI\nRequired. Output segments directory URI. If scheme is not specified, then default to local fs: file://...\n\n\ninput.fs.classNameinput.fs.prop.<props>\nOptional. If the scheme in input URIs is not registered. Then user can define the PinontFS here.\n\n\noutput.fs.classNameoutput.fs.prop.<props>\nOptional. If the scheme in output URIs is not registered. Then user can define the PinontFS here.\n\n\nrecordReader.classNamerecordReader.configClassNamerecordReader.prop.<props>\nOptional. Defines input file reader format. Typically this info can be inferred from . But for certain input format, like csv, user may need to define custom props like separator.Also user can specify their own recordReader class and props to support new file formats.\n\n\nsegmentNameGenerator.typesegmentNameGenerator.configs.<props>\nOptional. Defines how segment name is generated(simple/normalizedDate/fixed), default to simpe.\n\n\npush.modepush.controllerUripush.segmentUriPrefixpush.segmentUriSuffix\nOptional. Defines how segment is pushd to controller(tar/uri/metadata)", "createdAt": "2020-12-08T06:42:31Z", "url": "https://github.com/apache/pinot/pull/6332", "merged": true, "mergeCommit": {"oid": "4183ffe71c19944312a99555392033cbd7481ac4"}, "closed": true, "closedAt": "2020-12-14T19:45:05Z", "author": {"login": "xiangfu0"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkFpJvgBqjQwODM0NzA1NTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdl9GZpAFqTU1MTAxOTkyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "adc0f0c31bc3bfe4e99a1100265e72401d114ad6", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/adc0f0c31bc3bfe4e99a1100265e72401d114ad6", "committedDate": "2020-12-08T06:41:30Z", "message": "simplify batch config and corresponding utils"}, "afterCommit": {"oid": "a1e4652180b85976b2a6cce23f977dfd945b7795", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/a1e4652180b85976b2a6cce23f977dfd945b7795", "committedDate": "2020-12-08T08:12:40Z", "message": "simplify batch config and corresponding utils"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a1e4652180b85976b2a6cce23f977dfd945b7795", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/a1e4652180b85976b2a6cce23f977dfd945b7795", "committedDate": "2020-12-08T08:12:40Z", "message": "simplify batch config and corresponding utils"}, "afterCommit": {"oid": "80e5a0e9008250dcafd02edf340b15dddb69d71d", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/80e5a0e9008250dcafd02edf340b15dddb69d71d", "committedDate": "2020-12-08T08:19:51Z", "message": "simplify batch config and corresponding utils"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "80e5a0e9008250dcafd02edf340b15dddb69d71d", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/80e5a0e9008250dcafd02edf340b15dddb69d71d", "committedDate": "2020-12-08T08:19:51Z", "message": "simplify batch config and corresponding utils"}, "afterCommit": {"oid": "3971d189f7a67fbc9878852680c536f66fa5fa9a", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/3971d189f7a67fbc9878852680c536f66fa5fa9a", "committedDate": "2020-12-08T20:39:44Z", "message": "simplify batch config and corresponding utils"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3971d189f7a67fbc9878852680c536f66fa5fa9a", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/3971d189f7a67fbc9878852680c536f66fa5fa9a", "committedDate": "2020-12-08T20:39:44Z", "message": "simplify batch config and corresponding utils"}, "afterCommit": {"oid": "b72f0d37227a181caee299412d8ef11fbc1f36f5", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/b72f0d37227a181caee299412d8ef11fbc1f36f5", "committedDate": "2020-12-08T20:40:40Z", "message": "simplify batch config and corresponding utils"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5NzA0MzI2", "url": "https://github.com/apache/pinot/pull/6332#pullrequestreview-549704326", "createdAt": "2020-12-10T23:54:41Z", "commit": {"oid": "b72f0d37227a181caee299412d8ef11fbc1f36f5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMzo1NDo0MVrOIDi2jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMzo1NDo0MVrOIDi2jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU4NzY2Mg==", "bodyText": "Curious on why this change?", "url": "https://github.com/apache/pinot/pull/6332#discussion_r540587662", "createdAt": "2020-12-10T23:54:41Z", "author": {"login": "mayankshriv"}, "path": "pinot-spi/src/main/java/org/apache/pinot/spi/filesystem/PinotFSFactory.java", "diffHunk": "@@ -38,8 +38,8 @@\n   private PinotFSFactory() {\n   }\n \n+  public static final String LOCAL_PINOT_FS_SCHEME = \"file\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b72f0d37227a181caee299412d8ef11fbc1f36f5"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNTA2MTMx", "url": "https://github.com/apache/pinot/pull/6332#pullrequestreview-550506131", "createdAt": "2020-12-11T19:10:47Z", "commit": {"oid": "b72f0d37227a181caee299412d8ef11fbc1f36f5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxOToxMDo0OFrOIEGzuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxOToxMDo0OFrOIEGzuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE3Njc2MQ==", "bodyText": "As discussed offline, please relax this requirement of input and output dir, so that user can pass in their own BatchConfig with null input and output for file uploads", "url": "https://github.com/apache/pinot/pull/6332#discussion_r541176761", "createdAt": "2020-12-11T19:10:48Z", "author": {"login": "npawar"}, "path": "pinot-spi/src/main/java/org/apache/pinot/spi/ingestion/batch/BatchConfig.java", "diffHunk": "@@ -28,73 +28,57 @@\n  * Provides all config related to the batch data source, as configured in the table config's ingestion config\n  */\n public class BatchConfig {\n+  private final Map<String, String> _batchConfigMap;\n+\n   private final String _tableNameWithType;\n-  private final String _type;\n   private final String _inputDirURI;\n   private final String _outputDirURI;\n-  private final String _fsClassName;\n-  private final Map<String, String> _fsProps = new HashMap<>();\n+  private final String _inputFsClassName;\n+  private final Map<String, String> _inputFsProps = new HashMap<>();\n+  private final String _outputFsClassName;\n+  private final Map<String, String> _outputFsProps = new HashMap<>();\n   private final FileFormat _inputFormat;\n   private final String _recordReaderClassName;\n   private final String _recordReaderConfigClassName;\n   private final Map<String, String> _recordReaderProps = new HashMap<>();\n \n-  private final Map<String, String> _batchConfigMap = new HashMap<>();\n-\n   public BatchConfig(String tableNameWithType, Map<String, String> batchConfigsMap) {\n-    _tableNameWithType = tableNameWithType;\n-\n-    _type = batchConfigsMap.get(BatchConfigProperties.BATCH_TYPE);\n-    Preconditions.checkState(_type != null, \"Property: %s cannot be null\", BatchConfigProperties.BATCH_TYPE);\n+    _batchConfigMap = batchConfigsMap;\n \n-    String inputDirURIKey = BatchConfigProperties.constructBatchProperty(_type, BatchConfigProperties.INPUT_DIR_URI);\n-    _inputDirURI = batchConfigsMap.get(inputDirURIKey);\n-    Preconditions.checkState(_inputDirURI != null, \"Property: %s cannot be null\", inputDirURIKey);\n+    _tableNameWithType = tableNameWithType;\n \n-    String outputDirURIKey = BatchConfigProperties.constructBatchProperty(_type, BatchConfigProperties.OUTPUT_DIR_URI);\n-    _outputDirURI = batchConfigsMap.get(outputDirURIKey);\n-    Preconditions.checkState(_outputDirURI != null, \"Property: %s cannot be null\", outputDirURIKey);\n+    _inputDirURI = batchConfigsMap.get(BatchConfigProperties.INPUT_DIR_URI);\n+    Preconditions.checkState(_inputDirURI != null, \"Property: %s cannot be null\", BatchConfigProperties.INPUT_DIR_URI);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b72f0d37227a181caee299412d8ef11fbc1f36f5"}, "originalPosition": 39}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b72f0d37227a181caee299412d8ef11fbc1f36f5", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/b72f0d37227a181caee299412d8ef11fbc1f36f5", "committedDate": "2020-12-08T20:40:40Z", "message": "simplify batch config and corresponding utils"}, "afterCommit": {"oid": "e3660c18d4a7b7c7f19c4b4677a2fefa24061d16", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/e3660c18d4a7b7c7f19c4b4677a2fefa24061d16", "committedDate": "2020-12-12T05:15:52Z", "message": "simplify batch config and corresponding utils"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6b28d840dba677b7dd589af80bf55f7dadf1c6e", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/c6b28d840dba677b7dd589af80bf55f7dadf1c6e", "committedDate": "2020-12-13T02:45:23Z", "message": "simplify batch config and corresponding utils"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e3660c18d4a7b7c7f19c4b4677a2fefa24061d16", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/e3660c18d4a7b7c7f19c4b4677a2fefa24061d16", "committedDate": "2020-12-12T05:15:52Z", "message": "simplify batch config and corresponding utils"}, "afterCommit": {"oid": "c6b28d840dba677b7dd589af80bf55f7dadf1c6e", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/c6b28d840dba677b7dd589af80bf55f7dadf1c6e", "committedDate": "2020-12-13T02:45:23Z", "message": "simplify batch config and corresponding utils"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxMDE5OTI4", "url": "https://github.com/apache/pinot/pull/6332#pullrequestreview-551019928", "createdAt": "2020-12-14T03:23:38Z", "commit": {"oid": "c6b28d840dba677b7dd589af80bf55f7dadf1c6e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1617, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}