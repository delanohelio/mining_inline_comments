{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwODUzODQz", "number": 5631, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwMToxOTozOVrOEKVFYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwMTo1MjowNlrOEOEbWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5MjY2NjU3OnYy", "diffSide": "RIGHT", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/ControllerStarter.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwMToxOTozOVrOGrTqNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxOTo0OTowMlrOGrzPCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA2NDA1Mw==", "bodyText": "No need to use guava for this. We have experienced several backward-incompatible issues with guava.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                Map<ClusterConstraints.ConstraintAttribute, String> constraintAttributes = Maps.newHashMap();\n          \n          \n            \n                Map<ClusterConstraints.ConstraintAttribute, String> constraintAttributes = new HashMap()<>;", "url": "https://github.com/apache/pinot/pull/5631#discussion_r448064053", "createdAt": "2020-07-01T01:19:39Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/ControllerStarter.java", "diffHunk": "@@ -202,6 +209,18 @@ private void setupHelixSystemProperties() {\n             CommonConstants.Helix.DEFAULT_FLAPPING_TIME_WINDOW_MS));\n   }\n \n+  private void setupHelixClusterConstraints() {\n+    String maxMessageLimit = _config.getString(CommonConstants.Helix.CONFIG_OF_HELIX_INSTANCE_MAX_MESSAGES,\n+        CommonConstants.Helix.DEFAULT_HELIX_INSTANCE_MAX_MESSAGES);\n+    Map<ClusterConstraints.ConstraintAttribute, String> constraintAttributes = Maps.newHashMap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d255b3589141187836eb2b5371a86ff6cd36e912"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU4MTM4Nw==", "bodyText": "Good to know this. thanks", "url": "https://github.com/apache/pinot/pull/5631#discussion_r448581387", "createdAt": "2020-07-01T19:49:02Z", "author": {"login": "yupeng9"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/ControllerStarter.java", "diffHunk": "@@ -202,6 +209,18 @@ private void setupHelixSystemProperties() {\n             CommonConstants.Helix.DEFAULT_FLAPPING_TIME_WINDOW_MS));\n   }\n \n+  private void setupHelixClusterConstraints() {\n+    String maxMessageLimit = _config.getString(CommonConstants.Helix.CONFIG_OF_HELIX_INSTANCE_MAX_MESSAGES,\n+        CommonConstants.Helix.DEFAULT_HELIX_INSTANCE_MAX_MESSAGES);\n+    Map<ClusterConstraints.ConstraintAttribute, String> constraintAttributes = Maps.newHashMap();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA2NDA1Mw=="}, "originalCommit": {"oid": "d255b3589141187836eb2b5371a86ff6cd36e912"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5MjY4ODYyOnYy", "diffSide": "RIGHT", "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/CommonConstants.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwMTozMzozOFrOGrT3XQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwMTozMzozOFrOGrT3XQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA2NzQyMQ==", "bodyText": "Recommend renaming it for clarity and add some comments on how it works (limit the maximum number of state transitions for each instance):\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static final String CONFIG_OF_HELIX_INSTANCE_MAX_MESSAGES = \"pinot.helix.instance.messages.max\";\n          \n          \n            \n                public static final String CONFIG_OF_HELIX_INSTANCE_MAX_STATE_TRANSITIONS = \"pinot.helix.instance.maxStateTransitions\";", "url": "https://github.com/apache/pinot/pull/5631#discussion_r448067421", "createdAt": "2020-07-01T01:33:38Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/CommonConstants.java", "diffHunk": "@@ -109,6 +109,8 @@\n     public static final String CONFIG_OF_BROKER_FLAPPING_TIME_WINDOW_MS = \"pinot.broker.flapping.timeWindowMs\";\n     public static final String CONFIG_OF_SERVER_FLAPPING_TIME_WINDOW_MS = \"pinot.server.flapping.timeWindowMs\";\n     public static final String CONFIG_OF_MINION_FLAPPING_TIME_WINDOW_MS = \"pinot.minion.flapping.timeWindowMs\";\n+    public static final String CONFIG_OF_HELIX_INSTANCE_MAX_MESSAGES = \"pinot.helix.instance.messages.max\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d255b3589141187836eb2b5371a86ff6cd36e912"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5MjY4OTY4OnYy", "diffSide": "RIGHT", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/ControllerStarter.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwMTozNDoxOFrOGrT3_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwMTozNDoxOFrOGrT3_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA2NzU4MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private static final String MAX_MESSAGES_PER_INSTANCE_NAME =  \"MaxMessagesPerInstance\";\n          \n          \n            \n              private static final String MAX_STATE_TRANSITIONS_PER_INSTANCE =  \"MaxStateTransitionsPerInstance\";", "url": "https://github.com/apache/pinot/pull/5631#discussion_r448067581", "createdAt": "2020-07-01T01:34:18Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/ControllerStarter.java", "diffHunk": "@@ -97,6 +103,7 @@\n   private static final Long DATA_DIRECTORY_MISSING_VALUE = 1000000L;\n   private static final Long DATA_DIRECTORY_EXCEPTION_VALUE = 1100000L;\n   private static final String METADATA_EVENT_NOTIFIER_PREFIX = \"metadata.event.notifier\";\n+  private static final String MAX_MESSAGES_PER_INSTANCE_NAME =  \"MaxMessagesPerInstance\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d255b3589141187836eb2b5371a86ff6cd36e912"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5MjY5MTQwOnYy", "diffSide": "RIGHT", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/ControllerStarter.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwMTozNToxOFrOGrT48w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwMTozNToxOFrOGrT48w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA2NzgyNw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                constraintAttributes.put(ClusterConstraints.ConstraintAttribute.MESSAGE_TYPE, \"STATE_TRANSITION\");\n          \n          \n            \n                constraintAttributes.put(ClusterConstraints.ConstraintAttribute.MESSAGE_TYPE, Message.MessageType.STATE_TRANSITION.name());", "url": "https://github.com/apache/pinot/pull/5631#discussion_r448067827", "createdAt": "2020-07-01T01:35:18Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/ControllerStarter.java", "diffHunk": "@@ -202,6 +209,18 @@ private void setupHelixSystemProperties() {\n             CommonConstants.Helix.DEFAULT_FLAPPING_TIME_WINDOW_MS));\n   }\n \n+  private void setupHelixClusterConstraints() {\n+    String maxMessageLimit = _config.getString(CommonConstants.Helix.CONFIG_OF_HELIX_INSTANCE_MAX_MESSAGES,\n+        CommonConstants.Helix.DEFAULT_HELIX_INSTANCE_MAX_MESSAGES);\n+    Map<ClusterConstraints.ConstraintAttribute, String> constraintAttributes = Maps.newHashMap();\n+    constraintAttributes.put(ClusterConstraints.ConstraintAttribute.INSTANCE, \".*\");\n+    constraintAttributes.put(ClusterConstraints.ConstraintAttribute.MESSAGE_TYPE, \"STATE_TRANSITION\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d255b3589141187836eb2b5371a86ff6cd36e912"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5MjY5NDk2OnYy", "diffSide": "RIGHT", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/ControllerStarter.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwMTozNzoyM1rOGrT7Dg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwMTozOTo0MlrOGshR8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA2ODM2Ng==", "bodyText": "We should not set this for Pinot controller but only for Helix controller", "url": "https://github.com/apache/pinot/pull/5631#discussion_r448068366", "createdAt": "2020-07-01T01:37:23Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/ControllerStarter.java", "diffHunk": "@@ -350,6 +377,9 @@ private void setUpPinotController() {\n       _realtimeSegmentsManager = null;\n     }\n \n+    // setup constraints\n+    setupHelixClusterConstraints();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d255b3589141187836eb2b5371a86ff6cd36e912"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU5MzYwNg==", "bodyText": "But then no constraint is added during PINOT_ONLY mode?", "url": "https://github.com/apache/pinot/pull/5631#discussion_r448593606", "createdAt": "2020-07-01T20:16:21Z", "author": {"login": "yupeng9"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/ControllerStarter.java", "diffHunk": "@@ -350,6 +377,9 @@ private void setUpPinotController() {\n       _realtimeSegmentsManager = null;\n     }\n \n+    // setup constraints\n+    setupHelixClusterConstraints();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA2ODM2Ng=="}, "originalCommit": {"oid": "d255b3589141187836eb2b5371a86ff6cd36e912"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIwNjY5Ng==", "bodyText": "PINOT_ONLY mode controller does not serve as the Helix controller, so it should not add this constraint to the cluster.", "url": "https://github.com/apache/pinot/pull/5631#discussion_r449206696", "createdAt": "2020-07-02T18:47:19Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/ControllerStarter.java", "diffHunk": "@@ -350,6 +377,9 @@ private void setUpPinotController() {\n       _realtimeSegmentsManager = null;\n     }\n \n+    // setup constraints\n+    setupHelixClusterConstraints();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA2ODM2Ng=="}, "originalCommit": {"oid": "d255b3589141187836eb2b5371a86ff6cd36e912"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMzNTc5Mg==", "bodyText": "Got it. thanks", "url": "https://github.com/apache/pinot/pull/5631#discussion_r449335792", "createdAt": "2020-07-03T01:39:42Z", "author": {"login": "yupeng9"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/ControllerStarter.java", "diffHunk": "@@ -350,6 +377,9 @@ private void setUpPinotController() {\n       _realtimeSegmentsManager = null;\n     }\n \n+    // setup constraints\n+    setupHelixClusterConstraints();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA2ODM2Ng=="}, "originalCommit": {"oid": "d255b3589141187836eb2b5371a86ff6cd36e912"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwMzE5NTE0OnYy", "diffSide": "RIGHT", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/ControllerStarter.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QyMjowOTowMVrOGs4N7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwMDoxMTo0M1rOGw_MOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcxMTU5Nw==", "bodyText": "While this may be a good thing to do, we have often experienced issues with helix, especially the undocumented features. Can we at least make this so that if the config is not set, then we leave the behavior like before?\nMeanwhile. I have asked someone from the helix team to take a look at this.", "url": "https://github.com/apache/pinot/pull/5631#discussion_r449711597", "createdAt": "2020-07-03T22:09:01Z", "author": {"login": "mcvsubbu"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/ControllerStarter.java", "diffHunk": "@@ -202,6 +209,20 @@ private void setupHelixSystemProperties() {\n             CommonConstants.Helix.DEFAULT_FLAPPING_TIME_WINDOW_MS));\n   }\n \n+  private void setupHelixClusterConstraints() {\n+    String maxMessageLimit = _config.getString(CommonConstants.Helix.CONFIG_OF_HELIX_INSTANCE_MAX_STATE_TRANSITIONS,\n+        CommonConstants.Helix.DEFAULT_HELIX_INSTANCE_MAX_STATE_TRANSITIONS);\n+    Map<ClusterConstraints.ConstraintAttribute, String> constraintAttributes = new HashMap<>();\n+    constraintAttributes.put(ClusterConstraints.ConstraintAttribute.INSTANCE, \".*\");\n+    constraintAttributes\n+        .put(ClusterConstraints.ConstraintAttribute.MESSAGE_TYPE, Message.MessageType.STATE_TRANSITION.name());\n+    ConstraintItem constraintItem = new ConstraintItem(constraintAttributes, maxMessageLimit);\n+\n+    _helixControllerManager.getClusterManagmentTool()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef30557e5b30a85b3dc94e5a4144be4496561b87"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc4NzA1Mg==", "bodyText": "Sure. Please have the helix team take a look.\nThere is some caveat of not adding the constraint when the config is not set: do we need to add logic removing the constraint if the config is not present? Otherwise it's possible that the constraint is left there, when users remove this configuration. What about if there are inconsistent configurations, with the configuration set on one controller but not others (which will lead to race condition)? Usually having the configuration with a default value makes such issues more manageable.", "url": "https://github.com/apache/pinot/pull/5631#discussion_r449787052", "createdAt": "2020-07-04T16:37:30Z", "author": {"login": "yupeng9"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/ControllerStarter.java", "diffHunk": "@@ -202,6 +209,20 @@ private void setupHelixSystemProperties() {\n             CommonConstants.Helix.DEFAULT_FLAPPING_TIME_WINDOW_MS));\n   }\n \n+  private void setupHelixClusterConstraints() {\n+    String maxMessageLimit = _config.getString(CommonConstants.Helix.CONFIG_OF_HELIX_INSTANCE_MAX_STATE_TRANSITIONS,\n+        CommonConstants.Helix.DEFAULT_HELIX_INSTANCE_MAX_STATE_TRANSITIONS);\n+    Map<ClusterConstraints.ConstraintAttribute, String> constraintAttributes = new HashMap<>();\n+    constraintAttributes.put(ClusterConstraints.ConstraintAttribute.INSTANCE, \".*\");\n+    constraintAttributes\n+        .put(ClusterConstraints.ConstraintAttribute.MESSAGE_TYPE, Message.MessageType.STATE_TRANSITION.name());\n+    ConstraintItem constraintItem = new ConstraintItem(constraintAttributes, maxMessageLimit);\n+\n+    _helixControllerManager.getClusterManagmentTool()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcxMTU5Nw=="}, "originalCommit": {"oid": "ef30557e5b30a85b3dc94e5a4144be4496561b87"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAyMDE1Mw==", "bodyText": "@mcvsubbu with Junkai's assessment, do you still have concerns on the current approach, given it's a safe change for better zookeeper scalability?\nI prefer the current way since it simplifies the configuration story, i.e. no need to use external Helix admin to clean up constraint etc.", "url": "https://github.com/apache/pinot/pull/5631#discussion_r454020153", "createdAt": "2020-07-14T00:11:43Z", "author": {"login": "yupeng9"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/ControllerStarter.java", "diffHunk": "@@ -202,6 +209,20 @@ private void setupHelixSystemProperties() {\n             CommonConstants.Helix.DEFAULT_FLAPPING_TIME_WINDOW_MS));\n   }\n \n+  private void setupHelixClusterConstraints() {\n+    String maxMessageLimit = _config.getString(CommonConstants.Helix.CONFIG_OF_HELIX_INSTANCE_MAX_STATE_TRANSITIONS,\n+        CommonConstants.Helix.DEFAULT_HELIX_INSTANCE_MAX_STATE_TRANSITIONS);\n+    Map<ClusterConstraints.ConstraintAttribute, String> constraintAttributes = new HashMap<>();\n+    constraintAttributes.put(ClusterConstraints.ConstraintAttribute.INSTANCE, \".*\");\n+    constraintAttributes\n+        .put(ClusterConstraints.ConstraintAttribute.MESSAGE_TYPE, Message.MessageType.STATE_TRANSITION.name());\n+    ConstraintItem constraintItem = new ConstraintItem(constraintAttributes, maxMessageLimit);\n+\n+    _helixControllerManager.getClusterManagmentTool()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcxMTU5Nw=="}, "originalCommit": {"oid": "ef30557e5b30a85b3dc94e5a4144be4496561b87"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzMTg3MzI1OnYy", "diffSide": "RIGHT", "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/CommonConstants.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwMTo0ODowOFrOGxA8ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwMTo0ODowOFrOGxA8ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA0ODk2Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static final String CONFIG_OF_HELIX_INSTANCE_MAX_STATE_TRANSITIONS = \"pinot.helix.instance.state.transitions.max\";\n          \n          \n            \n                public static final String CONFIG_OF_HELIX_INSTANCE_MAX_STATE_TRANSITIONS = \"pinot.helix.instance.maxStateTransitions\";", "url": "https://github.com/apache/pinot/pull/5631#discussion_r454048963", "createdAt": "2020-07-14T01:48:08Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/CommonConstants.java", "diffHunk": "@@ -109,6 +109,8 @@\n     public static final String CONFIG_OF_BROKER_FLAPPING_TIME_WINDOW_MS = \"pinot.broker.flapping.timeWindowMs\";\n     public static final String CONFIG_OF_SERVER_FLAPPING_TIME_WINDOW_MS = \"pinot.server.flapping.timeWindowMs\";\n     public static final String CONFIG_OF_MINION_FLAPPING_TIME_WINDOW_MS = \"pinot.minion.flapping.timeWindowMs\";\n+    public static final String CONFIG_OF_HELIX_INSTANCE_MAX_STATE_TRANSITIONS = \"pinot.helix.instance.state.transitions.max\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef30557e5b30a85b3dc94e5a4144be4496561b87"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzMTg3NTczOnYy", "diffSide": "RIGHT", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/ControllerStarter.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwMTo0OTozOFrOGxA-ZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwMTo0OTozOFrOGxA-ZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA0OTM4MA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                String maxMessageLimit = _config.getString(CommonConstants.Helix.CONFIG_OF_HELIX_INSTANCE_MAX_STATE_TRANSITIONS,\n          \n          \n            \n                String maxStateTransitions = _config.getString(CommonConstants.Helix.CONFIG_OF_HELIX_INSTANCE_MAX_STATE_TRANSITIONS,", "url": "https://github.com/apache/pinot/pull/5631#discussion_r454049380", "createdAt": "2020-07-14T01:49:38Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/ControllerStarter.java", "diffHunk": "@@ -202,6 +209,20 @@ private void setupHelixSystemProperties() {\n             CommonConstants.Helix.DEFAULT_FLAPPING_TIME_WINDOW_MS));\n   }\n \n+  private void setupHelixClusterConstraints() {\n+    String maxMessageLimit = _config.getString(CommonConstants.Helix.CONFIG_OF_HELIX_INSTANCE_MAX_STATE_TRANSITIONS,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef30557e5b30a85b3dc94e5a4144be4496561b87"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzMTg3ODQ0OnYy", "diffSide": "RIGHT", "path": "pinot-controller/src/test/java/org/apache/pinot/controller/helix/PinotControllerModeTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwMTo1MDo1MlrOGxA_4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwMTo1MDo1MlrOGxA_4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA0OTc2Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    .assertEquals(\"STATE_TRANSITION\", item.getAttributeValue(ClusterConstraints.ConstraintAttribute.MESSAGE_TYPE));\n          \n          \n            \n                    .assertEquals(item.getAttributeValue(ClusterConstraints.ConstraintAttribute.MESSAGE_TYPE), Message.MessageType.STATE_TRANSITION.name());", "url": "https://github.com/apache/pinot/pull/5631#discussion_r454049763", "createdAt": "2020-07-14T01:50:52Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-controller/src/test/java/org/apache/pinot/controller/helix/PinotControllerModeTest.java", "diffHunk": "@@ -248,6 +253,16 @@ public void testPinotOnlyController() {\n     helixOnlyController.stop();\n   }\n \n+  private void checkHelixConstraints(HelixAdmin helixAdmin) {\n+    ClusterConstraints constraints =\n+        helixAdmin.getConstraints(getHelixClusterName(), ClusterConstraints.ConstraintType.MESSAGE_CONSTRAINT);\n+    ConstraintItem item = constraints.getConstraintItem(\"MaxStateTransitionsPerInstance\");\n+    Assert.assertEquals(\".*\", item.getAttributeValue(ClusterConstraints.ConstraintAttribute.INSTANCE));\n+    Assert\n+        .assertEquals(\"STATE_TRANSITION\", item.getAttributeValue(ClusterConstraints.ConstraintAttribute.MESSAGE_TYPE));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef30557e5b30a85b3dc94e5a4144be4496561b87"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzMTg4MDU3OnYy", "diffSide": "RIGHT", "path": "pinot-controller/src/test/java/org/apache/pinot/controller/helix/PinotControllerModeTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwMTo1MjowNlrOGxBBPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwMTo1MjowNlrOGxBBPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA1MDEwOA==", "bodyText": "Please reverse the arguments for all the asserts, where the first should be actual, and the second should be expected.", "url": "https://github.com/apache/pinot/pull/5631#discussion_r454050108", "createdAt": "2020-07-14T01:52:06Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-controller/src/test/java/org/apache/pinot/controller/helix/PinotControllerModeTest.java", "diffHunk": "@@ -248,6 +253,16 @@ public void testPinotOnlyController() {\n     helixOnlyController.stop();\n   }\n \n+  private void checkHelixConstraints(HelixAdmin helixAdmin) {\n+    ClusterConstraints constraints =\n+        helixAdmin.getConstraints(getHelixClusterName(), ClusterConstraints.ConstraintType.MESSAGE_CONSTRAINT);\n+    ConstraintItem item = constraints.getConstraintItem(\"MaxStateTransitionsPerInstance\");\n+    Assert.assertEquals(\".*\", item.getAttributeValue(ClusterConstraints.ConstraintAttribute.INSTANCE));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef30557e5b30a85b3dc94e5a4144be4496561b87"}, "originalPosition": 47}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4399, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}