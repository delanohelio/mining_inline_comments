{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg0MjkzMzM3", "number": 6001, "title": "[TE] entity anomaly logging for ad-hoc debugging", "bodyText": "", "createdAt": "2020-09-10T20:22:21Z", "url": "https://github.com/apache/pinot/pull/6001", "merged": true, "mergeCommit": {"oid": "143f398fc1a3e23df991c43820049ad3cd1dc730"}, "closed": true, "closedAt": "2020-09-13T21:55:08Z", "author": {"login": "akshayrai"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHmsrhAH2gAyNDg0MjkzMzM3OjE2OTJkZjkzOWJkMjQ0ZTgyZTdmZTExNTkxNzY1MjZiYTUxMDhmYzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdH8JjxgFqTQ4NzEzMDY2NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1692df939bd244e82e7fe1159176526ba5108fc4", "author": {"user": {"login": "akshayrai", "name": "Akshay Rai"}}, "url": "https://github.com/apache/pinot/commit/1692df939bd244e82e7fe1159176526ba5108fc4", "committedDate": "2020-09-10T20:19:54Z", "message": "Test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2OTE3NzI1", "url": "https://github.com/apache/pinot/pull/6001#pullrequestreview-486917725", "createdAt": "2020-09-11T15:40:38Z", "commit": {"oid": "1692df939bd244e82e7fe1159176526ba5108fc4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MDg5MjEw", "url": "https://github.com/apache/pinot/pull/6001#pullrequestreview-487089210", "createdAt": "2020-09-11T20:01:27Z", "commit": {"oid": "1692df939bd244e82e7fe1159176526ba5108fc4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQyMDowMToyN1rOHQsLSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQyMDowMToyN1rOHQsLSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI2MzA0OQ==", "bodyText": "hide the user name here?", "url": "https://github.com/apache/pinot/pull/6001#discussion_r487263049", "createdAt": "2020-09-11T20:01:27Z", "author": {"login": "jihaozh"}, "path": "thirdeye/thirdeye-pinot/src/test/java/org/apache/pinot/thirdeye/tools/RunAdhocDatabaseQueriesTool.java", "diffHunk": "@@ -723,9 +741,65 @@ private void rollbackMigrateSubscriptionWatermarks() {\n     }\n   }\n \n-  public static void main(String[] args) throws Exception {\n+  private void printEntityAnomalyDetails(MergedAnomalyResultDTO anomaly, String indent, int index) {\n+    LOG.info(\"\");\n+    LOG.info(\"Exploring Entity Anomaly {} with id {}\", index, anomaly.getId());\n+    LOG.info(ENTITY_STATS_TEMPLATE, anomaly.getChildren().size(), anomaly.getProperties());\n+    LOG.info(ENTITY_TIME_TEMPLATE,\n+        new DateTime(anomaly.getCreatedTime(), TIMEZONE),\n+        DATE_FORMAT.print(new DateTime(anomaly.getStartTime(), TIMEZONE)),\n+        DATE_FORMAT.print(new DateTime(anomaly.getEndTime(), TIMEZONE)));\n+  }\n \n-    File persistenceFile = new File(\"/Users/akrai/persistence-linux.yml\");\n+  /**\n+   * Visualizes the entity anomalies by printing them\n+   *\n+   * Eg: dq.printEntityAnomalyTrees(158750221, 0, System.currentTimeMillis())\n+   *\n+   * @param detectionId The detection id whose anomalies need to be printed\n+   * @param start The start time of the anomaly slice\n+   * @param end The end time of the anomaly slice\n+   */\n+  private void printEntityAnomalyTrees(long detectionId, long start, long end) {\n+    TimeSeriesLoader timeseriesLoader =\n+        new DefaultTimeSeriesLoader(metricConfigDAO, datasetConfigDAO,\n+            ThirdEyeCacheRegistry.getInstance().getQueryCache(),\n+            ThirdEyeCacheRegistry.getInstance().getTimeSeriesCache());\n+    AggregationLoader aggregationLoader =\n+        new DefaultAggregationLoader(metricConfigDAO, datasetConfigDAO,\n+            ThirdEyeCacheRegistry.getInstance().getQueryCache(),\n+            ThirdEyeCacheRegistry.getInstance().getDatasetMaxDataTimeCache());\n+    DefaultDataProvider provider =\n+        new DefaultDataProvider(metricConfigDAO, datasetConfigDAO, eventDAO, mergedResultDAO,\n+            DAORegistry.getInstance().getEvaluationManager(), timeseriesLoader, aggregationLoader,\n+            new DetectionPipelineLoader(), TimeSeriesCacheBuilder.getInstance(), AnomaliesCacheBuilder.getInstance());\n+\n+    AnomalySlice anomalySlice = new AnomalySlice();\n+    anomalySlice = anomalySlice.withDetectionId(detectionId).withStart(start).withEnd(end);\n+    Multimap<AnomalySlice, MergedAnomalyResultDTO>\n+        sliceToAnomaliesMap = provider.fetchAnomalies(Collections.singletonList(anomalySlice));\n+\n+    LOG.info(\"Total number of entity anomalies = \" + sliceToAnomaliesMap.values().size());\n+\n+    int i = 1;\n+    for (MergedAnomalyResultDTO parentAnomaly : sliceToAnomaliesMap.values()) {\n+      printEntityAnomalyDetails(parentAnomaly, \"\", i);\n+      int j = 1;\n+      for (MergedAnomalyResultDTO child : parentAnomaly.getChildren()) {\n+        printEntityAnomalyDetails(parentAnomaly, \"\\t\", j);\n+        int k = 1;\n+        for (MergedAnomalyResultDTO grandchild : child.getChildren()) {\n+          printEntityAnomalyDetails(grandchild, \"\\t\\t\", k);\n+          k++;\n+        }\n+        j++;\n+      }\n+      i++;\n+    }\n+  }\n+\n+  public static void main(String[] args) throws Exception {\n+    File persistenceFile = new File(\"/Users/akrai/persistence-local.yml\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1692df939bd244e82e7fe1159176526ba5108fc4"}, "originalPosition": 119}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "530e75f058650686b5008970630f5c6a585cadcb", "author": {"user": {"login": "akshayrai", "name": "Akshay Rai"}}, "url": "https://github.com/apache/pinot/commit/530e75f058650686b5008970630f5c6a585cadcb", "committedDate": "2020-09-11T20:49:02Z", "message": "Updated persistence path"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MTE3MzU1", "url": "https://github.com/apache/pinot/pull/6001#pullrequestreview-487117355", "createdAt": "2020-09-11T20:52:22Z", "commit": {"oid": "530e75f058650686b5008970630f5c6a585cadcb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MTMwNjY0", "url": "https://github.com/apache/pinot/pull/6001#pullrequestreview-487130664", "createdAt": "2020-09-11T21:19:27Z", "commit": {"oid": "530e75f058650686b5008970630f5c6a585cadcb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 8, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}