{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4OTcyNzcx", "number": 6031, "title": "Handle the partitioning mismatch between table config and stream", "bodyText": "Description\nFix for #6029\nIn consuming segment, update the partition info when ingesting new records. Log a warning and emit a metric REALTIME_PARTITION_MISMATCH when the partition is not aligned with the stream partition. The updated partition info will be persisted in the segment metadata, and when the segment is committed, also update the partition info stored in the segment ZK metadata.\nAdded SegmentPartitionLLCRealtimeClusterIntegrationTest to test the expected behavior.\nNOTE: With the fix, the consuming segment can still be pruned out incorrectly if the partition info in the table config does not align with the stream. To fix that, we can only persist the partition info for the completed segments, but not the consuming segments. Need some perf test to verify the performance penalty.", "createdAt": "2020-09-17T22:57:24Z", "url": "https://github.com/apache/pinot/pull/6031", "merged": true, "mergeCommit": {"oid": "919f40764b1057e80be1e96daed8af929601360f"}, "closed": true, "closedAt": "2020-09-19T18:56:45Z", "author": {"login": "Jackie-Jiang"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJ5evPgBqjM3ODAyNzAxNzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdKNnFWAFqTQ5MTgyMDcyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d5338a9c3b5d25badd51cb2e6f8c8714f41ef39", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/2d5338a9c3b5d25badd51cb2e6f8c8714f41ef39", "committedDate": "2020-09-17T22:43:18Z", "message": "Handle the partitioning mismatch between table config and stream"}, "afterCommit": {"oid": "fcf2b7ad3d76fab37919285492312b8378f710fb", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/fcf2b7ad3d76fab37919285492312b8378f710fb", "committedDate": "2020-09-17T23:19:56Z", "message": "Handle the partitioning mismatch between table config and stream"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNjA2OTgx", "url": "https://github.com/apache/pinot/pull/6031#pullrequestreview-491606981", "createdAt": "2020-09-18T16:18:01Z", "commit": {"oid": "fcf2b7ad3d76fab37919285492312b8378f710fb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNjoxODowMVrOHUTqyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNjoxODowMVrOHUTqyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1NTgxNw==", "bodyText": "Do we also test partition function and num partitions change?", "url": "https://github.com/apache/pinot/pull/6031#discussion_r491055817", "createdAt": "2020-09-18T16:18:01Z", "author": {"login": "mayankshriv"}, "path": "pinot-integration-tests/src/test/java/org/apache/pinot/integration/tests/SegmentPartitionLLCRealtimeClusterIntegrationTest.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.integration.tests;\n+\n+import java.io.File;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import javax.annotation.Nullable;\n+import org.apache.commons.io.FileUtils;\n+import org.apache.pinot.common.metadata.segment.ColumnPartitionMetadata;\n+import org.apache.pinot.common.metadata.segment.RealtimeSegmentZKMetadata;\n+import org.apache.pinot.common.metadata.segment.SegmentPartitionMetadata;\n+import org.apache.pinot.common.utils.CommonConstants.Segment.Realtime.Status;\n+import org.apache.pinot.common.utils.LLCSegmentName;\n+import org.apache.pinot.spi.config.table.ColumnPartitionConfig;\n+import org.apache.pinot.spi.config.table.IndexingConfig;\n+import org.apache.pinot.spi.config.table.SegmentPartitionConfig;\n+import org.apache.pinot.spi.config.table.TableConfig;\n+import org.apache.pinot.spi.data.FieldSpec.DataType;\n+import org.apache.pinot.spi.data.Schema;\n+import org.apache.pinot.util.TestUtils;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.assertNotNull;\n+import static org.testng.Assert.assertTrue;\n+\n+\n+/**\n+ * Integration test that enables segment partition for the LLC real-time table.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcf2b7ad3d76fab37919285492312b8378f710fb"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNjAzMzg4", "url": "https://github.com/apache/pinot/pull/6031#pullrequestreview-491603388", "createdAt": "2020-09-18T16:12:56Z", "commit": {"oid": "fcf2b7ad3d76fab37919285492312b8378f710fb"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNjoxMjo1NlrOHUTgVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNjoyNjozNVrOHUT9aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1MzE0Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                //       partition of the segment can be different from the stream partition.\n          \n          \n            \n                //       partition of the segment is undefined", "url": "https://github.com/apache/pinot/pull/6031#discussion_r491053143", "createdAt": "2020-09-18T16:12:56Z", "author": {"login": "mcvsubbu"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/realtime/PinotLLCRealtimeSegmentManager.java", "diffHunk": "@@ -510,6 +511,11 @@ private LLCRealtimeSegmentZKMetadata updateCommittingSegmentZKMetadata(String re\n     committingSegmentZKMetadata.setIndexVersion(segmentMetadata.getVersion());\n     committingSegmentZKMetadata.setTotalDocs(segmentMetadata.getTotalDocs());\n \n+    // Update the partition metadata based on the segment metadata\n+    // NOTE: When the stream partition changes, or the records are not properly partitioned from the stream, the\n+    //       partition of the segment can be different from the stream partition.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcf2b7ad3d76fab37919285492312b8378f710fb"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1Mzg4Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private SegmentPartitionMetadata getPartitionMetadataFromTableConfig(TableConfig tableConfig, int numPartitions,\n          \n          \n            \n              private SegmentPartitionMetadata getPartitionMetadataFromTableConfig(TableConfig tableConfig, int numStreamPartitions,", "url": "https://github.com/apache/pinot/pull/6031#discussion_r491053883", "createdAt": "2020-09-18T16:14:16Z", "author": {"login": "mcvsubbu"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/realtime/PinotLLCRealtimeSegmentManager.java", "diffHunk": "@@ -560,7 +566,8 @@ private void createNewSegmentZKMetadata(TableConfig tableConfig, PartitionLevelS\n   }\n \n   @Nullable\n-  private SegmentPartitionMetadata getPartitionMetadataFromTableConfig(TableConfig tableConfig, int partitionId) {\n+  private SegmentPartitionMetadata getPartitionMetadataFromTableConfig(TableConfig tableConfig, int numPartitions,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcf2b7ad3d76fab37919285492312b8378f710fb"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1NDQ4NA==", "bodyText": "Can we add the metric on the controller instead? If it happens for one stream partition, it is highly likely that it will happen to all partitions, so might as well reduce noise", "url": "https://github.com/apache/pinot/pull/6031#discussion_r491054484", "createdAt": "2020-09-18T16:15:18Z", "author": {"login": "mcvsubbu"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/metrics/ServerMeter.java", "diffHunk": "@@ -39,6 +39,7 @@\n   REALTIME_CONSUMPTION_EXCEPTIONS(\"exceptions\", true),\n   REALTIME_OFFSET_COMMITS(\"commits\", true),\n   REALTIME_OFFSET_COMMIT_EXCEPTIONS(\"exceptions\", false),\n+  REALTIME_PARTITION_MISMATCH(\"mismatch\", false),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcf2b7ad3d76fab37919285492312b8378f710fb"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA2MDU4Nw==", "bodyText": "We don't recognize new partitions instantly. Everytime the realtime validation manager runs, it checks if the number of aprtitions have changed, and if so, starts a new consuming partition.\nLet us say at time T1 we checked and the partition number did not change\nAt time T1 + 10, the partition numbers changed, but we did not know. The stream divided the records into a different partitioning system, thus having mismatched rows in (most likely) all partitions . At time T1 + 50, we check again, and create the new consuming segment for the new partition we detected.\nIn this case, all the segments that have the mismatched rows should be marked as not belonging to any partition.\nI am not sure this condition is being handled", "url": "https://github.com/apache/pinot/pull/6031#discussion_r491060587", "createdAt": "2020-09-18T16:26:35Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/LLRealtimeSegmentDataManager.java", "diffHunk": "@@ -1204,13 +1207,20 @@ public LLRealtimeSegmentDataManager(RealtimeSegmentZKMetadata segmentZKMetadata,\n         String partitionColumn = entry.getKey();\n         ColumnPartitionConfig columnPartitionConfig = entry.getValue();\n         String partitionFunctionName = columnPartitionConfig.getFunctionName();\n+\n+        // NOTE: Here we compare the number of partitions from the config and the stream, and log a warning and emit a\n+        //       metric when they don't match, but use the one from the stream. The mismatch could happen when the\n+        //       stream partitions are changed, but the table config has not been updated to reflect the change. In such\n+        //       case, picking the number of partitions from the stream can keep the segment properly partitioned as", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcf2b7ad3d76fab37919285492312b8378f710fb"}, "originalPosition": 71}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNzgzNTk2", "url": "https://github.com/apache/pinot/pull/6031#pullrequestreview-491783596", "createdAt": "2020-09-18T21:11:32Z", "commit": {"oid": "fcf2b7ad3d76fab37919285492312b8378f710fb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMToxMTozMlrOHUcBjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMToxMTozMlrOHUcBjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE5MjcxOQ==", "bodyText": "For realtime table, maybe we should not have the num partitions in the tableconfig. It can be set to -1, to indicate that it needs to come from the stream.", "url": "https://github.com/apache/pinot/pull/6031#discussion_r491192719", "createdAt": "2020-09-18T21:11:32Z", "author": {"login": "mcvsubbu"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/realtime/PinotLLCRealtimeSegmentManager.java", "diffHunk": "@@ -569,13 +576,44 @@ private SegmentPartitionMetadata getPartitionMetadataFromTableConfig(TableConfig\n     for (Map.Entry<String, ColumnPartitionConfig> entry : partitionConfig.getColumnPartitionMap().entrySet()) {\n       String columnName = entry.getKey();\n       ColumnPartitionConfig columnPartitionConfig = entry.getValue();\n+\n+      // NOTE: Here we compare the number of partitions from the config and the stream, and log a warning when they\n+      //       don't match, but use the one from the stream. The mismatch could happen when the stream partitions are\n+      //       changed, but the table config has not been updated to reflect the change. In such case, picking the\n+      //       number of partitions from the stream can keep the segment properly partitioned as long as the partition\n+      //       function is not changed.\n+      if (columnPartitionConfig.getNumPartitions() != numPartitions) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcf2b7ad3d76fab37919285492312b8378f710fb"}, "originalPosition": 49}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fcf2b7ad3d76fab37919285492312b8378f710fb", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/fcf2b7ad3d76fab37919285492312b8378f710fb", "committedDate": "2020-09-17T23:19:56Z", "message": "Handle the partitioning mismatch between table config and stream"}, "afterCommit": {"oid": "6a2fc33c7c37aa60061da436457df2986adf50fa", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/6a2fc33c7c37aa60061da436457df2986adf50fa", "committedDate": "2020-09-18T21:18:00Z", "message": "Handle the partitioning mismatch between table config and stream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "750a9857b80af5cecc58c5d3b3e9f060dabd3bad", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/750a9857b80af5cecc58c5d3b3e9f060dabd3bad", "committedDate": "2020-09-18T22:04:29Z", "message": "Handle the partitioning mismatch between table config and stream"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6a2fc33c7c37aa60061da436457df2986adf50fa", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/6a2fc33c7c37aa60061da436457df2986adf50fa", "committedDate": "2020-09-18T21:18:00Z", "message": "Handle the partitioning mismatch between table config and stream"}, "afterCommit": {"oid": "750a9857b80af5cecc58c5d3b3e9f060dabd3bad", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/750a9857b80af5cecc58c5d3b3e9f060dabd3bad", "committedDate": "2020-09-18T22:04:29Z", "message": "Handle the partitioning mismatch between table config and stream"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxODIwNzI2", "url": "https://github.com/apache/pinot/pull/6031#pullrequestreview-491820726", "createdAt": "2020-09-18T22:46:18Z", "commit": {"oid": "6a2fc33c7c37aa60061da436457df2986adf50fa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 64, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}