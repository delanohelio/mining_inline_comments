{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2NTgxMDU5", "number": 5589, "title": "Fix server log for execution stats", "bodyText": "Description\nCouple of minor fixes:\n\n\nBoth server and broker log write requestId, but they write in a different manner. After looking into the server log for processed queries and then looking into the broker log with corresponding requestId (to look at the actual query) requires :set ic and use = instead of : to grep in the broker log with that requestId. A mere copy paste won't work and it wastes time while debugging. This PR makes both server and broker log write requestID in the same manner\n\n\nOn the server side, also log requestDeserialization, responseSerialization times.\n\n\nUpgrade Notes\nDoes this PR prevent a zero down-time upgrade? (Assume upgrade order: Controller, Broker, Server, Minion)\nNo\nDoes this PR fix a zero-downtime upgrade introduced earlier?\nNo\nDoes this PR otherwise need attention when creating release notes? Things to consider:\nNo\nRelease Notes\nNone\nDocumentation\nN/A", "createdAt": "2020-06-18T15:58:56Z", "url": "https://github.com/apache/pinot/pull/5589", "merged": true, "mergeCommit": {"oid": "4df2d5f0550631acc7411108e9469fcf83b9c396"}, "closed": true, "closedAt": "2020-06-18T22:07:08Z", "author": {"login": "siddharthteotia"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsguBlgFqTQzMzQzMzk5OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsl355ABqjM0NjAyMjc3NjE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNDMzOTk4", "url": "https://github.com/apache/pinot/pull/5589#pullrequestreview-433433998", "createdAt": "2020-06-18T16:05:59Z", "commit": {"oid": "cdd443ab4df72e5f3d83de1a70525d3d75e4c71c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNDMyMzA5", "url": "https://github.com/apache/pinot/pull/5589#pullrequestreview-433432309", "createdAt": "2020-06-18T16:03:55Z", "commit": {"oid": "cdd443ab4df72e5f3d83de1a70525d3d75e4c71c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNjowMzo1NlrOGl2Jcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNjowNToxOVrOGl2M-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMzNzY1MQ==", "bodyText": "There may be (are) scripts that use this log line to parse. Unless absolutely needed, let us not change the case for requestId?", "url": "https://github.com/apache/pinot/pull/5589#discussion_r442337651", "createdAt": "2020-06-18T16:03:56Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/scheduler/QueryScheduler.java", "diffHunk": "@@ -199,11 +199,13 @@ public void stop() {\n \n     if (queryLogRateLimiter.tryAcquire() || forceLog(schedulerWaitMs, numDocsScanned)) {\n       LOGGER.info(\n-          \"Processed requestId={},table={},segments(queried/processed/matched/consuming)={}/{}/{}/{},\"\n-              + \"schedulerWaitMs={},totalExecMs={},totalTimeMs={},minConsumingFreshnessMs={},broker={},\"\n-              + \"numDocsScanned={},scanInFilter={},scanPostFilter={},sched={}\",\n-          requestId, tableNameWithType, numSegmentsQueried, numSegmentsProcessed, numSegmentsMatched,\n-          numSegmentsConsuming, schedulerWaitMs, timerContext.getPhaseDurationMs(ServerQueryPhase.QUERY_PROCESSING),\n+          \"Processed RequestId:{},table:{},segments(queried/processed/matched/consuming)={}/{}/{}/{},\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdd443ab4df72e5f3d83de1a70525d3d75e4c71c"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMzODU1NQ==", "bodyText": "Can you add the new items at the end and not change the names of the variables? Is the changing of var names absolutely needed?\nIf we are trying to minimize the line length, another way of doing this will be to create a separate logger that outputs in binary, and provide a utility to read it?", "url": "https://github.com/apache/pinot/pull/5589#discussion_r442338555", "createdAt": "2020-06-18T16:05:19Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/scheduler/QueryScheduler.java", "diffHunk": "@@ -199,11 +199,13 @@ public void stop() {\n \n     if (queryLogRateLimiter.tryAcquire() || forceLog(schedulerWaitMs, numDocsScanned)) {\n       LOGGER.info(\n-          \"Processed requestId={},table={},segments(queried/processed/matched/consuming)={}/{}/{}/{},\"\n-              + \"schedulerWaitMs={},totalExecMs={},totalTimeMs={},minConsumingFreshnessMs={},broker={},\"\n-              + \"numDocsScanned={},scanInFilter={},scanPostFilter={},sched={}\",\n-          requestId, tableNameWithType, numSegmentsQueried, numSegmentsProcessed, numSegmentsMatched,\n-          numSegmentsConsuming, schedulerWaitMs, timerContext.getPhaseDurationMs(ServerQueryPhase.QUERY_PROCESSING),\n+          \"Processed RequestId:{},table:{},segments(queried/processed/matched/consuming)={}/{}/{}/{},\"\n+              + \"schedulerWaitMs:{},reqDeserMs:{},totalExecMs:{},resSerMs:{},totalTimeMs:{},minConsumingFreshnessMs:{},broker:{},\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdd443ab4df72e5f3d83de1a70525d3d75e4c71c"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNTQ0MjA5", "url": "https://github.com/apache/pinot/pull/5589#pullrequestreview-433544209", "createdAt": "2020-06-18T18:31:21Z", "commit": {"oid": "e0236ebe210fe80a648f6a0ba0140babd75a43fb"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxODozMToyMVrOGl7Xng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxODozMToyMVrOGl7Xng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQyMzE5OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  LOGGER.info(\"Processed requestId:{},table:{},segments(queried/processed/matched/consuming)={}/{}/{}/{},\"\n          \n          \n            \n                  LOGGER.info(\"Processed requestId:{},table:{},segments(queried/processed/matched/consuming):{}/{}/{}/{},\"", "url": "https://github.com/apache/pinot/pull/5589#discussion_r442423198", "createdAt": "2020-06-18T18:31:21Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/scheduler/QueryScheduler.java", "diffHunk": "@@ -198,12 +198,13 @@ public void stop() {\n     long schedulerWaitMs = timerContext.getPhaseDurationMs(ServerQueryPhase.SCHEDULER_WAIT);\n \n     if (queryLogRateLimiter.tryAcquire() || forceLog(schedulerWaitMs, numDocsScanned)) {\n-      LOGGER.info(\n-          \"Processed requestId={},table={},segments(queried/processed/matched/consuming)={}/{}/{}/{},\"\n-              + \"schedulerWaitMs={},totalExecMs={},totalTimeMs={},minConsumingFreshnessMs={},broker={},\"\n-              + \"numDocsScanned={},scanInFilter={},scanPostFilter={},sched={}\",\n-          requestId, tableNameWithType, numSegmentsQueried, numSegmentsProcessed, numSegmentsMatched,\n-          numSegmentsConsuming, schedulerWaitMs, timerContext.getPhaseDurationMs(ServerQueryPhase.QUERY_PROCESSING),\n+      LOGGER.info(\"Processed requestId:{},table:{},segments(queried/processed/matched/consuming)={}/{}/{}/{},\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0236ebe210fe80a648f6a0ba0140babd75a43fb"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNDkwNDg4", "url": "https://github.com/apache/pinot/pull/5589#pullrequestreview-433490488", "createdAt": "2020-06-18T17:17:07Z", "commit": {"oid": "e0236ebe210fe80a648f6a0ba0140babd75a43fb"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzoxNzowN1rOGl43LQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzoxNzowN1rOGl43LQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM4MjEyNQ==", "bodyText": "let us stick to \"name1=value1,name2=value2,....\". (IOW comma-separtated name=value, no other spaces).\nMy bad when I wrote \"variables\". I meant item names. For some reason, I thought \"schedulerWaitMs\" was changed to \"sched\" May be I was mistaken.\nSorry to harp on this, but when we look through gazillion log lines scripts help if the format is uniform.", "url": "https://github.com/apache/pinot/pull/5589#discussion_r442382125", "createdAt": "2020-06-18T17:17:07Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/scheduler/QueryScheduler.java", "diffHunk": "@@ -199,11 +199,13 @@ public void stop() {\n \n     if (queryLogRateLimiter.tryAcquire() || forceLog(schedulerWaitMs, numDocsScanned)) {\n       LOGGER.info(\n-          \"Processed requestId={},table={},segments(queried/processed/matched/consuming)={}/{}/{}/{},\"\n-              + \"schedulerWaitMs={},totalExecMs={},totalTimeMs={},minConsumingFreshnessMs={},broker={},\"\n-              + \"numDocsScanned={},scanInFilter={},scanPostFilter={},sched={}\",\n-          requestId, tableNameWithType, numSegmentsQueried, numSegmentsProcessed, numSegmentsMatched,\n-          numSegmentsConsuming, schedulerWaitMs, timerContext.getPhaseDurationMs(ServerQueryPhase.QUERY_PROCESSING),\n+          \"Processed RequestId:{},table:{},segments(queried/processed/matched/consuming)={}/{}/{}/{},\"\n+              + \"schedulerWaitMs:{},reqDeserMs:{},totalExecMs:{},resSerMs:{},totalTimeMs:{},minConsumingFreshnessMs:{},broker:{},\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMzODU1NQ=="}, "originalCommit": {"oid": "cdd443ab4df72e5f3d83de1a70525d3d75e4c71c"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNjcyOTUy", "url": "https://github.com/apache/pinot/pull/5589#pullrequestreview-433672952", "createdAt": "2020-06-18T21:52:34Z", "commit": {"oid": "484fbd684449098b68aad1da23ae09e639a2d80b"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "866dcb7a1bdf519600f562139443d409dfe368ac", "author": {"user": null}, "url": "https://github.com/apache/pinot/commit/866dcb7a1bdf519600f562139443d409dfe368ac", "committedDate": "2020-06-18T22:05:31Z", "message": "Fix server and broker log for execution stats"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4fa5bf63c4cd7515cf60bba2532b3ae4433ce7d2", "author": {"user": null}, "url": "https://github.com/apache/pinot/commit/4fa5bf63c4cd7515cf60bba2532b3ae4433ce7d2", "committedDate": "2020-06-18T21:55:00Z", "message": "new"}, "afterCommit": {"oid": "866dcb7a1bdf519600f562139443d409dfe368ac", "author": {"user": null}, "url": "https://github.com/apache/pinot/commit/866dcb7a1bdf519600f562139443d409dfe368ac", "committedDate": "2020-06-18T22:05:31Z", "message": "Fix server and broker log for execution stats"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 646, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}