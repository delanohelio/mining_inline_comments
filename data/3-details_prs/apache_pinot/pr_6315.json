{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyMTkyNTYx", "number": 6315, "title": "Fix: Close HelixAdmin appropriately, when setting up Helix Cluster.", "bodyText": "Currently, we cannot select multiple controller tests and run them in IDE successfully.\nWe see that after the first test that extends ControllerTest, the setup for next test\nis unsuccessful due to the following reason:\n\nIn startController, we setup Helix as well as Pinot Controllers.\nBoth of these end up opening a ZKClient, however, only one of them (Pinot Controller)\ncloses the zkClient.\nSince Helix controller does not close the ZKCLient, it remains alive, even after the\nfirst test's cleanup() is called.\nGiven that we use SharedZKClientFactory which is a singleton class, and when running\nmultiple tests from IDE, they use the same JVM, the second test ends up getting\nan obsolete ZKClient from preivous test, which is already disconnected.\n\nThis PR fixes the issue by appropriately closing the HelixAdmin (which closes the ZKClient)\nwhen completed.\nDescription\nAdd a description of your PR here.\nA good description should include pointers to an issue or design document, etc.\nUpgrade Notes\nDoes this PR prevent a zero down-time upgrade? (Assume upgrade order: Controller, Broker, Server, Minion)\n\n Yes (Please label as backward-incompat, and complete the section below on Release Notes)\n\nDoes this PR fix a zero-downtime upgrade introduced earlier?\n\n Yes (Please label this as backward-incompat, and complete the section below on Release Notes)\n\nDoes this PR otherwise need attention when creating release notes? Things to consider:\n\nNew configuration options\nDeprecation of configurations\nSignature changes to public methods/interfaces\nNew plugins added or old plugins removed\n\n\n Yes (Please label this PR as release-notes and complete the section on Release Notes)\n\nRelease Notes\nIf you have tagged this as either backward-incompat or release-notes,\nyou MUST add text here that you would like to see appear in release notes of the\nnext release.\nIf you have a series of commits adding or enabling a feature, then\nadd this section only in final commit that marks the feature completed.\nRefer to earlier release notes to see examples of text\nDocumentation\nIf you have introduced a new feature or configuration, please add it to the documentation as well.\nSee https://docs.pinot.apache.org/developers/developers-and-contributors/update-document", "createdAt": "2020-12-03T23:53:00Z", "url": "https://github.com/apache/pinot/pull/6315", "merged": true, "mergeCommit": {"oid": "41a77224f36557758f7962bdeb09183c68c8eb3a"}, "closed": true, "closedAt": "2020-12-04T04:25:42Z", "author": {"login": "mayankshriv"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdisJwCAFqTU0NDU1ODU1NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdisYz5gBqjQwNzAzODY0MjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NTU4NTU0", "url": "https://github.com/apache/pinot/pull/6315#pullrequestreview-544558554", "createdAt": "2020-12-03T23:56:37Z", "commit": {"oid": "4f7aa022580af7c125fdc237478932ecd7dc60f1"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMzo1NjozN1rOH-6meQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMzo1NjozN1rOH-6meQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTczMzg4MQ==", "bodyText": "You need to close it in both cases? (Move it out of the else block)", "url": "https://github.com/apache/pinot/pull/6315#discussion_r535733881", "createdAt": "2020-12-03T23:56:37Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/util/HelixSetupUtils.java", "diffHunk": "@@ -81,6 +81,7 @@ private static void setupHelixClusterIfNeeded(String helixClusterName, String zk\n       configMap.put(DEFAULT_HYPERLOGLOG_LOG2M_KEY, Integer.toString(DEFAULT_HYPERLOGLOG_LOG2M));\n       configMap.put(CommonConstants.Broker.CONFIG_OF_ENABLE_QUERY_LIMIT_OVERRIDE, Boolean.toString(false));\n       admin.setConfig(configScope, configMap);\n+      admin.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f7aa022580af7c125fdc237478932ecd7dc60f1"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e13f39ed4b29906f2759ac04dd4c3cfadc46fc16", "author": {"user": {"login": "mayankshriv", "name": "Mayank Shrivastava"}}, "url": "https://github.com/apache/pinot/commit/e13f39ed4b29906f2759ac04dd4c3cfadc46fc16", "committedDate": "2020-12-04T00:12:35Z", "message": "Fix: Close HelixAdmin appropriately, when setting up Helix Cluster.\n\nCurrently, we cannot select multiple controller tests and run them in IDE successfully.\nWe see that after the first test that extends `ControllerTest`, the setup for next test\nis unsuccessful due to the following reason:\n\n- In `startController`, we setup Helix as well as Pinot Controllers.\n- Both of these end up opening a ZKClient, however, only one of them (Pinot Controller)\n  closes the zkClient.\n- Since Helix controller does not close the ZKCLient, it remains alive, even after the\n  first test's `cleanup()` is called.\n- Given that we use SharedZKClientFactory which is a singleton class, and when running\n  multiple tests from IDE, they use the same JVM, the second test ends up getting\n  an obsolete ZKClient from preivous test, which is already disconnected.\n\nThis PR fixes the issue by appropriately closing the HelixAdmin (which closes the ZKClient)\nwhen completed."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4f7aa022580af7c125fdc237478932ecd7dc60f1", "author": {"user": {"login": "mayankshriv", "name": "Mayank Shrivastava"}}, "url": "https://github.com/apache/pinot/commit/4f7aa022580af7c125fdc237478932ecd7dc60f1", "committedDate": "2020-12-03T23:45:45Z", "message": "Fix: Close HelixAdmin appropriately, when setting up Helix Cluster.\n\nCurrently, we cannot select multiple controller tests and run them in IDE successfully.\nWe see that after the first test that extends `ControllerTest`, the setup for next test\nis unsuccessful due to the following reason:\n\n- In `startController`, we setup Helix as well as Pinot Controllers.\n- Both of these end up opening a ZKClient, however, only one of them (Pinot Controller)\n  closes the zkClient.\n- Since Helix controller does not close the ZKCLient, it remains alive, even after the\n  first test's `cleanup()` is called.\n- Given that we use SharedZKClientFactory which is a singleton class, and when running\n  multiple tests from IDE, they use the same JVM, the second test ends up getting\n  an obsolete ZKClient from preivous test, which is already disconnected.\n\nThis PR fixes the issue by appropriately closing the HelixAdmin (which closes the ZKClient)\nwhen completed."}, "afterCommit": {"oid": "e13f39ed4b29906f2759ac04dd4c3cfadc46fc16", "author": {"user": {"login": "mayankshriv", "name": "Mayank Shrivastava"}}, "url": "https://github.com/apache/pinot/commit/e13f39ed4b29906f2759ac04dd4c3cfadc46fc16", "committedDate": "2020-12-04T00:12:35Z", "message": "Fix: Close HelixAdmin appropriately, when setting up Helix Cluster.\n\nCurrently, we cannot select multiple controller tests and run them in IDE successfully.\nWe see that after the first test that extends `ControllerTest`, the setup for next test\nis unsuccessful due to the following reason:\n\n- In `startController`, we setup Helix as well as Pinot Controllers.\n- Both of these end up opening a ZKClient, however, only one of them (Pinot Controller)\n  closes the zkClient.\n- Since Helix controller does not close the ZKCLient, it remains alive, even after the\n  first test's `cleanup()` is called.\n- Given that we use SharedZKClientFactory which is a singleton class, and when running\n  multiple tests from IDE, they use the same JVM, the second test ends up getting\n  an obsolete ZKClient from preivous test, which is already disconnected.\n\nThis PR fixes the issue by appropriately closing the HelixAdmin (which closes the ZKClient)\nwhen completed."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1585, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}