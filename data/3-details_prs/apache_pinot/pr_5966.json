{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4MzExMDQz", "number": 5966, "title": "Validate timeColumnName when adding/updating schema/tableConfig", "bodyText": "Description\n#5915\nAdd validation to check that timeColumnName is in sync across the table config and schema.\nCases\n\nAdding/updating tableConfig - Find associated schema (using rawTableName or from validationConfig.getSchemaName). Check that timeColumnName is present in schema. For OFFLINE, it is possible that timeColumnName/schema is null.\nAdding/updating schema - Find associated table configs (schemaName_OFFLINE and schemaName_REALTIME) Check timeColumnName used in all associated tableConfigs also exists in schema.\n\nCorner case\nIf tableConfig has been created with a schemaName != rawTableName, then we will not be able to validate during schema add/upload.\nRelease Notes\nAfter this change,\n\nuploading a tableConfig with timeColumnName not present in schema will be disallowed (provided schema already uploaded)\nuploading schema with timeColumnName not present in the schema will be disallowed (provided schemaName = tableName)", "createdAt": "2020-09-03T02:49:04Z", "url": "https://github.com/apache/pinot/pull/5966", "merged": true, "mergeCommit": {"oid": "e0ed179c249a4affbbf0491e4140d1c9fd5e9b20"}, "closed": true, "closedAt": "2020-09-10T21:32:32Z", "author": {"login": "npawar"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFFUAXAH2gAyNDc4MzExMDQzOjhkYTlkNjJlZDIxMzIxMjBkYWZmMDIzYjM3MDFmOTI4N2ExZWExYTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHmcbegH2gAyNDc4MzExMDQzOmMzZWEyNTViNjY2NDFmMzFiMmUyZjFjNjQyYzFmZTQ0MmMxNGVlNTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8da9d62ed2132120daff023b3701f9287a1ea1a2", "author": {"user": {"login": "npawar", "name": "Neha Pawar"}}, "url": "https://github.com/apache/pinot/commit/8da9d62ed2132120daff023b3701f9287a1ea1a2", "committedDate": "2020-09-03T00:18:14Z", "message": "Validate timeColumnName when adding/updating schema/tableConfig"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6607291a6cf0f58cedbc9e275003147cde055b90", "author": {"user": {"login": "npawar", "name": "Neha Pawar"}}, "url": "https://github.com/apache/pinot/commit/6607291a6cf0f58cedbc9e275003147cde055b90", "committedDate": "2020-09-03T20:53:23Z", "message": "Fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1MjQyOTYx", "url": "https://github.com/apache/pinot/pull/5966#pullrequestreview-485242961", "createdAt": "2020-09-09T17:24:49Z", "commit": {"oid": "6607291a6cf0f58cedbc9e275003147cde055b90"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNzoyNDo0OVrOHPSaQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNzoyNDo0OVrOHPSaQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc5MjMyMA==", "bodyText": "I wonder if this (along with the getTableConfigsForSchema function) can be moved inside validate ? So that the caller doesn't have to do this every single time (and can be done implicitly)", "url": "https://github.com/apache/pinot/pull/5966#discussion_r485792320", "createdAt": "2020-09-09T17:24:49Z", "author": {"login": "icefury71"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotSchemaRestletResource.java", "diffHunk": "@@ -171,7 +173,8 @@ public SuccessResponse addSchema(\n   public String validateSchema(FormDataMultiPart multiPart) {\n     Schema schema = getSchemaFromMultiPart(multiPart);\n     try {\n-      SchemaUtils.validate(schema);\n+      List<TableConfig> tableConfigs = getTableConfigsForSchema(schema.getSchemaName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6607291a6cf0f58cedbc9e275003147cde055b90"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1MjQ0MTA3", "url": "https://github.com/apache/pinot/pull/5966#pullrequestreview-485244107", "createdAt": "2020-09-09T17:26:20Z", "commit": {"oid": "6607291a6cf0f58cedbc9e275003147cde055b90"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNzoyNjoyMFrOHPSd0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNzozODoxN1rOHPS4bA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc5MzIzMw==", "bodyText": "Same here", "url": "https://github.com/apache/pinot/pull/5966#discussion_r485793233", "createdAt": "2020-09-09T17:26:20Z", "author": {"login": "icefury71"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotTableIndexingConfigs.java", "diffHunk": "@@ -58,7 +59,8 @@ public SuccessResponse updateIndexingConfig(\n     TableConfig tableConfig;\n     try {\n       tableConfig = JsonUtils.stringToObject(tableConfigString, TableConfig.class);\n-      TableConfigUtils.validate(tableConfig);\n+      Schema schema = pinotHelixResourceManager.getSchemaForTableConfig(tableConfig);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6607291a6cf0f58cedbc9e275003147cde055b90"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc5NjMyMg==", "bodyText": "Curious - how is this related to time column field validation ?", "url": "https://github.com/apache/pinot/pull/5966#discussion_r485796322", "createdAt": "2020-09-09T17:31:25Z", "author": {"login": "icefury71"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/util/TableConfigUtils.java", "diffHunk": "@@ -74,19 +80,37 @@ public static void validateTableName(TableConfig tableConfig) {\n     }\n   }\n \n-  private static void validateValidationConfig(TableConfig tableConfig) {\n+  /**\n+   * Validates the following in the validationConfig of the table\n+   * 1. For REALTIME table\n+   * - checks for non-null timeColumnName\n+   * - checks for valid field spec for timeColumnName in schema\n+   *\n+   * 2. For OFFLINE table\n+   * - checks for valid field spec for timeColumnName in schema, if timeColumnName and schema re non-null\n+   *\n+   * 3. Checks peerDownloadSchema\n+   */\n+  private static void validateValidationConfig(TableConfig tableConfig, @Nullable Schema schema) {\n     SegmentsValidationAndRetentionConfig validationConfig = tableConfig.getValidationConfig();\n-    if (validationConfig != null) {\n-      if (tableConfig.getTableType() == TableType.REALTIME && validationConfig.getTimeColumnName() == null) {\n-        throw new IllegalStateException(\"Must provide time column in real-time table config\");\n-      }\n-      String peerSegmentDownloadScheme = validationConfig.getPeerSegmentDownloadScheme();\n-      if (peerSegmentDownloadScheme != null) {\n-        if (!CommonConstants.HTTP_PROTOCOL.equalsIgnoreCase(peerSegmentDownloadScheme)\n-            && !CommonConstants.HTTPS_PROTOCOL.equalsIgnoreCase(peerSegmentDownloadScheme)) {\n-          throw new IllegalStateException(\"Invalid value '\" + peerSegmentDownloadScheme\n-              + \"' for peerSegmentDownloadScheme. Must be one of http nor https\");\n-        }\n+    String timeColumnName = validationConfig.getTimeColumnName();\n+    if (tableConfig.getTableType() == TableType.REALTIME) {\n+      // For REALTIME table, must have a non-null timeColumnName\n+      Preconditions.checkState(timeColumnName != null, \"'timeColumnName' cannot be null in REALTIME table config\");\n+    }\n+    // timeColumnName can be null in OFFLINE table\n+    if (timeColumnName != null && schema != null) {\n+      Preconditions.checkState(schema.getSpecForTimeColumn(timeColumnName) != null,\n+          \"Cannot find valid fieldSpec for timeColumn: %s from the table config, in the schema: %s\", timeColumnName,\n+          schema.getSchemaName());\n+    }\n+\n+    String peerSegmentDownloadScheme = validationConfig.getPeerSegmentDownloadScheme();\n+    if (peerSegmentDownloadScheme != null) {\n+      if (!CommonConstants.HTTP_PROTOCOL.equalsIgnoreCase(peerSegmentDownloadScheme) && !CommonConstants.HTTPS_PROTOCOL", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6607291a6cf0f58cedbc9e275003147cde055b90"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc5OTg5Mg==", "bodyText": "nit: wrap with try-catch for future proofing ?", "url": "https://github.com/apache/pinot/pull/5966#discussion_r485799892", "createdAt": "2020-09-09T17:38:00Z", "author": {"login": "icefury71"}, "path": "pinot-core/src/test/java/org/apache/pinot/core/util/SchemaUtilsTest.java", "diffHunk": "@@ -35,6 +43,115 @@\n  */\n public class SchemaUtilsTest {\n \n+  private static final String TABLE_NAME = \"testTable\";\n+  private static final String TIME_COLUMN = \"timeColumn\";\n+\n+  @Test\n+  public void testCompatibilityWithTableConfig() {\n+    // empty list\n+    List<TableConfig> tableConfigs = new ArrayList<>();\n+    Schema schema = new Schema.SchemaBuilder().setSchemaName(TABLE_NAME).build();\n+    SchemaUtils.validate(schema, tableConfigs);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6607291a6cf0f58cedbc9e275003147cde055b90"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTgwMDA0NA==", "bodyText": "Same here", "url": "https://github.com/apache/pinot/pull/5966#discussion_r485800044", "createdAt": "2020-09-09T17:38:17Z", "author": {"login": "icefury71"}, "path": "pinot-core/src/test/java/org/apache/pinot/core/util/SchemaUtilsTest.java", "diffHunk": "@@ -35,6 +43,115 @@\n  */\n public class SchemaUtilsTest {\n \n+  private static final String TABLE_NAME = \"testTable\";\n+  private static final String TIME_COLUMN = \"timeColumn\";\n+\n+  @Test\n+  public void testCompatibilityWithTableConfig() {\n+    // empty list\n+    List<TableConfig> tableConfigs = new ArrayList<>();\n+    Schema schema = new Schema.SchemaBuilder().setSchemaName(TABLE_NAME).build();\n+    SchemaUtils.validate(schema, tableConfigs);\n+\n+    // offline table\n+    // null timeColumnName\n+    TableConfig tableConfig = new TableConfigBuilder(TableType.OFFLINE).setTableName(TABLE_NAME).build();\n+    SchemaUtils.validate(schema, Lists.newArrayList(tableConfig));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6607291a6cf0f58cedbc9e275003147cde055b90"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MjE3OTk1", "url": "https://github.com/apache/pinot/pull/5966#pullrequestreview-486217995", "createdAt": "2020-09-10T18:47:18Z", "commit": {"oid": "6607291a6cf0f58cedbc9e275003147cde055b90"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxODo0NzoxOFrOHQBZSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxODo1MDozMFrOHQBgIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU2MjEyMQ==", "bodyText": "schemaName should never be null", "url": "https://github.com/apache/pinot/pull/5966#discussion_r486562121", "createdAt": "2020-09-10T18:47:18Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotSchemaRestletResource.java", "diffHunk": "@@ -318,4 +324,19 @@ private void deleteSchemaInternal(String schemaName) {\n           Response.Status.INTERNAL_SERVER_ERROR);\n     }\n   }\n+\n+  private List<TableConfig> getTableConfigsForSchema(@Nullable String schemaName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6607291a6cf0f58cedbc9e275003147cde055b90"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU2Mzg3NQ==", "bodyText": "Wondering if we can move this method into PinotHelixResourceManager?", "url": "https://github.com/apache/pinot/pull/5966#discussion_r486563875", "createdAt": "2020-09-10T18:50:30Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotSchemaRestletResource.java", "diffHunk": "@@ -318,4 +324,19 @@ private void deleteSchemaInternal(String schemaName) {\n           Response.Status.INTERNAL_SERVER_ERROR);\n     }\n   }\n+\n+  private List<TableConfig> getTableConfigsForSchema(@Nullable String schemaName) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU2MjEyMQ=="}, "originalCommit": {"oid": "6607291a6cf0f58cedbc9e275003147cde055b90"}, "originalPosition": 79}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3ea255b66641f31b2e2f1c642c1fe442c14ee58", "author": {"user": {"login": "npawar", "name": "Neha Pawar"}}, "url": "https://github.com/apache/pinot/commit/c3ea255b66641f31b2e2f1c642c1fe442c14ee58", "committedDate": "2020-09-10T20:02:09Z", "message": "Move getTableConfigsForSchema into pinotHelixResourceManager"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1710, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}