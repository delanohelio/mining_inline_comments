{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyNDIzNDY4", "number": 6272, "title": "Set S3 Bucket ACL policy from config", "bodyText": "Description\nThis PR introduces a config key to decide either to grant full control to bucket(aws s3) owner or not. These will be useful when the pinot-cluster and S3 bucket are in different AWS accounts.\nHere is the issue related to this. #6161 .\nDocumentation\nRaised a pinot-contrib/pinot-docs#15 to include it in the pinot-docs specific to S3.\nNote: I've tested this in our setup and it was working as expected(controller was able to create data dir, launched an ingestion job to test pushing and loading of segments).", "createdAt": "2020-11-17T13:47:09Z", "url": "https://github.com/apache/pinot/pull/6272", "merged": true, "mergeCommit": {"oid": "f40c2aca7ecbf3b9112a7bf2fff7c0c5b75247be"}, "closed": true, "closedAt": "2020-11-18T07:04:01Z", "author": {"login": "Aka-shi"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddYhotAH2gAyNTIyNDIzNDY4OjIzZjk2ZjI1MmE2Nzg0MDhlNzY3MjQ4NGZiM2RjNDNkNDdjYzFjN2M=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddlo2qgFqTUzMzA3OTEwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "23f96f252a678408e7672484fb3dc43d47cc1c7c", "author": {"user": {"login": "Aka-shi", "name": "Tanmay Krishna"}}, "url": "https://github.com/apache/pinot/commit/23f96f252a678408e7672484fb3dc43d47cc1c7c", "committedDate": "2020-11-17T12:15:30Z", "message": "[pinot-s3] Set acl based on config"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNjAyMTM4", "url": "https://github.com/apache/pinot/pull/6272#pullrequestreview-532602138", "createdAt": "2020-11-17T17:13:26Z", "commit": {"oid": "23f96f252a678408e7672484fb3dc43d47cc1c7c"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyODc5NTIx", "url": "https://github.com/apache/pinot/pull/6272#pullrequestreview-532879521", "createdAt": "2020-11-17T22:52:01Z", "commit": {"oid": "23f96f252a678408e7672484fb3dc43d47cc1c7c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMjo1MjowMVrOH1OxSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMjo1MjowMVrOH1OxSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU3ODU2OQ==", "bodyText": "if (!disableAcl) {\n    copyReqBuilder.acl(ObjectCannedACL.BUCKET_OWNER_FULL_CONTROL);\n} \nCopyObjectRequest copyReq = copyReqBuilder.build();", "url": "https://github.com/apache/pinot/pull/6272#discussion_r525578569", "createdAt": "2020-11-17T22:52:01Z", "author": {"login": "xiangfu0"}, "path": "pinot-plugins/pinot-file-system/pinot-s3/src/main/java/org/apache/pinot/plugin/filesystem/S3PinotFS.java", "diffHunk": "@@ -225,9 +225,15 @@ private boolean copyFile(URI srcUri, URI dstUri)\n       }\n \n       String dstPath = sanitizePath(dstUri.getPath());\n-      CopyObjectRequest copyReq =\n-          CopyObjectRequest.builder().copySource(encodedUrl).destinationBucket(dstUri.getHost()).destinationKey(dstPath)\n-              .build();\n+      CopyObjectRequest.Builder copyReqBuilder = CopyObjectRequest.builder().copySource(encodedUrl)\n+          .destinationBucket(dstUri.getHost()).destinationKey(dstPath);\n+      CopyObjectRequest copyReq;\n+\n+      if (!disableAcl) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23f96f252a678408e7672484fb3dc43d47cc1c7c"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyODc5Nzc3", "url": "https://github.com/apache/pinot/pull/6272#pullrequestreview-532879777", "createdAt": "2020-11-17T22:52:29Z", "commit": {"oid": "23f96f252a678408e7672484fb3dc43d47cc1c7c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMjo1MjozMFrOH1OyKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMjo1MjozMFrOH1OyKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU3ODc5Mw==", "bodyText": "same above", "url": "https://github.com/apache/pinot/pull/6272#discussion_r525578793", "createdAt": "2020-11-17T22:52:30Z", "author": {"login": "xiangfu0"}, "path": "pinot-plugins/pinot-file-system/pinot-s3/src/main/java/org/apache/pinot/plugin/filesystem/S3PinotFS.java", "diffHunk": "@@ -248,7 +254,14 @@ public boolean mkdir(URI uri)\n         return true;\n       }\n \n-      PutObjectRequest putObjectRequest = PutObjectRequest.builder().bucket(uri.getHost()).key(path).build();\n+      PutObjectRequest.Builder putReqBuilder = PutObjectRequest.builder().bucket(uri.getHost()).key(path);\n+      PutObjectRequest putObjectRequest;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23f96f252a678408e7672484fb3dc43d47cc1c7c"}, "originalPosition": 80}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyODg0NDEz", "url": "https://github.com/apache/pinot/pull/6272#pullrequestreview-532884413", "createdAt": "2020-11-17T23:01:05Z", "commit": {"oid": "23f96f252a678408e7672484fb3dc43d47cc1c7c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzowMTowNVrOH1PBqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzowMTowNVrOH1PBqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU4Mjc2MA==", "bodyText": "just set builder here and build the request later.", "url": "https://github.com/apache/pinot/pull/6272#discussion_r525582760", "createdAt": "2020-11-17T23:01:05Z", "author": {"login": "xiangfu0"}, "path": "pinot-plugins/pinot-file-system/pinot-s3/src/main/java/org/apache/pinot/plugin/filesystem/S3PinotFS.java", "diffHunk": "@@ -491,17 +511,32 @@ public boolean touch(URI uri)\n       String path = sanitizePath(uri.getPath());\n       Map<String, String> mp = new HashMap<>();\n       mp.put(\"lastModified\", String.valueOf(System.currentTimeMillis()));\n-      CopyObjectRequest request =\n-          CopyObjectRequest.builder().copySource(encodedUrl).destinationBucket(uri.getHost()).destinationKey(path)\n-              .metadata(mp).metadataDirective(MetadataDirective.REPLACE).build();\n+      CopyObjectRequest.Builder copyReqBuilder = CopyObjectRequest.builder().copySource(encodedUrl)\n+          .destinationBucket(uri.getHost()).destinationKey(path)\n+          .metadata(mp).metadataDirective(MetadataDirective.REPLACE);\n+      CopyObjectRequest request;\n+\n+      if (!disableAcl) {\n+        request = copyReqBuilder.acl(ObjectCannedACL.BUCKET_OWNER_FULL_CONTROL).build();\n+      } else {\n+        request = copyReqBuilder.build();\n+      }\n \n       _s3Client.copyObject(request);\n       long newUpdateTime = getS3ObjectMetadata(uri).lastModified().toEpochMilli();\n       return newUpdateTime > s3ObjectMetadata.lastModified().toEpochMilli();\n     } catch (NoSuchKeyException e) {\n       String path = sanitizePath(uri.getPath());\n-      _s3Client.putObject(PutObjectRequest.builder().bucket(uri.getHost()).key(path).build(),\n-          RequestBody.fromBytes(new byte[0]));\n+      PutObjectRequest.Builder putReqBuilder = PutObjectRequest.builder().bucket(uri.getHost()).key(path);\n+      PutObjectRequest putObjectRequest;\n+\n+      if (!disableAcl) {\n+        putObjectRequest = putReqBuilder.acl(ObjectCannedACL.BUCKET_OWNER_FULL_CONTROL).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23f96f252a678408e7672484fb3dc43d47cc1c7c"}, "originalPosition": 164}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyODg0NDc4", "url": "https://github.com/apache/pinot/pull/6272#pullrequestreview-532884478", "createdAt": "2020-11-17T23:01:14Z", "commit": {"oid": "23f96f252a678408e7672484fb3dc43d47cc1c7c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzowMToxNFrOH1PB2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzowMToxNFrOH1PB2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU4MjgwOA==", "bodyText": "set builder here and build the request later.", "url": "https://github.com/apache/pinot/pull/6272#discussion_r525582808", "createdAt": "2020-11-17T23:01:14Z", "author": {"login": "xiangfu0"}, "path": "pinot-plugins/pinot-file-system/pinot-s3/src/main/java/org/apache/pinot/plugin/filesystem/S3PinotFS.java", "diffHunk": "@@ -491,17 +511,32 @@ public boolean touch(URI uri)\n       String path = sanitizePath(uri.getPath());\n       Map<String, String> mp = new HashMap<>();\n       mp.put(\"lastModified\", String.valueOf(System.currentTimeMillis()));\n-      CopyObjectRequest request =\n-          CopyObjectRequest.builder().copySource(encodedUrl).destinationBucket(uri.getHost()).destinationKey(path)\n-              .metadata(mp).metadataDirective(MetadataDirective.REPLACE).build();\n+      CopyObjectRequest.Builder copyReqBuilder = CopyObjectRequest.builder().copySource(encodedUrl)\n+          .destinationBucket(uri.getHost()).destinationKey(path)\n+          .metadata(mp).metadataDirective(MetadataDirective.REPLACE);\n+      CopyObjectRequest request;\n+\n+      if (!disableAcl) {\n+        request = copyReqBuilder.acl(ObjectCannedACL.BUCKET_OWNER_FULL_CONTROL).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23f96f252a678408e7672484fb3dc43d47cc1c7c"}, "originalPosition": 148}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyODg0NTE4", "url": "https://github.com/apache/pinot/pull/6272#pullrequestreview-532884518", "createdAt": "2020-11-17T23:01:18Z", "commit": {"oid": "23f96f252a678408e7672484fb3dc43d47cc1c7c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzowMToxOFrOH1PB9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzowMToxOFrOH1PB9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU4MjgzOA==", "bodyText": "set builder here and build the request later.", "url": "https://github.com/apache/pinot/pull/6272#discussion_r525582838", "createdAt": "2020-11-17T23:01:18Z", "author": {"login": "xiangfu0"}, "path": "pinot-plugins/pinot-file-system/pinot-s3/src/main/java/org/apache/pinot/plugin/filesystem/S3PinotFS.java", "diffHunk": "@@ -445,7 +458,14 @@ public void copyFromLocalFile(File srcFile, URI dstUri)\n     LOGGER.info(\"Copy {} from local to {}\", srcFile.getAbsolutePath(), dstUri);\n     URI base = getBase(dstUri);\n     String prefix = sanitizePath(base.relativize(dstUri).getPath());\n-    PutObjectRequest putObjectRequest = PutObjectRequest.builder().bucket(dstUri.getHost()).key(prefix).build();\n+    PutObjectRequest.Builder putReqBuilder = PutObjectRequest.builder().bucket(dstUri.getHost()).key(prefix);\n+    PutObjectRequest putObjectRequest;\n+\n+    if (!disableAcl) {\n+      putObjectRequest = putReqBuilder.acl(ObjectCannedACL.BUCKET_OWNER_FULL_CONTROL).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23f96f252a678408e7672484fb3dc43d47cc1c7c"}, "originalPosition": 117}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyOTU3NTYy", "url": "https://github.com/apache/pinot/pull/6272#pullrequestreview-532957562", "createdAt": "2020-11-18T01:48:11Z", "commit": {"oid": "aca31361ac8819ce1cdb978c58f40ae10ef24985"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwMTo0ODoxMlrOH1SoGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwMTo0ODoxMlrOH1SoGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTY0MTc1Mw==", "bodyText": "do we need to set the default value ?\nalso use boolean not Boolean", "url": "https://github.com/apache/pinot/pull/6272#discussion_r525641753", "createdAt": "2020-11-18T01:48:12Z", "author": {"login": "xiangfu0"}, "path": "pinot-plugins/pinot-file-system/pinot-s3/src/main/java/org/apache/pinot/plugin/filesystem/S3PinotFS.java", "diffHunk": "@@ -72,17 +70,19 @@\n   public static final String SECRET_KEY = \"secretKey\";\n   public static final String REGION = \"region\";\n   public static final String ENDPOINT = \"endpoint\";\n+  public static final String DISABLE_ACL = \"disableAcl\";\n \n   private static final Logger LOGGER = LoggerFactory.getLogger(S3PinotFS.class);\n   private static final String DELIMITER = \"/\";\n   public static final String S3_SCHEME = \"s3://\";\n   private S3Client _s3Client;\n+  private Boolean disableAcl = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aca31361ac8819ce1cdb978c58f40ae10ef24985"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyOTYyMTQx", "url": "https://github.com/apache/pinot/pull/6272#pullrequestreview-532962141", "createdAt": "2020-11-18T01:50:59Z", "commit": {"oid": "aca31361ac8819ce1cdb978c58f40ae10ef24985"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwMTo1MDo1OVrOH1Srlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwMTo1MDo1OVrOH1Srlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTY0MjY0Ng==", "bodyText": "Create constant  DEFAULT_DISABLE_ACL=true and use it here.", "url": "https://github.com/apache/pinot/pull/6272#discussion_r525642646", "createdAt": "2020-11-18T01:50:59Z", "author": {"login": "xiangfu0"}, "path": "pinot-plugins/pinot-file-system/pinot-s3/src/main/java/org/apache/pinot/plugin/filesystem/S3PinotFS.java", "diffHunk": "@@ -72,17 +70,19 @@\n   public static final String SECRET_KEY = \"secretKey\";\n   public static final String REGION = \"region\";\n   public static final String ENDPOINT = \"endpoint\";\n+  public static final String DISABLE_ACL = \"disableAcl\";\n \n   private static final Logger LOGGER = LoggerFactory.getLogger(S3PinotFS.class);\n   private static final String DELIMITER = \"/\";\n   public static final String S3_SCHEME = \"s3://\";\n   private S3Client _s3Client;\n+  private Boolean disableAcl = true;\n \n   @Override\n   public void init(PinotConfiguration config) {\n     Preconditions.checkArgument(!isNullOrEmpty(config.getProperty(REGION)));\n     String region = config.getProperty(REGION);\n-\n+    disableAcl = config.getProperty(DISABLE_ACL, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aca31361ac8819ce1cdb978c58f40ae10ef24985"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyOTY5NjUz", "url": "https://github.com/apache/pinot/pull/6272#pullrequestreview-532969653", "createdAt": "2020-11-18T01:55:33Z", "commit": {"oid": "aca31361ac8819ce1cdb978c58f40ae10ef24985"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aca31361ac8819ce1cdb978c58f40ae10ef24985", "author": {"user": {"login": "Aka-shi", "name": "Tanmay Krishna"}}, "url": "https://github.com/apache/pinot/commit/aca31361ac8819ce1cdb978c58f40ae10ef24985", "committedDate": "2020-11-18T01:37:46Z", "message": "review changes"}, "afterCommit": {"oid": "79fc19a301ded04e1b16c906099c8a6239779616", "author": {"user": {"login": "Aka-shi", "name": "Tanmay Krishna"}}, "url": "https://github.com/apache/pinot/commit/79fc19a301ded04e1b16c906099c8a6239779616", "committedDate": "2020-11-18T03:00:52Z", "message": "review changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c738c91d3717f10ba0ab47e477bc9cfb193ce92d", "author": {"user": {"login": "Aka-shi", "name": "Tanmay Krishna"}}, "url": "https://github.com/apache/pinot/commit/c738c91d3717f10ba0ab47e477bc9cfb193ce92d", "committedDate": "2020-11-18T03:25:50Z", "message": "review changes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "79fc19a301ded04e1b16c906099c8a6239779616", "author": {"user": {"login": "Aka-shi", "name": "Tanmay Krishna"}}, "url": "https://github.com/apache/pinot/commit/79fc19a301ded04e1b16c906099c8a6239779616", "committedDate": "2020-11-18T03:00:52Z", "message": "review changes"}, "afterCommit": {"oid": "c738c91d3717f10ba0ab47e477bc9cfb193ce92d", "author": {"user": {"login": "Aka-shi", "name": "Tanmay Krishna"}}, "url": "https://github.com/apache/pinot/commit/c738c91d3717f10ba0ab47e477bc9cfb193ce92d", "committedDate": "2020-11-18T03:25:50Z", "message": "review changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMDc5MTAw", "url": "https://github.com/apache/pinot/pull/6272#pullrequestreview-533079100", "createdAt": "2020-11-18T03:32:09Z", "commit": {"oid": "c738c91d3717f10ba0ab47e477bc9cfb193ce92d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1812, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}