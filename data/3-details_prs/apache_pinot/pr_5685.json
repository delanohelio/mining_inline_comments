{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3NzEwMDQy", "number": 5685, "title": "Adding controller APIs to fetch brokers information", "bodyText": "Description\nAdding controller APIs to fetch brokers information\nPer issue: #5682\nSample output:\n\u279c curl localhost:9000/brokers | jq .\n{\n  \"tenants\": {\n    \"DefaultTenant\": [\n      \"Broker_127.0.0.1_8000\"\n    ]\n  },\n  \"tables\": {\n    \"airlineStats\": [\n      \"Broker_127.0.0.1_8000\"\n    ]\n  }\n}\n\n\n\u279c curl localhost:9000/brokers/tenants | jq .\n{\n  \"DefaultTenant\": [\n    \"Broker_127.0.0.1_8000\"\n  ]\n}\n\n\u279c curl localhost:9000/brokers/tenants/DefaultTenant | jq .\n[\n  \"Broker_127.0.0.1_8000\"\n]\n\n\u279c curl localhost:9000/brokers/tables | jq .\n{\n  \"airlineStats\": [\n    \"Broker_127.0.0.1_8000\"\n  ]\n}\n\n\u279c curl \"localhost:9000/brokers/tables/airlineStats?type=OFFLINE\" | jq .\n[\n  \"Broker_127.0.0.1_8000\"\n]\n\n\u279c curl \"localhost:9000/brokers/tables/airlineStats?type=REALTIME\" | jq .\n[\n  \"Broker_127.0.0.1_8000\"\n]\n\n\u279c curl localhost:9000/brokers/tables/airlineStats | jq .\n[\n  \"Broker_127.0.0.1_8000\"\n]\n\n\u279c curl localhost:9000/brokers/tables/airlineStats1 | jq .\n{\n  \"code\": 404,\n  \"error\": \"Table 'airlineStats1' not found.\"\n}\n\n\nRelease Notes\nAdding Controller APIs to fetch brokers information:\n// Return all the {state} brokers mapping of tenants/tables\nGET /brokers?state={online|offline}\n\n// Return all the {state} brokers mapping per tenants\nGET /brokers/tenants?state={online|offline}\n\n// Return {state} brokers for a given {tenant}, returns all brokers if state is not specified.\nGET /brokers/tenants/{tenant}?state={online|offline}\n\n// Return all the {state} brokers mapping per table\nGET /brokers/tables?state={online|offline}\n\n// Return {state} brokers for a given {table}_{type}, returns all brokers if state is not specified.\nGET /brokers/tables/{table}?type={REALTIME|OFFLINE}&?state={online|offline}", "createdAt": "2020-07-11T03:03:56Z", "url": "https://github.com/apache/pinot/pull/5685", "merged": true, "mergeCommit": {"oid": "25aa780814809c3290d278bb2136373865f5c947"}, "closed": true, "closedAt": "2020-07-14T23:25:59Z", "author": {"login": "xiangfu0"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczx8qvABqjM1MzYwMTc4OTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc08ZXKgBqjM1NDU4ODUzMDE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1a2f8fff33a5dccce1135ca13d00ad55b46786a5", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/1a2f8fff33a5dccce1135ca13d00ad55b46786a5", "committedDate": "2020-07-11T03:01:58Z", "message": "Adding controller APIs to fetch brokers information"}, "afterCommit": {"oid": "cda4c4f6b627f972ae002a8ff6e838742eedd8d0", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/cda4c4f6b627f972ae002a8ff6e838742eedd8d0", "committedDate": "2020-07-11T06:07:36Z", "message": "Adding controller APIs to fetch brokers information"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cda4c4f6b627f972ae002a8ff6e838742eedd8d0", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/cda4c4f6b627f972ae002a8ff6e838742eedd8d0", "committedDate": "2020-07-11T06:07:36Z", "message": "Adding controller APIs to fetch brokers information"}, "afterCommit": {"oid": "f4496ee261414d556f41f26fa4e1b650afcc9369", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/f4496ee261414d556f41f26fa4e1b650afcc9369", "committedDate": "2020-07-11T06:09:32Z", "message": "Adding controller APIs to fetch brokers information"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f02d337e5daab135e899a4bdb9a4fba0e424a68", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/2f02d337e5daab135e899a4bdb9a4fba0e424a68", "committedDate": "2020-07-11T11:06:46Z", "message": "Adding controller APIs to fetch brokers information"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f4496ee261414d556f41f26fa4e1b650afcc9369", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/f4496ee261414d556f41f26fa4e1b650afcc9369", "committedDate": "2020-07-11T06:09:32Z", "message": "Adding controller APIs to fetch brokers information"}, "afterCommit": {"oid": "2f02d337e5daab135e899a4bdb9a4fba0e424a68", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/2f02d337e5daab135e899a4bdb9a4fba0e424a68", "committedDate": "2020-07-11T11:06:46Z", "message": "Adding controller APIs to fetch brokers information"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3NDEzNzQz", "url": "https://github.com/apache/pinot/pull/5685#pullrequestreview-447413743", "createdAt": "2020-07-13T16:32:54Z", "commit": {"oid": "2f02d337e5daab135e899a4bdb9a4fba0e424a68"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNjozMjo1NFrOGwwcEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNjozMjo1NFrOGwwcEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc3ODQ1MA==", "bodyText": "use the constant from statemodel", "url": "https://github.com/apache/pinot/pull/5685#discussion_r453778450", "createdAt": "2020-07-13T16:32:54Z", "author": {"login": "kishoreg"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotBrokerRestletResource.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.controller.api.resources;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.swagger.annotations.Api;\n+import io.swagger.annotations.ApiOperation;\n+import io.swagger.annotations.ApiParam;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import javax.inject.Inject;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.PathParam;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.QueryParam;\n+import javax.ws.rs.core.MediaType;\n+import org.apache.pinot.controller.helix.core.PinotHelixResourceManager;\n+import org.apache.pinot.spi.config.table.TableType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+@Api(tags = Constants.BROKER_TAG)\n+@Path(\"/\")\n+public class PinotBrokerRestletResource {\n+  public static final Logger LOGGER = LoggerFactory.getLogger(PinotBrokerRestletResource.class);\n+\n+  @Inject\n+  PinotHelixResourceManager _pinotHelixResourceManager;\n+\n+  @GET\n+  @Produces(MediaType.APPLICATION_JSON)\n+  @Path(\"/brokers\")\n+  @ApiOperation(value = \"List tenants and tables to brokers mappings\", notes = \"List tenants and tables to brokers mappings\")\n+  public Map<String, Map<String, List<String>>> listBrokersMapping(\n+      @ApiParam(value = \"ONLINE|OFFLINE\") @QueryParam(\"state\") String state) {\n+    Map<String, Map<String, List<String>>> resultMap = new HashMap<>();\n+    resultMap.put(\"tenants\", getTenantsToBrokersMapping(state));\n+    resultMap.put(\"tables\", getTablesToBrokersMapping(state));\n+    return resultMap;\n+  }\n+\n+  @GET\n+  @Produces(MediaType.APPLICATION_JSON)\n+  @Path(\"/brokers/tenants\")\n+  @ApiOperation(value = \"List tenants to brokers mappings\", notes = \"List tenants to brokers mappings\")\n+  public Map<String, List<String>> getTenantsToBrokersMapping(\n+      @ApiParam(value = \"ONLINE|OFFLINE\") @QueryParam(\"state\") String state) {\n+    Map<String, List<String>> resultMap = new HashMap<>();\n+    _pinotHelixResourceManager.getAllBrokerTenantNames().stream()\n+        .forEach(tenant -> resultMap.put(tenant, getBrokersForTenant(tenant, state)));\n+    return resultMap;\n+  }\n+\n+  @GET\n+  @Produces(MediaType.APPLICATION_JSON)\n+  @Path(\"/brokers/tenants/{tenantName}\")\n+  @ApiOperation(value = \"List brokers for a given tenant\", notes = \"List brokers for a given tenant\")\n+  public List<String> getBrokersForTenant(\n+      @ApiParam(value = \"Name of the tenant\", required = true) @PathParam(\"tenantName\") String tenantName,\n+      @ApiParam(value = \"ONLINE|OFFLINE\") @QueryParam(\"state\") String state) {\n+    Set<String> tenantBrokers = new HashSet<>();\n+    tenantBrokers.addAll(_pinotHelixResourceManager.getAllInstancesForBrokerTenant(tenantName));\n+    applyStateChanges(tenantBrokers, state);\n+    return ImmutableList.copyOf(tenantBrokers);\n+  }\n+\n+  @GET\n+  @Produces(MediaType.APPLICATION_JSON)\n+  @Path(\"/brokers/tables\")\n+  @ApiOperation(value = \"List tables to brokers mappings\", notes = \"List tables to brokers mappings\")\n+  public Map<String, List<String>> getTablesToBrokersMapping(\n+      @ApiParam(value = \"ONLINE|OFFLINE\") @QueryParam(\"state\") String state) {\n+    Map<String, List<String>> resultMap = new HashMap<>();\n+    _pinotHelixResourceManager.getAllTables().stream()\n+        .forEach(table -> resultMap.put(table, getBrokersForTable(table, state)));\n+    return resultMap;\n+  }\n+\n+  @GET\n+  @Produces(MediaType.APPLICATION_JSON)\n+  @Path(\"/brokers/tables/{tableName}\")\n+  @ApiOperation(value = \"List brokers for a given table\", notes = \"List brokers for a given table\")\n+  public List<String> getBrokersForTable(\n+      @ApiParam(value = \"Name of the table\", required = true) @PathParam(\"tableName\") String tableName,\n+      @ApiParam(value = \"ONLINE|OFFLINE\") @QueryParam(\"state\") String state) {\n+    String actualTableName = _pinotHelixResourceManager.getActualTableName(tableName);\n+    Set<String> tableBrokers = new HashSet<>();\n+    if (_pinotHelixResourceManager.hasOfflineTable(actualTableName)) {\n+      tableBrokers.addAll(_pinotHelixResourceManager.getBrokerInstancesForTable(actualTableName, TableType.OFFLINE));\n+    }\n+    if (_pinotHelixResourceManager.hasRealtimeTable(actualTableName)) {\n+      tableBrokers.addAll(_pinotHelixResourceManager.getBrokerInstancesForTable(actualTableName, TableType.REALTIME));\n+    }\n+    applyStateChanges(tableBrokers, state);\n+    return ImmutableList.copyOf(tableBrokers);\n+  }\n+\n+  private void applyStateChanges(Set<String> brokers, String state) {\n+    if (state == null) {\n+      return;\n+    }\n+    switch (state) {\n+      case \"ONLINE\":", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f02d337e5daab135e899a4bdb9a4fba0e424a68"}, "originalPosition": 124}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c142f4917901dba45a5394424e9eb309d012e92e", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/c142f4917901dba45a5394424e9eb309d012e92e", "committedDate": "2020-07-14T11:06:48Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NDI2OTcz", "url": "https://github.com/apache/pinot/pull/5685#pullrequestreview-448426973", "createdAt": "2020-07-14T20:07:45Z", "commit": {"oid": "c142f4917901dba45a5394424e9eb309d012e92e"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQyMDowNzo0NlrOGxjZRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQyMDoxMTozOVrOGxjhTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDYxMzMxNg==", "bodyText": "these two definitions are not used anywhere right?", "url": "https://github.com/apache/pinot/pull/5685#discussion_r454613316", "createdAt": "2020-07-14T20:07:46Z", "author": {"login": "mcvsubbu"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotBrokerRestletResource.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.controller.api.resources;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.swagger.annotations.Api;\n+import io.swagger.annotations.ApiOperation;\n+import io.swagger.annotations.ApiParam;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import javax.inject.Inject;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.PathParam;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.QueryParam;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.core.Response;\n+import org.apache.pinot.common.exception.TableNotFoundException;\n+import org.apache.pinot.common.utils.CommonConstants;\n+import org.apache.pinot.controller.helix.core.PinotHelixResourceManager;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+@Api(tags = Constants.BROKER_TAG)\n+@Path(\"/\")\n+public class PinotBrokerRestletResource {\n+  public static final Logger LOGGER = LoggerFactory.getLogger(PinotBrokerRestletResource.class);\n+  private static final String TYPE_REALTIME = \"_REALTIME\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c142f4917901dba45a5394424e9eb309d012e92e"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDYxNTM3NA==", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    throw new ControllerApplicationException(LOGGER, String.format(\"Table [%s] not found.\", tableName),\n          \n          \n            \n                    throw new ControllerApplicationException(LOGGER, String.format(\"Table '%s' not found.\", tableName),", "url": "https://github.com/apache/pinot/pull/5685#discussion_r454615374", "createdAt": "2020-07-14T20:11:39Z", "author": {"login": "mcvsubbu"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotBrokerRestletResource.java", "diffHunk": "@@ -103,28 +110,35 @@\n   @ApiOperation(value = \"List brokers for a given table\", notes = \"List brokers for a given table\")\n   public List<String> getBrokersForTable(\n       @ApiParam(value = \"Name of the table\", required = true) @PathParam(\"tableName\") String tableName,\n+      @ApiParam(value = \"OFFLINE|REALTIME\") @QueryParam(\"type\") String tableTypeStr,\n       @ApiParam(value = \"ONLINE|OFFLINE\") @QueryParam(\"state\") String state) {\n-    String actualTableName = _pinotHelixResourceManager.getActualTableName(tableName);\n-    Set<String> tableBrokers = new HashSet<>();\n-    if (_pinotHelixResourceManager.hasOfflineTable(actualTableName)) {\n-      tableBrokers.addAll(_pinotHelixResourceManager.getBrokerInstancesForTable(actualTableName, TableType.OFFLINE));\n-    }\n-    if (_pinotHelixResourceManager.hasRealtimeTable(actualTableName)) {\n-      tableBrokers.addAll(_pinotHelixResourceManager.getBrokerInstancesForTable(actualTableName, TableType.REALTIME));\n+    try {\n+      List<String> tableNamesWithType = _pinotHelixResourceManager\n+          .getExistingTableNamesWithType(tableName, Constants.validateTableType(tableTypeStr));\n+      if (tableNamesWithType.isEmpty()) {\n+        throw new ControllerApplicationException(LOGGER, String.format(\"Table [%s] not found.\", tableName),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c142f4917901dba45a5394424e9eb309d012e92e"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "469ae84dfa14c3ba56435663d2b42e13d9ae5922", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/469ae84dfa14c3ba56435663d2b42e13d9ae5922", "committedDate": "2020-07-14T20:51:58Z", "message": "Address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "03f875e8942ac5ab6ec9470ddf967e445591dc52", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/03f875e8942ac5ab6ec9470ddf967e445591dc52", "committedDate": "2020-07-14T20:17:02Z", "message": "Address comments"}, "afterCommit": {"oid": "469ae84dfa14c3ba56435663d2b42e13d9ae5922", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/469ae84dfa14c3ba56435663d2b42e13d9ae5922", "committedDate": "2020-07-14T20:51:58Z", "message": "Address comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 321, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}