{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwNTYyMTA0", "number": 5224, "title": "Support bootstrap mode for table rebalance", "bodyText": "Add bootstrap mode where the rebalancer starts with an empty table and reassign all segments.\nThis mode can be used to rebalance table with hotspot servers.\nAll segments will be sorted alphabetically and assigned in a round-robin fashion, no minimum movement is guaranteed.\nOther related changes:\n\nExtract some pieces of code for sharing between offline and real-time assignment\nExtract assign segment logic without logging to reduce the log for bootstrapping\nAdd tests to cover the new feature", "createdAt": "2020-04-08T00:12:40Z", "url": "https://github.com/apache/pinot/pull/5224", "merged": true, "mergeCommit": {"oid": "8f0d059193a01e2a5ea80295d6e988bf566cc419"}, "closed": true, "closedAt": "2020-04-09T00:38:03Z", "author": {"login": "Jackie-Jiang"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVrMLtgBqjMyMTUwNzIzMjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVx7t4AFqTM5MDI2MTEzNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a8d3ddb3d0efe4a92c2a3c6715d8da867596129d", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/a8d3ddb3d0efe4a92c2a3c6715d8da867596129d", "committedDate": "2020-04-08T00:12:25Z", "message": "Support bootstrap mode for table rebalance\n\nAdd bootstrap mode where the rebalancer starts with an empty table and reassign all segments.\nThis mode can be used to rebalance table with hotspot servers.\nAll segments will be sorted alphabetically and assigned in a round-robin fashion, no minimum movement is guaranteed.\n\nOther related changes:\n- Extract some pieces of code for sharing between offline and real-time assignment\n- Extract assign segment logic without logging to reduce the log for bootstrapping\n- Add tests to cover the new feature"}, "afterCommit": {"oid": "94b79fb4818f32c3978d23dc4ec16233641e533f", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/94b79fb4818f32c3978d23dc4ec16233641e533f", "committedDate": "2020-04-08T17:17:26Z", "message": "Support bootstrap mode for table rebalance\n\nAdd bootstrap mode where the rebalancer starts with an empty table and reassign all segments.\nThis mode can be used to rebalance table with hotspot servers.\nAll segments will be sorted alphabetically and assigned in a round-robin fashion, no minimum movement is guaranteed.\n\nOther related changes:\n- Extract some pieces of code for sharing between offline and real-time assignment\n- Extract assign segment logic without logging to reduce the log for bootstrapping\n- Add tests to cover the new feature"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMzAwNTUw", "url": "https://github.com/apache/pinot/pull/5224#pullrequestreview-390300550", "createdAt": "2020-04-08T20:18:45Z", "commit": {"oid": "94b79fb4818f32c3978d23dc4ec16233641e533f"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMDoxODo0NlrOGC_ZiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMDozMDo0MVrOGC_zFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc4OTA2NQ==", "bodyText": "Can you adjust the comment here?", "url": "https://github.com/apache/pinot/pull/5224#discussion_r405789065", "createdAt": "2020-04-08T20:18:46Z", "author": {"login": "jackjlli"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/OfflineSegmentAssignment.java", "diffHunk": "@@ -189,45 +163,48 @@ public void init(HelixManager helixManager, TableConfig tableConfig) {\n     InstancePartitions instancePartitions = instancePartitionsMap.get(InstancePartitionsType.OFFLINE);\n     Preconditions.checkState(instancePartitions != null, \"Failed to find OFFLINE instance partitions for table: %s\",\n         _offlineTableName);\n-    LOGGER.info(\"Rebalancing table: {} with instance partitions: {}\", _offlineTableName, instancePartitions);\n+    boolean bootstrap =\n+        config.getBoolean(RebalanceConfigConstants.BOOTSTRAP, RebalanceConfigConstants.DEFAULT_BOOTSTRAP);\n+    LOGGER.info(\"Rebalancing table: {} with instance partitions: {}, bootstrap: {}\", _offlineTableName,\n+        instancePartitions, bootstrap);\n+    checkReplication(instancePartitions);\n \n     Map<String, Map<String, String>> newAssignment;\n-    if (instancePartitions.getNumReplicaGroups() == 1) {\n-      // Non-replica-group based assignment\n+    if (bootstrap) {\n+      LOGGER.info(\"Bootstrapping the table: {}\", _offlineTableName);\n \n-      List<String> instances =\n-          SegmentAssignmentUtils.getInstancesForNonReplicaGroupBasedAssignment(instancePartitions, _replication);\n-      newAssignment = SegmentAssignmentUtils\n-          .rebalanceTableWithHelixAutoRebalanceStrategy(currentAssignment, instances, _replication);\n+      // When bootstrap is enabled, start with an empty table add reassign all segments", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94b79fb4818f32c3978d23dc4ec16233641e533f"}, "originalPosition": 157}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc5NTYwNw==", "bodyText": "Will it print too many messages if there are many segments in a table?", "url": "https://github.com/apache/pinot/pull/5224#discussion_r405795607", "createdAt": "2020-04-08T20:30:41Z", "author": {"login": "jackjlli"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/OfflineSegmentAssignment.java", "diffHunk": "@@ -99,49 +99,48 @@ public void init(HelixManager helixManager, TableConfig tableConfig) {\n         _offlineTableName);\n     LOGGER.info(\"Assigning segment: {} with instance partitions: {} for table: {}\", segmentName, instancePartitions,\n         _offlineTableName);\n+    checkReplication(instancePartitions);\n \n-    List<String> instancesAssigned;\n-    if (instancePartitions.getNumReplicaGroups() == 1) {\n+    List<String> instancesAssigned = assignSegment(segmentName, currentAssignment, instancePartitions);\n+\n+    LOGGER", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94b79fb4818f32c3978d23dc4ec16233641e533f"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMzY2MjM5", "url": "https://github.com/apache/pinot/pull/5224#pullrequestreview-390366239", "createdAt": "2020-04-08T22:08:45Z", "commit": {"oid": "94b79fb4818f32c3978d23dc4ec16233641e533f"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMjowODo0NVrOGDCuSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMjoxMDoyNlrOGDCxCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg0MzUyOQ==", "bodyText": "empty table -> empty assignment?", "url": "https://github.com/apache/pinot/pull/5224#discussion_r405843529", "createdAt": "2020-04-08T22:08:45Z", "author": {"login": "snleee"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/RealtimeSegmentAssignment.java", "diffHunk": "@@ -184,41 +199,45 @@ public void init(HelixManager helixManager, TableConfig tableConfig) {\n       LOGGER\n           .info(\"Reassigning COMPLETED segments with COMPLETED instance partitions for table: {}\", _realtimeTableName);\n \n-      if (completedInstancePartitions.getNumReplicaGroups() == 1) {\n-        // Non-replica-group based assignment\n+      if (bootstrap) {\n+        LOGGER.info(\"Bootstrapping the COMPLETED segments for table: {}\", _realtimeTableName);\n \n-        List<String> instances = SegmentAssignmentUtils\n-            .getInstancesForNonReplicaGroupBasedAssignment(completedInstancePartitions, _replication);\n-        newAssignment = SegmentAssignmentUtils\n-            .rebalanceTableWithHelixAutoRebalanceStrategy(completedSegmentAssignment, instances, _replication);\n+        // When bootstrap is enabled, start with an empty table add reassign all segments", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94b79fb4818f32c3978d23dc4ec16233641e533f"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg0NDIzNA==", "bodyText": "I assume that Pairs.intPairComparator will be an ascending order?", "url": "https://github.com/apache/pinot/pull/5224#discussion_r405844234", "createdAt": "2020-04-08T22:10:26Z", "author": {"login": "snleee"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/SegmentAssignmentUtils.java", "diffHunk": "@@ -86,6 +86,55 @@ private SegmentAssignmentUtils() {\n     return instances;\n   }\n \n+  /**\n+   * Assigns the segment for the non-replica-group based segment assignment strategy and returns the assigned instances.\n+   */\n+  static List<String> assignSegmentWithoutReplicaGroup(Map<String, Map<String, String>> currentAssignment,\n+      InstancePartitions instancePartitions, int replication) {\n+    List<String> instances =\n+        SegmentAssignmentUtils.getInstancesForNonReplicaGroupBasedAssignment(instancePartitions, replication);\n+    int[] numSegmentsAssignedPerInstance = getNumSegmentsAssignedPerInstance(currentAssignment, instances);\n+    int numInstances = numSegmentsAssignedPerInstance.length;\n+    PriorityQueue<Pairs.IntPair> heap = new PriorityQueue<>(numInstances, Pairs.intPairComparator());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94b79fb4818f32c3978d23dc4ec16233641e533f"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a0878e1d7517412abd0f9d21a02039d5ee8bbec", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/9a0878e1d7517412abd0f9d21a02039d5ee8bbec", "committedDate": "2020-04-08T23:52:55Z", "message": "Support bootstrap mode for table rebalance\n\nAdd bootstrap mode where the rebalancer starts with an empty table and reassign all segments.\nThis mode can be used to rebalance table with hotspot servers.\nAll segments will be sorted alphabetically and assigned in a round-robin fashion, no minimum movement is guaranteed.\n\nOther related changes:\n- Extract some pieces of code for sharing between offline and real-time assignment\n- Extract assign segment logic without logging to reduce the log for bootstrapping\n- Add tests to cover the new feature"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNDEwMjgx", "url": "https://github.com/apache/pinot/pull/5224#pullrequestreview-390410281", "createdAt": "2020-04-09T00:03:50Z", "commit": {"oid": "94b79fb4818f32c3978d23dc4ec16233641e533f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da2bb76b6df802772df93e549accdfd5b3be14d3", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/da2bb76b6df802772df93e549accdfd5b3be14d3", "committedDate": "2020-04-09T00:14:29Z", "message": "Address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "94b79fb4818f32c3978d23dc4ec16233641e533f", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/94b79fb4818f32c3978d23dc4ec16233641e533f", "committedDate": "2020-04-08T17:17:26Z", "message": "Support bootstrap mode for table rebalance\n\nAdd bootstrap mode where the rebalancer starts with an empty table and reassign all segments.\nThis mode can be used to rebalance table with hotspot servers.\nAll segments will be sorted alphabetically and assigned in a round-robin fashion, no minimum movement is guaranteed.\n\nOther related changes:\n- Extract some pieces of code for sharing between offline and real-time assignment\n- Extract assign segment logic without logging to reduce the log for bootstrapping\n- Add tests to cover the new feature"}, "afterCommit": {"oid": "da2bb76b6df802772df93e549accdfd5b3be14d3", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/da2bb76b6df802772df93e549accdfd5b3be14d3", "committedDate": "2020-04-09T00:14:29Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMjYxMTM0", "url": "https://github.com/apache/pinot/pull/5224#pullrequestreview-390261134", "createdAt": "2020-04-08T19:18:35Z", "commit": {"oid": "94b79fb4818f32c3978d23dc4ec16233641e533f"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxOToxODozNVrOGC9bDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMTowNDo1NlrOGDGJ0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc1NjY4NA==", "bodyText": "When will this be the case? Can you also add that in the comments?", "url": "https://github.com/apache/pinot/pull/5224#discussion_r405756684", "createdAt": "2020-04-08T19:18:35Z", "author": {"login": "mcvsubbu"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/OfflineSegmentAssignment.java", "diffHunk": "@@ -99,49 +99,48 @@ public void init(HelixManager helixManager, TableConfig tableConfig) {\n         _offlineTableName);\n     LOGGER.info(\"Assigning segment: {} with instance partitions: {} for table: {}\", segmentName, instancePartitions,\n         _offlineTableName);\n+    checkReplication(instancePartitions);\n \n-    List<String> instancesAssigned;\n-    if (instancePartitions.getNumReplicaGroups() == 1) {\n+    List<String> instancesAssigned = assignSegment(segmentName, currentAssignment, instancePartitions);\n+\n+    LOGGER\n+        .info(\"Assigned segment: {} to instances: {} for table: {}\", segmentName, instancesAssigned, _offlineTableName);\n+    return instancesAssigned;\n+  }\n+\n+  /**\n+   * Helper method to check whether the number of replica-groups matches the table replication for replica-group based", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94b79fb4818f32c3978d23dc4ec16233641e533f"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg5NzgzOQ==", "bodyText": "Suggest wording : \"Bootstrapping segment assignment for table ...\" Otherwise it may throw an admin off", "url": "https://github.com/apache/pinot/pull/5224#discussion_r405897839", "createdAt": "2020-04-09T00:57:39Z", "author": {"login": "mcvsubbu"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/OfflineSegmentAssignment.java", "diffHunk": "@@ -189,45 +163,48 @@ public void init(HelixManager helixManager, TableConfig tableConfig) {\n     InstancePartitions instancePartitions = instancePartitionsMap.get(InstancePartitionsType.OFFLINE);\n     Preconditions.checkState(instancePartitions != null, \"Failed to find OFFLINE instance partitions for table: %s\",\n         _offlineTableName);\n-    LOGGER.info(\"Rebalancing table: {} with instance partitions: {}\", _offlineTableName, instancePartitions);\n+    boolean bootstrap =\n+        config.getBoolean(RebalanceConfigConstants.BOOTSTRAP, RebalanceConfigConstants.DEFAULT_BOOTSTRAP);\n+    LOGGER.info(\"Rebalancing table: {} with instance partitions: {}, bootstrap: {}\", _offlineTableName,\n+        instancePartitions, bootstrap);\n+    checkReplication(instancePartitions);\n \n     Map<String, Map<String, String>> newAssignment;\n-    if (instancePartitions.getNumReplicaGroups() == 1) {\n-      // Non-replica-group based assignment\n+    if (bootstrap) {\n+      LOGGER.info(\"Bootstrapping the table: {}\", _offlineTableName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da2bb76b6df802772df93e549accdfd5b3be14d3"}, "originalPosition": 151}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg5OTM5NA==", "bodyText": "\"Bootstrapping segment assignment for COMPLETED segments...\"", "url": "https://github.com/apache/pinot/pull/5224#discussion_r405899394", "createdAt": "2020-04-09T01:03:42Z", "author": {"login": "mcvsubbu"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/RealtimeSegmentAssignment.java", "diffHunk": "@@ -184,41 +199,45 @@ public void init(HelixManager helixManager, TableConfig tableConfig) {\n       LOGGER\n           .info(\"Reassigning COMPLETED segments with COMPLETED instance partitions for table: {}\", _realtimeTableName);\n \n-      if (completedInstancePartitions.getNumReplicaGroups() == 1) {\n-        // Non-replica-group based assignment\n+      if (bootstrap) {\n+        LOGGER.info(\"Bootstrapping the COMPLETED segments for table: {}\", _realtimeTableName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da2bb76b6df802772df93e549accdfd5b3be14d3"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg5OTczMA==", "bodyText": "Is this a typo? Or are you intentionally calling assignConsumingSegment() method?", "url": "https://github.com/apache/pinot/pull/5224#discussion_r405899730", "createdAt": "2020-04-09T01:04:56Z", "author": {"login": "mcvsubbu"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/RealtimeSegmentAssignment.java", "diffHunk": "@@ -230,7 +249,7 @@ public void init(HelixManager helixManager, TableConfig tableConfig) {\n \n       newAssignment = new TreeMap<>();\n       for (String segmentName : completedSegmentAssignment.keySet()) {\n-        List<String> instancesAssigned = assignSegment(segmentName, consumingInstancePartitions);\n+        List<String> instancesAssigned = assignConsumingSegment(segmentName, consumingInstancePartitions);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da2bb76b6df802772df93e549accdfd5b3be14d3"}, "originalPosition": 155}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1181, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}