{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0MTM5NDIw", "number": 5564, "reviewThreads": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo0MToyNVrOEFoj4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo1ODo1MFrOEFo60Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MzQyODgxOnYy", "diffSide": "RIGHT", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/broker/helix/HelixBrokerStarter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo0MToyNVrOGj8QOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo0MToyNVrOGj8QOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0MDUzNg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    LOGGER.warn(\"Unable to set Log2M value {} for DistinctCountHLL function. {}\", log2mStr, e);\n          \n          \n            \n                    LOGGER.warn(\"Invalid config of '{}': '{}', using: {} as the default log2m for HyperLogLog\", Helix.CONFIG_OF_DEFAULT_HYPERLOGLOG_LOG2M, log2mStr, CommonConstants.Helix.DEFAULT_HYPERLOGLOG_LOG2M);", "url": "https://github.com/apache/pinot/pull/5564#discussion_r440340536", "createdAt": "2020-06-15T17:41:25Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/broker/helix/HelixBrokerStarter.java", "diffHunk": "@@ -191,11 +191,19 @@ public void start()\n         new HelixConfigScopeBuilder(HelixConfigScope.ConfigScopeProperty.CLUSTER).forCluster(_clusterName).build();\n     Map<String, String> configMap = configAccessor.get(helixConfigScope, Arrays\n         .asList(Helix.ENABLE_CASE_INSENSITIVE_KEY, Helix.DEPRECATED_ENABLE_CASE_INSENSITIVE_KEY,\n-            Broker.CONFIG_OF_ENABLE_QUERY_LIMIT_OVERRIDE));\n+            Broker.CONFIG_OF_ENABLE_QUERY_LIMIT_OVERRIDE, Helix.CONFIG_OF_DEFAULT_HYPERLOGLOG_LOG2M));\n     if (Boolean.parseBoolean(configMap.get(Helix.ENABLE_CASE_INSENSITIVE_KEY)) || Boolean\n         .parseBoolean(configMap.get(Helix.DEPRECATED_ENABLE_CASE_INSENSITIVE_KEY))) {\n       _brokerConf.setProperty(Helix.ENABLE_CASE_INSENSITIVE_KEY, true);\n     }\n+    String log2mStr = configMap.get(Helix.CONFIG_OF_DEFAULT_HYPERLOGLOG_LOG2M);\n+    if (log2mStr != null) {\n+      try {\n+        _brokerConf.setProperty(Helix.CONFIG_OF_DEFAULT_HYPERLOGLOG_LOG2M, Integer.parseInt(log2mStr));\n+      } catch (NumberFormatException e) {\n+        LOGGER.warn(\"Unable to set Log2M value {} for DistinctCountHLL function. {}\", log2mStr, e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3799d93fa2595c01df4de2289e7c6cca65e2c1df"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MzQzNDE0OnYy", "diffSide": "RIGHT", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo0MzowN1rOGj8Tqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo0MzowN1rOGj8Tqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0MTQxOA==", "bodyText": "Rename to _defaultHllLog2m?", "url": "https://github.com/apache/pinot/pull/5564#discussion_r440341418", "createdAt": "2020-06-15T17:43:07Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -112,6 +114,7 @@\n \n   private final boolean _enableCaseInsensitive;\n   private final boolean _enableQueryLimitOverride;\n+  private final int _hllLog2mOverride;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3799d93fa2595c01df4de2289e7c6cca65e2c1df"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MzQzNTYxOnYy", "diffSide": "RIGHT", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo0MzozNlrOGj8Umw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo0MzozNlrOGj8Umw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0MTY1OQ==", "bodyText": "_defaultHllLog2m =\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (_config.containsKey(CommonConstants.Helix.CONFIG_OF_DEFAULT_HYPERLOGLOG_LOG2M)) {\n          \n          \n            \n                  _hllLog2mOverride = _config.getInt(CommonConstants.Helix.CONFIG_OF_DEFAULT_HYPERLOGLOG_LOG2M,\n          \n          \n            \n                      CommonConstants.Helix.DEFAULT_HYPERLOGLOG_LOG2M);\n          \n          \n            \n                } else {\n          \n          \n            \n                  _hllLog2mOverride = -1;\n          \n          \n            \n                }\n          \n          \n            \n                _hllLog2mOverride = _config.getInt(CommonConstants.Helix.CONFIG_OF_DEFAULT_HYPERLOGLOG_LOG2M,\n          \n          \n            \n                      CommonConstants.Helix.DEFAULT_HYPERLOGLOG_LOG2M);", "url": "https://github.com/apache/pinot/pull/5564#discussion_r440341659", "createdAt": "2020-06-15T17:43:36Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -129,6 +132,12 @@ public BaseBrokerRequestHandler(Configuration config, RoutingManager routingMana\n     } else {\n       _tableCache = null;\n     }\n+    if (_config.containsKey(CommonConstants.Helix.CONFIG_OF_DEFAULT_HYPERLOGLOG_LOG2M)) {\n+      _hllLog2mOverride = _config.getInt(CommonConstants.Helix.CONFIG_OF_DEFAULT_HYPERLOGLOG_LOG2M,\n+          CommonConstants.Helix.DEFAULT_HYPERLOGLOG_LOG2M);\n+    } else {\n+      _hllLog2mOverride = -1;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3799d93fa2595c01df4de2289e7c6cca65e2c1df"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MzQ0MjU5OnYy", "diffSide": "RIGHT", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo0NTozNlrOGj8ZBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMDoxMDozNlrOGkBCyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0Mjc4OA==", "bodyText": "Why do we need brokerRequest.getSelections() != null here? It will never be true for aggregation right?", "url": "https://github.com/apache/pinot/pull/5564#discussion_r440342788", "createdAt": "2020-06-15T17:45:36Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -425,6 +437,58 @@ public BrokerResponse handleRequest(JsonNode request, @Nullable RequesterIdentit\n     return brokerResponse;\n   }\n \n+  /**\n+   * Set Log2m value for DistinctCountHLL Function\n+   * @param brokerRequest\n+   * @param hllLog2mOverride\n+   */\n+  static void handleHyperloglogLog2mOverride(BrokerRequest brokerRequest, int hllLog2mOverride) {\n+    if (brokerRequest.getAggregationsInfo() != null) {\n+      for (AggregationInfo aggregationInfo : brokerRequest.getAggregationsInfo()) {\n+        switch (AggregationFunctionType.valueOf(aggregationInfo.getAggregationType().toUpperCase())) {\n+          case DISTINCTCOUNTHLL:\n+          case DISTINCTCOUNTHLLMV:\n+          case DISTINCTCOUNTRAWHLL:\n+          case DISTINCTCOUNTRAWHLLMV:\n+            if (aggregationInfo.getExpressionsSize() == 1) {\n+              aggregationInfo.addToExpressions(Integer.toString(hllLog2mOverride));\n+            }\n+        }\n+      }\n+    }\n+    if (brokerRequest.getPinotQuery() != null && brokerRequest.getSelections() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3799d93fa2595c01df4de2289e7c6cca65e2c1df"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQxOTAxOQ==", "bodyText": "ah, it should be brokerRequest.getPinotQuery().getSelectList()", "url": "https://github.com/apache/pinot/pull/5564#discussion_r440419019", "createdAt": "2020-06-15T20:10:36Z", "author": {"login": "xiangfu0"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -425,6 +437,58 @@ public BrokerResponse handleRequest(JsonNode request, @Nullable RequesterIdentit\n     return brokerResponse;\n   }\n \n+  /**\n+   * Set Log2m value for DistinctCountHLL Function\n+   * @param brokerRequest\n+   * @param hllLog2mOverride\n+   */\n+  static void handleHyperloglogLog2mOverride(BrokerRequest brokerRequest, int hllLog2mOverride) {\n+    if (brokerRequest.getAggregationsInfo() != null) {\n+      for (AggregationInfo aggregationInfo : brokerRequest.getAggregationsInfo()) {\n+        switch (AggregationFunctionType.valueOf(aggregationInfo.getAggregationType().toUpperCase())) {\n+          case DISTINCTCOUNTHLL:\n+          case DISTINCTCOUNTHLLMV:\n+          case DISTINCTCOUNTRAWHLL:\n+          case DISTINCTCOUNTRAWHLLMV:\n+            if (aggregationInfo.getExpressionsSize() == 1) {\n+              aggregationInfo.addToExpressions(Integer.toString(hllLog2mOverride));\n+            }\n+        }\n+      }\n+    }\n+    if (brokerRequest.getPinotQuery() != null && brokerRequest.getSelections() != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0Mjc4OA=="}, "originalCommit": {"oid": "3799d93fa2595c01df4de2289e7c6cca65e2c1df"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MzQ0OTQzOnYy", "diffSide": "RIGHT", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo0Nzo0MFrOGj8dTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMDoxMTo1OFrOGkBFhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0Mzg4NQ==", "bodyText": "Please handle exception here, or switch on String instead of AggregationFunctionType", "url": "https://github.com/apache/pinot/pull/5564#discussion_r440343885", "createdAt": "2020-06-15T17:47:40Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -425,6 +437,58 @@ public BrokerResponse handleRequest(JsonNode request, @Nullable RequesterIdentit\n     return brokerResponse;\n   }\n \n+  /**\n+   * Set Log2m value for DistinctCountHLL Function\n+   * @param brokerRequest\n+   * @param hllLog2mOverride\n+   */\n+  static void handleHyperloglogLog2mOverride(BrokerRequest brokerRequest, int hllLog2mOverride) {\n+    if (brokerRequest.getAggregationsInfo() != null) {\n+      for (AggregationInfo aggregationInfo : brokerRequest.getAggregationsInfo()) {\n+        switch (AggregationFunctionType.valueOf(aggregationInfo.getAggregationType().toUpperCase())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3799d93fa2595c01df4de2289e7c6cca65e2c1df"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQxOTcxOQ==", "bodyText": "will change to string then.", "url": "https://github.com/apache/pinot/pull/5564#discussion_r440419719", "createdAt": "2020-06-15T20:11:58Z", "author": {"login": "xiangfu0"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -425,6 +437,58 @@ public BrokerResponse handleRequest(JsonNode request, @Nullable RequesterIdentit\n     return brokerResponse;\n   }\n \n+  /**\n+   * Set Log2m value for DistinctCountHLL Function\n+   * @param brokerRequest\n+   * @param hllLog2mOverride\n+   */\n+  static void handleHyperloglogLog2mOverride(BrokerRequest brokerRequest, int hllLog2mOverride) {\n+    if (brokerRequest.getAggregationsInfo() != null) {\n+      for (AggregationInfo aggregationInfo : brokerRequest.getAggregationsInfo()) {\n+        switch (AggregationFunctionType.valueOf(aggregationInfo.getAggregationType().toUpperCase())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0Mzg4NQ=="}, "originalCommit": {"oid": "3799d93fa2595c01df4de2289e7c6cca65e2c1df"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MzQ2MDUyOnYy", "diffSide": "RIGHT", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo1MTowMFrOGj8kbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMDoxMjo1M1rOGkBHOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0NTcwOQ==", "bodyText": "(nit) This check is redundant?", "url": "https://github.com/apache/pinot/pull/5564#discussion_r440345709", "createdAt": "2020-06-15T17:51:00Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -425,6 +437,58 @@ public BrokerResponse handleRequest(JsonNode request, @Nullable RequesterIdentit\n     return brokerResponse;\n   }\n \n+  /**\n+   * Set Log2m value for DistinctCountHLL Function\n+   * @param brokerRequest\n+   * @param hllLog2mOverride\n+   */\n+  static void handleHyperloglogLog2mOverride(BrokerRequest brokerRequest, int hllLog2mOverride) {\n+    if (brokerRequest.getAggregationsInfo() != null) {\n+      for (AggregationInfo aggregationInfo : brokerRequest.getAggregationsInfo()) {\n+        switch (AggregationFunctionType.valueOf(aggregationInfo.getAggregationType().toUpperCase())) {\n+          case DISTINCTCOUNTHLL:\n+          case DISTINCTCOUNTHLLMV:\n+          case DISTINCTCOUNTRAWHLL:\n+          case DISTINCTCOUNTRAWHLLMV:\n+            if (aggregationInfo.getExpressionsSize() == 1) {\n+              aggregationInfo.addToExpressions(Integer.toString(hllLog2mOverride));\n+            }\n+        }\n+      }\n+    }\n+    if (brokerRequest.getPinotQuery() != null && brokerRequest.getSelections() != null) {\n+      for (Expression expr : brokerRequest.getPinotQuery().getSelectList()) {\n+        updateDistinctCountHllExpr(expr, hllLog2mOverride);\n+      }\n+    }\n+  }\n+\n+  private static void updateDistinctCountHllExpr(Expression expr, int hllLog2mOverride) {\n+    if (expr == null || expr.getFunctionCall() == null) {\n+      return;\n+    }\n+    Function functionCall = expr.getFunctionCall();\n+    try {\n+      switch (AggregationFunctionType.getAggregationFunctionType(functionCall.getOperator())) {\n+        case DISTINCTCOUNTHLL:\n+        case DISTINCTCOUNTHLLMV:\n+        case DISTINCTCOUNTRAWHLL:\n+        case DISTINCTCOUNTRAWHLLMV:\n+          if (functionCall.getOperandsSize() == 1) {\n+            functionCall.addToOperands(RequestUtils.getLiteralExpression(hllLog2mOverride));\n+          }\n+          return;\n+      }\n+    } catch (Exception e) {\n+      // Swallow exceptions\n+    }\n+    if (functionCall.getOperandsSize() > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3799d93fa2595c01df4de2289e7c6cca65e2c1df"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQyMDE1NA==", "bodyText": "just in case.", "url": "https://github.com/apache/pinot/pull/5564#discussion_r440420154", "createdAt": "2020-06-15T20:12:53Z", "author": {"login": "xiangfu0"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -425,6 +437,58 @@ public BrokerResponse handleRequest(JsonNode request, @Nullable RequesterIdentit\n     return brokerResponse;\n   }\n \n+  /**\n+   * Set Log2m value for DistinctCountHLL Function\n+   * @param brokerRequest\n+   * @param hllLog2mOverride\n+   */\n+  static void handleHyperloglogLog2mOverride(BrokerRequest brokerRequest, int hllLog2mOverride) {\n+    if (brokerRequest.getAggregationsInfo() != null) {\n+      for (AggregationInfo aggregationInfo : brokerRequest.getAggregationsInfo()) {\n+        switch (AggregationFunctionType.valueOf(aggregationInfo.getAggregationType().toUpperCase())) {\n+          case DISTINCTCOUNTHLL:\n+          case DISTINCTCOUNTHLLMV:\n+          case DISTINCTCOUNTRAWHLL:\n+          case DISTINCTCOUNTRAWHLLMV:\n+            if (aggregationInfo.getExpressionsSize() == 1) {\n+              aggregationInfo.addToExpressions(Integer.toString(hllLog2mOverride));\n+            }\n+        }\n+      }\n+    }\n+    if (brokerRequest.getPinotQuery() != null && brokerRequest.getSelections() != null) {\n+      for (Expression expr : brokerRequest.getPinotQuery().getSelectList()) {\n+        updateDistinctCountHllExpr(expr, hllLog2mOverride);\n+      }\n+    }\n+  }\n+\n+  private static void updateDistinctCountHllExpr(Expression expr, int hllLog2mOverride) {\n+    if (expr == null || expr.getFunctionCall() == null) {\n+      return;\n+    }\n+    Function functionCall = expr.getFunctionCall();\n+    try {\n+      switch (AggregationFunctionType.getAggregationFunctionType(functionCall.getOperator())) {\n+        case DISTINCTCOUNTHLL:\n+        case DISTINCTCOUNTHLLMV:\n+        case DISTINCTCOUNTRAWHLL:\n+        case DISTINCTCOUNTRAWHLLMV:\n+          if (functionCall.getOperandsSize() == 1) {\n+            functionCall.addToOperands(RequestUtils.getLiteralExpression(hllLog2mOverride));\n+          }\n+          return;\n+      }\n+    } catch (Exception e) {\n+      // Swallow exceptions\n+    }\n+    if (functionCall.getOperandsSize() > 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0NTcwOQ=="}, "originalCommit": {"oid": "3799d93fa2595c01df4de2289e7c6cca65e2c1df"}, "originalPosition": 96}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MzQ2NDQ1OnYy", "diffSide": "RIGHT", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo1MjoxNVrOGj8nCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo1MjoxNVrOGj8nCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0NjM3Ng==", "bodyText": "expr can never be null here.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (expr == null || expr.getFunctionCall() == null) {\n          \n          \n            \n                  return;\n          \n          \n            \n                }\n          \n          \n            \n                Function functionCall = expr.getFunctionCall();\n          \n          \n            \n                Function functionCall = expr.getFunctionCall();\n          \n          \n            \n                if (functionCall == null) {\n          \n          \n            \n                  return;\n          \n          \n            \n                }", "url": "https://github.com/apache/pinot/pull/5564#discussion_r440346376", "createdAt": "2020-06-15T17:52:15Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -425,6 +437,58 @@ public BrokerResponse handleRequest(JsonNode request, @Nullable RequesterIdentit\n     return brokerResponse;\n   }\n \n+  /**\n+   * Set Log2m value for DistinctCountHLL Function\n+   * @param brokerRequest\n+   * @param hllLog2mOverride\n+   */\n+  static void handleHyperloglogLog2mOverride(BrokerRequest brokerRequest, int hllLog2mOverride) {\n+    if (brokerRequest.getAggregationsInfo() != null) {\n+      for (AggregationInfo aggregationInfo : brokerRequest.getAggregationsInfo()) {\n+        switch (AggregationFunctionType.valueOf(aggregationInfo.getAggregationType().toUpperCase())) {\n+          case DISTINCTCOUNTHLL:\n+          case DISTINCTCOUNTHLLMV:\n+          case DISTINCTCOUNTRAWHLL:\n+          case DISTINCTCOUNTRAWHLLMV:\n+            if (aggregationInfo.getExpressionsSize() == 1) {\n+              aggregationInfo.addToExpressions(Integer.toString(hllLog2mOverride));\n+            }\n+        }\n+      }\n+    }\n+    if (brokerRequest.getPinotQuery() != null && brokerRequest.getSelections() != null) {\n+      for (Expression expr : brokerRequest.getPinotQuery().getSelectList()) {\n+        updateDistinctCountHllExpr(expr, hllLog2mOverride);\n+      }\n+    }\n+  }\n+\n+  private static void updateDistinctCountHllExpr(Expression expr, int hllLog2mOverride) {\n+    if (expr == null || expr.getFunctionCall() == null) {\n+      return;\n+    }\n+    Function functionCall = expr.getFunctionCall();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3799d93fa2595c01df4de2289e7c6cca65e2c1df"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MzQ2NTk0OnYy", "diffSide": "RIGHT", "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/CommonConstants.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo1Mjo0M1rOGj8n-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo1Mjo0M1rOGj8n-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0NjYxOQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static final String CONFIG_OF_DEFAULT_HYPERLOGLOG_LOG2M = \"default.hyperloglog.log2m\";\n          \n          \n            \n                public static final String DEFAULT_HYPERLOGLOG_LOG2M_KEY = \"default.hyperloglog.log2m\";", "url": "https://github.com/apache/pinot/pull/5564#discussion_r440346619", "createdAt": "2020-06-15T17:52:43Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/CommonConstants.java", "diffHunk": "@@ -44,6 +44,9 @@\n     public static final String ENABLE_CASE_INSENSITIVE_KEY = \"enable.case.insensitive\";\n     public static final String DEPRECATED_ENABLE_CASE_INSENSITIVE_KEY = \"enable.case.insensitive.pql\";\n \n+    public static final String CONFIG_OF_DEFAULT_HYPERLOGLOG_LOG2M = \"default.hyperloglog.log2m\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3799d93fa2595c01df4de2289e7c6cca65e2c1df"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MzQ3MDI5OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountHLLAggregationFunction.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo1NDowMVrOGj8qxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo1NDowMVrOGj8qxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0NzMzMw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                Preconditions\n          \n          \n            \n                    .checkArgument(numExpressions <= 2 && numExpressions >= 1, \"DistinctCountHLL expects 1 or 2 arguments, got: \",\n          \n          \n            \n                        numExpressions);\n          \n          \n            \n                Preconditions\n          \n          \n            \n                    .checkArgument(numExpressions <= 2 && numExpressions >= 1, \"DistinctCountHLL expects 1 or 2 arguments, got: %s\",\n          \n          \n            \n                        numExpressions);", "url": "https://github.com/apache/pinot/pull/5564#discussion_r440347333", "createdAt": "2020-06-15T17:54:01Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountHLLAggregationFunction.java", "diffHunk": "@@ -35,9 +36,20 @@\n \n public class DistinctCountHLLAggregationFunction extends BaseSingleInputAggregationFunction<HyperLogLog, Long> {\n   public static final int DEFAULT_LOG2M = 8;\n+  protected final int _log2M;\n \n-  public DistinctCountHLLAggregationFunction(String column) {\n-    super(column);\n+  public DistinctCountHLLAggregationFunction(List<String> arguments) {\n+    super(arguments.get(0));\n+    int numExpressions = arguments.size();\n+    // This function expects 1 or 2 arguments.\n+    Preconditions\n+        .checkArgument(numExpressions <= 2 && numExpressions >= 1, \"DistinctCountHLL expects 1 or 2 arguments, got: \",\n+            numExpressions);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3799d93fa2595c01df4de2289e7c6cca65e2c1df"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MzQ3NDc5OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountHLLAggregationFunction.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo1NToxOFrOGj8tlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMzo1MzozOFrOGkGg0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0ODA1Mg==", "bodyText": "No need to replace single quote here", "url": "https://github.com/apache/pinot/pull/5564#discussion_r440348052", "createdAt": "2020-06-15T17:55:18Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountHLLAggregationFunction.java", "diffHunk": "@@ -35,9 +36,20 @@\n \n public class DistinctCountHLLAggregationFunction extends BaseSingleInputAggregationFunction<HyperLogLog, Long> {\n   public static final int DEFAULT_LOG2M = 8;\n+  protected final int _log2M;\n \n-  public DistinctCountHLLAggregationFunction(String column) {\n-    super(column);\n+  public DistinctCountHLLAggregationFunction(List<String> arguments) {\n+    super(arguments.get(0));\n+    int numExpressions = arguments.size();\n+    // This function expects 1 or 2 arguments.\n+    Preconditions\n+        .checkArgument(numExpressions <= 2 && numExpressions >= 1, \"DistinctCountHLL expects 1 or 2 arguments, got: \",\n+            numExpressions);\n+    if (arguments.size() == 2) {\n+      _log2M = Integer.valueOf(arguments.get(1).replace(\"'\", \"\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3799d93fa2595c01df4de2289e7c6cca65e2c1df"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQyMTUxOA==", "bodyText": "Integer.valueOf(...) will throw exception on string \"'1'\"", "url": "https://github.com/apache/pinot/pull/5564#discussion_r440421518", "createdAt": "2020-06-15T20:15:24Z", "author": {"login": "xiangfu0"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountHLLAggregationFunction.java", "diffHunk": "@@ -35,9 +36,20 @@\n \n public class DistinctCountHLLAggregationFunction extends BaseSingleInputAggregationFunction<HyperLogLog, Long> {\n   public static final int DEFAULT_LOG2M = 8;\n+  protected final int _log2M;\n \n-  public DistinctCountHLLAggregationFunction(String column) {\n-    super(column);\n+  public DistinctCountHLLAggregationFunction(List<String> arguments) {\n+    super(arguments.get(0));\n+    int numExpressions = arguments.size();\n+    // This function expects 1 or 2 arguments.\n+    Preconditions\n+        .checkArgument(numExpressions <= 2 && numExpressions >= 1, \"DistinctCountHLL expects 1 or 2 arguments, got: \",\n+            numExpressions);\n+    if (arguments.size() == 2) {\n+      _log2M = Integer.valueOf(arguments.get(1).replace(\"'\", \"\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0ODA1Mg=="}, "originalCommit": {"oid": "3799d93fa2595c01df4de2289e7c6cca65e2c1df"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ4OTU0NQ==", "bodyText": "But why would someone put '1' here? In order to put '1' as the literal, you need to explicitly escape ' (i.e. DistinctCountHLL(column, '''1''')). Also, in that case we should fail the query because it is invalid.", "url": "https://github.com/apache/pinot/pull/5564#discussion_r440489545", "createdAt": "2020-06-15T22:51:10Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountHLLAggregationFunction.java", "diffHunk": "@@ -35,9 +36,20 @@\n \n public class DistinctCountHLLAggregationFunction extends BaseSingleInputAggregationFunction<HyperLogLog, Long> {\n   public static final int DEFAULT_LOG2M = 8;\n+  protected final int _log2M;\n \n-  public DistinctCountHLLAggregationFunction(String column) {\n-    super(column);\n+  public DistinctCountHLLAggregationFunction(List<String> arguments) {\n+    super(arguments.get(0));\n+    int numExpressions = arguments.size();\n+    // This function expects 1 or 2 arguments.\n+    Preconditions\n+        .checkArgument(numExpressions <= 2 && numExpressions >= 1, \"DistinctCountHLL expects 1 or 2 arguments, got: \",\n+            numExpressions);\n+    if (arguments.size() == 2) {\n+      _log2M = Integer.valueOf(arguments.get(1).replace(\"'\", \"\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0ODA1Mg=="}, "originalCommit": {"oid": "3799d93fa2595c01df4de2289e7c6cca65e2c1df"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUwMDAwMw==", "bodyText": "from sql side, we are still doing DistinctCountHLL(column, 1), this expression is parsed to long literal, then converted to string literal in BrokerRequest with single quotes.", "url": "https://github.com/apache/pinot/pull/5564#discussion_r440500003", "createdAt": "2020-06-15T23:25:09Z", "author": {"login": "xiangfu0"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountHLLAggregationFunction.java", "diffHunk": "@@ -35,9 +36,20 @@\n \n public class DistinctCountHLLAggregationFunction extends BaseSingleInputAggregationFunction<HyperLogLog, Long> {\n   public static final int DEFAULT_LOG2M = 8;\n+  protected final int _log2M;\n \n-  public DistinctCountHLLAggregationFunction(String column) {\n-    super(column);\n+  public DistinctCountHLLAggregationFunction(List<String> arguments) {\n+    super(arguments.get(0));\n+    int numExpressions = arguments.size();\n+    // This function expects 1 or 2 arguments.\n+    Preconditions\n+        .checkArgument(numExpressions <= 2 && numExpressions >= 1, \"DistinctCountHLL expects 1 or 2 arguments, got: \",\n+            numExpressions);\n+    if (arguments.size() == 2) {\n+      _log2M = Integer.valueOf(arguments.get(1).replace(\"'\", \"\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0ODA1Mg=="}, "originalCommit": {"oid": "3799d93fa2595c01df4de2289e7c6cca65e2c1df"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUwMjg3Mg==", "bodyText": "This doesn't seem right.. Can we add a TODO and fix it later?", "url": "https://github.com/apache/pinot/pull/5564#discussion_r440502872", "createdAt": "2020-06-15T23:34:24Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountHLLAggregationFunction.java", "diffHunk": "@@ -35,9 +36,20 @@\n \n public class DistinctCountHLLAggregationFunction extends BaseSingleInputAggregationFunction<HyperLogLog, Long> {\n   public static final int DEFAULT_LOG2M = 8;\n+  protected final int _log2M;\n \n-  public DistinctCountHLLAggregationFunction(String column) {\n-    super(column);\n+  public DistinctCountHLLAggregationFunction(List<String> arguments) {\n+    super(arguments.get(0));\n+    int numExpressions = arguments.size();\n+    // This function expects 1 or 2 arguments.\n+    Preconditions\n+        .checkArgument(numExpressions <= 2 && numExpressions >= 1, \"DistinctCountHLL expects 1 or 2 arguments, got: \",\n+            numExpressions);\n+    if (arguments.size() == 2) {\n+      _log2M = Integer.valueOf(arguments.get(1).replace(\"'\", \"\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0ODA1Mg=="}, "originalCommit": {"oid": "3799d93fa2595c01df4de2289e7c6cca65e2c1df"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUwODYyNQ==", "bodyText": "Added comments.\nCurrently PinotQuery2BrokerRequestConverter enforces single quoted non-string literal in ParserUtils.standardizeExpression(...).", "url": "https://github.com/apache/pinot/pull/5564#discussion_r440508625", "createdAt": "2020-06-15T23:53:38Z", "author": {"login": "xiangfu0"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountHLLAggregationFunction.java", "diffHunk": "@@ -35,9 +36,20 @@\n \n public class DistinctCountHLLAggregationFunction extends BaseSingleInputAggregationFunction<HyperLogLog, Long> {\n   public static final int DEFAULT_LOG2M = 8;\n+  protected final int _log2M;\n \n-  public DistinctCountHLLAggregationFunction(String column) {\n-    super(column);\n+  public DistinctCountHLLAggregationFunction(List<String> arguments) {\n+    super(arguments.get(0));\n+    int numExpressions = arguments.size();\n+    // This function expects 1 or 2 arguments.\n+    Preconditions\n+        .checkArgument(numExpressions <= 2 && numExpressions >= 1, \"DistinctCountHLL expects 1 or 2 arguments, got: \",\n+            numExpressions);\n+    if (arguments.size() == 2) {\n+      _log2M = Integer.valueOf(arguments.get(1).replace(\"'\", \"\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0ODA1Mg=="}, "originalCommit": {"oid": "3799d93fa2595c01df4de2289e7c6cca65e2c1df"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MzQ3NzE5OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountHLLAggregationFunction.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo1NTo1OVrOGj8vDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo1NTo1OVrOGj8vDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0ODQyOA==", "bodyText": "(nit) Rename to _log2m?", "url": "https://github.com/apache/pinot/pull/5564#discussion_r440348428", "createdAt": "2020-06-15T17:55:59Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountHLLAggregationFunction.java", "diffHunk": "@@ -35,9 +36,20 @@\n \n public class DistinctCountHLLAggregationFunction extends BaseSingleInputAggregationFunction<HyperLogLog, Long> {\n   public static final int DEFAULT_LOG2M = 8;\n+  protected final int _log2M;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3799d93fa2595c01df4de2289e7c6cca65e2c1df"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MzQ4MTA1OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountHLLAggregationFunction.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo1Njo1OVrOGj8xfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo1Njo1OVrOGj8xfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0OTA1Mw==", "bodyText": "Replace this with the one in CommonConstants?", "url": "https://github.com/apache/pinot/pull/5564#discussion_r440349053", "createdAt": "2020-06-15T17:56:59Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountHLLAggregationFunction.java", "diffHunk": "@@ -35,9 +36,20 @@\n \n public class DistinctCountHLLAggregationFunction extends BaseSingleInputAggregationFunction<HyperLogLog, Long> {\n   public static final int DEFAULT_LOG2M = 8;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3799d93fa2595c01df4de2289e7c6cca65e2c1df"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MzQ4MzUzOnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountHLLAggregationFunction.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo1Nzo0M1rOGj8zFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo1Nzo0M1rOGj8zFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0OTQ2Mg==", "bodyText": "You don't need to pass member variable _log2M to getDefaultHyperLogLog(), just remove the static should be good", "url": "https://github.com/apache/pinot/pull/5564#discussion_r440349462", "createdAt": "2020-06-15T17:57:43Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountHLLAggregationFunction.java", "diffHunk": "@@ -67,7 +79,7 @@ public void aggregate(int length, AggregationResultHolder aggregationResultHolde\n     DataType valueType = blockValSet.getValueType();\n \n     if (valueType != DataType.BYTES) {\n-      HyperLogLog hyperLogLog = getDefaultHyperLogLog(aggregationResultHolder);\n+      HyperLogLog hyperLogLog = getDefaultHyperLogLog(aggregationResultHolder, _log2M);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3799d93fa2595c01df4de2289e7c6cca65e2c1df"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MzQ4NzUzOnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountHLLMVAggregationFunction.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo1ODo1MFrOGj81kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo1ODo1MFrOGj81kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM1MDA5OQ==", "bodyText": "Same here, don't pass _log2M", "url": "https://github.com/apache/pinot/pull/5564#discussion_r440350099", "createdAt": "2020-06-15T17:58:50Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountHLLMVAggregationFunction.java", "diffHunk": "@@ -47,7 +48,7 @@ public void accept(AggregationFunctionVisitorBase visitor) {\n   @Override\n   public void aggregate(int length, AggregationResultHolder aggregationResultHolder,\n       Map<TransformExpressionTree, BlockValSet> blockValSetMap) {\n-    HyperLogLog hyperLogLog = getDefaultHyperLogLog(aggregationResultHolder);\n+    HyperLogLog hyperLogLog = getDefaultHyperLogLog(aggregationResultHolder, _log2M);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3799d93fa2595c01df4de2289e7c6cca65e2c1df"}, "originalPosition": 24}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4314, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}