{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5OTQ3NzAw", "number": 5040, "title": "Update Selection Query Limit with pre-configured value", "bodyText": "Update Selection query limit if MAX_QUERY_SELECTION_LIMIT is set.\nThis is to avoid bad/malformed usage and protect pinot servers.", "createdAt": "2020-02-01T22:30:37Z", "url": "https://github.com/apache/pinot/pull/5040", "merged": true, "mergeCommit": {"oid": "bfa176ce6f44b6d859b15baa1eab5c071cc37ddc"}, "closed": true, "closedAt": "2020-02-11T20:12:55Z", "author": {"login": "harshinielath"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcAHOW5AH2gAyMzY5OTQ3NzAwOjkyOWE1MjU2Yzc0YTI0NzBiNzA5ODI5NzhmOTlkYzFjNTIwOTA5OWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDSCbgAH2gAyMzY5OTQ3NzAwOjUyZTJiODE4ZTc5ZDgxYjJiNTg5ZjliNTg4NjI2M2FkMGFhNDg3MGQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "929a5256c74a2470b70982978f99dc1c5209099b", "author": {"user": {"login": "harshinielath", "name": null}}, "url": "https://github.com/apache/pinot/commit/929a5256c74a2470b70982978f99dc1c5209099b", "committedDate": "2020-02-01T17:31:06Z", "message": "update max selectionquery limit behavior"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "632df82c559eda48755ffc9bf2e112c00c0c575b", "author": {"user": {"login": "harshinielath", "name": null}}, "url": "https://github.com/apache/pinot/commit/632df82c559eda48755ffc9bf2e112c00c0c575b", "committedDate": "2020-02-01T17:37:54Z", "message": "Merge pull request #1 from harshinielath/update_max_select_behavior\n\nupdate max selection query limit behavior"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59ba2007219b0cd2698399ace33834c0eba9fabc", "author": {"user": {"login": "harshinielath", "name": null}}, "url": "https://github.com/apache/pinot/commit/59ba2007219b0cd2698399ace33834c0eba9fabc", "committedDate": "2020-02-02T22:02:56Z", "message": "changed limit config setup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02d15ab4ec7fa5a86c40dbe57e7eb354fc782940", "author": {"user": {"login": "harshinielath", "name": null}}, "url": "https://github.com/apache/pinot/commit/02d15ab4ec7fa5a86c40dbe57e7eb354fc782940", "committedDate": "2020-02-02T22:07:13Z", "message": "Merge pull request #2 from harshinielath/update_max_select_behavior\n\nchanged limit config setup to helix cluster level."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffd2163e2db4589f3157a2e47ced728505bbbc80", "author": {"user": {"login": "harshinielath", "name": null}}, "url": "https://github.com/apache/pinot/commit/ffd2163e2db4589f3157a2e47ced728505bbbc80", "committedDate": "2020-02-03T00:46:57Z", "message": "fixed compilation error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "365eede5b75d8882d39f926b29d2ec8ccba0f191", "author": {"user": {"login": "harshinielath", "name": null}}, "url": "https://github.com/apache/pinot/commit/365eede5b75d8882d39f926b29d2ec8ccba0f191", "committedDate": "2020-02-03T00:51:40Z", "message": "Merge pull request #3 from harshinielath/update_max_select_behavior\n\nMoved PinotQueryParserFactory to pinot-common"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MDM5Nzc1", "url": "https://github.com/apache/pinot/pull/5040#pullrequestreview-354039775", "createdAt": "2020-02-05T21:05:52Z", "commit": {"oid": "365eede5b75d8882d39f926b29d2ec8ccba0f191"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMTowNTo1MlrOFmHJmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMTowNjo0MlrOFmHLOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTUwNzM1NA==", "bodyText": "we dont need to set the variable in PinotQueryParserFactory. Just change the brokerrequest using the config", "url": "https://github.com/apache/pinot/pull/5040#discussion_r375507354", "createdAt": "2020-02-05T21:05:52Z", "author": {"login": "kishoreg"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -122,6 +123,9 @@ public BaseBrokerRequestHandler(Configuration config, RoutingTable routingTable,\n     } else {\n       _tableCache = null;\n     }\n+\n+    PinotQueryParserFactory.MAX_QUERY_SELECTION_LIMIT = _config.getInt(CommonConstants.Helix.MAX_QUERY_SELECTION_LIMIT_KEY, CommonConstants.Helix.DEFAULT_MAX_QUERY_SELECTION_LIMIT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "365eede5b75d8882d39f926b29d2ec8ccba0f191"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTUwNzc3MQ==", "bodyText": "this code can be moved to basebrokerrequesthandler", "url": "https://github.com/apache/pinot/pull/5040#discussion_r375507771", "createdAt": "2020-02-05T21:06:42Z", "author": {"login": "kishoreg"}, "path": "pinot-common/src/main/java/org/apache/pinot/pql/parsers/pql2/ast/SelectAstNode.java", "diffHunk": "@@ -166,6 +167,11 @@ public void updateBrokerRequest(BrokerRequest brokerRequest) {\n     } else {\n       brokerRequest.setLimit(DEFAULT_RECORD_LIMIT);\n     }\n+    // Update Selection query limit if MAX_QUERY_SELECTION_LIMIT is set.\n+    int limit = brokerRequest.getLimit();\n+    if ((PinotQueryParserFactory.MAX_QUERY_SELECTION_LIMIT > 0) && (limit > PinotQueryParserFactory.MAX_QUERY_SELECTION_LIMIT)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "365eede5b75d8882d39f926b29d2ec8ccba0f191"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3a34bbfd4329a65b8d1ab3254169f91de3aa02d", "author": {"user": {"login": "harshinielath", "name": null}}, "url": "https://github.com/apache/pinot/commit/c3a34bbfd4329a65b8d1ab3254169f91de3aa02d", "committedDate": "2020-02-06T19:26:22Z", "message": "Changed logic to broker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33b9c56905ee0cc3e09acd257f73bb3003b67cd9", "author": {"user": {"login": "harshinielath", "name": null}}, "url": "https://github.com/apache/pinot/commit/33b9c56905ee0cc3e09acd257f73bb3003b67cd9", "committedDate": "2020-02-06T19:32:44Z", "message": "Merge pull request #4 from harshinielath/update_max_select_behavior\n\nChanged logic to BaseBrokerRequestHandler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9481cc05697d0dcbcdf33706beefcaaf29101261", "author": {"user": {"login": "harshinielath", "name": null}}, "url": "https://github.com/apache/pinot/commit/9481cc05697d0dcbcdf33706beefcaaf29101261", "committedDate": "2020-02-07T02:52:55Z", "message": "Added Broker Query Limit Override key"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9eeeab6d14b943539604e488af8d082c208da29f", "author": {"user": {"login": "harshinielath", "name": null}}, "url": "https://github.com/apache/pinot/commit/9eeeab6d14b943539604e488af8d082c208da29f", "committedDate": "2020-02-07T02:58:46Z", "message": "Merge pull request #5 from harshinielath/update_max_select_behavior\n\nAdded ENABLE_BROKER_QUERY_LIMIT_OVERRIDE_KEY"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NDgxNTA0", "url": "https://github.com/apache/pinot/pull/5040#pullrequestreview-355481504", "createdAt": "2020-02-07T22:46:31Z", "commit": {"oid": "9eeeab6d14b943539604e488af8d082c208da29f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NTIyMzUz", "url": "https://github.com/apache/pinot/pull/5040#pullrequestreview-355522353", "createdAt": "2020-02-08T02:09:09Z", "commit": {"oid": "9eeeab6d14b943539604e488af8d082c208da29f"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b05eecf9871c343e80e24084e33944dad4460d7f", "author": {"user": {"login": "harshinielath", "name": null}}, "url": "https://github.com/apache/pinot/commit/b05eecf9871c343e80e24084e33944dad4460d7f", "committedDate": "2020-02-08T03:11:44Z", "message": "moved Pinot Query Parser back to broker requesthandler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c6bc6c22da9f5e813e5d7db0dd8c4625b46cc0d", "author": {"user": {"login": "harshinielath", "name": null}}, "url": "https://github.com/apache/pinot/commit/1c6bc6c22da9f5e813e5d7db0dd8c4625b46cc0d", "committedDate": "2020-02-08T03:13:38Z", "message": "Merge pull request #6 from harshinielath/update_max_select_behavior\n\nmoved PinotQueryParserFactory back to pinot-broker"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NzE1NTI0", "url": "https://github.com/apache/pinot/pull/5040#pullrequestreview-355715524", "createdAt": "2020-02-10T06:42:57Z", "commit": {"oid": "1c6bc6c22da9f5e813e5d7db0dd8c4625b46cc0d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwNjo0Mjo1N1rOFnbcfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwNjo0Mjo1N1rOFnbcfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg4ODQ0NQ==", "bodyText": "Can you please move this under class Broker instead of Helix? Also, I would recommend changing it to CONFIG_OF_ENABLE_QUERY_LIMIT_OVERRIDE to be consistent with other configs.", "url": "https://github.com/apache/pinot/pull/5040#discussion_r376888445", "createdAt": "2020-02-10T06:42:57Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/CommonConstants.java", "diffHunk": "@@ -42,7 +42,7 @@\n \n     public static final String LEAD_CONTROLLER_RESOURCE_ENABLED_KEY = \"RESOURCE_ENABLED\";\n     public static final String ENABLE_CASE_INSENSITIVE_PQL_KEY = \"enable.case.insensitive.pql\";\n-\n+    public static final String ENABLE_BROKER_QUERY_LIMIT_OVERRIDE_KEY = \"enable.broker.query.limit.override\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c6bc6c22da9f5e813e5d7db0dd8c4625b46cc0d"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb6ed21e0aa14f9348b32d1448c27f6466ef607b", "author": {"user": {"login": "harshinielath", "name": null}}, "url": "https://github.com/apache/pinot/commit/eb6ed21e0aa14f9348b32d1448c27f6466ef607b", "committedDate": "2020-02-10T23:27:20Z", "message": "Changed config var name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e90639832128926e5194c78bd9f19fdd94e295df", "author": {"user": {"login": "harshinielath", "name": null}}, "url": "https://github.com/apache/pinot/commit/e90639832128926e5194c78bd9f19fdd94e295df", "committedDate": "2020-02-11T00:04:39Z", "message": "Merge pull request #7 from harshinielath/update_max_select_behavior\n\nChanged config var name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2NDAyOTUz", "url": "https://github.com/apache/pinot/pull/5040#pullrequestreview-356402953", "createdAt": "2020-02-11T03:30:55Z", "commit": {"oid": "e90639832128926e5194c78bd9f19fdd94e295df"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQwMzozMDo1NlrOFn8tsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQwMzozNDoyN1rOFn8v3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQzMzUyMg==", "bodyText": "pinot.broker.enable.query.limit.override for consistency", "url": "https://github.com/apache/pinot/pull/5040#discussion_r377433522", "createdAt": "2020-02-11T03:30:56Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/CommonConstants.java", "diffHunk": "@@ -166,6 +165,7 @@ public ServerType getServerType() {\n     public static final String CONFIG_OF_BROKER_MIN_RESOURCE_PERCENT_FOR_START =\n         \"pinot.broker.startup.minResourcePercent\";\n     public static final double DEFAULT_BROKER_MIN_RESOURCE_PERCENT_FOR_START = 100.0;\n+    public static final String CONFIG_OF_ENABLE_QUERY_LIMIT_OVERRIDE = \"enable.broker.query.limit.override\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e90639832128926e5194c78bd9f19fdd94e295df"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQzMzcwMA==", "bodyText": "(nit) CommonConstants.Broker is already imported so you can directly use Broker.CONFIG_OF_ENABLE_QUERY_LIMIT_OVERRIDE", "url": "https://github.com/apache/pinot/pull/5040#discussion_r377433700", "createdAt": "2020-02-11T03:32:04Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -122,6 +122,9 @@ public BaseBrokerRequestHandler(Configuration config, RoutingTable routingTable,\n     } else {\n       _tableCache = null;\n     }\n+\n+    _enableBrokerQueryLimitOverride = _config.getBoolean(CommonConstants.Broker.CONFIG_OF_ENABLE_QUERY_LIMIT_OVERRIDE, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e90639832128926e5194c78bd9f19fdd94e295df"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQzNDAzMg==", "bodyText": "(nit) enableQueryLimitOverride", "url": "https://github.com/apache/pinot/pull/5040#discussion_r377434032", "createdAt": "2020-02-11T03:34:07Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/broker/helix/HelixBrokerStarter.java", "diffHunk": "@@ -182,7 +181,8 @@ public void start()\n         new HelixConfigScopeBuilder(HelixConfigScope.ConfigScopeProperty.CLUSTER).forCluster(_clusterName).build();\n     String enableCaseInsensitivePql = configAccessor.get(helixConfigScope, Helix.ENABLE_CASE_INSENSITIVE_PQL_KEY);\n     _brokerConf.setProperty(Helix.ENABLE_CASE_INSENSITIVE_PQL_KEY, Boolean.valueOf(enableCaseInsensitivePql));\n-\n+    String enableBrokerQueryLimitOverride = configAccessor.get(helixConfigScope, Broker.CONFIG_OF_ENABLE_QUERY_LIMIT_OVERRIDE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e90639832128926e5194c78bd9f19fdd94e295df"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQzNDA3Ng==", "bodyText": "(nit) _enableQueryLimitOverride?", "url": "https://github.com/apache/pinot/pull/5040#discussion_r377434076", "createdAt": "2020-02-11T03:34:27Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -104,6 +103,7 @@\n   private final AtomicInteger _numDroppedLog;\n \n   private final boolean _enableCaseInsensitivePql;\n+  private final boolean _enableBrokerQueryLimitOverride;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e90639832128926e5194c78bd9f19fdd94e295df"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6664fc4c7430fb8c196c431d9dd7091fd403f86", "author": {"user": {"login": "harshinielath", "name": null}}, "url": "https://github.com/apache/pinot/commit/c6664fc4c7430fb8c196c431d9dd7091fd403f86", "committedDate": "2020-02-11T13:45:38Z", "message": "Few nit changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52e2b818e79d81b2b589f9b5886263ad0aa4870d", "author": {"user": {"login": "harshinielath", "name": null}}, "url": "https://github.com/apache/pinot/commit/52e2b818e79d81b2b589f9b5886263ad0aa4870d", "committedDate": "2020-02-11T13:48:48Z", "message": "Merge pull request #8 from harshinielath/update_max_select_behavior\n\nFew nit changes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1575, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}