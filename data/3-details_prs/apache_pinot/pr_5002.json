{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1NjMwMDU2", "number": 5002, "title": "Handle sun.nio.ch.DirectBuffer cleaner behavior for jdk 8+", "bodyText": "From jdk 9, sun.misc.Cleaner is moved to jdk.internal.ref.Cleaner and sun.misc.Unsafe#invokeCleaner(ByteBuffer) is the replacement to clean buffer.\nThis  PR ensures the code built in jdk 8 can also be running under jdk 9+.\nE.g. this exception will be thrown when running Pinot built under jdk8 with jdk 11:\nException in thread \"main\" java.lang.NoSuchMethodError: 'sun.misc.Cleaner sun.nio.ch.DirectBuffer.cleaner()'\n\tat org.apache.pinot.core.segment.memory.PinotByteBuffer.release(PinotByteBuffer.java:330)\n\tat org.apache.pinot.core.segment.memory.PinotDataBuffer.close(PinotDataBuffer.java:272)\n\tat org.apache.pinot.core.io.util.FixedByteValueReaderWriter.close(FixedByteValueReaderWriter.java:126)\n\tat org.apache.pinot.core.segment.creator.impl.SegmentDictionaryCreator.build(SegmentDictionaryCreator.java:91)\n\tat org.apache.pinot.core.segment.creator.impl.SegmentColumnarIndexCreator.init(SegmentColumnarIndexCreator.java:146)\n\tat org.apache.pinot.core.segment.creator.impl.SegmentIndexCreationDriverImpl.buildRaw(SegmentIndexCreationDriverImpl.java:370)\n\tat org.apache.pinot.core.segment.creator.impl.SegmentIndexCreationDriverImpl.build(SegmentIndexCreationDriverImpl.java:249)\n\tat org.apache.pinot.plugin.ingestion.batch.common.SegmentGenerationTaskRunner.run(SegmentGenerationTaskRunner.java:103)\n\tat org.apache.pinot.plugin.ingestion.batch.standalone.SegmentGenerationJobRunner.run(SegmentGenerationJobRunner.java:190)\n\tat org.apache.pinot.spi.ingestion.batch.IngestionJobLauncher.kickoffIngestionJob(IngestionJobLauncher.java:96)\n\tat org.apache.pinot.spi.ingestion.batch.IngestionJobLauncher.runIngestionJob(IngestionJobLauncher.java:77)\n\tat org.apache.pinot.spi.ingestion.batch.IngestionJobLauncher.main(IngestionJobLauncher.java:55)\n\tat org.apache.pinot.tools.admin.command.LaunchDataIngestionJobCommand.execute(LaunchDataIngestionJobCommand.java:50)\n\tat org.apache.pinot.tools.admin.PinotAdministrator.execute(PinotAdministrator.java:148)\n\tat org.apache.pinot.tools.admin.PinotAdministrator.main(PinotAdministrator.java:160)\n\tSuppressed: java.lang.NoSuchMethodError: 'sun.misc.Cleaner sun.nio.ch.DirectBuffer.cleaner()'\n\t\tat org.apache.pinot.core.segment.memory.PinotByteBuffer.release(PinotByteBuffer.java:330)\n\t\tat org.apache.pinot.core.segment.memory.PinotDataBuffer.close(PinotDataBuffer.java:272)\n\t\t... 12 more```", "createdAt": "2020-01-22T02:16:25Z", "url": "https://github.com/apache/pinot/pull/5002", "merged": true, "mergeCommit": {"oid": "c3117d0ed32438a75bebf5f53be0b259f5a64aac"}, "closed": true, "closedAt": "2020-01-23T01:11:33Z", "author": {"login": "xiangfu0"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8s_NbgFqTM0NjMyNTMwMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8_EZ-gBqjI5NzIwNjY1MTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MzI1MzAw", "url": "https://github.com/apache/pinot/pull/5002#pullrequestreview-346325300", "createdAt": "2020-01-22T03:14:43Z", "commit": {"oid": "1e6dd26dd6dd5d95635d869de31038b891040aa3"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwMzoxNDo0M1rOFgPgow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwMzoxNToxMlrOFgPg7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM1Mjg2Nw==", "bodyText": "Will this throw exception in normal case? We should not swallow exception", "url": "https://github.com/apache/pinot/pull/5002#discussion_r369352867", "createdAt": "2020-01-22T03:14:43Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/memory/PinotByteBuffer.java", "diffHunk": "@@ -327,8 +327,11 @@ public void flush() {\n \n   @Override\n   protected void release() {\n-    if (((DirectBuffer) _buffer).cleaner() != null) {\n-      ((DirectBuffer) _buffer).cleaner().clean();\n+    if (CleanerUtil.UNMAP_SUPPORTED) {\n+      try {\n+        CleanerUtil.getCleaner().freeBuffer(_buffer);\n+      } catch (IOException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e6dd26dd6dd5d95635d869de31038b891040aa3"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM1Mjk0Mg==", "bodyText": "If UNMAP is not supported, are we going to leak resources?", "url": "https://github.com/apache/pinot/pull/5002#discussion_r369352942", "createdAt": "2020-01-22T03:15:12Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/memory/PinotByteBuffer.java", "diffHunk": "@@ -327,8 +327,11 @@ public void flush() {\n \n   @Override\n   protected void release() {\n-    if (((DirectBuffer) _buffer).cleaner() != null) {\n-      ((DirectBuffer) _buffer).cleaner().clean();\n+    if (CleanerUtil.UNMAP_SUPPORTED) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e6dd26dd6dd5d95635d869de31038b891040aa3"}, "originalPosition": 15}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1e6dd26dd6dd5d95635d869de31038b891040aa3", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/1e6dd26dd6dd5d95635d869de31038b891040aa3", "committedDate": "2020-01-22T01:45:49Z", "message": "Smoothly handle ByteBuffer clean behavior from jdk 8"}, "afterCommit": {"oid": "07577fc659a9b6e8bfea8ea087f5dcc0ab5e208f", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/07577fc659a9b6e8bfea8ea087f5dcc0ab5e208f", "committedDate": "2020-01-22T06:51:29Z", "message": "Smoothly handle ByteBuffer clean behavior from jdk 8"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06deaba62b5ea6fce9ac37dc193743cbed30ae13", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/06deaba62b5ea6fce9ac37dc193743cbed30ae13", "committedDate": "2020-01-22T07:00:31Z", "message": "Smoothly handle ByteBuffer clean behavior from jdk 8"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "07577fc659a9b6e8bfea8ea087f5dcc0ab5e208f", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/07577fc659a9b6e8bfea8ea087f5dcc0ab5e208f", "committedDate": "2020-01-22T06:51:29Z", "message": "Smoothly handle ByteBuffer clean behavior from jdk 8"}, "afterCommit": {"oid": "06deaba62b5ea6fce9ac37dc193743cbed30ae13", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/06deaba62b5ea6fce9ac37dc193743cbed30ae13", "committedDate": "2020-01-22T07:00:31Z", "message": "Smoothly handle ByteBuffer clean behavior from jdk 8"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2OTkwMDg0", "url": "https://github.com/apache/pinot/pull/5002#pullrequestreview-346990084", "createdAt": "2020-01-23T00:10:32Z", "commit": {"oid": "b79d53e38bd7f86cbe99174561b457916ef1cade"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QwMDoxMDozMlrOFgvS5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QwMDoxMjoxNlrOFgvUvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg3MzYzOA==", "bodyText": "No need for this test as release() is called in close().", "url": "https://github.com/apache/pinot/pull/5002#discussion_r369873638", "createdAt": "2020-01-23T00:10:32Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/test/java/org/apache/pinot/core/segment/memory/PinotDataBufferTest.java", "diffHunk": "@@ -115,6 +115,34 @@ public void testPinotByteBuffer()\n     }\n   }\n \n+  @Test\n+  public void testPinotByteBufferRelease()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b79d53e38bd7f86cbe99174561b457916ef1cade"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg3Mzg5Nw==", "bodyText": "Maybe better to log an warning with the reason when CleanerUtil.UNMAP_SUPPORTED is false", "url": "https://github.com/apache/pinot/pull/5002#discussion_r369873897", "createdAt": "2020-01-23T00:11:30Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/memory/PinotByteBuffer.java", "diffHunk": "@@ -326,9 +329,15 @@ public void flush() {\n   }\n \n   @Override\n-  protected void release() {\n-    if (((DirectBuffer) _buffer).cleaner() != null) {\n-      ((DirectBuffer) _buffer).cleaner().clean();\n+  protected void release()\n+      throws IOException {\n+    if (CleanerUtil.UNMAP_SUPPORTED) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b79d53e38bd7f86cbe99174561b457916ef1cade"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg3NDExMA==", "bodyText": "No need to try-catch and log the error if we throw the exception out", "url": "https://github.com/apache/pinot/pull/5002#discussion_r369874110", "createdAt": "2020-01-23T00:12:16Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/memory/PinotByteBuffer.java", "diffHunk": "@@ -326,9 +329,15 @@ public void flush() {\n   }\n \n   @Override\n-  protected void release() {\n-    if (((DirectBuffer) _buffer).cleaner() != null) {\n-      ((DirectBuffer) _buffer).cleaner().clean();\n+  protected void release()\n+      throws IOException {\n+    if (CleanerUtil.UNMAP_SUPPORTED) {\n+      try {\n+        CleanerUtil.getCleaner().freeBuffer(_buffer);\n+      } catch (IOException e) {\n+        LOGGER.error(\"Failed to release ByteBuffer: {}\", _buffer, e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b79d53e38bd7f86cbe99174561b457916ef1cade"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fb56e162f7cfa4fbd1ba10b89c6c4ebce7ac6a3", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/8fb56e162f7cfa4fbd1ba10b89c6c4ebce7ac6a3", "committedDate": "2020-01-23T00:19:03Z", "message": "address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b79d53e38bd7f86cbe99174561b457916ef1cade", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/b79d53e38bd7f86cbe99174561b457916ef1cade", "committedDate": "2020-01-22T23:30:13Z", "message": "Adding test for PinotByteBuffer release"}, "afterCommit": {"oid": "8fb56e162f7cfa4fbd1ba10b89c6c4ebce7ac6a3", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/8fb56e162f7cfa4fbd1ba10b89c6c4ebce7ac6a3", "committedDate": "2020-01-23T00:19:03Z", "message": "address comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1511, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}