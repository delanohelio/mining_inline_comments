{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyNzE2ODUz", "number": 6213, "title": "[Upsert] Preserve the newer added record when 2 records have the same timestamp", "bodyText": "Description\nFor upsert table, the record with newer timestamp will replace the old record with older timestamp, but when multiple records have the same timestamp, which record to preserve is undefined in the current implementation.\nThis PR enhances the PartitionUpsertMetadataManager to preserve the latest ingested record if multiple records have the same timestamp:\n\nIf 2 records are not in the same segment, preserve the one in the segment with larger sequence number\nIf 2 records are in the same segment, preserve the one with larger docId\n\nNote that for tables with sorted column, the records will be re-ordered when committing the segment, and we will use the re-ordered docIds instead of the ingestion order to decide which record to preserve.", "createdAt": "2020-10-30T02:30:12Z", "url": "https://github.com/apache/pinot/pull/6213", "merged": true, "mergeCommit": {"oid": "8678f5ec0a5a58a095b38d27b5ecda55efdde8ec"}, "closed": true, "closedAt": "2020-10-30T19:27:05Z", "author": {"login": "Jackie-Jiang"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXfi7VAFqTUyMDM3ODMwMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXravQgFqTUyMDk0ODg1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMzc4MzAw", "url": "https://github.com/apache/pinot/pull/6213#pullrequestreview-520378300", "createdAt": "2020-10-30T05:02:42Z", "commit": {"oid": "089dac2b0f2b97865b4c8f17fd5ce2b6a730cfd5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNDEyMjAz", "url": "https://github.com/apache/pinot/pull/6213#pullrequestreview-520412203", "createdAt": "2020-10-30T06:54:14Z", "commit": {"oid": "089dac2b0f2b97865b4c8f17fd5ce2b6a730cfd5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwNjo1NDoxNFrOHrDIXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwNjo1NDoxNFrOHrDIXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkwMjEwOQ==", "bodyText": "Can you update this line of comments? It is a bit hard to understand. Do you mean:\n\"\u2026, where we want to\" =>. In this case, we want to update the record location when there is a tie\u2026\nalso when this is a tie, how to you update the record location? Should it be determined by docID?", "url": "https://github.com/apache/pinot/pull/6213#discussion_r514902109", "createdAt": "2020-10-30T06:54:14Z", "author": {"login": "chenboat"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/upsert/PartitionUpsertMetadataManager.java", "diffHunk": "@@ -83,34 +87,34 @@ public ThreadSafeMutableRoaringBitmap addSegment(String segmentName, Iterator<Re\n           if (segmentName.equals(currentRecordLocation.getSegmentName())) {\n             // The current record location has the same segment name\n \n-            if (validDocIds == currentRecordLocation.getValidDocIds()) {\n-              // The current record location is pointing to the new segment being loaded\n-\n-              // Update the record location when getting a newer timestamp\n-              if (recordInfo._timestamp > currentRecordLocation.getTimestamp()) {\n+            // Update the record location when the new timestamp is greater than or equal to the current timestamp.\n+            // There are 2 scenarios:\n+            //   1. The current record location is pointing to the new segment being loaded, where we want to update the", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "089dac2b0f2b97865b4c8f17fd5ce2b6a730cfd5"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e632601f7ae709398eca33d22d872098770d34f", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/6e632601f7ae709398eca33d22d872098770d34f", "committedDate": "2020-10-30T17:57:04Z", "message": "[Upsert] Preserve the newer added record when 2 records have the same timestamp"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "089dac2b0f2b97865b4c8f17fd5ce2b6a730cfd5", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/089dac2b0f2b97865b4c8f17fd5ce2b6a730cfd5", "committedDate": "2020-10-30T02:25:16Z", "message": "[Upsert] Preserve the newer added record when 2 records have the same timestamp"}, "afterCommit": {"oid": "6e632601f7ae709398eca33d22d872098770d34f", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/6e632601f7ae709398eca33d22d872098770d34f", "committedDate": "2020-10-30T17:57:04Z", "message": "[Upsert] Preserve the newer added record when 2 records have the same timestamp"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwOTQ4ODUx", "url": "https://github.com/apache/pinot/pull/6213#pullrequestreview-520948851", "createdAt": "2020-10-30T18:52:37Z", "commit": {"oid": "6e632601f7ae709398eca33d22d872098770d34f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1681, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}