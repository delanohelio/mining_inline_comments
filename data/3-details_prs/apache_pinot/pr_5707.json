{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5Mzc2OTMy", "number": 5707, "title": "Allow Pinot to accept query with FROM clause in the format of [database].[table]", "bodyText": "Description\nAllow Pinot to accept query with FROM clause in the format of [database].[table].\nWill update TableName to [table] in BrokerRequest, when [database].[table] doesn't exist but [table] exists.\nFor case sensitive mode (default), use RoutingManager to check table existence.\nFor case insensitive mode, use TableCache to check table existence.\nSome thoughts here:\nWe should try to prevent user creating table with dot in the table name.\nRelease Notes\nAllow Pinot to accept query with FROM clause in the format of [database].[table].", "createdAt": "2020-07-15T09:59:26Z", "url": "https://github.com/apache/pinot/pull/5707", "merged": true, "mergeCommit": {"oid": "48d9ca72c97e8689da238052dfc38c33100932fe"}, "closed": true, "closedAt": "2020-07-16T07:18:14Z", "author": {"login": "xiangfu0"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1Hj0wAH2gAyNDQ5Mzc2OTMyOmQyZjcwOWFhZGQwMzg3ODVjZDA0ZjlkNWU3ZDQ5MzUzZmNkYmRhODI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1XSJDAH2gAyNDQ5Mzc2OTMyOmQ5NThmOTg5MzY3OTkxYmVjNGQ4OTkxOTEyNzg2OWJhN2E4NTFiNWY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d2f709aadd038785cd04f9d5e7d49353fcdbda82", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/d2f709aadd038785cd04f9d5e7d49353fcdbda82", "committedDate": "2020-07-15T09:52:32Z", "message": "Allow Pinot to accept query with FROM clause in the format of [database].[table]"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MjExMzM3", "url": "https://github.com/apache/pinot/pull/5707#pullrequestreview-449211337", "createdAt": "2020-07-15T18:11:32Z", "commit": {"oid": "d2f709aadd038785cd04f9d5e7d49353fcdbda82"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxODoxMTozMlrOGyKBUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxODoxMTozMlrOGyKBUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI0NjE2MQ==", "bodyText": "Should this be done in PinotQuery2BrokerRequestConverter?", "url": "https://github.com/apache/pinot/pull/5707#discussion_r455246161", "createdAt": "2020-07-15T18:11:32Z", "author": {"login": "mayankshriv"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -438,6 +439,46 @@ public BrokerResponse handleRequest(JsonNode request, @Nullable RequesterIdentit\n     return brokerResponse;\n   }\n \n+  /**\n+   * Check if table is in the format of [database_name].[table_name].\n+   *\n+   * Only update TableName in QuerySource if there is no existing table in the format of [database_name].[table_name],\n+   * but only [table_name].\n+   *\n+   * @param brokerRequest\n+   */\n+  private void updateQuerySource(BrokerRequest brokerRequest) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2f709aadd038785cd04f9d5e7d49353fcdbda82"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MzgzNzQy", "url": "https://github.com/apache/pinot/pull/5707#pullrequestreview-449383742", "createdAt": "2020-07-15T22:20:50Z", "commit": {"oid": "d2f709aadd038785cd04f9d5e7d49353fcdbda82"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjoyMDo1MFrOGyTT0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjozMjoxNlrOGyTlIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM5ODM1NA==", "bodyText": "Avoid regex match\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                String[] querySourceSplits = tableName.split(\"\\\\.\", 2);\n          \n          \n            \n                String[] tableNameSplits = StringUtils.split(tableName, '.');", "url": "https://github.com/apache/pinot/pull/5707#discussion_r455398354", "createdAt": "2020-07-15T22:20:50Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -438,6 +439,46 @@ public BrokerResponse handleRequest(JsonNode request, @Nullable RequesterIdentit\n     return brokerResponse;\n   }\n \n+  /**\n+   * Check if table is in the format of [database_name].[table_name].\n+   *\n+   * Only update TableName in QuerySource if there is no existing table in the format of [database_name].[table_name],\n+   * but only [table_name].\n+   *\n+   * @param brokerRequest\n+   */\n+  private void updateQuerySource(BrokerRequest brokerRequest) {\n+    String tableName = brokerRequest.getQuerySource().getTableName();\n+    // Check if table is in the format of [database_name].[table_name]\n+    String[] querySourceSplits = tableName.split(\"\\\\.\", 2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2f709aadd038785cd04f9d5e7d49353fcdbda82"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM5OTg1MA==", "bodyText": "Suggest renaming to containsTable()", "url": "https://github.com/apache/pinot/pull/5707#discussion_r455399850", "createdAt": "2020-07-15T22:24:43Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/helix/TableCache.java", "diffHunk": "@@ -67,6 +67,10 @@ public String getActualTableName(String tableName) {\n     return _tableConfigChangeListener._tableNameMap.getOrDefault(tableName.toLowerCase(), tableName);\n   }\n \n+  public boolean existTableName(String tableName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2f709aadd038785cd04f9d5e7d49353fcdbda82"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQwMTgzMw==", "bodyText": "Use 2 if checks to prevent using RoutingManager for case insensitive table\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (_enableCaseInsensitive && _tableCache.existTableName(querySourceSplits[1]) && !_tableCache\n          \n          \n            \n                    .existTableName(tableName)) {\n          \n          \n            \n                  // Use TableCache to check case insensitive table name.\n          \n          \n            \n                  brokerRequest.getQuerySource().setTableName(querySourceSplits[1]);\n          \n          \n            \n                  return;\n          \n          \n            \n                }\n          \n          \n            \n                if (_enableCaseInsensitive) {\n          \n          \n            \n                  // Use TableCache to check case insensitive table name.\n          \n          \n            \n                  if (_tableCache.existTableName(querySourceSplits[1]) && !_tableCache.existTableName(tableName)) {\n          \n          \n            \n                    brokerRequest.getQuerySource().setTableName(querySourceSplits[1]);\n          \n          \n            \n                  }\n          \n          \n            \n                  return;\n          \n          \n            \n                }", "url": "https://github.com/apache/pinot/pull/5707#discussion_r455401833", "createdAt": "2020-07-15T22:29:35Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -438,6 +439,46 @@ public BrokerResponse handleRequest(JsonNode request, @Nullable RequesterIdentit\n     return brokerResponse;\n   }\n \n+  /**\n+   * Check if table is in the format of [database_name].[table_name].\n+   *\n+   * Only update TableName in QuerySource if there is no existing table in the format of [database_name].[table_name],\n+   * but only [table_name].\n+   *\n+   * @param brokerRequest\n+   */\n+  private void updateQuerySource(BrokerRequest brokerRequest) {\n+    String tableName = brokerRequest.getQuerySource().getTableName();\n+    // Check if table is in the format of [database_name].[table_name]\n+    String[] querySourceSplits = tableName.split(\"\\\\.\", 2);\n+    if (querySourceSplits.length != 2) {\n+      return;\n+    }\n+    // Update table name if there is no existing table in the format of [database_name].[table_name] but only [table_name]\n+    if (_enableCaseInsensitive && _tableCache.existTableName(querySourceSplits[1]) && !_tableCache\n+        .existTableName(tableName)) {\n+      // Use TableCache to check case insensitive table name.\n+      brokerRequest.getQuerySource().setTableName(querySourceSplits[1]);\n+      return;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2f709aadd038785cd04f9d5e7d49353fcdbda82"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQwMjc4NA==", "bodyText": "Similarly here\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (tableType != null && _routingManager.routingExists(querySourceSplits[1]) && !_routingManager\n          \n          \n            \n                    .routingExists(tableName)) {\n          \n          \n            \n                  brokerRequest.getQuerySource().setTableName(querySourceSplits[1]);\n          \n          \n            \n                  return;\n          \n          \n            \n                }\n          \n          \n            \n                if (TableNameBuilder.isTableResource(tableName)) {\n          \n          \n            \n                  if (_routingManager.routingExists(querySourceSplits[1]) && !_routingManager.routingExists(tableName)) {\n          \n          \n            \n                    brokerRequest.getQuerySource().setTableName(querySourceSplits[1]);\n          \n          \n            \n                  }\n          \n          \n            \n                  return;\n          \n          \n            \n                }", "url": "https://github.com/apache/pinot/pull/5707#discussion_r455402784", "createdAt": "2020-07-15T22:32:16Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -438,6 +439,46 @@ public BrokerResponse handleRequest(JsonNode request, @Nullable RequesterIdentit\n     return brokerResponse;\n   }\n \n+  /**\n+   * Check if table is in the format of [database_name].[table_name].\n+   *\n+   * Only update TableName in QuerySource if there is no existing table in the format of [database_name].[table_name],\n+   * but only [table_name].\n+   *\n+   * @param brokerRequest\n+   */\n+  private void updateQuerySource(BrokerRequest brokerRequest) {\n+    String tableName = brokerRequest.getQuerySource().getTableName();\n+    // Check if table is in the format of [database_name].[table_name]\n+    String[] querySourceSplits = tableName.split(\"\\\\.\", 2);\n+    if (querySourceSplits.length != 2) {\n+      return;\n+    }\n+    // Update table name if there is no existing table in the format of [database_name].[table_name] but only [table_name]\n+    if (_enableCaseInsensitive && _tableCache.existTableName(querySourceSplits[1]) && !_tableCache\n+        .existTableName(tableName)) {\n+      // Use TableCache to check case insensitive table name.\n+      brokerRequest.getQuerySource().setTableName(querySourceSplits[1]);\n+      return;\n+    }\n+    // Use RoutingManager to check case sensitive table name.\n+    TableType tableType = TableNameBuilder.getTableTypeFromTableName(tableName);\n+    if (tableType != null && _routingManager.routingExists(querySourceSplits[1]) && !_routingManager\n+        .routingExists(tableName)) {\n+      brokerRequest.getQuerySource().setTableName(querySourceSplits[1]);\n+      return;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2f709aadd038785cd04f9d5e7d49353fcdbda82"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "429d27383a9006aeb713150ed21cc0679570f6ea", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/429d27383a9006aeb713150ed21cc0679570f6ea", "committedDate": "2020-07-16T00:32:18Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NDUzMDM0", "url": "https://github.com/apache/pinot/pull/5707#pullrequestreview-449453034", "createdAt": "2020-07-16T01:48:47Z", "commit": {"oid": "429d27383a9006aeb713150ed21cc0679570f6ea"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwMTo0ODo0N1rOGyXLJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwMTo0ODo0N1rOGyXLJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ2MTY3MA==", "bodyText": "Move return outside\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  if (_routingManager.routingExists(tableNameSplits[1]) && !_routingManager.routingExists(tableName)) {\n          \n          \n            \n                    brokerRequest.getQuerySource().setTableName(tableNameSplits[1]);\n          \n          \n            \n                    return;\n          \n          \n            \n                  }\n          \n          \n            \n                  if (_routingManager.routingExists(tableNameSplits[1]) && !_routingManager.routingExists(tableName)) {\n          \n          \n            \n                    brokerRequest.getQuerySource().setTableName(tableNameSplits[1]);\n          \n          \n            \n                  }\n          \n          \n            \n                  return;", "url": "https://github.com/apache/pinot/pull/5707#discussion_r455461670", "createdAt": "2020-07-16T01:48:47Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -438,6 +439,47 @@ public BrokerResponse handleRequest(JsonNode request, @Nullable RequesterIdentit\n     return brokerResponse;\n   }\n \n+  /**\n+   * Check if table is in the format of [database_name].[table_name].\n+   *\n+   * Only update TableName in QuerySource if there is no existing table in the format of [database_name].[table_name],\n+   * but only [table_name].\n+   *\n+   * @param brokerRequest\n+   */\n+  private void updateQuerySource(BrokerRequest brokerRequest) {\n+    String tableName = brokerRequest.getQuerySource().getTableName();\n+    // Check if table is in the format of [database_name].[table_name]\n+    String[] tableNameSplits = StringUtils.split(tableName, '.');\n+    if (tableNameSplits.length != 2) {\n+      return;\n+    }\n+    // Update table name if there is no existing table in the format of [database_name].[table_name] but only [table_name]\n+    if (_enableCaseInsensitive) {\n+      if (_tableCache.containsTable(tableNameSplits[1]) && !_tableCache.containsTable(tableName)) {\n+        // Use TableCache to check case insensitive table name.\n+        brokerRequest.getQuerySource().setTableName(tableNameSplits[1]);\n+      }\n+      return;\n+    }\n+    // Use RoutingManager to check case sensitive table name.\n+    if (TableNameBuilder.isTableResource(tableName)) {\n+      if (_routingManager.routingExists(tableNameSplits[1]) && !_routingManager.routingExists(tableName)) {\n+        brokerRequest.getQuerySource().setTableName(tableNameSplits[1]);\n+        return;\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "429d27383a9006aeb713150ed21cc0679570f6ea"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d958f989367991bec4d89919127869ba7a851b5f", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/d958f989367991bec4d89919127869ba7a851b5f", "committedDate": "2020-07-16T04:11:42Z", "message": "Update pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java\n\nCo-authored-by: Xiaotian (Jackie) Jiang <17555551+Jackie-Jiang@users.noreply.github.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 345, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}