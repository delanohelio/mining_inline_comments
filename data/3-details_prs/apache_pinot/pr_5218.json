{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwMTk1NzUx", "number": 5218, "title": "Fix HDFS copy logic", "bodyText": "Current hdfs cp will copy all the files from src dir to dest dir as a flatten layout.\nThis fix will ensure the dest directory could retain the same structure as src directory.\nFor HadoopPinotFS.copy(src,dest) behavior:\nBefore:\nsrc/2014/01/01/myTable-20140101.avro\nsrc/2014/01/02/myTable-20140102.avro\nsrc/2014/01/03/myTable-20140103.avro\nsrc/2014/01/04/myTable-20140104.avro\n\n=>\ndest/myTable-20140101.avro\ndest/myTable-20140102.avro\ndest/myTable-20140103.avro\ndest/myTable-20140104.avro\n\nNew logic:\nsrc/2014/01/01/myTable-20140101.avro\nsrc/2014/01/02/myTable-20140102.avro\nsrc/2014/01/03/myTable-20140103.avro\nsrc/2014/01/04/myTable-20140104.avro\n\n=>\ndest/2014/01/01/myTable-20140101.avro\ndest/2014/01/02/myTable-20140102.avro\ndest/2014/01/03/myTable-20140103.avro\ndest/2014/01/04/myTable-20140104.avro", "createdAt": "2020-04-07T11:01:38Z", "url": "https://github.com/apache/pinot/pull/5218", "merged": true, "mergeCommit": {"oid": "d68ef7b1cb57a95e159a431b909cf45bef1e6a66"}, "closed": true, "closedAt": "2020-04-17T03:02:36Z", "author": {"login": "xiangfu0"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXpqf2AH2gAyNDAwMTk1NzUxOmJjMDcwMzE0MzNkZmE1MDQ0OWQ0ZDllYTJjYjAzYzdhN2Y5ZDBjYWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYV23eABqjMyNDIzMzEwMDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bc07031433dfa50449d4d9ea2cb03c7a7f9d0cac", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/bc07031433dfa50449d4d9ea2cb03c7a7f9d0cac", "committedDate": "2020-04-14T20:38:52Z", "message": "Make Quickstart to log error to consoles"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0OTA0MTA3", "url": "https://github.com/apache/pinot/pull/5218#pullrequestreview-394904107", "createdAt": "2020-04-16T18:41:57Z", "commit": {"oid": "c82e14b085ffb65d4eac4794361157c54ef8e8b0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxODo0MTo1OFrOGGyfRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxODo0MTo1OFrOGGyfRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc3MTg0NA==", "bodyText": "Why do we need to set it to false?", "url": "https://github.com/apache/pinot/pull/5218#discussion_r409771844", "createdAt": "2020-04-16T18:41:58Z", "author": {"login": "jackjlli"}, "path": "pinot-plugins/pinot-file-system/pinot-hdfs/src/main/java/org/apache/pinot/plugin/filesystem/HadoopPinotFS.java", "diffHunk": "@@ -60,6 +62,7 @@ public void init(Configuration config) {\n       _hadoopConf = getConf(config.getString(HADOOP_CONF_PATH));\n       authenticate(_hadoopConf, config);\n       _hadoopFS = org.apache.hadoop.fs.FileSystem.get(_hadoopConf);\n+      _hadoopFS.setWriteChecksum((config.getBoolean(WRITE_CHECKSUM, false)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c82e14b085ffb65d4eac4794361157c54ef8e8b0"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0OTk2NDQ1", "url": "https://github.com/apache/pinot/pull/5218#pullrequestreview-394996445", "createdAt": "2020-04-16T21:02:06Z", "commit": {"oid": "c82e14b085ffb65d4eac4794361157c54ef8e8b0"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMTowMjowN1rOGG3BXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMTowMjowN1rOGG3BXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg0NjExMA==", "bodyText": "Here the distURI is constructed by target + sourceFilePath. Can you make sure sourceFilePath is relative path instead of absolute path?\nAnd if possible, it'd be good to add some tests for this method. Thanks!", "url": "https://github.com/apache/pinot/pull/5218#discussion_r409846110", "createdAt": "2020-04-16T21:02:07Z", "author": {"login": "jackjlli"}, "path": "pinot-plugins/pinot-file-system/pinot-hdfs/src/main/java/org/apache/pinot/plugin/filesystem/HadoopPinotFS.java", "diffHunk": "@@ -97,13 +100,24 @@ public boolean copy(URI srcUri, URI dstUri)\n       throws IOException {\n     Path source = new Path(srcUri);\n     Path target = new Path(dstUri);\n-    RemoteIterator<LocatedFileStatus> sourceFiles = _hadoopFS.listFiles(source, true);\n+    RemoteIterator<FileStatus> sourceFiles = _hadoopFS.listStatusIterator(source);\n     if (sourceFiles != null) {\n       while (sourceFiles.hasNext()) {\n-        boolean succeeded =\n-            FileUtil.copy(_hadoopFS, sourceFiles.next().getPath(), _hadoopFS, target, true, _hadoopConf);\n-        if (!succeeded) {\n-          return false;\n+        FileStatus sourceFile = sourceFiles.next();\n+        Path sourceFilePath = sourceFile.getPath();\n+        if (sourceFile.isFile()) {\n+          try {\n+            FileUtil.copy(_hadoopFS, sourceFilePath, _hadoopFS, new Path(target, sourceFilePath.getName()), false,\n+                _hadoopConf);\n+          } catch (FileNotFoundException e) {\n+            LOGGER.warn(\"Not found file {}, skipping copying it...\", sourceFilePath, e);\n+          }\n+        } else if (sourceFile.isDirectory()) {\n+          try {\n+            copy(sourceFilePath.toUri(), new Path(target, sourceFilePath.getName()).toUri());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c82e14b085ffb65d4eac4794361157c54ef8e8b0"}, "originalPosition": 74}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d4edc680d1791e7bd3f84b3fc88b9a2469554e5", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/6d4edc680d1791e7bd3f84b3fc88b9a2469554e5", "committedDate": "2020-04-17T00:03:35Z", "message": "Update HDFS copy logic"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cfd0b2c5ca756a07532278aace875c70077b795a", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/cfd0b2c5ca756a07532278aace875c70077b795a", "committedDate": "2020-04-17T00:02:48Z", "message": "Adding test"}, "afterCommit": {"oid": "71584a969002ec82407e0119c9dd39e3751b5fb3", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/71584a969002ec82407e0119c9dd39e3751b5fb3", "committedDate": "2020-04-17T00:03:35Z", "message": "Adding test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a208fb0ba42b1a2c50591c4125a79e1d968228bc", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/a208fb0ba42b1a2c50591c4125a79e1d968228bc", "committedDate": "2020-04-17T00:08:04Z", "message": "Adding test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "71584a969002ec82407e0119c9dd39e3751b5fb3", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/71584a969002ec82407e0119c9dd39e3751b5fb3", "committedDate": "2020-04-17T00:03:35Z", "message": "Adding test"}, "afterCommit": {"oid": "a208fb0ba42b1a2c50591c4125a79e1d968228bc", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/a208fb0ba42b1a2c50591c4125a79e1d968228bc", "committedDate": "2020-04-17T00:08:04Z", "message": "Adding test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1171, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}