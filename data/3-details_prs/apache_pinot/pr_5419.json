{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIwNTQ1ODMw", "number": 5419, "title": "Use thread local for groupby raw key holders", "bodyText": "", "createdAt": "2020-05-20T06:54:07Z", "url": "https://github.com/apache/pinot/pull/5419", "merged": true, "mergeCommit": {"oid": "a3ebd0c5981d692185d7c79a2ff1e8d682b5f069"}, "closed": true, "closedAt": "2020-05-21T03:50:58Z", "author": {"login": "xiangfu0"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjD5tjgBqjMzNTUwNzQ0OTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjUdwVABqjMzNTkwMjYyMTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0b2fd80c7ee13268b229fe4269d2e2df827c3675", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/0b2fd80c7ee13268b229fe4269d2e2df827c3675", "committedDate": "2020-05-20T06:41:39Z", "message": "Use thread local for groupby raw key holders"}, "afterCommit": {"oid": "d0c29a000fd05e6256930b5786167b60d25b7951", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/d0c29a000fd05e6256930b5786167b60d25b7951", "committedDate": "2020-05-20T07:26:02Z", "message": "Use thread local for groupby raw key holders"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d0c29a000fd05e6256930b5786167b60d25b7951", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/d0c29a000fd05e6256930b5786167b60d25b7951", "committedDate": "2020-05-20T07:26:02Z", "message": "Use thread local for groupby raw key holders"}, "afterCommit": {"oid": "646b149b1f19802f30b2e23b43f205aabe73c9b0", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/646b149b1f19802f30b2e23b43f205aabe73c9b0", "committedDate": "2020-05-20T10:27:57Z", "message": "Use thread local for groupby raw key holders"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "646b149b1f19802f30b2e23b43f205aabe73c9b0", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/646b149b1f19802f30b2e23b43f205aabe73c9b0", "committedDate": "2020-05-20T10:27:57Z", "message": "Use thread local for groupby raw key holders"}, "afterCommit": {"oid": "1655c27c50df07bfab6863386150be8eccd0ac50", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/1655c27c50df07bfab6863386150be8eccd0ac50", "committedDate": "2020-05-20T10:32:05Z", "message": "Use thread local for groupby raw key holders"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NTYzMDM2", "url": "https://github.com/apache/pinot/pull/5419#pullrequestreview-415563036", "createdAt": "2020-05-20T17:32:23Z", "commit": {"oid": "1655c27c50df07bfab6863386150be8eccd0ac50"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNzozMjoyM1rOGYWgLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNzozMjoyM1rOGYWgLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE4NzY5Mg==", "bodyText": "Use computeIfAbsent() to save one extra map lookup.\nAlso, because you already know the type of key holders, maybe add a separate class to store different type of holders without map lookup?", "url": "https://github.com/apache/pinot/pull/5419#discussion_r428187692", "createdAt": "2020-05-20T17:32:23Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/groupby/DictionaryBasedGroupKeyGenerator.java", "diffHunk": "@@ -106,18 +108,26 @@ public DictionaryBasedGroupKeyGenerator(TransformOperator transformOperator,\n \n       _isSingleValueColumn[i] = transformOperator.getResultMetadata(groupByExpression).isSingleValue();\n     }\n-\n     if (longOverflow) {\n       _globalGroupIdUpperBound = numGroupsLimit;\n-      _rawKeyHolder = new ArrayMapBasedHolder(_globalGroupIdUpperBound);\n+      if (!mapBasedRawKeyHolders.containsKey(ArrayMapBasedHolder.class.getName())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1655c27c50df07bfab6863386150be8eccd0ac50"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NjAxMjYw", "url": "https://github.com/apache/pinot/pull/5419#pullrequestreview-415601260", "createdAt": "2020-05-20T18:24:25Z", "commit": {"oid": "1655c27c50df07bfab6863386150be8eccd0ac50"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxODoyNDoyNVrOGYYXLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxODoyNDoyNVrOGYYXLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIxODE1OQ==", "bodyText": "I think initializing to _globalGroupIdUpperBound got introduced in #5291. For many cases with multiple group by columns (high cardinality and/or MV columns) this number can be huge. Unclear to me if making this thread-local will protect against such cases that may require allocating huge chunk of memory upfornt.", "url": "https://github.com/apache/pinot/pull/5419#discussion_r428218159", "createdAt": "2020-05-20T18:24:25Z", "author": {"login": "mayankshriv"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/groupby/DictionaryBasedGroupKeyGenerator.java", "diffHunk": "@@ -106,18 +108,26 @@ public DictionaryBasedGroupKeyGenerator(TransformOperator transformOperator,\n \n       _isSingleValueColumn[i] = transformOperator.getResultMetadata(groupByExpression).isSingleValue();\n     }\n-\n     if (longOverflow) {\n       _globalGroupIdUpperBound = numGroupsLimit;\n-      _rawKeyHolder = new ArrayMapBasedHolder(_globalGroupIdUpperBound);\n+      if (!mapBasedRawKeyHolders.containsKey(ArrayMapBasedHolder.class.getName())) {\n+        mapBasedRawKeyHolders.put(ArrayMapBasedHolder.class.getName(), new ArrayMapBasedHolder(_globalGroupIdUpperBound).getInternal());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1655c27c50df07bfab6863386150be8eccd0ac50"}, "originalPosition": 27}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3b96ab5e7ed8146d78b4cc689d360d1c1b78f18b", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/3b96ab5e7ed8146d78b4cc689d360d1c1b78f18b", "committedDate": "2020-05-20T18:25:40Z", "message": "Adding a threshold to not reuse threadlocal for small groups"}, "afterCommit": {"oid": "3698af0b749d6bee98f33ea6d5584633dbb23dac", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/3698af0b749d6bee98f33ea6d5584633dbb23dac", "committedDate": "2020-05-20T22:06:54Z", "message": "Adding more optimization for map initial size and discard size"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1ODI3MjAw", "url": "https://github.com/apache/pinot/pull/5419#pullrequestreview-415827200", "createdAt": "2020-05-21T01:50:20Z", "commit": {"oid": "3698af0b749d6bee98f33ea6d5584633dbb23dac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02ccddd9675d2ef05b0946c841260d8d75996f94", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/02ccddd9675d2ef05b0946c841260d8d75996f94", "committedDate": "2020-05-21T02:42:40Z", "message": "Use thread local for groupby raw key holders"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9584e4c5886e15cc1f99f46dfd03515aa7dc8a94", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/9584e4c5886e15cc1f99f46dfd03515aa7dc8a94", "committedDate": "2020-05-21T02:43:04Z", "message": "Adding more optimization for map initial size and discard size"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3698af0b749d6bee98f33ea6d5584633dbb23dac", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/3698af0b749d6bee98f33ea6d5584633dbb23dac", "committedDate": "2020-05-20T22:06:54Z", "message": "Adding more optimization for map initial size and discard size"}, "afterCommit": {"oid": "9584e4c5886e15cc1f99f46dfd03515aa7dc8a94", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/9584e4c5886e15cc1f99f46dfd03515aa7dc8a94", "committedDate": "2020-05-21T02:43:04Z", "message": "Adding more optimization for map initial size and discard size"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 813, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}