{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5MTc2MDY5", "number": 5705, "title": "Add error message to broker response in case of broker send error", "bodyText": "On Pinot Broker, the incoming request gets written into socket channels of the target Servers. This happens on QueryRouter.submitQuery(...) function. If any exception occurs during  submitQuery for any reason like connection refused to one of the servers, sending requests to the remaining servers are abandoned and the partial responses from already successful sent requests are returned in BrokerResponse with no indication of the exception.\nAlthough partial response is acceptable, there should be an indication of such problem in broker response to make life easier for ppl debugging this issue. Recently there was an incident where, for a specific use case, broker response was empty (no partial response) and there was no exception returned, while data was available on Pinot Servers. After good amount of time going through logs, this issue was discovered with exception being connection refused by only one faulty server.\nThis PR adds the exception to BrokerReponse for easier debugging.", "createdAt": "2020-07-15T00:21:30Z", "url": "https://github.com/apache/pinot/pull/5705", "merged": true, "mergeCommit": {"oid": "897c96cf45d46ed664883a7c54790454266916f1"}, "closed": true, "closedAt": "2020-07-21T05:34:01Z", "author": {"login": "sajjad-moradi"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0-r1MAH2gAyNDQ5MTc2MDY5OjA1NGQ2NTI0NWNiY2MyZDMwNGUwNjJkMTQ1YTdjYTg0NDIxOGQxMTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1lM17gH2gAyNDQ5MTc2MDY5Ojc1NThlYmQyODVjMzQ1YjNmNWJhOGMzOWFlM2FjMTY5Y2UwYzJmODc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "054d65245cbcc2d304e062d145a7ca844218d114", "author": {"user": {"login": "sajjad-moradi", "name": "Sajjad Moradi"}}, "url": "https://github.com/apache/pinot/commit/054d65245cbcc2d304e062d145a7ca844218d114", "committedDate": "2020-07-14T23:32:08Z", "message": "Add error message to broker response in case of broker send error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NTU3MDc1", "url": "https://github.com/apache/pinot/pull/5705#pullrequestreview-448557075", "createdAt": "2020-07-15T00:46:11Z", "commit": {"oid": "054d65245cbcc2d304e062d145a7ca844218d114"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MTk5ODY0", "url": "https://github.com/apache/pinot/pull/5705#pullrequestreview-449199864", "createdAt": "2020-07-15T17:57:25Z", "commit": {"oid": "054d65245cbcc2d304e062d145a7ca844218d114"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNzo1NzoyNVrOGyJekQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNzo1NzoyNVrOGyJekQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIzNzI2NQ==", "bodyText": "Avoid static import.", "url": "https://github.com/apache/pinot/pull/5705#discussion_r455237265", "createdAt": "2020-07-15T17:57:25Z", "author": {"login": "mayankshriv"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/SingleConnectionBrokerRequestHandler.java", "diffHunk": "@@ -47,6 +49,8 @@\n import org.apache.pinot.spi.env.PinotConfiguration;\n import org.apache.pinot.spi.utils.builder.TableNameBuilder;\n \n+import static org.apache.pinot.common.exception.QueryException.BROKER_REQUEST_SEND_ERROR_CODE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "054d65245cbcc2d304e062d145a7ca844218d114"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5Mzk2MjQy", "url": "https://github.com/apache/pinot/pull/5705#pullrequestreview-449396242", "createdAt": "2020-07-15T22:51:12Z", "commit": {"oid": "054d65245cbcc2d304e062d145a7ca844218d114"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjo1MToxMlrOGyT_4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjo1NToyN1rOGyUFhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQwOTYzMw==", "bodyText": "(nit) Package private?", "url": "https://github.com/apache/pinot/pull/5705#discussion_r455409633", "createdAt": "2020-07-15T22:51:12Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/transport/AsyncQueryResponse.java", "diffHunk": "@@ -105,4 +107,12 @@ void markServerDown(ServerRoutingInstance serverRoutingInstance) {\n       markQueryFailed();\n     }\n   }\n+\n+  public Exception getBrokerRequestSendException() {\n+    return _brokerRequestSendException;\n+  }\n+\n+  public void setBrokerRequestSendException(Exception brokerRequestSendException) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "054d65245cbcc2d304e062d145a7ca844218d114"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxMDAzOQ==", "bodyText": "Make it volatile? (Although it is always set and read by the same thread)", "url": "https://github.com/apache/pinot/pull/5705#discussion_r455410039", "createdAt": "2020-07-15T22:52:16Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/transport/AsyncQueryResponse.java", "diffHunk": "@@ -39,6 +39,8 @@\n   private final CountDownLatch _countDownLatch;\n   private final long _maxEndTimeMs;\n \n+  private Exception _brokerRequestSendException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "054d65245cbcc2d304e062d145a7ca844218d114"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxMDcyNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (asyncQueryResponse.getBrokerRequestSendException() != null) {\n          \n          \n            \n                  String errorMsg = QueryException.getTruncatedStackTrace(asyncQueryResponse.getBrokerRequestSendException());\n          \n          \n            \n                  brokerResponse.addToExceptions(new QueryProcessingException(BROKER_REQUEST_SEND_ERROR_CODE, errorMsg));\n          \n          \n            \n                }\n          \n          \n            \n                Exception brokerRequestSendException = asyncQueryResponse.getBrokerRequestSendException();\n          \n          \n            \n                if (brokerRequestSendException != null) {\n          \n          \n            \n                  brokerResponse.addToExceptions(new QueryProcessingException(BROKER_REQUEST_SEND_ERROR_CODE, brokerRequestSendException));\n          \n          \n            \n                }", "url": "https://github.com/apache/pinot/pull/5705#discussion_r455410724", "createdAt": "2020-07-15T22:54:26Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/SingleConnectionBrokerRequestHandler.java", "diffHunk": "@@ -114,6 +118,10 @@ protected BrokerResponse processBrokerRequest(long requestId, BrokerRequest orig\n     brokerResponse.setNumServersQueried(numServersQueried);\n     brokerResponse.setNumServersResponded(numServersResponded);\n \n+    if (asyncQueryResponse.getBrokerRequestSendException() != null) {\n+      String errorMsg = QueryException.getTruncatedStackTrace(asyncQueryResponse.getBrokerRequestSendException());\n+      brokerResponse.addToExceptions(new QueryProcessingException(BROKER_REQUEST_SEND_ERROR_CODE, errorMsg));\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "054d65245cbcc2d304e062d145a7ca844218d114"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxMTA3Nw==", "bodyText": "Not sure if we should expose this method", "url": "https://github.com/apache/pinot/pull/5705#discussion_r455411077", "createdAt": "2020-07-15T22:55:27Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/exception/QueryException.java", "diffHunk": "@@ -125,8 +126,17 @@ public static void setMaxLinesOfStackTrace(int maxLinesOfStackTrace) {\n   }\n \n   public static ProcessingException getException(ProcessingException processingException, Exception exception) {\n+    return getException(processingException, getTruncatedStackTrace(exception));\n+  }\n+\n+  public static ProcessingException getException(ProcessingException processingException, String errorMessage) {\n     String errorType = processingException.getMessage();\n     ProcessingException copiedProcessingException = processingException.deepCopy();\n+    copiedProcessingException.setMessage(errorType + \":\\n\" + errorMessage);\n+    return copiedProcessingException;\n+  }\n+\n+  public static String getTruncatedStackTrace(Exception exception) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "054d65245cbcc2d304e062d145a7ca844218d114"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7558ebd285c345b3f5ba8c39ae3ac169ce0c2f87", "author": {"user": {"login": "sajjad-moradi", "name": "Sajjad Moradi"}}, "url": "https://github.com/apache/pinot/commit/7558ebd285c345b3f5ba8c39ae3ac169ce0c2f87", "committedDate": "2020-07-16T20:24:35Z", "message": "Apply PR's suggestions"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 337, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}