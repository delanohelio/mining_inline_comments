{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyOTEwMjI3", "number": 4984, "title": "[TE] Fix over-scheduling tasks in data availability scheduler", "bodyText": "This PR is to fix the issue when detection jobs doesn't move the watermark forward and the data availability keeps scheduling detection tasks for the same detection. To solve it, we add scheduling window logic in which the scheduler only schedule new detection tasks. If the watermark does not move forward for any reason after the detection job runs, the scheduler will try scheduling it a few times and stop due to being out of the scheduling window.", "createdAt": "2020-01-15T01:08:46Z", "url": "https://github.com/apache/pinot/pull/4984", "merged": true, "mergeCommit": {"oid": "7ff9dd4a1c4fdf2bc9815735bacc47b49fc54a37"}, "closed": true, "closedAt": "2020-01-17T01:07:44Z", "author": {"login": "vincentchenjl"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6awWogH2gAyMzYyOTEwMjI3OmQ4ZWFkYTU3MDYxYzFlMmNkMzIzNjlkYmIzODAwNTg2ZWUxNmYxYWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6u6qtgH2gAyMzYyOTEwMjI3OjMwODg1ODJhZDE1MThlMTc4ZmZiOTZkZDMzYjE2MTNhNDA0ZjVhOTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d8eada57061c1e2cd32369dbb3800586ee16f1ae", "author": {"user": {"login": "vincentchenjl", "name": "Vincent Chen"}}, "url": "https://github.com/apache/pinot/commit/d8eada57061c1e2cd32369dbb3800586ee16f1ae", "committedDate": "2020-01-15T00:52:53Z", "message": "[TE] Fix over-scheduling tasks in data availability scheduler"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyOTU0MjA4", "url": "https://github.com/apache/pinot/pull/4984#pullrequestreview-342954208", "createdAt": "2020-01-15T02:13:53Z", "commit": {"oid": "d8eada57061c1e2cd32369dbb3800586ee16f1ae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwMjoxNDowMVrOFdrlBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwMjoxNDowMVrOFdrlBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY2NzAxMw==", "bodyText": "Using Pair<Long, Long> for <last refresh time, last refresh event time> may make the code a little hard to read without context. Would it be better to create a class for this instead?", "url": "https://github.com/apache/pinot/pull/4984#discussion_r366667013", "createdAt": "2020-01-15T02:14:01Z", "author": {"login": "bxji"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskScheduler.java", "diffHunk": "@@ -80,7 +85,7 @@ public DataAvailabilityTaskScheduler(long delayInSec, long fallBackTimeInSec) {\n   @Override\n   public void run() {\n     Map<DetectionConfigDTO, Set<String>> detection2DatasetMap = new HashMap<>();\n-    Map<String, Long> dataset2RefreshTimeMap = new HashMap<>();\n+    Map<String, Pair<Long, Long>> dataset2RefreshTimeMap = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8eada57061c1e2cd32369dbb3800586ee16f1ae"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzMzg5NTM4", "url": "https://github.com/apache/pinot/pull/4984#pullrequestreview-343389538", "createdAt": "2020-01-15T17:23:06Z", "commit": {"oid": "d8eada57061c1e2cd32369dbb3800586ee16f1ae"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNzoyMzowNlrOFeAN6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNzoyNDo1OVrOFeARwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAwNTE2Mg==", "bodyText": ".max() should work", "url": "https://github.com/apache/pinot/pull/4984#discussion_r367005162", "createdAt": "2020-01-15T17:23:06Z", "author": {"login": "xiaohui-sun"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskScheduler.java", "diffHunk": "@@ -214,4 +224,11 @@ private boolean needFallback(DetectionConfigDTO detectionConfig) throws Exceptio\n     long lastRunTime = taskLastCreateTimeMap.get(detectionConfigId);\n     return (System.currentTimeMillis() - lastRunTime >= notRunThreshold);\n   }\n+\n+  private boolean isWithinSchedulingWindow(Set<String> datasets, Map<String, Pair<Long, Long>> dataset2RefreshTimeMap) {\n+    long maxEventTime = datasets.stream()\n+        .map(dataset -> dataset2RefreshTimeMap.get(dataset).getRight())\n+        .reduce((v1, v2) -> (v1 > v2) ? v1 : v2).orElse(0L);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8eada57061c1e2cd32369dbb3800586ee16f1ae"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAwNTI0OQ==", "bodyText": "Add some comments", "url": "https://github.com/apache/pinot/pull/4984#discussion_r367005249", "createdAt": "2020-01-15T17:23:16Z", "author": {"login": "xiaohui-sun"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskScheduler.java", "diffHunk": "@@ -214,4 +224,11 @@ private boolean needFallback(DetectionConfigDTO detectionConfig) throws Exceptio\n     long lastRunTime = taskLastCreateTimeMap.get(detectionConfigId);\n     return (System.currentTimeMillis() - lastRunTime >= notRunThreshold);\n   }\n+\n+  private boolean isWithinSchedulingWindow(Set<String> datasets, Map<String, Pair<Long, Long>> dataset2RefreshTimeMap) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8eada57061c1e2cd32369dbb3800586ee16f1ae"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAwNTY5NQ==", "bodyText": "More concrete comments please.\nAdd the motivation for this field.", "url": "https://github.com/apache/pinot/pull/4984#discussion_r367005695", "createdAt": "2020-01-15T17:24:03Z", "author": {"login": "xiaohui-sun"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/utils/DataAvailabilitySchedulingConfiguration.java", "diffHunk": "@@ -37,9 +37,11 @@\n   private List<String> dataSourceWhitelist;\n   private List<String> filterClassList;\n   // delay time after each run for the scheduler to reduce DB polling\n-  private long schedulerDelayInSec = 300; // 5 minute\n+  private long schedulerDelayInSec = 300; // 5 minutes\n   // default threshold if detection level threshold is not set\n   private long taskTriggerFallBackTimeInSec = 24 * 60 * 60; // 1 day\n+  // scheduling window for data availability scheduling", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8eada57061c1e2cd32369dbb3800586ee16f1ae"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAwNjE0NA==", "bodyText": "Why two TEST_TIME. Normally the two times should be different.", "url": "https://github.com/apache/pinot/pull/4984#discussion_r367006144", "createdAt": "2020-01-15T17:24:59Z", "author": {"login": "xiaohui-sun"}, "path": "thirdeye/thirdeye-pinot/src/test/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskSchedulerTest.java", "diffHunk": "@@ -110,8 +110,8 @@ public void testCreateMultipleTasks() {\n     long detection2 = createDetection(2, metrics1, oneDayAgo, 0);\n     List<Long> singleMetric = Collections.singletonList(metricId2);\n     long detection3 = createDetection(3, singleMetric, oneDayAgo, 0);\n-    createDataset(1, TEST_TIME);\n-    createDataset(2, TEST_TIME);\n+    createDataset(1, TEST_TIME, TEST_TIME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8eada57061c1e2cd32369dbb3800586ee16f1ae"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNDMzMTM1", "url": "https://github.com/apache/pinot/pull/4984#pullrequestreview-343433135", "createdAt": "2020-01-15T18:35:03Z", "commit": {"oid": "d8eada57061c1e2cd32369dbb3800586ee16f1ae"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxODozNTowM1rOFeCT9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxODozNTo1MFrOFeCVXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzOTQ3OA==", "bodyText": "Maybe it's better to use TimeUnit.MINUTES.toSeconds(15) than calculating seconds by multiplication.", "url": "https://github.com/apache/pinot/pull/4984#discussion_r367039478", "createdAt": "2020-01-15T18:35:03Z", "author": {"login": "jihaozh"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/utils/DataAvailabilitySchedulingConfiguration.java", "diffHunk": "@@ -37,9 +37,11 @@\n   private List<String> dataSourceWhitelist;\n   private List<String> filterClassList;\n   // delay time after each run for the scheduler to reduce DB polling\n-  private long schedulerDelayInSec = 300; // 5 minute\n+  private long schedulerDelayInSec = 300; // 5 minutes\n   // default threshold if detection level threshold is not set\n   private long taskTriggerFallBackTimeInSec = 24 * 60 * 60; // 1 day\n+  // scheduling window for data availability scheduling\n+  private long schedulingWindowInSec = 15 * 60; // 15 minutes", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8eada57061c1e2cd32369dbb3800586ee16f1ae"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzOTgzNg==", "bodyText": "Same as above, how about using TimeUnit class to convert to seconds?", "url": "https://github.com/apache/pinot/pull/4984#discussion_r367039836", "createdAt": "2020-01-15T18:35:50Z", "author": {"login": "jihaozh"}, "path": "thirdeye/thirdeye-pinot/src/test/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskSchedulerTest.java", "diffHunk": "@@ -79,7 +79,7 @@ public void beforeMethod() {\n     metric1.setDerived(false);\n     metric2.setAlias(\"\");\n     metricId2 = metricConfigManager.save(metric2);\n-    dataAvailabilityTaskScheduler = new DataAvailabilityTaskScheduler(60, 24 * 60 * 60);\n+    dataAvailabilityTaskScheduler = new DataAvailabilityTaskScheduler(60, 24 * 60 * 60, 15 * 60);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8eada57061c1e2cd32369dbb3800586ee16f1ae"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d9f14442b1d6845c04f2c47d54ff71fdc54e4fd", "author": {"user": {"login": "vincentchenjl", "name": "Vincent Chen"}}, "url": "https://github.com/apache/pinot/commit/5d9f14442b1d6845c04f2c47d54ff71fdc54e4fd", "committedDate": "2020-01-15T19:55:21Z", "message": "minor change to address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNTI2NTY0", "url": "https://github.com/apache/pinot/pull/4984#pullrequestreview-343526564", "createdAt": "2020-01-15T21:16:33Z", "commit": {"oid": "5d9f14442b1d6845c04f2c47d54ff71fdc54e4fd"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQyMToxNjozM1rOFeGr7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQyMToyNzo1M1rOFeG_Ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzExMTE1MA==", "bodyText": "Add comments.", "url": "https://github.com/apache/pinot/pull/4984#discussion_r367111150", "createdAt": "2020-01-15T21:16:33Z", "author": {"login": "xiaohui-sun"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskScheduler.java", "diffHunk": "@@ -58,18 +59,29 @@\n   private ScheduledExecutorService executorService;\n   private long delayInSec;\n   private long fallBackTimeInSec;\n+  private long schedulingWindowInSec;\n   private Map<Long, Long> taskLastCreateTimeMap;\n   private TaskManager taskDAO;\n   private DetectionConfigManager detectionConfigDAO;\n   private DatasetConfigManager datasetConfigDAO;\n+\n+  private class DatasetUpdateStatus {\n+    long lastDataTs;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d9f14442b1d6845c04f2c47d54ff71fdc54e4fd"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzExMjY5OA==", "bodyText": "Should we log it? Will it creates lots of logs?", "url": "https://github.com/apache/pinot/pull/4984#discussion_r367112698", "createdAt": "2020-01-15T21:19:52Z", "author": {"login": "xiaohui-sun"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskScheduler.java", "diffHunk": "@@ -89,12 +101,16 @@ public void run() {\n         long detectionConfigId = detectionConfig.getId();\n         if (!runningDetection.containsKey(detectionConfigId)) {\n           if (isAllDatasetUpdated(detectionConfig, detection2DatasetMap.get(detectionConfig), dataset2RefreshTimeMap)) {\n-            //TODO: additional check is required if detection is based on aggregated value across multiple data points\n-            createDetectionTask(detectionConfig);\n-            ThirdeyeMetricsUtil.eventScheduledTaskCounter.inc();\n-            taskCount++;\n+            if (isWithinSchedulingWindow(detection2DatasetMap.get(detectionConfig), dataset2RefreshTimeMap)) {\n+              //TODO: additional check is required if detection is based on aggregated value across multiple data points\n+              createDetectionTask(detectionConfig);\n+              ThirdeyeMetricsUtil.eventScheduledTaskCounter.inc();\n+              taskCount++;\n+            } else {\n+              LOG.warn(\"Unable to schedule a task for {}, because it is out of scheduling window.\", detectionConfigId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d9f14442b1d6845c04f2c47d54ff71fdc54e4fd"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzExNjExNA==", "bodyText": "I have a feeling we are creating too many customized objects. Can we just reuse the DatasetConfigDTO and get rid of DatasetUpdateStatus? The DatasetConfigDTO should contain everything you need.", "url": "https://github.com/apache/pinot/pull/4984#discussion_r367116114", "createdAt": "2020-01-15T21:27:53Z", "author": {"login": "xiaohui-sun"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/detection/trigger/DataAvailabilityTaskScheduler.java", "diffHunk": "@@ -119,7 +135,8 @@ public void close() {\n   }\n \n   private void populateDetectionMapAndDataset2RefreshTimeMap(\n-      Map<DetectionConfigDTO, Set<String>> dataset2DetectionMap, Map<String, Long> dataset2RefreshTimeMap) {\n+      Map<DetectionConfigDTO, Set<String>> dataset2DetectionMap,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d9f14442b1d6845c04f2c47d54ff71fdc54e4fd"}, "originalPosition": 75}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3088582ad1518e178ffb96dd33b1613a404f5a97", "author": {"user": {"login": "vincentchenjl", "name": "Vincent Chen"}}, "url": "https://github.com/apache/pinot/commit/3088582ad1518e178ffb96dd33b1613a404f5a97", "committedDate": "2020-01-16T00:22:15Z", "message": "minor change"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1467, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}