{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1MDc3OTQx", "number": 5728, "title": "Add segment lineage based segment selector", "bodyText": "Segment lineage based segment selector looks at the\nsegment lineage metadata and correctly prunes the segments\nto make sure that we do not process the duplicate data.", "createdAt": "2020-07-22T12:09:35Z", "url": "https://github.com/apache/pinot/pull/5728", "merged": true, "mergeCommit": {"oid": "2c0b999b279e17d5cce1e8065b277d78d2c8581e"}, "closed": true, "closedAt": "2020-07-31T04:02:05Z", "author": {"login": "snleee"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3bMGNABqjM1NzU4ODM0ODc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc6LR5yABqjM2MDY2NDQ2ODM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8a45a25eee1401d7c4cdc6e12dc42ce5c32593c3", "author": {"user": {"login": "snleee", "name": "Seunghyun Lee"}}, "url": "https://github.com/apache/pinot/commit/8a45a25eee1401d7c4cdc6e12dc42ce5c32593c3", "committedDate": "2020-07-22T12:04:56Z", "message": "Add segment lineage based segment selector\n\nSegment lineage based segment selector looks at the\nsegment lineage metadata and correctly prunes the segments\nto make sure that we do not process the duplicate data."}, "afterCommit": {"oid": "43f6837ea7d3d4d0068c23ca6a8fa9274557bd02", "author": {"user": {"login": "snleee", "name": "Seunghyun Lee"}}, "url": "https://github.com/apache/pinot/commit/43f6837ea7d3d4d0068c23ca6a8fa9274557bd02", "committedDate": "2020-07-22T13:52:21Z", "message": "Add segment lineage based segment selector\n\nSegment lineage based segment selector looks at the\nsegment lineage metadata and correctly prunes the segments\nto make sure that we do not process the duplicate data."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "43f6837ea7d3d4d0068c23ca6a8fa9274557bd02", "author": {"user": {"login": "snleee", "name": "Seunghyun Lee"}}, "url": "https://github.com/apache/pinot/commit/43f6837ea7d3d4d0068c23ca6a8fa9274557bd02", "committedDate": "2020-07-22T13:52:21Z", "message": "Add segment lineage based segment selector\n\nSegment lineage based segment selector looks at the\nsegment lineage metadata and correctly prunes the segments\nto make sure that we do not process the duplicate data."}, "afterCommit": {"oid": "3a2938be4586a898b096e300cc60626e0ffd1ffa", "author": {"user": {"login": "snleee", "name": "Seunghyun Lee"}}, "url": "https://github.com/apache/pinot/commit/3a2938be4586a898b096e300cc60626e0ffd1ffa", "committedDate": "2020-07-22T14:07:52Z", "message": "Add segment lineage based segment selector\n\nSegment lineage based segment selector looks at the\nsegment lineage metadata and correctly prunes the segments\nto make sure that we do not process the duplicate data."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNjIyMzY1", "url": "https://github.com/apache/pinot/pull/5728#pullrequestreview-453622365", "createdAt": "2020-07-22T19:32:14Z", "commit": {"oid": "3a2938be4586a898b096e300cc60626e0ffd1ffa"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOTozMjoxNFrOG1xL6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOTo1Mjo0NlrOG1x2zA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzMzU3OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private SegmentLineageBasedSegmentSelector _segmentLineageBasedSegmentSelector;\n          \n          \n            \n              private final SegmentLineageBasedSegmentSelector _segmentLineageBasedSegmentSelector;", "url": "https://github.com/apache/pinot/pull/5728#discussion_r459033578", "createdAt": "2020-07-22T19:32:14Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/segmentselector/OfflineSegmentSelector.java", "diffHunk": "@@ -30,10 +31,17 @@\n  * Segment selector for offline table.\n  */\n public class OfflineSegmentSelector implements SegmentSelector {\n+  private SegmentLineageBasedSegmentSelector _segmentLineageBasedSegmentSelector;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a2938be4586a898b096e300cc60626e0ffd1ffa"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA0NDA2Mg==", "bodyText": "Don't implement SegmentSelector because it is not actually a segment selector, but a component inside the segment selector.\nYou may re-design the methods for this class to make it easier to use, e.g. public Set<String> refreshLinage(Set<String> onlineSegments); which returns the candidate segments based on the linage", "url": "https://github.com/apache/pinot/pull/5728#discussion_r459044062", "createdAt": "2020-07-22T19:51:53Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/segmentselector/SegmentLineageBasedSegmentSelector.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.routing.segmentselector;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.model.ExternalView;\n+import org.apache.helix.store.zk.ZkHelixPropertyStore;\n+import org.apache.pinot.common.lineage.LineageEntry;\n+import org.apache.pinot.common.lineage.LineageEntryState;\n+import org.apache.pinot.common.lineage.SegmentLineage;\n+import org.apache.pinot.common.lineage.SegmentLineageAccessHelper;\n+import org.apache.pinot.common.request.BrokerRequest;\n+\n+\n+public class SegmentLineageBasedSegmentSelector implements SegmentSelector {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a2938be4586a898b096e300cc60626e0ffd1ffa"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA0NDU1Ng==", "bodyText": "Table name in table config always have the suffix\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                String tableNameWithType =\n          \n          \n            \n                    TableNameBuilder.forType(tableConfig.getTableType()).tableNameWithType(tableConfig.getTableName());\n          \n          \n            \n                String tableNameWithType = tableConfig.getTableName();", "url": "https://github.com/apache/pinot/pull/5728#discussion_r459044556", "createdAt": "2020-07-22T19:52:46Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/segmentselector/SegmentSelectorFactory.java", "diffHunk": "@@ -17,19 +17,25 @@\n  * under the License.\n  */\n package org.apache.pinot.broker.routing.segmentselector;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.store.zk.ZkHelixPropertyStore;\n import org.apache.pinot.spi.config.table.TableConfig;\n import org.apache.pinot.spi.config.table.TableType;\n+import org.apache.pinot.spi.utils.builder.TableNameBuilder;\n \n \n public class SegmentSelectorFactory {\n   private SegmentSelectorFactory() {\n   }\n \n-  public static SegmentSelector getSegmentSelector(TableConfig tableConfig) {\n+  public static SegmentSelector getSegmentSelector(TableConfig tableConfig,\n+      ZkHelixPropertyStore<ZNRecord> propertyStore) {\n+    String tableNameWithType =\n+        TableNameBuilder.forType(tableConfig.getTableType()).tableNameWithType(tableConfig.getTableName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a2938be4586a898b096e300cc60626e0ffd1ffa"}, "originalPosition": 19}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3a2938be4586a898b096e300cc60626e0ffd1ffa", "author": {"user": {"login": "snleee", "name": "Seunghyun Lee"}}, "url": "https://github.com/apache/pinot/commit/3a2938be4586a898b096e300cc60626e0ffd1ffa", "committedDate": "2020-07-22T14:07:52Z", "message": "Add segment lineage based segment selector\n\nSegment lineage based segment selector looks at the\nsegment lineage metadata and correctly prunes the segments\nto make sure that we do not process the duplicate data."}, "afterCommit": {"oid": "c00ffbdbd998ba3a271684517a8317933971645d", "author": {"user": {"login": "snleee", "name": "Seunghyun Lee"}}, "url": "https://github.com/apache/pinot/commit/c00ffbdbd998ba3a271684517a8317933971645d", "committedDate": "2020-07-24T04:38:11Z", "message": "Add segment lineage based segment selector\n\nSegment lineage based segment selector looks at the\nsegment lineage metadata and correctly prunes the segments\nto make sure that we do not process the duplicate data."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0c35445fff3432b5bf76ef2cba4e015bdf05162", "author": {"user": {"login": "snleee", "name": "Seunghyun Lee"}}, "url": "https://github.com/apache/pinot/commit/d0c35445fff3432b5bf76ef2cba4e015bdf05162", "committedDate": "2020-07-24T05:02:13Z", "message": "Add segment lineage based segment selector\n\nSegment lineage based segment selector looks at the\nsegment lineage metadata and correctly prunes the segments\nto make sure that we do not process the duplicate data."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c00ffbdbd998ba3a271684517a8317933971645d", "author": {"user": {"login": "snleee", "name": "Seunghyun Lee"}}, "url": "https://github.com/apache/pinot/commit/c00ffbdbd998ba3a271684517a8317933971645d", "committedDate": "2020-07-24T04:38:11Z", "message": "Add segment lineage based segment selector\n\nSegment lineage based segment selector looks at the\nsegment lineage metadata and correctly prunes the segments\nto make sure that we do not process the duplicate data."}, "afterCommit": {"oid": "d0c35445fff3432b5bf76ef2cba4e015bdf05162", "author": {"user": {"login": "snleee", "name": "Seunghyun Lee"}}, "url": "https://github.com/apache/pinot/commit/d0c35445fff3432b5bf76ef2cba4e015bdf05162", "committedDate": "2020-07-24T05:02:13Z", "message": "Add segment lineage based segment selector\n\nSegment lineage based segment selector looks at the\nsegment lineage metadata and correctly prunes the segments\nto make sure that we do not process the duplicate data."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1Mjg3MTY1", "url": "https://github.com/apache/pinot/pull/5728#pullrequestreview-455287165", "createdAt": "2020-07-25T14:07:10Z", "commit": {"oid": "d0c35445fff3432b5bf76ef2cba4e015bdf05162"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNVQxNDowNzoxMFrOG3FGCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNVQxNDoxMjo0MFrOG3FHsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQwODMyOQ==", "bodyText": "This seems a bit confusing:\n\nOne segment selector class contains another segment segment selector.\nEven though both are named SegmentSelector, only one of them implements the SegmentSelector interface.\n\nI think SegmentLineageBasedSegmentSelector needs to be renamed, since it is not really implementing the interface.", "url": "https://github.com/apache/pinot/pull/5728#discussion_r460408329", "createdAt": "2020-07-25T14:07:10Z", "author": {"login": "mayankshriv"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/segmentselector/OfflineSegmentSelector.java", "diffHunk": "@@ -30,10 +30,17 @@\n  * Segment selector for offline table.\n  */\n public class OfflineSegmentSelector implements SegmentSelector {\n+  private final SegmentLineageBasedSegmentSelector _segmentLineageBasedSegmentSelector;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0c35445fff3432b5bf76ef2cba4e015bdf05162"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQwODc1Mg==", "bodyText": "I am unclear on the extensibility of the code in future. Will we add more selectors and cascade them in future, for example versionBasedSelector/Pruner?", "url": "https://github.com/apache/pinot/pull/5728#discussion_r460408752", "createdAt": "2020-07-25T14:12:40Z", "author": {"login": "mayankshriv"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/segmentselector/OfflineSegmentSelector.java", "diffHunk": "@@ -42,7 +49,14 @@ public void onExternalViewChange(ExternalView externalView, Set<String> onlineSe\n     // TODO: for new added segments, before all replicas are up, consider not selecting them to avoid causing\n     //       hotspot servers\n \n-    _segments = Collections.unmodifiableList(new ArrayList<>(onlineSegments));\n+\n+    // Update segment lineage based segment selector\n+    _segmentLineageBasedSegmentSelector.onExternalViewChange();\n+\n+    // Compute the intersection of segments to process from both offline and segment lineage based segment selectors.\n+    List<String> segmentsToProcess =\n+        new ArrayList<>(_segmentLineageBasedSegmentSelector.computeSegmentsToProcess(onlineSegments));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0c35445fff3432b5bf76ef2cba4e015bdf05162"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MDA0NTE4", "url": "https://github.com/apache/pinot/pull/5728#pullrequestreview-456004518", "createdAt": "2020-07-27T17:49:48Z", "commit": {"oid": "d0c35445fff3432b5bf76ef2cba4e015bdf05162"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNzo0OTo0OFrOG3tICA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxODozMjoyNlrOG3umKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2NDIwMA==", "bodyText": "+1", "url": "https://github.com/apache/pinot/pull/5728#discussion_r461064200", "createdAt": "2020-07-27T17:49:48Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/segmentselector/OfflineSegmentSelector.java", "diffHunk": "@@ -30,10 +30,17 @@\n  * Segment selector for offline table.\n  */\n public class OfflineSegmentSelector implements SegmentSelector {\n+  private final SegmentLineageBasedSegmentSelector _segmentLineageBasedSegmentSelector;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQwODMyOQ=="}, "originalCommit": {"oid": "d0c35445fff3432b5bf76ef2cba4e015bdf05162"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA4MTcwMg==", "bodyText": "You don't need to follow the interface for SegmentSelector. This class can be simplified into one method computeSegmentsToProcess() which fetches the lineage and filters the online segments.", "url": "https://github.com/apache/pinot/pull/5728#discussion_r461081702", "createdAt": "2020-07-27T18:20:35Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/segmentselector/SegmentLineageBasedSegmentSelector.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.routing.segmentselector;\n+\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.Set;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.store.zk.ZkHelixPropertyStore;\n+import org.apache.pinot.common.lineage.LineageEntry;\n+import org.apache.pinot.common.lineage.LineageEntryState;\n+import org.apache.pinot.common.lineage.SegmentLineage;\n+import org.apache.pinot.common.lineage.SegmentLineageAccessHelper;\n+\n+\n+public class SegmentLineageBasedSegmentSelector {\n+  private final String _tableNameWithType;\n+  private final ZkHelixPropertyStore<ZNRecord> _propertyStore;\n+\n+  private volatile Set<String> _segmentsToRemove;\n+\n+  public SegmentLineageBasedSegmentSelector(String tableNameWithType, ZkHelixPropertyStore<ZNRecord> propertyStore) {\n+    _tableNameWithType = tableNameWithType;\n+    _propertyStore = propertyStore;\n+  }\n+\n+  public void init() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0c35445fff3432b5bf76ef2cba4e015bdf05162"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA4NzQxMg==", "bodyText": "(Not related to this PR) Before updating lineage to COMPLETED, we might need to check whether all the segments on the right side has turned ONLINE in external view, or we might end up querying partial data", "url": "https://github.com/apache/pinot/pull/5728#discussion_r461087412", "createdAt": "2020-07-27T18:30:46Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/segmentselector/SegmentLineageBasedSegmentSelector.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.routing.segmentselector;\n+\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.Set;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.store.zk.ZkHelixPropertyStore;\n+import org.apache.pinot.common.lineage.LineageEntry;\n+import org.apache.pinot.common.lineage.LineageEntryState;\n+import org.apache.pinot.common.lineage.SegmentLineage;\n+import org.apache.pinot.common.lineage.SegmentLineageAccessHelper;\n+\n+\n+public class SegmentLineageBasedSegmentSelector {\n+  private final String _tableNameWithType;\n+  private final ZkHelixPropertyStore<ZNRecord> _propertyStore;\n+\n+  private volatile Set<String> _segmentsToRemove;\n+\n+  public SegmentLineageBasedSegmentSelector(String tableNameWithType, ZkHelixPropertyStore<ZNRecord> propertyStore) {\n+    _tableNameWithType = tableNameWithType;\n+    _propertyStore = propertyStore;\n+  }\n+\n+  public void init() {\n+    onExternalViewChange();\n+  }\n+\n+  public void onExternalViewChange() {\n+    // Fetch segment lineage\n+    SegmentLineage segmentLineage = SegmentLineageAccessHelper.getSegmentLineage(_propertyStore, _tableNameWithType);\n+    Set<String> segmentsToRemove = new HashSet<>();\n+    if (segmentLineage != null) {\n+      for (String lineageEntryId : segmentLineage.getLineageEntryIds()) {\n+        LineageEntry lineageEntry = segmentLineage.getLineageEntry(lineageEntryId);\n+        if (lineageEntry.getState() == LineageEntryState.COMPLETED) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0c35445fff3432b5bf76ef2cba4e015bdf05162"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA4ODI5Ng==", "bodyText": "Another way is to model this as a SegmentPreselector which filters the onlineSegments before getting into the SegmentSelector", "url": "https://github.com/apache/pinot/pull/5728#discussion_r461088296", "createdAt": "2020-07-27T18:32:26Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/segmentselector/OfflineSegmentSelector.java", "diffHunk": "@@ -42,7 +49,14 @@ public void onExternalViewChange(ExternalView externalView, Set<String> onlineSe\n     // TODO: for new added segments, before all replicas are up, consider not selecting them to avoid causing\n     //       hotspot servers\n \n-    _segments = Collections.unmodifiableList(new ArrayList<>(onlineSegments));\n+\n+    // Update segment lineage based segment selector\n+    _segmentLineageBasedSegmentSelector.onExternalViewChange();\n+\n+    // Compute the intersection of segments to process from both offline and segment lineage based segment selectors.\n+    List<String> segmentsToProcess =\n+        new ArrayList<>(_segmentLineageBasedSegmentSelector.computeSegmentsToProcess(onlineSegments));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQwODc1Mg=="}, "originalCommit": {"oid": "d0c35445fff3432b5bf76ef2cba4e015bdf05162"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e0fca5326d09eb1c4e27592d4f6829b090b8dab", "author": {"user": {"login": "snleee", "name": "Seunghyun Lee"}}, "url": "https://github.com/apache/pinot/commit/8e0fca5326d09eb1c4e27592d4f6829b090b8dab", "committedDate": "2020-07-30T13:31:28Z", "message": "Added SegmentPreSelector interface"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "938f6741a8869d5a3c6543e2e8837fb19bc17b44", "author": {"user": {"login": "snleee", "name": "Seunghyun Lee"}}, "url": "https://github.com/apache/pinot/commit/938f6741a8869d5a3c6543e2e8837fb19bc17b44", "committedDate": "2020-07-30T13:25:50Z", "message": "Added SegmentPreSelector interface"}, "afterCommit": {"oid": "8e0fca5326d09eb1c4e27592d4f6829b090b8dab", "author": {"user": {"login": "snleee", "name": "Seunghyun Lee"}}, "url": "https://github.com/apache/pinot/commit/8e0fca5326d09eb1c4e27592d4f6829b090b8dab", "committedDate": "2020-07-30T13:31:28Z", "message": "Added SegmentPreSelector interface"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NjQzODA2", "url": "https://github.com/apache/pinot/pull/5728#pullrequestreview-458643806", "createdAt": "2020-07-30T18:14:48Z", "commit": {"oid": "8e0fca5326d09eb1c4e27592d4f6829b090b8dab"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxODoxNDo0OVrOG5uccA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxOTowMjoyM1rOG5v_5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE4Mjk2MA==", "bodyText": "Pre-select onlineSegments before calling init on other components", "url": "https://github.com/apache/pinot/pull/5728#discussion_r463182960", "createdAt": "2020-07-30T18:14:49Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/RoutingManager.java", "diffHunk": "@@ -312,6 +314,8 @@ public synchronized void buildRouting(String tableNameWithType) {\n \n     Set<String> enabledInstances = _enabledServerInstanceMap.keySet();\n \n+    SegmentPreSelector segmentPreSelector =\n+        SegmentPreSelectorFactory.getSegmentPreSelector(tableConfig, _propertyStore);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e0fca5326d09eb1c4e27592d4f6829b090b8dab"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE4NjUxNQ==", "bodyText": "Check lineage before creating segmentsToProcess and segmentsToRemove. If lineage does not exist, directly return onlineSegments to prevent unnecessary overhead.\n(Optional) Consider modifying onlineSegments in-place?", "url": "https://github.com/apache/pinot/pull/5728#discussion_r463186515", "createdAt": "2020-07-30T18:21:17Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/segmentselector/SegmentLineageBasedSegmentPreSelector.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.routing.segmentselector;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.store.zk.ZkHelixPropertyStore;\n+import org.apache.pinot.common.lineage.LineageEntry;\n+import org.apache.pinot.common.lineage.LineageEntryState;\n+import org.apache.pinot.common.lineage.SegmentLineage;\n+import org.apache.pinot.common.lineage.SegmentLineageAccessHelper;\n+\n+\n+/**\n+ * Segment lineage based segment pre-selector\n+ *\n+ * This pre-selector reads the segment lineage metadata and filters out either merged segments or original segments\n+ * to make sure that the final segments contain no duplicate data.\n+ */\n+public class SegmentLineageBasedSegmentPreSelector implements SegmentPreSelector {\n+  private final String _tableNameWithType;\n+  private final ZkHelixPropertyStore<ZNRecord> _propertyStore;\n+\n+  public SegmentLineageBasedSegmentPreSelector(String tableNameWithType, ZkHelixPropertyStore<ZNRecord> propertyStore) {\n+    _tableNameWithType = tableNameWithType;\n+    _propertyStore = propertyStore;\n+  }\n+\n+  @Override\n+  public Set<String> preSelect(Set<String> onlineSegments) {\n+    Set<String> segmentsToProcess = new HashSet<>(onlineSegments);\n+    SegmentLineage segmentLineage = SegmentLineageAccessHelper.getSegmentLineage(_propertyStore, _tableNameWithType);\n+    Set<String> segmentsToRemove = new HashSet<>();\n+    if (segmentLineage != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e0fca5326d09eb1c4e27592d4f6829b090b8dab"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIwODQyMA==", "bodyText": "This won't work because the onlineSegments are from the idealState instead of the externalView. Also, it  won't be able to handle some corner cases.\nE.g. the lineage is as following, and one segment in segmentsB is unavailable\nsegmentsA -> segmentsB -> segmentsC\nThis algorithm will select both segmentsA and segmentsC, which will cause wrong result.\nI still think we should handle this when updating the lineage. Before updating the lineage to COMPLETED, we check whether all segmentsTo are available in externalView. Also, the updater needs to notify the broker to rebuild the routing because there might be no externalView change to trigger the lineage update.", "url": "https://github.com/apache/pinot/pull/5728#discussion_r463208420", "createdAt": "2020-07-30T19:02:23Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/segmentselector/SegmentLineageBasedSegmentPreSelector.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.routing.segmentselector;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.store.zk.ZkHelixPropertyStore;\n+import org.apache.pinot.common.lineage.LineageEntry;\n+import org.apache.pinot.common.lineage.LineageEntryState;\n+import org.apache.pinot.common.lineage.SegmentLineage;\n+import org.apache.pinot.common.lineage.SegmentLineageAccessHelper;\n+\n+\n+/**\n+ * Segment lineage based segment pre-selector\n+ *\n+ * This pre-selector reads the segment lineage metadata and filters out either merged segments or original segments\n+ * to make sure that the final segments contain no duplicate data.\n+ */\n+public class SegmentLineageBasedSegmentPreSelector implements SegmentPreSelector {\n+  private final String _tableNameWithType;\n+  private final ZkHelixPropertyStore<ZNRecord> _propertyStore;\n+\n+  public SegmentLineageBasedSegmentPreSelector(String tableNameWithType, ZkHelixPropertyStore<ZNRecord> propertyStore) {\n+    _tableNameWithType = tableNameWithType;\n+    _propertyStore = propertyStore;\n+  }\n+\n+  @Override\n+  public Set<String> preSelect(Set<String> onlineSegments) {\n+    Set<String> segmentsToProcess = new HashSet<>(onlineSegments);\n+    SegmentLineage segmentLineage = SegmentLineageAccessHelper.getSegmentLineage(_propertyStore, _tableNameWithType);\n+    Set<String> segmentsToRemove = new HashSet<>();\n+    if (segmentLineage != null) {\n+      for (String lineageEntryId : segmentLineage.getLineageEntryIds()) {\n+        LineageEntry lineageEntry = segmentLineage.getLineageEntry(lineageEntryId);\n+        if (lineageEntry.getState() == LineageEntryState.COMPLETED && onlineSegments\n+            .containsAll(lineageEntry.getSegmentsTo())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e0fca5326d09eb1c4e27592d4f6829b090b8dab"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4ODM2OTEw", "url": "https://github.com/apache/pinot/pull/5728#pullrequestreview-458836910", "createdAt": "2020-07-30T23:52:45Z", "commit": {"oid": "c929fd318626a9c2bf38c22557626b1585e581e0"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMzo1Mjo0NVrOG53msQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMzo1Mjo0NVrOG53msQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMzMzA0MQ==", "bodyText": "(nit) You can directly remove them from onlineSegments", "url": "https://github.com/apache/pinot/pull/5728#discussion_r463333041", "createdAt": "2020-07-30T23:52:45Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/segmentselector/SegmentLineageBasedSegmentPreSelector.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.routing.segmentselector;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.store.zk.ZkHelixPropertyStore;\n+import org.apache.pinot.common.lineage.LineageEntry;\n+import org.apache.pinot.common.lineage.LineageEntryState;\n+import org.apache.pinot.common.lineage.SegmentLineage;\n+import org.apache.pinot.common.lineage.SegmentLineageAccessHelper;\n+\n+\n+/**\n+ * Segment lineage based segment pre-selector\n+ *\n+ * This pre-selector reads the segment lineage metadata and filters out either merged segments or original segments\n+ * to make sure that the final segments contain no duplicate data.\n+ */\n+public class SegmentLineageBasedSegmentPreSelector implements SegmentPreSelector {\n+  private final String _tableNameWithType;\n+  private final ZkHelixPropertyStore<ZNRecord> _propertyStore;\n+\n+  public SegmentLineageBasedSegmentPreSelector(String tableNameWithType, ZkHelixPropertyStore<ZNRecord> propertyStore) {\n+    _tableNameWithType = tableNameWithType;\n+    _propertyStore = propertyStore;\n+  }\n+\n+  @Override\n+  public Set<String> preSelect(Set<String> onlineSegments) {\n+    SegmentLineage segmentLineage = SegmentLineageAccessHelper.getSegmentLineage(_propertyStore, _tableNameWithType);\n+    if (segmentLineage != null) {\n+      Set<String> segmentsToRemove = new HashSet<>();\n+      for (String lineageEntryId : segmentLineage.getLineageEntryIds()) {\n+        LineageEntry lineageEntry = segmentLineage.getLineageEntry(lineageEntryId);\n+        if (lineageEntry.getState() == LineageEntryState.COMPLETED) {\n+          segmentsToRemove.addAll(lineageEntry.getSegmentsFrom());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c929fd318626a9c2bf38c22557626b1585e581e0"}, "originalPosition": 54}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c929fd318626a9c2bf38c22557626b1585e581e0", "author": {"user": {"login": "snleee", "name": "Seunghyun Lee"}}, "url": "https://github.com/apache/pinot/commit/c929fd318626a9c2bf38c22557626b1585e581e0", "committedDate": "2020-07-30T23:41:04Z", "message": "Addressing comments"}, "afterCommit": {"oid": "7622673b2e20734bf11855d071c387932c37b1ae", "author": {"user": {"login": "snleee", "name": "Seunghyun Lee"}}, "url": "https://github.com/apache/pinot/commit/7622673b2e20734bf11855d071c387932c37b1ae", "committedDate": "2020-07-31T00:13:04Z", "message": "Addressing comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbd686152db0412c111f66c140890ba06820633e", "author": {"user": {"login": "snleee", "name": "Seunghyun Lee"}}, "url": "https://github.com/apache/pinot/commit/bbd686152db0412c111f66c140890ba06820633e", "committedDate": "2020-07-31T03:01:59Z", "message": "Addressing comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7622673b2e20734bf11855d071c387932c37b1ae", "author": {"user": {"login": "snleee", "name": "Seunghyun Lee"}}, "url": "https://github.com/apache/pinot/commit/7622673b2e20734bf11855d071c387932c37b1ae", "committedDate": "2020-07-31T00:13:04Z", "message": "Addressing comments"}, "afterCommit": {"oid": "bbd686152db0412c111f66c140890ba06820633e", "author": {"user": {"login": "snleee", "name": "Seunghyun Lee"}}, "url": "https://github.com/apache/pinot/commit/bbd686152db0412c111f66c140890ba06820633e", "committedDate": "2020-07-31T03:01:59Z", "message": "Addressing comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 415, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}