{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA1MzgxNzcz", "number": 6153, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNzozNzo1OFrOEvbT_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNzozMToxOVrOEv5m4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4MTY2MDE1OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/util/TableConfigUtils.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNzozNzo1OFrOHkZzyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNzozNzo1OFrOHkZzyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkzMzY0MA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    tableConfig.getIndexingConfig().getStarTreeIndexConfigs() == null || tableConfig.getIndexingConfig()\n          \n          \n            \n                        .getStarTreeIndexConfigs().isEmpty(), \"The upsert table cannot have star-tree index.\");\n          \n          \n            \n                    Collections.isEmpty(tableConfig.getIndexingConfig().getStarTreeIndexConfigs()) && !tableConfig.getIndexingConfig().isEnableDefaultStarTree(), \"The upsert table cannot have star-tree index.\");", "url": "https://github.com/apache/pinot/pull/6153#discussion_r507933640", "createdAt": "2020-10-19T17:37:58Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/util/TableConfigUtils.java", "diffHunk": "@@ -265,6 +265,10 @@ protected static void validateUpsertConfig(TableConfig tableConfig, Schema schem\n         tableConfig.getRoutingConfig() != null && RoutingConfig.REPLICA_GROUP_INSTANCE_SELECTOR_TYPE\n             .equalsIgnoreCase(tableConfig.getRoutingConfig().getInstanceSelectorType()),\n         \"Upsert table must use replica-group (i.e. replicaGroup) based routing\");\n+    // no startree index\n+    Preconditions.checkState(\n+        tableConfig.getIndexingConfig().getStarTreeIndexConfigs() == null || tableConfig.getIndexingConfig()\n+            .getStarTreeIndexConfigs().isEmpty(), \"The upsert table cannot have star-tree index.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ddb30bf5fa80a71074c3661c71707311a85e579c"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4MTcxNjQ2OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/test/java/org/apache/pinot/core/util/SchemaUtilsTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNzo0Nzo1NFrOHkaXwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNzo0Nzo1NFrOHkaXwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk0Mjg1MA==", "bodyText": "Still fail??", "url": "https://github.com/apache/pinot/pull/6153#discussion_r507942850", "createdAt": "2020-10-19T17:47:54Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/test/java/org/apache/pinot/core/util/SchemaUtilsTest.java", "diffHunk": "@@ -221,6 +221,30 @@ public void testValidateTimeFieldSpec() {\n     SchemaUtils.validate(pinotSchema);\n   }\n \n+  @Test\n+  public void testValidatePrimaryKeyColumns() {\n+    Schema pinotSchema;\n+    // non-existing column used as primary key\n+    pinotSchema = new Schema.SchemaBuilder()\n+        .addTime(new TimeGranularitySpec(DataType.LONG, TimeUnit.MILLISECONDS, \"time\"),\n+            new TimeGranularitySpec(DataType.INT, TimeUnit.DAYS, \"time\")).addSingleValueDimension(\"col\", DataType.INT)\n+        .setPrimaryKeyColumns(Lists.newArrayList(\"test\")).build();\n+    checkValidationFails(pinotSchema);\n+    // time column used as primary key\n+    pinotSchema = new Schema.SchemaBuilder()\n+        .addTime(new TimeGranularitySpec(DataType.LONG, TimeUnit.MILLISECONDS, \"time\"),\n+            new TimeGranularitySpec(DataType.INT, TimeUnit.DAYS, \"time\")).addSingleValueDimension(\"col\", DataType.INT)\n+        .setPrimaryKeyColumns(Lists.newArrayList(\"time\")).build();\n+    checkValidationFails(pinotSchema);\n+\n+    // valid primary key\n+    pinotSchema = new Schema.SchemaBuilder()\n+        .addTime(new TimeGranularitySpec(DataType.LONG, TimeUnit.MILLISECONDS, \"time\"),\n+            new TimeGranularitySpec(DataType.INT, TimeUnit.DAYS, \"time\")).addSingleValueDimension(\"col\", DataType.INT)\n+        .setPrimaryKeyColumns(Lists.newArrayList(\"col\")).build();\n+    checkValidationFails(pinotSchema);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ddb30bf5fa80a71074c3661c71707311a85e579c"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4MTc2NDIwOnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/util/SchemaUtils.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNzo1NTo1MVrOHka32Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxOToxNDoyMlrOHkd7Rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk1MTA2NQ==", "bodyText": "Why putting this in the else? Also, this filter can never match because a field cannot be both TIME and DATE_TIME", "url": "https://github.com/apache/pinot/pull/6153#discussion_r507951065", "createdAt": "2020-10-19T17:55:51Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/util/SchemaUtils.java", "diffHunk": "@@ -92,6 +93,9 @@ public static void validate(Schema schema) {\n                 \"Exception in getting arguments for transform function '\" + transformFunction + \"' for column '\"\n                     + column + \"'\", e);\n           }\n+        } else if (fieldSpec.getFieldType().equals(FieldSpec.FieldType.TIME) && fieldSpec.getFieldType()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ddb30bf5fa80a71074c3661c71707311a85e579c"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODAwMTA5NQ==", "bodyText": "typo. missed negation", "url": "https://github.com/apache/pinot/pull/6153#discussion_r508001095", "createdAt": "2020-10-19T19:14:22Z", "author": {"login": "yupeng9"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/util/SchemaUtils.java", "diffHunk": "@@ -92,6 +93,9 @@ public static void validate(Schema schema) {\n                 \"Exception in getting arguments for transform function '\" + transformFunction + \"' for column '\"\n                     + column + \"'\", e);\n           }\n+        } else if (fieldSpec.getFieldType().equals(FieldSpec.FieldType.TIME) && fieldSpec.getFieldType()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk1MTA2NQ=="}, "originalCommit": {"oid": "ddb30bf5fa80a71074c3661c71707311a85e579c"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4MzAwMjE5OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/util/SchemaUtils.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMDo0Mzo1OVrOHkmiPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMzozMjo0NVrOHkpXXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE0MjE0MA==", "bodyText": "Any specific reason why transformed column cannot be primary key column?", "url": "https://github.com/apache/pinot/pull/6153#discussion_r508142140", "createdAt": "2020-10-20T00:43:59Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/util/SchemaUtils.java", "diffHunk": "@@ -92,6 +93,8 @@ public static void validate(Schema schema) {\n                 \"Exception in getting arguments for transform function '\" + transformFunction + \"' for column '\"\n                     + column + \"'\", e);\n           }\n+        } else {\n+          primaryKeyColumnCandidates.add(column);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1de567840ca3e109d179f21ba53c6ddea6cadf28"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE4ODUwOA==", "bodyText": "we can remove this constraint, though I feel it shall be very rare for the transformed column to be the primary key", "url": "https://github.com/apache/pinot/pull/6153#discussion_r508188508", "createdAt": "2020-10-20T03:32:45Z", "author": {"login": "yupeng9"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/util/SchemaUtils.java", "diffHunk": "@@ -92,6 +93,8 @@ public static void validate(Schema schema) {\n                 \"Exception in getting arguments for transform function '\" + transformFunction + \"' for column '\"\n                     + column + \"'\", e);\n           }\n+        } else {\n+          primaryKeyColumnCandidates.add(column);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE0MjE0MA=="}, "originalCommit": {"oid": "1de567840ca3e109d179f21ba53c6ddea6cadf28"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4MzAwNDQ0OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/util/TableConfigUtils.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMDo0NTowMVrOHkmjbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxOToyMDoxNFrOHlNdpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE0MjQ0Nw==", "bodyText": "This part is incorrect. You should wrap everything into the preconditions", "url": "https://github.com/apache/pinot/pull/6153#discussion_r508142447", "createdAt": "2020-10-20T00:45:01Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/util/TableConfigUtils.java", "diffHunk": "@@ -265,6 +265,12 @@ protected static void validateUpsertConfig(TableConfig tableConfig, Schema schem\n         tableConfig.getRoutingConfig() != null && RoutingConfig.REPLICA_GROUP_INSTANCE_SELECTOR_TYPE\n             .equalsIgnoreCase(tableConfig.getRoutingConfig().getInstanceSelectorType()),\n         \"Upsert table must use replica-group (i.e. replicaGroup) based routing\");\n+    // no startree index\n+    if (tableConfig.getIndexingConfig() != null && tableConfig.getIndexingConfig().getStarTreeIndexConfigs() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1de567840ca3e109d179f21ba53c6ddea6cadf28"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE4ODI5NA==", "bodyText": "why? when both are null, this check is noop?", "url": "https://github.com/apache/pinot/pull/6153#discussion_r508188294", "createdAt": "2020-10-20T03:31:52Z", "author": {"login": "yupeng9"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/util/TableConfigUtils.java", "diffHunk": "@@ -265,6 +265,12 @@ protected static void validateUpsertConfig(TableConfig tableConfig, Schema schem\n         tableConfig.getRoutingConfig() != null && RoutingConfig.REPLICA_GROUP_INSTANCE_SELECTOR_TYPE\n             .equalsIgnoreCase(tableConfig.getRoutingConfig().getInstanceSelectorType()),\n         \"Upsert table must use replica-group (i.e. replicaGroup) based routing\");\n+    // no startree index\n+    if (tableConfig.getIndexingConfig() != null && tableConfig.getIndexingConfig().getStarTreeIndexConfigs() != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE0MjQ0Nw=="}, "originalCommit": {"oid": "1de567840ca3e109d179f21ba53c6ddea6cadf28"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODcxMDY3NQ==", "bodyText": "If tableConfig.getIndexingConfig().getStarTreeIndexConfigs() is null, but tableConfig.getIndexingConfig().isEnableDefaultStarTree() is true, you will miss the check.\nAlso, tableConfig.getIndexingConfig() can never be null here because it has been checked", "url": "https://github.com/apache/pinot/pull/6153#discussion_r508710675", "createdAt": "2020-10-20T17:28:57Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/util/TableConfigUtils.java", "diffHunk": "@@ -265,6 +265,12 @@ protected static void validateUpsertConfig(TableConfig tableConfig, Schema schem\n         tableConfig.getRoutingConfig() != null && RoutingConfig.REPLICA_GROUP_INSTANCE_SELECTOR_TYPE\n             .equalsIgnoreCase(tableConfig.getRoutingConfig().getInstanceSelectorType()),\n         \"Upsert table must use replica-group (i.e. replicaGroup) based routing\");\n+    // no startree index\n+    if (tableConfig.getIndexingConfig() != null && tableConfig.getIndexingConfig().getStarTreeIndexConfigs() != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE0MjQ0Nw=="}, "originalCommit": {"oid": "1de567840ca3e109d179f21ba53c6ddea6cadf28"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc3OTk0MA==", "bodyText": "I see what you meant. Makes sense.", "url": "https://github.com/apache/pinot/pull/6153#discussion_r508779940", "createdAt": "2020-10-20T19:20:14Z", "author": {"login": "yupeng9"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/util/TableConfigUtils.java", "diffHunk": "@@ -265,6 +265,12 @@ protected static void validateUpsertConfig(TableConfig tableConfig, Schema schem\n         tableConfig.getRoutingConfig() != null && RoutingConfig.REPLICA_GROUP_INSTANCE_SELECTOR_TYPE\n             .equalsIgnoreCase(tableConfig.getRoutingConfig().getInstanceSelectorType()),\n         \"Upsert table must use replica-group (i.e. replicaGroup) based routing\");\n+    // no startree index\n+    if (tableConfig.getIndexingConfig() != null && tableConfig.getIndexingConfig().getStarTreeIndexConfigs() != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE0MjQ0Nw=="}, "originalCommit": {"oid": "1de567840ca3e109d179f21ba53c6ddea6cadf28"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NjYyMzY5OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/util/TableConfigUtils.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNzozMToxOVrOHlJUsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNzozMToxOVrOHlJUsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODcxMjExNQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (tableConfig.getIndexingConfig() != null && tableConfig.getIndexingConfig().getStarTreeIndexConfigs() != null) {\n          \n          \n            \n                  Preconditions.checkState(\n          \n          \n            \n                      tableConfig.getIndexingConfig().getStarTreeIndexConfigs().isEmpty() && !tableConfig.getIndexingConfig()\n          \n          \n            \n                          .isEnableDefaultStarTree(), \"The upsert table cannot have star-tree index.\");\n          \n          \n            \n                }\n          \n          \n            \n                Preconditions.checkState(\n          \n          \n            \n                    CollectionUtils.isEmpty(tableConfig.getIndexingConfig().getStarTreeIndexConfigs()) && !tableConfig\n          \n          \n            \n                        .getIndexingConfig().isEnableDefaultStarTree(), \"The upsert table cannot have star-tree index.\");", "url": "https://github.com/apache/pinot/pull/6153#discussion_r508712115", "createdAt": "2020-10-20T17:31:19Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/util/TableConfigUtils.java", "diffHunk": "@@ -265,6 +265,12 @@ protected static void validateUpsertConfig(TableConfig tableConfig, Schema schem\n         tableConfig.getRoutingConfig() != null && RoutingConfig.REPLICA_GROUP_INSTANCE_SELECTOR_TYPE\n             .equalsIgnoreCase(tableConfig.getRoutingConfig().getInstanceSelectorType()),\n         \"Upsert table must use replica-group (i.e. replicaGroup) based routing\");\n+    // no startree index\n+    if (tableConfig.getIndexingConfig() != null && tableConfig.getIndexingConfig().getStarTreeIndexConfigs() != null) {\n+      Preconditions.checkState(\n+          tableConfig.getIndexingConfig().getStarTreeIndexConfigs().isEmpty() && !tableConfig.getIndexingConfig()\n+              .isEnableDefaultStarTree(), \"The upsert table cannot have star-tree index.\");\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f400bfcf93f2ffb519ff7491fb75384c7251a85"}, "originalPosition": 9}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3761, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}