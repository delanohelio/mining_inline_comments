{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4MDk1ODgz", "number": 5765, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMjozNTowNlrOETEjjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMjozNzoyMlrOETEk-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NDMzMDM4OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/operator/blocks/ProjectionBlock.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMjozNTowNlrOG4mZeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMjozNTowNlrOG4mZeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwMjU1Mw==", "bodyText": "probably not relevant to this PR but we should try to move towards using Block instead of DataSource", "url": "https://github.com/apache/pinot/pull/5765#discussion_r462002553", "createdAt": "2020-07-29T02:35:06Z", "author": {"login": "kishoreg"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/operator/blocks/ProjectionBlock.java", "diffHunk": "@@ -25,22 +25,22 @@\n import org.apache.pinot.core.common.BlockMetadata;\n import org.apache.pinot.core.common.BlockValSet;\n import org.apache.pinot.core.common.DataBlockCache;\n-import org.apache.pinot.core.common.DataSourceMetadata;\n+import org.apache.pinot.core.common.DataSource;\n import org.apache.pinot.core.operator.docvalsets.ProjectionBlockValSet;\n-import org.apache.pinot.spi.data.FieldSpec;\n \n \n /**\n  * ProjectionBlock holds a column name to Block Map.\n  * It provides DocIdSetBlock for a given column.\n  */\n public class ProjectionBlock implements Block {\n-  private final Map<String, DataSourceMetadata> _dataSourceMetadataMap;\n+  private final Map<String, DataSource> _dataSourceMap;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce53fd0f2ced9b85f4504ad753c3268f1840bfe5"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NDMzMjM1OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/operator/docvalsets/ProjectionBlockValSet.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMjozNjoxOFrOG4makw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNTo1Njo0OVrOG4poWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwMjgzNQ==", "bodyText": "how come we never needed this? For group by, we already have the optimization to work on dictionary ids right?", "url": "https://github.com/apache/pinot/pull/5765#discussion_r462002835", "createdAt": "2020-07-29T02:36:18Z", "author": {"login": "kishoreg"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/operator/docvalsets/ProjectionBlockValSet.java", "diffHunk": "@@ -32,32 +35,33 @@\n public class ProjectionBlockValSet implements BlockValSet {\n   private final DataBlockCache _dataBlockCache;\n   private final String _column;\n-  private final DataType _dataType;\n-  private final boolean _singleValue;\n+  private final DataSource _dataSource;\n \n   /**\n    * Constructor for the class.\n-   * The dataBlockCache argument is initialized in {@link ProjectionOperator},\n-   * so that it can be reused across multiple calls to {@link ProjectionOperator#nextBlock()}.\n-   *\n-   * @param dataBlockCache data block cache\n-   * @param column Projection column.\n+   * The dataBlockCache is initialized in {@link ProjectionOperator} so that it can be reused across multiple calls to\n+   * {@link ProjectionOperator#nextBlock()}.\n    */\n-  public ProjectionBlockValSet(DataBlockCache dataBlockCache, String column, DataType dataType, boolean singleValue) {\n+  public ProjectionBlockValSet(DataBlockCache dataBlockCache, String column, DataSource dataSource) {\n     _dataBlockCache = dataBlockCache;\n     _column = column;\n-    _dataType = dataType;\n-    _singleValue = singleValue;\n+    _dataSource = dataSource;\n   }\n \n   @Override\n   public DataType getValueType() {\n-    return _dataType;\n+    return _dataSource.getDataSourceMetadata().getDataType();\n   }\n \n   @Override\n   public boolean isSingleValue() {\n-    return _singleValue;\n+    return _dataSource.getDataSourceMetadata().isSingleValue();\n+  }\n+\n+  @Nullable\n+  @Override\n+  public Dictionary getDictionary() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce53fd0f2ced9b85f4504ad753c3268f1840bfe5"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA1NTUxMw==", "bodyText": "For group-by, the dictionary is fetched from the TransformFunction", "url": "https://github.com/apache/pinot/pull/5765#discussion_r462055513", "createdAt": "2020-07-29T05:56:49Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/operator/docvalsets/ProjectionBlockValSet.java", "diffHunk": "@@ -32,32 +35,33 @@\n public class ProjectionBlockValSet implements BlockValSet {\n   private final DataBlockCache _dataBlockCache;\n   private final String _column;\n-  private final DataType _dataType;\n-  private final boolean _singleValue;\n+  private final DataSource _dataSource;\n \n   /**\n    * Constructor for the class.\n-   * The dataBlockCache argument is initialized in {@link ProjectionOperator},\n-   * so that it can be reused across multiple calls to {@link ProjectionOperator#nextBlock()}.\n-   *\n-   * @param dataBlockCache data block cache\n-   * @param column Projection column.\n+   * The dataBlockCache is initialized in {@link ProjectionOperator} so that it can be reused across multiple calls to\n+   * {@link ProjectionOperator#nextBlock()}.\n    */\n-  public ProjectionBlockValSet(DataBlockCache dataBlockCache, String column, DataType dataType, boolean singleValue) {\n+  public ProjectionBlockValSet(DataBlockCache dataBlockCache, String column, DataSource dataSource) {\n     _dataBlockCache = dataBlockCache;\n     _column = column;\n-    _dataType = dataType;\n-    _singleValue = singleValue;\n+    _dataSource = dataSource;\n   }\n \n   @Override\n   public DataType getValueType() {\n-    return _dataType;\n+    return _dataSource.getDataSourceMetadata().getDataType();\n   }\n \n   @Override\n   public boolean isSingleValue() {\n-    return _singleValue;\n+    return _dataSource.getDataSourceMetadata().isSingleValue();\n+  }\n+\n+  @Nullable\n+  @Override\n+  public Dictionary getDictionary() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwMjgzNQ=="}, "originalCommit": {"oid": "ce53fd0f2ced9b85f4504ad753c3268f1840bfe5"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NDMzNDAxOnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountAggregationFunction.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMjozNzoyMlrOG4mbiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNjowNjo1MVrOG4p1zA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwMzA4Mw==", "bodyText": "java doc for this?", "url": "https://github.com/apache/pinot/pull/5765#discussion_r462003083", "createdAt": "2020-07-29T02:37:22Z", "author": {"login": "kishoreg"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountAggregationFunction.java", "diffHunk": "@@ -212,11 +259,57 @@ public IntOpenHashSet extractGroupByResult(GroupByResultHolder groupByResultHold\n     IntOpenHashSet valueSet = groupByResultHolder.getResult(groupKey);\n     if (valueSet == null) {\n       return new IntOpenHashSet();\n+    }\n+\n+    if (_dictionary != null) {\n+      // For dictionary-encoded expression, convert dictionary ids to values\n+      return convertToValueSet(valueSet);\n     } else {\n       return valueSet;\n     }\n   }\n \n+  private IntOpenHashSet convertToValueSet(IntOpenHashSet dictIdSet) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce53fd0f2ced9b85f4504ad753c3268f1840bfe5"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA1ODk1Ng==", "bodyText": "Added", "url": "https://github.com/apache/pinot/pull/5765#discussion_r462058956", "createdAt": "2020-07-29T06:06:51Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountAggregationFunction.java", "diffHunk": "@@ -212,11 +259,57 @@ public IntOpenHashSet extractGroupByResult(GroupByResultHolder groupByResultHold\n     IntOpenHashSet valueSet = groupByResultHolder.getResult(groupKey);\n     if (valueSet == null) {\n       return new IntOpenHashSet();\n+    }\n+\n+    if (_dictionary != null) {\n+      // For dictionary-encoded expression, convert dictionary ids to values\n+      return convertToValueSet(valueSet);\n     } else {\n       return valueSet;\n     }\n   }\n \n+  private IntOpenHashSet convertToValueSet(IntOpenHashSet dictIdSet) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwMzA4Mw=="}, "originalCommit": {"oid": "ce53fd0f2ced9b85f4504ad753c3268f1840bfe5"}, "originalPosition": 122}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4216, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}