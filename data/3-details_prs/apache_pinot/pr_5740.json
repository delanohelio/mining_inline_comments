{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1NDY0MDA3", "number": 5740, "title": "[TE] Added a backfill start date for Anomaly Detection", "bodyText": "Description\nWhen an alert is created, it automatically triggers a YAML Onboarding Task\nwhich detects all anomalies in the past 30 days. This change makes the\nsetting configurable by providing a backfill start timestamp.\nNot providing the value or simply providing a dubious entry would result\nin the system defaulting to the 30 day lookback.\nThis change also updates the alert template UI to make it easy for a new\nuser to try this config\nThere are no backward incompatible changes.", "createdAt": "2020-07-23T03:44:26Z", "url": "https://github.com/apache/pinot/pull/5740", "merged": true, "mergeCommit": {"oid": "cb7de2343ff5a074f295b1ab57a353f613abcc9f"}, "closed": true, "closedAt": "2020-07-30T18:41:38Z", "author": {"login": "suvodeep-pyne"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3nCI2gH2gAyNDU1NDY0MDA3Ojc2MDVkMDMxMzA3YjgzM2Y3MDAwMzA3NmQwYWZmZTVjYjZmMGEzYmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc6EG_qgFqTQ1ODY2MTcyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7605d031307b833f70003076d0affe5cb6f0a3be", "author": {"user": null}, "url": "https://github.com/apache/pinot/commit/7605d031307b833f70003076d0affe5cb6f0a3be", "committedDate": "2020-07-23T03:40:33Z", "message": "[TE] Added a backfill start date for Anomaly Detection\n\nWhen an alert is created, it automatically triggers a YAML Onboarding Task\nwhich detects all anomalies in the past 30 days. This change makes the\nsetting configurable by providing a backfill start timestamp.\n\nNot providing the value or simply providing a dubious entry would result\nin the system defaulting to the 30 day lookback.\n\nThis change also updates the alert template UI to make it easy for a new\nuser to try this config"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NDExNDM5", "url": "https://github.com/apache/pinot/pull/5740#pullrequestreview-454411439", "createdAt": "2020-07-23T18:56:36Z", "commit": {"oid": "7605d031307b833f70003076d0affe5cb6f0a3be"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxODo1NjozN1rOG2XhoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxOToxMDo0N1rOG2X-4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2MTcyOA==", "bodyText": "I'd prefer keeping the template simple and put all the additional configurations in the user guide. Regular users need not know about these parameters.", "url": "https://github.com/apache/pinot/pull/5740#discussion_r459661728", "createdAt": "2020-07-23T18:56:37Z", "author": {"login": "akshayrai"}, "path": "thirdeye/thirdeye-frontend/app/utils/yaml-tools.js", "diffHunk": "@@ -29,6 +28,20 @@ rules:\n     type: DATA_SLA              # Alert if data is missing.\n     params:\n       sla: 3_DAYS               # Data is missing for 3 days since last availability\n+\n+# You can mention a cron to allow this detection to be run periodically\n+# For example, the cron below would execute every 5 minutes.\n+# cron: \"0 0/5 * 1/1 * ? *\"\n+\n+# Backfill detections\n+# You can use the backfillStart parameter to denote how far back you want the anomalies\n+# to be detected.\n+# A valid entry is a timestamp value in millis.\n+# \n+# - By default, (if not mentioned), the lookback is 30 days\n+# - A value of 0 (zero) implies complete backfill till the start of data. As shown below.\n+# backfillStart: 0 \n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7605d031307b833f70003076d0affe5cb6f0a3be"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2NTU1NA==", "bodyText": "Can you shed some light on the need for a custom backfill configuration? Since this is a one time setting, I am not very confident of putting it in the detection config.", "url": "https://github.com/apache/pinot/pull/5740#discussion_r459665554", "createdAt": "2020-07-23T19:03:46Z", "author": {"login": "akshayrai"}, "path": "thirdeye/thirdeye-frontend/app/utils/yaml-tools.js", "diffHunk": "@@ -29,6 +28,20 @@ rules:\n     type: DATA_SLA              # Alert if data is missing.\n     params:\n       sla: 3_DAYS               # Data is missing for 3 days since last availability\n+\n+# You can mention a cron to allow this detection to be run periodically\n+# For example, the cron below would execute every 5 minutes.\n+# cron: \"0 0/5 * 1/1 * ? *\"\n+\n+# Backfill detections\n+# You can use the backfillStart parameter to denote how far back you want the anomalies\n+# to be detected.\n+# A valid entry is a timestamp value in millis.\n+# \n+# - By default, (if not mentioned), the lookback is 30 days\n+# - A value of 0 (zero) implies complete backfill till the start of data. As shown below.\n+# backfillStart: 0 ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7605d031307b833f70003076d0affe5cb6f0a3be"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2NjM1OQ==", "bodyText": "The term backfill is a bit overloaded. It could also mean rerunning the detection which is not what is intended.", "url": "https://github.com/apache/pinot/pull/5740#discussion_r459666359", "createdAt": "2020-07-23T19:05:13Z", "author": {"login": "akshayrai"}, "path": "thirdeye/thirdeye-frontend/app/utils/yaml-tools.js", "diffHunk": "@@ -29,6 +28,20 @@ rules:\n     type: DATA_SLA              # Alert if data is missing.\n     params:\n       sla: 3_DAYS               # Data is missing for 3 days since last availability\n+\n+# You can mention a cron to allow this detection to be run periodically\n+# For example, the cron below would execute every 5 minutes.\n+# cron: \"0 0/5 * 1/1 * ? *\"\n+\n+# Backfill detections", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7605d031307b833f70003076d0affe5cb6f0a3be"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2Nzc3MA==", "bodyText": "@harleyjj\nCan we customize and configure the default template? At LinkedIn, we are relying on ALGORITHM as the default detection. If we change this, we need to have an alternative to plug a different default setting.", "url": "https://github.com/apache/pinot/pull/5740#discussion_r459667770", "createdAt": "2020-07-23T19:07:52Z", "author": {"login": "akshayrai"}, "path": "thirdeye/thirdeye-frontend/app/utils/yaml-tools.js", "diffHunk": "@@ -12,12 +12,11 @@ dataset: dataset_to_which_this_metric_belongs\n rules:\n - detection:\n   - name: detection_rule_1\n-    type: ALGORITHM             # Configure the detection type here. See doc for more details.\n+    type: PERCENTAGE_RULE       # Configure the detection type here. See doc for more details.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7605d031307b833f70003076d0affe5cb6f0a3be"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2OTIxOA==", "bodyText": "I think we already have a utility for this. Can you try MapUtils or ConfigUtils?", "url": "https://github.com/apache/pinot/pull/5740#discussion_r459669218", "createdAt": "2020-07-23T19:10:47Z", "author": {"login": "akshayrai"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/yaml/translator/DetectionConfigTranslator.java", "diffHunk": "@@ -189,6 +190,7 @@ private DetectionConfigDTO generateDetectionConfig(Map<String, Object> yamlConfi\n     config.setCron(cron);\n     config.setActive(MapUtils.getBooleanValue(yamlConfigMap, PROP_ACTIVE, true));\n     config.setYaml(yamlConfig);\n+    config.setBackfillStart(parseTimeStampLong(yamlConfigMap.get(PROP_BACKFILL_START)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7605d031307b833f70003076d0affe5cb6f0a3be"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3de9f1a0f435bd8deaf0fe6dcb2b77c8d05b212a", "author": {"user": null}, "url": "https://github.com/apache/pinot/commit/3de9f1a0f435bd8deaf0fe6dcb2b77c8d05b212a", "committedDate": "2020-07-24T03:38:16Z", "message": "[TE] Added a backfill start date for Anomaly Detection\n\nUpdates. Replaced backfillStart with the already existing lastTimestamp\nThis value is used as a checkpoint and is already being persisted in the db"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2OTA2ODcz", "url": "https://github.com/apache/pinot/pull/5740#pullrequestreview-456906873", "createdAt": "2020-07-28T18:39:46Z", "commit": {"oid": "3de9f1a0f435bd8deaf0fe6dcb2b77c8d05b212a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODozOTo0NlrOG4Zlkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODozOTo0NlrOG4Zlkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5MjY1OQ==", "bodyText": "Couple of concerns with backfilling all the data:\n\nBackfilling all the data can take quite some time, especially if there are years worth of data and possibly even fail due to timeout and other issues.\nThere isn't much benefit of backfilling older data. Users usually don't care about historical anomalies/issues, at least not older than a month.\nThe goal of the 30 day default backfill is to quickly show some stats and recent anomalies as soon as the alert is created. Otherwise, the alert page will look empty and users have to revisit after some time.\nTypically, users tend to create an alert using the basic settings and update it later on. When they update,  anomalies created using the initial setting will no longer make sense.\n\nWe could increase the default limit from 30 days to say 90 days if that is more reasonable?", "url": "https://github.com/apache/pinot/pull/5740#discussion_r461792659", "createdAt": "2020-07-28T18:39:46Z", "author": {"login": "akshayrai"}, "path": "thirdeye/thirdeye-frontend/app/utils/yaml-tools.js", "diffHunk": "@@ -29,6 +28,20 @@ rules:\n     type: DATA_SLA              # Alert if data is missing.\n     params:\n       sla: 3_DAYS               # Data is missing for 3 days since last availability\n+\n+# You can mention a cron to allow this detection to be run periodically\n+# For example, the cron below would execute every 5 minutes.\n+# cron: \"0 0/5 * 1/1 * ? *\"\n+\n+# Detections in past data\n+# You can use the lastTimestamp parameter to denote how far back you want the anomalies\n+# to be detected. This value acts like a checkpoint or high watermark. \n+# A valid entry is a non negative timestamp value in millis.\n+# \n+# - By default, (if not mentioned), the lookback is 30 days\n+# - A value of 0 (zero) implies complete backfill till the start of data. As shown below.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3de9f1a0f435bd8deaf0fe6dcb2b77c8d05b212a"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aab60e7196ec13a3c755f7a35c514beced82ad7b", "author": {"user": null}, "url": "https://github.com/apache/pinot/commit/aab60e7196ec13a3c755f7a35c514beced82ad7b", "committedDate": "2020-07-28T22:45:19Z", "message": "[TE] Added a backfill start date for Anomaly Detection\n\nUndoing changes in create alert yaml template"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MDk5ODM5", "url": "https://github.com/apache/pinot/pull/5740#pullrequestreview-457099839", "createdAt": "2020-07-28T23:36:34Z", "commit": {"oid": "aab60e7196ec13a3c755f7a35c514beced82ad7b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMzozNjozNFrOG4jZJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMzozNjozNFrOG4jZJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk1MzMxOQ==", "bodyText": "Since the default value of lastTimestamp will be 0 (when not set), we should probably change this condition here to not trigger detection on the entire dataset.", "url": "https://github.com/apache/pinot/pull/5740#discussion_r461953319", "createdAt": "2020-07-28T23:36:34Z", "author": {"login": "akshayrai"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/yaml/YamlResource.java", "diffHunk": "@@ -236,10 +236,17 @@ private void createYamlOnboardingTask(long configId, long tuningWindowStart, lon\n     info.setTuningWindowStart(tuningWindowStart);\n     info.setTuningWindowEnd(tuningWindowEnd);\n     info.setEnd(System.currentTimeMillis());\n-    info.setStart(info.getEnd() - ONBOARDING_REPLAY_LOOKBACK);\n+\n+    long lastTimestamp = detectionConfig.getLastTimestamp();\n+    // If no value is present, set the default lookback\n+    if (lastTimestamp < 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aab60e7196ec13a3c755f7a35c514beced82ad7b"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NjYxNzI4", "url": "https://github.com/apache/pinot/pull/5740#pullrequestreview-458661728", "createdAt": "2020-07-30T18:40:57Z", "commit": {"oid": "aab60e7196ec13a3c755f7a35c514beced82ad7b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 441, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}