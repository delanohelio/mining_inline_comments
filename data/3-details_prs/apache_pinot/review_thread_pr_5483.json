{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2MzExMzEy", "number": 5483, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwMjo1NDoyNFrOEBk7xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xM1QwMzo1NDozN1rOEFOssQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMDg5MTU5OnYy", "diffSide": "RIGHT", "path": "pinot-common/src/main/java/org/apache/pinot/common/request/v2/ServerQuery.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwMjo1NDoyNFrOGdga5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMTo0NDo0N1rOGeFCrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU5MzA2Mw==", "bodyText": "Why call this ServerQuery?", "url": "https://github.com/apache/pinot/pull/5483#discussion_r433593063", "createdAt": "2020-06-02T02:54:24Z", "author": {"login": "kishoreg"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/request/v2/ServerQuery.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.common.request.v2;\n+\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import org.apache.pinot.common.request.BrokerRequest;\n+\n+\n+public class ServerQuery {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c80df275a64781fad00b35fe18a44e7af6fb480"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzYxNTAzMQ==", "bodyText": "This object can have some Server specific optimizations or pre-computed result, which might not apply to Broker. For example, we don't need to compile the filter for broker. We can add a separate BrokerQuery which only contain the information that Broker needs.\nExpression, Function are common and shared for both Broker and Server.", "url": "https://github.com/apache/pinot/pull/5483#discussion_r433615031", "createdAt": "2020-06-02T04:35:26Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/request/v2/ServerQuery.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.common.request.v2;\n+\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import org.apache.pinot.common.request.BrokerRequest;\n+\n+\n+public class ServerQuery {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU5MzA2Mw=="}, "originalCommit": {"oid": "9c80df275a64781fad00b35fe18a44e7af6fb480"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE5MzA2OA==", "bodyText": "@kishoreg After reconsideration, changed it to QueryRequest and use it on both Broker and Server side. We can use a wrapper class on server side (E.g. ServerQueryRequest) to store the server specific helper variables.", "url": "https://github.com/apache/pinot/pull/5483#discussion_r434193068", "createdAt": "2020-06-02T21:44:47Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/request/v2/ServerQuery.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.common.request.v2;\n+\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import org.apache.pinot.common.request.BrokerRequest;\n+\n+\n+public class ServerQuery {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU5MzA2Mw=="}, "originalCommit": {"oid": "9c80df275a64781fad00b35fe18a44e7af6fb480"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNTM5Nzc5OnYy", "diffSide": "RIGHT", "path": "pinot-common/src/main/java/org/apache/pinot/common/request/v2/utils/BrokerRequestToQueryRequestConverter.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwNTozNzoyM1rOGeMs5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwNTozNzoyM1rOGeMs5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMxODU2NA==", "bodyText": "Isn't the damage already done when an expression from PinotQuery was converted to a string in BrokerRequest? Can we always get back the original expression from the string inside BrokerRequest (I recently ran into an issue where we lost the info whether a token was literal or not, will dig up the details).", "url": "https://github.com/apache/pinot/pull/5483#discussion_r434318564", "createdAt": "2020-06-03T05:37:23Z", "author": {"login": "mayankshriv"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/request/v2/utils/BrokerRequestToQueryRequestConverter.java", "diffHunk": "@@ -0,0 +1,154 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.common.request.v2.utils;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import org.apache.pinot.common.request.AggregationInfo;\n+import org.apache.pinot.common.request.BrokerRequest;\n+import org.apache.pinot.common.request.FilterOperator;\n+import org.apache.pinot.common.request.GroupBy;\n+import org.apache.pinot.common.request.Selection;\n+import org.apache.pinot.common.request.SelectionSort;\n+import org.apache.pinot.common.request.v2.Expression;\n+import org.apache.pinot.common.request.v2.FilterFunction;\n+import org.apache.pinot.common.request.v2.Function;\n+import org.apache.pinot.common.request.v2.OrderByExpression;\n+import org.apache.pinot.common.request.v2.QueryRequest;\n+import org.apache.pinot.common.utils.request.FilterQueryTree;\n+import org.apache.pinot.common.utils.request.RequestUtils;\n+import org.apache.pinot.pql.parsers.Pql2Compiler;\n+import org.apache.pinot.pql.parsers.pql2.ast.AstNode;\n+import org.apache.pinot.pql.parsers.pql2.ast.FunctionCallAstNode;\n+import org.apache.pinot.pql.parsers.pql2.ast.IdentifierAstNode;\n+import org.apache.pinot.pql.parsers.pql2.ast.LiteralAstNode;\n+\n+\n+public class BrokerRequestToQueryRequestConverter {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "087337ae392d6f9b212fdd5e0d077a5a3601a22a"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczMzUyOTIzOnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/request/context/Expression.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMzo0NDo0N1rOGid6gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxODoyMzo0M1rOGjNq1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc5NDg4Mw==", "bodyText": "We already have this class right? The Calcite SQL compilation path uses Expression already. Why add it again?", "url": "https://github.com/apache/pinot/pull/5483#discussion_r438794883", "createdAt": "2020-06-11T13:44:47Z", "author": {"login": "siddharthteotia"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/request/context/Expression.java", "diffHunk": "@@ -0,0 +1,119 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.query.request.context;\n+\n+import java.util.Objects;\n+import java.util.Set;\n+\n+\n+/**\n+ * The {@code Expression} class represents an expression in the query.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a111e48040063fe4a071e6b84d5de4724290a13"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk2NDIxNQ==", "bodyText": "Added this new Expression class for 2 reasons:\n\nThe function is represented with the new added FunctionInfo class (Pinot domain class which identifies whether the function is Aggregation or Transform before sending the query to each segment)\nCalcite Expression is a Thrift object which we use for wiring. It cannot be evolved along with the query execution engine. We should have a separate POJO class to encapsulate the information needed by the query engine, and perform the pre-computation before getting into each segment if possible.\n\nThis Expression class will replace the TransformExpressionTree in the following PRs of deprecating BrokerRequest.", "url": "https://github.com/apache/pinot/pull/5483#discussion_r438964215", "createdAt": "2020-06-11T17:48:27Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/request/context/Expression.java", "diffHunk": "@@ -0,0 +1,119 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.query.request.context;\n+\n+import java.util.Objects;\n+import java.util.Set;\n+\n+\n+/**\n+ * The {@code Expression} class represents an expression in the query.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc5NDg4Mw=="}, "originalCommit": {"oid": "9a111e48040063fe4a071e6b84d5de4724290a13"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU3NzMwMA==", "bodyText": "I agree with the change, however, can we rename one of them (I am guessing we can't rename thrift one). It becomes very confusion with two classes of same name.", "url": "https://github.com/apache/pinot/pull/5483#discussion_r439577300", "createdAt": "2020-06-12T18:23:43Z", "author": {"login": "mayankshriv"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/request/context/Expression.java", "diffHunk": "@@ -0,0 +1,119 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.query.request.context;\n+\n+import java.util.Objects;\n+import java.util.Set;\n+\n+\n+/**\n+ * The {@code Expression} class represents an expression in the query.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc5NDg4Mw=="}, "originalCommit": {"oid": "9a111e48040063fe4a071e6b84d5de4724290a13"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczMzUyOTk4OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/request/context/FilterInfo.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMzo0NDo1MlrOGid68Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNzo1NzowMFrOGiosvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc5NDk5Mw==", "bodyText": "Today execution engine is based on FilterQueryTree. So the wire request contains FilterQuery and FilterSubqueryMap. On the server, FilterPlanNode converts these into FilterQueryTree for each segment level execution.\nWhy can't we continue to leverage FilterQueryTree? We should just create it once (since it is segment independent) and stash it away in QueryContext. It already encapsulates all the information that this class seems to provide.", "url": "https://github.com/apache/pinot/pull/5483#discussion_r438794993", "createdAt": "2020-06-11T13:44:52Z", "author": {"login": "siddharthteotia"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/request/context/FilterInfo.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.query.request.context;\n+\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Set;\n+import org.apache.pinot.core.query.request.context.predicate.Predicate;\n+\n+\n+/**\n+ * The {@code FilterInfo} class encapsulates the information of the filter in the query. Both WHERE clause and HAVING\n+ * clause are modeled as a filter.\n+ */\n+public class FilterInfo {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a111e48040063fe4a071e6b84d5de4724290a13"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3MTU4MA==", "bodyText": "FilterQueryTree will be replaced with the FilterInfo in the following PRs of deprecating BrokerRequest.\nWe want to replace FilterQueryTree for the following reasons:\n\nIt has the Thrift object FilterOperator\nThe value is not a good abstraction for Predicate (e.g. for RANGE, it is a single string of [a\\t\\tb])\nThe predicate is not pre-computed", "url": "https://github.com/apache/pinot/pull/5483#discussion_r438971580", "createdAt": "2020-06-11T17:57:00Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/request/context/FilterInfo.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.query.request.context;\n+\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Set;\n+import org.apache.pinot.core.query.request.context.predicate.Predicate;\n+\n+\n+/**\n+ * The {@code FilterInfo} class encapsulates the information of the filter in the query. Both WHERE clause and HAVING\n+ * clause are modeled as a filter.\n+ */\n+public class FilterInfo {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc5NDk5Mw=="}, "originalCommit": {"oid": "9a111e48040063fe4a071e6b84d5de4724290a13"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczMzUzMDg4OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/request/context/QueryContext.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMzo0NTowMVrOGid7fA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxODowMzowM1rOGio57A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc5NTEzMg==", "bodyText": "Is it correct to say that that this can be constructed on the server regardless of whether the wire object is BrokeRequest or PinotQuery. So we need to have 2 converters to be used upon request deserialization on the server side?\n\nBrokerRequest to QueryRequest\nPinotQuery to QueryRequest", "url": "https://github.com/apache/pinot/pull/5483#discussion_r438795132", "createdAt": "2020-06-11T13:45:01Z", "author": {"login": "siddharthteotia"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/request/context/QueryContext.java", "diffHunk": "@@ -0,0 +1,199 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.query.request.context;\n+\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.pinot.common.request.BrokerRequest;\n+\n+\n+/**\n+ * The {@code QueryContext} class encapsulates all the query related information extracted from the wiring Object.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a111e48040063fe4a071e6b84d5de4724290a13"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3NDk1Ng==", "bodyText": "Yes and no. We always use BrokerRequest as the wire object right now, and it has the PinotQuery inside for SQL queries. We only need one converter from BrokerRequest to QueryRequest, but when PinotQuery exists, it will try to convert from PinotQuery.\nWhen we switch the wire object, all we need to do is add a new converter without any change on the query engine", "url": "https://github.com/apache/pinot/pull/5483#discussion_r438974956", "createdAt": "2020-06-11T18:03:03Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/request/context/QueryContext.java", "diffHunk": "@@ -0,0 +1,199 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.query.request.context;\n+\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.pinot.common.request.BrokerRequest;\n+\n+\n+/**\n+ * The {@code QueryContext} class encapsulates all the query related information extracted from the wiring Object.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc5NTEzMg=="}, "originalCommit": {"oid": "9a111e48040063fe4a071e6b84d5de4724290a13"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNTI3NjYwOnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/request/context/FunctionInfo.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMTozNTowNVrOGivfcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwMDowMjowM1rOGiylZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTA4Mjg2Nw==", "bodyText": "what about SCALAR functions", "url": "https://github.com/apache/pinot/pull/5483#discussion_r439082867", "createdAt": "2020-06-11T21:35:05Z", "author": {"login": "kishoreg"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/request/context/FunctionInfo.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.query.request.context;\n+\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Set;\n+\n+\n+/**\n+ * The {@code FunctionInfo} class represents the function in the Expression.\n+ * <p>Pinot currently supports 2 types of functions: Aggregation (e.g. SUM, MAX) and Transform (e.g. ADD, SUB).\n+ */\n+public class FunctionInfo {\n+  public enum Type {\n+    AGGREGATION, TRANSFORM", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a111e48040063fe4a071e6b84d5de4724290a13"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEzMzU0MQ==", "bodyText": "Scalar function is one type of Transform function", "url": "https://github.com/apache/pinot/pull/5483#discussion_r439133541", "createdAt": "2020-06-12T00:02:03Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/request/context/FunctionInfo.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.query.request.context;\n+\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Set;\n+\n+\n+/**\n+ * The {@code FunctionInfo} class represents the function in the Expression.\n+ * <p>Pinot currently supports 2 types of functions: Aggregation (e.g. SUM, MAX) and Transform (e.g. ADD, SUB).\n+ */\n+public class FunctionInfo {\n+  public enum Type {\n+    AGGREGATION, TRANSFORM", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTA4Mjg2Nw=="}, "originalCommit": {"oid": "9a111e48040063fe4a071e6b84d5de4724290a13"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczODM3ODMwOnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/request/context/Function.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxODoyNTowNlrOGjNtZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxODoyNTowNlrOGjNtZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU3Nzk1OQ==", "bodyText": "Same here, please avoid classes with same names.", "url": "https://github.com/apache/pinot/pull/5483#discussion_r439577959", "createdAt": "2020-06-12T18:25:06Z", "author": {"login": "mayankshriv"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/request/context/Function.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.query.request.context;\n+\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Set;\n+\n+\n+/**\n+ * The {@code Function} class represents the function in the Expression.\n+ * <p>Pinot currently supports 2 types of functions: Aggregation (e.g. SUM, MAX) and Transform (e.g. ADD, SUB).\n+ */\n+public class Function {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e570f816ae61d0405d9db2817ffa6e5751a85c3"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczOTE5MTUzOnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/request/context/utils/BrokerRequestToQueryContextConverter.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xM1QwMzo1NDozN1rOGjViXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xM1QwMzo1NDozN1rOGjViXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTcwNjIwNQ==", "bodyText": "I would highly suggest to use a different suffix otherwise we will end up using these package absolute references in this class since this is referring to both query context pojos as well as their thrift counterparts.\nMay be choose \"info\" as the suffix. For the predicate classes that are duplicated, are we going to delete them at some point. I think we need to after query engine starts using predicate from the context. So may be until then let's keep a different name and then start using a suitable names once existing classes are deleted.\nI am not good with names so \"info\" is the suffix that comes to mind.", "url": "https://github.com/apache/pinot/pull/5483#discussion_r439706205", "createdAt": "2020-06-13T03:54:37Z", "author": {"login": "siddharthteotia"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/request/context/utils/BrokerRequestToQueryContextConverter.java", "diffHunk": "@@ -0,0 +1,423 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.query.request.context.utils;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.commons.collections.CollectionUtils;\n+import org.apache.pinot.common.function.AggregationFunctionType;\n+import org.apache.pinot.common.function.FunctionDefinitionRegistry;\n+import org.apache.pinot.common.request.AggregationInfo;\n+import org.apache.pinot.common.request.BrokerRequest;\n+import org.apache.pinot.common.request.ExpressionType;\n+import org.apache.pinot.common.request.FilterOperator;\n+import org.apache.pinot.common.request.GroupBy;\n+import org.apache.pinot.common.request.PinotQuery;\n+import org.apache.pinot.common.request.Selection;\n+import org.apache.pinot.common.request.SelectionSort;\n+import org.apache.pinot.common.utils.request.FilterQueryTree;\n+import org.apache.pinot.common.utils.request.RequestUtils;\n+import org.apache.pinot.core.query.exception.BadQueryRequestException;\n+import org.apache.pinot.core.query.request.context.Expression;\n+import org.apache.pinot.core.query.request.context.Filter;\n+import org.apache.pinot.core.query.request.context.Function;\n+import org.apache.pinot.core.query.request.context.OrderByExpression;\n+import org.apache.pinot.core.query.request.context.QueryContext;\n+import org.apache.pinot.core.query.request.context.predicate.EqPredicate;\n+import org.apache.pinot.core.query.request.context.predicate.InPredicate;\n+import org.apache.pinot.core.query.request.context.predicate.IsNotNullPredicate;\n+import org.apache.pinot.core.query.request.context.predicate.IsNullPredicate;\n+import org.apache.pinot.core.query.request.context.predicate.NotEqPredicate;\n+import org.apache.pinot.core.query.request.context.predicate.NotInPredicate;\n+import org.apache.pinot.core.query.request.context.predicate.RangePredicate;\n+import org.apache.pinot.core.query.request.context.predicate.RegexpLikePredicate;\n+import org.apache.pinot.core.query.request.context.predicate.TextMatchPredicate;\n+import org.apache.pinot.pql.parsers.Pql2Compiler;\n+import org.apache.pinot.pql.parsers.pql2.ast.AstNode;\n+import org.apache.pinot.pql.parsers.pql2.ast.FilterKind;\n+import org.apache.pinot.pql.parsers.pql2.ast.FunctionCallAstNode;\n+import org.apache.pinot.pql.parsers.pql2.ast.IdentifierAstNode;\n+import org.apache.pinot.pql.parsers.pql2.ast.LiteralAstNode;\n+\n+\n+public class BrokerRequestToQueryContextConverter {\n+  private BrokerRequestToQueryContextConverter() {\n+  }\n+\n+  private static final Pql2Compiler PQL_COMPILER = new Pql2Compiler();\n+\n+  /**\n+   * Converts the given BrokerRequest to a QueryContext.\n+   * <p>Use PinotQuery if available to avoid the unnecessary parsing of the expression.\n+   * <p>TODO: We cannot use PinotQuery to generate the {@code filter} because {@code BrokerRequestOptimizer} only\n+   *          optimizes the BrokerRequest but not the PinotQuery.\n+   */\n+  public static QueryContext convertToQueryContext(BrokerRequest brokerRequest) {\n+    PinotQuery pinotQuery = brokerRequest.getPinotQuery();\n+\n+    List<Expression> selectExpressions;\n+    Map<Expression, String> aliasMap;\n+    List<Expression> groupByExpressions = null;\n+    int limit;\n+    int offset = 0;\n+    if (pinotQuery != null) {\n+      aliasMap = new HashMap<>();\n+      List<org.apache.pinot.common.request.Expression> selectList = pinotQuery.getSelectList();\n+      int numExpressions = selectList.size();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ec8a569922f30835592f6ea8ff4b80bb520b719"}, "originalPosition": 85}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4517, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}