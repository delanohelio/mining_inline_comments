{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgxODI5NzQx", "number": 5988, "title": "Fetch Brokers From Controller in JDBC", "bodyText": "Currently, there is no mechanism in JDBC connector to use the correct broker to execute a query.\nThe PR fixes the issue by getting Tenant as property in the JDBC connector and fetching brokers from the controller.", "createdAt": "2020-09-08T07:05:22Z", "url": "https://github.com/apache/pinot/pull/5988", "merged": true, "mergeCommit": {"oid": "b710e0945a5d7058fda6eb1cc3f297a5d017d01f"}, "closed": true, "closedAt": "2020-10-24T15:19:26Z", "author": {"login": "KKcorps"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdGyTNcgFqTQ4Mzg1NDI2MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdU8aMTABqjM5MDczOTM2ODc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzODU0MjYw", "url": "https://github.com/apache/pinot/pull/5988#pullrequestreview-483854260", "createdAt": "2020-09-08T07:14:10Z", "commit": {"oid": "636d8937771d50f0bd5ecd83afbca01891152192"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNzoxNDoxMFrOHOPuEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNzoxNjo0OVrOHOPzvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY5OTY2NQ==", "bodyText": "not needed, you can use the default tenant name and go with it.", "url": "https://github.com/apache/pinot/pull/5988#discussion_r484699665", "createdAt": "2020-09-08T07:14:10Z", "author": {"login": "kishoreg"}, "path": "pinot-clients/pinot-jdbc-client/src/main/java/org/apache/pinot/client/PinotDriver.java", "diffHunk": "@@ -37,16 +38,18 @@\n public class PinotDriver implements Driver {\n   private static final org.slf4j.Logger LOGGER = LoggerFactory.getLogger(PinotDriver.class);\n   private final String SCHEME = \"pinot\";\n+  public static final String TENANT = \"tenant\";\n \n   @Override\n   public Connection connect(String url, Properties info)\n       throws SQLException {\n     try {\n       LOGGER.info(\"Initiating connection to database for url: \" + url);\n       PinotClientTransport pinotClientTransport = new JsonAsyncHttpPinotClientTransportFactory().buildTransport();\n-      List<String> brokerList = DriverUtils.getBrokersFromURL(url);\n       String controllerUrl = DriverUtils.getControllerFromURL(url);\n-      return new PinotConnection(brokerList, controllerUrl, pinotClientTransport);\n+      Preconditions.checkArgument(info.containsKey(TENANT), \"Pinot tenant missing in the properties\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "636d8937771d50f0bd5ecd83afbca01891152192"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDcwMDYyNQ==", "bodyText": "is this called for every connection creation or every query?", "url": "https://github.com/apache/pinot/pull/5988#discussion_r484700625", "createdAt": "2020-09-08T07:15:54Z", "author": {"login": "kishoreg"}, "path": "pinot-clients/pinot-jdbc-client/src/main/java/org/apache/pinot/client/controller/PinotControllerTransport.java", "diffHunk": "@@ -77,13 +76,31 @@ public SchemaResponse getTableSchema(String table, String controllerAddress) {\n       final Future<Response> response =\n           requestBuilder.addHeader(\"Content-Type\", \"application/json; charset=utf-8\").execute();\n \n-      SchemaResponseFuture schemaResponseFuture = new SchemaResponseFuture(response, url);\n+      SchemaResponse.SchemaResponseFuture schemaResponseFuture = new SchemaResponse.SchemaResponseFuture(response, url);\n       return schemaResponseFuture.get();\n     } catch (ExecutionException e) {\n       throw new PinotClientException(e);\n     }\n   }\n \n+  public ControllerTenantBrokerResponse getBrokersFromController(String controllerAddress, String tenant) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "636d8937771d50f0bd5ecd83afbca01891152192"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDcwMTExNg==", "bodyText": "better to get the host name port from instance config instead of the broker name", "url": "https://github.com/apache/pinot/pull/5988#discussion_r484701116", "createdAt": "2020-09-08T07:16:49Z", "author": {"login": "kishoreg"}, "path": "pinot-clients/pinot-jdbc-client/src/main/java/org/apache/pinot/client/controller/response/ControllerTenantBrokerResponse.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.client.controller.response;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectReader;\n+import com.google.common.collect.Lists;\n+import com.ning.http.client.Response;\n+\n+import java.io.IOException;\n+import java.util.*;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+\n+\n+public class ControllerTenantBrokerResponse {\n+  private JsonNode _brokers;\n+\n+  private ControllerTenantBrokerResponse() {\n+\n+  }\n+\n+  private ControllerTenantBrokerResponse(JsonNode controllerTenantBrokerResponse) {\n+    _brokers = controllerTenantBrokerResponse;\n+  }\n+\n+  public static ControllerTenantBrokerResponse fromJson(JsonNode controllerTenantBrokerResponse) {\n+    return new ControllerTenantBrokerResponse(controllerTenantBrokerResponse);\n+  }\n+\n+  public static ControllerTenantBrokerResponse empty() {\n+    return new ControllerTenantBrokerResponse();\n+  }\n+\n+  public List<String> getBrokers() {\n+    List<String> brokerList = new ArrayList<>();\n+\n+    for (JsonNode broker : _brokers) {\n+      String[] brokerPath = broker.textValue().split(\"_\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "636d8937771d50f0bd5ecd83afbca01891152192"}, "originalPosition": 57}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "50f1dfcdb4bc296c55d293312f987331ca7e58a7", "author": {"user": {"login": "KKcorps", "name": "Kartik Khare"}}, "url": "https://github.com/apache/pinot/commit/50f1dfcdb4bc296c55d293312f987331ca7e58a7", "committedDate": "2020-09-08T07:40:18Z", "message": "Use default tenant in case a tenant is not available"}, "afterCommit": {"oid": "1b6b852b63c4c76282e545f67f27371caa6e20c8", "author": {"user": null}, "url": "https://github.com/apache/pinot/commit/1b6b852b63c4c76282e545f67f27371caa6e20c8", "committedDate": "2020-10-13T05:11:44Z", "message": "Fetch hostname from response  rather than split the instance name"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1b6b852b63c4c76282e545f67f27371caa6e20c8", "author": {"user": null}, "url": "https://github.com/apache/pinot/commit/1b6b852b63c4c76282e545f67f27371caa6e20c8", "committedDate": "2020-10-13T05:11:44Z", "message": "Fetch hostname from response  rather than split the instance name"}, "afterCommit": {"oid": "8b29541e14325465eb85473f08076031b4f3d04b", "author": {"user": null}, "url": "https://github.com/apache/pinot/commit/8b29541e14325465eb85473f08076031b4f3d04b", "committedDate": "2020-10-14T07:08:51Z", "message": "Fetch hostname from response  rather than split the instance name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NjQzMzkz", "url": "https://github.com/apache/pinot/pull/5988#pullrequestreview-509643393", "createdAt": "2020-10-15T18:09:13Z", "commit": {"oid": "08232eef3302b29be35e2af4cc3ed40a6605d600"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b204ff91ebd484220142c4262fa24e22d9d00ea3", "author": {"user": {"login": "KKcorps", "name": "Kartik Khare"}}, "url": "https://github.com/apache/pinot/commit/b204ff91ebd484220142c4262fa24e22d9d00ea3", "committedDate": "2020-10-22T05:53:10Z", "message": "Add support to fetch brokers from controller"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce3926030da52049bea48bd619f663521c7ebd49", "author": {"user": {"login": "KKcorps", "name": "Kartik Khare"}}, "url": "https://github.com/apache/pinot/commit/ce3926030da52049bea48bd619f663521c7ebd49", "committedDate": "2020-10-22T05:53:10Z", "message": "Add license header"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e42134395a4de84b13e786f3369e4953e0a7188", "author": {"user": {"login": "KKcorps", "name": "Kartik Khare"}}, "url": "https://github.com/apache/pinot/commit/3e42134395a4de84b13e786f3369e4953e0a7188", "committedDate": "2020-10-22T05:53:10Z", "message": "Use default tenant in case a tenant is not available"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fd05e79ebcf4a2039f726381865d7946b0844d7", "author": {"user": null}, "url": "https://github.com/apache/pinot/commit/6fd05e79ebcf4a2039f726381865d7946b0844d7", "committedDate": "2020-10-22T05:53:10Z", "message": "Fetch hostname from response  rather than split the instance name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f6391573cc5f2a6abecb9f9999145af86b8a50f", "author": {"user": {"login": "KKcorps", "name": "Kartik Khare"}}, "url": "https://github.com/apache/pinot/commit/8f6391573cc5f2a6abecb9f9999145af86b8a50f", "committedDate": "2020-10-22T05:53:10Z", "message": "Bug fix: change API to v2 and fetch proper host name"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "08232eef3302b29be35e2af4cc3ed40a6605d600", "author": {"user": {"login": "KKcorps", "name": "Kartik Khare"}}, "url": "https://github.com/apache/pinot/commit/08232eef3302b29be35e2af4cc3ed40a6605d600", "committedDate": "2020-10-15T12:31:49Z", "message": "Bug fix: change API to v2 and fetch proper host name"}, "afterCommit": {"oid": "8f6391573cc5f2a6abecb9f9999145af86b8a50f", "author": {"user": {"login": "KKcorps", "name": "Kartik Khare"}}, "url": "https://github.com/apache/pinot/commit/8f6391573cc5f2a6abecb9f9999145af86b8a50f", "committedDate": "2020-10-22T05:53:10Z", "message": "Bug fix: change API to v2 and fetch proper host name"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1739, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}