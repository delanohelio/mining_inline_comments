{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3MDkxMTI4", "number": 5856, "title": "[Post-Aggregation] Support post-aggregation in ORDER-BY", "bodyText": "Description\nEnhance TableResizer to support post-aggregation in ORDER-BY clause", "createdAt": "2020-08-13T01:21:07Z", "url": "https://github.com/apache/pinot/pull/5856", "merged": true, "mergeCommit": {"oid": "2d94cb9696223ed949c6c173d0067067f10e82cd"}, "closed": true, "closedAt": "2020-08-17T19:26:14Z", "author": {"login": "Jackie-Jiang"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-6V5iABqjM2NTc1NTAxNDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc_oW2GAFqTQ2ODEyMDYxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3dd5cbe60016e154d7d6e5633b9150086983b693", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/3dd5cbe60016e154d7d6e5633b9150086983b693", "committedDate": "2020-08-13T01:16:43Z", "message": "Support post-aggregation in ORDER-BY"}, "afterCommit": {"oid": "c4c4a015cf94c706c538c153c151a5c8c31f10b4", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/c4c4a015cf94c706c538c153c151a5c8c31f10b4", "committedDate": "2020-08-14T20:06:49Z", "message": "Support post-aggregation in ORDER-BY"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75c686fbf3eafc357ce9e8d85a3aa7b20dcf5c13", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/75c686fbf3eafc357ce9e8d85a3aa7b20dcf5c13", "committedDate": "2020-08-14T20:07:54Z", "message": "Support post-aggregation in ORDER-BY"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c4c4a015cf94c706c538c153c151a5c8c31f10b4", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/c4c4a015cf94c706c538c153c151a5c8c31f10b4", "committedDate": "2020-08-14T20:06:49Z", "message": "Support post-aggregation in ORDER-BY"}, "afterCommit": {"oid": "75c686fbf3eafc357ce9e8d85a3aa7b20dcf5c13", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/75c686fbf3eafc357ce9e8d85a3aa7b20dcf5c13", "committedDate": "2020-08-14T20:07:54Z", "message": "Support post-aggregation in ORDER-BY"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MTIwNjE5", "url": "https://github.com/apache/pinot/pull/5856#pullrequestreview-468120619", "createdAt": "2020-08-17T01:33:11Z", "commit": {"oid": "75c686fbf3eafc357ce9e8d85a3aa7b20dcf5c13"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwMTozMzoxMVrOHBXMFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwMTozNjo0NFrOHBXOkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE5MDU0OQ==", "bodyText": "what does it mean to have ORDER BY a literal? can you give an example?", "url": "https://github.com/apache/pinot/pull/5856#discussion_r471190549", "createdAt": "2020-08-17T01:33:11Z", "author": {"login": "npawar"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/table/TableResizer.java", "diffHunk": "@@ -98,14 +93,37 @@\n     };\n   }\n \n+  /**\n+   * Helper method to construct a OrderByValueExtractor based on the given expression.\n+   */\n+  private OrderByValueExtractor getOrderByValueExtractor(ExpressionContext expression) {\n+    if (expression.getType() == ExpressionContext.Type.LITERAL) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75c686fbf3eafc357ce9e8d85a3aa7b20dcf5c13"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE5MTE4Ng==", "bodyText": "why using assert instead of Preconditions.checkState?", "url": "https://github.com/apache/pinot/pull/5856#discussion_r471191186", "createdAt": "2020-08-17T01:36:44Z", "author": {"login": "npawar"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/table/TableResizer.java", "diffHunk": "@@ -28,66 +28,61 @@\n import java.util.List;\n import java.util.Map;\n import java.util.PriorityQueue;\n-import java.util.function.Function;\n import org.apache.pinot.common.utils.DataSchema;\n+import org.apache.pinot.common.utils.DataSchema.ColumnDataType;\n import org.apache.pinot.core.query.aggregation.function.AggregationFunction;\n+import org.apache.pinot.core.query.postaggregation.PostAggregationFunction;\n+import org.apache.pinot.core.query.request.context.ExpressionContext;\n+import org.apache.pinot.core.query.request.context.FunctionContext;\n import org.apache.pinot.core.query.request.context.OrderByExpressionContext;\n+import org.apache.pinot.core.query.request.context.QueryContext;\n+import org.apache.pinot.spi.utils.ByteArray;\n \n \n /**\n  * Helper class for trimming and sorting records in the IndexedTable, based on the order by information\n  */\n @SuppressWarnings({\"rawtypes\", \"unchecked\"})\n public class TableResizer {\n+  private final DataSchema _dataSchema;\n+  private final int _numGroupByExpressions;\n+  private final Map<ExpressionContext, Integer> _groupByExpressionIndexMap;\n+  private final AggregationFunction[] _aggregationFunctions;\n+  private final Map<FunctionContext, Integer> _aggregationFunctionIndexMap;\n+  private final int _numOrderByExpressions;\n   private final OrderByValueExtractor[] _orderByValueExtractors;\n   private final Comparator<IntermediateRecord> _intermediateRecordComparator;\n-  private final int _numOrderByExpressions;\n \n-  TableResizer(DataSchema dataSchema, AggregationFunction[] aggregationFunctions,\n-      List<OrderByExpressionContext> orderByExpressions) {\n+  public TableResizer(DataSchema dataSchema, QueryContext queryContext) {\n+    _dataSchema = dataSchema;\n \n-    // NOTE: the assumption here is that the key columns will appear before the aggregation columns in the data schema\n-    // This is handled in the only in the AggregationGroupByOrderByOperator for now\n+    // NOTE: The data schema will always have group-by expressions in the front, followed by aggregation functions of\n+    //       the same order as in the query context. This is handled in AggregationGroupByOrderByOperator.\n \n-    int numColumns = dataSchema.size();\n-    int numAggregations = aggregationFunctions.length;\n-    int numKeyColumns = numColumns - numAggregations;\n-\n-    Map<String, Integer> columnIndexMap = new HashMap<>();\n-    Map<String, AggregationFunction> aggregationColumnToFunction = new HashMap<>();\n-    for (int i = 0; i < numColumns; i++) {\n-      String columnName = dataSchema.getColumnName(i);\n-      columnIndexMap.put(columnName, i);\n-      if (i >= numKeyColumns) {\n-        aggregationColumnToFunction.put(columnName, aggregationFunctions[i - numKeyColumns]);\n-      }\n+    List<ExpressionContext> groupByExpressions = queryContext.getGroupByExpressions();\n+    assert groupByExpressions != null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75c686fbf3eafc357ce9e8d85a3aa7b20dcf5c13"}, "originalPosition": 63}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 166, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}