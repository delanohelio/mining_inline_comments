{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3NzEzOTky", "number": 5861, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxODoyMzo1NlrOEYkiHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxODoyOToxM1rOEYksnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0MTk5ODM5OnYy", "diffSide": "RIGHT", "path": "thirdeye/thirdeye-pinot/src/test/java/org/apache/pinot/thirdeye/util/ThirdEyeUtilsTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxODoyMzo1N1rOHA-qJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQyMjoyMTo1MlrOHBEyXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc4ODY0Ng==", "bodyText": "Probably better to compare with absolute difference: abs(actual - expected) < 0.00001. Or better:\nwe can use Assert.assertEquals(actual, expected, delta)", "url": "https://github.com/apache/pinot/pull/5861#discussion_r470788646", "createdAt": "2020-08-14T18:23:57Z", "author": {"login": "Ruoyingw"}, "path": "thirdeye/thirdeye-pinot/src/test/java/org/apache/pinot/thirdeye/util/ThirdEyeUtilsTest.java", "diffHunk": "@@ -176,21 +179,51 @@ public void testExceptionToStringLimited() {\n   }\n \n   @Test\n-  public void testMergeAnomalyProperties() {\n+  public void testMergeAnomalyProperties() throws Exception {\n+    final long now = System.currentTimeMillis();\n+    final long bucketSize = 300_000;\n+    final double parentVal = 1.0, childVal = 2.0;\n+\n     Map<String, String> parentProperties = new HashMap<>();\n     parentProperties.put(\"p1\", \"value1\");\n     parentProperties.put(\"p2\", \"value2\");\n     parentProperties.put(\"detectorComponentName\", \"rule1\");\n+    parentProperties.put(\"anomalyTimelinesView\",\n+        generateAnomalyTimelineView(now, bucketSize, 10, parentVal).toJsonString());\n+\n \n     Map<String, String> childProperties = new HashMap<>();\n     childProperties.put(\"p1\", \"value3\");\n     childProperties.put(\"c1\", \"value4\");\n     childProperties.put(\"detectorComponentName\", \"rule2\");\n+    childProperties.put(\"anomalyTimelinesView\",\n+        generateAnomalyTimelineView(now + bucketSize, bucketSize, 10,  childVal).toJsonString());\n \n     ThirdEyeUtils.mergeAnomalyProperties(parentProperties, childProperties);\n     Assert.assertEquals(parentProperties.get(\"p1\"), \"value1\");\n     Assert.assertEquals(parentProperties.get(\"p2\"), \"value2\");\n     Assert.assertEquals(parentProperties.get(\"c1\"), \"value4\");\n     Assert.assertEquals(parentProperties.get(\"detectorComponentName\"), \"rule1,rule2\");\n+    AnomalyTimelinesView merged = AnomalyTimelinesView.fromJsonString(parentProperties.get(\"anomalyTimelinesView\"));\n+    Assert.assertEquals(merged.getTimeBuckets().size(), 11);\n+    Assert.assertTrue(merged.getCurrentValues().get(0) - parentVal < 0.00001);\n+    Assert.assertTrue(merged.getCurrentValues().get(1) - parentVal < 0.00001);\n+    Assert.assertTrue(merged.getCurrentValues().get(10) - childVal < 0.00001);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad2ea576a5619b708b4f6a0164ffe55af27626bb"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg4OTA1NA==", "bodyText": "Good point.", "url": "https://github.com/apache/pinot/pull/5861#discussion_r470889054", "createdAt": "2020-08-14T22:21:52Z", "author": {"login": "vincentchenjl"}, "path": "thirdeye/thirdeye-pinot/src/test/java/org/apache/pinot/thirdeye/util/ThirdEyeUtilsTest.java", "diffHunk": "@@ -176,21 +179,51 @@ public void testExceptionToStringLimited() {\n   }\n \n   @Test\n-  public void testMergeAnomalyProperties() {\n+  public void testMergeAnomalyProperties() throws Exception {\n+    final long now = System.currentTimeMillis();\n+    final long bucketSize = 300_000;\n+    final double parentVal = 1.0, childVal = 2.0;\n+\n     Map<String, String> parentProperties = new HashMap<>();\n     parentProperties.put(\"p1\", \"value1\");\n     parentProperties.put(\"p2\", \"value2\");\n     parentProperties.put(\"detectorComponentName\", \"rule1\");\n+    parentProperties.put(\"anomalyTimelinesView\",\n+        generateAnomalyTimelineView(now, bucketSize, 10, parentVal).toJsonString());\n+\n \n     Map<String, String> childProperties = new HashMap<>();\n     childProperties.put(\"p1\", \"value3\");\n     childProperties.put(\"c1\", \"value4\");\n     childProperties.put(\"detectorComponentName\", \"rule2\");\n+    childProperties.put(\"anomalyTimelinesView\",\n+        generateAnomalyTimelineView(now + bucketSize, bucketSize, 10,  childVal).toJsonString());\n \n     ThirdEyeUtils.mergeAnomalyProperties(parentProperties, childProperties);\n     Assert.assertEquals(parentProperties.get(\"p1\"), \"value1\");\n     Assert.assertEquals(parentProperties.get(\"p2\"), \"value2\");\n     Assert.assertEquals(parentProperties.get(\"c1\"), \"value4\");\n     Assert.assertEquals(parentProperties.get(\"detectorComponentName\"), \"rule1,rule2\");\n+    AnomalyTimelinesView merged = AnomalyTimelinesView.fromJsonString(parentProperties.get(\"anomalyTimelinesView\"));\n+    Assert.assertEquals(merged.getTimeBuckets().size(), 11);\n+    Assert.assertTrue(merged.getCurrentValues().get(0) - parentVal < 0.00001);\n+    Assert.assertTrue(merged.getCurrentValues().get(1) - parentVal < 0.00001);\n+    Assert.assertTrue(merged.getCurrentValues().get(10) - childVal < 0.00001);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc4ODY0Ng=="}, "originalCommit": {"oid": "ad2ea576a5619b708b4f6a0164ffe55af27626bb"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0MjAyNTI1OnYy", "diffSide": "RIGHT", "path": "thirdeye/thirdeye-pinot/src/test/java/org/apache/pinot/thirdeye/util/ThirdEyeUtilsTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxODoyOToxM1rOHA-7lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQyMjoyMTo0NVrOHBEyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc5MzExMA==", "bodyText": "Can we add another unit test case where the child anomaly has a gap with parent? say\nchildProperties.put(\"anomalyTimelinesView\", generateAnomalyTimelineView(now + bucketSize * 20, bucketSize, 10,  childVal).toJsonString());", "url": "https://github.com/apache/pinot/pull/5861#discussion_r470793110", "createdAt": "2020-08-14T18:29:13Z", "author": {"login": "Ruoyingw"}, "path": "thirdeye/thirdeye-pinot/src/test/java/org/apache/pinot/thirdeye/util/ThirdEyeUtilsTest.java", "diffHunk": "@@ -176,21 +179,51 @@ public void testExceptionToStringLimited() {\n   }\n \n   @Test\n-  public void testMergeAnomalyProperties() {\n+  public void testMergeAnomalyProperties() throws Exception {\n+    final long now = System.currentTimeMillis();\n+    final long bucketSize = 300_000;\n+    final double parentVal = 1.0, childVal = 2.0;\n+\n     Map<String, String> parentProperties = new HashMap<>();\n     parentProperties.put(\"p1\", \"value1\");\n     parentProperties.put(\"p2\", \"value2\");\n     parentProperties.put(\"detectorComponentName\", \"rule1\");\n+    parentProperties.put(\"anomalyTimelinesView\",\n+        generateAnomalyTimelineView(now, bucketSize, 10, parentVal).toJsonString());\n+\n \n     Map<String, String> childProperties = new HashMap<>();\n     childProperties.put(\"p1\", \"value3\");\n     childProperties.put(\"c1\", \"value4\");\n     childProperties.put(\"detectorComponentName\", \"rule2\");\n+    childProperties.put(\"anomalyTimelinesView\",\n+        generateAnomalyTimelineView(now + bucketSize, bucketSize, 10,  childVal).toJsonString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad2ea576a5619b708b4f6a0164ffe55af27626bb"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg4OTAxNQ==", "bodyText": "Added it as a new test.", "url": "https://github.com/apache/pinot/pull/5861#discussion_r470889015", "createdAt": "2020-08-14T22:21:45Z", "author": {"login": "vincentchenjl"}, "path": "thirdeye/thirdeye-pinot/src/test/java/org/apache/pinot/thirdeye/util/ThirdEyeUtilsTest.java", "diffHunk": "@@ -176,21 +179,51 @@ public void testExceptionToStringLimited() {\n   }\n \n   @Test\n-  public void testMergeAnomalyProperties() {\n+  public void testMergeAnomalyProperties() throws Exception {\n+    final long now = System.currentTimeMillis();\n+    final long bucketSize = 300_000;\n+    final double parentVal = 1.0, childVal = 2.0;\n+\n     Map<String, String> parentProperties = new HashMap<>();\n     parentProperties.put(\"p1\", \"value1\");\n     parentProperties.put(\"p2\", \"value2\");\n     parentProperties.put(\"detectorComponentName\", \"rule1\");\n+    parentProperties.put(\"anomalyTimelinesView\",\n+        generateAnomalyTimelineView(now, bucketSize, 10, parentVal).toJsonString());\n+\n \n     Map<String, String> childProperties = new HashMap<>();\n     childProperties.put(\"p1\", \"value3\");\n     childProperties.put(\"c1\", \"value4\");\n     childProperties.put(\"detectorComponentName\", \"rule2\");\n+    childProperties.put(\"anomalyTimelinesView\",\n+        generateAnomalyTimelineView(now + bucketSize, bucketSize, 10,  childVal).toJsonString());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc5MzExMA=="}, "originalCommit": {"oid": "ad2ea576a5619b708b4f6a0164ffe55af27626bb"}, "originalPosition": 37}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3987, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}