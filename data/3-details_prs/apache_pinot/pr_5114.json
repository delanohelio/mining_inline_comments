{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0MDA4ODQ0", "number": 5114, "title": "Bugfixing the issue for ThreadLocal DocIdSet in ExpressionFilterOperator", "bodyText": "Bug fixing for: #5103\nRoot cause is that we use THREAD_LOCAL_DOC_IDS in DocIdSetOperator.\nHowever expression evaluation through ExpressionFilterOperator will construct DocIdSetOperator multiple times with FilterOperator to reset the THREAD_LOCAL_DOC_IDS values.", "createdAt": "2020-03-05T00:52:06Z", "url": "https://github.com/apache/pinot/pull/5114", "merged": true, "mergeCommit": {"oid": "edf1ce6e71dc5d1cc949d212f58ba55cb67b944b"}, "closed": true, "closedAt": "2020-03-05T21:24:20Z", "author": {"login": "xiangfu0"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKglZWAH2gAyMzg0MDA4ODQ0OjgyODMzZjIxYTBjN2I4OGMwMDgzZGYxZDVmOTA2ODNlNDMwY2M0N2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKxxLFgFqTM2OTkwMDI0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "82833f21a0c7b88c0083df1d5f90683e430cc47b", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/82833f21a0c7b88c0083df1d5f90683e430cc47b", "committedDate": "2020-03-05T00:43:08Z", "message": "Bugfixing the issue for ThreadLocal DocIdSet in ExpressionFilterOperator"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MjMyMjQ3", "url": "https://github.com/apache/pinot/pull/5114#pullrequestreview-369232247", "createdAt": "2020-03-05T01:01:42Z", "commit": {"oid": "82833f21a0c7b88c0083df1d5f90683e430cc47b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ca6f5eaf250a89ff07792a97ff7aeebae4e1da4", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/7ca6f5eaf250a89ff07792a97ff7aeebae4e1da4", "committedDate": "2020-03-05T02:39:37Z", "message": "Update bitmap range start/end id"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MjcxOTA4", "url": "https://github.com/apache/pinot/pull/5114#pullrequestreview-369271908", "createdAt": "2020-03-05T03:17:06Z", "commit": {"oid": "7ca6f5eaf250a89ff07792a97ff7aeebae4e1da4"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwMzoxNzowNlrOFyFNEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwMzoxODowOVrOFyFN-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODA1ODM4Ng==", "bodyText": "I would recommend making both endDocId and this exclusive. Currently the numDocsScanned value is incorrect.", "url": "https://github.com/apache/pinot/pull/5114#discussion_r388058386", "createdAt": "2020-03-05T03:17:06Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/operator/filter/ExpressionFilterOperator.java", "diffHunk": "@@ -196,7 +196,7 @@ public BlockDocIdIterator iterator() {\n       int _endDocId;\n       //used only in next() and advance methods\n       int _currentBlockStartDocId = -1;\n-      int _currentBlockEndDocId = 0;\n+      int _currentBlockEndDocId = -1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ca6f5eaf250a89ff07792a97ff7aeebae4e1da4"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODA1ODYxOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                int[] docIds = _threadLocal? THREAD_LOCAL_DOC_IDS.get(): new int[DocIdSetPlanNode.MAX_DOC_PER_CALL];\n          \n          \n            \n                int[] docIds = _threadLocal? THREAD_LOCAL_DOC_IDS.get(): new int[_maxSizeOfDocIdSet];", "url": "https://github.com/apache/pinot/pull/5114#discussion_r388058619", "createdAt": "2020-03-05T03:18:09Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/operator/DocIdSetOperator.java", "diffHunk": "@@ -69,7 +75,7 @@ protected DocIdSetBlock getNextBlock() {\n     }\n \n     int pos = 0;\n-    int[] docIds = THREAD_LOCAL_DOC_IDS.get();\n+    int[] docIds = _threadLocal? THREAD_LOCAL_DOC_IDS.get(): new int[DocIdSetPlanNode.MAX_DOC_PER_CALL];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ca6f5eaf250a89ff07792a97ff7aeebae4e1da4"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "682b8c24e20cf69daab53f5e2fd14b5f96da3c5e", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/682b8c24e20cf69daab53f5e2fd14b5f96da3c5e", "committedDate": "2020-03-05T06:43:32Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5OTAwMjQx", "url": "https://github.com/apache/pinot/pull/5114#pullrequestreview-369900241", "createdAt": "2020-03-05T20:44:23Z", "commit": {"oid": "682b8c24e20cf69daab53f5e2fd14b5f96da3c5e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1337, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}