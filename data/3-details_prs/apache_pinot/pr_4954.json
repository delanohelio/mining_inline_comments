{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU4NzY5NTM4", "number": 4954, "title": "Support schema evolution for consuming segments", "bodyText": "Implement the design in #4225 (comment)\nSupport querying newly added columns in the consuming segment (OFF by default to keep default behavior the same). Currently after updating the schema for a realtime table and calling reload on the table, consuming segments would not be reloaded with the new schema, which would cause consuming segments to be dropped at query time due to schema inconsistency.\nIn this diff, we use the virtual column provider to provide default null values for the newly added columns in the consuming segment (until it is committed), to address the schema inconsistency issue. There is still a delay in indexing and querying the actual values in the newly added columns (up to a few hours, depending on the segment commit thresholds). We will revisit this later.\nThis functionality is off by default for now to keep the default behavior the same.", "createdAt": "2020-01-02T19:38:39Z", "url": "https://github.com/apache/pinot/pull/4954", "merged": true, "mergeCommit": {"oid": "76f9c53b7417417c5fabceccaa124ba371a95417"}, "closed": true, "closedAt": "2020-03-10T18:57:01Z", "author": {"login": "haibow"}, "timelineItems": {"totalCount": 43, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb2fGIyABqjI5MTg1OTg5Njg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMXN8MgFqTM3MjIzNTgyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f7fd6a864983323ab47311c02ae8207ea13375e0", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/f7fd6a864983323ab47311c02ae8207ea13375e0", "committedDate": "2019-12-31T01:51:19Z", "message": "Support schema evolution for consuming segments"}, "afterCommit": {"oid": "62d90a19cc5ecf9b606f6036fc801de4314029e5", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/62d90a19cc5ecf9b606f6036fc801de4314029e5", "committedDate": "2020-01-02T19:40:24Z", "message": "Support schema evolution for consuming segments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "62d90a19cc5ecf9b606f6036fc801de4314029e5", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/62d90a19cc5ecf9b606f6036fc801de4314029e5", "committedDate": "2020-01-02T19:40:24Z", "message": "Support schema evolution for consuming segments"}, "afterCommit": {"oid": "360ef90f19da8fdd48bd95d90d16a17aca87817d", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/360ef90f19da8fdd48bd95d90d16a17aca87817d", "committedDate": "2020-01-02T21:08:47Z", "message": "Support schema evolution for consuming segments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "360ef90f19da8fdd48bd95d90d16a17aca87817d", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/360ef90f19da8fdd48bd95d90d16a17aca87817d", "committedDate": "2020-01-02T21:08:47Z", "message": "Support schema evolution for consuming segments"}, "afterCommit": {"oid": "aa70cd698567aba7873c0220cd6da552d51f6cda", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/aa70cd698567aba7873c0220cd6da552d51f6cda", "committedDate": "2020-01-02T22:46:01Z", "message": "Support schema evolution for consuming segments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aa70cd698567aba7873c0220cd6da552d51f6cda", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/aa70cd698567aba7873c0220cd6da552d51f6cda", "committedDate": "2020-01-02T22:46:01Z", "message": "Support schema evolution for consuming segments"}, "afterCommit": {"oid": "4974c9f3e67e32d305ab4fd4fd17a348360e8895", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/4974c9f3e67e32d305ab4fd4fd17a348360e8895", "committedDate": "2020-01-02T22:52:48Z", "message": "Support schema evolution for consuming segments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4974c9f3e67e32d305ab4fd4fd17a348360e8895", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/4974c9f3e67e32d305ab4fd4fd17a348360e8895", "committedDate": "2020-01-02T22:52:48Z", "message": "Support schema evolution for consuming segments"}, "afterCommit": {"oid": "9947e3d25d7863b7e6e4afc6e5d3a44fd8a4550e", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/9947e3d25d7863b7e6e4afc6e5d3a44fd8a4550e", "committedDate": "2020-01-06T21:49:05Z", "message": "Support schema evolution for consuming segments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4OTgyNDEx", "url": "https://github.com/apache/pinot/pull/4954#pullrequestreview-338982411", "createdAt": "2020-01-07T01:02:11Z", "commit": {"oid": "9947e3d25d7863b7e6e4afc6e5d3a44fd8a4550e"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwMTowMjoxMVrOFatdlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwMToyOToyMFrOFatzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU1MjE1MA==", "bodyText": "We have two APIs, one named getColumnNames() and the other named getPhysicalColumnNames().  select * should decide which one to use? Do we need a third one? Why can't getPhysicalColumnNames API return the right set of columns from the consuming segment?", "url": "https://github.com/apache/pinot/pull/4954#discussion_r363552150", "createdAt": "2020-01-07T01:02:11Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/IndexSegment.java", "diffHunk": "@@ -57,6 +58,13 @@\n    */\n   Set<String> getPhysicalColumnNames();\n \n+  /**\n+   * Returns all columns for the \"select *\" query\n+   *\n+   * @return Set of column names\n+   */\n+  Set<String> getColumnNamesForSelectStar();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9947e3d25d7863b7e6e4afc6e5d3a44fd8a4550e"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU1MzA3MQ==", "bodyText": "Given that we dont have a member called _newSchema, why rename this? Can we keep it as _schema?", "url": "https://github.com/apache/pinot/pull/4954#discussion_r363553071", "createdAt": "2020-01-07T01:06:48Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImpl.java", "diffHunk": "@@ -80,9 +84,9 @@\n   private final long _startTimeMillis = System.currentTimeMillis();\n \n   private final String _segmentName;\n-  private final Schema _schema;\n+  private final Schema _originalSchema;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9947e3d25d7863b7e6e4afc6e5d3a44fd8a4550e"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU1MzE3Mg==", "bodyText": "Same here. Why rename?", "url": "https://github.com/apache/pinot/pull/4954#discussion_r363553172", "createdAt": "2020-01-07T01:07:21Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImpl.java", "diffHunk": "@@ -80,9 +84,9 @@\n   private final long _startTimeMillis = System.currentTimeMillis();\n \n   private final String _segmentName;\n-  private final Schema _schema;\n+  private final Schema _originalSchema;\n   private final int _capacity;\n-  private final SegmentMetadata _segmentMetadata;\n+  private final SegmentMetadata _originalSegmentMetadata;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9947e3d25d7863b7e6e4afc6e5d3a44fd8a4550e"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU1MzY1NQ==", "bodyText": "Just call the reload API on the segment, and let the segment decide if it is to be reloaded (i.e. depending on the config), and also how it should do it.", "url": "https://github.com/apache/pinot/pull/4954#discussion_r363553655", "createdAt": "2020-01-07T01:09:55Z", "author": {"login": "mcvsubbu"}, "path": "pinot-server/src/main/java/org/apache/pinot/server/starter/helix/HelixInstanceDataManager.java", "diffHunk": "@@ -194,7 +198,17 @@ private void reloadSegment(String tableNameWithType, SegmentMetadata segmentMeta\n \n     File indexDir = segmentMetadata.getIndexDir();\n     if (indexDir == null) {\n-      LOGGER.info(\"Skip reloading REALTIME consuming segment: {} in table: {}\", segmentName, tableNameWithType);\n+      if (!_instanceDataManagerConfig.shouldReloadConsumingSegment()) {\n+        LOGGER.info(\"Skip reloading REALTIME consuming segment: {} in table: {}\", segmentName, tableNameWithType);\n+        return;\n+      }\n+      LOGGER.info(\"Try reloading REALTIME consuming segment: {} in table: {}\", segmentName, tableNameWithType);\n+      SegmentMetadataImpl segmentMetadataImpl = (SegmentMetadataImpl) segmentMetadata;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9947e3d25d7863b7e6e4afc6e5d3a44fd8a4550e"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU1NDQ4NQ==", "bodyText": "remove this. We already have _logger", "url": "https://github.com/apache/pinot/pull/4954#discussion_r363554485", "createdAt": "2020-01-07T01:14:08Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImpl.java", "diffHunk": "@@ -68,6 +71,7 @@\n \n \n public class MutableSegmentImpl implements MutableSegment {\n+  private static final Logger LOGGER = LoggerFactory.getLogger(MutableSegmentImpl.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9947e3d25d7863b7e6e4afc6e5d3a44fd8a4550e"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU1NTMyMQ==", "bodyText": "Let us think of a better name for this", "url": "https://github.com/apache/pinot/pull/4954#discussion_r363555321", "createdAt": "2020-01-07T01:17:46Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/io/reader/impl/SameMultiValueInvertedIndex.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.io.reader.impl;\n+\n+import java.io.IOException;\n+import org.apache.pinot.common.utils.Pairs;\n+import org.apache.pinot.core.io.reader.BaseSingleColumnMultiValueReader;\n+import org.apache.pinot.core.io.reader.impl.v1.FixedBitMultiValueReader;\n+\n+\n+/**\n+ * Reader for the multi-value column with the same value\n+ */\n+public class SameMultiValueInvertedIndex extends BaseSingleColumnMultiValueReader<FixedBitMultiValueReader.Context> implements SortedIndexMultiValueReader<FixedBitMultiValueReader.Context> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9947e3d25d7863b7e6e4afc6e5d3a44fd8a4550e"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU1NjgwMQ==", "bodyText": "LOGGER  can be configured to log the class name, line number, etc. so we should not be logging class name", "url": "https://github.com/apache/pinot/pull/4954#discussion_r363556801", "createdAt": "2020-01-07T01:24:30Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/pruner/SegmentPrunerService.java", "diffHunk": "@@ -52,7 +52,7 @@ public SegmentPrunerService(SegmentPrunerConfig config) {\n   public boolean prune(IndexSegment segment, ServerQueryRequest queryRequest) {\n     for (SegmentPruner segmentPruner : _segmentPruners) {\n       if (segmentPruner.prune(segment, queryRequest)) {\n-        LOGGER.debug(\"Pruned segment: {}\", segment.getSegmentName());\n+        LOGGER.debug(\"{} pruned segment: {}\", segmentPruner.getClass().getName(), segment.getSegmentName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9947e3d25d7863b7e6e4afc6e5d3a44fd8a4550e"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU1NzY4OA==", "bodyText": "no other changes here? why touch this file?", "url": "https://github.com/apache/pinot/pull/4954#discussion_r363557688", "createdAt": "2020-01-07T01:29:20Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/index/SegmentMetadataImpl.java", "diffHunk": "@@ -43,19 +43,19 @@\n import org.apache.commons.configuration.ConfigurationException;\n import org.apache.commons.configuration.PropertiesConfiguration;\n import org.apache.commons.lang.StringEscapeUtils;\n-import org.apache.pinot.spi.data.MetricFieldSpec;\n-import org.apache.pinot.spi.data.Schema;\n import org.apache.pinot.common.metadata.segment.RealtimeSegmentZKMetadata;\n import org.apache.pinot.common.segment.SegmentMetadata;\n import org.apache.pinot.common.segment.StarTreeMetadata;\n-import org.apache.pinot.spi.utils.JsonUtils;\n-import org.apache.pinot.spi.utils.TimeUtils;\n import org.apache.pinot.core.indexsegment.generator.SegmentVersion;\n import org.apache.pinot.core.segment.creator.impl.V1Constants;\n import org.apache.pinot.core.segment.creator.impl.V1Constants.MetadataKeys;\n import org.apache.pinot.core.segment.store.SegmentDirectoryPaths;\n import org.apache.pinot.core.startree.v2.StarTreeV2Constants;\n import org.apache.pinot.core.startree.v2.StarTreeV2Metadata;\n+import org.apache.pinot.spi.data.MetricFieldSpec;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9947e3d25d7863b7e6e4afc6e5d3a44fd8a4550e"}, "originalPosition": 17}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9947e3d25d7863b7e6e4afc6e5d3a44fd8a4550e", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/9947e3d25d7863b7e6e4afc6e5d3a44fd8a4550e", "committedDate": "2020-01-06T21:49:05Z", "message": "Support schema evolution for consuming segments"}, "afterCommit": {"oid": "b1bce2ef9e3da1af5740b7895d918cc87c3cfef2", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/b1bce2ef9e3da1af5740b7895d918cc87c3cfef2", "committedDate": "2020-01-07T19:59:30Z", "message": "remove duplicate logger"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMTYyMjc0", "url": "https://github.com/apache/pinot/pull/4954#pullrequestreview-340162274", "createdAt": "2020-01-08T21:39:46Z", "commit": {"oid": "b1bce2ef9e3da1af5740b7895d918cc87c3cfef2"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQyMTozOTo0NlrOFbkpng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQyMjoxMTozNlrOFfQ5jQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ1NjM1MA==", "bodyText": "I would prefer to leave the names as is, and rename the new fields as _columnsAddedDuringConsumption or something like that. We can wait for others to chime in before we rename stuff", "url": "https://github.com/apache/pinot/pull/4954#discussion_r364456350", "createdAt": "2020-01-08T21:39:46Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImpl.java", "diffHunk": "@@ -80,9 +84,9 @@\n   private final long _startTimeMillis = System.currentTimeMillis();\n \n   private final String _segmentName;\n-  private final Schema _schema;\n+  private final Schema _originalSchema;\n   private final int _capacity;\n-  private final SegmentMetadata _segmentMetadata;\n+  private final SegmentMetadata _originalSegmentMetadata;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU1MzE3Mg=="}, "originalCommit": {"oid": "9947e3d25d7863b7e6e4afc6e5d3a44fd8a4550e"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMyNDE5Nw==", "bodyText": "Newly added columns should not be included in virtual column provider. You need a new provider for these columns.", "url": "https://github.com/apache/pinot/pull/4954#discussion_r368324197", "createdAt": "2020-01-19T21:27:45Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/IndexSegment.java", "diffHunk": "@@ -57,6 +58,13 @@\n    */\n   Set<String> getPhysicalColumnNames();\n \n+  /**\n+   * Returns all columns for the \"select *\" query\n+   *\n+   * @return Set of column names\n+   */\n+  Set<String> getColumnNamesForSelectStar();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU1MjE1MA=="}, "originalCommit": {"oid": "9947e3d25d7863b7e6e4afc6e5d3a44fd8a4550e"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMyNDM0MA==", "bodyText": "Should be info log", "url": "https://github.com/apache/pinot/pull/4954#discussion_r368324340", "createdAt": "2020-01-19T21:30:02Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImpl.java", "diffHunk": "@@ -252,6 +258,16 @@ public long getMaxTime() {\n     return _maxTime;\n   }\n \n+  public void addExtraColumns(Schema newSchema,\n+      Map<String, BaseDefaultColumnHandler.DefaultColumnAction> defaultColumnActionMap) {\n+    defaultColumnActionMap.forEach(((columnName, defaultColumnAction) -> {\n+      if (defaultColumnAction.isAddAction() && !newSchema.getFieldSpecFor(columnName).isVirtualColumn()) {\n+        _newlyAddedColumnsFieldMap.put(columnName, newSchema.getFieldSpecFor(columnName));\n+      }\n+    }));\n+    _logger.debug(\"Newly added columns: \" + _newlyAddedColumnsFieldMap.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "996893163cfabf2923a5cd48431f32ba36479866"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMyNTM5NA==", "bodyText": "I think we should remove the DefaultColumnAction here. We know that there is only one thing we can do -- add columns with a default value. The only argument needed here is newSchema", "url": "https://github.com/apache/pinot/pull/4954#discussion_r368325394", "createdAt": "2020-01-19T21:46:15Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImpl.java", "diffHunk": "@@ -252,6 +258,16 @@ public long getMaxTime() {\n     return _maxTime;\n   }\n \n+  public void addExtraColumns(Schema newSchema,\n+      Map<String, BaseDefaultColumnHandler.DefaultColumnAction> defaultColumnActionMap) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "996893163cfabf2923a5cd48431f32ba36479866"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMyNjM0Ng==", "bodyText": "We should have a different column provider here that should be optimized better than the virtual column provider. The new column provider should not be built every time, but should stay in memory once built. What  may be updated is the number of rows. That will minimize additional allocation during query processing.\nAdd a new column provider factory (say, ConstantValueColumnProviderFactory) that has a map from the col name to the provider. The map is built lazily as columns are added to the query.", "url": "https://github.com/apache/pinot/pull/4954#discussion_r368326346", "createdAt": "2020-01-19T22:01:15Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImpl.java", "diffHunk": "@@ -467,13 +483,22 @@ public SegmentMetadata getSegmentMetadata() {\n     return physicalColumnNames;\n   }\n \n+  @Override\n+  public Set<String> getColumnNamesForSelectStar() {\n+    return Sets.union(getPhysicalColumnNames(), _newlyAddedColumnsFieldMap.keySet());\n+  }\n+\n   @Override\n   public ColumnDataSource getDataSource(String columnName) {\n     FieldSpec fieldSpec = _schema.getFieldSpecFor(columnName);\n-    if (fieldSpec.isVirtualColumn()) {\n+    if ((fieldSpec == null && _newlyAddedColumnsFieldMap.containsKey(columnName)) || fieldSpec.isVirtualColumn()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "996893163cfabf2923a5cd48431f32ba36479866"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMyNjQ2OQ==", "bodyText": "In that case, this logic is best handled like:\nif (fieldSpec != null) {\n  if (fieldSpec.isVirtualColumn()) {\n    // process virtual column from schema\n  } else {\n    // process real column from schema\n  }\n} else {\n  // process newly added column using the new provider factory\n}", "url": "https://github.com/apache/pinot/pull/4954#discussion_r368326469", "createdAt": "2020-01-19T22:03:11Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImpl.java", "diffHunk": "@@ -467,13 +483,22 @@ public SegmentMetadata getSegmentMetadata() {\n     return physicalColumnNames;\n   }\n \n+  @Override\n+  public Set<String> getColumnNamesForSelectStar() {\n+    return Sets.union(getPhysicalColumnNames(), _newlyAddedColumnsFieldMap.keySet());\n+  }\n+\n   @Override\n   public ColumnDataSource getDataSource(String columnName) {\n     FieldSpec fieldSpec = _schema.getFieldSpecFor(columnName);\n-    if (fieldSpec.isVirtualColumn()) {\n+    if ((fieldSpec == null && _newlyAddedColumnsFieldMap.containsKey(columnName)) || fieldSpec.isVirtualColumn()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMyNjM0Ng=="}, "originalCommit": {"oid": "996893163cfabf2923a5cd48431f32ba36479866"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMyNjU1Mg==", "bodyText": "Constant is another alternative", "url": "https://github.com/apache/pinot/pull/4954#discussion_r368326552", "createdAt": "2020-01-19T22:04:30Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/io/reader/impl/SameMultiValueInvertedIndex.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.io.reader.impl;\n+\n+import java.io.IOException;\n+import org.apache.pinot.common.utils.Pairs;\n+import org.apache.pinot.core.io.reader.BaseSingleColumnMultiValueReader;\n+import org.apache.pinot.core.io.reader.impl.v1.FixedBitMultiValueReader;\n+\n+\n+/**\n+ * Reader for the multi-value column with the same value\n+ */\n+public class SameMultiValueInvertedIndex extends BaseSingleColumnMultiValueReader<FixedBitMultiValueReader.Context> implements SortedIndexMultiValueReader<FixedBitMultiValueReader.Context> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU1NTMyMQ=="}, "originalCommit": {"oid": "9947e3d25d7863b7e6e4afc6e5d3a44fd8a4550e"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMyNzA1Mw==", "bodyText": "I would bypass the references to DefaultColumnAction class altogether. Since we have a handle to the mutable index, just call the addExtraColumns API with the new schema. Just make sure that API handles well if we call it multiple times, either with same set of columns or newer ones than the previous time.\nAgreed with your observation that this is the reload API. It makes me think that reload API should be implemented as a part of the segment API, but that is a HUGE change, and I am not sure what else is involved there (and why it was done this way as a static method like ImmutableSegment.reload()).  So, let us not go into that.", "url": "https://github.com/apache/pinot/pull/4954#discussion_r368327053", "createdAt": "2020-01-19T22:11:36Z", "author": {"login": "mcvsubbu"}, "path": "pinot-server/src/main/java/org/apache/pinot/server/starter/helix/HelixInstanceDataManager.java", "diffHunk": "@@ -194,7 +198,17 @@ private void reloadSegment(String tableNameWithType, SegmentMetadata segmentMeta\n \n     File indexDir = segmentMetadata.getIndexDir();\n     if (indexDir == null) {\n-      LOGGER.info(\"Skip reloading REALTIME consuming segment: {} in table: {}\", segmentName, tableNameWithType);\n+      if (!_instanceDataManagerConfig.shouldReloadConsumingSegment()) {\n+        LOGGER.info(\"Skip reloading REALTIME consuming segment: {} in table: {}\", segmentName, tableNameWithType);\n+        return;\n+      }\n+      LOGGER.info(\"Try reloading REALTIME consuming segment: {} in table: {}\", segmentName, tableNameWithType);\n+      SegmentMetadataImpl segmentMetadataImpl = (SegmentMetadataImpl) segmentMetadata;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU1MzY1NQ=="}, "originalCommit": {"oid": "9947e3d25d7863b7e6e4afc6e5d3a44fd8a4550e"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1MDM3MzEx", "url": "https://github.com/apache/pinot/pull/4954#pullrequestreview-345037311", "createdAt": "2020-01-19T23:58:22Z", "commit": {"oid": "996893163cfabf2923a5cd48431f32ba36479866"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d880f2b2704c21ad2f2e09a70c2682bc6cd4355", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/2d880f2b2704c21ad2f2e09a70c2682bc6cd4355", "committedDate": "2020-01-23T01:08:51Z", "message": "address comments"}, "afterCommit": {"oid": "9e16c73072980666f24f16b252328f8f4f9c78b8", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/9e16c73072980666f24f16b252328f8f4f9c78b8", "committedDate": "2020-01-23T08:30:15Z", "message": "cache virtual column provider"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MTI1NzQ3", "url": "https://github.com/apache/pinot/pull/4954#pullrequestreview-347125747", "createdAt": "2020-01-23T08:33:31Z", "commit": {"oid": "9e16c73072980666f24f16b252328f8f4f9c78b8"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9e16c73072980666f24f16b252328f8f4f9c78b8", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/9e16c73072980666f24f16b252328f8f4f9c78b8", "committedDate": "2020-01-23T08:30:15Z", "message": "cache virtual column provider"}, "afterCommit": {"oid": "0654400296c49a179840ed2cc935e646d447d466", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/0654400296c49a179840ed2cc935e646d447d466", "committedDate": "2020-01-23T08:40:20Z", "message": "cache virtual column provider"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MTI1MDk1", "url": "https://github.com/apache/pinot/pull/4954#pullrequestreview-357125095", "createdAt": "2020-02-12T00:55:22Z", "commit": {"oid": "0654400296c49a179840ed2cc935e646d447d466"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMDo1NToyMlrOFoeghQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMDo1Nzo1MFrOFoejTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk4NzIwNQ==", "bodyText": "Why are we treating newly added columns as virtual?", "url": "https://github.com/apache/pinot/pull/4954#discussion_r377987205", "createdAt": "2020-02-12T00:55:22Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/IndexSegment.java", "diffHunk": "@@ -57,6 +58,13 @@\n    */\n   Set<String> getPhysicalColumnNames();\n \n+  /**\n+   * Returns all columns for the \"select *\" query\n+   *\n+   * @return Set of column names\n+   */\n+  Set<String> getColumnNamesForSelectStar();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU1MjE1MA=="}, "originalCommit": {"oid": "9947e3d25d7863b7e6e4afc6e5d3a44fd8a4550e"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk4NzY2Mg==", "bodyText": "Not sure why DefaultColumnAction is needed here. We can just iterate through the schema and add a newly added column's FieldSpec if it is not there already. The FieldSpec can have the null value. There is no question of handling incompatible schema evolution at that point.", "url": "https://github.com/apache/pinot/pull/4954#discussion_r377987662", "createdAt": "2020-02-12T00:56:49Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImpl.java", "diffHunk": "@@ -299,6 +311,23 @@ public long getMaxTime() {\n     return _maxTime;\n   }\n \n+  public void addExtraColumns(Schema newSchema) {\n+    Map<String, BaseDefaultColumnHandler.DefaultColumnAction> defaultColumnActionMap =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0654400296c49a179840ed2cc935e646d447d466"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk4NzkxNw==", "bodyText": "We need to do this only if the newly added column is a virtual column, right?", "url": "https://github.com/apache/pinot/pull/4954#discussion_r377987917", "createdAt": "2020-02-12T00:57:50Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImpl.java", "diffHunk": "@@ -521,15 +550,38 @@ public SegmentMetadata getSegmentMetadata() {\n     return physicalColumnNames;\n   }\n \n+  @Override\n+  public Set<String> getColumnNamesForSelectStar() {\n+    return Sets.union(getPhysicalColumnNames(), _newlyAddedColumnsFieldMap.keySet());\n+  }\n+\n   @Override\n   public ColumnDataSource getDataSource(String columnName) {\n     FieldSpec fieldSpec = _schema.getFieldSpecFor(columnName);\n-    if (fieldSpec.isVirtualColumn()) {\n+    if (fieldSpec == null || fieldSpec.isVirtualColumn()) {\n+      // Column is either added during ingestion, or was initiated with a virtual column provider\n+      if (fieldSpec == null) {\n+        // If the column was added during ingestion, we will construct the virtual column provider based on its fieldSpec\n+        fieldSpec = _newlyAddedColumnsFieldMap.get(columnName);\n+        Preconditions.checkNotNull(fieldSpec, \"FieldSpec for \" + columnName + \" should not be null\");\n+      }\n       VirtualColumnContext virtualColumnContext = new VirtualColumnContext(fieldSpec, _numDocsIndexed);\n-      VirtualColumnProvider virtualColumnProvider =\n-          VirtualColumnProviderFactory.buildProvider(_schema.getFieldSpecFor(columnName).getVirtualColumnProvider());\n-      return new ColumnDataSource(virtualColumnProvider.buildColumnIndexContainer(virtualColumnContext),\n-          virtualColumnProvider.buildMetadata(virtualColumnContext));\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0654400296c49a179840ed2cc935e646d447d466"}, "originalPosition": 145}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0654400296c49a179840ed2cc935e646d447d466", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/0654400296c49a179840ed2cc935e646d447d466", "committedDate": "2020-01-23T08:40:20Z", "message": "cache virtual column provider"}, "afterCommit": {"oid": "dcd99e2f47361df3ac6c6aad416ee2b97e544cce", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/dcd99e2f47361df3ac6c6aad416ee2b97e544cce", "committedDate": "2020-02-19T22:51:09Z", "message": "Refactor column provider"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cd9e9151014c382a6d5667d69e1112f59ce9de42", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/cd9e9151014c382a6d5667d69e1112f59ce9de42", "committedDate": "2020-02-19T23:43:01Z", "message": "Simplify addExtraColumns"}, "afterCommit": {"oid": "e234e90c8da53d0daecf1f807f95d580bf3ee99c", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/e234e90c8da53d0daecf1f807f95d580bf3ee99c", "committedDate": "2020-02-20T23:41:32Z", "message": "Refactor column provider"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MzI5MTAx", "url": "https://github.com/apache/pinot/pull/4954#pullrequestreview-365329101", "createdAt": "2020-02-26T23:55:12Z", "commit": {"oid": "e234e90c8da53d0daecf1f807f95d580bf3ee99c"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMzo1NToxMlrOFvAqnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwMToxODo1M1rOFvCMOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgzODMwMA==", "bodyText": "please update the comment, not always construct virtual column provider, but dependng on the new column type -- whether virtual or physical column", "url": "https://github.com/apache/pinot/pull/4954#discussion_r384838300", "createdAt": "2020-02-26T23:55:12Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImpl.java", "diffHunk": "@@ -555,12 +575,27 @@ public SegmentMetadata getSegmentMetadata() {\n   @Override\n   public ColumnDataSource getDataSource(String columnName) {\n     FieldSpec fieldSpec = _schema.getFieldSpecFor(columnName);\n-    if (fieldSpec.isVirtualColumn()) {\n-      VirtualColumnContext virtualColumnContext = new VirtualColumnContext(fieldSpec, _numDocsIndexed);\n-      VirtualColumnProvider virtualColumnProvider =\n-          VirtualColumnProviderFactory.buildProvider(_schema.getFieldSpecFor(columnName).getVirtualColumnProvider());\n-      return new ColumnDataSource(virtualColumnProvider.buildColumnIndexContainer(virtualColumnContext),\n-          virtualColumnProvider.buildMetadata(virtualColumnContext));\n+    if (fieldSpec == null || fieldSpec.isVirtualColumn()) {\n+      // Column is either added during ingestion, or was initiated with a virtual column provider\n+      if (fieldSpec == null) {\n+        // If the column was added during ingestion, we will construct the virtual column provider based on its fieldSpec", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e234e90c8da53d0daecf1f807f95d580bf3ee99c"}, "originalPosition": 123}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg1Nzc5Mg==", "bodyText": "Should we be using PluginClassLoader here?", "url": "https://github.com/apache/pinot/pull/4954#discussion_r384857792", "createdAt": "2020-02-27T00:59:12Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/virtualcolumn/ColumnProviderFactory.java", "diffHunk": "@@ -20,18 +20,29 @@\n \n import org.apache.pinot.common.utils.CommonConstants.Segment.BuiltInVirtualColumn;\n import org.apache.pinot.common.utils.NetUtil;\n+import org.apache.pinot.core.segment.index.column.ColumnContext;\n+import org.apache.pinot.core.segment.index.column.ColumnProvider;\n+import org.apache.pinot.core.segment.index.column.DefaultNullValueColumnProvider;\n import org.apache.pinot.spi.data.DimensionFieldSpec;\n import org.apache.pinot.spi.data.FieldSpec;\n import org.apache.pinot.spi.data.Schema;\n \n \n /**\n- * Factory for virtual column providers.\n+ * Factory for column providers.\n  */\n-public class VirtualColumnProviderFactory {\n-  public static VirtualColumnProvider buildProvider(String virtualColumnProvider) {\n+public class ColumnProviderFactory {\n+  public static ColumnProvider buildProvider(ColumnContext columnContext) {\n+    String virtualColumnProvider = columnContext.getFieldSpec().getVirtualColumnProvider();\n     try {\n-      return (VirtualColumnProvider) Class.forName(virtualColumnProvider).newInstance();\n+      // Use the preset virtualColumnProvider if available\n+      if (virtualColumnProvider != null && !virtualColumnProvider\n+          .equals(DefaultNullValueColumnProvider.class.getName())) {\n+        return (ColumnProvider) Class.forName(virtualColumnProvider).newInstance();\n+      }\n+      // Create the columnProvider that returns default null values based on the columnContext\n+      return DefaultNullValueColumnProvider.class.getDeclaredConstructor(ColumnContext.class)\n+          .newInstance(columnContext);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e234e90c8da53d0daecf1f807f95d580bf3ee99c"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg1ODk1MQ==", "bodyText": "Can we do theese things inside the Column ProviderFFactory so that we dont need to cast here?", "url": "https://github.com/apache/pinot/pull/4954#discussion_r384858951", "createdAt": "2020-02-27T01:03:15Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImpl.java", "diffHunk": "@@ -555,12 +575,27 @@ public SegmentMetadata getSegmentMetadata() {\n   @Override\n   public ColumnDataSource getDataSource(String columnName) {\n     FieldSpec fieldSpec = _schema.getFieldSpecFor(columnName);\n-    if (fieldSpec.isVirtualColumn()) {\n-      VirtualColumnContext virtualColumnContext = new VirtualColumnContext(fieldSpec, _numDocsIndexed);\n-      VirtualColumnProvider virtualColumnProvider =\n-          VirtualColumnProviderFactory.buildProvider(_schema.getFieldSpecFor(columnName).getVirtualColumnProvider());\n-      return new ColumnDataSource(virtualColumnProvider.buildColumnIndexContainer(virtualColumnContext),\n-          virtualColumnProvider.buildMetadata(virtualColumnContext));\n+    if (fieldSpec == null || fieldSpec.isVirtualColumn()) {\n+      // Column is either added during ingestion, or was initiated with a virtual column provider\n+      if (fieldSpec == null) {\n+        // If the column was added during ingestion, we will construct the virtual column provider based on its fieldSpec\n+        fieldSpec = _newlyAddedColumnsFieldMap.get(columnName);\n+        Preconditions.checkNotNull(fieldSpec, \"FieldSpec for \" + columnName + \" should not be null\");\n+      }\n+      ColumnContext columnContext = new ColumnContext(fieldSpec, _numDocsIndexed);\n+      ColumnProvider columnProvider = _newlyAddedColumnsProviderMap.getOrDefault(columnName, ColumnProviderFactory.buildProvider(columnContext));\n+      if (columnProvider instanceof DefaultNullValueColumnProvider) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e234e90c8da53d0daecf1f807f95d580bf3ee99c"}, "originalPosition": 129}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg2MDAwMQ==", "bodyText": "we can just get physical column names, right? Are we trying to say that virtual columns that do not start with dollar sign are ok?", "url": "https://github.com/apache/pinot/pull/4954#discussion_r384860001", "createdAt": "2020-02-27T01:07:08Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/plan/TransformPlanNode.java", "diffHunk": "@@ -83,7 +83,11 @@ private void extractColumnsAndTransforms(BrokerRequest brokerRequest, IndexSegme\n       // Extract selection expressions\n       List<String> selectionColumns = selection.getSelectionColumns();\n       if (selectionColumns.size() == 1 && selectionColumns.get(0).equals(\"*\")) {\n-        for (String column : indexSegment.getPhysicalColumnNames()) {\n+        for (String column : indexSegment.getColumnNames()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e234e90c8da53d0daecf1f807f95d580bf3ee99c"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg2MTA0MA==", "bodyText": "Since column context already contains the number of rows, we can call update inverted index right here", "url": "https://github.com/apache/pinot/pull/4954#discussion_r384861040", "createdAt": "2020-02-27T01:10:39Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/index/column/DefaultNullValueColumnProvider.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.segment.index.column;\n+\n+import com.google.common.base.Preconditions;\n+import org.apache.pinot.core.io.reader.impl.ConstantMultiValueInvertedIndex;\n+import org.apache.pinot.core.io.reader.impl.ConstantSingleValueInvertedIndex;\n+import org.apache.pinot.core.segment.index.ColumnMetadata;\n+import org.apache.pinot.core.segment.index.readers.Dictionary;\n+import org.apache.pinot.core.segment.index.readers.SingleDoubleDictionary;\n+import org.apache.pinot.core.segment.index.readers.SingleFloatDictionary;\n+import org.apache.pinot.core.segment.index.readers.SingleIntDictionary;\n+import org.apache.pinot.core.segment.index.readers.SingleLongDictionary;\n+import org.apache.pinot.core.segment.index.readers.SingleStringDictionary;\n+import org.apache.pinot.spi.data.FieldSpec;\n+import org.apache.pinot.spi.data.FieldSpec.DataType;\n+\n+\n+/**\n+ * Provide the default null value.\n+ */\n+public class DefaultNullValueColumnProvider extends BaseColumnProvider {\n+\n+  Dictionary _dictionary;\n+  ColumnMetadata _columnMetadata;\n+\n+  public DefaultNullValueColumnProvider(ColumnContext columnContext) {\n+    buildDictionary(columnContext);\n+    buildMetadata(columnContext);\n+    buildColumnIndexContainer(columnContext);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e234e90c8da53d0daecf1f807f95d580bf3ee99c"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg2MTg4OQ==", "bodyText": "Not sure if we still need to modify this class. It should remain the same for the completed segments, right?", "url": "https://github.com/apache/pinot/pull/4954#discussion_r384861889", "createdAt": "2020-02-27T01:13:37Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/index/loader/defaultcolumn/BaseDefaultColumnHandler.java", "diffHunk": "@@ -155,27 +155,37 @@ public void updateDefaultColumns()\n    *\n    * @return Action Map for each column.\n    */\n-  private Map<String, DefaultColumnAction> computeDefaultColumnActionMap() {\n+  public static Map<String, DefaultColumnAction> computeDefaultColumnActionMap(Schema schema,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e234e90c8da53d0daecf1f807f95d580bf3ee99c"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg2MjQ3MQ==", "bodyText": "the name seems like oxymoron :), but I cannot think of a better name. @Jackie-Jiang ?\nConstantValueDoubleDictionary?", "url": "https://github.com/apache/pinot/pull/4954#discussion_r384862471", "createdAt": "2020-02-27T01:15:52Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/index/readers/SingleDoubleDictionary.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.segment.index.readers;\n+\n+/**\n+ * Dictionary for single-value double\n+ */\n+\n+public class SingleDoubleDictionary extends BaseImmutableDictionary {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e234e90c8da53d0daecf1f807f95d580bf3ee99c"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg2MzI4OQ==", "bodyText": "Where are you releasing the segment?", "url": "https://github.com/apache/pinot/pull/4954#discussion_r384863289", "createdAt": "2020-02-27T01:18:53Z", "author": {"login": "mcvsubbu"}, "path": "pinot-server/src/main/java/org/apache/pinot/server/starter/helix/HelixInstanceDataManager.java", "diffHunk": "@@ -197,7 +201,15 @@ private void reloadSegment(String tableNameWithType, SegmentMetadata segmentMeta\n \n     File indexDir = segmentMetadata.getIndexDir();\n     if (indexDir == null) {\n-      LOGGER.info(\"Skip reloading REALTIME consuming segment: {} in table: {}\", segmentName, tableNameWithType);\n+      if (!_instanceDataManagerConfig.shouldReloadConsumingSegment()) {\n+        LOGGER.info(\"Skip reloading REALTIME consuming segment: {} in table: {}\", segmentName, tableNameWithType);\n+        return;\n+      }\n+      LOGGER.info(\"Try reloading REALTIME consuming segment: {} in table: {}\", segmentName, tableNameWithType);\n+      SegmentMetadataImpl segmentMetadataImpl = (SegmentMetadataImpl) segmentMetadata;\n+      MutableSegmentImpl mutableSegment = (MutableSegmentImpl) (_tableDataManagerMap.get(tableNameWithType)\n+          .acquireSegment(segmentMetadataImpl.getName()).getSegment());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e234e90c8da53d0daecf1f807f95d580bf3ee99c"}, "originalPosition": 32}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e234e90c8da53d0daecf1f807f95d580bf3ee99c", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/e234e90c8da53d0daecf1f807f95d580bf3ee99c", "committedDate": "2020-02-20T23:41:32Z", "message": "Refactor column provider"}, "afterCommit": {"oid": "b3536a1346ba09601389f044669d260326e4f69e", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/b3536a1346ba09601389f044669d260326e4f69e", "committedDate": "2020-02-28T02:15:02Z", "message": "Address review"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b3536a1346ba09601389f044669d260326e4f69e", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/b3536a1346ba09601389f044669d260326e4f69e", "committedDate": "2020-02-28T02:15:02Z", "message": "Address review"}, "afterCommit": {"oid": "19ad031ba7034bc6fd9b2f96e20ac7062aedd9a9", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/19ad031ba7034bc6fd9b2f96e20ac7062aedd9a9", "committedDate": "2020-02-28T04:36:32Z", "message": "Address review"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "19ad031ba7034bc6fd9b2f96e20ac7062aedd9a9", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/19ad031ba7034bc6fd9b2f96e20ac7062aedd9a9", "committedDate": "2020-02-28T04:36:32Z", "message": "Address review"}, "afterCommit": {"oid": "0fb657b15fd0d0b6f791ba2ea11bf2c708659506", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/0fb657b15fd0d0b6f791ba2ea11bf2c708659506", "committedDate": "2020-02-28T06:22:43Z", "message": "Address review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NDQ0MzMz", "url": "https://github.com/apache/pinot/pull/4954#pullrequestreview-368444333", "createdAt": "2020-03-04T01:18:19Z", "commit": {"oid": "0fb657b15fd0d0b6f791ba2ea11bf2c708659506"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwMToxODoyMFrOFxczYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwMTozMjozM1rOFxdHJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM5NjQ1MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private volatile Map<String, FieldSpec> _newlyAddedColumnsFieldMap = new ConcurrentHashMap();\n          \n          \n            \n              private final Map<String, FieldSpec> _newlyAddedColumnsFieldMap = new ConcurrentHashMap();", "url": "https://github.com/apache/pinot/pull/4954#discussion_r387396450", "createdAt": "2020-03-04T01:18:20Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImpl.java", "diffHunk": "@@ -125,6 +128,9 @@\n   private volatile long _latestIngestionTimeMs = Long.MIN_VALUE;\n \n   private RealtimeLuceneReaders _realtimeLuceneReaders;\n+  // If the table schema is changed before the consuming segment is committed, newly added columns would appear in _newlyAddedColumnsFieldMap.\n+  private volatile Map<String, FieldSpec> _newlyAddedColumnsFieldMap = new ConcurrentHashMap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fb657b15fd0d0b6f791ba2ea11bf2c708659506"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM5NjU5MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private volatile Map<String, ColumnProvider> _newlyAddedColumnsProviderMap = new ConcurrentHashMap<>();\n          \n          \n            \n              private final Map<String, ColumnProvider> _newlyAddedColumnsProviderMap = new ConcurrentHashMap<>();", "url": "https://github.com/apache/pinot/pull/4954#discussion_r387396591", "createdAt": "2020-03-04T01:18:33Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImpl.java", "diffHunk": "@@ -125,6 +128,9 @@\n   private volatile long _latestIngestionTimeMs = Long.MIN_VALUE;\n \n   private RealtimeLuceneReaders _realtimeLuceneReaders;\n+  // If the table schema is changed before the consuming segment is committed, newly added columns would appear in _newlyAddedColumnsFieldMap.\n+  private volatile Map<String, FieldSpec> _newlyAddedColumnsFieldMap = new ConcurrentHashMap();\n+  private volatile Map<String, ColumnProvider> _newlyAddedColumnsProviderMap = new ConcurrentHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fb657b15fd0d0b6f791ba2ea11bf2c708659506"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM5Njc0NA==", "bodyText": "You don't need volatile. You never set these values again in the class.", "url": "https://github.com/apache/pinot/pull/4954#discussion_r387396744", "createdAt": "2020-03-04T01:18:47Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImpl.java", "diffHunk": "@@ -125,6 +128,9 @@\n   private volatile long _latestIngestionTimeMs = Long.MIN_VALUE;\n \n   private RealtimeLuceneReaders _realtimeLuceneReaders;\n+  // If the table schema is changed before the consuming segment is committed, newly added columns would appear in _newlyAddedColumnsFieldMap.\n+  private volatile Map<String, FieldSpec> _newlyAddedColumnsFieldMap = new ConcurrentHashMap();\n+  private volatile Map<String, ColumnProvider> _newlyAddedColumnsProviderMap = new ConcurrentHashMap<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM5NjU5MQ=="}, "originalCommit": {"oid": "0fb657b15fd0d0b6f791ba2ea11bf2c708659506"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM5ODUxNQ==", "bodyText": "What if newly introduced column is a virtual column?", "url": "https://github.com/apache/pinot/pull/4954#discussion_r387398515", "createdAt": "2020-03-04T01:21:45Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImpl.java", "diffHunk": "@@ -546,19 +561,32 @@ public SegmentMetadata getSegmentMetadata() {\n     for (FieldSpec fieldSpec : _physicalFieldSpecs) {\n       physicalColumnNames.add(fieldSpec.getName());\n     }\n-\n-    return physicalColumnNames;\n+    // We should include newly added columns in the physical columns", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fb657b15fd0d0b6f791ba2ea11bf2c708659506"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM5OTk2Ng==", "bodyText": "Why cache it? We construct it afresh for each query in the offline case, this should not be worse than that, right?", "url": "https://github.com/apache/pinot/pull/4954#discussion_r387399966", "createdAt": "2020-03-04T01:27:06Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImpl.java", "diffHunk": "@@ -555,12 +575,27 @@ public SegmentMetadata getSegmentMetadata() {\n   @Override\n   public ColumnDataSource getDataSource(String columnName) {\n     FieldSpec fieldSpec = _schema.getFieldSpecFor(columnName);\n-    if (fieldSpec.isVirtualColumn()) {\n-      VirtualColumnContext virtualColumnContext = new VirtualColumnContext(fieldSpec, _numDocsIndexed);\n-      VirtualColumnProvider virtualColumnProvider =\n-          VirtualColumnProviderFactory.buildProvider(_schema.getFieldSpecFor(columnName).getVirtualColumnProvider());\n-      return new ColumnDataSource(virtualColumnProvider.buildColumnIndexContainer(virtualColumnContext),\n-          virtualColumnProvider.buildMetadata(virtualColumnContext));\n+    if (fieldSpec == null || fieldSpec.isVirtualColumn()) {\n+      // Column is either added during ingestion, or was initiated with a virtual column provider\n+      if (fieldSpec == null) {\n+        // If the column was added during ingestion, we will construct the virtual column provider based on its fieldSpec\n+        fieldSpec = _newlyAddedColumnsFieldMap.get(columnName);\n+        Preconditions.checkNotNull(fieldSpec, \"FieldSpec for \" + columnName + \" should not be null\");\n+      }\n+      ColumnContext columnContext = new ColumnContext(fieldSpec, _numDocsIndexed);\n+      ColumnProvider columnProvider = _newlyAddedColumnsProviderMap.getOrDefault(columnName, ColumnProviderFactory.buildProvider(columnContext));\n+      if (columnProvider instanceof DefaultNullValueColumnProvider) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg1ODk1MQ=="}, "originalCommit": {"oid": "e234e90c8da53d0daecf1f807f95d580bf3ee99c"}, "originalPosition": 129}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQwMDg3Ng==", "bodyText": "Are these new imports needed?", "url": "https://github.com/apache/pinot/pull/4954#discussion_r387400876", "createdAt": "2020-03-04T01:30:27Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/index/ColumnMetadata.java", "diffHunk": "@@ -39,7 +39,27 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import static org.apache.pinot.core.segment.creator.impl.V1Constants.MetadataKeys.Column.*;\n+import static org.apache.pinot.core.segment.creator.impl.V1Constants.MetadataKeys.Column.BITS_PER_ELEMENT;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fb657b15fd0d0b6f791ba2ea11bf2c708659506"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQwMTUwOQ==", "bodyText": "Hmm... ok, we rebuild this column provider everytime in the offline world, but yes. maybe caching can help (but, as you note, we need to update the inverted index, and later, any other auto-generated index if need be).", "url": "https://github.com/apache/pinot/pull/4954#discussion_r387401509", "createdAt": "2020-03-04T01:32:33Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/index/column/DefaultNullValueColumnProvider.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.segment.index.column;\n+\n+import com.google.common.base.Preconditions;\n+import org.apache.pinot.core.io.reader.impl.ConstantMultiValueInvertedIndex;\n+import org.apache.pinot.core.io.reader.impl.ConstantSingleValueInvertedIndex;\n+import org.apache.pinot.core.segment.index.ColumnMetadata;\n+import org.apache.pinot.core.segment.index.readers.Dictionary;\n+import org.apache.pinot.core.segment.index.readers.SingleDoubleDictionary;\n+import org.apache.pinot.core.segment.index.readers.SingleFloatDictionary;\n+import org.apache.pinot.core.segment.index.readers.SingleIntDictionary;\n+import org.apache.pinot.core.segment.index.readers.SingleLongDictionary;\n+import org.apache.pinot.core.segment.index.readers.SingleStringDictionary;\n+import org.apache.pinot.spi.data.FieldSpec;\n+import org.apache.pinot.spi.data.FieldSpec.DataType;\n+\n+\n+/**\n+ * Provide the default null value.\n+ */\n+public class DefaultNullValueColumnProvider extends BaseColumnProvider {\n+\n+  Dictionary _dictionary;\n+  ColumnMetadata _columnMetadata;\n+\n+  public DefaultNullValueColumnProvider(ColumnContext columnContext) {\n+    buildDictionary(columnContext);\n+    buildMetadata(columnContext);\n+    buildColumnIndexContainer(columnContext);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg2MTA0MA=="}, "originalCommit": {"oid": "e234e90c8da53d0daecf1f807f95d580bf3ee99c"}, "originalPosition": 46}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c0a06d6e1a72b2f757124c20cbfe62d9a852ced2", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/c0a06d6e1a72b2f757124c20cbfe62d9a852ced2", "committedDate": "2020-03-05T05:22:40Z", "message": "Address comments"}, "afterCommit": {"oid": "c122eecb53150e9d6fe1d3f528fba28c01849de1", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/c122eecb53150e9d6fe1d3f528fba28c01849de1", "committedDate": "2020-03-05T07:07:50Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5OTM3NTcw", "url": "https://github.com/apache/pinot/pull/4954#pullrequestreview-369937570", "createdAt": "2020-03-05T21:44:58Z", "commit": {"oid": "c122eecb53150e9d6fe1d3f528fba28c01849de1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMTo0NDo1OFrOFylSWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMTo0NDo1OFrOFylSWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU4NDAyNw==", "bodyText": "you need deeper equals definition, make sure that the inverted index obects are equal. etc.", "url": "https://github.com/apache/pinot/pull/4954#discussion_r388584027", "createdAt": "2020-03-05T21:44:58Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/index/ColumnMetadata.java", "diffHunk": "@@ -540,4 +560,31 @@ public String toString() {\n \n     return result.toString();\n   }\n+\n+  @Override\n+  public boolean equals(Object object) {\n+    if (this == object) {\n+      return true;\n+    }\n+    if (object instanceof ColumnMetadata) {\n+      ColumnMetadata columnMetadata = (ColumnMetadata) object;\n+      return getColumnName() == columnMetadata.getColumnName() && getCardinality() == columnMetadata.getCardinality()\n+          && getTotalDocs() == columnMetadata.getTotalDocs() && getDataType().equals(columnMetadata.getDataType())\n+          && getBitsPerElement() == columnMetadata.getBitsPerElement() && getFieldSpec()\n+          .equals(columnMetadata.getFieldSpec()) && isSorted() == columnMetadata.isSorted()\n+          && hasNulls() == columnMetadata.hasNulls() && hasDictionary() == columnMetadata.hasDictionary()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c122eecb53150e9d6fe1d3f528fba28c01849de1"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNzUyMTM1", "url": "https://github.com/apache/pinot/pull/4954#pullrequestreview-370752135", "createdAt": "2020-03-07T16:21:26Z", "commit": {"oid": "c122eecb53150e9d6fe1d3f528fba28c01849de1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNDQ1ODYw", "url": "https://github.com/apache/pinot/pull/4954#pullrequestreview-371445860", "createdAt": "2020-03-09T18:55:39Z", "commit": {"oid": "c122eecb53150e9d6fe1d3f528fba28c01849de1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxODo1NTozOVrOFz1Ugw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxODo1NTozOVrOFz1Ugw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg5NTI5OQ==", "bodyText": "Can we revert this class name change? Seems it is not used in this pr?", "url": "https://github.com/apache/pinot/pull/4954#discussion_r389895299", "createdAt": "2020-03-09T18:55:39Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/RealtimeTableDataManager.java", "diffHunk": "@@ -51,7 +51,7 @@\n import org.apache.pinot.core.realtime.impl.RealtimeSegmentStatsHistory;\n import org.apache.pinot.core.segment.index.loader.IndexLoadingConfig;\n import org.apache.pinot.core.segment.index.loader.LoaderUtils;\n-import org.apache.pinot.core.segment.virtualcolumn.VirtualColumnProviderFactory;\n+import org.apache.pinot.core.segment.virtualcolumn.ColumnProviderFactory;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c122eecb53150e9d6fe1d3f528fba28c01849de1"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNDY3Mjgx", "url": "https://github.com/apache/pinot/pull/4954#pullrequestreview-371467281", "createdAt": "2020-03-09T19:28:47Z", "commit": {"oid": "c122eecb53150e9d6fe1d3f528fba28c01849de1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxOToyODo0OFrOFz2WYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxOTozMDo0NlrOFz2aNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkxMjE2Mg==", "bodyText": "Multi-value column inverted index should be bitmap based, and it can never to sorted.", "url": "https://github.com/apache/pinot/pull/4954#discussion_r389912162", "createdAt": "2020-03-09T19:28:48Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/io/reader/impl/ConstantMultiValueInvertedIndex.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.io.reader.impl;\n+\n+import java.io.IOException;\n+import org.apache.pinot.common.utils.Pairs;\n+import org.apache.pinot.core.io.reader.BaseSingleColumnMultiValueReader;\n+import org.apache.pinot.core.io.reader.impl.v1.FixedBitMultiValueReader;\n+\n+\n+/**\n+ * Reader for the multi-value column with the constant value\n+ */\n+public class ConstantMultiValueInvertedIndex extends BaseSingleColumnMultiValueReader<FixedBitMultiValueReader.Context> implements SortedIndexMultiValueReader<FixedBitMultiValueReader.Context> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c122eecb53150e9d6fe1d3f528fba28c01849de1"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkxMjgzNQ==", "bodyText": "Please revert this and all related renaming", "url": "https://github.com/apache/pinot/pull/4954#discussion_r389912835", "createdAt": "2020-03-09T19:30:08Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/io/reader/impl/v1/SortedIndexSingleValueReader.java", "diffHunk": "@@ -28,7 +28,7 @@\n /**\n  * Interface for sorted index readers.\n  */\n-public interface SortedIndexReader<T extends ReaderContext> extends SingleColumnSingleValueReader<T>, InvertedIndexReader<Pairs.IntPair> {\n+public interface SortedIndexSingleValueReader<T extends ReaderContext> extends SingleColumnSingleValueReader<T>, InvertedIndexReader<Pairs.IntPair> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c122eecb53150e9d6fe1d3f528fba28c01849de1"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkxMzE0MQ==", "bodyText": "Please remove this as multi-value column can never be sorted", "url": "https://github.com/apache/pinot/pull/4954#discussion_r389913141", "createdAt": "2020-03-09T19:30:46Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/io/reader/impl/SortedIndexMultiValueReader.java", "diffHunk": "@@ -16,13 +16,32 @@\n  * specific language governing permissions and limitations\n  * under the License.\n  */\n-package org.apache.pinot.core.segment.virtualcolumn;\n+package org.apache.pinot.core.io.reader.impl;\n+\n+import java.io.IOException;\n+import org.apache.pinot.common.utils.Pairs;\n+import org.apache.pinot.core.io.reader.ReaderContext;\n+import org.apache.pinot.core.io.reader.SingleColumnMultiValueReader;\n+import org.apache.pinot.core.segment.index.readers.InvertedIndexReader;\n+\n \n /**\n- * Provide the default null value as a single string.\n+ * Interface for sorted index multi-value readers.\n  */\n-public class DefaultNullValueSingleStringVirtualColumnProvider extends SingleStringVirtualColumnProvider {\n-  protected String getValue(VirtualColumnContext context) {\n-    return context.getFieldSpec().getDefaultNullValue().toString();\n-  }\n+public interface SortedIndexMultiValueReader<T extends ReaderContext> extends SingleColumnMultiValueReader<T>, InvertedIndexReader<Pairs.IntPair> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c122eecb53150e9d6fe1d3f528fba28c01849de1"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec98d2e7a40bbd539b0dae0bdf9c3265d75f9153", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/ec98d2e7a40bbd539b0dae0bdf9c3265d75f9153", "committedDate": "2020-03-09T20:58:45Z", "message": "Support schema evolution for consuming segments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0befa330678358fcacef6b90a8a0672b217a6c5", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/d0befa330678358fcacef6b90a8a0672b217a6c5", "committedDate": "2020-03-09T20:58:45Z", "message": "remove duplicate logger"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85eada633445d45562ee55036a074e05ef4d3380", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/85eada633445d45562ee55036a074e05ef4d3380", "committedDate": "2020-03-09T20:58:45Z", "message": "revert renaming"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efe6cf86b8596c1df1dbd26e2c79e47dd9dca4de", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/efe6cf86b8596c1df1dbd26e2c79e47dd9dca4de", "committedDate": "2020-03-09T20:58:45Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f41e08de06cb54cb55eea7f6d57f8a855214cb56", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/f41e08de06cb54cb55eea7f6d57f8a855214cb56", "committedDate": "2020-03-09T20:58:45Z", "message": "cache virtual column provider"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a38bac97b361550025d4c5438fde1f5f1213280d", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/a38bac97b361550025d4c5438fde1f5f1213280d", "committedDate": "2020-03-09T20:58:45Z", "message": "Refactor column provider"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "428e5d86873d182840af6feef4436f0805d48a0a", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/428e5d86873d182840af6feef4436f0805d48a0a", "committedDate": "2020-03-09T20:58:45Z", "message": "Address review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f6c1a5683207c9242850a33bf9a52cd17790498", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/9f6c1a5683207c9242850a33bf9a52cd17790498", "committedDate": "2020-03-09T20:58:45Z", "message": "Update MutableSegmentImpl\n\nCo-Authored-By: Subbu Subramaniam <mcvsubbu@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa67ab2039e7bc4e8ddf859038579304d211a698", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/aa67ab2039e7bc4e8ddf859038579304d211a698", "committedDate": "2020-03-09T20:58:45Z", "message": "Update MutableSegmentImpl\n\nCo-Authored-By: Subbu Subramaniam <mcvsubbu@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4fdae29e672b2db14df52adfebb4f7d359c4428", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/e4fdae29e672b2db14df52adfebb4f7d359c4428", "committedDate": "2020-03-09T20:58:45Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1de9377f3e86ebeda77a8711b539634b6c51959", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/f1de9377f3e86ebeda77a8711b539634b6c51959", "committedDate": "2020-03-09T20:58:45Z", "message": "Revert some renaming"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a4761ffbc5cc705e2223a561c5f85e8956e91689", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/a4761ffbc5cc705e2223a561c5f85e8956e91689", "committedDate": "2020-03-09T20:38:37Z", "message": "Revert some renaming"}, "afterCommit": {"oid": "d943a07e816123772c4210595b6748c4b4d15749", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/d943a07e816123772c4210595b6748c4b4d15749", "committedDate": "2020-03-09T21:07:54Z", "message": "Undo more renaming"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d943a07e816123772c4210595b6748c4b4d15749", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/d943a07e816123772c4210595b6748c4b4d15749", "committedDate": "2020-03-09T21:07:54Z", "message": "Undo more renaming"}, "afterCommit": {"oid": "31d616533cc4f880604fc241d372762d97549481", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/31d616533cc4f880604fc241d372762d97549481", "committedDate": "2020-03-09T21:19:58Z", "message": "Undo more renaming"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNTc3NDM0", "url": "https://github.com/apache/pinot/pull/4954#pullrequestreview-371577434", "createdAt": "2020-03-09T22:44:41Z", "commit": {"oid": "31d616533cc4f880604fc241d372762d97549481"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMjo0NDo0MVrOFz71mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMjo0NDo0MVrOFz71mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAwMjA3NQ==", "bodyText": "Can we revert this as well? Seems only used in the test", "url": "https://github.com/apache/pinot/pull/4954#discussion_r390002075", "createdAt": "2020-03-09T22:44:41Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/index/loader/defaultcolumn/BaseDefaultColumnHandler.java", "diffHunk": "@@ -164,16 +164,16 @@ public void updateDefaultColumns(IndexLoadingConfig indexLoadingConfig)\n    *\n    * @return Action Map for each column.\n    */\n-  private Map<String, DefaultColumnAction> computeDefaultColumnActionMap() {\n+  static Map<String, DefaultColumnAction> computeDefaultColumnActionMap(Schema schema, SegmentMetadataImpl segmentMetadata) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d616533cc4f880604fc241d372762d97549481"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "31d616533cc4f880604fc241d372762d97549481", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/31d616533cc4f880604fc241d372762d97549481", "committedDate": "2020-03-09T21:19:58Z", "message": "Undo more renaming"}, "afterCommit": {"oid": "e0c0c7dcead630b38f436663eb367e59bee28ac5", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/e0c0c7dcead630b38f436663eb367e59bee28ac5", "committedDate": "2020-03-09T23:47:24Z", "message": "Undo more renaming"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb331bfdc2baac9b2ec74ff065116ac8f3c53c72", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/cb331bfdc2baac9b2ec74ff065116ac8f3c53c72", "committedDate": "2020-03-10T07:56:53Z", "message": "Undo more renaming"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6ebab1ba05567b0658f90a6df47d842a59fa01e1", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/6ebab1ba05567b0658f90a6df47d842a59fa01e1", "committedDate": "2020-03-10T07:56:13Z", "message": "update"}, "afterCommit": {"oid": "cb331bfdc2baac9b2ec74ff065116ac8f3c53c72", "author": {"user": {"login": "haibow", "name": null}}, "url": "https://github.com/apache/pinot/commit/cb331bfdc2baac9b2ec74ff065116ac8f3c53c72", "committedDate": "2020-03-10T07:56:53Z", "message": "Undo more renaming"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMjM1ODI5", "url": "https://github.com/apache/pinot/pull/4954#pullrequestreview-372235829", "createdAt": "2020-03-10T18:56:13Z", "commit": {"oid": "cb331bfdc2baac9b2ec74ff065116ac8f3c53c72"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1413, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}