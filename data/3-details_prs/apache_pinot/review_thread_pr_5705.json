{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5MTc2MDY5", "number": 5705, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNzo1NzoyNVrOEOy5tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjo1NToyN1rOEO5haA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzOTQ5NDk0OnYy", "diffSide": "RIGHT", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/SingleConnectionBrokerRequestHandler.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNzo1NzoyNVrOGyJekQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNzo1NzoyNVrOGyJekQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIzNzI2NQ==", "bodyText": "Avoid static import.", "url": "https://github.com/apache/pinot/pull/5705#discussion_r455237265", "createdAt": "2020-07-15T17:57:25Z", "author": {"login": "mayankshriv"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/SingleConnectionBrokerRequestHandler.java", "diffHunk": "@@ -47,6 +49,8 @@\n import org.apache.pinot.spi.env.PinotConfiguration;\n import org.apache.pinot.spi.utils.builder.TableNameBuilder;\n \n+import static org.apache.pinot.common.exception.QueryException.BROKER_REQUEST_SEND_ERROR_CODE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "054d65245cbcc2d304e062d145a7ca844218d114"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0MDU3MDQ2OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/transport/AsyncQueryResponse.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjo1MToxMlrOGyT_4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjo1MToxMlrOGyT_4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQwOTYzMw==", "bodyText": "(nit) Package private?", "url": "https://github.com/apache/pinot/pull/5705#discussion_r455409633", "createdAt": "2020-07-15T22:51:12Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/transport/AsyncQueryResponse.java", "diffHunk": "@@ -105,4 +107,12 @@ void markServerDown(ServerRoutingInstance serverRoutingInstance) {\n       markQueryFailed();\n     }\n   }\n+\n+  public Exception getBrokerRequestSendException() {\n+    return _brokerRequestSendException;\n+  }\n+\n+  public void setBrokerRequestSendException(Exception brokerRequestSendException) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "054d65245cbcc2d304e062d145a7ca844218d114"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0MDU3Mjk0OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/transport/AsyncQueryResponse.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjo1MjoxNlrOGyUBdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQyMDoyNzowOFrOGy7iRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxMDAzOQ==", "bodyText": "Make it volatile? (Although it is always set and read by the same thread)", "url": "https://github.com/apache/pinot/pull/5705#discussion_r455410039", "createdAt": "2020-07-15T22:52:16Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/transport/AsyncQueryResponse.java", "diffHunk": "@@ -39,6 +39,8 @@\n   private final CountDownLatch _countDownLatch;\n   private final long _maxEndTimeMs;\n \n+  private Exception _brokerRequestSendException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "054d65245cbcc2d304e062d145a7ca844218d114"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA1NzQxNA==", "bodyText": "Good suggestion. Being on same thread might change in future due to some refactoring and it's good to have it as volatile.", "url": "https://github.com/apache/pinot/pull/5705#discussion_r456057414", "createdAt": "2020-07-16T20:27:08Z", "author": {"login": "sajjad-moradi"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/transport/AsyncQueryResponse.java", "diffHunk": "@@ -39,6 +39,8 @@\n   private final CountDownLatch _countDownLatch;\n   private final long _maxEndTimeMs;\n \n+  private Exception _brokerRequestSendException;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxMDAzOQ=="}, "originalCommit": {"oid": "054d65245cbcc2d304e062d145a7ca844218d114"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0MDU3NzI3OnYy", "diffSide": "RIGHT", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/SingleConnectionBrokerRequestHandler.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjo1NDoyNlrOGyUEJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjo1NDoyNlrOGyUEJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxMDcyNA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (asyncQueryResponse.getBrokerRequestSendException() != null) {\n          \n          \n            \n                  String errorMsg = QueryException.getTruncatedStackTrace(asyncQueryResponse.getBrokerRequestSendException());\n          \n          \n            \n                  brokerResponse.addToExceptions(new QueryProcessingException(BROKER_REQUEST_SEND_ERROR_CODE, errorMsg));\n          \n          \n            \n                }\n          \n          \n            \n                Exception brokerRequestSendException = asyncQueryResponse.getBrokerRequestSendException();\n          \n          \n            \n                if (brokerRequestSendException != null) {\n          \n          \n            \n                  brokerResponse.addToExceptions(new QueryProcessingException(BROKER_REQUEST_SEND_ERROR_CODE, brokerRequestSendException));\n          \n          \n            \n                }", "url": "https://github.com/apache/pinot/pull/5705#discussion_r455410724", "createdAt": "2020-07-15T22:54:26Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/SingleConnectionBrokerRequestHandler.java", "diffHunk": "@@ -114,6 +118,10 @@ protected BrokerResponse processBrokerRequest(long requestId, BrokerRequest orig\n     brokerResponse.setNumServersQueried(numServersQueried);\n     brokerResponse.setNumServersResponded(numServersResponded);\n \n+    if (asyncQueryResponse.getBrokerRequestSendException() != null) {\n+      String errorMsg = QueryException.getTruncatedStackTrace(asyncQueryResponse.getBrokerRequestSendException());\n+      brokerResponse.addToExceptions(new QueryProcessingException(BROKER_REQUEST_SEND_ERROR_CODE, errorMsg));\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "054d65245cbcc2d304e062d145a7ca844218d114"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0MDU3OTYwOnYy", "diffSide": "RIGHT", "path": "pinot-common/src/main/java/org/apache/pinot/common/exception/QueryException.java", "isResolved": false, "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjo1NToyN1rOGyUFhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNTozNjo0NFrOG0ozOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxMTA3Nw==", "bodyText": "Not sure if we should expose this method", "url": "https://github.com/apache/pinot/pull/5705#discussion_r455411077", "createdAt": "2020-07-15T22:55:27Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/exception/QueryException.java", "diffHunk": "@@ -125,8 +126,17 @@ public static void setMaxLinesOfStackTrace(int maxLinesOfStackTrace) {\n   }\n \n   public static ProcessingException getException(ProcessingException processingException, Exception exception) {\n+    return getException(processingException, getTruncatedStackTrace(exception));\n+  }\n+\n+  public static ProcessingException getException(ProcessingException processingException, String errorMessage) {\n     String errorType = processingException.getMessage();\n     ProcessingException copiedProcessingException = processingException.deepCopy();\n+    copiedProcessingException.setMessage(errorType + \":\\n\" + errorMessage);\n+    return copiedProcessingException;\n+  }\n+\n+  public static String getTruncatedStackTrace(Exception exception) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "054d65245cbcc2d304e062d145a7ca844218d114"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA1OTA2MQ==", "bodyText": "Why not? One example of its usefulness is in this PR as we need to truncate the stack trace and return it in broker response.", "url": "https://github.com/apache/pinot/pull/5705#discussion_r456059061", "createdAt": "2020-07-16T20:30:14Z", "author": {"login": "sajjad-moradi"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/exception/QueryException.java", "diffHunk": "@@ -125,8 +126,17 @@ public static void setMaxLinesOfStackTrace(int maxLinesOfStackTrace) {\n   }\n \n   public static ProcessingException getException(ProcessingException processingException, Exception exception) {\n+    return getException(processingException, getTruncatedStackTrace(exception));\n+  }\n+\n+  public static ProcessingException getException(ProcessingException processingException, String errorMessage) {\n     String errorType = processingException.getMessage();\n     ProcessingException copiedProcessingException = processingException.deepCopy();\n+    copiedProcessingException.setMessage(errorType + \":\\n\" + errorMessage);\n+    return copiedProcessingException;\n+  }\n+\n+  public static String getTruncatedStackTrace(Exception exception) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxMTA3Nw=="}, "originalCommit": {"oid": "054d65245cbcc2d304e062d145a7ca844218d114"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjEzNjY3MA==", "bodyText": "To send stack trace, we should use getException(ProcessingException processingException, Exception exception) instead of calling this method to construct the error message and use getException(ProcessingException processingException, String errorMessage)", "url": "https://github.com/apache/pinot/pull/5705#discussion_r456136670", "createdAt": "2020-07-16T23:38:29Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/exception/QueryException.java", "diffHunk": "@@ -125,8 +126,17 @@ public static void setMaxLinesOfStackTrace(int maxLinesOfStackTrace) {\n   }\n \n   public static ProcessingException getException(ProcessingException processingException, Exception exception) {\n+    return getException(processingException, getTruncatedStackTrace(exception));\n+  }\n+\n+  public static ProcessingException getException(ProcessingException processingException, String errorMessage) {\n     String errorType = processingException.getMessage();\n     ProcessingException copiedProcessingException = processingException.deepCopy();\n+    copiedProcessingException.setMessage(errorType + \":\\n\" + errorMessage);\n+    return copiedProcessingException;\n+  }\n+\n+  public static String getTruncatedStackTrace(Exception exception) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxMTA3Nw=="}, "originalCommit": {"oid": "054d65245cbcc2d304e062d145a7ca844218d114"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE1MzgzOQ==", "bodyText": "getException method takes ProcessingException as its argument while we need to construct a QueryProcesssingException to pass it in broker response. That's why i did that refactoring.", "url": "https://github.com/apache/pinot/pull/5705#discussion_r456153839", "createdAt": "2020-07-17T00:37:34Z", "author": {"login": "sajjad-moradi"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/exception/QueryException.java", "diffHunk": "@@ -125,8 +126,17 @@ public static void setMaxLinesOfStackTrace(int maxLinesOfStackTrace) {\n   }\n \n   public static ProcessingException getException(ProcessingException processingException, Exception exception) {\n+    return getException(processingException, getTruncatedStackTrace(exception));\n+  }\n+\n+  public static ProcessingException getException(ProcessingException processingException, String errorMessage) {\n     String errorType = processingException.getMessage();\n     ProcessingException copiedProcessingException = processingException.deepCopy();\n+    copiedProcessingException.setMessage(errorType + \":\\n\" + errorMessage);\n+    return copiedProcessingException;\n+  }\n+\n+  public static String getTruncatedStackTrace(Exception exception) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxMTA3Nw=="}, "originalCommit": {"oid": "054d65245cbcc2d304e062d145a7ca844218d114"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI0MTI0Ng==", "bodyText": "Sorry didn't realize they are different classes.\n(Optional) You might also want to keep the errorType information in the error message? If so, you can construct a ProcessingException first, then use it to construct the QueryProcessingException: new QueryProcessingException(exception.getErrorCode(), exception.getMessage())", "url": "https://github.com/apache/pinot/pull/5705#discussion_r456241246", "createdAt": "2020-07-17T06:20:03Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/exception/QueryException.java", "diffHunk": "@@ -125,8 +126,17 @@ public static void setMaxLinesOfStackTrace(int maxLinesOfStackTrace) {\n   }\n \n   public static ProcessingException getException(ProcessingException processingException, Exception exception) {\n+    return getException(processingException, getTruncatedStackTrace(exception));\n+  }\n+\n+  public static ProcessingException getException(ProcessingException processingException, String errorMessage) {\n     String errorType = processingException.getMessage();\n     ProcessingException copiedProcessingException = processingException.deepCopy();\n+    copiedProcessingException.setMessage(errorType + \":\\n\" + errorMessage);\n+    return copiedProcessingException;\n+  }\n+\n+  public static String getTruncatedStackTrace(Exception exception) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxMTA3Nw=="}, "originalCommit": {"oid": "054d65245cbcc2d304e062d145a7ca844218d114"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU2NDM3MA==", "bodyText": "errorType, which is basically exception.getMessage(), is always available in the first line of the stack trace. Since we keep the stack trace, we don't need to separately keep it.", "url": "https://github.com/apache/pinot/pull/5705#discussion_r457564370", "createdAt": "2020-07-20T17:10:18Z", "author": {"login": "sajjad-moradi"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/exception/QueryException.java", "diffHunk": "@@ -125,8 +126,17 @@ public static void setMaxLinesOfStackTrace(int maxLinesOfStackTrace) {\n   }\n \n   public static ProcessingException getException(ProcessingException processingException, Exception exception) {\n+    return getException(processingException, getTruncatedStackTrace(exception));\n+  }\n+\n+  public static ProcessingException getException(ProcessingException processingException, String errorMessage) {\n     String errorType = processingException.getMessage();\n     ProcessingException copiedProcessingException = processingException.deepCopy();\n+    copiedProcessingException.setMessage(errorType + \":\\n\" + errorMessage);\n+    return copiedProcessingException;\n+  }\n+\n+  public static String getTruncatedStackTrace(Exception exception) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxMTA3Nw=="}, "originalCommit": {"oid": "054d65245cbcc2d304e062d145a7ca844218d114"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc2MTcyOA==", "bodyText": "The errorType I referred to here is BrokerResponseSendError which you put in the QueryException.class so that users don't need to look up the int error code (425) to understand the type of the error. The error message of the Exception will be:\n  BrokerResponseSendError:\n  {stacktrace}\n\nI already approved the change. These comments are just suggestions. You can merge it", "url": "https://github.com/apache/pinot/pull/5705#discussion_r457761728", "createdAt": "2020-07-21T00:15:00Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/exception/QueryException.java", "diffHunk": "@@ -125,8 +126,17 @@ public static void setMaxLinesOfStackTrace(int maxLinesOfStackTrace) {\n   }\n \n   public static ProcessingException getException(ProcessingException processingException, Exception exception) {\n+    return getException(processingException, getTruncatedStackTrace(exception));\n+  }\n+\n+  public static ProcessingException getException(ProcessingException processingException, String errorMessage) {\n     String errorType = processingException.getMessage();\n     ProcessingException copiedProcessingException = processingException.deepCopy();\n+    copiedProcessingException.setMessage(errorType + \":\\n\" + errorMessage);\n+    return copiedProcessingException;\n+  }\n+\n+  public static String getTruncatedStackTrace(Exception exception) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxMTA3Nw=="}, "originalCommit": {"oid": "054d65245cbcc2d304e062d145a7ca844218d114"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc2MjQ0Mw==", "bodyText": "I don't have the write access to merge this PR. How can I get the write access?", "url": "https://github.com/apache/pinot/pull/5705#discussion_r457762443", "createdAt": "2020-07-21T00:17:26Z", "author": {"login": "sajjad-moradi"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/exception/QueryException.java", "diffHunk": "@@ -125,8 +126,17 @@ public static void setMaxLinesOfStackTrace(int maxLinesOfStackTrace) {\n   }\n \n   public static ProcessingException getException(ProcessingException processingException, Exception exception) {\n+    return getException(processingException, getTruncatedStackTrace(exception));\n+  }\n+\n+  public static ProcessingException getException(ProcessingException processingException, String errorMessage) {\n     String errorType = processingException.getMessage();\n     ProcessingException copiedProcessingException = processingException.deepCopy();\n+    copiedProcessingException.setMessage(errorType + \":\\n\" + errorMessage);\n+    return copiedProcessingException;\n+  }\n+\n+  public static String getTruncatedStackTrace(Exception exception) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxMTA3Nw=="}, "originalCommit": {"oid": "054d65245cbcc2d304e062d145a7ca844218d114"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg0NzYwOQ==", "bodyText": "@sajjad-moradi Merged the PR. I think you need to be a committer in order to merge PR. @mayankshriv @mcvsubbu Do we need to start a vote in order to make Sajjad a committer?", "url": "https://github.com/apache/pinot/pull/5705#discussion_r457847609", "createdAt": "2020-07-21T05:36:44Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/exception/QueryException.java", "diffHunk": "@@ -125,8 +126,17 @@ public static void setMaxLinesOfStackTrace(int maxLinesOfStackTrace) {\n   }\n \n   public static ProcessingException getException(ProcessingException processingException, Exception exception) {\n+    return getException(processingException, getTruncatedStackTrace(exception));\n+  }\n+\n+  public static ProcessingException getException(ProcessingException processingException, String errorMessage) {\n     String errorType = processingException.getMessage();\n     ProcessingException copiedProcessingException = processingException.deepCopy();\n+    copiedProcessingException.setMessage(errorType + \":\\n\" + errorMessage);\n+    return copiedProcessingException;\n+  }\n+\n+  public static String getTruncatedStackTrace(Exception exception) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxMTA3Nw=="}, "originalCommit": {"oid": "054d65245cbcc2d304e062d145a7ca844218d114"}, "originalPosition": 22}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4112, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}