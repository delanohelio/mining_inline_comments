{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzODk0MTc4", "number": 6329, "title": "Fix table cache logic in pinot-broker", "bodyText": "Description\nThis PR fixes table cache and its related integration test in pinot-broker.\nCurrently the column name in queries doesn't get converted to lower cases before fetching the real column name in table cache.\nAnd the case insensitivity setting is currently invalid for pql queries, thus also fixing the table name in SelectAstNode class and  updating the tests to send sql and pql queries in OfflineClusterIntegrationTest class.\nUpgrade Notes\nDoes this PR prevent a zero down-time upgrade? (Assume upgrade order: Controller, Broker, Server, Minion)\n\n Yes (Please label as backward-incompat, and complete the section below on Release Notes)\n\nDoes this PR fix a zero-downtime upgrade introduced earlier?\n\n Yes (Please label this as backward-incompat, and complete the section below on Release Notes)\n\nDoes this PR otherwise need attention when creating release notes? Things to consider:\n\nNew configuration options\nDeprecation of configurations\nSignature changes to public methods/interfaces\nNew plugins added or old plugins removed\n\n\n Yes (Please label this PR as release-notes and complete the section on Release Notes)\n\nRelease Notes\nIf you have tagged this as either backward-incompat or release-notes,\nyou MUST add text here that you would like to see appear in release notes of the\nnext release.\nIf you have a series of commits adding or enabling a feature, then\nadd this section only in final commit that marks the feature completed.\nRefer to earlier release notes to see examples of text\nDocumentation\nIf you have introduced a new feature or configuration, please add it to the documentation as well.\nSee https://docs.pinot.apache.org/developers/developers-and-contributors/update-document", "createdAt": "2020-12-07T19:25:43Z", "url": "https://github.com/apache/pinot/pull/6329", "merged": true, "mergeCommit": {"oid": "4ba7204a8778467043d8e54ccd0e005cb8042887"}, "closed": true, "closedAt": "2020-12-10T16:53:11Z", "author": {"login": "jackjlli"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdj7pq_AFqTU0NjUxMDM3MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdknUHtgBqjQwOTI0MzQwMzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NTEwMzcw", "url": "https://github.com/apache/pinot/pull/6329#pullrequestreview-546510370", "createdAt": "2020-12-07T20:29:05Z", "commit": {"oid": "32659d9d9f2b8a07478b66062ca61a337e6617d1"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMDoyOTowNVrOIA5VnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMDozNDoyN1rOIA5iRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgxMDMzMw==", "bodyText": "You can directly use assertTrue(), same for other places", "url": "https://github.com/apache/pinot/pull/6329#discussion_r537810333", "createdAt": "2020-12-07T20:29:05Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-integration-tests/src/test/java/org/apache/pinot/integration/tests/OfflineClusterIntegrationTest.java", "diffHunk": "@@ -1307,7 +1308,8 @@ public void testCaseInsensitivity() {\n \n     for (String query : queries) {\n       try {\n-        postQuery(query);\n+        JsonNode response = postSqlQuery(query);\n+        Assert.assertTrue(response.get(\"numSegmentsProcessed\").asLong() >= 1L, query + \" failed\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32659d9d9f2b8a07478b66062ca61a337e6617d1"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgxMTkzOA==", "bodyText": "Can you please check why it does not apply to pql? It should apply to both pql and sql", "url": "https://github.com/apache/pinot/pull/6329#discussion_r537811938", "createdAt": "2020-12-07T20:31:51Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-integration-tests/src/test/java/org/apache/pinot/integration/tests/OfflineClusterIntegrationTest.java", "diffHunk": "@@ -1307,7 +1308,8 @@ public void testCaseInsensitivity() {\n \n     for (String query : queries) {\n       try {\n-        postQuery(query);\n+        JsonNode response = postSqlQuery(query);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32659d9d9f2b8a07478b66062ca61a337e6617d1"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgxMzU3NA==", "bodyText": "Good catch, but how the the test pass before?", "url": "https://github.com/apache/pinot/pull/6329#discussion_r537813574", "createdAt": "2020-12-07T20:34:27Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -1002,7 +1002,7 @@ private String getActualColumnName(String rawTableName, String columnName,\n         columnName = splits[1];\n       }\n       if (columnNameMap != null) {\n-        return columnNameMap.getOrDefault(columnName, columnName);\n+        return columnNameMap.getOrDefault(columnName.toLowerCase(), columnName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32659d9d9f2b8a07478b66062ca61a337e6617d1"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "32659d9d9f2b8a07478b66062ca61a337e6617d1", "author": {"user": null}, "url": "https://github.com/apache/pinot/commit/32659d9d9f2b8a07478b66062ca61a337e6617d1", "committedDate": "2020-12-07T19:24:32Z", "message": "Fix table cache in pinot-broker"}, "afterCommit": {"oid": "e8c24395777fc6088bfdd60974c7bb7ffb9f3556", "author": {"user": null}, "url": "https://github.com/apache/pinot/commit/e8c24395777fc6088bfdd60974c7bb7ffb9f3556", "committedDate": "2020-12-07T21:50:38Z", "message": "Fix table cache in pinot-broker"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e8c24395777fc6088bfdd60974c7bb7ffb9f3556", "author": {"user": null}, "url": "https://github.com/apache/pinot/commit/e8c24395777fc6088bfdd60974c7bb7ffb9f3556", "committedDate": "2020-12-07T21:50:38Z", "message": "Fix table cache in pinot-broker"}, "afterCommit": {"oid": "121c149e92ea9511c7ec5a0db45357f002eb1966", "author": {"user": null}, "url": "https://github.com/apache/pinot/commit/121c149e92ea9511c7ec5a0db45357f002eb1966", "committedDate": "2020-12-07T21:52:35Z", "message": "Fix table cache in pinot-broker"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3Njc0MTI5", "url": "https://github.com/apache/pinot/pull/6329#pullrequestreview-547674129", "createdAt": "2020-12-08T22:09:08Z", "commit": {"oid": "121c149e92ea9511c7ec5a0db45357f002eb1966"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMjowOTowOFrOIB4dkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMjowOTowOFrOIB4dkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0NDU2Mg==", "bodyText": "I think we don't differentiate table name and resource name right now, so maybe a better fix should be in TableNameAstNode to remove the resourceName and only keep the tableName?", "url": "https://github.com/apache/pinot/pull/6329#discussion_r538844562", "createdAt": "2020-12-08T22:09:08Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-common/src/main/java/org/apache/pinot/pql/parsers/pql2/ast/SelectAstNode.java", "diffHunk": "@@ -106,7 +106,7 @@ public String toString() {\n   public void updateBrokerRequest(BrokerRequest brokerRequest) {\n     // Set the query source\n     QuerySource querySource = new QuerySource();\n-    querySource.setTableName(_resourceName);\n+    querySource.setTableName(_tableName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "121c149e92ea9511c7ec5a0db45357f002eb1966"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NDk1MDkw", "url": "https://github.com/apache/pinot/pull/6329#pullrequestreview-548495090", "createdAt": "2020-12-09T18:43:55Z", "commit": {"oid": "121c149e92ea9511c7ec5a0db45357f002eb1966"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxODo0Mzo1NVrOICj4Yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxODo0Mzo1NVrOICj4Yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU1NTkzOA==", "bodyText": "I see. You might also want to use _tableName on line 172 for updating the pinot query", "url": "https://github.com/apache/pinot/pull/6329#discussion_r539555938", "createdAt": "2020-12-09T18:43:55Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-common/src/main/java/org/apache/pinot/pql/parsers/pql2/ast/SelectAstNode.java", "diffHunk": "@@ -106,7 +106,7 @@ public String toString() {\n   public void updateBrokerRequest(BrokerRequest brokerRequest) {\n     // Set the query source\n     QuerySource querySource = new QuerySource();\n-    querySource.setTableName(_resourceName);\n+    querySource.setTableName(_tableName);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0NDU2Mg=="}, "originalCommit": {"oid": "121c149e92ea9511c7ec5a0db45357f002eb1966"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "110af3283fa4d69c5d4c81d44deadc036a08c8e4", "author": {"user": null}, "url": "https://github.com/apache/pinot/commit/110af3283fa4d69c5d4c81d44deadc036a08c8e4", "committedDate": "2020-12-09T23:26:30Z", "message": "Fix table cache in pinot-broker"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "121c149e92ea9511c7ec5a0db45357f002eb1966", "author": {"user": null}, "url": "https://github.com/apache/pinot/commit/121c149e92ea9511c7ec5a0db45357f002eb1966", "committedDate": "2020-12-07T21:52:35Z", "message": "Fix table cache in pinot-broker"}, "afterCommit": {"oid": "110af3283fa4d69c5d4c81d44deadc036a08c8e4", "author": {"user": null}, "url": "https://github.com/apache/pinot/commit/110af3283fa4d69c5d4c81d44deadc036a08c8e4", "committedDate": "2020-12-09T23:26:30Z", "message": "Fix table cache in pinot-broker"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1611, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}