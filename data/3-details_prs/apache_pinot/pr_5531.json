{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyMDQwMDQx", "number": 5531, "title": "Fix the failure caused by Reflections in FunctionRegistry", "bodyText": "Description\nThe new FunctionRegistry change of using reflection to plug in methods (introduced in #5440) is causing failure in query compilation.\nThe problem is caused by Reflections library not being thread-safe when multiple threads are accessing the same jar file.\nWe have multiple libraries (jersey, swagger) using reflection to load classes. The FunctionRegistry uses reflection in the static block, which happens when the class is loaded. If the first query arrives (first usage of FunctionRegistry which runs the static block) during the setup of the jersey server, Reflections will throw exception.\nUsing reflection in the static block can also cause the first query to block on reflection scanning the classes, which can potentially take seconds.\nRead more about the thread-safety issue here: ronmamo/reflections#81\nUsers are reporting the same issue even with the latest Reflections version 0.9.12.\nA common solution is to downgrade Reflections to 0.9.9, but we have other dependencies rely on 0.9.11, so downgrading might cause other issues.\nThe solution here is to introduce a no-op init() method to trigger the static block so that we can control when to scan the files to avoid the thread-safety issue as well as blocking the first query.\nAnother benefit of using an init() method is that the exception won't be swallowed (the exception in static block will be swallowed and query engine will start getting ClassNotFoundException)\nThis PR also introduces a convention for the plugin methods using reflection, where the class must includes \".function.\" in its class path.\nThis can significantly reduce the time of class scanning (reduced from 4 seconds to 200 ms locally)\nDoes this PR otherwise need attention when creating release notes? Things to consider:\n\nNew configuration options\nDeprecation of configurations\nSignature changes to public methods/interfaces\nNew plugins added or old plugins removed\n\n\n Yes (Please label this PR as release-notes and complete the section on Release Notes)\n\nRelease Notes\nIn order to plug in scalar methods using annotation via reflection, please put the methods in a class that includes \".function.\" in its class path.", "createdAt": "2020-06-09T20:16:37Z", "url": "https://github.com/apache/pinot/pull/5531", "merged": true, "mergeCommit": {"oid": "53906986e376e7b454f1d23599794b07683293b0"}, "closed": true, "closedAt": "2020-06-10T02:07:54Z", "author": {"login": "Jackie-Jiang"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcprKC4AFqTQyNzUxOTMzMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpu1gNgBqjM0MjczNTYxOTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NTE5MzMx", "url": "https://github.com/apache/pinot/pull/5531#pullrequestreview-427519331", "createdAt": "2020-06-09T20:33:52Z", "commit": {"oid": "4cb398a9c2113369c3cbe3c4139d5f968bdb3f9c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NTIyNDI3", "url": "https://github.com/apache/pinot/pull/5531#pullrequestreview-427522427", "createdAt": "2020-06-09T20:38:29Z", "commit": {"oid": "4cb398a9c2113369c3cbe3c4139d5f968bdb3f9c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQyMDozODoyOVrOGhbTdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQyMDozODoyOVrOGhbTdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzcwMzU0Mw==", "bodyText": "Curious if there's any way to enforce this, so we ensure that future changes adhere to this?", "url": "https://github.com/apache/pinot/pull/5531#discussion_r437703543", "createdAt": "2020-06-09T20:38:29Z", "author": {"login": "mayankshriv"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/function/FunctionRegistry.java", "diffHunk": "@@ -39,62 +38,63 @@\n  */\n public class FunctionRegistry {\n   private static final Logger LOGGER = LoggerFactory.getLogger(FunctionRegistry.class);\n-  private static final Map<String, FunctionInfo> _functionInfoMap = new HashMap<>();\n+  private static final Map<String, FunctionInfo> FUNCTION_INFO_MAP = new HashMap<>();\n+\n+  private static boolean _initialized = false;\n \n   /**\n-   * Given a function name, asserts that a corresponding function was registered during construction and returns it\n+   * Initializes the FunctionRegistry by registering the scalar functions via reflection.\n+   * NOTE: In order to plugin methods using reflection, the methods should be inside a class that includes \".function.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4cb398a9c2113369c3cbe3c4139d5f968bdb3f9c"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NTU0MTc1", "url": "https://github.com/apache/pinot/pull/5531#pullrequestreview-427554175", "createdAt": "2020-06-09T21:20:46Z", "commit": {"oid": "4cb398a9c2113369c3cbe3c4139d5f968bdb3f9c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQyMToyMDo0NlrOGhc5AQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQyMToyMDo0NlrOGhc5AQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzcyOTUzNw==", "bodyText": "why are we measuring the time to init functions? do we expect it to take a long time?\nAlso, if we logging it may be useful to log the map size here, and also each function as they are registered", "url": "https://github.com/apache/pinot/pull/5531#discussion_r437729537", "createdAt": "2020-06-09T21:20:46Z", "author": {"login": "mcvsubbu"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/function/FunctionRegistry.java", "diffHunk": "@@ -39,62 +38,63 @@\n  */\n public class FunctionRegistry {\n   private static final Logger LOGGER = LoggerFactory.getLogger(FunctionRegistry.class);\n-  private static final Map<String, FunctionInfo> _functionInfoMap = new HashMap<>();\n+  private static final Map<String, FunctionInfo> FUNCTION_INFO_MAP = new HashMap<>();\n+\n+  private static boolean _initialized = false;\n \n   /**\n-   * Given a function name, asserts that a corresponding function was registered during construction and returns it\n+   * Initializes the FunctionRegistry by registering the scalar functions via reflection.\n+   * NOTE: In order to plugin methods using reflection, the methods should be inside a class that includes \".function.\"\n+   *       in its class path. This convention can significantly reduce the time of class scanning.\n    */\n-  public static FunctionInfo getFunctionByName(String functionName) {\n-    Preconditions.checkArgument(_functionInfoMap.containsKey(functionName.toLowerCase()));\n-    return _functionInfoMap.get(functionName.toLowerCase());\n+  public static synchronized void init() {\n+    if (_initialized) {\n+      LOGGER.info(\"FunctionRegistry is already initialized\");\n+      return;\n+    }\n+\n+    long startTimeMs = System.currentTimeMillis();\n+    Reflections reflections = new Reflections(\n+        new ConfigurationBuilder().setUrls(ClasspathHelper.forPackage(\"org.apache.pinot\"))\n+            .filterInputsBy(new FilterBuilder.Include(\".*\\\\.function\\\\..*\"))\n+            .setScanners(new MethodAnnotationsScanner()));\n+    Set<Method> methodSet = reflections.getMethodsAnnotatedWith(ScalarFunction.class);\n+    for (Method method : methodSet) {\n+      ScalarFunction scalarFunction = method.getAnnotation(ScalarFunction.class);\n+      if (scalarFunction.enabled()) {\n+        if (!scalarFunction.name().isEmpty()) {\n+          FunctionRegistry.registerFunction(scalarFunction.name(), method);\n+        } else {\n+          FunctionRegistry.registerFunction(method);\n+        }\n+      }\n+    }\n+    LOGGER.info(\"Initialized FunctionRegistry within {}ms\", System.currentTimeMillis() - startTimeMs);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4cb398a9c2113369c3cbe3c4139d5f968bdb3f9c"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NTY4MDg1", "url": "https://github.com/apache/pinot/pull/5531#pullrequestreview-427568085", "createdAt": "2020-06-09T21:45:27Z", "commit": {"oid": "4cb398a9c2113369c3cbe3c4139d5f968bdb3f9c"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQyMTo0NToyOFrOGhdjfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQyMTo1NToxN1rOGhdz1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc0MDQxMg==", "bodyText": "Could you make a function like canonicalize(functionName) and use it here and also in registerFunction method where FUNCTION_INFO_MAP gets populated so in future we won't miss converting to lowercase?", "url": "https://github.com/apache/pinot/pull/5531#discussion_r437740412", "createdAt": "2020-06-09T21:45:28Z", "author": {"login": "sajjad-moradi"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/function/FunctionRegistry.java", "diffHunk": "@@ -39,62 +38,63 @@\n  */\n public class FunctionRegistry {\n   private static final Logger LOGGER = LoggerFactory.getLogger(FunctionRegistry.class);\n-  private static final Map<String, FunctionInfo> _functionInfoMap = new HashMap<>();\n+  private static final Map<String, FunctionInfo> FUNCTION_INFO_MAP = new HashMap<>();\n+\n+  private static boolean _initialized = false;\n \n   /**\n-   * Given a function name, asserts that a corresponding function was registered during construction and returns it\n+   * Initializes the FunctionRegistry by registering the scalar functions via reflection.\n+   * NOTE: In order to plugin methods using reflection, the methods should be inside a class that includes \".function.\"\n+   *       in its class path. This convention can significantly reduce the time of class scanning.\n    */\n-  public static FunctionInfo getFunctionByName(String functionName) {\n-    Preconditions.checkArgument(_functionInfoMap.containsKey(functionName.toLowerCase()));\n-    return _functionInfoMap.get(functionName.toLowerCase());\n+  public static synchronized void init() {\n+    if (_initialized) {\n+      LOGGER.info(\"FunctionRegistry is already initialized\");\n+      return;\n+    }\n+\n+    long startTimeMs = System.currentTimeMillis();\n+    Reflections reflections = new Reflections(\n+        new ConfigurationBuilder().setUrls(ClasspathHelper.forPackage(\"org.apache.pinot\"))\n+            .filterInputsBy(new FilterBuilder.Include(\".*\\\\.function\\\\..*\"))\n+            .setScanners(new MethodAnnotationsScanner()));\n+    Set<Method> methodSet = reflections.getMethodsAnnotatedWith(ScalarFunction.class);\n+    for (Method method : methodSet) {\n+      ScalarFunction scalarFunction = method.getAnnotation(ScalarFunction.class);\n+      if (scalarFunction.enabled()) {\n+        if (!scalarFunction.name().isEmpty()) {\n+          FunctionRegistry.registerFunction(scalarFunction.name(), method);\n+        } else {\n+          FunctionRegistry.registerFunction(method);\n+        }\n+      }\n+    }\n+    LOGGER.info(\"Initialized FunctionRegistry within {}ms\", System.currentTimeMillis() - startTimeMs);\n+    _initialized = true;\n   }\n \n   /**\n-   * Given a function name and a set of argument types, asserts that a corresponding function\n-   * was registered during construction and returns it\n+   * Registers a method with the name of the method.\n    */\n-  public static FunctionInfo getFunctionByNameWithApplicableArgumentTypes(String functionName,\n-      Class<?>[] argumentTypes) {\n-    FunctionInfo functionInfo = getFunctionByName(functionName);\n-    Preconditions.checkArgument(functionInfo.isApplicable(argumentTypes));\n-    return functionInfo;\n-  }\n-\n-  public static void registerFunction(Method method) {\n+  public static synchronized void registerFunction(Method method) {\n     registerFunction(method.getName().toLowerCase(), method);\n   }\n \n-  public static void registerFunction(String name, Method method) {\n+  /**\n+   * Registers a method with the given function name.\n+   */\n+  public static synchronized void registerFunction(String functionName, Method method) {\n     FunctionInfo functionInfo = new FunctionInfo(method, method.getDeclaringClass());\n-    _functionInfoMap.put(name, functionInfo);\n+    FUNCTION_INFO_MAP.put(functionName, functionInfo);\n   }\n \n-  public static boolean containsFunctionByName(String funcName) {\n-    return _functionInfoMap.containsKey(funcName.toLowerCase());\n-  }\n-\n-  static {\n-    try {\n-\n-      Reflections reflections = new Reflections(\n-          new ConfigurationBuilder().setUrls(ClasspathHelper.forPackage(\"org.apache.pinot\"))\n-              .setScanners(new MethodAnnotationsScanner()));\n-\n-      Set<Method> methodSet = reflections.getMethodsAnnotatedWith(ScalarFunction.class);\n-      for (Method method : methodSet) {\n-        ScalarFunction scalarFunction = method.getAnnotation(ScalarFunction.class);\n-        if (scalarFunction.enabled()) {\n-          if (!scalarFunction.name().isEmpty()) {\n-            FunctionRegistry.registerFunction(scalarFunction.name(), method);\n-          } else {\n-            FunctionRegistry.registerFunction(method);\n-          }\n-        }\n-      }\n-\n-    } catch (Exception e) {\n-      LOGGER.error(\"Caught exception when registering function\", e);\n-      throw new IllegalStateException(e);\n-    }\n+  /**\n+   * Returns the {@link FunctionInfo} associated with the given function name, or {@code null} if there is no method\n+   * registered under the name. This method should be called after the FunctionRegistry is initialized and all methods\n+   * are already registered.\n+   */\n+  @Nullable\n+  public static FunctionInfo getFunctionByName(String functionName) {\n+    return FUNCTION_INFO_MAP.get(functionName.toLowerCase());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4cb398a9c2113369c3cbe3c4139d5f968bdb3f9c"}, "originalPosition": 126}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc0NDU5OQ==", "bodyText": "why are you removing this check?", "url": "https://github.com/apache/pinot/pull/5531#discussion_r437744599", "createdAt": "2020-06-09T21:55:17Z", "author": {"login": "sajjad-moradi"}, "path": "pinot-common/src/main/java/org/apache/pinot/sql/parsers/CalciteSqlParser.java", "diffHunk": "@@ -667,21 +666,23 @@ protected static Expression invokeCompileTimeFunctionExpression(Expression funcE\n       function.getOperands().set(i, operand);\n     }\n     String funcName = function.getOperator();\n-    if (FunctionRegistry.containsFunctionByName(funcName) && compilable) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4cb398a9c2113369c3cbe3c4139d5f968bdb3f9c"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4cb398a9c2113369c3cbe3c4139d5f968bdb3f9c", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/4cb398a9c2113369c3cbe3c4139d5f968bdb3f9c", "committedDate": "2020-06-09T20:00:41Z", "message": "Fix the failure caused by Reflections in FunctionRegistry\n\nThe problem is caused by Reflections library not being thread-safe when multiple threads are accessing the same jar file.\nRead more about the thread-safety issue here: https://github.com/ronmamo/reflections/issues/81\nUsers are reporting the same issue even with the latest Reflections version 0.9.12.\nA common solution is to downgrade Reflections to 0.9.9, but we have other dependencies rely on 0.9.11, so downgrading might cause other issues.\n\nThe solution introduced here is by replacing the static block with an init() method so that we can control when to scan the files to avoid the thread-safety issue.\nAnother benefit of using an init() method is that the exception won't be swallowed (the exception in static block will be swallowed and query engine will start getting ClassNotFoundException)\n\nThis PR also introduces a convention for the plugin methods using reflection, where the class must includes \".function.\" in its class path.\nThis can significantly reduce the time of class scanning (reduced from 4 seconds to 200 ms locally)"}, "afterCommit": {"oid": "9f1eea901d019a0b434d2dd951c1e249c500bf41", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/9f1eea901d019a0b434d2dd951c1e249c500bf41", "committedDate": "2020-06-09T22:11:42Z", "message": "Fix the failure caused by Reflections in FunctionRegistry\n\nThe problem is caused by Reflections library not being thread-safe when multiple threads are accessing the same jar file.\nRead more about the thread-safety issue here: https://github.com/ronmamo/reflections/issues/81\nUsers are reporting the same issue even with the latest Reflections version 0.9.12.\nA common solution is to downgrade Reflections to 0.9.9, but we have other dependencies rely on 0.9.11, so downgrading might cause other issues.\n\nThe solution introduced here is by replacing the static block with an init() method so that we can control when to scan the files to avoid the thread-safety issue.\nAnother benefit of using an init() method is that the exception won't be swallowed (the exception in static block will be swallowed and query engine will start getting ClassNotFoundException)\n\nThis PR also introduces a convention for the plugin methods using reflection, where the class must includes \".function.\" in its class path.\nThis can significantly reduce the time of class scanning (reduced from 4 seconds to 200 ms locally)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "503eff8d10b7e3dc4c9db7f2f6ae8b8d151af400", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/503eff8d10b7e3dc4c9db7f2f6ae8b8d151af400", "committedDate": "2020-06-10T00:48:46Z", "message": "Fix the failure caused by Reflections in FunctionRegistry\n\nThe problem is caused by Reflections library not being thread-safe when multiple threads are accessing the same jar file.\nRead more about the thread-safety issue here: https://github.com/ronmamo/reflections/issues/81\nUsers are reporting the same issue even with the latest Reflections version 0.9.12.\nA common solution is to downgrade Reflections to 0.9.9, but we have other dependencies rely on 0.9.11, so downgrading might cause other issues.\n\nThe solution introduced here is by replacing the static block with an init() method so that we can control when to scan the files to avoid the thread-safety issue.\nAnother benefit of using an init() method is that the exception won't be swallowed (the exception in static block will be swallowed and query engine will start getting ClassNotFoundException)\n\nThis PR also introduces a convention for the plugin methods using reflection, where the class must includes \".function.\" in its class path.\nThis can significantly reduce the time of class scanning (reduced from 4 seconds to 200 ms locally)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9f1eea901d019a0b434d2dd951c1e249c500bf41", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/9f1eea901d019a0b434d2dd951c1e249c500bf41", "committedDate": "2020-06-09T22:11:42Z", "message": "Fix the failure caused by Reflections in FunctionRegistry\n\nThe problem is caused by Reflections library not being thread-safe when multiple threads are accessing the same jar file.\nRead more about the thread-safety issue here: https://github.com/ronmamo/reflections/issues/81\nUsers are reporting the same issue even with the latest Reflections version 0.9.12.\nA common solution is to downgrade Reflections to 0.9.9, but we have other dependencies rely on 0.9.11, so downgrading might cause other issues.\n\nThe solution introduced here is by replacing the static block with an init() method so that we can control when to scan the files to avoid the thread-safety issue.\nAnother benefit of using an init() method is that the exception won't be swallowed (the exception in static block will be swallowed and query engine will start getting ClassNotFoundException)\n\nThis PR also introduces a convention for the plugin methods using reflection, where the class must includes \".function.\" in its class path.\nThis can significantly reduce the time of class scanning (reduced from 4 seconds to 200 ms locally)"}, "afterCommit": {"oid": "503eff8d10b7e3dc4c9db7f2f6ae8b8d151af400", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/503eff8d10b7e3dc4c9db7f2f6ae8b8d151af400", "committedDate": "2020-06-10T00:48:46Z", "message": "Fix the failure caused by Reflections in FunctionRegistry\n\nThe problem is caused by Reflections library not being thread-safe when multiple threads are accessing the same jar file.\nRead more about the thread-safety issue here: https://github.com/ronmamo/reflections/issues/81\nUsers are reporting the same issue even with the latest Reflections version 0.9.12.\nA common solution is to downgrade Reflections to 0.9.9, but we have other dependencies rely on 0.9.11, so downgrading might cause other issues.\n\nThe solution introduced here is by replacing the static block with an init() method so that we can control when to scan the files to avoid the thread-safety issue.\nAnother benefit of using an init() method is that the exception won't be swallowed (the exception in static block will be swallowed and query engine will start getting ClassNotFoundException)\n\nThis PR also introduces a convention for the plugin methods using reflection, where the class must includes \".function.\" in its class path.\nThis can significantly reduce the time of class scanning (reduced from 4 seconds to 200 ms locally)"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 564, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}