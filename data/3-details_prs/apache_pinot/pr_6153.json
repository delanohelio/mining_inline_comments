{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA1MzgxNzcz", "number": 6153, "title": "add more validation for upsert config", "bodyText": "Part of a series of PRs for #4261\nCheck this doc out for the new design\n\nvalidate primary key columns\nvalidate startree index not in use", "createdAt": "2020-10-18T03:12:13Z", "url": "https://github.com/apache/pinot/pull/6153", "merged": true, "mergeCommit": {"oid": "da451a8f3dbfcfe18d344e8b3b40c69e6ef08325"}, "closed": true, "closedAt": "2020-10-20T20:16:25Z", "author": {"login": "yupeng9"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdTVXqfgH2gAyNTA1MzgxNzczOmZhY2FmMzZkOTlmNzhmZjI3M2RkZTBmOTFiZTAxODI2MTBkOTlkMDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUenYKgFqTUxMzA5Njk0OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "facaf36d99f78ff273dde0f91be0182610d99d06", "author": {"user": {"login": "yupeng9", "name": "Yupeng Fu"}}, "url": "https://github.com/apache/pinot/commit/facaf36d99f78ff273dde0f91be0182610d99d06", "committedDate": "2020-10-17T06:55:39Z", "message": "add more validation for upsert config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddb30bf5fa80a71074c3661c71707311a85e579c", "author": {"user": {"login": "yupeng9", "name": "Yupeng Fu"}}, "url": "https://github.com/apache/pinot/commit/ddb30bf5fa80a71074c3661c71707311a85e579c", "committedDate": "2020-10-18T03:52:11Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMDAxOTA3", "url": "https://github.com/apache/pinot/pull/6153#pullrequestreview-512001907", "createdAt": "2020-10-19T17:37:58Z", "commit": {"oid": "ddb30bf5fa80a71074c3661c71707311a85e579c"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNzozNzo1OFrOHkZzyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNzo1NTo1MVrOHka32Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkzMzY0MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    tableConfig.getIndexingConfig().getStarTreeIndexConfigs() == null || tableConfig.getIndexingConfig()\n          \n          \n            \n                        .getStarTreeIndexConfigs().isEmpty(), \"The upsert table cannot have star-tree index.\");\n          \n          \n            \n                    Collections.isEmpty(tableConfig.getIndexingConfig().getStarTreeIndexConfigs()) && !tableConfig.getIndexingConfig().isEnableDefaultStarTree(), \"The upsert table cannot have star-tree index.\");", "url": "https://github.com/apache/pinot/pull/6153#discussion_r507933640", "createdAt": "2020-10-19T17:37:58Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/util/TableConfigUtils.java", "diffHunk": "@@ -265,6 +265,10 @@ protected static void validateUpsertConfig(TableConfig tableConfig, Schema schem\n         tableConfig.getRoutingConfig() != null && RoutingConfig.REPLICA_GROUP_INSTANCE_SELECTOR_TYPE\n             .equalsIgnoreCase(tableConfig.getRoutingConfig().getInstanceSelectorType()),\n         \"Upsert table must use replica-group (i.e. replicaGroup) based routing\");\n+    // no startree index\n+    Preconditions.checkState(\n+        tableConfig.getIndexingConfig().getStarTreeIndexConfigs() == null || tableConfig.getIndexingConfig()\n+            .getStarTreeIndexConfigs().isEmpty(), \"The upsert table cannot have star-tree index.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ddb30bf5fa80a71074c3661c71707311a85e579c"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk0Mjg1MA==", "bodyText": "Still fail??", "url": "https://github.com/apache/pinot/pull/6153#discussion_r507942850", "createdAt": "2020-10-19T17:47:54Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/test/java/org/apache/pinot/core/util/SchemaUtilsTest.java", "diffHunk": "@@ -221,6 +221,30 @@ public void testValidateTimeFieldSpec() {\n     SchemaUtils.validate(pinotSchema);\n   }\n \n+  @Test\n+  public void testValidatePrimaryKeyColumns() {\n+    Schema pinotSchema;\n+    // non-existing column used as primary key\n+    pinotSchema = new Schema.SchemaBuilder()\n+        .addTime(new TimeGranularitySpec(DataType.LONG, TimeUnit.MILLISECONDS, \"time\"),\n+            new TimeGranularitySpec(DataType.INT, TimeUnit.DAYS, \"time\")).addSingleValueDimension(\"col\", DataType.INT)\n+        .setPrimaryKeyColumns(Lists.newArrayList(\"test\")).build();\n+    checkValidationFails(pinotSchema);\n+    // time column used as primary key\n+    pinotSchema = new Schema.SchemaBuilder()\n+        .addTime(new TimeGranularitySpec(DataType.LONG, TimeUnit.MILLISECONDS, \"time\"),\n+            new TimeGranularitySpec(DataType.INT, TimeUnit.DAYS, \"time\")).addSingleValueDimension(\"col\", DataType.INT)\n+        .setPrimaryKeyColumns(Lists.newArrayList(\"time\")).build();\n+    checkValidationFails(pinotSchema);\n+\n+    // valid primary key\n+    pinotSchema = new Schema.SchemaBuilder()\n+        .addTime(new TimeGranularitySpec(DataType.LONG, TimeUnit.MILLISECONDS, \"time\"),\n+            new TimeGranularitySpec(DataType.INT, TimeUnit.DAYS, \"time\")).addSingleValueDimension(\"col\", DataType.INT)\n+        .setPrimaryKeyColumns(Lists.newArrayList(\"col\")).build();\n+    checkValidationFails(pinotSchema);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ddb30bf5fa80a71074c3661c71707311a85e579c"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk1MTA2NQ==", "bodyText": "Why putting this in the else? Also, this filter can never match because a field cannot be both TIME and DATE_TIME", "url": "https://github.com/apache/pinot/pull/6153#discussion_r507951065", "createdAt": "2020-10-19T17:55:51Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/util/SchemaUtils.java", "diffHunk": "@@ -92,6 +93,9 @@ public static void validate(Schema schema) {\n                 \"Exception in getting arguments for transform function '\" + transformFunction + \"' for column '\"\n                     + column + \"'\", e);\n           }\n+        } else if (fieldSpec.getFieldType().equals(FieldSpec.FieldType.TIME) && fieldSpec.getFieldType()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ddb30bf5fa80a71074c3661c71707311a85e579c"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8e0cf26fd20cfba43c2fa912eadad259e5a0a9e", "author": {"user": {"login": "yupeng9", "name": "Yupeng Fu"}}, "url": "https://github.com/apache/pinot/commit/d8e0cf26fd20cfba43c2fa912eadad259e5a0a9e", "committedDate": "2020-10-19T19:24:45Z", "message": "comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79e5dd391d7ed7bcf247d7f0e3f5c9de0f646076", "author": {"user": {"login": "yupeng9", "name": "Yupeng Fu"}}, "url": "https://github.com/apache/pinot/commit/79e5dd391d7ed7bcf247d7f0e3f5c9de0f646076", "committedDate": "2020-10-19T20:19:28Z", "message": "fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMDgxODc4", "url": "https://github.com/apache/pinot/pull/6153#pullrequestreview-512081878", "createdAt": "2020-10-19T19:14:21Z", "commit": {"oid": "ddb30bf5fa80a71074c3661c71707311a85e579c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxOToxNDoyMlrOHkd7Rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxOToxNDoyMlrOHkd7Rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODAwMTA5NQ==", "bodyText": "typo. missed negation", "url": "https://github.com/apache/pinot/pull/6153#discussion_r508001095", "createdAt": "2020-10-19T19:14:22Z", "author": {"login": "yupeng9"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/util/SchemaUtils.java", "diffHunk": "@@ -92,6 +93,9 @@ public static void validate(Schema schema) {\n                 \"Exception in getting arguments for transform function '\" + transformFunction + \"' for column '\"\n                     + column + \"'\", e);\n           }\n+        } else if (fieldSpec.getFieldType().equals(FieldSpec.FieldType.TIME) && fieldSpec.getFieldType()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk1MTA2NQ=="}, "originalCommit": {"oid": "ddb30bf5fa80a71074c3661c71707311a85e579c"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1de567840ca3e109d179f21ba53c6ddea6cadf28", "author": {"user": {"login": "yupeng9", "name": "Yupeng Fu"}}, "url": "https://github.com/apache/pinot/commit/1de567840ca3e109d179f21ba53c6ddea6cadf28", "committedDate": "2020-10-19T23:17:04Z", "message": "address comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMjUzODk3", "url": "https://github.com/apache/pinot/pull/6153#pullrequestreview-512253897", "createdAt": "2020-10-20T00:43:59Z", "commit": {"oid": "1de567840ca3e109d179f21ba53c6ddea6cadf28"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMDo0Mzo1OVrOHkmiPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMDo0NTowMVrOHkmjbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE0MjE0MA==", "bodyText": "Any specific reason why transformed column cannot be primary key column?", "url": "https://github.com/apache/pinot/pull/6153#discussion_r508142140", "createdAt": "2020-10-20T00:43:59Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/util/SchemaUtils.java", "diffHunk": "@@ -92,6 +93,8 @@ public static void validate(Schema schema) {\n                 \"Exception in getting arguments for transform function '\" + transformFunction + \"' for column '\"\n                     + column + \"'\", e);\n           }\n+        } else {\n+          primaryKeyColumnCandidates.add(column);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1de567840ca3e109d179f21ba53c6ddea6cadf28"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE0MjQ0Nw==", "bodyText": "This part is incorrect. You should wrap everything into the preconditions", "url": "https://github.com/apache/pinot/pull/6153#discussion_r508142447", "createdAt": "2020-10-20T00:45:01Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/util/TableConfigUtils.java", "diffHunk": "@@ -265,6 +265,12 @@ protected static void validateUpsertConfig(TableConfig tableConfig, Schema schem\n         tableConfig.getRoutingConfig() != null && RoutingConfig.REPLICA_GROUP_INSTANCE_SELECTOR_TYPE\n             .equalsIgnoreCase(tableConfig.getRoutingConfig().getInstanceSelectorType()),\n         \"Upsert table must use replica-group (i.e. replicaGroup) based routing\");\n+    // no startree index\n+    if (tableConfig.getIndexingConfig() != null && tableConfig.getIndexingConfig().getStarTreeIndexConfigs() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1de567840ca3e109d179f21ba53c6ddea6cadf28"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f400bfcf93f2ffb519ff7491fb75384c7251a85", "author": {"user": {"login": "yupeng9", "name": "Yupeng Fu"}}, "url": "https://github.com/apache/pinot/commit/1f400bfcf93f2ffb519ff7491fb75384c7251a85", "committedDate": "2020-10-20T03:35:11Z", "message": "comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyOTcxMjY2", "url": "https://github.com/apache/pinot/pull/6153#pullrequestreview-512971266", "createdAt": "2020-10-20T17:28:57Z", "commit": {"oid": "1f400bfcf93f2ffb519ff7491fb75384c7251a85"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNzoyODo1N1rOHlJPEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNzozMToxOVrOHlJUsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODcxMDY3NQ==", "bodyText": "If tableConfig.getIndexingConfig().getStarTreeIndexConfigs() is null, but tableConfig.getIndexingConfig().isEnableDefaultStarTree() is true, you will miss the check.\nAlso, tableConfig.getIndexingConfig() can never be null here because it has been checked", "url": "https://github.com/apache/pinot/pull/6153#discussion_r508710675", "createdAt": "2020-10-20T17:28:57Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/util/TableConfigUtils.java", "diffHunk": "@@ -265,6 +265,12 @@ protected static void validateUpsertConfig(TableConfig tableConfig, Schema schem\n         tableConfig.getRoutingConfig() != null && RoutingConfig.REPLICA_GROUP_INSTANCE_SELECTOR_TYPE\n             .equalsIgnoreCase(tableConfig.getRoutingConfig().getInstanceSelectorType()),\n         \"Upsert table must use replica-group (i.e. replicaGroup) based routing\");\n+    // no startree index\n+    if (tableConfig.getIndexingConfig() != null && tableConfig.getIndexingConfig().getStarTreeIndexConfigs() != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE0MjQ0Nw=="}, "originalCommit": {"oid": "1de567840ca3e109d179f21ba53c6ddea6cadf28"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODcxMjExNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (tableConfig.getIndexingConfig() != null && tableConfig.getIndexingConfig().getStarTreeIndexConfigs() != null) {\n          \n          \n            \n                  Preconditions.checkState(\n          \n          \n            \n                      tableConfig.getIndexingConfig().getStarTreeIndexConfigs().isEmpty() && !tableConfig.getIndexingConfig()\n          \n          \n            \n                          .isEnableDefaultStarTree(), \"The upsert table cannot have star-tree index.\");\n          \n          \n            \n                }\n          \n          \n            \n                Preconditions.checkState(\n          \n          \n            \n                    CollectionUtils.isEmpty(tableConfig.getIndexingConfig().getStarTreeIndexConfigs()) && !tableConfig\n          \n          \n            \n                        .getIndexingConfig().isEnableDefaultStarTree(), \"The upsert table cannot have star-tree index.\");", "url": "https://github.com/apache/pinot/pull/6153#discussion_r508712115", "createdAt": "2020-10-20T17:31:19Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/util/TableConfigUtils.java", "diffHunk": "@@ -265,6 +265,12 @@ protected static void validateUpsertConfig(TableConfig tableConfig, Schema schem\n         tableConfig.getRoutingConfig() != null && RoutingConfig.REPLICA_GROUP_INSTANCE_SELECTOR_TYPE\n             .equalsIgnoreCase(tableConfig.getRoutingConfig().getInstanceSelectorType()),\n         \"Upsert table must use replica-group (i.e. replicaGroup) based routing\");\n+    // no startree index\n+    if (tableConfig.getIndexingConfig() != null && tableConfig.getIndexingConfig().getStarTreeIndexConfigs() != null) {\n+      Preconditions.checkState(\n+          tableConfig.getIndexingConfig().getStarTreeIndexConfigs().isEmpty() && !tableConfig.getIndexingConfig()\n+              .isEnableDefaultStarTree(), \"The upsert table cannot have star-tree index.\");\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f400bfcf93f2ffb519ff7491fb75384c7251a85"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12b653723580eb97315a4e6790b84c7ed37aa361", "author": {"user": {"login": "yupeng9", "name": "Yupeng Fu"}}, "url": "https://github.com/apache/pinot/commit/12b653723580eb97315a4e6790b84c7ed37aa361", "committedDate": "2020-10-20T19:24:57Z", "message": "comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMDk2OTQ5", "url": "https://github.com/apache/pinot/pull/6153#pullrequestreview-513096949", "createdAt": "2020-10-20T20:15:53Z", "commit": {"oid": "12b653723580eb97315a4e6790b84c7ed37aa361"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1614, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}