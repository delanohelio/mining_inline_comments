{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5NzQ2ODEx", "number": 6119, "title": "Change Signature of Broker API in Controller", "bodyText": "Add a new /v2/brokers API in the controller. This API is an improvement over the previous API in the sense, that host and port are supplied along with the instance name. The plan is to deprecate the older API in the future.\nThe change is being done so that the query clients such as JDBC and Java client using this API don't have to rely on the hack of splitting the instance name to fetch hostname and port.  The splitting can result in incorrect hosts in case the Pinot cluster is deployed in a managed environment such as K8s", "createdAt": "2020-10-08T08:21:06Z", "url": "https://github.com/apache/pinot/pull/6119", "merged": true, "mergeCommit": {"oid": "33be20770f68604714c47fd0b5d4bffa92422ebf"}, "closed": true, "closedAt": "2020-10-13T20:12:28Z", "author": {"login": "KKcorps"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQcTEyAH2gAyNDk5NzQ2ODExOjQxYTgyMTgyNGQ1MjkxMWJhYTU3NjcxOTBlMzQ1YWQyNjVmZWJhZDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSOXpHAFqTUwNzc5MDkwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "41a821824d52911baa5767190e345ad265febad8", "author": {"user": null}, "url": "https://github.com/apache/pinot/commit/41a821824d52911baa5767190e345ad265febad8", "committedDate": "2020-10-08T07:18:12Z", "message": "Add code for v2 broker api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "987a01d267f2b67798386d5c002c3d5e4275ba2f", "author": {"user": null}, "url": "https://github.com/apache/pinot/commit/987a01d267f2b67798386d5c002c3d5e4275ba2f", "committedDate": "2020-10-08T07:50:33Z", "message": "Change v1 methods to use v2 signature"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MzEzODMx", "url": "https://github.com/apache/pinot/pull/6119#pullrequestreview-505313831", "createdAt": "2020-10-09T02:06:17Z", "commit": {"oid": "987a01d267f2b67798386d5c002c3d5e4275ba2f"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwMjowNjoxN1rOHe3teg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwMzoyNzo1NVrOHe5saA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEzMjA5MA==", "bodyText": "Can we keep the old implementation as there are performance differences", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502132090", "createdAt": "2020-10-09T02:06:17Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/helix/HelixHelper.java", "diffHunk": "@@ -422,10 +423,15 @@ public IdealState apply(@Nullable IdealState idealState) {\n    * reuse instance configs in order to reduce ZK accesses\n    */\n   public static List<String> getInstancesWithTag(List<InstanceConfig> instanceConfigs, String tag) {\n-    List<String> instancesWithTag = new ArrayList<>();\n+    List<InstanceConfig> instancesWithTag = getInstancesConfigsWithTag(instanceConfigs, tag);\n+    return instancesWithTag.stream().map(InstanceConfig::getInstanceName).collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "987a01d267f2b67798386d5c002c3d5e4275ba2f"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEzMjU2OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return new HashSet<>(HelixHelper.getInstancesConfigsWithTag(instanceConfigs, TagNameUtils.getBrokerTagForTenant(tenant)));\n          \n          \n            \n                return new HashSet<>(getInstancesConfigsWithTag(instanceConfigs, TagNameUtils.getBrokerTagForTenant(tenant)));", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502132569", "createdAt": "2020-10-09T02:07:21Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/helix/HelixHelper.java", "diffHunk": "@@ -474,6 +480,12 @@ public IdealState apply(@Nullable IdealState idealState) {\n    * TODO: refactor code to use this method if applicable to reuse instance configs in order to reduce ZK accesses\n    */\n   public static Set<String> getBrokerInstancesForTenant(List<InstanceConfig> instanceConfigs, String tenant) {\n-    return new HashSet<>(HelixHelper.getInstancesWithTag(instanceConfigs, TagNameUtils.getBrokerTagForTenant(tenant)));\n+    return getBrokerInstanceConfigsForTenant(instanceConfigs, tenant).stream().map(InstanceConfig::getInstanceName).collect(\n+        Collectors.toSet());\n   }\n+\n+  public static Set<InstanceConfig> getBrokerInstanceConfigsForTenant(List<InstanceConfig> instanceConfigs, String tenant) {\n+    return new HashSet<>(HelixHelper.getInstancesConfigsWithTag(instanceConfigs, TagNameUtils.getBrokerTagForTenant(tenant)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "987a01d267f2b67798386d5c002c3d5e4275ba2f"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEzMzE3MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return getBrokerInstanceConfigsForTenant(instanceConfigs, tenant).stream().map(InstanceConfig::getInstanceName).collect(\n          \n          \n            \n                    Collectors.toSet());\n          \n          \n            \n                return new HashSet<>(getInstancesWithTag(instanceConfigs, TagNameUtils.getBrokerTagForTenant(tenant)));", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502133171", "createdAt": "2020-10-09T02:08:31Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/helix/HelixHelper.java", "diffHunk": "@@ -474,6 +480,12 @@ public IdealState apply(@Nullable IdealState idealState) {\n    * TODO: refactor code to use this method if applicable to reuse instance configs in order to reduce ZK accesses\n    */\n   public static Set<String> getBrokerInstancesForTenant(List<InstanceConfig> instanceConfigs, String tenant) {\n-    return new HashSet<>(HelixHelper.getInstancesWithTag(instanceConfigs, TagNameUtils.getBrokerTagForTenant(tenant)));\n+    return getBrokerInstanceConfigsForTenant(instanceConfigs, tenant).stream().map(InstanceConfig::getInstanceName).collect(\n+        Collectors.toSet());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "987a01d267f2b67798386d5c002c3d5e4275ba2f"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEzMzQ1Mg==", "bodyText": "Is this used?", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502133452", "createdAt": "2020-10-09T02:09:03Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/Constants.java", "diffHunk": "@@ -36,6 +36,7 @@\n   public static final String SCHEMA_TAG = \"Schema\";\n   public static final String TENANT_TAG = \"Tenant\";\n   public static final String BROKER_TAG = \"Broker\";\n+  public static final String BROKER_V2_TAG = \"BrokerV2\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "987a01d267f2b67798386d5c002c3d5e4275ba2f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEzNjY1Ng==", "bodyText": "Again suggest keeping the current logic for performance concern if this will be called frequently. You may extract a helper function for getting the brokerTenantName to avoid duplicate code", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502136656", "createdAt": "2020-10-09T02:15:00Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManager.java", "diffHunk": "@@ -348,6 +348,11 @@ public InstanceZKMetadata getInstanceZKMetadata(String instanceId) {\n    * @return List of broker instance Ids\n    */\n   public List<String> getBrokerInstancesFor(String tableName) {\n+    List<InstanceConfig> instanceConfigList = getBrokerInstancesConfigsFor(tableName);\n+    return instanceConfigList.stream().map(InstanceConfig::getInstanceName).collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "987a01d267f2b67798386d5c002c3d5e4275ba2f"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE2NDQ0OA==", "bodyText": "Suggest renaming it to InstanceInfo so that it can be reused for server instances if necessary.", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502164448", "createdAt": "2020-10-09T03:27:21Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/ControllerBrokerResponse.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.controller.api.resources;\n+\n+public class ControllerBrokerResponse {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "987a01d267f2b67798386d5c002c3d5e4275ba2f"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE2NDU4NA==", "bodyText": "You can change these variables to final and remove the setters as they are not needed", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502164584", "createdAt": "2020-10-09T03:27:55Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/ControllerBrokerResponse.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.controller.api.resources;\n+\n+public class ControllerBrokerResponse {\n+  private String _instanceName;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "987a01d267f2b67798386d5c002c3d5e4275ba2f"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a1accf846f03c4cac5dbf442594317936a409ac", "author": {"user": null}, "url": "https://github.com/apache/pinot/commit/6a1accf846f03c4cac5dbf442594317936a409ac", "committedDate": "2020-10-09T09:16:33Z", "message": "Refactor: Change class name from ControllerBrokerResponse to InstanceInfo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b245e6ce88b10d63369a902ffc2ef7205fc7e3b", "author": {"user": null}, "url": "https://github.com/apache/pinot/commit/9b245e6ce88b10d63369a902ffc2ef7205fc7e3b", "committedDate": "2020-10-09T09:18:43Z", "message": "Refactor: Remove unused constant and reuse functions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f49a0172a206ccb01f38df840bff3ac250221d8c", "author": {"user": null}, "url": "https://github.com/apache/pinot/commit/f49a0172a206ccb01f38df840bff3ac250221d8c", "committedDate": "2020-10-09T09:21:12Z", "message": "Refactor: Remove class name from the methods called from same class"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2OTcyNzM0", "url": "https://github.com/apache/pinot/pull/6119#pullrequestreview-506972734", "createdAt": "2020-10-12T23:22:21Z", "commit": {"oid": "f49a0172a206ccb01f38df840bff3ac250221d8c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NzkwOTAz", "url": "https://github.com/apache/pinot/pull/6119#pullrequestreview-507790903", "createdAt": "2020-10-13T20:12:22Z", "commit": {"oid": "f49a0172a206ccb01f38df840bff3ac250221d8c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1559, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}