{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1MTUwMTY4", "number": 6073, "title": "Adding more table config validation", "bodyText": "Description\nRelated to issue #5942\n\nAdding more table config validation (retention, pushType and tenant)\nFixing bug where retention manager does not work for real-time tables if the pushType is missing.\n\nUpgrade Notes\nDoes this PR prevent a zero down-time upgrade?\nNo\nDoes this PR fix a zero-downtime upgrade introduced earlier?\nNo\nDoes this PR otherwise need attention when creating release notes?\nNo", "createdAt": "2020-09-29T22:27:15Z", "url": "https://github.com/apache/pinot/pull/6073", "merged": true, "mergeCommit": {"oid": "9929dad2e804f525b8ace925e859e07c6fdee9da"}, "closed": true, "closedAt": "2020-10-02T16:41:56Z", "author": {"login": "icefury71"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNv0BwgH2gAyNDk1MTUwMTY4Ojg4NDk3NTcyY2Y5MDU4YjJkMGUwNmNiYmVhODdkNzg1Y2UyMWY4NzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOYFuagH2gAyNDk1MTUwMTY4OjJmOWU0YmY5NjcyMDQwMGJkOWUwODg3ZWE1ZmI0OTljYjNjNGU4M2Q=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "88497572cf9058b2d0e06cbbea87d785ce21f875", "author": {"user": {"login": "icefury71", "name": null}}, "url": "https://github.com/apache/pinot/commit/88497572cf9058b2d0e06cbbea87d785ce21f875", "committedDate": "2020-09-29T22:20:37Z", "message": "* Adding more table config validation (retention, pushType and tenant)\n* Fixing bug where retention manager does not work for real-time tables\n  if the pushType is missing."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9e354197f5fef57b08884e3de170ef19ddcabe1", "author": {"user": {"login": "icefury71", "name": null}}, "url": "https://github.com/apache/pinot/commit/c9e354197f5fef57b08884e3de170ef19ddcabe1", "committedDate": "2020-09-29T22:25:53Z", "message": "Adding newline at end of TableConfigUtilsTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fb5149df177977518a21e90e06edd4757b92c47", "author": {"user": {"login": "icefury71", "name": null}}, "url": "https://github.com/apache/pinot/commit/3fb5149df177977518a21e90e06edd4757b92c47", "committedDate": "2020-09-30T02:33:56Z", "message": "Allowing null tenant config in the validation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5MDcwNzk2", "url": "https://github.com/apache/pinot/pull/6073#pullrequestreview-499070796", "createdAt": "2020-09-30T04:08:06Z", "commit": {"oid": "3fb5149df177977518a21e90e06edd4757b92c47"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNDowODowNlrOHaMnFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNDowODowNlrOHaMnFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIzMTYzOA==", "bodyText": "This is the same check as PinotHelixResourceManager.validateTableTenantConfig(TableConfig tableConfig)", "url": "https://github.com/apache/pinot/pull/6073#discussion_r497231638", "createdAt": "2020-09-30T04:08:06Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/util/TableConfigUtils.java", "diffHunk": "@@ -76,10 +79,41 @@ public static void validate(TableConfig tableConfig, @Nullable Schema schema) {\n     validateFieldConfigList(tableConfig.getFieldConfigList(), schema);\n   }\n \n+  /**\n+   * Validates all table config including tenant config. This is specifically invoked\n+   * during table config creation, update or validate API calls.\n+   */\n+  public static void validate(TableConfig tableConfig, @Nullable Schema schema, Set<String> serverTenants,\n+      Set<String> brokerTenants) {\n+    validate(tableConfig, schema);\n+    validateTenants(tableConfig, serverTenants, brokerTenants);\n+  }\n+\n+  /**\n+   * Ensures a valid tenant config is provided in the table config.\n+   * Ensures the broker and server tenant names are valid.\n+   */\n+  private static void validateTenants(TableConfig tableConfig, Set<String> serverTenants, Set<String> brokerTenants) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fb5149df177977518a21e90e06edd4757b92c47"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48c76e92652facc6e3f4b57cb7730ccfdee4ccbf", "author": {"user": {"login": "icefury71", "name": null}}, "url": "https://github.com/apache/pinot/commit/48c76e92652facc6e3f4b57cb7730ccfdee4ccbf", "committedDate": "2020-09-30T22:49:40Z", "message": "Remove tenant validation code as per review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5ODgzODU0", "url": "https://github.com/apache/pinot/pull/6073#pullrequestreview-499883854", "createdAt": "2020-09-30T23:40:55Z", "commit": {"oid": "48c76e92652facc6e3f4b57cb7730ccfdee4ccbf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0307db867bdcac0461ccef02f7b317147d6117d", "author": {"user": {"login": "icefury71", "name": null}}, "url": "https://github.com/apache/pinot/commit/c0307db867bdcac0461ccef02f7b317147d6117d", "committedDate": "2020-10-01T19:01:19Z", "message": "Adding server and broker tenant check for multi-tenant clusters"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNjQyNjE1", "url": "https://github.com/apache/pinot/pull/6073#pullrequestreview-500642615", "createdAt": "2020-10-01T19:11:42Z", "commit": {"oid": "c0307db867bdcac0461ccef02f7b317147d6117d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxOToxMTo0MlrOHbXlTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxOToxMTo0MlrOHbXlTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ1OTk4Mg==", "bodyText": "You should put default tenant here if it is single-tenant cluster, similar to addTable()\nYou may extract this part into a helper method", "url": "https://github.com/apache/pinot/pull/6073#discussion_r498459982", "createdAt": "2020-10-01T19:11:42Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManager.java", "diffHunk": "@@ -1374,6 +1378,14 @@ private void assignInstances(TableConfig tableConfig, boolean override) {\n    */\n   public void updateTableConfig(TableConfig tableConfig)\n       throws IOException {\n+    TenantConfig tenantConfig = tableConfig.getTenantConfig();\n+    String brokerTag = tenantConfig.getBroker();\n+    String serverTag = tenantConfig.getServer();\n+    if (brokerTag == null || serverTag == null) {\n+      if (!_isSingleTenantCluster) {\n+        throw new InvalidTableConfigException(\"server and broker tenants must be specified for multi-tenant cluster\");\n+      }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0307db867bdcac0461ccef02f7b317147d6117d"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a882a9da3714bed9e75c7609349e0bb971cdf2bc", "author": {"user": {"login": "icefury71", "name": null}}, "url": "https://github.com/apache/pinot/commit/a882a9da3714bed9e75c7609349e0bb971cdf2bc", "committedDate": "2020-10-01T19:36:04Z", "message": "Refactoring tenant validation code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNjY0ODY5", "url": "https://github.com/apache/pinot/pull/6073#pullrequestreview-500664869", "createdAt": "2020-10-01T19:44:32Z", "commit": {"oid": "a882a9da3714bed9e75c7609349e0bb971cdf2bc"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxOTo0NDozMlrOHbYiNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxOTo0NDozMlrOHbYiNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3NTU3NQ==", "bodyText": "That's also put the table name within the exception message", "url": "https://github.com/apache/pinot/pull/6073#discussion_r498475575", "createdAt": "2020-10-01T19:44:32Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManager.java", "diffHunk": "@@ -1195,12 +1182,26 @@ public void addTable(TableConfig tableConfig)\n   }\n \n   /**\n-   * Validates the tenant config for the table\n+   * Validates the tenant config for the table. In case of a single tenant cluster,\n+   * if the server and broker tenants are not specified in the config, they're\n+   * auto-populated with the default tenant name. In case of a multi-tenant cluster,\n+   * these parameters must be specified in the table config.\n    */\n   @VisibleForTesting\n   void validateTableTenantConfig(TableConfig tableConfig) {\n-    String tableNameWithType = tableConfig.getTableName();\n     TenantConfig tenantConfig = tableConfig.getTenantConfig();\n+    String brokerTag = tenantConfig.getBroker();\n+    String serverTag = tenantConfig.getServer();\n+    if (brokerTag == null || serverTag == null) {\n+      if (!_isSingleTenantCluster) {\n+        throw new InvalidTableConfigException(\"server and broker tenants must be specified for multi-tenant cluster\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a882a9da3714bed9e75c7609349e0bb971cdf2bc"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f9e4bf96720400bd9e0887ea5fb499cb3c4e83d", "author": {"user": {"login": "icefury71", "name": null}}, "url": "https://github.com/apache/pinot/commit/2f9e4bf96720400bd9e0887ea5fb499cb3c4e83d", "committedDate": "2020-10-01T21:16:09Z", "message": "Enhancing exception message with table name"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1492, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}