{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2NzI5MDQx", "number": 5014, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxODowNToxNlrODakQuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxODoxMDo0NFrODakWPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MTgzNjczOnYy", "diffSide": "RIGHT", "path": "pinot-common/src/test/java/org/apache/pinot/sql/parsers/CalciteSqlCompilerTest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxODowNToxN1rOFhl23A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQyMDoxNTozNVrOFhpQ8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc2NzU4MA==", "bodyText": "Add one more test to cover cases like \"select A, count(*) from table group by A,B\"?", "url": "https://github.com/apache/pinot/pull/5014#discussion_r370767580", "createdAt": "2020-01-24T18:05:17Z", "author": {"login": "chenboat"}, "path": "pinot-common/src/test/java/org/apache/pinot/sql/parsers/CalciteSqlCompilerTest.java", "diffHunk": "@@ -832,4 +849,17 @@ public void testSqlDistinctQueryCompilation() {\n     Assert.assertEquals(aggregationInfo.getAggregationParams().get(FunctionCallAstNode.COLUMN_KEY_IN_AGGREGATION_INFO),\n         \"add(div(col1,col2),mul(col3,col4)):sub(col3,col4):col5:col6\");\n   }\n+\n+  @Test\n+  public void testQueryValidationFailure() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "766f01b8a707f06e7a0fe7b4e32becc570470cbe"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgxODQ5OA==", "bodyText": "I thought this is a valid query ?", "url": "https://github.com/apache/pinot/pull/5014#discussion_r370818498", "createdAt": "2020-01-24T20:02:28Z", "author": {"login": "xiangfu0"}, "path": "pinot-common/src/test/java/org/apache/pinot/sql/parsers/CalciteSqlCompilerTest.java", "diffHunk": "@@ -832,4 +849,17 @@ public void testSqlDistinctQueryCompilation() {\n     Assert.assertEquals(aggregationInfo.getAggregationParams().get(FunctionCallAstNode.COLUMN_KEY_IN_AGGREGATION_INFO),\n         \"add(div(col1,col2),mul(col3,col4)):sub(col3,col4):col5:col6\");\n   }\n+\n+  @Test\n+  public void testQueryValidationFailure() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc2NzU4MA=="}, "originalCommit": {"oid": "766f01b8a707f06e7a0fe7b4e32becc570470cbe"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgyMzQwOQ==", "bodyText": "added this to the test", "url": "https://github.com/apache/pinot/pull/5014#discussion_r370823409", "createdAt": "2020-01-24T20:15:35Z", "author": {"login": "xiangfu0"}, "path": "pinot-common/src/test/java/org/apache/pinot/sql/parsers/CalciteSqlCompilerTest.java", "diffHunk": "@@ -832,4 +849,17 @@ public void testSqlDistinctQueryCompilation() {\n     Assert.assertEquals(aggregationInfo.getAggregationParams().get(FunctionCallAstNode.COLUMN_KEY_IN_AGGREGATION_INFO),\n         \"add(div(col1,col2),mul(col3,col4)):sub(col3,col4):col5:col6\");\n   }\n+\n+  @Test\n+  public void testQueryValidationFailure() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc2NzU4MA=="}, "originalCommit": {"oid": "766f01b8a707f06e7a0fe7b4e32becc570470cbe"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MTgzOTk3OnYy", "diffSide": "RIGHT", "path": "pinot-common/src/main/java/org/apache/pinot/sql/parsers/CalciteSqlParser.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxODowNjozMFrOFhl40g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQyMDoxNTo0MVrOFhpRGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc2ODA4Mg==", "bodyText": "NIT: use if(pinotQuery.getGroupByList() == null) return; to reduce the nest levels.", "url": "https://github.com/apache/pinot/pull/5014#discussion_r370768082", "createdAt": "2020-01-24T18:06:30Z", "author": {"login": "chenboat"}, "path": "pinot-common/src/main/java/org/apache/pinot/sql/parsers/CalciteSqlParser.java", "diffHunk": "@@ -92,6 +94,34 @@ public static PinotQuery compileToPinotQuery(String sql)\n     return pinotQuery;\n   }\n \n+  static void validate(PinotQuery pinotQuery)\n+      throws SqlCompilationException {\n+    // Sanity check group by query: All identifiers in selection list should be also included in group by list.\n+    if (pinotQuery.getGroupByList() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "766f01b8a707f06e7a0fe7b4e32becc570470cbe"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgyMzQ0OQ==", "bodyText": "done", "url": "https://github.com/apache/pinot/pull/5014#discussion_r370823449", "createdAt": "2020-01-24T20:15:41Z", "author": {"login": "xiangfu0"}, "path": "pinot-common/src/main/java/org/apache/pinot/sql/parsers/CalciteSqlParser.java", "diffHunk": "@@ -92,6 +94,34 @@ public static PinotQuery compileToPinotQuery(String sql)\n     return pinotQuery;\n   }\n \n+  static void validate(PinotQuery pinotQuery)\n+      throws SqlCompilationException {\n+    // Sanity check group by query: All identifiers in selection list should be also included in group by list.\n+    if (pinotQuery.getGroupByList() != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc2ODA4Mg=="}, "originalCommit": {"oid": "766f01b8a707f06e7a0fe7b4e32becc570470cbe"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MTg0NDE2OnYy", "diffSide": "RIGHT", "path": "pinot-common/src/main/java/org/apache/pinot/sql/parsers/CalciteSqlParser.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxODowODowNFrOFhl7gQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQyMDowNTo1OVrOFhpDCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc2ODc2OQ==", "bodyText": "Should we check identifiers or expressions?", "url": "https://github.com/apache/pinot/pull/5014#discussion_r370768769", "createdAt": "2020-01-24T18:08:04Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-common/src/main/java/org/apache/pinot/sql/parsers/CalciteSqlParser.java", "diffHunk": "@@ -92,6 +94,34 @@ public static PinotQuery compileToPinotQuery(String sql)\n     return pinotQuery;\n   }\n \n+  static void validate(PinotQuery pinotQuery)\n+      throws SqlCompilationException {\n+    // Sanity check group by query: All identifiers in selection list should be also included in group by list.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "766f01b8a707f06e7a0fe7b4e32becc570470cbe"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc3MDY4OQ==", "bodyText": "I don't think we should support function expressions part of GROUP BY clause. See example here #5014 (comment)", "url": "https://github.com/apache/pinot/pull/5014#discussion_r370770689", "createdAt": "2020-01-24T18:12:49Z", "author": {"login": "siddharthteotia"}, "path": "pinot-common/src/main/java/org/apache/pinot/sql/parsers/CalciteSqlParser.java", "diffHunk": "@@ -92,6 +94,34 @@ public static PinotQuery compileToPinotQuery(String sql)\n     return pinotQuery;\n   }\n \n+  static void validate(PinotQuery pinotQuery)\n+      throws SqlCompilationException {\n+    // Sanity check group by query: All identifiers in selection list should be also included in group by list.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc2ODc2OQ=="}, "originalCommit": {"oid": "766f01b8a707f06e7a0fe7b4e32becc570470cbe"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgxOTg0OQ==", "bodyText": "GroupBy clause could be non-aggregate expressions, like dateConverter(), ADD(...), SUB(...)", "url": "https://github.com/apache/pinot/pull/5014#discussion_r370819849", "createdAt": "2020-01-24T20:05:59Z", "author": {"login": "xiangfu0"}, "path": "pinot-common/src/main/java/org/apache/pinot/sql/parsers/CalciteSqlParser.java", "diffHunk": "@@ -92,6 +94,34 @@ public static PinotQuery compileToPinotQuery(String sql)\n     return pinotQuery;\n   }\n \n+  static void validate(PinotQuery pinotQuery)\n+      throws SqlCompilationException {\n+    // Sanity check group by query: All identifiers in selection list should be also included in group by list.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc2ODc2OQ=="}, "originalCommit": {"oid": "766f01b8a707f06e7a0fe7b4e32becc570470cbe"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MTg1MDg3OnYy", "diffSide": "RIGHT", "path": "pinot-common/src/test/java/org/apache/pinot/sql/parsers/CalciteSqlCompilerTest.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxODoxMDo0NFrOFhl_kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQyMDo0Mjo1NFrOFhp4GQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc2OTgxMQ==", "bodyText": "I agree that we should be checking for identifiers. However, I think a query like this:\nSELECT State, Count() from Customers GROUP BY State, Count() should not be supported.\nIn other words, we should not have the aggregations as one of the GROUP BY columns.", "url": "https://github.com/apache/pinot/pull/5014#discussion_r370769811", "createdAt": "2020-01-24T18:10:44Z", "author": {"login": "siddharthteotia"}, "path": "pinot-common/src/test/java/org/apache/pinot/sql/parsers/CalciteSqlCompilerTest.java", "diffHunk": "@@ -832,4 +849,17 @@ public void testSqlDistinctQueryCompilation() {\n     Assert.assertEquals(aggregationInfo.getAggregationParams().get(FunctionCallAstNode.COLUMN_KEY_IN_AGGREGATION_INFO),\n         \"add(div(col1,col2),mul(col3,col4)):sub(col3,col4):col5:col6\");\n   }\n+\n+  @Test\n+  public void testQueryValidationFailure() {\n+    String sql;\n+    try {\n+      sql = \"select group_city,group_country, sum(rsvp_count), count(*) from meetupRsvp group by group_country, sum(rsvp_count), count(*) limit 50\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "766f01b8a707f06e7a0fe7b4e32becc570470cbe"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc3MDE5MA==", "bodyText": "Try the following queries here https://www.w3schools.com/sql/trysql.asp?filename=trysql_select_no_distinct\n(1) SELECT City, SUM(PostalCode) FROM Customers GROUP BY City, SUM(PostalCode)\n(2) SELECT City, SUM(PostalCode) FROM Customers GROUP BY City\n(2) is valid whereas (1) fails", "url": "https://github.com/apache/pinot/pull/5014#discussion_r370770190", "createdAt": "2020-01-24T18:11:39Z", "author": {"login": "siddharthteotia"}, "path": "pinot-common/src/test/java/org/apache/pinot/sql/parsers/CalciteSqlCompilerTest.java", "diffHunk": "@@ -832,4 +849,17 @@ public void testSqlDistinctQueryCompilation() {\n     Assert.assertEquals(aggregationInfo.getAggregationParams().get(FunctionCallAstNode.COLUMN_KEY_IN_AGGREGATION_INFO),\n         \"add(div(col1,col2),mul(col3,col4)):sub(col3,col4):col5:col6\");\n   }\n+\n+  @Test\n+  public void testQueryValidationFailure() {\n+    String sql;\n+    try {\n+      sql = \"select group_city,group_country, sum(rsvp_count), count(*) from meetupRsvp group by group_country, sum(rsvp_count), count(*) limit 50\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc2OTgxMQ=="}, "originalCommit": {"oid": "766f01b8a707f06e7a0fe7b4e32becc570470cbe"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc3MDg4Mg==", "bodyText": "So we should add tests for this case too", "url": "https://github.com/apache/pinot/pull/5014#discussion_r370770882", "createdAt": "2020-01-24T18:13:15Z", "author": {"login": "siddharthteotia"}, "path": "pinot-common/src/test/java/org/apache/pinot/sql/parsers/CalciteSqlCompilerTest.java", "diffHunk": "@@ -832,4 +849,17 @@ public void testSqlDistinctQueryCompilation() {\n     Assert.assertEquals(aggregationInfo.getAggregationParams().get(FunctionCallAstNode.COLUMN_KEY_IN_AGGREGATION_INFO),\n         \"add(div(col1,col2),mul(col3,col4)):sub(col3,col4):col5:col6\");\n   }\n+\n+  @Test\n+  public void testQueryValidationFailure() {\n+    String sql;\n+    try {\n+      sql = \"select group_city,group_country, sum(rsvp_count), count(*) from meetupRsvp group by group_country, sum(rsvp_count), count(*) limit 50\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc2OTgxMQ=="}, "originalCommit": {"oid": "766f01b8a707f06e7a0fe7b4e32becc570470cbe"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc3MjAzOQ==", "bodyText": "The error seen on executing the above examples as per the w3schools website is:\nError 1: could not prepare statement (1 aggregate functions are not allowed in the GROUP BY clause).", "url": "https://github.com/apache/pinot/pull/5014#discussion_r370772039", "createdAt": "2020-01-24T18:16:02Z", "author": {"login": "siddharthteotia"}, "path": "pinot-common/src/test/java/org/apache/pinot/sql/parsers/CalciteSqlCompilerTest.java", "diffHunk": "@@ -832,4 +849,17 @@ public void testSqlDistinctQueryCompilation() {\n     Assert.assertEquals(aggregationInfo.getAggregationParams().get(FunctionCallAstNode.COLUMN_KEY_IN_AGGREGATION_INFO),\n         \"add(div(col1,col2),mul(col3,col4)):sub(col3,col4):col5:col6\");\n   }\n+\n+  @Test\n+  public void testQueryValidationFailure() {\n+    String sql;\n+    try {\n+      sql = \"select group_city,group_country, sum(rsvp_count), count(*) from meetupRsvp group by group_country, sum(rsvp_count), count(*) limit 50\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc2OTgxMQ=="}, "originalCommit": {"oid": "766f01b8a707f06e7a0fe7b4e32becc570470cbe"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgxOTU0NA==", "bodyText": "GROUP BY clause shouldn't contain aggregate expression like sum(PostalCode), however, you can still do dateConverter(secondsSinceEpoch) etc, which is non-aggregate Transform function. Or expressions like ADD(a,b).\nMy validate assumes that group by clause is always non-aggregate expression, so that we could extract all the identifier from them.", "url": "https://github.com/apache/pinot/pull/5014#discussion_r370819544", "createdAt": "2020-01-24T20:05:08Z", "author": {"login": "xiangfu0"}, "path": "pinot-common/src/test/java/org/apache/pinot/sql/parsers/CalciteSqlCompilerTest.java", "diffHunk": "@@ -832,4 +849,17 @@ public void testSqlDistinctQueryCompilation() {\n     Assert.assertEquals(aggregationInfo.getAggregationParams().get(FunctionCallAstNode.COLUMN_KEY_IN_AGGREGATION_INFO),\n         \"add(div(col1,col2),mul(col3,col4)):sub(col3,col4):col5:col6\");\n   }\n+\n+  @Test\n+  public void testQueryValidationFailure() {\n+    String sql;\n+    try {\n+      sql = \"select group_city,group_country, sum(rsvp_count), count(*) from meetupRsvp group by group_country, sum(rsvp_count), count(*) limit 50\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc2OTgxMQ=="}, "originalCommit": {"oid": "766f01b8a707f06e7a0fe7b4e32becc570470cbe"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgzMzQzMw==", "bodyText": "Also added a validation to prevent aggregate expression in group by clause.", "url": "https://github.com/apache/pinot/pull/5014#discussion_r370833433", "createdAt": "2020-01-24T20:42:54Z", "author": {"login": "xiangfu0"}, "path": "pinot-common/src/test/java/org/apache/pinot/sql/parsers/CalciteSqlCompilerTest.java", "diffHunk": "@@ -832,4 +849,17 @@ public void testSqlDistinctQueryCompilation() {\n     Assert.assertEquals(aggregationInfo.getAggregationParams().get(FunctionCallAstNode.COLUMN_KEY_IN_AGGREGATION_INFO),\n         \"add(div(col1,col2),mul(col3,col4)):sub(col3,col4):col5:col6\");\n   }\n+\n+  @Test\n+  public void testQueryValidationFailure() {\n+    String sql;\n+    try {\n+      sql = \"select group_city,group_country, sum(rsvp_count), count(*) from meetupRsvp group by group_country, sum(rsvp_count), count(*) limit 50\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc2OTgxMQ=="}, "originalCommit": {"oid": "766f01b8a707f06e7a0fe7b4e32becc570470cbe"}, "originalPosition": 33}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3638, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}