{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ1NTU0NTc4", "number": 6385, "title": "cleanup tar.gz segment files on job exit", "bodyText": "Description\nRemove tar.gz segment files from the output directory on job exit.\nTesting:\nVerified the segment deletion by running pinot locally for jobType SegmentCreationAndTarPush and SegmentCreationAndUriPush\nIssue #6349\nUpgrade Notes\nDoes this PR prevent a zero down-time upgrade? (Assume upgrade order: Controller, Broker, Server, Minion)\n\n Yes (Please label as backward-incompat, and complete the section below on Release Notes)\n\nDoes this PR fix a zero-downtime upgrade introduced earlier?\n\n Yes (Please label this as backward-incompat, and complete the section below on Release Notes)\n\nDoes this PR otherwise need attention when creating release notes? Things to consider:\n\nNew configuration options\nDeprecation of configurations\nSignature changes to public methods/interfaces\nNew plugins added or old plugins removed\n\n\n Yes (Please label this PR as release-notes and complete the section on Release Notes)\n\nRelease Notes\nIf you have tagged this as either backward-incompat or release-notes,\nyou MUST add text here that you would like to see appear in release notes of the\nnext release.\nIf you have a series of commits adding or enabling a feature, then\nadd this section only in final commit that marks the feature completed.\nRefer to earlier release notes to see examples of text\nDocumentation\nIf you have introduced a new feature or configuration, please add it to the documentation as well.\nSee https://docs.pinot.apache.org/developers/developers-and-contributors/update-document", "createdAt": "2020-12-25T08:48:29Z", "url": "https://github.com/apache/pinot/pull/6385", "merged": true, "mergeCommit": {"oid": "6b43aef4c9d4bd558c29ca3b68552f91bcaff693"}, "closed": true, "closedAt": "2020-12-29T20:03:44Z", "author": {"login": "amarnathkarthik"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdpkRCFgH2gAyNTQ1NTU0NTc4Ojk0MDMyOGRkNzliMTIyNzc3Mzc5ZTRkNDcxM2M1ODkzNzBkZWM2ZWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdqx03ogFqTU1OTM2MzAwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "940328dd79b122777379e4d4713c589370dec6ec", "author": {"user": {"login": "amarnathkarthik", "name": "Karthik Amarnath"}}, "url": "https://github.com/apache/pinot/commit/940328dd79b122777379e4d4713c589370dec6ec", "committedDate": "2020-12-25T08:43:19Z", "message": "cleanup tar.gz post upload complete."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4ODM3MDY1", "url": "https://github.com/apache/pinot/pull/6385#pullrequestreview-558837065", "createdAt": "2020-12-25T21:16:47Z", "commit": {"oid": "940328dd79b122777379e4d4713c589370dec6ec"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNVQyMToxNjo0N1rOILe9tA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNVQyMToyMTowNVrOILe-uQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxMjU2NA==", "bodyText": "this one assumes the tar file is on local disk, which may not be true always. E.g. the tar file could be on S3.\nThe path is s3://<my-bucket>/<my-tar>.tar.gz\nIn this case, you need to use PinotFs to delete the tar file.", "url": "https://github.com/apache/pinot/pull/6385#discussion_r548912564", "createdAt": "2020-12-25T21:16:47Z", "author": {"login": "xiangfu0"}, "path": "pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java", "diffHunk": "@@ -134,6 +135,8 @@ public static void pushSegments(SegmentGenerationJobSpec spec, PinotFS fileSyste\n                       segmentName, controllerURI, e);\n               throw e;\n             }\n+          } finally {\n+            FileUtils.deleteQuietly(tarFile);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "940328dd79b122777379e4d4713c589370dec6ec"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxMjU4Nw==", "bodyText": "Same above.", "url": "https://github.com/apache/pinot/pull/6385#discussion_r548912587", "createdAt": "2020-12-25T21:16:58Z", "author": {"login": "xiangfu0"}, "path": "pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java", "diffHunk": "@@ -183,6 +187,8 @@ public static void sendSegmentUris(SegmentGenerationJobSpec spec, List<String> s\n                   tableName, segmentUri, controllerURI, e);\n               throw e;\n             }\n+          } finally {\n+            FileUtils.deleteQuietly(segmentPath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "940328dd79b122777379e4d4713c589370dec6ec"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxMjgyNQ==", "bodyText": "Please use flag to turn on/off this deletion.", "url": "https://github.com/apache/pinot/pull/6385#discussion_r548912825", "createdAt": "2020-12-25T21:21:05Z", "author": {"login": "xiangfu0"}, "path": "pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java", "diffHunk": "@@ -134,6 +135,8 @@ public static void pushSegments(SegmentGenerationJobSpec spec, PinotFS fileSyste\n                       segmentName, controllerURI, e);\n               throw e;\n             }\n+          } finally {\n+            FileUtils.deleteQuietly(tarFile);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "940328dd79b122777379e4d4713c589370dec6ec"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8cbe1b9cd3be11e4a618e95ac5884a8ac1690af", "author": {"user": {"login": "amarnathkarthik", "name": "Karthik Amarnath"}}, "url": "https://github.com/apache/pinot/commit/e8cbe1b9cd3be11e4a618e95ac5884a8ac1690af", "committedDate": "2020-12-26T09:15:24Z", "message": "cleanup tar.gz segment files on job exit."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4OTUwMzY1", "url": "https://github.com/apache/pinot/pull/6385#pullrequestreview-558950365", "createdAt": "2020-12-27T18:09:47Z", "commit": {"oid": "e8cbe1b9cd3be11e4a618e95ac5884a8ac1690af"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yN1QxODowOTo0N1rOILtTXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yN1QxODowOTo0N1rOILtTXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTE0NzQ4Ng==", "bodyText": "Any specific reason to create this variable, as opposed to using spec.isCleanupOutputDir() inline, given that it is just used in one place?", "url": "https://github.com/apache/pinot/pull/6385#discussion_r549147486", "createdAt": "2020-12-27T18:09:47Z", "author": {"login": "mayankshriv"}, "path": "pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java", "diffHunk": "@@ -87,6 +89,7 @@ public static URI generateSegmentTarURI(URI dirURI, URI fileURI, String prefix,\n   public static void pushSegments(SegmentGenerationJobSpec spec, PinotFS fileSystem, List<String> tarFilePaths)\n       throws RetriableOperationException, AttemptsExceededException {\n     String tableName = spec.getTableSpec().getTableName();\n+    boolean cleanUpOutputDir = spec.isCleanUpOutputDir();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8cbe1b9cd3be11e4a618e95ac5884a8ac1690af"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MzYzMDAz", "url": "https://github.com/apache/pinot/pull/6385#pullrequestreview-559363003", "createdAt": "2020-12-29T03:05:09Z", "commit": {"oid": "e8cbe1b9cd3be11e4a618e95ac5884a8ac1690af"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1696, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}