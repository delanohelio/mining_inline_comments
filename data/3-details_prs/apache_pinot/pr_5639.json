{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxODI0NzM2", "number": 5639, "title": "Refactor how Pinot controller stores segment download url in Zookeeper to deal with peer uri format", "bodyText": "Description\nAdd a description of your PR here.\nAs part of the deepstore by-passing project, a Pinot server may pass a Peer segment location to Pinot controller (format like peer:///segment1). For such peer segment location, during the commit phase of the LLC protocol, we modify the controller behavior such that (1) controller does need to move segments during commitEnd() phase of split commit (2) controller will store an empty string '' in the zk.\n@mcvsubbu\nUpgrade Notes\nDoes this PR prevent a zero down-time upgrade? (Assume upgrade order: Controller, Broker, Server, Minion)\n\n Yes (Please label as backward-incompat, and complete the section below on Release Notes)\n\nDoes this PR fix a zero-downtime upgrade introduced earlier?\n\n Yes (Please label this as backward-incompat, and complete the section below on Release Notes)\n\nDoes this PR otherwise need attention when creating release notes? Things to consider:\n\nNew configuration options\nDeprecation of configurations\nSignature changes to public methods/interfaces\nNew plugins added or old plugins removed\n\n\n Yes (Please label this PR as release-notes and complete the section on Release Notes)\n\nRelease Notes\nIf you have tagged this as either backward-incompat or release-notes,\nyou MUST add text here that you would like to see appear in release notes of the\nnext release.\nIf you have a series of commits adding or enabling a feature, then\nadd this section only in final commit that marks the feature completed.\nRefer to earlier release notes to see examples of text\nDocumentation\nIf you have introduced a new feature or configuration, please add it to the documentation as well.\nSee https://docs.pinot.apache.org/developers/developers-and-contributors/update-document", "createdAt": "2020-06-30T06:59:44Z", "url": "https://github.com/apache/pinot/pull/5639", "merged": true, "mergeCommit": {"oid": "72311af185822d5b0a91ed9de6ef8e3510151581"}, "closed": true, "closedAt": "2020-07-02T16:34:47Z", "author": {"login": "chenboat"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcvMlw_AH2gAyNDQxODI0NzM2OjkwZjQ0MTgyNmJkY2FmNDBiYTY1NDNiMmZlZTdlMDNmZjE1NDA5NzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcxBhTRgFqTQ0MTg1NTQ4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "90f441826bdcaf40ba6543b2fee7e03ff1540973", "author": {"user": {"login": "chenboat", "name": "Ting Chen"}}, "url": "https://github.com/apache/pinot/commit/90f441826bdcaf40ba6543b2fee7e03ff1540973", "committedDate": "2020-06-27T00:20:38Z", "message": "Initial commit for controller side change."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a45fcd4312578caeeef224e284e2cdd0ea86c3a", "author": {"user": {"login": "chenboat", "name": "Ting Chen"}}, "url": "https://github.com/apache/pinot/commit/2a45fcd4312578caeeef224e284e2cdd0ea86c3a", "committedDate": "2020-06-30T06:44:56Z", "message": "Revised based on email discussion and add more tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "041758b8b39c82bfd3d1618fec1b13418e4fda84", "author": {"user": {"login": "chenboat", "name": "Ting Chen"}}, "url": "https://github.com/apache/pinot/commit/041758b8b39c82bfd3d1618fec1b13418e4fda84", "committedDate": "2020-06-30T22:24:44Z", "message": "Fix integration tests by adding segment location to descriptor."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6366a0087fd68c943d67b8fde2eba01e27b3b75", "author": {"user": {"login": "chenboat", "name": "Ting Chen"}}, "url": "https://github.com/apache/pinot/commit/a6366a0087fd68c943d67b8fde2eba01e27b3b75", "committedDate": "2020-07-01T06:48:46Z", "message": "Add handling of controller vip based segment download url. Add more tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMDk1ODMz", "url": "https://github.com/apache/pinot/pull/5639#pullrequestreview-441095833", "createdAt": "2020-07-01T18:14:56Z", "commit": {"oid": "a6366a0087fd68c943d67b8fde2eba01e27b3b75"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxODoxNDo1NlrOGrwgpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxODoyMDo0MlrOGrwriQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUzNjc0Mw==", "bodyText": "we dont need to check the peer download scheme here, since we check and put the right value while committing metadata in PinotLLCRealtimeSegmentManager. We can always set the segment location. The if condition can be as before", "url": "https://github.com/apache/pinot/pull/5639#discussion_r448536743", "createdAt": "2020-07-01T18:14:56Z", "author": {"login": "mcvsubbu"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/realtime/SegmentCompletionManager.java", "diffHunk": "@@ -1068,16 +1069,28 @@ private int numReplicasToLookFor() {\n       _state = State.COMMITTING;\n       // In case of splitCommit, the segment is uploaded to a unique file name indicated by segmentLocation,\n       // so we need to move the segment file to its permanent location first before committing the metadata.\n-      if (isSplitCommit) {\n+      // The committingSegmentDescriptor is then updated with the permanent segment location to be saved in metadata\n+      // store.\n+      // The exception is when the server uses the Peer segment download scheme, in such case, there is no need to\n+      // move the segment.\n+      if (isSplitCommit && !isPeerSegmentDownloadScheme(committingSegmentDescriptor)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6366a0087fd68c943d67b8fde2eba01e27b3b75"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUzOTUyOQ==", "bodyText": "check the descriptor for peer  scheme in this method, and move only if it is not peer scheme. leave the descriptor.location as is if it is peer scheme. If not, update the location with the final location in this method. You can still return void.", "url": "https://github.com/apache/pinot/pull/5639#discussion_r448539529", "createdAt": "2020-07-01T18:20:42Z", "author": {"login": "mcvsubbu"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/realtime/PinotLLCRealtimeSegmentManager.java", "diffHunk": "@@ -355,8 +355,9 @@ void setIdealState(String realtimeTableName, IdealState idealState) {\n    * This method moves the segment file from another location to its permanent location.\n    * When splitCommit is enabled, segment file is uploaded to the segmentLocation in the committingSegmentDescriptor,\n    * and we need to move the segment file to its permanent location before committing the segment metadata.\n+   * Return the permanent location of the segment if the commit succeeds.\n    */\n-  public void commitSegmentFile(String realtimeTableName, CommittingSegmentDescriptor committingSegmentDescriptor)\n+  public String commitSegmentFile(String realtimeTableName, CommittingSegmentDescriptor committingSegmentDescriptor)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6366a0087fd68c943d67b8fde2eba01e27b3b75"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cad2b84a6ee7e2882f4dca1cf4e7c1ef6617867b", "author": {"user": {"login": "chenboat", "name": "Ting Chen"}}, "url": "https://github.com/apache/pinot/commit/cad2b84a6ee7e2882f4dca1cf4e7c1ef6617867b", "committedDate": "2020-07-01T19:37:28Z", "message": "Revise based on comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjQ4OTA0", "url": "https://github.com/apache/pinot/pull/5639#pullrequestreview-441248904", "createdAt": "2020-07-01T23:04:54Z", "commit": {"oid": "cad2b84a6ee7e2882f4dca1cf4e7c1ef6617867b"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMzowNDo1NFrOGr4CUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMzoxMDo1MlrOGr4JJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2MDA0OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Updated the segment location to the uri which the segment is moved to.\n          \n          \n            \n               * Modifies the segment location in committingSegmentDescriptor to the uri which the segment is moved to", "url": "https://github.com/apache/pinot/pull/5639#discussion_r448660049", "createdAt": "2020-07-01T23:04:54Z", "author": {"login": "mcvsubbu"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/realtime/PinotLLCRealtimeSegmentManager.java", "diffHunk": "@@ -355,10 +355,17 @@ void setIdealState(String realtimeTableName, IdealState idealState) {\n    * This method moves the segment file from another location to its permanent location.\n    * When splitCommit is enabled, segment file is uploaded to the segmentLocation in the committingSegmentDescriptor,\n    * and we need to move the segment file to its permanent location before committing the segment metadata.\n+   * Updated the segment location to the uri which the segment is moved to.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cad2b84a6ee7e2882f4dca1cf4e7c1ef6617867b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2MDI2Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Exception: for committingSegmentDescriptor with peer download scheme in its segment location, there is no need for\n          \n          \n            \n               * unless committingSegmentDescriptor has a peer download uri scheme in segment location.", "url": "https://github.com/apache/pinot/pull/5639#discussion_r448660267", "createdAt": "2020-07-01T23:05:36Z", "author": {"login": "mcvsubbu"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/realtime/PinotLLCRealtimeSegmentManager.java", "diffHunk": "@@ -355,10 +355,17 @@ void setIdealState(String realtimeTableName, IdealState idealState) {\n    * This method moves the segment file from another location to its permanent location.\n    * When splitCommit is enabled, segment file is uploaded to the segmentLocation in the committingSegmentDescriptor,\n    * and we need to move the segment file to its permanent location before committing the segment metadata.\n+   * Updated the segment location to the uri which the segment is moved to.\n+   * Exception: for committingSegmentDescriptor with peer download scheme in its segment location, there is no need for", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cad2b84a6ee7e2882f4dca1cf4e7c1ef6617867b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2MDMxOQ==", "bodyText": "delete this line", "url": "https://github.com/apache/pinot/pull/5639#discussion_r448660319", "createdAt": "2020-07-01T23:05:46Z", "author": {"login": "mcvsubbu"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/realtime/PinotLLCRealtimeSegmentManager.java", "diffHunk": "@@ -355,10 +355,17 @@ void setIdealState(String realtimeTableName, IdealState idealState) {\n    * This method moves the segment file from another location to its permanent location.\n    * When splitCommit is enabled, segment file is uploaded to the segmentLocation in the committingSegmentDescriptor,\n    * and we need to move the segment file to its permanent location before committing the segment metadata.\n+   * Updated the segment location to the uri which the segment is moved to.\n+   * Exception: for committingSegmentDescriptor with peer download scheme in its segment location, there is no need for\n+   * moving.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cad2b84a6ee7e2882f4dca1cf4e7c1ef6617867b"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2MTc5Ng==", "bodyText": "Can we define \"\"  as public static string METADATA_URI_FOR_PEER_DOWNLOAD in CommonConstants.Segment and reference the same thing in the server as well, to detect peer download? Once we decide it is going to be \"\" all components need to use the same thing, so might as well make a common definition. A change to this will need to be done keeping backward compat in mind, if at all someone wants to change it.\nthanks", "url": "https://github.com/apache/pinot/pull/5639#discussion_r448661796", "createdAt": "2020-07-01T23:10:52Z", "author": {"login": "mcvsubbu"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/realtime/PinotLLCRealtimeSegmentManager.java", "diffHunk": "@@ -485,9 +498,10 @@ private LLCRealtimeSegmentZKMetadata updateCommittingSegmentZKMetadata(String re\n     // TODO Issue 5953 remove the long parsing once metadata is set correctly.\n     committingSegmentZKMetadata.setEndOffset(committingSegmentDescriptor.getNextOffset());\n     committingSegmentZKMetadata.setStatus(Status.DONE);\n-    committingSegmentZKMetadata.setDownloadUrl(URIUtils\n-        .constructDownloadUrl(_controllerConf.generateVipUrl(), TableNameBuilder.extractRawTableName(realtimeTableName),\n-            segmentName));\n+    // If the download url set by the server is a peer download url format with peer scheme, put an empty string in zk\n+    // otherwise just use the location in the descriptor.\n+    committingSegmentZKMetadata.setDownloadUrl(isPeerURL(committingSegmentDescriptor.getSegmentLocation()) ? \"\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cad2b84a6ee7e2882f4dca1cf4e7c1ef6617867b"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83adcc9b1c75e117105ccb805591e12dcb3899e0", "author": {"user": {"login": "chenboat", "name": "Ting Chen"}}, "url": "https://github.com/apache/pinot/commit/83adcc9b1c75e117105ccb805591e12dcb3899e0", "committedDate": "2020-07-02T04:01:50Z", "message": "Update pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/realtime/PinotLLCRealtimeSegmentManager.java\n\nCo-authored-by: Subbu Subramaniam <mcvsubbu@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba7e9f9c8ebf78d8e86a9a2daf0cd006f21175b8", "author": {"user": {"login": "chenboat", "name": "Ting Chen"}}, "url": "https://github.com/apache/pinot/commit/ba7e9f9c8ebf78d8e86a9a2daf0cd006f21175b8", "committedDate": "2020-07-02T04:02:06Z", "message": "Update pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/realtime/PinotLLCRealtimeSegmentManager.java\n\nCo-authored-by: Subbu Subramaniam <mcvsubbu@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5886b42d8b5a27208de227671726c7a54b3ff50", "author": {"user": {"login": "chenboat", "name": "Ting Chen"}}, "url": "https://github.com/apache/pinot/commit/a5886b42d8b5a27208de227671726c7a54b3ff50", "committedDate": "2020-07-02T04:12:02Z", "message": "Minor revising based on comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxODU1NDgx", "url": "https://github.com/apache/pinot/pull/5639#pullrequestreview-441855481", "createdAt": "2020-07-02T16:34:39Z", "commit": {"oid": "a5886b42d8b5a27208de227671726c7a54b3ff50"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 736, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}