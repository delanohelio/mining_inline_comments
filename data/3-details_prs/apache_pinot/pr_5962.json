{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4MDEzMTEw", "number": 5962, "title": "[TE] Severity based alerter", "bodyText": "Description\nThis PR adds the severity based alerting. It sends out anomalies to different email/Jira channels based on its anomaly severity. It also supports re-sending the alert if a given anomaly's severity has changed. This is achieved by adding a new lookup table for recording the relationship between an anomaly and subscription groups.", "createdAt": "2020-09-02T17:26:27Z", "url": "https://github.com/apache/pinot/pull/5962", "merged": true, "mergeCommit": {"oid": "3a47121ae30b72741a3a2eb1d93cef45c8a7caea"}, "closed": true, "closedAt": "2020-09-09T18:11:55Z", "author": {"login": "jihaozh"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFsNvIgFqTQ4Mjg5MzAxOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHA8BgABqjM3NDMzMDAxMjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyODkzMDE4", "url": "https://github.com/apache/pinot/pull/5962#pullrequestreview-482893018", "createdAt": "2020-09-04T19:21:00Z", "commit": {"oid": "55117218c4008a8d5a3893f0b29892a52e5d9608"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxOToyMTowMFrOHNZNwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQyMTozNToxN1rOHNcBtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgwNjY1OA==", "bodyText": "Why are we not checking if the corresponding entry exists for the anomalies?", "url": "https://github.com/apache/pinot/pull/5962#discussion_r483806658", "createdAt": "2020-09-04T19:21:00Z", "author": {"login": "vincentchenjl"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/DetectionResource.java", "diffHunk": "@@ -570,4 +574,19 @@ public Response getDetectionHealth(@PathParam(\"id\") @ApiParam(\"detection config\n     }\n     return Response.ok(health).build();\n   }\n+\n+  @POST\n+  @Path(value = \"/re-notify\")\n+  @ApiOperation(\"Resend the notification for the anomalies to the subscribed notification groups, if the subscription group supports re-notify\")\n+  public Response alert(@QueryParam(\"id\") List<Long> anomalyIds) {\n+    List<MergedAnomalyResultDTO> anomalies = this.anomalyDAO.findByIds(anomalyIds);\n+    for (MergedAnomalyResultDTO anomaly : anomalies) {\n+      AnomalySubscriptionGroupNotificationDTO anomalySubscriptionGroupNotificationDTO =\n+          new AnomalySubscriptionGroupNotificationDTO();\n+      anomalySubscriptionGroupNotificationDTO.setAnomalyId(anomaly.getId());\n+      anomalySubscriptionGroupNotificationDTO.setDetectionConfigId(anomaly.getDetectionConfigId());\n+      anomalySubscriptionGroupNotificationManager.save(anomalySubscriptionGroupNotificationDTO);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55117218c4008a8d5a3893f0b29892a52e5d9608"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg0NjU5NA==", "bodyText": "Do we expect that new anomalies also have renotify flag as true? Or this should only apply for existing anomalies?", "url": "https://github.com/apache/pinot/pull/5962#discussion_r483846594", "createdAt": "2020-09-04T21:14:47Z", "author": {"login": "vincentchenjl"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/DetectionPipelineTaskRunner.java", "diffHunk": "@@ -167,6 +175,14 @@ public DetectionPipelineTaskRunner(DetectionConfigManager detectionDAO, MergedAn\n       }\n       this.detectionDAO.update(config);\n \n+      // re-notify the anomalies if any\n+      for (MergedAnomalyResultDTO anomaly : result.getAnomalies()) {\n+        // if an anomaly should be re-notified, update the notification lookup table in the database\n+        if (anomaly.shouldRenotify()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55117218c4008a8d5a3893f0b29892a52e5d9608"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1MjcyNQ==", "bodyText": "There's a conflict here between this PR and mine. The labeler in the other PR relies on the order of the severity.", "url": "https://github.com/apache/pinot/pull/5962#discussion_r483852725", "createdAt": "2020-09-04T21:35:17Z", "author": {"login": "vincentchenjl"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/constant/AnomalySeverity.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ */\n+\n+package org.apache.pinot.thirdeye.constant;\n+\n+public enum AnomalySeverity {\n+  LOW(\"low\"), MODERATE(\"moderate\"), HIGH(\"high\"), CRITICAL(\"critical\"), DEFAULT(\"default\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55117218c4008a8d5a3893f0b29892a52e5d9608"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NTMzMTk1", "url": "https://github.com/apache/pinot/pull/5962#pullrequestreview-484533195", "createdAt": "2020-09-08T22:28:15Z", "commit": {"oid": "c95c341feb0c699d7d7fd2fc50f45afcef3fa9eb"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMjoyODoxNlrOHOwEeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMjozMDowN1rOHOwG-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIyOTY4OQ==", "bodyText": "pls include some javadocs", "url": "https://github.com/apache/pinot/pull/5962#discussion_r485229689", "createdAt": "2020-09-08T22:28:16Z", "author": {"login": "akshayrai"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/datalayer/bao/AnomalySubscriptionGroupNotificationManager.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ */\n+\n+package org.apache.pinot.thirdeye.datalayer.bao;\n+\n+import org.apache.pinot.thirdeye.datalayer.dto.AnomalySubscriptionGroupNotificationDTO;\n+\n+\n+public interface AnomalySubscriptionGroupNotificationManager", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c95c341feb0c699d7d7fd2fc50f45afcef3fa9eb"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIzMDMzMQ==", "bodyText": "javadocs", "url": "https://github.com/apache/pinot/pull/5962#discussion_r485230331", "createdAt": "2020-09-08T22:30:07Z", "author": {"login": "akshayrai"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/constant/AnomalySeverity.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ */\n+\n+package org.apache.pinot.thirdeye.constant;\n+\n+public enum AnomalySeverity {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c95c341feb0c699d7d7fd2fc50f45afcef3fa9eb"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "815c52ad25ffb866569acc03c99b99cc1d8d578e", "author": {"user": {"login": "jihaozh", "name": "Jihao Zhang"}}, "url": "https://github.com/apache/pinot/commit/815c52ad25ffb866569acc03c99b99cc1d8d578e", "committedDate": "2020-09-09T00:07:16Z", "message": "add anomaly notification table"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9caca064677030856e7dd5649969e47e9c595f6e", "author": {"user": {"login": "jihaozh", "name": "Jihao Zhang"}}, "url": "https://github.com/apache/pinot/commit/9caca064677030856e7dd5649969e47e9c595f6e", "committedDate": "2020-09-09T00:09:08Z", "message": "severity alerter & unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09944df4bca95db34a46d7efee6197baa2cc017d", "author": {"user": {"login": "jihaozh", "name": "Jihao Zhang"}}, "url": "https://github.com/apache/pinot/commit/09944df4bca95db34a46d7efee6197baa2cc017d", "committedDate": "2020-09-09T00:09:12Z", "message": "refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c9a272e6948269fd66e42678e85a5151b924cc6", "author": {"user": {"login": "jihaozh", "name": "Jihao Zhang"}}, "url": "https://github.com/apache/pinot/commit/2c9a272e6948269fd66e42678e85a5151b924cc6", "committedDate": "2020-09-09T00:09:12Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13c7d66795a6d42f547f5fbe588f97eb8ab6da6a", "author": {"user": {"login": "jihaozh", "name": "Jihao Zhang"}}, "url": "https://github.com/apache/pinot/commit/13c7d66795a6d42f547f5fbe588f97eb8ab6da6a", "committedDate": "2020-09-09T00:18:52Z", "message": "rebase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "363004e569852a0e88ea8c5a18a6a82bc1c73762", "author": {"user": {"login": "jihaozh", "name": "Jihao Zhang"}}, "url": "https://github.com/apache/pinot/commit/363004e569852a0e88ea8c5a18a6a82bc1c73762", "committedDate": "2020-09-09T00:19:56Z", "message": "address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c95c341feb0c699d7d7fd2fc50f45afcef3fa9eb", "author": {"user": {"login": "jihaozh", "name": "Jihao Zhang"}}, "url": "https://github.com/apache/pinot/commit/c95c341feb0c699d7d7fd2fc50f45afcef3fa9eb", "committedDate": "2020-09-08T18:19:49Z", "message": "address comments"}, "afterCommit": {"oid": "363004e569852a0e88ea8c5a18a6a82bc1c73762", "author": {"user": {"login": "jihaozh", "name": "Jihao Zhang"}}, "url": "https://github.com/apache/pinot/commit/363004e569852a0e88ea8c5a18a6a82bc1c73762", "committedDate": "2020-09-09T00:19:56Z", "message": "address comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1704, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}