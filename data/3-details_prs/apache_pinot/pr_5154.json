{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg4ODYxMDE5", "number": 5154, "title": "Fix the NPE for DISTINCT aggregation function when no record is selected", "bodyText": "When no record is selected for the whole table, column data type will be STRING for all distinct columns (by Pinot convention)", "createdAt": "2020-03-15T22:54:40Z", "url": "https://github.com/apache/pinot/pull/5154", "merged": true, "mergeCommit": {"oid": "2e800e071e095a3f151dbb2d52fe6ff0473a7b81"}, "closed": true, "closedAt": "2020-03-19T21:19:00Z", "author": {"login": "Jackie-Jiang"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOBqIqgH2gAyMzg4ODYxMDE5OjhkZDc3Y2ZmNzM2ZmI2NmE5MjZjNDBjNDk5Yjc3MTExNDA2MzdlMDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPShmKAFqTM3ODA5NTYxNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8dd77cff736fb66a926c40c499b7711140637e02", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/8dd77cff736fb66a926c40c499b7711140637e02", "committedDate": "2020-03-15T22:56:57Z", "message": "Fix the NPE for DISTINCT aggregation function when no record is selected\n\nWhen no record is selected for the whole table, column data type will be STRING for all distinct columns (by Pinot convention)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f8e8aa7b0d64878a488662996f52a420b836097b", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/f8e8aa7b0d64878a488662996f52a420b836097b", "committedDate": "2020-03-15T22:50:59Z", "message": "Fix the NPE for DISTINCT aggregation function when no record is selected\n\nWhen no record is selected for the whole table, column data type will be STRING for all distinct columns (by Pinot convention)"}, "afterCommit": {"oid": "8dd77cff736fb66a926c40c499b7711140637e02", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/8dd77cff736fb66a926c40c499b7711140637e02", "committedDate": "2020-03-15T22:56:57Z", "message": "Fix the NPE for DISTINCT aggregation function when no record is selected\n\nWhen no record is selected for the whole table, column data type will be STRING for all distinct columns (by Pinot convention)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3NTY3OTAx", "url": "https://github.com/apache/pinot/pull/5154#pullrequestreview-377567901", "createdAt": "2020-03-19T09:54:12Z", "commit": {"oid": "8dd77cff736fb66a926c40c499b7711140637e02"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwOTo1NDoxM1rOF4nMjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwOTo1NDoxM1rOF4nMjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkwNjc2Nw==", "bodyText": "I think this is the scenario when the overall result set of DISTINCT query at table level is empty and was throwing NPE as DistinctTable was null.\nCan we please also add a test where the overall result at table level is non-empty but one or more segment returns empty?\nThen we have everything  covered.", "url": "https://github.com/apache/pinot/pull/5154#discussion_r394906767", "createdAt": "2020-03-19T09:54:13Z", "author": {"login": "siddharthteotia"}, "path": "pinot-core/src/test/java/org/apache/pinot/queries/DistinctQueriesTest.java", "diffHunk": "@@ -685,6 +694,18 @@ public void testDistinctWithFilter()\n         sortedResults.add(new Record(new Object[]{\"California\", \"San Mateo\", 400000}));\n         sortedResults.add(new Record(new Object[]{\"California\", \"Sunnyvale\", 300000}));\n         runQueryInterSegmentWithOrderBy(orderByQuery, sortedResults, new String[]{\"State\", \"City\", \"SaleAmount\"});\n+\n+        String emptyResultQuery =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8dd77cff736fb66a926c40c499b7711140637e02"}, "originalPosition": 112}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3NTY5MjQx", "url": "https://github.com/apache/pinot/pull/5154#pullrequestreview-377569241", "createdAt": "2020-03-19T09:55:58Z", "commit": {"oid": "8dd77cff736fb66a926c40c499b7711140637e02"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwOTo1NTo1OVrOF4nQ8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwOTo1NTo1OVrOF4nQ8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkwNzg5MQ==", "bodyText": "I am unable to recall why I had this if check. I think there was a code-path where null broker request could have been passed. It is not possible right?", "url": "https://github.com/apache/pinot/pull/5154#discussion_r394907891", "createdAt": "2020-03-19T09:55:59Z", "author": {"login": "siddharthteotia"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/AggregationFunctionFactory.java", "diffHunk": "@@ -112,8 +111,10 @@ public static AggregationFunction getAggregationFunction(AggregationInfo aggrega\n           case DISTINCTCOUNTRAWHLLMV:\n             return new DistinctCountRawHLLMVAggregationFunction();\n           case DISTINCT:\n+            Preconditions.checkState(brokerRequest != null,\n+                \"Broker request must be provided for 'DISTINCT' aggregation function\");\n             return new DistinctAggregationFunction(AggregationFunctionUtils.getColumn(aggregationInfo),\n-                brokerRequest != null ? brokerRequest.getLimit() : SelectAstNode.DEFAULT_RECORD_LIMIT, brokerRequest.getOrderBy());\n+                brokerRequest.getOrderBy(), brokerRequest.getLimit());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8dd77cff736fb66a926c40c499b7711140637e02"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4MDk1NjE0", "url": "https://github.com/apache/pinot/pull/5154#pullrequestreview-378095614", "createdAt": "2020-03-19T21:09:56Z", "commit": {"oid": "8dd77cff736fb66a926c40c499b7711140637e02"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1396, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}