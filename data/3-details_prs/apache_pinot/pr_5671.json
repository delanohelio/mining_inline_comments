{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2NjExMTM3", "number": 5671, "title": "Rewrite non-aggregate group by query to distinct query", "bodyText": "Description\nPer #5663, this PR rewrite non-aggregation groupBy query to distinct query.\ne.g.\nSELECT col1+col2*5 FROM foo GROUP BY col1, col2 => SELECT distinct col1+col2*5 FROM foo\nSELECT col1, col2 FROM foo GROUP BY col1, col2 => SELECT distinct col1, col2 FROM foo\nRelease Notes\nRewrite non-aggregation group by query to distinct query.", "createdAt": "2020-07-09T04:34:06Z", "url": "https://github.com/apache/pinot/pull/5671", "merged": true, "mergeCommit": {"oid": "b32750951f0fb24923a6280f066a6cd037e1f0cb"}, "closed": true, "closedAt": "2020-07-10T03:44:14Z", "author": {"login": "xiangfu0"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczIlY9ABqjM1MjgwODU3MDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczZe8rgH2gAyNDQ2NjExMTM3Ojg3NDY4ZDFmNjY5NTAyN2NmMzc2ZTljOGE5NmIzNmQxYjUxZjA5MWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b1c65e7746af7e310bf733127be5e84db407fdcd", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/b1c65e7746af7e310bf733127be5e84db407fdcd", "committedDate": "2020-07-09T04:29:41Z", "message": "Rewrite non-aggregate group by query to distinct query"}, "afterCommit": {"oid": "3a2e1fd88292567f11f56bc4429b91e9d2a42270", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/3a2e1fd88292567f11f56bc4429b91e9d2a42270", "committedDate": "2020-07-09T05:56:09Z", "message": "Rewrite non-aggregate group by query to distinct query"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3a2e1fd88292567f11f56bc4429b91e9d2a42270", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/3a2e1fd88292567f11f56bc4429b91e9d2a42270", "committedDate": "2020-07-09T05:56:09Z", "message": "Rewrite non-aggregate group by query to distinct query"}, "afterCommit": {"oid": "74f85675b50d074a869cc07a96870d9e996aed05", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/74f85675b50d074a869cc07a96870d9e996aed05", "committedDate": "2020-07-09T06:27:16Z", "message": "Rewrite non-aggregate group by query to distinct query"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "74f85675b50d074a869cc07a96870d9e996aed05", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/74f85675b50d074a869cc07a96870d9e996aed05", "committedDate": "2020-07-09T06:27:16Z", "message": "Rewrite non-aggregate group by query to distinct query"}, "afterCommit": {"oid": "83adf32a3a6c178cc255c4086187ec5403249914", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/83adf32a3a6c178cc255c4086187ec5403249914", "committedDate": "2020-07-09T07:33:46Z", "message": "Rewrite non-aggregate group by query to distinct query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25d70e4881dfc81565888f558d2739da8026c94c", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/25d70e4881dfc81565888f558d2739da8026c94c", "committedDate": "2020-07-09T10:46:29Z", "message": "Rewrite non-aggregate group by query to distinct query"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "83adf32a3a6c178cc255c4086187ec5403249914", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/83adf32a3a6c178cc255c4086187ec5403249914", "committedDate": "2020-07-09T07:33:46Z", "message": "Rewrite non-aggregate group by query to distinct query"}, "afterCommit": {"oid": "25d70e4881dfc81565888f558d2739da8026c94c", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/25d70e4881dfc81565888f558d2739da8026c94c", "committedDate": "2020-07-09T10:46:29Z", "message": "Rewrite non-aggregate group by query to distinct query"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NzYwMjMz", "url": "https://github.com/apache/pinot/pull/5671#pullrequestreview-445760233", "createdAt": "2020-07-09T16:03:57Z", "commit": {"oid": "25d70e4881dfc81565888f558d2739da8026c94c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNjowMzo1OFrOGvX3OQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNjowODo1OFrOGvYDEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjMyNzIyNQ==", "bodyText": "Would be good to add doc with sample query translations (as already stated in the PR description).", "url": "https://github.com/apache/pinot/pull/5671#discussion_r452327225", "createdAt": "2020-07-09T16:03:58Z", "author": {"login": "mayankshriv"}, "path": "pinot-common/src/main/java/org/apache/pinot/sql/parsers/CalciteSqlParser.java", "diffHunk": "@@ -331,12 +345,59 @@ private static void queryRewrite(PinotQuery pinotQuery) {\n       pinotQuery.setFilterExpression(updatedFilterExpression);\n     }\n \n+    // Rewrite GroupBy to Distinct\n+    rewriteNonAggregationGroupByToDistinct(pinotQuery);\n+\n     // Update alias\n     Map<Identifier, Expression> aliasMap = extractAlias(pinotQuery.getSelectList());\n     applyAlias(aliasMap, pinotQuery);\n     validate(aliasMap, pinotQuery);\n   }\n \n+  private static void rewriteNonAggregationGroupByToDistinct(PinotQuery pinotQuery) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25d70e4881dfc81565888f558d2739da8026c94c"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjMzMDI1OA==", "bodyText": "May be a non-issue here, but just wanted to point out that there are aggregation functions that take multiple args, some of which are expected to be literals (even though they look like expressions, eg distinctCountThetaSketch).", "url": "https://github.com/apache/pinot/pull/5671#discussion_r452330258", "createdAt": "2020-07-09T16:08:58Z", "author": {"login": "mayankshriv"}, "path": "pinot-common/src/main/java/org/apache/pinot/sql/parsers/CalciteSqlParser.java", "diffHunk": "@@ -196,13 +198,25 @@ private static boolean isAggregateExpression(Expression expression) {\n     return false;\n   }\n \n-  public static Set<String> extractIdentifiers(List<Expression> expressions) {\n+  /**\n+   * Extract all the identifiers from given expressions.\n+   *\n+   * @param expressions\n+   * @param excludeAs if true, ignores the right side identifier for AS function.\n+   * @return all the identifier names.\n+   */\n+  public static Set<String> extractIdentifiers(List<Expression> expressions, boolean excludeAs) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25d70e4881dfc81565888f558d2739da8026c94c"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5103dff769b485fe69f1853fc5f8f81899268fd", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/d5103dff769b485fe69f1853fc5f8f81899268fd", "committedDate": "2020-07-09T21:41:42Z", "message": "Adding tests to DistinctQueriesTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MDY0OTI3", "url": "https://github.com/apache/pinot/pull/5671#pullrequestreview-446064927", "createdAt": "2020-07-10T01:19:25Z", "commit": {"oid": "d5103dff769b485fe69f1853fc5f8f81899268fd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwMToxOToyNlrOGvm1cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwMToxOToyNlrOGvm1cw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU3MjUzMQ==", "bodyText": "private?", "url": "https://github.com/apache/pinot/pull/5671#discussion_r452572531", "createdAt": "2020-07-10T01:19:26Z", "author": {"login": "siddharthteotia"}, "path": "pinot-core/src/test/java/org/apache/pinot/queries/DistinctQueriesTest.java", "diffHunk": "@@ -179,18 +179,15 @@ private ImmutableSegment createSegment(int index, List<GenericRow> records)\n    *   <li>Selecting some columns with filter that does not match any record</li>\n    * </ul>\n    */\n-  @Test\n-  public void testDistinctInnerSegment()\n+  public void testDistinctInnerSegmentHelper(String[] queries, boolean isPql)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5103dff769b485fe69f1853fc5f8f81899268fd"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MDY1MTc3", "url": "https://github.com/apache/pinot/pull/5671#pullrequestreview-446065177", "createdAt": "2020-07-10T01:20:25Z", "commit": {"oid": "d5103dff769b485fe69f1853fc5f8f81899268fd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwMToyMDoyNVrOGvm2Xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwMToyMDoyNVrOGvm2Xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU3Mjc2Ng==", "bodyText": "private?", "url": "https://github.com/apache/pinot/pull/5671#discussion_r452572766", "createdAt": "2020-07-10T01:20:25Z", "author": {"login": "siddharthteotia"}, "path": "pinot-core/src/test/java/org/apache/pinot/queries/DistinctQueriesTest.java", "diffHunk": "@@ -347,19 +389,16 @@ private DistinctTable getDistinctTableInnerSegment(String query) {\n    *   </li>\n    * </ul>\n    */\n-  @Test\n-  public void testDistinctInterSegment()\n+  public void testDistinctInterSegmentHelper(String[] pqlQueries, String[] sqlQueries)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5103dff769b485fe69f1853fc5f8f81899268fd"}, "originalPosition": 144}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MDY1Njcw", "url": "https://github.com/apache/pinot/pull/5671#pullrequestreview-446065670", "createdAt": "2020-07-10T01:22:07Z", "commit": {"oid": "d5103dff769b485fe69f1853fc5f8f81899268fd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87468d1f6695027cf376e9c8a96b36d1b51f091b", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/87468d1f6695027cf376e9c8a96b36d1b51f091b", "committedDate": "2020-07-10T01:37:39Z", "message": "Update DistinctQueriesTest.java"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 306, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}