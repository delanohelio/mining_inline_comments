{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1MTUwMTY4", "number": 6073, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNDowODowNlrOEo3Kaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxOTo0NDozMlrOEpnADw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExMjgyMjgzOnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/util/TableConfigUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNDowODowNlrOHaMnFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNDowODowNlrOHaMnFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIzMTYzOA==", "bodyText": "This is the same check as PinotHelixResourceManager.validateTableTenantConfig(TableConfig tableConfig)", "url": "https://github.com/apache/pinot/pull/6073#discussion_r497231638", "createdAt": "2020-09-30T04:08:06Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/util/TableConfigUtils.java", "diffHunk": "@@ -76,10 +79,41 @@ public static void validate(TableConfig tableConfig, @Nullable Schema schema) {\n     validateFieldConfigList(tableConfig.getFieldConfigList(), schema);\n   }\n \n+  /**\n+   * Validates all table config including tenant config. This is specifically invoked\n+   * during table config creation, update or validate API calls.\n+   */\n+  public static void validate(TableConfig tableConfig, @Nullable Schema schema, Set<String> serverTenants,\n+      Set<String> brokerTenants) {\n+    validate(tableConfig, schema);\n+    validateTenants(tableConfig, serverTenants, brokerTenants);\n+  }\n+\n+  /**\n+   * Ensures a valid tenant config is provided in the table config.\n+   * Ensures the broker and server tenant names are valid.\n+   */\n+  private static void validateTenants(TableConfig tableConfig, Set<String> serverTenants, Set<String> brokerTenants) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fb5149df177977518a21e90e06edd4757b92c47"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMDU2NzY3OnYy", "diffSide": "RIGHT", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxOToxMTo0MlrOHbXlTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxOToxMjozN1rOHbXnDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ1OTk4Mg==", "bodyText": "You should put default tenant here if it is single-tenant cluster, similar to addTable()\nYou may extract this part into a helper method", "url": "https://github.com/apache/pinot/pull/6073#discussion_r498459982", "createdAt": "2020-10-01T19:11:42Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManager.java", "diffHunk": "@@ -1374,6 +1378,14 @@ private void assignInstances(TableConfig tableConfig, boolean override) {\n    */\n   public void updateTableConfig(TableConfig tableConfig)\n       throws IOException {\n+    TenantConfig tenantConfig = tableConfig.getTenantConfig();\n+    String brokerTag = tenantConfig.getBroker();\n+    String serverTag = tenantConfig.getServer();\n+    if (brokerTag == null || serverTag == null) {\n+      if (!_isSingleTenantCluster) {\n+        throw new InvalidTableConfigException(\"server and broker tenants must be specified for multi-tenant cluster\");\n+      }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0307db867bdcac0461ccef02f7b317147d6117d"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ2MDQzMQ==", "bodyText": "makes sense. lemme do that", "url": "https://github.com/apache/pinot/pull/6073#discussion_r498460431", "createdAt": "2020-10-01T19:12:37Z", "author": {"login": "icefury71"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManager.java", "diffHunk": "@@ -1374,6 +1378,14 @@ private void assignInstances(TableConfig tableConfig, boolean override) {\n    */\n   public void updateTableConfig(TableConfig tableConfig)\n       throws IOException {\n+    TenantConfig tenantConfig = tableConfig.getTenantConfig();\n+    String brokerTag = tenantConfig.getBroker();\n+    String serverTag = tenantConfig.getServer();\n+    if (brokerTag == null || serverTag == null) {\n+      if (!_isSingleTenantCluster) {\n+        throw new InvalidTableConfigException(\"server and broker tenants must be specified for multi-tenant cluster\");\n+      }\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ1OTk4Mg=="}, "originalCommit": {"oid": "c0307db867bdcac0461ccef02f7b317147d6117d"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMDY2MDYzOnYy", "diffSide": "RIGHT", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxOTo0NDozMlrOHbYiNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxOTo0NDozMlrOHbYiNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3NTU3NQ==", "bodyText": "That's also put the table name within the exception message", "url": "https://github.com/apache/pinot/pull/6073#discussion_r498475575", "createdAt": "2020-10-01T19:44:32Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManager.java", "diffHunk": "@@ -1195,12 +1182,26 @@ public void addTable(TableConfig tableConfig)\n   }\n \n   /**\n-   * Validates the tenant config for the table\n+   * Validates the tenant config for the table. In case of a single tenant cluster,\n+   * if the server and broker tenants are not specified in the config, they're\n+   * auto-populated with the default tenant name. In case of a multi-tenant cluster,\n+   * these parameters must be specified in the table config.\n    */\n   @VisibleForTesting\n   void validateTableTenantConfig(TableConfig tableConfig) {\n-    String tableNameWithType = tableConfig.getTableName();\n     TenantConfig tenantConfig = tableConfig.getTenantConfig();\n+    String brokerTag = tenantConfig.getBroker();\n+    String serverTag = tenantConfig.getServer();\n+    if (brokerTag == null || serverTag == null) {\n+      if (!_isSingleTenantCluster) {\n+        throw new InvalidTableConfigException(\"server and broker tenants must be specified for multi-tenant cluster\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a882a9da3714bed9e75c7609349e0bb971cdf2bc"}, "originalPosition": 39}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3678, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}