{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2NzI5MDQx", "number": 5014, "title": "fixing converting PinotQuery to BrokerRequest for group by clause with selections", "bodyText": "Fixing the issue that for Aggregation Group by query, we don't set selection field in BrokerRequest.\nadded a simple validation logic to fail query if selected field(s) not mentioned in group by clause.\nE.g. SELECT col_a, col_b FROM myTable GROUP BY col_a\nadded a validation logic to prevent aggregation expressions in group by clause.", "createdAt": "2020-01-24T08:32:15Z", "url": "https://github.com/apache/pinot/pull/5014", "merged": true, "mergeCommit": {"oid": "4ebdb085a5a8ae398c9cf584b3a5f423d373c0a6"}, "closed": true, "closedAt": "2020-01-24T22:39:46Z", "author": {"login": "xiangfu0"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb9axQ3gBqjI5NzY0NDcwMDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb9mRTUAFqTM0ODI0OTE2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a32a0dfe4ee544aafb207f0863699e46870166e3", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/a32a0dfe4ee544aafb207f0863699e46870166e3", "committedDate": "2020-01-24T08:30:48Z", "message": "fixing converting PinotQuery to BrokerRequest for group by clause with selections"}, "afterCommit": {"oid": "f964ac467fadd31d5eac6a67e0f4d6f76627bb5f", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/f964ac467fadd31d5eac6a67e0f4d6f76627bb5f", "committedDate": "2020-01-24T08:35:29Z", "message": "fixing converting PinotQuery to BrokerRequest for group by clause with selections"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "766f01b8a707f06e7a0fe7b4e32becc570470cbe", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/766f01b8a707f06e7a0fe7b4e32becc570470cbe", "committedDate": "2020-01-24T08:36:25Z", "message": "fixing converting PinotQuery to BrokerRequest for group by clause with selections"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f964ac467fadd31d5eac6a67e0f4d6f76627bb5f", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/f964ac467fadd31d5eac6a67e0f4d6f76627bb5f", "committedDate": "2020-01-24T08:35:29Z", "message": "fixing converting PinotQuery to BrokerRequest for group by clause with selections"}, "afterCommit": {"oid": "766f01b8a707f06e7a0fe7b4e32becc570470cbe", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/766f01b8a707f06e7a0fe7b4e32becc570470cbe", "committedDate": "2020-01-24T08:36:25Z", "message": "fixing converting PinotQuery to BrokerRequest for group by clause with selections"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4MTI4NTg3", "url": "https://github.com/apache/pinot/pull/5014#pullrequestreview-348128587", "createdAt": "2020-01-24T18:05:16Z", "commit": {"oid": "766f01b8a707f06e7a0fe7b4e32becc570470cbe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxODowNToxN1rOFhl23A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxODowNToxN1rOFhl23A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc2NzU4MA==", "bodyText": "Add one more test to cover cases like \"select A, count(*) from table group by A,B\"?", "url": "https://github.com/apache/pinot/pull/5014#discussion_r370767580", "createdAt": "2020-01-24T18:05:17Z", "author": {"login": "chenboat"}, "path": "pinot-common/src/test/java/org/apache/pinot/sql/parsers/CalciteSqlCompilerTest.java", "diffHunk": "@@ -832,4 +849,17 @@ public void testSqlDistinctQueryCompilation() {\n     Assert.assertEquals(aggregationInfo.getAggregationParams().get(FunctionCallAstNode.COLUMN_KEY_IN_AGGREGATION_INFO),\n         \"add(div(col1,col2),mul(col3,col4)):sub(col3,col4):col5:col6\");\n   }\n+\n+  @Test\n+  public void testQueryValidationFailure() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "766f01b8a707f06e7a0fe7b4e32becc570470cbe"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4MTI5MjM3", "url": "https://github.com/apache/pinot/pull/5014#pullrequestreview-348129237", "createdAt": "2020-01-24T18:06:30Z", "commit": {"oid": "766f01b8a707f06e7a0fe7b4e32becc570470cbe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxODowNjozMFrOFhl40g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxODowNjozMFrOFhl40g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc2ODA4Mg==", "bodyText": "NIT: use if(pinotQuery.getGroupByList() == null) return; to reduce the nest levels.", "url": "https://github.com/apache/pinot/pull/5014#discussion_r370768082", "createdAt": "2020-01-24T18:06:30Z", "author": {"login": "chenboat"}, "path": "pinot-common/src/main/java/org/apache/pinot/sql/parsers/CalciteSqlParser.java", "diffHunk": "@@ -92,6 +94,34 @@ public static PinotQuery compileToPinotQuery(String sql)\n     return pinotQuery;\n   }\n \n+  static void validate(PinotQuery pinotQuery)\n+      throws SqlCompilationException {\n+    // Sanity check group by query: All identifiers in selection list should be also included in group by list.\n+    if (pinotQuery.getGroupByList() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "766f01b8a707f06e7a0fe7b4e32becc570470cbe"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4MTMwMDc4", "url": "https://github.com/apache/pinot/pull/5014#pullrequestreview-348130078", "createdAt": "2020-01-24T18:08:04Z", "commit": {"oid": "766f01b8a707f06e7a0fe7b4e32becc570470cbe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxODowODowNFrOFhl7gQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxODowODowNFrOFhl7gQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc2ODc2OQ==", "bodyText": "Should we check identifiers or expressions?", "url": "https://github.com/apache/pinot/pull/5014#discussion_r370768769", "createdAt": "2020-01-24T18:08:04Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-common/src/main/java/org/apache/pinot/sql/parsers/CalciteSqlParser.java", "diffHunk": "@@ -92,6 +94,34 @@ public static PinotQuery compileToPinotQuery(String sql)\n     return pinotQuery;\n   }\n \n+  static void validate(PinotQuery pinotQuery)\n+      throws SqlCompilationException {\n+    // Sanity check group by query: All identifiers in selection list should be also included in group by list.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "766f01b8a707f06e7a0fe7b4e32becc570470cbe"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4MTMxNTAz", "url": "https://github.com/apache/pinot/pull/5014#pullrequestreview-348131503", "createdAt": "2020-01-24T18:10:44Z", "commit": {"oid": "766f01b8a707f06e7a0fe7b4e32becc570470cbe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxODoxMDo0NFrOFhl_kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxODoxMDo0NFrOFhl_kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc2OTgxMQ==", "bodyText": "I agree that we should be checking for identifiers. However, I think a query like this:\nSELECT State, Count() from Customers GROUP BY State, Count() should not be supported.\nIn other words, we should not have the aggregations as one of the GROUP BY columns.", "url": "https://github.com/apache/pinot/pull/5014#discussion_r370769811", "createdAt": "2020-01-24T18:10:44Z", "author": {"login": "siddharthteotia"}, "path": "pinot-common/src/test/java/org/apache/pinot/sql/parsers/CalciteSqlCompilerTest.java", "diffHunk": "@@ -832,4 +849,17 @@ public void testSqlDistinctQueryCompilation() {\n     Assert.assertEquals(aggregationInfo.getAggregationParams().get(FunctionCallAstNode.COLUMN_KEY_IN_AGGREGATION_INFO),\n         \"add(div(col1,col2),mul(col3,col4)):sub(col3,col4):col5:col6\");\n   }\n+\n+  @Test\n+  public void testQueryValidationFailure() {\n+    String sql;\n+    try {\n+      sql = \"select group_city,group_country, sum(rsvp_count), count(*) from meetupRsvp group by group_country, sum(rsvp_count), count(*) limit 50\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "766f01b8a707f06e7a0fe7b4e32becc570470cbe"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4MTMzNzc1", "url": "https://github.com/apache/pinot/pull/5014#pullrequestreview-348133775", "createdAt": "2020-01-24T18:14:49Z", "commit": {"oid": "766f01b8a707f06e7a0fe7b4e32becc570470cbe"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3c3b7c5ed74400aca2e23f15ce064bf1cf4221e2", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/3c3b7c5ed74400aca2e23f15ce064bf1cf4221e2", "committedDate": "2020-01-24T20:15:03Z", "message": "Address comments"}, "afterCommit": {"oid": "f9c45b7f12066c444ba7ae38563e8d8733adef04", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/f9c45b7f12066c444ba7ae38563e8d8733adef04", "committedDate": "2020-01-24T20:39:47Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd0884766b5fb777015476d13fb2b78f39feea30", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/dd0884766b5fb777015476d13fb2b78f39feea30", "committedDate": "2020-01-24T20:46:37Z", "message": "Address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f9c45b7f12066c444ba7ae38563e8d8733adef04", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/f9c45b7f12066c444ba7ae38563e8d8733adef04", "committedDate": "2020-01-24T20:39:47Z", "message": "Address comments"}, "afterCommit": {"oid": "dd0884766b5fb777015476d13fb2b78f39feea30", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/dd0884766b5fb777015476d13fb2b78f39feea30", "committedDate": "2020-01-24T20:46:37Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4MjQ5MTY5", "url": "https://github.com/apache/pinot/pull/5014#pullrequestreview-348249169", "createdAt": "2020-01-24T21:59:36Z", "commit": {"oid": "dd0884766b5fb777015476d13fb2b78f39feea30"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1532, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}