{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwMjU3OTM4", "number": 5314, "reviewThreads": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxODo0ODo1NlrOD4Kihw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxNjoyNjozNlrOD5ELUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMjE5NTI3OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/BestEffortSegmentUploader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxODo0ODo1NlrOGO2Acw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxNjoxNzo0NFrOGPONTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIxODA5OQ==", "bodyText": "can u javadoc the arguments?  What is defaultSegment? Maybe call it defaultSegmentURI and define it as URI type?", "url": "https://github.com/apache/pinot/pull/5314#discussion_r418218099", "createdAt": "2020-04-30T18:48:56Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/BestEffortSegmentUploader.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.pinot.common.utils.StringUtil;\n+import org.apache.pinot.spi.filesystem.PinotFS;\n+import org.apache.pinot.spi.filesystem.PinotFSFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+// A segment uploader which does best effort segment upload to a segment store (with store root dir configured as\n+// _segmentStoreUriStr). The upload is successful if it is done within a configurable timeout period.\n+// The final segment location would be in the URI _segmentStoreUriStr/_tableNameWithType/segmentName if\n+// successful. If a segment upload fails or there is no segment store uri configured, it sets the segment location as\n+// the default URI.\n+public class BestEffortSegmentUploader implements SegmentUploader {\n+  private Logger LOGGER = LoggerFactory.getLogger(BestEffortSegmentUploader.class);\n+  private String _segmentStoreUriStr;\n+  private ExecutorService _executorService = Executors.newCachedThreadPool();\n+  // The default segment location URI to return if the upload fails.\n+  private URI _defaultSegmentLocationURI;\n+  private int _timeoutInMs;\n+\n+  public BestEffortSegmentUploader(String segmentStoreUriStr, int timeoutInMs, String defaultSegment) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "209262f25455031cfb572734dd4585517564ea72"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYxNDYwNA==", "bodyText": "parameter removed with new class constructor.", "url": "https://github.com/apache/pinot/pull/5314#discussion_r418614604", "createdAt": "2020-05-01T16:17:44Z", "author": {"login": "chenboat"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/BestEffortSegmentUploader.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.pinot.common.utils.StringUtil;\n+import org.apache.pinot.spi.filesystem.PinotFS;\n+import org.apache.pinot.spi.filesystem.PinotFSFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+// A segment uploader which does best effort segment upload to a segment store (with store root dir configured as\n+// _segmentStoreUriStr). The upload is successful if it is done within a configurable timeout period.\n+// The final segment location would be in the URI _segmentStoreUriStr/_tableNameWithType/segmentName if\n+// successful. If a segment upload fails or there is no segment store uri configured, it sets the segment location as\n+// the default URI.\n+public class BestEffortSegmentUploader implements SegmentUploader {\n+  private Logger LOGGER = LoggerFactory.getLogger(BestEffortSegmentUploader.class);\n+  private String _segmentStoreUriStr;\n+  private ExecutorService _executorService = Executors.newCachedThreadPool();\n+  // The default segment location URI to return if the upload fails.\n+  private URI _defaultSegmentLocationURI;\n+  private int _timeoutInMs;\n+\n+  public BestEffortSegmentUploader(String segmentStoreUriStr, int timeoutInMs, String defaultSegment) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIxODA5OQ=="}, "originalCommit": {"oid": "209262f25455031cfb572734dd4585517564ea72"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMjIwNDAzOnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/BestEffortSegmentUploader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxODo1MTozM1rOGO2GGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxODo1MTozM1rOGO2GGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIxOTU0NQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class BestEffortSegmentUploader implements SegmentUploader {\n          \n          \n            \n            public class PinotFSSegmentUploader implements SegmentUploader {", "url": "https://github.com/apache/pinot/pull/5314#discussion_r418219545", "createdAt": "2020-04-30T18:51:33Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/BestEffortSegmentUploader.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.pinot.common.utils.StringUtil;\n+import org.apache.pinot.spi.filesystem.PinotFS;\n+import org.apache.pinot.spi.filesystem.PinotFSFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+// A segment uploader which does best effort segment upload to a segment store (with store root dir configured as\n+// _segmentStoreUriStr). The upload is successful if it is done within a configurable timeout period.\n+// The final segment location would be in the URI _segmentStoreUriStr/_tableNameWithType/segmentName if\n+// successful. If a segment upload fails or there is no segment store uri configured, it sets the segment location as\n+// the default URI.\n+public class BestEffortSegmentUploader implements SegmentUploader {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "209262f25455031cfb572734dd4585517564ea72"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMjIwOTM2OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/BestEffortSegmentUploader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxODo1MzoxMlrOGO2Jnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxODo1MzoxMlrOGO2Jnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyMDQ0Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public BestEffortSegmentUploader(String segmentStoreUriStr, int timeoutInMs, String defaultSegment) {\n          \n          \n            \n              public BestEffortSegmentUploader(String segmentStoreDirUri, int timeoutMillis, String defaultSegment) {", "url": "https://github.com/apache/pinot/pull/5314#discussion_r418220447", "createdAt": "2020-04-30T18:53:12Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/BestEffortSegmentUploader.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.pinot.common.utils.StringUtil;\n+import org.apache.pinot.spi.filesystem.PinotFS;\n+import org.apache.pinot.spi.filesystem.PinotFSFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+// A segment uploader which does best effort segment upload to a segment store (with store root dir configured as\n+// _segmentStoreUriStr). The upload is successful if it is done within a configurable timeout period.\n+// The final segment location would be in the URI _segmentStoreUriStr/_tableNameWithType/segmentName if\n+// successful. If a segment upload fails or there is no segment store uri configured, it sets the segment location as\n+// the default URI.\n+public class BestEffortSegmentUploader implements SegmentUploader {\n+  private Logger LOGGER = LoggerFactory.getLogger(BestEffortSegmentUploader.class);\n+  private String _segmentStoreUriStr;\n+  private ExecutorService _executorService = Executors.newCachedThreadPool();\n+  // The default segment location URI to return if the upload fails.\n+  private URI _defaultSegmentLocationURI;\n+  private int _timeoutInMs;\n+\n+  public BestEffortSegmentUploader(String segmentStoreUriStr, int timeoutInMs, String defaultSegment) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "209262f25455031cfb572734dd4585517564ea72"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMjIyMTUwOnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/BestEffortSegmentUploader.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxODo1NjozOFrOGO2ROw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMlQwMToxMzozMVrOGPaFDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyMjM5NQ==", "bodyText": "Better to separate the default uri functionality. If the uploader.upload fails, it always returns null (have a consistent javaoc in SegmentUploader interface). The caller can decide whether default is needed. In this case, the split committer should decide that.", "url": "https://github.com/apache/pinot/pull/5314#discussion_r418222395", "createdAt": "2020-04-30T18:56:38Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/BestEffortSegmentUploader.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.pinot.common.utils.StringUtil;\n+import org.apache.pinot.spi.filesystem.PinotFS;\n+import org.apache.pinot.spi.filesystem.PinotFSFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+// A segment uploader which does best effort segment upload to a segment store (with store root dir configured as", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "209262f25455031cfb572734dd4585517564ea72"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYxNTkyMw==", "bodyText": "done. Another option is to use a AlwaysSucceedSegmentUploader with a default uri which wraps around the PinotFSSegmentUploader. For now, just let split committer handle the null case as you suggested.", "url": "https://github.com/apache/pinot/pull/5314#discussion_r418615923", "createdAt": "2020-05-01T16:20:51Z", "author": {"login": "chenboat"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/BestEffortSegmentUploader.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.pinot.common.utils.StringUtil;\n+import org.apache.pinot.spi.filesystem.PinotFS;\n+import org.apache.pinot.spi.filesystem.PinotFSFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+// A segment uploader which does best effort segment upload to a segment store (with store root dir configured as", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyMjM5NQ=="}, "originalCommit": {"oid": "209262f25455031cfb572734dd4585517564ea72"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODczMzU1MQ==", "bodyText": "We can override the split commit class with another class, or pass a flag into the split committer to decide whether to override failures with default. I would prefer the former. The decision of which committer to use should be left to the table config.", "url": "https://github.com/apache/pinot/pull/5314#discussion_r418733551", "createdAt": "2020-05-01T20:54:02Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/BestEffortSegmentUploader.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.pinot.common.utils.StringUtil;\n+import org.apache.pinot.spi.filesystem.PinotFS;\n+import org.apache.pinot.spi.filesystem.PinotFSFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+// A segment uploader which does best effort segment upload to a segment store (with store root dir configured as", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyMjM5NQ=="}, "originalCommit": {"oid": "209262f25455031cfb572734dd4585517564ea72"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODgwOTEwMw==", "bodyText": "done.", "url": "https://github.com/apache/pinot/pull/5314#discussion_r418809103", "createdAt": "2020-05-02T01:13:31Z", "author": {"login": "chenboat"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/BestEffortSegmentUploader.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.pinot.common.utils.StringUtil;\n+import org.apache.pinot.spi.filesystem.PinotFS;\n+import org.apache.pinot.spi.filesystem.PinotFSFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+// A segment uploader which does best effort segment upload to a segment store (with store root dir configured as", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyMjM5NQ=="}, "originalCommit": {"oid": "209262f25455031cfb572734dd4585517564ea72"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMjIyNDg1OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/BestEffortSegmentUploader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxODo1NzozM1rOGO2TbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxNjoyMTowNVrOGPOS1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyMjk1Nw==", "bodyText": "InterruptedException should be OK, if the service is being shutdown", "url": "https://github.com/apache/pinot/pull/5314#discussion_r418222957", "createdAt": "2020-04-30T18:57:33Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/BestEffortSegmentUploader.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.pinot.common.utils.StringUtil;\n+import org.apache.pinot.spi.filesystem.PinotFS;\n+import org.apache.pinot.spi.filesystem.PinotFSFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+// A segment uploader which does best effort segment upload to a segment store (with store root dir configured as\n+// _segmentStoreUriStr). The upload is successful if it is done within a configurable timeout period.\n+// The final segment location would be in the URI _segmentStoreUriStr/_tableNameWithType/segmentName if\n+// successful. If a segment upload fails or there is no segment store uri configured, it sets the segment location as\n+// the default URI.\n+public class BestEffortSegmentUploader implements SegmentUploader {\n+  private Logger LOGGER = LoggerFactory.getLogger(BestEffortSegmentUploader.class);\n+  private String _segmentStoreUriStr;\n+  private ExecutorService _executorService = Executors.newCachedThreadPool();\n+  // The default segment location URI to return if the upload fails.\n+  private URI _defaultSegmentLocationURI;\n+  private int _timeoutInMs;\n+\n+  public BestEffortSegmentUploader(String segmentStoreUriStr, int timeoutInMs, String defaultSegment) {\n+    _segmentStoreUriStr = segmentStoreUriStr;\n+    _timeoutInMs = timeoutInMs;\n+    _defaultSegmentLocationURI = URI.create(defaultSegment);\n+  }\n+\n+  public URI uploadSegment(File segmentFile, String tableNameWithType, String segmentName) {\n+    if (_segmentStoreUriStr == null || _segmentStoreUriStr.isEmpty()) {\n+      return _defaultSegmentLocationURI;\n+    }\n+\n+    Callable<URI> uploadTask = () -> {\n+      try {\n+        PinotFS pinotFS = PinotFSFactory.create(new URI(_segmentStoreUriStr).getScheme());\n+        URI destUri = new URI(StringUtil.join(File.separator, _segmentStoreUriStr, tableNameWithType, segmentName));\n+        // Check and delete any existing segment file.\n+        if (pinotFS.exists(destUri)) {\n+          pinotFS.delete(destUri, true);\n+        }\n+        pinotFS.copyFromLocalFile(segmentFile, destUri);\n+        return destUri;\n+      } catch (Exception e) {\n+        LOGGER.error(\"Failed copy segment tar file to segment store {}: {}\", segmentFile.getName(), e);\n+      }\n+      return _defaultSegmentLocationURI;\n+    };\n+    Future<URI> future = _executorService.submit(uploadTask);\n+    try {\n+      URI segmentLocation = future.get(_timeoutInMs, TimeUnit.MILLISECONDS);\n+      return segmentLocation;\n+    } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "209262f25455031cfb572734dd4585517564ea72"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYxNjAyMg==", "bodyText": "done.", "url": "https://github.com/apache/pinot/pull/5314#discussion_r418616022", "createdAt": "2020-05-01T16:21:05Z", "author": {"login": "chenboat"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/BestEffortSegmentUploader.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.pinot.common.utils.StringUtil;\n+import org.apache.pinot.spi.filesystem.PinotFS;\n+import org.apache.pinot.spi.filesystem.PinotFSFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+// A segment uploader which does best effort segment upload to a segment store (with store root dir configured as\n+// _segmentStoreUriStr). The upload is successful if it is done within a configurable timeout period.\n+// The final segment location would be in the URI _segmentStoreUriStr/_tableNameWithType/segmentName if\n+// successful. If a segment upload fails or there is no segment store uri configured, it sets the segment location as\n+// the default URI.\n+public class BestEffortSegmentUploader implements SegmentUploader {\n+  private Logger LOGGER = LoggerFactory.getLogger(BestEffortSegmentUploader.class);\n+  private String _segmentStoreUriStr;\n+  private ExecutorService _executorService = Executors.newCachedThreadPool();\n+  // The default segment location URI to return if the upload fails.\n+  private URI _defaultSegmentLocationURI;\n+  private int _timeoutInMs;\n+\n+  public BestEffortSegmentUploader(String segmentStoreUriStr, int timeoutInMs, String defaultSegment) {\n+    _segmentStoreUriStr = segmentStoreUriStr;\n+    _timeoutInMs = timeoutInMs;\n+    _defaultSegmentLocationURI = URI.create(defaultSegment);\n+  }\n+\n+  public URI uploadSegment(File segmentFile, String tableNameWithType, String segmentName) {\n+    if (_segmentStoreUriStr == null || _segmentStoreUriStr.isEmpty()) {\n+      return _defaultSegmentLocationURI;\n+    }\n+\n+    Callable<URI> uploadTask = () -> {\n+      try {\n+        PinotFS pinotFS = PinotFSFactory.create(new URI(_segmentStoreUriStr).getScheme());\n+        URI destUri = new URI(StringUtil.join(File.separator, _segmentStoreUriStr, tableNameWithType, segmentName));\n+        // Check and delete any existing segment file.\n+        if (pinotFS.exists(destUri)) {\n+          pinotFS.delete(destUri, true);\n+        }\n+        pinotFS.copyFromLocalFile(segmentFile, destUri);\n+        return destUri;\n+      } catch (Exception e) {\n+        LOGGER.error(\"Failed copy segment tar file to segment store {}: {}\", segmentFile.getName(), e);\n+      }\n+      return _defaultSegmentLocationURI;\n+    };\n+    Future<URI> future = _executorService.submit(uploadTask);\n+    try {\n+      URI segmentLocation = future.get(_timeoutInMs, TimeUnit.MILLISECONDS);\n+      return segmentLocation;\n+    } catch (Exception e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyMjk1Nw=="}, "originalCommit": {"oid": "209262f25455031cfb572734dd4585517564ea72"}, "originalPosition": 78}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMjIyNjY0OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/BestEffortSegmentUploader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxODo1ODowOVrOGO2Uow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxNjoyMToxOVrOGPOTRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyMzI2Nw==", "bodyText": "Not sure if this should be logged as an error, since we have recovery mechanisms. Warning should be ok. We should log an error in higher layers if we just cannot recover from this", "url": "https://github.com/apache/pinot/pull/5314#discussion_r418223267", "createdAt": "2020-04-30T18:58:09Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/BestEffortSegmentUploader.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.pinot.common.utils.StringUtil;\n+import org.apache.pinot.spi.filesystem.PinotFS;\n+import org.apache.pinot.spi.filesystem.PinotFSFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+// A segment uploader which does best effort segment upload to a segment store (with store root dir configured as\n+// _segmentStoreUriStr). The upload is successful if it is done within a configurable timeout period.\n+// The final segment location would be in the URI _segmentStoreUriStr/_tableNameWithType/segmentName if\n+// successful. If a segment upload fails or there is no segment store uri configured, it sets the segment location as\n+// the default URI.\n+public class BestEffortSegmentUploader implements SegmentUploader {\n+  private Logger LOGGER = LoggerFactory.getLogger(BestEffortSegmentUploader.class);\n+  private String _segmentStoreUriStr;\n+  private ExecutorService _executorService = Executors.newCachedThreadPool();\n+  // The default segment location URI to return if the upload fails.\n+  private URI _defaultSegmentLocationURI;\n+  private int _timeoutInMs;\n+\n+  public BestEffortSegmentUploader(String segmentStoreUriStr, int timeoutInMs, String defaultSegment) {\n+    _segmentStoreUriStr = segmentStoreUriStr;\n+    _timeoutInMs = timeoutInMs;\n+    _defaultSegmentLocationURI = URI.create(defaultSegment);\n+  }\n+\n+  public URI uploadSegment(File segmentFile, String tableNameWithType, String segmentName) {\n+    if (_segmentStoreUriStr == null || _segmentStoreUriStr.isEmpty()) {\n+      return _defaultSegmentLocationURI;\n+    }\n+\n+    Callable<URI> uploadTask = () -> {\n+      try {\n+        PinotFS pinotFS = PinotFSFactory.create(new URI(_segmentStoreUriStr).getScheme());\n+        URI destUri = new URI(StringUtil.join(File.separator, _segmentStoreUriStr, tableNameWithType, segmentName));\n+        // Check and delete any existing segment file.\n+        if (pinotFS.exists(destUri)) {\n+          pinotFS.delete(destUri, true);\n+        }\n+        pinotFS.copyFromLocalFile(segmentFile, destUri);\n+        return destUri;\n+      } catch (Exception e) {\n+        LOGGER.error(\"Failed copy segment tar file to segment store {}: {}\", segmentFile.getName(), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "209262f25455031cfb572734dd4585517564ea72"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYxNjEzNA==", "bodyText": "Done and use warning.", "url": "https://github.com/apache/pinot/pull/5314#discussion_r418616134", "createdAt": "2020-05-01T16:21:19Z", "author": {"login": "chenboat"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/BestEffortSegmentUploader.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.pinot.common.utils.StringUtil;\n+import org.apache.pinot.spi.filesystem.PinotFS;\n+import org.apache.pinot.spi.filesystem.PinotFSFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+// A segment uploader which does best effort segment upload to a segment store (with store root dir configured as\n+// _segmentStoreUriStr). The upload is successful if it is done within a configurable timeout period.\n+// The final segment location would be in the URI _segmentStoreUriStr/_tableNameWithType/segmentName if\n+// successful. If a segment upload fails or there is no segment store uri configured, it sets the segment location as\n+// the default URI.\n+public class BestEffortSegmentUploader implements SegmentUploader {\n+  private Logger LOGGER = LoggerFactory.getLogger(BestEffortSegmentUploader.class);\n+  private String _segmentStoreUriStr;\n+  private ExecutorService _executorService = Executors.newCachedThreadPool();\n+  // The default segment location URI to return if the upload fails.\n+  private URI _defaultSegmentLocationURI;\n+  private int _timeoutInMs;\n+\n+  public BestEffortSegmentUploader(String segmentStoreUriStr, int timeoutInMs, String defaultSegment) {\n+    _segmentStoreUriStr = segmentStoreUriStr;\n+    _timeoutInMs = timeoutInMs;\n+    _defaultSegmentLocationURI = URI.create(defaultSegment);\n+  }\n+\n+  public URI uploadSegment(File segmentFile, String tableNameWithType, String segmentName) {\n+    if (_segmentStoreUriStr == null || _segmentStoreUriStr.isEmpty()) {\n+      return _defaultSegmentLocationURI;\n+    }\n+\n+    Callable<URI> uploadTask = () -> {\n+      try {\n+        PinotFS pinotFS = PinotFSFactory.create(new URI(_segmentStoreUriStr).getScheme());\n+        URI destUri = new URI(StringUtil.join(File.separator, _segmentStoreUriStr, tableNameWithType, segmentName));\n+        // Check and delete any existing segment file.\n+        if (pinotFS.exists(destUri)) {\n+          pinotFS.delete(destUri, true);\n+        }\n+        pinotFS.copyFromLocalFile(segmentFile, destUri);\n+        return destUri;\n+      } catch (Exception e) {\n+        LOGGER.error(\"Failed copy segment tar file to segment store {}: {}\", segmentFile.getName(), e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyMzI2Nw=="}, "originalCommit": {"oid": "209262f25455031cfb572734dd4585517564ea72"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMjIyNzc3OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/BestEffortSegmentUploader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxODo1ODoyOVrOGO2VZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxNjozMDo1MVrOGPOjqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyMzQ2Mg==", "bodyText": "same comment here about error. Will we be logging 2 error messages?", "url": "https://github.com/apache/pinot/pull/5314#discussion_r418223462", "createdAt": "2020-04-30T18:58:29Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/BestEffortSegmentUploader.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.pinot.common.utils.StringUtil;\n+import org.apache.pinot.spi.filesystem.PinotFS;\n+import org.apache.pinot.spi.filesystem.PinotFSFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+// A segment uploader which does best effort segment upload to a segment store (with store root dir configured as\n+// _segmentStoreUriStr). The upload is successful if it is done within a configurable timeout period.\n+// The final segment location would be in the URI _segmentStoreUriStr/_tableNameWithType/segmentName if\n+// successful. If a segment upload fails or there is no segment store uri configured, it sets the segment location as\n+// the default URI.\n+public class BestEffortSegmentUploader implements SegmentUploader {\n+  private Logger LOGGER = LoggerFactory.getLogger(BestEffortSegmentUploader.class);\n+  private String _segmentStoreUriStr;\n+  private ExecutorService _executorService = Executors.newCachedThreadPool();\n+  // The default segment location URI to return if the upload fails.\n+  private URI _defaultSegmentLocationURI;\n+  private int _timeoutInMs;\n+\n+  public BestEffortSegmentUploader(String segmentStoreUriStr, int timeoutInMs, String defaultSegment) {\n+    _segmentStoreUriStr = segmentStoreUriStr;\n+    _timeoutInMs = timeoutInMs;\n+    _defaultSegmentLocationURI = URI.create(defaultSegment);\n+  }\n+\n+  public URI uploadSegment(File segmentFile, String tableNameWithType, String segmentName) {\n+    if (_segmentStoreUriStr == null || _segmentStoreUriStr.isEmpty()) {\n+      return _defaultSegmentLocationURI;\n+    }\n+\n+    Callable<URI> uploadTask = () -> {\n+      try {\n+        PinotFS pinotFS = PinotFSFactory.create(new URI(_segmentStoreUriStr).getScheme());\n+        URI destUri = new URI(StringUtil.join(File.separator, _segmentStoreUriStr, tableNameWithType, segmentName));\n+        // Check and delete any existing segment file.\n+        if (pinotFS.exists(destUri)) {\n+          pinotFS.delete(destUri, true);\n+        }\n+        pinotFS.copyFromLocalFile(segmentFile, destUri);\n+        return destUri;\n+      } catch (Exception e) {\n+        LOGGER.error(\"Failed copy segment tar file to segment store {}: {}\", segmentFile.getName(), e);\n+      }\n+      return _defaultSegmentLocationURI;\n+    };\n+    Future<URI> future = _executorService.submit(uploadTask);\n+    try {\n+      URI segmentLocation = future.get(_timeoutInMs, TimeUnit.MILLISECONDS);\n+      return segmentLocation;\n+    } catch (Exception e) {\n+      LOGGER.error(\"Failed to upload file {} of segment {} for table {} \", segmentFile.getAbsolutePath(), segmentName,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "209262f25455031cfb572734dd4585517564ea72"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYyMDMyOA==", "bodyText": "Switch to use WARN. Are you asking about 2 error (or warning) messages: one for the callable task and the other for the future waiting? I could not think of cases in which both error will be logged. Even in the timeout scenario, only the future waiting error is logged -- as the unit test shows. Also the two errors have different signatures.", "url": "https://github.com/apache/pinot/pull/5314#discussion_r418620328", "createdAt": "2020-05-01T16:30:51Z", "author": {"login": "chenboat"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/BestEffortSegmentUploader.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.pinot.common.utils.StringUtil;\n+import org.apache.pinot.spi.filesystem.PinotFS;\n+import org.apache.pinot.spi.filesystem.PinotFSFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+// A segment uploader which does best effort segment upload to a segment store (with store root dir configured as\n+// _segmentStoreUriStr). The upload is successful if it is done within a configurable timeout period.\n+// The final segment location would be in the URI _segmentStoreUriStr/_tableNameWithType/segmentName if\n+// successful. If a segment upload fails or there is no segment store uri configured, it sets the segment location as\n+// the default URI.\n+public class BestEffortSegmentUploader implements SegmentUploader {\n+  private Logger LOGGER = LoggerFactory.getLogger(BestEffortSegmentUploader.class);\n+  private String _segmentStoreUriStr;\n+  private ExecutorService _executorService = Executors.newCachedThreadPool();\n+  // The default segment location URI to return if the upload fails.\n+  private URI _defaultSegmentLocationURI;\n+  private int _timeoutInMs;\n+\n+  public BestEffortSegmentUploader(String segmentStoreUriStr, int timeoutInMs, String defaultSegment) {\n+    _segmentStoreUriStr = segmentStoreUriStr;\n+    _timeoutInMs = timeoutInMs;\n+    _defaultSegmentLocationURI = URI.create(defaultSegment);\n+  }\n+\n+  public URI uploadSegment(File segmentFile, String tableNameWithType, String segmentName) {\n+    if (_segmentStoreUriStr == null || _segmentStoreUriStr.isEmpty()) {\n+      return _defaultSegmentLocationURI;\n+    }\n+\n+    Callable<URI> uploadTask = () -> {\n+      try {\n+        PinotFS pinotFS = PinotFSFactory.create(new URI(_segmentStoreUriStr).getScheme());\n+        URI destUri = new URI(StringUtil.join(File.separator, _segmentStoreUriStr, tableNameWithType, segmentName));\n+        // Check and delete any existing segment file.\n+        if (pinotFS.exists(destUri)) {\n+          pinotFS.delete(destUri, true);\n+        }\n+        pinotFS.copyFromLocalFile(segmentFile, destUri);\n+        return destUri;\n+      } catch (Exception e) {\n+        LOGGER.error(\"Failed copy segment tar file to segment store {}: {}\", segmentFile.getName(), e);\n+      }\n+      return _defaultSegmentLocationURI;\n+    };\n+    Future<URI> future = _executorService.submit(uploadTask);\n+    try {\n+      URI segmentLocation = future.get(_timeoutInMs, TimeUnit.MILLISECONDS);\n+      return segmentLocation;\n+    } catch (Exception e) {\n+      LOGGER.error(\"Failed to upload file {} of segment {} for table {} \", segmentFile.getAbsolutePath(), segmentName,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyMzQ2Mg=="}, "originalCommit": {"oid": "209262f25455031cfb572734dd4585517564ea72"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMjIzMDM3OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/Server2ControllerSegmentUploader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxODo1OToxNVrOGO2XGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxODo1OToxNVrOGO2XGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyMzg5OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public URI uploadSegment(File segmentFile, String tableName, String segmentName) {\n          \n          \n            \n              public URI uploadSegment(File segmentFile,  LLCSegmentName segmentName) {\n          \n      \n    \n    \n  \n\nsegmentName already has the (raw) tableName.", "url": "https://github.com/apache/pinot/pull/5314#discussion_r418223898", "createdAt": "2020-04-30T18:59:15Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/Server2ControllerSegmentUploader.java", "diffHunk": "@@ -52,7 +52,7 @@ public Server2ControllerSegmentUploader(Logger segmentLogger, FileUploadDownload\n   }\n \n   @Override\n-  public URI uploadSegment(File segmentFile) {\n+  public URI uploadSegment(File segmentFile, String tableName, String segmentName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "209262f25455031cfb572734dd4585517564ea72"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwNTUyNjQ5OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/PinotFSSegmentUploader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQyMDo1NTowNFrOGPVfVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQyMDo1NTowNFrOGPVfVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODczMzkwOA==", "bodyText": "Can you put this in javadoc format?", "url": "https://github.com/apache/pinot/pull/5314#discussion_r418733908", "createdAt": "2020-05-01T20:55:04Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/PinotFSSegmentUploader.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.pinot.common.utils.LLCSegmentName;\n+import org.apache.pinot.common.utils.StringUtil;\n+import org.apache.pinot.spi.filesystem.PinotFS;\n+import org.apache.pinot.spi.filesystem.PinotFSFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+// A segment uploader which does segment upload to a segment store (with store root dir configured as", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "226c0a47c4522ec16c016a4cf91af6400565596a"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwNTUzMDMzOnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/PinotFSSegmentUploader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQyMDo1Njo1MlrOGPVh4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMlQwMDoyMDozOVrOGPYwYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODczNDU2Mw==", "bodyText": "include segment destUri in the log", "url": "https://github.com/apache/pinot/pull/5314#discussion_r418734563", "createdAt": "2020-05-01T20:56:52Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/PinotFSSegmentUploader.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.pinot.common.utils.LLCSegmentName;\n+import org.apache.pinot.common.utils.StringUtil;\n+import org.apache.pinot.spi.filesystem.PinotFS;\n+import org.apache.pinot.spi.filesystem.PinotFSFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+// A segment uploader which does segment upload to a segment store (with store root dir configured as\n+// _segmentStoreUriStr) using PinotFS within a configurable timeout period. The final segment location would be in the\n+// URI _segmentStoreUriStr/_tableNameWithType/segmentName if successful.\n+public class PinotFSSegmentUploader implements SegmentUploader {\n+  private Logger LOGGER = LoggerFactory.getLogger(PinotFSSegmentUploader.class);\n+  private String _segmentStoreUriStr;\n+  private ExecutorService _executorService = Executors.newCachedThreadPool();\n+  private int _timeoutInMs;\n+\n+  public PinotFSSegmentUploader(String segmentStoreDirUri, int timeoutMillis) {\n+    _segmentStoreUriStr = segmentStoreDirUri;\n+    _timeoutInMs = timeoutMillis;\n+  }\n+\n+  public URI uploadSegment(File segmentFile, LLCSegmentName segmentName) {\n+    if (_segmentStoreUriStr == null || _segmentStoreUriStr.isEmpty()) {\n+      return null;\n+    }\n+    Callable<URI> uploadTask = () -> {\n+      try {\n+        PinotFS pinotFS = PinotFSFactory.create(new URI(_segmentStoreUriStr).getScheme());\n+        URI destUri = new URI(StringUtil\n+            .join(File.separator, _segmentStoreUriStr, segmentName.getTableName(), segmentName.getSegmentName()));\n+        // Check and delete any existing segment file.\n+        if (pinotFS.exists(destUri)) {\n+          pinotFS.delete(destUri, true);\n+        }\n+        pinotFS.copyFromLocalFile(segmentFile, destUri);\n+        return destUri;\n+      } catch (Exception e) {\n+        LOGGER.warn(\"Failed copy segment tar file to segment store {}: {}\", segmentFile.getName(), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "226c0a47c4522ec16c016a4cf91af6400565596a"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc4NzQyNQ==", "bodyText": "done.", "url": "https://github.com/apache/pinot/pull/5314#discussion_r418787425", "createdAt": "2020-05-02T00:20:39Z", "author": {"login": "chenboat"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/PinotFSSegmentUploader.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.pinot.common.utils.LLCSegmentName;\n+import org.apache.pinot.common.utils.StringUtil;\n+import org.apache.pinot.spi.filesystem.PinotFS;\n+import org.apache.pinot.spi.filesystem.PinotFSFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+// A segment uploader which does segment upload to a segment store (with store root dir configured as\n+// _segmentStoreUriStr) using PinotFS within a configurable timeout period. The final segment location would be in the\n+// URI _segmentStoreUriStr/_tableNameWithType/segmentName if successful.\n+public class PinotFSSegmentUploader implements SegmentUploader {\n+  private Logger LOGGER = LoggerFactory.getLogger(PinotFSSegmentUploader.class);\n+  private String _segmentStoreUriStr;\n+  private ExecutorService _executorService = Executors.newCachedThreadPool();\n+  private int _timeoutInMs;\n+\n+  public PinotFSSegmentUploader(String segmentStoreDirUri, int timeoutMillis) {\n+    _segmentStoreUriStr = segmentStoreDirUri;\n+    _timeoutInMs = timeoutMillis;\n+  }\n+\n+  public URI uploadSegment(File segmentFile, LLCSegmentName segmentName) {\n+    if (_segmentStoreUriStr == null || _segmentStoreUriStr.isEmpty()) {\n+      return null;\n+    }\n+    Callable<URI> uploadTask = () -> {\n+      try {\n+        PinotFS pinotFS = PinotFSFactory.create(new URI(_segmentStoreUriStr).getScheme());\n+        URI destUri = new URI(StringUtil\n+            .join(File.separator, _segmentStoreUriStr, segmentName.getTableName(), segmentName.getSegmentName()));\n+        // Check and delete any existing segment file.\n+        if (pinotFS.exists(destUri)) {\n+          pinotFS.delete(destUri, true);\n+        }\n+        pinotFS.copyFromLocalFile(segmentFile, destUri);\n+        return destUri;\n+      } catch (Exception e) {\n+        LOGGER.warn(\"Failed copy segment tar file to segment store {}: {}\", segmentFile.getName(), e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODczNDU2Mw=="}, "originalCommit": {"oid": "226c0a47c4522ec16c016a4cf91af6400565596a"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwNTU5NDY2OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SplitSegmentCommitter.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQyMToyNTowNlrOGPWJHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMDozNzowNVrOGQRObw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc0NDYwNg==", "bodyText": "I think we can clean this up by not having the extra argument, but just taking TableConfig instead of indexLoadingConfig in the constructor. We can pull from tableconfig  whether the default (always a peer).  Construct the peer download URL in this class if the upload fails. For now, you can comment out that failure handling code.\nLet us float a discussion on how the table should be configured on upload failure. You can either do it in doc, or via email or a discsussion in the chat channel (and summarize in email).\nA few options come to mind, but best to discuss with the team before moving forward.\n\nIn  the SegmentValidationAndRetentionConfig set some variable to indicate that we are enabling peer download for segments. The variable can just indicate the scheme: e.g. \"http\".  The rest of the URL can be constructed easily since we know the value of the host, port. etc. I prefer this to having a boolean and then another one for the scheme somewhere else. Putting it here can also help in the case when deep store is down and we want to download offline table segments.\nIntroduce something in the streamConfig section, but that restricts the peer download to realtime only.\n\nIn the splitSegmentCommitter class, look at the table config to construct the URL.", "url": "https://github.com/apache/pinot/pull/5314#discussion_r418744606", "createdAt": "2020-05-01T21:25:06Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SplitSegmentCommitter.java", "diffHunk": "@@ -35,16 +38,34 @@\n   private final ServerSegmentCompletionProtocolHandler _protocolHandler;\n   private final IndexLoadingConfig _indexLoadingConfig;\n   private final SegmentUploader _segmentUploader;\n+  // The default segment location uri str, could be null.\n+  private final String _defaultSegmentLocation;\n \n   private final Logger _segmentLogger;\n \n   public SplitSegmentCommitter(Logger segmentLogger, ServerSegmentCompletionProtocolHandler protocolHandler,\n       IndexLoadingConfig indexLoadingConfig, SegmentCompletionProtocol.Request.Params params, SegmentUploader segmentUploader) {\n+    this(segmentLogger, protocolHandler, indexLoadingConfig, params, segmentUploader, null);\n+  }\n+\n+  /**\n+   *\n+   * @param segmentLogger\n+   * @param protocolHandler\n+   * @param indexLoadingConfig\n+   * @param params\n+   * @param segmentUploader\n+   * @param defaultSegmentLocation The default segment location uri str, could be null.\n+   */\n+  public SplitSegmentCommitter(Logger segmentLogger, ServerSegmentCompletionProtocolHandler protocolHandler,\n+      IndexLoadingConfig indexLoadingConfig, SegmentCompletionProtocol.Request.Params params, SegmentUploader segmentUploader,\n+      String defaultSegmentLocation) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "226c0a47c4522ec16c016a4cf91af6400565596a"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODgwODk2NA==", "bodyText": "Will send out the config change proposal. Replace indexLoadingConfig with tableConfig. Note that isEnableSplitCommitEndWithMetadata in indexLoadingConfig is a server instance level config. TableConfig does not have this field -- so I add a new boolean flag to the factory creation method. This flag can be removed if no other is using the deprecated _protocolHandler.segmentCommitEnd() anymore.", "url": "https://github.com/apache/pinot/pull/5314#discussion_r418808964", "createdAt": "2020-05-02T01:13:10Z", "author": {"login": "chenboat"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SplitSegmentCommitter.java", "diffHunk": "@@ -35,16 +38,34 @@\n   private final ServerSegmentCompletionProtocolHandler _protocolHandler;\n   private final IndexLoadingConfig _indexLoadingConfig;\n   private final SegmentUploader _segmentUploader;\n+  // The default segment location uri str, could be null.\n+  private final String _defaultSegmentLocation;\n \n   private final Logger _segmentLogger;\n \n   public SplitSegmentCommitter(Logger segmentLogger, ServerSegmentCompletionProtocolHandler protocolHandler,\n       IndexLoadingConfig indexLoadingConfig, SegmentCompletionProtocol.Request.Params params, SegmentUploader segmentUploader) {\n+    this(segmentLogger, protocolHandler, indexLoadingConfig, params, segmentUploader, null);\n+  }\n+\n+  /**\n+   *\n+   * @param segmentLogger\n+   * @param protocolHandler\n+   * @param indexLoadingConfig\n+   * @param params\n+   * @param segmentUploader\n+   * @param defaultSegmentLocation The default segment location uri str, could be null.\n+   */\n+  public SplitSegmentCommitter(Logger segmentLogger, ServerSegmentCompletionProtocolHandler protocolHandler,\n+      IndexLoadingConfig indexLoadingConfig, SegmentCompletionProtocol.Request.Params params, SegmentUploader segmentUploader,\n+      String defaultSegmentLocation) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc0NDYwNg=="}, "originalCommit": {"oid": "226c0a47c4522ec16c016a4cf91af6400565596a"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTU1ODA1MA==", "bodyText": "Ah, the config isEnableSplitCommitEndWithMetadata can re removed now. We had introduced that for upgrade compatibility. by now, the controllers should already have the capability to get split commit with metadata.\nSo, you can remove that, and then, like you pointed out, remove tableConfig as well (for some reason, I thought tableConfig had that boolean. my bad, sorry)", "url": "https://github.com/apache/pinot/pull/5314#discussion_r419558050", "createdAt": "2020-05-04T16:19:14Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SplitSegmentCommitter.java", "diffHunk": "@@ -35,16 +38,34 @@\n   private final ServerSegmentCompletionProtocolHandler _protocolHandler;\n   private final IndexLoadingConfig _indexLoadingConfig;\n   private final SegmentUploader _segmentUploader;\n+  // The default segment location uri str, could be null.\n+  private final String _defaultSegmentLocation;\n \n   private final Logger _segmentLogger;\n \n   public SplitSegmentCommitter(Logger segmentLogger, ServerSegmentCompletionProtocolHandler protocolHandler,\n       IndexLoadingConfig indexLoadingConfig, SegmentCompletionProtocol.Request.Params params, SegmentUploader segmentUploader) {\n+    this(segmentLogger, protocolHandler, indexLoadingConfig, params, segmentUploader, null);\n+  }\n+\n+  /**\n+   *\n+   * @param segmentLogger\n+   * @param protocolHandler\n+   * @param indexLoadingConfig\n+   * @param params\n+   * @param segmentUploader\n+   * @param defaultSegmentLocation The default segment location uri str, could be null.\n+   */\n+  public SplitSegmentCommitter(Logger segmentLogger, ServerSegmentCompletionProtocolHandler protocolHandler,\n+      IndexLoadingConfig indexLoadingConfig, SegmentCompletionProtocol.Request.Params params, SegmentUploader segmentUploader,\n+      String defaultSegmentLocation) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc0NDYwNg=="}, "originalCommit": {"oid": "226c0a47c4522ec16c016a4cf91af6400565596a"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcxMjYyMw==", "bodyText": "the boolean flag isEnableSplitCommitEndWithMetadata and tableConfig removed.", "url": "https://github.com/apache/pinot/pull/5314#discussion_r419712623", "createdAt": "2020-05-04T20:37:05Z", "author": {"login": "chenboat"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SplitSegmentCommitter.java", "diffHunk": "@@ -35,16 +38,34 @@\n   private final ServerSegmentCompletionProtocolHandler _protocolHandler;\n   private final IndexLoadingConfig _indexLoadingConfig;\n   private final SegmentUploader _segmentUploader;\n+  // The default segment location uri str, could be null.\n+  private final String _defaultSegmentLocation;\n \n   private final Logger _segmentLogger;\n \n   public SplitSegmentCommitter(Logger segmentLogger, ServerSegmentCompletionProtocolHandler protocolHandler,\n       IndexLoadingConfig indexLoadingConfig, SegmentCompletionProtocol.Request.Params params, SegmentUploader segmentUploader) {\n+    this(segmentLogger, protocolHandler, indexLoadingConfig, params, segmentUploader, null);\n+  }\n+\n+  /**\n+   *\n+   * @param segmentLogger\n+   * @param protocolHandler\n+   * @param indexLoadingConfig\n+   * @param params\n+   * @param segmentUploader\n+   * @param defaultSegmentLocation The default segment location uri str, could be null.\n+   */\n+  public SplitSegmentCommitter(Logger segmentLogger, ServerSegmentCompletionProtocolHandler protocolHandler,\n+      IndexLoadingConfig indexLoadingConfig, SegmentCompletionProtocol.Request.Params params, SegmentUploader segmentUploader,\n+      String defaultSegmentLocation) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc0NDYwNg=="}, "originalCommit": {"oid": "226c0a47c4522ec16c016a4cf91af6400565596a"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMTYxMzczOnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/PinotFSSegmentUploader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxNjoyMDo0NlrOGQH2ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxNjoyMDo0NlrOGQH2ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTU1OTA5OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  LOGGER.info(\"Interrupted while waiting for segment upload.\");\n          \n          \n            \n                  LOGGER.info(\"Interrupted while waiting for segment upload of {} to {}.\", segmentName, _segmentStoreUriStr);", "url": "https://github.com/apache/pinot/pull/5314#discussion_r419559098", "createdAt": "2020-05-04T16:20:46Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/PinotFSSegmentUploader.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.pinot.common.utils.LLCSegmentName;\n+import org.apache.pinot.common.utils.StringUtil;\n+import org.apache.pinot.spi.filesystem.PinotFS;\n+import org.apache.pinot.spi.filesystem.PinotFSFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+/**\n+ * A segment uploader which does segment upload to a segment store (with store root dir configured as\n+ * _segmentStoreUriStr) using PinotFS within a configurable timeout period. The final segment location would be in the\n+ * URI _segmentStoreUriStr/_tableNameWithType/segmentName if successful.\n+ */\n+public class PinotFSSegmentUploader implements SegmentUploader {\n+  private Logger LOGGER = LoggerFactory.getLogger(PinotFSSegmentUploader.class);\n+  private String _segmentStoreUriStr;\n+  private ExecutorService _executorService = Executors.newCachedThreadPool();\n+  private int _timeoutInMs;\n+\n+  public PinotFSSegmentUploader(String segmentStoreDirUri, int timeoutMillis) {\n+    _segmentStoreUriStr = segmentStoreDirUri;\n+    _timeoutInMs = timeoutMillis;\n+  }\n+\n+  public URI uploadSegment(File segmentFile, LLCSegmentName segmentName) {\n+    if (_segmentStoreUriStr == null || _segmentStoreUriStr.isEmpty()) {\n+      return null;\n+    }\n+    Callable<URI> uploadTask = () -> {\n+      URI destUri = new URI(StringUtil\n+          .join(File.separator, _segmentStoreUriStr, segmentName.getTableName(), segmentName.getSegmentName()));\n+      try {\n+        PinotFS pinotFS = PinotFSFactory.create(new URI(_segmentStoreUriStr).getScheme());\n+        // Check and delete any existing segment file.\n+        if (pinotFS.exists(destUri)) {\n+          pinotFS.delete(destUri, true);\n+        }\n+        pinotFS.copyFromLocalFile(segmentFile, destUri);\n+        return destUri;\n+      } catch (Exception e) {\n+        LOGGER.warn(\"Failed copy segment tar file {} to segment store {}: {}\", segmentFile.getName(), destUri, e);\n+      }\n+      return null;\n+    };\n+    Future<URI> future = _executorService.submit(uploadTask);\n+    try {\n+      URI segmentLocation = future.get(_timeoutInMs, TimeUnit.MILLISECONDS);\n+      return segmentLocation;\n+    } catch (InterruptedException e) {\n+      LOGGER.info(\"Interrupted while waiting for segment upload.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d53c0d8eb27fba2eafc77990b3e4d6c8c39a771"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMTYzMTIyOnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SegmentCommitterFactory.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxNjoyNDo1NVrOGQIBnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMDo0MzoyNFrOGQRb1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTU2MTg4Nw==", "bodyText": "My bad, looks like tableConfig is not used, we can remove it.", "url": "https://github.com/apache/pinot/pull/5314#discussion_r419561887", "createdAt": "2020-05-04T16:24:55Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SegmentCommitterFactory.java", "diffHunk": "@@ -29,18 +29,20 @@\n  */\n public class SegmentCommitterFactory {\n   private static Logger LOGGER;\n-  private final IndexLoadingConfig _indexLoadingConfig;\n+  private final TableConfig _tableConfig;\n   private final ServerSegmentCompletionProtocolHandler _protocolHandler;\n \n-  public SegmentCommitterFactory(Logger segmentLogger, IndexLoadingConfig indexLoadingConfig,\n+  public SegmentCommitterFactory(Logger segmentLogger, TableConfig tableConfig,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d53c0d8eb27fba2eafc77990b3e4d6c8c39a771"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcxNjA1Mg==", "bodyText": "Done.", "url": "https://github.com/apache/pinot/pull/5314#discussion_r419716052", "createdAt": "2020-05-04T20:43:24Z", "author": {"login": "chenboat"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SegmentCommitterFactory.java", "diffHunk": "@@ -29,18 +29,20 @@\n  */\n public class SegmentCommitterFactory {\n   private static Logger LOGGER;\n-  private final IndexLoadingConfig _indexLoadingConfig;\n+  private final TableConfig _tableConfig;\n   private final ServerSegmentCompletionProtocolHandler _protocolHandler;\n \n-  public SegmentCommitterFactory(Logger segmentLogger, IndexLoadingConfig indexLoadingConfig,\n+  public SegmentCommitterFactory(Logger segmentLogger, TableConfig tableConfig,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTU2MTg4Nw=="}, "originalCommit": {"oid": "2d53c0d8eb27fba2eafc77990b3e4d6c8c39a771"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMTYzODU5OnYy", "diffSide": "RIGHT", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/Server2ControllerSegmentUploader.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxNjoyNjozNlrOGQIGEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQyMToxOTowN1rOGQ79Ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTU2MzAyNg==", "bodyText": "In this class, we should not need the segment name argument anymore since we get it in the upload() call.", "url": "https://github.com/apache/pinot/pull/5314#discussion_r419563026", "createdAt": "2020-05-04T16:26:36Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/Server2ControllerSegmentUploader.java", "diffHunk": "@@ -24,6 +24,7 @@\n import org.apache.pinot.common.metrics.ServerMetrics;\n import org.apache.pinot.common.protocols.SegmentCompletionProtocol;\n import org.apache.pinot.common.utils.FileUploadDownloadClient;\n+import org.apache.pinot.common.utils.LLCSegmentName;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d53c0d8eb27fba2eafc77990b3e4d6c8c39a771"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcxNDY5Ng==", "bodyText": "This is a compile time dependency because this uploader implements the interface's\nURI uploadSegment(File segmentFile, LLCSegmentName segmentName);\nmethod.  The interface method uses segmentName -- which is a reasonable choice given that some implementation may need that info e.g., PinotFSUploader.", "url": "https://github.com/apache/pinot/pull/5314#discussion_r419714696", "createdAt": "2020-05-04T20:40:48Z", "author": {"login": "chenboat"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/Server2ControllerSegmentUploader.java", "diffHunk": "@@ -24,6 +24,7 @@\n import org.apache.pinot.common.metrics.ServerMetrics;\n import org.apache.pinot.common.protocols.SegmentCompletionProtocol;\n import org.apache.pinot.common.utils.FileUploadDownloadClient;\n+import org.apache.pinot.common.utils.LLCSegmentName;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTU2MzAyNg=="}, "originalCommit": {"oid": "2d53c0d8eb27fba2eafc77990b3e4d6c8c39a771"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQxMjc2Mw==", "bodyText": "I meant that we shouldnot need the segment name argument in the constructor of the class. Sorry, I should have been clearer. You can do this in another PR. It is not a public interface, so we are ok", "url": "https://github.com/apache/pinot/pull/5314#discussion_r420412763", "createdAt": "2020-05-05T21:19:07Z", "author": {"login": "mcvsubbu"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/Server2ControllerSegmentUploader.java", "diffHunk": "@@ -24,6 +24,7 @@\n import org.apache.pinot.common.metrics.ServerMetrics;\n import org.apache.pinot.common.protocols.SegmentCompletionProtocol;\n import org.apache.pinot.common.utils.FileUploadDownloadClient;\n+import org.apache.pinot.common.utils.LLCSegmentName;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTU2MzAyNg=="}, "originalCommit": {"oid": "2d53c0d8eb27fba2eafc77990b3e4d6c8c39a771"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3202, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}