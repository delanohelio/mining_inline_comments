{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1NDIzOTc2", "number": 5354, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwMjo0OTo0OVrOD7eKBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwMzowNjoyMlrOD7eUJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzNjg2NjYwOnYy", "diffSide": "RIGHT", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/MockEventsLoaderConfiguration.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwMjo0OTo0OVrOGT0Lww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwNDoyOToxOVrOGT1pQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQzMTEwNw==", "bodyText": "nit: Add license header", "url": "https://github.com/apache/pinot/pull/5354#discussion_r423431107", "createdAt": "2020-05-12T02:49:49Z", "author": {"login": "akshayrai"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/MockEventsLoaderConfiguration.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package org.apache.pinot.thirdeye.anomaly;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ee05d198e248b1c0138aa8e9d7726ec55ef66b5"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ1NTA0Mw==", "bodyText": "fixed", "url": "https://github.com/apache/pinot/pull/5354#discussion_r423455043", "createdAt": "2020-05-12T04:29:19Z", "author": {"login": "apucher"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/MockEventsLoaderConfiguration.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package org.apache.pinot.thirdeye.anomaly;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQzMTEwNw=="}, "originalCommit": {"oid": "7ee05d198e248b1c0138aa8e9d7726ec55ef66b5"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzNjg3MDIwOnYy", "diffSide": "RIGHT", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/rootcause/impl/ThirdEyeEventsPipeline.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwMjo1MjoxM1rOGT0ODA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwMjo1MjoxM1rOGT0ODA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQzMTY5Mg==", "bodyText": "might want to remove the new imports (here and below) in this class!", "url": "https://github.com/apache/pinot/pull/5354#discussion_r423431692", "createdAt": "2020-05-12T02:52:13Z", "author": {"login": "akshayrai"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/rootcause/impl/ThirdEyeEventsPipeline.java", "diffHunk": "@@ -19,6 +19,7 @@\n \n package org.apache.pinot.thirdeye.rootcause.impl;\n \n+import org.apache.commons.lang3.StringUtils;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ee05d198e248b1c0138aa8e9d7726ec55ef66b5"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzNjg4MjEyOnYy", "diffSide": "RIGHT", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/MockEventsLoaderConfiguration.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwMzowMDowNVrOGT0VZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwMzowMDowNVrOGT0VZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQzMzU3NQ==", "bodyText": "Can you include a one-line comment for these fields?", "url": "https://github.com/apache/pinot/pull/5354#discussion_r423433575", "createdAt": "2020-05-12T03:00:05Z", "author": {"login": "akshayrai"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/MockEventsLoaderConfiguration.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package org.apache.pinot.thirdeye.anomaly;\n+\n+\n+import org.apache.pinot.thirdeye.anomaly.events.MockEventsLoader;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+public class MockEventsLoaderConfiguration {\n+    public static class EventGeneratorConfig {\n+        String type;\n+        String arrivalType = MockEventsLoader.DIST_TYPE_EXPONENTIAL;\n+        double arrivalMean;\n+        String durationType = MockEventsLoader.DIST_TYPE_FIXED;\n+        double durationMean = 86400000;\n+        int seed = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ee05d198e248b1c0138aa8e9d7726ec55ef66b5"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzNjg4MzEyOnYy", "diffSide": "RIGHT", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/events/MockEventsLoader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwMzowMDo0MFrOGT0V_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwMzowMDo0MFrOGT0V_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQzMzcyNA==", "bodyText": "nit: license", "url": "https://github.com/apache/pinot/pull/5354#discussion_r423433724", "createdAt": "2020-05-12T03:00:40Z", "author": {"login": "akshayrai"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/events/MockEventsLoader.java", "diffHunk": "@@ -0,0 +1,129 @@\n+package org.apache.pinot.thirdeye.anomaly.events;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ee05d198e248b1c0138aa8e9d7726ec55ef66b5"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzNjg4NTA5OnYy", "diffSide": "RIGHT", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/events/MockEventsLoader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwMzowMTo0N1rOGT0XGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwMzowMTo0N1rOGT0XGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQzNDAwOA==", "bodyText": "consider including a javadoc comment about this class", "url": "https://github.com/apache/pinot/pull/5354#discussion_r423434008", "createdAt": "2020-05-12T03:01:47Z", "author": {"login": "akshayrai"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/events/MockEventsLoader.java", "diffHunk": "@@ -0,0 +1,129 @@\n+package org.apache.pinot.thirdeye.anomaly.events;\n+\n+import org.apache.commons.math3.distribution.*;\n+import org.apache.commons.math3.random.Well19937c;\n+import org.apache.pinot.thirdeye.anomaly.MockEventsLoaderConfiguration;\n+import org.apache.pinot.thirdeye.datalayer.bao.EventManager;\n+import org.apache.pinot.thirdeye.datalayer.dto.EventDTO;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.*;\n+\n+\n+public class MockEventsLoader implements Runnable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ee05d198e248b1c0138aa8e9d7726ec55ef66b5"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzNjg5MjUzOnYy", "diffSide": "RIGHT", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/events/MockEventsLoader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwMzowNjoyMlrOGT0bvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwMzowNjoyMlrOGT0bvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQzNTE5OA==", "bodyText": "This is really cool! Can you include a comment about the technique in the code?", "url": "https://github.com/apache/pinot/pull/5354#discussion_r423435198", "createdAt": "2020-05-12T03:06:22Z", "author": {"login": "akshayrai"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/events/MockEventsLoader.java", "diffHunk": "@@ -0,0 +1,129 @@\n+package org.apache.pinot.thirdeye.anomaly.events;\n+\n+import org.apache.commons.math3.distribution.*;\n+import org.apache.commons.math3.random.Well19937c;\n+import org.apache.pinot.thirdeye.anomaly.MockEventsLoaderConfiguration;\n+import org.apache.pinot.thirdeye.datalayer.bao.EventManager;\n+import org.apache.pinot.thirdeye.datalayer.dto.EventDTO;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.*;\n+\n+\n+public class MockEventsLoader implements Runnable {\n+    private static final Logger LOG = LoggerFactory.getLogger(MockEventsLoader.class);\n+\n+    private static Comparator<EventDTO> MOCK_EVENT_COMPARATOR = Comparator\n+            .comparingLong(EventDTO::getStartTime)\n+            .thenComparingLong(EventDTO::getEndTime)\n+            .thenComparing(EventDTO::getEventType)\n+            .thenComparing(EventDTO::getName);\n+\n+    private static final long START_TIMESTAMP = 1546300800000L; // January 1, 2019 12:00:00 AM GMT\n+    private static final long END_OFFSET = 31536000000L; // 365d in ms\n+\n+    public static final String DIST_TYPE_GAUSSIAN = \"gaussian\";\n+    public static final String DIST_TYPE_EXPONENTIAL = \"exponential\";\n+    public static final String DIST_TYPE_LOGNORMAL = \"lognormal\";\n+    public static final String DIST_TYPE_FIXED = \"fixed\";\n+\n+    MockEventsLoaderConfiguration configuration;\n+    EventManager eventDAO;\n+\n+    public MockEventsLoader(MockEventsLoaderConfiguration configuration, EventManager eventDAO) {\n+        this.configuration = configuration;\n+        this.eventDAO = eventDAO;\n+    }\n+\n+    @Override\n+    public void run() {\n+        final long cutoff = System.currentTimeMillis() + END_OFFSET;\n+\n+        for (MockEventsLoaderConfiguration.EventGeneratorConfig conf : this.configuration.getGenerators()) {\n+            LOG.info(\"Generating '{}' events from {} to {}\", conf.getType(), START_TIMESTAMP, cutoff);\n+\n+            List<EventDTO> generated = generateEvents(conf, cutoff);\n+            List<EventDTO> existing = this.eventDAO.findEventsBetweenTimeRange(conf.getType(), START_TIMESTAMP, cutoff);\n+\n+            Set<EventDTO> deduplicated = dedup(generated, existing);\n+            LOG.info(\"Generated '{}' events: {} generated, {} pre-existing, {} saved after deduplication\",\n+                    conf.getType(), generated.size(), existing.size(), deduplicated.size());\n+\n+            deduplicated.forEach(this.eventDAO::save);\n+        }\n+    }\n+\n+    List<EventDTO> generateEvents(MockEventsLoaderConfiguration.EventGeneratorConfig conf, long cutoff) {\n+        List<EventDTO> generated = new ArrayList<>();\n+\n+        AbstractRealDistribution arrivalDist = makeDist(conf.getArrivalType(), conf.getArrivalMean(), conf.getSeed());\n+        AbstractRealDistribution durationDist = makeDist(conf.getDurationType(), conf.getDurationMean(), conf.getSeed());\n+\n+        EventGenerator generator = new EventGenerator(conf.getType(), arrivalDist, durationDist);\n+\n+        EventDTO event;\n+        while ((event = generator.next()).getStartTime() < cutoff) {\n+            generated.add(event);\n+        }\n+\n+        return generated;\n+    }\n+\n+    Set<EventDTO> dedup(Collection<EventDTO> generated, Collection<EventDTO> existing) {\n+        Set<EventDTO> sorted = new TreeSet<>(MOCK_EVENT_COMPARATOR);\n+        sorted.addAll(generated);\n+        existing.forEach(sorted::remove);\n+        return sorted;\n+    }\n+\n+    AbstractRealDistribution makeDist(String type, double param, int seed) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ee05d198e248b1c0138aa8e9d7726ec55ef66b5"}, "originalPosition": 80}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3253, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}