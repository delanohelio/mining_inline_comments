{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc5Mjg1MTY3", "number": 5092, "title": "Minor improvement for RoutingManager", "bodyText": "For external view change, log the changed tables\nFor instance config change, skip the routing update when no instance is changed", "createdAt": "2020-02-24T23:33:39Z", "url": "https://github.com/apache/pinot/pull/5092", "merged": true, "mergeCommit": {"oid": "ef6509e442a48ef7f149c47b11a2f975ec48ed06"}, "closed": true, "closedAt": "2020-02-25T00:17:02Z", "author": {"login": "Jackie-Jiang"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcHmg23AFqTM2Mzc4NDgxNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHmqGqABqjMwNjc0NjI0MzM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNzg0ODE0", "url": "https://github.com/apache/pinot/pull/5092#pullrequestreview-363784814", "createdAt": "2020-02-24T23:55:49Z", "commit": {"oid": "01f755eecfcfe82db01e6d8d41972ac475660bc4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMzo1NTo1MFrOFt0HuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMzo1NTo1MFrOFt0HuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU4NDE4NA==", "bodyText": "It is not intuitive from this message as to how many tables the routing table was updated for? Is tablesToUpdate.size() this number?\nMay be we should make \"update N routing entries\" to \"update N routing table entries for M tables\".", "url": "https://github.com/apache/pinot/pull/5092#discussion_r383584184", "createdAt": "2020-02-24T23:55:50Z", "author": {"login": "siddharthteotia"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/v2/RoutingManager.java", "diffHunk": "@@ -131,44 +131,42 @@ private void processExternalViewChange() {\n     Stat[] stats = _zkDataAccessor.getStats(externalViewPaths, AccessOption.PERSISTENT);\n     long fetchStatsEndTimeMs = System.currentTimeMillis();\n \n-    int numRoutingEntriesToUpdate = 0;\n+    List<String> tablesToUpdate = new ArrayList<>();\n     for (int i = 0; i < numTables; i++) {\n       Stat stat = stats[i];\n       if (stat != null) {\n         RoutingEntry routingEntry = routingEntries.get(i);\n         if (stat.getVersion() != routingEntry.getLastUpdateExternalViewVersion()) {\n-          numRoutingEntriesToUpdate++;\n+          String tableNameWithType = routingEntry.getTableNameWithType();\n+          tablesToUpdate.add(tableNameWithType);\n           try {\n-            updateRoutingEntryOnExternalViewChange(routingEntry);\n+            ExternalView externalView = getExternalView(tableNameWithType);\n+            if (externalView == null) {\n+              LOGGER.warn(\"Failed to find external view for table: {}, skipping updating routing entry\",\n+                  tableNameWithType);\n+              continue;\n+            }\n+            Set<String> onlineSegments = getOnlineSegments(tableNameWithType);\n+            if (onlineSegments == null) {\n+              LOGGER\n+                  .warn(\"Failed to find ideal state for table: {}, skipping updating routing entry\", tableNameWithType);\n+              continue;\n+            }\n+            routingEntry.onExternalViewChange(externalView, onlineSegments);\n           } catch (Exception e) {\n             LOGGER\n                 .error(\"Caught unexpected exception while updating routing entry on external view change for table: {}\",\n-                    routingEntry.getTableNameWithType(), e);\n+                    tableNameWithType, e);\n           }\n         }\n       }\n     }\n     long updateRoutingEntriesEndTimeMs = System.currentTimeMillis();\n \n     LOGGER.info(\n-        \"Processed external view change in {}ms (fetch {} external view stats: {}ms, update {} routing entries: {}ms)\",\n+        \"Processed external view change in {}ms (fetch {} external view stats: {}ms, update {} routing entries ({}): {}ms)\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01f755eecfcfe82db01e6d8d41972ac475660bc4"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNzg1MDgx", "url": "https://github.com/apache/pinot/pull/5092#pullrequestreview-363785081", "createdAt": "2020-02-24T23:56:26Z", "commit": {"oid": "01f755eecfcfe82db01e6d8d41972ac475660bc4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c79e6d1e12f195dfa83961ba566ece8bfb9d19cf", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/c79e6d1e12f195dfa83961ba566ece8bfb9d19cf", "committedDate": "2020-02-25T00:05:41Z", "message": "Minor improvement for RoutingManager\n\n- For external view change, log the changed tables\n- For instance config change, skip the routing update when no instance is changed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "01f755eecfcfe82db01e6d8d41972ac475660bc4", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/01f755eecfcfe82db01e6d8d41972ac475660bc4", "committedDate": "2020-02-24T23:31:27Z", "message": "Minor improvement for RoutingManager\n\n- For external view change, log the changed tables\n- For instance config change, skip the routing update when no instance is changed"}, "afterCommit": {"oid": "c79e6d1e12f195dfa83961ba566ece8bfb9d19cf", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/c79e6d1e12f195dfa83961ba566ece8bfb9d19cf", "committedDate": "2020-02-25T00:05:41Z", "message": "Minor improvement for RoutingManager\n\n- For external view change, log the changed tables\n- For instance config change, skip the routing update when no instance is changed"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1324, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}