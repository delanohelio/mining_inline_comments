{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyMzc5NTAx", "number": 5795, "title": "Support aggregation function name with underscore inside", "bodyText": "Description\nSupport aggregation function name with underscore inside", "createdAt": "2020-08-03T20:24:24Z", "url": "https://github.com/apache/pinot/pull/5795", "merged": true, "mergeCommit": {"oid": "48d1653c012b42f19999b50dc1b5d3039a09eeaa"}, "closed": true, "closedAt": "2020-08-07T06:43:04Z", "author": {"login": "xiangfu0"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7YbpaABqjM2MTc1NjA0MTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8Tv-QAFqTQ2Mjc1NTUxMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "49e18e4338819147993697266a8687174506dcc8", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/49e18e4338819147993697266a8687174506dcc8", "committedDate": "2020-08-03T20:23:56Z", "message": "Support aggregation function name with underscore inside"}, "afterCommit": {"oid": "c04e537e44af257739aff439f0ea009261b47dd4", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/c04e537e44af257739aff439f0ea009261b47dd4", "committedDate": "2020-08-03T20:55:20Z", "message": "Support aggregation function name with underscore inside"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMzc3MDI0", "url": "https://github.com/apache/pinot/pull/5795#pullrequestreview-460377024", "createdAt": "2020-08-03T22:20:07Z", "commit": {"oid": "c04e537e44af257739aff439f0ea009261b47dd4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMjoyMDowN1rOG7Kjgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMjoyMDowN1rOG7Kjgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY5MjA5OA==", "bodyText": "This will break ST_Union. Can we first look up with original function name, and if not found, replace _ then?", "url": "https://github.com/apache/pinot/pull/5795#discussion_r464692098", "createdAt": "2020-08-03T22:20:07Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/function/AggregationFunctionType.java", "diffHunk": "@@ -79,7 +79,7 @@ public boolean isOfType(AggregationFunctionType... aggregationFunctionTypes) {\n    * Returns the corresponding aggregation function type for the given function name.\n    */\n   public static AggregationFunctionType getAggregationFunctionType(String functionName) {\n-    String upperCaseFunctionName = functionName.toUpperCase();\n+    String upperCaseFunctionName = functionName.toUpperCase().replace(\"_\", \"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c04e537e44af257739aff439f0ea009261b47dd4"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c04e537e44af257739aff439f0ea009261b47dd4", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/c04e537e44af257739aff439f0ea009261b47dd4", "committedDate": "2020-08-03T20:55:20Z", "message": "Support aggregation function name with underscore inside"}, "afterCommit": {"oid": "51a27b7f666df05c1a84f94bab0aeec6c51b2b6f", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/51a27b7f666df05c1a84f94bab0aeec6c51b2b6f", "committedDate": "2020-08-03T22:53:44Z", "message": "Support aggregation function name with underscore inside"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6c5ca9d9c2f3d574e294a304997d55a0cf16d3ec", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/6c5ca9d9c2f3d574e294a304997d55a0cf16d3ec", "committedDate": "2020-08-04T01:06:17Z", "message": "update codecov version to v1.0.5"}, "afterCommit": {"oid": "c1f5ec772e71675f92b2b477cc93185b8242498a", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/c1f5ec772e71675f92b2b477cc93185b8242498a", "committedDate": "2020-08-04T06:09:12Z", "message": "update codecov version to v1.0.12"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c1f5ec772e71675f92b2b477cc93185b8242498a", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/c1f5ec772e71675f92b2b477cc93185b8242498a", "committedDate": "2020-08-04T06:09:12Z", "message": "update codecov version to v1.0.12"}, "afterCommit": {"oid": "085a95c26ad5c684b66f1c3706518011105a7cb9", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/085a95c26ad5c684b66f1c3706518011105a7cb9", "committedDate": "2020-08-04T08:20:51Z", "message": "update codecov version to v1.0.12"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "085a95c26ad5c684b66f1c3706518011105a7cb9", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/085a95c26ad5c684b66f1c3706518011105a7cb9", "committedDate": "2020-08-04T08:20:51Z", "message": "update codecov version to v1.0.12"}, "afterCommit": {"oid": "a8b1912cf23a6b2351b6874dab1577d5ac5609ee", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/a8b1912cf23a6b2351b6874dab1577d5ac5609ee", "committedDate": "2020-08-04T08:22:04Z", "message": "update codecov version to v1.0.12"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMjQyMDc2", "url": "https://github.com/apache/pinot/pull/5795#pullrequestreview-461242076", "createdAt": "2020-08-04T23:26:44Z", "commit": {"oid": "a8b1912cf23a6b2351b6874dab1577d5ac5609ee"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMzoyNjo0NFrOG702LA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMzoyNzo0N1rOG703cQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM4NTAwNA==", "bodyText": "This won't cover functions such as percentile_tdigest.\nWe can make the current one a private helper method, and add a new getAggregationFunctionType to look up for both functionName with/without underscore", "url": "https://github.com/apache/pinot/pull/5795#discussion_r465385004", "createdAt": "2020-08-04T23:26:44Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/function/AggregationFunctionType.java", "diffHunk": "@@ -101,6 +101,13 @@ public static AggregationFunctionType getAggregationFunctionType(String function\n       try {\n         return AggregationFunctionType.valueOf(upperCaseFunctionName);\n       } catch (Exception e) {\n+        if (upperCaseFunctionName.contains(\"_\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8b1912cf23a6b2351b6874dab1577d5ac5609ee"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM4NTMyOQ==", "bodyText": "Same here", "url": "https://github.com/apache/pinot/pull/5795#discussion_r465385329", "createdAt": "2020-08-04T23:27:47Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/AggregationFunctionFactory.java", "diffHunk": "@@ -106,7 +106,7 @@ public static AggregationFunction getAggregationFunction(FunctionContext functio\n         }\n         throw new IllegalArgumentException(\"Invalid percentile function: \" + function);\n       } else {\n-        switch (AggregationFunctionType.valueOf(upperCaseFunctionName)) {\n+        switch (AggregationFunctionType.getAggregationFunctionType(upperCaseFunctionName)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8b1912cf23a6b2351b6874dab1577d5ac5609ee"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMjQzMjk5", "url": "https://github.com/apache/pinot/pull/5795#pullrequestreview-461243299", "createdAt": "2020-08-04T23:30:20Z", "commit": {"oid": "a8b1912cf23a6b2351b6874dab1577d5ac5609ee"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMzozMDoyMFrOG706nw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMzozMDoyMFrOG706nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM4NjE0Mw==", "bodyText": "Check if it contains underscore before the second lookup for performance", "url": "https://github.com/apache/pinot/pull/5795#discussion_r465386143", "createdAt": "2020-08-04T23:30:20Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/function/AggregationFunctionType.java", "diffHunk": "@@ -101,6 +101,13 @@ public static AggregationFunctionType getAggregationFunctionType(String function\n       try {\n         return AggregationFunctionType.valueOf(upperCaseFunctionName);\n       } catch (Exception e) {\n+        if (upperCaseFunctionName.contains(\"_\")) {\n+          try {\n+            return AggregationFunctionType.valueOf(upperCaseFunctionName.replace(\"_\", \"\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8b1912cf23a6b2351b6874dab1577d5ac5609ee"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89120991952a9e86086ef465a9a567b81879f7ad", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/89120991952a9e86086ef465a9a567b81879f7ad", "committedDate": "2020-08-05T00:42:09Z", "message": "Support aggregation function name with underscore inside"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a8b1912cf23a6b2351b6874dab1577d5ac5609ee", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/a8b1912cf23a6b2351b6874dab1577d5ac5609ee", "committedDate": "2020-08-04T08:22:04Z", "message": "update codecov version to v1.0.12"}, "afterCommit": {"oid": "89120991952a9e86086ef465a9a567b81879f7ad", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/89120991952a9e86086ef465a9a567b81879f7ad", "committedDate": "2020-08-05T00:42:09Z", "message": "Support aggregation function name with underscore inside"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMDkzNDE5", "url": "https://github.com/apache/pinot/pull/5795#pullrequestreview-462093419", "createdAt": "2020-08-05T23:38:03Z", "commit": {"oid": "89120991952a9e86086ef465a9a567b81879f7ad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQyMzozODowNFrOG8eLbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQyMzozODowNFrOG8eLbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA2MjE4OQ==", "bodyText": "Why do we have to do upperCase again?\nAggregationFunctionType is an enum so getName() should return upper case right?", "url": "https://github.com/apache/pinot/pull/5795#discussion_r466062189", "createdAt": "2020-08-05T23:38:04Z", "author": {"login": "siddharthteotia"}, "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/AggregationFunctionFactory.java", "diffHunk": "@@ -45,10 +45,12 @@ private AggregationFunctionFactory() {\n   public static AggregationFunction getAggregationFunction(FunctionContext function, QueryContext queryContext) {\n     try {\n       String upperCaseFunctionName = function.getFunctionName().toUpperCase();\n+      AggregationFunctionType aggregationFunctionType =\n+          AggregationFunctionType.getAggregationFunctionType(upperCaseFunctionName);\n       List<ExpressionContext> arguments = function.getArguments();\n       ExpressionContext firstArgument = arguments.get(0);\n-      if (upperCaseFunctionName.startsWith(\"PERCENTILE\")) {\n-        String remainingFunctionName = upperCaseFunctionName.substring(10);\n+      if (aggregationFunctionType.getName().toUpperCase().startsWith(\"PERCENTILE\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89120991952a9e86086ef465a9a567b81879f7ad"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e4fdc02bc28f82c7bfd3697895bb1efec043f5b", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/apache/pinot/commit/3e4fdc02bc28f82c7bfd3697895bb1efec043f5b", "committedDate": "2020-08-06T07:30:47Z", "message": "Change ST_Union AggregationType enum to STUnion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe1f80a3ab7191238228308671fb968835c5baea", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/fe1f80a3ab7191238228308671fb968835c5baea", "committedDate": "2020-08-06T18:01:16Z", "message": "Simplify the handling"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a7079f32353c538237e53053fc077e20fe8c535d", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/a7079f32353c538237e53053fc077e20fe8c535d", "committedDate": "2020-08-06T17:58:34Z", "message": "Simplify the handling"}, "afterCommit": {"oid": "fe1f80a3ab7191238228308671fb968835c5baea", "author": {"user": {"login": "Jackie-Jiang", "name": "Xiaotian (Jackie) Jiang"}}, "url": "https://github.com/apache/pinot/commit/fe1f80a3ab7191238228308671fb968835c5baea", "committedDate": "2020-08-06T18:01:16Z", "message": "Simplify the handling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNzU1NTEw", "url": "https://github.com/apache/pinot/pull/5795#pullrequestreview-462755510", "createdAt": "2020-08-06T18:02:08Z", "commit": {"oid": "fe1f80a3ab7191238228308671fb968835c5baea"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 546, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}