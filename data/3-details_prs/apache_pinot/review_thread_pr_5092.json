{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc5Mjg1MTY3", "number": 5092, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMzo1NTo1MFrODihRaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMzo1NTo1MFrODihRaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3NTIzMzA1OnYy", "diffSide": "RIGHT", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/v2/RoutingManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMzo1NTo1MFrOFt0HuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwMDowNToyMFrOFt0TQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU4NDE4NA==", "bodyText": "It is not intuitive from this message as to how many tables the routing table was updated for? Is tablesToUpdate.size() this number?\nMay be we should make \"update N routing entries\" to \"update N routing table entries for M tables\".", "url": "https://github.com/apache/pinot/pull/5092#discussion_r383584184", "createdAt": "2020-02-24T23:55:50Z", "author": {"login": "siddharthteotia"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/v2/RoutingManager.java", "diffHunk": "@@ -131,44 +131,42 @@ private void processExternalViewChange() {\n     Stat[] stats = _zkDataAccessor.getStats(externalViewPaths, AccessOption.PERSISTENT);\n     long fetchStatsEndTimeMs = System.currentTimeMillis();\n \n-    int numRoutingEntriesToUpdate = 0;\n+    List<String> tablesToUpdate = new ArrayList<>();\n     for (int i = 0; i < numTables; i++) {\n       Stat stat = stats[i];\n       if (stat != null) {\n         RoutingEntry routingEntry = routingEntries.get(i);\n         if (stat.getVersion() != routingEntry.getLastUpdateExternalViewVersion()) {\n-          numRoutingEntriesToUpdate++;\n+          String tableNameWithType = routingEntry.getTableNameWithType();\n+          tablesToUpdate.add(tableNameWithType);\n           try {\n-            updateRoutingEntryOnExternalViewChange(routingEntry);\n+            ExternalView externalView = getExternalView(tableNameWithType);\n+            if (externalView == null) {\n+              LOGGER.warn(\"Failed to find external view for table: {}, skipping updating routing entry\",\n+                  tableNameWithType);\n+              continue;\n+            }\n+            Set<String> onlineSegments = getOnlineSegments(tableNameWithType);\n+            if (onlineSegments == null) {\n+              LOGGER\n+                  .warn(\"Failed to find ideal state for table: {}, skipping updating routing entry\", tableNameWithType);\n+              continue;\n+            }\n+            routingEntry.onExternalViewChange(externalView, onlineSegments);\n           } catch (Exception e) {\n             LOGGER\n                 .error(\"Caught unexpected exception while updating routing entry on external view change for table: {}\",\n-                    routingEntry.getTableNameWithType(), e);\n+                    tableNameWithType, e);\n           }\n         }\n       }\n     }\n     long updateRoutingEntriesEndTimeMs = System.currentTimeMillis();\n \n     LOGGER.info(\n-        \"Processed external view change in {}ms (fetch {} external view stats: {}ms, update {} routing entries: {}ms)\",\n+        \"Processed external view change in {}ms (fetch {} external view stats: {}ms, update {} routing entries ({}): {}ms)\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01f755eecfcfe82db01e6d8d41972ac475660bc4"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU4NzEzNw==", "bodyText": "Changed it to ..., update routing entry for 2 tables ([foo_OFFLINE, bar_REALTIME]): 5ms", "url": "https://github.com/apache/pinot/pull/5092#discussion_r383587137", "createdAt": "2020-02-25T00:05:20Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/v2/RoutingManager.java", "diffHunk": "@@ -131,44 +131,42 @@ private void processExternalViewChange() {\n     Stat[] stats = _zkDataAccessor.getStats(externalViewPaths, AccessOption.PERSISTENT);\n     long fetchStatsEndTimeMs = System.currentTimeMillis();\n \n-    int numRoutingEntriesToUpdate = 0;\n+    List<String> tablesToUpdate = new ArrayList<>();\n     for (int i = 0; i < numTables; i++) {\n       Stat stat = stats[i];\n       if (stat != null) {\n         RoutingEntry routingEntry = routingEntries.get(i);\n         if (stat.getVersion() != routingEntry.getLastUpdateExternalViewVersion()) {\n-          numRoutingEntriesToUpdate++;\n+          String tableNameWithType = routingEntry.getTableNameWithType();\n+          tablesToUpdate.add(tableNameWithType);\n           try {\n-            updateRoutingEntryOnExternalViewChange(routingEntry);\n+            ExternalView externalView = getExternalView(tableNameWithType);\n+            if (externalView == null) {\n+              LOGGER.warn(\"Failed to find external view for table: {}, skipping updating routing entry\",\n+                  tableNameWithType);\n+              continue;\n+            }\n+            Set<String> onlineSegments = getOnlineSegments(tableNameWithType);\n+            if (onlineSegments == null) {\n+              LOGGER\n+                  .warn(\"Failed to find ideal state for table: {}, skipping updating routing entry\", tableNameWithType);\n+              continue;\n+            }\n+            routingEntry.onExternalViewChange(externalView, onlineSegments);\n           } catch (Exception e) {\n             LOGGER\n                 .error(\"Caught unexpected exception while updating routing entry on external view change for table: {}\",\n-                    routingEntry.getTableNameWithType(), e);\n+                    tableNameWithType, e);\n           }\n         }\n       }\n     }\n     long updateRoutingEntriesEndTimeMs = System.currentTimeMillis();\n \n     LOGGER.info(\n-        \"Processed external view change in {}ms (fetch {} external view stats: {}ms, update {} routing entries: {}ms)\",\n+        \"Processed external view change in {}ms (fetch {} external view stats: {}ms, update {} routing entries ({}): {}ms)\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU4NDE4NA=="}, "originalCommit": {"oid": "01f755eecfcfe82db01e6d8d41972ac475660bc4"}, "originalPosition": 42}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3476, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}