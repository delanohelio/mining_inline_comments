{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3ODQ0NjIz", "number": 5208, "title": "[TE] Disable alerts if it has no success run within 30 days", "bodyText": "Check alert's lastTaskRunTime. If there is no success run within 30 days then disable it.", "createdAt": "2020-04-02T22:43:55Z", "url": "https://github.com/apache/pinot/pull/5208", "merged": true, "mergeCommit": {"oid": "7a621660eacf3ac9f52d94304e6c2531db976e5d"}, "closed": true, "closedAt": "2020-04-19T16:28:29Z", "author": {"login": "xiaohui-sun"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcT0PsfgH2gAyMzk3ODQ0NjIzOjgxNTgzZDYxNTJjMDNiZTc1MTljOWE4ZmYzZjNkMTQ1MmUzOGJiMmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYq_GcAFqTM5NTgzODI2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "81583d6152c03be7519c9a8ff3f3d1452e38bb2d", "author": {"user": null}, "url": "https://github.com/apache/pinot/commit/81583d6152c03be7519c9a8ff3f3d1452e38bb2d", "committedDate": "2020-04-02T22:42:51Z", "message": "[TE] Disable alerts if it has no success run within 30 days"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a13624711cf61b7713ac0839584d6ca2dc0b278", "author": {"user": null}, "url": "https://github.com/apache/pinot/commit/3a13624711cf61b7713ac0839584d6ca2dc0b278", "committedDate": "2020-04-03T03:03:12Z", "message": "[TE] Check if the update time is null"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MzM4NTM1", "url": "https://github.com/apache/pinot/pull/5208#pullrequestreview-387338535", "createdAt": "2020-04-03T15:03:20Z", "commit": {"oid": "3a13624711cf61b7713ac0839584d6ca2dc0b278"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NTc2MzE1", "url": "https://github.com/apache/pinot/pull/5208#pullrequestreview-387576315", "createdAt": "2020-04-03T20:58:34Z", "commit": {"oid": "3a13624711cf61b7713ac0839584d6ca2dc0b278"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "010a571405362815894629caeebf5cd4f344d50a", "author": {"user": null}, "url": "https://github.com/apache/pinot/commit/010a571405362815894629caeebf5cd4f344d50a", "committedDate": "2020-04-04T16:55:24Z", "message": "[TE] Send notification mail when disabling alerts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMzE4NTk1", "url": "https://github.com/apache/pinot/pull/5208#pullrequestreview-390318595", "createdAt": "2020-04-08T20:45:51Z", "commit": {"oid": "010a571405362815894629caeebf5cd4f344d50a"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMDo0NTo1MVrOGDATgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMToxMzoyOVrOGDBMYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgwMzkwNQ==", "bodyText": "log the exception.", "url": "https://github.com/apache/pinot/pull/5208#discussion_r405803905", "createdAt": "2020-04-08T20:45:51Z", "author": {"login": "akshayrai"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/monitor/MonitorTaskRunner.java", "diffHunk": "@@ -120,11 +134,62 @@ private void executeMonitorUpdate(MonitorTaskInfo monitorTaskInfo) {\n \n       // update detection health\n       updateDetectionHealth();\n+\n+      // disable alerts that failed consecutively for a long time\n+      disableLongFailedAlerts();\n+\n     } catch (Exception e) {\n       LOG.error(\"Exception in monitor update task\", e);\n     }\n   }\n \n+  /**\n+   * Disable the alert if it was updated before {@MAX_TASK_FAIL_DAYS} but there is no success run since then.\n+   */\n+  private void disableLongFailedAlerts() {\n+    DetectionConfigManager detectionDAO = DAO_REGISTRY.getDetectionConfigManager();\n+    List<DetectionConfigDTO> detectionConfigs = detectionDAO.findAllActive();\n+    long currentTimeMills = System.currentTimeMillis();\n+    long maxTaskFailMills = TimeUnit.DAYS.toMillis(MAX_FAILED_DISABLE_DAYS);\n+    for (DetectionConfigDTO config : detectionConfigs) {\n+      try {\n+        Timestamp updateTime = config.getUpdateTime();\n+        if (updateTime != null && config.getHealth() != null && config.getHealth().getDetectionTaskStatus() != null) {\n+          long lastTaskExecutionTime = config.getHealth().getDetectionTaskStatus().getLastTaskExecutionTime();\n+          if (updateTime.getTime() <= currentTimeMills - maxTaskFailMills && (lastTaskExecutionTime == -1L\n+              || lastTaskExecutionTime <= currentTimeMills - maxTaskFailMills)) {\n+            config.setActive(false);\n+            detectionDAO.update(config);\n+            sendDisableAlertNotificationEmail(config);\n+            LOG.info(\"Disabled alert \" + config.getId() + \" since it failed more than \" + MAX_FAILED_DISABLE_DAYS + \" days\");\n+            LOG.info(\"Task last update time: \" + config.getUpdateTime());\n+            LOG.info(\"Last success task execution time: \" + lastTaskExecutionTime);\n+          }\n+        }\n+      } catch (Exception e) {\n+        LOG.error(\"Exception in disabling alert \", config.getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "010a571405362815894629caeebf5cd4f344d50a"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxMTgxMQ==", "bodyText": "Can we include some unit tests for this?", "url": "https://github.com/apache/pinot/pull/5208#discussion_r405811811", "createdAt": "2020-04-08T21:00:04Z", "author": {"login": "akshayrai"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/monitor/MonitorTaskRunner.java", "diffHunk": "@@ -120,11 +134,62 @@ private void executeMonitorUpdate(MonitorTaskInfo monitorTaskInfo) {\n \n       // update detection health\n       updateDetectionHealth();\n+\n+      // disable alerts that failed consecutively for a long time\n+      disableLongFailedAlerts();\n+\n     } catch (Exception e) {\n       LOG.error(\"Exception in monitor update task\", e);\n     }\n   }\n \n+  /**\n+   * Disable the alert if it was updated before {@MAX_TASK_FAIL_DAYS} but there is no success run since then.\n+   */\n+  private void disableLongFailedAlerts() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "010a571405362815894629caeebf5cd4f344d50a"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxNDA2NA==", "bodyText": "nit: typo currentTimeMillis & maxTaskFailMillis", "url": "https://github.com/apache/pinot/pull/5208#discussion_r405814064", "createdAt": "2020-04-08T21:04:39Z", "author": {"login": "akshayrai"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/monitor/MonitorTaskRunner.java", "diffHunk": "@@ -120,11 +134,62 @@ private void executeMonitorUpdate(MonitorTaskInfo monitorTaskInfo) {\n \n       // update detection health\n       updateDetectionHealth();\n+\n+      // disable alerts that failed consecutively for a long time\n+      disableLongFailedAlerts();\n+\n     } catch (Exception e) {\n       LOG.error(\"Exception in monitor update task\", e);\n     }\n   }\n \n+  /**\n+   * Disable the alert if it was updated before {@MAX_TASK_FAIL_DAYS} but there is no success run since then.\n+   */\n+  private void disableLongFailedAlerts() {\n+    DetectionConfigManager detectionDAO = DAO_REGISTRY.getDetectionConfigManager();\n+    List<DetectionConfigDTO> detectionConfigs = detectionDAO.findAllActive();\n+    long currentTimeMills = System.currentTimeMillis();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "010a571405362815894629caeebf5cd4f344d50a"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxNTIxOQ==", "bodyText": "Can we skip the lastTaskExecutionTime == -1L check?\nIsn't that already covered by lastTaskExecutionTime <= currentTimeMills - maxTaskFailMills?", "url": "https://github.com/apache/pinot/pull/5208#discussion_r405815219", "createdAt": "2020-04-08T21:07:00Z", "author": {"login": "akshayrai"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/monitor/MonitorTaskRunner.java", "diffHunk": "@@ -120,11 +134,62 @@ private void executeMonitorUpdate(MonitorTaskInfo monitorTaskInfo) {\n \n       // update detection health\n       updateDetectionHealth();\n+\n+      // disable alerts that failed consecutively for a long time\n+      disableLongFailedAlerts();\n+\n     } catch (Exception e) {\n       LOG.error(\"Exception in monitor update task\", e);\n     }\n   }\n \n+  /**\n+   * Disable the alert if it was updated before {@MAX_TASK_FAIL_DAYS} but there is no success run since then.\n+   */\n+  private void disableLongFailedAlerts() {\n+    DetectionConfigManager detectionDAO = DAO_REGISTRY.getDetectionConfigManager();\n+    List<DetectionConfigDTO> detectionConfigs = detectionDAO.findAllActive();\n+    long currentTimeMills = System.currentTimeMillis();\n+    long maxTaskFailMills = TimeUnit.DAYS.toMillis(MAX_FAILED_DISABLE_DAYS);\n+    for (DetectionConfigDTO config : detectionConfigs) {\n+      try {\n+        Timestamp updateTime = config.getUpdateTime();\n+        if (updateTime != null && config.getHealth() != null && config.getHealth().getDetectionTaskStatus() != null) {\n+          long lastTaskExecutionTime = config.getHealth().getDetectionTaskStatus().getLastTaskExecutionTime();\n+          if (updateTime.getTime() <= currentTimeMills - maxTaskFailMills && (lastTaskExecutionTime == -1L", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "010a571405362815894629caeebf5cd4f344d50a"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxNjE2OQ==", "bodyText": "Clubbing them into one log statement might be easier to debug.", "url": "https://github.com/apache/pinot/pull/5208#discussion_r405816169", "createdAt": "2020-04-08T21:08:51Z", "author": {"login": "akshayrai"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/monitor/MonitorTaskRunner.java", "diffHunk": "@@ -120,11 +134,62 @@ private void executeMonitorUpdate(MonitorTaskInfo monitorTaskInfo) {\n \n       // update detection health\n       updateDetectionHealth();\n+\n+      // disable alerts that failed consecutively for a long time\n+      disableLongFailedAlerts();\n+\n     } catch (Exception e) {\n       LOG.error(\"Exception in monitor update task\", e);\n     }\n   }\n \n+  /**\n+   * Disable the alert if it was updated before {@MAX_TASK_FAIL_DAYS} but there is no success run since then.\n+   */\n+  private void disableLongFailedAlerts() {\n+    DetectionConfigManager detectionDAO = DAO_REGISTRY.getDetectionConfigManager();\n+    List<DetectionConfigDTO> detectionConfigs = detectionDAO.findAllActive();\n+    long currentTimeMills = System.currentTimeMillis();\n+    long maxTaskFailMills = TimeUnit.DAYS.toMillis(MAX_FAILED_DISABLE_DAYS);\n+    for (DetectionConfigDTO config : detectionConfigs) {\n+      try {\n+        Timestamp updateTime = config.getUpdateTime();\n+        if (updateTime != null && config.getHealth() != null && config.getHealth().getDetectionTaskStatus() != null) {\n+          long lastTaskExecutionTime = config.getHealth().getDetectionTaskStatus().getLastTaskExecutionTime();\n+          if (updateTime.getTime() <= currentTimeMills - maxTaskFailMills && (lastTaskExecutionTime == -1L\n+              || lastTaskExecutionTime <= currentTimeMills - maxTaskFailMills)) {\n+            config.setActive(false);\n+            detectionDAO.update(config);\n+            sendDisableAlertNotificationEmail(config);\n+            LOG.info(\"Disabled alert \" + config.getId() + \" since it failed more than \" + MAX_FAILED_DISABLE_DAYS + \" days\");\n+            LOG.info(\"Task last update time: \" + config.getUpdateTime());\n+            LOG.info(\"Last success task execution time: \" + lastTaskExecutionTime);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "010a571405362815894629caeebf5cd4f344d50a"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxODQ2NA==", "bodyText": "What if the alert was updated(after receiving the below notification) and it still continues to fail? We don't want to disable & notify them again?", "url": "https://github.com/apache/pinot/pull/5208#discussion_r405818464", "createdAt": "2020-04-08T21:13:29Z", "author": {"login": "akshayrai"}, "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/monitor/MonitorTaskRunner.java", "diffHunk": "@@ -120,11 +134,62 @@ private void executeMonitorUpdate(MonitorTaskInfo monitorTaskInfo) {\n \n       // update detection health\n       updateDetectionHealth();\n+\n+      // disable alerts that failed consecutively for a long time\n+      disableLongFailedAlerts();\n+\n     } catch (Exception e) {\n       LOG.error(\"Exception in monitor update task\", e);\n     }\n   }\n \n+  /**\n+   * Disable the alert if it was updated before {@MAX_TASK_FAIL_DAYS} but there is no success run since then.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "010a571405362815894629caeebf5cd4f344d50a"}, "originalPosition": 65}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da29f688886f2af28abd75948e97fbdf8392752a", "author": {"user": null}, "url": "https://github.com/apache/pinot/commit/da29f688886f2af28abd75948e97fbdf8392752a", "committedDate": "2020-04-12T05:04:38Z", "message": "[TE] Updated typo and logs for disabling alerts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1ODM4MjY5", "url": "https://github.com/apache/pinot/pull/5208#pullrequestreview-395838269", "createdAt": "2020-04-18T00:45:12Z", "commit": {"oid": "da29f688886f2af28abd75948e97fbdf8392752a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1157, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}