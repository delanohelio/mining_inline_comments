{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5Mzc2OTMy", "number": 5707, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxODoxMTozMlrOEOzPbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwMTo0ODo0N1rOEO7nQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzOTU1MDUyOnYy", "diffSide": "RIGHT", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxODoxMTozMlrOGyKBUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxOTozMDoyN1rOGyMy2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI0NjE2MQ==", "bodyText": "Should this be done in PinotQuery2BrokerRequestConverter?", "url": "https://github.com/apache/pinot/pull/5707#discussion_r455246161", "createdAt": "2020-07-15T18:11:32Z", "author": {"login": "mayankshriv"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -438,6 +439,46 @@ public BrokerResponse handleRequest(JsonNode request, @Nullable RequesterIdentit\n     return brokerResponse;\n   }\n \n+  /**\n+   * Check if table is in the format of [database_name].[table_name].\n+   *\n+   * Only update TableName in QuerySource if there is no existing table in the format of [database_name].[table_name],\n+   * but only [table_name].\n+   *\n+   * @param brokerRequest\n+   */\n+  private void updateQuerySource(BrokerRequest brokerRequest) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2f709aadd038785cd04f9d5e7d49353fcdbda82"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI1ODA5Nw==", "bodyText": "I wish I could do that!\nHere we don't have any information of existing table names as we are allowing dot in table name.", "url": "https://github.com/apache/pinot/pull/5707#discussion_r455258097", "createdAt": "2020-07-15T18:30:45Z", "author": {"login": "xiangfu0"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -438,6 +439,46 @@ public BrokerResponse handleRequest(JsonNode request, @Nullable RequesterIdentit\n     return brokerResponse;\n   }\n \n+  /**\n+   * Check if table is in the format of [database_name].[table_name].\n+   *\n+   * Only update TableName in QuerySource if there is no existing table in the format of [database_name].[table_name],\n+   * but only [table_name].\n+   *\n+   * @param brokerRequest\n+   */\n+  private void updateQuerySource(BrokerRequest brokerRequest) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI0NjE2MQ=="}, "originalCommit": {"oid": "d2f709aadd038785cd04f9d5e7d49353fcdbda82"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI5MTYwOA==", "bodyText": "Also I feel that we should introduce the concept that no dot is allowed in table name/column name.\nI'm not sure if anyone is using dot in table name, but it's definitely some users are using dot in column name.", "url": "https://github.com/apache/pinot/pull/5707#discussion_r455291608", "createdAt": "2020-07-15T19:30:27Z", "author": {"login": "xiangfu0"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -438,6 +439,46 @@ public BrokerResponse handleRequest(JsonNode request, @Nullable RequesterIdentit\n     return brokerResponse;\n   }\n \n+  /**\n+   * Check if table is in the format of [database_name].[table_name].\n+   *\n+   * Only update TableName in QuerySource if there is no existing table in the format of [database_name].[table_name],\n+   * but only [table_name].\n+   *\n+   * @param brokerRequest\n+   */\n+  private void updateQuerySource(BrokerRequest brokerRequest) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI0NjE2MQ=="}, "originalCommit": {"oid": "d2f709aadd038785cd04f9d5e7d49353fcdbda82"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0MDQ5NDczOnYy", "diffSide": "RIGHT", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjoyMDo1MFrOGyTT0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjoyMDo1MFrOGyTT0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM5ODM1NA==", "bodyText": "Avoid regex match\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                String[] querySourceSplits = tableName.split(\"\\\\.\", 2);\n          \n          \n            \n                String[] tableNameSplits = StringUtils.split(tableName, '.');", "url": "https://github.com/apache/pinot/pull/5707#discussion_r455398354", "createdAt": "2020-07-15T22:20:50Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -438,6 +439,46 @@ public BrokerResponse handleRequest(JsonNode request, @Nullable RequesterIdentit\n     return brokerResponse;\n   }\n \n+  /**\n+   * Check if table is in the format of [database_name].[table_name].\n+   *\n+   * Only update TableName in QuerySource if there is no existing table in the format of [database_name].[table_name],\n+   * but only [table_name].\n+   *\n+   * @param brokerRequest\n+   */\n+  private void updateQuerySource(BrokerRequest brokerRequest) {\n+    String tableName = brokerRequest.getQuerySource().getTableName();\n+    // Check if table is in the format of [database_name].[table_name]\n+    String[] querySourceSplits = tableName.split(\"\\\\.\", 2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2f709aadd038785cd04f9d5e7d49353fcdbda82"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0MDUwNDgzOnYy", "diffSide": "RIGHT", "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/helix/TableCache.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjoyNDo0M1rOGyTZqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjoyNDo0M1rOGyTZqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM5OTg1MA==", "bodyText": "Suggest renaming to containsTable()", "url": "https://github.com/apache/pinot/pull/5707#discussion_r455399850", "createdAt": "2020-07-15T22:24:43Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/helix/TableCache.java", "diffHunk": "@@ -67,6 +67,10 @@ public String getActualTableName(String tableName) {\n     return _tableConfigChangeListener._tableNameMap.getOrDefault(tableName.toLowerCase(), tableName);\n   }\n \n+  public boolean existTableName(String tableName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2f709aadd038785cd04f9d5e7d49353fcdbda82"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0MDUxNzc0OnYy", "diffSide": "RIGHT", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjoyOTozNVrOGyThaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjoyOTozNVrOGyThaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQwMTgzMw==", "bodyText": "Use 2 if checks to prevent using RoutingManager for case insensitive table\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (_enableCaseInsensitive && _tableCache.existTableName(querySourceSplits[1]) && !_tableCache\n          \n          \n            \n                    .existTableName(tableName)) {\n          \n          \n            \n                  // Use TableCache to check case insensitive table name.\n          \n          \n            \n                  brokerRequest.getQuerySource().setTableName(querySourceSplits[1]);\n          \n          \n            \n                  return;\n          \n          \n            \n                }\n          \n          \n            \n                if (_enableCaseInsensitive) {\n          \n          \n            \n                  // Use TableCache to check case insensitive table name.\n          \n          \n            \n                  if (_tableCache.existTableName(querySourceSplits[1]) && !_tableCache.existTableName(tableName)) {\n          \n          \n            \n                    brokerRequest.getQuerySource().setTableName(querySourceSplits[1]);\n          \n          \n            \n                  }\n          \n          \n            \n                  return;\n          \n          \n            \n                }", "url": "https://github.com/apache/pinot/pull/5707#discussion_r455401833", "createdAt": "2020-07-15T22:29:35Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -438,6 +439,46 @@ public BrokerResponse handleRequest(JsonNode request, @Nullable RequesterIdentit\n     return brokerResponse;\n   }\n \n+  /**\n+   * Check if table is in the format of [database_name].[table_name].\n+   *\n+   * Only update TableName in QuerySource if there is no existing table in the format of [database_name].[table_name],\n+   * but only [table_name].\n+   *\n+   * @param brokerRequest\n+   */\n+  private void updateQuerySource(BrokerRequest brokerRequest) {\n+    String tableName = brokerRequest.getQuerySource().getTableName();\n+    // Check if table is in the format of [database_name].[table_name]\n+    String[] querySourceSplits = tableName.split(\"\\\\.\", 2);\n+    if (querySourceSplits.length != 2) {\n+      return;\n+    }\n+    // Update table name if there is no existing table in the format of [database_name].[table_name] but only [table_name]\n+    if (_enableCaseInsensitive && _tableCache.existTableName(querySourceSplits[1]) && !_tableCache\n+        .existTableName(tableName)) {\n+      // Use TableCache to check case insensitive table name.\n+      brokerRequest.getQuerySource().setTableName(querySourceSplits[1]);\n+      return;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2f709aadd038785cd04f9d5e7d49353fcdbda82"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0MDUyNDA5OnYy", "diffSide": "RIGHT", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjozMjoxNlrOGyTlIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjozMjoxNlrOGyTlIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQwMjc4NA==", "bodyText": "Similarly here\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (tableType != null && _routingManager.routingExists(querySourceSplits[1]) && !_routingManager\n          \n          \n            \n                    .routingExists(tableName)) {\n          \n          \n            \n                  brokerRequest.getQuerySource().setTableName(querySourceSplits[1]);\n          \n          \n            \n                  return;\n          \n          \n            \n                }\n          \n          \n            \n                if (TableNameBuilder.isTableResource(tableName)) {\n          \n          \n            \n                  if (_routingManager.routingExists(querySourceSplits[1]) && !_routingManager.routingExists(tableName)) {\n          \n          \n            \n                    brokerRequest.getQuerySource().setTableName(querySourceSplits[1]);\n          \n          \n            \n                  }\n          \n          \n            \n                  return;\n          \n          \n            \n                }", "url": "https://github.com/apache/pinot/pull/5707#discussion_r455402784", "createdAt": "2020-07-15T22:32:16Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -438,6 +439,46 @@ public BrokerResponse handleRequest(JsonNode request, @Nullable RequesterIdentit\n     return brokerResponse;\n   }\n \n+  /**\n+   * Check if table is in the format of [database_name].[table_name].\n+   *\n+   * Only update TableName in QuerySource if there is no existing table in the format of [database_name].[table_name],\n+   * but only [table_name].\n+   *\n+   * @param brokerRequest\n+   */\n+  private void updateQuerySource(BrokerRequest brokerRequest) {\n+    String tableName = brokerRequest.getQuerySource().getTableName();\n+    // Check if table is in the format of [database_name].[table_name]\n+    String[] querySourceSplits = tableName.split(\"\\\\.\", 2);\n+    if (querySourceSplits.length != 2) {\n+      return;\n+    }\n+    // Update table name if there is no existing table in the format of [database_name].[table_name] but only [table_name]\n+    if (_enableCaseInsensitive && _tableCache.existTableName(querySourceSplits[1]) && !_tableCache\n+        .existTableName(tableName)) {\n+      // Use TableCache to check case insensitive table name.\n+      brokerRequest.getQuerySource().setTableName(querySourceSplits[1]);\n+      return;\n+    }\n+    // Use RoutingManager to check case sensitive table name.\n+    TableType tableType = TableNameBuilder.getTableTypeFromTableName(tableName);\n+    if (tableType != null && _routingManager.routingExists(querySourceSplits[1]) && !_routingManager\n+        .routingExists(tableName)) {\n+      brokerRequest.getQuerySource().setTableName(querySourceSplits[1]);\n+      return;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2f709aadd038785cd04f9d5e7d49353fcdbda82"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0MDkyMjI0OnYy", "diffSide": "RIGHT", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwMTo0ODo0N1rOGyXLJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwMTo0ODo0N1rOGyXLJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ2MTY3MA==", "bodyText": "Move return outside\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  if (_routingManager.routingExists(tableNameSplits[1]) && !_routingManager.routingExists(tableName)) {\n          \n          \n            \n                    brokerRequest.getQuerySource().setTableName(tableNameSplits[1]);\n          \n          \n            \n                    return;\n          \n          \n            \n                  }\n          \n          \n            \n                  if (_routingManager.routingExists(tableNameSplits[1]) && !_routingManager.routingExists(tableName)) {\n          \n          \n            \n                    brokerRequest.getQuerySource().setTableName(tableNameSplits[1]);\n          \n          \n            \n                  }\n          \n          \n            \n                  return;", "url": "https://github.com/apache/pinot/pull/5707#discussion_r455461670", "createdAt": "2020-07-16T01:48:47Z", "author": {"login": "Jackie-Jiang"}, "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -438,6 +439,47 @@ public BrokerResponse handleRequest(JsonNode request, @Nullable RequesterIdentit\n     return brokerResponse;\n   }\n \n+  /**\n+   * Check if table is in the format of [database_name].[table_name].\n+   *\n+   * Only update TableName in QuerySource if there is no existing table in the format of [database_name].[table_name],\n+   * but only [table_name].\n+   *\n+   * @param brokerRequest\n+   */\n+  private void updateQuerySource(BrokerRequest brokerRequest) {\n+    String tableName = brokerRequest.getQuerySource().getTableName();\n+    // Check if table is in the format of [database_name].[table_name]\n+    String[] tableNameSplits = StringUtils.split(tableName, '.');\n+    if (tableNameSplits.length != 2) {\n+      return;\n+    }\n+    // Update table name if there is no existing table in the format of [database_name].[table_name] but only [table_name]\n+    if (_enableCaseInsensitive) {\n+      if (_tableCache.containsTable(tableNameSplits[1]) && !_tableCache.containsTable(tableName)) {\n+        // Use TableCache to check case insensitive table name.\n+        brokerRequest.getQuerySource().setTableName(tableNameSplits[1]);\n+      }\n+      return;\n+    }\n+    // Use RoutingManager to check case sensitive table name.\n+    if (TableNameBuilder.isTableResource(tableName)) {\n+      if (_routingManager.routingExists(tableNameSplits[1]) && !_routingManager.routingExists(tableName)) {\n+        brokerRequest.getQuerySource().setTableName(tableNameSplits[1]);\n+        return;\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "429d27383a9006aeb713150ed21cc0679570f6ea"}, "originalPosition": 40}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4120, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}