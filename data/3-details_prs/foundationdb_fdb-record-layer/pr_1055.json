{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExMjI4MTU4", "number": 1055, "title": "Fixes #1054: \"make unbuilt index readable\" exception blocks opening a record store", "bodyText": "This happens when check version tries to rebuildIndexWithNoRecord but the index was not readable (probably related to reusing index name, also see #794 which was reverted)\nThere are two things need to be fixed:\n\n\nIn such situation it should mark the index to readable regardless\n\n\nIn any case, marking index as readable should not block the critical path (checkVersion), whose failure can people unable to do anything with the record store.", "createdAt": "2020-10-28T02:21:48Z", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1055", "merged": true, "mergeCommit": {"oid": "da492627e366351063f9678d4beac0933a6c1627"}, "closed": true, "closedAt": "2020-11-05T02:31:39Z", "author": {"login": "nblintao"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdW0OSHABqjM5MjkwNjczNDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZY-mDAFqTUyMzg4MzM4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7ba21c4469fe3dddd81e8313ebe0123c2bcd0ad4", "author": {"user": {"login": "nblintao", "name": "Tao Lin"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/7ba21c4469fe3dddd81e8313ebe0123c2bcd0ad4", "committedDate": "2020-10-28T02:21:01Z", "message": "Fixes #1054: \"make unbuilt index readable\" exception blocks opening a record store"}, "afterCommit": {"oid": "142ffdc14cf7c5a5cfe5d94ce80dbca1c3516049", "author": {"user": {"login": "nblintao", "name": "Tao Lin"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/142ffdc14cf7c5a5cfe5d94ce80dbca1c3516049", "committedDate": "2020-10-28T02:34:07Z", "message": "Fixes #1054: \"make unbuilt index readable\" exception blocks opening a record store"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMTE5MTI1", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1055#pullrequestreview-520119125", "createdAt": "2020-10-29T21:59:15Z", "commit": {"oid": "142ffdc14cf7c5a5cfe5d94ce80dbca1c3516049"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMTo1OToxNVrOHqwOHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMjo1Mzo0NFrOHqxeew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU5MjI4Ng==", "bodyText": "Hm, it seems like this should probably take a CompletableFuture<V> instead of a Supplier<CompletableFuture<V>>, which is generally what these methods take, but then I suppose you don't get the behavior that the same handler gets used constructing or executing the future, so I suppose it's probably fine.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1055#discussion_r514592286", "createdAt": "2020-10-29T21:59:15Z", "author": {"login": "alecgrieser"}, "path": "fdb-extensions/src/main/java/com/apple/foundationdb/async/MoreAsyncUtil.java", "diffHunk": "@@ -913,6 +913,32 @@ public static void closeIterator(@Nonnull Iterator<?> iterator) {\n         });\n     }\n \n+    /**\n+     * Handle when <code>futureSupplier</code> has exception when supplying a future, or the future is completed\n+     * exceptionally. Unlike the \"handle\" in CompletableFuture, <code>handlerOnException</code> is not executed if\n+     * the future is successful.\n+     * @param futureSupplier the supplier of future which need to be handled\n+     * @param handlerOnException the hanlder when the future has\n+     * @param <V> the result type of the future\n+     * @return future that completes exceptionally if the handler has exception\n+     */\n+    public static <V> CompletableFuture<V> handleOnException(Supplier<CompletableFuture<V>> futureSupplier,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "142ffdc14cf7c5a5cfe5d94ce80dbca1c3516049"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU5MjY4NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Handle when <code>futureSupplier</code> has exception when supplying a future, or the future is completed\n          \n          \n            \n                 * Handle when <code>futureSupplier</code> encounters an exception when supplying a future, or the future is completed", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1055#discussion_r514592685", "createdAt": "2020-10-29T22:00:08Z", "author": {"login": "alecgrieser"}, "path": "fdb-extensions/src/main/java/com/apple/foundationdb/async/MoreAsyncUtil.java", "diffHunk": "@@ -913,6 +913,32 @@ public static void closeIterator(@Nonnull Iterator<?> iterator) {\n         });\n     }\n \n+    /**\n+     * Handle when <code>futureSupplier</code> has exception when supplying a future, or the future is completed", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "142ffdc14cf7c5a5cfe5d94ce80dbca1c3516049"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU5Mjg3NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @param futureSupplier the supplier of future which need to be handled\n          \n          \n            \n                 * @param futureSupplier the supplier of future which needs to be handled", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1055#discussion_r514592874", "createdAt": "2020-10-29T22:00:36Z", "author": {"login": "alecgrieser"}, "path": "fdb-extensions/src/main/java/com/apple/foundationdb/async/MoreAsyncUtil.java", "diffHunk": "@@ -913,6 +913,32 @@ public static void closeIterator(@Nonnull Iterator<?> iterator) {\n         });\n     }\n \n+    /**\n+     * Handle when <code>futureSupplier</code> has exception when supplying a future, or the future is completed\n+     * exceptionally. Unlike the \"handle\" in CompletableFuture, <code>handlerOnException</code> is not executed if\n+     * the future is successful.\n+     * @param futureSupplier the supplier of future which need to be handled", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "142ffdc14cf7c5a5cfe5d94ce80dbca1c3516049"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU5Mjk3NA==", "bodyText": "Looks like this sentence drops off half way", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1055#discussion_r514592974", "createdAt": "2020-10-29T22:00:50Z", "author": {"login": "alecgrieser"}, "path": "fdb-extensions/src/main/java/com/apple/foundationdb/async/MoreAsyncUtil.java", "diffHunk": "@@ -913,6 +913,32 @@ public static void closeIterator(@Nonnull Iterator<?> iterator) {\n         });\n     }\n \n+    /**\n+     * Handle when <code>futureSupplier</code> has exception when supplying a future, or the future is completed\n+     * exceptionally. Unlike the \"handle\" in CompletableFuture, <code>handlerOnException</code> is not executed if\n+     * the future is successful.\n+     * @param futureSupplier the supplier of future which need to be handled\n+     * @param handlerOnException the hanlder when the future has", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "142ffdc14cf7c5a5cfe5d94ce80dbca1c3516049"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU5NDY0Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                            logExceptionAsWarn(\"unable build index\", exception);\n          \n          \n            \n                                            logExceptionAsWarn(\"unable to build index\", exception);\n          \n      \n    \n    \n  \n\nIt also seems like we might want to include things like the index name as a log key. Maybe logExceptionAsWarn should take a KeyValueLogMessage (and handle adding the log keys from the exception as well)?", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1055#discussion_r514594647", "createdAt": "2020-10-29T22:05:05Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "diffHunk": "@@ -3055,7 +3090,14 @@ public boolean isIndexDisabled(@Nonnull String indexName) {\n                     Index index = indexItem.getKey();\n                     List<RecordType> recordTypes = indexItem.getValue();\n                     IndexState indexState = newStates.getOrDefault(index, IndexState.READABLE);\n-                    work.add(rebuildOrMarkIndex(index, indexState, recordTypes, reason, oldMetaDataVersion));\n+                    final CompletableFuture<Void> rebuildOrMarkIndexSafely = MoreAsyncUtil.handleOnException(\n+                            () -> rebuildOrMarkIndex(index, indexState, recordTypes, reason, oldMetaDataVersion),\n+                            exception -> {\n+                                // If there is anything issue, simply mark the index as disabled without blocking checkVersion\n+                                logExceptionAsWarn(\"unable build index\", exception);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "142ffdc14cf7c5a5cfe5d94ce80dbca1c3516049"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYxMjg1OQ==", "bodyText": "There's something about having this catch and then ignore the error that feels a little strange....\nGiven that we're going to ignore the results of doing the validation, it almost seems like we should call uncheckedMarkIndexReadable. I could see alternative arguments that we could, like, check there are no uniqueness violations or data in the index subspace or something and then mark it as READABLE (perhaps only in the error case) (and maybe it also should add the \\x00 to \\xff range to the build space?).\nI could also see an argument that if it encounters an error, it should mark the index as DISABLED and wait for a rebuild. Then we don't get the index right away (sad) but we also no longer block checkVersion.\nSomething about the extra flag to force marking it as readable doesn't quite seem right.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1055#discussion_r514612859", "createdAt": "2020-10-29T22:53:44Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "diffHunk": "@@ -3117,7 +3159,10 @@ private boolean areAllRecordTypesSince(@Nullable Collection<RecordType> recordTy\n             }\n         }\n \n-        return markIndexReadable(index).thenApply(b -> null);\n+        // The index states is supposed to be empty (i.e. readable) because this is a new index. But unfortunately, the\n+        // index state is keyed by index name which can be reused. So we need to mark the index readable. In such case,\n+        // the built range is unlikely to be full so we should force it.\n+        return markIndexReadable(index, true).thenApply(b -> null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "142ffdc14cf7c5a5cfe5d94ce80dbca1c3516049"}, "originalPosition": 126}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3659779bbb17e2677cf0ba2fa77674a703b5912e", "author": {"user": {"login": "nblintao", "name": "Tao Lin"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/3659779bbb17e2677cf0ba2fa77674a703b5912e", "committedDate": "2020-11-03T02:21:49Z", "message": "Not force marking index readable & and test"}, "afterCommit": {"oid": "8713a5d7ba4f5df9f0b84874c3706dd964cbc284", "author": {"user": {"login": "nblintao", "name": "Tao Lin"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/8713a5d7ba4f5df9f0b84874c3706dd964cbc284", "committedDate": "2020-11-03T02:41:08Z", "message": "Not force marking index readable & and test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd5920abf47853df009be84945db9202b55fadf7", "author": {"user": {"login": "nblintao", "name": "Tao Lin"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/dd5920abf47853df009be84945db9202b55fadf7", "committedDate": "2020-11-04T20:02:38Z", "message": "Fixes #1054: \"make unbuilt index readable\" exception blocks opening a record store"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8713a5d7ba4f5df9f0b84874c3706dd964cbc284", "author": {"user": {"login": "nblintao", "name": "Tao Lin"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/8713a5d7ba4f5df9f0b84874c3706dd964cbc284", "committedDate": "2020-11-03T02:41:08Z", "message": "Not force marking index readable & and test"}, "afterCommit": {"oid": "c87d19952d0b2c790c44a24bb85b8a8e813d10a9", "author": {"user": {"login": "nblintao", "name": "Tao Lin"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/c87d19952d0b2c790c44a24bb85b8a8e813d10a9", "committedDate": "2020-11-04T20:02:38Z", "message": "Not force marking index readable & and test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9505d73e0ecf9ffff5b1b0ee547352e94af1495", "author": {"user": {"login": "nblintao", "name": "Tao Lin"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/e9505d73e0ecf9ffff5b1b0ee547352e94af1495", "committedDate": "2020-11-04T21:46:26Z", "message": "Not force marking index readable & and test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c87d19952d0b2c790c44a24bb85b8a8e813d10a9", "author": {"user": {"login": "nblintao", "name": "Tao Lin"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/c87d19952d0b2c790c44a24bb85b8a8e813d10a9", "committedDate": "2020-11-04T20:02:38Z", "message": "Not force marking index readable & and test"}, "afterCommit": {"oid": "e9505d73e0ecf9ffff5b1b0ee547352e94af1495", "author": {"user": {"login": "nblintao", "name": "Tao Lin"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/e9505d73e0ecf9ffff5b1b0ee547352e94af1495", "committedDate": "2020-11-04T21:46:26Z", "message": "Not force marking index readable & and test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzODU5ODQx", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1055#pullrequestreview-523859841", "createdAt": "2020-11-05T01:47:39Z", "commit": {"oid": "e9505d73e0ecf9ffff5b1b0ee547352e94af1495"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzODgzMzgz", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1055#pullrequestreview-523883383", "createdAt": "2020-11-05T02:31:26Z", "commit": {"oid": "e9505d73e0ecf9ffff5b1b0ee547352e94af1495"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2480, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}