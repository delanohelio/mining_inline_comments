{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4NDQ2MTI3", "number": 833, "title": "Resolves #828: RankedSet poorly split for non-random keys ", "bodyText": "Introduces an index option for RANK and TIME_WINDOW_LEADERBOARD indexes that controls what hash function is used.\nNote that while it is technically safe to change the hash function for existing data, this is not recommended, as it changes the distribution.", "createdAt": "2020-02-21T19:52:37Z", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/833", "merged": true, "mergeCommit": {"oid": "aa0f2b230940b8c5499a89f82b0c9d071c10f394"}, "closed": true, "closedAt": "2020-02-24T14:09:34Z", "author": {"login": "MMcM"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGlUGOABqjMwNjE3MzYyMDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHNYfUABqjMwNjM2MTk2MjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e3d79a10439a7d77e31997dfe7bdd24a9b484a6e", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/e3d79a10439a7d77e31997dfe7bdd24a9b484a6e", "committedDate": "2020-02-21T19:47:30Z", "message": "Resolves #828: RankedSet poorly split for non-random keys\nIntroduces an index option for RANK and TIME_WINDOW_LEADERBOARD indexes that controls what hash function is used.\nNote that while it is technically safe to change the hash function for existing data, this is not recommended, as it changes the distribution."}, "afterCommit": {"oid": "74722663e678ad3c5da7f2727afb3bf466401deb", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/74722663e678ad3c5da7f2727afb3bf466401deb", "committedDate": "2020-02-21T19:57:56Z", "message": "Resolves #828: RankedSet poorly split for non-random keys\nIntroduces an index option for RANK and TIME_WINDOW_LEADERBOARD indexes that controls what hash function is used.\nNote that while it is technically safe to change the hash function for existing data, this is not recommended, as it changes the distribution."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "74722663e678ad3c5da7f2727afb3bf466401deb", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/74722663e678ad3c5da7f2727afb3bf466401deb", "committedDate": "2020-02-21T19:57:56Z", "message": "Resolves #828: RankedSet poorly split for non-random keys\nIntroduces an index option for RANK and TIME_WINDOW_LEADERBOARD indexes that controls what hash function is used.\nNote that while it is technically safe to change the hash function for existing data, this is not recommended, as it changes the distribution."}, "afterCommit": {"oid": "bf835044155835927488cff2fde4ecb7277ca2ff", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/bf835044155835927488cff2fde4ecb7277ca2ff", "committedDate": "2020-02-21T19:59:30Z", "message": "Resolves #828: RankedSet poorly split for non-random keys\nIntroduces an index option for RANK and TIME_WINDOW_LEADERBOARD indexes that controls what hash function is used.\nNote that while it is technically safe to change the hash function for existing data, this is not recommended, as it changes the distribution."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bf835044155835927488cff2fde4ecb7277ca2ff", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/bf835044155835927488cff2fde4ecb7277ca2ff", "committedDate": "2020-02-21T19:59:30Z", "message": "Resolves #828: RankedSet poorly split for non-random keys\nIntroduces an index option for RANK and TIME_WINDOW_LEADERBOARD indexes that controls what hash function is used.\nNote that while it is technically safe to change the hash function for existing data, this is not recommended, as it changes the distribution."}, "afterCommit": {"oid": "e2f678b95534aa08a88fb8add37a39f592f71a27", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/e2f678b95534aa08a88fb8add37a39f592f71a27", "committedDate": "2020-02-21T20:15:12Z", "message": "Resolves #828: RankedSet poorly split for non-random keys\nIntroduces an index option for RANK and TIME_WINDOW_LEADERBOARD indexes that controls what hash function is used.\nNote that while it is technically safe to change the hash function for existing data, this is not recommended, as it changes the distribution."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e2f678b95534aa08a88fb8add37a39f592f71a27", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/e2f678b95534aa08a88fb8add37a39f592f71a27", "committedDate": "2020-02-21T20:15:12Z", "message": "Resolves #828: RankedSet poorly split for non-random keys\nIntroduces an index option for RANK and TIME_WINDOW_LEADERBOARD indexes that controls what hash function is used.\nNote that while it is technically safe to change the hash function for existing data, this is not recommended, as it changes the distribution."}, "afterCommit": {"oid": "33d8ddb960b33736a51df2c8647f39e58e76f1aa", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/33d8ddb960b33736a51df2c8647f39e58e76f1aa", "committedDate": "2020-02-21T21:02:41Z", "message": "Resolves #828: RankedSet poorly split for non-random keys\nIntroduces an index option for RANK and TIME_WINDOW_LEADERBOARD indexes that controls what hash function is used.\nNote that while it is technically safe to change the hash function for existing data, this is not recommended, as it changes the distribution."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyOTYwNDY4", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/833#pullrequestreview-362960468", "createdAt": "2020-02-21T22:41:15Z", "commit": {"oid": "33d8ddb960b33736a51df2c8647f39e58e76f1aa"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQyMjo0MToxNVrOFtGurQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQyMjo1NzowMlrOFtHA5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0MDQ5Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            * **Performance** Improvement Allow setting hash function used by `RankedSet` [(Issue #828)](https://github.com/FoundationDB/fdb-record-layer/issues/828)\n          \n          \n            \n            * **Performance** Allow setting hash function used by `RankedSet` [(Issue #828)](https://github.com/FoundationDB/fdb-record-layer/issues/828)", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/833#discussion_r382840493", "createdAt": "2020-02-21T22:41:15Z", "author": {"login": "alecgrieser"}, "path": "docs/ReleaseNotes.md", "diffHunk": "@@ -45,7 +45,7 @@ The `FDBDatabase::getReadVersion()` method has been replaced with the `FDBRecord\n * **Bug fix** Fix 3 [(Issue #NNN)](https://github.com/FoundationDB/fdb-record-layer/issues/NNN)\n * **Bug fix** Fix 4 [(Issue #NNN)](https://github.com/FoundationDB/fdb-record-layer/issues/NNN)\n * **Bug fix** Fix 5 [(Issue #NNN)](https://github.com/FoundationDB/fdb-record-layer/issues/NNN)\n-* **Performance** Improvement 1 [(Issue #NNN)](https://github.com/FoundationDB/fdb-record-layer/issues/NNN)\n+* **Performance** Improvement Allow setting hash function used by `RankedSet` [(Issue #828)](https://github.com/FoundationDB/fdb-record-layer/issues/828)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33d8ddb960b33736a51df2c8647f39e58e76f1aa"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0MTQwNw==", "bodyText": "While the other lines in this comment are aren't needed any more, I think this first line is still valuable.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/833#discussion_r382841407", "createdAt": "2020-02-21T22:44:05Z", "author": {"login": "alecgrieser"}, "path": "fdb-extensions/src/main/java/com/apple/foundationdb/async/RankedSet.java", "diffHunk": "@@ -143,10 +190,7 @@ public RankedSet(Subspace subspace, Executor executor) {\n      */\n     public CompletableFuture<Boolean> add(TransactionContext tc, byte[] key) {\n         checkKey(key);\n-        // Use the hash of the key, instead a p value and randomLevel. The key is likely Tuple-encoded.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33d8ddb960b33736a51df2c8647f39e58e76f1aa"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0MjE2MA==", "bodyText": "Interesting. I suppose we could loosen this to allow for the rank hash function to change (given that it should be compatible). I'm not opposed to being stricter for now, though perhaps that should be an option at some point.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/833#discussion_r382842160", "createdAt": "2020-02-21T22:46:33Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/indexes/RankIndexMaintainerFactory.java", "diffHunk": "@@ -64,15 +65,25 @@ public void validate(@Nonnull MetaDataValidator metaDataValidator) {\n \n             @Override\n             public void validateChangedOptions(@Nonnull Index oldIndex, @Nonnull Set<String> changedOptions) {\n+                // Allow changing from unspecified to the default (or vice versa), but not otherwise.\n                 if (changedOptions.contains(IndexOptions.RANK_NLEVELS)) {\n-                    int oldLevels = RankIndexMaintainer.getNLevels(oldIndex);\n-                    int newLevels = RankIndexMaintainer.getNLevels(index);\n+                    int oldLevels = RankedSetIndexHelper.getNLevels(oldIndex);\n+                    int newLevels = RankedSetIndexHelper.getNLevels(index);\n                     if (oldLevels != newLevels) {\n                         throw new MetaDataException(\"rank levels changed\",\n                                 LogMessageKeys.INDEX_NAME, index.getName());\n                     }\n                     changedOptions.remove(IndexOptions.RANK_NLEVELS);\n                 }\n+                if (changedOptions.contains(IndexOptions.RANK_HASH_FUNCTION)) {\n+                    RankedSet.HashFunction oldFunction = RankedSetIndexHelper.getHashFunction(oldIndex);\n+                    RankedSet.HashFunction newFunction = RankedSetIndexHelper.getHashFunction(index);\n+                    if (!oldFunction.equals(newFunction)) {\n+                        throw new MetaDataException(\"rank hash function changed\",\n+                                LogMessageKeys.INDEX_NAME, index.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33d8ddb960b33736a51df2c8647f39e58e76f1aa"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0MzA2MA==", "bodyText": "I suppose using a registry rather than an enum is more idiomatic (e.g., FunctionKeyExpressions) and allows a user to provide their own implementation. I think that switching to a registry in the future is compatible with this current approach, though, so maybe it's fine as is for now. (Perhaps there should be an Issue about it.)", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/833#discussion_r382843060", "createdAt": "2020-02-21T22:49:53Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/indexes/RankedSetIndexHelper.java", "diffHunk": "@@ -50,6 +54,54 @@\n public class RankedSetIndexHelper {\n     public static final Tuple COMPARISON_SKIPPED_SCORE = Tuple.from(Comparisons.COMPARISON_SKIPPED_BINDING);\n \n+    public static final RankedSet.HashFunction MURMUR3_HASH_FUNCTION = new GuavaHashFunction(Hashing.murmur3_32());\n+\n+    /**\n+     * Use {@code com.google.common.hash.HashFunction}s as {@code RankedSet.HashFunction}s.\n+     */\n+    public static class GuavaHashFunction implements RankedSet.HashFunction {\n+        @Nonnull\n+        private final HashFunction guava;\n+\n+        public GuavaHashFunction(HashFunction guava) {\n+            this.guava = guava;\n+        }\n+\n+        @Override\n+        public int hash(byte[] key) {\n+            return guava.hashBytes(key).asInt();\n+        }\n+    }\n+\n+    /**\n+     * Known hash functions available as index options.\n+     */\n+    public enum HashFunctionNames {\n+        JDK(RankedSet.JDK_ARRAY_HASH),\n+        CRC(RankedSet.CRC_HASH),\n+        MURMUR3(MURMUR3_HASH_FUNCTION);\n+\n+        private final RankedSet.HashFunction hashFunction;\n+\n+        HashFunctionNames(RankedSet.HashFunction hashFunction) {\n+            this.hashFunction = hashFunction;\n+        }\n+\n+        public RankedSet.HashFunction getHashFunction() {\n+            return hashFunction;\n+        }\n+    }\n+\n+    public static int getNLevels(@Nonnull Index index) {\n+        String nlevelsOption = index.getOption(IndexOptions.RANK_NLEVELS);\n+        return nlevelsOption == null ? RankedSet.DEFAULT_LEVELS : Integer.parseInt(nlevelsOption);\n+    }\n+\n+    public static RankedSet.HashFunction getHashFunction(@Nonnull Index index) {\n+        String hashFunctionOption = index.getOption(IndexOptions.RANK_HASH_FUNCTION);\n+        return hashFunctionOption == null ? RankedSet.DEFAULT_HASH_FUNCTION : HashFunctionNames.valueOf(hashFunctionOption).getHashFunction();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33d8ddb960b33736a51df2c8647f39e58e76f1aa"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0MzQwOQ==", "bodyText": "This kind of feels like a private class, at least until the user can provide their own hash function implementation (instead of using the enum).", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/833#discussion_r382843409", "createdAt": "2020-02-21T22:51:00Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/indexes/RankedSetIndexHelper.java", "diffHunk": "@@ -50,6 +54,54 @@\n public class RankedSetIndexHelper {\n     public static final Tuple COMPARISON_SKIPPED_SCORE = Tuple.from(Comparisons.COMPARISON_SKIPPED_BINDING);\n \n+    public static final RankedSet.HashFunction MURMUR3_HASH_FUNCTION = new GuavaHashFunction(Hashing.murmur3_32());\n+\n+    /**\n+     * Use {@code com.google.common.hash.HashFunction}s as {@code RankedSet.HashFunction}s.\n+     */\n+    public static class GuavaHashFunction implements RankedSet.HashFunction {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33d8ddb960b33736a51df2c8647f39e58e76f1aa"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0NTE1Ng==", "bodyText": "As this enum is in an INTERNAL class, it's technically \"unadvised\" for users to use this, but the alternative is they need their own constants in their code if they want to use the names here. I suppose we could leave it here if we're not \"entirely happy\" with this API (yet?), or move it out.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/833#discussion_r382845156", "createdAt": "2020-02-21T22:57:02Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/indexes/RankedSetIndexHelper.java", "diffHunk": "@@ -50,6 +54,54 @@\n public class RankedSetIndexHelper {\n     public static final Tuple COMPARISON_SKIPPED_SCORE = Tuple.from(Comparisons.COMPARISON_SKIPPED_BINDING);\n \n+    public static final RankedSet.HashFunction MURMUR3_HASH_FUNCTION = new GuavaHashFunction(Hashing.murmur3_32());\n+\n+    /**\n+     * Use {@code com.google.common.hash.HashFunction}s as {@code RankedSet.HashFunction}s.\n+     */\n+    public static class GuavaHashFunction implements RankedSet.HashFunction {\n+        @Nonnull\n+        private final HashFunction guava;\n+\n+        public GuavaHashFunction(HashFunction guava) {\n+            this.guava = guava;\n+        }\n+\n+        @Override\n+        public int hash(byte[] key) {\n+            return guava.hashBytes(key).asInt();\n+        }\n+    }\n+\n+    /**\n+     * Known hash functions available as index options.\n+     */\n+    public enum HashFunctionNames {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33d8ddb960b33736a51df2c8647f39e58e76f1aa"}, "originalPosition": 56}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ef5eb07cf1fe4be256479c0a65e6aa40311b22c2", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/ef5eb07cf1fe4be256479c0a65e6aa40311b22c2", "committedDate": "2020-02-21T23:36:23Z", "message": "Update docs/ReleaseNotes.md\n\nCo-Authored-By: Alec Grieser <alloc@apple.com>"}, "afterCommit": {"oid": "e058eeb26aa867b289bc15bf4f6e4f06cb10a0ba", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/e058eeb26aa867b289bc15bf4f6e4f06cb10a0ba", "committedDate": "2020-02-22T00:17:58Z", "message": "Move enum out to top level as a regular class."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e058eeb26aa867b289bc15bf4f6e4f06cb10a0ba", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/e058eeb26aa867b289bc15bf4f6e4f06cb10a0ba", "committedDate": "2020-02-22T00:17:58Z", "message": "Move enum out to top level as a regular class."}, "afterCommit": {"oid": "7a5eee2b371b0ff67d3905c1f9660cef1d4c123e", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/7a5eee2b371b0ff67d3905c1f9660cef1d4c123e", "committedDate": "2020-02-22T05:05:53Z", "message": "Move enum out to top level as a regular class."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7a5eee2b371b0ff67d3905c1f9660cef1d4c123e", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/7a5eee2b371b0ff67d3905c1f9660cef1d4c123e", "committedDate": "2020-02-22T05:05:53Z", "message": "Move enum out to top level as a regular class."}, "afterCommit": {"oid": "3b9308c92b446df845cd7fc108795fcebf8c3569", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/3b9308c92b446df845cd7fc108795fcebf8c3569", "committedDate": "2020-02-22T05:11:35Z", "message": "Move enum out to top level as a regular class."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9514e03b4fb16223fa0aa1be736df807b760c42f", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/9514e03b4fb16223fa0aa1be736df807b760c42f", "committedDate": "2020-02-23T18:38:05Z", "message": "Allow RankedSet to have different hash functions."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75a19880395259eba12c6a285da3d72925bbde9f", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/75a19880395259eba12c6a285da3d72925bbde9f", "committedDate": "2020-02-23T18:38:57Z", "message": "Resolves #828: RankedSet poorly split for non-random keys\nIntroduces an index option for RANK and TIME_WINDOW_LEADERBOARD indexes that controls what hash function is used.\nNote that while it is technically safe to change the hash function for existing data, this is not recommended, as it changes the distribution."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0440f94cb35b60897b86c35959eafcd3019b77c", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/d0440f94cb35b60897b86c35959eafcd3019b77c", "committedDate": "2020-02-23T18:38:57Z", "message": "Move enum out to top level as a regular class."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3b9308c92b446df845cd7fc108795fcebf8c3569", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/3b9308c92b446df845cd7fc108795fcebf8c3569", "committedDate": "2020-02-22T05:11:35Z", "message": "Move enum out to top level as a regular class."}, "afterCommit": {"oid": "d0440f94cb35b60897b86c35959eafcd3019b77c", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/d0440f94cb35b60897b86c35959eafcd3019b77c", "committedDate": "2020-02-23T18:38:57Z", "message": "Move enum out to top level as a regular class."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2770, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}