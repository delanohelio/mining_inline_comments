{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzMzM4MDc4", "number": 961, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMjoyMTozMVrOEE3lag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMzowNzoyOVrOEE4LyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNTQwNDU4OnYy", "diffSide": "RIGHT", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMjoyMTozMVrOGiwvAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMjoyMTozMVrOGiwvAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEwMzIzNA==", "bodyText": "This method is only called if one wants to add a conflict range over all records, so it should essentially never be called. I'm surprised it's showing up in your profiling. Maybe it doesn't hurt to also optimize it in this way.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/961#discussion_r439103234", "createdAt": "2020-06-11T22:21:31Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "diffHunk": "@@ -2771,6 +2781,10 @@ public Range getUnbuiltRange() {\n      * Add a read conflict key for all records.\n      */\n     private void addRecordsReadConflict() {\n+        if (recordsReadConflict) {\n+            return;\n+        }\n+        recordsReadConflict = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40e40a9966f8b9e8fad2d79749a3cb51dca32c3c"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNTQxMjM5OnYy", "diffSide": "RIGHT", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMjoyNTowNFrOGiwzng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMjozNDo1NVrOGixAqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEwNDQxNA==", "bodyText": "Should this be using a ConcurrentHashMap? I think multiple threads can access it at once. Because it's safe to set this multiple times for the same index, having this throw away the full hash map in certain race conditions seems fine, but I'm still worried about messing up internal state in the hash map if there are multiple accessors.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/961#discussion_r439104414", "createdAt": "2020-06-11T22:25:04Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "diffHunk": "@@ -2784,6 +2798,14 @@ private void addIndexStateReadConflict(@Nonnull String indexName) {\n         if (!getRecordMetaData().hasIndex(indexName)) {\n             throw new MetaDataException(\"Index \" + indexName + \" does not exist in meta-data.\");\n         }\n+        if (indexStateReadConflicts == null) {\n+            indexStateReadConflicts = new HashSet<>(8);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40e40a9966f8b9e8fad2d79749a3cb51dca32c3c"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEwNzc1Mg==", "bodyText": "Yeah, I debated.  I will modify.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/961#discussion_r439107752", "createdAt": "2020-06-11T22:34:55Z", "author": {"login": "jleach4"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "diffHunk": "@@ -2784,6 +2798,14 @@ private void addIndexStateReadConflict(@Nonnull String indexName) {\n         if (!getRecordMetaData().hasIndex(indexName)) {\n             throw new MetaDataException(\"Index \" + indexName + \" does not exist in meta-data.\");\n         }\n+        if (indexStateReadConflicts == null) {\n+            indexStateReadConflicts = new HashSet<>(8);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEwNDQxNA=="}, "originalCommit": {"oid": "40e40a9966f8b9e8fad2d79749a3cb51dca32c3c"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNTQ4Nzc5OnYy", "diffSide": "RIGHT", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMzowMDoxMVrOGixgyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMzowMTo0NFrOGixipw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExNTk3Nw==", "bodyText": "Is there a reason this doesn't just set it to a ConcurrentHashMap in the constructor? We'll need to access this whenever we access an index, which will be essentially most things that interact with the store, so it seems like just initializing this in the constructor would be simpler and not much more expensive?", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/961#discussion_r439115977", "createdAt": "2020-06-11T23:00:11Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "diffHunk": "@@ -2784,6 +2798,14 @@ private void addIndexStateReadConflict(@Nonnull String indexName) {\n         if (!getRecordMetaData().hasIndex(indexName)) {\n             throw new MetaDataException(\"Index \" + indexName + \" does not exist in meta-data.\");\n         }\n+        if (indexStateReadConflicts == null) {\n+            indexStateReadConflicts = ConcurrentHashMap.newKeySet(8);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe1bb2230563c0e386b78790542fb6548b3f5b4f"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExNjQ1NQ==", "bodyText": "Sure, let me fix.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/961#discussion_r439116455", "createdAt": "2020-06-11T23:01:44Z", "author": {"login": "jleach4"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "diffHunk": "@@ -2784,6 +2798,14 @@ private void addIndexStateReadConflict(@Nonnull String indexName) {\n         if (!getRecordMetaData().hasIndex(indexName)) {\n             throw new MetaDataException(\"Index \" + indexName + \" does not exist in meta-data.\");\n         }\n+        if (indexStateReadConflicts == null) {\n+            indexStateReadConflicts = ConcurrentHashMap.newKeySet(8);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExNTk3Nw=="}, "originalCommit": {"oid": "fe1bb2230563c0e386b78790542fb6548b3f5b4f"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNTUwMTM3OnYy", "diffSide": "RIGHT", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMzowNjo0OVrOGixo4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMzowNjo0OVrOGixo4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExODA1MA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Nullable\n          \n          \n            \n                @Nonnull", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/961#discussion_r439118050", "createdAt": "2020-06-11T23:06:49Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "diffHunk": "@@ -250,6 +251,15 @@\n     @Nonnull\n     private final Cache<Tuple, FDBRawRecord> preloadCache;\n \n+    @Nonnull\n+    private boolean recordsReadConflict;\n+\n+    @Nonnull\n+    private boolean storeStateReadConflict;\n+\n+    @Nullable", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ff53285192f0c6d24dcd1d15a379129e3345f2b"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNTUwMjIzOnYy", "diffSide": "RIGHT", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMzowNzoxM1rOGixpXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMzowNzoxM1rOGixpXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExODE3NQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Nonnull", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/961#discussion_r439118175", "createdAt": "2020-06-11T23:07:13Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "diffHunk": "@@ -250,6 +251,15 @@\n     @Nonnull\n     private final Cache<Tuple, FDBRawRecord> preloadCache;\n \n+    @Nonnull", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ff53285192f0c6d24dcd1d15a379129e3345f2b"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNTUwMjUzOnYy", "diffSide": "RIGHT", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMzowNzoyMFrOGixpig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMzowNzoyMFrOGixpig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExODIxOA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Nonnull", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/961#discussion_r439118218", "createdAt": "2020-06-11T23:07:20Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "diffHunk": "@@ -250,6 +251,15 @@\n     @Nonnull\n     private final Cache<Tuple, FDBRawRecord> preloadCache;\n \n+    @Nonnull\n+    private boolean recordsReadConflict;\n+\n+    @Nonnull", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ff53285192f0c6d24dcd1d15a379129e3345f2b"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNTUwMjgxOnYy", "diffSide": "RIGHT", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMzowNzoyOVrOGixptA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMzowNzoyOVrOGixptA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExODI2MA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private Set<String> indexStateReadConflicts = ConcurrentHashMap.newKeySet(8);\n          \n          \n            \n                private final Set<String> indexStateReadConflicts = ConcurrentHashMap.newKeySet(8);", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/961#discussion_r439118260", "createdAt": "2020-06-11T23:07:29Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "diffHunk": "@@ -250,6 +251,15 @@\n     @Nonnull\n     private final Cache<Tuple, FDBRawRecord> preloadCache;\n \n+    @Nonnull\n+    private boolean recordsReadConflict;\n+\n+    @Nonnull\n+    private boolean storeStateReadConflict;\n+\n+    @Nullable\n+    private Set<String> indexStateReadConflicts = ConcurrentHashMap.newKeySet(8);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ff53285192f0c6d24dcd1d15a379129e3345f2b"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4918, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}