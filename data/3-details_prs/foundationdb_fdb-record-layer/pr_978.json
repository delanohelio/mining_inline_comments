{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2MTUzMzc3", "number": 978, "title": "Fixes #977: RecordMetaData#recordTypesForIndex is N^2 with Universal index probing...", "bodyText": "N^2 shows up with a decent number of indexes and lots of and/or predicate action.", "createdAt": "2020-06-17T23:56:44Z", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/978", "merged": true, "mergeCommit": {"oid": "a3fd03ca0e680e4fc94469b3f9cc1dc05241cd88"}, "closed": true, "closedAt": "2020-07-13T17:09:21Z", "author": {"login": "jleach4"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsTBNYAFqTQzMjg1NjE2MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc0kmw4AFqTQ0NzQ0MDQwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyODU2MTYx", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/978#pullrequestreview-432856161", "createdAt": "2020-06-18T00:08:16Z", "commit": {"oid": "ce0306d56913301c679cfb646b5bce047b14b8ad"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyODU4NTk5", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/978#pullrequestreview-432858599", "createdAt": "2020-06-18T00:16:24Z", "commit": {"oid": "ce0306d56913301c679cfb646b5bce047b14b8ad"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwMDoxNjoyNVrOGlbehw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwMDoxNjoyNVrOGlbehw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkwMDY3OQ==", "bodyText": "Would it make sense to cache the result of this function back inside the Index itself?\nFor most indexes, it will be the singleton, so that's not much more space and the meta-data has a reasonably long lifetime.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/978#discussion_r441900679", "createdAt": "2020-06-18T00:16:25Z", "author": {"login": "MMcM"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/RecordMetaData.java", "diffHunk": "@@ -372,7 +372,7 @@ public boolean usesSubspaceKeyCounter() {\n \n     @Nonnull\n     public Collection<RecordType> recordTypesForIndex(@Nonnull Index index) {\n-        if (getUniversalIndexes().contains(index)) {\n+        if (hasUniversalIndex(index.getName())) {\n             return getRecordTypes().values();\n         }\n         List<RecordType> result = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce0306d56913301c679cfb646b5bce047b14b8ad"}, "originalPosition": 8}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ce0306d56913301c679cfb646b5bce047b14b8ad", "author": {"user": {"login": "jleach4", "name": "John Leach"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/ce0306d56913301c679cfb646b5bce047b14b8ad", "committedDate": "2020-06-17T23:55:10Z", "message": "Fixes #977: RecordMetaData#recordTypesForIndex is N^2 with Universal Index probing."}, "afterCommit": {"oid": "8974959948d6699ca281b181bdd561cd9b8ddab9", "author": {"user": {"login": "jleach4", "name": "John Leach"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/8974959948d6699ca281b181bdd561cd9b8ddab9", "committedDate": "2020-06-22T16:53:46Z", "message": "Fixes #977: RecordMetaData#recordTypesForIndex is N^2 with Universal Index probing."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8974959948d6699ca281b181bdd561cd9b8ddab9", "author": {"user": {"login": "jleach4", "name": "John Leach"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/8974959948d6699ca281b181bdd561cd9b8ddab9", "committedDate": "2020-06-22T16:53:46Z", "message": "Fixes #977: RecordMetaData#recordTypesForIndex is N^2 with Universal Index probing."}, "afterCommit": {"oid": "79ecda515f926d11d7d5e26f32574c371637fdfa", "author": {"user": {"login": "jleach4", "name": "John Leach"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/79ecda515f926d11d7d5e26f32574c371637fdfa", "committedDate": "2020-06-24T21:25:10Z", "message": "Fixes #977: RecordMetaData#recordTypesForIndex is N^2 with Universal Index probing."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "79ecda515f926d11d7d5e26f32574c371637fdfa", "author": {"user": {"login": "jleach4", "name": "John Leach"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/79ecda515f926d11d7d5e26f32574c371637fdfa", "committedDate": "2020-06-24T21:25:10Z", "message": "Fixes #977: RecordMetaData#recordTypesForIndex is N^2 with Universal Index probing."}, "afterCommit": {"oid": "3efad62049bfd8f8c0039d21200662012a0a7761", "author": {"user": {"login": "jleach4", "name": "John Leach"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/3efad62049bfd8f8c0039d21200662012a0a7761", "committedDate": "2020-07-02T18:34:00Z", "message": "Fixes #977: RecordMetaData#recordTypesForIndex is N^2 with Universal Index probing."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxOTM1OTcz", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/978#pullrequestreview-441935973", "createdAt": "2020-07-02T18:36:09Z", "commit": {"oid": "3efad62049bfd8f8c0039d21200662012a0a7761"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxODozNjowOVrOGsZFPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxODozNjowOVrOGsZFPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIwMTQ2OA==", "bodyText": "Does this need to be a ConcurrentHashMap? Alternatively, this could be populated at meta-data build time (for every index), I suppose, and then it's immutable, so concurrency doesn't matter.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/978#discussion_r449201468", "createdAt": "2020-07-02T18:36:09Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/RecordMetaData.java", "diffHunk": "@@ -118,6 +119,7 @@ protected RecordMetaData(@Nonnull Descriptors.FileDescriptor recordsDescriptor,\n         this.usesSubspaceKeyCounter = usesSubspaceKeyCounter;\n         this.recordCountKey = recordCountKey;\n         this.usesLocalRecordsDescriptor = usesLocalRecordsDescriptor;\n+        this.recordTypesForIndex = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3efad62049bfd8f8c0039d21200662012a0a7761"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3efad62049bfd8f8c0039d21200662012a0a7761", "author": {"user": {"login": "jleach4", "name": "John Leach"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/3efad62049bfd8f8c0039d21200662012a0a7761", "committedDate": "2020-07-02T18:34:00Z", "message": "Fixes #977: RecordMetaData#recordTypesForIndex is N^2 with Universal Index probing."}, "afterCommit": {"oid": "1964f32f2e7381a94dbf32954a018e2703054f09", "author": {"user": {"login": "jleach4", "name": "John Leach"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/1964f32f2e7381a94dbf32954a018e2703054f09", "committedDate": "2020-07-02T18:40:15Z", "message": "Fixes #977: RecordMetaData#recordTypesForIndex is N^2 with Universal Index probing."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxOTQwMzI5", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/978#pullrequestreview-441940329", "createdAt": "2020-07-02T18:43:21Z", "commit": {"oid": "1964f32f2e7381a94dbf32954a018e2703054f09"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxODo0MzoyMVrOGsZSfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxODo0MzoyMVrOGsZSfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIwNDg2MQ==", "bodyText": "Should probably be MapsUtils.computeIfAbsent to avoid the lockup bug", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/978#discussion_r449204861", "createdAt": "2020-07-02T18:43:21Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/RecordMetaData.java", "diffHunk": "@@ -372,25 +375,28 @@ public boolean usesSubspaceKeyCounter() {\n \n     @Nonnull\n     public Collection<RecordType> recordTypesForIndex(@Nonnull Index index) {\n-        if (getUniversalIndexes().contains(index)) {\n-            return getRecordTypes().values();\n-        }\n-        List<RecordType> result = new ArrayList<>();\n-        for (RecordType recordType : getRecordTypes().values()) {\n-            if (recordType.getIndexes().contains(index)) {\n-                return Collections.singletonList(recordType);\n-            } else if (recordType.getMultiTypeIndexes().contains(index)) {\n-                result.add(recordType);\n-            }\n-        }\n-        for (SyntheticRecordType<?> recordType : getSyntheticRecordTypes().values()) {\n-            if (recordType.getIndexes().contains(index)) {\n-                return Collections.singletonList(recordType);\n-            } else if (recordType.getMultiTypeIndexes().contains(index)) {\n-                result.add(recordType);\n+        return recordTypesForIndex.computeIfAbsent(index, idx -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1964f32f2e7381a94dbf32954a018e2703054f09"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3e1594bde696f8ed59f989476944a5c4b9404f4", "author": {"user": {"login": "jleach4", "name": "John Leach"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/f3e1594bde696f8ed59f989476944a5c4b9404f4", "committedDate": "2020-07-02T18:47:46Z", "message": "Fixes #977: RecordMetaData#recordTypesForIndex is N^2 with Universal Index probing."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1964f32f2e7381a94dbf32954a018e2703054f09", "author": {"user": {"login": "jleach4", "name": "John Leach"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/1964f32f2e7381a94dbf32954a018e2703054f09", "committedDate": "2020-07-02T18:40:15Z", "message": "Fixes #977: RecordMetaData#recordTypesForIndex is N^2 with Universal Index probing."}, "afterCommit": {"oid": "f3e1594bde696f8ed59f989476944a5c4b9404f4", "author": {"user": {"login": "jleach4", "name": "John Leach"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/f3e1594bde696f8ed59f989476944a5c4b9404f4", "committedDate": "2020-07-02T18:47:46Z", "message": "Fixes #977: RecordMetaData#recordTypesForIndex is N^2 with Universal Index probing."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxOTQzODMz", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/978#pullrequestreview-441943833", "createdAt": "2020-07-02T18:49:32Z", "commit": {"oid": "f3e1594bde696f8ed59f989476944a5c4b9404f4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3NDQwNDA3", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/978#pullrequestreview-447440407", "createdAt": "2020-07-13T17:09:04Z", "commit": {"oid": "f3e1594bde696f8ed59f989476944a5c4b9404f4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2646, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}