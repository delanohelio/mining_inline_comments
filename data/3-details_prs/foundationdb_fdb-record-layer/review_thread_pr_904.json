{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzMzgwOTc0", "number": 904, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNjo1NDowMVrODyKNmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozMTowM1rODzCVdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzOTIyNzEyOnYy", "diffSide": "RIGHT", "path": "fdb-record-layer-core/src/test/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStoreTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNjo1NDowMVrOGGC1Lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNjo1NDowMVrOGGC1Lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk5MTAyMg==", "bodyText": "This is maybe a different change, but I believe this is using uncheckedOpen in order to avoid conflicting on the store header create. I suspect we could make this a \"real\" open if we opened the store in a separate, initial transaction before all of this. Then the other operations would just read the store header rather than change it.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/904#discussion_r408991022", "createdAt": "2020-04-15T16:54:01Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/test/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStoreTest.java", "diffHunk": "@@ -2459,55 +2461,56 @@ public void testSubspaceWriteConflict() throws Exception {\n     @Test\n     public void testSubspaceReadWriteConflict() throws Exception {\n         // Double check that it works to have two contexts on same space writing different records without conflict.\n-        FDBRecordContext context1 = openContext();\n-        uncheckedOpenSimpleRecordStore(context1);\n-        FDBRecordStore recordStore1 = recordStore;\n-        recordStore1.saveRecord(TestRecords1Proto.MySimpleRecord.newBuilder().setRecNo(1).build());\n-        try (FDBRecordContext context2 = openContext()) {\n-            uncheckedOpenSimpleRecordStore(context2);\n-            recordStore.saveRecord(TestRecords1Proto.MySimpleRecord.newBuilder().setRecNo(2).build());\n-            commit(context2);\n+        try (FDBRecordContext context1 = openContext()) {\n+            uncheckedOpenSimpleRecordStore(context1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a376cc2d229dc6169d77048cba87d600f67fef30"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzOTIzMjcwOnYy", "diffSide": "RIGHT", "path": "fdb-record-layer-core/src/test/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStoreTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNjo1NTozN1rOGGC41g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNjo1NTozN1rOGGC41g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk5MTk1OA==", "bodyText": "I guess this change here is logic preserving, but we could probably also achieve more or less the same check by asserting that the exception is of type FDBStoreTransactionConflictException (or whatever it's called) instead of FDBStoreRetriableException.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/904#discussion_r408991958", "createdAt": "2020-04-15T16:55:37Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/test/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStoreTest.java", "diffHunk": "@@ -2459,55 +2461,56 @@ public void testSubspaceWriteConflict() throws Exception {\n     @Test\n     public void testSubspaceReadWriteConflict() throws Exception {\n         // Double check that it works to have two contexts on same space writing different records without conflict.\n-        FDBRecordContext context1 = openContext();\n-        uncheckedOpenSimpleRecordStore(context1);\n-        FDBRecordStore recordStore1 = recordStore;\n-        recordStore1.saveRecord(TestRecords1Proto.MySimpleRecord.newBuilder().setRecNo(1).build());\n-        try (FDBRecordContext context2 = openContext()) {\n-            uncheckedOpenSimpleRecordStore(context2);\n-            recordStore.saveRecord(TestRecords1Proto.MySimpleRecord.newBuilder().setRecNo(2).build());\n-            commit(context2);\n+        try (FDBRecordContext context1 = openContext()) {\n+            uncheckedOpenSimpleRecordStore(context1);\n+            FDBRecordStore recordStore1 = recordStore;\n+            recordStore1.saveRecord(TestRecords1Proto.MySimpleRecord.newBuilder().setRecNo(1).build());\n+            try (FDBRecordContext context2 = openContext()) {\n+                uncheckedOpenSimpleRecordStore(context2);\n+                recordStore.saveRecord(TestRecords1Proto.MySimpleRecord.newBuilder().setRecNo(2).build());\n+                commit(context2);\n+            }\n+            commit(context1);\n         }\n-        commit(context1);\n \n         // Again with requested conflict.\n-        FDBRecordContext context3 = openContext();\n-        uncheckedOpenSimpleRecordStore(context3);\n-        FDBRecordStore recordStore3 = recordStore;\n-        recordStore3.addConflictForSubspace(false);\n-        recordStore3.saveRecord(TestRecords1Proto.MySimpleRecord.newBuilder().setRecNo(3).build());\n-        try (FDBRecordContext context4 = openContext()) {\n-            uncheckedOpenSimpleRecordStore(context4);\n-            recordStore.addConflictForSubspace(false);\n-            recordStore.saveRecord(TestRecords1Proto.MySimpleRecord.newBuilder().setRecNo(4).build());\n-            commit(context4);\n-        }\n-        try {\n-            commit(context3);\n-            fail(\"should have gotten failure\");\n-        } catch (FDBExceptions.FDBStoreRetriableException ex) {\n-            assertTrue(ex.getCause() instanceof FDBException);\n-            assertThat(((FDBException)ex.getCause()).getCode(), equalTo(1020)); // not_committed\n+        try (FDBRecordContext context3 = openContext()) {\n+            uncheckedOpenSimpleRecordStore(context3);\n+            FDBRecordStore recordStore3 = recordStore;\n+            recordStore3.addConflictForSubspace(false);\n+            recordStore3.saveRecord(TestRecords1Proto.MySimpleRecord.newBuilder().setRecNo(3).build());\n+            try (FDBRecordContext context4 = openContext()) {\n+                uncheckedOpenSimpleRecordStore(context4);\n+                recordStore.addConflictForSubspace(false);\n+                recordStore.saveRecord(TestRecords1Proto.MySimpleRecord.newBuilder().setRecNo(4).build());\n+                commit(context4);\n+            }\n+            final FDBExceptions.FDBStoreRetriableException exception = assertThrows(FDBExceptions.FDBStoreRetriableException.class,\n+                    () -> commit(context3));\n+            assertThat(((FDBException)exception.getCause()).getCode(), equalTo(1020)); // not_committed", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a376cc2d229dc6169d77048cba87d600f67fef30"}, "originalPosition": 105}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0ODQyMjI4OnYy", "diffSide": "RIGHT", "path": "fdb-record-layer-core/src/test/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStoreUniquenessTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozMTowM1rOGHcMYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDozMTowM1rOGHcMYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1NTEzOA==", "bodyText": "This kind of feels like it should be, like, an \"index\" test rather than a uniqueness test, in that it's really testing that behavior rather than the store's. But probably a rename that could happen later.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/904#discussion_r410455138", "createdAt": "2020-04-17T20:31:03Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/test/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStoreUniquenessTest.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*\n+ * FDBRecordStoreUniquenessTest.java\n+ *\n+ * This source file is part of the FoundationDB open source project\n+ *\n+ * Copyright 2015-2020 Apple Inc. and the FoundationDB project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.apple.foundationdb.record.provider.foundationdb;\n+\n+import com.apple.foundationdb.record.RecordIndexUniquenessViolation;\n+import com.apple.foundationdb.record.TestRecords1Proto;\n+import com.apple.foundationdb.record.TestRecordsBytesProto;\n+import com.apple.foundationdb.tuple.Tuple;\n+import com.apple.test.Tags;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Random;\n+import java.util.concurrent.CompletableFuture;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n+\n+/**\n+ * Tests of uniqueness checks.\n+ */\n+@Tag(Tags.RequiresFDB)\n+public class FDBRecordStoreUniquenessTest extends FDBRecordStoreTestBase {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6552084e235bd57aa5725c3045d462695cbd602"}, "originalPosition": 43}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4871, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}