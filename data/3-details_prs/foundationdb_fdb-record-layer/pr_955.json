{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxNjU4MDI5", "number": 955, "title": "Fixes #952: Local version cache is keyed only by Tuple (i.e., primary key) not subspace", "bodyText": "This changes the local version cache to be keyed by byte[] rather than by Tuple. Then the exact key (in the database) is used to represent the cache entry rather than the record's primary key. This allows multiple stores to be opened in the same transaction and for them to interact with versioned records with the same primary key in each store without having cache entries from one store pollute the cache entries of the other.\nThis meant changing the API. The previous API was just wrong, in that there was absolutely no way to protect oneself from the bug identified in #952, so it has just been removed (despite the fact that this violates are claims of API stability). These APIs probably should have been marked INTERNAL anyway, but I believe they pre-date the API stability annotations, which is why they weren't. I put this against master rather than 2.9 as it is a bug fix that could bite someone who doesn't want to upgrade to 2.9 (despite the API breaking), but perhaps it should be rebased onto that branch if 2.9 is soon.\nThis fixes #952.", "createdAt": "2020-05-22T00:53:44Z", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/955", "merged": true, "mergeCommit": {"oid": "0716849c7c0df4876ff88c1e601e873d122067de"}, "closed": true, "closedAt": "2020-06-17T16:12:16Z", "author": {"login": "alecgrieser"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjzu1qgFqTQxNjk4NjAyMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsMNMGgFqTQzMjU1ODMyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2OTg2MDIx", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/955#pullrequestreview-416986021", "createdAt": "2020-05-22T15:09:23Z", "commit": {"oid": "83b9903d263e09b6f4af7ed4577165f15c70767e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNTowOToyM1rOGZaoKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNTowOTozM1rOGZaokg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMwMzg1MQ==", "bodyText": "Wait, this is wrong", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/955#discussion_r429303851", "createdAt": "2020-05-22T15:09:23Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/test/java/com/apple/foundationdb/record/provider/foundationdb/VersionIndexTest.java", "diffHunk": "@@ -1059,13 +1295,13 @@ public void maxEverVersionWithinTransaction(int testFormatVersion, boolean testS\n         try (FDBRecordContext context = openContext(maxEverVersionHook)) {\n             MySimpleRecord record3 = MySimpleRecord.newBuilder().setRecNo(1066L).build();\n             MySimpleRecord record4 = MySimpleRecord.newBuilder().setRecNo(1415L).build();\n-            recordStore.saveRecord(record3);\n+            FDBRecordVersion version3 = recordStore.saveRecord(record3).getVersion();\n+            assertNotNull(version3);\n             FDBRecordVersion version4 = getBiggerVersion(expectedMaxVersion);\n-            recordStore.saveRecord(record4, version4);\n+            FDBStoredRecord<?> storedRecord4 = recordStore.saveRecord(record4, version4);\n \n             context.commit();\n             assertNotNull(context.getVersionStamp());\n-            FDBRecordVersion version3 = FDBRecordVersion.complete(context.getVersionStamp(), context.getLocalVersion(Tuple.from(record3.getRecNo())).get());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83b9903d263e09b6f4af7ed4577165f15c70767e"}, "originalPosition": 288}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMwMzk1NA==", "bodyText": "as is this", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/955#discussion_r429303954", "createdAt": "2020-05-22T15:09:33Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/test/java/com/apple/foundationdb/record/provider/foundationdb/VersionIndexTest.java", "diffHunk": "@@ -1077,11 +1313,11 @@ public void maxEverVersionWithinTransaction(int testFormatVersion, boolean testS\n             MySimpleRecord record6 = MySimpleRecord.newBuilder().setRecNo(1455L).build();\n             FDBRecordVersion version5 = getBiggerVersion(expectedMaxVersion);\n             recordStore.saveRecord(record5, version5);\n-            recordStore.saveRecord(record6);\n+            FDBRecordVersion version6 = recordStore.saveRecord(record6).getVersion();\n+            assertNotNull(version6);\n \n             context.commit();\n             assertNotNull(context.getVersionStamp());\n-            FDBRecordVersion version6 = FDBRecordVersion.complete(context.getVersionStamp(), context.getLocalVersion(Tuple.from(record6.getRecNo())).get());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83b9903d263e09b6f4af7ed4577165f15c70767e"}, "originalPosition": 302}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "83b9903d263e09b6f4af7ed4577165f15c70767e", "author": {"user": {"login": "alecgrieser", "name": "Alec Grieser"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/83b9903d263e09b6f4af7ed4577165f15c70767e", "committedDate": "2020-05-22T00:48:54Z", "message": "Fixes #952: Local version cache is keyed only by Tuple (i.e., primary key) not subspace\n\nThis changes the local version cache to be keyed by `byte[]` rather than by `Tuple`. Then the exact key (in the database) is used to represent the cache entry rather than the record's primary key. This allows multiple stores to be opened in the same transaction and for them to interact with versioned records with the same primary key in each store without having cache entries from one store pollute the cache entries of the other.\n\nThis meant changing the API. The previous API was just wrong, in that there was absolutely no way to protect oneself from the bug identified in #952, so it has just been removed (despite the fact that this violates are claims of API stability). These APIs probably should have been marked INTERNAL anyway, but I believe they pre-date the API stability annotations, which is why they weren't."}, "afterCommit": {"oid": "bdb5dd92156e1d08bb441787ca0bf0d92881762c", "author": {"user": {"login": "alecgrieser", "name": "Alec Grieser"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/bdb5dd92156e1d08bb441787ca0bf0d92881762c", "committedDate": "2020-05-22T15:15:08Z", "message": "Fixes #952: Local version cache is keyed only by Tuple (i.e., primary key) not subspace\n\nThis changes the local version cache to be keyed by `byte[]` rather than by `Tuple`. Then the exact key (in the database) is used to represent the cache entry rather than the record's primary key. This allows multiple stores to be opened in the same transaction and for them to interact with versioned records with the same primary key in each store without having cache entries from one store pollute the cache entries of the other.\n\nThis meant changing the API. The previous API was just wrong, in that there was absolutely no way to protect oneself from the bug identified in #952, so it has just been removed (despite the fact that this violates are claims of API stability). These APIs probably should have been marked INTERNAL anyway, but I believe they pre-date the API stability annotations, which is why they weren't."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "200702fff640eba3c07a121bd4d934ffa1b6f956", "author": {"user": {"login": "alecgrieser", "name": "Alec Grieser"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/200702fff640eba3c07a121bd4d934ffa1b6f956", "committedDate": "2020-05-28T20:16:51Z", "message": "Fixes #952: Local version cache is keyed only by Tuple (i.e., primary key) not subspace\n\nThis changes the local version cache to be keyed by `byte[]` rather than by `Tuple`. Then the exact key (in the database) is used to represent the cache entry rather than the record's primary key. This allows multiple stores to be opened in the same transaction and for them to interact with versioned records with the same primary key in each store without having cache entries from one store pollute the cache entries of the other.\n\nThis meant changing the API. The previous API was just wrong, in that there was absolutely no way to protect oneself from the bug identified in #952, so it has just been removed (despite the fact that this violates are claims of API stability). These APIs probably should have been marked INTERNAL anyway, but I believe they pre-date the API stability annotations, which is why they weren't."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bdb5dd92156e1d08bb441787ca0bf0d92881762c", "author": {"user": {"login": "alecgrieser", "name": "Alec Grieser"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/bdb5dd92156e1d08bb441787ca0bf0d92881762c", "committedDate": "2020-05-22T15:15:08Z", "message": "Fixes #952: Local version cache is keyed only by Tuple (i.e., primary key) not subspace\n\nThis changes the local version cache to be keyed by `byte[]` rather than by `Tuple`. Then the exact key (in the database) is used to represent the cache entry rather than the record's primary key. This allows multiple stores to be opened in the same transaction and for them to interact with versioned records with the same primary key in each store without having cache entries from one store pollute the cache entries of the other.\n\nThis meant changing the API. The previous API was just wrong, in that there was absolutely no way to protect oneself from the bug identified in #952, so it has just been removed (despite the fact that this violates are claims of API stability). These APIs probably should have been marked INTERNAL anyway, but I believe they pre-date the API stability annotations, which is why they weren't."}, "afterCommit": {"oid": "200702fff640eba3c07a121bd4d934ffa1b6f956", "author": {"user": {"login": "alecgrieser", "name": "Alec Grieser"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/200702fff640eba3c07a121bd4d934ffa1b6f956", "committedDate": "2020-05-28T20:16:51Z", "message": "Fixes #952: Local version cache is keyed only by Tuple (i.e., primary key) not subspace\n\nThis changes the local version cache to be keyed by `byte[]` rather than by `Tuple`. Then the exact key (in the database) is used to represent the cache entry rather than the record's primary key. This allows multiple stores to be opened in the same transaction and for them to interact with versioned records with the same primary key in each store without having cache entries from one store pollute the cache entries of the other.\n\nThis meant changing the API. The previous API was just wrong, in that there was absolutely no way to protect oneself from the bug identified in #952, so it has just been removed (despite the fact that this violates are claims of API stability). These APIs probably should have been marked INTERNAL anyway, but I believe they pre-date the API stability annotations, which is why they weren't."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNTU4MzIz", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/955#pullrequestreview-432558323", "createdAt": "2020-06-17T16:12:01Z", "commit": {"oid": "200702fff640eba3c07a121bd4d934ffa1b6f956"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2615, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}