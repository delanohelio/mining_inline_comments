{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5NDkwOTQ0", "number": 1069, "title": "Resolves #1068: Could allow degenerate composed bitmaps from single index", "bodyText": "", "createdAt": "2020-11-11T22:40:45Z", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1069", "merged": true, "mergeCommit": {"oid": "9e92d7a368a0beaf4ab5f5c88c48efb48dc6791d"}, "closed": true, "closedAt": "2020-11-12T22:22:12Z", "author": {"login": "MMcM"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbl3BzgH2gAyNTE5NDkwOTQ0OjMxZWRkNTAyYjU2ZTE4YzhlZGExODlmZjExMWRkMmEyNmNiOTFlNWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdb6M6HgFqTUyOTU0NzI4Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "31edd502b56e18c8eda189ff111dd2a26cb91e5b", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/31edd502b56e18c8eda189ff111dd2a26cb91e5b", "committedDate": "2020-11-11T22:39:47Z", "message": "Resolves #1068: Could allow degenerate composed bitmaps from single index"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NTg3OTU0", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1069#pullrequestreview-528587954", "createdAt": "2020-11-11T22:41:24Z", "commit": {"oid": "31edd502b56e18c8eda189ff111dd2a26cb91e5b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMjo0MToyNFrOHxg7YA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMjo0MToyNFrOHxg7YA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4MTc2MA==", "bodyText": "I believe that an earlier review of this class suggested that this was a more appropriate signature. It didn't matter then, but it does now.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1069#discussion_r521681760", "createdAt": "2020-11-11T22:41:24Z", "author": {"login": "MMcM"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/bitmap/ComposedBitmapIndexAggregate.java", "diffHunk": "@@ -82,9 +83,9 @@\n      * @return an {@code Optional} query plan or {@code Optional.empty} if planning is not possible\n      */\n     @Nonnull\n-    public static Optional<ComposedBitmapIndexQueryPlan> tryPlan(@Nonnull RecordQueryPlanner planner,\n-                                                                 @Nonnull RecordQuery query,\n-                                                                 @Nonnull IndexAggregateFunction indexAggregateFunction) {\n+    public static Optional<RecordQueryPlan> tryPlan(@Nonnull RecordQueryPlanner planner,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31edd502b56e18c8eda189ff111dd2a26cb91e5b"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NjEwNTYz", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1069#pullrequestreview-528610563", "createdAt": "2020-11-11T23:28:22Z", "commit": {"oid": "31edd502b56e18c8eda189ff111dd2a26cb91e5b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMzoyODoyM1rOHxiFPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMzoyOTo0OVrOHxiHKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTcwMDY3MQ==", "bodyText": "Is this correct if there's a NOT in the composer tree against a single index scan?\nAlso, separately, without this change, would it have returned a ComposedBitmapIndexQueryPlan with a single IndexNode in the tree (which I think is correct, but perhaps inefficient), or would it have returned something less good?", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1069#discussion_r521700671", "createdAt": "2020-11-11T23:28:23Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/bitmap/ComposedBitmapIndexAggregate.java", "diffHunk": "@@ -99,12 +100,18 @@\n      * @return an {@code Optional} query plan or {@code Optional.empty} if planning is not possible\n      */\n     @Nonnull\n-    public Optional<ComposedBitmapIndexQueryPlan> tryPlan(@Nonnull RecordQueryPlanner planner,\n-                                                          @Nonnull RecordQuery.Builder queryBuilder) {\n+    public Optional<RecordQueryPlan> tryPlan(@Nonnull RecordQueryPlanner planner,\n+                                             @Nonnull RecordQuery.Builder queryBuilder) {\n         final List<RecordQueryCoveringIndexPlan> indexScans = new ArrayList<>();\n         final Map<IndexNode, ComposedBitmapIndexQueryPlan.IndexComposer> indexComposers = new IdentityHashMap<>();\n-        return Optional.ofNullable(plan(root, queryBuilder, planner, indexScans, indexComposers))\n-                .map(composer -> new ComposedBitmapIndexQueryPlan(indexScans, composer));\n+        final ComposedBitmapIndexQueryPlan.ComposerBase composer = plan(root, queryBuilder, planner, indexScans, indexComposers);\n+        if (composer == null || indexScans.isEmpty()) {\n+            return Optional.empty();\n+        }\n+        if (indexScans.size() == 1) {\n+            return Optional.ofNullable(indexScans.get(0));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31edd502b56e18c8eda189ff111dd2a26cb91e5b"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTcwMTE2MA==", "bodyText": "I guess this class doesn't have an API stability annotation. It kind of feels like it should have been marked experimental, but alas. Not sure how much of a stickler we want to be here. My inclination here is to just let the signature be changed.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1069#discussion_r521701160", "createdAt": "2020-11-11T23:29:49Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/bitmap/ComposedBitmapIndexAggregate.java", "diffHunk": "@@ -82,9 +83,9 @@\n      * @return an {@code Optional} query plan or {@code Optional.empty} if planning is not possible\n      */\n     @Nonnull\n-    public static Optional<ComposedBitmapIndexQueryPlan> tryPlan(@Nonnull RecordQueryPlanner planner,\n-                                                                 @Nonnull RecordQuery query,\n-                                                                 @Nonnull IndexAggregateFunction indexAggregateFunction) {\n+    public static Optional<RecordQueryPlan> tryPlan(@Nonnull RecordQueryPlanner planner,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4MTc2MA=="}, "originalCommit": {"oid": "31edd502b56e18c8eda189ff111dd2a26cb91e5b"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1bf17f08cd6ba9a2d3310a674d099435ba8fa26", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/f1bf17f08cd6ba9a2d3310a674d099435ba8fa26", "committedDate": "2020-11-12T02:56:00Z", "message": "Add missing annotations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NTQ3Mjgy", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1069#pullrequestreview-529547282", "createdAt": "2020-11-12T22:21:47Z", "commit": {"oid": "f1bf17f08cd6ba9a2d3310a674d099435ba8fa26"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2496, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}