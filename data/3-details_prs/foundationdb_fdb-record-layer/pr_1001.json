{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1MzcyMjY1", "number": 1001, "title": "Resolves #1000: Some filters can be performed with covering index \u2026", "bodyText": "\u2026 scan's partial record.\n\nMake FunctionKeyExpression.Builder's abstract function public so can be defined anywhere.\nPlanner attempts to match the key expressions corresponding to the filter component to the index entry.\nDo a similar match in the QueryToKeyMatcher.", "createdAt": "2020-07-22T21:47:49Z", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1001", "merged": true, "mergeCommit": {"oid": "5c5a781435c9229cfc05bc619f1cd484c3ea8515"}, "closed": true, "closedAt": "2020-07-30T16:08:22Z", "author": {"login": "MMcM"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3x_jegBqjM1ODA3NzM4MDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc6B7DnAFqTQ1ODU0OTExMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7bde5f7604709edb932dc66b9616ca555b67ba9b", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/7bde5f7604709edb932dc66b9616ca555b67ba9b", "committedDate": "2020-07-22T21:46:20Z", "message": "Resolves #1000: Some filters can be performed with covering index scan's partial record.\nAttempt to match the key expressions corresponding to the filter component to the index entry."}, "afterCommit": {"oid": "22d596cb7fdcdefe5c2134399fc1272067392626", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/22d596cb7fdcdefe5c2134399fc1272067392626", "committedDate": "2020-07-23T16:24:54Z", "message": "Adjust QueryToKeyMatcher to handle QueryableKeyExpression"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "22d596cb7fdcdefe5c2134399fc1272067392626", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/22d596cb7fdcdefe5c2134399fc1272067392626", "committedDate": "2020-07-23T16:24:54Z", "message": "Adjust QueryToKeyMatcher to handle QueryableKeyExpression"}, "afterCommit": {"oid": "8e60f90992ba53a73264c7d99660cf04f7931e56", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/8e60f90992ba53a73264c7d99660cf04f7931e56", "committedDate": "2020-07-23T16:46:39Z", "message": "Adjust QueryToKeyMatcher to handle QueryableKeyExpression"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8e60f90992ba53a73264c7d99660cf04f7931e56", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/8e60f90992ba53a73264c7d99660cf04f7931e56", "committedDate": "2020-07-23T16:46:39Z", "message": "Adjust QueryToKeyMatcher to handle QueryableKeyExpression"}, "afterCommit": {"oid": "922fe9a0db691901824a81016af42ee9649a73c7", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/922fe9a0db691901824a81016af42ee9649a73c7", "committedDate": "2020-07-23T17:08:38Z", "message": "Adjust QueryToKeyMatcher to handle QueryableKeyExpression"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MzQ1NTcx", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1001#pullrequestreview-454345571", "createdAt": "2020-07-23T17:24:48Z", "commit": {"oid": "922fe9a0db691901824a81016af42ee9649a73c7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNzoyNDo0OFrOG2UWBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNzoyNDo0OFrOG2UWBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYwOTYwNQ==", "bodyText": "A text index, in particular, does not have the actual indexed text in the entry.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1001#discussion_r459609605", "createdAt": "2020-07-23T17:24:48Z", "author": {"login": "MMcM"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/RecordQueryPlanner.java", "diffHunk": "@@ -1351,27 +1355,44 @@ private QueryComponent normalizeAndOrForInAsOr(@Nonnull QueryComponent component\n     }\n \n     @Nonnull\n+    @SuppressWarnings(\"PMD.CompareObjectsWithEquals\")\n     private RecordQueryPlan tryToConvertToCoveringPlan(@Nonnull PlanContext planContext, @Nonnull RecordQueryPlan chosenPlan) {\n         if (chosenPlan instanceof RecordQueryPlanWithIndex) {\n             // Check if the index scan covers, then convert it to a covering plan.\n-            return tryToConvertToCoveringPlan(planContext, (RecordQueryPlanWithIndex) chosenPlan);\n+            return tryToConvertToCoveringPlan(planContext, (RecordQueryPlanWithIndex) chosenPlan, null);\n         } else if (chosenPlan instanceof RecordQueryUnorderedPrimaryKeyDistinctPlan) {\n             // If possible, push down the covering index transformation so that\n             // it happens before checking for distinct primary keys\n             final RecordQueryUnorderedPrimaryKeyDistinctPlan distinctPlan = (RecordQueryUnorderedPrimaryKeyDistinctPlan) chosenPlan;\n             if (distinctPlan.getChild() instanceof RecordQueryPlanWithIndex) {\n-                final RecordQueryPlan newChildPlan = tryToConvertToCoveringPlan(planContext, (RecordQueryPlanWithIndex) distinctPlan.getChild());\n+                final RecordQueryPlan newChildPlan = tryToConvertToCoveringPlan(planContext, (RecordQueryPlanWithIndex) distinctPlan.getChild(), null);\n                 if (newChildPlan != distinctPlan.getChild()) {\n                     return new RecordQueryUnorderedPrimaryKeyDistinctPlan(newChildPlan);\n                 }\n             }\n+        } else if (chosenPlan instanceof RecordQueryFilterPlan) {\n+            final RecordQueryFilterPlan filterPlan = (RecordQueryFilterPlan)chosenPlan;\n+            if (filterPlan.getChild() instanceof RecordQueryPlanWithIndex) {\n+                final RecordQueryPlanWithIndex filteredIndexPlan = (RecordQueryPlanWithIndex) filterPlan.getChild();\n+                final Index index = metaData.getIndex(filteredIndexPlan.getIndexName());\n+                if (indexTypes.getValueTypes().contains(index.getType())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "922fe9a0db691901824a81016af42ee9649a73c7"}, "originalPosition": 49}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "922fe9a0db691901824a81016af42ee9649a73c7", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/922fe9a0db691901824a81016af42ee9649a73c7", "committedDate": "2020-07-23T17:08:38Z", "message": "Adjust QueryToKeyMatcher to handle QueryableKeyExpression"}, "afterCommit": {"oid": "53e2a09be9c53b368f4fa991936cc93053628a21", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/53e2a09be9c53b368f4fa991936cc93053628a21", "committedDate": "2020-07-28T21:59:15Z", "message": "Adjust QueryToKeyMatcher to handle QueryableKeyExpression"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3OTY1MDcz", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1001#pullrequestreview-457965073", "createdAt": "2020-07-29T23:26:30Z", "commit": {"oid": "53e2a09be9c53b368f4fa991936cc93053628a21"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMzoyNjozMVrOG5NsGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMzozNDowMlrOG5N05Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY0NjI5Nw==", "bodyText": "This is a great point. I think it's worth adding it as a comment here in case someone forgets this in the future.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1001#discussion_r462646297", "createdAt": "2020-07-29T23:26:31Z", "author": {"login": "nschiefer"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/RecordQueryPlanner.java", "diffHunk": "@@ -1351,27 +1355,44 @@ private QueryComponent normalizeAndOrForInAsOr(@Nonnull QueryComponent component\n     }\n \n     @Nonnull\n+    @SuppressWarnings(\"PMD.CompareObjectsWithEquals\")\n     private RecordQueryPlan tryToConvertToCoveringPlan(@Nonnull PlanContext planContext, @Nonnull RecordQueryPlan chosenPlan) {\n         if (chosenPlan instanceof RecordQueryPlanWithIndex) {\n             // Check if the index scan covers, then convert it to a covering plan.\n-            return tryToConvertToCoveringPlan(planContext, (RecordQueryPlanWithIndex) chosenPlan);\n+            return tryToConvertToCoveringPlan(planContext, (RecordQueryPlanWithIndex) chosenPlan, null);\n         } else if (chosenPlan instanceof RecordQueryUnorderedPrimaryKeyDistinctPlan) {\n             // If possible, push down the covering index transformation so that\n             // it happens before checking for distinct primary keys\n             final RecordQueryUnorderedPrimaryKeyDistinctPlan distinctPlan = (RecordQueryUnorderedPrimaryKeyDistinctPlan) chosenPlan;\n             if (distinctPlan.getChild() instanceof RecordQueryPlanWithIndex) {\n-                final RecordQueryPlan newChildPlan = tryToConvertToCoveringPlan(planContext, (RecordQueryPlanWithIndex) distinctPlan.getChild());\n+                final RecordQueryPlan newChildPlan = tryToConvertToCoveringPlan(planContext, (RecordQueryPlanWithIndex) distinctPlan.getChild(), null);\n                 if (newChildPlan != distinctPlan.getChild()) {\n                     return new RecordQueryUnorderedPrimaryKeyDistinctPlan(newChildPlan);\n                 }\n             }\n+        } else if (chosenPlan instanceof RecordQueryFilterPlan) {\n+            final RecordQueryFilterPlan filterPlan = (RecordQueryFilterPlan)chosenPlan;\n+            if (filterPlan.getChild() instanceof RecordQueryPlanWithIndex) {\n+                final RecordQueryPlanWithIndex filteredIndexPlan = (RecordQueryPlanWithIndex) filterPlan.getChild();\n+                final Index index = metaData.getIndex(filteredIndexPlan.getIndexName());\n+                if (indexTypes.getValueTypes().contains(index.getType())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYwOTYwNQ=="}, "originalCommit": {"oid": "922fe9a0db691901824a81016af42ee9649a73c7"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY0ODU0OQ==", "bodyText": "I think that this part here only works because findFilterCoveredFields() ignored nested repeated fields entirely. That's fine with me, but I think it needs a comment to that effect or someone might mess this up later.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1001#discussion_r462648549", "createdAt": "2020-07-29T23:34:02Z", "author": {"login": "nschiefer"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/query/plan/RecordQueryPlanner.java", "diffHunk": "@@ -1384,6 +1405,11 @@ private RecordQueryPlan tryToConvertToCoveringPlan(@Nonnull PlanContext context,\n         for (KeyExpression resultField : context.query.getRequiredResults()) {\n             resultFields.addAll(resultField.normalizeKeyForPositions());\n         }\n+        if (filterFields != null) {\n+            for (KeyExpression filterField : filterFields) {\n+                resultFields.addAll(filterField.normalizeKeyForPositions());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53e2a09be9c53b368f4fa991936cc93053628a21"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05fe8770a5d0a7d9d766f5787268f7775865f3eb", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/05fe8770a5d0a7d9d766f5787268f7775865f3eb", "committedDate": "2020-07-29T23:41:26Z", "message": "Allow FunctionKeyExpression Builder to be in any package"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c965e6c87271aef8c351430f1127a9d1e85645b2", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/c965e6c87271aef8c351430f1127a9d1e85645b2", "committedDate": "2020-07-29T23:41:26Z", "message": "Resolves #1000: Some filters can be performed with covering index scan's partial record.\nAttempt to match the key expressions corresponding to the filter component to the index entry."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fe7e570b9d6c56db7600472ff334de278f86b87", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/8fe7e570b9d6c56db7600472ff334de278f86b87", "committedDate": "2020-07-29T23:41:26Z", "message": "Adjust QueryToKeyMatcher to handle QueryableKeyExpression"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f81fb9b2b862e582f5c1c35b924d2bbbfaebc23", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/9f81fb9b2b862e582f5c1c35b924d2bbbfaebc23", "committedDate": "2020-07-29T23:52:27Z", "message": "Some comments about delicate aspects of these transformations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "53e2a09be9c53b368f4fa991936cc93053628a21", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/53e2a09be9c53b368f4fa991936cc93053628a21", "committedDate": "2020-07-28T21:59:15Z", "message": "Adjust QueryToKeyMatcher to handle QueryableKeyExpression"}, "afterCommit": {"oid": "9f81fb9b2b862e582f5c1c35b924d2bbbfaebc23", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/9f81fb9b2b862e582f5c1c35b924d2bbbfaebc23", "committedDate": "2020-07-29T23:52:27Z", "message": "Some comments about delicate aspects of these transformations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NTQ5MTEx", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1001#pullrequestreview-458549111", "createdAt": "2020-07-30T16:08:06Z", "commit": {"oid": "9f81fb9b2b862e582f5c1c35b924d2bbbfaebc23"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2698, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}