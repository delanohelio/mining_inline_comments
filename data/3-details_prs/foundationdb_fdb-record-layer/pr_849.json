{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2OTQ2OTc3", "number": 849, "title": "Resolves #848: Allow for setting the FDB transaction timeout on FDBRecordContexts", "bodyText": "I, um, don't quite know how this blew up into ~700 lines added, but alas. The main goal of this change is to allow for the transaction timeout to be specified through the FDBRecordContext. In theory, one could always have called ensureActive and then set the option manually, but it seemed better to have a real way of doing this without needing to peek at internals.\nThis is broken into two commits:\n\nThe first refactors FDBRecordContext to take a Config object at creation. This is to ameliorate the fact that there was a growing number of essentially optional parameters into the object, so now those are hidden in an object. But that commit shouldn't make any functional changes except (because it simplified the implementation considerably), it is now the case that if you explicitly set a transaction ID to null, then it will still look in the MDC context for a uuid key. We could keep that behavior the same by, like, distinguishing between a \"default\" transaction ID and a \"set to null\" transaction ID, but I didn't.\nThe second adds to that config object a \"timeout\" parameter. The FDBDatabaseFactory and FDBDatabaseRunner classes also have timeout parameters, and transactions created by a runner will use the runner's timeout value if set, and all transactions will default to the database factory's value if unset. And, if nothing in these classes sets a timeout, it will use the value set at the FDB level, so this should be compatible with existing code that has used the various end-runs around the Record Layer to set these values already.\n\nThis resolves #848.", "createdAt": "2020-03-11T22:18:11Z", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/849", "merged": true, "mergeCommit": {"oid": "f7158cfb4d2cba31c833602938373ad87fc80e51"}, "closed": true, "closedAt": "2020-03-13T21:18:52Z", "author": {"login": "alecgrieser"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMuzUyAFqTM3MzE2NzE1Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNWymugFqTM3NDYxNzAwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMTY3MTUz", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/849#pullrequestreview-373167153", "createdAt": "2020-03-11T22:21:52Z", "commit": {"oid": "6457a8c264955a887a2e7c7ca71cfa59dc9736ef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQyMjoyMTo1MlrOF1LT0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQyMjoyMTo1MlrOF1LT0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMwNDE0Ng==", "bodyText": "This is alluding to that behavior change regarding the transaction ID that is mentioned in the PR's overview comment.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/849#discussion_r391304146", "createdAt": "2020-03-11T22:21:52Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabase.java", "diffHunk": "@@ -358,20 +358,19 @@ public FDBRecordContext openContext(@Nullable Map<String, String> mdcContext,\n                                         @Nullable FDBStoreTimer timer,\n                                         @Nullable WeakReadSemantics weakReadSemantics,\n                                         @Nonnull FDBTransactionPriority priority) {\n-        final String transactionId = mdcContext == null ? null : mdcContext.get(\"uuid\");\n-        return openContext(mdcContext, timer, weakReadSemantics, priority, transactionId);\n+        return openContext(mdcContext, timer, weakReadSemantics, priority, null);\n     }\n \n \n     /**\n      * Open a new record context with a new transaction begun on the underlying FDB database.\n      *\n      * <p>\n-     * Note that other variants of this method will inspect the MDC context for the transaction ID by looking\n-     * for an entry in the map with the key \"uuid\". This method will ignore whatever is in the MDC context\n-     * and use the ID provided as a parameter instead. The transaction ID should typically consist solely of\n-     * printable ASCII characters and should not exceed 100 bytes. The ID may be truncated or dropped if the ID will\n-     * not fit in 100 bytes. See {@link FDBRecordContext#getTransactionId()} for more details.\n+     * If the passed {@code transactionId} is {@code null}, then this method will set the transaction ID\n+     * of the given transaction to the value of the \"uuid\" key in the MDC context if present. The transaction ID\n+     * should typically consist solely of printable ASCII characters and should not exceed 100 bytes. The ID may\n+     * be truncated or dropped if the ID will not fit in 100 bytes. See {@link FDBRecordContext#getTransactionId()}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6457a8c264955a887a2e7c7ca71cfa59dc9736ef"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMTcxMDIx", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/849#pullrequestreview-373171021", "createdAt": "2020-03-11T22:31:00Z", "commit": {"oid": "6457a8c264955a887a2e7c7ca71cfa59dc9736ef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQyMjozMTowMFrOF1LgqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQyMjozMTowMFrOF1LgqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMwNzQzMg==", "bodyText": "These are \"breaking changes\" for implementors of the interface, if we care about that use case. They are fine for those that are using the interface.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/849#discussion_r391307432", "createdAt": "2020-03-11T22:31:00Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabaseRunner.java", "diffHunk": "@@ -201,6 +201,32 @@\n      */\n     void setInitialDelayMillis(long initialDelayMillis);\n \n+    /**\n+     * Set the transaction timeout for all transactions started by this runner. If set to {@link FDBDatabaseFactory#DEFAULT_TR_TIMEOUT_MILLIS},\n+     * then this will use the value of set in the originating database's factory. If set to {@link FDBDatabaseFactory#UNLIMITED_TR_TIMEOUT_MILLIS},\n+     * then no timeout will be imposed on transactions used by this runner.\n+     *\n+     * <p>\n+     * Note that the error that the transaction hits, {@link FDBExceptions.FDBStoreTransactionTimeoutException},\n+     * is not retriable, so if the runner encounters such an error, it will terminate.\n+     * </p>\n+     *\n+     * @param transactionTimeoutMillis the transaction timeout time in milliseconds\n+     * @see FDBDatabaseFactory#setTransactionTimeoutMillis(long)\n+     */\n+    void setTransactionTimeoutMillis(long transactionTimeoutMillis);\n+\n+    /**\n+     * Get the transaction timeout for all transactions started by this runner. This will return the value configured\n+     * for this runner through {@link #setTransactionTimeoutMillis(long)}. Note, however, that if the transaction timeout\n+     * is set to {@link FDBDatabaseFactory#DEFAULT_TR_TIMEOUT_MILLIS}, then the actual timeout set for this transaction\n+     * will be set to the value in the originating factory.\n+     *\n+     * @return the configured transacation timeout time in milliseconds\n+     * @see #setTransactionTimeoutMillis(long)\n+     */\n+    long getTransactionTimeoutMillis();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6457a8c264955a887a2e7c7ca71cfa59dc9736ef"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77c47cab5ca804e4ab48ac534b291a2d431a0d77", "author": {"user": {"login": "alecgrieser", "name": "Alec Grieser"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/77c47cab5ca804e4ab48ac534b291a2d431a0d77", "committedDate": "2020-03-12T21:03:32Z", "message": "refactor FDBRecordContext configuration to a separate config object with a builder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b3d04db56637ac0120aad6a9d0ecb20e0edbd73", "author": {"user": {"login": "alecgrieser", "name": "Alec Grieser"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/3b3d04db56637ac0120aad6a9d0ecb20e0edbd73", "committedDate": "2020-03-12T21:03:43Z", "message": "Resolves #848: Allow for setting the FDB transaction timeout on FDBRecordContexts\n\nThis adds a configuration option to the FDBRecordContextConfig that allows the user to set a transaction timeout. It also allows the user to specify a default value for that timeout, either for the full database or on a specific runner."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MDEwNTI0", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/849#pullrequestreview-374010524", "createdAt": "2020-03-13T02:29:58Z", "commit": {"oid": "6457a8c264955a887a2e7c7ca71cfa59dc9736ef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NTkxNjYy", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/849#pullrequestreview-374591662", "createdAt": "2020-03-13T20:16:04Z", "commit": {"oid": "9073ed7f9236e9db6ebffb73ee3b167705a32ba6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QyMDoxNjowNVrOF2RBrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QyMDoyMDoxNVrOF2RIzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ0NjM4Mw==", "bodyText": "(just a comment, nothing to do) I kind of have a preference for FDBRecordContext.Config, but given the size of this class I get why you did this.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/849#discussion_r392446383", "createdAt": "2020-03-13T20:16:05Z", "author": {"login": "scgray"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordContextConfig.java", "diffHunk": "@@ -0,0 +1,308 @@\n+/*\n+ * FDBRecordContextConfig.java\n+ *\n+ * This source file is part of the FoundationDB open source project\n+ *\n+ * Copyright 2015-2020 Apple Inc. and the FoundationDB project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.apple.foundationdb.record.provider.foundationdb;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import java.util.Map;\n+\n+/**\n+ * A configuration struct that can be used to set various options on an {@link FDBRecordContext}. Instances\n+ * of this configuration object can be passed to {@link FDBDatabase#openContext(FDBRecordContextConfig)}\n+ * to create a new transaction with various parameters set according to the values specified here.\n+ */\n+public class FDBRecordContextConfig {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9073ed7f9236e9db6ebffb73ee3b167705a32ba6"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ0ODIwNw==", "bodyText": "Maybe the release notes should call out this minor (unlikely) breaking change (I did something like this on 2.8.103.0:\n\nBreaking change ByteScanLimiter and RecordScanLimiter are now interfaces. Instances with various concrete behavior are constructed through factory classes. (PR #836)", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/849#discussion_r392448207", "createdAt": "2020-03-13T20:20:15Z", "author": {"login": "scgray"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabaseRunner.java", "diffHunk": "@@ -201,6 +201,32 @@\n      */\n     void setInitialDelayMillis(long initialDelayMillis);\n \n+    /**\n+     * Set the transaction timeout for all transactions started by this runner. If set to {@link FDBDatabaseFactory#DEFAULT_TR_TIMEOUT_MILLIS},\n+     * then this will use the value of set in the originating database's factory. If set to {@link FDBDatabaseFactory#UNLIMITED_TR_TIMEOUT_MILLIS},\n+     * then no timeout will be imposed on transactions used by this runner.\n+     *\n+     * <p>\n+     * Note that the error that the transaction hits, {@link FDBExceptions.FDBStoreTransactionTimeoutException},\n+     * is not retriable, so if the runner encounters such an error, it will terminate.\n+     * </p>\n+     *\n+     * @param transactionTimeoutMillis the transaction timeout time in milliseconds\n+     * @see FDBDatabaseFactory#setTransactionTimeoutMillis(long)\n+     */\n+    void setTransactionTimeoutMillis(long transactionTimeoutMillis);\n+\n+    /**\n+     * Get the transaction timeout for all transactions started by this runner. This will return the value configured\n+     * for this runner through {@link #setTransactionTimeoutMillis(long)}. Note, however, that if the transaction timeout\n+     * is set to {@link FDBDatabaseFactory#DEFAULT_TR_TIMEOUT_MILLIS}, then the actual timeout set for this transaction\n+     * will be set to the value in the originating factory.\n+     *\n+     * @return the configured transacation timeout time in milliseconds\n+     * @see #setTransactionTimeoutMillis(long)\n+     */\n+    long getTransactionTimeoutMillis();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMwNzQzMg=="}, "originalCommit": {"oid": "6457a8c264955a887a2e7c7ca71cfa59dc9736ef"}, "originalPosition": 28}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6457a8c264955a887a2e7c7ca71cfa59dc9736ef", "author": {"user": {"login": "alecgrieser", "name": "Alec Grieser"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/6457a8c264955a887a2e7c7ca71cfa59dc9736ef", "committedDate": "2020-03-11T22:06:28Z", "message": "Resolves #848: Allow for setting the FDB transaction timeout on FDBRecordContexts\n\nThis adds a configuration option to the FDBRecordContextConfig that allows the user to set a transaction timeout. It also allows the user to specify a default value for that timeout, either for the full database or on a specific runner."}, "afterCommit": {"oid": "654df54e19673cfcd22fc82668fabb3082d4eb21", "author": {"user": {"login": "alecgrieser", "name": "Alec Grieser"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/654df54e19673cfcd22fc82668fabb3082d4eb21", "committedDate": "2020-03-13T20:55:09Z", "message": "add release notes for two breaking changes coming out of #849"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1df078149e36a331da46caf0c65f89d2250ff2f", "author": {"user": {"login": "alecgrieser", "name": "Alec Grieser"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/b1df078149e36a331da46caf0c65f89d2250ff2f", "committedDate": "2020-03-13T20:59:53Z", "message": "add release notes for two breaking changes coming out of #849"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "654df54e19673cfcd22fc82668fabb3082d4eb21", "author": {"user": {"login": "alecgrieser", "name": "Alec Grieser"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/654df54e19673cfcd22fc82668fabb3082d4eb21", "committedDate": "2020-03-13T20:55:09Z", "message": "add release notes for two breaking changes coming out of #849"}, "afterCommit": {"oid": "b1df078149e36a331da46caf0c65f89d2250ff2f", "author": {"user": {"login": "alecgrieser", "name": "Alec Grieser"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/b1df078149e36a331da46caf0c65f89d2250ff2f", "committedDate": "2020-03-13T20:59:53Z", "message": "add release notes for two breaking changes coming out of #849"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NjE3MDA2", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/849#pullrequestreview-374617006", "createdAt": "2020-03-13T21:00:18Z", "commit": {"oid": "b1df078149e36a331da46caf0c65f89d2250ff2f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2537, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}