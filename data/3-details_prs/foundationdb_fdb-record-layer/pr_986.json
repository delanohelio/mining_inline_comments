{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyODYzODgx", "number": 986, "title": "Resolves #985: Get rid of finalizer", "bodyText": "Includes #984", "createdAt": "2020-07-01T18:12:44Z", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/986", "merged": true, "mergeCommit": {"oid": "46677245865ea993bd241e08dd12ebab153a687a"}, "closed": true, "closedAt": "2020-07-02T17:50:13Z", "author": {"login": "MMcM"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwzM27gFqTQ0MTI1ODk0Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcxCmDqgFqTQ0MTkwNzQwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjU4OTQz", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/986#pullrequestreview-441258943", "createdAt": "2020-07-01T23:35:22Z", "commit": {"oid": "0b138786b7b9081a2177614df40b86282fcdb172"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMzozNToyM1rOGr4lYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMzo1MjozOFrOGr44yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2OTAyNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @param warnAndCloseOpenContextsAfterSeconds  number of seconds after which a context and be closed and a warning logged\n          \n          \n            \n                 * @param warnAndCloseOpenContextsAfterSeconds number of seconds after which a context and be closed and a warning logged", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/986#discussion_r448669025", "createdAt": "2020-07-01T23:35:23Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabaseFactory.java", "diffHunk": "@@ -480,6 +482,22 @@ public void setTransactionIsTracedSupplier(Supplier<Boolean> transactionIsTraced\n         return transactionIsTracedSupplier;\n     }\n \n+    /**\n+     * Get whether to warn and close record contexts open for too long.\n+     * @return number of seconds after which a context and be closed and a warning logged\n+     */\n+    public long getWarnAndCloseOpenContextsAfterSeconds() {\n+        return warnAndCloseOpenContextsAfterSeconds;\n+    }\n+\n+    /**\n+     * Set whether to warn and close record contexts open for too long.\n+     * @param warnAndCloseOpenContextsAfterSeconds  number of seconds after which a context and be closed and a warning logged", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b138786b7b9081a2177614df40b86282fcdb172"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2OTMyNA==", "bodyText": "I guess I'm not 100% clear on this, but can we deprecate them now (according to our rules)? If this is stable, I suppose we can't remove them until version 3, but I thought deprecating \"should\" be okay at any time.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/986#discussion_r448669324", "createdAt": "2020-07-01T23:36:24Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabaseFactory.java", "diffHunk": "@@ -463,14 +464,15 @@ public long getReverseDirectoryMaxMillisPerTransaction() {\n         return reverseDirectoryMaxMillisPerTransaction;\n     }\n \n+    // TODO: Demote these to UNSTABLE and deprecate at some point.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b138786b7b9081a2177614df40b86282fcdb172"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3MDI2Mg==", "bodyText": "I think if this used pollFirstEntry, then this wouldn't need to catch an exception (but would have to check for null). I suppose that could then be combined with the check to see if the data structure is empty.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/986#discussion_r448670262", "createdAt": "2020-07-01T23:39:43Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabase.java", "diffHunk": "@@ -1120,6 +1134,55 @@ protected RuntimeException mapAsyncToSyncException(@Nonnull Throwable ex) {\n         return future.get();\n     }\n \n+    /**\n+     * Log warning and close tracked contexts that have been open for too long.\n+     * @param minAgeSeconds number of seconds above which to warn\n+     * @return number of such contexts found\n+     */\n+    public int warnAndCloseOldTrackedOpenContexts(long minAgeSeconds) {\n+        long nanoTime = System.nanoTime() - TimeUnit.SECONDS.toNanos(minAgeSeconds);\n+        if (trackedOpenContexts.isEmpty()) {\n+            return 0;\n+        }\n+        try {\n+            if (trackedOpenContexts.firstKey() > nanoTime) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b138786b7b9081a2177614df40b86282fcdb172"}, "originalPosition": 144}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3MjcyMA==", "bodyText": "Is this public so that a consumer might decide that they want to run this more often (or I suppose in their own tests)? It seems that in general, this should be package private, but I could also see the argument that either of those would be useful features.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/986#discussion_r448672720", "createdAt": "2020-07-01T23:48:17Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabase.java", "diffHunk": "@@ -1120,6 +1134,55 @@ protected RuntimeException mapAsyncToSyncException(@Nonnull Throwable ex) {\n         return future.get();\n     }\n \n+    /**\n+     * Log warning and close tracked contexts that have been open for too long.\n+     * @param minAgeSeconds number of seconds above which to warn\n+     * @return number of such contexts found\n+     */\n+    public int warnAndCloseOldTrackedOpenContexts(long minAgeSeconds) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b138786b7b9081a2177614df40b86282fcdb172"}, "originalPosition": 138}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3MzA0Mw==", "bodyText": "This doesn't feel like it should be public. I think I can get behind the others, though they also seem more package-private (unless they're supposed to be visible for testing, or something like that).", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/986#discussion_r448673043", "createdAt": "2020-07-01T23:49:25Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordContext.java", "diffHunk": "@@ -337,6 +340,34 @@ public boolean isLogged() {\n         return logged;\n     }\n \n+    /**\n+     * Get the nanosecond time at which this context was opened.\n+     * @return time opened\n+     */\n+    @API(API.Status.INTERNAL)\n+    public long getTrackOpenTimeNanos() {\n+        return trackOpenTimeNanos;\n+    }\n+\n+    /**\n+     * Set the nanosecond time at which this context was opened.\n+     * @param trackOpenTimeNanos  time opened\n+     */\n+    @API(API.Status.INTERNAL)\n+    public void setTrackOpenTimeNanos(final long trackOpenTimeNanos) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b138786b7b9081a2177614df40b86282fcdb172"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3Mzk5NQ==", "bodyText": "Seems like the throwable here should have a message here about how it's not thrown (or equivalently that this is created only for the stack trace).", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/986#discussion_r448673995", "createdAt": "2020-07-01T23:52:38Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordContext.java", "diffHunk": "@@ -152,22 +154,23 @@\n     private final Map<String, PostCommit> postCommits = new LinkedHashMap<>();\n     private boolean dirtyStoreState;\n     private boolean dirtyMetaDataVersionStamp;\n+    private long trackOpenTimeNanos;\n \n     protected FDBRecordContext(@Nonnull FDBDatabase fdb,\n                                @Nonnull Transaction transaction,\n-                               @Nonnull FDBRecordContextConfig config,\n-                               boolean transactionIsTraced) {\n+                               @Nonnull FDBRecordContextConfig config) {\n         super(fdb, transaction, config.getTimer());\n         this.transactionCreateTime = System.currentTimeMillis();\n         this.localVersion = new AtomicInteger(0);\n         this.localVersionCache = new ConcurrentSkipListMap<>(ByteArrayUtil::compareUnsigned);\n         this.versionMutationCache = new ConcurrentSkipListMap<>(ByteArrayUtil::compareUnsigned);\n         this.transactionId = getSanitizedId(config);\n+        this.openStackTrace = config.isSaveOpenStackTrace() ? new Throwable() : null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b138786b7b9081a2177614df40b86282fcdb172"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82b71ef4efb1f85b6073c6fea7f4cc1915ee52f0", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/82b71ef4efb1f85b6073c6fea7f4cc1915ee52f0", "committedDate": "2020-07-02T01:24:56Z", "message": "Resolves #985: Get rid of finalizer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0b138786b7b9081a2177614df40b86282fcdb172", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/0b138786b7b9081a2177614df40b86282fcdb172", "committedDate": "2020-07-01T16:44:00Z", "message": "Resolves #985: Get rid of finalizer"}, "afterCommit": {"oid": "82b71ef4efb1f85b6073c6fea7f4cc1915ee52f0", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/82b71ef4efb1f85b6073c6fea7f4cc1915ee52f0", "committedDate": "2020-07-02T01:24:56Z", "message": "Resolves #985: Get rid of finalizer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxNjA5MjIy", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/986#pullrequestreview-441609222", "createdAt": "2020-07-02T11:59:40Z", "commit": {"oid": "82b71ef4efb1f85b6073c6fea7f4cc1915ee52f0"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxMTo1OTo0MVrOGsJtQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxMjoyNDo0NVrOGsKhOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk0OTU3MQ==", "bodyText": "Yeah, it seems useful to me for this to be public, so you could, say, hook it into some metric publishing system to track the number of leaky transactions you have over time.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/986#discussion_r448949571", "createdAt": "2020-07-02T11:59:41Z", "author": {"login": "scgray"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabase.java", "diffHunk": "@@ -1120,6 +1134,55 @@ protected RuntimeException mapAsyncToSyncException(@Nonnull Throwable ex) {\n         return future.get();\n     }\n \n+    /**\n+     * Log warning and close tracked contexts that have been open for too long.\n+     * @param minAgeSeconds number of seconds above which to warn\n+     * @return number of such contexts found\n+     */\n+    public int warnAndCloseOldTrackedOpenContexts(long minAgeSeconds) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3MjcyMA=="}, "originalCommit": {"oid": "0b138786b7b9081a2177614df40b86282fcdb172"}, "originalPosition": 138}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk2Mjg3NA==", "bodyText": "Just an observation: I wasn't aware that nanoTime() could return 0. That's useful to be aware of.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/986#discussion_r448962874", "createdAt": "2020-07-02T12:24:45Z", "author": {"login": "scgray"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabase.java", "diffHunk": "@@ -1118,6 +1132,55 @@ protected RuntimeException mapAsyncToSyncException(@Nonnull Throwable ex) {\n         return future.get();\n     }\n \n+    /**\n+     * Log warning and close tracked contexts that have been open for too long.\n+     * @param minAgeSeconds number of seconds above which to warn\n+     * @return number of such contexts found\n+     */\n+    public int warnAndCloseOldTrackedOpenContexts(long minAgeSeconds) {\n+        long nanoTime = System.nanoTime() - TimeUnit.SECONDS.toNanos(minAgeSeconds);\n+        if (trackedOpenContexts.isEmpty()) {\n+            return 0;\n+        }\n+        try {\n+            if (trackedOpenContexts.firstKey() > nanoTime) {\n+                return 0;\n+            }\n+        } catch (NoSuchElementException ex) {\n+            return 0;\n+        }\n+        int count = 0;\n+        for (FDBRecordContext context : trackedOpenContexts.headMap(nanoTime, true).values()) {\n+            KeyValueLogMessage msg = KeyValueLogMessage.build(\"context not closed\",\n+                    LogMessageKeys.AGE_SECONDS, TimeUnit.NANOSECONDS.toSeconds(nanoTime - context.getTrackOpenTimeNanos()),\n+                    LogMessageKeys.TRANSACTION_ID, context.getTransactionId());\n+            if (context.getOpenStackTrace() != null) {\n+                LOGGER.warn(msg.toString(), context.getOpenStackTrace());\n+            } else {\n+                LOGGER.warn(msg.toString());\n+            }\n+            context.close();\n+            count++;\n+        }\n+        return count;\n+    }\n+\n+    protected void trackOpenContext(FDBRecordContext context) {\n+        long key = System.nanoTime();\n+        while (key == 0 || trackedOpenContexts.putIfAbsent(key, context) != null) {\n+            key++;  // Might not have nanosecond resolution and need something non-zero and unique.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82b71ef4efb1f85b6073c6fea7f4cc1915ee52f0"}, "originalPosition": 169}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8542010f501e6c253eb9896023946576ec11df59", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/8542010f501e6c253eb9896023946576ec11df59", "committedDate": "2020-07-02T13:51:49Z", "message": "Update fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabaseFactory.java\n\nCo-authored-by: Alec Grieser <alloc@apple.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3c58c017ca17808c127f0fe4e9394f2c4b95a1e", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/e3c58c017ca17808c127f0fe4e9394f2c4b95a1e", "committedDate": "2020-07-02T15:05:14Z", "message": "Adjust some visibility"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "85bfec6124009034e29f4383bc70e01a28b97554", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/85bfec6124009034e29f4383bc70e01a28b97554", "committedDate": "2020-07-02T15:03:44Z", "message": "Adjust some visibility"}, "afterCommit": {"oid": "e3c58c017ca17808c127f0fe4e9394f2c4b95a1e", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/e3c58c017ca17808c127f0fe4e9394f2c4b95a1e", "committedDate": "2020-07-02T15:05:14Z", "message": "Adjust some visibility"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxODMyNjAw", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/986#pullrequestreview-441832600", "createdAt": "2020-07-02T16:04:49Z", "commit": {"oid": "e3c58c017ca17808c127f0fe4e9394f2c4b95a1e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cad029f303b1602bbc8ab750469eba1694f932a5", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/cad029f303b1602bbc8ab750469eba1694f932a5", "committedDate": "2020-07-02T16:33:02Z", "message": "Add a KPI for warnAndCloseOldTrackedOpenContexts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxODY1NTM2", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/986#pullrequestreview-441865536", "createdAt": "2020-07-02T16:48:35Z", "commit": {"oid": "cad029f303b1602bbc8ab750469eba1694f932a5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxOTA3NDAy", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/986#pullrequestreview-441907402", "createdAt": "2020-07-02T17:49:45Z", "commit": {"oid": "cad029f303b1602bbc8ab750469eba1694f932a5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2657, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}