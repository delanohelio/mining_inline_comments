{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2MzgwNzMz", "number": 914, "title": "Fixes #482: Test failure in RankIndexTest::repeatedRankQuery", "bodyText": "This looks like it was a real concurrency bug (one that can lead to the data being corrupt). Essentially, the ranked set does not allow concurrent updates to the same subspace in the same transaction. This is a known issue, and there are real ways to fix it (like implementing some kind of locking abstraction), but it is hard to get right in a way that also does not result in blocking in async threads. The patch here fixes the text index maintainer so that it issues its updates to the same subspace serially, though it can still update unrelated subspaces in parallel.\nThis fixes #482.", "createdAt": "2020-04-21T01:07:33Z", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/914", "merged": true, "mergeCommit": {"oid": "95857ae64ee0d121d7a807c0cc3d86cb589ad44d"}, "closed": true, "closedAt": "2020-04-23T16:00:55Z", "author": {"login": "alecgrieser"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZpOj2AH2gAyNDA2MzgwNzMzOjEyNjlkNjFjZGI2M2MzN2UwZDhhNTdlNDI3ZjUxYzU1Y2JlZGMyNTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcafE6QAFqTM5OTIyOTAwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1269d61cdb63c37e0d8a57e427f51c55cbedc255", "author": {"user": {"login": "alecgrieser", "name": "Alec Grieser"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/1269d61cdb63c37e0d8a57e427f51c55cbedc255", "committedDate": "2020-04-21T01:16:12Z", "message": "Fixes #482: Test failure in RankIndexTest::repeatedRankQuery\n\nThis looks like it was a real concurrency bug (one that can lead to the data being corrupt). Essentially, the ranked set does not allow concurrent updates to the same subspace in the same transaction. This is a known issue, and there are real ways to fix it (like implementing some kind of locking abstraction), but it is hard to get right in a way that also does not result in blocking in async threads. The patch here fixes the text index maintainer so that it issues its updates to the same subspace serially, though it can still update unrelated subspaces in parallel."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c85c2c83f1a5cc0a6ad94100ecb2ec19e7792f63", "author": {"user": {"login": "alecgrieser", "name": "Alec Grieser"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/c85c2c83f1a5cc0a6ad94100ecb2ec19e7792f63", "committedDate": "2020-04-21T01:07:12Z", "message": "Fixes #482: Test failure in RankIndexTest::repeatedRankQuery\n\nThis looks like it was a real concurrency bug (one that can lead to the data being corrupt). Essentially, the ranked set does not allow concurrent updates to the same subspace in the same transaction. This is a known issue, and there are real ways to fix it (like implementing some kind of locking abstraction), but it is hard to get right in a way that also does not result in blocking in async threads. The patch here fixes the text index maintainer so that it issues its updates to the same subspace serially, though it can still update unrelated subspaces in parallel."}, "afterCommit": {"oid": "1269d61cdb63c37e0d8a57e427f51c55cbedc255", "author": {"user": {"login": "alecgrieser", "name": "Alec Grieser"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/1269d61cdb63c37e0d8a57e427f51c55cbedc255", "committedDate": "2020-04-21T01:16:12Z", "message": "Fixes #482: Test failure in RankIndexTest::repeatedRankQuery\n\nThis looks like it was a real concurrency bug (one that can lead to the data being corrupt). Essentially, the ranked set does not allow concurrent updates to the same subspace in the same transaction. This is a known issue, and there are real ways to fix it (like implementing some kind of locking abstraction), but it is hard to get right in a way that also does not result in blocking in async threads. The patch here fixes the text index maintainer so that it issues its updates to the same subspace serially, though it can still update unrelated subspaces in parallel."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "825b8d90175bb4c471b89cb1dc4217600917f38b", "author": {"user": {"login": "ScottDugas", "name": "Scott Dugas"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/825b8d90175bb4c471b89cb1dc4217600917f38b", "committedDate": "2020-04-22T21:30:35Z", "message": "A repro for #482\n\nThese seem to reliably get the wrong results, although, I definitely\nfeel like the test could be cleaner"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11c436ebfdf76e567b15678dbef48017039a163f", "author": {"user": {"login": "alecgrieser", "name": "Alec Grieser"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/11c436ebfdf76e567b15678dbef48017039a163f", "committedDate": "2020-04-22T21:36:09Z", "message": "some tweaks to the repeated ranks tests to make the asserts work"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5MjI5MDA3", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/914#pullrequestreview-399229007", "createdAt": "2020-04-23T15:41:14Z", "commit": {"oid": "11c436ebfdf76e567b15678dbef48017039a163f"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxNTo0MToxNFrOGKu3tA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxNTo0Mzo1NFrOGKvAAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzkwNjg2OA==", "bodyText": "Does this mean that it is unsafe to write two records concurrently, if they both touch the same rank index?", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/914#discussion_r413906868", "createdAt": "2020-04-23T15:41:14Z", "author": {"login": "ScottDugas"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/indexes/RankIndexMaintainer.java", "diffHunk": "@@ -127,10 +129,19 @@ public RankIndexMaintainer(IndexMaintainerState state) {\n                 rankSubspace = extraSubspace;\n                 scoreKey = indexEntry.getKey();\n             }\n-            futures.add(RankedSetIndexHelper.updateRankedSet(state, rankSubspace, config, indexEntry.getKey(),\n-                    scoreKey, remove));\n+            // It is unsafe to have two concurrent updates to the same ranked set, so ensure that at most", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11c436ebfdf76e567b15678dbef48017039a163f"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzkwODk5Mg==", "bodyText": "Just checking on my understanding, this means that if you have an ungrouped rank, the record updates will be done serially, if you have a grouped rank index, each group will be done in parallel, but the updates within a group will be done serially, correct?", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/914#discussion_r413908992", "createdAt": "2020-04-23T15:43:54Z", "author": {"login": "ScottDugas"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/indexes/RankIndexMaintainer.java", "diffHunk": "@@ -127,10 +129,19 @@ public RankIndexMaintainer(IndexMaintainerState state) {\n                 rankSubspace = extraSubspace;\n                 scoreKey = indexEntry.getKey();\n             }\n-            futures.add(RankedSetIndexHelper.updateRankedSet(state, rankSubspace, config, indexEntry.getKey(),\n-                    scoreKey, remove));\n+            // It is unsafe to have two concurrent updates to the same ranked set, so ensure that at most\n+            // one update per grouping key is ongoing at any given time\n+            final Function<Void, CompletableFuture<Void>> futureSupplier = vignore -> RankedSetIndexHelper.updateRankedSet(\n+                    state, rankSubspace, config, indexEntry.getKey(), scoreKey, remove\n+            );\n+            CompletableFuture<Void> existingFuture = futures.get(rankSubspace);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11c436ebfdf76e567b15678dbef48017039a163f"}, "originalPosition": 37}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2576, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}