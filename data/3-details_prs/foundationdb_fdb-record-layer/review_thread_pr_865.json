{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyNzI0Mzcw", "number": 865, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwMTozMToyNFrODqnTlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNDoxMTo0NVrODrOyUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2MDEwNzcyOnYy", "diffSide": "RIGHT", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/keyspace/LocatableResolver.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwMTozMToyNFrOF6eFJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwMTozMToyNFrOF6eFJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg1NDU2NQ==", "bodyText": "If we wanted to also set the max attempts, we could do that here", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/865#discussion_r396854565", "createdAt": "2020-03-24T01:31:24Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/keyspace/LocatableResolver.java", "diffHunk": "@@ -113,71 +116,194 @@ public FDBDatabase getDatabase() {\n         );\n     }\n \n+    @Nonnull\n+    private <T> CompletableFuture<T> runAsyncBorrowingReadVersion(@Nonnull FDBRecordContext parentContext, @Nonnull Function<FDBRecordContext, CompletableFuture<T>> retriable) {\n+        final FDBDatabaseRunner runner = parentContext.newRunner();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58a729ad568a1d7591fd922149095578b15eb56d"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2Mzg3Mjc0OnYy", "diffSide": "RIGHT", "path": "fdb-record-layer-core/src/test/java/com/apple/foundationdb/record/provider/foundationdb/keyspace/ExtendedDirectoryLayerTest.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMToxNDo1MFrOF7DXAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMzozMTo0NFrOF7yNCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ2NTM0Ng==", "bodyText": "Perhaps these tests could be improved by yet another overload that only took the key and did the null itself.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/865#discussion_r397465346", "createdAt": "2020-03-24T21:14:50Z", "author": {"login": "MMcM"}, "path": "fdb-record-layer-core/src/test/java/com/apple/foundationdb/record/provider/foundationdb/keyspace/ExtendedDirectoryLayerTest.java", "diffHunk": "@@ -99,12 +99,12 @@ private static void testReadCompatible(LocatableResolver writer, LocatableResolv\n         Map<String, Long> allocations = new HashMap<>();\n         for (int i = 0; i < 50; i++) {\n             String key = \"key-\" + i;\n-            Long value = writer.resolve(null, key).join();\n+            Long value = writer.resolve((FDBStoreTimer)null, key).join();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58a729ad568a1d7591fd922149095578b15eb56d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODIzMjIxMw==", "bodyText": "Yeah, though it's a little weird that the optional parameter is the first (rather than the last).", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/865#discussion_r398232213", "createdAt": "2020-03-25T23:29:53Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/test/java/com/apple/foundationdb/record/provider/foundationdb/keyspace/ExtendedDirectoryLayerTest.java", "diffHunk": "@@ -99,12 +99,12 @@ private static void testReadCompatible(LocatableResolver writer, LocatableResolv\n         Map<String, Long> allocations = new HashMap<>();\n         for (int i = 0; i < 50; i++) {\n             String key = \"key-\" + i;\n-            Long value = writer.resolve(null, key).join();\n+            Long value = writer.resolve((FDBStoreTimer)null, key).join();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ2NTM0Ng=="}, "originalCommit": {"oid": "58a729ad568a1d7591fd922149095578b15eb56d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODIzMjg0MQ==", "bodyText": "I added this as a separate commit with this PR, for size", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/865#discussion_r398232841", "createdAt": "2020-03-25T23:31:44Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/test/java/com/apple/foundationdb/record/provider/foundationdb/keyspace/ExtendedDirectoryLayerTest.java", "diffHunk": "@@ -99,12 +99,12 @@ private static void testReadCompatible(LocatableResolver writer, LocatableResolv\n         Map<String, Long> allocations = new HashMap<>();\n         for (int i = 0; i < 50; i++) {\n             String key = \"key-\" + i;\n-            Long value = writer.resolve(null, key).join();\n+            Long value = writer.resolve((FDBStoreTimer)null, key).join();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ2NTM0Ng=="}, "originalCommit": {"oid": "58a729ad568a1d7591fd922149095578b15eb56d"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2NjU3NjE2OnYy", "diffSide": "RIGHT", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBReverseDirectoryCache.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNDoxMTo0NVrOF7c8DA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMjo1ODozOVrOF7xf7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg4NDQyOA==", "bodyText": "Since the @VisibleForTesting doesn't really help when, say, your favorite IDE is autocompleting potential methods, maybe it would be a good idea to also name this method waitUntilReadyForTesting (unless we can restrict the use of methods tagged with this automatically?).", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/865#discussion_r397884428", "createdAt": "2020-03-25T14:11:45Z", "author": {"login": "scgray"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBReverseDirectoryCache.java", "diffHunk": "@@ -371,6 +371,15 @@ public void rebuild(LocatableResolver scope) {\n         }\n     }\n \n+    /**\n+     * Wait for any asynchronous work started at object creation time to complete. This should only be\n+     * used for tests in order to avoid spurious conflicts.\n+     */\n+    @VisibleForTesting\n+    public void waitUntilReady() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58a729ad568a1d7591fd922149095578b15eb56d"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODIyMTI5Mg==", "bodyText": "Done. It does seem, given that @VisibleForTesting is defined in guava, and that library is popular enough, that an IDE plugin that keeps you from using it outside of test packages could conceivably exist, though I'm not aware of one off hand.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/865#discussion_r398221292", "createdAt": "2020-03-25T22:58:39Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBReverseDirectoryCache.java", "diffHunk": "@@ -371,6 +371,15 @@ public void rebuild(LocatableResolver scope) {\n         }\n     }\n \n+    /**\n+     * Wait for any asynchronous work started at object creation time to complete. This should only be\n+     * used for tests in order to avoid spurious conflicts.\n+     */\n+    @VisibleForTesting\n+    public void waitUntilReady() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg4NDQyOA=="}, "originalCommit": {"oid": "58a729ad568a1d7591fd922149095578b15eb56d"}, "originalPosition": 9}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4851, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}