{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyNzI0Mzcw", "number": 865, "title": "Resolves #864: KeySpacePath resolution should re-use the initiating transaction's read version", "bodyText": "This adds overloads to LocatableResolver::resolve that allow a transaction to be passed, and then the resolver uses that transaction's read version when performing reads from the directory layer. In the \"usual case\" (which should be when a new entry does not need to be created), this transaction won't be committed anyway, so the only loss in efficiency over using the transaction itself is some extra memory (and no extra network requests).\nIt would probably still be a good idea to do #853 (if we can figure out what we want to do about caching), but this is easier and gets us 99% of the benefit. That being said, there is more cognitive load needed to understand this API, which is perhaps a smell.\nThis resolves #864.", "createdAt": "2020-03-24T01:29:17Z", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/865", "merged": true, "mergeCommit": {"oid": "2c20ea821a6472f671cb8bd6d03dc808bc191db8"}, "closed": true, "closedAt": "2020-03-26T18:14:59Z", "author": {"login": "alecgrieser"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQon_MgH2gAyMzkyNzI0MzcwOjU4YTcyOWFkNTY4YTFkNzU5MWZkOTIyMTQ5MDk1NTc4YjE1ZWI1NmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRgNyagFqTM4MjI4NDQzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "58a729ad568a1d7591fd922149095578b15eb56d", "author": {"user": {"login": "alecgrieser", "name": "Alec Grieser"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/58a729ad568a1d7591fd922149095578b15eb56d", "committedDate": "2020-03-24T01:28:45Z", "message": "Resolves #864: KeySpacePath resolution should re-use the initiating transaction's read version\n\nThis adds overloads to `LocatableResolver::resolve` that allow a transaction to be passed, and then the resolver uses that transaction's read version when performing reads from the directory layer. In the \"usual case\" (which should be when a new entry does not need to be created), this transaction won't be committed anyway, so the only loss in efficiency over using the transaction itself is some extra memory (and no extra network requests).\n\nIt would probably still be a good idea to do #853 (if we can figure out what we want to do about caching), but this is easier and gets us 99% of the benefit. That being said, there is more cognitive load needed to understand this API, which is perhaps a smell."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5OTQyNDM3", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/865#pullrequestreview-379942437", "createdAt": "2020-03-24T01:31:23Z", "commit": {"oid": "58a729ad568a1d7591fd922149095578b15eb56d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwMTozMToyNFrOF6eFJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwMTozMToyNFrOF6eFJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg1NDU2NQ==", "bodyText": "If we wanted to also set the max attempts, we could do that here", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/865#discussion_r396854565", "createdAt": "2020-03-24T01:31:24Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/keyspace/LocatableResolver.java", "diffHunk": "@@ -113,71 +116,194 @@ public FDBDatabase getDatabase() {\n         );\n     }\n \n+    @Nonnull\n+    private <T> CompletableFuture<T> runAsyncBorrowingReadVersion(@Nonnull FDBRecordContext parentContext, @Nonnull Function<FDBRecordContext, CompletableFuture<T>> retriable) {\n+        final FDBDatabaseRunner runner = parentContext.newRunner();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58a729ad568a1d7591fd922149095578b15eb56d"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNzAxNzkz", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/865#pullrequestreview-380701793", "createdAt": "2020-03-24T21:14:50Z", "commit": {"oid": "58a729ad568a1d7591fd922149095578b15eb56d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMToxNDo1MFrOF7DXAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMToxNDo1MFrOF7DXAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ2NTM0Ng==", "bodyText": "Perhaps these tests could be improved by yet another overload that only took the key and did the null itself.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/865#discussion_r397465346", "createdAt": "2020-03-24T21:14:50Z", "author": {"login": "MMcM"}, "path": "fdb-record-layer-core/src/test/java/com/apple/foundationdb/record/provider/foundationdb/keyspace/ExtendedDirectoryLayerTest.java", "diffHunk": "@@ -99,12 +99,12 @@ private static void testReadCompatible(LocatableResolver writer, LocatableResolv\n         Map<String, Long> allocations = new HashMap<>();\n         for (int i = 0; i < 50; i++) {\n             String key = \"key-\" + i;\n-            Long value = writer.resolve(null, key).join();\n+            Long value = writer.resolve((FDBStoreTimer)null, key).join();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58a729ad568a1d7591fd922149095578b15eb56d"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxMTg0NTY0", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/865#pullrequestreview-381184564", "createdAt": "2020-03-25T14:11:45Z", "commit": {"oid": "58a729ad568a1d7591fd922149095578b15eb56d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNDoxMTo0NVrOF7c8DA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNDoxMTo0NVrOF7c8DA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg4NDQyOA==", "bodyText": "Since the @VisibleForTesting doesn't really help when, say, your favorite IDE is autocompleting potential methods, maybe it would be a good idea to also name this method waitUntilReadyForTesting (unless we can restrict the use of methods tagged with this automatically?).", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/865#discussion_r397884428", "createdAt": "2020-03-25T14:11:45Z", "author": {"login": "scgray"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBReverseDirectoryCache.java", "diffHunk": "@@ -371,6 +371,15 @@ public void rebuild(LocatableResolver scope) {\n         }\n     }\n \n+    /**\n+     * Wait for any asynchronous work started at object creation time to complete. This should only be\n+     * used for tests in order to avoid spurious conflicts.\n+     */\n+    @VisibleForTesting\n+    public void waitUntilReady() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58a729ad568a1d7591fd922149095578b15eb56d"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f205ca2a94971578dc98e1a5c74848467efd2d19", "author": {"user": {"login": "alecgrieser", "name": "Alec Grieser"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/f205ca2a94971578dc98e1a5c74848467efd2d19", "committedDate": "2020-03-25T22:51:18Z", "message": "rename a method to make it more obvious it is for testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "823271ffd37b93ca3a710f49bd2af5a95b2ca273", "author": {"user": {"login": "alecgrieser", "name": "Alec Grieser"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/823271ffd37b93ca3a710f49bd2af5a95b2ca273", "committedDate": "2020-03-25T23:26:31Z", "message": "add overloads for resolve that take neither a timer nor a context"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxNjExNDYz", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/865#pullrequestreview-381611463", "createdAt": "2020-03-25T23:35:40Z", "commit": {"oid": "823271ffd37b93ca3a710f49bd2af5a95b2ca273"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMjg0NDMy", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/865#pullrequestreview-382284432", "createdAt": "2020-03-26T18:14:49Z", "commit": {"oid": "823271ffd37b93ca3a710f49bd2af5a95b2ca273"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2550, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}