{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyMjkzMDI5", "number": 984, "title": "Resolves #983: FDBDatabaseRunner should use FDBRecordContextConfig more", "bodyText": "", "createdAt": "2020-06-30T21:04:26Z", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/984", "merged": true, "mergeCommit": {"oid": "282fcea70eea2237f8fb3fcbb761b62f2d39c4a3"}, "closed": true, "closedAt": "2020-07-02T01:02:01Z", "author": {"login": "MMcM"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwr6VggH2gAyNDQyMjkzMDI5OmE5MmQ3ZDFkNTY2YTA5YTI0NzNjNjFmYWQ3ZmQzNzgyNTFhZjg5YjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcw0LREgFqTQ0MTI4NDIxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a92d7d1d566a09a2473c61fad7fd378251af89b1", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/a92d7d1d566a09a2473c61fad7fd378251af89b1", "committedDate": "2020-07-01T15:24:05Z", "message": "Resolves #983: FDBDatabaseRunner should use FDBRecordContextConfig more"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e447baa5787586b0a42ca82c0b69f9e4341dab64", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/e447baa5787586b0a42ca82c0b69f9e4341dab64", "committedDate": "2020-06-30T21:03:50Z", "message": "Resolves #983: FDBDatabaseRunner should use FDBRecordContextConfig more"}, "afterCommit": {"oid": "a92d7d1d566a09a2473c61fad7fd378251af89b1", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/a92d7d1d566a09a2473c61fad7fd378251af89b1", "committedDate": "2020-07-01T15:24:05Z", "message": "Resolves #983: FDBDatabaseRunner should use FDBRecordContextConfig more"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjUxMjAz", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/984#pullrequestreview-441251203", "createdAt": "2020-07-01T23:11:47Z", "commit": {"oid": "a92d7d1d566a09a2473c61fad7fd378251af89b1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMzoxMTo0N1rOGr4KJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMzozMDoyNlrOGr4fRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2MjA1Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                FDBRecordContextConfig.Builder getContextConfigBuilder();\n          \n          \n            \n                @Nonnull\n          \n          \n            \n                FDBRecordContextConfig.Builder getContextConfigBuilder();", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/984#discussion_r448662053", "createdAt": "2020-07-01T23:11:47Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabaseRunner.java", "diffHunk": "@@ -69,6 +69,18 @@\n     @Nonnull\n     FDBDatabase getDatabase();\n \n+    /**\n+     * Get the configuration used in record contexts opened by this runner.\n+     * @return configuration to use\n+     */\n+    FDBRecordContextConfig.Builder getContextConfigBuilder();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a92d7d1d566a09a2473c61fad7fd378251af89b1"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2MjY1OQ==", "bodyText": "I suppose this should have a Javadoc comment along the lines of the other getters in this builder", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/984#discussion_r448662659", "createdAt": "2020-07-01T23:13:50Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordContextConfig.java", "diffHunk": "@@ -344,7 +354,7 @@ public Builder setTransactionTimeoutMillis(long transactionTimeoutMillis) {\n             return this;\n         }\n \n-        private long getTransactionTimeoutMillis() {\n+        public long getTransactionTimeoutMillis() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a92d7d1d566a09a2473c61fad7fd378251af89b1"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NDI4OQ==", "bodyText": "It is a little weird that this sets the default option here... I suppose another approach would be to make the argument to FDBDatabaseRunnerImpl @Nullable and then fill it in with a default builder (like this) if null is provided, and then filling in the defaults is the job of in FDBDatabaseRunnerImpl (or there's a \"default config builder\" method in FDBDatabase and then that does the job of filling in the default values).\nI think all of those things could be changed later, though, without affecting the API.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/984#discussion_r448664289", "createdAt": "2020-07-01T23:19:30Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabase.java", "diffHunk": "@@ -766,14 +766,23 @@ private Transaction createTransaction(@Nonnull FDBRecordContextConfig config,\n         return transaction;\n     }\n \n+    /**\n+     * Create an {@link FDBDatabaseRunner} for use against this database.\n+     * @param contextConfigBuilder options for contexts opened by the new runner\n+     * @return a new runner\n+     */\n+    @Nonnull\n+    public FDBDatabaseRunner newRunner(@Nonnull FDBRecordContextConfig.Builder contextConfigBuilder) {\n+        return new FDBDatabaseRunnerImpl(this, contextConfigBuilder);\n+    }\n \n     /**\n      * Create an {@link FDBDatabaseRunner} for use against this database.\n      * @return a new runner\n      */\n     @Nonnull\n     public FDBDatabaseRunner newRunner() {\n-        return new FDBDatabaseRunnerImpl(this);\n+        return newRunner(FDBRecordContextConfig.newBuilder().setTransactionTimeoutMillis(factory.getTransactionTimeoutMillis()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a92d7d1d566a09a2473c61fad7fd378251af89b1"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NDU1OA==", "bodyText": "It might be worth clarifying that the builder passed in will be the same object used in the runner, so future changes to the state of the argument will also affect the values as seen in the runner (as it's running).", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/984#discussion_r448664558", "createdAt": "2020-07-01T23:20:25Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabase.java", "diffHunk": "@@ -766,14 +766,23 @@ private Transaction createTransaction(@Nonnull FDBRecordContextConfig config,\n         return transaction;\n     }\n \n+    /**\n+     * Create an {@link FDBDatabaseRunner} for use against this database.\n+     * @param contextConfigBuilder options for contexts opened by the new runner", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a92d7d1d566a09a2473c61fad7fd378251af89b1"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NDg3OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    FDBDatabaseRunner runner = newRunner();\n          \n          \n            \n                    runner.getContextConfigBuilder().setTimer(timer).setMdcContext(mdcContext);\n          \n          \n            \n                    return runner;\n          \n          \n            \n                    return newRunner(timer, mdcContext, null);\n          \n      \n    \n    \n  \n\nI think. I can make arguments that the other two newRunners should remain as is, but this one seems like it should populate the default value of the other one.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/984#discussion_r448664879", "createdAt": "2020-07-01T23:21:30Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabase.java", "diffHunk": "@@ -784,7 +793,9 @@ public FDBDatabaseRunner newRunner() {\n      */\n     @Nonnull\n     public FDBDatabaseRunner newRunner(@Nullable FDBStoreTimer timer, @Nullable Map<String, String> mdcContext) {\n-        return new FDBDatabaseRunnerImpl(this, timer, mdcContext);\n+        FDBDatabaseRunner runner = newRunner();\n+        runner.getContextConfigBuilder().setTimer(timer).setMdcContext(mdcContext);\n+        return runner;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a92d7d1d566a09a2473c61fad7fd378251af89b1"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NTU4Ng==", "bodyText": "It's probably worth clarifying that as the object returned is the same object as (not a copy of) the one used by the runner, if one changes one of the values of the builder, then this will affect the values used when the runner creates new contexts.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/984#discussion_r448665586", "createdAt": "2020-07-01T23:23:59Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabaseRunner.java", "diffHunk": "@@ -69,6 +69,18 @@\n     @Nonnull\n     FDBDatabase getDatabase();\n \n+    /**\n+     * Get the configuration used in record contexts opened by this runner.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a92d7d1d566a09a2473c61fad7fd378251af89b1"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NjE1Ng==", "bodyText": "Looks like get/set transaction timeout millis can be similarly removed", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/984#discussion_r448666156", "createdAt": "2020-07-01T23:26:02Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/synchronizedsession/SynchronizedSessionRunner.java", "diffHunk": "@@ -206,52 +205,18 @@ public FDBDatabase getDatabase() {\n     }\n \n     @Override\n-    public Executor getExecutor() {\n-        return underlying.getExecutor();\n-    }\n-\n-    @Override\n-    @Nullable\n-    public FDBStoreTimer getTimer() {\n-        return underlying.getTimer();\n-    }\n-\n-    @Override\n-    public void setTimer(@Nullable FDBStoreTimer timer) {\n-        underlying.setTimer(timer);\n-    }\n-\n-    @Override\n-    @Nullable\n-    public Map<String, String> getMdcContext() {\n-        return underlying.getMdcContext();\n+    public FDBRecordContextConfig.Builder getContextConfigBuilder() {\n+        return underlying.getContextConfigBuilder();\n     }\n \n     @Override\n-    public void setMdcContext(@Nullable Map<String, String> mdcContext) {\n-        underlying.setMdcContext(mdcContext);\n+    public void setContextConfigBuilder(final FDBRecordContextConfig.Builder contextConfigBuilder) {\n+        underlying.setContextConfigBuilder(contextConfigBuilder);\n     }\n \n     @Override\n-    @Nullable\n-    public FDBDatabase.WeakReadSemantics getWeakReadSemantics() {\n-        return underlying.getWeakReadSemantics();\n-    }\n-\n-    @Override\n-    public void setWeakReadSemantics(@Nullable FDBDatabase.WeakReadSemantics weakReadSemantics) {\n-        underlying.setWeakReadSemantics(weakReadSemantics);\n-    }\n-\n-    @Nonnull\n-    @Override\n-    public FDBTransactionPriority getPriority() {\n-        return underlying.getPriority();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a92d7d1d566a09a2473c61fad7fd378251af89b1"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NzQ2MA==", "bodyText": "It's a little weird that one might forget to set the default transaction timeout millis here if one isn't careful...I suppose a \"default context config builder\" method on a database (or, I suppose, a static \"default builder\" method on a FDBRecordContextConfig that took an FDBDatabase) as suggested in a different comment might help with that.", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/984#discussion_r448667460", "createdAt": "2020-07-01T23:30:26Z", "author": {"login": "alecgrieser"}, "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabase.java", "diffHunk": "@@ -766,14 +766,23 @@ private Transaction createTransaction(@Nonnull FDBRecordContextConfig config,\n         return transaction;\n     }\n \n+    /**\n+     * Create an {@link FDBDatabaseRunner} for use against this database.\n+     * @param contextConfigBuilder options for contexts opened by the new runner\n+     * @return a new runner\n+     */\n+    @Nonnull\n+    public FDBDatabaseRunner newRunner(@Nonnull FDBRecordContextConfig.Builder contextConfigBuilder) {\n+        return new FDBDatabaseRunnerImpl(this, contextConfigBuilder);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a92d7d1d566a09a2473c61fad7fd378251af89b1"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdfd33cca3032363b049f3f8fa9935fe34933246", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/fdfd33cca3032363b049f3f8fa9935fe34933246", "committedDate": "2020-07-01T23:45:19Z", "message": "Update fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabaseRunner.java\n\nCo-authored-by: Alec Grieser <alloc@apple.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f83a95bdbdd8872905e4f246534d2c30a45d789", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/7f83a95bdbdd8872905e4f246534d2c30a45d789", "committedDate": "2020-07-02T00:08:53Z", "message": "Simplify timeout defaults"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e032e722c50ae47f516a1399fdd49f089c9615da", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/e032e722c50ae47f516a1399fdd49f089c9615da", "committedDate": "2020-07-02T00:09:04Z", "message": "Merge branch 'more-context-config' of github.com:MMcM/fdb-record-layer into more-context-config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a61b8435a30d2b8115d86daf89920eb05a640e86", "author": {"user": {"login": "MMcM", "name": "Mike McMahon"}}, "url": "https://github.com/FoundationDB/fdb-record-layer/commit/a61b8435a30d2b8115d86daf89920eb05a640e86", "committedDate": "2020-07-02T00:41:40Z", "message": "try another way"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjg0MjE4", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/984#pullrequestreview-441284218", "createdAt": "2020-07-02T01:01:49Z", "commit": {"oid": "a61b8435a30d2b8115d86daf89920eb05a640e86"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2653, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}