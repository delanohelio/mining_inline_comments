{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4MjI0NzU2", "number": 8508, "title": "Allow to supply SHA512 in installApplication #8494", "bodyText": "", "createdAt": "2020-11-26T18:28:53Z", "url": "https://github.com/enonic/xp/pull/8508", "merged": true, "mergeCommit": {"oid": "04fe31f1ea7bb91458975cf84f666ad8f4ba0cdb"}, "closed": true, "closedAt": "2020-11-30T11:59:34Z", "author": {"login": "rymsha"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgXTF-gBqjQwNDM1OTE2Nzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhjvv3AFqTU0MDgyNTQ2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5c1304f14dd15253d3c9ae1055ca94c1f70f18c0", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/5c1304f14dd15253d3c9ae1055ca94c1f70f18c0", "committedDate": "2020-11-26T18:26:40Z", "message": "Allow to supply SHA512 in installApplication #8494"}, "afterCommit": {"oid": "83ac448d346ab66bd41106e71e15aa4dbe711ad8", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/83ac448d346ab66bd41106e71e15aa4dbe711ad8", "committedDate": "2020-11-26T18:30:38Z", "message": "Allow to supply SHA512 in installApplication #8494"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "83ac448d346ab66bd41106e71e15aa4dbe711ad8", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/83ac448d346ab66bd41106e71e15aa4dbe711ad8", "committedDate": "2020-11-26T18:30:38Z", "message": "Allow to supply SHA512 in installApplication #8494"}, "afterCommit": {"oid": "8d91ca7a83bd6f5e84c58a4bc32572c04fbf357d", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/8d91ca7a83bd6f5e84c58a4bc32572c04fbf357d", "committedDate": "2020-11-27T07:55:24Z", "message": "Allow to supply SHA512 in installApplication #8494"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5ODE3NTgy", "url": "https://github.com/enonic/xp/pull/8508#pullrequestreview-539817582", "createdAt": "2020-11-27T09:16:06Z", "commit": {"oid": "8d91ca7a83bd6f5e84c58a4bc32572c04fbf357d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwOToxNjowN1rOH62i8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwOToxNjowN1rOH62i8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ3MzEzOQ==", "bodyText": "can be replaced by UncheckedIOException", "url": "https://github.com/enonic/xp/pull/8508#discussion_r531473139", "createdAt": "2020-11-27T09:16:07Z", "author": {"login": "anatol-sialitski"}, "path": "modules/core/core-app/src/main/java/com/enonic/xp/core/impl/app/ApplicationLoader.java", "diffHunk": "@@ -21,51 +24,84 @@ public ApplicationLoader( final Consumer<Event> eventConsumer )\n         this.eventConsumer = eventConsumer;\n     }\n \n-    public ByteSource load( URL url )\n+    public ByteSource load( final URL url, final byte[] messageDigest )\n     {\n         try\n         {\n-            URLConnection connection = url.openConnection();\n+            final URLConnection connection = url.openConnection();\n \n-            ByteArrayOutputStream os = null;\n-\n-            try (final InputStream is = connection.getInputStream())\n+            final InputStream inputStream = connection.getInputStream();\n+            final DigestInputStream digestInputStream = new DigestInputStream( inputStream, MessageDigests.sha512() );\n+            final ProgressInputStream progressInputStream =\n+                new ProgressInputStream( digestInputStream, connection.getContentLengthLong(), url.toString() );\n+            try (inputStream; digestInputStream; progressInputStream)\n             {\n-                int totalLength = connection.getContentLength();\n-                int bytesRead;\n-                int totalRead = 0;\n-                int lastPct = 0;\n-                byte[] buffer = new byte[8192];\n-                os = new ByteArrayOutputStream();\n-\n-                while ( ( bytesRead = is.read( buffer ) ) != -1 )\n-                {\n-                    os.write( buffer, 0, bytesRead );\n-                    totalRead += bytesRead;\n-\n-                    int currentPct = (int) Math.min( 100, Math.round( totalRead * 100. / totalLength ) );\n-\n-                    if ( lastPct != currentPct )\n-                    {\n-                        eventConsumer.accept( ApplicationEvents.progress( url.toString(), currentPct ) );\n-                        lastPct = currentPct;\n-                    }\n-                }\n-                os.flush();\n+                final byte[] bytes = progressInputStream.readAllBytes();\n \n-                return ByteSource.wrap( os.toByteArray() );\n-            }\n-            finally\n-            {\n-                if ( os != null )\n+                if ( messageDigest != null && !MessageDigest.isEqual( messageDigest, digestInputStream.getMessageDigest().digest() ) )\n                 {\n-                    os.close();\n+                    throw new IllegalArgumentException( \"MessageDigest does not match\" );\n                 }\n+                return ByteSource.wrap( bytes );\n             }\n         }\n         catch ( IOException e )\n         {\n             throw new RuntimeException( \"Failed to load application from \" + url );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d91ca7a83bd6f5e84c58a4bc32572c04fbf357d"}, "originalPosition": 79}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5ODE4NjEy", "url": "https://github.com/enonic/xp/pull/8508#pullrequestreview-539818612", "createdAt": "2020-11-27T09:17:35Z", "commit": {"oid": "8d91ca7a83bd6f5e84c58a4bc32572c04fbf357d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2987061d89047c7efee3052a74eda40fcd7d5045", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/2987061d89047c7efee3052a74eda40fcd7d5045", "committedDate": "2020-11-27T10:47:21Z", "message": "Allow to supply SHA512 in installApplication #8494"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8d91ca7a83bd6f5e84c58a4bc32572c04fbf357d", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/8d91ca7a83bd6f5e84c58a4bc32572c04fbf357d", "committedDate": "2020-11-27T07:55:24Z", "message": "Allow to supply SHA512 in installApplication #8494"}, "afterCommit": {"oid": "2987061d89047c7efee3052a74eda40fcd7d5045", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/2987061d89047c7efee3052a74eda40fcd7d5045", "committedDate": "2020-11-27T10:47:21Z", "message": "Allow to supply SHA512 in installApplication #8494"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwODI1NDY4", "url": "https://github.com/enonic/xp/pull/8508#pullrequestreview-540825468", "createdAt": "2020-11-30T11:35:34Z", "commit": {"oid": "2987061d89047c7efee3052a74eda40fcd7d5045"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4411, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}