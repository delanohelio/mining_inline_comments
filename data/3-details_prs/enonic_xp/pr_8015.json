{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxNDMwNzc2", "number": 8015, "title": "GIF images should not be scaled #8004", "bodyText": "", "createdAt": "2020-04-09T13:40:47Z", "url": "https://github.com/enonic/xp/pull/8015", "merged": true, "mergeCommit": {"oid": "12ef7b3ee9a04a0e58db8a30c37d7eb6f64e5b80"}, "closed": true, "closedAt": "2020-04-14T15:08:21Z", "author": {"login": "vbradnitski"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcWSTuRgFqTM5MTQ4NDE2Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXk7eSgFqTM5MzAyMzIwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNDg0MTY3", "url": "https://github.com/enonic/xp/pull/8015#pullrequestreview-391484167", "createdAt": "2020-04-10T14:52:14Z", "commit": {"oid": "d364caa89c75d47f4239e3e54ecbbcdbd62e7159"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNDo1MjoxNVrOGD8qbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNDo1MjoxNVrOGD8qbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc5MjgxMw==", "bodyText": "I am not sure that A needs here, I think renderAsSource will be better", "url": "https://github.com/enonic/xp/pull/8015#discussion_r406792813", "createdAt": "2020-04-10T14:52:15Z", "author": {"login": "anatol-sialitski"}, "path": "modules/core/core-image/src/main/java/com/enonic/xp/core/impl/image/ImageServiceImpl.java", "diffHunk": "@@ -53,67 +51,47 @@\n     public ByteSource readImage( final ReadImageParams readImageParams )\n         throws IOException\n     {\n-        final Path cachedImagePath = getCachedImagePath( readImageParams );\n-        ByteSource imageByteSource = ImmutableFilesHelper.computeIfAbsent( cachedImagePath, () -> createImage( readImageParams ) );\n-        return imageByteSource;\n+        final String format = doGetFormatByMimeType( readImageParams.getMimeType() );\n+\n+        if ( renderAsASource( format ) )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d364caa89c75d47f4239e3e54ecbbcdbd62e7159"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNTM5MTc1", "url": "https://github.com/enonic/xp/pull/8015#pullrequestreview-391539175", "createdAt": "2020-04-10T16:39:47Z", "commit": {"oid": "d364caa89c75d47f4239e3e54ecbbcdbd62e7159"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNjozOTo0N1rOGD_fuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNjo0NjoyNVrOGD_qxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgzOTIyNA==", "bodyText": "It seems unnecessary to extract format from MIME type here as we only ignore processing very well defined image/gif MIME. So we can remove renderAsASource altogether and replace it with plain \"image/gif\".equals(readImageParams.getMimeType())", "url": "https://github.com/enonic/xp/pull/8015#discussion_r406839224", "createdAt": "2020-04-10T16:39:47Z", "author": {"login": "rymsha"}, "path": "modules/core/core-image/src/main/java/com/enonic/xp/core/impl/image/ImageServiceImpl.java", "diffHunk": "@@ -53,67 +51,47 @@\n     public ByteSource readImage( final ReadImageParams readImageParams )\n         throws IOException\n     {\n-        final Path cachedImagePath = getCachedImagePath( readImageParams );\n-        ByteSource imageByteSource = ImmutableFilesHelper.computeIfAbsent( cachedImagePath, () -> createImage( readImageParams ) );\n-        return imageByteSource;\n+        final String format = doGetFormatByMimeType( readImageParams.getMimeType() );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d364caa89c75d47f4239e3e54ecbbcdbd62e7159"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg0MjA1Mg==", "bodyText": "Move calculation of \"format\" here, so it is also guarded by cache.", "url": "https://github.com/enonic/xp/pull/8015#discussion_r406842052", "createdAt": "2020-04-10T16:46:25Z", "author": {"login": "rymsha"}, "path": "modules/core/core-image/src/main/java/com/enonic/xp/core/impl/image/ImageServiceImpl.java", "diffHunk": "@@ -157,9 +135,6 @@ else if ( readImageParams.isScaleWidth() )\n         //Filter string value\n         final String filter = readImageParams.getFilterParam() != null ? readImageParams.getFilterParam() : \"no-filter\";\n \n-        //Format string value\n-        final String format = readImageParams.getFormat();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d364caa89c75d47f4239e3e54ecbbcdbd62e7159"}, "originalPosition": 113}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNTQyOTM2", "url": "https://github.com/enonic/xp/pull/8015#pullrequestreview-391542936", "createdAt": "2020-04-10T16:47:11Z", "commit": {"oid": "d364caa89c75d47f4239e3e54ecbbcdbd62e7159"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNjo0NzoxMVrOGD_sCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNjo0NzoxMVrOGD_sCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg0MjM3Ng==", "bodyText": "dead code. remove", "url": "https://github.com/enonic/xp/pull/8015#discussion_r406842376", "createdAt": "2020-04-10T16:47:11Z", "author": {"login": "rymsha"}, "path": "modules/core/core-image/src/test/java/com/enonic/xp/core/impl/image/ImageServiceImplTest.java", "diffHunk": "@@ -62,7 +60,7 @@ public void setUp()\n         imageService.setImageFilterBuilder( imageFilterBuilder );\n     }\n \n-    @Test\n+    /*@Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d364caa89c75d47f4239e3e54ecbbcdbd62e7159"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d364caa89c75d47f4239e3e54ecbbcdbd62e7159", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/d364caa89c75d47f4239e3e54ecbbcdbd62e7159", "committedDate": "2020-04-09T13:04:59Z", "message": "GIF images should not be scaled #8004"}, "afterCommit": {"oid": "668a11c9a17006f1ec605c37ecc9459bd0ee26e1", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/668a11c9a17006f1ec605c37ecc9459bd0ee26e1", "committedDate": "2020-04-14T13:17:57Z", "message": "GIF images should not be scaled #8004"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18ed6e2c6b65b68ba5ee9be7424a3f08785c0f12", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/18ed6e2c6b65b68ba5ee9be7424a3f08785c0f12", "committedDate": "2020-04-14T14:13:57Z", "message": "GIF images should not be scaled #8004"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "668a11c9a17006f1ec605c37ecc9459bd0ee26e1", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/668a11c9a17006f1ec605c37ecc9459bd0ee26e1", "committedDate": "2020-04-14T13:17:57Z", "message": "GIF images should not be scaled #8004"}, "afterCommit": {"oid": "18ed6e2c6b65b68ba5ee9be7424a3f08785c0f12", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/18ed6e2c6b65b68ba5ee9be7424a3f08785c0f12", "committedDate": "2020-04-14T14:13:57Z", "message": "GIF images should not be scaled #8004"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyOTU1NTk3", "url": "https://github.com/enonic/xp/pull/8015#pullrequestreview-392955597", "createdAt": "2020-04-14T14:00:24Z", "commit": {"oid": "d364caa89c75d47f4239e3e54ecbbcdbd62e7159"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMDIzMjAy", "url": "https://github.com/enonic/xp/pull/8015#pullrequestreview-393023202", "createdAt": "2020-04-14T15:07:53Z", "commit": {"oid": "18ed6e2c6b65b68ba5ee9be7424a3f08785c0f12"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4519, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}