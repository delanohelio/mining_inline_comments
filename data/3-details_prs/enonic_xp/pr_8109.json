{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxOTc5NTMw", "number": 8109, "title": "Audit logs appear to always be created as \"anonymous\" user #8079", "bodyText": "", "createdAt": "2020-05-22T15:16:34Z", "url": "https://github.com/enonic/xp/pull/8109", "merged": true, "mergeCommit": {"oid": "4ff59cc981b324c78e39fa496322bcc7292cdf91"}, "closed": true, "closedAt": "2020-05-25T10:14:06Z", "author": {"login": "anatol-sialitski"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcj1qX6gH2gAyNDIxOTc5NTMwOjM5ZDMxMzQzMWNhNzhhOWE1MmFhZmVjNzQ3YzVmODRiZThmZDg5NDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABckr-HLgFqTQxNzU1NDE1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "39d313431ca78a9a52aafec747c5f84be8fd8949", "author": {"user": {"login": "anatol-sialitski", "name": null}}, "url": "https://github.com/enonic/xp/commit/39d313431ca78a9a52aafec747c5f84be8fd8949", "committedDate": "2020-05-22T17:24:41Z", "message": "Audit logs appear to always be created as \"anonymous\" user #8079"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0024535a3175421a0f390e1ee86813264a35360a", "author": {"user": {"login": "anatol-sialitski", "name": null}}, "url": "https://github.com/enonic/xp/commit/0024535a3175421a0f390e1ee86813264a35360a", "committedDate": "2020-05-22T15:13:41Z", "message": "Audit logs appear to always be created as \"anonymous\" user #8079"}, "afterCommit": {"oid": "39d313431ca78a9a52aafec747c5f84be8fd8949", "author": {"user": {"login": "anatol-sialitski", "name": null}}, "url": "https://github.com/enonic/xp/commit/39d313431ca78a9a52aafec747c5f84be8fd8949", "committedDate": "2020-05-22T17:24:41Z", "message": "Audit logs appear to always be created as \"anonymous\" user #8079"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MTQzMzE3", "url": "https://github.com/enonic/xp/pull/8109#pullrequestreview-417143317", "createdAt": "2020-05-22T19:28:41Z", "commit": {"oid": "39d313431ca78a9a52aafec747c5f84be8fd8949"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxOToyODo0MVrOGZhwrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxOToyODo0MVrOGZhwrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQyMDcxOQ==", "bodyText": "Use CompletableFuture and it will look great!\n(Tip: CF::runAsync has same signature as Executor::execute )", "url": "https://github.com/enonic/xp/pull/8109#discussion_r429420719", "createdAt": "2020-05-22T19:28:41Z", "author": {"login": "rymsha"}, "path": "modules/core/core-content/src/test/java/com/enonic/xp/core/impl/content/ContentAuditLogSupportImplTest.java", "diffHunk": "@@ -0,0 +1,101 @@\n+package com.enonic.xp.core.impl.content;\n+\n+import java.time.Instant;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Mockito;\n+\n+import com.enonic.xp.audit.AuditLogService;\n+import com.enonic.xp.audit.LogAuditLogParams;\n+import com.enonic.xp.content.Content;\n+import com.enonic.xp.content.ContentConstants;\n+import com.enonic.xp.content.ContentId;\n+import com.enonic.xp.content.ContentPath;\n+import com.enonic.xp.content.CreateContentParams;\n+import com.enonic.xp.context.Context;\n+import com.enonic.xp.context.ContextBuilder;\n+import com.enonic.xp.data.PropertyTree;\n+import com.enonic.xp.repository.RepositoryId;\n+import com.enonic.xp.schema.content.ContentTypeName;\n+import com.enonic.xp.security.IdProviderKey;\n+import com.enonic.xp.security.PrincipalKey;\n+import com.enonic.xp.security.RoleKeys;\n+import com.enonic.xp.security.User;\n+import com.enonic.xp.security.auth.AuthenticationInfo;\n+\n+public class ContentAuditLogSupportImplTest\n+{\n+\n+    @Test\n+    public void testCreateContent()\n+        throws Exception\n+    {\n+        // mock\n+        final ContentConfig config = Mockito.mock( ContentConfig.class );\n+\n+        final AuditLogService auditLogService = Mockito.mock( AuditLogService.class );\n+\n+        Mockito.when( config.auditlog_enabled() ).thenReturn( true );\n+\n+        // prepare\n+        final ExecutorService executor = Executors.newSingleThreadExecutor();\n+\n+        final ContentAuditLogSupportImpl support = new ContentAuditLogSupportImpl( config, executor, auditLogService );\n+\n+        final PropertyTree propertyTree = new PropertyTree();\n+        propertyTree.addString( \"test-data\", \"test-data\" );\n+\n+        final CreateContentParams params = CreateContentParams.create().\n+            type( ContentTypeName.site() ).\n+            parent( ContentPath.ROOT ).\n+            contentData( propertyTree ).\n+            displayName( \"displayName\" ).build();\n+\n+        final Content content = Content.create().\n+            id( ContentId.from( \"contentId\" ) ).\n+            type( ContentTypeName.site() ).\n+            name( \"contentName\" ).\n+            displayName( \"displayName\" ).\n+            parentPath( ContentPath.ROOT ).\n+            build();\n+\n+        final User user = User.create().\n+            key( PrincipalKey.ofUser( IdProviderKey.system(), \"testUser\" ) ).\n+            displayName( \"Test User\" ).\n+            modifiedTime( Instant.now() ).\n+            email( \"test-user@enonic.com\" ).\n+            login( \"test-user\" ).\n+            build();\n+\n+        final AuthenticationInfo authInfo = AuthenticationInfo.create().\n+            user( user ).\n+            principals( RoleKeys.ADMIN_LOGIN ).\n+            build();\n+\n+        final Context context = ContextBuilder.create().\n+            branch( ContentConstants.BRANCH_DRAFT ).\n+            repositoryId( RepositoryId.from( \"test-repository\" ) ).\n+            authInfo( authInfo ).\n+            build();\n+\n+        // test\n+        context.runWith( () -> support.createContent( params, content ) );\n+\n+        executor.shutdown();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39d313431ca78a9a52aafec747c5f84be8fd8949"}, "originalPosition": 89}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3NTU0MTU1", "url": "https://github.com/enonic/xp/pull/8109#pullrequestreview-417554155", "createdAt": "2020-05-25T08:41:08Z", "commit": {"oid": "39d313431ca78a9a52aafec747c5f84be8fd8949"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4556, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}