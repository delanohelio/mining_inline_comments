{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3NzQzMzg1", "number": 8219, "reviewThreads": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToxNTowMVrOENfByQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOTozMjozOVrOENfGaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNTc1MzA1OnYy", "diffSide": "RIGHT", "path": "modules/core/core-repo/src/main/java/com/enonic/xp/repo/impl/elasticsearch/snapshot/ClusterCleaner.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToxNTowMVrOGwLozw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToxNTowMVrOGwLozw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3NTUwMw==", "bodyText": "40 is a magic number, that represents XP launcher start level. Find a way to un-hardcode it.", "url": "https://github.com/enonic/xp/pull/8219#discussion_r453175503", "createdAt": "2020-07-11T09:15:01Z", "author": {"login": "rymsha"}, "path": "modules/core/core-repo/src/main/java/com/enonic/xp/repo/impl/elasticsearch/snapshot/ClusterCleaner.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package com.enonic.xp.repo.impl.elasticsearch.snapshot;\n+\n+import org.osgi.framework.Bundle;\n+import org.osgi.framework.BundleContext;\n+import org.osgi.framework.BundleException;\n+import org.osgi.framework.startlevel.BundleStartLevel;\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.enonic.xp.event.Event;\n+import com.enonic.xp.event.EventListener;\n+import com.enonic.xp.repo.impl.RepositoryEvents;\n+\n+@Component(immediate = true)\n+public class ClusterCleaner\n+    implements EventListener\n+{\n+    private final static Logger LOG = LoggerFactory.getLogger( ClusterCleaner.class );\n+\n+    private final BundleContext bundleContext;\n+\n+    @Activate\n+    public ClusterCleaner( final BundleContext bundleContext )\n+    {\n+        this.bundleContext = bundleContext;\n+    }\n+\n+    @Override\n+    public void onEvent( final Event event )\n+    {\n+        if ( event.isType( RepositoryEvents.RESTORE_INITIALIZED_EVENT_TYPE ) )\n+        {\n+            for ( Bundle bundle : bundleContext.getBundles() )\n+            {\n+                if ( bundle.adapt( BundleStartLevel.class ).getStartLevel() > 40 )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNTc1MzQ2OnYy", "diffSide": "RIGHT", "path": "modules/core/core-repo/src/test/java/com/enonic/xp/repo/impl/dump/DumpServiceImplTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToxNToyMVrOGwLo-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToxNToyMVrOGwLo-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3NTU0Ng==", "bodyText": "grammar", "url": "https://github.com/enonic/xp/pull/8219#discussion_r453175546", "createdAt": "2020-07-11T09:15:21Z", "author": {"login": "rymsha"}, "path": "modules/core/core-repo/src/test/java/com/enonic/xp/repo/impl/dump/DumpServiceImplTest.java", "diffHunk": "@@ -1083,8 +1089,11 @@ private Node updateNode( final Node node )\n     {\n         return updateNode( UpdateNodeParams.create().\n             id( node.id() ).\n-            editor( ( n ) -> n.data.setInstant( \"timestamp\", Instant.now() ) ).\n+            editor( ( n ) -> {\n+                // Guarantee new node version is created. Without it update is ignored because node is not changed.\n+                // N.B. Writing \"current time\" (even System#nanoTime) does not have the same guarantee due low to timer resolution.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "originalPosition": 190}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNTc1Mzc1OnYy", "diffSide": "LEFT", "path": "modules/core/core-api/src/main/java/com/enonic/xp/data/PropertyPath.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToxNTo0NlrOGwLpHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToxNTo0NlrOGwLpHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3NTU4MA==", "bodyText": "move to own PR", "url": "https://github.com/enonic/xp/pull/8219#discussion_r453175580", "createdAt": "2020-07-11T09:15:46Z", "author": {"login": "rymsha"}, "path": "modules/core/core-api/src/main/java/com/enonic/xp/data/PropertyPath.java", "diffHunk": "@@ -35,7 +35,7 @@\n     public static PropertyPath from( final PropertyPath parentPath, final String element )\n     {\n         Preconditions.checkNotNull( parentPath, \"parentPath cannot be null\" );\n-        Preconditions.checkNotNull( parentPath, \"element cannot be null\" );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNTc1NDQzOnYy", "diffSide": "RIGHT", "path": "modules/core/core-api/src/main/java/com/enonic/xp/init/Initializer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToxNjo0MVrOGwLpbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToxNjo0MVrOGwLpbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3NTY2MA==", "bodyText": "call it readyToInitialize", "url": "https://github.com/enonic/xp/pull/8219#discussion_r453175660", "createdAt": "2020-07-11T09:16:41Z", "author": {"login": "rymsha"}, "path": "modules/core/core-api/src/main/java/com/enonic/xp/init/Initializer.java", "diffHunk": "@@ -72,6 +84,8 @@ public void initialize()\n \n     protected abstract void doInitialize();\n \n+    protected abstract boolean canInitialize();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNTc1NDk1OnYy", "diffSide": "RIGHT", "path": "modules/core/core-api/src/main/java/com/enonic/xp/repository/CreateRepositoryParams.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToxNzoxOVrOGwLppg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToxNzoxOVrOGwLppg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3NTcxOA==", "bodyText": "It would be nice not to extend API.", "url": "https://github.com/enonic/xp/pull/8219#discussion_r453175718", "createdAt": "2020-07-11T09:17:19Z", "author": {"login": "rymsha"}, "path": "modules/core/core-api/src/main/java/com/enonic/xp/repository/CreateRepositoryParams.java", "diffHunk": "@@ -54,6 +57,11 @@ public ChildOrder getRootChildOrder()\n         return rootChildOrder;\n     }\n \n+    public boolean isFailIfExists()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNTc1NzA5OnYy", "diffSide": "RIGHT", "path": "modules/core/core-elasticsearch/src/main/java/com/enonic/xp/elasticsearch/impl/ElasticsearchCluster.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToyMDozN1rOGwLqpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToyMDozN1rOGwLqpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3NTk3NQ==", "bodyText": "make green not part of default branch", "url": "https://github.com/enonic/xp/pull/8219#discussion_r453175975", "createdAt": "2020-07-11T09:20:37Z", "author": {"login": "rymsha"}, "path": "modules/core/core-elasticsearch/src/main/java/com/enonic/xp/elasticsearch/impl/ElasticsearchCluster.java", "diffHunk": "@@ -192,26 +124,24 @@ private DiscoveryNodes getMembers()\n             indices( \"\" ).\n             masterNodeTimeout( CLUSTER_HEALTH_TIMEOUT );\n \n-        final ClusterStateResponse response = this.node.client().admin().cluster().state( clusterStateRequest ).actionGet();\n+        final ClusterStateResponse response = node.client().admin().cluster().state( clusterStateRequest ).actionGet();\n \n         return response.getState().getNodes();\n     }\n \n     private ClusterHealth toClusterHealth( final ClusterHealthResponse healthResponse )\n     {\n-        if ( healthResponse.getStatus() == org.elasticsearch.cluster.health.ClusterHealthStatus.RED )\n+        switch ( healthResponse.getStatus() )\n         {\n-            return ClusterHealth.create().\n-                status( ClusterHealthStatus.RED ).\n-                errorMessage( healthResponse.toString() ).\n-                build();\n+            case RED:\n+                return ClusterHealth.create().\n+                    status( ClusterHealthStatus.RED ).\n+                    errorMessage( healthResponse.toString() ).\n+                    build();\n+            case YELLOW:\n+                return ClusterHealth.yellow();\n+            default:\n+                return ClusterHealth.green();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "originalPosition": 183}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNTc1OTk5OnYy", "diffSide": "RIGHT", "path": "modules/core/core-repo/src/main/java/com/enonic/xp/repo/impl/dump/RepoDumper.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToyNToxMlrOGwLsAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToyNToxMlrOGwLsAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3NjMyMg==", "bodyText": "de-optimize / inline", "url": "https://github.com/enonic/xp/pull/8219#discussion_r453176322", "createdAt": "2020-07-11T09:25:12Z", "author": {"login": "rymsha"}, "path": "modules/core/core-repo/src/main/java/com/enonic/xp/repo/impl/dump/RepoDumper.java", "diffHunk": "@@ -77,11 +76,11 @@\n \n     private RepoDumper( final Builder builder )\n     {\n-        this.repositoryId = builder.repositoryId;\n+        this.repository = builder.repository;\n+        this.repositoryId = builder.repository.getId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNTc2MDkyOnYy", "diffSide": "RIGHT", "path": "modules/core/core-project/src/main/java/com/enonic/xp/core/impl/project/ProjectServiceImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToyNjozM1rOGwLsdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToyNjozM1rOGwLsdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3NjQzNg==", "bodyText": "should be a better way to fail if exists. don't do a check here.", "url": "https://github.com/enonic/xp/pull/8219#discussion_r453176436", "createdAt": "2020-07-11T09:26:33Z", "author": {"login": "rymsha"}, "path": "modules/core/core-project/src/main/java/com/enonic/xp/core/impl/project/ProjectServiceImpl.java", "diffHunk": "@@ -74,22 +73,21 @@\n     @Activate\n     public void initialize()\n     {\n-        adminContext().runWith( () -> {\n-            if ( doGet( ProjectName.from( ContentConstants.CONTENT_REPO_ID ) ) == null )\n-            {\n-                doCreate( CreateProjectParams.create().\n-                    name( ProjectConstants.DEFAULT_PROJECT.getName() ).\n-                    displayName( ProjectConstants.DEFAULT_PROJECT.getDisplayName() ).\n-                    description( ProjectConstants.DEFAULT_PROJECT.getDescription() ).\n-                    build() );\n-            }\n-        } );\n+        adminContext().runWith( () -> doCreate( CreateProjectParams.create().\n+            name( ProjectConstants.DEFAULT_PROJECT.getName() ).\n+            displayName( ProjectConstants.DEFAULT_PROJECT.getDisplayName() ).\n+            description( ProjectConstants.DEFAULT_PROJECT.getDescription() ).\n+            build() ) );\n     }\n \n     @Override\n     public Project create( CreateProjectParams params )\n     {\n         return callWithCreateContext( ( () -> {\n+            if ( repositoryService.isInitialized( params.getName().getRepoId() ) )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNTc2MTY5OnYy", "diffSide": "RIGHT", "path": "modules/core/core-repo/src/main/java/com/enonic/xp/repo/impl/elasticsearch/IndexServiceInternalImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToyNzo1MVrOGwLs1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToyNzo1MVrOGwLs1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3NjUzNQ==", "bodyText": "rearrange code, for there are only two returns.", "url": "https://github.com/enonic/xp/pull/8219#discussion_r453176535", "createdAt": "2020-07-11T09:27:51Z", "author": {"login": "rymsha"}, "path": "modules/core/core-repo/src/main/java/com/enonic/xp/repo/impl/elasticsearch/IndexServiceInternalImpl.java", "diffHunk": "@@ -109,6 +105,31 @@ public boolean isMaster()\n         return clusterStateResponse.getState().nodes().localNodeMaster();\n     }\n \n+    @Override\n+    public boolean waitForYellowStatus( final String... indexNames )\n+    {\n+        try\n+        {\n+            final ClusterHealthStatus clusterHealth = doGetClusterHealth( CLUSTER_HEALTH_TIMEOUT, indexNames );\n+\n+            if ( clusterHealth.isTimedOut() || clusterHealth.getClusterStatusCode().equals( ClusterStatusCode.RED ) )\n+            {\n+                LOG.error( \"Cluster not healthy: timed out: {}, state: {}\", clusterHealth.isTimedOut(),\n+                           clusterHealth.getClusterStatusCode() );\n+                return false;\n+            }\n+\n+            return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNTc2MjU4OnYy", "diffSide": "RIGHT", "path": "modules/core/core-repo/src/main/java/com/enonic/xp/repo/impl/elasticsearch/snapshot/ClusterCleaner.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToyOToxNlrOGwLtQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToyOToxNlrOGwLtQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3NjY0Mg==", "bodyText": "find a better name", "url": "https://github.com/enonic/xp/pull/8219#discussion_r453176642", "createdAt": "2020-07-11T09:29:16Z", "author": {"login": "rymsha"}, "path": "modules/core/core-repo/src/main/java/com/enonic/xp/repo/impl/elasticsearch/snapshot/ClusterCleaner.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package com.enonic.xp.repo.impl.elasticsearch.snapshot;\n+\n+import org.osgi.framework.Bundle;\n+import org.osgi.framework.BundleContext;\n+import org.osgi.framework.BundleException;\n+import org.osgi.framework.startlevel.BundleStartLevel;\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.enonic.xp.event.Event;\n+import com.enonic.xp.event.EventListener;\n+import com.enonic.xp.repo.impl.RepositoryEvents;\n+\n+@Component(immediate = true)\n+public class ClusterCleaner", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNTc2NDg5OnYy", "diffSide": "RIGHT", "path": "modules/runtime/build.gradle", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOTozMjozOVrOGwLuXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOTozMjozOVrOGwLuXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3NjkyNQ==", "bodyText": "Move to own PR", "url": "https://github.com/enonic/xp/pull/8219#discussion_r453176925", "createdAt": "2020-07-11T09:32:39Z", "author": {"login": "rymsha"}, "path": "modules/runtime/build.gradle", "diffHunk": "@@ -1,6 +1,7 @@\n import org.apache.tools.ant.filters.ReplaceTokens\n \n apply plugin: 'java-base'\n+apply plugin: 'distribution'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 991, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}