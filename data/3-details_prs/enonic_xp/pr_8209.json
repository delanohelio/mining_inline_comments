{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2MzAyOTkz", "number": 8209, "title": "Sync content immediately when content from parent project ready #8181", "bodyText": "", "createdAt": "2020-07-08T15:01:43Z", "url": "https://github.com/enonic/xp/pull/8209", "merged": true, "mergeCommit": {"oid": "7dc3cfd92be74582972e7f7b1fe2cebfa8701cdc"}, "closed": true, "closedAt": "2020-07-09T14:22:32Z", "author": {"login": "vbradnitski"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczOgJMABqjM1Mjk1NDM5NjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczPom4gBqjM1Mjk4ODY0ODE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "89004ca60ecace7c02f0abbd6e710e5daef26aa2", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/89004ca60ecace7c02f0abbd6e710e5daef26aa2", "committedDate": "2020-07-08T15:00:49Z", "message": "Sync content immediately when content from parent project ready #8181"}, "afterCommit": {"oid": "c9b89485f536900265c99cfcf07f774534b2319e", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/c9b89485f536900265c99cfcf07f774534b2319e", "committedDate": "2020-07-09T12:49:34Z", "message": "Sync content immediately when content from parent project ready #8181"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NTk1ODQz", "url": "https://github.com/enonic/xp/pull/8209#pullrequestreview-445595843", "createdAt": "2020-07-09T13:06:41Z", "commit": {"oid": "c9b89485f536900265c99cfcf07f774534b2319e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMzowNjo0MVrOGvQQdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMzowNjo0MVrOGvQQdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjIwMjYxMg==", "bodyText": "Offload loops and heavy tasks into a separate thread (it still need to be in order, so for now single threaded thread pool would work)", "url": "https://github.com/enonic/xp/pull/8209#discussion_r452202612", "createdAt": "2020-07-09T13:06:41Z", "author": {"login": "rymsha"}, "path": "modules/core/core-project/src/main/java/com/enonic/xp/core/impl/project/ProjectNodeEventListener.java", "diffHunk": "@@ -0,0 +1,129 @@\n+package com.enonic.xp.core.impl.project;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Reference;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.enonic.xp.content.ContentConstants;\n+import com.enonic.xp.content.ContentId;\n+import com.enonic.xp.content.ContentService;\n+import com.enonic.xp.context.Context;\n+import com.enonic.xp.context.ContextBuilder;\n+import com.enonic.xp.event.Event;\n+import com.enonic.xp.event.EventListener;\n+import com.enonic.xp.project.Project;\n+import com.enonic.xp.project.ProjectName;\n+import com.enonic.xp.project.ProjectService;\n+import com.enonic.xp.repository.RepositoryId;\n+import com.enonic.xp.security.PrincipalKey;\n+import com.enonic.xp.security.RoleKeys;\n+import com.enonic.xp.security.User;\n+import com.enonic.xp.security.auth.AuthenticationInfo;\n+\n+@Component(immediate = true)\n+public class ProjectNodeEventListener\n+    implements EventListener\n+{\n+    private final static Logger LOG = LoggerFactory.getLogger( ProjectNodeEventListener.class );\n+\n+    private ProjectService projectService;\n+\n+    private ContentService contentService;\n+\n+    @Override\n+    public void onEvent( final Event event )\n+    {\n+        if ( event != null )\n+        {\n+            createAdminContext().runWith( () -> doHandleEvent( event ) );\n+        }\n+    }\n+\n+    private void doHandleEvent( final Event event )\n+    {\n+        final String type = event.getType();\n+\n+        switch ( type )\n+        {\n+            case \"node.created\":\n+                handleEventType( event );\n+                break;\n+            case \"node.updated\":\n+                handleEventType( event );\n+                break;\n+        }\n+    }\n+\n+    private void handleEventType( final Event event )\n+    {\n+        try\n+        {\n+            final List<Map<String, String>> nodes = (List<Map<String, String>>) event.getData().get( \"nodes\" );\n+\n+            nodes.forEach( nodeMap -> {\n+                if ( nodeMap.get( \"path\" ).startsWith( \"/content/\" ) )\n+                {\n+                    final ProjectName currentProjectName = ProjectName.from( RepositoryId.from( nodeMap.get( \"repo\" ) ) );\n+\n+                    final Project sourceProject = this.projectService.list().\n+                        stream().\n+                        filter( project -> currentProjectName.equals( project.getName() ) ).\n+                        findAny().\n+                        orElse( null );\n+\n+                    this.projectService.list().\n+                        stream().\n+                        filter( project -> currentProjectName.equals( project.getParent() ) ).\n+                        forEach( targetProject -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9b89485f536900265c99cfcf07f774534b2319e"}, "originalPosition": 81}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c9b89485f536900265c99cfcf07f774534b2319e", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/c9b89485f536900265c99cfcf07f774534b2319e", "committedDate": "2020-07-09T12:49:34Z", "message": "Sync content immediately when content from parent project ready #8181"}, "afterCommit": {"oid": "9adacce73fe666c2f0156f751a9daa4a82954b10", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/9adacce73fe666c2f0156f751a9daa4a82954b10", "committedDate": "2020-07-09T13:52:56Z", "message": "Sync content immediately when content from parent project ready #8181"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NjQyMTY2", "url": "https://github.com/enonic/xp/pull/8209#pullrequestreview-445642166", "createdAt": "2020-07-09T13:57:35Z", "commit": {"oid": "9adacce73fe666c2f0156f751a9daa4a82954b10"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bde4b9ae79afacbd0aea4898f9372733cc30a0cc", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/bde4b9ae79afacbd0aea4898f9372733cc30a0cc", "committedDate": "2020-07-09T14:08:52Z", "message": "Sync content immediately when content from parent project ready #8181"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9adacce73fe666c2f0156f751a9daa4a82954b10", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/9adacce73fe666c2f0156f751a9daa4a82954b10", "committedDate": "2020-07-09T13:52:56Z", "message": "Sync content immediately when content from parent project ready #8181"}, "afterCommit": {"oid": "bde4b9ae79afacbd0aea4898f9372733cc30a0cc", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/bde4b9ae79afacbd0aea4898f9372733cc30a0cc", "committedDate": "2020-07-09T14:08:52Z", "message": "Sync content immediately when content from parent project ready #8181"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4437, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}