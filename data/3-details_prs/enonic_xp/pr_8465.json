{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3ODgxMzM3", "number": 8465, "title": "  Extend Management with App events #8451", "bodyText": "", "createdAt": "2020-11-09T16:24:35Z", "url": "https://github.com/enonic/xp/pull/8465", "merged": true, "mergeCommit": {"oid": "f8896b819c576806b0b47888f9b625a279294ac6"}, "closed": true, "closedAt": "2020-11-11T15:31:33Z", "author": {"login": "anatol-sialitski"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABda3oeJgFqTUyNjQzODQ1Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbdt7OAFqTUyODE1NzI5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NDM4NDU3", "url": "https://github.com/enonic/xp/pull/8465#pullrequestreview-526438457", "createdAt": "2020-11-09T16:36:46Z", "commit": {"oid": "f4bd2e808e27534cbf4fe73ab81b8864648571fe"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNjozNjo0NlrOHv3PLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNjo0NjoyMFrOHv3tjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk1MDEyNQ==", "bodyText": "Should be in apps", "url": "https://github.com/enonic/xp/pull/8465#discussion_r519950125", "createdAt": "2020-11-09T16:36:46Z", "author": {"login": "rymsha"}, "path": "modules/server/server-rest/src/main/java/com/enonic/xp/impl/server/rest/SseEntryPoint.java", "diffHunk": "@@ -0,0 +1,169 @@\n+package com.enonic.xp.impl.server.rest;\n+\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.sse.OutboundSseEvent;\n+import javax.ws.rs.sse.Sse;\n+import javax.ws.rs.sse.SseBroadcaster;\n+import javax.ws.rs.sse.SseEventSink;\n+\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Deactivate;\n+import org.osgi.service.component.annotations.Reference;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.enonic.xp.app.Application;\n+import com.enonic.xp.app.ApplicationKey;\n+import com.enonic.xp.app.ApplicationNotFoundException;\n+import com.enonic.xp.app.ApplicationService;\n+import com.enonic.xp.event.Event;\n+import com.enonic.xp.event.EventListener;\n+import com.enonic.xp.impl.server.rest.model.ApplicationInfoJson;\n+import com.enonic.xp.impl.server.rest.model.ApplicationUninstalledJson;\n+import com.enonic.xp.impl.server.rest.model.ListApplicationJson;\n+import com.enonic.xp.jaxrs.JaxRsComponent;\n+\n+@Path(\"sse\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4bd2e808e27534cbf4fe73ab81b8864648571fe"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk1MDQ1Mw==", "bodyText": "Should be events", "url": "https://github.com/enonic/xp/pull/8465#discussion_r519950453", "createdAt": "2020-11-09T16:37:13Z", "author": {"login": "rymsha"}, "path": "modules/server/server-rest/src/main/java/com/enonic/xp/impl/server/rest/SseEntryPoint.java", "diffHunk": "@@ -0,0 +1,169 @@\n+package com.enonic.xp.impl.server.rest;\n+\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.sse.OutboundSseEvent;\n+import javax.ws.rs.sse.Sse;\n+import javax.ws.rs.sse.SseBroadcaster;\n+import javax.ws.rs.sse.SseEventSink;\n+\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Deactivate;\n+import org.osgi.service.component.annotations.Reference;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.enonic.xp.app.Application;\n+import com.enonic.xp.app.ApplicationKey;\n+import com.enonic.xp.app.ApplicationNotFoundException;\n+import com.enonic.xp.app.ApplicationService;\n+import com.enonic.xp.event.Event;\n+import com.enonic.xp.event.EventListener;\n+import com.enonic.xp.impl.server.rest.model.ApplicationInfoJson;\n+import com.enonic.xp.impl.server.rest.model.ApplicationUninstalledJson;\n+import com.enonic.xp.impl.server.rest.model.ListApplicationJson;\n+import com.enonic.xp.jaxrs.JaxRsComponent;\n+\n+@Path(\"sse\")\n+@Component(immediate = true, property = \"group=api\")\n+public class SseEntryPoint\n+    implements JaxRsComponent, EventListener\n+{\n+\n+    private static final Logger LOG = LoggerFactory.getLogger( SseEntryPoint.class );\n+\n+    private static final String EVENT_TYPE = \"application.cluster\";\n+\n+    private static final String EVENT_TYPE_KEY = \"eventType\";\n+\n+    private static final String INSTALLED = \"installed\";\n+\n+    private static final String START = \"start\";\n+\n+    private static final String STOP = \"stop\";\n+\n+    private static final String UNINSTALL = \"uninstall\";\n+\n+    private static final String UNINSTALLED = \"uninstalled\";\n+\n+    private static final String APPLICATION_KEY_PARAM = \"key\";\n+\n+    private final ApplicationService applicationService;\n+\n+    private SseBroadcaster sseBroadcaster;\n+\n+    private Sse sse;\n+\n+    @Activate\n+    public SseEntryPoint( final @Reference ApplicationService applicationService )\n+    {\n+        this.applicationService = applicationService;\n+    }\n+\n+    @Deactivate\n+    public void deactivate()\n+    {\n+        if ( sseBroadcaster != null )\n+        {\n+            sseBroadcaster.close();\n+        }\n+    }\n+\n+    @Context\n+    public void setSse( final Sse sse )\n+    {\n+        this.sse = sse;\n+        this.sseBroadcaster = sse.newBroadcaster();\n+    }\n+\n+    @GET\n+    @Path(\"subscribe-app-events\")\n+    @Produces(MediaType.SERVER_SENT_EVENTS)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4bd2e808e27534cbf4fe73ab81b8864648571fe"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk1MDg4MQ==", "bodyText": "Just list", "url": "https://github.com/enonic/xp/pull/8465#discussion_r519950881", "createdAt": "2020-11-09T16:37:51Z", "author": {"login": "rymsha"}, "path": "modules/server/server-rest/src/main/java/com/enonic/xp/impl/server/rest/SseEntryPoint.java", "diffHunk": "@@ -0,0 +1,169 @@\n+package com.enonic.xp.impl.server.rest;\n+\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.sse.OutboundSseEvent;\n+import javax.ws.rs.sse.Sse;\n+import javax.ws.rs.sse.SseBroadcaster;\n+import javax.ws.rs.sse.SseEventSink;\n+\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Deactivate;\n+import org.osgi.service.component.annotations.Reference;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.enonic.xp.app.Application;\n+import com.enonic.xp.app.ApplicationKey;\n+import com.enonic.xp.app.ApplicationNotFoundException;\n+import com.enonic.xp.app.ApplicationService;\n+import com.enonic.xp.event.Event;\n+import com.enonic.xp.event.EventListener;\n+import com.enonic.xp.impl.server.rest.model.ApplicationInfoJson;\n+import com.enonic.xp.impl.server.rest.model.ApplicationUninstalledJson;\n+import com.enonic.xp.impl.server.rest.model.ListApplicationJson;\n+import com.enonic.xp.jaxrs.JaxRsComponent;\n+\n+@Path(\"sse\")\n+@Component(immediate = true, property = \"group=api\")\n+public class SseEntryPoint\n+    implements JaxRsComponent, EventListener\n+{\n+\n+    private static final Logger LOG = LoggerFactory.getLogger( SseEntryPoint.class );\n+\n+    private static final String EVENT_TYPE = \"application.cluster\";\n+\n+    private static final String EVENT_TYPE_KEY = \"eventType\";\n+\n+    private static final String INSTALLED = \"installed\";\n+\n+    private static final String START = \"start\";\n+\n+    private static final String STOP = \"stop\";\n+\n+    private static final String UNINSTALL = \"uninstall\";\n+\n+    private static final String UNINSTALLED = \"uninstalled\";\n+\n+    private static final String APPLICATION_KEY_PARAM = \"key\";\n+\n+    private final ApplicationService applicationService;\n+\n+    private SseBroadcaster sseBroadcaster;\n+\n+    private Sse sse;\n+\n+    @Activate\n+    public SseEntryPoint( final @Reference ApplicationService applicationService )\n+    {\n+        this.applicationService = applicationService;\n+    }\n+\n+    @Deactivate\n+    public void deactivate()\n+    {\n+        if ( sseBroadcaster != null )\n+        {\n+            sseBroadcaster.close();\n+        }\n+    }\n+\n+    @Context\n+    public void setSse( final Sse sse )\n+    {\n+        this.sse = sse;\n+        this.sseBroadcaster = sse.newBroadcaster();\n+    }\n+\n+    @GET\n+    @Path(\"subscribe-app-events\")\n+    @Produces(MediaType.SERVER_SENT_EVENTS)\n+    public void subscribe( @Context SseEventSink sseEventSink )\n+    {\n+        this.sseBroadcaster.register( sseEventSink );\n+\n+        final OutboundSseEvent sseEvent = sse.newEventBuilder().\n+            name( \"List of applications\" ).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4bd2e808e27534cbf4fe73ab81b8864648571fe"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk1NjE2OQ==", "bodyText": "We maybe doing something wrong here. These events are global, but we probably need local (from bundle events)\nNeed to discuss.", "url": "https://github.com/enonic/xp/pull/8465#discussion_r519956169", "createdAt": "2020-11-09T16:44:49Z", "author": {"login": "rymsha"}, "path": "modules/server/server-rest/src/main/java/com/enonic/xp/impl/server/rest/SseEntryPoint.java", "diffHunk": "@@ -0,0 +1,169 @@\n+package com.enonic.xp.impl.server.rest;\n+\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.sse.OutboundSseEvent;\n+import javax.ws.rs.sse.Sse;\n+import javax.ws.rs.sse.SseBroadcaster;\n+import javax.ws.rs.sse.SseEventSink;\n+\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Deactivate;\n+import org.osgi.service.component.annotations.Reference;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.enonic.xp.app.Application;\n+import com.enonic.xp.app.ApplicationKey;\n+import com.enonic.xp.app.ApplicationNotFoundException;\n+import com.enonic.xp.app.ApplicationService;\n+import com.enonic.xp.event.Event;\n+import com.enonic.xp.event.EventListener;\n+import com.enonic.xp.impl.server.rest.model.ApplicationInfoJson;\n+import com.enonic.xp.impl.server.rest.model.ApplicationUninstalledJson;\n+import com.enonic.xp.impl.server.rest.model.ListApplicationJson;\n+import com.enonic.xp.jaxrs.JaxRsComponent;\n+\n+@Path(\"sse\")\n+@Component(immediate = true, property = \"group=api\")\n+public class SseEntryPoint\n+    implements JaxRsComponent, EventListener\n+{\n+\n+    private static final Logger LOG = LoggerFactory.getLogger( SseEntryPoint.class );\n+\n+    private static final String EVENT_TYPE = \"application.cluster\";\n+\n+    private static final String EVENT_TYPE_KEY = \"eventType\";\n+\n+    private static final String INSTALLED = \"installed\";\n+\n+    private static final String START = \"start\";\n+\n+    private static final String STOP = \"stop\";\n+\n+    private static final String UNINSTALL = \"uninstall\";\n+\n+    private static final String UNINSTALLED = \"uninstalled\";\n+\n+    private static final String APPLICATION_KEY_PARAM = \"key\";\n+\n+    private final ApplicationService applicationService;\n+\n+    private SseBroadcaster sseBroadcaster;\n+\n+    private Sse sse;\n+\n+    @Activate\n+    public SseEntryPoint( final @Reference ApplicationService applicationService )\n+    {\n+        this.applicationService = applicationService;\n+    }\n+\n+    @Deactivate\n+    public void deactivate()\n+    {\n+        if ( sseBroadcaster != null )\n+        {\n+            sseBroadcaster.close();\n+        }\n+    }\n+\n+    @Context\n+    public void setSse( final Sse sse )\n+    {\n+        this.sse = sse;\n+        this.sseBroadcaster = sse.newBroadcaster();\n+    }\n+\n+    @GET\n+    @Path(\"subscribe-app-events\")\n+    @Produces(MediaType.SERVER_SENT_EVENTS)\n+    public void subscribe( @Context SseEventSink sseEventSink )\n+    {\n+        this.sseBroadcaster.register( sseEventSink );\n+\n+        final OutboundSseEvent sseEvent = sse.newEventBuilder().\n+            name( \"List of applications\" ).\n+            id( UUID.randomUUID().toString() ).\n+            mediaType( MediaType.APPLICATION_JSON_TYPE ).\n+            data( ListApplicationJson.class, new ListApplicationJson( applicationService.getInstalledApplications().stream().\n+                map( application -> new ApplicationInfoJson( application, applicationService.isLocalApplication( application.getKey() ) ) ).\n+                collect( Collectors.toList() ) ) ).\n+            comment( \"List of installed applications\" ).build();\n+\n+        sseEventSink.send( sseEvent );\n+    }\n+\n+    @Override\n+    public void onEvent( final Event event )\n+    {\n+        if ( EVENT_TYPE.equals( event.getType() ) )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4bd2e808e27534cbf4fe73ab81b8864648571fe"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk1NzkwMw==", "bodyText": "Isn't it so that broadcaster always initialized?", "url": "https://github.com/enonic/xp/pull/8465#discussion_r519957903", "createdAt": "2020-11-09T16:46:20Z", "author": {"login": "rymsha"}, "path": "modules/server/server-rest/src/main/java/com/enonic/xp/impl/server/rest/SseEntryPoint.java", "diffHunk": "@@ -0,0 +1,169 @@\n+package com.enonic.xp.impl.server.rest;\n+\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.sse.OutboundSseEvent;\n+import javax.ws.rs.sse.Sse;\n+import javax.ws.rs.sse.SseBroadcaster;\n+import javax.ws.rs.sse.SseEventSink;\n+\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Deactivate;\n+import org.osgi.service.component.annotations.Reference;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.enonic.xp.app.Application;\n+import com.enonic.xp.app.ApplicationKey;\n+import com.enonic.xp.app.ApplicationNotFoundException;\n+import com.enonic.xp.app.ApplicationService;\n+import com.enonic.xp.event.Event;\n+import com.enonic.xp.event.EventListener;\n+import com.enonic.xp.impl.server.rest.model.ApplicationInfoJson;\n+import com.enonic.xp.impl.server.rest.model.ApplicationUninstalledJson;\n+import com.enonic.xp.impl.server.rest.model.ListApplicationJson;\n+import com.enonic.xp.jaxrs.JaxRsComponent;\n+\n+@Path(\"sse\")\n+@Component(immediate = true, property = \"group=api\")\n+public class SseEntryPoint\n+    implements JaxRsComponent, EventListener\n+{\n+\n+    private static final Logger LOG = LoggerFactory.getLogger( SseEntryPoint.class );\n+\n+    private static final String EVENT_TYPE = \"application.cluster\";\n+\n+    private static final String EVENT_TYPE_KEY = \"eventType\";\n+\n+    private static final String INSTALLED = \"installed\";\n+\n+    private static final String START = \"start\";\n+\n+    private static final String STOP = \"stop\";\n+\n+    private static final String UNINSTALL = \"uninstall\";\n+\n+    private static final String UNINSTALLED = \"uninstalled\";\n+\n+    private static final String APPLICATION_KEY_PARAM = \"key\";\n+\n+    private final ApplicationService applicationService;\n+\n+    private SseBroadcaster sseBroadcaster;\n+\n+    private Sse sse;\n+\n+    @Activate\n+    public SseEntryPoint( final @Reference ApplicationService applicationService )\n+    {\n+        this.applicationService = applicationService;\n+    }\n+\n+    @Deactivate\n+    public void deactivate()\n+    {\n+        if ( sseBroadcaster != null )\n+        {\n+            sseBroadcaster.close();\n+        }\n+    }\n+\n+    @Context\n+    public void setSse( final Sse sse )\n+    {\n+        this.sse = sse;\n+        this.sseBroadcaster = sse.newBroadcaster();\n+    }\n+\n+    @GET\n+    @Path(\"subscribe-app-events\")\n+    @Produces(MediaType.SERVER_SENT_EVENTS)\n+    public void subscribe( @Context SseEventSink sseEventSink )\n+    {\n+        this.sseBroadcaster.register( sseEventSink );\n+\n+        final OutboundSseEvent sseEvent = sse.newEventBuilder().\n+            name( \"List of applications\" ).\n+            id( UUID.randomUUID().toString() ).\n+            mediaType( MediaType.APPLICATION_JSON_TYPE ).\n+            data( ListApplicationJson.class, new ListApplicationJson( applicationService.getInstalledApplications().stream().\n+                map( application -> new ApplicationInfoJson( application, applicationService.isLocalApplication( application.getKey() ) ) ).\n+                collect( Collectors.toList() ) ) ).\n+            comment( \"List of installed applications\" ).build();\n+\n+        sseEventSink.send( sseEvent );\n+    }\n+\n+    @Override\n+    public void onEvent( final Event event )\n+    {\n+        if ( EVENT_TYPE.equals( event.getType() ) )\n+        {\n+            event.getValueAs( String.class, EVENT_TYPE_KEY ).\n+                ifPresent( eventSubType -> {\n+                    switch ( eventSubType )\n+                    {\n+                        case INSTALLED:\n+                        case START:\n+                        case STOP:\n+                        case UNINSTALL:\n+                        case UNINSTALLED:\n+                            handleEvent( event, eventSubType );\n+                            break;\n+                        default:\n+                            LOG.debug( \"Ignoring {} {}\", EVENT_TYPE, eventSubType );\n+                            break;\n+                    }\n+                } );\n+        }\n+    }\n+\n+    private void handleEvent( final Event event, final String eventSubType )\n+    {\n+        if ( sseBroadcaster == null )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4bd2e808e27534cbf4fe73ab81b8864648571fe"}, "originalPosition": 131}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f4bd2e808e27534cbf4fe73ab81b8864648571fe", "author": {"user": {"login": "anatol-sialitski", "name": null}}, "url": "https://github.com/enonic/xp/commit/f4bd2e808e27534cbf4fe73ab81b8864648571fe", "committedDate": "2020-11-09T16:23:07Z", "message": "Extend Management with App events #8451"}, "afterCommit": {"oid": "7e4e4c8bd9d93b0398329738aa1bc5f39f36f417", "author": {"user": {"login": "anatol-sialitski", "name": null}}, "url": "https://github.com/enonic/xp/commit/7e4e4c8bd9d93b0398329738aa1bc5f39f36f417", "committedDate": "2020-11-09T18:12:55Z", "message": "Extend Management with App events #8451"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NjcwNzA4", "url": "https://github.com/enonic/xp/pull/8465#pullrequestreview-526670708", "createdAt": "2020-11-09T21:31:40Z", "commit": {"oid": "7e4e4c8bd9d93b0398329738aa1bc5f39f36f417"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMTozMTo0MFrOHwCaZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMTozMTo0MFrOHwCaZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEzMzIyMQ==", "bodyText": "Must be admins only", "url": "https://github.com/enonic/xp/pull/8465#discussion_r520133221", "createdAt": "2020-11-09T21:31:40Z", "author": {"login": "rymsha"}, "path": "modules/server/server-rest/src/main/java/com/enonic/xp/impl/server/rest/SseEntryPoint.java", "diffHunk": "@@ -0,0 +1,169 @@\n+package com.enonic.xp.impl.server.rest;\n+\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.sse.OutboundSseEvent;\n+import javax.ws.rs.sse.Sse;\n+import javax.ws.rs.sse.SseBroadcaster;\n+import javax.ws.rs.sse.SseEventSink;\n+\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Deactivate;\n+import org.osgi.service.component.annotations.Reference;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.enonic.xp.app.Application;\n+import com.enonic.xp.app.ApplicationKey;\n+import com.enonic.xp.app.ApplicationNotFoundException;\n+import com.enonic.xp.app.ApplicationService;\n+import com.enonic.xp.event.Event;\n+import com.enonic.xp.event.EventListener;\n+import com.enonic.xp.impl.server.rest.model.ApplicationInfoJson;\n+import com.enonic.xp.impl.server.rest.model.ApplicationUninstalledJson;\n+import com.enonic.xp.impl.server.rest.model.ListApplicationJson;\n+import com.enonic.xp.jaxrs.JaxRsComponent;\n+\n+@Path(\"apps\")\n+@Component(immediate = true, property = \"group=api\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e4e4c8bd9d93b0398329738aa1bc5f39f36f417"}, "originalPosition": 35}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7e4e4c8bd9d93b0398329738aa1bc5f39f36f417", "author": {"user": {"login": "anatol-sialitski", "name": null}}, "url": "https://github.com/enonic/xp/commit/7e4e4c8bd9d93b0398329738aa1bc5f39f36f417", "committedDate": "2020-11-09T18:12:55Z", "message": "Extend Management with App events #8451"}, "afterCommit": {"oid": "ab60fb8a27999e1f35373f7d64938af5643e5a2f", "author": {"user": {"login": "anatol-sialitski", "name": null}}, "url": "https://github.com/enonic/xp/commit/ab60fb8a27999e1f35373f7d64938af5643e5a2f", "committedDate": "2020-11-10T12:17:40Z", "message": "Extend Management with App events #8451"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3MTc0MTM0", "url": "https://github.com/enonic/xp/pull/8465#pullrequestreview-527174134", "createdAt": "2020-11-10T12:57:14Z", "commit": {"oid": "ab60fb8a27999e1f35373f7d64938af5643e5a2f"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxMjo1NzoxNFrOHwbUSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxMzowMDoxNFrOHwbbhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU0MTI1OQ==", "bodyText": "static", "url": "https://github.com/enonic/xp/pull/8465#discussion_r520541259", "createdAt": "2020-11-10T12:57:14Z", "author": {"login": "rymsha"}, "path": "modules/server/server-rest/src/main/java/com/enonic/xp/impl/server/rest/SseEntryPoint.java", "diffHunk": "@@ -0,0 +1,190 @@\n+package com.enonic.xp.impl.server.rest;\n+\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+\n+import javax.annotation.security.RolesAllowed;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.sse.OutboundSseEvent;\n+import javax.ws.rs.sse.Sse;\n+import javax.ws.rs.sse.SseBroadcaster;\n+import javax.ws.rs.sse.SseEventSink;\n+\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Deactivate;\n+import org.osgi.service.component.annotations.Reference;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.enonic.xp.app.Application;\n+import com.enonic.xp.app.ApplicationKey;\n+import com.enonic.xp.app.ApplicationNotFoundException;\n+import com.enonic.xp.app.ApplicationService;\n+import com.enonic.xp.event.Event;\n+import com.enonic.xp.event.EventListener;\n+import com.enonic.xp.impl.server.rest.model.ApplicationInfoJson;\n+import com.enonic.xp.impl.server.rest.model.ApplicationUninstalledJson;\n+import com.enonic.xp.impl.server.rest.model.ListApplicationJson;\n+import com.enonic.xp.jaxrs.JaxRsComponent;\n+import com.enonic.xp.security.RoleKeys;\n+\n+@Path(\"app\")\n+@RolesAllowed(RoleKeys.ADMIN_ID)\n+@Component(immediate = true, property = \"group=api\")\n+public class SseEntryPoint\n+    implements JaxRsComponent, EventListener\n+{\n+\n+    private static final Logger LOG = LoggerFactory.getLogger( SseEntryPoint.class );\n+\n+    private static final String EVENT_TYPE = \"application.cluster\";\n+\n+    private static final String EVENT_TYPE_KEY = \"eventType\";\n+\n+    private static final String INSTALLED = \"installed\";\n+\n+    private static final String STATE = \"state\";\n+\n+    private static final String UNINSTALLED = \"uninstalled\";\n+\n+    private static final String APPLICATION_KEY_PARAM = \"key\";\n+\n+    private final ApplicationService applicationService;\n+\n+    private volatile SseContextHolder contextHolder;\n+\n+    @Activate\n+    public SseEntryPoint( final @Reference ApplicationService applicationService )\n+    {\n+        this.applicationService = applicationService;\n+    }\n+\n+    @Deactivate\n+    public void deactivate()\n+    {\n+        final SseBroadcaster broadcaster = contextHolder.getBroadcaster();\n+\n+        if ( broadcaster != null )\n+        {\n+            broadcaster.close();\n+        }\n+    }\n+\n+    @Context\n+    public void setSse( final Sse sse )\n+    {\n+        this.contextHolder = new SseContextHolder( sse );\n+    }\n+\n+    @GET\n+    @Path(\"events\")\n+    @Produces(MediaType.SERVER_SENT_EVENTS)\n+    public void subscribe( final @Context SseEventSink sseEventSink )\n+    {\n+        contextHolder.getBroadcaster().register( sseEventSink );\n+\n+        final OutboundSseEvent sseEvent = contextHolder.getSse().newEventBuilder().\n+            name( \"list\" ).\n+            id( UUID.randomUUID().toString() ).\n+            mediaType( MediaType.APPLICATION_JSON_TYPE ).\n+            data( ListApplicationJson.class, new ListApplicationJson( applicationService.getInstalledApplications().stream().\n+                map( application -> new ApplicationInfoJson( application, applicationService.isLocalApplication( application.getKey() ) ) ).\n+                collect( Collectors.toList() ) ) ).\n+            comment( \"List of installed applications\" ).build();\n+\n+        sseEventSink.send( sseEvent );\n+    }\n+\n+    @Override\n+    public void onEvent( final Event event )\n+    {\n+        if ( EVENT_TYPE.equals( event.getType() ) && event.isLocalOrigin() )\n+        {\n+            event.getValueAs( String.class, EVENT_TYPE_KEY ).\n+                ifPresent( eventSubType -> {\n+                    switch ( eventSubType )\n+                    {\n+                        case INSTALLED:\n+                        case STATE:\n+                        case UNINSTALLED:\n+                            handleEvent( event, eventSubType );\n+                            break;\n+                        default:\n+                            LOG.debug( \"Ignoring {} {}\", EVENT_TYPE, eventSubType );\n+                            break;\n+                    }\n+                } );\n+        }\n+    }\n+\n+    private void handleEvent( final Event event, final String eventSubType )\n+    {\n+        if ( contextHolder == null )\n+        {\n+            LOG.debug( \"Skipping {} {}. Please to subscribe to send SSE events.\", EVENT_TYPE, eventSubType );\n+            return;\n+        }\n+\n+        if ( event.getValue( APPLICATION_KEY_PARAM ).isPresent() )\n+        {\n+            final OutboundSseEvent.Builder eventBuilder = contextHolder.getSse().newEventBuilder().\n+                name( eventSubType ).\n+                id( UUID.randomUUID().toString() ).\n+                mediaType( MediaType.APPLICATION_JSON_TYPE );\n+\n+            if ( UNINSTALLED.equals( eventSubType ) )\n+            {\n+                eventBuilder.data( ApplicationUninstalledJson.class,\n+                                   new ApplicationUninstalledJson( event.getValue( APPLICATION_KEY_PARAM ).get().toString() ) );\n+            }\n+            else\n+            {\n+                final ApplicationKey applicationKey = ApplicationKey.from( event.getValue( APPLICATION_KEY_PARAM ).get().toString() );\n+\n+                final Application application = applicationService.getInstalledApplication( applicationKey );\n+\n+                if ( application == null )\n+                {\n+                    throw new ApplicationNotFoundException( applicationKey );\n+                }\n+\n+                final boolean localApplication = applicationService.isLocalApplication( application.getKey() );\n+\n+                eventBuilder.data( ApplicationInfoJson.class, new ApplicationInfoJson( application, localApplication ) );\n+            }\n+\n+            contextHolder.getBroadcaster().broadcast( eventBuilder.build() );\n+        }\n+    }\n+\n+    private class SseContextHolder", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab60fb8a27999e1f35373f7d64938af5643e5a2f"}, "originalPosition": 165}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU0MTM5Mw==", "bodyText": "getters are not needed", "url": "https://github.com/enonic/xp/pull/8465#discussion_r520541393", "createdAt": "2020-11-10T12:57:30Z", "author": {"login": "rymsha"}, "path": "modules/server/server-rest/src/main/java/com/enonic/xp/impl/server/rest/SseEntryPoint.java", "diffHunk": "@@ -0,0 +1,190 @@\n+package com.enonic.xp.impl.server.rest;\n+\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+\n+import javax.annotation.security.RolesAllowed;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.sse.OutboundSseEvent;\n+import javax.ws.rs.sse.Sse;\n+import javax.ws.rs.sse.SseBroadcaster;\n+import javax.ws.rs.sse.SseEventSink;\n+\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Deactivate;\n+import org.osgi.service.component.annotations.Reference;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.enonic.xp.app.Application;\n+import com.enonic.xp.app.ApplicationKey;\n+import com.enonic.xp.app.ApplicationNotFoundException;\n+import com.enonic.xp.app.ApplicationService;\n+import com.enonic.xp.event.Event;\n+import com.enonic.xp.event.EventListener;\n+import com.enonic.xp.impl.server.rest.model.ApplicationInfoJson;\n+import com.enonic.xp.impl.server.rest.model.ApplicationUninstalledJson;\n+import com.enonic.xp.impl.server.rest.model.ListApplicationJson;\n+import com.enonic.xp.jaxrs.JaxRsComponent;\n+import com.enonic.xp.security.RoleKeys;\n+\n+@Path(\"app\")\n+@RolesAllowed(RoleKeys.ADMIN_ID)\n+@Component(immediate = true, property = \"group=api\")\n+public class SseEntryPoint\n+    implements JaxRsComponent, EventListener\n+{\n+\n+    private static final Logger LOG = LoggerFactory.getLogger( SseEntryPoint.class );\n+\n+    private static final String EVENT_TYPE = \"application.cluster\";\n+\n+    private static final String EVENT_TYPE_KEY = \"eventType\";\n+\n+    private static final String INSTALLED = \"installed\";\n+\n+    private static final String STATE = \"state\";\n+\n+    private static final String UNINSTALLED = \"uninstalled\";\n+\n+    private static final String APPLICATION_KEY_PARAM = \"key\";\n+\n+    private final ApplicationService applicationService;\n+\n+    private volatile SseContextHolder contextHolder;\n+\n+    @Activate\n+    public SseEntryPoint( final @Reference ApplicationService applicationService )\n+    {\n+        this.applicationService = applicationService;\n+    }\n+\n+    @Deactivate\n+    public void deactivate()\n+    {\n+        final SseBroadcaster broadcaster = contextHolder.getBroadcaster();\n+\n+        if ( broadcaster != null )\n+        {\n+            broadcaster.close();\n+        }\n+    }\n+\n+    @Context\n+    public void setSse( final Sse sse )\n+    {\n+        this.contextHolder = new SseContextHolder( sse );\n+    }\n+\n+    @GET\n+    @Path(\"events\")\n+    @Produces(MediaType.SERVER_SENT_EVENTS)\n+    public void subscribe( final @Context SseEventSink sseEventSink )\n+    {\n+        contextHolder.getBroadcaster().register( sseEventSink );\n+\n+        final OutboundSseEvent sseEvent = contextHolder.getSse().newEventBuilder().\n+            name( \"list\" ).\n+            id( UUID.randomUUID().toString() ).\n+            mediaType( MediaType.APPLICATION_JSON_TYPE ).\n+            data( ListApplicationJson.class, new ListApplicationJson( applicationService.getInstalledApplications().stream().\n+                map( application -> new ApplicationInfoJson( application, applicationService.isLocalApplication( application.getKey() ) ) ).\n+                collect( Collectors.toList() ) ) ).\n+            comment( \"List of installed applications\" ).build();\n+\n+        sseEventSink.send( sseEvent );\n+    }\n+\n+    @Override\n+    public void onEvent( final Event event )\n+    {\n+        if ( EVENT_TYPE.equals( event.getType() ) && event.isLocalOrigin() )\n+        {\n+            event.getValueAs( String.class, EVENT_TYPE_KEY ).\n+                ifPresent( eventSubType -> {\n+                    switch ( eventSubType )\n+                    {\n+                        case INSTALLED:\n+                        case STATE:\n+                        case UNINSTALLED:\n+                            handleEvent( event, eventSubType );\n+                            break;\n+                        default:\n+                            LOG.debug( \"Ignoring {} {}\", EVENT_TYPE, eventSubType );\n+                            break;\n+                    }\n+                } );\n+        }\n+    }\n+\n+    private void handleEvent( final Event event, final String eventSubType )\n+    {\n+        if ( contextHolder == null )\n+        {\n+            LOG.debug( \"Skipping {} {}. Please to subscribe to send SSE events.\", EVENT_TYPE, eventSubType );\n+            return;\n+        }\n+\n+        if ( event.getValue( APPLICATION_KEY_PARAM ).isPresent() )\n+        {\n+            final OutboundSseEvent.Builder eventBuilder = contextHolder.getSse().newEventBuilder().\n+                name( eventSubType ).\n+                id( UUID.randomUUID().toString() ).\n+                mediaType( MediaType.APPLICATION_JSON_TYPE );\n+\n+            if ( UNINSTALLED.equals( eventSubType ) )\n+            {\n+                eventBuilder.data( ApplicationUninstalledJson.class,\n+                                   new ApplicationUninstalledJson( event.getValue( APPLICATION_KEY_PARAM ).get().toString() ) );\n+            }\n+            else\n+            {\n+                final ApplicationKey applicationKey = ApplicationKey.from( event.getValue( APPLICATION_KEY_PARAM ).get().toString() );\n+\n+                final Application application = applicationService.getInstalledApplication( applicationKey );\n+\n+                if ( application == null )\n+                {\n+                    throw new ApplicationNotFoundException( applicationKey );\n+                }\n+\n+                final boolean localApplication = applicationService.isLocalApplication( application.getKey() );\n+\n+                eventBuilder.data( ApplicationInfoJson.class, new ApplicationInfoJson( application, localApplication ) );\n+            }\n+\n+            contextHolder.getBroadcaster().broadcast( eventBuilder.build() );\n+        }\n+    }\n+\n+    private class SseContextHolder\n+    {\n+\n+        final Sse sse;\n+\n+        final SseBroadcaster broadcaster;\n+\n+        SseContextHolder( final Sse sse )\n+        {\n+            this.sse = sse;\n+            this.broadcaster = sse.newBroadcaster();\n+        }\n+\n+        Sse getSse()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab60fb8a27999e1f35373f7d64938af5643e5a2f"}, "originalPosition": 178}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU0MTc4Mg==", "bodyText": "save contextHolder into local var and operate only with it in the method later", "url": "https://github.com/enonic/xp/pull/8465#discussion_r520541782", "createdAt": "2020-11-10T12:58:06Z", "author": {"login": "rymsha"}, "path": "modules/server/server-rest/src/main/java/com/enonic/xp/impl/server/rest/SseEntryPoint.java", "diffHunk": "@@ -0,0 +1,190 @@\n+package com.enonic.xp.impl.server.rest;\n+\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+\n+import javax.annotation.security.RolesAllowed;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.sse.OutboundSseEvent;\n+import javax.ws.rs.sse.Sse;\n+import javax.ws.rs.sse.SseBroadcaster;\n+import javax.ws.rs.sse.SseEventSink;\n+\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Deactivate;\n+import org.osgi.service.component.annotations.Reference;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.enonic.xp.app.Application;\n+import com.enonic.xp.app.ApplicationKey;\n+import com.enonic.xp.app.ApplicationNotFoundException;\n+import com.enonic.xp.app.ApplicationService;\n+import com.enonic.xp.event.Event;\n+import com.enonic.xp.event.EventListener;\n+import com.enonic.xp.impl.server.rest.model.ApplicationInfoJson;\n+import com.enonic.xp.impl.server.rest.model.ApplicationUninstalledJson;\n+import com.enonic.xp.impl.server.rest.model.ListApplicationJson;\n+import com.enonic.xp.jaxrs.JaxRsComponent;\n+import com.enonic.xp.security.RoleKeys;\n+\n+@Path(\"app\")\n+@RolesAllowed(RoleKeys.ADMIN_ID)\n+@Component(immediate = true, property = \"group=api\")\n+public class SseEntryPoint\n+    implements JaxRsComponent, EventListener\n+{\n+\n+    private static final Logger LOG = LoggerFactory.getLogger( SseEntryPoint.class );\n+\n+    private static final String EVENT_TYPE = \"application.cluster\";\n+\n+    private static final String EVENT_TYPE_KEY = \"eventType\";\n+\n+    private static final String INSTALLED = \"installed\";\n+\n+    private static final String STATE = \"state\";\n+\n+    private static final String UNINSTALLED = \"uninstalled\";\n+\n+    private static final String APPLICATION_KEY_PARAM = \"key\";\n+\n+    private final ApplicationService applicationService;\n+\n+    private volatile SseContextHolder contextHolder;\n+\n+    @Activate\n+    public SseEntryPoint( final @Reference ApplicationService applicationService )\n+    {\n+        this.applicationService = applicationService;\n+    }\n+\n+    @Deactivate\n+    public void deactivate()\n+    {\n+        final SseBroadcaster broadcaster = contextHolder.getBroadcaster();\n+\n+        if ( broadcaster != null )\n+        {\n+            broadcaster.close();\n+        }\n+    }\n+\n+    @Context\n+    public void setSse( final Sse sse )\n+    {\n+        this.contextHolder = new SseContextHolder( sse );\n+    }\n+\n+    @GET\n+    @Path(\"events\")\n+    @Produces(MediaType.SERVER_SENT_EVENTS)\n+    public void subscribe( final @Context SseEventSink sseEventSink )\n+    {\n+        contextHolder.getBroadcaster().register( sseEventSink );\n+\n+        final OutboundSseEvent sseEvent = contextHolder.getSse().newEventBuilder().\n+            name( \"list\" ).\n+            id( UUID.randomUUID().toString() ).\n+            mediaType( MediaType.APPLICATION_JSON_TYPE ).\n+            data( ListApplicationJson.class, new ListApplicationJson( applicationService.getInstalledApplications().stream().\n+                map( application -> new ApplicationInfoJson( application, applicationService.isLocalApplication( application.getKey() ) ) ).\n+                collect( Collectors.toList() ) ) ).\n+            comment( \"List of installed applications\" ).build();\n+\n+        sseEventSink.send( sseEvent );\n+    }\n+\n+    @Override\n+    public void onEvent( final Event event )\n+    {\n+        if ( EVENT_TYPE.equals( event.getType() ) && event.isLocalOrigin() )\n+        {\n+            event.getValueAs( String.class, EVENT_TYPE_KEY ).\n+                ifPresent( eventSubType -> {\n+                    switch ( eventSubType )\n+                    {\n+                        case INSTALLED:\n+                        case STATE:\n+                        case UNINSTALLED:\n+                            handleEvent( event, eventSubType );\n+                            break;\n+                        default:\n+                            LOG.debug( \"Ignoring {} {}\", EVENT_TYPE, eventSubType );\n+                            break;\n+                    }\n+                } );\n+        }\n+    }\n+\n+    private void handleEvent( final Event event, final String eventSubType )\n+    {\n+        if ( contextHolder == null )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab60fb8a27999e1f35373f7d64938af5643e5a2f"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU0Mjc5MA==", "bodyText": "it should be contentHolder saved into local var and checked for null.\nBroadcaster is never null, when contentHolder is not null", "url": "https://github.com/enonic/xp/pull/8465#discussion_r520542790", "createdAt": "2020-11-10T12:59:44Z", "author": {"login": "rymsha"}, "path": "modules/server/server-rest/src/main/java/com/enonic/xp/impl/server/rest/SseEntryPoint.java", "diffHunk": "@@ -0,0 +1,190 @@\n+package com.enonic.xp.impl.server.rest;\n+\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+\n+import javax.annotation.security.RolesAllowed;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.sse.OutboundSseEvent;\n+import javax.ws.rs.sse.Sse;\n+import javax.ws.rs.sse.SseBroadcaster;\n+import javax.ws.rs.sse.SseEventSink;\n+\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Deactivate;\n+import org.osgi.service.component.annotations.Reference;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.enonic.xp.app.Application;\n+import com.enonic.xp.app.ApplicationKey;\n+import com.enonic.xp.app.ApplicationNotFoundException;\n+import com.enonic.xp.app.ApplicationService;\n+import com.enonic.xp.event.Event;\n+import com.enonic.xp.event.EventListener;\n+import com.enonic.xp.impl.server.rest.model.ApplicationInfoJson;\n+import com.enonic.xp.impl.server.rest.model.ApplicationUninstalledJson;\n+import com.enonic.xp.impl.server.rest.model.ListApplicationJson;\n+import com.enonic.xp.jaxrs.JaxRsComponent;\n+import com.enonic.xp.security.RoleKeys;\n+\n+@Path(\"app\")\n+@RolesAllowed(RoleKeys.ADMIN_ID)\n+@Component(immediate = true, property = \"group=api\")\n+public class SseEntryPoint\n+    implements JaxRsComponent, EventListener\n+{\n+\n+    private static final Logger LOG = LoggerFactory.getLogger( SseEntryPoint.class );\n+\n+    private static final String EVENT_TYPE = \"application.cluster\";\n+\n+    private static final String EVENT_TYPE_KEY = \"eventType\";\n+\n+    private static final String INSTALLED = \"installed\";\n+\n+    private static final String STATE = \"state\";\n+\n+    private static final String UNINSTALLED = \"uninstalled\";\n+\n+    private static final String APPLICATION_KEY_PARAM = \"key\";\n+\n+    private final ApplicationService applicationService;\n+\n+    private volatile SseContextHolder contextHolder;\n+\n+    @Activate\n+    public SseEntryPoint( final @Reference ApplicationService applicationService )\n+    {\n+        this.applicationService = applicationService;\n+    }\n+\n+    @Deactivate\n+    public void deactivate()\n+    {\n+        final SseBroadcaster broadcaster = contextHolder.getBroadcaster();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab60fb8a27999e1f35373f7d64938af5643e5a2f"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU0MzEwOQ==", "bodyText": "I think toString is not needed", "url": "https://github.com/enonic/xp/pull/8465#discussion_r520543109", "createdAt": "2020-11-10T13:00:14Z", "author": {"login": "rymsha"}, "path": "modules/core/core-app/src/main/java/com/enonic/xp/core/impl/app/event/ApplicationClusterEvents.java", "diffHunk": "@@ -34,6 +34,7 @@ public static Event installed( final Node applicationNode )\n             distributed( true ).\n             value( EVENT_TYPE_KEY, INSTALLED ).\n             value( NODE_ID_PARAM, applicationNode.id() ).\n+            value( APPLICATION_KEY_PARAM, applicationNode.name().toString() ).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab60fb8a27999e1f35373f7d64938af5643e5a2f"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab60fb8a27999e1f35373f7d64938af5643e5a2f", "author": {"user": {"login": "anatol-sialitski", "name": null}}, "url": "https://github.com/enonic/xp/commit/ab60fb8a27999e1f35373f7d64938af5643e5a2f", "committedDate": "2020-11-10T12:17:40Z", "message": "Extend Management with App events #8451"}, "afterCommit": {"oid": "97a597c9767c1c7aa6b574b48ad57ad3c1d0f488", "author": {"user": {"login": "anatol-sialitski", "name": null}}, "url": "https://github.com/enonic/xp/commit/97a597c9767c1c7aa6b574b48ad57ad3c1d0f488", "committedDate": "2020-11-10T16:02:53Z", "message": "Extend Management with App events #8451"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "97a597c9767c1c7aa6b574b48ad57ad3c1d0f488", "author": {"user": {"login": "anatol-sialitski", "name": null}}, "url": "https://github.com/enonic/xp/commit/97a597c9767c1c7aa6b574b48ad57ad3c1d0f488", "committedDate": "2020-11-10T16:02:53Z", "message": "Extend Management with App events #8451"}, "afterCommit": {"oid": "85577e266c59409967ece10efa1da03aafffffe9", "author": {"user": {"login": "anatol-sialitski", "name": null}}, "url": "https://github.com/enonic/xp/commit/85577e266c59409967ece10efa1da03aafffffe9", "committedDate": "2020-11-11T07:14:03Z", "message": "Extend Management with App events #8451"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "85577e266c59409967ece10efa1da03aafffffe9", "author": {"user": {"login": "anatol-sialitski", "name": null}}, "url": "https://github.com/enonic/xp/commit/85577e266c59409967ece10efa1da03aafffffe9", "committedDate": "2020-11-11T07:14:03Z", "message": "Extend Management with App events #8451"}, "afterCommit": {"oid": "3ab5c191de6fba886274203530da0d999afcbf5f", "author": {"user": {"login": "anatol-sialitski", "name": null}}, "url": "https://github.com/enonic/xp/commit/3ab5c191de6fba886274203530da0d999afcbf5f", "committedDate": "2020-11-11T09:35:51Z", "message": "Extend Management with App events #8451"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4MDYzMjEw", "url": "https://github.com/enonic/xp/pull/8465#pullrequestreview-528063210", "createdAt": "2020-11-11T10:50:40Z", "commit": {"oid": "3ab5c191de6fba886274203530da0d999afcbf5f"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxMDo1MDo0MFrOHxIBRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxMDo1NDozOVrOHxIJag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI3MzY2OA==", "bodyText": "It looks like overkill for state event (on start/stop) to fetch app details? But maybe @gbbirkisson has a use for it?", "url": "https://github.com/enonic/xp/pull/8465#discussion_r521273668", "createdAt": "2020-11-11T10:50:40Z", "author": {"login": "rymsha"}, "path": "modules/server/server-rest/src/main/java/com/enonic/xp/impl/server/rest/SseEntryPoint.java", "diffHunk": "@@ -0,0 +1,186 @@\n+package com.enonic.xp.impl.server.rest;\n+\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+\n+import javax.annotation.security.RolesAllowed;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.sse.OutboundSseEvent;\n+import javax.ws.rs.sse.Sse;\n+import javax.ws.rs.sse.SseBroadcaster;\n+import javax.ws.rs.sse.SseEventSink;\n+\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Deactivate;\n+import org.osgi.service.component.annotations.Reference;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.enonic.xp.app.Application;\n+import com.enonic.xp.app.ApplicationKey;\n+import com.enonic.xp.app.ApplicationNotFoundException;\n+import com.enonic.xp.app.ApplicationService;\n+import com.enonic.xp.event.Event;\n+import com.enonic.xp.event.EventListener;\n+import com.enonic.xp.impl.server.rest.model.ApplicationInfoJson;\n+import com.enonic.xp.impl.server.rest.model.ApplicationUninstalledJson;\n+import com.enonic.xp.impl.server.rest.model.ListApplicationJson;\n+import com.enonic.xp.jaxrs.JaxRsComponent;\n+import com.enonic.xp.security.RoleKeys;\n+\n+@Path(\"app\")\n+@RolesAllowed(RoleKeys.ADMIN_ID)\n+@Component(immediate = true, property = \"group=api\")\n+public class SseEntryPoint\n+    implements JaxRsComponent, EventListener\n+{\n+    private static final Logger LOG = LoggerFactory.getLogger( SseEntryPoint.class );\n+\n+    private static final String EVENT_TYPE = \"application.cluster\";\n+\n+    private static final String EVENT_TYPE_KEY = \"eventType\";\n+\n+    private static final String INSTALLED = \"installed\";\n+\n+    private static final String STATE = \"state\";\n+\n+    private static final String UNINSTALLED = \"uninstalled\";\n+\n+    private static final String APPLICATION_KEY_PARAM = \"key\";\n+\n+    private final ApplicationService applicationService;\n+\n+    private volatile SseContextHolder contextHolder;\n+\n+    @Activate\n+    public SseEntryPoint( final @Reference ApplicationService applicationService )\n+    {\n+        this.applicationService = applicationService;\n+    }\n+\n+    @Deactivate\n+    public void deactivate()\n+    {\n+        final SseContextHolder ctx = contextHolder;\n+\n+        if ( ctx != null )\n+        {\n+            ctx.broadcaster.close();\n+        }\n+    }\n+\n+    @Context\n+    public void setSse( final Sse sse )\n+    {\n+        this.contextHolder = new SseContextHolder( sse );\n+    }\n+\n+    @GET\n+    @Path(\"events\")\n+    @Produces(MediaType.SERVER_SENT_EVENTS)\n+    public void subscribe( final @Context SseEventSink sseEventSink )\n+    {\n+        final SseContextHolder ctx = contextHolder;\n+\n+        if ( ctx == null )\n+        {\n+            return;\n+        }\n+\n+        ctx.broadcaster.register( sseEventSink );\n+\n+        final OutboundSseEvent sseEvent = ctx.sse.newEventBuilder().\n+            name( \"list\" ).\n+            id( UUID.randomUUID().toString() ).\n+            mediaType( MediaType.APPLICATION_JSON_TYPE ).\n+            data( ListApplicationJson.class, new ListApplicationJson( applicationService.getInstalledApplications().stream().\n+                map( application -> new ApplicationInfoJson( application, applicationService.isLocalApplication( application.getKey() ) ) ).\n+                collect( Collectors.toList() ) ) ).build();\n+\n+        sseEventSink.send( sseEvent );\n+    }\n+\n+    @Override\n+    public void onEvent( final Event event )\n+    {\n+        if ( EVENT_TYPE.equals( event.getType() ) && event.isLocalOrigin() )\n+        {\n+            event.getValueAs( String.class, EVENT_TYPE_KEY ).\n+                ifPresent( eventSubType -> {\n+                    switch ( eventSubType )\n+                    {\n+                        case INSTALLED:\n+                        case STATE:\n+                        case UNINSTALLED:\n+                            handleEvent( event, eventSubType );\n+                            break;\n+                        default:\n+                            LOG.debug( \"Ignoring {} {}\", EVENT_TYPE, eventSubType );\n+                            break;\n+                    }\n+                } );\n+        }\n+    }\n+\n+    private void handleEvent( final Event event, final String eventSubType )\n+    {\n+        final SseContextHolder ctx = contextHolder;\n+\n+        if ( ctx == null )\n+        {\n+            LOG.debug( \"Skipping {} {}. Please to subscribe to send SSE events.\", EVENT_TYPE, eventSubType );\n+            return;\n+        }\n+\n+        if ( event.getValue( APPLICATION_KEY_PARAM ).isPresent() )\n+        {\n+            final OutboundSseEvent.Builder eventBuilder = ctx.sse.newEventBuilder().\n+                name( eventSubType ).\n+                id( UUID.randomUUID().toString() ).\n+                mediaType( MediaType.APPLICATION_JSON_TYPE );\n+\n+            if ( UNINSTALLED.equals( eventSubType ) )\n+            {\n+                eventBuilder.data( ApplicationUninstalledJson.class,\n+                                   new ApplicationUninstalledJson( event.getValue( APPLICATION_KEY_PARAM ).get().toString() ) );\n+            }\n+            else\n+            {\n+                final ApplicationKey applicationKey = ApplicationKey.from( event.getValue( APPLICATION_KEY_PARAM ).get().toString() );\n+\n+                final Application application = applicationService.getInstalledApplication( applicationKey );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ab5c191de6fba886274203530da0d999afcbf5f"}, "originalPosition": 156}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI3NTc1NA==", "bodyText": "There are no users of this exception. A WARN log should be enough.", "url": "https://github.com/enonic/xp/pull/8465#discussion_r521275754", "createdAt": "2020-11-11T10:54:39Z", "author": {"login": "rymsha"}, "path": "modules/server/server-rest/src/main/java/com/enonic/xp/impl/server/rest/SseEntryPoint.java", "diffHunk": "@@ -0,0 +1,186 @@\n+package com.enonic.xp.impl.server.rest;\n+\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+\n+import javax.annotation.security.RolesAllowed;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.sse.OutboundSseEvent;\n+import javax.ws.rs.sse.Sse;\n+import javax.ws.rs.sse.SseBroadcaster;\n+import javax.ws.rs.sse.SseEventSink;\n+\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Deactivate;\n+import org.osgi.service.component.annotations.Reference;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.enonic.xp.app.Application;\n+import com.enonic.xp.app.ApplicationKey;\n+import com.enonic.xp.app.ApplicationNotFoundException;\n+import com.enonic.xp.app.ApplicationService;\n+import com.enonic.xp.event.Event;\n+import com.enonic.xp.event.EventListener;\n+import com.enonic.xp.impl.server.rest.model.ApplicationInfoJson;\n+import com.enonic.xp.impl.server.rest.model.ApplicationUninstalledJson;\n+import com.enonic.xp.impl.server.rest.model.ListApplicationJson;\n+import com.enonic.xp.jaxrs.JaxRsComponent;\n+import com.enonic.xp.security.RoleKeys;\n+\n+@Path(\"app\")\n+@RolesAllowed(RoleKeys.ADMIN_ID)\n+@Component(immediate = true, property = \"group=api\")\n+public class SseEntryPoint\n+    implements JaxRsComponent, EventListener\n+{\n+    private static final Logger LOG = LoggerFactory.getLogger( SseEntryPoint.class );\n+\n+    private static final String EVENT_TYPE = \"application.cluster\";\n+\n+    private static final String EVENT_TYPE_KEY = \"eventType\";\n+\n+    private static final String INSTALLED = \"installed\";\n+\n+    private static final String STATE = \"state\";\n+\n+    private static final String UNINSTALLED = \"uninstalled\";\n+\n+    private static final String APPLICATION_KEY_PARAM = \"key\";\n+\n+    private final ApplicationService applicationService;\n+\n+    private volatile SseContextHolder contextHolder;\n+\n+    @Activate\n+    public SseEntryPoint( final @Reference ApplicationService applicationService )\n+    {\n+        this.applicationService = applicationService;\n+    }\n+\n+    @Deactivate\n+    public void deactivate()\n+    {\n+        final SseContextHolder ctx = contextHolder;\n+\n+        if ( ctx != null )\n+        {\n+            ctx.broadcaster.close();\n+        }\n+    }\n+\n+    @Context\n+    public void setSse( final Sse sse )\n+    {\n+        this.contextHolder = new SseContextHolder( sse );\n+    }\n+\n+    @GET\n+    @Path(\"events\")\n+    @Produces(MediaType.SERVER_SENT_EVENTS)\n+    public void subscribe( final @Context SseEventSink sseEventSink )\n+    {\n+        final SseContextHolder ctx = contextHolder;\n+\n+        if ( ctx == null )\n+        {\n+            return;\n+        }\n+\n+        ctx.broadcaster.register( sseEventSink );\n+\n+        final OutboundSseEvent sseEvent = ctx.sse.newEventBuilder().\n+            name( \"list\" ).\n+            id( UUID.randomUUID().toString() ).\n+            mediaType( MediaType.APPLICATION_JSON_TYPE ).\n+            data( ListApplicationJson.class, new ListApplicationJson( applicationService.getInstalledApplications().stream().\n+                map( application -> new ApplicationInfoJson( application, applicationService.isLocalApplication( application.getKey() ) ) ).\n+                collect( Collectors.toList() ) ) ).build();\n+\n+        sseEventSink.send( sseEvent );\n+    }\n+\n+    @Override\n+    public void onEvent( final Event event )\n+    {\n+        if ( EVENT_TYPE.equals( event.getType() ) && event.isLocalOrigin() )\n+        {\n+            event.getValueAs( String.class, EVENT_TYPE_KEY ).\n+                ifPresent( eventSubType -> {\n+                    switch ( eventSubType )\n+                    {\n+                        case INSTALLED:\n+                        case STATE:\n+                        case UNINSTALLED:\n+                            handleEvent( event, eventSubType );\n+                            break;\n+                        default:\n+                            LOG.debug( \"Ignoring {} {}\", EVENT_TYPE, eventSubType );\n+                            break;\n+                    }\n+                } );\n+        }\n+    }\n+\n+    private void handleEvent( final Event event, final String eventSubType )\n+    {\n+        final SseContextHolder ctx = contextHolder;\n+\n+        if ( ctx == null )\n+        {\n+            LOG.debug( \"Skipping {} {}. Please to subscribe to send SSE events.\", EVENT_TYPE, eventSubType );\n+            return;\n+        }\n+\n+        if ( event.getValue( APPLICATION_KEY_PARAM ).isPresent() )\n+        {\n+            final OutboundSseEvent.Builder eventBuilder = ctx.sse.newEventBuilder().\n+                name( eventSubType ).\n+                id( UUID.randomUUID().toString() ).\n+                mediaType( MediaType.APPLICATION_JSON_TYPE );\n+\n+            if ( UNINSTALLED.equals( eventSubType ) )\n+            {\n+                eventBuilder.data( ApplicationUninstalledJson.class,\n+                                   new ApplicationUninstalledJson( event.getValue( APPLICATION_KEY_PARAM ).get().toString() ) );\n+            }\n+            else\n+            {\n+                final ApplicationKey applicationKey = ApplicationKey.from( event.getValue( APPLICATION_KEY_PARAM ).get().toString() );\n+\n+                final Application application = applicationService.getInstalledApplication( applicationKey );\n+\n+                if ( application == null )\n+                {\n+                    throw new ApplicationNotFoundException( applicationKey );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ab5c191de6fba886274203530da0d999afcbf5f"}, "originalPosition": 160}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4MTEzNjc1", "url": "https://github.com/enonic/xp/pull/8465#pullrequestreview-528113675", "createdAt": "2020-11-11T12:07:05Z", "commit": {"oid": "3ab5c191de6fba886274203530da0d999afcbf5f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxMjowNzowNlrOHxKZzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxMjowNzowNlrOHxKZzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMxMjcxOQ==", "bodyText": "I personally like the model K8s uses, that is send event type and the whole object related to that event. If it is not a huge performance problem, I think we should keep it. It will probably come in handy.", "url": "https://github.com/enonic/xp/pull/8465#discussion_r521312719", "createdAt": "2020-11-11T12:07:06Z", "author": {"login": "gbbirkisson"}, "path": "modules/server/server-rest/src/main/java/com/enonic/xp/impl/server/rest/SseEntryPoint.java", "diffHunk": "@@ -0,0 +1,186 @@\n+package com.enonic.xp.impl.server.rest;\n+\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+\n+import javax.annotation.security.RolesAllowed;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.sse.OutboundSseEvent;\n+import javax.ws.rs.sse.Sse;\n+import javax.ws.rs.sse.SseBroadcaster;\n+import javax.ws.rs.sse.SseEventSink;\n+\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Deactivate;\n+import org.osgi.service.component.annotations.Reference;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.enonic.xp.app.Application;\n+import com.enonic.xp.app.ApplicationKey;\n+import com.enonic.xp.app.ApplicationNotFoundException;\n+import com.enonic.xp.app.ApplicationService;\n+import com.enonic.xp.event.Event;\n+import com.enonic.xp.event.EventListener;\n+import com.enonic.xp.impl.server.rest.model.ApplicationInfoJson;\n+import com.enonic.xp.impl.server.rest.model.ApplicationUninstalledJson;\n+import com.enonic.xp.impl.server.rest.model.ListApplicationJson;\n+import com.enonic.xp.jaxrs.JaxRsComponent;\n+import com.enonic.xp.security.RoleKeys;\n+\n+@Path(\"app\")\n+@RolesAllowed(RoleKeys.ADMIN_ID)\n+@Component(immediate = true, property = \"group=api\")\n+public class SseEntryPoint\n+    implements JaxRsComponent, EventListener\n+{\n+    private static final Logger LOG = LoggerFactory.getLogger( SseEntryPoint.class );\n+\n+    private static final String EVENT_TYPE = \"application.cluster\";\n+\n+    private static final String EVENT_TYPE_KEY = \"eventType\";\n+\n+    private static final String INSTALLED = \"installed\";\n+\n+    private static final String STATE = \"state\";\n+\n+    private static final String UNINSTALLED = \"uninstalled\";\n+\n+    private static final String APPLICATION_KEY_PARAM = \"key\";\n+\n+    private final ApplicationService applicationService;\n+\n+    private volatile SseContextHolder contextHolder;\n+\n+    @Activate\n+    public SseEntryPoint( final @Reference ApplicationService applicationService )\n+    {\n+        this.applicationService = applicationService;\n+    }\n+\n+    @Deactivate\n+    public void deactivate()\n+    {\n+        final SseContextHolder ctx = contextHolder;\n+\n+        if ( ctx != null )\n+        {\n+            ctx.broadcaster.close();\n+        }\n+    }\n+\n+    @Context\n+    public void setSse( final Sse sse )\n+    {\n+        this.contextHolder = new SseContextHolder( sse );\n+    }\n+\n+    @GET\n+    @Path(\"events\")\n+    @Produces(MediaType.SERVER_SENT_EVENTS)\n+    public void subscribe( final @Context SseEventSink sseEventSink )\n+    {\n+        final SseContextHolder ctx = contextHolder;\n+\n+        if ( ctx == null )\n+        {\n+            return;\n+        }\n+\n+        ctx.broadcaster.register( sseEventSink );\n+\n+        final OutboundSseEvent sseEvent = ctx.sse.newEventBuilder().\n+            name( \"list\" ).\n+            id( UUID.randomUUID().toString() ).\n+            mediaType( MediaType.APPLICATION_JSON_TYPE ).\n+            data( ListApplicationJson.class, new ListApplicationJson( applicationService.getInstalledApplications().stream().\n+                map( application -> new ApplicationInfoJson( application, applicationService.isLocalApplication( application.getKey() ) ) ).\n+                collect( Collectors.toList() ) ) ).build();\n+\n+        sseEventSink.send( sseEvent );\n+    }\n+\n+    @Override\n+    public void onEvent( final Event event )\n+    {\n+        if ( EVENT_TYPE.equals( event.getType() ) && event.isLocalOrigin() )\n+        {\n+            event.getValueAs( String.class, EVENT_TYPE_KEY ).\n+                ifPresent( eventSubType -> {\n+                    switch ( eventSubType )\n+                    {\n+                        case INSTALLED:\n+                        case STATE:\n+                        case UNINSTALLED:\n+                            handleEvent( event, eventSubType );\n+                            break;\n+                        default:\n+                            LOG.debug( \"Ignoring {} {}\", EVENT_TYPE, eventSubType );\n+                            break;\n+                    }\n+                } );\n+        }\n+    }\n+\n+    private void handleEvent( final Event event, final String eventSubType )\n+    {\n+        final SseContextHolder ctx = contextHolder;\n+\n+        if ( ctx == null )\n+        {\n+            LOG.debug( \"Skipping {} {}. Please to subscribe to send SSE events.\", EVENT_TYPE, eventSubType );\n+            return;\n+        }\n+\n+        if ( event.getValue( APPLICATION_KEY_PARAM ).isPresent() )\n+        {\n+            final OutboundSseEvent.Builder eventBuilder = ctx.sse.newEventBuilder().\n+                name( eventSubType ).\n+                id( UUID.randomUUID().toString() ).\n+                mediaType( MediaType.APPLICATION_JSON_TYPE );\n+\n+            if ( UNINSTALLED.equals( eventSubType ) )\n+            {\n+                eventBuilder.data( ApplicationUninstalledJson.class,\n+                                   new ApplicationUninstalledJson( event.getValue( APPLICATION_KEY_PARAM ).get().toString() ) );\n+            }\n+            else\n+            {\n+                final ApplicationKey applicationKey = ApplicationKey.from( event.getValue( APPLICATION_KEY_PARAM ).get().toString() );\n+\n+                final Application application = applicationService.getInstalledApplication( applicationKey );", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI3MzY2OA=="}, "originalCommit": {"oid": "3ab5c191de6fba886274203530da0d999afcbf5f"}, "originalPosition": 156}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "648166c9a95878a08dc83480dd00e1ef374c84b0", "author": {"user": {"login": "anatol-sialitski", "name": null}}, "url": "https://github.com/enonic/xp/commit/648166c9a95878a08dc83480dd00e1ef374c84b0", "committedDate": "2020-11-11T13:06:13Z", "message": "Extend Management with App events #8451"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3ab5c191de6fba886274203530da0d999afcbf5f", "author": {"user": {"login": "anatol-sialitski", "name": null}}, "url": "https://github.com/enonic/xp/commit/3ab5c191de6fba886274203530da0d999afcbf5f", "committedDate": "2020-11-11T09:35:51Z", "message": "Extend Management with App events #8451"}, "afterCommit": {"oid": "648166c9a95878a08dc83480dd00e1ef374c84b0", "author": {"user": {"login": "anatol-sialitski", "name": null}}, "url": "https://github.com/enonic/xp/commit/648166c9a95878a08dc83480dd00e1ef374c84b0", "committedDate": "2020-11-11T13:06:13Z", "message": "Extend Management with App events #8451"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4MTU3Mjk4", "url": "https://github.com/enonic/xp/pull/8465#pullrequestreview-528157298", "createdAt": "2020-11-11T13:10:36Z", "commit": {"oid": "648166c9a95878a08dc83480dd00e1ef374c84b0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4396, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}