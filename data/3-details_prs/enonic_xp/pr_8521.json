{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxMDc1NDMy", "number": 8521, "title": "Duplicate headers in controller creates a crash. #8404", "bodyText": "There were a few iterations of HTTP header specs and how they should handled\nFirstly they are case-insensitive preferably lowercased\nhttps://tools.ietf.org/html/rfc7540#section-8.1.2\nSecondly the order is not significant\nhttps://tools.ietf.org/html/rfc7230#section-3.2.2\nSo, it is safe to lowercase them and when response is built, headers get populated into case-insensitive sorted map (for backwards compatibility, so location = headers['Location'] works equally to location = headers['location'])\nInstead of throwing an Exception, it is possible to replace previous header values with new ones.\nThis is the easiest fix for now. More info in #8404 (comment)", "createdAt": "2020-12-02T14:59:06Z", "url": "https://github.com/enonic/xp/pull/8521", "merged": true, "mergeCommit": {"oid": "26ba49b79a35ed302455ba7fb164742d660fe01c"}, "closed": true, "closedAt": "2020-12-03T08:07:07Z", "author": {"login": "rymsha"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiP9y6AFqTU0MjkyOTM1Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdieaU1AFqTU0MzY4NTg4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyOTI5MzUz", "url": "https://github.com/enonic/xp/pull/8521#pullrequestreview-542929353", "createdAt": "2020-12-02T15:06:44Z", "commit": {"oid": "4b7281be131a0d3769d743e93599d423bcf207e8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4b7281be131a0d3769d743e93599d423bcf207e8", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/4b7281be131a0d3769d743e93599d423bcf207e8", "committedDate": "2020-12-02T14:29:40Z", "message": "Duplicate headers in controller creates a crash. #8404"}, "afterCommit": {"oid": "450a375669104f1cb7fd4fc3d10fade791eed218", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/450a375669104f1cb7fd4fc3d10fade791eed218", "committedDate": "2020-12-02T15:44:29Z", "message": "Duplicate headers in controller creates a crash. #8404"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "450a375669104f1cb7fd4fc3d10fade791eed218", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/450a375669104f1cb7fd4fc3d10fade791eed218", "committedDate": "2020-12-02T15:44:29Z", "message": "Duplicate headers in controller creates a crash. #8404"}, "afterCommit": {"oid": "d22c8b8d4cd04eccf5600540d3e2c4dbb3168dce", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/d22c8b8d4cd04eccf5600540d3e2c4dbb3168dce", "committedDate": "2020-12-02T16:26:39Z", "message": "Duplicate headers in controller creates a crash. #8404"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMDM2OTI5", "url": "https://github.com/enonic/xp/pull/8521#pullrequestreview-543036929", "createdAt": "2020-12-02T16:50:40Z", "commit": {"oid": "d22c8b8d4cd04eccf5600540d3e2c4dbb3168dce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxNjo1MDo0MFrOH9kdLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxNjo1MDo0MFrOH9kdLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDMyMjQ3OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    ;", "url": "https://github.com/enonic/xp/pull/8521#discussion_r534322479", "createdAt": "2020-12-02T16:50:40Z", "author": {"login": "rymsha"}, "path": "modules/web/web-api/src/main/java/com/enonic/xp/web/WebResponse.java", "diffHunk": "@@ -106,7 +109,9 @@ public WebSocketConfig getWebSocket()\n     {\n         private Object body;\n \n-        private ImmutableMap.Builder<String, String> headers;\n+        private Map<String, String> headers = new HashMap<>();\n+\n+        ;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d22c8b8d4cd04eccf5600540d3e2c4dbb3168dce"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMDM3Nzc3", "url": "https://github.com/enonic/xp/pull/8521#pullrequestreview-543037777", "createdAt": "2020-12-02T16:51:34Z", "commit": {"oid": "d22c8b8d4cd04eccf5600540d3e2c4dbb3168dce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxNjo1MTozNFrOH9kfvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxNjo1MTozNFrOH9kfvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDMyMzEzNA==", "bodyText": "Don't use in constructor", "url": "https://github.com/enonic/xp/pull/8521#discussion_r534323134", "createdAt": "2020-12-02T16:51:34Z", "author": {"login": "rymsha"}, "path": "modules/web/web-api/src/main/java/com/enonic/xp/web/WebResponse.java", "diffHunk": "@@ -140,27 +145,19 @@ public T body( final Object body )\n \n         public T headers( final Map<String, String> headers )\n         {\n-            if ( this.headers == null )\n-            {\n-                clearHeaders();\n-            }\n-            this.headers.putAll( headers );\n+            headers.forEach( ( key, value ) -> this.headers.put( key.toLowerCase( Locale.ROOT ), Objects.requireNonNull( value ) ) );\n             return (T) this;\n         }\n \n         public T header( final String key, final String value )\n         {\n-            if ( this.headers == null )\n-            {\n-                clearHeaders();\n-            }\n-            this.headers.put( key, value );\n+            this.headers.put( key.toLowerCase( Locale.ROOT ), Objects.requireNonNull( value ) );\n             return (T) this;\n         }\n \n         public T clearHeaders()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d22c8b8d4cd04eccf5600540d3e2c4dbb3168dce"}, "originalPosition": 61}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25e57d46745e588ae9e3b06debf89c710a434f5e", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/25e57d46745e588ae9e3b06debf89c710a434f5e", "committedDate": "2020-12-02T21:08:00Z", "message": "Duplicate headers in controller creates a crash. #8404"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d22c8b8d4cd04eccf5600540d3e2c4dbb3168dce", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/d22c8b8d4cd04eccf5600540d3e2c4dbb3168dce", "committedDate": "2020-12-02T16:26:39Z", "message": "Duplicate headers in controller creates a crash. #8404"}, "afterCommit": {"oid": "25e57d46745e588ae9e3b06debf89c710a434f5e", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/25e57d46745e588ae9e3b06debf89c710a434f5e", "committedDate": "2020-12-02T21:08:00Z", "message": "Duplicate headers in controller creates a crash. #8404"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzNjgzMTg3", "url": "https://github.com/enonic/xp/pull/8521#pullrequestreview-543683187", "createdAt": "2020-12-03T07:52:18Z", "commit": {"oid": "25e57d46745e588ae9e3b06debf89c710a434f5e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzNjg1ODg1", "url": "https://github.com/enonic/xp/pull/8521#pullrequestreview-543685885", "createdAt": "2020-12-03T07:56:34Z", "commit": {"oid": "25e57d46745e588ae9e3b06debf89c710a434f5e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4363, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}