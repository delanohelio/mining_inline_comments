{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3NDkxMTk5", "number": 8045, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMToxNzoxM1rOD0-gmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMDozNDo1MlrOD1dtNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2ODc2Njk5OnYy", "diffSide": "RIGHT", "path": "modules/admin/admin-impl/src/main/java/com/enonic/xp/admin/impl/rest/resource/project/icon/ProjectIconResource.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMToxNzoxM1rOGKMO0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMToxNzoxM1rOGKMO0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMzOTM0NA==", "bodyText": "This is a controller class which does waaay too much.\nLet see how to split it up.", "url": "https://github.com/enonic/xp/pull/8045#discussion_r413339344", "createdAt": "2020-04-22T21:17:13Z", "author": {"login": "rymsha"}, "path": "modules/admin/admin-impl/src/main/java/com/enonic/xp/admin/impl/rest/resource/project/icon/ProjectIconResource.java", "diffHunk": "@@ -0,0 +1,192 @@\n+package com.enonic.xp.admin.impl.rest.resource.project.icon;\n+\n+import java.awt.image.BufferedImage;\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.UncheckedIOException;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Paths;\n+import java.util.Iterator;\n+\n+import javax.annotation.security.RolesAllowed;\n+import javax.imageio.ImageIO;\n+import javax.imageio.ImageWriter;\n+import javax.ws.rs.DefaultValue;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.PathParam;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.QueryParam;\n+import javax.ws.rs.WebApplicationException;\n+import javax.ws.rs.core.CacheControl;\n+import javax.ws.rs.core.Response;\n+\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Reference;\n+\n+import com.google.common.hash.HashCode;\n+import com.google.common.hash.Hashing;\n+import com.google.common.io.ByteSource;\n+\n+import com.enonic.xp.admin.impl.rest.resource.content.ResolvedImage;\n+import com.enonic.xp.attachment.Attachment;\n+import com.enonic.xp.home.HomeDir;\n+import com.enonic.xp.image.ImageHelper;\n+import com.enonic.xp.jaxrs.JaxRsComponent;\n+import com.enonic.xp.project.Project;\n+import com.enonic.xp.project.ProjectName;\n+import com.enonic.xp.project.ProjectService;\n+import com.enonic.xp.repository.RepositoryService;\n+import com.enonic.xp.security.RoleKeys;\n+import com.enonic.xp.util.HexEncoder;\n+import com.enonic.xp.util.ImmutableFilesHelper;\n+\n+import static com.enonic.xp.admin.impl.rest.resource.ResourceConstants.REST_ROOT;\n+import static com.google.common.base.Strings.isNullOrEmpty;\n+\n+@Path(REST_ROOT + \"project/icon\")\n+@Produces(\"image/*\")\n+@RolesAllowed({RoleKeys.ADMIN_LOGIN_ID, RoleKeys.ADMIN_ID})\n+@Component(immediate = true, property = \"group=admin\")\n+public final class ProjectIconResource", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97ef3076d25c3f3de0082df000d62b1e518c6dc5"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3MzIzNzMxOnYy", "diffSide": "RIGHT", "path": "modules/core/core-api/src/main/java/com/enonic/xp/project/ProjectService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxNzo1ODoxNFrOGK0-4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxODo1Njo1NVrOGK3VeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAwNzAxMA==", "bodyText": "I think you need to introduce ModifyProjectParams\nAlso, what is size? dimension?", "url": "https://github.com/enonic/xp/pull/8045#discussion_r414007010", "createdAt": "2020-04-23T17:58:14Z", "author": {"login": "rymsha"}, "path": "modules/core/core-api/src/main/java/com/enonic/xp/project/ProjectService.java", "diffHunk": "@@ -9,6 +10,8 @@\n \n     Project modify( final ModifyProjectParams params );\n \n+    void modifyIcon( final ProjectName projectName, final CreateAttachment icon, final int size );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29c487618648aea1aade659658ba00b5fd2568c1"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA0NTU2MQ==", "bodyText": "To which width image will be scaled (if it's bigger). But size I like more than width  as a param here.", "url": "https://github.com/enonic/xp/pull/8045#discussion_r414045561", "createdAt": "2020-04-23T18:56:55Z", "author": {"login": "vbradnitski"}, "path": "modules/core/core-api/src/main/java/com/enonic/xp/project/ProjectService.java", "diffHunk": "@@ -9,6 +10,8 @@\n \n     Project modify( final ModifyProjectParams params );\n \n+    void modifyIcon( final ProjectName projectName, final CreateAttachment icon, final int size );", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAwNzAxMA=="}, "originalCommit": {"oid": "29c487618648aea1aade659658ba00b5fd2568c1"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3MzI0ODY0OnYy", "diffSide": "RIGHT", "path": "modules/core/core-api/src/main/java/com/enonic/xp/image/ImageHelper.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxODowMDo1MlrOGK1F7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxODowMDo1MlrOGK1F7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAwODgxNA==", "bodyText": "No TODOs, please", "url": "https://github.com/enonic/xp/pull/8045#discussion_r414008814", "createdAt": "2020-04-23T18:00:52Z", "author": {"login": "rymsha"}, "path": "modules/core/core-api/src/main/java/com/enonic/xp/image/ImageHelper.java", "diffHunk": "@@ -85,6 +85,45 @@ public static ImageWriter getWriterByFormat( final String format )\n         }\n     }\n \n+    public static String getFormatByMimeType( final String mimeType )\n+        throws IOException\n+    {\n+        final Iterator<ImageWriter> i = ImageIO.getImageWritersByMIMEType( mimeType );\n+        if ( !i.hasNext() )\n+        {\n+            throw new IOException( \"The image-based media type \" + mimeType + \" is not supported for writing\" );\n+        }\n+\n+        return i.next().getOriginatingProvider().getFormatNames()[0];\n+    }\n+\n+    public static ByteSource serializeImage( final BufferedImage bufferedImage, final String mimeType, final int quality )\n+        throws IOException\n+    {\n+        final byte[] serializedImage;\n+        //TODO If/Else due to a difference of treatment between admin and portal. Should be uniform", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29c487618648aea1aade659658ba00b5fd2568c1"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3MzgyNDM2OnYy", "diffSide": "RIGHT", "path": "modules/core/core-api/src/main/java/com/enonic/xp/image/ImageHelper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMDoyMDo0OFrOGK6eZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQwNzoxODo0MVrOGLJ_hQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5Njk5OQ==", "bodyText": "Format is only part of hash, right? If so, it should be private", "url": "https://github.com/enonic/xp/pull/8045#discussion_r414096999", "createdAt": "2020-04-23T20:20:48Z", "author": {"login": "rymsha"}, "path": "modules/core/core-api/src/main/java/com/enonic/xp/image/ImageHelper.java", "diffHunk": "@@ -85,6 +85,44 @@ public static ImageWriter getWriterByFormat( final String format )\n         }\n     }\n \n+    public static String getFormatByMimeType( final String mimeType )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1d7b62cb445ef69be8bc81c43f0e8829b0846a5"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM1MTIzNw==", "bodyText": "no, we have deprecated api method to fetch it.", "url": "https://github.com/enonic/xp/pull/8045#discussion_r414351237", "createdAt": "2020-04-24T07:18:41Z", "author": {"login": "vbradnitski"}, "path": "modules/core/core-api/src/main/java/com/enonic/xp/image/ImageHelper.java", "diffHunk": "@@ -85,6 +85,44 @@ public static ImageWriter getWriterByFormat( final String format )\n         }\n     }\n \n+    public static String getFormatByMimeType( final String mimeType )", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5Njk5OQ=="}, "originalCommit": {"oid": "b1d7b62cb445ef69be8bc81c43f0e8829b0846a5"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3MzgzNzc2OnYy", "diffSide": "RIGHT", "path": "modules/core/core-api/src/main/java/com/enonic/xp/image/ImageHelper.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMDoyNDowNVrOGK6mIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMDoyNDowNVrOGK6mIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5ODk3OA==", "bodyText": "Float is slower and less precise.\nAnyway let's make a more generic solution.", "url": "https://github.com/enonic/xp/pull/8045#discussion_r414098978", "createdAt": "2020-04-23T20:24:05Z", "author": {"login": "rymsha"}, "path": "modules/core/core-api/src/main/java/com/enonic/xp/image/ImageHelper.java", "diffHunk": "@@ -203,6 +241,18 @@ public static BufferedImage scaleSquare( final BufferedImage source, final int s\n         return getScaledInstance( cropped, size, size );\n     }\n \n+    public static BufferedImage scaleWidth( BufferedImage source, final int size )\n+    {\n+        int width = source.getWidth();\n+        int height = source.getHeight();\n+        float scale = (float) size / (float) width;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1d7b62cb445ef69be8bc81c43f0e8829b0846a5"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3Mzg0MDgxOnYy", "diffSide": "RIGHT", "path": "modules/core/core-api/src/main/java/com/enonic/xp/image/ImageHelper.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMDoyNTowMFrOGK6n-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMDoyNTowMFrOGK6n-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5OTQ1MQ==", "bodyText": "newWidth instead of size\nAPI should have more generic method. This one is too specific", "url": "https://github.com/enonic/xp/pull/8045#discussion_r414099451", "createdAt": "2020-04-23T20:25:00Z", "author": {"login": "rymsha"}, "path": "modules/core/core-api/src/main/java/com/enonic/xp/image/ImageHelper.java", "diffHunk": "@@ -203,6 +241,18 @@ public static BufferedImage scaleSquare( final BufferedImage source, final int s\n         return getScaledInstance( cropped, size, size );\n     }\n \n+    public static BufferedImage scaleWidth( BufferedImage source, final int size )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1d7b62cb445ef69be8bc81c43f0e8829b0846a5"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3Mzg1NzE3OnYy", "diffSide": "RIGHT", "path": "modules/core/core-api/src/main/java/com/enonic/xp/image/ImageHelper.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMDoyOToxNFrOGK6x3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMDoyOToxNFrOGK6x3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEwMTk4MA==", "bodyText": "Avoid ByteSource in API. byte[] is ok here", "url": "https://github.com/enonic/xp/pull/8045#discussion_r414101980", "createdAt": "2020-04-23T20:29:14Z", "author": {"login": "rymsha"}, "path": "modules/core/core-api/src/main/java/com/enonic/xp/image/ImageHelper.java", "diffHunk": "@@ -85,6 +85,44 @@ public static ImageWriter getWriterByFormat( final String format )\n         }\n     }\n \n+    public static String getFormatByMimeType( final String mimeType )\n+        throws IOException\n+    {\n+        final Iterator<ImageWriter> i = ImageIO.getImageWritersByMIMEType( mimeType );\n+        if ( !i.hasNext() )\n+        {\n+            throw new IOException( \"The image-based media type \" + mimeType + \" is not supported for writing\" );\n+        }\n+\n+        return i.next().getOriginatingProvider().getFormatNames()[0];\n+    }\n+\n+    public static ByteSource serializeImage( final BufferedImage bufferedImage, final String mimeType, final int quality )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1d7b62cb445ef69be8bc81c43f0e8829b0846a5"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3Mzg2NzgyOnYy", "diffSide": "RIGHT", "path": "modules/core/core-api/src/main/java/com/enonic/xp/project/ModifyProjectIconParams.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMDozMTo1NlrOGK64Sg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMDozMTo1NlrOGK64Sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEwMzYyNg==", "bodyText": "width?", "url": "https://github.com/enonic/xp/pull/8045#discussion_r414103626", "createdAt": "2020-04-23T20:31:56Z", "author": {"login": "rymsha"}, "path": "modules/core/core-api/src/main/java/com/enonic/xp/project/ModifyProjectIconParams.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package com.enonic.xp.project;\n+\n+import com.google.common.base.Preconditions;\n+\n+import com.enonic.xp.annotation.PublicApi;\n+import com.enonic.xp.attachment.CreateAttachment;\n+\n+@PublicApi\n+public final class ModifyProjectIconParams\n+{\n+    private final ProjectName name;\n+\n+    private final CreateAttachment icon;\n+\n+    private final int size;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1d7b62cb445ef69be8bc81c43f0e8829b0846a5"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3Mzg3ODI5OnYy", "diffSide": "RIGHT", "path": "modules/core/core-project/src/main/java/com/enonic/xp/core/impl/project/ProjectServiceImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMDozNDo1MlrOGK6-ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMDozNDo1MlrOGK6-ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEwNTI3NA==", "bodyText": "debug.", "url": "https://github.com/enonic/xp/pull/8045#discussion_r414105274", "createdAt": "2020-04-23T20:34:52Z", "author": {"login": "rymsha"}, "path": "modules/core/core-project/src/main/java/com/enonic/xp/core/impl/project/ProjectServiceImpl.java", "diffHunk": "@@ -161,6 +162,43 @@ private Project doModify( final ModifyProjectParams params )\n         return Project.from( updatedRepository );\n     }\n \n+    @Override\n+    public void modifyIcon( final ModifyProjectIconParams params )\n+    {\n+        callWithUpdateContext( ( () -> {\n+            doModifyIcon( params );\n+            LOG.info( \"Icon for project updated: \" + params.getName() );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1d7b62cb445ef69be8bc81c43f0e8829b0846a5"}, "originalPosition": 57}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1052, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}