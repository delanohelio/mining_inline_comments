{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4NzMyNDIz", "number": 8089, "title": "Vacuum and Dump fail on big repository (XP 6.15) #8069", "bodyText": "", "createdAt": "2020-05-15T18:11:49Z", "url": "https://github.com/enonic/xp/pull/8089", "merged": true, "mergeCommit": {"oid": "ee1d995b67a15afefb086cc97914d173e68716f5"}, "closed": true, "closedAt": "2020-05-18T14:48:52Z", "author": {"login": "vbradnitski"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchotfAABqjMzNDI2MTA1NDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcifwhnAFqTQxMzU4NTU5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e1c1b217b2181fba709b10682f48dc4e161a7f28", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/e1c1b217b2181fba709b10682f48dc4e161a7f28", "committedDate": "2020-05-15T18:11:14Z", "message": "Vacuum and Dump fail on big repository (XP 6.15) #8069"}, "afterCommit": {"oid": "c0a1cd9f5ae959f760280cba9822528d87a6d02a", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/c0a1cd9f5ae959f760280cba9822528d87a6d02a", "committedDate": "2020-05-15T21:10:09Z", "message": "Vacuum and Dump fail on big repository (XP 6.15) #8069"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyODcyODI1", "url": "https://github.com/enonic/xp/pull/8089#pullrequestreview-412872825", "createdAt": "2020-05-15T18:25:35Z", "commit": {"oid": "e1c1b217b2181fba709b10682f48dc4e161a7f28"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxODoyNTozNVrOGWPb4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxODoyNjozNFrOGWPd0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk3NDc1Mg==", "bodyText": "For simplicity it can be just boolean", "url": "https://github.com/enonic/xp/pull/8089#discussion_r425974752", "createdAt": "2020-05-15T18:25:35Z", "author": {"login": "rymsha"}, "path": "modules/core/core-repo/src/main/java/com/enonic/xp/repo/impl/vacuum/versiontable/VersionTableCleanupTask.java", "diffHunk": "@@ -222,4 +208,9 @@ public void setVersionService( final VersionService versionService )\n     {\n         this.versionService = versionService;\n     }\n+\n+    private enum Status\n+    {\n+        NOT_STARTED, IN_PROGRESS", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1c1b217b2181fba709b10682f48dc4e161a7f28"}, "originalPosition": 162}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk3NTI1MA==", "bodyText": "generify Object", "url": "https://github.com/enonic/xp/pull/8089#discussion_r425975250", "createdAt": "2020-05-15T18:26:34Z", "author": {"login": "rymsha"}, "path": "modules/core/core-api/src/main/java/com/enonic/xp/node/AbstractQuery.java", "diffHunk": "@@ -44,6 +45,8 @@\n \n     private final boolean explain;\n \n+    private final Consumer<Object> batchCallback;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1c1b217b2181fba709b10682f48dc4e161a7f28"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c0a1cd9f5ae959f760280cba9822528d87a6d02a", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/c0a1cd9f5ae959f760280cba9822528d87a6d02a", "committedDate": "2020-05-15T21:10:09Z", "message": "Vacuum and Dump fail on big repository (XP 6.15) #8069"}, "afterCommit": {"oid": "f8c12958fb296ef643077c628b371d0799318752", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/f8c12958fb296ef643077c628b371d0799318752", "committedDate": "2020-05-16T16:02:53Z", "message": "Vacuum and Dump fail on big repository (XP 6.15) #8069"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f8c12958fb296ef643077c628b371d0799318752", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/f8c12958fb296ef643077c628b371d0799318752", "committedDate": "2020-05-16T16:02:53Z", "message": "Vacuum and Dump fail on big repository (XP 6.15) #8069"}, "afterCommit": {"oid": "3c3d93dfa5f686ddc3e690ec763792afc8376635", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/3c3d93dfa5f686ddc3e690ec763792afc8376635", "committedDate": "2020-05-16T16:04:57Z", "message": "Vacuum and Dump fail on big repository (XP 6.15) #8069"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3c3d93dfa5f686ddc3e690ec763792afc8376635", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/3c3d93dfa5f686ddc3e690ec763792afc8376635", "committedDate": "2020-05-16T16:04:57Z", "message": "Vacuum and Dump fail on big repository (XP 6.15) #8069"}, "afterCommit": {"oid": "b9cb8ff02850348ffde6ea3fbd39da7aa80cbbdc", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/b9cb8ff02850348ffde6ea3fbd39da7aa80cbbdc", "committedDate": "2020-05-16T16:06:24Z", "message": "Vacuum and Dump fail on big repository (XP 6.15) #8069"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMzIwOTE2", "url": "https://github.com/enonic/xp/pull/8089#pullrequestreview-413320916", "createdAt": "2020-05-18T07:06:58Z", "commit": {"oid": "b9cb8ff02850348ffde6ea3fbd39da7aa80cbbdc"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwNzowNjo1OFrOGWp9ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwNzowNzoyOFrOGWp-uA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQwOTQxMQ==", "bodyText": "should not be here", "url": "https://github.com/enonic/xp/pull/8089#discussion_r426409411", "createdAt": "2020-05-18T07:06:58Z", "author": {"login": "rymsha"}, "path": "modules/core/core-repo/src/main/java/com/enonic/xp/repo/impl/dump/RepoDumper.java", "diffHunk": "@@ -2,13 +2,15 @@\n \n import java.time.Duration;\n import java.time.Instant;\n+import java.util.HashSet;\n import java.util.Set;\n+import java.util.function.Consumer;\n import java.util.stream.Collectors;\n \n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import com.google.common.collect.Sets;\n+import jdk.net.SocketFlow;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9cb8ff02850348ffde6ea3fbd39da7aa80cbbdc"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQwOTY1Ng==", "bodyText": "Or, for now remove generic <Object>", "url": "https://github.com/enonic/xp/pull/8089#discussion_r426409656", "createdAt": "2020-05-18T07:07:28Z", "author": {"login": "rymsha"}, "path": "modules/core/core-api/src/main/java/com/enonic/xp/node/AbstractQuery.java", "diffHunk": "@@ -44,6 +45,8 @@\n \n     private final boolean explain;\n \n+    private final Consumer<Object> batchCallback;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk3NTI1MA=="}, "originalCommit": {"oid": "e1c1b217b2181fba709b10682f48dc4e161a7f28"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b9cb8ff02850348ffde6ea3fbd39da7aa80cbbdc", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/b9cb8ff02850348ffde6ea3fbd39da7aa80cbbdc", "committedDate": "2020-05-16T16:06:24Z", "message": "Vacuum and Dump fail on big repository (XP 6.15) #8069"}, "afterCommit": {"oid": "5ccece9d6f5790213cde7fe0425dd744e60e7bf3", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/5ccece9d6f5790213cde7fe0425dd744e60e7bf3", "committedDate": "2020-05-18T08:22:25Z", "message": "Vacuum and Dump fail on big repository (XP 6.15) #8069"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5ccece9d6f5790213cde7fe0425dd744e60e7bf3", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/5ccece9d6f5790213cde7fe0425dd744e60e7bf3", "committedDate": "2020-05-18T08:22:25Z", "message": "Vacuum and Dump fail on big repository (XP 6.15) #8069"}, "afterCommit": {"oid": "32178fdd9feb2131e0a0e6d1b0ecf1929d9998b2", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/32178fdd9feb2131e0a0e6d1b0ecf1929d9998b2", "committedDate": "2020-05-18T08:25:06Z", "message": "Vacuum and Dump fail on big repository (XP 6.15) #8069"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "32178fdd9feb2131e0a0e6d1b0ecf1929d9998b2", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/32178fdd9feb2131e0a0e6d1b0ecf1929d9998b2", "committedDate": "2020-05-18T08:25:06Z", "message": "Vacuum and Dump fail on big repository (XP 6.15) #8069"}, "afterCommit": {"oid": "063581d7b46b4a231c5f3bd1aa588f21a046fea4", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/063581d7b46b4a231c5f3bd1aa588f21a046fea4", "committedDate": "2020-05-18T09:46:39Z", "message": "Vacuum and Dump fail on big repository (XP 6.15) #8069"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzNDU4Mzky", "url": "https://github.com/enonic/xp/pull/8089#pullrequestreview-413458392", "createdAt": "2020-05-18T10:16:14Z", "commit": {"oid": "063581d7b46b4a231c5f3bd1aa588f21a046fea4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMDoxNjoxNFrOGWwtMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMDoxNjoxNFrOGWwtMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUxOTg1OA==", "bodyText": "will be better to use isEmpty", "url": "https://github.com/enonic/xp/pull/8089#discussion_r426519858", "createdAt": "2020-05-18T10:16:14Z", "author": {"login": "anatol-sialitski"}, "path": "modules/core/core-repo/src/main/java/com/enonic/xp/repo/impl/vacuum/versiontable/VersionTableCleanupTask.java", "diffHunk": "@@ -181,28 +147,56 @@ private boolean versionUsedInAnyBranch( final Repository repository, final NodeV\n         return false;\n     }\n \n-    private NodeVersionQuery createQuery( final NodeVersionId lastVersionId )\n+    private NodeVersionQuery createQuery( final Repository repository )\n     {\n         final NodeVersionQuery.Builder builder = NodeVersionQuery.create();\n \n-        if ( lastVersionId != null )\n+        builder.addQueryFilter( RangeFilter.create().\n+            fieldName( VersionIndexPath.TIMESTAMP.getPath() ).\n+            to( ValueFactory.newDateTime( this.until ) ).\n+            build() );\n+\n+        builder.size( -1 ).\n+            batchSize( 100 ).\n+            batchCallback( result -> this.handleBatchCallback( (SearchResult) result, repository, builder.build() ) );\n+\n+        return builder.build();\n+    }\n+\n+    private void handleBatchCallback( final SearchResult searchResult, final Repository repository,\n+                                      final NodeVersionQuery nodeVersionQuery )\n+    {\n+        final List<NodeVersionDocumentId> toBeDeleted = Lists.newArrayList();\n+\n+        final long versionTotal = searchResult.getTotalHits();\n+        if ( !this.repositoryCleanStarted )\n         {\n-            final RangeFilter versionIdFilter = RangeFilter.create().\n-                fieldName( VersionIndexPath.VERSION_ID.getPath() ).\n-                from( ValueFactory.newString( lastVersionId.toString() ) ).\n-                build();\n-            builder.addQueryFilter( versionIdFilter );\n+            if ( listener != null )\n+            {\n+                listener.vacuumingVersionRepository( repository.getId(), versionTotal );\n+\n+            }\n+            this.repositoryCleanStarted = true;\n         }\n \n-        final RangeFilter mustBeOlderThanFilter = RangeFilter.create().\n-            fieldName( VersionIndexPath.TIMESTAMP.getPath() ).\n-            to( ValueFactory.newDateTime( this.until ) ).\n-            build();\n+        if ( searchResult.getHits().getSize() == 0 )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "063581d7b46b4a231c5f3bd1aa588f21a046fea4"}, "originalPosition": 130}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzNDU4ODM3", "url": "https://github.com/enonic/xp/pull/8089#pullrequestreview-413458837", "createdAt": "2020-05-18T10:16:52Z", "commit": {"oid": "063581d7b46b4a231c5f3bd1aa588f21a046fea4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6d9d9c5e66b7bf8d0b99b2643034b36eec1b434", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/c6d9d9c5e66b7bf8d0b99b2643034b36eec1b434", "committedDate": "2020-05-18T10:23:49Z", "message": "Vacuum and Dump fail on big repository (XP 6.15) #8069"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "063581d7b46b4a231c5f3bd1aa588f21a046fea4", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/063581d7b46b4a231c5f3bd1aa588f21a046fea4", "committedDate": "2020-05-18T09:46:39Z", "message": "Vacuum and Dump fail on big repository (XP 6.15) #8069"}, "afterCommit": {"oid": "c6d9d9c5e66b7bf8d0b99b2643034b36eec1b434", "author": {"user": {"login": "vbradnitski", "name": "Bradnitski Viachaslau"}}, "url": "https://github.com/enonic/xp/commit/c6d9d9c5e66b7bf8d0b99b2643034b36eec1b434", "committedDate": "2020-05-18T10:23:49Z", "message": "Vacuum and Dump fail on big repository (XP 6.15) #8069"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzNDkxOTk4", "url": "https://github.com/enonic/xp/pull/8089#pullrequestreview-413491998", "createdAt": "2020-05-18T11:07:30Z", "commit": {"oid": "c6d9d9c5e66b7bf8d0b99b2643034b36eec1b434"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzNTg1NTk2", "url": "https://github.com/enonic/xp/pull/8089#pullrequestreview-413585596", "createdAt": "2020-05-18T13:19:34Z", "commit": {"oid": "c6d9d9c5e66b7bf8d0b99b2643034b36eec1b434"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4545, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}