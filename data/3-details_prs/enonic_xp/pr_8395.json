{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxMDEyOTg5", "number": 8395, "title": "Simultaneous app start/stop on all nodes #8360", "bodyText": "Before start/stop/uninstall the initiator node sends a respective event to other nodes in the cluster. Other nodes try to start/stop/uninstall - it happens simultaneously on all nodes.\napplication install is more complex process, as it needs to persist app first into shared storage. So it still waits for install to finish on initiator node.", "createdAt": "2020-09-22T15:13:00Z", "url": "https://github.com/enonic/xp/pull/8395", "merged": true, "mergeCommit": {"oid": "13f128ecefff3d47413d54211e24ee75d1c231ee"}, "closed": true, "closedAt": "2020-09-23T14:54:44Z", "author": {"login": "rymsha"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLm6N5gBqjM3OTY1MTg5OTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLtkkCABqjM3OTg0NjI3MjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "14b7f3bcb52b69c15d23fbbb93f309715e9d07cb", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/14b7f3bcb52b69c15d23fbbb93f309715e9d07cb", "committedDate": "2020-09-22T15:12:21Z", "message": "Simultaneous app start/stop on all nodes #8360"}, "afterCommit": {"oid": "b4c94cbf640ca2d7a24a6f67b7cc021c6f1f61d6", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/b4c94cbf640ca2d7a24a6f67b7cc021c6f1f61d6", "committedDate": "2020-09-23T06:50:10Z", "message": "Simultaneous app start/stop on all nodes #8360"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b4c94cbf640ca2d7a24a6f67b7cc021c6f1f61d6", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/b4c94cbf640ca2d7a24a6f67b7cc021c6f1f61d6", "committedDate": "2020-09-23T06:50:10Z", "message": "Simultaneous app start/stop on all nodes #8360"}, "afterCommit": {"oid": "3a4187a4407f6360e030b7e15727e0c05c547ae2", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/3a4187a4407f6360e030b7e15727e0c05c547ae2", "committedDate": "2020-09-23T06:58:23Z", "message": "Simultaneous app start/stop on all nodes #8360"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3a4187a4407f6360e030b7e15727e0c05c547ae2", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/3a4187a4407f6360e030b7e15727e0c05c547ae2", "committedDate": "2020-09-23T06:58:23Z", "message": "Simultaneous app start/stop on all nodes #8360"}, "afterCommit": {"oid": "fd3f29fc421989c4b937db1da1744dae81f31570", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/fd3f29fc421989c4b937db1da1744dae81f31570", "committedDate": "2020-09-23T07:21:23Z", "message": "Simultaneous app start/stop on all nodes #8360"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0NTg5Nzgw", "url": "https://github.com/enonic/xp/pull/8395#pullrequestreview-494589780", "createdAt": "2020-09-23T12:10:16Z", "commit": {"oid": "fd3f29fc421989c4b937db1da1744dae81f31570"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxMjoxMDoxN1rOHWpqPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxMjoxMDoxN1rOHWpqPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzUxMzI3OQ==", "bodyText": "What about default block?", "url": "https://github.com/enonic/xp/pull/8395#discussion_r493513279", "createdAt": "2020-09-23T12:10:17Z", "author": {"login": "anatol-sialitski"}, "path": "modules/core/core-app/src/main/java/com/enonic/xp/core/impl/app/event/ApplicationClusterEventListener.java", "diffHunk": "@@ -17,100 +19,81 @@\n public class ApplicationClusterEventListener\n     implements EventListener\n {\n-    private ApplicationService applicationService;\n+    private final ApplicationService applicationService;\n+\n+    @Activate\n+    public ApplicationClusterEventListener( @Reference final ApplicationService applicationService )\n+    {\n+        this.applicationService = applicationService;\n+    }\n \n     @Override\n     public void onEvent( final Event event )\n     {\n-        if ( event != null )\n+        if ( !event.isLocalOrigin() )\n         {\n-            if ( event.isLocalOrigin() )\n-            {\n-                return;\n-            }\n-\n             doHandleEvent( event );\n         }\n     }\n \n     private void doHandleEvent( final Event event )\n     {\n-        final String type = event.getType();\n-\n-        if ( type.equals( ApplicationClusterEvents.EVENT_TYPE ) )\n+        if ( ApplicationClusterEvents.EVENT_TYPE.equals( event.getType() ) )\n         {\n-            final String eventSubType = event.getValueAs( String.class, ApplicationClusterEvents.EVENT_TYPE_KEY ).get();\n-\n-            switch ( eventSubType )\n-            {\n-                case ApplicationClusterEvents.INSTALLED:\n-                    handleInstalledEvent( event );\n-                    break;\n-                case ApplicationClusterEvents.STATE_CHANGE:\n-                    handleStateChangedEvent( event );\n-                    break;\n-                case ApplicationClusterEvents.UNINSTALLED:\n-                    handleUninstalledEvent( event );\n-                    break;\n-            }\n+            event.getValueAs( String.class, ApplicationClusterEvents.EVENT_TYPE_KEY ).\n+                ifPresent( eventSubType -> {\n+                    switch ( eventSubType )\n+                    {\n+                        case ApplicationClusterEvents.INSTALLED:\n+                            handleInstalledEvent( event );\n+                            break;\n+                        case ApplicationClusterEvents.UNINSTALL:\n+                            handleUninstallEvent( event );\n+                            break;\n+                        case ApplicationClusterEvents.START:\n+                            handleStartEvent( event );\n+                            break;\n+                        case ApplicationClusterEvents.STOP:\n+                            handleStopEvent( event );\n+                            break;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd3f29fc421989c4b937db1da1744dae81f31570"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0NjkxNzMx", "url": "https://github.com/enonic/xp/pull/8395#pullrequestreview-494691731", "createdAt": "2020-09-23T13:59:30Z", "commit": {"oid": "fd3f29fc421989c4b937db1da1744dae81f31570"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0NzEyNDA2", "url": "https://github.com/enonic/xp/pull/8395#pullrequestreview-494712406", "createdAt": "2020-09-23T14:19:18Z", "commit": {"oid": "fd3f29fc421989c4b937db1da1744dae81f31570"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd3f29fc421989c4b937db1da1744dae81f31570", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/fd3f29fc421989c4b937db1da1744dae81f31570", "committedDate": "2020-09-23T07:21:23Z", "message": "Simultaneous app start/stop on all nodes #8360"}, "afterCommit": {"oid": "2612e74933b427d0cdb83790484d26504c968abf", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/2612e74933b427d0cdb83790484d26504c968abf", "committedDate": "2020-09-23T14:23:27Z", "message": "Simultaneous app start/stop on all nodes #8360"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "055fe2ff7e11b1e379457c11a8d2eacbb6ee3c2a", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/055fe2ff7e11b1e379457c11a8d2eacbb6ee3c2a", "committedDate": "2020-09-23T14:35:46Z", "message": "Simultaneous app start/stop on all nodes #8360"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2612e74933b427d0cdb83790484d26504c968abf", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/2612e74933b427d0cdb83790484d26504c968abf", "committedDate": "2020-09-23T14:23:27Z", "message": "Simultaneous app start/stop on all nodes #8360"}, "afterCommit": {"oid": "055fe2ff7e11b1e379457c11a8d2eacbb6ee3c2a", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/055fe2ff7e11b1e379457c11a8d2eacbb6ee3c2a", "committedDate": "2020-09-23T14:35:46Z", "message": "Simultaneous app start/stop on all nodes #8360"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4385, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}