{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3NzQzMzg1", "number": 8219, "title": "Cluster health-check may cause applications inconsistencies #8086", "bodyText": "Cluster health-check int its destructive behavior removed.\nRemoval of health check means that ClusterManagerImpl no longer tries to put down Cluster(s)\nThis change broke some fragile code:\n\n\nInitializers started to run too early, when Elasticsearch may still be in RED state (yes, Elasticsearch need time to start shards), to address this IndexService got waitForYelowStatus method (which is called from readyToInitialize). It is not the best place, but since ExternalInitializer is part of public API (and very commonly used) it was the only suitable place.\n\n\nInitializers have started to fail more often due to #6681 and similar bugs got more exposed. Fixed it in this PR. Noticeable change: now /content, /issue, etc... nodes get pushed from draft to master (before it was from master to draft) - that way it is simpler to check if repository is fully ready.\n\n\nSnapshot Restore got broken: it was waiting for ClusterManager to report RED state after closing indices in order to start restoring them. Now it never happens. Instead of that FrameworkService can now be \"reset\" - uninstall all bundles that are not part of the system. And Snapshot Restore does that right before restoring a snapshot. This helps to avoid a lot of ERROR logs (because by that time Elasticsearch indices are closed). In addition to that FrameworkService can now be \"restarted\" - basically instantiate OSGI Framework from scratch. And Snapshot Restore does that right after restore is completed! It guarantees that old versions of applications don't survive after snapshot restore is complete. This is an incomplete fix of #8221 , but a good starting point.\nRestart didn't work well on Windows with JNA bundle, so I had to move JNA bundle to system libs. Jars in libs are not part of OSGi and don't get \"restarted\".\n\n\nDump Load was refactored and generally repeats what Snapshot Restore does: uninstall apps before load and restart framework entirely after load. all the magic around application ununstall/install in the Dump Restore removed (because OSGi framework is fully restarted instead. It addresses #8172\n\n\nOther related changes\n\nElasticsearchCluster never gets disabled, so responsibility of registering ES Client moved to ElasticsearchActivator.\nCluster enable/disable/isEnabled methods are deprecated because clusers are always enabled now.\nInitializer now honors attempts/timeouts specified (before it was just endless |while| loop)\nDump Load is auditlog aware now. (Before autitlog repository could easily disappear after load)\nsecurity fix: I tried to remove as many RepositoryService references as possible and found ProjectPermissionsContextManagerImpl throwing different error if repository does not exist, even when user has no rights on that repository. Now InsufficientRights exception is thrown even if repository does not exist. So unauthorized users cannot know if repository exists or not.\n\n#8107 is obsolete. I added some extra logging into dump and load\n#7692 is obsolete. because unhealthy clusters don't kill applications anymore\n#7328 maybe obsolete. Applications are functional even when ES is read-only. It is possible to recover from read-only as management port is accessible\n#6700 is obsolete. There is no cluster health check anyone. Slow master response won't kill nodes.\n#6681 fixed. See above.\n#5422 maybe obsolete.\n#8172 fixed. See above.", "createdAt": "2020-07-11T09:07:49Z", "url": "https://github.com/enonic/xp/pull/8219", "merged": true, "mergeCommit": {"oid": "edadb61fe1401984fc09bf8c6f36feac117fd1ee"}, "closed": true, "closedAt": "2020-07-21T11:37:48Z", "author": {"login": "rymsha"}, "timelineItems": {"totalCount": 31, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcz0oCggFqTQ0Njc5MDUyNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3EmGQgFqTQ1MjM2Njc1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NzkwNTI2", "url": "https://github.com/enonic/xp/pull/8219#pullrequestreview-446790526", "createdAt": "2020-07-11T09:15:00Z", "commit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToxNTowMVrOGwLozw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToxNTowMVrOGwLozw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3NTUwMw==", "bodyText": "40 is a magic number, that represents XP launcher start level. Find a way to un-hardcode it.", "url": "https://github.com/enonic/xp/pull/8219#discussion_r453175503", "createdAt": "2020-07-11T09:15:01Z", "author": {"login": "rymsha"}, "path": "modules/core/core-repo/src/main/java/com/enonic/xp/repo/impl/elasticsearch/snapshot/ClusterCleaner.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package com.enonic.xp.repo.impl.elasticsearch.snapshot;\n+\n+import org.osgi.framework.Bundle;\n+import org.osgi.framework.BundleContext;\n+import org.osgi.framework.BundleException;\n+import org.osgi.framework.startlevel.BundleStartLevel;\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.enonic.xp.event.Event;\n+import com.enonic.xp.event.EventListener;\n+import com.enonic.xp.repo.impl.RepositoryEvents;\n+\n+@Component(immediate = true)\n+public class ClusterCleaner\n+    implements EventListener\n+{\n+    private final static Logger LOG = LoggerFactory.getLogger( ClusterCleaner.class );\n+\n+    private final BundleContext bundleContext;\n+\n+    @Activate\n+    public ClusterCleaner( final BundleContext bundleContext )\n+    {\n+        this.bundleContext = bundleContext;\n+    }\n+\n+    @Override\n+    public void onEvent( final Event event )\n+    {\n+        if ( event.isType( RepositoryEvents.RESTORE_INITIALIZED_EVENT_TYPE ) )\n+        {\n+            for ( Bundle bundle : bundleContext.getBundles() )\n+            {\n+                if ( bundle.adapt( BundleStartLevel.class ).getStartLevel() > 40 )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NzkwNTQ2", "url": "https://github.com/enonic/xp/pull/8219#pullrequestreview-446790546", "createdAt": "2020-07-11T09:15:20Z", "commit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToxNToyMVrOGwLo-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToxNToyMVrOGwLo-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3NTU0Ng==", "bodyText": "grammar", "url": "https://github.com/enonic/xp/pull/8219#discussion_r453175546", "createdAt": "2020-07-11T09:15:21Z", "author": {"login": "rymsha"}, "path": "modules/core/core-repo/src/test/java/com/enonic/xp/repo/impl/dump/DumpServiceImplTest.java", "diffHunk": "@@ -1083,8 +1089,11 @@ private Node updateNode( final Node node )\n     {\n         return updateNode( UpdateNodeParams.create().\n             id( node.id() ).\n-            editor( ( n ) -> n.data.setInstant( \"timestamp\", Instant.now() ) ).\n+            editor( ( n ) -> {\n+                // Guarantee new node version is created. Without it update is ignored because node is not changed.\n+                // N.B. Writing \"current time\" (even System#nanoTime) does not have the same guarantee due low to timer resolution.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "originalPosition": 190}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NzkwNTY1", "url": "https://github.com/enonic/xp/pull/8219#pullrequestreview-446790565", "createdAt": "2020-07-11T09:15:46Z", "commit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToxNTo0NlrOGwLpHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToxNTo0NlrOGwLpHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3NTU4MA==", "bodyText": "move to own PR", "url": "https://github.com/enonic/xp/pull/8219#discussion_r453175580", "createdAt": "2020-07-11T09:15:46Z", "author": {"login": "rymsha"}, "path": "modules/core/core-api/src/main/java/com/enonic/xp/data/PropertyPath.java", "diffHunk": "@@ -35,7 +35,7 @@\n     public static PropertyPath from( final PropertyPath parentPath, final String element )\n     {\n         Preconditions.checkNotNull( parentPath, \"parentPath cannot be null\" );\n-        Preconditions.checkNotNull( parentPath, \"element cannot be null\" );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NzkwNjEz", "url": "https://github.com/enonic/xp/pull/8219#pullrequestreview-446790613", "createdAt": "2020-07-11T09:16:41Z", "commit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToxNjo0MVrOGwLpbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToxNjo0MVrOGwLpbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3NTY2MA==", "bodyText": "call it readyToInitialize", "url": "https://github.com/enonic/xp/pull/8219#discussion_r453175660", "createdAt": "2020-07-11T09:16:41Z", "author": {"login": "rymsha"}, "path": "modules/core/core-api/src/main/java/com/enonic/xp/init/Initializer.java", "diffHunk": "@@ -72,6 +84,8 @@ public void initialize()\n \n     protected abstract void doInitialize();\n \n+    protected abstract boolean canInitialize();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "originalPosition": 91}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NzkwNjQ5", "url": "https://github.com/enonic/xp/pull/8219#pullrequestreview-446790649", "createdAt": "2020-07-11T09:17:19Z", "commit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToxNzoxOVrOGwLppg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToxNzoxOVrOGwLppg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3NTcxOA==", "bodyText": "It would be nice not to extend API.", "url": "https://github.com/enonic/xp/pull/8219#discussion_r453175718", "createdAt": "2020-07-11T09:17:19Z", "author": {"login": "rymsha"}, "path": "modules/core/core-api/src/main/java/com/enonic/xp/repository/CreateRepositoryParams.java", "diffHunk": "@@ -54,6 +57,11 @@ public ChildOrder getRootChildOrder()\n         return rootChildOrder;\n     }\n \n+    public boolean isFailIfExists()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NzkwODIz", "url": "https://github.com/enonic/xp/pull/8219#pullrequestreview-446790823", "createdAt": "2020-07-11T09:20:37Z", "commit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToyMDozN1rOGwLqpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToyMDozN1rOGwLqpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3NTk3NQ==", "bodyText": "make green not part of default branch", "url": "https://github.com/enonic/xp/pull/8219#discussion_r453175975", "createdAt": "2020-07-11T09:20:37Z", "author": {"login": "rymsha"}, "path": "modules/core/core-elasticsearch/src/main/java/com/enonic/xp/elasticsearch/impl/ElasticsearchCluster.java", "diffHunk": "@@ -192,26 +124,24 @@ private DiscoveryNodes getMembers()\n             indices( \"\" ).\n             masterNodeTimeout( CLUSTER_HEALTH_TIMEOUT );\n \n-        final ClusterStateResponse response = this.node.client().admin().cluster().state( clusterStateRequest ).actionGet();\n+        final ClusterStateResponse response = node.client().admin().cluster().state( clusterStateRequest ).actionGet();\n \n         return response.getState().getNodes();\n     }\n \n     private ClusterHealth toClusterHealth( final ClusterHealthResponse healthResponse )\n     {\n-        if ( healthResponse.getStatus() == org.elasticsearch.cluster.health.ClusterHealthStatus.RED )\n+        switch ( healthResponse.getStatus() )\n         {\n-            return ClusterHealth.create().\n-                status( ClusterHealthStatus.RED ).\n-                errorMessage( healthResponse.toString() ).\n-                build();\n+            case RED:\n+                return ClusterHealth.create().\n+                    status( ClusterHealthStatus.RED ).\n+                    errorMessage( healthResponse.toString() ).\n+                    build();\n+            case YELLOW:\n+                return ClusterHealth.yellow();\n+            default:\n+                return ClusterHealth.green();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "originalPosition": 183}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NzkxMDQ2", "url": "https://github.com/enonic/xp/pull/8219#pullrequestreview-446791046", "createdAt": "2020-07-11T09:25:12Z", "commit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToyNToxMlrOGwLsAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToyNToxMlrOGwLsAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3NjMyMg==", "bodyText": "de-optimize / inline", "url": "https://github.com/enonic/xp/pull/8219#discussion_r453176322", "createdAt": "2020-07-11T09:25:12Z", "author": {"login": "rymsha"}, "path": "modules/core/core-repo/src/main/java/com/enonic/xp/repo/impl/dump/RepoDumper.java", "diffHunk": "@@ -77,11 +76,11 @@\n \n     private RepoDumper( final Builder builder )\n     {\n-        this.repositoryId = builder.repositoryId;\n+        this.repository = builder.repository;\n+        this.repositoryId = builder.repository.getId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NzkxMTIx", "url": "https://github.com/enonic/xp/pull/8219#pullrequestreview-446791121", "createdAt": "2020-07-11T09:26:32Z", "commit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToyNjozM1rOGwLsdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToyNjozM1rOGwLsdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3NjQzNg==", "bodyText": "should be a better way to fail if exists. don't do a check here.", "url": "https://github.com/enonic/xp/pull/8219#discussion_r453176436", "createdAt": "2020-07-11T09:26:33Z", "author": {"login": "rymsha"}, "path": "modules/core/core-project/src/main/java/com/enonic/xp/core/impl/project/ProjectServiceImpl.java", "diffHunk": "@@ -74,22 +73,21 @@\n     @Activate\n     public void initialize()\n     {\n-        adminContext().runWith( () -> {\n-            if ( doGet( ProjectName.from( ContentConstants.CONTENT_REPO_ID ) ) == null )\n-            {\n-                doCreate( CreateProjectParams.create().\n-                    name( ProjectConstants.DEFAULT_PROJECT.getName() ).\n-                    displayName( ProjectConstants.DEFAULT_PROJECT.getDisplayName() ).\n-                    description( ProjectConstants.DEFAULT_PROJECT.getDescription() ).\n-                    build() );\n-            }\n-        } );\n+        adminContext().runWith( () -> doCreate( CreateProjectParams.create().\n+            name( ProjectConstants.DEFAULT_PROJECT.getName() ).\n+            displayName( ProjectConstants.DEFAULT_PROJECT.getDisplayName() ).\n+            description( ProjectConstants.DEFAULT_PROJECT.getDescription() ).\n+            build() ) );\n     }\n \n     @Override\n     public Project create( CreateProjectParams params )\n     {\n         return callWithCreateContext( ( () -> {\n+            if ( repositoryService.isInitialized( params.getName().getRepoId() ) )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NzkxMTky", "url": "https://github.com/enonic/xp/pull/8219#pullrequestreview-446791192", "createdAt": "2020-07-11T09:27:51Z", "commit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToyNzo1MVrOGwLs1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToyNzo1MVrOGwLs1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3NjUzNQ==", "bodyText": "rearrange code, for there are only two returns.", "url": "https://github.com/enonic/xp/pull/8219#discussion_r453176535", "createdAt": "2020-07-11T09:27:51Z", "author": {"login": "rymsha"}, "path": "modules/core/core-repo/src/main/java/com/enonic/xp/repo/impl/elasticsearch/IndexServiceInternalImpl.java", "diffHunk": "@@ -109,6 +105,31 @@ public boolean isMaster()\n         return clusterStateResponse.getState().nodes().localNodeMaster();\n     }\n \n+    @Override\n+    public boolean waitForYellowStatus( final String... indexNames )\n+    {\n+        try\n+        {\n+            final ClusterHealthStatus clusterHealth = doGetClusterHealth( CLUSTER_HEALTH_TIMEOUT, indexNames );\n+\n+            if ( clusterHealth.isTimedOut() || clusterHealth.getClusterStatusCode().equals( ClusterStatusCode.RED ) )\n+            {\n+                LOG.error( \"Cluster not healthy: timed out: {}, state: {}\", clusterHealth.isTimedOut(),\n+                           clusterHealth.getClusterStatusCode() );\n+                return false;\n+            }\n+\n+            return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NzkxMjY4", "url": "https://github.com/enonic/xp/pull/8219#pullrequestreview-446791268", "createdAt": "2020-07-11T09:29:16Z", "commit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToyOToxNlrOGwLtQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOToyOToxNlrOGwLtQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3NjY0Mg==", "bodyText": "find a better name", "url": "https://github.com/enonic/xp/pull/8219#discussion_r453176642", "createdAt": "2020-07-11T09:29:16Z", "author": {"login": "rymsha"}, "path": "modules/core/core-repo/src/main/java/com/enonic/xp/repo/impl/elasticsearch/snapshot/ClusterCleaner.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package com.enonic.xp.repo.impl.elasticsearch.snapshot;\n+\n+import org.osgi.framework.Bundle;\n+import org.osgi.framework.BundleContext;\n+import org.osgi.framework.BundleException;\n+import org.osgi.framework.startlevel.BundleStartLevel;\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.enonic.xp.event.Event;\n+import com.enonic.xp.event.EventListener;\n+import com.enonic.xp.repo.impl.RepositoryEvents;\n+\n+@Component(immediate = true)\n+public class ClusterCleaner", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NzkxNDU2", "url": "https://github.com/enonic/xp/pull/8219#pullrequestreview-446791456", "createdAt": "2020-07-11T09:32:39Z", "commit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOTozMjozOVrOGwLuXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwOTozMjozOVrOGwLuXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3NjkyNQ==", "bodyText": "Move to own PR", "url": "https://github.com/enonic/xp/pull/8219#discussion_r453176925", "createdAt": "2020-07-11T09:32:39Z", "author": {"login": "rymsha"}, "path": "modules/runtime/build.gradle", "diffHunk": "@@ -1,6 +1,7 @@\n import org.apache.tools.ant.filters.ReplaceTokens\n \n apply plugin: 'java-base'\n+apply plugin: 'distribution'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f5e064500ddc17131e57405baececcfd28268fe6", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/f5e064500ddc17131e57405baececcfd28268fe6", "committedDate": "2020-07-11T09:07:06Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}, "afterCommit": {"oid": "ac40437d07f5acc7f396d5b548700112a7cac9cd", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/ac40437d07f5acc7f396d5b548700112a7cac9cd", "committedDate": "2020-07-13T08:23:38Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ac40437d07f5acc7f396d5b548700112a7cac9cd", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/ac40437d07f5acc7f396d5b548700112a7cac9cd", "committedDate": "2020-07-13T08:23:38Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}, "afterCommit": {"oid": "d65d2d4c3535bace5b3769cfa1bb1a47a241c367", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/d65d2d4c3535bace5b3769cfa1bb1a47a241c367", "committedDate": "2020-07-13T08:33:38Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fab48b1bde21736ee0c48e77596c50264a13efcf", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/fab48b1bde21736ee0c48e77596c50264a13efcf", "committedDate": "2020-07-13T08:57:24Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}, "afterCommit": {"oid": "8466b7f38ff0eea25f9ea39344b8582688a9a6ce", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/8466b7f38ff0eea25f9ea39344b8582688a9a6ce", "committedDate": "2020-07-13T12:38:21Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8466b7f38ff0eea25f9ea39344b8582688a9a6ce", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/8466b7f38ff0eea25f9ea39344b8582688a9a6ce", "committedDate": "2020-07-13T12:38:21Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}, "afterCommit": {"oid": "a7c86c1519b22cc49e0c89e4474b3226742a09c9", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/a7c86c1519b22cc49e0c89e4474b3226742a09c9", "committedDate": "2020-07-13T14:37:47Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a7c86c1519b22cc49e0c89e4474b3226742a09c9", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/a7c86c1519b22cc49e0c89e4474b3226742a09c9", "committedDate": "2020-07-13T14:37:47Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}, "afterCommit": {"oid": "98420953b2afe0800c36a7c95e87bd98c9bbba46", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/98420953b2afe0800c36a7c95e87bd98c9bbba46", "committedDate": "2020-07-13T15:57:15Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "98420953b2afe0800c36a7c95e87bd98c9bbba46", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/98420953b2afe0800c36a7c95e87bd98c9bbba46", "committedDate": "2020-07-13T15:57:15Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}, "afterCommit": {"oid": "5f0ffc8c63a353a69dc5f8cd14be1b8589f93cb2", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/5f0ffc8c63a353a69dc5f8cd14be1b8589f93cb2", "committedDate": "2020-07-13T16:50:39Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5f0ffc8c63a353a69dc5f8cd14be1b8589f93cb2", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/5f0ffc8c63a353a69dc5f8cd14be1b8589f93cb2", "committedDate": "2020-07-13T16:50:39Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}, "afterCommit": {"oid": "2fd112631c39c964dfac0ce05ab06638885c616e", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/2fd112631c39c964dfac0ce05ab06638885c616e", "committedDate": "2020-07-14T15:52:32Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2fd112631c39c964dfac0ce05ab06638885c616e", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/2fd112631c39c964dfac0ce05ab06638885c616e", "committedDate": "2020-07-14T15:52:32Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}, "afterCommit": {"oid": "540f28ce174f9128618c21262d89b54d877a5062", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/540f28ce174f9128618c21262d89b54d877a5062", "committedDate": "2020-07-14T16:01:26Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "540f28ce174f9128618c21262d89b54d877a5062", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/540f28ce174f9128618c21262d89b54d877a5062", "committedDate": "2020-07-14T16:01:26Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}, "afterCommit": {"oid": "694089cb44c0997871e816b6f192586cf8cfb9f2", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/694089cb44c0997871e816b6f192586cf8cfb9f2", "committedDate": "2020-07-16T12:44:42Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "694089cb44c0997871e816b6f192586cf8cfb9f2", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/694089cb44c0997871e816b6f192586cf8cfb9f2", "committedDate": "2020-07-16T12:44:42Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}, "afterCommit": {"oid": "9c08a6c380981fc287d6731a6581ec71b0df37bb", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/9c08a6c380981fc287d6731a6581ec71b0df37bb", "committedDate": "2020-07-16T14:26:58Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9c08a6c380981fc287d6731a6581ec71b0df37bb", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/9c08a6c380981fc287d6731a6581ec71b0df37bb", "committedDate": "2020-07-16T14:26:58Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}, "afterCommit": {"oid": "af975096bbf8a98a706fcdbb4884027379a30959", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/af975096bbf8a98a706fcdbb4884027379a30959", "committedDate": "2020-07-17T11:03:22Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "af975096bbf8a98a706fcdbb4884027379a30959", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/af975096bbf8a98a706fcdbb4884027379a30959", "committedDate": "2020-07-17T11:03:22Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}, "afterCommit": {"oid": "cc89adce286d9e5e8caa78f520148c2c41a2d928", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/cc89adce286d9e5e8caa78f520148c2c41a2d928", "committedDate": "2020-07-17T14:16:30Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cc89adce286d9e5e8caa78f520148c2c41a2d928", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/cc89adce286d9e5e8caa78f520148c2c41a2d928", "committedDate": "2020-07-17T14:16:30Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}, "afterCommit": {"oid": "2af4354c1125bff5e267473d1fc8aeaac77a69ac", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/2af4354c1125bff5e267473d1fc8aeaac77a69ac", "committedDate": "2020-07-17T18:03:52Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2af4354c1125bff5e267473d1fc8aeaac77a69ac", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/2af4354c1125bff5e267473d1fc8aeaac77a69ac", "committedDate": "2020-07-17T18:03:52Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}, "afterCommit": {"oid": "5e2a6dba88e436ce8f51506d67538389037c3c17", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/5e2a6dba88e436ce8f51506d67538389037c3c17", "committedDate": "2020-07-17T19:01:03Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1903dbe955b354f3b67a52b5aaae01ef4520e800", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/1903dbe955b354f3b67a52b5aaae01ef4520e800", "committedDate": "2020-07-20T15:05:41Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}, "afterCommit": {"oid": "acf668b31cc00e1f99473ef016f49abf7fb0a237", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/acf668b31cc00e1f99473ef016f49abf7fb0a237", "committedDate": "2020-07-20T17:27:37Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "acf668b31cc00e1f99473ef016f49abf7fb0a237", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/acf668b31cc00e1f99473ef016f49abf7fb0a237", "committedDate": "2020-07-20T17:27:37Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}, "afterCommit": {"oid": "8f9726810306acc197e77a8ac613e4bc7529fdd0", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/8f9726810306acc197e77a8ac613e4bc7529fdd0", "committedDate": "2020-07-21T07:59:30Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac816cdd33fa31afa58806a46663b9c51e2357e9", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/ac816cdd33fa31afa58806a46663b9c51e2357e9", "committedDate": "2020-07-21T09:26:41Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8f9726810306acc197e77a8ac613e4bc7529fdd0", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/8f9726810306acc197e77a8ac613e4bc7529fdd0", "committedDate": "2020-07-21T07:59:30Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}, "afterCommit": {"oid": "ac816cdd33fa31afa58806a46663b9c51e2357e9", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/ac816cdd33fa31afa58806a46663b9c51e2357e9", "committedDate": "2020-07-21T09:26:41Z", "message": "Cluster health-check may cause applications inconsistencies #8086"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyMzEzMDcx", "url": "https://github.com/enonic/xp/pull/8219#pullrequestreview-452313071", "createdAt": "2020-07-21T10:08:19Z", "commit": {"oid": "ac816cdd33fa31afa58806a46663b9c51e2357e9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyMzY2NzUx", "url": "https://github.com/enonic/xp/pull/8219#pullrequestreview-452366751", "createdAt": "2020-07-21T11:33:09Z", "commit": {"oid": "ac816cdd33fa31afa58806a46663b9c51e2357e9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4440, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}