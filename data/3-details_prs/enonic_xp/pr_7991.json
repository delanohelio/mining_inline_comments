{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2OTcxMDU0", "number": 7991, "title": "Application fails to update properly under load #7978", "bodyText": "ApplicationListener got deprecated as it was never used. ApplicationListenerHub responsible for ApplicationListeners notification is kept but no longer able to catch all application bundle events because it is now controlled by ApplicationServiceImpl which has no fully synchronous control over bundle/application binding . It was the main cause of issue: ApplicationListenerHub could invalidate Application instance too early (while it was still in STOPPING state), causing other threads to re-capture reference to a dying bundle.\nApplicationService invalidate method got deprecated. It is unreliable and can cause deadlocks.\nFallback to ConfigAdmin is kept is branch 7.2 to simplify PR readability, but will be removed in master.\nScriptExecutorManager now verifies BundleContext before creating an ScriptExecutor. Without such a check any frontend request could create an executor with null BundleContext, even if new Application Bundle was correctly captured (applicationService.getInstalledApplication may return Application even if bundle is just INSTALLED, but in such state bundles don't have context yet)", "createdAt": "2020-04-01T12:43:36Z", "url": "https://github.com/enonic/xp/pull/7991", "merged": true, "mergeCommit": {"oid": "3ff9457f13daf25a723508007f7e45942685c29a"}, "closed": true, "closedAt": "2020-04-02T09:33:05Z", "author": {"login": "rymsha"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTXDqyAH2gAyMzk2OTcxMDU0OjQ3MmRiZWVlNjY0ZDM2ZmMxZGZiMjE3NjYxMGMwNjU4MDY4M2FmMDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTo8UmAFqTM4NjI1NzYyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "472dbeee664d36fc1dfb2176610c06580683af09", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/472dbeee664d36fc1dfb2176610c06580683af09", "committedDate": "2020-04-01T12:42:28Z", "message": "Application fails to update properly under load #7978"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NjcyNzEy", "url": "https://github.com/enonic/xp/pull/7991#pullrequestreview-385672712", "createdAt": "2020-04-01T15:00:53Z", "commit": {"oid": "472dbeee664d36fc1dfb2176610c06580683af09"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNTowMDo1M1rOF_E1-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNTowMDo1M1rOF_E1-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY4Mzk2Mg==", "bodyText": "Config happens after invalidation. Super-fast frontend request may grab old config for ScriptExecutor", "url": "https://github.com/enonic/xp/pull/7991#discussion_r401683962", "createdAt": "2020-04-01T15:00:53Z", "author": {"login": "rymsha"}, "path": "modules/core/core-app/src/main/java/com/enonic/xp/core/impl/app/ApplicationRegistry.java", "diffHunk": "@@ -96,8 +97,7 @@ public void setConfiguration( final ApplicationKey key, final Configuration conf\n                     callInvalidators( k, ApplicationInvalidationLevel.CACHE );\n                 }\n                 LOG.debug( \"Configure and unlatch app {}\", key );\n-                v.application.setConfig( configuration );\n-                v.unlatch();\n+                v.setConfig( configuration );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "472dbeee664d36fc1dfb2176610c06580683af09"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1Njg0MzI4", "url": "https://github.com/enonic/xp/pull/7991#pullrequestreview-385684328", "createdAt": "2020-04-01T15:13:00Z", "commit": {"oid": "472dbeee664d36fc1dfb2176610c06580683af09"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MTU4NDY5", "url": "https://github.com/enonic/xp/pull/7991#pullrequestreview-386158469", "createdAt": "2020-04-02T07:11:35Z", "commit": {"oid": "472dbeee664d36fc1dfb2176610c06580683af09"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNzoxMTozNVrOF_eDXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNzoxMTozNVrOF_eDXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA5Njk5MA==", "bodyText": "Why this log is used twice?", "url": "https://github.com/enonic/xp/pull/7991#discussion_r402096990", "createdAt": "2020-04-02T07:11:35Z", "author": {"login": "anatol-sialitski"}, "path": "modules/core/core-app/src/main/java/com/enonic/xp/core/impl/app/ApplicationServiceImpl.java", "diffHunk": "@@ -579,7 +582,9 @@ private void uninstallBundle( final ApplicationKey applicationKey )\n \n             if ( bundle != null )\n             {\n+                LOG.debug( \"Uninstalling application {} bundle {}\", applicationKey, bundle.getBundleId() );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "472dbeee664d36fc1dfb2176610c06580683af09"}, "originalPosition": 273}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MjU3NjIy", "url": "https://github.com/enonic/xp/pull/7991#pullrequestreview-386257622", "createdAt": "2020-04-02T09:32:44Z", "commit": {"oid": "472dbeee664d36fc1dfb2176610c06580683af09"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4505, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}