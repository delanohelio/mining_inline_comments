{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI5NTIxNTMy", "number": 8140, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwNzozNjozNFrOEDVKwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDo0MDowMlrOED0LOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxOTI4MDAyOnYy", "diffSide": "RIGHT", "path": "modules/admin/admin-impl/src/main/java/com/enonic/xp/admin/impl/rest/resource/issue/IssueResource.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwNzozNjozNFrOGgSQ7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwNzozNjozNFrOGgSQ7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjUwNjg2Mg==", "bodyText": "this is unnecessary. anyMatch will immediately return false on empty", "url": "https://github.com/enonic/xp/pull/8140#discussion_r436506862", "createdAt": "2020-06-08T07:36:34Z", "author": {"login": "rymsha"}, "path": "modules/admin/admin-impl/src/main/java/com/enonic/xp/admin/impl/rest/resource/issue/IssueResource.java", "diffHunk": "@@ -479,21 +482,34 @@ private UpdateIssueParams generateUpdateIssueParams( final UpdateIssueJson json\n \n     private PrincipalKeys filterInvalidAssignees( final List<PrincipalKey> assignees )\n     {\n-        return PrincipalKeys.from( assignees.stream().filter( this::isValidAssignee ).collect( Collectors.toList() ) );\n+        final ProjectPermissions projectPermissions = getCurrentProjectPermissions();\n+\n+        return PrincipalKeys.from(\n+            assignees.stream().filter( ( principalKey ) -> isValidAssignee( principalKey, projectPermissions ) ).collect(\n+                Collectors.toList() ) );\n     }\n \n-    private boolean isValidAssignee( final PrincipalKey principalKey )\n+    private ProjectPermissions getCurrentProjectPermissions()\n     {\n-        final PrincipalKeys membershipKeys = securityService.getAllMemberships( principalKey );\n-        if ( membershipKeys.getSize() > 0 )\n+        final ProjectName projectName = ProjectName.from( ContextAccessor.current().getRepositoryId() );\n+        return projectService.getPermissions( projectName );\n+    }\n+\n+    private boolean isValidAssignee( final PrincipalKey principalKey, final ProjectPermissions projectPermissions )\n+    {\n+        if ( hasProjectPermissions( principalKey, projectPermissions ) )\n         {\n-            final Principals memberships = securityService.getPrincipals( membershipKeys );\n-            return memberships.stream().anyMatch( this::hasIssuePermissions );\n+            return true;\n         }\n-        else\n+\n+        final PrincipalKeys membershipKeys = securityService.getAllMemberships( principalKey );\n+\n+        if ( membershipKeys.getSize() > 0 )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e3f1cd57158d1e179877b12320149b0a0c35c94"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxOTI5MTc3OnYy", "diffSide": "RIGHT", "path": "modules/admin/admin-impl/src/main/java/com/enonic/xp/admin/impl/rest/resource/issue/IssueResource.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwNzo0MDozOVrOGgSYhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwNzo0MDozOVrOGgSYhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjUwODgwNw==", "bodyText": "I don't think this is  correct anymore. #7942 describes previous content roles as \"just\" default project roles", "url": "https://github.com/enonic/xp/pull/8140#discussion_r436508807", "createdAt": "2020-06-08T07:40:39Z", "author": {"login": "rymsha"}, "path": "modules/admin/admin-impl/src/main/java/com/enonic/xp/admin/impl/rest/resource/issue/IssueResource.java", "diffHunk": "@@ -509,24 +525,34 @@ private PrincipalKeys filterKeys( final PrincipalKeys oldKeys, final PrincipalKe\n         }\n     }\n \n-    private boolean hasIssuePermissions( final Principal principal )\n+    private boolean hasIssuePermissions( final PrincipalKey principalKey, final ProjectPermissions projectPermissions )\n     {\n-        if ( principal.getKey().equals( RoleKeys.ADMIN ) )\n+        if ( principalKey.equals( RoleKeys.ADMIN ) )\n+        {\n+            return true;\n+        }\n+\n+        if ( principalKey.equals( RoleKeys.CONTENT_MANAGER_ADMIN ) )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e3f1cd57158d1e179877b12320149b0a0c35c94"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyMTY5OTY0OnYy", "diffSide": "RIGHT", "path": "modules/admin/admin-impl/src/main/java/com/enonic/xp/admin/impl/rest/resource/issue/IssueResource.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNzo1NDozNlrOGgpoBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNzo1NDozNlrOGgpoBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg4OTYwNw==", "bodyText": "here null projectPermisions propagates and accepted into hasIssuePermissions. it looks like a bug", "url": "https://github.com/enonic/xp/pull/8140#discussion_r436889607", "createdAt": "2020-06-08T17:54:36Z", "author": {"login": "rymsha"}, "path": "modules/admin/admin-impl/src/main/java/com/enonic/xp/admin/impl/rest/resource/issue/IssueResource.java", "diffHunk": "@@ -479,21 +483,36 @@ private UpdateIssueParams generateUpdateIssueParams( final UpdateIssueJson json\n \n     private PrincipalKeys filterInvalidAssignees( final List<PrincipalKey> assignees )\n     {\n-        return PrincipalKeys.from( assignees.stream().filter( this::isValidAssignee ).collect( Collectors.toList() ) );\n+        final ProjectPermissions projectPermissions = getCurrentProjectPermissions();\n+\n+        return PrincipalKeys.from( assignees.\n+            stream().\n+            filter( ( principalKey ) -> isValidAssignee( principalKey, projectPermissions ) ).\n+            collect( Collectors.toList() ) );\n     }\n \n-    private boolean isValidAssignee( final PrincipalKey principalKey )\n+    private ProjectPermissions getCurrentProjectPermissions()\n     {\n-        final PrincipalKeys membershipKeys = securityService.getAllMemberships( principalKey );\n-        if ( membershipKeys.getSize() > 0 )\n+        final ProjectName projectName = ProjectName.from( ContextAccessor.current().getRepositoryId() );\n+        return !ProjectConstants.DEFAULT_PROJECT_NAME.equals( projectName ) ? projectService.getPermissions( projectName ) : null;\n+    }\n+\n+    private boolean isValidAssignee( final PrincipalKey principalKey, final ProjectPermissions projectPermissions )\n+    {\n+        if ( !principalKey.isUser() )\n         {\n-            final Principals memberships = securityService.getPrincipals( membershipKeys );\n-            return memberships.stream().anyMatch( this::hasIssuePermissions );\n+            return false;\n         }\n-        else\n+\n+        if ( projectPermissions != null && hasProjectPermissions( principalKey, projectPermissions ) )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55378d38a54d681d0ec4fb7f06bafe5e78c316af"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyMTcwOTQwOnYy", "diffSide": "RIGHT", "path": "modules/admin/admin-impl/src/main/java/com/enonic/xp/admin/impl/rest/resource/issue/IssueResource.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNzo1NzoxNVrOGgpuCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNzo1NzoxNVrOGgpuCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg5MTE0NQ==", "bodyText": "It is hard for me to read this due to many negations and several exit points.\nI will note other needless negations as well", "url": "https://github.com/enonic/xp/pull/8140#discussion_r436891145", "createdAt": "2020-06-08T17:57:15Z", "author": {"login": "rymsha"}, "path": "modules/admin/admin-impl/src/main/java/com/enonic/xp/admin/impl/rest/resource/issue/IssueResource.java", "diffHunk": "@@ -479,21 +483,36 @@ private UpdateIssueParams generateUpdateIssueParams( final UpdateIssueJson json\n \n     private PrincipalKeys filterInvalidAssignees( final List<PrincipalKey> assignees )\n     {\n-        return PrincipalKeys.from( assignees.stream().filter( this::isValidAssignee ).collect( Collectors.toList() ) );\n+        final ProjectPermissions projectPermissions = getCurrentProjectPermissions();\n+\n+        return PrincipalKeys.from( assignees.\n+            stream().\n+            filter( ( principalKey ) -> isValidAssignee( principalKey, projectPermissions ) ).\n+            collect( Collectors.toList() ) );\n     }\n \n-    private boolean isValidAssignee( final PrincipalKey principalKey )\n+    private ProjectPermissions getCurrentProjectPermissions()\n     {\n-        final PrincipalKeys membershipKeys = securityService.getAllMemberships( principalKey );\n-        if ( membershipKeys.getSize() > 0 )\n+        final ProjectName projectName = ProjectName.from( ContextAccessor.current().getRepositoryId() );\n+        return !ProjectConstants.DEFAULT_PROJECT_NAME.equals( projectName ) ? projectService.getPermissions( projectName ) : null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55378d38a54d681d0ec4fb7f06bafe5e78c316af"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyMTcxMDQ5OnYy", "diffSide": "RIGHT", "path": "modules/admin/admin-impl/src/main/java/com/enonic/xp/admin/impl/rest/resource/issue/IssueResource.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNzo1NzozMVrOGgpuvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNzo1NzozMVrOGgpuvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg5MTMyNw==", "bodyText": "needless negation", "url": "https://github.com/enonic/xp/pull/8140#discussion_r436891327", "createdAt": "2020-06-08T17:57:31Z", "author": {"login": "rymsha"}, "path": "modules/admin/admin-impl/src/main/java/com/enonic/xp/admin/impl/rest/resource/issue/IssueResource.java", "diffHunk": "@@ -479,21 +483,36 @@ private UpdateIssueParams generateUpdateIssueParams( final UpdateIssueJson json\n \n     private PrincipalKeys filterInvalidAssignees( final List<PrincipalKey> assignees )\n     {\n-        return PrincipalKeys.from( assignees.stream().filter( this::isValidAssignee ).collect( Collectors.toList() ) );\n+        final ProjectPermissions projectPermissions = getCurrentProjectPermissions();\n+\n+        return PrincipalKeys.from( assignees.\n+            stream().\n+            filter( ( principalKey ) -> isValidAssignee( principalKey, projectPermissions ) ).\n+            collect( Collectors.toList() ) );\n     }\n \n-    private boolean isValidAssignee( final PrincipalKey principalKey )\n+    private ProjectPermissions getCurrentProjectPermissions()\n     {\n-        final PrincipalKeys membershipKeys = securityService.getAllMemberships( principalKey );\n-        if ( membershipKeys.getSize() > 0 )\n+        final ProjectName projectName = ProjectName.from( ContextAccessor.current().getRepositoryId() );\n+        return !ProjectConstants.DEFAULT_PROJECT_NAME.equals( projectName ) ? projectService.getPermissions( projectName ) : null;\n+    }\n+\n+    private boolean isValidAssignee( final PrincipalKey principalKey, final ProjectPermissions projectPermissions )\n+    {\n+        if ( !principalKey.isUser() )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55378d38a54d681d0ec4fb7f06bafe5e78c316af"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyMTcxMTM1OnYy", "diffSide": "RIGHT", "path": "modules/admin/admin-impl/src/main/java/com/enonic/xp/admin/impl/rest/resource/issue/IssueResource.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNzo1Nzo0N1rOGgpvWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNzo1Nzo0N1rOGgpvWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg5MTQ4Mw==", "bodyText": "needless negation", "url": "https://github.com/enonic/xp/pull/8140#discussion_r436891483", "createdAt": "2020-06-08T17:57:47Z", "author": {"login": "rymsha"}, "path": "modules/admin/admin-impl/src/main/java/com/enonic/xp/admin/impl/rest/resource/issue/IssueResource.java", "diffHunk": "@@ -509,24 +528,29 @@ private PrincipalKeys filterKeys( final PrincipalKeys oldKeys, final PrincipalKe\n         }\n     }\n \n-    private boolean hasIssuePermissions( final Principal principal )\n+    private boolean hasIssuePermissions( final PrincipalKey principalKey, final ProjectPermissions projectPermissions )\n     {\n-        if ( principal.getKey().equals( RoleKeys.ADMIN ) )\n+        if ( RoleKeys.ADMIN.equals( principalKey ) || RoleKeys.CONTENT_MANAGER_ADMIN.equals( principalKey ) ||\n+            RoleKeys.CONTENT_MANAGER_EXPERT.equals( principalKey ) )\n         {\n             return true;\n         }\n \n-        if ( principal.getKey().equals( RoleKeys.CONTENT_MANAGER_ADMIN ) )\n+        final ProjectName projectName = ProjectName.from( ContextAccessor.current().getRepositoryId() );\n+\n+        if ( !ProjectConstants.DEFAULT_PROJECT_NAME.equals( projectName ) )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55378d38a54d681d0ec4fb7f06bafe5e78c316af"}, "originalPosition": 88}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyNDM2MDI1OnYy", "diffSide": "RIGHT", "path": "modules/admin/admin-impl/src/main/java/com/enonic/xp/admin/impl/rest/resource/issue/IssueResource.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDo0MDowMlrOGhDcZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDo0MDowMlrOGhDcZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMxMjYxMw==", "bodyText": "This should be (almost) symmetric how default project and other projects handle permissions. Only one exception for now with Contributor role", "url": "https://github.com/enonic/xp/pull/8140#discussion_r437312613", "createdAt": "2020-06-09T10:40:02Z", "author": {"login": "rymsha"}, "path": "modules/admin/admin-impl/src/main/java/com/enonic/xp/admin/impl/rest/resource/issue/IssueResource.java", "diffHunk": "@@ -479,21 +483,34 @@ private UpdateIssueParams generateUpdateIssueParams( final UpdateIssueJson json\n \n     private PrincipalKeys filterInvalidAssignees( final List<PrincipalKey> assignees )\n     {\n-        return PrincipalKeys.from( assignees.stream().filter( this::isValidAssignee ).collect( Collectors.toList() ) );\n+        return PrincipalKeys.from( assignees.\n+            stream().\n+            filter( this::isValidAssignee ).\n+            collect( Collectors.toList() ) );\n     }\n \n+\n     private boolean isValidAssignee( final PrincipalKey principalKey )\n     {\n-        final PrincipalKeys membershipKeys = securityService.getAllMemberships( principalKey );\n-        if ( membershipKeys.getSize() > 0 )\n-        {\n-            final Principals memberships = securityService.getPrincipals( membershipKeys );\n-            return memberships.stream().anyMatch( this::hasIssuePermissions );\n-        }\n-        else\n+        if ( principalKey.isUser() )\n         {\n-            return false;\n+            final ProjectName projectName = ProjectName.from( ContextAccessor.current().getRepositoryId() );\n+            final PrincipalKeys membershipKeys = securityService.getAllMemberships( principalKey );\n+\n+            if ( ProjectConstants.DEFAULT_PROJECT_NAME.equals( projectName ) )\n+            {\n+                return membershipKeys.stream().anyMatch( this::hasManagerAccess );\n+            }\n+            else\n+            {\n+                final ProjectPermissions projectPermissions = projectService.getPermissions( projectName );\n+\n+                return isProjectOwnerOrEditor( principalKey, projectPermissions ) || membershipKeys.stream().", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bee8d114b2429a822014f22cffad15bad104d93e"}, "originalPosition": 61}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 981, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}