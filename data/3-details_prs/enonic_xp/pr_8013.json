{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwOTUxMTk2", "number": 8013, "title": "System Dumps straight into/from archive", "bodyText": "Test huge dumps (tested 800 MB)\n\n\n Cleanup Upgrade code a bit more (moved to #8023)\n\n\n Check Dump errors (they are not written as strings) #8024\n\n\n blobstore refactorings as a separate PR #8026\n\n\n FileDumpWriter.create fix arguments order\n\n\n avoid Set<NodeId> dumpedNodes when no versions dumped #8025\n\n\n Make sure upgrade and zip together throw exception\n\n\n Don't compress tar twice", "createdAt": "2020-04-08T16:24:16Z", "url": "https://github.com/enonic/xp/pull/8013", "merged": true, "mergeCommit": {"oid": "e9543704ba70dfa35ff3d422650f54f367dfc248"}, "closed": true, "closedAt": "2020-04-17T16:00:12Z", "author": {"login": "rymsha"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYOQGJgBqjMyNDA0MzE3MDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYjeMHgFqTM5NTU3OTUwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1810ef19d57fe0e522c0edf1b2f8ae8fe5bab51f", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/1810ef19d57fe0e522c0edf1b2f8ae8fe5bab51f", "committedDate": "2020-04-16T14:23:58Z", "message": "save"}, "afterCommit": {"oid": "4bb509183bef5b2735d7c4d239415f2d215453d9", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/4bb509183bef5b2735d7c4d239415f2d215453d9", "committedDate": "2020-04-16T15:16:20Z", "message": "save"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "db14d90a68884038dca668b6ce1e59a74e61a88b", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/db14d90a68884038dca668b6ce1e59a74e61a88b", "committedDate": "2020-04-17T09:22:41Z", "message": "save"}, "afterCommit": {"oid": "de4480a14eeec65c136165c4a4b0eef6117f4a47", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/de4480a14eeec65c136165c4a4b0eef6117f4a47", "committedDate": "2020-04-17T09:58:19Z", "message": "System Dumps straight into/from archive #8013"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e7679a658eb4556e83af197466fa146585df674", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/4e7679a658eb4556e83af197466fa146585df674", "committedDate": "2020-04-17T10:12:06Z", "message": "Serialize/Deserialize System Dumps straight into/from archive #7312"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de4480a14eeec65c136165c4a4b0eef6117f4a47", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/de4480a14eeec65c136165c4a4b0eef6117f4a47", "committedDate": "2020-04-17T09:58:19Z", "message": "System Dumps straight into/from archive #8013"}, "afterCommit": {"oid": "4e7679a658eb4556e83af197466fa146585df674", "author": {"user": {"login": "rymsha", "name": "Sergey Rymsha"}}, "url": "https://github.com/enonic/xp/commit/4e7679a658eb4556e83af197466fa146585df674", "committedDate": "2020-04-17T10:12:06Z", "message": "Serialize/Deserialize System Dumps straight into/from archive #7312"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1Mzg1NDYz", "url": "https://github.com/enonic/xp/pull/8013#pullrequestreview-395385463", "createdAt": "2020-04-17T11:47:46Z", "commit": {"oid": "4e7679a658eb4556e83af197466fa146585df674"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMTo0Nzo0N1rOGHK0yQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMTo0Nzo0N1rOGHK0yQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE3MDU2OQ==", "bodyText": "what about to check on NULL before closing?", "url": "https://github.com/enonic/xp/pull/8013#discussion_r410170569", "createdAt": "2020-04-17T11:47:47Z", "author": {"login": "anatol-sialitski"}, "path": "modules/core/core-repo/src/main/java/com/enonic/xp/repo/impl/dump/writer/AbstractDumpWriter.java", "diffHunk": "@@ -0,0 +1,232 @@\n+package com.enonic.xp.repo.impl.dump.writer;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.util.stream.Stream;\n+import java.util.zip.GZIPOutputStream;\n+\n+import org.apache.commons.compress.archivers.tar.TarArchiveEntry;\n+import org.apache.commons.compress.archivers.tar.TarArchiveOutputStream;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.enonic.xp.blob.BlobKey;\n+import com.enonic.xp.blob.BlobRecord;\n+import com.enonic.xp.blob.BlobStore;\n+import com.enonic.xp.blob.NodeVersionKey;\n+import com.enonic.xp.blob.Segment;\n+import com.enonic.xp.branch.Branch;\n+import com.enonic.xp.repo.impl.dump.DumpConstants;\n+import com.enonic.xp.repo.impl.dump.FilePaths;\n+import com.enonic.xp.repo.impl.dump.PathRef;\n+import com.enonic.xp.repo.impl.dump.RepoDumpException;\n+import com.enonic.xp.repo.impl.dump.blobstore.DumpBlobStore;\n+import com.enonic.xp.repo.impl.dump.model.BranchDumpEntry;\n+import com.enonic.xp.repo.impl.dump.model.CommitDumpEntry;\n+import com.enonic.xp.repo.impl.dump.model.DumpMeta;\n+import com.enonic.xp.repo.impl.dump.model.VersionsDumpEntry;\n+import com.enonic.xp.repo.impl.dump.serializer.DumpSerializer;\n+import com.enonic.xp.repo.impl.dump.serializer.json.DumpMetaJsonSerializer;\n+import com.enonic.xp.repo.impl.dump.serializer.json.JsonDumpSerializer;\n+import com.enonic.xp.repo.impl.node.NodeConstants;\n+import com.enonic.xp.repository.RepositoryId;\n+import com.enonic.xp.repository.RepositorySegmentUtils;\n+\n+public abstract class AbstractDumpWriter\n+    implements DumpWriter\n+{\n+    private final static Logger LOG = LoggerFactory.getLogger( FileDumpWriter.class );\n+\n+    private final DumpBlobStore dumpBlobStore;\n+\n+    private final BlobStore blobStore;\n+\n+    private final DumpSerializer serializer;\n+\n+    protected final FilePaths filePaths;\n+\n+    protected TarArchiveOutputStream tarOutputStream;\n+\n+    protected AbstractDumpWriter( final BlobStore blobStore, FilePaths filePaths, DumpBlobStore dumpBlobStore )\n+    {\n+        this.dumpBlobStore = dumpBlobStore;\n+        this.serializer = new JsonDumpSerializer();\n+        this.blobStore = blobStore;\n+        this.filePaths = filePaths;\n+    }\n+\n+    @Override\n+    public void writeDumpMetaData( final DumpMeta dumpMeta )\n+    {\n+        final PathRef dumpMetaFile = filePaths.metaDataFile();\n+\n+        try (final OutputStream outputStream = openMetaFileStream( dumpMetaFile ))\n+        {\n+            outputStream.write( new DumpMetaJsonSerializer().serialize( dumpMeta ) );\n+        }\n+        catch ( IOException e )\n+        {\n+            throw new RepoDumpException( \"Cannot write dump-meta file\", e );\n+        }\n+    }\n+\n+    @Override\n+    public void openBranchMeta( final RepositoryId repositoryId, final Branch branch )\n+    {\n+        final PathRef branchMetaPath = filePaths.branchMetaPath( repositoryId, branch );\n+        openTarStream( branchMetaPath );\n+    }\n+\n+    @Override\n+    public void openVersionsMeta( final RepositoryId repositoryId )\n+    {\n+        final PathRef versionMetaPath = filePaths.versionMetaPath( repositoryId );\n+        openTarStream( versionMetaPath );\n+    }\n+\n+    @Override\n+    public void openCommitsMeta( final RepositoryId repositoryId )\n+    {\n+        final PathRef commitMetaPath = filePaths.commitMetaPath( repositoryId );\n+        openTarStream( commitMetaPath );\n+    }\n+\n+    @Override\n+    public void closeMeta()\n+    {\n+        try\n+        {\n+            this.tarOutputStream.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e7679a658eb4556e83af197466fa146585df674"}, "originalPosition": 99}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NTI3NTc4", "url": "https://github.com/enonic/xp/pull/8013#pullrequestreview-395527578", "createdAt": "2020-04-17T14:56:13Z", "commit": {"oid": "4e7679a658eb4556e83af197466fa146585df674"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NTc5NTA2", "url": "https://github.com/enonic/xp/pull/8013#pullrequestreview-395579506", "createdAt": "2020-04-17T15:59:55Z", "commit": {"oid": "4e7679a658eb4556e83af197466fa146585df674"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4516, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}