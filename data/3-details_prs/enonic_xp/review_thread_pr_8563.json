{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyNTkyMDk3", "number": 8563, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxNjowMDo0N1rOFHPvbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMjowMzowMlrOFHxHGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQzMTQyMjUyOnYy", "diffSide": "RIGHT", "path": "modules/core/core-content/src/main/java/com/enonic/xp/core/impl/content/ParentContentSynchronizer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxNjowMDo0N1rOIIo3nQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxNjowMDo0N1rOIIo3nQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkyOTExNw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public Context sourceContext;", "url": "https://github.com/enonic/xp/pull/8563#discussion_r545929117", "createdAt": "2020-12-18T16:00:47Z", "author": {"login": "rymsha"}, "path": "modules/core/core-content/src/main/java/com/enonic/xp/core/impl/content/ParentContentSynchronizer.java", "diffHunk": "@@ -39,6 +39,10 @@\n \n     private final ContentService contentService;\n \n+    public Context sourceContext;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7e10660d786853812ec3deb7d73fec527685b75"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQzMTQyMzM3OnYy", "diffSide": "RIGHT", "path": "modules/core/core-content/src/main/java/com/enonic/xp/core/impl/content/ParentContentSynchronizer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxNjowMTowNFrOIIo4Hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxNjowMTowNFrOIIo4Hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkyOTI0Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private Context targetContext;", "url": "https://github.com/enonic/xp/pull/8563#discussion_r545929246", "createdAt": "2020-12-18T16:01:04Z", "author": {"login": "rymsha"}, "path": "modules/core/core-content/src/main/java/com/enonic/xp/core/impl/content/ParentContentSynchronizer.java", "diffHunk": "@@ -39,6 +39,10 @@\n \n     private final ContentService contentService;\n \n+    public Context sourceContext;\n+\n+    private Context targetContext;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7e10660d786853812ec3deb7d73fec527685b75"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQzMTQzMzExOnYy", "diffSide": "RIGHT", "path": "modules/core/core-content/src/main/java/com/enonic/xp/core/impl/content/SyncContentServiceImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxNjowMzo0MVrOIIo99Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxNjowMzo0MVrOIIo99Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkzMDc0MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \n          \n          \n            \n            @Override", "url": "https://github.com/enonic/xp/pull/8563#discussion_r545930741", "createdAt": "2020-12-18T16:03:41Z", "author": {"login": "rymsha"}, "path": "modules/core/core-content/src/main/java/com/enonic/xp/core/impl/content/SyncContentServiceImpl.java", "diffHunk": "@@ -73,4 +74,12 @@ public void resetInheritance( final ResetContentInheritParams params )\n             build().\n             execute();\n     }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7e10660d786853812ec3deb7d73fec527685b75"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQzMTQ0NTQzOnYy", "diffSide": "RIGHT", "path": "modules/core/core-api/src/main/java/com/enonic/xp/content/ProjectSyncParams.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxNjowNzowMVrOIIpFTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxNjowNzowMVrOIIpFTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkzMjYyMA==", "bodyText": "I am not sure source project should be here.\n\nIt allows to sync content from any project\nIt does not fit into muli-inheritance\n\nService should get sourceProject(s) from project data\ntargetProject should be called just project", "url": "https://github.com/enonic/xp/pull/8563#discussion_r545932620", "createdAt": "2020-12-18T16:07:01Z", "author": {"login": "rymsha"}, "path": "modules/core/core-api/src/main/java/com/enonic/xp/content/ProjectSyncParams.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package com.enonic.xp.content;\n+\n+import com.google.common.base.Preconditions;\n+\n+import com.enonic.xp.project.ProjectName;\n+\n+public final class ProjectSyncParams\n+{\n+    private final ProjectName sourceProject;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7e10660d786853812ec3deb7d73fec527685b75"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQzMTQ2NTYwOnYy", "diffSide": "RIGHT", "path": "modules/itest/itest-core/src/test/java/com/enonic/xp/core/content/ProjectEventListenerTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxNjoxMjoxM1rOIIpReg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxNjoxMjoxM1rOIIpReg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkzNTczOA==", "bodyText": "remove", "url": "https://github.com/enonic/xp/pull/8563#discussion_r545935738", "createdAt": "2020-12-18T16:12:13Z", "author": {"login": "rymsha"}, "path": "modules/itest/itest-core/src/test/java/com/enonic/xp/core/content/ProjectEventListenerTest.java", "diffHunk": "@@ -71,7 +70,7 @@ public void testChildren()\n         compareSynched( sourceChild2, targetChild2 );\n     }\n \n-    @Test\n+   /* @Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7e10660d786853812ec3deb7d73fec527685b75"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQzMTQ4NjA3OnYy", "diffSide": "RIGHT", "path": "modules/server/server-rest/src/main/java/com/enonic/xp/impl/server/rest/task/ProjectsSyncTask.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxNjoxNzoyMFrOIIpeHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxNjoxNzoyMFrOIIpeHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkzODk3NQ==", "bodyText": "Maybe transfer task caller context, so it is not always \"su\"?", "url": "https://github.com/enonic/xp/pull/8563#discussion_r545938975", "createdAt": "2020-12-18T16:17:20Z", "author": {"login": "rymsha"}, "path": "modules/server/server-rest/src/main/java/com/enonic/xp/impl/server/rest/task/ProjectsSyncTask.java", "diffHunk": "@@ -0,0 +1,125 @@\n+package com.enonic.xp.impl.server.rest.task;\n+\n+import com.google.common.base.Preconditions;\n+\n+import com.enonic.xp.content.ContentConstants;\n+import com.enonic.xp.content.ProjectSyncParams;\n+import com.enonic.xp.content.SyncContentService;\n+import com.enonic.xp.context.Context;\n+import com.enonic.xp.context.ContextBuilder;\n+import com.enonic.xp.project.Project;\n+import com.enonic.xp.project.ProjectService;\n+import com.enonic.xp.security.PrincipalKey;\n+import com.enonic.xp.security.RoleKeys;\n+import com.enonic.xp.security.User;\n+import com.enonic.xp.security.auth.AuthenticationInfo;\n+import com.enonic.xp.task.ProgressReporter;\n+import com.enonic.xp.task.RunnableTask;\n+import com.enonic.xp.task.TaskId;\n+\n+public final class ProjectsSyncTask\n+    implements RunnableTask\n+{\n+    private final ProjectService projectService;\n+\n+    private final SyncContentService syncContentService;\n+\n+    public ProjectsSyncTask( final Builder builder )\n+    {\n+        this.projectService = builder.projectService;\n+        this.syncContentService = builder.syncContentService;\n+    }\n+\n+    public static Builder create()\n+    {\n+        return new Builder();\n+    }\n+\n+    @Override\n+    public void run( final TaskId taskId, final ProgressReporter progressReporter )\n+    {\n+        createAdminContext().runWith( () -> this.projectService.list().\n+            stream().\n+            filter( project -> project.getParent() != null ).\n+            sorted( ( o1, o2 ) -> {\n+\n+                if ( o2.getName().equals( o1.getParent() ) )\n+                {\n+                    return 1;\n+                }\n+\n+                if ( o1.getName().equals( o2.getParent() ) )\n+                {\n+                    return -1;\n+                }\n+\n+                return 0;\n+            } ).\n+            forEach( project -> {\n+                Project parentProject = this.projectService.get( project.getParent() );\n+                doSync( parentProject, project, progressReporter );\n+            } ) );\n+    }\n+\n+    private void doSync( final Project sourceProject, final Project targetProject, final ProgressReporter progressReporter )\n+    {\n+        syncContentService.syncProject( ProjectSyncParams.create().\n+            sourceProject( sourceProject.getName() ).\n+            targetProject( targetProject.getName() ).\n+            build() );\n+    }\n+\n+    private Context createAdminContext()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7e10660d786853812ec3deb7d73fec527685b75"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQzNjg4NDUzOnYy", "diffSide": "RIGHT", "path": "modules/itest/itest-core/build.gradle", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMjowMDo1MVrOIJV9rA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMjowMDo1MVrOIJV9rA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY2Nzk0OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                testFixturesImplementation(testFixtures( project( \":core:core-task\" ) ))\n          \n          \n            \n                testImplementation(testFixtures( project( \":core:core-task\" ) ))", "url": "https://github.com/enonic/xp/pull/8563#discussion_r546667948", "createdAt": "2020-12-21T12:00:51Z", "author": {"login": "rymsha"}, "path": "modules/itest/itest-core/build.gradle", "diffHunk": "@@ -11,4 +11,8 @@ dependencies {\n     testImplementation( testFixtures( project(\":core:core-blobstore\") ) )\n     testImplementation( testFixtures( project(\":core:core-repo\") ) )\n     testImplementation( testFixtures( project(\":core:core-security\") ) )\n+    testImplementation( testFixtures( project(\":core:core-task\") ) )\n+    testImplementation( testFixtures( project(\":core:core-internal\") ) )\n+\n+    testFixturesImplementation(testFixtures( project( \":core:core-task\" ) ))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ef8cc2c9fb07d2ebd41cf18c28b8bea94d3c9aa"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQzNjg4OTg0OnYy", "diffSide": "RIGHT", "path": "modules/server/server-rest/src/main/java/com/enonic/xp/impl/server/rest/ProjectResource.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMjowMzowMlrOIJWA0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMjowMzowMlrOIJWA0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY2ODc1Mw==", "bodyText": "Write a doc", "url": "https://github.com/enonic/xp/pull/8563#discussion_r546668753", "createdAt": "2020-12-21T12:03:02Z", "author": {"login": "rymsha"}, "path": "modules/server/server-rest/src/main/java/com/enonic/xp/impl/server/rest/ProjectResource.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package com.enonic.xp.impl.server.rest;\n+\n+import javax.annotation.security.RolesAllowed;\n+import javax.ws.rs.Consumes;\n+import javax.ws.rs.POST;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.MediaType;\n+\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Reference;\n+\n+import com.enonic.xp.content.SyncContentService;\n+import com.enonic.xp.impl.server.rest.task.ProjectsSyncTask;\n+import com.enonic.xp.jaxrs.JaxRsComponent;\n+import com.enonic.xp.project.ProjectService;\n+import com.enonic.xp.security.RoleKeys;\n+import com.enonic.xp.task.TaskId;\n+import com.enonic.xp.task.TaskResultJson;\n+import com.enonic.xp.task.TaskService;\n+\n+@Path(\"/project\")\n+@Produces(MediaType.APPLICATION_JSON)\n+@Consumes(MediaType.APPLICATION_JSON)\n+@RolesAllowed(RoleKeys.ADMIN_ID)\n+@Component(immediate = true, property = \"group=api\")\n+public final class ProjectResource\n+    implements JaxRsComponent\n+{\n+    private ProjectService projectService;\n+\n+    private SyncContentService syncContentService;\n+\n+    private TaskService taskService;\n+\n+    @POST\n+    @Path(\"syncAll\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ef8cc2c9fb07d2ebd41cf18c28b8bea94d3c9aa"}, "originalPosition": 37}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 941, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}