{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4NDM4NTQ5", "number": 1690, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQxNDozNDo1OVrOEDK7pA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMzoyMDoxN1rOEDcXEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNzYwMjkyOnYy", "diffSide": "RIGHT", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/OCFLPersistentStorageUtils.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQxNDozNDo1OVrOGgEBdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQxNjoxODozNFrOGgEeMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MzUyNQ==", "bodyText": "I believe this can remain private.", "url": "https://github.com/fcrepo/fcrepo/pull/1690#discussion_r436273525", "createdAt": "2020-06-06T14:34:59Z", "author": {"login": "awoods"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/OCFLPersistentStorageUtils.java", "diffHunk": "@@ -81,7 +82,7 @@ private OCFLPersistentStorageUtils() {\n      * The directory within an OCFL Object's content directory that contains\n      * information managed by Fedora.\n      */\n-    private static final String INTERNAL_FEDORA_DIRECTORY = \".fcrepo\";\n+    public static final String INTERNAL_FEDORA_DIRECTORY = \".fcrepo\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "604328fa45e26d1c478547f9f0bcdf4d232656c8"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI4MDg4MA==", "bodyText": "Ah, I needed it public for an earlier version, but not the final one. Should be fixed now", "url": "https://github.com/fcrepo/fcrepo/pull/1690#discussion_r436280880", "createdAt": "2020-06-06T16:18:34Z", "author": {"login": "bbpennel"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/OCFLPersistentStorageUtils.java", "diffHunk": "@@ -81,7 +82,7 @@ private OCFLPersistentStorageUtils() {\n      * The directory within an OCFL Object's content directory that contains\n      * information managed by Fedora.\n      */\n-    private static final String INTERNAL_FEDORA_DIRECTORY = \".fcrepo\";\n+    public static final String INTERNAL_FEDORA_DIRECTORY = \".fcrepo\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MzUyNQ=="}, "originalCommit": {"oid": "604328fa45e26d1c478547f9f0bcdf4d232656c8"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyMDQxNDE0OnYy", "diffSide": "RIGHT", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/AbstractNonRdfSourcePersister.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMzoxMjo1NVrOGgdPAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNjo0NzoyMVrOGgnG9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY4NjU5Mg==", "bodyText": "No need to change, but this can now be constructed using List.of().", "url": "https://github.com/fcrepo/fcrepo/pull/1690#discussion_r436686592", "createdAt": "2020-06-08T13:12:55Z", "author": {"login": "pwinckles"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/AbstractNonRdfSourcePersister.java", "diffHunk": "@@ -88,12 +88,13 @@ protected void persistNonRDFSource(final ResourceOperation operation,\n         if (forExternalBinary(nonRdfSourceOperation)) {\n             outcome = null;\n         } else {\n+            final var transmissionDigestAlg = objectSession.getObjectDigestAlgorithm();\n             final var providedDigests = nonRdfSourceOperation.getContentDigests();\n             // Wrap binary stream in digest computing wrapper, requesting\n             final var multiDigestWrapper = new MultiDigestInputStreamWrapper(\n                     nonRdfSourceOperation.getContentStream(),\n                     providedDigests,\n-                    Arrays.asList(objectSession.getObjectDigestAlgorithm()));\n+                    Arrays.asList(transmissionDigestAlg));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5764c998a29ef13f82b051180b4c3ae6b4b79613"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg0ODM3Mg==", "bodyText": "Sure, I'll swap it", "url": "https://github.com/fcrepo/fcrepo/pull/1690#discussion_r436848372", "createdAt": "2020-06-08T16:47:21Z", "author": {"login": "bbpennel"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/AbstractNonRdfSourcePersister.java", "diffHunk": "@@ -88,12 +88,13 @@ protected void persistNonRDFSource(final ResourceOperation operation,\n         if (forExternalBinary(nonRdfSourceOperation)) {\n             outcome = null;\n         } else {\n+            final var transmissionDigestAlg = objectSession.getObjectDigestAlgorithm();\n             final var providedDigests = nonRdfSourceOperation.getContentDigests();\n             // Wrap binary stream in digest computing wrapper, requesting\n             final var multiDigestWrapper = new MultiDigestInputStreamWrapper(\n                     nonRdfSourceOperation.getContentStream(),\n                     providedDigests,\n-                    Arrays.asList(objectSession.getObjectDigestAlgorithm()));\n+                    Arrays.asList(transmissionDigestAlg));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY4NjU5Mg=="}, "originalCommit": {"oid": "5764c998a29ef13f82b051180b4c3ae6b4b79613"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyMDQ1ODQyOnYy", "diffSide": "RIGHT", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DefaultOCFLObjectSession.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMzoyMDoxN1rOGgdpsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNjo0Nzo0NlrOGgnIIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY5MzQyNw==", "bodyText": "I don't think you need to walk the staged files, unless you want to. You should just be able to add the entire staging directory, and then iterate over your map of digests, calling addFileFixity for each.", "url": "https://github.com/fcrepo/fcrepo/pull/1690#discussion_r436693427", "createdAt": "2020-06-08T13:20:17Z", "author": {"login": "pwinckles"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DefaultOCFLObjectSession.java", "diffHunk": "@@ -449,6 +457,53 @@ private String commitUpdates(final CommitOption commitOption) {\n         }\n     }\n \n+    private Consumer<OcflObjectUpdater> constructCommitUpdater(final boolean updatingObject) {\n+        final DIGEST_ALGORITHM fcrepoDigestAlg = getObjectDigestAlgorithm();\n+        final DigestAlgorithm ocflDigestAlg = translateFedoraDigestToOcfl(fcrepoDigestAlg);\n+        final OcflOption[] ocflOptions;\n+        if (updatingObject) {\n+            ocflOptions = new OcflOption[] { MOVE_SOURCE, OVERWRITE };\n+        } else {\n+            ocflOptions = new OcflOption[] { MOVE_SOURCE };\n+        }\n+\n+\n+        return updater -> {\n+            if (updatingObject) {\n+                deletePaths.forEach(updater::removeFile);\n+            }\n+            if (isStagingEmpty()) {\n+                return;\n+            }\n+\n+            try {\n+                Files.walk(stagingPath)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5764c998a29ef13f82b051180b4c3ae6b4b79613"}, "originalPosition": 143}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg0ODY3NQ==", "bodyText": "Good catch, I was still in the mindset of needing to walk files, but there's really no need at this point. I've switched to your suggestion", "url": "https://github.com/fcrepo/fcrepo/pull/1690#discussion_r436848675", "createdAt": "2020-06-08T16:47:46Z", "author": {"login": "bbpennel"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DefaultOCFLObjectSession.java", "diffHunk": "@@ -449,6 +457,53 @@ private String commitUpdates(final CommitOption commitOption) {\n         }\n     }\n \n+    private Consumer<OcflObjectUpdater> constructCommitUpdater(final boolean updatingObject) {\n+        final DIGEST_ALGORITHM fcrepoDigestAlg = getObjectDigestAlgorithm();\n+        final DigestAlgorithm ocflDigestAlg = translateFedoraDigestToOcfl(fcrepoDigestAlg);\n+        final OcflOption[] ocflOptions;\n+        if (updatingObject) {\n+            ocflOptions = new OcflOption[] { MOVE_SOURCE, OVERWRITE };\n+        } else {\n+            ocflOptions = new OcflOption[] { MOVE_SOURCE };\n+        }\n+\n+\n+        return updater -> {\n+            if (updatingObject) {\n+                deletePaths.forEach(updater::removeFile);\n+            }\n+            if (isStagingEmpty()) {\n+                return;\n+            }\n+\n+            try {\n+                Files.walk(stagingPath)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY5MzQyNw=="}, "originalCommit": {"oid": "5764c998a29ef13f82b051180b4c3ae6b4b79613"}, "originalPosition": 143}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1841, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}