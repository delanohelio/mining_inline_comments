{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2NzA2ODkw", "number": 1703, "title": "Moves the search index into its own table.", "bodyText": "Adds support for searching by modified and created dates.\nAdds support for customizing the output fields of your search.\nBy default all fields returned.\nResolves:\nhttps://jira.lyrasis.org/browse/FCREPO-3349\nhttps://jira.lyrasis.org/browse/FCREPO-3353\nhttps://jira.lyrasis.org/browse/FCREPO-3354\n\nOther Relevant Links (Mailing list discussion, related pull requests, etc.)\n\nWhat does this Pull Request do?\n\nMoves the search index into its own table.\nAdds support for searching by modified and created dates.\nAdds support for customizing the output fields of your search.\nThe index is kept up to date now via the internal event bus.\nIntegration tests cover the following features:\n\nsearch by resources with modified or created date <, >, >=, or <= . Ensure that \"before\", \"after\" and \"before and after\" (ie between) are supported.\ncompound queries are now supported: ie your can specify multiple conditions.\n\n\n\nHow should this be tested?\nCreate a bunch of resources\nfor i in `seq 1 50`; do curl -X PUT -u fedoraAdmin:fedoraAdmin  \"http://localhost:8080/rest/resource-$i\"; done;\n\nSee that the modified and created dates are returned by default (jq makes the json pretty):\ncurl  -u fedoraAdmin:fedoraAdmin \"http://localhost:8080/rest/fcr:search\" | jq \n\nReturn all available fields in results: (should be identical to the previous results )\ncurl -u fedoraAdmin:fedoraAdmin \"http://localhost:8080/rest/fcr:search?fields=*\" | jq\n\nReturn only the fedora_id and modified in results:\ncurl -u fedoraAdmin:fedoraAdmin \"http://localhost:8080/rest/fcr:search?fields=fedora_id,modified\" | jq\n\nReturn results matching fedora_id and created after using YYYY-mm-dd format. Should return one result\ncurl -u fedoraAdmin:fedoraAdmin \"http://localhost:8080/rest/fcr:search?condition=fedora_id%3Dresource-1&condition=created%3E2020-06-18&fields=fedora_id,modified\" | jq\n\nReturn results matching fedora_id and created before using YYYY-mm-dd format. Should return no  results.\ncurl -u fedoraAdmin:fedoraAdmin \"http://localhost:8080/rest/fcr:search?condition=fedora_id%3Dresource-1&condition=created%3C2020-06-18&fields=fedora_id,modified\" | jq\n\nReturn results matching fedora_id and modified after using ISO date format. Should return one result\ncurl -u fedoraAdmin:fedoraAdmin \"http://localhost:8080/rest/fcr:search?condition=fedora_id%3Dresource-1&condition=modified%3E2020-06-18T19:04:10.802Z&fields=fedora_id,modified\" | jq\n\nInterested parties\nTag (@ mention) interested parties or, if unsure, @fcrepo4/committers", "createdAt": "2020-06-18T19:03:03Z", "url": "https://github.com/fcrepo/fcrepo/pull/1703", "merged": true, "mergeCommit": {"oid": "a28b66d0e2723666241f927fe63cdfe86315f5ee"}, "closed": true, "closedAt": "2020-07-02T19:33:55Z", "author": {"login": "dbernstein"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcskBa4gFqTQzMzU3MDczMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcxDqqSgFqTQ0MTk1MjkwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNTcwNzMx", "url": "https://github.com/fcrepo/fcrepo/pull/1703#pullrequestreview-433570731", "createdAt": "2020-06-18T19:09:26Z", "commit": {"oid": "e96979a32bdfaec42dd7dd0b38d6048d35cfe3cf"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxOTowOToyN1rOGl8m3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxOTo1NjowMlrOGl-Ikg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ0MzQ4Nw==", "bodyText": "The first 2 clauses could be expressed as StringUtils.isBlank(fields)", "url": "https://github.com/fcrepo/fcrepo/pull/1703#discussion_r442443487", "createdAt": "2020-06-18T19:09:27Z", "author": {"login": "pwinckles"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraSearch.java", "diffHunk": "@@ -87,15 +89,30 @@ public Response doSearch(@QueryParam(value = \"condition\") final List<String> con\n                 final var parsedCondition = parse(condition, identifierConverter());\n                 conditionList.add(parsedCondition);\n             }\n-            final var params = new SearchParameters(conditionList, maxResults, offset);\n+\n+            List<Condition.Field> parsedFields = null;\n+            if (fields == null || fields.trim().length() == 0 || fields.equals(\"*\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e96979a32bdfaec42dd7dd0b38d6048d35cfe3cf"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ1MzMxOQ==", "bodyText": "I don't think this needs a transaction, does it?", "url": "https://github.com/fcrepo/fcrepo/pull/1703#discussion_r442453319", "createdAt": "2020-06-18T19:29:11Z", "author": {"login": "pwinckles"}, "path": "fcrepo-search-impl/src/main/java/org/fcrepo/search/impl/DbSearchIndexImpl.java", "diffHunk": "@@ -0,0 +1,241 @@\n+/*\n+ * Licensed to DuraSpace under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional information\n+ * regarding copyright ownership.\n+ *\n+ * DuraSpace licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except in\n+ * compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.fcrepo.search.impl;\n+\n+import org.fcrepo.kernel.api.exception.RepositoryRuntimeException;\n+import org.fcrepo.kernel.api.identifiers.FedoraId;\n+import org.fcrepo.search.api.Condition;\n+import org.fcrepo.search.api.InvalidQueryException;\n+import org.fcrepo.search.api.PaginationInfo;\n+import org.fcrepo.search.api.SearchIndex;\n+import org.fcrepo.search.api.SearchParameters;\n+import org.fcrepo.search.api.SearchResult;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.core.io.DefaultResourceLoader;\n+import org.springframework.jdbc.core.RowMapper;\n+import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;\n+import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;\n+import org.springframework.jdbc.datasource.init.DatabasePopulatorUtils;\n+import org.springframework.jdbc.datasource.init.ResourceDatabasePopulator;\n+import org.springframework.stereotype.Component;\n+import org.springframework.transaction.PlatformTransactionManager;\n+import org.springframework.transaction.support.TransactionCallback;\n+import org.springframework.transaction.support.TransactionTemplate;\n+\n+import javax.annotation.PostConstruct;\n+import javax.inject.Inject;\n+import javax.sql.DataSource;\n+import java.sql.Date;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.sql.Timestamp;\n+import java.sql.Types;\n+import java.time.Instant;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+\n+import static java.time.format.DateTimeFormatter.ISO_INSTANT;\n+\n+\n+/**\n+ * An implementation of the {@link SearchIndex}\n+ *\n+ * @author dbernstein\n+ */\n+@Component\n+public class DbSearchIndexImpl implements SearchIndex {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(DbSearchIndexImpl.class);\n+    private static final String SIMPLE_SEARCH_TABLE = \"simple_search\";\n+    private static final String DDL = \"sql/default-search-index.sql\";\n+\n+    @Inject\n+    private DataSource dataSource;\n+\n+    private NamedParameterJdbcTemplate jdbcTemplate;\n+\n+    @Inject\n+    private PlatformTransactionManager platformTransactionManager;\n+\n+    /**\n+     * Setup database table and connection\n+     */\n+    @PostConstruct\n+    public void setup() {\n+        LOGGER.info(\"Applying ddl: {}\", DDL);\n+        DatabasePopulatorUtils.execute(\n+                new ResourceDatabasePopulator(new DefaultResourceLoader().getResource(\"classpath:\" + DDL)),\n+                this.dataSource);\n+        this.jdbcTemplate = getNamedParameterJdbcTemplate();\n+    }\n+\n+    private NamedParameterJdbcTemplate getNamedParameterJdbcTemplate() {\n+        return new NamedParameterJdbcTemplate(this.dataSource);\n+    }\n+\n+    @Override\n+    public SearchResult doSearch(final SearchParameters parameters) throws InvalidQueryException {\n+        //translate parameters into a SQL query\n+        var paramCount = 1;\n+\n+        final MapSqlParameterSource parameterSource = new MapSqlParameterSource();\n+        final var whereClauses = new ArrayList<String>();\n+        for (Condition condition : parameters.getConditions()) {\n+            final var field = condition.getField();\n+            final var operation = condition.getOperator();\n+            var object = condition.getObject();\n+            if (field.equals(Condition.Field.FEDORA_ID) &&\n+                    condition.getOperator().equals(Condition.Operator.EQ)) {\n+                if (!object.equals(\"*\")) {\n+                    if (object.contains(\"*\")) {\n+                        object = object.replace(\"*\", \"%\");\n+                        whereClauses.add(Condition.Field.FEDORA_ID + \" like '\" + object + \"'\");\n+                    } else {\n+                        whereClauses.add(Condition.Field.FEDORA_ID + \" = '\" + object + \"'\");\n+                    }\n+                }\n+            } else if (field.equals(Condition.Field.CREATED) || field.equals(Condition.Field.MODIFIED)) {\n+                //parse date\n+                try {\n+                    final var instant = InstantParser.parse(object);\n+                    final var paramName = \"param\" + paramCount++;\n+                    whereClauses.add(field + \" \" + operation.getStringValue() +\n+                            \" :\" + paramName);\n+                    parameterSource.addValue(paramName, new Date(instant.toEpochMilli()), Types.TIMESTAMP);\n+                } catch (Exception ex) {\n+                    throw new InvalidQueryException(ex.getMessage());\n+                }\n+            } else {\n+                throw new InvalidQueryException(\"Condition not supported: \\\"\" + condition + \"\\\"\");\n+            }\n+        }\n+\n+        final var fields = parameters.getFields().stream().map(x -> x.toString()).collect(Collectors.toList());\n+        final var sql =\n+                new StringBuilder(\"SELECT \" + String.join(\",\", fields) + \" FROM \" + SIMPLE_SEARCH_TABLE);\n+\n+        if (!whereClauses.isEmpty()) {\n+            sql.append(\" WHERE \");\n+            for (var it = whereClauses.iterator(); it.hasNext(); ) {\n+                sql.append(it.next());\n+                if (it.hasNext()) {\n+                    sql.append(\" AND \");\n+                }\n+            }\n+        }\n+        sql.append(\" ORDER BY \" + Condition.Field.FEDORA_ID);\n+        sql.append(\" LIMIT :limit OFFSET :offset\");\n+        parameterSource.addValue(\"limit\", parameters.getMaxResults());\n+        parameterSource.addValue(\"offset\", parameters.getOffset());\n+\n+        final var rowMapper = new RowMapper<Map<String, Object>>() {\n+            @Override\n+            public Map<String, Object> mapRow(final ResultSet rs, final int rowNum) throws SQLException {\n+                final Map<String, Object> map = new HashMap<>();\n+                for (String f : fields) {\n+                    var value = rs.getObject(f);\n+                    if (value instanceof Timestamp) {\n+                        value = ISO_INSTANT.format(Instant.ofEpochMilli(((Timestamp) value).getTime()));\n+                    }\n+                    map.put(f, value);\n+                }\n+                return map;\n+            }\n+        };\n+\n+        final List<Map<String, Object>> items = jdbcTemplate.query(sql.toString(), parameterSource, rowMapper);\n+        final var pagination = new PaginationInfo(parameters.getMaxResults(), parameters.getOffset());\n+        LOGGER.debug(\"Search query with parameters: {} - {}\", sql, parameters);\n+        return new SearchResult(items, pagination);\n+    }\n+\n+    @Override\n+    public void addUpdateIndex(final FedoraId fedoraId, final Instant created, final Instant modified,\n+                               final Long size, final String mimetype) {\n+        final var fullId = fedoraId.getFullId();\n+        final var selectParams = new MapSqlParameterSource();\n+        selectParams.addValue(\"fedora_id\", fullId);\n+        final var result = jdbcTemplate.queryForList(\"SELECT fedora_id FROM \" + SIMPLE_SEARCH_TABLE +\n+                        \" WHERE fedora_id = :fedora_id\",\n+                selectParams);\n+\n+        final var txId = UUID.randomUUID().toString();\n+        executeInDbTransaction(txId, status -> {\n+            try {\n+\n+                final var params = new MapSqlParameterSource();\n+                params.addValue(\"fedora_id\", fullId);\n+                params.addValue(\"modified\", modified);\n+\n+                if (result.size() > 0) {\n+                    //update\n+                    final var sql = \"UPDATE \" + SIMPLE_SEARCH_TABLE +\n+                            \" SET modified=:modified  WHERE fedora_id = :fedora_id;\";\n+                    jdbcTemplate.update(sql, params);\n+                } else {\n+                    params.addValue(\"created\", created);\n+\n+                    final var sql = \"INSERT INTO \" + SIMPLE_SEARCH_TABLE + \" (fedora_id, modified, created) \" +\n+                            \"VALUES(:fedora_id, :modified, :created)\";\n+                    jdbcTemplate.update(sql, params);\n+                }\n+                return null;\n+            } catch (Exception e) {\n+                status.setRollbackOnly();\n+                throw new RepositoryRuntimeException(\"Failed add/updated the search index for : \" + fullId, e);\n+            }\n+        });\n+    }\n+\n+    @Override\n+    public void removeFromIndex(final FedoraId fedoraId) {\n+        final var txId = UUID.randomUUID().toString();\n+        executeInDbTransaction(txId, status -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e96979a32bdfaec42dd7dd0b38d6048d35cfe3cf"}, "originalPosition": 213}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ1NDQzNA==", "bodyText": "This seems more like a debug level log", "url": "https://github.com/fcrepo/fcrepo/pull/1703#discussion_r442454434", "createdAt": "2020-06-18T19:31:17Z", "author": {"login": "pwinckles"}, "path": "fcrepo-search-impl/src/main/java/org/fcrepo/search/impl/SearchIndexUpdater.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * Licensed to DuraSpace under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional information\n+ * regarding copyright ownership.\n+ *\n+ * DuraSpace licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except in\n+ * compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+\n+package org.fcrepo.search.impl;\n+\n+import com.google.common.collect.Sets;\n+import com.google.common.eventbus.EventBus;\n+import com.google.common.eventbus.Subscribe;\n+import org.fcrepo.kernel.api.models.ResourceFactory;\n+import org.fcrepo.kernel.api.observer.Event;\n+import org.fcrepo.kernel.api.observer.EventType;\n+import org.fcrepo.persistence.api.PersistentStorageSessionManager;\n+import org.fcrepo.persistence.api.exceptions.PersistentStorageException;\n+import org.fcrepo.search.api.SearchIndex;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import javax.annotation.PostConstruct;\n+import javax.annotation.PreDestroy;\n+import javax.inject.Inject;\n+import java.util.Set;\n+\n+import static org.fcrepo.kernel.api.observer.EventType.RESOURCE_CREATION;\n+import static org.fcrepo.kernel.api.observer.EventType.RESOURCE_DELETION;\n+import static org.fcrepo.kernel.api.observer.EventType.RESOURCE_MODIFICATION;\n+\n+/**\n+ * This class listens to events from the event bus and updates the search\n+ * index accordingly.\n+ *\n+ * @author dbernstein\n+ */\n+@Component\n+public class SearchIndexUpdater {\n+\n+    @Inject\n+    private EventBus eventBus;\n+\n+    @Inject\n+    private SearchIndex searchIndex;\n+\n+    @Inject\n+    private ResourceFactory resourceFactory;\n+\n+    @Inject\n+    private PersistentStorageSessionManager persistentStorageSessionManager;\n+\n+    private static Logger LOGGER = LoggerFactory.getLogger(SearchIndexUpdater.class);\n+    private static final Set<EventType> HANDLED_TYPES = Sets.newHashSet(RESOURCE_CREATION, RESOURCE_MODIFICATION,\n+            RESOURCE_DELETION);\n+\n+    @Subscribe\n+    public void onEvent(final Event event) {\n+        LOGGER.info(\"event={}\", event);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e96979a32bdfaec42dd7dd0b38d6048d35cfe3cf"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ1ODU5NQ==", "bodyText": "This should probably be annotated with @AllowConcurrentEvents", "url": "https://github.com/fcrepo/fcrepo/pull/1703#discussion_r442458595", "createdAt": "2020-06-18T19:38:14Z", "author": {"login": "pwinckles"}, "path": "fcrepo-search-impl/src/main/java/org/fcrepo/search/impl/SearchIndexUpdater.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * Licensed to DuraSpace under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional information\n+ * regarding copyright ownership.\n+ *\n+ * DuraSpace licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except in\n+ * compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+\n+package org.fcrepo.search.impl;\n+\n+import com.google.common.collect.Sets;\n+import com.google.common.eventbus.EventBus;\n+import com.google.common.eventbus.Subscribe;\n+import org.fcrepo.kernel.api.models.ResourceFactory;\n+import org.fcrepo.kernel.api.observer.Event;\n+import org.fcrepo.kernel.api.observer.EventType;\n+import org.fcrepo.persistence.api.PersistentStorageSessionManager;\n+import org.fcrepo.persistence.api.exceptions.PersistentStorageException;\n+import org.fcrepo.search.api.SearchIndex;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import javax.annotation.PostConstruct;\n+import javax.annotation.PreDestroy;\n+import javax.inject.Inject;\n+import java.util.Set;\n+\n+import static org.fcrepo.kernel.api.observer.EventType.RESOURCE_CREATION;\n+import static org.fcrepo.kernel.api.observer.EventType.RESOURCE_DELETION;\n+import static org.fcrepo.kernel.api.observer.EventType.RESOURCE_MODIFICATION;\n+\n+/**\n+ * This class listens to events from the event bus and updates the search\n+ * index accordingly.\n+ *\n+ * @author dbernstein\n+ */\n+@Component\n+public class SearchIndexUpdater {\n+\n+    @Inject\n+    private EventBus eventBus;\n+\n+    @Inject\n+    private SearchIndex searchIndex;\n+\n+    @Inject\n+    private ResourceFactory resourceFactory;\n+\n+    @Inject\n+    private PersistentStorageSessionManager persistentStorageSessionManager;\n+\n+    private static Logger LOGGER = LoggerFactory.getLogger(SearchIndexUpdater.class);\n+    private static final Set<EventType> HANDLED_TYPES = Sets.newHashSet(RESOURCE_CREATION, RESOURCE_MODIFICATION,\n+            RESOURCE_DELETION);\n+\n+    @Subscribe\n+    public void onEvent(final Event event) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e96979a32bdfaec42dd7dd0b38d6048d35cfe3cf"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ2MTA2Nw==", "bodyText": "I don't think this class needs this constructor, does it?", "url": "https://github.com/fcrepo/fcrepo/pull/1703#discussion_r442461067", "createdAt": "2020-06-18T19:41:35Z", "author": {"login": "pwinckles"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/IndexBuilderImpl.java", "diffHunk": "@@ -63,12 +63,18 @@\n     @Inject\n     private ContainmentIndex containmentIndex;\n \n+    @Inject\n+    private SearchIndex searchIndex;\n+\n     @Inject\n     private TransactionManager transactionManager;\n \n     @Inject\n     private OcflRepository ocflRepository;\n \n+    public IndexBuilderImpl() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e96979a32bdfaec42dd7dd0b38d6048d35cfe3cf"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ2MjIxMg==", "bodyText": "Does this module have access to the ResourceHeaders interface? If so, it might be nice to have an api that just took FedoraId and ResourceHeaders rather than having to pass each value individually.", "url": "https://github.com/fcrepo/fcrepo/pull/1703#discussion_r442462212", "createdAt": "2020-06-18T19:43:58Z", "author": {"login": "pwinckles"}, "path": "fcrepo-search-api/src/main/java/org/fcrepo/search/api/SearchIndex.java", "diffHunk": "@@ -17,11 +17,31 @@\n  */\n package org.fcrepo.search.api;\n \n+import org.fcrepo.kernel.api.identifiers.FedoraId;\n+\n+import java.time.Instant;\n+\n /**\n- * An interface defining search operations\n+ * An interface defining search index management operations\n+ *\n  * @author dbernstein\n  */\n-public interface SearchService {\n+public interface SearchIndex {\n+\n+    /**\n+     * @param fedoraId\n+     * @param created\n+     * @param modified\n+     * @param size\n+     * @param mimetype\n+     */\n+    void addUpdateIndex(final FedoraId fedoraId, final Instant created, final Instant modified,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e96979a32bdfaec42dd7dd0b38d6048d35cfe3cf"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ2MjcwMQ==", "bodyText": "Should probably update the toString to include the additional fields.", "url": "https://github.com/fcrepo/fcrepo/pull/1703#discussion_r442462701", "createdAt": "2020-06-18T19:44:53Z", "author": {"login": "pwinckles"}, "path": "fcrepo-search-api/src/main/java/org/fcrepo/search/api/SearchParameters.java", "diffHunk": "@@ -74,6 +78,14 @@ public int getMaxResults() {\n         return conditions;\n     }\n \n+    /**\n+     * Returns the list of fields to display in the results.\n+     * @return\n+     */\n+    public List<Condition.Field> getFields() {\n+        return fields;\n+    }\n+\n     @Override\n     public String toString() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e96979a32bdfaec42dd7dd0b38d6048d35cfe3cf"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ2MzQ1NQ==", "bodyText": "Do we need to take any sql injection precautions here?", "url": "https://github.com/fcrepo/fcrepo/pull/1703#discussion_r442463455", "createdAt": "2020-06-18T19:46:16Z", "author": {"login": "pwinckles"}, "path": "fcrepo-search-impl/src/main/java/org/fcrepo/search/impl/DbSearchIndexImpl.java", "diffHunk": "@@ -0,0 +1,241 @@\n+/*\n+ * Licensed to DuraSpace under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional information\n+ * regarding copyright ownership.\n+ *\n+ * DuraSpace licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except in\n+ * compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.fcrepo.search.impl;\n+\n+import org.fcrepo.kernel.api.exception.RepositoryRuntimeException;\n+import org.fcrepo.kernel.api.identifiers.FedoraId;\n+import org.fcrepo.search.api.Condition;\n+import org.fcrepo.search.api.InvalidQueryException;\n+import org.fcrepo.search.api.PaginationInfo;\n+import org.fcrepo.search.api.SearchIndex;\n+import org.fcrepo.search.api.SearchParameters;\n+import org.fcrepo.search.api.SearchResult;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.core.io.DefaultResourceLoader;\n+import org.springframework.jdbc.core.RowMapper;\n+import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;\n+import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;\n+import org.springframework.jdbc.datasource.init.DatabasePopulatorUtils;\n+import org.springframework.jdbc.datasource.init.ResourceDatabasePopulator;\n+import org.springframework.stereotype.Component;\n+import org.springframework.transaction.PlatformTransactionManager;\n+import org.springframework.transaction.support.TransactionCallback;\n+import org.springframework.transaction.support.TransactionTemplate;\n+\n+import javax.annotation.PostConstruct;\n+import javax.inject.Inject;\n+import javax.sql.DataSource;\n+import java.sql.Date;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.sql.Timestamp;\n+import java.sql.Types;\n+import java.time.Instant;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+\n+import static java.time.format.DateTimeFormatter.ISO_INSTANT;\n+\n+\n+/**\n+ * An implementation of the {@link SearchIndex}\n+ *\n+ * @author dbernstein\n+ */\n+@Component\n+public class DbSearchIndexImpl implements SearchIndex {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(DbSearchIndexImpl.class);\n+    private static final String SIMPLE_SEARCH_TABLE = \"simple_search\";\n+    private static final String DDL = \"sql/default-search-index.sql\";\n+\n+    @Inject\n+    private DataSource dataSource;\n+\n+    private NamedParameterJdbcTemplate jdbcTemplate;\n+\n+    @Inject\n+    private PlatformTransactionManager platformTransactionManager;\n+\n+    /**\n+     * Setup database table and connection\n+     */\n+    @PostConstruct\n+    public void setup() {\n+        LOGGER.info(\"Applying ddl: {}\", DDL);\n+        DatabasePopulatorUtils.execute(\n+                new ResourceDatabasePopulator(new DefaultResourceLoader().getResource(\"classpath:\" + DDL)),\n+                this.dataSource);\n+        this.jdbcTemplate = getNamedParameterJdbcTemplate();\n+    }\n+\n+    private NamedParameterJdbcTemplate getNamedParameterJdbcTemplate() {\n+        return new NamedParameterJdbcTemplate(this.dataSource);\n+    }\n+\n+    @Override\n+    public SearchResult doSearch(final SearchParameters parameters) throws InvalidQueryException {\n+        //translate parameters into a SQL query\n+        var paramCount = 1;\n+\n+        final MapSqlParameterSource parameterSource = new MapSqlParameterSource();\n+        final var whereClauses = new ArrayList<String>();\n+        for (Condition condition : parameters.getConditions()) {\n+            final var field = condition.getField();\n+            final var operation = condition.getOperator();\n+            var object = condition.getObject();\n+            if (field.equals(Condition.Field.FEDORA_ID) &&\n+                    condition.getOperator().equals(Condition.Operator.EQ)) {\n+                if (!object.equals(\"*\")) {\n+                    if (object.contains(\"*\")) {\n+                        object = object.replace(\"*\", \"%\");\n+                        whereClauses.add(Condition.Field.FEDORA_ID + \" like '\" + object + \"'\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e96979a32bdfaec42dd7dd0b38d6048d35cfe3cf"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ2NjAzNA==", "bodyText": "Small simplification:\nfinal String sql;\n\nif (result.size() > 0) {\n    sql = \"...\";\n} else {\n    params.add...;\n    sql = \"...\";\n}\n\njdbcTemplate.update(sql, params);", "url": "https://github.com/fcrepo/fcrepo/pull/1703#discussion_r442466034", "createdAt": "2020-06-18T19:51:24Z", "author": {"login": "pwinckles"}, "path": "fcrepo-search-impl/src/main/java/org/fcrepo/search/impl/DbSearchIndexImpl.java", "diffHunk": "@@ -0,0 +1,241 @@\n+/*\n+ * Licensed to DuraSpace under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional information\n+ * regarding copyright ownership.\n+ *\n+ * DuraSpace licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except in\n+ * compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.fcrepo.search.impl;\n+\n+import org.fcrepo.kernel.api.exception.RepositoryRuntimeException;\n+import org.fcrepo.kernel.api.identifiers.FedoraId;\n+import org.fcrepo.search.api.Condition;\n+import org.fcrepo.search.api.InvalidQueryException;\n+import org.fcrepo.search.api.PaginationInfo;\n+import org.fcrepo.search.api.SearchIndex;\n+import org.fcrepo.search.api.SearchParameters;\n+import org.fcrepo.search.api.SearchResult;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.core.io.DefaultResourceLoader;\n+import org.springframework.jdbc.core.RowMapper;\n+import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;\n+import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;\n+import org.springframework.jdbc.datasource.init.DatabasePopulatorUtils;\n+import org.springframework.jdbc.datasource.init.ResourceDatabasePopulator;\n+import org.springframework.stereotype.Component;\n+import org.springframework.transaction.PlatformTransactionManager;\n+import org.springframework.transaction.support.TransactionCallback;\n+import org.springframework.transaction.support.TransactionTemplate;\n+\n+import javax.annotation.PostConstruct;\n+import javax.inject.Inject;\n+import javax.sql.DataSource;\n+import java.sql.Date;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.sql.Timestamp;\n+import java.sql.Types;\n+import java.time.Instant;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+\n+import static java.time.format.DateTimeFormatter.ISO_INSTANT;\n+\n+\n+/**\n+ * An implementation of the {@link SearchIndex}\n+ *\n+ * @author dbernstein\n+ */\n+@Component\n+public class DbSearchIndexImpl implements SearchIndex {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(DbSearchIndexImpl.class);\n+    private static final String SIMPLE_SEARCH_TABLE = \"simple_search\";\n+    private static final String DDL = \"sql/default-search-index.sql\";\n+\n+    @Inject\n+    private DataSource dataSource;\n+\n+    private NamedParameterJdbcTemplate jdbcTemplate;\n+\n+    @Inject\n+    private PlatformTransactionManager platformTransactionManager;\n+\n+    /**\n+     * Setup database table and connection\n+     */\n+    @PostConstruct\n+    public void setup() {\n+        LOGGER.info(\"Applying ddl: {}\", DDL);\n+        DatabasePopulatorUtils.execute(\n+                new ResourceDatabasePopulator(new DefaultResourceLoader().getResource(\"classpath:\" + DDL)),\n+                this.dataSource);\n+        this.jdbcTemplate = getNamedParameterJdbcTemplate();\n+    }\n+\n+    private NamedParameterJdbcTemplate getNamedParameterJdbcTemplate() {\n+        return new NamedParameterJdbcTemplate(this.dataSource);\n+    }\n+\n+    @Override\n+    public SearchResult doSearch(final SearchParameters parameters) throws InvalidQueryException {\n+        //translate parameters into a SQL query\n+        var paramCount = 1;\n+\n+        final MapSqlParameterSource parameterSource = new MapSqlParameterSource();\n+        final var whereClauses = new ArrayList<String>();\n+        for (Condition condition : parameters.getConditions()) {\n+            final var field = condition.getField();\n+            final var operation = condition.getOperator();\n+            var object = condition.getObject();\n+            if (field.equals(Condition.Field.FEDORA_ID) &&\n+                    condition.getOperator().equals(Condition.Operator.EQ)) {\n+                if (!object.equals(\"*\")) {\n+                    if (object.contains(\"*\")) {\n+                        object = object.replace(\"*\", \"%\");\n+                        whereClauses.add(Condition.Field.FEDORA_ID + \" like '\" + object + \"'\");\n+                    } else {\n+                        whereClauses.add(Condition.Field.FEDORA_ID + \" = '\" + object + \"'\");\n+                    }\n+                }\n+            } else if (field.equals(Condition.Field.CREATED) || field.equals(Condition.Field.MODIFIED)) {\n+                //parse date\n+                try {\n+                    final var instant = InstantParser.parse(object);\n+                    final var paramName = \"param\" + paramCount++;\n+                    whereClauses.add(field + \" \" + operation.getStringValue() +\n+                            \" :\" + paramName);\n+                    parameterSource.addValue(paramName, new Date(instant.toEpochMilli()), Types.TIMESTAMP);\n+                } catch (Exception ex) {\n+                    throw new InvalidQueryException(ex.getMessage());\n+                }\n+            } else {\n+                throw new InvalidQueryException(\"Condition not supported: \\\"\" + condition + \"\\\"\");\n+            }\n+        }\n+\n+        final var fields = parameters.getFields().stream().map(x -> x.toString()).collect(Collectors.toList());\n+        final var sql =\n+                new StringBuilder(\"SELECT \" + String.join(\",\", fields) + \" FROM \" + SIMPLE_SEARCH_TABLE);\n+\n+        if (!whereClauses.isEmpty()) {\n+            sql.append(\" WHERE \");\n+            for (var it = whereClauses.iterator(); it.hasNext(); ) {\n+                sql.append(it.next());\n+                if (it.hasNext()) {\n+                    sql.append(\" AND \");\n+                }\n+            }\n+        }\n+        sql.append(\" ORDER BY \" + Condition.Field.FEDORA_ID);\n+        sql.append(\" LIMIT :limit OFFSET :offset\");\n+        parameterSource.addValue(\"limit\", parameters.getMaxResults());\n+        parameterSource.addValue(\"offset\", parameters.getOffset());\n+\n+        final var rowMapper = new RowMapper<Map<String, Object>>() {\n+            @Override\n+            public Map<String, Object> mapRow(final ResultSet rs, final int rowNum) throws SQLException {\n+                final Map<String, Object> map = new HashMap<>();\n+                for (String f : fields) {\n+                    var value = rs.getObject(f);\n+                    if (value instanceof Timestamp) {\n+                        value = ISO_INSTANT.format(Instant.ofEpochMilli(((Timestamp) value).getTime()));\n+                    }\n+                    map.put(f, value);\n+                }\n+                return map;\n+            }\n+        };\n+\n+        final List<Map<String, Object>> items = jdbcTemplate.query(sql.toString(), parameterSource, rowMapper);\n+        final var pagination = new PaginationInfo(parameters.getMaxResults(), parameters.getOffset());\n+        LOGGER.debug(\"Search query with parameters: {} - {}\", sql, parameters);\n+        return new SearchResult(items, pagination);\n+    }\n+\n+    @Override\n+    public void addUpdateIndex(final FedoraId fedoraId, final Instant created, final Instant modified,\n+                               final Long size, final String mimetype) {\n+        final var fullId = fedoraId.getFullId();\n+        final var selectParams = new MapSqlParameterSource();\n+        selectParams.addValue(\"fedora_id\", fullId);\n+        final var result = jdbcTemplate.queryForList(\"SELECT fedora_id FROM \" + SIMPLE_SEARCH_TABLE +\n+                        \" WHERE fedora_id = :fedora_id\",\n+                selectParams);\n+\n+        final var txId = UUID.randomUUID().toString();\n+        executeInDbTransaction(txId, status -> {\n+            try {\n+\n+                final var params = new MapSqlParameterSource();\n+                params.addValue(\"fedora_id\", fullId);\n+                params.addValue(\"modified\", modified);\n+\n+                if (result.size() > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e96979a32bdfaec42dd7dd0b38d6048d35cfe3cf"}, "originalPosition": 190}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ2NzEzOA==", "bodyText": "You can also get this with ZoneOffset.UTC", "url": "https://github.com/fcrepo/fcrepo/pull/1703#discussion_r442467138", "createdAt": "2020-06-18T19:53:31Z", "author": {"login": "pwinckles"}, "path": "fcrepo-search-impl/src/main/java/org/fcrepo/search/impl/InstantParser.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Licensed to DuraSpace under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional information\n+ * regarding copyright ownership.\n+ *\n+ * DuraSpace licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except in\n+ * compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.fcrepo.search.impl;\n+\n+import java.time.Instant;\n+import java.time.ZoneId;\n+import java.time.format.DateTimeFormatter;\n+import java.time.format.DateTimeFormatterBuilder;\n+import java.time.temporal.ChronoField;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static java.time.format.DateTimeFormatter.ISO_DATE_TIME;\n+import static java.time.format.DateTimeFormatter.ISO_OFFSET_DATE_TIME;\n+import static java.time.format.DateTimeFormatter.RFC_1123_DATE_TIME;\n+\n+/**\n+ * A utility class for parsing a variety of different date/time formats into an Instant.\n+ *\n+ * @author dbernstein\n+ */\n+public class InstantParser {\n+\n+    private static final List<DateTimeFormatter> VALID_DATE_FORMATS = new ArrayList<>();\n+\n+    static {\n+        VALID_DATE_FORMATS.add(ISO_DATE_TIME);\n+        VALID_DATE_FORMATS.add(ISO_OFFSET_DATE_TIME);\n+        VALID_DATE_FORMATS.add(RFC_1123_DATE_TIME);\n+        final var zoneId = ZoneId.of(\"UTC\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e96979a32bdfaec42dd7dd0b38d6048d35cfe3cf"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ2ODQ5OA==", "bodyText": "I'm not sure there's a guaranteed event type ordering, so if multiple events occur on the same object in the same transaction, the search index could be updated in the wrong order here.", "url": "https://github.com/fcrepo/fcrepo/pull/1703#discussion_r442468498", "createdAt": "2020-06-18T19:56:02Z", "author": {"login": "pwinckles"}, "path": "fcrepo-search-impl/src/main/java/org/fcrepo/search/impl/SearchIndexUpdater.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * Licensed to DuraSpace under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional information\n+ * regarding copyright ownership.\n+ *\n+ * DuraSpace licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except in\n+ * compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+\n+package org.fcrepo.search.impl;\n+\n+import com.google.common.collect.Sets;\n+import com.google.common.eventbus.EventBus;\n+import com.google.common.eventbus.Subscribe;\n+import org.fcrepo.kernel.api.models.ResourceFactory;\n+import org.fcrepo.kernel.api.observer.Event;\n+import org.fcrepo.kernel.api.observer.EventType;\n+import org.fcrepo.persistence.api.PersistentStorageSessionManager;\n+import org.fcrepo.persistence.api.exceptions.PersistentStorageException;\n+import org.fcrepo.search.api.SearchIndex;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import javax.annotation.PostConstruct;\n+import javax.annotation.PreDestroy;\n+import javax.inject.Inject;\n+import java.util.Set;\n+\n+import static org.fcrepo.kernel.api.observer.EventType.RESOURCE_CREATION;\n+import static org.fcrepo.kernel.api.observer.EventType.RESOURCE_DELETION;\n+import static org.fcrepo.kernel.api.observer.EventType.RESOURCE_MODIFICATION;\n+\n+/**\n+ * This class listens to events from the event bus and updates the search\n+ * index accordingly.\n+ *\n+ * @author dbernstein\n+ */\n+@Component\n+public class SearchIndexUpdater {\n+\n+    @Inject\n+    private EventBus eventBus;\n+\n+    @Inject\n+    private SearchIndex searchIndex;\n+\n+    @Inject\n+    private ResourceFactory resourceFactory;\n+\n+    @Inject\n+    private PersistentStorageSessionManager persistentStorageSessionManager;\n+\n+    private static Logger LOGGER = LoggerFactory.getLogger(SearchIndexUpdater.class);\n+    private static final Set<EventType> HANDLED_TYPES = Sets.newHashSet(RESOURCE_CREATION, RESOURCE_MODIFICATION,\n+            RESOURCE_DELETION);\n+\n+    @Subscribe\n+    public void onEvent(final Event event) {\n+        LOGGER.info(\"event={}\", event);\n+        try {\n+            final var types = event.getTypes();\n+            for (EventType et : types) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e96979a32bdfaec42dd7dd0b38d6048d35cfe3cf"}, "originalPosition": 74}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MTE1ODQ1", "url": "https://github.com/fcrepo/fcrepo/pull/1703#pullrequestreview-434115845", "createdAt": "2020-06-19T14:21:23Z", "commit": {"oid": "e96979a32bdfaec42dd7dd0b38d6048d35cfe3cf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNDoyMToyM1rOGmWkWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNDoyMToyM1rOGmWkWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg2ODgyNQ==", "bodyText": "Since the value of DDL doesn't change it could either be removed or moved to a debug level.", "url": "https://github.com/fcrepo/fcrepo/pull/1703#discussion_r442868825", "createdAt": "2020-06-19T14:21:23Z", "author": {"login": "whikloj"}, "path": "fcrepo-search-impl/src/main/java/org/fcrepo/search/impl/DbSearchIndexImpl.java", "diffHunk": "@@ -0,0 +1,241 @@\n+/*\n+ * Licensed to DuraSpace under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional information\n+ * regarding copyright ownership.\n+ *\n+ * DuraSpace licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except in\n+ * compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.fcrepo.search.impl;\n+\n+import org.fcrepo.kernel.api.exception.RepositoryRuntimeException;\n+import org.fcrepo.kernel.api.identifiers.FedoraId;\n+import org.fcrepo.search.api.Condition;\n+import org.fcrepo.search.api.InvalidQueryException;\n+import org.fcrepo.search.api.PaginationInfo;\n+import org.fcrepo.search.api.SearchIndex;\n+import org.fcrepo.search.api.SearchParameters;\n+import org.fcrepo.search.api.SearchResult;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.core.io.DefaultResourceLoader;\n+import org.springframework.jdbc.core.RowMapper;\n+import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;\n+import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;\n+import org.springframework.jdbc.datasource.init.DatabasePopulatorUtils;\n+import org.springframework.jdbc.datasource.init.ResourceDatabasePopulator;\n+import org.springframework.stereotype.Component;\n+import org.springframework.transaction.PlatformTransactionManager;\n+import org.springframework.transaction.support.TransactionCallback;\n+import org.springframework.transaction.support.TransactionTemplate;\n+\n+import javax.annotation.PostConstruct;\n+import javax.inject.Inject;\n+import javax.sql.DataSource;\n+import java.sql.Date;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.sql.Timestamp;\n+import java.sql.Types;\n+import java.time.Instant;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+\n+import static java.time.format.DateTimeFormatter.ISO_INSTANT;\n+\n+\n+/**\n+ * An implementation of the {@link SearchIndex}\n+ *\n+ * @author dbernstein\n+ */\n+@Component\n+public class DbSearchIndexImpl implements SearchIndex {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(DbSearchIndexImpl.class);\n+    private static final String SIMPLE_SEARCH_TABLE = \"simple_search\";\n+    private static final String DDL = \"sql/default-search-index.sql\";\n+\n+    @Inject\n+    private DataSource dataSource;\n+\n+    private NamedParameterJdbcTemplate jdbcTemplate;\n+\n+    @Inject\n+    private PlatformTransactionManager platformTransactionManager;\n+\n+    /**\n+     * Setup database table and connection\n+     */\n+    @PostConstruct\n+    public void setup() {\n+        LOGGER.info(\"Applying ddl: {}\", DDL);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e96979a32bdfaec42dd7dd0b38d6048d35cfe3cf"}, "originalPosition": 85}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MTIyMDc2", "url": "https://github.com/fcrepo/fcrepo/pull/1703#pullrequestreview-434122076", "createdAt": "2020-06-19T14:29:21Z", "commit": {"oid": "e96979a32bdfaec42dd7dd0b38d6048d35cfe3cf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNDoyOToyMVrOGmW1tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNDoyOToyMVrOGmW1tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg3MzI3MQ==", "bodyText": "Can use Condition.Field.FEDORA_ID here and the line above, ie.\n        final var result = jdbcTemplate.queryForList(\"SELECT \" + Condition.Field.FEDORA_ID + \" FROM \" + SIMPLE_SEARCH_TABLE +\n                        \" WHERE \" + Condition.Field.FEDORA_ID + \" = :fedora_id\",", "url": "https://github.com/fcrepo/fcrepo/pull/1703#discussion_r442873271", "createdAt": "2020-06-19T14:29:21Z", "author": {"login": "whikloj"}, "path": "fcrepo-search-impl/src/main/java/org/fcrepo/search/impl/DbSearchIndexImpl.java", "diffHunk": "@@ -0,0 +1,241 @@\n+/*\n+ * Licensed to DuraSpace under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional information\n+ * regarding copyright ownership.\n+ *\n+ * DuraSpace licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except in\n+ * compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.fcrepo.search.impl;\n+\n+import org.fcrepo.kernel.api.exception.RepositoryRuntimeException;\n+import org.fcrepo.kernel.api.identifiers.FedoraId;\n+import org.fcrepo.search.api.Condition;\n+import org.fcrepo.search.api.InvalidQueryException;\n+import org.fcrepo.search.api.PaginationInfo;\n+import org.fcrepo.search.api.SearchIndex;\n+import org.fcrepo.search.api.SearchParameters;\n+import org.fcrepo.search.api.SearchResult;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.core.io.DefaultResourceLoader;\n+import org.springframework.jdbc.core.RowMapper;\n+import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;\n+import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;\n+import org.springframework.jdbc.datasource.init.DatabasePopulatorUtils;\n+import org.springframework.jdbc.datasource.init.ResourceDatabasePopulator;\n+import org.springframework.stereotype.Component;\n+import org.springframework.transaction.PlatformTransactionManager;\n+import org.springframework.transaction.support.TransactionCallback;\n+import org.springframework.transaction.support.TransactionTemplate;\n+\n+import javax.annotation.PostConstruct;\n+import javax.inject.Inject;\n+import javax.sql.DataSource;\n+import java.sql.Date;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.sql.Timestamp;\n+import java.sql.Types;\n+import java.time.Instant;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+\n+import static java.time.format.DateTimeFormatter.ISO_INSTANT;\n+\n+\n+/**\n+ * An implementation of the {@link SearchIndex}\n+ *\n+ * @author dbernstein\n+ */\n+@Component\n+public class DbSearchIndexImpl implements SearchIndex {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(DbSearchIndexImpl.class);\n+    private static final String SIMPLE_SEARCH_TABLE = \"simple_search\";\n+    private static final String DDL = \"sql/default-search-index.sql\";\n+\n+    @Inject\n+    private DataSource dataSource;\n+\n+    private NamedParameterJdbcTemplate jdbcTemplate;\n+\n+    @Inject\n+    private PlatformTransactionManager platformTransactionManager;\n+\n+    /**\n+     * Setup database table and connection\n+     */\n+    @PostConstruct\n+    public void setup() {\n+        LOGGER.info(\"Applying ddl: {}\", DDL);\n+        DatabasePopulatorUtils.execute(\n+                new ResourceDatabasePopulator(new DefaultResourceLoader().getResource(\"classpath:\" + DDL)),\n+                this.dataSource);\n+        this.jdbcTemplate = getNamedParameterJdbcTemplate();\n+    }\n+\n+    private NamedParameterJdbcTemplate getNamedParameterJdbcTemplate() {\n+        return new NamedParameterJdbcTemplate(this.dataSource);\n+    }\n+\n+    @Override\n+    public SearchResult doSearch(final SearchParameters parameters) throws InvalidQueryException {\n+        //translate parameters into a SQL query\n+        var paramCount = 1;\n+\n+        final MapSqlParameterSource parameterSource = new MapSqlParameterSource();\n+        final var whereClauses = new ArrayList<String>();\n+        for (Condition condition : parameters.getConditions()) {\n+            final var field = condition.getField();\n+            final var operation = condition.getOperator();\n+            var object = condition.getObject();\n+            if (field.equals(Condition.Field.FEDORA_ID) &&\n+                    condition.getOperator().equals(Condition.Operator.EQ)) {\n+                if (!object.equals(\"*\")) {\n+                    if (object.contains(\"*\")) {\n+                        object = object.replace(\"*\", \"%\");\n+                        whereClauses.add(Condition.Field.FEDORA_ID + \" like '\" + object + \"'\");\n+                    } else {\n+                        whereClauses.add(Condition.Field.FEDORA_ID + \" = '\" + object + \"'\");\n+                    }\n+                }\n+            } else if (field.equals(Condition.Field.CREATED) || field.equals(Condition.Field.MODIFIED)) {\n+                //parse date\n+                try {\n+                    final var instant = InstantParser.parse(object);\n+                    final var paramName = \"param\" + paramCount++;\n+                    whereClauses.add(field + \" \" + operation.getStringValue() +\n+                            \" :\" + paramName);\n+                    parameterSource.addValue(paramName, new Date(instant.toEpochMilli()), Types.TIMESTAMP);\n+                } catch (Exception ex) {\n+                    throw new InvalidQueryException(ex.getMessage());\n+                }\n+            } else {\n+                throw new InvalidQueryException(\"Condition not supported: \\\"\" + condition + \"\\\"\");\n+            }\n+        }\n+\n+        final var fields = parameters.getFields().stream().map(x -> x.toString()).collect(Collectors.toList());\n+        final var sql =\n+                new StringBuilder(\"SELECT \" + String.join(\",\", fields) + \" FROM \" + SIMPLE_SEARCH_TABLE);\n+\n+        if (!whereClauses.isEmpty()) {\n+            sql.append(\" WHERE \");\n+            for (var it = whereClauses.iterator(); it.hasNext(); ) {\n+                sql.append(it.next());\n+                if (it.hasNext()) {\n+                    sql.append(\" AND \");\n+                }\n+            }\n+        }\n+        sql.append(\" ORDER BY \" + Condition.Field.FEDORA_ID);\n+        sql.append(\" LIMIT :limit OFFSET :offset\");\n+        parameterSource.addValue(\"limit\", parameters.getMaxResults());\n+        parameterSource.addValue(\"offset\", parameters.getOffset());\n+\n+        final var rowMapper = new RowMapper<Map<String, Object>>() {\n+            @Override\n+            public Map<String, Object> mapRow(final ResultSet rs, final int rowNum) throws SQLException {\n+                final Map<String, Object> map = new HashMap<>();\n+                for (String f : fields) {\n+                    var value = rs.getObject(f);\n+                    if (value instanceof Timestamp) {\n+                        value = ISO_INSTANT.format(Instant.ofEpochMilli(((Timestamp) value).getTime()));\n+                    }\n+                    map.put(f, value);\n+                }\n+                return map;\n+            }\n+        };\n+\n+        final List<Map<String, Object>> items = jdbcTemplate.query(sql.toString(), parameterSource, rowMapper);\n+        final var pagination = new PaginationInfo(parameters.getMaxResults(), parameters.getOffset());\n+        LOGGER.debug(\"Search query with parameters: {} - {}\", sql, parameters);\n+        return new SearchResult(items, pagination);\n+    }\n+\n+    @Override\n+    public void addUpdateIndex(final FedoraId fedoraId, final Instant created, final Instant modified,\n+                               final Long size, final String mimetype) {\n+        final var fullId = fedoraId.getFullId();\n+        final var selectParams = new MapSqlParameterSource();\n+        selectParams.addValue(\"fedora_id\", fullId);\n+        final var result = jdbcTemplate.queryForList(\"SELECT fedora_id FROM \" + SIMPLE_SEARCH_TABLE +\n+                        \" WHERE fedora_id = :fedora_id\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e96979a32bdfaec42dd7dd0b38d6048d35cfe3cf"}, "originalPosition": 179}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "30ca1bf73f6c251ac3537e52d73040b973ba19b5", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/30ca1bf73f6c251ac3537e52d73040b973ba19b5", "committedDate": "2020-06-22T22:39:21Z", "message": "Address PR feedback."}, "afterCommit": {"oid": "7c8b36fe23f6555d13b51e0b70ef9b60eb03126b", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/7c8b36fe23f6555d13b51e0b70ef9b60eb03126b", "committedDate": "2020-06-22T22:47:34Z", "message": "Address PR feedback."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMzI4NzI2", "url": "https://github.com/fcrepo/fcrepo/pull/1703#pullrequestreview-440328726", "createdAt": "2020-06-30T19:39:49Z", "commit": {"oid": "953df4bfa0f7f851715333e0b19f0ac9b806680c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxOTozOTo1MFrOGrLtzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxOTozOTo1MFrOGrLtzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzkzMzkwMQ==", "bodyText": "The size of result.getItems().size() is asserted as 0 above, so this stream is never run and can probably be removed.", "url": "https://github.com/fcrepo/fcrepo/pull/1703#discussion_r447933901", "createdAt": "2020-06-30T19:39:50Z", "author": {"login": "whikloj"}, "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraSearchIT.java", "diffHunk": "@@ -124,11 +136,184 @@ public void testWildcardMatchingOnPartialFedoraId() throws Exception {\n                 assertEquals(\"expected \" + count + \" items where condition = \" + condition, count,\n                         result.getItems().size());\n \n-                result.getItems().stream().map(x -> x.get(\"fedora_id\"))\n+                result.getItems().stream().map(x -> x.get(FEDORA_ID.toString()))\n                         .forEach(x -> assertTrue(x.toString().startsWith(urlPrefix)));\n             }\n         }\n+    }\n+\n+    @Test\n+    public void testUpdateSearchIndexOnResourceUpdate() throws Exception {\n+        final var resourceId = createResources(1).get(0);\n+        final var condition = FEDORA_ID + \"=\" + resourceId;\n+        final String searchUrl = getSearchEndpoint() + \"condition=\" + encode(condition);\n+        String modified = null;\n+        try (final CloseableHttpResponse response = execute(new HttpGet(searchUrl))) {\n+            assertEquals(OK.getStatusCode(), getStatus(response));\n+            final ObjectMapper objectMapper = new ObjectMapper();\n+            final SearchResult result = objectMapper.readValue(response.getEntity().getContent(),\n+                    SearchResult.class);\n+            assertEquals(\"expected 1 item where condition = \" + condition, 1,\n+                    result.getItems().size());\n+            modified = result.getItems().get(0).get(MODIFIED.toString()).toString();\n+        }\n+\n+        final var patch = new HttpPatch(resourceId);\n+        patch.setHeader(\"Content-Type\", \"application/sparql-update\");\n+        patch.setEntity(new StringEntity(\"insert data { <> <http://example/blah> \\\"Blah\\\". }\"));\n+        try (final CloseableHttpResponse response = execute(patch)) {\n+            assertEquals(NO_CONTENT.getStatusCode(), getStatus(response));\n+        }\n+\n+        try (final CloseableHttpResponse response = execute(new HttpGet(searchUrl))) {\n+            assertEquals(OK.getStatusCode(), getStatus(response));\n+            final ObjectMapper objectMapper = new ObjectMapper();\n+            final SearchResult result = objectMapper.readValue(response.getEntity().getContent(),\n+                    SearchResult.class);\n+            assertEquals(\"expected 1 item where condition = \" + condition, 1,\n+                    result.getItems().size());\n+            final var newModified = result.getItems().get(0).get(MODIFIED.toString()).toString();\n+            assertNotEquals(\"Modified date should have changed  but it did not.\", modified, newModified);\n+        }\n+    }\n+\n+    @Test\n+    public void testUpdateSearchIndexOnResourceDelete() throws Exception {\n+        final var resourceId = createResources(1).get(0);\n+        final var condition = FEDORA_ID + \"=\" + resourceId;\n+        final String searchUrl = getSearchEndpoint() + \"condition=\" + encode(condition);\n+        try (final CloseableHttpResponse response = execute(new HttpGet(searchUrl))) {\n+            assertEquals(OK.getStatusCode(), getStatus(response));\n+            final ObjectMapper objectMapper = new ObjectMapper();\n+            final SearchResult result = objectMapper.readValue(response.getEntity().getContent(),\n+                    SearchResult.class);\n+            assertEquals(\"expected 1 item where condition = \" + condition, 1,\n+                    result.getItems().size());\n+        }\n+\n+        final var httpDelete = new HttpDelete(resourceId);\n+        try (final CloseableHttpResponse response = execute(httpDelete)) {\n+            assertEquals(NO_CONTENT.getStatusCode(), getStatus(response));\n+        }\n+\n+        try (final CloseableHttpResponse response = execute(new HttpGet(searchUrl))) {\n+            assertEquals(OK.getStatusCode(), getStatus(response));\n+            final ObjectMapper objectMapper = new ObjectMapper();\n+            final SearchResult result = objectMapper.readValue(response.getEntity().getContent(),\n+                    SearchResult.class);\n+            assertEquals(\"expected 0 items where condition = \" + condition, 0,\n+                    result.getItems().size());\n+        }\n+    }\n+\n+    public void testModifiedGreaterAndLessThan() throws Exception {\n+        final var id = getRandomUniqueId();\n+        final int count = 1;\n+        final var instant = Instant.now();\n+        final var now = instant.toString();\n+        final var tomorrow = instant.plus(Duration.ofDays(1)).toString();\n+        createResources(id, count);\n+        final var fedoraId = FEDORA_ID_PREFIX + \"/\" + id;\n+        final var fedoraIdCondition = FEDORA_ID + \"=\" + fedoraId;\n+        final var lessThanNow = MODIFIED + \"<\" + now;\n+        final var greaterThanNow = MODIFIED + \">\" + now;\n+        final var lessThanTomorrow = MODIFIED + \"<\" + tomorrow;\n+        final var greaterThanTomorrow = MODIFIED + \">\" + tomorrow;\n+\n+        //no results for resources modified before now\n+        String searchUrl =\n+                getSearchEndpoint() + \"condition=\" + encode(fedoraIdCondition) + \"&\" + lessThanNow;\n+        try (final CloseableHttpResponse response = execute(new HttpGet(searchUrl))) {\n+            assertEquals(OK.getStatusCode(), getStatus(response));\n+            final ObjectMapper objectMapper = new ObjectMapper();\n+            final SearchResult result = objectMapper.readValue(response.getEntity().getContent(),\n+                    SearchResult.class);\n+            assertEquals(\"expected no results\", 0,\n+                    result.getItems().size());\n+            result.getItems().stream().map(x -> x.get(\"fedora_id\"))\n+                    .forEach(x -> assertTrue(x.toString().equals(fedoraId)));\n+        }\n+        //no results for resources modified after tomorrow\n+        searchUrl =\n+                getSearchEndpoint() + \"condition=\" + encode(fedoraIdCondition) + \"&\" + greaterThanTomorrow;\n+        try (final CloseableHttpResponse response = execute(new HttpGet(searchUrl))) {\n+            assertEquals(OK.getStatusCode(), getStatus(response));\n+            final ObjectMapper objectMapper = new ObjectMapper();\n+            final SearchResult result = objectMapper.readValue(response.getEntity().getContent(),\n+                    SearchResult.class);\n+            assertEquals(\"expected no results\", 0,\n+                    result.getItems().size());\n+            result.getItems().stream().map(x -> x.get(\"fedora_id\"))\n+                    .forEach(x -> assertTrue(x.toString().equals(fedoraId)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "953df4bfa0f7f851715333e0b19f0ac9b806680c"}, "originalPosition": 156}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "702efc5bba82ec738af731747a0be3672bc08eb6", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/702efc5bba82ec738af731747a0be3672bc08eb6", "committedDate": "2020-07-02T16:56:39Z", "message": "Moves the search index into its own table.\nAdds support for searching by modified and created dates.\nAdds support for customizing the output fields of your search.\nBy default all fields returned.\n\nResolves:\nhttps://jira.lyrasis.org/browse/FCREPO-3349\nhttps://jira.lyrasis.org/browse/FCREPO-3353\nhttps://jira.lyrasis.org/browse/FCREPO-3354"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99427588ce9d21e31a52c215bb32b5e56127c055", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/99427588ce9d21e31a52c215bb32b5e56127c055", "committedDate": "2020-07-02T16:56:40Z", "message": "Address PR feedback."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa9d68dad2cf74e45fbe071357871296d95be003", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/aa9d68dad2cf74e45fbe071357871296d95be003", "committedDate": "2020-07-02T16:56:40Z", "message": "Removes unnecessary assertions."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92e065a1efe1422fbbe4c2d3a6e2506178751958", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/92e065a1efe1422fbbe4c2d3a6e2506178751958", "committedDate": "2020-07-02T18:16:41Z", "message": "Refactors SearchIndex.addUpdateIndex() method to take a single (ResourceHeaders) parameter."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d24758c860c3e19ac498781db47226f2fc6f19f8", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/d24758c860c3e19ac498781db47226f2fc6f19f8", "committedDate": "2020-06-30T22:30:35Z", "message": "Refactors SearchIndex.addUpdateIndex() method to take a single (ResourceHeaders) parameter."}, "afterCommit": {"oid": "92e065a1efe1422fbbe4c2d3a6e2506178751958", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/92e065a1efe1422fbbe4c2d3a6e2506178751958", "committedDate": "2020-07-02T18:16:41Z", "message": "Refactors SearchIndex.addUpdateIndex() method to take a single (ResourceHeaders) parameter."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxOTUyOTA2", "url": "https://github.com/fcrepo/fcrepo/pull/1703#pullrequestreview-441952906", "createdAt": "2020-07-02T19:04:41Z", "commit": {"oid": "92e065a1efe1422fbbe4c2d3a6e2506178751958"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3143, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}