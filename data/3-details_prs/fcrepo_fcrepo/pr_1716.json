{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2MjI2NDY4", "number": 1716, "title": "improved rollback logic", "bodyText": "JIRA Ticket: https://jira.lyrasis.org/browse/FCREPO-3350\nWhat does this Pull Request do?\n\nExceptions during rollbacks are logged; not rethrown\nStaging directories are always cleaned up\nGeneral logic and logging cleanup\n\nHow should this be tested?\nStart F6:\nmvn -Dfcrepo.home=target/fcrepo -Dfcrepo.log=DEBUG clean jetty:run\n\nCreate a resource in a transaction:\ncurl -u fedoraAdmin:fedoraAdmin -v -XPOST http://localhost:8080/rest/fcr:tx\ntxid=<TX_ID>\ncurl -u fedoraAdmin:fedoraAdmin -H\"Atomic-ID: ${txid}\" http://localhost:8080/rest/foo -H \"Link: <http://www.w3.org/ns/ldp#NonRDFSource>; rel=type\" -v -H \"Content-Type: text/plain\" -X PUT --data-binary \"bar\"\n\nSee the staging directory:\nls target/fcrepo/data/staging\n\nCommit the transaction:\ncurl -u fedoraAdmin:fedoraAdmin -X PUT -v http://localhost:8080/rest/fcr:tx/${txid}\n\nVerify the staging directory is now gone.\nDo the same steps a second time, but, instead of committing the transaction, wait for it to expire and the confirm that the staging directory was removed.\nInterested parties\n@fcrepo4/committers", "createdAt": "2020-07-08T12:58:23Z", "url": "https://github.com/fcrepo/fcrepo/pull/1716", "merged": true, "mergeCommit": {"oid": "2aea8d8d37fef19738ccdb7a60d29c01839c0691"}, "closed": true, "closedAt": "2020-07-09T20:42:53Z", "author": {"login": "pwinckles"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcy56JoAH2gAyNDQ2MjI2NDY4OjU4NjYyZWYxMTc5MTdlYjJhZjg3ZDhiNjU4Nzk2YmQxOTA3OGI1NTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczRkrUAFqTQ0NTc3NzA3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "58662ef117917eb2af87d8b658796bd19078b554", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/58662ef117917eb2af87d8b658796bd19078b554", "committedDate": "2020-07-08T12:50:24Z", "message": "improved rollback logic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MDM2Mzkz", "url": "https://github.com/fcrepo/fcrepo/pull/1716#pullrequestreview-445036393", "createdAt": "2020-07-08T18:43:41Z", "commit": {"oid": "58662ef117917eb2af87d8b658796bd19078b554"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxODo0Mzo0MVrOGu00mQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQyMDo1MjozNVrOGu40Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc1MzExMw==", "bodyText": "For consistency with the other methods on this interface... potentially change from tx to txId.", "url": "https://github.com/fcrepo/fcrepo/pull/1716#discussion_r451753113", "createdAt": "2020-07-08T18:43:41Z", "author": {"login": "awoods"}, "path": "fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/ContainmentIndex.java", "diffHunk": "@@ -39,7 +38,7 @@\n      * @param fedoraResource The containing fedora resource\n      * @return A stream of contained identifiers\n      */\n-    Stream<String> getContains(Transaction tx, FedoraResource fedoraResource);\n+    Stream<String> getContains(String tx, FedoraResource fedoraResource);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58662ef117917eb2af87d8b658796bd19078b554"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc1MzE3OQ==", "bodyText": "For consistency with the other methods on this interface... potentially change from tx to txId.", "url": "https://github.com/fcrepo/fcrepo/pull/1716#discussion_r451753179", "createdAt": "2020-07-08T18:43:48Z", "author": {"login": "awoods"}, "path": "fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/ContainmentIndex.java", "diffHunk": "@@ -49,7 +48,7 @@\n      * @param fedoraResource The containing fedora resource\n      * @return A stream of contained identifiers\n      */\n-    Stream<String> getContainsDeleted(Transaction tx, FedoraResource fedoraResource);\n+    Stream<String> getContainsDeleted(String tx, FedoraResource fedoraResource);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58662ef117917eb2af87d8b658796bd19078b554"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc1NTQwMw==", "bodyText": "Thank you.", "url": "https://github.com/fcrepo/fcrepo/pull/1716#discussion_r451755403", "createdAt": "2020-07-08T18:47:53Z", "author": {"login": "awoods"}, "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/observer/EventAccumulatorImpl.java", "diffHunk": "@@ -71,7 +71,7 @@ public void recordEventForOperation(final String transactionId, final FedoraId f\n \n     @Override\n     public void emitEvents(final String transactionId, final String baseUrl, final String userAgent) {\n-        LOG.info(\"Emitting events for transaction {}\", transactionId);\n+        LOG.debug(\"Emitting events for transaction {}\", transactionId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58662ef117917eb2af87d8b658796bd19078b554"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgxMzQ3MA==", "bodyText": "For clarity around the use of this pseudo-transaction, can we make this method (rebuild()) private, and remove it from the IndexBuilder interface?", "url": "https://github.com/fcrepo/fcrepo/pull/1716#discussion_r451813470", "createdAt": "2020-07-08T20:42:16Z", "author": {"login": "awoods"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/IndexBuilderImpl.java", "diffHunk": "@@ -89,80 +97,92 @@ public void rebuild() {\n         containmentIndex.reset();\n         searchIndex.reset();\n \n+        final var txId = UUID.randomUUID().toString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58662ef117917eb2af87d8b658796bd19078b554"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgxODU0Nw==", "bodyText": "I believe slf4j sees a miniscule performance benefit from the non-concatenating syntax (\"Failed to cleanup staging directory: {}\", stagingDir)... but no big deal.", "url": "https://github.com/fcrepo/fcrepo/pull/1716#discussion_r451818547", "createdAt": "2020-07-08T20:52:35Z", "author": {"login": "awoods"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/IndexBuilderImpl.java", "diffHunk": "@@ -190,4 +210,32 @@ private boolean repoContainsObjects() {\n         return ocflRepository.listObjectIds().findFirst().isPresent();\n     }\n \n+    private Path createStagingDir(final String txId) {\n+        try {\n+            return Files.createDirectories(sessionStagingRoot.resolve(txId));\n+        } catch (IOException e) {\n+            throw new UncheckedIOException(e);\n+        }\n+    }\n+\n+    private void cleanupStaging(final Path stagingDir) {\n+        if (!FileUtils.deleteQuietly(stagingDir.toFile())) {\n+            LOGGER.warn(\"Failed to cleanup staging directory: \" + stagingDir);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58662ef117917eb2af87d8b658796bd19078b554"}, "originalPosition": 213}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcd72b685e255d9edaf8373371464eea91280104", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/dcd72b685e255d9edaf8373371464eea91280104", "committedDate": "2020-07-09T14:43:06Z", "message": "pr fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75f76a039d0c7028454fb81f7a77a35aba76af5f", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/75f76a039d0c7028454fb81f7a77a35aba76af5f", "committedDate": "2020-07-09T15:32:19Z", "message": "moved txId() to super class"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1Nzc3MDcy", "url": "https://github.com/fcrepo/fcrepo/pull/1716#pullrequestreview-445777072", "createdAt": "2020-07-09T16:24:40Z", "commit": {"oid": "75f76a039d0c7028454fb81f7a77a35aba76af5f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3159, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}