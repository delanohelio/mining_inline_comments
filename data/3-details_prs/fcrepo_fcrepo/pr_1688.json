{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3MzgwNzY4", "number": 1688, "title": "FCREPO-3200 - Default Digests", "bodyText": "JIRA Ticket: https://jira.lyrasis.org/browse/FCREPO-3200\nWhat does this Pull Request do?\n\nInternal fedora binaries will always record a default digest\nAdds a repository wide default digest algorithm from a system property.\n\nCan only be SHA512 or SHA256 due to OCFL restrictions\n\n\nNew OCFL objects are configured to use this default digest algorithm\nAdded aliases for digest algorithms to help with matching across domains\nAdds integration tests for binary persistence in OCFL\n\nHow should this be tested?\nDigests are not currently visible in http responses unfortunately, so you would need to look at the OCFL persistence to verify results:\ncurl -XPOST http://localhost:8080/rest/ -H\"Slug: binary_default_digest\" --data-binary @README.md -H\"Content-type: text/plain\" -ufedoraAdmin:fedoraAdmin\n\n# verify that the sha512 is set (adjust for your OCFL storage root)\nless /var/folders/v6/r6tq3p3n2h165cw93s39rl25cv0v_w/T/fcrepo.ocfl.storage.root.dir/84/43/86/binary_default_digest/v1/content/.fcrepo/binary_default_digest.json \n\n{\n  \"parent\": \"info:fedora\",\n  \"id\": \"info:fedora/binary_default_digest\",\n  \"lastModifiedDate\": \"2020-06-03T18:14:13.987960Z\",\n  \"interactionModel\": \"http://www.w3.org/ns/ldp#NonRDFSource\",\n  \"createdBy\": \"fedoraAdmin\",\n  \"createdDate\": \"2020-06-03T18:14:13.987960Z\",\n  \"lastModifiedBy\": \"fedoraAdmin\",\n  \"stateToken\": \"4BE570CA6FBA4D7ECD6D94DB8878B3C2\",\n  \"contentSize\": 5770,\n  \"digests\": [\n    \"urn:sha-512:7003d24ed80964957eb59d590f8d63961a8db755bc5760b9d55c21d97d3b011497bce353e1ceaa9374efbe9f05f4b277010468b92a55c543b0dca787300f8681\"\n  ],\n  \"filename\": \"\",\n  \"deleted\": false,\n  \"mimeType\": \"text/plain\",\n  \"archivalGroup\": false,\n  \"objectRoot\": true\n}\n\n# With bad digest\ncurl -XPOST http://localhost:8080/rest/ -H\"Slug: binary_sha1_digest\" --data-binary @LICENSE -H\"Content-type: text/plain\" -H\"digest: sha=checksumdoesntmatch\" -ufedoraAdmin:fedoraAdmin\n# Checksum mismatch, computed SHA digest f5c0f25223b84f167e917701f91e90c49525def0 did not match expected value checksumdoesntmatch\n\n# With sha1 digest\ncurl -XPOST http://localhost:8080/rest/ -H\"Slug: binary_sha1_digest\" --data-binary @LICENSE -H\"Content-type: text/plain\" -H\"digest: sha=f5c0f25223b84f167e917701f91e90c49525def0\" -ufedoraAdmin:fedoraAdmin\n\n# Verify that the sha512 and provided sha1 are present\nless /var/folders/v6/r6tq3p3n2h165cw93s39rl25cv0v_w/T/fcrepo.ocfl.storage.root.dir/82/70/bb/binary_sha1_digest/v1/content/.fcrepo/binary_sha1_digest.json \n\n{\n  \"parent\": \"info:fedora\",\n  \"id\": \"info:fedora/binary_sha1_digest\",\n  \"lastModifiedDate\": \"2020-06-03T18:24:03.656085Z\",\n  \"interactionModel\": \"http://www.w3.org/ns/ldp#NonRDFSource\",\n  \"createdBy\": \"fedoraAdmin\",\n  \"createdDate\": \"2020-06-03T18:24:03.656085Z\",\n  \"lastModifiedBy\": \"fedoraAdmin\",\n  \"stateToken\": \"9C8C83F606DBDA2BCB78A431E45AD3EC\",\n  \"contentSize\": 10831,\n  \"digests\": [\n    \"urn:sha1:f5c0f25223b84f167e917701f91e90c49525def0\",\n    \"urn:sha-512:05de5e29e68a7e33c86d494cf88da0c3c8c7c10ce5d3d678a548c2538991f806728d6e44495d3b59da13d279533c29952f6467b61a57415e9239d76e23201b22\"\n  ],\n  \"filename\": \"\",\n  \"deleted\": false,\n  \"mimeType\": \"text/plain\",\n  \"archivalGroup\": false,\n  \"objectRoot\": true\n}\n\nNotes\nThe SHA512 is generated both when the file is written to staging, and the OCFL client also generates and verifies it. Some efficiency should be gained later in FCREPO-3201 by passing the digest along with the OCFL client in terms of transmission fixity checking.\nInterested parties\n@awoods @pwinckles", "createdAt": "2020-06-03T18:33:58Z", "url": "https://github.com/fcrepo/fcrepo/pull/1688", "merged": true, "mergeCommit": {"oid": "ccce2abfe5c8cc5cdce5b344dad8363f3c746020"}, "closed": true, "closedAt": "2020-06-04T14:17:18Z", "author": {"login": "bbpennel"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnbfDYgH2gAyNDI3MzgwNzY4OjVjNmU5ZGI1ZTdiNmE2NjFjODI0MzFhYmRmMzkxMWI5NTFiMGQ0YWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcn-xBJgFqTQyNDQ5NjExOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5c6e9db5e7b6a661c82431abdf3911b951b0d4ac", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/fcrepo/fcrepo/commit/5c6e9db5e7b6a661c82431abdf3911b951b0d4ac", "committedDate": "2020-06-02T21:10:29Z", "message": "Added getDigests method to MultiDigestInputStreamWrapper, constructor can now take a list of digests to calculate in addition to the current list of digests to verify. checkFixity and getDigests will both now consume the inputstream if it has not already been read"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "427dc26a8c1d2a0f21714646decd87be9fde7ace", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/fcrepo/fcrepo/commit/427dc26a8c1d2a0f21714646decd87be9fde7ace", "committedDate": "2020-06-03T17:55:53Z", "message": "Internal binaries always have a digest of the default algorithm generated and stored to their header file\nOCFLObjectSessions now have a helper method for getting the digest algorithm used by an ocfl object\nAdded a constant for getting the default digest algorithm used by fedora and OCFL (only SHA512 and SHA256 are supported)\nAdds integration tests for persistence of binaries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ead477d2c42738b6a87a62d89cd877c3350dbe69", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/fcrepo/fcrepo/commit/ead477d2c42738b6a87a62d89cd877c3350dbe69", "committedDate": "2020-06-03T19:01:09Z", "message": "Persist digests from operation for external binaries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzODg2NjQx", "url": "https://github.com/fcrepo/fcrepo/pull/1688#pullrequestreview-423886641", "createdAt": "2020-06-03T20:01:13Z", "commit": {"oid": "ead477d2c42738b6a87a62d89cd877c3350dbe69"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QyMDowMToxM1rOGerWjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QyMDowMToxM1rOGerWjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgyMDc0OA==", "bodyText": "Comments seems incorrect. We are defaulting to SHA512, no?", "url": "https://github.com/fcrepo/fcrepo/pull/1688#discussion_r434820748", "createdAt": "2020-06-03T20:01:13Z", "author": {"login": "awoods"}, "path": "fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/utils/ContentDigest.java", "diffHunk": "@@ -38,20 +41,39 @@\n \n     private static final Logger LOGGER = getLogger(ContentDigest.class);\n \n+    private final static String DEFAULT_DIGEST_ALGORITHM_PROPERTY = \"fcrepo.persistence.defaultDigestAlgorithm\";\n+    public final static DIGEST_ALGORITHM DEFAULT_DIGEST_ALGORITHM;\n+\n+    static {\n+        // Establish the default digest algorithm for fedora, defaulting to SHA1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ead477d2c42738b6a87a62d89cd877c3350dbe69"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MDA0Nzg5", "url": "https://github.com/fcrepo/fcrepo/pull/1688#pullrequestreview-424004789", "createdAt": "2020-06-03T23:30:17Z", "commit": {"oid": "ead477d2c42738b6a87a62d89cd877c3350dbe69"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QyMzozMDoxN1rOGew6qA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QyMzozMDoxN1rOGew6qA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDkxMTkxMg==", "bodyText": "Thoughts on refactoring: \"fedoraconfig:defaultDigestAlgorithm\"?\nhttps://github.com/fcrepo4/fcrepo4/blob/master/fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/FedoraTypes.java#L90\nOr... is there any reason to change the existing property, and the associated documentation?\nhttps://wiki.lyrasis.org/display/FEDORA4x/RESTful+HTTP+API+-+Fixity#RESTfulHTTPAPIFixity-DefaultFixityAlgorithm", "url": "https://github.com/fcrepo/fcrepo/pull/1688#discussion_r434911912", "createdAt": "2020-06-03T23:30:17Z", "author": {"login": "awoods"}, "path": "fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/utils/ContentDigest.java", "diffHunk": "@@ -38,20 +41,39 @@\n \n     private static final Logger LOGGER = getLogger(ContentDigest.class);\n \n+    private final static String DEFAULT_DIGEST_ALGORITHM_PROPERTY = \"fcrepo.persistence.defaultDigestAlgorithm\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ead477d2c42738b6a87a62d89cd877c3350dbe69"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf9c13baf87ee2708b5fba117a24916776d5c003", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/fcrepo/fcrepo/commit/bf9c13baf87ee2708b5fba117a24916776d5c003", "committedDate": "2020-06-04T12:49:19Z", "message": "Improve error message when invalid digest algorithms provided"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NDE4NDY2", "url": "https://github.com/fcrepo/fcrepo/pull/1688#pullrequestreview-424418466", "createdAt": "2020-06-04T13:04:20Z", "commit": {"oid": "bf9c13baf87ee2708b5fba117a24916776d5c003"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NDk2MTE5", "url": "https://github.com/fcrepo/fcrepo/pull/1688#pullrequestreview-424496119", "createdAt": "2020-06-04T14:16:47Z", "commit": {"oid": "bf9c13baf87ee2708b5fba117a24916776d5c003"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3127, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}