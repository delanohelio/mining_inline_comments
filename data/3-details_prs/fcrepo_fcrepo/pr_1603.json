{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyODA0NDM5", "number": 1603, "title": "Persist FedoraToOCFLIndex to disk", "bodyText": "JIRA Ticket: https://jira.lyrasis.org/browse/FCREPO-3171\nWhat does this Pull Request do?\nA simple text file containing the FedoraToOCFLObjectIndex so we can reload it between runs of Fedora.\nHow should this be tested?\nTry both of these steps before and after PR.\n\nStand up Fedora\nCreate a resource.\nGET the resource\nShutdown Fedora\nStart Fedora, this step will throw errors before the PR.\nGET the resource again, this step will only work after the PR.\n\nAdditional Notes:\nThis is not good I'm sure. My skill with creating and read/writing to files with java is weak so please provide any improvements you can think of.\nInterested parties\n@fcrepo4/committers", "createdAt": "2020-01-14T19:38:03Z", "url": "https://github.com/fcrepo/fcrepo/pull/1603", "merged": true, "mergeCommit": {"oid": "b9e9512d1e374ae3bc40a5e37dfe09332cd0bc0e"}, "closed": true, "closedAt": "2020-01-15T22:17:54Z", "author": {"login": "whikloj"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6Uls0gH2gAyMzYyODA0NDM5OjRlZGYyNDNhNDY5NWExMGUyNTFkMzJiYmUwMTVmNDA3MDFhZTJlOTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6swcCAH2gAyMzYyODA0NDM5Ojg2MDMyNzgzNGJlYzY3NDdhNTVlMTM1Y2YyYjg4N2Y5ZDVlYmNmZmM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4edf243a4695a10e251d32bbe015f40701ae2e93", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/4edf243a4695a10e251d32bbe015f40701ae2e93", "committedDate": "2020-01-14T17:41:49Z", "message": "Persist FedoraToOCFLIndex to disk"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyODkzOTg4", "url": "https://github.com/fcrepo/fcrepo/pull/1603#pullrequestreview-342893988", "createdAt": "2020-01-14T22:55:19Z", "commit": {"oid": "4edf243a4695a10e251d32bbe015f40701ae2e93"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQyMjo1NToxOVrOFdoe8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQyMjo1NzoxNlrOFdohtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxNjMwNw==", "bodyText": "@whikloj :  There are constants these directories in DefaultOCFLObjectSessionFactory.  I would moving DefaultOCFLObjectSessionFactory.STAGING_DIR,  DefaultOCFLObjectSessionFactory.OCFL_STORAGE_ROOT_DIR,  DefaultOCFLObjectSessionFactory.OCFL_WORK_DIR and DefaultOCFLObjectSessionFactory.resolveDir() into OCFLPersistenceConstants and then having FedoraToOCFLObjectIndexImpl use them in order to eliminate the duplicate code.", "url": "https://github.com/fcrepo/fcrepo/pull/1603#discussion_r366616307", "createdAt": "2020-01-14T22:55:19Z", "author": {"login": "dbernstein"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImpl.java", "diffHunk": "@@ -35,10 +46,36 @@\n  */\n @Component\n public class FedoraToOCFLObjectIndexImpl implements FedoraToOCFLObjectIndex {\n+\n+    private Path indexFilePath = getProperty(\"fcrepo.ocfl.work.dir\") == null ?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4edf243a4695a10e251d32bbe015f40701ae2e93"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxNjgwMw==", "bodyText": "Make fedoraToOcflIndex.tsv a constant as well.", "url": "https://github.com/fcrepo/fcrepo/pull/1603#discussion_r366616803", "createdAt": "2020-01-14T22:56:42Z", "author": {"login": "dbernstein"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImpl.java", "diffHunk": "@@ -35,10 +46,36 @@\n  */\n @Component\n public class FedoraToOCFLObjectIndexImpl implements FedoraToOCFLObjectIndex {\n+\n+    private Path indexFilePath = getProperty(\"fcrepo.ocfl.work.dir\") == null ?\n+            Paths.get(JAVA_IO_TMPDIR, \"fcrepo.ocfl.work.dir\", \"fedoraToOcflIndex.tsv\") :", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4edf243a4695a10e251d32bbe015f40701ae2e93"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxNzAxNA==", "bodyText": "Use constants per above refactoring suggestion.", "url": "https://github.com/fcrepo/fcrepo/pull/1603#discussion_r366617014", "createdAt": "2020-01-14T22:57:16Z", "author": {"login": "dbernstein"}, "path": "fcrepo-persistence-ocfl/src/test/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImplTest.java", "diffHunk": "@@ -36,6 +52,16 @@\n     private static final String OCFL_ID = \"ocfl-id\";\n     private static final String OCFL_ID_RESOURCE_3 = \"ocfl-id-resource-3\";\n \n+    private final Path indexMappingPath = getProperty(\"fcrepo.ocfl.work.dir\") == null ?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4edf243a4695a10e251d32bbe015f40701ae2e93"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyOTA3MDUz", "url": "https://github.com/fcrepo/fcrepo/pull/1603#pullrequestreview-342907053", "createdAt": "2020-01-14T23:29:00Z", "commit": {"oid": "4edf243a4695a10e251d32bbe015f40701ae2e93"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c43e4e0553eee11cb6c06a84a192fd8828994d6", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/4c43e4e0553eee11cb6c06a84a192fd8828994d6", "committedDate": "2020-01-15T14:30:47Z", "message": "Reuse OCFL directory constants"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzMzU1NDkx", "url": "https://github.com/fcrepo/fcrepo/pull/1603#pullrequestreview-343355491", "createdAt": "2020-01-15T16:34:28Z", "commit": {"oid": "4c43e4e0553eee11cb6c06a84a192fd8828994d6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNjozNDoyOFrOFd-oWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNjozNDoyOFrOFd-oWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njk3OTE2MA==", "bodyText": "Please add a documentation note describing the expected layout/fields in the .tsv file.\nThe use of map.length == 3 and indexing into the map array seem a bit opaque.", "url": "https://github.com/fcrepo/fcrepo/pull/1603#discussion_r366979160", "createdAt": "2020-01-15T16:34:28Z", "author": {"login": "awoods"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImpl.java", "diffHunk": "@@ -35,10 +42,30 @@\n  */\n @Component\n public class FedoraToOCFLObjectIndexImpl implements FedoraToOCFLObjectIndex {\n+\n     private static Logger LOGGER = LoggerFactory.getLogger(FedoraToOCFLObjectIndexImpl.class);\n \n     private Map<String, FedoraOCFLMapping> fedoraOCFLMappingMap = Collections.synchronizedMap(new HashMap<>());\n \n+    /**\n+     * Constructor", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c43e4e0553eee11cb6c06a84a192fd8828994d6"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzMzU5NTI4", "url": "https://github.com/fcrepo/fcrepo/pull/1603#pullrequestreview-343359528", "createdAt": "2020-01-15T16:40:00Z", "commit": {"oid": "4c43e4e0553eee11cb6c06a84a192fd8828994d6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNjo0MDowMFrOFd-0hQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNjo0OToyNVrOFd_I-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njk4MjI3Nw==", "bodyText": "Maybe add a log message if the length is not 3?", "url": "https://github.com/fcrepo/fcrepo/pull/1603#discussion_r366982277", "createdAt": "2020-01-15T16:40:00Z", "author": {"login": "awoods"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImpl.java", "diffHunk": "@@ -35,10 +42,30 @@\n  */\n @Component\n public class FedoraToOCFLObjectIndexImpl implements FedoraToOCFLObjectIndex {\n+\n     private static Logger LOGGER = LoggerFactory.getLogger(FedoraToOCFLObjectIndexImpl.class);\n \n     private Map<String, FedoraOCFLMapping> fedoraOCFLMappingMap = Collections.synchronizedMap(new HashMap<>());\n \n+    /**\n+     * Constructor\n+     * @throws IOException If we can't access the file.\n+     */\n+    public FedoraToOCFLObjectIndexImpl() throws IOException {\n+        if (FEDORA_TO_OCFL_INDEX_FILE.exists() && FEDORA_TO_OCFL_INDEX_FILE.canRead()) {\n+            Files.lines(FEDORA_TO_OCFL_INDEX_FILE.toPath()).filter(l -> {\n+                final String m = l.split(\"\\t\")[0];\n+                return (!fedoraOCFLMappingMap.containsKey(m));\n+            }).forEach(l -> {\n+                final String[] map = l.split(\"\\t\");\n+                if (map.length == 3) {\n+                    final FedoraOCFLMapping ocflMapping = new FedoraOCFLMapping(map[1], map[2]);\n+                    fedoraOCFLMappingMap.put(map[0], ocflMapping);\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c43e4e0553eee11cb6c06a84a192fd8828994d6"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njk4Njk4Mw==", "bodyText": "Instead of these contortions, can you try either:\n\nhttps://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/nio/file/Path.html#getParent() or\nhttps://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/io/File.html#getParentFile()", "url": "https://github.com/fcrepo/fcrepo/pull/1603#discussion_r366986983", "createdAt": "2020-01-15T16:48:25Z", "author": {"login": "awoods"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImpl.java", "diffHunk": "@@ -59,15 +86,39 @@ public FedoraOCFLMapping addMapping(final String fedoraResourceIdentifier, final\n         if (mapping == null) {\n             mapping = new FedoraOCFLMapping(fedoraRootObjectResourceId, ocflObjectId);\n             fedoraOCFLMappingMap.put(fedoraRootObjectResourceId, mapping);\n-\n+            writeMappingToDisk(fedoraRootObjectResourceId, mapping);\n         }\n \n         if (!fedoraResourceIdentifier.equals(fedoraRootObjectResourceId)) {\n             fedoraOCFLMappingMap.put(fedoraResourceIdentifier, mapping);\n+            writeMappingToDisk(fedoraResourceIdentifier, mapping);\n         }\n \n         LOGGER.debug(\"added mapping {} for {}\", mapping, fedoraResourceIdentifier);\n         return mapping;\n     }\n \n+    /**\n+     * Write any added mappings to the on-disk index.\n+     * @param fedoraId The internal Fedora identifier.\n+     * @param fedoraOCFLMapping The Fedora to OCFL mapping object.\n+     */\n+    private void writeMappingToDisk(final String fedoraId, final FedoraOCFLMapping fedoraOCFLMapping) {\n+        try {\n+            if (!FEDORA_TO_OCFL_INDEX_FILE.exists()) {\n+                final String dirName = FEDORA_TO_OCFL_INDEX_FILE.toPath().toAbsolutePath().toString().substring(0,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c43e4e0553eee11cb6c06a84a192fd8828994d6"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njk4NzUxNQ==", "bodyText": "Possibly add a logging statement in the case that map.length does not equal 3?", "url": "https://github.com/fcrepo/fcrepo/pull/1603#discussion_r366987515", "createdAt": "2020-01-15T16:49:25Z", "author": {"login": "awoods"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImpl.java", "diffHunk": "@@ -35,10 +42,30 @@\n  */\n @Component\n public class FedoraToOCFLObjectIndexImpl implements FedoraToOCFLObjectIndex {\n+\n     private static Logger LOGGER = LoggerFactory.getLogger(FedoraToOCFLObjectIndexImpl.class);\n \n     private Map<String, FedoraOCFLMapping> fedoraOCFLMappingMap = Collections.synchronizedMap(new HashMap<>());\n \n+    /**\n+     * Constructor\n+     * @throws IOException If we can't access the file.\n+     */\n+    public FedoraToOCFLObjectIndexImpl() throws IOException {\n+        if (FEDORA_TO_OCFL_INDEX_FILE.exists() && FEDORA_TO_OCFL_INDEX_FILE.canRead()) {\n+            Files.lines(FEDORA_TO_OCFL_INDEX_FILE.toPath()).filter(l -> {\n+                final String m = l.split(\"\\t\")[0];\n+                return (!fedoraOCFLMappingMap.containsKey(m));\n+            }).forEach(l -> {\n+                final String[] map = l.split(\"\\t\");\n+                if (map.length == 3) {\n+                    final FedoraOCFLMapping ocflMapping = new FedoraOCFLMapping(map[1], map[2]);\n+                    fedoraOCFLMappingMap.put(map[0], ocflMapping);\n+                }\n+            });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c43e4e0553eee11cb6c06a84a192fd8828994d6"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13dc87a868149a3d15312819b31b11ce92bcbe99", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/13dc87a868149a3d15312819b31b11ce92bcbe99", "committedDate": "2020-01-15T17:08:13Z", "message": "Code review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzMzg1NzI1", "url": "https://github.com/fcrepo/fcrepo/pull/1603#pullrequestreview-343385725", "createdAt": "2020-01-15T17:17:09Z", "commit": {"oid": "13dc87a868149a3d15312819b31b11ce92bcbe99"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84d39f2863944af85fd5ee58e759a54b79ae28c2", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/84d39f2863944af85fd5ee58e759a54b79ae28c2", "committedDate": "2020-01-15T17:26:33Z", "message": "Too long lines"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNDAwMzMw", "url": "https://github.com/fcrepo/fcrepo/pull/1603#pullrequestreview-343400330", "createdAt": "2020-01-15T17:40:23Z", "commit": {"oid": "84d39f2863944af85fd5ee58e759a54b79ae28c2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "860327834bec6747a55e135cf2b887f9d5ebcffc", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/860327834bec6747a55e135cf2b887f9d5ebcffc", "committedDate": "2020-01-15T21:51:16Z", "message": "Remove unneccesary toString"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3197, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}