{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzNDIyMjY0", "number": 1662, "title": "Periodic Transactions garbage collection", "bodyText": "JIRA Ticket: none\nWhat does this Pull Request do?\nFills in periodic cleanup of transactions.\nTransactions are automatically rolled back if they expire.\nClosed transactions will be remain available for retrieving status until their expiration time has passed. For transactions that expire automatically, they will stick around until the next garbage collection.\nWhat's new?\nTransaction cleanup and tests.\nHow should this be tested?\nYou should be able to create a transaction, cancel it, check its status to see that it tells you it was rolled back, and then check its status again after 3 minutes to see that it now gives a 404.\nAdditional Notes:\nSession cleanup timer currently just reuses the session timeout environment variable.\nInterested parties\n@fcrepo4/committers", "createdAt": "2020-04-14T21:25:04Z", "url": "https://github.com/fcrepo/fcrepo/pull/1662", "merged": true, "mergeCommit": {"oid": "37cc1b4b836757b9e75ee52925caa49180afa0f5"}, "closed": true, "closedAt": "2020-04-21T19:26:56Z", "author": {"login": "bbpennel"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXqG4QAH2gAyNDAzNDIyMjY0OmUyZGUyZmZmNjc2ZGMwOWJhYTgxOTQxYTNlZjBlMTMzZmFkMjFmNzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZ41EJAFqTM5NzYwODczNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e2de2fff676dc09baa81941a3ef0e133fad21f79", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/fcrepo/fcrepo/commit/e2de2fff676dc09baa81941a3ef0e133fad21f79", "committedDate": "2020-04-14T21:09:52Z", "message": "Cleanup closed transactions on a regular basis, but only if they have expired. This will also expire and rollback stale transactions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMzQyNjI4", "url": "https://github.com/fcrepo/fcrepo/pull/1662#pullrequestreview-393342628", "createdAt": "2020-04-14T22:36:16Z", "commit": {"oid": "e2de2fff676dc09baa81941a3ef0e133fad21f79"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQyMjozNjoxNlrOGFjZcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQyMjozNjoxNlrOGFjZcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ3NjAxNw==", "bodyText": "Don't we remove the transaction as soon as it is committed or rolled back?", "url": "https://github.com/fcrepo/fcrepo/pull/1662#discussion_r408476017", "createdAt": "2020-04-14T22:36:16Z", "author": {"login": "whikloj"}, "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/TransactionManagerImpl.java", "diffHunk": "@@ -52,10 +54,32 @@\n     private EventAccumulator eventAccumulator;\n \n     TransactionManagerImpl() {\n-        transactions = new HashMap<>();\n+        transactions = new ConcurrentHashMap<>();\n     }\n \n-    // TODO Add a timer to periodically rollback and cleanup expired transaction?\n+    /**\n+     * Periodically scan for closed transactions for cleanup\n+     */\n+    @Scheduled(fixedDelayString = \"#{systemProperties['fcrepo.session.timeout'] ?: 180000}\")\n+    public void cleanupClosedTransactions() {\n+        final var txIt = transactions.entrySet().iterator();\n+        while (txIt.hasNext()) {\n+            final var txEntry = txIt.next();\n+            final var tx = txEntry.getValue();\n+\n+            // Cleanup if transaction is closed and past its expiration time\n+            if (tx.isCommitted() || tx.isRolledBack()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2de2fff676dc09baa81941a3ef0e133fad21f79"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMzQzNjc4", "url": "https://github.com/fcrepo/fcrepo/pull/1662#pullrequestreview-393343678", "createdAt": "2020-04-14T22:38:43Z", "commit": {"oid": "e2de2fff676dc09baa81941a3ef0e133fad21f79"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQyMjozODo0M1rOGFjc9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQyMjozODo0M1rOGFjc9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ3NjkxOA==", "bodyText": "I see now that we are hanging on to transaction regardless of state until the clean up period. Just wondering if there is any value to having those transactions that have been actively committed or rolled back?", "url": "https://github.com/fcrepo/fcrepo/pull/1662#discussion_r408476918", "createdAt": "2020-04-14T22:38:43Z", "author": {"login": "whikloj"}, "path": "fcrepo-kernel-impl/src/test/java/org/fcrepo/kernel/impl/TransactionManagerImplTest.java", "diffHunk": "@@ -88,8 +97,108 @@ public void testGetTransactionWithInvalidID() {\n     }\n \n     @Test(expected = TransactionRuntimeException.class)\n-    public void testGetExpiredTransaction() {\n+    public void testGetExpiredTransaction() throws Exception {\n         testTx.expire();\n-        testTxManager.get(testTx.getId());\n+        try {\n+            testTxManager.get(testTx.getId());\n+        } finally {\n+            // Make sure rollback is triggered\n+            verify(psSession).rollback();\n+        }\n+    }\n+\n+    @Test\n+    public void testCleanupClosedTransactions() {\n+        System.setProperty(TransactionImpl.TIMEOUT_SYSTEM_PROPERTY, \"10000\");\n+\n+        final var commitTx = testTxManager.create();\n+        commitTx.commit();\n+        final var continuingTx = testTxManager.create();\n+        final var rollbackTx = testTxManager.create();\n+        rollbackTx.rollback();\n+\n+        // verify that transactions retrievable before cleanup\n+        try {\n+            testTxManager.get(commitTx.getId());\n+            fail(\"Transaction must be committed\");\n+        } catch(final TransactionClosedException e) {\n+            //expected\n+        }\n+        try {\n+            testTxManager.get(rollbackTx.getId());\n+            fail(\"Transaction must be rolled back\");\n+        } catch(final TransactionClosedException e) {\n+            //expected\n+        }\n+\n+        assertNotNull(\"Continuing transaction must be present\",\n+                testTxManager.get(continuingTx.getId()));\n+\n+        testTxManager.cleanupClosedTransactions();\n+\n+        // Verify that the closed transactions are stick around since they haven't expired yet", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2de2fff676dc09baa81941a3ef0e133fad21f79"}, "originalPosition": 88}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28c1061752b45e8a7d6b645b59f4503781cf4ead", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/fcrepo/fcrepo/commit/28c1061752b45e8a7d6b645b59f4503781cf4ead", "committedDate": "2020-04-21T13:15:57Z", "message": "Add sleep"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NjA4NzM2", "url": "https://github.com/fcrepo/fcrepo/pull/1662#pullrequestreview-397608736", "createdAt": "2020-04-21T19:26:50Z", "commit": {"oid": "28c1061752b45e8a7d6b645b59f4503781cf4ead"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3088, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}