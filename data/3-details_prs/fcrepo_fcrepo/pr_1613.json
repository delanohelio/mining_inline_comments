{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4MTk3NTAw", "number": 1613, "title": "FCREPO-3079 - GET binary", "bodyText": "JIRA Ticket: https://jira.lyrasis.org/browse/FCREPO-3079\nWhat does this Pull Request do?\nEnables retrieval of binaries at the persistence and http layers.\nWhat's new?\n\nImplements getBinaryContent at persistence layer\nReorganization of @get method to skip unnecessary creation of rdf stream when getting binary content, and to separate binary from rdf retrieval, similar to how the HEAD method is organized.\n\nthis included removing binary retrieval from the getContent method, and removing the Range parameter from various API methods that were only receiving it to pass it to getContent (where it was ignored since they didn't retrieve binaries)\n\n\nFix issue with content size of binaries when content disposition is present but no content size specified\nRemoves some more unused binary\nReenables some binary related integration tests\n\nmany still can't be enabled because they depend on PUT\n\n\n\nHow should this be tested?\nVarious tests, and should be able to POST to create a binary with one click, and then perform a GET on it to retrieve the file.\nAdditional Notes:\nStill doesn't support digest related features, and still many binary retrieval integration tests disabled.\nInterested parties\n@fcrepo4/committers", "createdAt": "2020-01-28T19:50:43Z", "url": "https://github.com/fcrepo/fcrepo/pull/1613", "merged": true, "mergeCommit": {"oid": "22ab2e069b28c2481c7c4e1491d087d35d992afd"}, "closed": true, "closedAt": "2020-01-30T15:59:17Z", "author": {"login": "bbpennel"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-1cXTgH2gAyMzY4MTk3NTAwOmIyMDNjYzczNDM4MmExNjkyYjY4MjkwNjdiNjY1ZGU0NDIzMTA2NTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_ctVYgFqTM1MDkzODA0OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b203cc734382a1692b6829067b665de442310656", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/fcrepo/fcrepo/commit/b203cc734382a1692b6829067b665de442310656", "committedDate": "2020-01-28T18:14:11Z", "message": "implement binary retrieve in ocfl sessions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea634ed59ae596bfe2bf91ced02be380e1ac70c9", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/fcrepo/fcrepo/commit/ea634ed59ae596bfe2bf91ced02be380e1ac70c9", "committedDate": "2020-01-28T19:19:01Z", "message": "Reorganization of @GET method to skip unnecessary creation of rdf stream when getting binary content, and to separate binary from rdf retrieval, similar to how the HEAD method is organized. Fix issue with content size of binaries when content disposition is present but no content size specified. Wire up retrieval of binary content."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80c478a99b3c7dec2ccb5ffb75aae053d41ae14e", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/fcrepo/fcrepo/commit/80c478a99b3c7dec2ccb5ffb75aae053d41ae14e", "committedDate": "2020-01-28T19:40:27Z", "message": "Remove unused range parameter from GET methods that don't retrieve binaries, and from the getContent helper method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMTI0MDU2", "url": "https://github.com/fcrepo/fcrepo/pull/1613#pullrequestreview-350124056", "createdAt": "2020-01-29T13:58:57Z", "commit": {"oid": "80c478a99b3c7dec2ccb5ffb75aae053d41ae14e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzo1ODo1N1rOFjJSNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzo1ODo1N1rOFjJSNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM5NjU5Ng==", "bodyText": "Nit-pick, maybe the name should specify that you are mocking a Create NonRdfSource Operation. Eventually we might need one for Update as well.", "url": "https://github.com/fcrepo/fcrepo/pull/1613#discussion_r372396596", "createdAt": "2020-01-29T13:58:57Z", "author": {"login": "whikloj"}, "path": "fcrepo-persistence-ocfl/src/test/java/org/fcrepo/persistence/ocfl/impl/OCFLPersistentStorageSessionTest.java", "diffHunk": "@@ -591,4 +597,97 @@ public void getTriplesFromPreviousVersion() throws Exception {\n         assertEquals(node, retrievedUserStream.topic());\n         assertEquals(dcTitleTriple, retrievedUserStream.findFirst().get());\n     }\n+\n+    @Test\n+    public void getBinaryContent() throws Exception {\n+        mockMappingAndIndex(mintOCFLObjectId(RESOURCE_ID), RESOURCE_ID, ROOT_OBJECT_ID, mapping);\n+\n+        // create the binary\n+        final var binOperation = mockNonRdfSourceOperation(BINARY_CONTENT, USER_PRINCIPAL, RESOURCE_ID);\n+\n+        // perform the create non-rdf source operation\n+        session.persist(binOperation);\n+\n+        // commit to OCFL\n+        session.commit();\n+\n+        // create a new session and verify the returned rdf stream.\n+        final var newSession = createSession(index, objectSessionFactory);\n+        final var result = IOUtils.toString(newSession.getBinaryContent(RESOURCE_ID, null), UTF_8);\n+\n+        assertEquals(BINARY_CONTENT, result);\n+    }\n+\n+    @Test\n+    public void getBinaryContentFailsIfAlreadyCommitted() throws Exception {\n+        mockMappingAndIndex(mintOCFLObjectId(RESOURCE_ID), RESOURCE_ID, ROOT_OBJECT_ID, mapping);\n+\n+        // create the binary\n+        final var binOperation = mockNonRdfSourceOperation(BINARY_CONTENT, USER_PRINCIPAL, RESOURCE_ID);\n+\n+        // perform the create non-rdf source operation\n+        session.persist(binOperation);\n+\n+        // commit to OCFL\n+        session.commit();\n+\n+        try {\n+            session.getBinaryContent(RESOURCE_ID, null);\n+            fail(\"Get must fail due to session having been committed\");\n+        } catch (final PersistentStorageException ex) {\n+            // expected failure, handled with catch since the persist can throw same error\n+        }\n+    }\n+\n+    @Test\n+    public void getBinaryContentVersion() throws Exception {\n+        DefaultOCFLObjectSession.setGlobaDefaultCommitOption(NEW_VERSION);\n+        // SEE getTriplesFromPreviousVersion\n+        mockMappingAndIndex(mintOCFLObjectId(RESOURCE_ID), RESOURCE_ID, ROOT_OBJECT_ID, mapping);\n+\n+        // create the binary\n+        final var binOperation = mockNonRdfSourceOperation(BINARY_CONTENT, USER_PRINCIPAL, RESOURCE_ID);\n+        // perform the create non-rdf source operation\n+        session.persist(binOperation);\n+        // commit to OCFL\n+        session.commit();\n+\n+        // create a new session and verify that the state is the same\n+        final var newSession = createSession(index, objectSessionFactory);\n+\n+        final var versions = newSession.listVersions(RESOURCE_ID);\n+        final var version1 = versions.get(versions.size() - 1);\n+        assertEquals(BINARY_CONTENT,\n+                IOUtils.toString(newSession.getBinaryContent(RESOURCE_ID, version1), UTF_8));\n+    }\n+\n+    @Test\n+    public void getBinaryContentUncommitted() throws Exception {\n+        mockMappingAndIndex(mintOCFLObjectId(RESOURCE_ID), RESOURCE_ID, ROOT_OBJECT_ID, mapping);\n+\n+        // create the binary\n+        final var binOperation = mockNonRdfSourceOperation(BINARY_CONTENT, USER_PRINCIPAL, RESOURCE_ID);\n+\n+        // perform the create non-rdf source operation\n+        session.persist(binOperation);\n+\n+        // create a new session and verify the returned rdf stream.\n+        final var result = IOUtils.toString(session.getBinaryContent(RESOURCE_ID, null), UTF_8);\n+\n+        assertEquals(BINARY_CONTENT, result);\n+    }\n+\n+    private NonRdfSourceOperation mockNonRdfSourceOperation(final String content,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80c478a99b3c7dec2ccb5ffb75aae053d41ae14e"}, "originalPosition": 124}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMTI0OTc1", "url": "https://github.com/fcrepo/fcrepo/pull/1613#pullrequestreview-350124975", "createdAt": "2020-01-29T14:00:10Z", "commit": {"oid": "80c478a99b3c7dec2ccb5ffb75aae053d41ae14e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNDowMDoxMVrOFjJU5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNDowMDoxMVrOFjJU5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM5NzI4NQ==", "bodyText": "Should this not take a transaction? What if the binary is created and then GETted inside a single long-running transaction?", "url": "https://github.com/fcrepo/fcrepo/pull/1613#discussion_r372397285", "createdAt": "2020-01-29T14:00:11Z", "author": {"login": "whikloj"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/OCFLPersistentStorageSession.java", "diffHunk": "@@ -253,9 +254,16 @@ public RdfStream getTriples(final String identifier, final Instant version)\n \n     @Override\n     public InputStream getBinaryContent(final String identifier, final Instant version)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80c478a99b3c7dec2ccb5ffb75aae053d41ae14e"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwOTM4MDE3", "url": "https://github.com/fcrepo/fcrepo/pull/1613#pullrequestreview-350938017", "createdAt": "2020-01-30T15:59:00Z", "commit": {"oid": "80c478a99b3c7dec2ccb5ffb75aae053d41ae14e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwOTM4MDQ5", "url": "https://github.com/fcrepo/fcrepo/pull/1613#pullrequestreview-350938049", "createdAt": "2020-01-30T15:59:01Z", "commit": {"oid": "80c478a99b3c7dec2ccb5ffb75aae053d41ae14e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3210, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}