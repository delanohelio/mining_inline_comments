{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzMDc0MDkx", "number": 1698, "title": "start work centralizing config props and add fcrepo.home", "bodyText": "JIRA Ticket: https://jira.lyrasis.org/browse/FCREPO-3337\nWhat does this Pull Request do?\nRemoves the following properties:\n\nfcrepo.ocfl.storage.root.dir\nfcrepo.ocfl.staging.dir\nfcrepo.ocfl.work.dir\n\nAdds:\n\nfcrepo.home (Default: ./fcrepo)\nfcrepo.ocfl.staging (Default: ${fcrepo.home}/data/staging)\nfcrepo.ocfl.root (Default: ${fcrepo.home}/data/ocfl-root)\nfcrepo.ocfl.temp (Default: ${fcrepo.home}/data/ocfl-temp)\n\nRepurposes fcrepo-configs as a module that is intended to contain all fcrepo configuration properties, and uses fcrepo.home to default the locations of OCFL related directories.\nBy default, fcrepo.home is configured to be the fcrepo directory in the current working directory. For Maven related activities, it's configured to point at target/fcrepo-home.\nHow should this be tested?\nBuild everything and run mvn jetty:run in fcrepo-webapp. You should see Fedora using target/fcrepo-home.\nRun mvn -Dfcrepo.home=/var/tmp/fcrepo-home jetty:run. You should see Fedora using /var/tmp/fcrepo-home.\nSame things also work with one-click and Tomcat.\nAdditionally, any of the other new properties that are based on fcrepo.home can be overriden individually.\nInterested parties\n@fcrepo4/committers", "createdAt": "2020-06-11T13:22:38Z", "url": "https://github.com/fcrepo/fcrepo/pull/1698", "merged": true, "mergeCommit": {"oid": "5806d1c44368b57d26fb61152a59d01c114ed1b2"}, "closed": true, "closedAt": "2020-06-19T01:06:18Z", "author": {"login": "pwinckles"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqN_rKgH2gAyNDMzMDc0MDkxOmUzZmY1ZmE3YzA3OTAzNThkZDliOWUwNTc4NjljMjA1ODJhZTA5Yjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsoZyPgFqTQzMzczOTQxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e3ff5fa7c0790358dd9b9e057869c20582ae09b9", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/e3ff5fa7c0790358dd9b9e057869c20582ae09b9", "committedDate": "2020-06-11T13:09:13Z", "message": "start work centralizing config props"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4OTYzOTYw", "url": "https://github.com/fcrepo/fcrepo/pull/1698#pullrequestreview-428963960", "createdAt": "2020-06-11T14:23:26Z", "commit": {"oid": "e3ff5fa7c0790358dd9b9e057869c20582ae09b9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNDoyNDozM1rOGifyJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNDo0NTo1NFrOGigtLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgyNTUwOQ==", "bodyText": "Have you tested these with IntelliJ and Eclipse? It would be good to get @bbpennel 's sign-off.", "url": "https://github.com/fcrepo/fcrepo/pull/1698#discussion_r438825509", "createdAt": "2020-06-11T14:24:33Z", "author": {"login": "awoods"}, "path": "fcrepo-configs/src/main/java/org/fcrepo/config/FedoraPropsConfig.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Licensed to DuraSpace under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional information\n+ * regarding copyright ownership.\n+ *\n+ * DuraSpace licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except in\n+ * compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.fcrepo.config;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Configuration;\n+\n+import javax.annotation.PostConstruct;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+\n+/**\n+ * General Fedora properties\n+ */\n+@Configuration\n+public class FedoraPropsConfig {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(FedoraPropsConfig.class);\n+\n+    private static final String DATA_DIR = \"data\";\n+\n+    @Value(\"${fcrepo.home:fcrepo}\")\n+    private Path fedoraHome;\n+\n+    @Value(\"#{fedoraPropsConfig.fedoraHome.resolve('\" + DATA_DIR + \"')}\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3ff5fa7c0790358dd9b9e057869c20582ae09b9"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgyNzE4Mw==", "bodyText": "Please add @author javadoc... and ideally, @since 2020-06-11.\nOur checkstyle used to enforce the @author... not sure why that is no longer working, hmm.", "url": "https://github.com/fcrepo/fcrepo/pull/1698#discussion_r438827183", "createdAt": "2020-06-11T14:26:52Z", "author": {"login": "awoods"}, "path": "fcrepo-configs/src/main/java/org/fcrepo/config/FedoraPropsConfig.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Licensed to DuraSpace under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional information\n+ * regarding copyright ownership.\n+ *\n+ * DuraSpace licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except in\n+ * compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.fcrepo.config;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Configuration;\n+\n+import javax.annotation.PostConstruct;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+\n+/**\n+ * General Fedora properties\n+ */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3ff5fa7c0790358dd9b9e057869c20582ae09b9"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgyNzI5MA==", "bodyText": "Please add @author javadoc... and ideally, @since 2020-06-11.", "url": "https://github.com/fcrepo/fcrepo/pull/1698#discussion_r438827290", "createdAt": "2020-06-11T14:27:02Z", "author": {"login": "awoods"}, "path": "fcrepo-configs/src/main/java/org/fcrepo/config/OcflPropsConfig.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to DuraSpace under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional information\n+ * regarding copyright ownership.\n+ *\n+ * DuraSpace licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except in\n+ * compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.fcrepo.config;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Configuration;\n+\n+import javax.annotation.PostConstruct;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+\n+/**\n+ * Fedora's OCFL related configuration properties", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3ff5fa7c0790358dd9b9e057869c20582ae09b9"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgyNzkzNg==", "bodyText": "Normally I do not like the logs to be too chatty... but these three messages are important to see at startup.\nCan you change them to LOGGER.info()?", "url": "https://github.com/fcrepo/fcrepo/pull/1698#discussion_r438827936", "createdAt": "2020-06-11T14:27:54Z", "author": {"login": "awoods"}, "path": "fcrepo-configs/src/main/java/org/fcrepo/config/OcflPropsConfig.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to DuraSpace under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional information\n+ * regarding copyright ownership.\n+ *\n+ * DuraSpace licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except in\n+ * compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.fcrepo.config;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Configuration;\n+\n+import javax.annotation.PostConstruct;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+\n+/**\n+ * Fedora's OCFL related configuration properties\n+ */\n+@Configuration\n+public class OcflPropsConfig {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(OcflPropsConfig.class);\n+\n+    private static final String OCFL_STAGING = \"staging\";\n+    private static final String OCFL_ROOT = \"ocfl-root\";\n+    private static final String OCFL_TEMP = \"ocfl-temp\";\n+\n+    @Value(\"${fcrepo.ocfl.staging:#{fedoraPropsConfig.fedoraData.resolve('\" + OCFL_STAGING + \"')}}\")\n+    private Path fedoraOcflStaging;\n+\n+    @Value(\"${fcrepo.ocfl.root:#{fedoraPropsConfig.fedoraData.resolve('\" + OCFL_ROOT + \"')}}\")\n+    private Path ocflRepoRoot;\n+\n+    @Value(\"${fcrepo.ocfl.temp:#{fedoraPropsConfig.fedoraData.resolve('\" + OCFL_TEMP + \"')}}\")\n+    private Path ocflTemp;\n+\n+    @PostConstruct\n+    private void postConstruct() throws IOException {\n+        LOGGER.debug(\"Fedora staging: {}\", fedoraOcflStaging);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3ff5fa7c0790358dd9b9e057869c20582ae09b9"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgzMDE1MA==", "bodyText": "Would it make sense to define this constant statically on OcflPropsConfig.java?", "url": "https://github.com/fcrepo/fcrepo/pull/1698#discussion_r438830150", "createdAt": "2020-06-11T14:30:49Z", "author": {"login": "awoods"}, "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/RebuildIT.java", "diffHunk": "@@ -57,28 +54,20 @@\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(RebuildIT.class);\n \n-    private static String origStorageRootDir;\n-    private static String origWorkDir;\n+    private static final String OCFL_ROOT_PROP = \"fcrepo.ocfl.root\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3ff5fa7c0790358dd9b9e057869c20582ae09b9"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgzMDk4OQ==", "bodyText": "Is there a potential need to reset the value of this property to what it was before this test?", "url": "https://github.com/fcrepo/fcrepo/pull/1698#discussion_r438830989", "createdAt": "2020-06-11T14:32:01Z", "author": {"login": "awoods"}, "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/RebuildIT.java", "diffHunk": "@@ -57,28 +54,20 @@\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(RebuildIT.class);\n \n-    private static String origStorageRootDir;\n-    private static String origWorkDir;\n+    private static final String OCFL_ROOT_PROP = \"fcrepo.ocfl.root\";\n \n     private OcflRepository ocflRepository;\n \n     private IndexBuilder indexBuilder;\n \n     @BeforeClass\n     public static void beforeClass() {\n-        // Save the pre-test System Property values\n-        origStorageRootDir = getProperty(OCFL_STORAGE_ROOT_DIR_KEY);\n-        origWorkDir = getProperty(OCFL_WORK_DIR_KEY);\n-\n-        System.setProperty(OCFL_STORAGE_ROOT_DIR_KEY, \"target/test-classes/test-rebuild-ocfl/ocfl-root\");\n-        System.setProperty(OCFL_WORK_DIR_KEY, \"target/test-classes/test-rebuild-ocfl/ocfl-work\");\n+        System.setProperty(OCFL_ROOT_PROP, \"target/test-classes/test-rebuild-ocfl/ocfl-root\");\n     }\n \n     @AfterClass\n     public static void afterClass() {\n-        // Restore pre-test System Property values\n-        System.setProperty(OCFL_STORAGE_ROOT_DIR_KEY, origStorageRootDir);\n-        System.setProperty(OCFL_WORK_DIR_KEY, origWorkDir);\n+        System.clearProperty(OCFL_ROOT_PROP);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3ff5fa7c0790358dd9b9e057869c20582ae09b9"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgzOTc4MA==", "bodyText": "Maybe reduce this logging to debug, in favor of the cleaner output of OcflPropsConfig.", "url": "https://github.com/fcrepo/fcrepo/pull/1698#discussion_r438839780", "createdAt": "2020-06-11T14:44:46Z", "author": {"login": "awoods"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DefaultOCFLObjectSessionFactory.java", "diffHunk": "@@ -52,39 +56,36 @@\n     @Value(\"${fcrepo.autoversioning.enabled:true}\")\n     private boolean autoVersioningEnabled;\n \n-    private File ocflStagingDir;\n+    private final Path ocflStagingDir;\n \n     @Inject\n     private MutableOcflRepository ocflRepository;\n \n-    /**\n-     * Default Constructor.  You can set the ocfl staging, storage root, and work directories by setting the following\n-     * system properties: fcrepo.ocfl.staging.dir, fcrepo.ocfl.storage.root.dir, and  fcrepo.ocfl.work.dir.  If these\n-     * are not set, default directories will be created in java.io.tmpdir.\n-     */\n-    public DefaultOCFLObjectSessionFactory() {\n-        this(new OCFLConstants().getStagingDir());\n-    }\n-\n     /**\n      * Constructor\n      *\n      * @param ocflStagingDir     The OCFL staging directory\n      */\n-    public DefaultOCFLObjectSessionFactory(final File ocflStagingDir) {\n+    @Autowired\n+    public DefaultOCFLObjectSessionFactory(\n+            @Value(\"#{ocflPropsConfig.fedoraOcflStaging}\")\n+            final Path ocflStagingDir) {\n         LOGGER.info(\"Fedora OCFL persistence staging directory:\\n- {}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3ff5fa7c0790358dd9b9e057869c20582ae09b9"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg0MDYyMA==", "bodyText": "Maybe reduce this logging to debug, in favor of the cleaner output of OcflPropsConfig.", "url": "https://github.com/fcrepo/fcrepo/pull/1698#discussion_r438840620", "createdAt": "2020-06-11T14:45:54Z", "author": {"login": "awoods"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/OCFLPersistentStorageUtils.java", "diffHunk": "@@ -385,15 +386,16 @@ public static String mintOCFLObjectId(final String fedoraIdentifier) {\n      * @param ocflWorkDir The ocfl work directory\n      * @return the repository\n      */\n-    public static MutableOcflRepository createRepository(final File ocflStorageRootDir, final File ocflWorkDir) {\n-        ocflStorageRootDir.mkdirs();\n-        ocflWorkDir.mkdirs();\n+    public static MutableOcflRepository createRepository(final Path ocflStorageRootDir, final Path ocflWorkDir)\n+            throws IOException {\n+        Files.createDirectories(ocflStorageRootDir);\n+        Files.createDirectories(ocflWorkDir);\n \n         log.info(\"Fedora OCFL persistence directories:\\n- {}\\n- {}\", ocflStorageRootDir, ocflWorkDir);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3ff5fa7c0790358dd9b9e057869c20582ae09b9"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ef95b8152e9a7e9f69620cde8a44a1d0e3644e9", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/4ef95b8152e9a7e9f69620cde8a44a1d0e3644e9", "committedDate": "2020-06-11T15:42:37Z", "message": "pr comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNzM5NDE5", "url": "https://github.com/fcrepo/fcrepo/pull/1698#pullrequestreview-433739419", "createdAt": "2020-06-19T01:03:07Z", "commit": {"oid": "4ef95b8152e9a7e9f69620cde8a44a1d0e3644e9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3141, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}