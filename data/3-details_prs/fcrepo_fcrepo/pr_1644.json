{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2MjI2OTA2", "number": 1644, "title": "added support for retrieving mementos", "bodyText": "JIRA Ticket: FCREPO-3245\nWhat does this Pull Request do?\nAdds the ability to retrieve mementos.\nHow should this be tested?\nTest script:\n# Create an AG\ncurl -u fedoraAdmin:fedoraAdmin http://localhost:8080/rest/version-test-3 -H'Link: <http://www.w3.org/ns/ldp#BasicContainer>;rel=\"type\"' -H'Link: <http://fedora.info/definitions/v4/repository#ArchivalGroup>;rel=\"type\"' -v -H \"Content-Type: text/turtle\" -X PUT --data \"<> <http://purl.org/dc/elements/1.1/title> 'AG Parent'\"\n\n# Create a child of the AG\ncurl -u fedoraAdmin:fedoraAdmin http://localhost:8080/rest/version-test-3/child1 -H \"Link: <http://www.w3.org/ns/ldp#NonRDFSource>; rel=type\" -v -H \"Content-Type: text/plain\" -X PUT --data-binary \"testing\"\n\n# Attempt to find a memento\ncurl -u fedoraAdmin:fedoraAdmin -H \"Accept: text/turtle\" -H \"Accept-Datetime: Mon, 09 Mar 2020 17:00:00 GMT\" -v http://localhost:8080/rest/version-test-3\n\n< HTTP/1.1 406 Not Acceptable\n< Set-Cookie: JSESSIONID=node01k7b201ep5d6r153a2qwcopxcy2.node0; Path=/\n< Set-Cookie: rememberMe=deleteMe; Path=/; Max-Age=0; Expires=Mon, 09-Mar-2020 14:56:57 GMT\n< Link: <http://www.w3.org/ns/ldp#Resource>;rel=\"type\"\n< Link: <http://fedora.info/definitions/v4/repository#ArchivalGroup>;rel=\"type\"\n< Link: <http://www.w3.org/ns/ldp#Container>;rel=\"type\"\n< Link: <http://www.w3.org/ns/ldp#RDFSource>; rel=\"type\"\n< Link: <http://www.w3.org/ns/ldp#BasicContainer>;rel=\"type\"\n< Link: <http://localhost:8080/rest/version-test-3>; rel=\"timegate\"\n< Link: <http://localhost:8080/rest/version-test-3>; rel=\"original\"\n< Link: <http://localhost:8080/rest/version-test-3/fcr:versions>; rel=\"timemap\"\n< Link: <http://mementoweb.org/ns#OriginalResource>; rel=\"type\"\n< Link: <http://mementoweb.org/ns#TimeGate>; rel=\"type\"\n< Accept-External-Content-Handling: copy,redirect,proxy\n< Accept-Patch: application/sparql-update\n< Accept-Post: text/turtle,text/rdf+n3,text/n3,application/rdf+xml,application/n-triples,application/ld+json\n< Allow: MOVE,COPY,DELETE,POST,HEAD,GET,PUT,PATCH,OPTIONS\n< Link: <http://localhost:8080/rest/version-test-3/fcr:acl>; rel=\"acl\"\n< Preference-Applied: return=representation\n< Cache-Control: must-revalidate,no-cache,no-store\n< Content-Length: 0\n< Server: Jetty(9.4.24.v20191120)\n\n# Create a memento\ncurl -u fedoraAdmin:fedoraAdmin -X POST -v http://localhost:8080/rest/version-test-3/fcr:versions\n\n# Find a memento\ncurl -u fedoraAdmin:fedoraAdmin -H \"Accept: text/turtle\" -H \"Accept-Datetime: Mon, 09 Mar 2020 17:00:00 GMT\" -v http://localhost:8080/rest/version-test-3\n\n< HTTP/1.1 302 Found\n< Date: Tue, 10 Mar 2020 14:59:48 GMT\n< Set-Cookie: JSESSIONID=node07umaoh56bopz184qx3zggro8f5.node0; Path=/\n< Expires: Thu, 01 Jan 1970 00:00:00 GMT\n< Set-Cookie: rememberMe=deleteMe; Path=/; Max-Age=0; Expires=Mon, 09-Mar-2020 14:59:48 GMT\n< Link: <http://www.w3.org/ns/ldp#Resource>;rel=\"type\"\n< Link: <http://fedora.info/definitions/v4/repository#ArchivalGroup>;rel=\"type\"\n< Link: <http://www.w3.org/ns/ldp#Container>;rel=\"type\"\n< Link: <http://www.w3.org/ns/ldp#RDFSource>; rel=\"type\"\n< Link: <http://www.w3.org/ns/ldp#BasicContainer>;rel=\"type\"\n< Link: <http://localhost:8080/rest/version-test-3>; rel=\"timegate\"\n< Link: <http://localhost:8080/rest/version-test-3>; rel=\"original\"\n< Link: <http://localhost:8080/rest/version-test-3/fcr:versions>; rel=\"timemap\"\n< Link: <http://mementoweb.org/ns#OriginalResource>; rel=\"type\"\n< Link: <http://mementoweb.org/ns#TimeGate>; rel=\"type\"\n< Accept-External-Content-Handling: copy,redirect,proxy\n< Accept-Patch: application/sparql-update\n< Accept-Post: text/turtle,text/rdf+n3,text/n3,application/rdf+xml,application/n-triples,application/ld+json\n< Allow: MOVE,COPY,DELETE,POST,HEAD,GET,PUT,PATCH,OPTIONS\n< Link: <http://localhost:8080/rest/version-test-3/fcr:acl>; rel=\"acl\"\n< Preference-Applied: return=representation\n< Vary: Prefer\n< Vary: Accept\n< Vary: Range\n< Vary: Accept-Encoding\n< Vary: Accept-Language\n< Vary: Accept-Datetime\n< Location: http://localhost:8080/rest/version-test-3/fcr:versions/20200310145927\n< Content-Length: 0\n< Server: Jetty(9.4.24.v20191120)\n\n# Retrieve AG memento\ncurl -u fedoraAdmin:fedoraAdmin -H \"Accept: text/turtle\" -v http://localhost:8080/rest/version-test-3/fcr:versions/20200310145927\n\n<info:fedora/version-test-3>\n        dc:title             \"AG Parent\" ;\n        rdf:type             ldp:RDFSource ;\n        fedora:created       \"2020-03-10T14:56:24.560756Z\" ;\n        fedora:lastModified  \"2020-03-10T14:56:24.560756Z\" ;\n        rdf:type             ldp:BasicContainer ;\n        rdf:type             fedora:ArchivalGroup .\n\t\t\n# Retrieve child memento\ncurl -u fedoraAdmin:fedoraAdmin -v http://localhost:8080/rest/version-test-3/child1/fcr:versions/20200310145927\n\n< HTTP/1.1 200 OK\n< Date: Tue, 10 Mar 2020 15:24:49 GMT\n< Set-Cookie: JSESSIONID=node0zapulvibku6wfrke08ex49wv1.node0; Path=/\n< Expires: Thu, 01 Jan 1970 00:00:00 GMT\n< Set-Cookie: rememberMe=deleteMe; Path=/; Max-Age=0; Expires=Mon, 09-Mar-2020 15:24:49 GMT\n< ETag: \"7494DAE3016C368D7773144D0CCC929F\"\n< X-State-Token: 7494DAE3016C368D7773144D0CCC929F\n< Last-Modified: Tue, 10 Mar 2020 14:56:43 GMT\n< Content-Type: text/plain\n< Accept-Ranges: bytes\n< Content-Disposition: attachment; filename=\"\"; creation-date=\"Tue, 10 Mar 2020 14:56:43 GMT\"; modification-date=\"Tue, 10 Mar 2020 14:56:43 GMT\"; size=7\n< Link: <http://www.w3.org/ns/ldp#Resource>;rel=\"type\"\n< Link: <http://www.w3.org/ns/ldp#NonRDFSource>;rel=\"type\"\n< Link: <http://localhost:8080/rest/version-test-3/child1/fcr:metadata>; rel=\"describedby\"\n< Link: <http://localhost:8080/rest/version-test-3/child1>; rel=\"timegate\"\n< Link: <http://localhost:8080/rest/version-test-3/child1>; rel=\"original\"\n< Link: <http://localhost:8080/rest/version-test-3/child1/fcr:versions>; rel=\"timemap\"\n< Accept-External-Content-Handling: copy,redirect,proxy\n< Allow: GET,HEAD,OPTIONS,DELETE\n< Memento-Datetime: Tue, 10 Mar 2020 14:59:27 GMT\n< Link: <http://mementoweb.org/ns#Memento>; rel=\"type\"\n< Cache-Control: no-transform, must-revalidate, max-age=0\n< Content-Length: 7\n< Server: Jetty(9.4.24.v20191120)\n< \n* Connection #0 to host localhost left intact\ntesting\n\n# Update the child\ncurl -u fedoraAdmin:fedoraAdmin http://localhost:8080/rest/version-test-3/child1 -H \"Link: <http://www.w3.org/ns/ldp#NonRDFSource>; rel=type\" -v -H \"Content-Type: text/plain\" -X PUT --data-binary \"updated\"\n\n# Create a new memento\ncurl -u fedoraAdmin:fedoraAdmin -X POST -v http://localhost:8080/rest/version-test-3/fcr:versions\n\n# Retrieve the original memento\ncurl -u fedoraAdmin:fedoraAdmin -v http://localhost:8080/rest/version-test-3/child1/fcr:versions/20200310145927\n\ntesting\n\n# Retrieve the new memento\ncurl -u fedoraAdmin:fedoraAdmin -v http://localhost:8080/rest/version-test-3/child1/fcr:versions/20200310153910\n\nupdated\n\nSame outputs from F5:\ncurl -u fedoraAdmin:fedoraAdmin -H \"Accept: text/turtle\" -H \"Accept-Datetime: Mon, 09 Mar 2020 17:00:00 GMT\" -v http://localhost:8080/rest/version-test-3\n\n< HTTP/1.1 406 Not Acceptable\n< Date: Tue, 10 Mar 2020 15:28:44 GMT\n< Link: <http://www.w3.org/ns/ldp#Resource>;rel=\"type\"\n< Link: <http://www.w3.org/ns/ldp#Container>;rel=\"type\"\n< Link: <http://www.w3.org/ns/ldp#RDFSource>; rel=\"type\"\n< Link: <http://www.w3.org/ns/ldp#BasicContainer>;rel=\"type\"\n< Link: <http://localhost:8080/rest/version-test-3>; rel=\"timegate\"\n< Link: <http://localhost:8080/rest/version-test-3>; rel=\"original\"\n< Link: <http://localhost:8080/rest/version-test-3/fcr:versions>; rel=\"timemap\"\n< Link: <http://mementoweb.org/ns#OriginalResource>; rel=\"type\"\n< Link: <http://mementoweb.org/ns#TimeGate>; rel=\"type\"\n< Accept-External-Content-Handling: copy,redirect,proxy\n< Accept-Patch: application/sparql-update\n< Accept-Post: text/turtle,text/rdf+n3,text/n3,application/rdf+xml,application/n-triples,application/ld+json\n< Allow: MOVE,COPY,DELETE,POST,HEAD,GET,PUT,PATCH,OPTIONS\n< Link: <http://localhost:8080/rest/version-test-3/fcr:acl>; rel=\"acl\"\n< Preference-Applied: return=representation\n< Vary: Prefer\n< Vary: Accept\n< Vary: Range\n< Vary: Accept-Encoding\n< Vary: Accept-Language\n< Vary: Accept-Datetime\n< Cache-Control: must-revalidate,no-cache,no-store\n< Content-Length: 0\n< Server: Jetty(9.3.25.v20180904)\n\n\ncurl -u fedoraAdmin:fedoraAdmin -H \"Accept: text/turtle\" -H \"Accept-Datetime: Mon, 09 Mar 2020 17:00:00 GMT\" -v http://localhost:8080/rest/version-test-3\n\n< HTTP/1.1 302 Found\n< Date: Tue, 10 Mar 2020 15:30:14 GMT\n< Link: <http://www.w3.org/ns/ldp#Resource>;rel=\"type\"\n< Link: <http://www.w3.org/ns/ldp#Container>;rel=\"type\"\n< Link: <http://www.w3.org/ns/ldp#RDFSource>; rel=\"type\"\n< Link: <http://www.w3.org/ns/ldp#BasicContainer>;rel=\"type\"\n< Link: <http://localhost:8080/rest/version-test-3>; rel=\"timegate\"\n< Link: <http://localhost:8080/rest/version-test-3>; rel=\"original\"\n< Link: <http://localhost:8080/rest/version-test-3/fcr:versions>; rel=\"timemap\"\n< Link: <http://mementoweb.org/ns#OriginalResource>; rel=\"type\"\n< Link: <http://mementoweb.org/ns#TimeGate>; rel=\"type\"\n< Accept-External-Content-Handling: copy,redirect,proxy\n< Accept-Patch: application/sparql-update\n< Accept-Post: text/turtle,text/rdf+n3,text/n3,application/rdf+xml,application/n-triples,application/ld+json\n< Allow: MOVE,COPY,DELETE,POST,HEAD,GET,PUT,PATCH,OPTIONS\n< Link: <http://localhost:8080/rest/version-test-3/fcr:acl>; rel=\"acl\"\n< Preference-Applied: return=representation\n< Vary: Prefer\n< Vary: Accept\n< Vary: Range\n< Vary: Accept-Encoding\n< Vary: Accept-Language\n< Vary: Accept-Datetime\n< Location: http://localhost:8080/rest/version-test-3/fcr:versions/20200310152937\n< Content-Length: 0\n< Server: Jetty(9.3.25.v20180904)\n\n\ncurl -u fedoraAdmin:fedoraAdmin -H \"Accept: text/turtle\" -v http://localhost:8080/rest/version-test-3/fcr:versions/20200310152937\n\n<http://localhost:8080/rest/version-test-3>\n        rdf:type               fedora:Container ;\n        rdf:type               ldp:RDFSource ;\n        rdf:type               ldp:Container ;\n        rdf:type               fedora:Resource ;\n        rdf:type               ldp:BasicContainer ;\n        fedora:created         \"2020-03-10T15:27:24.684Z\"^^<http://www.w3.org/2001/XMLSchema#dateTime> ;\n        ldp:contains           <http://localhost:8080/rest/version-test-3/child1> ;\n        dc:title               \"AG Parent\" ;\n        fedora:lastModified    \"2020-03-10T15:27:40.661Z\"^^<http://www.w3.org/2001/XMLSchema#dateTime> ;\n        fedora:lastModifiedBy  \"bypassAdmin\" ;\n        fedora:createdBy       \"bypassAdmin\" .\n\nInterested parties\n@awoods", "createdAt": "2020-03-10T16:09:10Z", "url": "https://github.com/fcrepo/fcrepo/pull/1644", "merged": true, "mergeCommit": {"oid": "f98179c30dfdc309383b2ebb1a97c5c94da39a47"}, "closed": true, "closedAt": "2020-03-19T17:03:48Z", "author": {"login": "pwinckles"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMrUTWAH2gAyMzg2MjI2OTA2OjRhN2RiYzY2MDgwZDdhYmVjMWE1ZTQ2ZjIyNDVjYjAxZjI1ODU5YmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPNGZdAFqTM3Nzc5NDc0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4a7dbc66080d7abec1a5e46f2245cb01f25859bd", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/4a7dbc66080d7abec1a5e46f2245cb01f25859bd", "committedDate": "2020-03-11T18:21:16Z", "message": "added support for retrieving mementos"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3e1bb65fe1481ecc6b759872817153c6c5e325f9", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/3e1bb65fe1481ecc6b759872817153c6c5e325f9", "committedDate": "2020-03-10T15:53:42Z", "message": "added support for retrieving mementos"}, "afterCommit": {"oid": "4a7dbc66080d7abec1a5e46f2245cb01f25859bd", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/4a7dbc66080d7abec1a5e46f2245cb01f25859bd", "committedDate": "2020-03-11T18:21:16Z", "message": "added support for retrieving mementos"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczODY1MTcz", "url": "https://github.com/fcrepo/fcrepo/pull/1644#pullrequestreview-373865173", "createdAt": "2020-03-12T20:06:19Z", "commit": {"oid": "4a7dbc66080d7abec1a5e46f2245cb01f25859bd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQyMDowNjoxOVrOF1ti9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQyMjo0NDo0NlrOF1yZUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg2NTA3Ng==", "bodyText": "The MEMENTO_DATETIME_HEADER value should be the time that the memento was created, no?\nIn which case, it may not align on the same second boundary as now(). Or am I misunderstanding the logic?", "url": "https://github.com/fcrepo/fcrepo/pull/1644#discussion_r391865076", "createdAt": "2020-03-12T20:06:19Z", "author": {"login": "awoods"}, "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraVersioningIT.java", "diffHunk": "@@ -249,6 +247,26 @@ public void getTimeMapFromAgWithChildrenWithDifferentVersions() throws Exception\n         }\n     }\n \n+    @Test\n+    public void getMementoFromAgChild() throws Exception {\n+        final var childId1 = id + \"/child1\";\n+\n+        createVersionedArchivalGroup(id);\n+        createMemento(subjectUri);\n+        TimeUnit.SECONDS.sleep(1);\n+\n+        putVersionedBinary(childId1, OCTET_STREAM_TYPE, \"v2\", false);\n+        final var mementoUri = createMemento(subjectUri);\n+        final var mementoTime = mementoUri.substring(mementoUri.lastIndexOf(\"/\"));\n+\n+        final HttpGet httpGet = new HttpGet(subjectUri + \"/child1/fcr:versions\" + mementoTime);\n+        try (final CloseableHttpResponse response = execute(httpGet)) {\n+            assertMementoDatetimeHeaderMatches(response, now());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a7dbc66080d7abec1a5e46f2245cb01f25859bd"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg3MTAxOA==", "bodyText": "The content-type provided during creation (above) is OCTET_STREAM_TYPE... which is the content-type that is being verified in this assertion. What is the comment (\"Content-type is not retained for a binary memento created without description\") intending to mean, exactly?... because it appears that the content-type is retained.", "url": "https://github.com/fcrepo/fcrepo/pull/1644#discussion_r391871018", "createdAt": "2020-03-12T20:16:15Z", "author": {"login": "awoods"}, "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraVersioningIT.java", "diffHunk": "@@ -989,52 +926,35 @@ public void testCreateVersionOfBinary() throws Exception {\n         }\n     }\n \n-    @Ignore(\"get memento not implemented\")\n     @Test\n-    public void testCreateVersionOfBinaryWithDatetimeAndContentType() throws Exception {\n+    public void testCreateVersionOfBinaryWithDatetimeAndBody() throws Exception {\n         createVersionedBinary(id);\n \n         final String mementoUri = createMemento(subjectUri);\n+        final String v1Time = now();\n         assertMementoUri(mementoUri, subjectUri);\n \n-        // Verify that the memento has the updated binary\n-        try (final CloseableHttpResponse response = execute(new HttpGet(mementoUri))) {\n-            assertMementoDatetimeHeaderMatches(response, MEMENTO_DATETIME);\n+        TimeUnit.SECONDS.sleep(1);\n \n-            assertEquals(\"Binary content of memento must be empty\",\n-                    \"\", EntityUtils.toString(response.getEntity()));\n-            assertEquals(OCTET_STREAM_TYPE, response.getFirstHeader(CONTENT_TYPE).getValue());\n-        }\n-    }\n+        putVersionedBinary(id, OCTET_STREAM_TYPE, BINARY_UPDATED, true);\n \n-    @Ignore(\"get memento not implemented\")\n-    @Test\n-    public void testCreateVersionOfBinaryWithBody() throws Exception {\n-        createVersionedBinary(id);\n+        final String mementoUri2 = createMemento(subjectUri);\n+        final String v2Time = now();\n+        assertMementoUri(mementoUri2, subjectUri);\n \n-        final String mementoUri = createMemento(subjectUri);\n-        assertMementoUri(mementoUri, subjectUri);\n+        // Verify that the memento has the updated binary\n+        try (final CloseableHttpResponse response = execute(new HttpGet(mementoUri))) {\n+            assertMementoDatetimeHeaderMatches(response, v1Time);\n \n-        final HttpGet httpGet = new HttpGet(mementoUri);\n-        try (final CloseableHttpResponse response = execute(httpGet)) {\n-            assertMementoDatetimeHeaderPresent(response);\n+            // Content-type is not retained for a binary memento created without description", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a7dbc66080d7abec1a5e46f2245cb01f25859bd"}, "originalPosition": 306}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg3MzM2MQ==", "bodyText": "Recognizing that this is not a change that you introduced, but I wonder if for clarity it would be more readable/consistent to pass the id into the createLDPRSMementoWithExistingBody() method.", "url": "https://github.com/fcrepo/fcrepo/pull/1644#discussion_r391873361", "createdAt": "2020-03-12T20:21:23Z", "author": {"login": "awoods"}, "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraVersioningIT.java", "diffHunk": "@@ -573,13 +517,10 @@ public void testHeadOnMemento() throws Exception {\n         checkResponseWithInvalidMementoID(headMethodInvalid);\n     }\n \n-    @Ignore //TODO Fix this test\n     @Test\n     public void testGetOnMemento() throws Exception {\n \n         createVersionedContainer(id);\n-        final String mementoDateTime =\n-            MEMENTO_RFC_1123_FORMATTER.format(ISO_INSTANT.parse(\"2017-06-10T11:41:00Z\", Instant::from));\n         final String mementoUri = createLDPRSMementoWithExistingBody();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a7dbc66080d7abec1a5e46f2245cb01f25859bd"}, "originalPosition": 201}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg4MTA3Ng==", "bodyText": "The test here creates two versions (version1Uri and version2Uri) with request1Datetime in between. Then the assertion on line 1155 ensures that the second memento is located. I would have thought that version1Uri would have been located since it precedes the request1Datetime.\n\nhttps://mementoweb.org/guide/rfc/#overview-datetime-conneg\nhttps://wiki.lyrasis.org/display/FEDORA6x/Versioning#Versioning-memento-datetime-negoMementoDatetimeNegotiationAlgorithm\n\nI may well be misreading the test, because the functionality when testing manually seems correct.", "url": "https://github.com/fcrepo/fcrepo/pull/1644#discussion_r391881076", "createdAt": "2020-03-12T20:38:16Z", "author": {"login": "awoods"}, "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraVersioningIT.java", "diffHunk": "@@ -1206,21 +1127,25 @@ public void testGetVersionResponseContentTypes() throws Exception {\n         }\n     }\n \n-    @Ignore //TODO Fix this test\n     @Test\n     public void testDatetimeNegotiationLDPRv() throws Exception {\n+        final String startDatetime = MEMENTO_RFC_1123_FORMATTER.format(Instant.now().atZone(ZoneOffset.UTC));\n+\n         final CloseableHttpClient customClient = createClient(true);\n \n         createVersionedContainer(id);\n-        final String memento1 =\n-            MEMENTO_RFC_1123_FORMATTER.format(ISO_INSTANT.parse(\"2017-06-10T11:41:00Z\", Instant::from));\n         final String version1Uri = createLDPRSMementoWithExistingBody();\n-            MEMENTO_RFC_1123_FORMATTER.format(ISO_INSTANT.parse(\"2016-06-17T11:41:00Z\", Instant::from));\n-        final String version2Uri = createLDPRSMementoWithExistingBody();\n+\n+        TimeUnit.SECONDS.sleep(1);\n \n         // Request datetime between memento1 and memento2\n-        final String request1Datetime =\n-            MEMENTO_RFC_1123_FORMATTER.format(ISO_INSTANT.parse(\"2017-01-12T00:00:00Z\", Instant::from));\n+        final String request1Datetime = MEMENTO_RFC_1123_FORMATTER.format(Instant.now().atZone(ZoneOffset.UTC));\n+\n+        TimeUnit.SECONDS.sleep(1);\n+\n+        final String version2Uri = createLDPRSMementoWithExistingBody();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a7dbc66080d7abec1a5e46f2245cb01f25859bd"}, "originalPosition": 411}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg4NjE0OA==", "bodyText": "Maybe include link to relevant JIRA? https://jira.lyrasis.org/browse/FCREPO-3246", "url": "https://github.com/fcrepo/fcrepo/pull/1644#discussion_r391886148", "createdAt": "2020-03-12T20:49:18Z", "author": {"login": "awoods"}, "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraVersioningIT.java", "diffHunk": "@@ -1112,7 +1032,7 @@ public void testCreateVersionBinaryDescriptionWithBodyAndDatetime() throws Excep\n         }\n     }\n \n-    @Ignore //TODO Fix this test\n+    @Ignore(\"metadata problems and issues creating binary resources as text/plain\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a7dbc66080d7abec1a5e46f2245cb01f25859bd"}, "originalPosition": 354}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg4NjIxOQ==", "bodyText": "Maybe include link to relevant JIRA? https://jira.lyrasis.org/browse/FCREPO-3246", "url": "https://github.com/fcrepo/fcrepo/pull/1644#discussion_r391886219", "createdAt": "2020-03-12T20:49:28Z", "author": {"login": "awoods"}, "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraVersioningIT.java", "diffHunk": "@@ -1490,18 +1403,16 @@ public void testGetLDPRSMementoHeaders() throws Exception {\n         }\n     }\n \n-    @Ignore //TODO Fix this test\n+    @Ignore(\"bug creating resources with text/plain\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a7dbc66080d7abec1a5e46f2245cb01f25859bd"}, "originalPosition": 541}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg4NjI2OQ==", "bodyText": "Maybe include link to relevant JIRA? https://jira.lyrasis.org/browse/FCREPO-3246", "url": "https://github.com/fcrepo/fcrepo/pull/1644#discussion_r391886269", "createdAt": "2020-03-12T20:49:35Z", "author": {"login": "awoods"}, "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraVersioningIT.java", "diffHunk": "@@ -1674,7 +1585,7 @@ public void testCreateHistoricExternalBinaryRedirectVersion() throws Exception {\n         }\n     }\n \n-    @Ignore //TODO Fix this test\n+    @Ignore(\"bug creating text/plain resources\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a7dbc66080d7abec1a5e46f2245cb01f25859bd"}, "originalPosition": 571}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkzNzkxMw==", "bodyText": "We could probably be slightly more precise and maintainable with:\nPattern.compile(\".*/\" + FedoraTypes.FCR_VERSIONS + \"/(\\\\d+)$\");", "url": "https://github.com/fcrepo/fcrepo/pull/1644#discussion_r391937913", "createdAt": "2020-03-12T22:23:59Z", "author": {"login": "awoods"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraBaseResource.java", "diffHunk": "@@ -59,6 +63,8 @@\n \n     private static final Pattern TRAILING_SLASH_REGEX = Pattern.compile(\"/+$\");\n \n+    private static final Pattern MEMENTO_PATH_PATTERN = Pattern.compile(\".*/fcr:versions/(.*)$\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a7dbc66080d7abec1a5e46f2245cb01f25859bd"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk0MTc3OA==", "bodyText": "Some inline comments would be helpful here.", "url": "https://github.com/fcrepo/fcrepo/pull/1644#discussion_r391941778", "createdAt": "2020-03-12T22:36:05Z", "author": {"login": "awoods"}, "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/models/FedoraResourceImpl.java", "diffHunk": "@@ -138,11 +146,22 @@ public boolean isAcl() {\n \n     @Override\n     public FedoraResource findMementoByDatetime(final Instant mementoDatetime) {\n-        try {\n-            return resourceFactory.getResource(tx, getId(), mementoDatetime);\n-        } catch (PathNotFoundException e) {\n-            throw new PathNotFoundRuntimeException(e);\n+        FedoraResource match = null;\n+        long matchDiff = 0;\n+\n+        for (var it = getTimeMap().getChildren().iterator(); it.hasNext();) {\n+            final var current = it.next();\n+            final var diff = Duration.between(current.getMementoDatetime(), mementoDatetime).toSeconds();\n+\n+            if (match == null", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a7dbc66080d7abec1a5e46f2245cb01f25859bd"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk0NDUyOA==", "bodyText": "Actually, we may need to discuss how we want to handle the possibility of multiple mementos with the same timestamp.\nWould there be a means of GETting one of the earlier mementos?", "url": "https://github.com/fcrepo/fcrepo/pull/1644#discussion_r391944528", "createdAt": "2020-03-12T22:44:46Z", "author": {"login": "awoods"}, "path": "fcrepo-kernel-impl/src/test/java/org/fcrepo/kernel/impl/models/FedoraResourceImplTest.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/*\n+ * Licensed to DuraSpace under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional information\n+ * regarding copyright ownership.\n+ *\n+ * DuraSpace licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except in\n+ * compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.fcrepo.kernel.impl.models;\n+\n+import org.fcrepo.kernel.api.models.FedoraResource;\n+import org.fcrepo.kernel.api.models.ResourceFactory;\n+import org.fcrepo.kernel.api.models.TimeMap;\n+import org.fcrepo.kernel.api.services.VersionService;\n+import org.fcrepo.persistence.api.PersistentStorageSessionManager;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+import java.time.Instant;\n+import java.util.ArrayList;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNull;\n+import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.spy;\n+import static org.mockito.Mockito.when;\n+\n+@RunWith(MockitoJUnitRunner.Silent.class)\n+public class FedoraResourceImplTest {\n+\n+    @Mock\n+    private TimeMap timeMap;\n+\n+    @Mock\n+    private PersistentStorageSessionManager sessionManager;\n+\n+    @Mock\n+    private ResourceFactory resourceFactory;\n+\n+    private static final String ID = \"info:fedora/test\";\n+\n+    @Test\n+    public void findMementoWhenOnlyOneAndBeforeSearch() {\n+        final var resource = resourceWithMockedTimeMap(ID);\n+        expectMementos(\"20200309172117\");\n+        final var match = resource.findMementoByDatetime(instant(\"20200309172118\"));\n+        assertEquals(\"0\", match.getId());\n+    }\n+\n+    @Test\n+    public void findClosestMementoWhenMultiple() {\n+        final var resource = resourceWithMockedTimeMap(ID);\n+        expectMementos(\"20200309172117\", \"20200309172118\", \"20200309172119\");\n+        final var match = resource.findMementoByDatetime(instant(\"20200309172118\"));\n+        assertEquals(\"1\", match.getId());\n+    }\n+\n+    @Test\n+    public void findClosestMementoWhenMultipleNoneExact() {\n+        final var resource = resourceWithMockedTimeMap(ID);\n+        expectMementos(\"20200309172116\", \"20200309172117\", \"20200309172119\");\n+        final var match = resource.findMementoByDatetime(instant(\"20200309172118\"));\n+        assertEquals(\"1\", match.getId());\n+    }\n+\n+    @Test\n+    public void findClosestMementoMultipleSameSecond() {\n+        final var resource = resourceWithMockedTimeMap(ID);\n+        expectMementos(\"20200309172117\", \"20200309172117\", \"20200309172117\");\n+        final var match = resource.findMementoByDatetime(instant(\"20200309172118\"));\n+        assertEquals(\"2\", match.getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a7dbc66080d7abec1a5e46f2245cb01f25859bd"}, "originalPosition": 83}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3add4633976e0a7c6a81d6580012b5b674d2133", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/f3add4633976e0a7c6a81d6580012b5b674d2133", "committedDate": "2020-03-13T13:51:31Z", "message": "pr fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3NzA0NzI0", "url": "https://github.com/fcrepo/fcrepo/pull/1644#pullrequestreview-377704724", "createdAt": "2020-03-19T13:13:43Z", "commit": {"oid": "f3add4633976e0a7c6a81d6580012b5b674d2133"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxMzoxMzo0M1rOF4txYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxMzoxMzo1N1rOF4tx6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAxNDQ5OQ==", "bodyText": "Note can probably go if the check for Mementos is.", "url": "https://github.com/fcrepo/fcrepo/pull/1644#discussion_r395014499", "createdAt": "2020-03-19T13:13:43Z", "author": {"login": "whikloj"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/ContentExposingResource.java", "diffHunk": "@@ -291,7 +291,7 @@ private RdfStream getResourceTriples(final int limit, final FedoraResource resou\n             //streams.add(getTriples(resource, MINIMAL));\n             // Mementos already have the server managed properties in the PROPERTIES category\n             // since mementos are immutable and these triples are no longer managed", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3add4633976e0a7c6a81d6580012b5b674d2133"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAxNDYzMg==", "bodyText": "Note can go.", "url": "https://github.com/fcrepo/fcrepo/pull/1644#discussion_r395014632", "createdAt": "2020-03-19T13:13:57Z", "author": {"login": "whikloj"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/ContentExposingResource.java", "diffHunk": "@@ -302,7 +302,7 @@ private RdfStream getResourceTriples(final int limit, final FedoraResource resou\n             // Additional server-managed triples about this resource\n             // Mementos already have the server managed properties in the PROPERTIES category\n             // since mementos are immutable and these triples are no longer managed", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3add4633976e0a7c6a81d6580012b5b674d2133"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "727560c1f814c12beadbf8cc9d81bdc6bd30ed46", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/727560c1f814c12beadbf8cc9d81bdc6bd30ed46", "committedDate": "2020-03-19T14:00:00Z", "message": "removed comments based on PR"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3Nzk0NzQ0", "url": "https://github.com/fcrepo/fcrepo/pull/1644#pullrequestreview-377794744", "createdAt": "2020-03-19T14:50:42Z", "commit": {"oid": "727560c1f814c12beadbf8cc9d81bdc6bd30ed46"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3244, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}