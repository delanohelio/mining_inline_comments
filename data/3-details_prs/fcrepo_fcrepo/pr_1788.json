{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2MTIxMjk3", "number": 1788, "title": "Memento containment", "bodyText": "JIRA Ticket: https://jira.lyrasis.org/browse/FCREPO-3450\nWhat does this Pull Request do?\nContains the past containment relationships for those things that did exist and are now deleted (but not purged).\nNote: this does not include the repository rebuild processing. I figured I'd work that once this seemed correct.\nNote note: I renamed the resources table to containment and the transaction_operations table to containment_transactions. The old names were not super clear and we have a lot more tables now.\nHow should this be tested?\nCreate a resource (parent)\nCreate a child resource (child)\nCreate a version of parent (I patch it)\nDelete child.\nGet the memento you created, before there were no ldp:contains, now you should see child.\nInterested parties\nTag (@ mention) interested parties or, if unsure, @fcrepo/committers", "createdAt": "2020-11-05T14:56:06Z", "url": "https://github.com/fcrepo/fcrepo/pull/1788", "merged": true, "mergeCommit": {"oid": "60bd59a399b408b93032f5a52a5f14a6c53f895a"}, "closed": true, "closedAt": "2020-11-12T21:01:39Z", "author": {"login": "whikloj"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZkJvlAFqTUyNDM3NTk1Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdb5BEmgFqTUyOTQ5MjI2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0Mzc1OTUz", "url": "https://github.com/fcrepo/fcrepo/pull/1788#pullrequestreview-524375953", "createdAt": "2020-11-05T15:27:03Z", "commit": {"oid": "a11a415c0446162bd51a3cbf7f374bc18e369e0e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNToyNzowM1rOHuIkDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNTozMTowNFrOHuIvqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEzNjg0Ng==", "bodyText": "Would getResouceId() not do what you want here?", "url": "https://github.com/fcrepo/fcrepo/pull/1788#discussion_r518136846", "createdAt": "2020-11-05T15:27:03Z", "author": {"login": "pwinckles"}, "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "diffHunk": "@@ -325,21 +377,27 @@ private NamedParameterJdbcTemplate getNamedParameterJdbcTemplate() {\n \n     @Override\n     public Stream<String> getContains(final String txId, final FedoraId fedoraId) {\n-        final String resourceId = fedoraId.getFullId();\n+        final String resourceId = fedoraId.isMemento() ? fedoraId.getBaseId() : fedoraId.getFullId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a11a415c0446162bd51a3cbf7f374bc18e369e0e"}, "originalPosition": 259}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEzOTgxOQ==", "bodyText": "Since mementos have second level granularity, perhaps it would make sense to truncate to the second?", "url": "https://github.com/fcrepo/fcrepo/pull/1788#discussion_r518139819", "createdAt": "2020-11-05T15:31:04Z", "author": {"login": "pwinckles"}, "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "diffHunk": "@@ -591,4 +660,18 @@ public void setDataSource(final DataSource dataSource) {\n         this.dataSource = dataSource;\n     }\n \n+    /**\n+     * Format an instant to a timestamp without milliseconds, due to precision\n+     * issues with memento datetimes.\n+     * @param instant\n+     * @return the timestamp\n+     */\n+    private Timestamp formatInstant(final Instant instant) {\n+        if (instant == null) {\n+            return null;\n+        }\n+        final var timestamp = Timestamp.from(instant);\n+        timestamp.setNanos(0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a11a415c0446162bd51a3cbf7f374bc18e369e0e"}, "originalPosition": 357}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a11a415c0446162bd51a3cbf7f374bc18e369e0e", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/a11a415c0446162bd51a3cbf7f374bc18e369e0e", "committedDate": "2020-11-05T03:18:04Z", "message": "First pass at memento containment"}, "afterCommit": {"oid": "82358bba38c2a0d6e0896208ebcd6365d5eea038", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/82358bba38c2a0d6e0896208ebcd6365d5eea038", "committedDate": "2020-11-10T21:25:24Z", "message": "Stop MariaDB setting timestamp to current time"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NDE0NDg5", "url": "https://github.com/fcrepo/fcrepo/pull/1788#pullrequestreview-528414489", "createdAt": "2020-11-11T18:05:09Z", "commit": {"oid": "82358bba38c2a0d6e0896208ebcd6365d5eea038"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5de3e62688b0e539097547d7eff1875e90630469", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/5de3e62688b0e539097547d7eff1875e90630469", "committedDate": "2020-11-12T19:49:36Z", "message": "First pass at memento containment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc4be6dce9acff805af74147a2663e330bc6f94c", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/fc4be6dce9acff805af74147a2663e330bc6f94c", "committedDate": "2020-11-12T19:49:45Z", "message": "Stop MariaDB setting timestamp to current time"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "82358bba38c2a0d6e0896208ebcd6365d5eea038", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/82358bba38c2a0d6e0896208ebcd6365d5eea038", "committedDate": "2020-11-10T21:25:24Z", "message": "Stop MariaDB setting timestamp to current time"}, "afterCommit": {"oid": "fc4be6dce9acff805af74147a2663e330bc6f94c", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/fc4be6dce9acff805af74147a2663e330bc6f94c", "committedDate": "2020-11-12T19:49:45Z", "message": "Stop MariaDB setting timestamp to current time"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cbb9f610d4eec4fd881a594fdb9bfcacc953516", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/7cbb9f610d4eec4fd881a594fdb9bfcacc953516", "committedDate": "2020-11-12T20:34:43Z", "message": "Use getResourceId()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NDkyMjY4", "url": "https://github.com/fcrepo/fcrepo/pull/1788#pullrequestreview-529492268", "createdAt": "2020-11-12T20:58:57Z", "commit": {"oid": "7cbb9f610d4eec4fd881a594fdb9bfcacc953516"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2995, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}