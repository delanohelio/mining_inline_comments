{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzNTA3ODM5", "number": 1812, "title": "Fixity Service", "bodyText": "JIRA Ticket: https://jira.lyrasis.org/browse/FCREPO-3535\nWhat does this Pull Request do?\nImplements a fixity checking service.\nHow should this be tested?\nPut a binary in, then go to it's fcr:fixity endpoint. Try both cUrl and a web browser.\nAssuming the result is SUCCESS try altering your binary and run the request again.\nSee the BAD_CHECKSUM result.\nIn Fedora 5 you would get a BAD_SIZE outcome as well, I feel like if the size changes the checksum changes and we aren't all that concerned about ever getting a BAD_SIZE without a BAD_CHECKSUM. But if desired we'd have to add this functionality to the fixity service.\nInterested parties\n@fcrepo/committers (specifically @bbpennel) and @dwilcox", "createdAt": "2020-11-18T21:59:17Z", "url": "https://github.com/fcrepo/fcrepo/pull/1812", "merged": true, "mergeCommit": {"oid": "aa1012339aafb8921f74ef0438b8d6f88e1015c7"}, "closed": true, "closedAt": "2020-11-27T22:28:42Z", "author": {"login": "whikloj"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdd2_MMAFqTUzMzk3MDMzNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgt-sUgFqTU0MDE4OTQ1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzOTcwMzM3", "url": "https://github.com/fcrepo/fcrepo/pull/1812#pullrequestreview-533970337", "createdAt": "2020-11-18T23:42:18Z", "commit": {"oid": "0277fc4bff6672f99cf930e3ae7caafd5ea517a1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMzo0MjoxOFrOH2GxFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMzo0MjoxOFrOH2GxFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ5NjAyMw==", "bodyText": "Haven't looked at this PR in depth. Was just browsing and noticed this. binary.getContent() should be called in a try-with block so that it is closed.", "url": "https://github.com/fcrepo/fcrepo/pull/1812#discussion_r526496023", "createdAt": "2020-11-18T23:42:18Z", "author": {"login": "pwinckles"}, "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/services/FixityServiceImpl.java", "diffHunk": "@@ -49,8 +73,37 @@\n     }\n \n     @Override\n-    public Collection<URI> checkFixity(final Binary binary, final Collection<String> algorithms)\n-            throws UnsupportedAlgorithmException {\n-        return null;\n+    public RdfStream checkFixity(final Binary binary)\n+            throws InvalidChecksumException {\n+        final Model model = createDefaultModel();\n+        final Resource subject = model.createResource(binary.getId());\n+        final Resource fixityResult = model.createResource(\n+                binary.getFedoraId().resolve(\"#\" + UUID.randomUUID().toString()).getFullId());\n+        model.add(subject, HAS_FIXITY_RESULT, fixityResult);\n+        model.add(fixityResult, type, PREMIS_FIXITY);\n+        model.add(fixityResult, type, PREMIS_EVENT_OUTCOME_DETAIL);\n+        model.add(fixityResult, HAS_SIZE, createTypedLiteral(binary.getContentSize()));\n+\n+        // Built for more than one digest in anticipation of FCREPO-3419\n+        final List<URI> existingDigestList = new ArrayList<>();\n+        existingDigestList.add(binary.getContentDigest());\n+\n+        final var digestAlgs = existingDigestList.stream()\n+                .map(URI::toString)\n+                .map(a -> a.replace(\"urn:\", \"\").split(\":\")[0])\n+                .map(DIGEST_ALGORITHM::fromAlgorithm)\n+                .collect(Collectors.toList());\n+\n+        final MultiDigestInputStreamWrapper digestWrapper = new MultiDigestInputStreamWrapper(\n+                binary.getContent(), existingDigestList, digestAlgs);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0277fc4bff6672f99cf930e3ae7caafd5ea517a1"}, "originalPosition": 78}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0d95eb1a776eb31ceede701ebc0b42350e689438", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/0d95eb1a776eb31ceede701ebc0b42350e689438", "committedDate": "2020-11-19T02:19:12Z", "message": "Close input streams"}, "afterCommit": {"oid": "889b82d09f97b8b313058718c3105ea354bdac10", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/889b82d09f97b8b313058718c3105ea354bdac10", "committedDate": "2020-11-20T01:18:03Z", "message": "Close input streams"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c12758068f44e4acf46d4a6c444b4569e38d48b7", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/c12758068f44e4acf46d4a6c444b4569e38d48b7", "committedDate": "2020-11-27T18:59:34Z", "message": "Fixity service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1c172c9e3a59f3c711b3516ee4bf20203851604", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/b1c172c9e3a59f3c711b3516ee4bf20203851604", "committedDate": "2020-11-27T18:59:34Z", "message": "Close input streams"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e8731c3f899152010567ae6ca50d8af9317b248", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/5e8731c3f899152010567ae6ca50d8af9317b248", "committedDate": "2020-11-27T18:59:34Z", "message": "Add integration test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e0f6c366ce2ad47eddf27d02e12762359a8edf3", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/9e0f6c366ce2ad47eddf27d02e12762359a8edf3", "committedDate": "2020-11-27T19:17:20Z", "message": "Corrupt a binary and check fixity"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "74d76c563d431561676244693af67b3deff32b55", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/74d76c563d431561676244693af67b3deff32b55", "committedDate": "2020-11-24T22:47:55Z", "message": "Add integration test"}, "afterCommit": {"oid": "9e0f6c366ce2ad47eddf27d02e12762359a8edf3", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/9e0f6c366ce2ad47eddf27d02e12762359a8edf3", "committedDate": "2020-11-27T19:17:20Z", "message": "Corrupt a binary and check fixity"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwMTg5NDUx", "url": "https://github.com/fcrepo/fcrepo/pull/1812#pullrequestreview-540189451", "createdAt": "2020-11-27T20:57:01Z", "commit": {"oid": "9e0f6c366ce2ad47eddf27d02e12762359a8edf3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3028, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}