{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEyNTIwODIx", "number": 1672, "title": "Implement adding ACLs", "bodyText": "JIRA Ticket: https://jira.lyrasis.org/browse/FCREPO-3134\nWhat does this Pull Request do?\nAllows you to PUT/GET/DELETE and PATCH ACLs.\nThis does not ensure ACLs are enforced, that is next up.\nWhat's new?\nI finally determined the issue with the FedoraId resourceId versus fullId. I need the resourceId to be the path as stored on disk. So for pretend things like fcr:tombstone and fcr:versions which don't exist it is the resource they hang off of, but for things that have an actual representation on disk (fcr:metadata and fcr:acl) we need their id (ie. info:fedora/object/fcr:metadata)\nHow should this be tested?\nTry PUTting an ACL\nTry GETting the ACL\nTry PATCHing an ACL\nTry DELETEing the ACL\nInterested parties\n@fcrepo4/committers", "createdAt": "2020-05-02T23:11:45Z", "url": "https://github.com/fcrepo/fcrepo/pull/1672", "merged": true, "mergeCommit": {"oid": "8310f770a8266cf33e97adea87188f050e975947"}, "closed": true, "closedAt": "2020-05-04T19:11:00Z", "author": {"login": "whikloj"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcdecUPAH2gAyNDEyNTIwODIxOmU4ZmE5NmYwZWM0NmYxMjVkZTMxNTU5MDBiYjZiYzRhYmNlMmMxZjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABceEYvLgFqTQwNTI2OTc0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e8fa96f0ec46f125de3155900bb6bc4abce2c1f3", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/e8fa96f0ec46f125de3155900bb6bc4abce2c1f3", "committedDate": "2020-05-02T22:57:58Z", "message": "Implement adding ACLs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NjI4Mzcw", "url": "https://github.com/fcrepo/fcrepo/pull/1672#pullrequestreview-404628370", "createdAt": "2020-05-03T15:12:34Z", "commit": {"oid": "e8fa96f0ec46f125de3155900bb6bc4abce2c1f3"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0057294a256b4cfbe7f36c8662de9a874245678b", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/0057294a256b4cfbe7f36c8662de9a874245678b", "committedDate": "2020-05-04T14:03:06Z", "message": "Re-enable more tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0OTM0MzE0", "url": "https://github.com/fcrepo/fcrepo/pull/1672#pullrequestreview-404934314", "createdAt": "2020-05-04T12:19:48Z", "commit": {"oid": "e8fa96f0ec46f125de3155900bb6bc4abce2c1f3"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxMjoxOTo0OFrOGP9yOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxMjo1NTo0N1rOGP_BTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM5NDEwNA==", "bodyText": "This should be written:\nprivate final static Set<String> extensions = Set.of(\n    FCR_TOMBSTONE,\n    FCR_METADAT,\n    // etc\n);", "url": "https://github.com/fcrepo/fcrepo/pull/1672#discussion_r419394104", "createdAt": "2020-05-04T12:19:48Z", "author": {"login": "pwinckles"}, "path": "fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/identifiers/FedoraId.java", "diffHunk": "@@ -60,6 +65,14 @@\n     private String mementoDatetimeStr;\n     private String pathOnly;\n \n+    private final static Set<String> extensions = new HashSet<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8fa96f0ec46f125de3155900bb6bc4abce2c1f3"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQwNTI5MA==", "bodyText": "Since the pattern never changes, and extensions isn't used for anything else, it may as well be Set<Pattern>. I'd be curious to know if there is any performance gain from doing the contains check before applying the regex as the contains will have to scan the string. If you do want to do the check, extensions could easily be Map<String, Pattern>.", "url": "https://github.com/fcrepo/fcrepo/pull/1672#discussion_r419405290", "createdAt": "2020-05-04T12:41:02Z", "author": {"login": "pwinckles"}, "path": "fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/identifiers/FedoraId.java", "diffHunk": "@@ -347,6 +364,31 @@ private void processIdentifier() {\n         if (processID.endsWith(\"/\")) {\n             processID = processID.replaceAll(\"/+$\", \"\");\n         }\n-        this.id = processID;\n+        this.resourceId = processID;\n+    }\n+\n+    /**\n+     * Check for obvious path errors.\n+     */\n+    private void checkForInvalidPath() {\n+        // Check for combinations of endpoints not allowed.\n+        if (\n+            // ID contains fcr:acl or fcr:tombstone AND fcr:metadata or fcr:versions\n+            ((this.fullId.contains(FCR_ACL) || this.fullId.contains(FCR_TOMBSTONE)) &&\n+                (this.fullId.contains(FCR_METADATA) || this.fullId.contains(FCR_VERSIONS))) ||\n+            // or ID contains fcr:acl AND fcr:tombstone\n+            (this.fullId.contains(FCR_TOMBSTONE) && this.fullId.contains(FCR_ACL))\n+        ) {\n+            throw new InvalidResourceIdentifierException(String.format(\"Path is invalid: %s\", pathOnly));\n+        }\n+        // Ensure we don't have 2 of any of the extensions, ie. info:fedora/object/fcr:acl/fcr:acl, etc.\n+        for (final String extension : extensions) {\n+            if (this.fullId.contains(extension)) {\n+                final Pattern extPattern = Pattern.compile(extension);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8fa96f0ec46f125de3155900bb6bc4abce2c1f3"}, "originalPosition": 144}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQxNDM0OQ==", "bodyText": "Is this needed since it's just calling super?", "url": "https://github.com/fcrepo/fcrepo/pull/1672#discussion_r419414349", "createdAt": "2020-05-04T12:55:47Z", "author": {"login": "pwinckles"}, "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/models/WebacAclImpl.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed to DuraSpace under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional information\n+ * regarding copyright ownership.\n+ *\n+ * DuraSpace licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except in\n+ * compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.fcrepo.kernel.impl.models;\n+\n+import org.fcrepo.kernel.api.RdfStream;\n+import org.fcrepo.kernel.api.Transaction;\n+import org.fcrepo.kernel.api.exception.PathNotFoundException;\n+import org.fcrepo.kernel.api.exception.PathNotFoundRuntimeException;\n+import org.fcrepo.kernel.api.identifiers.FedoraId;\n+import org.fcrepo.kernel.api.models.FedoraResource;\n+import org.fcrepo.kernel.api.models.ResourceFactory;\n+import org.fcrepo.kernel.api.models.WebacAcl;\n+import org.fcrepo.persistence.api.PersistentStorageSessionManager;\n+\n+/**\n+ * Webac Acl class\n+ */\n+public class WebacAclImpl extends ContainerImpl implements WebacAcl {\n+\n+    /**\n+     * Constructor\n+     * @param fedoraID the internal identifier\n+     * @param tx the current transaction\n+     * @param pSessionManager a session manager\n+     * @param resourceFactory a resource factory instance.\n+     */\n+    public WebacAclImpl(final FedoraId fedoraID, final Transaction tx,\n+                        final PersistentStorageSessionManager pSessionManager, final ResourceFactory resourceFactory) {\n+        super(fedoraID, tx, pSessionManager, resourceFactory);\n+    }\n+\n+    @Override\n+    public FedoraResource getDescribedResource() {\n+        final var originalId = FedoraId.create(getFedoraId().getResourceId());\n+        try {\n+            return resourceFactory.getResource(tx, originalId);\n+        } catch (final PathNotFoundException exc) {\n+            throw new PathNotFoundRuntimeException(exc);\n+        }\n+    }\n+\n+    @Override\n+    public RdfStream getTriples() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8fa96f0ec46f125de3155900bb6bc4abce2c1f3"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MDY3NjY5", "url": "https://github.com/fcrepo/fcrepo/pull/1672#pullrequestreview-405067669", "createdAt": "2020-05-04T14:56:28Z", "commit": {"oid": "0057294a256b4cfbe7f36c8662de9a874245678b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxNDo1NjoyOVrOGQENrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxNzoyMDozM1rOGQKNRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQ5OTQzNw==", "bodyText": "Does this commit a potentially \"long-running transaction\"... irrespective of the transaction API?", "url": "https://github.com/fcrepo/fcrepo/pull/1672#discussion_r419499437", "createdAt": "2020-05-04T14:56:29Z", "author": {"login": "awoods"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraAcl.java", "diffHunk": "@@ -130,37 +128,32 @@ public Response createFedoraWebacAcl(@HeaderParam(CONTENT_TYPE) final MediaType\n         if (resource().isAcl() || resource().isMemento()) {\n             throw new BadRequestException(\"ACL resource creation is not allowed for resource \" + resource().getId());\n         }\n+        LOGGER.info(\"PUT acl resource '{}'\", externalPath());\n \n-        final boolean created;\n-        final FedoraResource aclResource;\n-\n-        final String path = toPath(translator(), externalPath);\n-        LOGGER.info(\"PUT acl resource '{}'\", externalPath);\n-\n-        final var transaction = transaction();\n-\n-        aclResource = webacAclService.findOrCreate(transaction, path);\n-        created = aclResource.isNew();\n-        final FedoraId aclId = aclResource.getFedoraId();\n+        final FedoraId aclId = identifierConverter().pathToInternalId(externalPath()).resolve(FCR_ACL);\n+        final boolean exists = resourceFactory.doesResourceExist(transaction(), aclId);\n \n         final MediaType contentType =\n             requestContentType == null ? RDFMediaType.TURTLE_TYPE : valueOf(getSimpleContentType(requestContentType));\n         if (isRdfContentType(contentType.toString())) {\n \n-            // TODO: confirm this is correct logic for ACL's\n-            final Model model = httpRdfService.bodyToInternalModel(externalPath() + \"/fcr:acl\",\n-                    requestBodyStream, requestContentType, identifierConverter());\n-\n-            replacePropertiesService.perform(transaction.getId(), getUserPrincipal(), aclId, model);\n+            final Model model = httpRdfService.bodyToInternalModel(aclId.getFullId(),\n+                    requestBodyStream, contentType, identifierConverter());\n+            if (exists) {\n+                replacePropertiesService.perform(transaction().getId(), getUserPrincipal(), aclId, model);\n+            } else {\n+                webacAclService.create(transaction(), aclId, getUserPrincipal(), model);\n+            }\n         } else {\n             throw new BadRequestException(\"Content-Type (\" + requestContentType + \") is invalid. Try text/turtle \" +\n                                           \"or other RDF compatible type.\");\n         }\n-        transaction.commit();\n+        transaction().commit();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0057294a256b4cfbe7f36c8662de9a874245678b"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUzNDA3Nw==", "bodyText": "This can probably be removed.", "url": "https://github.com/fcrepo/fcrepo/pull/1672#discussion_r419534077", "createdAt": "2020-05-04T15:44:50Z", "author": {"login": "awoods"}, "path": "fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/identifiers/FedoraId.java", "diffHunk": "@@ -48,8 +52,9 @@\n  */\n public class FedoraId {\n \n-    private String id;\n+    private String resourceId;\n     private String fullId;\n+    private String parentId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0057294a256b4cfbe7f36c8662de9a874245678b"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTU5NDI4MQ==", "bodyText": "In the past, we supported /fcr:metadata having their own ACLs, no? Was it decided that this would no longer be supported?\nThis impacts FedoraIdTest.java updates.", "url": "https://github.com/fcrepo/fcrepo/pull/1672#discussion_r419594281", "createdAt": "2020-05-04T17:14:55Z", "author": {"login": "awoods"}, "path": "fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/identifiers/FedoraId.java", "diffHunk": "@@ -347,6 +364,31 @@ private void processIdentifier() {\n         if (processID.endsWith(\"/\")) {\n             processID = processID.replaceAll(\"/+$\", \"\");\n         }\n-        this.id = processID;\n+        this.resourceId = processID;\n+    }\n+\n+    /**\n+     * Check for obvious path errors.\n+     */\n+    private void checkForInvalidPath() {\n+        // Check for combinations of endpoints not allowed.\n+        if (\n+            // ID contains fcr:acl or fcr:tombstone AND fcr:metadata or fcr:versions\n+            ((this.fullId.contains(FCR_ACL) || this.fullId.contains(FCR_TOMBSTONE)) &&\n+                (this.fullId.contains(FCR_METADATA) || this.fullId.contains(FCR_VERSIONS))) ||", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0057294a256b4cfbe7f36c8662de9a874245678b"}, "originalPosition": 135}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTU5NzYzNg==", "bodyText": "In the case that the resource is an ACL (see line:100 above), there may not be a \"memento instant\", no?", "url": "https://github.com/fcrepo/fcrepo/pull/1672#discussion_r419597636", "createdAt": "2020-05-04T17:20:33Z", "author": {"login": "awoods"}, "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/models/ResourceFactoryImpl.java", "diffHunk": "@@ -96,18 +97,20 @@ public boolean doesResourceExist(final Transaction transaction, final FedoraId f\n             // Root always exists.\n             return true;\n         }\n-        if (!fedoraId.isMemento()) {\n-            // containment index doesn't handle versions, so don't bother checking for them.\n+        if (!(fedoraId.isMemento() || fedoraId.isAcl())) {\n+            // containment index doesn't handle versions and only tells us if the resource (not acl) is there,\n+            // so don't bother checking for them.\n             final String transactionId = transaction == null ? null : transaction.getId();\n             return containmentIndex.resourceExists(transactionId, fedoraId);\n         } else {\n \n             final PersistentStorageSession psSession = getSession(transaction);\n \n             try {\n-                final String id = fedoraId.isDescription() ? fedoraId.getDescriptionId() : fedoraId.getResourceId();\n-                psSession.getHeaders(id, fedoraId.getMementoInstant());\n-                return true;\n+                // Resource ID for metadata or ACL contains their individual endopoints (ie. fcr:metadata, fcr:acl)\n+                final String id = fedoraId.getResourceId();\n+                final ResourceHeaders headers = psSession.getHeaders(id, fedoraId.getMementoInstant());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0057294a256b4cfbe7f36c8662de9a874245678b"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "317054c330dd4a4ed3508d6ee508eb3425173acc", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/317054c330dd4a4ed3508d6ee508eb3425173acc", "committedDate": "2020-05-04T18:28:42Z", "message": "Code review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MjQ2NjE3", "url": "https://github.com/fcrepo/fcrepo/pull/1672#pullrequestreview-405246617", "createdAt": "2020-05-04T18:38:48Z", "commit": {"oid": "317054c330dd4a4ed3508d6ee508eb3425173acc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MjY5NzQ4", "url": "https://github.com/fcrepo/fcrepo/pull/1672#pullrequestreview-405269748", "createdAt": "2020-05-04T19:10:27Z", "commit": {"oid": "317054c330dd4a4ed3508d6ee508eb3425173acc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3110, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}