{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUwMjQwMjMw", "number": 1724, "title": "Remove ocfl id mappings on purge", "bodyText": "JIRA Ticket: https://jira.lyrasis.org/browse/FCREPO-3357\nOriginal PR: #1710\nWhat does this Pull Request do?\n\nOCFL ID mapping changes are accumulated in a transaction table and only applied when a transaction is committed\nWhen resources are purged their associated mappings are removed from the OCFL ID map table\n\nHow should this be tested?\n\n\nStart Fedora against a DB like Postgres.\n\n\nFire up the DB's CLI and execute: select * from ocfl_id_map;\n\n\nCreate resources:\n\n\ncurl -u fedoraAdmin:fedoraAdmin http://localhost:8080/rest/ag-02 -H'Link: <http://www.w3.org/ns/ldp#BasicContainer>;rel=\"type\"' -H'Link: <http://fedora.info/definitions/v4/repository#ArchivalGroup>;rel=\"type\"' -v -H \"Content-Type: text/turtle\" -X PUT --data \"<> <http://purl.org/dc/elements/1.1/title> 'AG Parent 2'\"\n\ncurl -u fedoraAdmin:fedoraAdmin http://localhost:8080/rest/ag-02/child -H'Link: <http://www.w3.org/ns/ldp#BasicContainer>;rel=\"type\"' -v -H \"Content-Type: text/turtle\" -X PUT --data \"<> <http://purl.org/dc/elements/1.1/title> 'AG 2 Child'\"\n\ncurl -u fedoraAdmin:fedoraAdmin http://localhost:8080/rest/ag-02/child/grand -H'Link: <http://www.w3.org/ns/ldp#BasicContainer>;rel=\"type\"' -v -H \"Content-Type: text/turtle\" -X PUT --data \"<> <http://purl.org/dc/elements/1.1/title> 'AG 2 grandchild'\"\n\ncurl -u fedoraAdmin:fedoraAdmin http://localhost:8080/rest/ag-02/child/grand/great -H'Link: <http://www.w3.org/ns/ldp#BasicContainer>;rel=\"type\"' -v -H \"Content-Type: text/turtle\" -X PUT --data \"<> <http://purl.org/dc/elements/1.1/title> 'AG 2 great grandchild'\"\n\ncurl -u fedoraAdmin:fedoraAdmin http://localhost:8080/rest/ag-02/child/grand/great/foo -H \"Link: <http://www.w3.org/ns/ldp#NonRDFSource>; rel=type\" -v -H \"Content-Type: text/plain\" -X PUT --data-binary \"bar\"\n\n\n\nVerify the mappings in the DB\n\n\nPurge a resource:\n\n\ncurl -u fedoraAdmin:fedoraAdmin -v -XDELETE http://localhost:8080/rest/ag-02/child\ncurl -u fedoraAdmin:fedoraAdmin -v -XDELETE http://localhost:8080/rest/ag-02/child/fcr:tombstone\n\n\n\nVerify the mapping, and all child mappings, were removed from the DB\n\n\nCreate a new resource:\n\n\ncurl -u fedoraAdmin:fedoraAdmin http://localhost:8080/rest/foo -H \"Link: <http://www.w3.org/ns/ldp#NonRDFSource>; rel=type\" -v -H \"Content-Type: text/plain\" -X PUT --data-binary \"bar\"\n\n\nPurge the resource within a transaction (DO NOT COMMIT):\n\ncurl -u fedoraAdmin:fedoraAdmin -v -XPOST http://localhost:8080/rest/fcr:tx\ntxid=ebeb046a-64e0-4e46-9ed6-38b3cd1e20a2\ncurl -u fedoraAdmin:fedoraAdmin -v -H\"Atomic-ID: ${txid}\" -XDELETE http://localhost:8080/rest/foo\ncurl -u fedoraAdmin:fedoraAdmin -v -H\"Atomic-ID: ${txid}\" -XDELETE http://localhost:8080/rest/foo/fcr:tombstone\n\n\nVerify the resource still exists in the DB and is access outside the transaction, but not within:\n\ncurl -u fedoraAdmin:fedoraAdmin -H\"Atomic-ID: ${txid}\" -v http://localhost:8080/rest/foo\n\ncurl -u fedoraAdmin:fedoraAdmin -v http://localhost:8080/rest/foo\n\n\nCommit the transaction:\n\ncurl -u fedoraAdmin:fedoraAdmin -X PUT -v http://localhost:8080/rest/fcr:tx/${txid}\n\n\nVerify the resource no longer exists in the DB and can no longer be accessed\n\nInterested parties\n@fcrepo4/committers", "createdAt": "2020-07-16T14:27:51Z", "url": "https://github.com/fcrepo/fcrepo/pull/1724", "merged": true, "mergeCommit": {"oid": "11091226f830bd78cfcc774e07b35c243663a136"}, "closed": true, "closedAt": "2020-07-22T22:25:40Z", "author": {"login": "pwinckles"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1eq46AH2gAyNDUwMjQwMjMwOjNmZGZiN2NmZWQ5NjI5MDE5OGE2ZDkwZTEyYjBiNzRhZTFiOWI5NjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3ihF1AFqTQ1MzcyNzQzNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3fdfb7cfed96290198a6d90e12b0b74ae1b9b962", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/3fdfb7cfed96290198a6d90e12b0b74ae1b9b962", "committedDate": "2020-07-16T12:48:04Z", "message": "Remove fedoraToOcflMapping on purge and use a new transaction table to avoid dangling identifier mappings."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08a06a4b13508fc0ab52454add43b159ba717b19", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/08a06a4b13508fc0ab52454add43b159ba717b19", "committedDate": "2020-07-16T12:48:19Z", "message": "Fix some containment and change fedoraToOcflMap to use upsert queries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12895962dfaae0353f8488bfca416441ad633be9", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/12895962dfaae0353f8488bfca416441ad633be9", "committedDate": "2020-07-16T12:48:19Z", "message": "MySQL DDL file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8117d5d13ea565d9c33c946f6e15d720b253a0e", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/c8117d5d13ea565d9c33c946f6e15d720b253a0e", "committedDate": "2020-07-16T12:48:19Z", "message": "Final clean up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93d5f804b630a3d872eb1260fea9b9b9e57daf4d", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/93d5f804b630a3d872eb1260fea9b9b9e57daf4d", "committedDate": "2020-07-16T12:48:20Z", "message": "SQL tweaks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31588b13738c2e9a5da5ccf885c17ea897d6cf04", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/31588b13738c2e9a5da5ccf885c17ea897d6cf04", "committedDate": "2020-07-16T12:49:05Z", "message": "Rebase changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00c356daf8588afebb2978fc023e408690c79d28", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/00c356daf8588afebb2978fc023e408690c79d28", "committedDate": "2020-07-16T12:49:08Z", "message": "move nonRdfSourceDescription delete to persister and other code review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a6eb6675d2b1ad705ea04ffbce288d07e010cf9", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/5a6eb6675d2b1ad705ea04ffbce288d07e010cf9", "committedDate": "2020-07-16T12:51:53Z", "message": "Changing back again again"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "533fbbb203622c4c74febe56b6558139f3bd85f4", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/533fbbb203622c4c74febe56b6558139f3bd85f4", "committedDate": "2020-07-16T12:51:56Z", "message": "refactor db platfrom code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "720df3d7fde485e9f88742881d420b236390e216", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/720df3d7fde485e9f88742881d420b236390e216", "committedDate": "2020-07-16T14:14:33Z", "message": "fixed bug in recursive purge"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNTc3Nzc2", "url": "https://github.com/fcrepo/fcrepo/pull/1724#pullrequestreview-453577776", "createdAt": "2020-07-22T18:29:01Z", "commit": {"oid": "720df3d7fde485e9f88742881d420b236390e216"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODoyOTowMVrOG1u_Qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOToxMDo0OVrOG1wfGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk5NzU3MA==", "bodyText": "Do we need to import jena?", "url": "https://github.com/fcrepo/fcrepo/pull/1724#discussion_r458997570", "createdAt": "2020-07-22T18:29:01Z", "author": {"login": "awoods"}, "path": "fcrepo-common/pom.xml", "diffHunk": "@@ -0,0 +1,69 @@\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+  <modelVersion>4.0.0</modelVersion>\n+\n+  <parent>\n+    <groupId>org.fcrepo</groupId>\n+    <artifactId>fcrepo</artifactId>\n+    <version>6.0.0-SNAPSHOT</version>\n+  </parent>\n+\n+  <artifactId>fcrepo-common</artifactId>\n+  <name>Fedora Repository Common Module</name>\n+  <description>Common, generally useful utilities</description>\n+  <packaging>bundle</packaging>\n+  <properties>\n+    <osgi.import.packages>\n+      org.apache.jena.*,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "720df3d7fde485e9f88742881d420b236390e216"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAxMjc2NQ==", "bodyText": "For consistency, maybe we should name this parameter: transactionId.\n...or in some other way provide consistency. We seem to switch between sessionIds and transactionIds.", "url": "https://github.com/fcrepo/fcrepo/pull/1724#discussion_r459012765", "createdAt": "2020-07-22T18:54:27Z", "author": {"login": "awoods"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/api/FedoraToOcflObjectIndex.java", "diffHunk": "@@ -36,34 +38,52 @@\n      * Contrast this  with an Archival Group example:  if you pass in \"my/archival-group/binary/fcr:metadata\" the\n      * resource returned in the mapping would be \"my/archival-group\".\n      *\n+     * @param sessionId id of the current session, or null for read-only.\n      * @param fedoraResourceIdentifier the fedora resource identifier\n      * @return the mapping\n      * @throws FedoraOCFLMappingNotFoundException when no mapping exists for the specified identifier.\n      */\n-    FedoraOCFLMapping getMapping(final String fedoraResourceIdentifier) throws FedoraOCFLMappingNotFoundException;\n+    FedoraOCFLMapping getMapping(final String sessionId, final String fedoraResourceIdentifier) throws", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "720df3d7fde485e9f88742881d420b236390e216"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAyMjEwNQ==", "bodyText": "It would appear that the use of Silent is not recommended. Do we have a good reason here?\n     * Engineers should care for removing unused stubbings because they are dead code,\n     * they add unnecessary details, potentially making the test code harder to comprehend.\n     * If you have good reasons to use the silent runner, let us know at the mailing list\n     * or raise an issue in our issue tracker.\n     * The purpose of silent implementation is to satisfy edge/unanticipated use cases,\n     * and to offer users an opt-out.\n     * Mockito framework is opinionated to drive clean tests but it is not dogmatic.", "url": "https://github.com/fcrepo/fcrepo/pull/1724#discussion_r459022105", "createdAt": "2020-07-22T19:10:49Z", "author": {"login": "awoods"}, "path": "fcrepo-persistence-ocfl/src/test/java/org/fcrepo/persistence/ocfl/impl/OCFLPersistentStorageSessionTest.java", "diffHunk": "@@ -88,7 +88,7 @@\n  *\n  * @author dbernstein\n  */\n-@RunWith(MockitoJUnitRunner.class)\n+@RunWith(MockitoJUnitRunner.Silent.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "720df3d7fde485e9f88742881d420b236390e216"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adda7805a6efc30917f23200b3365d744dcb9630", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/adda7805a6efc30917f23200b3365d744dcb9630", "committedDate": "2020-07-22T20:09:18Z", "message": "pr fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNzI3NDM1", "url": "https://github.com/fcrepo/fcrepo/pull/1724#pullrequestreview-453727435", "createdAt": "2020-07-22T22:24:50Z", "commit": {"oid": "adda7805a6efc30917f23200b3365d744dcb9630"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3166, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}