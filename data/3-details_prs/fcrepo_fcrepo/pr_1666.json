{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4NjIwMzA5", "number": 1666, "title": "Change delete to remove data files and set headers to deleted.", "bodyText": "JIRA Ticket: https://jira.lyrasis.org/browse/FCREPO-3033\nWhat does this Pull Request do?\nChanges how deletes work from an immediate purge to just removing the data files and setting the resources as deleted in their header files. This allows the ResourceFactory to determine if the requested resource was deleted and provide a tombstone link.\nHow should this be tested?\nBefore the PR all deleted objects would return a 404, now they should return a 410 GONE and include a Link header to a tombstone location. For NonRdfSourceDescription, TimeMaps and Mementos the link header refers to the original resource + fcr:tombstone\nInterested parties\n@fcrepo4/committers", "createdAt": "2020-04-24T15:32:13Z", "url": "https://github.com/fcrepo/fcrepo/pull/1666", "merged": true, "mergeCommit": {"oid": "e892a909d2ad8bc83a71b468b9db84e00c1ab885"}, "closed": true, "closedAt": "2020-04-29T19:20:51Z", "author": {"login": "whikloj"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcazKS5gH2gAyNDA4NjIwMzA5OjFkMDYyYTFhNzQ2Zjc5ZmU1ZTRjMzkxYmUxYTYzMzJjMzVmYTg1YTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABccdWNYAFqTQwMjk1NzkyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1d062a1a746f79fe5e4c391be1a6332c35fa85a0", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/1d062a1a746f79fe5e4c391be1a6332c35fa85a0", "committedDate": "2020-04-24T15:24:31Z", "message": "Change delete to remove data files and set headers to deleted."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMDYyMDg1", "url": "https://github.com/fcrepo/fcrepo/pull/1666#pullrequestreview-400062085", "createdAt": "2020-04-24T15:43:48Z", "commit": {"oid": "1d062a1a746f79fe5e4c391be1a6332c35fa85a0"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNTo0Mzo0OFrOGLdy-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNzozMjoyNFrOGLiCDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDY3NTcwNA==", "bodyText": "For whatever reason, Java hid what you're looking for at ZoneOffset.UTC.", "url": "https://github.com/fcrepo/fcrepo/pull/1666#discussion_r414675704", "createdAt": "2020-04-24T15:43:48Z", "author": {"login": "pwinckles"}, "path": "fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/exception/TombstoneException.java", "diffHunk": "@@ -32,22 +38,26 @@\n \n     private final String uri;\n \n+    private static DateTimeFormatter isoFormatter = ISO_INSTANT.withZone(ZoneId.of(\"UTC\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d062a1a746f79fe5e4c391be1a6332c35fa85a0"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDY4NTc1Ng==", "bodyText": "Not a problem with this PR, but making changes to the headers file was on the back of my mind recently. Should this file be versioned or do we expect it to never really change once F6 is released? What is the impact of adding/removing properties later?", "url": "https://github.com/fcrepo/fcrepo/pull/1666#discussion_r414685756", "createdAt": "2020-04-24T15:58:00Z", "author": {"login": "pwinckles"}, "path": "fcrepo-persistence-common/src/main/java/org/fcrepo/persistence/common/ResourceHeadersImpl.java", "diffHunk": "@@ -62,6 +62,8 @@\n \n     private boolean objectRoot;\n \n+    private boolean deleted;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d062a1a746f79fe5e4c391be1a6332c35fa85a0"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDY4NzQwNQ==", "bodyText": "Why are you rethrowing the exception message without its stacktrace? It makes debugging much harder.", "url": "https://github.com/fcrepo/fcrepo/pull/1666#discussion_r414687405", "createdAt": "2020-04-24T16:00:16Z", "author": {"login": "pwinckles"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DeleteResourcePersister.java", "diffHunk": "@@ -52,16 +57,68 @@ public void persist(final OCFLPersistentStorageSession session, final ResourceOp\n         final var objectSession = session.findOrCreateSession(mapping.getOcflObjectId());\n         log.debug(\"Deleting {} from {}\", resourceId, mapping.getOcflObjectId());\n         if (fedoraResourceRoot.equals(resourceId)) {\n-            // We are at the root of the object.\n-            objectSession.deleteObject();\n+            // We are at the root of the object, so delete all the data files.\n+            try {\n+                objectSession.listHeadSubpaths().filter(p -> !isSidecarSubpath(p)).forEach(\n+                        p -> deletePathWrapped(p, objectSession));\n+            } catch (final PersistentStorageRuntimeException exc) {\n+                // Rethrow the exception as a checked exception\n+                throw new PersistentStorageException(exc.getCause().getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d062a1a746f79fe5e4c391be1a6332c35fa85a0"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDczMTU5OQ==", "bodyText": "Is it possible for a path to have a . that is unrelated to a file extension?", "url": "https://github.com/fcrepo/fcrepo/pull/1666#discussion_r414731599", "createdAt": "2020-04-24T17:10:36Z", "author": {"login": "pwinckles"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DeleteResourcePersister.java", "diffHunk": "@@ -52,16 +57,68 @@ public void persist(final OCFLPersistentStorageSession session, final ResourceOp\n         final var objectSession = session.findOrCreateSession(mapping.getOcflObjectId());\n         log.debug(\"Deleting {} from {}\", resourceId, mapping.getOcflObjectId());\n         if (fedoraResourceRoot.equals(resourceId)) {\n-            // We are at the root of the object.\n-            objectSession.deleteObject();\n+            // We are at the root of the object, so delete all the data files.\n+            try {\n+                objectSession.listHeadSubpaths().filter(p -> !isSidecarSubpath(p)).forEach(\n+                        p -> deletePathWrapped(p, objectSession));\n+            } catch (final PersistentStorageRuntimeException exc) {\n+                // Rethrow the exception as a checked exception\n+                throw new PersistentStorageException(exc.getCause().getMessage());\n+            }\n         } else {\n             final var relativeSubPath = relativizeSubpath(fedoraResourceRoot, operation.getResourceId());\n             final var ocflSubPath = resolveOCFLSubpath(fedoraResourceRoot, relativeSubPath);\n-            final var headers = readHeaders(objectSession, ocflSubPath);\n-            final var filePath = resolveExtensions(ocflSubPath,\n-                    !Objects.equals(NON_RDF_SOURCE.toString(), headers.getInteractionModel())\n-            );\n-            objectSession.delete(filePath);\n+            final var headers = (ResourceHeadersImpl) readHeaders(objectSession, ocflSubPath);\n+            final boolean isRdf = !Objects.equals(NON_RDF_SOURCE.toString(), headers.getInteractionModel());\n+            final var filePath = resolveExtensions(ocflSubPath, isRdf);\n+            deletePath(filePath, objectSession, headers);\n+            if (!isRdf) {\n+                // Delete the description too.\n+                final var descPath = resolveExtensions(ocflSubPath + \"-description\", true);\n+                deletePath(descPath, objectSession);\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Simple utility to delete a path's files and mark them as deleted in the headers file.\n+     * @param path Path to delete\n+     * @param session Session to delete the path in.\n+     */\n+    private void deletePath(final String path, final OCFLObjectSession session) throws PersistentStorageException{\n+        // readHeaders and writeHeaders need the subpath where as delete needs the file name. So remove any extensions.\n+        final var no_extension = (path.contains(\".\") ? path.substring(0, path.indexOf(\".\")) : path);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d062a1a746f79fe5e4c391be1a6332c35fa85a0"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc0NTEwMA==", "bodyText": "Would acls need to be deleted here too? I know we aren't writing any yet. Just asking out of curiosity.", "url": "https://github.com/fcrepo/fcrepo/pull/1666#discussion_r414745100", "createdAt": "2020-04-24T17:32:24Z", "author": {"login": "pwinckles"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DeleteResourcePersister.java", "diffHunk": "@@ -52,16 +57,68 @@ public void persist(final OCFLPersistentStorageSession session, final ResourceOp\n         final var objectSession = session.findOrCreateSession(mapping.getOcflObjectId());\n         log.debug(\"Deleting {} from {}\", resourceId, mapping.getOcflObjectId());\n         if (fedoraResourceRoot.equals(resourceId)) {\n-            // We are at the root of the object.\n-            objectSession.deleteObject();\n+            // We are at the root of the object, so delete all the data files.\n+            try {\n+                objectSession.listHeadSubpaths().filter(p -> !isSidecarSubpath(p)).forEach(\n+                        p -> deletePathWrapped(p, objectSession));\n+            } catch (final PersistentStorageRuntimeException exc) {\n+                // Rethrow the exception as a checked exception\n+                throw new PersistentStorageException(exc.getCause().getMessage());\n+            }\n         } else {\n             final var relativeSubPath = relativizeSubpath(fedoraResourceRoot, operation.getResourceId());\n             final var ocflSubPath = resolveOCFLSubpath(fedoraResourceRoot, relativeSubPath);\n-            final var headers = readHeaders(objectSession, ocflSubPath);\n-            final var filePath = resolveExtensions(ocflSubPath,\n-                    !Objects.equals(NON_RDF_SOURCE.toString(), headers.getInteractionModel())\n-            );\n-            objectSession.delete(filePath);\n+            final var headers = (ResourceHeadersImpl) readHeaders(objectSession, ocflSubPath);\n+            final boolean isRdf = !Objects.equals(NON_RDF_SOURCE.toString(), headers.getInteractionModel());\n+            final var filePath = resolveExtensions(ocflSubPath, isRdf);\n+            deletePath(filePath, objectSession, headers);\n+            if (!isRdf) {\n+                // Delete the description too.\n+                final var descPath = resolveExtensions(ocflSubPath + \"-description\", true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d062a1a746f79fe5e4c391be1a6332c35fa85a0"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37caf788372ac9608dc3dfa95e5145488d13fd9d", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/37caf788372ac9608dc3dfa95e5145488d13fd9d", "committedDate": "2020-04-24T19:39:28Z", "message": "Use ZoneOffset and persist exception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMjU0NjAw", "url": "https://github.com/fcrepo/fcrepo/pull/1666#pullrequestreview-400254600", "createdAt": "2020-04-24T20:36:58Z", "commit": {"oid": "37caf788372ac9608dc3dfa95e5145488d13fd9d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwOTEyNzgx", "url": "https://github.com/fcrepo/fcrepo/pull/1666#pullrequestreview-400912781", "createdAt": "2020-04-27T12:42:51Z", "commit": {"oid": "37caf788372ac9608dc3dfa95e5145488d13fd9d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMjo0Mjo1MVrOGMhITA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMjo0Mjo1MVrOGMhITA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTc3ODg5Mg==", "bodyText": "I think you might want to call ResourceHeadersUtil.touchModificationHeaders() here instead of directly setting the lastModifiedDate.", "url": "https://github.com/fcrepo/fcrepo/pull/1666#discussion_r415778892", "createdAt": "2020-04-27T12:42:51Z", "author": {"login": "pwinckles"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DeleteResourcePersister.java", "diffHunk": "@@ -52,16 +57,68 @@ public void persist(final OCFLPersistentStorageSession session, final ResourceOp\n         final var objectSession = session.findOrCreateSession(mapping.getOcflObjectId());\n         log.debug(\"Deleting {} from {}\", resourceId, mapping.getOcflObjectId());\n         if (fedoraResourceRoot.equals(resourceId)) {\n-            // We are at the root of the object.\n-            objectSession.deleteObject();\n+            // We are at the root of the object, so delete all the data files.\n+            try {\n+                objectSession.listHeadSubpaths().filter(p -> !isSidecarSubpath(p)).forEach(\n+                        p -> deletePathWrapped(p, objectSession));\n+            } catch (final PersistentStorageRuntimeException exc) {\n+                // Rethrow the exception as a checked exception\n+                throw new PersistentStorageException(exc);\n+            }\n         } else {\n             final var relativeSubPath = relativizeSubpath(fedoraResourceRoot, operation.getResourceId());\n             final var ocflSubPath = resolveOCFLSubpath(fedoraResourceRoot, relativeSubPath);\n-            final var headers = readHeaders(objectSession, ocflSubPath);\n-            final var filePath = resolveExtensions(ocflSubPath,\n-                    !Objects.equals(NON_RDF_SOURCE.toString(), headers.getInteractionModel())\n-            );\n-            objectSession.delete(filePath);\n+            final var headers = (ResourceHeadersImpl) readHeaders(objectSession, ocflSubPath);\n+            final boolean isRdf = !Objects.equals(NON_RDF_SOURCE.toString(), headers.getInteractionModel());\n+            final var filePath = resolveExtensions(ocflSubPath, isRdf);\n+            deletePath(filePath, objectSession, headers);\n+            if (!isRdf) {\n+                // Delete the description too.\n+                final var descPath = resolveExtensions(ocflSubPath + \"-description\", true);\n+                deletePath(descPath, objectSession);\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Simple utility to delete a path's files and mark them as deleted in the headers file.\n+     * @param path Path to delete\n+     * @param session Session to delete the path in.\n+     */\n+    private void deletePath(final String path, final OCFLObjectSession session) throws PersistentStorageException{\n+        // readHeaders and writeHeaders need the subpath where as delete needs the file name. So remove any extensions.\n+        final var no_extension = (path.contains(\".\") ? path.substring(0, path.indexOf(\".\")) : path);\n+        final var headers = (ResourceHeadersImpl) readHeaders(session, no_extension);\n+        deletePath(path, session, headers);\n+    }\n+\n+    /**\n+     * Simple utility to delete a path's files and mark them as deleted in the headers file.\n+     * @param path Path to delete\n+     * @param session Session to delete the path in.\n+     * @param headers The headers for the file.\n+     * @throws PersistentStorageException if can't read, write or delete a file.\n+     */\n+    private void deletePath(final String path, final OCFLObjectSession session, final ResourceHeadersImpl headers)\n+        throws PersistentStorageException {\n+        session.delete(path);\n+        headers.setDeleted(true);\n+        headers.setLastModifiedDate(Instant.now());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37caf788372ac9608dc3dfa95e5145488d13fd9d"}, "originalPosition": 78}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5efe7ed2e394ae5a058c440225384261b730f67b", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/5efe7ed2e394ae5a058c440225384261b730f67b", "committedDate": "2020-04-27T14:44:37Z", "message": "Use utility"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0e9a6da753f5f9b845458884ca301b74b2125b0", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/f0e9a6da753f5f9b845458884ca301b74b2125b0", "committedDate": "2020-04-27T14:55:26Z", "message": "Tag tickets"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyOTU3OTIx", "url": "https://github.com/fcrepo/fcrepo/pull/1666#pullrequestreview-402957921", "createdAt": "2020-04-29T19:07:28Z", "commit": {"oid": "f0e9a6da753f5f9b845458884ca301b74b2125b0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3098, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}