{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxNjY2OTQ2", "number": 1660, "title": "Refactors the index rebuild routine to include containment relationships.", "bodyText": "Refactors the index rebuild routine to include containment relationships\n\nJIRA Ticket: https://jira.lyrasis.org/browse/FCREPO-3247\n\nOther Relevant Links (Mailing list discussion, related pull requests, etc.)\n\nWhat does this Pull Request do?\n\nRefactors FedoraToOCFLIndexUtil into IndexBuilder\nAdds containment relationships to the rebuild process.\nAdds a new unit test for the IndexBuilderImpl\nUpdates the integration test (RebuildIT)\n\nHow should this be tested?\n\nStart up fedora\n\njava -jar fcrepo-webapp/target/fcrepo-webapp-6.0.0-SNAPSHOT-jetty-console.jar  --headless\n\n\nAdd some resources (archival group, binary and container in archival group, binary at root, container at root\n\n# container at root\ncurl -u fedoraAdmin:fedoraAdmin http://localhost:8080/rest  -X POST -H \"Slug: basic-container\"  -H \"Content-Type: text/turtle\" -v\n\n# archival group at root\ncurl -u fedoraAdmin:fedoraAdmin http://localhost:8080/rest -X POST -H \"Slug: archival-group\"  -H'Link: <http://fedora.info/definitions/v4/repository#ArchivalGroup>;rel=\"type\"' -v\n# binary in archival group\ncurl -u fedoraAdmin:fedoraAdmin http://localhost:8080/rest/archival-group -H \"Slug: binary\" -H \"Link: <http://www.w3.org/ns/ldp#NonRDFSource>; rel=type\" -v -H \"Content-Type: text/plain\"  -X POST --data \"test\"\n# container in archival group\ncurl -u fedoraAdmin:fedoraAdmin http://localhost:8080/rest/archival-group  -X POST -H \"Slug: basic-container\"  -H \"Content-Type: text/turtle\"\n\n\nDelete the ocfl-work directory\nrestart fedora\nverify that you can retrieve all the resources and the containment relationships are intact.\n\nNote:\nBinary at root cannot be retrieved. I believe this problem is addressed in @whikloj 's PR.\nInterested parties\n@whikloj ,  @bbpennel , @pwinckles", "createdAt": "2020-04-09T22:02:13Z", "url": "https://github.com/fcrepo/fcrepo/pull/1660", "merged": true, "mergeCommit": {"oid": "d707e4ad8812a56e51ad4db3fef1cc6fdf27d539"}, "closed": true, "closedAt": "2020-04-16T17:48:09Z", "author": {"login": "dbernstein"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcWEXY5gBqjMyMjAyMDIxMzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYQaAUgFqTM5NDg2Mzc5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "26690e265f10644c9eb3cde78f3ee55955e5ebd9", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/26690e265f10644c9eb3cde78f3ee55955e5ebd9", "committedDate": "2020-04-09T05:45:02Z", "message": "Refactors the index rebuild routine to include containment relationships.\n\nResolves: https://jira.lyrasis.org/browse/FCREPO-3247"}, "afterCommit": {"oid": "e69540fa2ae8c12a5c8496d9f6e8e560ef06d9bf", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/e69540fa2ae8c12a5c8496d9f6e8e560ef06d9bf", "committedDate": "2020-04-09T22:36:58Z", "message": "Refactors the index rebuild routine to include containment relationships.\n\nResolves: https://jira.lyrasis.org/browse/FCREPO-3247"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMTc0ODcy", "url": "https://github.com/fcrepo/fcrepo/pull/1660#pullrequestreview-391174872", "createdAt": "2020-04-09T22:33:21Z", "commit": {"oid": "26690e265f10644c9eb3cde78f3ee55955e5ebd9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMjozMzoyMVrOGDromQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMjo1MjoyMFrOGDsAWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUxMzgxNw==", "bodyText": "Containment Index now uses FedoraIds for this method, so you'll need to generate them.", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r406513817", "createdAt": "2020-04-09T22:33:21Z", "author": {"login": "whikloj"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/IndexBuilderImpl.java", "diffHunk": "@@ -77,10 +95,28 @@ public void rebuild() {\n                             //we're only interested in sidecar subpaths\n                             try {\n                                 final var headers = deserializeHeaders(objSession.read(subpath));\n-                                fedoraIds.add(headers.getId());\n+                                final var fedoraId = headers.getId();\n+                                fedoraIds.add(fedoraId);\n                                 if (headers.isArchivalGroup()) {\n                                     rootId.set(headers.getId());\n                                 }\n+\n+                                if(!fedoraId.equals(rootFedoraId)) {\n+                                    var parentId = headers.getParent();\n+\n+                                    if( parentId == null) {\n+                                        if (!fedoraId.endsWith(FCR_METADATA) &&\n+                                            !fedoraId.endsWith(FCR_ACL) &&\n+                                            !fedoraId.endsWith(FCR_VERSIONS)) {\n+                                            parentId = FEDORA_ID_PREFIX;\n+                                        }\n+                                    }\n+\n+                                    if (parentId != null) {\n+                                        this.containmentIndex.addContainedBy(txId, parentId, headers.getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26690e265f10644c9eb3cde78f3ee55955e5ebd9"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUxODU4NA==", "bodyText": "If you create fedoraId as a FedoraId then you could use fedoraId.isRepositoryRoot() here.", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r406518584", "createdAt": "2020-04-09T22:48:10Z", "author": {"login": "whikloj"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/IndexBuilderImpl.java", "diffHunk": "@@ -77,10 +95,28 @@ public void rebuild() {\n                             //we're only interested in sidecar subpaths\n                             try {\n                                 final var headers = deserializeHeaders(objSession.read(subpath));\n-                                fedoraIds.add(headers.getId());\n+                                final var fedoraId = headers.getId();\n+                                fedoraIds.add(fedoraId);\n                                 if (headers.isArchivalGroup()) {\n                                     rootId.set(headers.getId());\n                                 }\n+\n+                                if (!fedoraId.equals(rootFedoraId)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e69540fa2ae8c12a5c8496d9f6e8e560ef06d9bf"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUxODc3NA==", "bodyText": "Probably don't need to re-define this string here.", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r406518774", "createdAt": "2020-04-09T22:48:45Z", "author": {"login": "whikloj"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/IndexBuilderImpl.java", "diffHunk": "@@ -60,7 +72,13 @@ public void rebuild() {\n \n         LOGGER.info(\"Initiating index rebuild.\");\n         fedoraToOCFLObjectIndex.reset();\n+        final var transaction = transactionManager.create();\n+        final var txId = transaction.getId();\n+        final var rootFedoraId = FEDORA_ID_PREFIX;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e69540fa2ae8c12a5c8496d9f6e8e560ef06d9bf"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUxOTg5Ng==", "bodyText": "I don't think TimeMaps get persisted to OCFL.", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r406519896", "createdAt": "2020-04-09T22:52:20Z", "author": {"login": "whikloj"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/IndexBuilderImpl.java", "diffHunk": "@@ -77,10 +95,28 @@ public void rebuild() {\n                             //we're only interested in sidecar subpaths\n                             try {\n                                 final var headers = deserializeHeaders(objSession.read(subpath));\n-                                fedoraIds.add(headers.getId());\n+                                final var fedoraId = headers.getId();\n+                                fedoraIds.add(fedoraId);\n                                 if (headers.isArchivalGroup()) {\n                                     rootId.set(headers.getId());\n                                 }\n+\n+                                if (!fedoraId.equals(rootFedoraId)) {\n+                                    var parentId = headers.getParent();\n+\n+                                    if (parentId == null) {\n+                                        if (!fedoraId.endsWith(FCR_METADATA) &&\n+                                                !fedoraId.endsWith(FCR_ACL) &&\n+                                                !fedoraId.endsWith(FCR_VERSIONS)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e69540fa2ae8c12a5c8496d9f6e8e560ef06d9bf"}, "originalPosition": 85}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f554c17a8adf57f21d0611d75144f787d3b8d1a7", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/f554c17a8adf57f21d0611d75144f787d3b8d1a7", "committedDate": "2020-04-14T05:56:32Z", "message": "Refactors the index rebuild routine to include containment relationships.\n\nResolves: https://jira.lyrasis.org/browse/FCREPO-3247"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e69540fa2ae8c12a5c8496d9f6e8e560ef06d9bf", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/e69540fa2ae8c12a5c8496d9f6e8e560ef06d9bf", "committedDate": "2020-04-09T22:36:58Z", "message": "Refactors the index rebuild routine to include containment relationships.\n\nResolves: https://jira.lyrasis.org/browse/FCREPO-3247"}, "afterCommit": {"oid": "f554c17a8adf57f21d0611d75144f787d3b8d1a7", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/f554c17a8adf57f21d0611d75144f787d3b8d1a7", "committedDate": "2020-04-14T05:56:32Z", "message": "Refactors the index rebuild routine to include containment relationships.\n\nResolves: https://jira.lyrasis.org/browse/FCREPO-3247"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c9f9a7fa4ac6475ea0debbe82da78ff9b36b8b2", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/2c9f9a7fa4ac6475ea0debbe82da78ff9b36b8b2", "committedDate": "2020-04-14T17:09:49Z", "message": "Address feedback."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMjMyNjk3", "url": "https://github.com/fcrepo/fcrepo/pull/1660#pullrequestreview-393232697", "createdAt": "2020-04-14T19:31:42Z", "commit": {"oid": "2c9f9a7fa4ac6475ea0debbe82da78ff9b36b8b2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMjM1MzE1", "url": "https://github.com/fcrepo/fcrepo/pull/1660#pullrequestreview-393235315", "createdAt": "2020-04-14T19:35:47Z", "commit": {"oid": "2c9f9a7fa4ac6475ea0debbe82da78ff9b36b8b2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxOTozOToyNVrOGFeBdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQyMTowNDozNFrOGFg26Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM4Nzk1Nw==", "bodyText": "What are the other 3 new ids that it should be returning? Should we be testing that they are present like the previous ones?", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r408387957", "createdAt": "2020-04-14T19:39:25Z", "author": {"login": "bbpennel"}, "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/RebuildIT.java", "diffHunk": "@@ -108,22 +117,55 @@ public void testRebuildOCFL() {\n             ocflRepository.listObjectIds().forEach(id -> LOGGER.debug(\"Object id: {}\", id));\n         }\n \n-        // Test directly against the underlying OCFL repository\n-        Assert.assertEquals(4, ocflRepository.listObjectIds().count());\n-        Assert.assertTrue(\"Should contain object with id: binary\", ocflRepository.containsObject(\"binary\"));\n-        Assert.assertTrue(\"Should contain object with id: test\", ocflRepository.containsObject(\"test\"));\n-        Assert.assertTrue(\"Should contain object with id: test_child\", ocflRepository.containsObject(\"test_child\"));\n-        Assert.assertFalse(\"Should NOT contain object with id: junk\", ocflRepository.containsObject(\"junk\"));\n+        assertEquals(7, ocflRepository.listObjectIds().count());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c9f9a7fa4ac6475ea0debbe82da78ff9b36b8b2"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM5MzYwOQ==", "bodyText": "reformat into separate lines. Also add short description of flag parameter", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r408393609", "createdAt": "2020-04-14T19:50:02Z", "author": {"login": "bbpennel"}, "path": "fcrepo-persistence-common/src/main/java/org/fcrepo/persistence/common/ResourceHeadersImpl.java", "diffHunk": "@@ -240,4 +242,19 @@ public void setArchivalGroup(final boolean flag) {\n     public boolean isArchivalGroup() {\n         return archivalGroup;\n     }\n+\n+    /**\n+     *\n+     * @param flag\n+     */\n+    public void setObjectRoot(final boolean flag) { this.objectRoot = flag; }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c9f9a7fa4ac6475ea0debbe82da78ff9b36b8b2"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM5Mzc0Mw==", "bodyText": "space after if", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r408393743", "createdAt": "2020-04-14T19:50:14Z", "author": {"login": "bbpennel"}, "path": "fcrepo-persistence-common/src/main/java/org/fcrepo/persistence/common/ResourceHeadersImpl.java", "diffHunk": "@@ -240,4 +242,19 @@ public void setArchivalGroup(final boolean flag) {\n     public boolean isArchivalGroup() {\n         return archivalGroup;\n     }\n+\n+    /**\n+     *\n+     * @param flag\n+     */\n+    public void setObjectRoot(final boolean flag) { this.objectRoot = flag; }\n+\n+    @Override\n+    public boolean isObjectRoot() {\n+        if(isArchivalGroup()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c9f9a7fa4ac6475ea0debbe82da78ff9b36b8b2"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM5ODcxMw==", "bodyText": "the parent id should already be getting set by the call to newResourceHeaders I think? this this line can probably be removed", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r408398713", "createdAt": "2020-04-14T19:59:03Z", "author": {"login": "bbpennel"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/AbstractRDFSourcePersister.java", "diffHunk": "@@ -103,6 +105,8 @@ private ResourceHeaders populateHeaders(final OCFLObjectSession objSession, fina\n                     createOperation.getInteractionModel());\n             touchCreationHeaders(headers, operation.getUserPrincipal(), timeWritten);\n             headers.setArchivalGroup(createOperation.isArchivalGroup());\n+            headers.setParent(createOperation.getParentId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c9f9a7fa4ac6475ea0debbe82da78ff9b36b8b2"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQwMTEwMA==", "bodyText": "Just curious, what triggered the upgrade from FedoraToOCFLObjectIndexUtilImpl to IndexBuilderImpl? Maybe the javadoc for the class should describe what kind of index builder this is versus the interface?", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r408401100", "createdAt": "2020-04-14T20:03:25Z", "author": {"login": "bbpennel"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/IndexBuilderImpl.java", "diffHunk": "@@ -18,43 +18,50 @@\n package org.fcrepo.persistence.ocfl.impl;\n \n import edu.wisc.library.ocfl.api.OcflRepository;\n+import org.fcrepo.kernel.api.ContainmentIndex;\n+import org.fcrepo.kernel.api.TransactionManager;\n import org.fcrepo.kernel.api.exception.RepositoryRuntimeException;\n+import org.fcrepo.kernel.api.identifiers.FedoraId;\n import org.fcrepo.persistence.api.exceptions.PersistentStorageException;\n import org.fcrepo.persistence.ocfl.api.FedoraToOCFLObjectIndex;\n-import org.fcrepo.persistence.ocfl.api.FedoraToOCFLObjectIndexUtil;\n+import org.fcrepo.persistence.ocfl.api.IndexBuilder;\n import org.fcrepo.persistence.ocfl.api.OCFLObjectSessionFactory;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import org.springframework.stereotype.Component;\n \n import javax.inject.Inject;\n import java.util.ArrayList;\n-import java.util.Objects;\n import java.util.concurrent.atomic.AtomicReference;\n \n import static java.lang.String.format;\n \n-import static org.fcrepo.kernel.api.RdfLexicon.FEDORA_NON_RDF_SOURCE_DESCRIPTION_URI;\n import static org.fcrepo.persistence.common.ResourceHeaderSerializationUtils.deserializeHeaders;\n import static org.fcrepo.persistence.ocfl.impl.OCFLPersistentStorageUtils.isSidecarSubpath;\n \n /**\n- * An implementation of {@link FedoraToOCFLObjectIndexUtil}\n+ * An implementation of {@link IndexBuilder}\n  *\n  * @author dbernstein\n  * @since 6.0.0\n  */\n @Component\n-public class FedoraToOCFLObjectIndexUtilImpl implements FedoraToOCFLObjectIndexUtil {\n+public class IndexBuilderImpl implements IndexBuilder {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c9f9a7fa4ac6475ea0debbe82da78ff9b36b8b2"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQwMTY2Mw==", "bodyText": "Nothing happens between these two log statements. Are they both needed, or is there something missing here?", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r408401663", "createdAt": "2020-04-14T20:04:19Z", "author": {"login": "bbpennel"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/IndexBuilderImpl.java", "diffHunk": "@@ -63,7 +70,12 @@ public void rebuild() {\n \n         LOGGER.info(\"Initiating index rebuild.\");\n         fedoraToOCFLObjectIndex.reset();\n+        final var transaction = transactionManager.create();\n+        final var txId = transaction.getId();\n+        LOGGER.info(\"Resetting ContaintmentIndex...\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c9f9a7fa4ac6475ea0debbe82da78ff9b36b8b2"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQyMTYyNA==", "bodyText": "Maybe we can address this later, but if a file exists in an archival group, but is neither the root nor has a defined parent, we should be able to determine a parent id based on the file hierarchy. This would be the case for non-fedora ocfl, and at some point we might want to make the parent implicit within archival groups (that's come up on a few calls)", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r408421624", "createdAt": "2020-04-14T20:40:48Z", "author": {"login": "bbpennel"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/IndexBuilderImpl.java", "diffHunk": "@@ -80,14 +92,28 @@ public void rebuild() {\n                             //we're only interested in sidecar subpaths\n                             try {\n                                 final var headers = deserializeHeaders(objSession.read(subpath));\n-                                fedoraIds.add(headers.getId());\n-                                if (headers.isArchivalGroup()) {\n+                                final var fedoraId = FedoraId.create(headers.getId());\n+                                fedoraIds.add(fedoraId.getFullId());\n+                                if (headers.isArchivalGroup() || headers.isObjectRoot()) {\n                                     rootId.set(headers.getId());\n-                                } else if (Objects.equals(headers.getInteractionModel(),\n-                                        FEDORA_NON_RDF_SOURCE_DESCRIPTION_URI)) {\n-                                    rootId.set(headers.getParent());\n                                 }\n-                            } catch (final PersistentStorageException e) {\n+\n+                                if (!fedoraId.isRepositoryRoot()) {\n+                                    var parentId = headers.getParent();\n+\n+                                    if (parentId == null) {\n+                                        if (headers.isObjectRoot()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c9f9a7fa4ac6475ea0debbe82da78ff9b36b8b2"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQyOTk2OQ==", "bodyText": "assertIndexContains actually seems to verify what the ocfl object id assigned to an id is, rather than whether it is in the index or not. Maybe the name of the method could be updated to clarify its purpose? assertHasOcflId or something. I was having a hard time understanding what this assertion was checking.", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r408429969", "createdAt": "2020-04-14T20:56:12Z", "author": {"login": "bbpennel"}, "path": "fcrepo-persistence-ocfl/src/test/java/org/fcrepo/persistence/ocfl/impl/IndexBuilderImplTest.java", "diffHunk": "@@ -127,51 +152,57 @@ public void rebuildWhenRepoContainsNonArchivalGroupObject() throws Exception {\n         assertIndexDoesNotContain(resource1);\n         assertIndexDoesNotContain(resource2);\n \n-        util.rebuild();\n+        indexBuilder.rebuild();\n \n         assertIndexContains(\"resource1\", resource1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c9f9a7fa4ac6475ea0debbe82da78ff9b36b8b2"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQzMTk1Nw==", "bodyText": "Maybe this could be for later, but it'd be good to verify that a rebuild works with ghost nodes.", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r408431957", "createdAt": "2020-04-14T20:59:58Z", "author": {"login": "bbpennel"}, "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/RebuildIT.java", "diffHunk": "@@ -108,22 +117,55 @@ public void testRebuildOCFL() {\n             ocflRepository.listObjectIds().forEach(id -> LOGGER.debug(\"Object id: {}\", id));\n         }\n \n-        // Test directly against the underlying OCFL repository\n-        Assert.assertEquals(4, ocflRepository.listObjectIds().count());\n-        Assert.assertTrue(\"Should contain object with id: binary\", ocflRepository.containsObject(\"binary\"));\n-        Assert.assertTrue(\"Should contain object with id: test\", ocflRepository.containsObject(\"test\"));\n-        Assert.assertTrue(\"Should contain object with id: test_child\", ocflRepository.containsObject(\"test_child\"));\n-        Assert.assertFalse(\"Should NOT contain object with id: junk\", ocflRepository.containsObject(\"junk\"));\n+        assertEquals(7, ocflRepository.listObjectIds().count());\n+        assertTrue(\"Should contain object with id: binary\", ocflRepository.containsObject(\"binary\"));\n+        assertTrue(\"Should contain object with id: test\", ocflRepository.containsObject(\"test\"));\n+        assertTrue(\"Should contain object with id: test_child\", ocflRepository.containsObject(\"test_child\"));\n+        assertFalse(\"Should NOT contain object with id: junk\", ocflRepository.containsObject(\"junk\"));\n     }\n \n     @Test\n-    public void testRebuildWebapp() {\n+    public void testRebuildWebapp() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c9f9a7fa4ac6475ea0debbe82da78ff9b36b8b2"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQzNDQwOQ==", "bodyText": "It would be good to have a test somewhere that verifies this new behavior, maybe in CreateNonRdfSourcePersisterTest. An integration test would be nice since it'd make sure that a blank subpath gets generated, but that might not be practical at the moment, not sure.", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r408434409", "createdAt": "2020-04-14T21:04:34Z", "author": {"login": "bbpennel"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/AbstractNonRdfSourcePersister.java", "diffHunk": "@@ -108,7 +108,8 @@ protected void persistNonRDFSource(final ResourceOperation operation,\n         }\n \n         // Write resource headers\n-        final var headers = populateHeaders(objectSession, subpath, nonRdfSourceOperation, outcome);\n+        final var headers = populateHeaders(objectSession, subpath, nonRdfSourceOperation, outcome,\n+                fedoraSubpath == \"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c9f9a7fa4ac6475ea0debbe82da78ff9b36b8b2"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13d577030b8041e6e4b3bb5abe2a2fde96e1f8bc", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/13d577030b8041e6e4b3bb5abe2a2fde96e1f8bc", "committedDate": "2020-04-15T22:39:42Z", "message": "Addresses remaining feedback on https://github.com/fcrepo4/fcrepo4/pull/1660"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0ODYzNzk2", "url": "https://github.com/fcrepo/fcrepo/pull/1660#pullrequestreview-394863796", "createdAt": "2020-04-16T17:47:09Z", "commit": {"oid": "13d577030b8041e6e4b3bb5abe2a2fde96e1f8bc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3082, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}