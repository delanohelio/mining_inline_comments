{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1NTY3NjU1", "number": 1740, "title": "Run ITests against all DBs", "bodyText": "JIRA Ticket: https://jira.lyrasis.org/browse/FCREPO-3382\nPrevious work: #1734\nWhat does this Pull Request do?\n\nAdds 3 new Travis jobs to run all of the ITests against PostgreSQL, MaraiDB, and MySQL. This code is based on experimenting I did here: https://github.com/pwinckles/travis-db-test\nAdds a listener that baselines the DB and OCFL repo between ITests\n\nHow should this be tested?\nThe Travis build should pass.\nInterested parties\n@fcrepo4/committers", "createdAt": "2020-08-10T15:21:00Z", "url": "https://github.com/fcrepo/fcrepo/pull/1740", "merged": true, "mergeCommit": {"oid": "0c29c4421e0e4b95cb78047e9c1d15e88a144302"}, "closed": true, "closedAt": "2020-08-21T14:38:30Z", "author": {"login": "pwinckles"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9jxuPgH2gAyNDY1NTY3NjU1OjUzMjgxYTI3YjkxZDA5NmRiYjA2MzZiN2EyN2I1ZDJiMWRiZTA1NTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdBF0NtgFqTQ3MjU0NTU0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "53281a27b91d096dbb0636b7a27b5d2b1dbe0550", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/53281a27b91d096dbb0636b7a27b5d2b1dbe0550", "committedDate": "2020-08-10T15:16:27Z", "message": "Run ITests against all DBs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5595c296cfea496e31642c9dfaef3661b45b00a1", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/5595c296cfea496e31642c9dfaef3661b45b00a1", "committedDate": "2020-08-10T15:37:02Z", "message": "corrected property names"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b0e88122a9ad9752448142d1e4ac904d45f5fa1", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/2b0e88122a9ad9752448142d1e4ac904d45f5fa1", "committedDate": "2020-08-10T15:46:40Z", "message": "fixed property names again"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1c17ad3d90f27a7c5a6643fe9ce975b7a2ce2c9", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/a1c17ad3d90f27a7c5a6643fe9ce975b7a2ce2c9", "committedDate": "2020-08-10T15:56:00Z", "message": "bump postgres version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18f52f8a1fd45199b979573df40e55eda68a01ac", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/18f52f8a1fd45199b979573df40e55eda68a01ac", "committedDate": "2020-08-10T16:03:48Z", "message": "try postgres on xenial"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49e3fa9cdb92f8df0156ed2808407766843887a4", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/49e3fa9cdb92f8df0156ed2808407766843887a4", "committedDate": "2020-08-10T16:18:35Z", "message": "yet another postgres attempt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a26457b369b82cddab80048e9b9f7bd7bd35b1b", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/5a26457b369b82cddab80048e9b9f7bd7bd35b1b", "committedDate": "2020-08-10T19:21:00Z", "message": "yet another postgres attempt 2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f928370bf8c7519f40f3dd9361fffd2cb3d72f0a", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/f928370bf8c7519f40f3dd9361fffd2cb3d72f0a", "committedDate": "2020-08-10T19:27:15Z", "message": "yet another postgres attempt 3"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f01c9d0c8224c836c1f49795e206b1ce00eeb4c6", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/f01c9d0c8224c836c1f49795e206b1ce00eeb4c6", "committedDate": "2020-08-10T19:44:40Z", "message": "travis cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1e1231bb1ec0798fd0fd50ee2822d4289f10e77", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/e1e1231bb1ec0798fd0fd50ee2822d4289f10e77", "committedDate": "2020-08-10T19:50:51Z", "message": "fix travis logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ad698bfab4edcf9098283a6afd52f4a538e981e", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/0ad698bfab4edcf9098283a6afd52f4a538e981e", "committedDate": "2020-08-10T20:29:47Z", "message": "attempt to fix some concurrency issues in itests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MTAyNDI5", "url": "https://github.com/fcrepo/fcrepo/pull/1740#pullrequestreview-465102429", "createdAt": "2020-08-11T14:09:03Z", "commit": {"oid": "0ad698bfab4edcf9098283a6afd52f4a538e981e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNDowOTowM1rOG-5ljg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNDozMDoxM1rOG-6spA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYwODM5OA==", "bodyText": "doesn't seem to make a difference here, but might be a good idea to remove the double slash", "url": "https://github.com/fcrepo/fcrepo/pull/1740#discussion_r468608398", "createdAt": "2020-08-11T14:09:03Z", "author": {"login": "bbpennel"}, "path": ".travis.yml", "diffHunk": "@@ -1,13 +1,69 @@\n \n jobs:\n   include:\n-    - os: linux\n-      language: java\n+    - name: Build - Linux\n+      os: linux\n       dist: trusty\n       sudo: true\n+      language: java\n       jdk: openjdk11\n-    - os: windows\n+      env: DEPLOY=true\n+    - name: Build - Windows\n+      os: windows\n       language: shell\n+    - name: ITests - PostgreSQL\n+      os: linux\n+      dist: focal\n+      sudo: true\n+      language: java\n+      jdk: openjdk11\n+      addons:\n+        postgresql: '12'\n+        apt:\n+          packages:\n+            - postgresql-12\n+            - postgresql-client-12\n+      env:\n+        - DB=postgresql\n+        - DB_PORT=5432\n+        - ITEST=true\n+      before_script:\n+        - psql -c 'CREATE DATABASE fcrepo;' -U postgres\n+    - name: ITests - MariaDB\n+      os: linux\n+      dist: trusty\n+      sudo: true\n+      language: java\n+      jdk: openjdk11\n+      addons:\n+        mariadb: \"10.4\"\n+      env:\n+        - DB=mariadb\n+        - DB_PORT=3306\n+        - ITEST=true\n+      before_script:\n+        - mysql -e 'CREATE DATABASE IF NOT EXISTS fcrepo;'\n+    - name: ITests - MySQL\n+      os: linux\n+      dist: xenial\n+      sudo: true\n+      language: java\n+      jdk: openjdk11\n+      env:\n+        - DB=mysql\n+        - DB_PORT=3306\n+        - ITEST=true\n+      services:\n+        - mysql\n+      before_script:\n+        - wget https://repo.mysql.com//mysql-apt-config_0.8.10-1_all.deb", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ad698bfab4edcf9098283a6afd52f4a538e981e"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYyNjU5Ng==", "bodyText": "If i'm understanding correctly, this change basically increases wiggle room allowed between the expected timestamp and the real timestamp up to the minutes range? Sort of wondering if it can tell apart the 4 mementos created in that test since they are separated by 1 second each, but it seems like that already would have been an issue since it seems like it was trimming off the seconds from the timestamp.\nI'm actually kind of surprised this test is passing since the logs for it are cranking out a lot of grizzly Method Not Allowed errors. But I can't really remember where versioning support stands in fedora 6 at the moment anyway.", "url": "https://github.com/fcrepo/fcrepo/pull/1740#discussion_r468626596", "createdAt": "2020-08-11T14:30:13Z", "author": {"login": "bbpennel"}, "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraVersioningIT.java", "diffHunk": "@@ -853,8 +853,8 @@ private void assertMementoLink(final Link expected, final Link actual) {\n \n             final var expectedUri = expected.getUri().toString();\n             final var actualUri = actual.getUri().toString();\n-            assertEquals(expectedUri.substring(0, expectedUri.length() - 2),\n-                    actualUri.substring(0, actualUri.length() - 2));\n+            assertEquals(expectedUri.substring(0, expectedUri.length() - 3),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ad698bfab4edcf9098283a6afd52f4a538e981e"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "551c8e6b5c72e0a2f4aa89bd565eaf757f111e7e", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/551c8e6b5c72e0a2f4aa89bd565eaf757f111e7e", "committedDate": "2020-08-11T14:41:56Z", "message": "remove duplicate slash"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07b2d27049ca22756a64388b181956f32db27ed1", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/07b2d27049ca22756a64388b181956f32db27ed1", "committedDate": "2020-08-12T12:58:12Z", "message": "try to fix mysql deadlock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ad140c70e621ab08851865b3b3192f0aa87cf60", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/0ad140c70e621ab08851865b3b3192f0aa87cf60", "committedDate": "2020-08-12T18:58:24Z", "message": "baseline DB and OCFL repo between ITests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "472f76d3beb7e78c88f74b7915c7bf07da141837", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/472f76d3beb7e78c88f74b7915c7bf07da141837", "committedDate": "2020-08-12T20:04:11Z", "message": "try to fix windows directory creation problem"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90b47324680b24c792f0b80e90ddb97ff33ed391", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/90b47324680b24c792f0b80e90ddb97ff33ed391", "committedDate": "2020-08-12T20:20:40Z", "message": "increasing wait for queued file deletions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "038e3ec23c16afe42d899e06b9f369ac8892dfab", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/038e3ec23c16afe42d899e06b9f369ac8892dfab", "committedDate": "2020-08-12T20:41:57Z", "message": "do not baseline on windows"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyMDEzNTA3", "url": "https://github.com/fcrepo/fcrepo/pull/1740#pullrequestreview-472013507", "createdAt": "2020-08-20T21:56:45Z", "commit": {"oid": "038e3ec23c16afe42d899e06b9f369ac8892dfab"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQyMTo1Njo0NVrOHEUqxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQxMzoyODo0NFrOHEtLGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI5NDk4MQ==", "bodyText": "We can likely delete this class, since the only use in the fcrepo-auth-webac module is actually referencing the copy of this class found in fcrepo-http-api.\nhttps://github.com/fcrepo4/fcrepo4/pull/1740/files#diff-cd44216a669bfca1b37f93a8ab06cf01R77", "url": "https://github.com/fcrepo/fcrepo/pull/1740#discussion_r474294981", "createdAt": "2020-08-20T21:56:45Z", "author": {"login": "awoods"}, "path": "fcrepo-auth-webac/src/test/java/org/fcrepo/integration/auth/webac/LinuxTestIsolationExecutionListener.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Licensed to DuraSpace under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional information\n+ * regarding copyright ownership.\n+ *\n+ * DuraSpace licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except in\n+ * compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.fcrepo.integration.auth.webac;\n+\n+import edu.wisc.library.ocfl.api.MutableOcflRepository;\n+import org.apache.commons.lang3.SystemUtils;\n+import org.fcrepo.http.commons.test.util.ContainerWrapper;\n+import org.fcrepo.persistence.ocfl.RepositoryInitializer;\n+import org.springframework.test.context.TestContext;\n+import org.springframework.test.context.support.AbstractTestExecutionListener;\n+\n+/**\n+ * Listener that baselines the DB and OCFL repo between every test.\n+ * It does not baseline on Windows due to difficulties associated with deleting and immediately recreating directories.\n+ *\n+ * @author pwinckles\n+ */\n+public class LinuxTestIsolationExecutionListener extends AbstractTestExecutionListener {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "038e3ec23c16afe42d899e06b9f369ac8892dfab"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI5ODU4NQ==", "bodyText": "A comment here explaining the magic number (3) would be helpful to our future selves.", "url": "https://github.com/fcrepo/fcrepo/pull/1740#discussion_r474298585", "createdAt": "2020-08-20T22:05:46Z", "author": {"login": "awoods"}, "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraVersioningIT.java", "diffHunk": "@@ -853,8 +857,8 @@ private void assertMementoLink(final Link expected, final Link actual) {\n \n             final var expectedUri = expected.getUri().toString();\n             final var actualUri = actual.getUri().toString();\n-            assertEquals(expectedUri.substring(0, expectedUri.length() - 2),\n-                    actualUri.substring(0, actualUri.length() - 2));\n+            assertEquals(expectedUri.substring(0, expectedUri.length() - 3),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "038e3ec23c16afe42d899e06b9f369ac8892dfab"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDY5NjQ3Mg==", "bodyText": "The profile name should match the name defined in the pom.xml: db-test (vs db-tests)", "url": "https://github.com/fcrepo/fcrepo/pull/1740#discussion_r474696472", "createdAt": "2020-08-21T13:28:44Z", "author": {"login": "awoods"}, "path": ".travis.yml", "diffHunk": "@@ -48,7 +106,8 @@ before_script:\n    fi\n     \n script:\n- - ./mvnw --settings .travis/settings.xml -Dgpg.skip -Dfcrepo.streaming.parallel=true install -B -V\n+ - if [ \"$ITEST\" != \"true\" ]; then ./mvnw --settings .travis/settings.xml -Dgpg.skip -Dfcrepo.streaming.parallel=true install -B -V; fi\n+ - if [ \"$ITEST\" = \"true\" ]; then ./mvnw -Dfcrepo.db.url=\"jdbc:${DB}://localhost:${DB_PORT}/fcrepo\" -Dfcrepo.db.user=\"travis\" -Dfcrepo.db.password=\"\" clean install -P db-tests; fi", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "038e3ec23c16afe42d899e06b9f369ac8892dfab"}, "originalPosition": 101}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1a5a16015fcb3dc7d5c61d2ca3acf12e36f63fd", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/f1a5a16015fcb3dc7d5c61d2ca3acf12e36f63fd", "committedDate": "2020-08-21T14:10:53Z", "message": "pr fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyNTQ1NTQz", "url": "https://github.com/fcrepo/fcrepo/pull/1740#pullrequestreview-472545543", "createdAt": "2020-08-21T14:37:43Z", "commit": {"oid": "f1a5a16015fcb3dc7d5c61d2ca3acf12e36f63fd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3185, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}