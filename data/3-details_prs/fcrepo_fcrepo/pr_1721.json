{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4NTA4NDYy", "number": 1721, "title": "Ensures that Fedora docker image is rebuilt and published to docker h\u2026", "bodyText": "Ensures that Fedora docker image is rebuilt and published to dockerhub on updates to main branch\n\nJIRA Ticket: https://jira.lyrasis.org/browse/FCREPO-3319\n\nOther Relevant Links (Mailing list discussion, related pull requests, etc.)\n\nWhat does this Pull Request do?\nA brief description of what the intended result of the PR will be and/or what problem it solves.\nHow should this be tested?\nThis PR is tricky to test because it works in conjunction with the travis build environment and relies on having a dockhub account.   I tested it locally by commenting out the sonatype updates and changing ./mvnw to mvn and exporting my DOCKER_USERNAME and DOCKER_PASSWORD environment variables before running to the .travis.deploy.sh script.\nInterested parties\nTag (@ mention) interested parties or, if unsure, @fcrepo4/committers", "createdAt": "2020-07-13T21:33:37Z", "url": "https://github.com/fcrepo/fcrepo/pull/1721", "merged": true, "mergeCommit": {"oid": "43274e7c8c3264ad08404d57da8ca149e7b16db3"}, "closed": true, "closedAt": "2020-07-16T20:23:56Z", "author": {"login": "dbernstein"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0oU4IgH2gAyNDQ4NTA4NDYyOmFhMTE2M2Q4MGUyZDg1ZjdlYzY3ZDdjOGM1YjZlZDc3ZWVmOWIzOGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1lL_PgFqTQ1MDE4ODY1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "aa1163d80e2d85f7ec67d7c8c5b6ed77eef9b38d", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/aa1163d80e2d85f7ec67d7c8c5b6ed77eef9b38d", "committedDate": "2020-07-13T21:29:09Z", "message": "Ensures that Fedora docker image is rebuilt and published to docker hub on\nupdates to main.\nResolves: https://jira.lyrasis.org/browse/FCREPO-3319"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5b31a0dd334cc35ca1105b8974be523c62320e7", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/b5b31a0dd334cc35ca1105b8974be523c62320e7", "committedDate": "2020-07-13T21:35:51Z", "message": "Changes travis branch from master to main."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3NjQxNTc4", "url": "https://github.com/fcrepo/fcrepo/pull/1721#pullrequestreview-447641578", "createdAt": "2020-07-13T22:02:25Z", "commit": {"oid": "b5b31a0dd334cc35ca1105b8974be523c62320e7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QyMjowMjoyNVrOGw7umQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QyMjowMjoyNVrOGw7umQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk2MzQxNw==", "bodyText": "Should this be uncommented?", "url": "https://github.com/fcrepo/fcrepo/pull/1721#discussion_r453963417", "createdAt": "2020-07-13T22:02:25Z", "author": {"login": "awoods"}, "path": ".travis/deploy.sh", "diffHunk": "@@ -2,6 +2,18 @@ if [ ! -z \"$TRAVIS_TAG\" ]\n then\n     echo \"on a tag -> $TRAVIS_TAG and therefore we will do nothing. Tagged releases are deployed to sonatype manually.\"\n else\n-    echo \"not on a tag -> deploying to sonatype snapshot repo...\"\n-    ./mvnw clean deploy --settings .travis/settings.xml -DskipTests=true -B -U\n+    echo \"not on a tag -> deploying to dockerhub and sonatype...\"\n+    FCREPO_VERSION=$(./mvnw org.apache.maven.plugins:maven-help-plugin:3.1.0:evaluate -Dexpression=project.version -q -DforceStdout)\n+    \n+    echo \"clone fcrepo4-labs/fcrepo-docker repository\"\n+    git clone https://github.com/fcrepo4-labs/fcrepo-docker.git\n+    echo \"building docker container\"\n+    cd fcrepo-docker\n+    ./build.sh ../fcrepo-webapp/target/fcrepo-webapp-${FCREPO_VERSION}.war\n+    echo \"push image to dockerhub\"\n+    ./push.sh latest ${FCREPO_VERSION}\n+    cd ..\n+\n+    echo \"deploying to sonatype snapshot repo...\"\n+#    ./mvnw clean deploy --settings .travis/settings.xml -DskipTests=true -B -U", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5b31a0dd334cc35ca1105b8974be523c62320e7"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25ae09e188eef52f5f93d79297600d817c2b2ccb", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/25ae09e188eef52f5f93d79297600d817c2b2ccb", "committedDate": "2020-07-14T18:07:46Z", "message": "uncomments mvnw command"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NjI4MTQz", "url": "https://github.com/fcrepo/fcrepo/pull/1721#pullrequestreview-449628143", "createdAt": "2020-07-16T08:25:06Z", "commit": {"oid": "25ae09e188eef52f5f93d79297600d817c2b2ccb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwODoyNTowN1rOGygZYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwODoyNTowN1rOGygZYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYxMjc3MQ==", "bodyText": "We might want to build the container within the default travis pipeline instead of in the deploy part and only include the push command here.", "url": "https://github.com/fcrepo/fcrepo/pull/1721#discussion_r455612771", "createdAt": "2020-07-16T08:25:07Z", "author": {"login": "tomcbe"}, "path": ".travis/deploy.sh", "diffHunk": "@@ -2,6 +2,18 @@ if [ ! -z \"$TRAVIS_TAG\" ]\n then\n     echo \"on a tag -> $TRAVIS_TAG and therefore we will do nothing. Tagged releases are deployed to sonatype manually.\"\n else\n-    echo \"not on a tag -> deploying to sonatype snapshot repo...\"\n+    echo \"not on a tag -> deploying to dockerhub and sonatype...\"\n+    FCREPO_VERSION=$(./mvnw org.apache.maven.plugins:maven-help-plugin:3.1.0:evaluate -Dexpression=project.version -q -DforceStdout)\n+    \n+    echo \"clone fcrepo4-labs/fcrepo-docker repository\"\n+    git clone https://github.com/fcrepo4-labs/fcrepo-docker.git\n+    echo \"building docker container\"\n+    cd fcrepo-docker\n+    ./build.sh ../fcrepo-webapp/target/fcrepo-webapp-${FCREPO_VERSION}.war", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25ae09e188eef52f5f93d79297600d817c2b2ccb"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NjI5MTAy", "url": "https://github.com/fcrepo/fcrepo/pull/1721#pullrequestreview-449629102", "createdAt": "2020-07-16T08:26:19Z", "commit": {"oid": "25ae09e188eef52f5f93d79297600d817c2b2ccb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwODoyNjoxOVrOGygcVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwODoyNjoxOVrOGygcVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYxMzUyNg==", "bodyText": "Change message to: \"on a tag -> $TRAVIS_TAG and therefore we will do nothing. Tagged releases are deployed to sonatype and Docker Hub manually.\"", "url": "https://github.com/fcrepo/fcrepo/pull/1721#discussion_r455613526", "createdAt": "2020-07-16T08:26:19Z", "author": {"login": "tomcbe"}, "path": ".travis/deploy.sh", "diffHunk": "@@ -2,6 +2,18 @@ if [ ! -z \"$TRAVIS_TAG\" ]\n then\n     echo \"on a tag -> $TRAVIS_TAG and therefore we will do nothing. Tagged releases are deployed to sonatype manually.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25ae09e188eef52f5f93d79297600d817c2b2ccb"}, "originalPosition": 2}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5OTg4NTgx", "url": "https://github.com/fcrepo/fcrepo/pull/1721#pullrequestreview-449988581", "createdAt": "2020-07-16T15:56:31Z", "commit": {"oid": "25ae09e188eef52f5f93d79297600d817c2b2ccb"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "475e5f06c3c016483f20dd8f52666486428fddaf", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/475e5f06c3c016483f20dd8f52666486428fddaf", "committedDate": "2020-07-16T19:55:30Z", "message": "Impoves log message in deploy.sh"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMTg4NjU5", "url": "https://github.com/fcrepo/fcrepo/pull/1721#pullrequestreview-450188659", "createdAt": "2020-07-16T20:23:40Z", "commit": {"oid": "475e5f06c3c016483f20dd8f52666486428fddaf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3163, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}