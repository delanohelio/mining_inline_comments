{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyODA0NDM5", "number": 1603, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQyMjo1NToxOVrODYA7zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNjo0OToyNVrODYPd5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NTA3NzI3OnYy", "diffSide": "RIGHT", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQyMjo1NToxOVrOFdoe8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQyMjo1NToxOVrOFdoe8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxNjMwNw==", "bodyText": "@whikloj :  There are constants these directories in DefaultOCFLObjectSessionFactory.  I would moving DefaultOCFLObjectSessionFactory.STAGING_DIR,  DefaultOCFLObjectSessionFactory.OCFL_STORAGE_ROOT_DIR,  DefaultOCFLObjectSessionFactory.OCFL_WORK_DIR and DefaultOCFLObjectSessionFactory.resolveDir() into OCFLPersistenceConstants and then having FedoraToOCFLObjectIndexImpl use them in order to eliminate the duplicate code.", "url": "https://github.com/fcrepo/fcrepo/pull/1603#discussion_r366616307", "createdAt": "2020-01-14T22:55:19Z", "author": {"login": "dbernstein"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImpl.java", "diffHunk": "@@ -35,10 +46,36 @@\n  */\n @Component\n public class FedoraToOCFLObjectIndexImpl implements FedoraToOCFLObjectIndex {\n+\n+    private Path indexFilePath = getProperty(\"fcrepo.ocfl.work.dir\") == null ?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4edf243a4695a10e251d32bbe015f40701ae2e93"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NTA4MDUwOnYy", "diffSide": "RIGHT", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImpl.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQyMjo1Njo0MlrOFdog4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNzozOTowNVrOFeAtUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxNjgwMw==", "bodyText": "Make fedoraToOcflIndex.tsv a constant as well.", "url": "https://github.com/fcrepo/fcrepo/pull/1603#discussion_r366616803", "createdAt": "2020-01-14T22:56:42Z", "author": {"login": "dbernstein"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImpl.java", "diffHunk": "@@ -35,10 +46,36 @@\n  */\n @Component\n public class FedoraToOCFLObjectIndexImpl implements FedoraToOCFLObjectIndex {\n+\n+    private Path indexFilePath = getProperty(\"fcrepo.ocfl.work.dir\") == null ?\n+            Paths.get(JAVA_IO_TMPDIR, \"fcrepo.ocfl.work.dir\", \"fedoraToOcflIndex.tsv\") :", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4edf243a4695a10e251d32bbe015f40701ae2e93"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njk1Mzg1NQ==", "bodyText": "I just made a constant of the FILE with the text \"fedoraToOcflIndex.tsv\", I could make that String a constant and use it in the other constant.\nBut that seemed like overkill as I feel that this will go away once we have a non-in-memory index.", "url": "https://github.com/fcrepo/fcrepo/pull/1603#discussion_r366953855", "createdAt": "2020-01-15T15:52:03Z", "author": {"login": "whikloj"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImpl.java", "diffHunk": "@@ -35,10 +46,36 @@\n  */\n @Component\n public class FedoraToOCFLObjectIndexImpl implements FedoraToOCFLObjectIndex {\n+\n+    private Path indexFilePath = getProperty(\"fcrepo.ocfl.work.dir\") == null ?\n+            Paths.get(JAVA_IO_TMPDIR, \"fcrepo.ocfl.work.dir\", \"fedoraToOcflIndex.tsv\") :", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxNjgwMw=="}, "originalCommit": {"oid": "4edf243a4695a10e251d32bbe015f40701ae2e93"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAxMzIwMg==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/fcrepo/fcrepo/pull/1603#discussion_r367013202", "createdAt": "2020-01-15T17:39:05Z", "author": {"login": "dbernstein"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImpl.java", "diffHunk": "@@ -35,10 +46,36 @@\n  */\n @Component\n public class FedoraToOCFLObjectIndexImpl implements FedoraToOCFLObjectIndex {\n+\n+    private Path indexFilePath = getProperty(\"fcrepo.ocfl.work.dir\") == null ?\n+            Paths.get(JAVA_IO_TMPDIR, \"fcrepo.ocfl.work.dir\", \"fedoraToOcflIndex.tsv\") :", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxNjgwMw=="}, "originalCommit": {"oid": "4edf243a4695a10e251d32bbe015f40701ae2e93"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NTA4MTg1OnYy", "diffSide": "RIGHT", "path": "fcrepo-persistence-ocfl/src/test/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImplTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQyMjo1NzoxNlrOFdohtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQyMjo1NzoxNlrOFdohtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxNzAxNA==", "bodyText": "Use constants per above refactoring suggestion.", "url": "https://github.com/fcrepo/fcrepo/pull/1603#discussion_r366617014", "createdAt": "2020-01-14T22:57:16Z", "author": {"login": "dbernstein"}, "path": "fcrepo-persistence-ocfl/src/test/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImplTest.java", "diffHunk": "@@ -36,6 +52,16 @@\n     private static final String OCFL_ID = \"ocfl-id\";\n     private static final String OCFL_ID_RESOURCE_3 = \"ocfl-id-resource-3\";\n \n+    private final Path indexMappingPath = getProperty(\"fcrepo.ocfl.work.dir\") == null ?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4edf243a4695a10e251d32bbe015f40701ae2e93"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NzQwNTM0OnYy", "diffSide": "RIGHT", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNjozNDoyOFrOFd-oWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNjozNDoyOFrOFd-oWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njk3OTE2MA==", "bodyText": "Please add a documentation note describing the expected layout/fields in the .tsv file.\nThe use of map.length == 3 and indexing into the map array seem a bit opaque.", "url": "https://github.com/fcrepo/fcrepo/pull/1603#discussion_r366979160", "createdAt": "2020-01-15T16:34:28Z", "author": {"login": "awoods"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImpl.java", "diffHunk": "@@ -35,10 +42,30 @@\n  */\n @Component\n public class FedoraToOCFLObjectIndexImpl implements FedoraToOCFLObjectIndex {\n+\n     private static Logger LOGGER = LoggerFactory.getLogger(FedoraToOCFLObjectIndexImpl.class);\n \n     private Map<String, FedoraOCFLMapping> fedoraOCFLMappingMap = Collections.synchronizedMap(new HashMap<>());\n \n+    /**\n+     * Constructor", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c43e4e0553eee11cb6c06a84a192fd8828994d6"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NzQyNDkxOnYy", "diffSide": "RIGHT", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNjo0MDowMFrOFd-0hQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNjo0MDowMFrOFd-0hQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njk4MjI3Nw==", "bodyText": "Maybe add a log message if the length is not 3?", "url": "https://github.com/fcrepo/fcrepo/pull/1603#discussion_r366982277", "createdAt": "2020-01-15T16:40:00Z", "author": {"login": "awoods"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImpl.java", "diffHunk": "@@ -35,10 +42,30 @@\n  */\n @Component\n public class FedoraToOCFLObjectIndexImpl implements FedoraToOCFLObjectIndex {\n+\n     private static Logger LOGGER = LoggerFactory.getLogger(FedoraToOCFLObjectIndexImpl.class);\n \n     private Map<String, FedoraOCFLMapping> fedoraOCFLMappingMap = Collections.synchronizedMap(new HashMap<>());\n \n+    /**\n+     * Constructor\n+     * @throws IOException If we can't access the file.\n+     */\n+    public FedoraToOCFLObjectIndexImpl() throws IOException {\n+        if (FEDORA_TO_OCFL_INDEX_FILE.exists() && FEDORA_TO_OCFL_INDEX_FILE.canRead()) {\n+            Files.lines(FEDORA_TO_OCFL_INDEX_FILE.toPath()).filter(l -> {\n+                final String m = l.split(\"\\t\")[0];\n+                return (!fedoraOCFLMappingMap.containsKey(m));\n+            }).forEach(l -> {\n+                final String[] map = l.split(\"\\t\");\n+                if (map.length == 3) {\n+                    final FedoraOCFLMapping ocflMapping = new FedoraOCFLMapping(map[1], map[2]);\n+                    fedoraOCFLMappingMap.put(map[0], ocflMapping);\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c43e4e0553eee11cb6c06a84a192fd8828994d6"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NzQ1NTEwOnYy", "diffSide": "RIGHT", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNjo0ODoyNVrOFd_G5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNjo0ODoyNVrOFd_G5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njk4Njk4Mw==", "bodyText": "Instead of these contortions, can you try either:\n\nhttps://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/nio/file/Path.html#getParent() or\nhttps://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/io/File.html#getParentFile()", "url": "https://github.com/fcrepo/fcrepo/pull/1603#discussion_r366986983", "createdAt": "2020-01-15T16:48:25Z", "author": {"login": "awoods"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImpl.java", "diffHunk": "@@ -59,15 +86,39 @@ public FedoraOCFLMapping addMapping(final String fedoraResourceIdentifier, final\n         if (mapping == null) {\n             mapping = new FedoraOCFLMapping(fedoraRootObjectResourceId, ocflObjectId);\n             fedoraOCFLMappingMap.put(fedoraRootObjectResourceId, mapping);\n-\n+            writeMappingToDisk(fedoraRootObjectResourceId, mapping);\n         }\n \n         if (!fedoraResourceIdentifier.equals(fedoraRootObjectResourceId)) {\n             fedoraOCFLMappingMap.put(fedoraResourceIdentifier, mapping);\n+            writeMappingToDisk(fedoraResourceIdentifier, mapping);\n         }\n \n         LOGGER.debug(\"added mapping {} for {}\", mapping, fedoraResourceIdentifier);\n         return mapping;\n     }\n \n+    /**\n+     * Write any added mappings to the on-disk index.\n+     * @param fedoraId The internal Fedora identifier.\n+     * @param fedoraOCFLMapping The Fedora to OCFL mapping object.\n+     */\n+    private void writeMappingToDisk(final String fedoraId, final FedoraOCFLMapping fedoraOCFLMapping) {\n+        try {\n+            if (!FEDORA_TO_OCFL_INDEX_FILE.exists()) {\n+                final String dirName = FEDORA_TO_OCFL_INDEX_FILE.toPath().toAbsolutePath().toString().substring(0,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c43e4e0553eee11cb6c06a84a192fd8828994d6"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NzQ1ODMwOnYy", "diffSide": "RIGHT", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNjo0OToyNVrOFd_I-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNjo0OToyNVrOFd_I-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njk4NzUxNQ==", "bodyText": "Possibly add a logging statement in the case that map.length does not equal 3?", "url": "https://github.com/fcrepo/fcrepo/pull/1603#discussion_r366987515", "createdAt": "2020-01-15T16:49:25Z", "author": {"login": "awoods"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImpl.java", "diffHunk": "@@ -35,10 +42,30 @@\n  */\n @Component\n public class FedoraToOCFLObjectIndexImpl implements FedoraToOCFLObjectIndex {\n+\n     private static Logger LOGGER = LoggerFactory.getLogger(FedoraToOCFLObjectIndexImpl.class);\n \n     private Map<String, FedoraOCFLMapping> fedoraOCFLMappingMap = Collections.synchronizedMap(new HashMap<>());\n \n+    /**\n+     * Constructor\n+     * @throws IOException If we can't access the file.\n+     */\n+    public FedoraToOCFLObjectIndexImpl() throws IOException {\n+        if (FEDORA_TO_OCFL_INDEX_FILE.exists() && FEDORA_TO_OCFL_INDEX_FILE.canRead()) {\n+            Files.lines(FEDORA_TO_OCFL_INDEX_FILE.toPath()).filter(l -> {\n+                final String m = l.split(\"\\t\")[0];\n+                return (!fedoraOCFLMappingMap.containsKey(m));\n+            }).forEach(l -> {\n+                final String[] map = l.split(\"\\t\");\n+                if (map.length == 3) {\n+                    final FedoraOCFLMapping ocflMapping = new FedoraOCFLMapping(map[1], map[2]);\n+                    fedoraOCFLMappingMap.put(map[0], ocflMapping);\n+                }\n+            });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c43e4e0553eee11cb6c06a84a192fd8828994d6"}, "originalPosition": 44}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1909, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}