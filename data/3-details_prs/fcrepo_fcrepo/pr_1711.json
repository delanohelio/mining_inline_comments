{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0OTA1NDAx", "number": 1711, "title": "Don't delete if never created", "bodyText": "JIRA Ticket: https://jira.lyrasis.org/browse/FCREPO-3340\nWhat does this Pull Request do?\nHandles deleting resources that were never committed to the repository.\nHow should this be tested?\nSee simple steps in the associated ticket or the 3 new integration tests for steps.\nInterested parties\n@fcrepo4/committers", "createdAt": "2020-07-06T17:17:38Z", "url": "https://github.com/fcrepo/fcrepo/pull/1711", "merged": true, "mergeCommit": {"oid": "fe7a7098beb3548bf34606a894ce6836ba5ea410"}, "closed": true, "closedAt": "2020-07-07T18:53:31Z", "author": {"login": "whikloj"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyWTBXgH2gAyNDQ0OTA1NDAxOjdkMjcyNjU3MTEwMmFiYWEzNjg2ZDA3M2VkZDcxMTEwZGYxZGE2MWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyqf4iAFqTQ0NDE2MzI3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7d2726571102abaa3686d073edd71110df1da61c", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/7d2726571102abaa3686d073edd71110df1da61c", "committedDate": "2020-07-06T19:20:59Z", "message": "Ensure files are marked as deleted"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzODQxMTEy", "url": "https://github.com/fcrepo/fcrepo/pull/1711#pullrequestreview-443841112", "createdAt": "2020-07-07T12:29:07Z", "commit": {"oid": "b92da1feada6b17a36158eca584f5b484e81a57d"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMjoyOTowN1rOGt8Qig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMjo1OToxMFrOGt9WYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyNjM3OA==", "bodyText": "It's more conventional for this type of method to be named isX() as in isNewInSession().", "url": "https://github.com/fcrepo/fcrepo/pull/1711#discussion_r450826378", "createdAt": "2020-07-07T12:29:07Z", "author": {"login": "pwinckles"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/api/OCFLObjectSession.java", "diffHunk": "@@ -165,4 +165,12 @@\n      * @return the digest algorithm used by the OCFL object\n      */\n     DIGEST_ALGORITHM getObjectDigestAlgorithm();\n+\n+    /**\n+     * Determine if the subpath is new to this session (has no versions committed).\n+     *\n+     * @param subpath the subpath to the resource.\n+     * @return true if this subpath has never been committed.\n+     */\n+    boolean newInSession(final String subpath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b92da1feada6b17a36158eca584f5b484e81a57d"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyODc0MA==", "bodyText": "Perhaps there could be a version of isNewInSession() that returns true if the OCFL object itself is new in the session? It seems a little wrong to me to base this logic on an exception being thrown from listHeadSubpaths(). In fact, it seems like a bug to me that listHeadSubpaths() is throwing an exception rather than returning an empty stream.", "url": "https://github.com/fcrepo/fcrepo/pull/1711#discussion_r450828740", "createdAt": "2020-07-07T12:33:26Z", "author": {"login": "pwinckles"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DeleteResourcePersister.java", "diffHunk": "@@ -62,8 +63,12 @@ public void persist(final OCFLPersistentStorageSession session, final ResourceOp\n         if (fedoraResourceRoot.equals(resourceId)) {\n             // We are at the root of the object, so delete all the data files.\n             try {\n-                objectSession.listHeadSubpaths().filter(p -> !isSidecarSubpath(p)).forEach(\n+                final Stream<String> files = objectSession.listHeadSubpaths();\n+                files.filter(p -> !isSidecarSubpath(p)).forEach(\n                         p -> deletePathWrapped(p, objectSession, user, deleteTime));\n+            } catch (final PersistentStorageException exc) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b92da1feada6b17a36158eca584f5b484e81a57d"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgzMTE1NA==", "bodyText": "Thinking about this some more, this method as currently defined is a little ambiguous. I can think of the following possibilities:\n\nsubpath exists in an OCFL version\nsubpath does not exist in an OCFL version but it does in staging\nsubpath does not exist in an OCFL version and does not exist in staging\n\nWhat is returned in the third case? false would seem to indicate that it exists in staging, but it doesn't.\nPerhaps an easy solution to this is to call the method something like isPersisted() to indicate whether or not a subpath has been persisted with no indication if the subpath is staged?", "url": "https://github.com/fcrepo/fcrepo/pull/1711#discussion_r450831154", "createdAt": "2020-07-07T12:37:47Z", "author": {"login": "pwinckles"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/api/OCFLObjectSession.java", "diffHunk": "@@ -165,4 +165,12 @@\n      * @return the digest algorithm used by the OCFL object\n      */\n     DIGEST_ALGORITHM getObjectDigestAlgorithm();\n+\n+    /**\n+     * Determine if the subpath is new to this session (has no versions committed).\n+     *\n+     * @param subpath the subpath to the resource.\n+     * @return true if this subpath has never been committed.\n+     */\n+    boolean newInSession(final String subpath);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyNjM3OA=="}, "originalCommit": {"oid": "b92da1feada6b17a36158eca584f5b484e81a57d"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg0NDI1OQ==", "bodyText": "As mentioned earlier, this seems like a bug. I think it makes more sense if an empty stream is returned if the object does not exist in OCFL.", "url": "https://github.com/fcrepo/fcrepo/pull/1711#discussion_r450844259", "createdAt": "2020-07-07T12:59:10Z", "author": {"login": "pwinckles"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DefaultOCFLObjectSession.java", "diffHunk": "@@ -564,11 +568,15 @@ public synchronized void close() throws PersistentStorageException {\n     @Override\n     public Stream<String> listHeadSubpaths() throws PersistentStorageException {\n         assertSessionOpen();\n-\n-        return this.ocflRepository.describeVersion(ObjectVersionId.head(this.objectIdentifier))\n-                .getFiles().stream()\n-                .map(FileDetails::getPath)\n-                .map(this::decode);\n+        try {\n+            return this.ocflRepository.describeVersion(ObjectVersionId.head(this.objectIdentifier))\n+                    .getFiles()\n+                    .stream()\n+                    .map(FileDetails::getPath)\n+                    .map(this::decode);\n+        } catch (final NotFoundException exc) {\n+            throw new PersistentStorageException(exc);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b92da1feada6b17a36158eca584f5b484e81a57d"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5f02f685bc4b354dd9427fd8e31ff0418875e44", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/e5f02f685bc4b354dd9427fd8e31ff0418875e44", "committedDate": "2020-07-07T15:20:18Z", "message": "Don't delete if never created"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e16d184e07af9282bd23f658f454db903062bbc", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/3e16d184e07af9282bd23f658f454db903062bbc", "committedDate": "2020-07-07T15:32:57Z", "message": "add some more tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b92da1feada6b17a36158eca584f5b484e81a57d", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/b92da1feada6b17a36158eca584f5b484e81a57d", "committedDate": "2020-07-06T17:15:16Z", "message": "Don't delete if never created"}, "afterCommit": {"oid": "3e16d184e07af9282bd23f658f454db903062bbc", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/3e16d184e07af9282bd23f658f454db903062bbc", "committedDate": "2020-07-07T15:32:57Z", "message": "add some more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ffcf41ea74c9b7503d25eac8f7a8aa80f0d3a2a", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/2ffcf41ea74c9b7503d25eac8f7a8aa80f0d3a2a", "committedDate": "2020-07-07T16:30:28Z", "message": "Rename to isNewInSession"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e0cb12f1fb4a3c2f6f81b239ce070fce056774b", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/4e0cb12f1fb4a3c2f6f81b239ce070fce056774b", "committedDate": "2020-07-07T17:07:22Z", "message": "Add isNewInSession()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MTA4ODg2", "url": "https://github.com/fcrepo/fcrepo/pull/1711#pullrequestreview-444108886", "createdAt": "2020-07-07T17:34:39Z", "commit": {"oid": "4e0cb12f1fb4a3c2f6f81b239ce070fce056774b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MTYzMjc5", "url": "https://github.com/fcrepo/fcrepo/pull/1711#pullrequestreview-444163279", "createdAt": "2020-07-07T18:53:08Z", "commit": {"oid": "4e0cb12f1fb4a3c2f6f81b239ce070fce056774b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3152, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}