{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2MzA1NzAw", "number": 1782, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzowODo0NVrOEwPPyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMzozNDozMVrOE0YShQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MDE2OTA2OnYy", "diffSide": "RIGHT", "path": "fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/identifiers/FedoraId.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzowODo0NVrOHlq7zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMToyNzowNFrOHsWO8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI2Mjc5OQ==", "bodyText": "Perhaps there can be a FedoarId test for this behavior?", "url": "https://github.com/fcrepo/fcrepo/pull/1782#discussion_r509262799", "createdAt": "2020-10-21T13:08:45Z", "author": {"login": "pwinckles"}, "path": "fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/identifiers/FedoraId.java", "diffHunk": "@@ -87,7 +87,7 @@\n      * @throws IllegalArgumentException If ID does not start with expected prefix.\n      */\n     private FedoraId(final String fullId) {\n-        this.fullId = ensurePrefix(fullId).replaceAll(\"/+$\", \"\");\n+        this.fullId = ensurePrefix(fullId).replaceAll(\"\\\\s\", \"%20\").replaceAll(\"/+$\", \"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15191fb641eaa80cf84b8de839b2d0ad5be1a49f"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI2MzY2Nw==", "bodyText": "I have reverted this change for a later attempt.", "url": "https://github.com/fcrepo/fcrepo/pull/1782#discussion_r516263667", "createdAt": "2020-11-02T21:27:04Z", "author": {"login": "whikloj"}, "path": "fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/identifiers/FedoraId.java", "diffHunk": "@@ -87,7 +87,7 @@\n      * @throws IllegalArgumentException If ID does not start with expected prefix.\n      */\n     private FedoraId(final String fullId) {\n-        this.fullId = ensurePrefix(fullId).replaceAll(\"/+$\", \"\");\n+        this.fullId = ensurePrefix(fullId).replaceAll(\"\\\\s\", \"%20\").replaceAll(\"/+$\", \"\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI2Mjc5OQ=="}, "originalCommit": {"oid": "15191fb641eaa80cf84b8de839b2d0ad5be1a49f"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIzMzU5MzY1OnYy", "diffSide": "RIGHT", "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java", "isResolved": true, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMzozNDozMVrOHsEjTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMToyNzoyNlrOHsWPsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk3Mzk2Ng==", "bodyText": "Why are spaces handled differently from any other character that might otherwise be url encoded? For example, is it okay if a slug contains a literal tab character? If so, what is it about spaces that requires special handling? (I'm not saying it doesn't require special handling, just trying to understand.)\nGenerally speaking, slugs are treated as string literals, yes? So, if I create an object with a slug of %D0%BE%D0%B1%D1%8A%D0%B5%D0%BA%D1%82 is that the object's literal id or is it \u043e\u0431\u044a\u0435\u043a\u0442?", "url": "https://github.com/fcrepo/fcrepo/pull/1782#discussion_r515973966", "createdAt": "2020-11-02T13:34:31Z", "author": {"login": "pwinckles"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java", "diffHunk": "@@ -799,6 +797,11 @@ private void handleRequestDisallowedOnMemento() {\n     private FedoraId mintNewPid(final FedoraId fedoraId, final String slug) {\n         final String pid;\n \n+        if (!isBlank(slug) && slug.contains(\" \")) {\n+            // Can't use a literal space\n+            throw new CannotCreateResourceException(\"Slug cannot include literal spaces\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "279d34bd361c6ce53200adf22dd88388c13f64cd"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE2Nzk2NA==", "bodyText": "Jersey un-encodes the path so (my understanding) is the id would be info:fedora/\u043e\u0431\u044a\u0435\u043a\u0442", "url": "https://github.com/fcrepo/fcrepo/pull/1782#discussion_r516167964", "createdAt": "2020-11-02T18:17:04Z", "author": {"login": "whikloj"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java", "diffHunk": "@@ -799,6 +797,11 @@ private void handleRequestDisallowedOnMemento() {\n     private FedoraId mintNewPid(final FedoraId fedoraId, final String slug) {\n         final String pid;\n \n+        if (!isBlank(slug) && slug.contains(\" \")) {\n+            // Can't use a literal space\n+            throw new CannotCreateResourceException(\"Slug cannot include literal spaces\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk3Mzk2Ng=="}, "originalCommit": {"oid": "279d34bd361c6ce53200adf22dd88388c13f64cd"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE3NDE5Mw==", "bodyText": "Sorry I misunderstood and misspoke. My understanding is we allow -H\"Slug: has%20spaces\" but we don't allow -H:\"Slug: has spaces\" because literal spaces are not allowed as part of a valid URI as defined in RFC-3986", "url": "https://github.com/fcrepo/fcrepo/pull/1782#discussion_r516174193", "createdAt": "2020-11-02T18:28:26Z", "author": {"login": "whikloj"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java", "diffHunk": "@@ -799,6 +797,11 @@ private void handleRequestDisallowedOnMemento() {\n     private FedoraId mintNewPid(final FedoraId fedoraId, final String slug) {\n         final String pid;\n \n+        if (!isBlank(slug) && slug.contains(\" \")) {\n+            // Can't use a literal space\n+            throw new CannotCreateResourceException(\"Slug cannot include literal spaces\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk3Mzk2Ng=="}, "originalCommit": {"oid": "279d34bd361c6ce53200adf22dd88388c13f64cd"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE3NTM0OQ==", "bodyText": "I think what you are asking is \"are we using the URL encoded or decoded form of the path\". We are using the decoded form with the exception of spaces. We can move to using the encoded form instead, but currently Jersey decodes on the way in for us. Then we need to work out how to generate a URI without double encoding the path.", "url": "https://github.com/fcrepo/fcrepo/pull/1782#discussion_r516175349", "createdAt": "2020-11-02T18:30:20Z", "author": {"login": "whikloj"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java", "diffHunk": "@@ -799,6 +797,11 @@ private void handleRequestDisallowedOnMemento() {\n     private FedoraId mintNewPid(final FedoraId fedoraId, final String slug) {\n         final String pid;\n \n+        if (!isBlank(slug) && slug.contains(\" \")) {\n+            // Can't use a literal space\n+            throw new CannotCreateResourceException(\"Slug cannot include literal spaces\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk3Mzk2Ng=="}, "originalCommit": {"oid": "279d34bd361c6ce53200adf22dd88388c13f64cd"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE5MTAzMQ==", "bodyText": "I don't see where https://tools.ietf.org/html/rfc3986 says you can't have spaces in URIs.\nIt would seem to me that a slug needs to be treated either as a string literal or as a url encoded value. It's odd to me that only spaces are required to be encoded. If Jersey is treating it as a url encoded value and it is decoding it before injecting the value in FedoraLdp, wouldn't there always be a \" \" in a slug that contains + or %20?", "url": "https://github.com/fcrepo/fcrepo/pull/1782#discussion_r516191031", "createdAt": "2020-11-02T19:00:05Z", "author": {"login": "pwinckles"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java", "diffHunk": "@@ -799,6 +797,11 @@ private void handleRequestDisallowedOnMemento() {\n     private FedoraId mintNewPid(final FedoraId fedoraId, final String slug) {\n         final String pid;\n \n+        if (!isBlank(slug) && slug.contains(\" \")) {\n+            // Can't use a literal space\n+            throw new CannotCreateResourceException(\"Slug cannot include literal spaces\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk3Mzk2Ng=="}, "originalCommit": {"oid": "279d34bd361c6ce53200adf22dd88388c13f64cd"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzNzg5NQ==", "bodyText": "My reading is the section 2.2 specifies what characters have a reserved purpose in a URI.\n\nreserved    = gen-delims / sub-delims\ngen-delims  = \":\" / \"/\" / \"?\" / \"#\" / \"[\" / \"]\" / \"@\"\nsub-delims  = \"!\" / \"$\" / \"&\" / \"'\" / \"(\" / \")\" / \"*\" / \"+\" / \",\" / \";\" / \"=\"\n\nand section 2.3 specifies which characters have an unreserved purpose in a URI.\n\nCharacters that are allowed in a URI but do not have a reserved\npurpose are called unreserved.  These include uppercase and lowercase\nletters, decimal digits, hyphen, period, underscore, and tilde.\nunreserved  = ALPHA / DIGIT / \"-\" / \".\" / \"_\" / \"~\"\n\nSpaces are not defined in either of those sections and so have no purpose in a URI.\nJersey automatically (I think) handles it when you try to add spaces to the URI you are attempting to access, as you encountered above. As Slugs are passed in as headers which do allow spaces but they are to meant be part of the URI so we enforce this requirement to have the end-user percent encode their spaces.", "url": "https://github.com/fcrepo/fcrepo/pull/1782#discussion_r516237895", "createdAt": "2020-11-02T20:33:22Z", "author": {"login": "whikloj"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java", "diffHunk": "@@ -799,6 +797,11 @@ private void handleRequestDisallowedOnMemento() {\n     private FedoraId mintNewPid(final FedoraId fedoraId, final String slug) {\n         final String pid;\n \n+        if (!isBlank(slug) && slug.contains(\" \")) {\n+            // Can't use a literal space\n+            throw new CannotCreateResourceException(\"Slug cannot include literal spaces\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk3Mzk2Ng=="}, "originalCommit": {"oid": "279d34bd361c6ce53200adf22dd88388c13f64cd"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI2Mzg1OQ==", "bodyText": "I have reverted this change for a later attempt.", "url": "https://github.com/fcrepo/fcrepo/pull/1782#discussion_r516263859", "createdAt": "2020-11-02T21:27:26Z", "author": {"login": "whikloj"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java", "diffHunk": "@@ -799,6 +797,11 @@ private void handleRequestDisallowedOnMemento() {\n     private FedoraId mintNewPid(final FedoraId fedoraId, final String slug) {\n         final String pid;\n \n+        if (!isBlank(slug) && slug.contains(\" \")) {\n+            // Can't use a literal space\n+            throw new CannotCreateResourceException(\"Slug cannot include literal spaces\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk3Mzk2Ng=="}, "originalCommit": {"oid": "279d34bd361c6ce53200adf22dd88388c13f64cd"}, "originalPosition": 32}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1691, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}