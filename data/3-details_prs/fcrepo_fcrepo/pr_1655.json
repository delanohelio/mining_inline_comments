{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk4NzY1NDg5", "number": 1655, "title": "Make Repository rebuilder handle binaries", "bodyText": "JIRA Ticket: https://jira.lyrasis.org/browse/FCREPO-3268\nWhat does this Pull Request do?\nAssigns the binary as the parent of the description when sending information to the persistence layer and then uses the parent and the interaction model to ensure the binary description gets re-added to the index correctly.\nHow should this be tested?\nBefore PR.\n\nAdd a binary to Fedora.\n> curl -ufedoraAdmin:fedoraAdmin -i -H\"Content-type: text/plain\" -H\"Slug: binary1\" --data-binary \"Some text content\" -XPOST http://localhost:8080/rest\n\n\nGET the binary and its metadata, validate it works.\n> curl -i -ufedoraAdmin:fedoraAdmin http://localhost:8080/rest/binary1\n> curl -i -ufedoraAdmin:fedoraAdmin http://localhost:8080/rest/binary1/fcr:metadata\n\n\nShutdown Fedora and delete the index file, fedoraToOcflIndex.tsv in the OCFL work directory.\nRestart Fedora\nTry to get the binary and metadata, see errors\nShutdown Fedora, pull in this PR, compile\nDelete the index file again\nRestart Fedora\nTry to get the binary and metadata, see correct results.\n\nInterested parties\n@fcrepo4/committers", "createdAt": "2020-04-04T21:21:25Z", "url": "https://github.com/fcrepo/fcrepo/pull/1655", "merged": true, "mergeCommit": {"oid": "69a512e0ebdb0ee6217de5b90ab7a4a9b512e781"}, "closed": true, "closedAt": "2020-04-10T18:43:01Z", "author": {"login": "whikloj"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcV-VwPAH2gAyMzk4NzY1NDg5OjE2NjBhY2M1OGJiMmFjMmFlYWVlMTE2MzRhYTZhMDQ5ZTkyNTMxM2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcWVkauAFqTM5MTU5ODI1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1660acc58bb2ac2aeaee11634aa6a049e925313a", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/1660acc58bb2ac2aeaee11634aa6a049e925313a", "committedDate": "2020-04-09T15:36:22Z", "message": "Handle binary descriptions on rebuild"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1fd56b0fb90b1df3b2f156f4ac948bbb9badcbe", "author": {"user": null}, "url": "https://github.com/fcrepo/fcrepo/commit/a1fd56b0fb90b1df3b2f156f4ac948bbb9badcbe", "committedDate": "2020-04-09T15:36:22Z", "message": "Add integration test for webapp in RebuildIT\n\n- Ensure context is refreshed before running this test\n- Update test data used in RebuildIT to currently produced OCFL\n- Update dependency version of failsafe (not necessary for this PR)\n- Add debug output for one FedoraHtmlIT (not necessary for this PR)\n\nRelated to: https://jira.lyrasis.org/browse/FCREPO-3268"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d672381f5fb3469fb1bfd6ee29bbe45fa2b30a65", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/d672381f5fb3469fb1bfd6ee29bbe45fa2b30a65", "committedDate": "2020-04-09T15:36:22Z", "message": "Revert unnecessary changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b1c7c5f391dd8bdb53bcecdef3c48afb927cbd9", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/3b1c7c5f391dd8bdb53bcecdef3c48afb927cbd9", "committedDate": "2020-04-09T15:36:22Z", "message": "Use URLEncoder"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8c30633d90b351cdf119782da3a6fa7e6ac159cb", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/8c30633d90b351cdf119782da3a6fa7e6ac159cb", "committedDate": "2020-04-09T15:30:40Z", "message": "Use URLEncoder"}, "afterCommit": {"oid": "3b1c7c5f391dd8bdb53bcecdef3c48afb927cbd9", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/3b1c7c5f391dd8bdb53bcecdef3c48afb927cbd9", "committedDate": "2020-04-09T15:36:22Z", "message": "Use URLEncoder"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwOTg2NTI2", "url": "https://github.com/fcrepo/fcrepo/pull/1655#pullrequestreview-390986526", "createdAt": "2020-04-09T17:22:00Z", "commit": {"oid": "3b1c7c5f391dd8bdb53bcecdef3c48afb927cbd9"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNzoyMjowMFrOGDiIpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxODo0NDoyOFrOGDk_7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM1ODE4Mg==", "bodyText": "Curious why this was needed? It doesn't appear to be changing any info, and kernel-api is available in persistence.", "url": "https://github.com/fcrepo/fcrepo/pull/1655#discussion_r406358182", "createdAt": "2020-04-09T17:22:00Z", "author": {"login": "bbpennel"}, "path": "fcrepo-persistence-api/src/main/java/org/fcrepo/persistence/api/PersistenceConstants.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Licensed to DuraSpace under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional information\n+ * regarding copyright ownership.\n+ *\n+ * DuraSpace licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except in\n+ * compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.fcrepo.persistence.api;\n+\n+import static org.fcrepo.kernel.api.RdfLexicon.FEDORA_NON_RDF_SOURCE_DESCRIPTION_URI;\n+\n+/**\n+ * Class for persistence constants.\n+ */\n+public final class PersistenceConstants {\n+\n+    /**\n+     * Bringing from kernel level.\n+     */\n+    public static final String PERSISTENCE_FEDORA_NON_RDF_SOURCE_DESCRIPTION = FEDORA_NON_RDF_SOURCE_DESCRIPTION_URI;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b1c7c5f391dd8bdb53bcecdef3c48afb927cbd9"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM4MjExNg==", "bodyText": "not that i mind this, but was this intentionally left in?", "url": "https://github.com/fcrepo/fcrepo/pull/1655#discussion_r406382116", "createdAt": "2020-04-09T18:03:52Z", "author": {"login": "bbpennel"}, "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraHtmlIT.java", "diffHunk": "@@ -104,7 +104,7 @@ public void testGetRootTemplate() throws IOException {\n         method.addHeader(ACCEPT, \"text/html\");\n         try (final CloseableHttpResponse response = execute(method)) {\n             final String html = EntityUtils.toString(response.getEntity());\n-            assertTrue(contains(html, \"class=\\\"fcrepo_root\\\"\"));\n+            assertTrue(html, contains(html, \"class=\\\"fcrepo_root\\\"\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b1c7c5f391dd8bdb53bcecdef3c48afb927cbd9"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQwNTEwMA==", "bodyText": "I'm trying to understand if this is the case and I can't test at the moment, so I may be totally off, but it seems like if you have an archival group which contains a binary, then everything else in the AG would also have the binary as its root instead of the AG? Do we only want to set the root for a description to the binary if its not in an AG, or do we always want to do this?", "url": "https://github.com/fcrepo/fcrepo/pull/1655#discussion_r406405100", "createdAt": "2020-04-09T18:44:28Z", "author": {"login": "bbpennel"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexUtilImpl.java", "diffHunk": "@@ -80,8 +83,11 @@ public void rebuild() {\n                                 fedoraIds.add(headers.getId());\n                                 if (headers.isArchivalGroup()) {\n                                     rootId.set(headers.getId());\n+                                } else if (Objects.equals(headers.getInteractionModel(),\n+                                        PERSISTENCE_FEDORA_NON_RDF_SOURCE_DESCRIPTION)) {\n+                                    rootId.set(headers.getParent());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b1c7c5f391dd8bdb53bcecdef3c48afb927cbd9"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMDUyNjQ5", "url": "https://github.com/fcrepo/fcrepo/pull/1655#pullrequestreview-391052649", "createdAt": "2020-04-09T18:58:34Z", "commit": {"oid": "3b1c7c5f391dd8bdb53bcecdef3c48afb927cbd9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxODo1ODozNFrOGDldxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxODo1ODozNFrOGDldxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQxMjc0MQ==", "bodyText": "I think that's right @bbpennel.  And we also want to account for fcr:acl  as well.", "url": "https://github.com/fcrepo/fcrepo/pull/1655#discussion_r406412741", "createdAt": "2020-04-09T18:58:34Z", "author": {"login": "dbernstein"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexUtilImpl.java", "diffHunk": "@@ -80,8 +83,11 @@ public void rebuild() {\n                                 fedoraIds.add(headers.getId());\n                                 if (headers.isArchivalGroup()) {\n                                     rootId.set(headers.getId());\n+                                } else if (Objects.equals(headers.getInteractionModel(),\n+                                        PERSISTENCE_FEDORA_NON_RDF_SOURCE_DESCRIPTION)) {\n+                                    rootId.set(headers.getParent());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQwNTEwMA=="}, "originalCommit": {"oid": "3b1c7c5f391dd8bdb53bcecdef3c48afb927cbd9"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4a71287d77d75662648777d92b6beb36f24a95f", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/b4a71287d77d75662648777d92b6beb36f24a95f", "committedDate": "2020-04-09T19:22:36Z", "message": "Clearly I did something wrong"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNTk4MjU5", "url": "https://github.com/fcrepo/fcrepo/pull/1655#pullrequestreview-391598259", "createdAt": "2020-04-10T18:40:12Z", "commit": {"oid": "b4a71287d77d75662648777d92b6beb36f24a95f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3074, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}