{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3NjcxMjc2", "number": 1611, "title": "Ensures that POSTs without explicit Content-Type headers use turtle b\u2026", "bodyText": "\u2026y default.\nResolves:  https://jira.lyrasis.org/browse/FCREPO-3188\nThe title of this pull-request should be a brief description of what the pull-request fixes/improves/changes. Ideally 50 characters or less.\n\nJIRA Ticket: https://jira.lyrasis.org/browse/FCREPO-3188\n\nOther Relevant Links (Mailing list discussion, related pull requests, etc.)\n\nWhat does this Pull Request do?\n\nEnsures that POSTs without an explicit Content-Type header do not fail. Rather, they assume text/turtle.\nFormerly @ignore'd integration tests now work.  In the process of reenabling the integration tests, I also fixed a bug related to link header parsing.\n\nHow should this be tested?\n`\ncreate the resource\ncurl -v -XPOST -H \"Slug: blah\" -ufedoraAdmin:fedoraAdmin -H \"Link: http://www.w3.org/ns/ldp#BasicContainer;rel=\"type\"\" http://localhost:8080/rest\n#Verify that the operation succeeds and a subsequent GET returns the resource. content type text/turtle\ncurl -I -u fedoraAdmin:fedoraAdmin http://localhost:8080/rest/blah\nInterested parties\nTag (@ mention) interested parties or, if unsure, @fcrepo4/committers", "createdAt": "2020-01-27T19:48:11Z", "url": "https://github.com/fcrepo/fcrepo/pull/1611", "merged": true, "mergeCommit": {"oid": "58b0736f28f8e0d4e421524d632a9f74e6ea9ac3"}, "closed": true, "closedAt": "2020-01-27T22:11:46Z", "author": {"login": "dbernstein"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-h-3ZAH2gAyMzY3NjcxMjc2Ojc3MDFkYjhjMjU5ZGRjZTQ2NzMyNWI2YzViODc4NTZlNTdiODRkYWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb-jv8sgFqTM0ODk5MjQyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7701db8c259ddce467325b6c5b87856e57b84daf", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/7701db8c259ddce467325b6c5b87856e57b84daf", "committedDate": "2020-01-27T19:33:46Z", "message": "Ensures that POSTs without explicit Content-Type headers use turtle by default.\nResolves:  https://jira.lyrasis.org/browse/FCREPO-3188"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4OTM5MzUz", "url": "https://github.com/fcrepo/fcrepo/pull/1611#pullrequestreview-348939353", "createdAt": "2020-01-27T20:04:36Z", "commit": {"oid": "7701db8c259ddce467325b6c5b87856e57b84daf"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QyMDowNDozNlrOFiPzEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QyMDowNjozNVrOFiP2iA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ1NDczOA==", "bodyText": "Should probably have this on two lines rather than going to three, or one line per parameter.", "url": "https://github.com/fcrepo/fcrepo/pull/1611#discussion_r371454738", "createdAt": "2020-01-27T20:04:36Z", "author": {"login": "bbpennel"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java", "diffHunk": "@@ -436,15 +441,17 @@ public Response createOrReplaceObjectRdf(\n                         .toString(),\n                     model);\n             } else {\n-                createResourceService.perform(transaction.getId(), getUserPrincipal(), fedoraId, null, false, links,\n+                fedoraId = createResourceService.perform(transaction.getId(), getUserPrincipal(), fedoraId, null,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7701db8c259ddce467325b6c5b87856e57b84daf"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ1NTYyNA==", "bodyText": "While this is important, I think this is only the default content type for rdf sources. For non-rdf sources it should be application/octet-stream I would think?", "url": "https://github.com/fcrepo/fcrepo/pull/1611#discussion_r371455624", "createdAt": "2020-01-27T20:06:35Z", "author": {"login": "bbpennel"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java", "diffHunk": "@@ -135,6 +136,7 @@\n     private static final String WANT_DIGEST = \"Want-Digest\";\n \n     private static final String DIGEST = \"Digest\";\n+    public static final MediaType DEFAULT_CONTENT_TYPE = RDFMediaType.TURTLE_TYPE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7701db8c259ddce467325b6c5b87856e57b84daf"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b5dadeb50c6dd337c7310e4d248565e45102523", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/1b5dadeb50c6dd337c7310e4d248565e45102523", "committedDate": "2020-01-27T20:10:17Z", "message": "Uses getResourceHead() instead of resourceFactory."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8704f56a036d507df91b1762afd7ab00d7a90d19", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/8704f56a036d507df91b1762afd7ab00d7a90d19", "committedDate": "2020-01-27T20:19:35Z", "message": "Rename  FedoraBaseResource.getResourceHead() to FedoraBaseResource.getFedoraResource()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4OTQ5NTQ1", "url": "https://github.com/fcrepo/fcrepo/pull/1611#pullrequestreview-348949545", "createdAt": "2020-01-27T20:22:26Z", "commit": {"oid": "8704f56a036d507df91b1762afd7ab00d7a90d19"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QyMDoyMjoyNlrOFiQSLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QyMDoyMjoyNlrOFiQSLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ2MjcwMA==", "bodyText": "I see you ran into this commit order issue too. I'll just add that it should be commitIfShortLived so that it won't end a multi-transaction commit prematurely. That holds true for all the commit in this class actually.", "url": "https://github.com/fcrepo/fcrepo/pull/1611#discussion_r371462700", "createdAt": "2020-01-27T20:22:26Z", "author": {"login": "bbpennel"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java", "diffHunk": "@@ -548,41 +555,39 @@ public Response createObject(@HeaderParam(CONTENT_DISPOSITION) final ContentDisp\n             return status(METHOD_NOT_ALLOWED).build();\n         }\n \n+        final var contentType = requestContentType != null ? requestContentType : DEFAULT_CONTENT_TYPE;\n         // If request is an external binary, verify link header before proceeding\n         final ExternalContent extContent = extContentHandlerFactory.createFromLinks(links);\n-\n-        final String contentType = extContent == null ? requestContentType.toString() : extContent.getContentType();\n+        final String contentTypeStr = extContent == null ? contentType.toString() : extContent.getContentType();\n \n         final String interactionModel = checkInteractionModel(links);\n \n         final String fedoraId = identifierConverter().toInternalId(identifierConverter().toDomain(externalPath()));\n-\n         final String newFedoraId;\n-        if (isBinary(interactionModel, requestContentType.toString(), requestContentType != null,\n+\n+        if (isBinary(interactionModel, contentType.toString(), requestContentType != null,\n                 extContent != null)) {\n             final Collection<String> checksums = parseDigestHeader(digest);\n             final String originalFileName = contentDisposition != null ? contentDisposition.getFileName() : \"\";\n-            newFedoraId = createResourceService.perform(transaction.getId(), getUserPrincipal(), fedoraId, slug, true,\n-                    contentType, originalFileName, contentDisposition.getSize(), links, checksums, requestBodyStream,\n-                    extContent);\n+            newFedoraId = createResourceService.perform(transaction.getId(), getUserPrincipal(), fedoraId, slug,\n+                    true, contentTypeStr,\n+                    originalFileName, contentDisposition.getSize(), links, checksums, requestBodyStream, extContent);\n         } else {\n             final Model model = httpRdfService.bodyToInternalModel(externalPath(), requestBodyStream,\n-                    requestContentType, identifierConverter());\n-            newFedoraId = createResourceService.perform(transaction.getId(), getUserPrincipal(), fedoraId, slug, true,\n-                    links, model);\n+                    contentType, identifierConverter());\n+            newFedoraId = createResourceService.perform(transaction.getId(), getUserPrincipal(), fedoraId, slug,\n+                    true, links,\n+                    model);\n         }\n-        // TODO: How to generate a response.\n-        LOGGER.debug(\"Finished creating resource with path: {}\", externalPath());\n \n-        final FedoraResource resource;\n+        LOGGER.debug(\"Finished creating resource: {}\", newFedoraId);\n+        transaction.commit();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8704f56a036d507df91b1762afd7ab00d7a90d19"}, "originalPosition": 105}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd53fb1f3dd7baf85b8cd7f7c0bb066c64725f5e", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/dd53fb1f3dd7baf85b8cd7f7c0bb066c64725f5e", "committedDate": "2020-01-27T21:27:42Z", "message": "Addresses PR feedback."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6ecc14930889b3e3737fd999cdf6257d79217747", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/6ecc14930889b3e3737fd999cdf6257d79217747", "committedDate": "2020-01-27T21:23:59Z", "message": "Addresses PR feedback."}, "afterCommit": {"oid": "dd53fb1f3dd7baf85b8cd7f7c0bb066c64725f5e", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/dd53fb1f3dd7baf85b8cd7f7c0bb066c64725f5e", "committedDate": "2020-01-27T21:27:42Z", "message": "Addresses PR feedback."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4OTg5MTIw", "url": "https://github.com/fcrepo/fcrepo/pull/1611#pullrequestreview-348989120", "createdAt": "2020-01-27T21:31:33Z", "commit": {"oid": "dd53fb1f3dd7baf85b8cd7f7c0bb066c64725f5e"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4OTkyNDIw", "url": "https://github.com/fcrepo/fcrepo/pull/1611#pullrequestreview-348992420", "createdAt": "2020-01-27T21:37:17Z", "commit": {"oid": "dd53fb1f3dd7baf85b8cd7f7c0bb066c64725f5e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3205, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}