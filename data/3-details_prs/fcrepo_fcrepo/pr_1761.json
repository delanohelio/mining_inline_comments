{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1NzM3Nzgy", "number": 1761, "title": "Enforce server managed predicates and types, add interaction model to containment index.", "bodyText": "JIRA Ticket: https://jira.lyrasis.org/browse/FCREPO-3258, also continues work on https://jira.lyrasis.org/browse/FCREPO-3223\nWhat does this Pull Request do?\nEnforces not being able to change the interaction model of a resource via\n\nLink header\nRDF body\nPATCH request body\n\nHow should this be tested?\nLots of tests have been added, but now if you add RDF with a rdf:type in the namespace of Memento, LDP or Fedora you should get rejected. If you send a Link header different from the current interaction model you should get rejected. If you send a rdf:type that is not a URI you should get rejected.\nInterested parties\n@fcrepo/committers", "createdAt": "2020-09-30T19:30:41Z", "url": "https://github.com/fcrepo/fcrepo/pull/1761", "merged": true, "mergeCommit": {"oid": "4131d6410637f884d44025de7e75e901a076b557"}, "closed": true, "closedAt": "2020-10-12T19:08:25Z", "author": {"login": "whikloj"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOSEOigFqTUwMDM2NTE5NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdR40_tgFqTUwNjg1MzQwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwMzY1MTk1", "url": "https://github.com/fcrepo/fcrepo/pull/1761#pullrequestreview-500365195", "createdAt": "2020-10-01T13:47:59Z", "commit": {"oid": "9be6f0947486a3156d66fb8ee71f0c080488bd2e"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxMzo0Nzo1OVrOHbLPKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNDoxNDo1N1rOHbMeXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI1NzcwNw==", "bodyText": "Not a big deal, but this should probably be either:\nStringUtils.isNotBlank(interactionModel) && StringUtils.isNotBlank(resInteractionModel)\nor\nStringUtils.isNoneBlank(interactionModel, resInteractionModel)", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r498257707", "createdAt": "2020-10-01T13:47:59Z", "author": {"login": "pwinckles"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java", "diffHunk": "@@ -395,13 +397,12 @@ public Response createOrReplaceObjectRdf(\n                 throw new ClientErrorException(\"An If-Match header is required\", 428);\n             }\n \n-            // TODO: Check existing resources interaction model and make sure we aren't trying to change it.\n-            //final String resInteractionModel = getInteractionModel(resource);\n-            //if (StringUtils.isNoneBlank(interactionModel) && StringUtils.isNoneBlank(resInteractionModel)\n-            //        && !resInteractionModel.equals(interactionModel)) {\n-            //    throw new InteractionModelViolationException(\"Changing the interaction model \" + resInteractionModel\n-            //            + \" to \" + interactionModel + \" is not allowed!\");\n-            //}\n+            final String resInteractionModel = getInteractionModel(transaction, fedoraId);\n+            if (StringUtils.isNoneBlank(interactionModel) && StringUtils.isNoneBlank(resInteractionModel)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9be6f0947486a3156d66fb8ee71f0c080488bd2e"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI2MDI5Nw==", "bodyText": "Actually, I think the entire condition could be written as:\nif (!Objects.equals(resInteractionModel, interactionModel)) {..}", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r498260297", "createdAt": "2020-10-01T13:51:24Z", "author": {"login": "pwinckles"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java", "diffHunk": "@@ -395,13 +397,12 @@ public Response createOrReplaceObjectRdf(\n                 throw new ClientErrorException(\"An If-Match header is required\", 428);\n             }\n \n-            // TODO: Check existing resources interaction model and make sure we aren't trying to change it.\n-            //final String resInteractionModel = getInteractionModel(resource);\n-            //if (StringUtils.isNoneBlank(interactionModel) && StringUtils.isNoneBlank(resInteractionModel)\n-            //        && !resInteractionModel.equals(interactionModel)) {\n-            //    throw new InteractionModelViolationException(\"Changing the interaction model \" + resInteractionModel\n-            //            + \" to \" + interactionModel + \" is not allowed!\");\n-            //}\n+            final String resInteractionModel = getInteractionModel(transaction, fedoraId);\n+            if (StringUtils.isNoneBlank(interactionModel) && StringUtils.isNoneBlank(resInteractionModel)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI1NzcwNw=="}, "originalCommit": {"oid": "9be6f0947486a3156d66fb8ee71f0c080488bd2e"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI2NTAzMg==", "bodyText": "Why is this special cased?", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r498265032", "createdAt": "2020-10-01T13:57:37Z", "author": {"login": "pwinckles"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraBaseResource.java", "diffHunk": "@@ -92,6 +94,13 @@ protected boolean doesResourceExist(final Transaction transaction, final FedoraI\n         return resourceFactory.doesResourceExist(transaction, fedoraId);\n     }\n \n+    protected String getInteractionModel(final Transaction transaction, final FedoraId fedoraId) {\n+        if (fedoraId.isDescription()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9be6f0947486a3156d66fb8ee71f0c080488bd2e"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI3Nzk4Mw==", "bodyText": "I'm not sure if I follow why the interaction model is being added to the containment index. Is it just a place to stick it so that the resource headers don't need to be read?", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r498277983", "createdAt": "2020-10-01T14:14:57Z", "author": {"login": "pwinckles"}, "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/models/ResourceFactoryImpl.java", "diffHunk": "@@ -150,6 +150,42 @@ public FedoraResource getContainer(final String transactionId, final FedoraId re\n         }\n     }\n \n+    @Override\n+    public String getInteractionModel(final String transactionId, final FedoraId fedoraId) {\n+        if (fedoraId.isRepositoryRoot()) {\n+            return BASIC_CONTAINER.getURI();\n+        }\n+        if (!(fedoraId.isMemento() || fedoraId.isAcl())) {\n+            // containment index doesn't handle versions and only tells us if the resource (not acl) is there,\n+            // so don't bother checking for them.\n+            return containmentIndex.getInteractionModel(transactionId, fedoraId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9be6f0947486a3156d66fb8ee71f0c080488bd2e"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMDkwNjM2", "url": "https://github.com/fcrepo/fcrepo/pull/1761#pullrequestreview-502090636", "createdAt": "2020-10-05T14:04:55Z", "commit": {"oid": "c103fb37731750d91c77ade68a594bda6f897b94"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNDQ4MDEz", "url": "https://github.com/fcrepo/fcrepo/pull/1761#pullrequestreview-502448013", "createdAt": "2020-10-05T21:54:03Z", "commit": {"oid": "c103fb37731750d91c77ade68a594bda6f897b94"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMTo1NDowM1rOHcvFrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMjozOTo0NVrOHcwHGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg5MzY3Nw==", "bodyText": "You can probably remove the newType variable... since the value is only used once. Additionally, the toString() method will be called by default within \"String.format(...)\", and does not need to be invoked explicitly.", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r499893677", "createdAt": "2020-10-05T21:54:03Z", "author": {"login": "awoods"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/services/HttpRdfService.java", "diffHunk": "@@ -230,4 +236,34 @@ protected static Model parseBodyAsModel(final InputStream requestBodyStream,\n         }\n     }\n \n+    /**\n+     * Checks if the RDF contains any disallowed statements.\n+     * @param statement a statement from the incoming RDF.\n+     */\n+    private static void checkForDisallowedRdf(final Statement statement) {\n+        checkTripleForDisallowed(statement.asTriple());\n+    }\n+\n+    /**\n+     * Several tests for invalid or disallowed RDF statements.\n+     * @param triple the triple to check.\n+     */\n+    public static void checkTripleForDisallowed(final Triple triple) {\n+        if (triple.getPredicate().equals(type().asNode()) && !triple.getObject().isURI()) {\n+            // The object of a rdf:type triple is not a URI.\n+            final var newType = triple.getObject().toString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c103fb37731750d91c77ade68a594bda6f897b94"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg5MzczNw==", "bodyText": "You can probably remove the newType variable... since the value is only used once. Additionally, the toString() method will be called by default within \"String.format(...)\", and does not need to be invoked explicitly.", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r499893737", "createdAt": "2020-10-05T21:54:14Z", "author": {"login": "awoods"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/services/HttpRdfService.java", "diffHunk": "@@ -230,4 +236,34 @@ protected static Model parseBodyAsModel(final InputStream requestBodyStream,\n         }\n     }\n \n+    /**\n+     * Checks if the RDF contains any disallowed statements.\n+     * @param statement a statement from the incoming RDF.\n+     */\n+    private static void checkForDisallowedRdf(final Statement statement) {\n+        checkTripleForDisallowed(statement.asTriple());\n+    }\n+\n+    /**\n+     * Several tests for invalid or disallowed RDF statements.\n+     * @param triple the triple to check.\n+     */\n+    public static void checkTripleForDisallowed(final Triple triple) {\n+        if (triple.getPredicate().equals(type().asNode()) && !triple.getObject().isURI()) {\n+            // The object of a rdf:type triple is not a URI.\n+            final var newType = triple.getObject().toString();\n+            throw new MalformedRdfException(\n+                    String.format(\"Invalid rdf:type: %s\", newType));\n+        } else if (restrictedType.test(triple)) {\n+            // The object of a rdf:type triple has a restricted namespace.\n+            final var newType = triple.getObject().toString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c103fb37731750d91c77ade68a594bda6f897b94"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg5Mzg0Mw==", "bodyText": "The toString() method will be called by default within \"String.format(...)\", and does not need to be invoked explicitly.", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r499893843", "createdAt": "2020-10-05T21:54:27Z", "author": {"login": "awoods"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/services/HttpRdfService.java", "diffHunk": "@@ -230,4 +236,34 @@ protected static Model parseBodyAsModel(final InputStream requestBodyStream,\n         }\n     }\n \n+    /**\n+     * Checks if the RDF contains any disallowed statements.\n+     * @param statement a statement from the incoming RDF.\n+     */\n+    private static void checkForDisallowedRdf(final Statement statement) {\n+        checkTripleForDisallowed(statement.asTriple());\n+    }\n+\n+    /**\n+     * Several tests for invalid or disallowed RDF statements.\n+     * @param triple the triple to check.\n+     */\n+    public static void checkTripleForDisallowed(final Triple triple) {\n+        if (triple.getPredicate().equals(type().asNode()) && !triple.getObject().isURI()) {\n+            // The object of a rdf:type triple is not a URI.\n+            final var newType = triple.getObject().toString();\n+            throw new MalformedRdfException(\n+                    String.format(\"Invalid rdf:type: %s\", newType));\n+        } else if (restrictedType.test(triple)) {\n+            // The object of a rdf:type triple has a restricted namespace.\n+            final var newType = triple.getObject().toString();\n+            throw new InteractionModelViolationException(\n+                    String.format(\"Changing this resource's interaction model to %s is not allowed\", newType));\n+        } else if (isManagedPredicate.test(createProperty(triple.getPredicate().getURI()))) {\n+            // The predicate is server managed.\n+            throw new ServerManagedPropertyException(\n+                    String.format(\"The server managed predicate (%s) cannot be modified by the client.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c103fb37731750d91c77ade68a594bda6f897b94"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg5OTIzOQ==", "bodyText": "Is there actually anything \"todo\"?", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r499899239", "createdAt": "2020-10-05T22:07:56Z", "author": {"login": "awoods"}, "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraLdpIT.java", "diffHunk": "@@ -3203,13 +3195,16 @@ public void testCreateResourceWithoutContentType() {\n         assertEquals(CREATED.getStatusCode(), getStatus(new HttpPut(serverAddress + getRandomUniqueId())));\n     }\n \n+    /*\n+     * TODO: This was originally expecting a 415 Unsupported Media Type, but because we assume text/turtle now it", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c103fb37731750d91c77ade68a594bda6f897b94"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwMDYzNw==", "bodyText": "Are you saying that a malformed SPARQL-Update request should silently fail? It seems like BAD_REQUEST is a more correct response. Am I missing something?", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r499900637", "createdAt": "2020-10-05T22:11:45Z", "author": {"login": "awoods"}, "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraLdpIT.java", "diffHunk": "@@ -3262,7 +3253,7 @@ public void testBinarySetBadMimeType() throws IOException {\n                 \"INSERT { <\" + subjectURI + \"> ebucore:hasMimeType \\\"-- invalid syntax! --\\\" } WHERE {}\")\n         );\n \n-        assertEquals(BAD_REQUEST.getStatusCode(), getStatus(patch));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c103fb37731750d91c77ade68a594bda6f897b94"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwNzU3MQ==", "bodyText": "It certainly can work here; however, it seems like \"getInteractionModel\" would more appropriately be a \"FedoraResource\" method, rather than a \"ResourceFactory\" method.\nThe following is available on \"FedoraResourceImpl\"\npsSession.getHeaders(fedoraId, fedoraId.getMementoInstant());\n\nWould it make sense for \"FedoraLdp\" to create the known-to-exist resource, then request its interaction-model?", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r499907571", "createdAt": "2020-10-05T22:31:09Z", "author": {"login": "awoods"}, "path": "fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/models/ResourceFactory.java", "diffHunk": "@@ -112,4 +112,12 @@ public FedoraResource getResource(final String transactionId, final FedoraId fed\n      * @return Stream of child resources\n      */\n     public Stream<FedoraResource> getChildren(final String transactionId, final FedoraId resourceId);\n+\n+    /**\n+     * Get the interaction model of the resource, assumes you've checked it exists already.\n+     * @param transactionId The transaction id\n+     * @param fedoraId Identifier of the resource.\n+     * @return The interaction model.\n+     */\n+    public String getInteractionModel(final String transactionId, final FedoraId fedoraId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c103fb37731750d91c77ade68a594bda6f897b94"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwODQyMw==", "bodyText": "Maybe update this comment to describe what qualifies as a \"restricted namespace\", vs talking about \"setting\" rdf:types... which this predicate is not doing.", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r499908423", "createdAt": "2020-10-05T22:33:43Z", "author": {"login": "awoods"}, "path": "fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/RdfLexicon.java", "diffHunk": "@@ -86,6 +88,12 @@\n     public static final Predicate<String> isManagedNamespace = p -> p.equals(REPOSITORY_NAMESPACE) ||\n             p.equals(LDP_NAMESPACE) || p.equals(MEMENTO_NAMESPACE);\n \n+    /**\n+     * Tests if we are trying to set the rdf:type to an object with a restricted namespace.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c103fb37731750d91c77ade68a594bda6f897b94"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwODc3NA==", "bodyText": "Nice finds. Can you create a ticket to purge these relics?", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r499908774", "createdAt": "2020-10-05T22:34:50Z", "author": {"login": "awoods"}, "path": "fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/RdfLexicon.java", "diffHunk": "@@ -259,21 +267,25 @@\n     /**\n      * Fedora defined JCR node type with supertype of nt:file with two nt:folder named fedora:timemap and\n      * fedora:binaryTimemap inside.\n+     * TODO: Remove modeshape-ism?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c103fb37731750d91c77ade68a594bda6f897b94"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwOTQ4MA==", "bodyText": "The headers for the RepositoryRoot also indicate its interaction model. Is the potential performance optimization here worth the redundant logic?", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r499909480", "createdAt": "2020-10-05T22:36:55Z", "author": {"login": "awoods"}, "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/models/ResourceFactoryImpl.java", "diffHunk": "@@ -150,6 +150,35 @@ public FedoraResource getContainer(final String transactionId, final FedoraId re\n         }\n     }\n \n+    @Override\n+    public String getInteractionModel(final String transactionId, final FedoraId fedoraId) {\n+        if (fedoraId.isRepositoryRoot()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c103fb37731750d91c77ade68a594bda6f897b94"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwOTk1Mw==", "bodyText": "It does not look like this is a function update. Can you revert the reformatting?", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r499909953", "createdAt": "2020-10-05T22:38:18Z", "author": {"login": "awoods"}, "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "diffHunk": "@@ -116,8 +116,8 @@\n      * Insert a parent child relationship to the transaction operation table.\n      */\n     private static final String INSERT_CHILD_IN_TRANSACTION = \"INSERT INTO \" + TRANSACTION_OPERATIONS_TABLE +\n-            \" ( \" + PARENT_COLUMN + \", \" + FEDORA_ID_COLUMN + \", \" + TRANSACTION_ID_COLUMN + \", \" + OPERATION_COLUMN +\n-            \" ) VALUES (:parent, :child, :transactionId, 'add')\";\n+            \" ( \" + PARENT_COLUMN + \", \" + FEDORA_ID_COLUMN + \", \" + TRANSACTION_ID_COLUMN + \", \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c103fb37731750d91c77ade68a594bda6f897b94"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkxMDQyNQ==", "bodyText": "I believe all updates to this file can be reverted.", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r499910425", "createdAt": "2020-10-05T22:39:45Z", "author": {"login": "awoods"}, "path": "fcrepo-kernel-impl/src/test/java/org/fcrepo/kernel/impl/ContainmentIndexImplTest.java", "diffHunk": "@@ -78,6 +79,8 @@\n     private final Map<String, FedoraResource> id_to_resource = new HashMap<>();\n     private final Map<String, Transaction> id_to_transaction = new HashMap<>();\n \n+    private final String ixnModel = BASIC_CONTAINER.getURI();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c103fb37731750d91c77ade68a594bda6f897b94"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyOTc5MjU1", "url": "https://github.com/fcrepo/fcrepo/pull/1761#pullrequestreview-502979255", "createdAt": "2020-10-06T13:45:28Z", "commit": {"oid": "c103fb37731750d91c77ade68a594bda6f897b94"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMzo0NToyOFrOHdHXAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNDoxNzoxOFrOHdJO8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI5MTMyOQ==", "bodyText": "I'm not really sure of the state of lenient at the moment, but shouldn't it be okay to specify a restricted type if it's already the interaction model of this resource?", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r500291329", "createdAt": "2020-10-06T13:45:28Z", "author": {"login": "bbpennel"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/services/HttpRdfService.java", "diffHunk": "@@ -230,4 +236,34 @@ protected static Model parseBodyAsModel(final InputStream requestBodyStream,\n         }\n     }\n \n+    /**\n+     * Checks if the RDF contains any disallowed statements.\n+     * @param statement a statement from the incoming RDF.\n+     */\n+    private static void checkForDisallowedRdf(final Statement statement) {\n+        checkTripleForDisallowed(statement.asTriple());\n+    }\n+\n+    /**\n+     * Several tests for invalid or disallowed RDF statements.\n+     * @param triple the triple to check.\n+     */\n+    public static void checkTripleForDisallowed(final Triple triple) {\n+        if (triple.getPredicate().equals(type().asNode()) && !triple.getObject().isURI()) {\n+            // The object of a rdf:type triple is not a URI.\n+            final var newType = triple.getObject().toString();\n+            throw new MalformedRdfException(\n+                    String.format(\"Invalid rdf:type: %s\", newType));\n+        } else if (restrictedType.test(triple)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c103fb37731750d91c77ade68a594bda6f897b94"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMwMDU0Mw==", "bodyText": "I'm just curious, does RDF.type cause issues? It appears to be a constant declaration of the result from RDF.Init.type(), not sure if we need to initialize it new each time?", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r500300543", "createdAt": "2020-10-06T13:55:05Z", "author": {"login": "bbpennel"}, "path": "fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/RdfLexicon.java", "diffHunk": "@@ -86,6 +88,12 @@\n     public static final Predicate<String> isManagedNamespace = p -> p.equals(REPOSITORY_NAMESPACE) ||\n             p.equals(LDP_NAMESPACE) || p.equals(MEMENTO_NAMESPACE);\n \n+    /**\n+     * Tests if we are trying to set the rdf:type to an object with a restricted namespace.\n+     */\n+    public static final Predicate<Triple> restrictedType = s -> s.getPredicate().equals(type().asNode()) &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c103fb37731750d91c77ade68a594bda6f897b94"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMwMTY3NQ==", "bodyText": "+1 to a FedoraResource method for getInteractionModel, i've found myself looking for it multiple times.", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r500301675", "createdAt": "2020-10-06T13:56:12Z", "author": {"login": "bbpennel"}, "path": "fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/models/ResourceFactory.java", "diffHunk": "@@ -112,4 +112,12 @@ public FedoraResource getResource(final String transactionId, final FedoraId fed\n      * @return Stream of child resources\n      */\n     public Stream<FedoraResource> getChildren(final String transactionId, final FedoraId resourceId);\n+\n+    /**\n+     * Get the interaction model of the resource, assumes you've checked it exists already.\n+     * @param transactionId The transaction id\n+     * @param fedoraId Identifier of the resource.\n+     * @return The interaction model.\n+     */\n+    public String getInteractionModel(final String transactionId, final FedoraId fedoraId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwNzU3MQ=="}, "originalCommit": {"oid": "c103fb37731750d91c77ade68a594bda6f897b94"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMxMTQ5NQ==", "bodyText": "It seems like some of the functionality here is duplicating some checks in AbstractService:\nhttps://github.com/fcrepo/fcrepo/blob/main/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/services/AbstractService.java#L154\nWere you thinking we would remove the check in AbstractService?\nOne advantage to where it is in AbstractService is that it is validating the model after a sparql update query has been applied to the model, in the case of PATCH. I don't think this method is called for PATCH currently?", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r500311495", "createdAt": "2020-10-06T14:06:21Z", "author": {"login": "bbpennel"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/services/HttpRdfService.java", "diffHunk": "@@ -117,6 +122,7 @@ public Model bodyToInternalModel(final String extResourceId, final InputStream s\n \n         while (stmtIterator.hasNext()) {\n             final Statement stmt = stmtIterator.nextStatement();\n+            checkForDisallowedRdf(stmt);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c103fb37731750d91c77ade68a594bda6f897b94"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMyMjAzMw==", "bodyText": "I don't know if this is a concern or not, but it might be unpredictable which error response you get from a request if the input contains both an interaction model change and a server managed triple. By checking for all the errors in the same loop (or not deferring the error thrown), whichever error is encountered first will be the result. Maybe that's fine, I was just concerned about that when looking at some tests, since the order of RDF is not generally guaranteed.\nFor what its worth, I stupidly hadn't noticed this PR yesterday and had started implementing checks for interaction model changes in my work on membership triples since so many of the Direct/Indirect container tests are about interaction model changes. I had added this method to ReplacePropertiesServiceImpl:\nprivate void ensureInteractionModelUnchanged(final FedoraId fedoraId, final Model model,\n            final String existingInteractionModel) {\n        final var rdfResc = model.getResource(fedoraId.getFullId());\n        final StmtIterator it = rdfResc.listProperties(RDF.type);\n        while (it.hasNext()) {\n            final Statement st = it.next();\n            if (!st.getObject().isURIResource()) {\n                continue;\n            }\n            final var objUri = st.getResource().getURI();\n\n            if (INTERACTION_MODELS_FULL.contains(objUri) && !objUri.equals(existingInteractionModel)) {\n                throw new InteractionModelViolationException(\"Changing the interaction model \"\n                        + existingInteractionModel + \" to \" + objUri + \" is not allowed!\");\n            }\n        }\n    }\n\nI was running this before checkForSmtsLdpTypes. On the other hand adding more iterations through the model will add up.\nbut wanted to make sure that if the request was changing the interaction model, that we would get the error for that over an error for", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r500322033", "createdAt": "2020-10-06T14:17:18Z", "author": {"login": "bbpennel"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/services/HttpRdfService.java", "diffHunk": "@@ -117,6 +122,7 @@ public Model bodyToInternalModel(final String extResourceId, final InputStream s\n \n         while (stmtIterator.hasNext()) {\n             final Statement stmt = stmtIterator.nextStatement();\n+            checkForDisallowedRdf(stmt);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMxMTQ5NQ=="}, "originalCommit": {"oid": "c103fb37731750d91c77ade68a594bda6f897b94"}, "originalPosition": 35}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "23d5b28c2424691d9d23527602a0762358340391", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/23d5b28c2424691d9d23527602a0762358340391", "committedDate": "2020-10-06T19:55:25Z", "message": "Remove todo"}, "afterCommit": {"oid": "75e787e1760712ab38d3191bb9bc612d13e0b167", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/75e787e1760712ab38d3191bb9bc612d13e0b167", "committedDate": "2020-10-06T21:00:33Z", "message": "Remove todo"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "75e787e1760712ab38d3191bb9bc612d13e0b167", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/75e787e1760712ab38d3191bb9bc612d13e0b167", "committedDate": "2020-10-06T21:00:33Z", "message": "Remove todo"}, "afterCommit": {"oid": "6b454f1bf33516184ce3746c99cfd4370a3bcc0f", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/6b454f1bf33516184ce3746c99cfd4370a3bcc0f", "committedDate": "2020-10-08T21:18:54Z", "message": "Remove todo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf79cd1a09ff421e2435127f7ec1f1ef6cc9c262", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/bf79cd1a09ff421e2435127f7ec1f1ef6cc9c262", "committedDate": "2020-10-10T21:53:54Z", "message": "Enforce server managed predicates and types."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33be0dc4a541f54b151a29e9dd195f5f61f643f4", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/33be0dc4a541f54b151a29e9dd195f5f61f643f4", "committedDate": "2020-10-10T21:53:54Z", "message": "Check for binaries interaction models in containment index."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb3a49446292fa448d8162a1317ede952c0e5bdf", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/cb3a49446292fa448d8162a1317ede952c0e5bdf", "committedDate": "2020-10-10T21:53:54Z", "message": "Go direct to the headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b361bcbba3882d495429c83ecf3e31b9d577307", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/8b361bcbba3882d495429c83ecf3e31b9d577307", "committedDate": "2020-10-10T21:55:56Z", "message": "Move getInteractionModel to FedoraResource\n\nAdd handling=lenient allowances/checks\n\nCode review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e473b9ee72e8b8471351712f0c0df97e89413ba2", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/e473b9ee72e8b8471351712f0c0df97e89413ba2", "committedDate": "2020-10-10T21:55:56Z", "message": "Remove todo"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6b454f1bf33516184ce3746c99cfd4370a3bcc0f", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/6b454f1bf33516184ce3746c99cfd4370a3bcc0f", "committedDate": "2020-10-08T21:18:54Z", "message": "Remove todo"}, "afterCommit": {"oid": "e473b9ee72e8b8471351712f0c0df97e89413ba2", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/e473b9ee72e8b8471351712f0c0df97e89413ba2", "committedDate": "2020-10-10T21:55:56Z", "message": "Remove todo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2Nzg2MTAx", "url": "https://github.com/fcrepo/fcrepo/pull/1761#pullrequestreview-506786101", "createdAt": "2020-10-12T17:05:35Z", "commit": {"oid": "e473b9ee72e8b8471351712f0c0df97e89413ba2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2ODUzNDAy", "url": "https://github.com/fcrepo/fcrepo/pull/1761#pullrequestreview-506853402", "createdAt": "2020-10-12T19:06:31Z", "commit": {"oid": "e473b9ee72e8b8471351712f0c0df97e89413ba2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2967, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}