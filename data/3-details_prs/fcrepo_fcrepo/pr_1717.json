{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2NDQ4Nzk4", "number": 1717, "title": "Adds support for order_by and order search parameters.", "bodyText": "Adds support for order_by and order search parameters\n\nJIRA Ticket: Resolves: https://jira.lyrasis.org/browse/FCREPO-3343\n\nOther Relevant Links (Mailing list discussion, related pull requests, etc.)\n\nWhat does this Pull Request do?\nYou can now add order_by= and order=<asc|desc> to your search querystring.\nHow should this be tested?\n# create two binary resources resources\ncurl -u fedoraAdmin:fedoraAdmin http://localhost:8080/rest -H \"Slug:b-text\" -H \"Link: <http://www.w3.org/ns/ldp#NonRDFSource>; rel=type\" -v -H \"Content-Type: text/plain\"  -X POST --data \"test\" -i\ncurl -u fedoraAdmin:fedoraAdmin http://localhost:8080/rest -H \"Slug:a-video\" -H \"Link: <http://www.w3.org/ns/ldp#NonRDFSource>; rel=type\" -v -H \"Content-Type: video/mpeg4\"  -X POST --data \"test\" -i\n\n# return default ordering (fedora_id asc)\ncurl -u fedoraAdmin:fedoraAdmin http://localhost:8080/rest/fcr:search | jq\n# verify the result is order by fedora id asc.\n\n# reverse the order\ncurl -u fedoraAdmin:fedoraAdmin \"http://localhost:8080/rest/fcr:search?order=desc\" | jq\n\n# order by mime_type desc\ncurl -u fedoraAdmin:fedoraAdmin \"http://localhost:8080/rest/fcr:searc?order_by=mime_type&order=desc\" | jq\n\n\nInterested parties\nTag (@ mention) interested parties or, if unsure, @fcrepo4/committers", "createdAt": "2020-07-08T19:47:38Z", "url": "https://github.com/fcrepo/fcrepo/pull/1717", "merged": true, "mergeCommit": {"oid": "ee7281834716a1b512706a3eccc4dce2123ea92f"}, "closed": true, "closedAt": "2020-07-13T21:24:53Z", "author": {"login": "dbernstein"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczQLmJAFqTQ0NTY2OTQzMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc0oQyagFqTQ0NzYxMjU2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NjY5NDMw", "url": "https://github.com/fcrepo/fcrepo/pull/1717#pullrequestreview-445669430", "createdAt": "2020-07-09T14:26:03Z", "commit": {"oid": "8c28f4154bdf5dbf6efa627cff09726ca766579e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNDoyNjowM1rOGvToiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNDo0MzowOVrOGvUZDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI1NzkzMQ==", "bodyText": "Minor: Can you bring the closing ) to follow directly after orderBy?", "url": "https://github.com/fcrepo/fcrepo/pull/1717#discussion_r452257931", "createdAt": "2020-07-09T14:26:03Z", "author": {"login": "awoods"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraSearch.java", "diffHunk": "@@ -82,7 +82,10 @@ public FedoraSearch() {\n     public Response doSearch(@QueryParam(value = \"condition\") final List<String> conditions,\n                              @QueryParam(value = \"fields\") final String fields,\n                              @DefaultValue(\"100\") @QueryParam(\"max_results\") final int maxResults,\n-                             @DefaultValue(\"0\") @QueryParam(\"offset\") final int offset) {\n+                             @DefaultValue(\"0\") @QueryParam(\"offset\") final int offset,\n+                             @DefaultValue(\"asc\") @QueryParam(\"order\") final String order,\n+                             @DefaultValue(\"fedora_id\") @QueryParam(\"order_by\") final String orderBy\n+    ) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c28f4154bdf5dbf6efa627cff09726ca766579e"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI2NTU2MA==", "bodyText": "There are two valid values for the order field: asc and desc.\nWhat is the purpose of listing all of the potential fields? ...likely should be removed.", "url": "https://github.com/fcrepo/fcrepo/pull/1717#discussion_r452265560", "createdAt": "2020-07-09T14:36:41Z", "author": {"login": "awoods"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraSearch.java", "diffHunk": "@@ -105,7 +108,21 @@ public Response doSearch(@QueryParam(value = \"condition\") final List<String> con\n                 }\n             }\n \n-            final var params = new SearchParameters(parsedFields, conditionList, maxResults, offset);\n+            final Condition.Field orderByField;\n+            try {\n+                orderByField = Condition.Field.fromString(orderBy);\n+            } catch (final Exception e) {\n+                throw new InvalidQueryException(\"The order_by field must contain a valid value such as \" +\n+                        StringUtils.join(Condition.Field.values()));\n+            }\n+\n+            if (!(order.equalsIgnoreCase(\"asc\") || order.equalsIgnoreCase(\"desc\"))) {\n+                throw new InvalidQueryException(\"The order field is invalid:  valid values are \\\"asc\\\" and \\\"desc\\\"\" +\n+                        StringUtils.join(Condition.Field.values()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c28f4154bdf5dbf6efa627cff09726ca766579e"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI2NzAxMg==", "bodyText": "Likely want to add a separator, such as:\nStringUtils.join(Condition.Field.values(), \", \"));", "url": "https://github.com/fcrepo/fcrepo/pull/1717#discussion_r452267012", "createdAt": "2020-07-09T14:38:41Z", "author": {"login": "awoods"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraSearch.java", "diffHunk": "@@ -105,7 +108,21 @@ public Response doSearch(@QueryParam(value = \"condition\") final List<String> con\n                 }\n             }\n \n-            final var params = new SearchParameters(parsedFields, conditionList, maxResults, offset);\n+            final Condition.Field orderByField;\n+            try {\n+                orderByField = Condition.Field.fromString(orderBy);\n+            } catch (final Exception e) {\n+                throw new InvalidQueryException(\"The order_by field must contain a valid value such as \" +\n+                        StringUtils.join(Condition.Field.values()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c28f4154bdf5dbf6efa627cff09726ca766579e"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI3MDM0OA==", "bodyText": "Since this test is named to be testing the \"default\" ordering, I would suggest removing the order_by and order query parameters... and rely on the defaults.\nA new, separate test could be useful to test desc order.", "url": "https://github.com/fcrepo/fcrepo/pull/1717#discussion_r452270348", "createdAt": "2020-07-09T14:43:09Z", "author": {"login": "awoods"}, "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraSearchIT.java", "diffHunk": "@@ -435,6 +435,52 @@ public void testMalformedCondition() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void testDefaultOrdering() throws Exception {\n+        final var prefix = getRandomUniqueId();\n+        final var resources = createResources(prefix, 3);\n+        final var condition = FEDORA_ID + \"=\" + prefix + \"*\";\n+        final String searchUrl = getSearchEndpoint() + \"condition=\" + encode(condition) +\n+                \"&order_by=fedora_id&order=asc\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c28f4154bdf5dbf6efa627cff09726ca766579e"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31fcbd3b5206c94cbdde29ecb839f0ace0cca760", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/31fcbd3b5206c94cbdde29ecb839f0ace0cca760", "committedDate": "2020-07-12T05:49:01Z", "message": "Adds support for order_by and order search parameters.\nResolves: https://jira.lyrasis.org/browse/FCREPO-3343"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d77ef584f0e357ef753ebdd90d78b39cce428c6d", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/d77ef584f0e357ef753ebdd90d78b39cce428c6d", "committedDate": "2020-07-12T05:49:01Z", "message": "Addresses PR feedback."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8c28f4154bdf5dbf6efa627cff09726ca766579e", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/8c28f4154bdf5dbf6efa627cff09726ca766579e", "committedDate": "2020-07-08T19:28:26Z", "message": "Adds support for order_by and order search parameters.\nResolves: https://jira.lyrasis.org/browse/FCREPO-3343"}, "afterCommit": {"oid": "d77ef584f0e357ef753ebdd90d78b39cce428c6d", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/d77ef584f0e357ef753ebdd90d78b39cce428c6d", "committedDate": "2020-07-12T05:49:01Z", "message": "Addresses PR feedback."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fb2b5f5a9765496a19792d960a61f31ff173894", "author": {"user": {"login": "dbernstein", "name": "dbernstein"}}, "url": "https://github.com/fcrepo/fcrepo/commit/9fb2b5f5a9765496a19792d960a61f31ff173894", "committedDate": "2020-07-13T18:08:48Z", "message": "As delimiter to join statement."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3NjEyNTYy", "url": "https://github.com/fcrepo/fcrepo/pull/1717#pullrequestreview-447612562", "createdAt": "2020-07-13T21:24:41Z", "commit": {"oid": "9fb2b5f5a9765496a19792d960a61f31ff173894"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3161, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}