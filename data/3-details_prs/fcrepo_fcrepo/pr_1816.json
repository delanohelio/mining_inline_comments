{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2NTg2NTM3", "number": 1816, "title": "all db commits within the same db transaction", "bodyText": "JIRA Ticket: https://jira.lyrasis.org/browse/FCREPO-3529\nWhat does this Pull Request do?\nFixes the transaction commit code so that all db commits are within the same transaction so that either they are all applied or none of them are.\nThis PR only fixes the db transactions. It will no cleanup already persisted OCFL changes. This should be handled by https://jira.lyrasis.org/browse/FCREPO-3130\nHow should this be tested?\nThis is difficult to test. You'd need to create a Fedora transaction and then corrupt a db table before committing the transaction so that the Fedora transaction does not commit cleanly.\nInterested parties\n@fcrepo/committers", "createdAt": "2020-11-24T15:58:07Z", "url": "https://github.com/fcrepo/fcrepo/pull/1816", "merged": true, "mergeCommit": {"oid": "5ff1e9f806da91b1e3cdfb51061c5bf818f707c0"}, "closed": true, "closedAt": "2020-11-25T21:16:24Z", "author": {"login": "pwinckles"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfr1YrgH2gAyNTI2NTg2NTM3OjdjYzk1Mzg1MjdiZTg2MDI3ZDAzY2Y5M2E4ODIwOTZkOWEyZWJhYTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgFDlRgFqTUzODg1MDY1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7cc9538527be86027d03cf93a882096d9a2ebaa3", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/7cc9538527be86027d03cf93a882096d9a2ebaa3", "committedDate": "2020-11-24T15:53:07Z", "message": "fixed transaction rollback so that all db commits are contained within the same db transaction"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NzE3MTQ3", "url": "https://github.com/fcrepo/fcrepo/pull/1816#pullrequestreview-537717147", "createdAt": "2020-11-24T16:54:31Z", "commit": {"oid": "7cc9538527be86027d03cf93a882096d9a2ebaa3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNjo1NDozMVrOH5MH3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNjo1NDozMVrOH5MH3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTcyOTUwMQ==", "bodyText": "I think this NOT_FOUND response is coming from the containment index, which failed and should have rolled back. Could we have one of the other services fail instead, like the ocfl Index, reference service or membership service? Just to ensure all the transactions are being rolled back.", "url": "https://github.com/fcrepo/fcrepo/pull/1816#discussion_r529729501", "createdAt": "2020-11-24T16:54:31Z", "author": {"login": "whikloj"}, "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/TransactionsIT.java", "diffHunk": "@@ -194,6 +196,47 @@ public void testCreateDoStuffAndRollbackTransaction() throws IOException {\n                 CONFLICT.getStatusCode(), getStatus(addTxTo(new HttpGet(newLocation), txLocation)));\n     }\n \n+    @Test\n+    public void testRollbackShouldNotLeaveDbInPartiallyUpdatedState() throws IOException {\n+        /* create a tx */\n+        final String txLocation = createTransaction();\n+\n+        /* create a new object inside the tx */\n+        final String newLocation;\n+        final HttpPost postNew = new HttpPost(serverAddress);\n+        postNew.addHeader(ATOMIC_ID_HEADER, txLocation);\n+        try (final CloseableHttpResponse resp = execute(postNew)) {\n+            assertEquals(CREATED.getStatusCode(), getStatus(resp));\n+            newLocation = getLocation(resp);\n+        }\n+\n+        final var resourceId = StringUtils.substringAfterLast(newLocation, \"/\");\n+\n+        /* fetch the created tx from the endpoint */\n+        try (final CloseableDataset dataset = getDataset(addTxTo(new HttpGet(newLocation), txLocation))) {\n+            assertTrue(dataset.asDatasetGraph().contains(ANY, createURI(newLocation), ANY, ANY));\n+        }\n+        /* fetch the created tx from the endpoint */\n+        assertEquals(\"Expected to not find our object within the scope of the transaction\",\n+                NOT_FOUND.getStatusCode(), getStatus(new HttpGet(newLocation)));\n+\n+        // Add a conflicting record to the database\n+        final var containmentIndex = getBean(\"containmentIndex\", ContainmentIndex.class);\n+        containmentIndex.addContainedBy(\"bogus\", FedoraId.getRepositoryRootId(), FedoraId.create(resourceId));\n+        containmentIndex.commitTransaction(\"bogus\");\n+\n+        // Commit transaction -- should fail\n+        assertEquals(CONFLICT.getStatusCode(), getStatus(new HttpPut(txLocation)));\n+\n+        assertEquals(\"Rolled back transaction should be gone\",\n+                GONE.getStatusCode(), getStatus(new HttpGet(txLocation)));\n+\n+        assertEquals(\"Expected to not find our object after rollback\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cc9538527be86027d03cf93a882096d9a2ebaa3"}, "originalPosition": 99}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b5e9e1a7e448a76d694825620ab217fd5b9c5e3", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/4b5e9e1a7e448a76d694825620ab217fd5b9c5e3", "committedDate": "2020-11-24T18:07:51Z", "message": "added unique index to mysql containment table"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4ODIxNzgx", "url": "https://github.com/fcrepo/fcrepo/pull/1816#pullrequestreview-538821781", "createdAt": "2020-11-25T20:19:36Z", "commit": {"oid": "4b5e9e1a7e448a76d694825620ab217fd5b9c5e3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQyMDoxOTozNlrOH6Cp2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQyMDoxOTozNlrOH6Cp2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDYyMjkzOA==", "bodyText": "You can just add the PRIMARY KEY to the fedora_id line, I'm not sure why it disappeared but clearly I made a mistake.", "url": "https://github.com/fcrepo/fcrepo/pull/1816#discussion_r530622938", "createdAt": "2020-11-25T20:19:36Z", "author": {"login": "whikloj"}, "path": "fcrepo-kernel-impl/src/main/resources/sql/mysql-containment.sql", "diffHunk": "@@ -3,10 +3,11 @@\n \n -- Holds the ID and its parent.\n CREATE TABLE IF NOT EXISTS containment (\n-    fedora_id  varchar(503) NOT NULL,\n+    fedora_id varchar(503) NOT NULL,\n     parent varchar(503) NOT NULL,\n     start_time timestamp NOT NULL,\n-    end_time timestamp NULL\n+    end_time timestamp NULL,\n+    UNIQUE KEY (fedora_id)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b5e9e1a7e448a76d694825620ab217fd5b9c5e3"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d8020615cb1d056bffbc27c5f0a623eb7002424", "author": {"user": {"login": "pwinckles", "name": "Peter Winckles"}}, "url": "https://github.com/fcrepo/fcrepo/commit/0d8020615cb1d056bffbc27c5f0a623eb7002424", "committedDate": "2020-11-25T20:37:29Z", "message": "change msyql containment to primary key"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4ODUwNjU1", "url": "https://github.com/fcrepo/fcrepo/pull/1816#pullrequestreview-538850655", "createdAt": "2020-11-25T21:16:15Z", "commit": {"oid": "0d8020615cb1d056bffbc27c5f0a623eb7002424"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3038, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}