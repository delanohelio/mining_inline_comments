{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyOTI0NzMw", "number": 1810, "title": "Alter ETag based on contained resources", "bodyText": "JIRA Ticket: https://jira.lyrasis.org/browse/FCREPO-3541\nWhat does this Pull Request do?\nWe don't change the ETag when a container has a new or deleted contained resource.  This attempts to fix that by generating a hash of all the children of the requested resource.\nI think this might be slowing down ingest as I was creating 5,000 children of a single parent and it seemed to average about 0.14 per resource (which is slower than normal on my machine).\nAlso there is probably a limit to how many contained resources this might work with. Probably need the big test machine to see if and when this crashes.\nHow should this be tested?\nCreate a container, note it's ETag and Last Modified time.\nCreate a child of the container, note it's ETag changes, but it's Last Modified is unchanged.\nInterested parties\nTag (@ mention) interested parties or, if unsure, @fcrepo/committers", "createdAt": "2020-11-18T05:31:36Z", "url": "https://github.com/fcrepo/fcrepo/pull/1810", "merged": true, "mergeCommit": {"oid": "203675ef987566d2fec595fcc00edbad4a1b3952"}, "closed": true, "closedAt": "2020-11-27T20:52:02Z", "author": {"login": "whikloj"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdefYWYgBqjQwMjMwNDgwNzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgt0GlgFqTU0MDE4NzEwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a1004fe8188b865bd395d329ed815955548bd7d4", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/a1004fe8188b865bd395d329ed815955548bd7d4", "committedDate": "2020-11-18T05:30:00Z", "message": "Alter ETag based on contained resources"}, "afterCommit": {"oid": "99c9a9777d85efcce0f5fca9b46f5259b978147f", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/99c9a9777d85efcce0f5fca9b46f5259b978147f", "committedDate": "2020-11-20T22:48:24Z", "message": "Use a last modified containment instead of a hash of contained resources"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e72851a13523db9a0821b0eb6916042d9643b2c7", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/e72851a13523db9a0821b0eb6916042d9643b2c7", "committedDate": "2020-11-22T04:18:57Z", "message": "Use datetime instead of timestamp"}, "afterCommit": {"oid": "9701cd98084752071169fd8e39d85c9e27831f55", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/9701cd98084752071169fd8e39d85c9e27831f55", "committedDate": "2020-11-25T20:01:20Z", "message": "Use datetime instead of timestamp"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5MzE2ODY2", "url": "https://github.com/fcrepo/fcrepo/pull/1810#pullrequestreview-539316866", "createdAt": "2020-11-26T13:30:58Z", "commit": {"oid": "9701cd98084752071169fd8e39d85c9e27831f55"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMzozMDo1OVrOH6bjIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMzozNTowOFrOH6bsWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzMDgxOQ==", "bodyText": "This code is only relevant when loading a container, correct? If so, I think we should only do this lookup when necessary.\nThis code would also be a good candidate for caching in the future.", "url": "https://github.com/fcrepo/fcrepo/pull/1810#discussion_r531030819", "createdAt": "2020-11-26T13:30:59Z", "author": {"login": "pwinckles"}, "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/models/ResourceFactoryImpl.java", "diffHunk": "@@ -193,14 +194,18 @@ private FedoraResource instantiateResource(final String transactionId,\n         }\n     }\n \n-    private void populateResourceHeaders(final FedoraResourceImpl resc, final ResourceHeaders headers,\n-                                         final Instant version) {\n+    private void populateResourceHeaders(final String transactionId, final FedoraResourceImpl resc,\n+                                         final ResourceHeaders headers, final Instant version) {\n         resc.setCreatedBy(headers.getCreatedBy());\n         resc.setCreatedDate(headers.getCreatedDate());\n         resc.setLastModifiedBy(headers.getLastModifiedBy());\n         resc.setLastModifiedDate(headers.getLastModifiedDate());\n         resc.setParentId(headers.getParent());\n-        resc.setEtag(headers.getStateToken());\n+        final Instant containmentUpdated = containmentIndex.containmentLastUpdated(transactionId, resc.getFedoraId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9701cd98084752071169fd8e39d85c9e27831f55"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzMzE3OA==", "bodyText": "I'm guessing that there will be similar code to this for membership? It might be nice to abstract the etag computation out into its own class, but you don't necessarily need to do so here.", "url": "https://github.com/fcrepo/fcrepo/pull/1810#discussion_r531033178", "createdAt": "2020-11-26T13:35:08Z", "author": {"login": "pwinckles"}, "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/models/ResourceFactoryImpl.java", "diffHunk": "@@ -193,14 +194,18 @@ private FedoraResource instantiateResource(final String transactionId,\n         }\n     }\n \n-    private void populateResourceHeaders(final FedoraResourceImpl resc, final ResourceHeaders headers,\n-                                         final Instant version) {\n+    private void populateResourceHeaders(final String transactionId, final FedoraResourceImpl resc,\n+                                         final ResourceHeaders headers, final Instant version) {\n         resc.setCreatedBy(headers.getCreatedBy());\n         resc.setCreatedDate(headers.getCreatedDate());\n         resc.setLastModifiedBy(headers.getLastModifiedBy());\n         resc.setLastModifiedDate(headers.getLastModifiedDate());\n         resc.setParentId(headers.getParent());\n-        resc.setEtag(headers.getStateToken());\n+        final Instant containmentUpdated = containmentIndex.containmentLastUpdated(transactionId, resc.getFedoraId());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzMDgxOQ=="}, "originalCommit": {"oid": "9701cd98084752071169fd8e39d85c9e27831f55"}, "originalPosition": 47}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9701cd98084752071169fd8e39d85c9e27831f55", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/9701cd98084752071169fd8e39d85c9e27831f55", "committedDate": "2020-11-25T20:01:20Z", "message": "Use datetime instead of timestamp"}, "afterCommit": {"oid": "30b22e3f6e5cc81395e2a6b3f7fad016286a11ab", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/30b22e3f6e5cc81395e2a6b3f7fad016286a11ab", "committedDate": "2020-11-26T19:49:36Z", "message": "Check end_time to get correct last updated after reindex."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15f29428e2d7d58cde74610eb3c6d48897c4abd3", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/15f29428e2d7d58cde74610eb3c6d48897c4abd3", "committedDate": "2020-11-27T18:44:19Z", "message": "Alter ETag based on contained resources"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38fbd4c8401b5a397cd6856e8e285e8935850f48", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/38fbd4c8401b5a397cd6856e8e285e8935850f48", "committedDate": "2020-11-27T18:45:10Z", "message": "Use a last modified containment instead of a hash of contained resources"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d292cdc076c6dd9cc3a6f188a2e49f90f8a6238", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/3d292cdc076c6dd9cc3a6f188a2e49f90f8a6238", "committedDate": "2020-11-27T18:45:15Z", "message": "Use datetime instead of timestamp"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3797d63ab87d57d42d5c8d0c62593969c60c8f68", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/3797d63ab87d57d42d5c8d0c62593969c60c8f68", "committedDate": "2020-11-27T18:45:15Z", "message": "Check end_time to get correct last updated after reindex."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fae73ad0f4986fe49abbfd3e4a6c5b183b6bf9d", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/6fae73ad0f4986fe49abbfd3e4a6c5b183b6bf9d", "committedDate": "2020-11-27T18:45:15Z", "message": "Only query for containment on Containers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "304007309f90a3bc7618f1fb5462a7f7836f0610", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/304007309f90a3bc7618f1fb5462a7f7836f0610", "committedDate": "2020-11-26T22:27:08Z", "message": "Only query for containment on Containers"}, "afterCommit": {"oid": "6fae73ad0f4986fe49abbfd3e4a6c5b183b6bf9d", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/6fae73ad0f4986fe49abbfd3e4a6c5b183b6bf9d", "committedDate": "2020-11-27T18:45:15Z", "message": "Only query for containment on Containers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwMTg3MTA5", "url": "https://github.com/fcrepo/fcrepo/pull/1810#pullrequestreview-540187109", "createdAt": "2020-11-27T20:45:27Z", "commit": {"oid": "6fae73ad0f4986fe49abbfd3e4a6c5b183b6bf9d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3026, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}