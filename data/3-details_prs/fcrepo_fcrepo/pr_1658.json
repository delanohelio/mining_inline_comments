{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwODI4MzQ2", "number": 1658, "title": "FCREPO-3264 - Start and commit transactions", "bodyText": "JIRA Ticket: https://jira.lyrasis.org/browse/FCREPO-3264\nWhat does this Pull Request do?\nEnables starting and committing multi-request transactions based on the following specification:\nhttps://github.com/fcrepo/fcrepo-specification-atomic-operations/pull/8/files\nAdds in a few other related transaction details from the specification\nWhat's new?\n\nImplement multi-request transaction creation, refreshing, status, and committing.\nTransaction provided will attempt to retrieve transaction id from request URI if header is not present\nTransactionImpl uses system property for session timeout if present.\nConsolidate transaction constants and add more detail to exceptions.\nAdjustments to persistent session rollback locking code to not fail if rolling back a transaction with no changes\nMoves injection of transaction up to ContentExposingResource so that it does not automatically happen in Transactions controller. Moved methods which depend on transaction with it.\n\nHow should this be tested?\nUpdated tests, and can be manually tested:\n# Run fedora in jetty\nmvn jetty:run -Dfcrepo.external.content.allowed=fcrepo-http-api/src/test/resources/allowed_external_paths.txt -Dfcrepo.auth.webac.userAgent.baseUri=http://example.com/ -pl fcrepo-webapp/\n\n\n\n# Start TX, record the id of the transaction from the Location header\ncurl -XPOST http://localhost:8080/rest/fcr:tx -ufedoraAdmin:fedoraAdmin -v\n\n< Location: http://localhost:8080/rest/fcr:tx/acd95f27-4251-490d-bb78-9c4496b8b990\n\n# Get the status of your TX\ncurl http://localhost:8080/rest/fcr:tx/acd95f27-4251-490d-bb78-9c4496b8b990 -ufedoraAdmin:fedoraAdmin -v\n# verify that Atomic-Expires is present\n\n# Refresh the expiration of the TX\ncurl -XPOST http://localhost:8080/rest/fcr:tx/acd95f27-4251-490d-bb78-9c4496b8b990 -ufedoraAdmin:fedoraAdmin -v\n# verify that Atomic-Expires is updated\n\n\n# Create a resource in the tx\ncurl -XPUT http://localhost:8080/rest/txtest -H\"Atomic-ID: http://localhost:8080/rest/fcr:tx/acd95f27-4251-490d-bb78-9c4496b8b990\" -ufedoraAdmin:fedoraAdmin -v\n\n< Atomic-ID: http://localhost:8080/rest/fcr:tx/acd95f27-4251-490d-bb78-9c4496b8b990\n< Location: http://localhost:8080/rest/txtest\n\n# Request outside of TX\ncurl http://localhost:8080/rest/txtest -ufedoraAdmin:fedoraAdmin -v\n# should return 404, although the error message is a bit messy\n\n# Request in TX\ncurl http://localhost:8080/rest/txtest -H\"Atomic-ID: http://localhost:8080/rest/fcr:tx/acd95f27-4251-490d-bb78-9c4496b8b990\" -ufedoraAdmin:fedoraAdmin -v\n\n# Commit TX\ncurl -XPUT http://localhost:8080/rest/fcr:tx/acd95f27-4251-490d-bb78-9c4496b8b990/commit -ufedoraAdmin:fedoraAdmin -v\n# 204\n\n# Request outside of TX\ncurl http://localhost:8080/rest/txtest -ufedoraAdmin:fedoraAdmin -v\n# should return the same response as the request in the tx\n\nAdditional Notes:\nOne part that might be worth discussion is that Atomic-ID and Atomic-Expires are not being returned on transaction start, in favor of Location and Expires headers. The former is in the spec, but I'm not sure which is preferable in terms of expires.\nInterested parties\n@peichman-umd, @fcrepo4/committers", "createdAt": "2020-04-08T12:49:19Z", "url": "https://github.com/fcrepo/fcrepo/pull/1658", "merged": true, "mergeCommit": {"oid": "b7b426a49612d5ba130dc20ed854edf3fe474d7a"}, "closed": true, "closedAt": "2020-04-09T18:25:49Z", "author": {"login": "bbpennel"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVZ2ztgH2gAyNDAwODI4MzQ2OjZkZWY3NjU0MDE1NmI1MzEwYzA2ODA5YTZiNjc4NWQ1YTlmMjc1NjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVw2t3AH2gAyNDAwODI4MzQ2OjY5YTU5ZTEzMGFiM2Y3ZmQyOWY1OThiNGJhMTk1MjdiNzBhNTQ2ZGM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6def76540156b5310c06809a6b6785d5a9f27564", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/fcrepo/fcrepo/commit/6def76540156b5310c06809a6b6785d5a9f27564", "committedDate": "2020-04-07T21:05:59Z", "message": "Move injection of transaction up to ContentExposingResource so that it does not automatically happen in Transactions controller. Moved methods which depend on transaction with it."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "416cbc03565ca8f0f005ba70918808c09678bbd6", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/fcrepo/fcrepo/commit/416cbc03565ca8f0f005ba70918808c09678bbd6", "committedDate": "2020-04-07T21:05:59Z", "message": "Adjustments to persistent session rollback locking code to not fail if rolling back a transaction with no changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e955647cd6e0ce3ec8cdc46ef29b9eb20248454c", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/fcrepo/fcrepo/commit/e955647cd6e0ce3ec8cdc46ef29b9eb20248454c", "committedDate": "2020-04-07T21:05:59Z", "message": "Implement multi-request transaction creation, refreshing, status, and committing.\n\nTransaction provided will attempt to retrieve transaction id from request URI if header is not present\n\nTransactionImpl uses system property for session timeout if present.\n\nConsolidate transaction constants and add more detail to exceptions."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "697b29c59828e3f936b0ad2058490d942aa4e8bd", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/fcrepo/fcrepo/commit/697b29c59828e3f936b0ad2058490d942aa4e8bd", "committedDate": "2020-04-08T16:14:49Z", "message": "Split up refresh and status methods for transactions so that they can respond to errors differently. Added unit tests for creation, refresh and status. Changed refresh to return 400 status if tx not found, to be consistent with the other modification operations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMTI3MzQ3", "url": "https://github.com/fcrepo/fcrepo/pull/1658#pullrequestreview-390127347", "createdAt": "2020-04-08T16:15:51Z", "commit": {"oid": "e955647cd6e0ce3ec8cdc46ef29b9eb20248454c"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNjoxNTo1MVrOGC2rpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNjoxNjoyN1rOGC2tJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY0NjI0Ng==", "bodyText": "Do we want to return  a text message as well such as \"Transaction does not exist: {txId}\"", "url": "https://github.com/fcrepo/fcrepo/pull/1658#discussion_r405646246", "createdAt": "2020-04-08T16:15:51Z", "author": {"login": "dbernstein"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/Transactions.java", "diffHunk": "@@ -84,19 +151,20 @@ public Response createTransaction() throws URISyntaxException {\n      * @return 204\n      */\n     @PUT\n-    @Path(\"/fcr:tx/{transactionId}/commit\")\n+    @Path(\"{transactionId}/commit\")\n     public Response commit(@PathParam(\"transactionId\") final String txId) {\n         try {\n             final Transaction transaction = txManager.get(txId);\n-            LOGGER.info(\"Commit transaction '{}'\", transaction.getId());\n+            LOGGER.info(\"Committing transaction '{}'\", transaction.getId());\n             transaction.commit();\n             return noContent().build();\n-        } catch(Exception e) {\n-            if (e.getMessage().matches(\"No Transaction found with transactionId\")) {\n-                return status(BAD_REQUEST).entity(e.getMessage()).type(TEXT_PLAIN_WITH_CHARSET).build();\n-            } else {\n-                throw new RuntimeException(e);\n-            }\n+        } catch (final TransactionNotFoundException e) {\n+            return Response.status(Status.BAD_REQUEST).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e955647cd6e0ce3ec8cdc46ef29b9eb20248454c"}, "originalPosition": 139}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY0NjYyOA==", "bodyText": "Or at least pass e.getMessage()", "url": "https://github.com/fcrepo/fcrepo/pull/1658#discussion_r405646628", "createdAt": "2020-04-08T16:16:27Z", "author": {"login": "dbernstein"}, "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/Transactions.java", "diffHunk": "@@ -84,19 +151,20 @@ public Response createTransaction() throws URISyntaxException {\n      * @return 204\n      */\n     @PUT\n-    @Path(\"/fcr:tx/{transactionId}/commit\")\n+    @Path(\"{transactionId}/commit\")\n     public Response commit(@PathParam(\"transactionId\") final String txId) {\n         try {\n             final Transaction transaction = txManager.get(txId);\n-            LOGGER.info(\"Commit transaction '{}'\", transaction.getId());\n+            LOGGER.info(\"Committing transaction '{}'\", transaction.getId());\n             transaction.commit();\n             return noContent().build();\n-        } catch(Exception e) {\n-            if (e.getMessage().matches(\"No Transaction found with transactionId\")) {\n-                return status(BAD_REQUEST).entity(e.getMessage()).type(TEXT_PLAIN_WITH_CHARSET).build();\n-            } else {\n-                throw new RuntimeException(e);\n-            }\n+        } catch (final TransactionNotFoundException e) {\n+            return Response.status(Status.BAD_REQUEST).build();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY0NjI0Ng=="}, "originalCommit": {"oid": "e955647cd6e0ce3ec8cdc46ef29b9eb20248454c"}, "originalPosition": 139}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb18e088bbd60c258eb4e6ce15a4fc52e535e6e6", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/fcrepo/fcrepo/commit/fb18e088bbd60c258eb4e6ce15a4fc52e535e6e6", "committedDate": "2020-04-08T16:39:54Z", "message": "Fix line length"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08b440cb81e55adecaaf2231bd8c8cdd6beb7fc6", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/fcrepo/fcrepo/commit/08b440cb81e55adecaaf2231bd8c8cdd6beb7fc6", "committedDate": "2020-04-08T23:13:53Z", "message": "Handle transaction exceptions thrown when retrieving transactions during normal api calls. TransactionProvider no longer injecting transactions via binding.\n\nUpdate response statuses for transaction operations."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69a59e130ab3f7fd29f598b4ba19527b70a546dc", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/fcrepo/fcrepo/commit/69a59e130ab3f7fd29f598b4ba19527b70a546dc", "committedDate": "2020-04-08T23:53:42Z", "message": "Merge branch 'master' into fcrepo-3264-create-commit-tx"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3079, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}