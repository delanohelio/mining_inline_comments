{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2MTIxMjk3", "number": 1788, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNToyNzowM1rOE1tU0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNTozMTowNFrOE1tcNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NzUyNTk1OnYy", "diffSide": "RIGHT", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNToyNzowM1rOHuIkDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMDoxNzo0MFrOHyMh1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEzNjg0Ng==", "bodyText": "Would getResouceId() not do what you want here?", "url": "https://github.com/fcrepo/fcrepo/pull/1788#discussion_r518136846", "createdAt": "2020-11-05T15:27:03Z", "author": {"login": "pwinckles"}, "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "diffHunk": "@@ -325,21 +377,27 @@ private NamedParameterJdbcTemplate getNamedParameterJdbcTemplate() {\n \n     @Override\n     public Stream<String> getContains(final String txId, final FedoraId fedoraId) {\n-        final String resourceId = fedoraId.getFullId();\n+        final String resourceId = fedoraId.isMemento() ? fedoraId.getBaseId() : fedoraId.getFullId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a11a415c0446162bd51a3cbf7f374bc18e369e0e"}, "originalPosition": 259}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4NDY5OQ==", "bodyText": "getResourceId() handles ACLs and NonRdfSourceDescriptions, but not Mementos.", "url": "https://github.com/fcrepo/fcrepo/pull/1788#discussion_r520884699", "createdAt": "2020-11-10T21:28:01Z", "author": {"login": "whikloj"}, "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "diffHunk": "@@ -325,21 +377,27 @@ private NamedParameterJdbcTemplate getNamedParameterJdbcTemplate() {\n \n     @Override\n     public Stream<String> getContains(final String txId, final FedoraId fedoraId) {\n-        final String resourceId = fedoraId.getFullId();\n+        final String resourceId = fedoraId.isMemento() ? fedoraId.getBaseId() : fedoraId.getFullId();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEzNjg0Ng=="}, "originalCommit": {"oid": "a11a415c0446162bd51a3cbf7f374bc18e369e0e"}, "originalPosition": 259}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg5MDI3MQ==", "bodyText": "But, the output of getResourceId can never contain a memento because it constructs an id based on the baseId.", "url": "https://github.com/fcrepo/fcrepo/pull/1788#discussion_r520890271", "createdAt": "2020-11-10T21:38:46Z", "author": {"login": "pwinckles"}, "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "diffHunk": "@@ -325,21 +377,27 @@ private NamedParameterJdbcTemplate getNamedParameterJdbcTemplate() {\n \n     @Override\n     public Stream<String> getContains(final String txId, final FedoraId fedoraId) {\n-        final String resourceId = fedoraId.getFullId();\n+        final String resourceId = fedoraId.isMemento() ? fedoraId.getBaseId() : fedoraId.getFullId();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEzNjg0Ng=="}, "originalCommit": {"oid": "a11a415c0446162bd51a3cbf7f374bc18e369e0e"}, "originalPosition": 259}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM5NjExNg==", "bodyText": "I understand, I can change this.", "url": "https://github.com/fcrepo/fcrepo/pull/1788#discussion_r522396116", "createdAt": "2020-11-12T20:17:40Z", "author": {"login": "whikloj"}, "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "diffHunk": "@@ -325,21 +377,27 @@ private NamedParameterJdbcTemplate getNamedParameterJdbcTemplate() {\n \n     @Override\n     public Stream<String> getContains(final String txId, final FedoraId fedoraId) {\n-        final String resourceId = fedoraId.getFullId();\n+        final String resourceId = fedoraId.isMemento() ? fedoraId.getBaseId() : fedoraId.getFullId();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEzNjg0Ng=="}, "originalCommit": {"oid": "a11a415c0446162bd51a3cbf7f374bc18e369e0e"}, "originalPosition": 259}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NzU0NDg0OnYy", "diffSide": "RIGHT", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNTozMTowNFrOHuIvqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxODowMzo0NlrOHxYdtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEzOTgxOQ==", "bodyText": "Since mementos have second level granularity, perhaps it would make sense to truncate to the second?", "url": "https://github.com/fcrepo/fcrepo/pull/1788#discussion_r518139819", "createdAt": "2020-11-05T15:31:04Z", "author": {"login": "pwinckles"}, "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "diffHunk": "@@ -591,4 +660,18 @@ public void setDataSource(final DataSource dataSource) {\n         this.dataSource = dataSource;\n     }\n \n+    /**\n+     * Format an instant to a timestamp without milliseconds, due to precision\n+     * issues with memento datetimes.\n+     * @param instant\n+     * @return the timestamp\n+     */\n+    private Timestamp formatInstant(final Instant instant) {\n+        if (instant == null) {\n+            return null;\n+        }\n+        final var timestamp = Timestamp.from(instant);\n+        timestamp.setNanos(0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a11a415c0446162bd51a3cbf7f374bc18e369e0e"}, "originalPosition": 357}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4NjAwNw==", "bodyText": "Is that not what this is doing? Setting the nanoseconds to 0? Perhaps @bbpennel could help as I stole this from his code", "url": "https://github.com/fcrepo/fcrepo/pull/1788#discussion_r520886007", "createdAt": "2020-11-10T21:30:33Z", "author": {"login": "whikloj"}, "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "diffHunk": "@@ -591,4 +660,18 @@ public void setDataSource(final DataSource dataSource) {\n         this.dataSource = dataSource;\n     }\n \n+    /**\n+     * Format an instant to a timestamp without milliseconds, due to precision\n+     * issues with memento datetimes.\n+     * @param instant\n+     * @return the timestamp\n+     */\n+    private Timestamp formatInstant(final Instant instant) {\n+        if (instant == null) {\n+            return null;\n+        }\n+        final var timestamp = Timestamp.from(instant);\n+        timestamp.setNanos(0);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEzOTgxOQ=="}, "originalCommit": {"oid": "a11a415c0446162bd51a3cbf7f374bc18e369e0e"}, "originalPosition": 357}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU0MzA5NA==", "bodyText": "I see. It reads as if it's truncating to milliseconds, but I see now that it's just removing all fractions of a second.", "url": "https://github.com/fcrepo/fcrepo/pull/1788#discussion_r521543094", "createdAt": "2020-11-11T18:03:46Z", "author": {"login": "pwinckles"}, "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "diffHunk": "@@ -591,4 +660,18 @@ public void setDataSource(final DataSource dataSource) {\n         this.dataSource = dataSource;\n     }\n \n+    /**\n+     * Format an instant to a timestamp without milliseconds, due to precision\n+     * issues with memento datetimes.\n+     * @param instant\n+     * @return the timestamp\n+     */\n+    private Timestamp formatInstant(final Instant instant) {\n+        if (instant == null) {\n+            return null;\n+        }\n+        final var timestamp = Timestamp.from(instant);\n+        timestamp.setNanos(0);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEzOTgxOQ=="}, "originalCommit": {"oid": "a11a415c0446162bd51a3cbf7f374bc18e369e0e"}, "originalPosition": 357}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1702, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}