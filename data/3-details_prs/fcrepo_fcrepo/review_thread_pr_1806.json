{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyNjY2NDM2", "number": 1806, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxNToxMToyOVrOE6nOoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwMjoxMzoxNVrOE9CKww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5ODk1NTg0OnYy", "diffSide": "RIGHT", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DbFedoraToOcflObjectIndex.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxNToxMToyOVrOH1yd3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxNTozMzoxNFrOH1zi3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjE2MzQyMw==", "bodyText": "This logic is not specific enough. It's possible for the update call to fail for reason unrelated to the length of the id.", "url": "https://github.com/fcrepo/fcrepo/pull/1806#discussion_r526163423", "createdAt": "2020-11-18T15:11:29Z", "author": {"login": "pwinckles"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DbFedoraToOcflObjectIndex.java", "diffHunk": "@@ -265,7 +266,11 @@ private void upsert(final String transactionId, final FedoraId fedoraId, final S\n         parameterSource.addValue(\"ocflId\", ocflId);\n         parameterSource.addValue(\"transactionId\", transactionId);\n         parameterSource.addValue(\"operation\", operation);\n-        jdbcTemplate.update(UPSERT_MAPPING_TX_MAP.get(dbPlatform), parameterSource);\n+        try {\n+            jdbcTemplate.update(UPSERT_MAPPING_TX_MAP.get(dbPlatform), parameterSource);\n+        } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65bd290003cbdd49f0584049185e13ebff84b328"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjE3Mjk2Mg==", "bodyText": "so, should I check the length of the id, rather than just wrap it in an exception handler?", "url": "https://github.com/fcrepo/fcrepo/pull/1806#discussion_r526172962", "createdAt": "2020-11-18T15:23:18Z", "author": {"login": "robyj"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DbFedoraToOcflObjectIndex.java", "diffHunk": "@@ -265,7 +266,11 @@ private void upsert(final String transactionId, final FedoraId fedoraId, final S\n         parameterSource.addValue(\"ocflId\", ocflId);\n         parameterSource.addValue(\"transactionId\", transactionId);\n         parameterSource.addValue(\"operation\", operation);\n-        jdbcTemplate.update(UPSERT_MAPPING_TX_MAP.get(dbPlatform), parameterSource);\n+        try {\n+            jdbcTemplate.update(UPSERT_MAPPING_TX_MAP.get(dbPlatform), parameterSource);\n+        } catch (Exception e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjE2MzQyMw=="}, "originalCommit": {"oid": "65bd290003cbdd49f0584049185e13ebff84b328"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjE4MTA4NQ==", "bodyText": "Checking the length may be reasonable, though, if we go that route, I think it would make more sense if the id length enforcement happened up in the HTTP layer.\nCatching the exception here is not a problem. You just need to be more targeted about it. What is the type of exception that's thrown when the id is too long? What is the message of the exception? Are these consistent across database implementations? Using that information, you should be able to inspect the exception and only throw the id length exception when appropriate.", "url": "https://github.com/fcrepo/fcrepo/pull/1806#discussion_r526181085", "createdAt": "2020-11-18T15:33:14Z", "author": {"login": "pwinckles"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DbFedoraToOcflObjectIndex.java", "diffHunk": "@@ -265,7 +266,11 @@ private void upsert(final String transactionId, final FedoraId fedoraId, final S\n         parameterSource.addValue(\"ocflId\", ocflId);\n         parameterSource.addValue(\"transactionId\", transactionId);\n         parameterSource.addValue(\"operation\", operation);\n-        jdbcTemplate.update(UPSERT_MAPPING_TX_MAP.get(dbPlatform), parameterSource);\n+        try {\n+            jdbcTemplate.update(UPSERT_MAPPING_TX_MAP.get(dbPlatform), parameterSource);\n+        } catch (Exception e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjE2MzQyMw=="}, "originalCommit": {"oid": "65bd290003cbdd49f0584049185e13ebff84b328"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5ODk2MzM5OnYy", "diffSide": "RIGHT", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DbFedoraToOcflObjectIndex.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxNToxMjo1OFrOH1yidQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxNToyOToxM1rOH1zWPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjE2NDU5Nw==", "bodyText": "It is almost always a good idea to include the cause when throwing a new exception. You should do so here, unless there's a good reason not to.", "url": "https://github.com/fcrepo/fcrepo/pull/1806#discussion_r526164597", "createdAt": "2020-11-18T15:12:58Z", "author": {"login": "pwinckles"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DbFedoraToOcflObjectIndex.java", "diffHunk": "@@ -265,7 +266,11 @@ private void upsert(final String transactionId, final FedoraId fedoraId, final S\n         parameterSource.addValue(\"ocflId\", ocflId);\n         parameterSource.addValue(\"transactionId\", transactionId);\n         parameterSource.addValue(\"operation\", operation);\n-        jdbcTemplate.update(UPSERT_MAPPING_TX_MAP.get(dbPlatform), parameterSource);\n+        try {\n+            jdbcTemplate.update(UPSERT_MAPPING_TX_MAP.get(dbPlatform), parameterSource);\n+        } catch (Exception e) {\n+            throw new InvalidResourceIdentifierException(\"ID path too long\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65bd290003cbdd49f0584049185e13ebff84b328"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjE3MzM3Nw==", "bodyText": "you mean change the message to be more descriptive?", "url": "https://github.com/fcrepo/fcrepo/pull/1806#discussion_r526173377", "createdAt": "2020-11-18T15:23:43Z", "author": {"login": "robyj"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DbFedoraToOcflObjectIndex.java", "diffHunk": "@@ -265,7 +266,11 @@ private void upsert(final String transactionId, final FedoraId fedoraId, final S\n         parameterSource.addValue(\"ocflId\", ocflId);\n         parameterSource.addValue(\"transactionId\", transactionId);\n         parameterSource.addValue(\"operation\", operation);\n-        jdbcTemplate.update(UPSERT_MAPPING_TX_MAP.get(dbPlatform), parameterSource);\n+        try {\n+            jdbcTemplate.update(UPSERT_MAPPING_TX_MAP.get(dbPlatform), parameterSource);\n+        } catch (Exception e) {\n+            throw new InvalidResourceIdentifierException(\"ID path too long\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjE2NDU5Nw=="}, "originalCommit": {"oid": "65bd290003cbdd49f0584049185e13ebff84b328"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjE3Nzg1NA==", "bodyText": "I mean include the cause in the new exception like:\nthrow new InvalidResourceIdentifierException(\"message\", e);", "url": "https://github.com/fcrepo/fcrepo/pull/1806#discussion_r526177854", "createdAt": "2020-11-18T15:29:13Z", "author": {"login": "pwinckles"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DbFedoraToOcflObjectIndex.java", "diffHunk": "@@ -265,7 +266,11 @@ private void upsert(final String transactionId, final FedoraId fedoraId, final S\n         parameterSource.addValue(\"ocflId\", ocflId);\n         parameterSource.addValue(\"transactionId\", transactionId);\n         parameterSource.addValue(\"operation\", operation);\n-        jdbcTemplate.update(UPSERT_MAPPING_TX_MAP.get(dbPlatform), parameterSource);\n+        try {\n+            jdbcTemplate.update(UPSERT_MAPPING_TX_MAP.get(dbPlatform), parameterSource);\n+        } catch (Exception e) {\n+            throw new InvalidResourceIdentifierException(\"ID path too long\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjE2NDU5Nw=="}, "originalCommit": {"oid": "65bd290003cbdd49f0584049185e13ebff84b328"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwNjI1MDIxOnYy", "diffSide": "RIGHT", "path": "fcrepo-persistence-ocfl/src/test/java/org/fcrepo/persistence/ocfl/impl/DbFedoraToOcflObjectIndexTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwMDozNTo0NFrOH24T_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwMDozNTo0NFrOH24T_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMwNzc3Mg==", "bodyText": "This is a good test, and we should keep it. However, it only tests against H2:\n\n  \n    \n      fcrepo/fcrepo-persistence-ocfl/src/test/java/org/fcrepo/persistence/ocfl/impl/DbFedoraToOcflObjectIndexTest.java\n    \n    \n        Lines 53 to 54\n      in\n      30a5161\n    \n    \n    \n    \n\n        \n          \n           dataSource.setDriverClassName(\"org.h2.jdbcx.JdbcDataSource\"); \n        \n\n        \n          \n           dataSource.setUrl(\"jdbc:h2:mem:index;DB_CLOSE_DELAY=-1\"); \n        \n    \n  \n\n\nIf we add a similar integration test to FedoraLdpIT, the GitHub Actions builds will test it against all three supported databases. You should be able to add a test in here:\nhttps://github.com/fcrepo/fcrepo/blob/main/fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraLdpIT.java\n..and you will be good to go.\nSorry for the lack of specificity in my previous comment. The integration tests (those that end in **IT.java) run against a deployed Fedora application... and GitHub Actions are configured to run the tests three times.", "url": "https://github.com/fcrepo/fcrepo/pull/1806#discussion_r527307772", "createdAt": "2020-11-20T00:35:44Z", "author": {"login": "awoods"}, "path": "fcrepo-persistence-ocfl/src/test/java/org/fcrepo/persistence/ocfl/impl/DbFedoraToOcflObjectIndexTest.java", "diffHunk": "@@ -175,6 +176,23 @@ public void testRollback() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void identifierTooLong() throws InvalidResourceIdentifierException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30a516136e8b1009d9266ae795e17a581ba2fd0a"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyMzIzNDM3OnYy", "diffSide": "RIGHT", "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraLdpIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQyMToyNTowMVrOH5VxdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQyMToyNTowMVrOH5VxdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg4NzYwNA==", "bodyText": "Can be removed", "url": "https://github.com/fcrepo/fcrepo/pull/1806#discussion_r529887604", "createdAt": "2020-11-24T21:25:01Z", "author": {"login": "whikloj"}, "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraLdpIT.java", "diffHunk": "@@ -202,6 +203,8 @@\n import nu.validator.htmlparser.sax.HtmlParser;\n import nu.validator.saxtree.TreeBuilder;\n \n+//import org.fcrepo.kernel.api.exception.InvalidResourceIdentifierException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8548850a4ef66355c2dba8b8ee26e491311cfc6"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyMzIzNzg4OnYy", "diffSide": "RIGHT", "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraLdpIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQyMToyNTo1MlrOH5VzXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQyMToyNTo1MlrOH5VzXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg4ODA5Mw==", "bodyText": "Can be private static", "url": "https://github.com/fcrepo/fcrepo/pull/1806#discussion_r529888093", "createdAt": "2020-11-24T21:25:52Z", "author": {"login": "whikloj"}, "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraLdpIT.java", "diffHunk": "@@ -5011,4 +5014,38 @@ public void testRepositoryRootTypes() throws Exception {\n             assertTrue(graph.contains(ANY, rootNode, type.asNode(), BASIC_CONTAINER.asNode()));\n         }\n     }\n+\n+    public String genLongUrl(final String prefix, final int numChars) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8548850a4ef66355c2dba8b8ee26e491311cfc6"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyMzI1NjIyOnYy", "diffSide": "RIGHT", "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraLdpIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQyMTozMToyNlrOH5V-BQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNDowNzowOFrOH50-Vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg5MDgyMQ==", "bodyText": "Not sure I understand what lastret is doing, is this to actually return the next to last iteration of this loop? If the slashes are messing you up I think (but I could be wrong) that a single super long URI would also cause this error.\nie.\nfinal String superLongUri = \"someverrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr...\n\nyou get the picture.\nI don't think you need to have a / between each character is what I mean if that makes the loop cleaner to execute and removes the need of lastret to store the previous iteration.", "url": "https://github.com/fcrepo/fcrepo/pull/1806#discussion_r529890821", "createdAt": "2020-11-24T21:31:26Z", "author": {"login": "whikloj"}, "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraLdpIT.java", "diffHunk": "@@ -5011,4 +5014,38 @@ public void testRepositoryRootTypes() throws Exception {\n             assertTrue(graph.contains(ANY, rootNode, type.asNode(), BASIC_CONTAINER.asNode()));\n         }\n     }\n+\n+    public String genLongUrl(final String prefix, final int numChars) {\n+        String ret = prefix;\n+        String lastret = ret;\n+        final Random rand = new Random();\n+        int cnt = prefix.length();\n+\n+        while (cnt <= numChars) {\n+            lastret = ret;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8548850a4ef66355c2dba8b8ee26e491311cfc6"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM5ODgwNg==", "bodyText": "Hmmm, I am using lastret to store the last string before it goes over the length required, so when it completes, lastret would contain the string that is upto the length required. Of course, I see now that the \"<=\" probably would return a string that is almost always less than the required length.\nI used the / between the elements in the path as the original bug report script iterated a path until it was too big and the first version of the test did the same, a for loop iterated through the path. I wasn't sure if the problem was a length issue or a path \"deepness\" issue", "url": "https://github.com/fcrepo/fcrepo/pull/1806#discussion_r530398806", "createdAt": "2020-11-25T14:07:08Z", "author": {"login": "robyj"}, "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraLdpIT.java", "diffHunk": "@@ -5011,4 +5014,38 @@ public void testRepositoryRootTypes() throws Exception {\n             assertTrue(graph.contains(ANY, rootNode, type.asNode(), BASIC_CONTAINER.asNode()));\n         }\n     }\n+\n+    public String genLongUrl(final String prefix, final int numChars) {\n+        String ret = prefix;\n+        String lastret = ret;\n+        final Random rand = new Random();\n+        int cnt = prefix.length();\n+\n+        while (cnt <= numChars) {\n+            lastret = ret;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg5MDgyMQ=="}, "originalCommit": {"oid": "a8548850a4ef66355c2dba8b8ee26e491311cfc6"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNDM0MTE1OnYy", "diffSide": "RIGHT", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DbFedoraToOcflObjectIndex.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwMjoxMzoxNVrOH5geUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwMjoxMzoxNVrOH5geUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA2MjkyOA==", "bodyText": "MariaDB is dying because it is throwing a different Exception and so its not getting caught here.\norg.springframework.jdbc.BadSqlGrammarException: PreparedStatementCallback; bad SQL grammar [INSERT INTO ocfl_id_map_session_operations (fedora_id, fedora_root_id, ocfl_id, session_id, operation) VALUES (?, ?, ?, ?, ?) ON DUPLICATE KEY UPDATE fedora_root_id = VALUES(fedora_id), ocfl_id = VALUES(ocfl_id), operation = VALUES(operation)]; nested exception is java.sql.SQLSyntaxErrorException: (conn=33) Data too long for column 'fedora_id' at row 1\n\nSo you'll need to catch both Exceptions here, ala\n} catch (final DataIntegrityViolationException | BadSqlGrammarException e) {", "url": "https://github.com/fcrepo/fcrepo/pull/1806#discussion_r530062928", "createdAt": "2020-11-25T02:13:15Z", "author": {"login": "whikloj"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DbFedoraToOcflObjectIndex.java", "diffHunk": "@@ -265,7 +267,11 @@ private void upsert(final String transactionId, final FedoraId fedoraId, final S\n         parameterSource.addValue(\"ocflId\", ocflId);\n         parameterSource.addValue(\"transactionId\", transactionId);\n         parameterSource.addValue(\"operation\", operation);\n-        jdbcTemplate.update(UPSERT_MAPPING_TX_MAP.get(dbPlatform), parameterSource);\n+        try {\n+            jdbcTemplate.update(UPSERT_MAPPING_TX_MAP.get(dbPlatform), parameterSource);\n+        } catch (final DataIntegrityViolationException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8548850a4ef66355c2dba8b8ee26e491311cfc6"}, "originalPosition": 23}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1722, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}