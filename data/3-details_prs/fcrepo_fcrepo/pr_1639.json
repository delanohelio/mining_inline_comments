{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0NDk4NDIy", "number": 1639, "title": "Add integration test for repository rebuild functionality", "bodyText": "Resolves: https://jira.lyrasis.org/browse/FCREPO-3210\nWhat does this Pull Request do?\nThis pull-request adds one new integration test for verifying the repository rebuild functionality.\nIn adding this test, the OCFLConstants.java class was updated to allow for runtime update of the OCFL storage root, staging, and work directories.\nMost of the files in this pull-request are new test fixtures.\nHow should this be tested?\nThe application should work exactly as before (one-click, etc).\nA successful build is a successful test.\nInterested parties\nTag @pwinckles / @whikloj", "createdAt": "2020-03-05T21:01:22Z", "url": "https://github.com/fcrepo/fcrepo/pull/1639", "merged": true, "mergeCommit": {"oid": "34eef4097fd6a2d7a6ac6d42727040db212d848f"}, "closed": true, "closedAt": "2020-03-12T14:39:19Z", "author": {"login": "awoods"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKywSJgFqTM2OTkzNzA2Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcM8vWoAFqTM3MzYxNDk2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5OTM3MDY2", "url": "https://github.com/fcrepo/fcrepo/pull/1639#pullrequestreview-369937066", "createdAt": "2020-03-05T21:44:07Z", "commit": {"oid": "dcbe994e8f51eb0cd7abadce8a0b763f719a4283"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMTo0NDowN1rOFylQ9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMTo1MjoyN1rOFylh8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU4MzY3MA==", "bodyText": "Perhaps the original value should be captured and restored in an @AfterClass method to avoid impacting other tests.", "url": "https://github.com/fcrepo/fcrepo/pull/1639#discussion_r388583670", "createdAt": "2020-03-05T21:44:07Z", "author": {"login": "pwinckles"}, "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/RebuildIT.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Licensed to DuraSpace under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional information\n+ * regarding copyright ownership.\n+ *\n+ * DuraSpace licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except in\n+ * compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.fcrepo.integration.http.api;\n+\n+\n+import edu.wisc.library.ocfl.api.OcflRepository;\n+import org.fcrepo.kernel.impl.operations.RdfSourceOperationFactoryImpl;\n+import org.fcrepo.persistence.ocfl.RepositoryInitializer;\n+import org.fcrepo.persistence.ocfl.impl.DefaultOCFLObjectSessionFactory;\n+import org.fcrepo.persistence.ocfl.impl.FedoraToOCFLObjectIndexImpl;\n+import org.fcrepo.persistence.ocfl.impl.FedoraToOCFLObjectIndexUtilImpl;\n+import org.fcrepo.persistence.ocfl.impl.OCFLPersistenceConfig;\n+import org.fcrepo.persistence.ocfl.impl.OCFLPersistentSessionManager;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.context.annotation.AnnotationConfigApplicationContext;\n+\n+import static java.lang.System.setProperty;\n+import static org.fcrepo.persistence.ocfl.impl.OCFLConstants.OCFL_STORAGE_ROOT_DIR_KEY;\n+import static org.fcrepo.persistence.ocfl.impl.OCFLConstants.OCFL_WORK_DIR_KEY;\n+\n+/**\n+ * @author awooods\n+ * @since 2020-03-04\n+ */\n+public class RebuildIT {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(RebuildIT.class);\n+\n+    private OcflRepository ocflRepository;\n+\n+    private static AnnotationConfigApplicationContext ctx;\n+\n+    @BeforeClass\n+    public static void beforeClass() {\n+        setProperty(OCFL_STORAGE_ROOT_DIR_KEY, \"target/test-classes/test-rebuild-ocfl/ocfl-root\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dcbe994e8f51eb0cd7abadce8a0b763f719a4283"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU4NTI4OA==", "bodyText": "There is only one test currently, could there be more in the future? If so, is the context dirtied by the existing test and worthwhile recreating?", "url": "https://github.com/fcrepo/fcrepo/pull/1639#discussion_r388585288", "createdAt": "2020-03-05T21:47:39Z", "author": {"login": "pwinckles"}, "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/RebuildIT.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Licensed to DuraSpace under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional information\n+ * regarding copyright ownership.\n+ *\n+ * DuraSpace licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except in\n+ * compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.fcrepo.integration.http.api;\n+\n+\n+import edu.wisc.library.ocfl.api.OcflRepository;\n+import org.fcrepo.kernel.impl.operations.RdfSourceOperationFactoryImpl;\n+import org.fcrepo.persistence.ocfl.RepositoryInitializer;\n+import org.fcrepo.persistence.ocfl.impl.DefaultOCFLObjectSessionFactory;\n+import org.fcrepo.persistence.ocfl.impl.FedoraToOCFLObjectIndexImpl;\n+import org.fcrepo.persistence.ocfl.impl.FedoraToOCFLObjectIndexUtilImpl;\n+import org.fcrepo.persistence.ocfl.impl.OCFLPersistenceConfig;\n+import org.fcrepo.persistence.ocfl.impl.OCFLPersistentSessionManager;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.context.annotation.AnnotationConfigApplicationContext;\n+\n+import static java.lang.System.setProperty;\n+import static org.fcrepo.persistence.ocfl.impl.OCFLConstants.OCFL_STORAGE_ROOT_DIR_KEY;\n+import static org.fcrepo.persistence.ocfl.impl.OCFLConstants.OCFL_WORK_DIR_KEY;\n+\n+/**\n+ * @author awooods\n+ * @since 2020-03-04\n+ */\n+public class RebuildIT {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(RebuildIT.class);\n+\n+    private OcflRepository ocflRepository;\n+\n+    private static AnnotationConfigApplicationContext ctx;\n+\n+    @BeforeClass\n+    public static void beforeClass() {\n+        setProperty(OCFL_STORAGE_ROOT_DIR_KEY, \"target/test-classes/test-rebuild-ocfl/ocfl-root\");\n+        setProperty(OCFL_WORK_DIR_KEY, \"target/test-classes/test-rebuild-ocfl/ocfl-work\");\n+\n+        ctx = new AnnotationConfigApplicationContext(OCFLPersistenceConfig.class);\n+\n+        // RepositoryInitializer.initialize() happens as a part of the object's construction.\n+        ctx.register(RepositoryInitializer.class,\n+                OCFLPersistentSessionManager.class,\n+                RdfSourceOperationFactoryImpl.class,\n+                FedoraToOCFLObjectIndexUtilImpl.class,\n+                DefaultOCFLObjectSessionFactory.class,\n+                OCFLPersistenceConfig.class,\n+                FedoraToOCFLObjectIndexImpl.class);\n+\n+    }\n+\n+    @Before\n+    public void setUp() {\n+        ocflRepository = ctx.getBean(OcflRepository.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dcbe994e8f51eb0cd7abadce8a0b763f719a4283"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU4ODAxOA==", "bodyText": "It's a little funny to instantiate this class. Perhaps it can be injected?", "url": "https://github.com/fcrepo/fcrepo/pull/1639#discussion_r388588018", "createdAt": "2020-03-05T21:52:27Z", "author": {"login": "pwinckles"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/RepositoryInitializer.java", "diffHunk": "@@ -63,10 +65,12 @@ public void initialize() {\n         final PersistentStorageSession session = this.sessionManager.getSession(\"initializationSession\" +\n                                                                                  System.currentTimeMillis());\n \n-        if (!FEDORA_TO_OCFL_INDEX_FILE.exists()) {\n+        final File fedoraToOcflIndexFile = new OCFLConstants().getFedoraToOCFLIndexFile();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dcbe994e8f51eb0cd7abadce8a0b763f719a4283"}, "originalPosition": 25}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dcbe994e8f51eb0cd7abadce8a0b763f719a4283", "author": {"user": null}, "url": "https://github.com/fcrepo/fcrepo/commit/dcbe994e8f51eb0cd7abadce8a0b763f719a4283", "committedDate": "2020-03-05T20:51:50Z", "message": "Add integration test for repository rebuild functionality\n\nResolves: https://jira.lyrasis.org/browse/FCREPO-3210"}, "afterCommit": {"oid": "5b42b5b3db34bded9c031705f9fcca25cd317052", "author": {"user": null}, "url": "https://github.com/fcrepo/fcrepo/commit/5b42b5b3db34bded9c031705f9fcca25cd317052", "committedDate": "2020-03-06T03:26:17Z", "message": "code review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMzA3NjUw", "url": "https://github.com/fcrepo/fcrepo/pull/1639#pullrequestreview-370307650", "createdAt": "2020-03-06T13:08:19Z", "commit": {"oid": "5b42b5b3db34bded9c031705f9fcca25cd317052"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNjI1MjMy", "url": "https://github.com/fcrepo/fcrepo/pull/1639#pullrequestreview-370625232", "createdAt": "2020-03-06T21:04:13Z", "commit": {"oid": "5b42b5b3db34bded9c031705f9fcca25cd317052"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMTowNDoxNFrOFzHaGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMTowNDoxNFrOFzHaGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE0MzA2Ng==", "bodyText": "Oh I missed this in my PR, perhaps this was the problem. Checking", "url": "https://github.com/fcrepo/fcrepo/pull/1639#discussion_r389143066", "createdAt": "2020-03-06T21:04:14Z", "author": {"login": "whikloj"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DefaultOCFLObjectSessionFactory.java", "diffHunk": "@@ -54,7 +52,7 @@\n      * are not set, default directories will be created in java.io.tmpdir.\n      */\n     public DefaultOCFLObjectSessionFactory() {\n-        this(STAGING_DIR);\n+        this(new OCFLConstants().getStagingDir());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b42b5b3db34bded9c031705f9fcca25cd317052"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwODY2MDk3", "url": "https://github.com/fcrepo/fcrepo/pull/1639#pullrequestreview-370866097", "createdAt": "2020-03-08T23:15:49Z", "commit": {"oid": "5b42b5b3db34bded9c031705f9fcca25cd317052"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQyMzoxNTo0OVrOFzYGTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQyMzoxNTo0OVrOFzYGTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQxNjUyNw==", "bodyText": "I have given up on avoiding all these instantiations. There is no way to @Inject into this class in a test without changing from a Mockito runner to using a Spring test runner and giving @ContextConfiguration to define all the bits because this constructor needs the underlying class right as the class is created.", "url": "https://github.com/fcrepo/fcrepo/pull/1639#discussion_r389416527", "createdAt": "2020-03-08T23:15:49Z", "author": {"login": "whikloj"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImpl.java", "diffHunk": "@@ -57,8 +58,9 @@\n      * @throws IOException If we can't access the file.\n      */\n     public FedoraToOCFLObjectIndexImpl() throws IOException {\n-        if (FEDORA_TO_OCFL_INDEX_FILE.exists() && FEDORA_TO_OCFL_INDEX_FILE.canRead()) {\n-            try (var lines = Files.lines(FEDORA_TO_OCFL_INDEX_FILE.toPath())) {\n+        fedoraToOcflIndexFile = new OCFLConstants().getFedoraToOCFLIndexFile();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b42b5b3db34bded9c031705f9fcca25cd317052"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4a4c4b72edc56e9489f6fdae77414742ae6e06d", "author": {"user": null}, "url": "https://github.com/fcrepo/fcrepo/commit/c4a4c4b72edc56e9489f6fdae77414742ae6e06d", "committedDate": "2020-03-11T21:59:11Z", "message": "Add integration test for repository rebuild functionality\n\nResolves: https://jira.lyrasis.org/browse/FCREPO-3210"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ce5578c8459e5bf64f3e9832b32c858c53e2e0b", "author": {"user": null}, "url": "https://github.com/fcrepo/fcrepo/commit/0ce5578c8459e5bf64f3e9832b32c858c53e2e0b", "committedDate": "2020-03-11T21:59:11Z", "message": "code review"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5b42b5b3db34bded9c031705f9fcca25cd317052", "author": {"user": null}, "url": "https://github.com/fcrepo/fcrepo/commit/5b42b5b3db34bded9c031705f9fcca25cd317052", "committedDate": "2020-03-06T03:26:17Z", "message": "code review"}, "afterCommit": {"oid": "0ce5578c8459e5bf64f3e9832b32c858c53e2e0b", "author": {"user": null}, "url": "https://github.com/fcrepo/fcrepo/commit/0ce5578c8459e5bf64f3e9832b32c858c53e2e0b", "committedDate": "2020-03-11T21:59:11Z", "message": "code review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczNjE0OTY4", "url": "https://github.com/fcrepo/fcrepo/pull/1639#pullrequestreview-373614968", "createdAt": "2020-03-12T14:39:12Z", "commit": {"oid": "0ce5578c8459e5bf64f3e9832b32c858c53e2e0b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3237, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}