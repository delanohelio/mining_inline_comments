{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwMzI3NDI3", "number": 1801, "title": "Rebuild containment index to support deleted objects", "bodyText": "JIRA Ticket: https://jira.lyrasis.org/browse/FCREPO-3450\nWhat does this Pull Request do?\nAlters the ReindexService to add the start time to the containment index for all resources and add an end time for deleted resources.\nHow should this be tested?\nMake some resources in Fedora.\nDelete some of them.\nShut down Fedora\nBlow away the indexes.\nRestart Fedora\nCheck the containment index to see that the resources are all there and have a start time. Deleted resources also have an end time.\nInterested parties\nTag (@ mention) interested parties or, if unsure, @fcrepo/committers", "createdAt": "2020-11-13T04:31:45Z", "url": "https://github.com/fcrepo/fcrepo/pull/1801", "merged": true, "mergeCommit": {"oid": "0b27779fd5cad142fee8521dbd7253c6df7fe707"}, "closed": true, "closedAt": "2020-11-13T22:12:22Z", "author": {"login": "whikloj"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdb_cEUAH2gAyNTIwMzI3NDI3OjYxY2Y0NzMyZDlhZTMwZWMwYTA4ODI3ZGI4OGJkZmRiYWYwNmViZTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdcOSiZAFqTUzMDQzNTgxMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "61cf4732d9ae30ec0a08827db88bdfdbaf06ebe6", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/61cf4732d9ae30ec0a08827db88bdfdbaf06ebe6", "committedDate": "2020-11-13T04:27:52Z", "message": "Rebuild containment index to support deleted objects"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NzIyMDMw", "url": "https://github.com/fcrepo/fcrepo/pull/1801#pullrequestreview-529722030", "createdAt": "2020-11-13T04:33:46Z", "commit": {"oid": "61cf4732d9ae30ec0a08827db88bdfdbaf06ebe6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QwNDozMzo0NlrOHyaIkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QwNDozMzo0NlrOHyaIkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjYxOTAyNw==", "bodyText": "I had to switch this back as getResourceId only deals with things that have an actual file backing them.\nA get to a timemap returned both the mementos but also the containment from the Original Resource. So I switched back to this method", "url": "https://github.com/fcrepo/fcrepo/pull/1801#discussion_r522619027", "createdAt": "2020-11-13T04:33:46Z", "author": {"login": "whikloj"}, "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "diffHunk": "@@ -395,7 +395,7 @@ private NamedParameterJdbcTemplate getNamedParameterJdbcTemplate() {\n \n     @Override\n     public Stream<String> getContains(final String txId, final FedoraId fedoraId) {\n-        final String resourceId = fedoraId.getResourceId();\n+        final String resourceId = fedoraId.isMemento() ? fedoraId.getBaseId() : fedoraId.getFullId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61cf4732d9ae30ec0a08827db88bdfdbaf06ebe6"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMDc1Njkz", "url": "https://github.com/fcrepo/fcrepo/pull/1801#pullrequestreview-530075693", "createdAt": "2020-11-13T13:50:16Z", "commit": {"oid": "61cf4732d9ae30ec0a08827db88bdfdbaf06ebe6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxMzo1MDoxNlrOHyvBsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxMzo1MDoxNlrOHyvBsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk2MTMyOA==", "bodyText": "Recognizing that this is not new code, I believe this input stream is not being closed.", "url": "https://github.com/fcrepo/fcrepo/pull/1801#discussion_r522961328", "createdAt": "2020-11-13T13:50:16Z", "author": {"login": "pwinckles"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/ReindexService.java", "diffHunk": "@@ -118,17 +118,23 @@ public void indexOcflObject(final String txId, final String ocflId) {\n                                     String.format(\"Resource %s must have a parent defined\", fedoraId.getFullId()));\n                         }\n                     }\n-                    if (!headers.getInteractionModel().equals(NON_RDF_SOURCE.toString())) {\n-                        final Optional<InputStream> content = session.readContent(fedoraId.getFullId())\n-                                .getContentStream();\n-                        if (content.isPresent()) {\n-                            final RdfStream rdf = parseRdf(fedoraId, content.get());\n-                            this.referenceService.updateReferences(txId, fedoraId, null, rdf);\n+                    final var created = headers.getCreatedDate();\n+                    if (!headers.isDeleted()) {\n+                        if (!headers.getInteractionModel().equals(NON_RDF_SOURCE.toString())) {\n+                            final Optional<InputStream> content = session.readContent(fedoraId.getFullId())\n+                                    .getContentStream();\n+                            if (content.isPresent()) {\n+                                final RdfStream rdf = parseRdf(fedoraId, content.get());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61cf4732d9ae30ec0a08827db88bdfdbaf06ebe6"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0692fb8a4169e57f291a854a2c532bdeae20c795", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/0692fb8a4169e57f291a854a2c532bdeae20c795", "committedDate": "2020-11-13T14:55:41Z", "message": "Close stream"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMTM3ODM1", "url": "https://github.com/fcrepo/fcrepo/pull/1801#pullrequestreview-530137835", "createdAt": "2020-11-13T15:05:36Z", "commit": {"oid": "0692fb8a4169e57f291a854a2c532bdeae20c795"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNTowNTozNlrOHyx5cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNTowNTozNlrOHyx5cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzAwODM3MA==", "bodyText": "This will work, but it's slightly unexpected behavior. Generally speaking, streams are closed on the same level that they're opened on. For example,\ntry (final var stream = content.get()) {\n    final RdfStream rdf = parseRdf(fedoraId, stream);\n    this.referenceService.updateReferences(txId, fedoraId, null, rdf);\n}\nThere are a variety of advantages to this approach, not the least of which is that it's clear when a stream is closed and you don't need to inspect every method that the stream is passed to to see if it closes it.", "url": "https://github.com/fcrepo/fcrepo/pull/1801#discussion_r523008370", "createdAt": "2020-11-13T15:05:36Z", "author": {"login": "pwinckles"}, "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/services/ReferenceServiceImpl.java", "diffHunk": "@@ -302,6 +302,8 @@ public void updateReferences(@Nonnull final String txId, final FedoraId resource\n             LOGGER.warn(\"Unable to update reference index for resource {} in transaction {}: {}\",\n                     resourceId.getFullId(), txId, e.getMessage());\n             throw new RepositoryRuntimeException(\"Unable to update reference index\", e);\n+        } finally {\n+            rdfStream.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0692fb8a4169e57f291a854a2c532bdeae20c795"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f408ef81561c6da04ab40768ff1be2f65b4124a0", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/f408ef81561c6da04ab40768ff1be2f65b4124a0", "committedDate": "2020-11-13T20:19:37Z", "message": "Close where it opened"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNDM1ODEw", "url": "https://github.com/fcrepo/fcrepo/pull/1801#pullrequestreview-530435810", "createdAt": "2020-11-13T21:46:02Z", "commit": {"oid": "f408ef81561c6da04ab40768ff1be2f65b4124a0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3010, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}