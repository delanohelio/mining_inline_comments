{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2ODUxNDE2", "number": 1704, "title": "Don't fail with stacktrace on empty path segment in WebAC Filter", "bodyText": "JIRA Ticket: https://jira.lyrasis.org/browse/FCREPO-3339\nWhat does this Pull Request do?\nWhen passing a URI with an empty path segment into the WebAC Filter it ends up without roles, but we don't account for that so it does a stacktrace.\nThis now checks that it isn't null before proceeding, resulting in a 403 for the path with empty path segments.\nHow should this be tested?\nBefore this PR\n\nStart a Fedora 5\nExecute curl -utestuser:testpass http://localhost:8080/rest/bob//bob\nSee stacktrace.\n\nInterested parties\n@fcrepo4/committers", "createdAt": "2020-06-19T02:23:55Z", "url": "https://github.com/fcrepo/fcrepo/pull/1704", "merged": true, "mergeCommit": {"oid": "3a5a6e6ffdfa16a3c4605cfdb0be8d4e281c6063"}, "closed": true, "closedAt": "2020-06-24T15:22:11Z", "author": {"login": "whikloj"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcspgS8AH2gAyNDM2ODUxNDE2OjhjYjY4NDg1NDllZjNiMDE5ZDMwNDdhZjE4MmYyZGQ3YWRhMjRjNTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABctyPLDAH2gAyNDM2ODUxNDE2OjJjZjdhMDYyNDNiMzVlYWZmYmIzZTA5ZTc1MDNiNDA0MzkxZjI4YTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8cb6848549ef3b019d3047af182f2dd7ada24c54", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/8cb6848549ef3b019d3047af182f2dd7ada24c54", "committedDate": "2020-06-19T02:20:08Z", "message": "Don't fail with stacktrace on empty path segment in WebAC Filter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0NDM0Mjk5", "url": "https://github.com/fcrepo/fcrepo/pull/1704#pullrequestreview-434434299", "createdAt": "2020-06-20T15:06:50Z", "commit": {"oid": "8cb6848549ef3b019d3047af182f2dd7ada24c54"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMFQxNTowNjo1MVrOGmm-mA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMFQxNTowNjo1MVrOGmm-mA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzNzY4OA==", "bodyText": "This is better than a stacktrace... I am fine with 403 for the 5.1.1 patch release.", "url": "https://github.com/fcrepo/fcrepo/pull/1704#discussion_r443137688", "createdAt": "2020-06-20T15:06:51Z", "author": {"login": "awoods"}, "path": "fcrepo-auth-webac/src/test/java/org/fcrepo/integration/auth/webac/WebACRecipesIT.java", "diffHunk": "@@ -1888,6 +1893,70 @@ public void testDirectRelationshipsOk() throws IOException {\n         testCanWrite(writeableResource, username);\n     }\n \n+    @Test\n+    public void testRequestWithEmptyPath() throws Exception {\n+        final String username = \"testUser92\";\n+        final String parent = getRandomUniqueId();\n+        final HttpPost postParent = postObjMethod();\n+        postParent.setHeader(\"Slug\", parent);\n+        setAuth(postParent, \"fedoraAdmin\");\n+        final String parentUri;\n+        try (final CloseableHttpResponse response = execute(postParent)) {\n+            assertEquals(CREATED.getStatusCode(), getStatus(response));\n+            parentUri = getLocation(response);\n+        }\n+        // Make parent only accessible to fedoraAdmin\n+        final String parentAcl = \"@prefix acl: <http://www.w3.org/ns/auth/acl#> .\\n\" +\n+                \"<#readauthz> a acl:Authorization ;\\n\" +\n+                \"   acl:agent \\\"fedoraAdmin\\\" ;\\n\" +\n+                \"   acl:mode acl:Read, acl:Write ;\\n\" +\n+                \"   acl:accessTo <\" + parentUri + \"> .\";\n+        ingestAclString(parentUri, parentAcl, \"fedoraAdmin\");\n+        // Admin can see parent\n+        final HttpGet getAdminParent = getObjMethod(parent);\n+        setAuth(getAdminParent, \"fedoraAdmin\");\n+        assertEquals(OK.getStatusCode(), getStatus(getAdminParent));\n+        final HttpGet getParent = getObjMethod(parent);\n+        setAuth(getParent, username);\n+        // testUser92 cannot see parent.\n+        assertEquals(FORBIDDEN.getStatusCode(), getStatus(getParent));\n+\n+        final String child = getRandomUniqueId();\n+        final HttpPost postChild = postObjMethod(parent);\n+        postChild.setHeader(\"Slug\", child);\n+        setAuth(postChild, \"fedoraAdmin\");\n+        final String childUri;\n+        try (final CloseableHttpResponse response = execute(postChild)) {\n+            assertEquals(CREATED.getStatusCode(), getStatus(response));\n+            childUri = getLocation(response);\n+        }\n+        // Make child accessible to testUser92\n+        final String childAcl = \"@prefix acl: <http://www.w3.org/ns/auth/acl#> .\\n\" +\n+                \"<#readauthz> a acl:Authorization ;\\n\" +\n+                \"   acl:agent \\\"\" + username + \"\\\" ;\\n\" +\n+                \"   acl:mode acl:Read, acl:Write ;\\n\" +\n+                \"   acl:accessTo <\" + childUri + \"> .\";\n+        ingestAclString(childUri, childAcl, \"fedoraAdmin\");\n+        // Admin can see child.\n+        final HttpGet getAdminChild = getObjMethod(parent + \"/\" + child);\n+        setAuth(getAdminChild, \"fedoraAdmin\");\n+        assertEquals(OK.getStatusCode(), getStatus(getAdminChild));\n+\n+        // testUser92 can see child.\n+        final HttpGet getChild = getObjMethod(parent + \"/\" + child);\n+        setAuth(getChild, username);\n+        assertEquals(OK.getStatusCode(), getStatus(getChild));\n+\n+        // Admin bypasses ACL resolution gets 409.\n+        final HttpGet getAdminRequest = getObjMethod(parent + \"//\" + child);\n+        setAuth(getAdminRequest, \"fedoraAdmin\");\n+        assertEquals(BAD_REQUEST.getStatusCode(), getStatus(getAdminRequest));\n+        // User can't access the URL (because the path is not correct).\n+        final HttpGet getUserRequest = getObjMethod(parent + \"//\" + child);\n+        setAuth(getUserRequest, username);\n+        assertEquals(FORBIDDEN.getStatusCode(), getStatus(getUserRequest));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8cb6848549ef3b019d3047af182f2dd7ada24c54"}, "originalPosition": 78}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0NDM0MzEx", "url": "https://github.com/fcrepo/fcrepo/pull/1704#pullrequestreview-434434311", "createdAt": "2020-06-20T15:06:57Z", "commit": {"oid": "8cb6848549ef3b019d3047af182f2dd7ada24c54"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cf7a06243b35eaffbb3e09e7503b404391f28a0", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/2cf7a06243b35eaffbb3e09e7503b404391f28a0", "committedDate": "2020-06-22T15:04:30Z", "message": "Check for empty paths"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3147, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}