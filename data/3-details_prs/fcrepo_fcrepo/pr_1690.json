{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4NDM4NTQ5", "number": 1690, "title": "FCREPO-3201 - Transmission fixity when staging to OCFL object", "bodyText": "https://jira.lyrasis.org/browse/FCREPO-3201\nWhat does this Pull Request do?\n\nDuring a commit, a digest is read from the header file for binaries and provided to the OCFL client for transmission fixity purposes, if there is an appropriate digest available\n\nperformed by first staging content files before sidecar files, so that the sidecar files are still addressable\n\n\nAll fedora generated objects have first real commit at v2, due to no longer using putObject to create new objects.\n\nHow should this be tested?\nThings should appear to function as before. There is an integration test that attempts to simulate this situation by changing a staged file after it would have passed fcrepo transmission fixity checking, but this still isn't exactly like the real world case.\nNotes\nIt is very unlikely for transmission fixity failures to occur at this stage since we are using MOVE operations to stage files to OCFL, so no byte copying occurs. So it is somewhat questionable how useful this PR. It would still have some effect in the case of the fcrepo staging and ocfl storage locations being on different logical volumes. So it wouldn't hurt my feelings if we don't ultimately want to do this change.\nRegarding reading digests from header files, it'd probably be possible to build a cache of digests at write time and use that instead of reading at commit time. I was a bit worried about the memory cost in a long running transaction, but it could be explored if this approach is undesirable.", "createdAt": "2020-06-05T13:07:28Z", "url": "https://github.com/fcrepo/fcrepo/pull/1690", "merged": true, "mergeCommit": {"oid": "e59076f987775600add4a63348571095673ce4df"}, "closed": true, "closedAt": "2020-06-09T13:43:36Z", "author": {"login": "bbpennel"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoSL4HgH2gAyNDI4NDM4NTQ5OmUxNzM1ODJkOGYyY2ZjZmFmMWQ3Y2M2NmRhZjc4YjdjMWU3ODBiNjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpXIToAH2gAyNDI4NDM4NTQ5OmFjYWM4MWU0ODJkMzhiMDg0ZTExODQyZDQ0NTVhNWVlYzE5MDg0ODY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e173582d8f2cfcfaf1d7cc66daf78b7c1e780b65", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/fcrepo/fcrepo/commit/e173582d8f2cfcfaf1d7cc66daf78b7c1e780b65", "committedDate": "2020-06-05T12:54:19Z", "message": "During a commit, a digest is read from the header file for binaries and provided to the OCFL client for transmission fixity purposes, if there is an appropriate digest available"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MzkwNjcz", "url": "https://github.com/fcrepo/fcrepo/pull/1690#pullrequestreview-425390673", "createdAt": "2020-06-05T15:13:48Z", "commit": {"oid": "e173582d8f2cfcfaf1d7cc66daf78b7c1e780b65"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fac107a55f3664f510065295b8cf932db9a74036", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/fcrepo/fcrepo/commit/fac107a55f3664f510065295b8cf932db9a74036", "committedDate": "2020-06-05T17:27:07Z", "message": "Use updateObject to create new objects when versioning enabled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53ff5125f1f6e32cfcffb5ca3beb83389e3d8800", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/fcrepo/fcrepo/commit/53ff5125f1f6e32cfcffb5ca3beb83389e3d8800", "committedDate": "2020-06-05T17:57:55Z", "message": "Register digests for files modified in a session after write, use those for transmission fixity instead of retrieving from sidecar files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "604328fa45e26d1c478547f9f0bcdf4d232656c8", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/fcrepo/fcrepo/commit/604328fa45e26d1c478547f9f0bcdf4d232656c8", "committedDate": "2020-06-05T19:16:03Z", "message": "Normalize separators in subpaths during registration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NzQ0NTEz", "url": "https://github.com/fcrepo/fcrepo/pull/1690#pullrequestreview-425744513", "createdAt": "2020-06-06T14:34:59Z", "commit": {"oid": "604328fa45e26d1c478547f9f0bcdf4d232656c8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQxNDozNDo1OVrOGgEBdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQxNDozNDo1OVrOGgEBdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MzUyNQ==", "bodyText": "I believe this can remain private.", "url": "https://github.com/fcrepo/fcrepo/pull/1690#discussion_r436273525", "createdAt": "2020-06-06T14:34:59Z", "author": {"login": "awoods"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/OCFLPersistentStorageUtils.java", "diffHunk": "@@ -81,7 +82,7 @@ private OCFLPersistentStorageUtils() {\n      * The directory within an OCFL Object's content directory that contains\n      * information managed by Fedora.\n      */\n-    private static final String INTERNAL_FEDORA_DIRECTORY = \".fcrepo\";\n+    public static final String INTERNAL_FEDORA_DIRECTORY = \".fcrepo\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "604328fa45e26d1c478547f9f0bcdf4d232656c8"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5764c998a29ef13f82b051180b4c3ae6b4b79613", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/fcrepo/fcrepo/commit/5764c998a29ef13f82b051180b4c3ae6b4b79613", "committedDate": "2020-06-06T16:18:09Z", "message": "Switch back to private"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NzU4ODcw", "url": "https://github.com/fcrepo/fcrepo/pull/1690#pullrequestreview-425758870", "createdAt": "2020-06-06T18:17:55Z", "commit": {"oid": "5764c998a29ef13f82b051180b4c3ae6b4b79613"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MjE5NDM4", "url": "https://github.com/fcrepo/fcrepo/pull/1690#pullrequestreview-426219438", "createdAt": "2020-06-08T13:12:55Z", "commit": {"oid": "5764c998a29ef13f82b051180b4c3ae6b4b79613"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMzoxMjo1NVrOGgdPAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMzoyMDoxN1rOGgdpsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY4NjU5Mg==", "bodyText": "No need to change, but this can now be constructed using List.of().", "url": "https://github.com/fcrepo/fcrepo/pull/1690#discussion_r436686592", "createdAt": "2020-06-08T13:12:55Z", "author": {"login": "pwinckles"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/AbstractNonRdfSourcePersister.java", "diffHunk": "@@ -88,12 +88,13 @@ protected void persistNonRDFSource(final ResourceOperation operation,\n         if (forExternalBinary(nonRdfSourceOperation)) {\n             outcome = null;\n         } else {\n+            final var transmissionDigestAlg = objectSession.getObjectDigestAlgorithm();\n             final var providedDigests = nonRdfSourceOperation.getContentDigests();\n             // Wrap binary stream in digest computing wrapper, requesting\n             final var multiDigestWrapper = new MultiDigestInputStreamWrapper(\n                     nonRdfSourceOperation.getContentStream(),\n                     providedDigests,\n-                    Arrays.asList(objectSession.getObjectDigestAlgorithm()));\n+                    Arrays.asList(transmissionDigestAlg));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5764c998a29ef13f82b051180b4c3ae6b4b79613"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY5MzQyNw==", "bodyText": "I don't think you need to walk the staged files, unless you want to. You should just be able to add the entire staging directory, and then iterate over your map of digests, calling addFileFixity for each.", "url": "https://github.com/fcrepo/fcrepo/pull/1690#discussion_r436693427", "createdAt": "2020-06-08T13:20:17Z", "author": {"login": "pwinckles"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DefaultOCFLObjectSession.java", "diffHunk": "@@ -449,6 +457,53 @@ private String commitUpdates(final CommitOption commitOption) {\n         }\n     }\n \n+    private Consumer<OcflObjectUpdater> constructCommitUpdater(final boolean updatingObject) {\n+        final DIGEST_ALGORITHM fcrepoDigestAlg = getObjectDigestAlgorithm();\n+        final DigestAlgorithm ocflDigestAlg = translateFedoraDigestToOcfl(fcrepoDigestAlg);\n+        final OcflOption[] ocflOptions;\n+        if (updatingObject) {\n+            ocflOptions = new OcflOption[] { MOVE_SOURCE, OVERWRITE };\n+        } else {\n+            ocflOptions = new OcflOption[] { MOVE_SOURCE };\n+        }\n+\n+\n+        return updater -> {\n+            if (updatingObject) {\n+                deletePaths.forEach(updater::removeFile);\n+            }\n+            if (isStagingEmpty()) {\n+                return;\n+            }\n+\n+            try {\n+                Files.walk(stagingPath)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5764c998a29ef13f82b051180b4c3ae6b4b79613"}, "originalPosition": 143}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e13c49a9cccec2e4da42ba38ebf015271e846a59", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/fcrepo/fcrepo/commit/e13c49a9cccec2e4da42ba38ebf015271e846a59", "committedDate": "2020-06-08T16:46:47Z", "message": "Refactor adding of files during commit to add the staging path directly and then register digests from map"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NDI4NTc1", "url": "https://github.com/fcrepo/fcrepo/pull/1690#pullrequestreview-426428575", "createdAt": "2020-06-08T16:50:47Z", "commit": {"oid": "e13c49a9cccec2e4da42ba38ebf015271e846a59"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8aac9a9757e4850834572b15eeb09b89afc74e8b", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/fcrepo/fcrepo/commit/8aac9a9757e4850834572b15eeb09b89afc74e8b", "committedDate": "2020-06-08T19:30:26Z", "message": "Merge branch 'master' into fcrepo-3201-ocfl-transmission"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "acac81e482d38b084e11842d4455a5eec1908486", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/fcrepo/fcrepo/commit/acac81e482d38b084e11842d4455a5eec1908486", "committedDate": "2020-06-08T21:13:52Z", "message": "Encode subpath when registering digests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3132, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}