{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyNjY2NDM2", "number": 1806, "title": "Added exception handling for identifier line that is too long, plus c\u2026", "bodyText": "\u2026ustom message\nResolves https://jira.lyrasis.org/browse/FCREPO-3374\nThe title of this pull-request should be a brief description of what the pull-request fixes/improves/changes. Ideally 50 characters or less.\n\nJIRA Ticket: (link)\n\nOther Relevant Links (Mailing list discussion, related pull requests, etc.)\n\nWhat does this Pull Request do?\nA brief description of what the intended result of the PR will be and/or what problem it solves.\nHow should this be tested?\nA description of what steps someone could take to:\n\nReproduce the problem you are fixing (if applicable)\nTest that the Pull Request does what is intended.\nPlease be as detailed as possible.\nGood testing instructions help get your PR completed faster.\n\nInterested parties\nTag (@ mention) interested parties or, if unsure, @fcrepo/committers", "createdAt": "2020-11-17T19:50:26Z", "url": "https://github.com/fcrepo/fcrepo/pull/1806", "merged": true, "mergeCommit": {"oid": "6ab7c3f18d560b22df2a2bf43d38b188c6c54dcf"}, "closed": true, "closedAt": "2020-11-27T15:18:15Z", "author": {"login": "robyj"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdde28KAH2gAyNTIyNjY2NDM2OjFhODRiZjlhNGNmNDA5MzhhMzc0NjJmYzZhZWY2OGUyNGNkMWI4ZTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgpIVCgFqTU0MDA1MDg2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1a84bf9a4cf40938a37462fc6aef68e24cd1b8e7", "author": {"user": {"login": "robyj", "name": "Jon Roby"}}, "url": "https://github.com/fcrepo/fcrepo/commit/1a84bf9a4cf40938a37462fc6aef68e24cd1b8e7", "committedDate": "2020-11-17T19:38:12Z", "message": "Added exception handling for identifier line that is too long, plus custom message\n\nResolves https://jira.lyrasis.org/browse/FCREPO-3374"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65bd290003cbdd49f0584049185e13ebff84b328", "author": {"user": {"login": "robyj", "name": "Jon Roby"}}, "url": "https://github.com/fcrepo/fcrepo/commit/65bd290003cbdd49f0584049185e13ebff84b328", "committedDate": "2020-11-17T21:15:02Z", "message": "removed some commented out lines of code plus an import that wasn't used\n\nresolves https://jira.lyrasis.org/browse/FCREPO-3374"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzNTQ1MDcy", "url": "https://github.com/fcrepo/fcrepo/pull/1806#pullrequestreview-533545072", "createdAt": "2020-11-18T15:11:29Z", "commit": {"oid": "65bd290003cbdd49f0584049185e13ebff84b328"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxNToxMToyOVrOH1yd3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxNToxMjo1OFrOH1yidQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjE2MzQyMw==", "bodyText": "This logic is not specific enough. It's possible for the update call to fail for reason unrelated to the length of the id.", "url": "https://github.com/fcrepo/fcrepo/pull/1806#discussion_r526163423", "createdAt": "2020-11-18T15:11:29Z", "author": {"login": "pwinckles"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DbFedoraToOcflObjectIndex.java", "diffHunk": "@@ -265,7 +266,11 @@ private void upsert(final String transactionId, final FedoraId fedoraId, final S\n         parameterSource.addValue(\"ocflId\", ocflId);\n         parameterSource.addValue(\"transactionId\", transactionId);\n         parameterSource.addValue(\"operation\", operation);\n-        jdbcTemplate.update(UPSERT_MAPPING_TX_MAP.get(dbPlatform), parameterSource);\n+        try {\n+            jdbcTemplate.update(UPSERT_MAPPING_TX_MAP.get(dbPlatform), parameterSource);\n+        } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65bd290003cbdd49f0584049185e13ebff84b328"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjE2NDU5Nw==", "bodyText": "It is almost always a good idea to include the cause when throwing a new exception. You should do so here, unless there's a good reason not to.", "url": "https://github.com/fcrepo/fcrepo/pull/1806#discussion_r526164597", "createdAt": "2020-11-18T15:12:58Z", "author": {"login": "pwinckles"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DbFedoraToOcflObjectIndex.java", "diffHunk": "@@ -265,7 +266,11 @@ private void upsert(final String transactionId, final FedoraId fedoraId, final S\n         parameterSource.addValue(\"ocflId\", ocflId);\n         parameterSource.addValue(\"transactionId\", transactionId);\n         parameterSource.addValue(\"operation\", operation);\n-        jdbcTemplate.update(UPSERT_MAPPING_TX_MAP.get(dbPlatform), parameterSource);\n+        try {\n+            jdbcTemplate.update(UPSERT_MAPPING_TX_MAP.get(dbPlatform), parameterSource);\n+        } catch (Exception e) {\n+            throw new InvalidResourceIdentifierException(\"ID path too long\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65bd290003cbdd49f0584049185e13ebff84b328"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae907df3a6790dafeb71fd245380e19f65e30685", "author": {"user": {"login": "robyj", "name": "Jon Roby"}}, "url": "https://github.com/fcrepo/fcrepo/commit/ae907df3a6790dafeb71fd245380e19f65e30685", "committedDate": "2020-11-19T18:18:51Z", "message": "- modified error message\n- made the exception catch more specific to the exception type\n- added a string/exception parameter to the InvalidResourceIdentifierException\n  so the root cause exception can be used if needed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0NzMzMDY0", "url": "https://github.com/fcrepo/fcrepo/pull/1806#pullrequestreview-534733064", "createdAt": "2020-11-19T18:28:11Z", "commit": {"oid": "ae907df3a6790dafeb71fd245380e19f65e30685"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30a516136e8b1009d9266ae795e17a581ba2fd0a", "author": {"user": {"login": "robyj", "name": "Jon Roby"}}, "url": "https://github.com/fcrepo/fcrepo/commit/30a516136e8b1009d9266ae795e17a581ba2fd0a", "committedDate": "2020-11-19T22:47:08Z", "message": "added test to create and map fedora item with a very long path. The generation is the same as\nthe exmaple code in the ticket. tested several times to make sure it triggers."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0OTg5NzQx", "url": "https://github.com/fcrepo/fcrepo/pull/1806#pullrequestreview-534989741", "createdAt": "2020-11-20T00:35:44Z", "commit": {"oid": "30a516136e8b1009d9266ae795e17a581ba2fd0a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwMDozNTo0NFrOH24T_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwMDozNTo0NFrOH24T_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMwNzc3Mg==", "bodyText": "This is a good test, and we should keep it. However, it only tests against H2:\n\n  \n    \n      fcrepo/fcrepo-persistence-ocfl/src/test/java/org/fcrepo/persistence/ocfl/impl/DbFedoraToOcflObjectIndexTest.java\n    \n    \n        Lines 53 to 54\n      in\n      30a5161\n    \n    \n    \n    \n\n        \n          \n           dataSource.setDriverClassName(\"org.h2.jdbcx.JdbcDataSource\"); \n        \n\n        \n          \n           dataSource.setUrl(\"jdbc:h2:mem:index;DB_CLOSE_DELAY=-1\"); \n        \n    \n  \n\n\nIf we add a similar integration test to FedoraLdpIT, the GitHub Actions builds will test it against all three supported databases. You should be able to add a test in here:\nhttps://github.com/fcrepo/fcrepo/blob/main/fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraLdpIT.java\n..and you will be good to go.\nSorry for the lack of specificity in my previous comment. The integration tests (those that end in **IT.java) run against a deployed Fedora application... and GitHub Actions are configured to run the tests three times.", "url": "https://github.com/fcrepo/fcrepo/pull/1806#discussion_r527307772", "createdAt": "2020-11-20T00:35:44Z", "author": {"login": "awoods"}, "path": "fcrepo-persistence-ocfl/src/test/java/org/fcrepo/persistence/ocfl/impl/DbFedoraToOcflObjectIndexTest.java", "diffHunk": "@@ -175,6 +176,23 @@ public void testRollback() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void identifierTooLong() throws InvalidResourceIdentifierException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30a516136e8b1009d9266ae795e17a581ba2fd0a"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a318c0b03ad81ead885416c3a9d17a8490814146", "author": {"user": {"login": "robyj", "name": "Jon Roby"}}, "url": "https://github.com/fcrepo/fcrepo/commit/a318c0b03ad81ead885416c3a9d17a8490814146", "committedDate": "2020-11-24T15:57:42Z", "message": "added integration test for database id path exception that should work for\nall database types"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8548850a4ef66355c2dba8b8ee26e491311cfc6", "author": {"user": {"login": "robyj", "name": "Jon Roby"}}, "url": "https://github.com/fcrepo/fcrepo/commit/a8548850a4ef66355c2dba8b8ee26e491311cfc6", "committedDate": "2020-11-24T20:15:56Z", "message": "On the advice of @whikloj, I've changed the test into two tests, to show the boundary of where the character\nlimit lies (479 charcters)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3OTU0NjM4", "url": "https://github.com/fcrepo/fcrepo/pull/1806#pullrequestreview-537954638", "createdAt": "2020-11-24T21:25:01Z", "commit": {"oid": "a8548850a4ef66355c2dba8b8ee26e491311cfc6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQyMToyNTowMVrOH5VxdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwMjoxMzoxNVrOH5geUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg4NzYwNA==", "bodyText": "Can be removed", "url": "https://github.com/fcrepo/fcrepo/pull/1806#discussion_r529887604", "createdAt": "2020-11-24T21:25:01Z", "author": {"login": "whikloj"}, "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraLdpIT.java", "diffHunk": "@@ -202,6 +203,8 @@\n import nu.validator.htmlparser.sax.HtmlParser;\n import nu.validator.saxtree.TreeBuilder;\n \n+//import org.fcrepo.kernel.api.exception.InvalidResourceIdentifierException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8548850a4ef66355c2dba8b8ee26e491311cfc6"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg4ODA5Mw==", "bodyText": "Can be private static", "url": "https://github.com/fcrepo/fcrepo/pull/1806#discussion_r529888093", "createdAt": "2020-11-24T21:25:52Z", "author": {"login": "whikloj"}, "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraLdpIT.java", "diffHunk": "@@ -5011,4 +5014,38 @@ public void testRepositoryRootTypes() throws Exception {\n             assertTrue(graph.contains(ANY, rootNode, type.asNode(), BASIC_CONTAINER.asNode()));\n         }\n     }\n+\n+    public String genLongUrl(final String prefix, final int numChars) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8548850a4ef66355c2dba8b8ee26e491311cfc6"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg5MDgyMQ==", "bodyText": "Not sure I understand what lastret is doing, is this to actually return the next to last iteration of this loop? If the slashes are messing you up I think (but I could be wrong) that a single super long URI would also cause this error.\nie.\nfinal String superLongUri = \"someverrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr...\n\nyou get the picture.\nI don't think you need to have a / between each character is what I mean if that makes the loop cleaner to execute and removes the need of lastret to store the previous iteration.", "url": "https://github.com/fcrepo/fcrepo/pull/1806#discussion_r529890821", "createdAt": "2020-11-24T21:31:26Z", "author": {"login": "whikloj"}, "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraLdpIT.java", "diffHunk": "@@ -5011,4 +5014,38 @@ public void testRepositoryRootTypes() throws Exception {\n             assertTrue(graph.contains(ANY, rootNode, type.asNode(), BASIC_CONTAINER.asNode()));\n         }\n     }\n+\n+    public String genLongUrl(final String prefix, final int numChars) {\n+        String ret = prefix;\n+        String lastret = ret;\n+        final Random rand = new Random();\n+        int cnt = prefix.length();\n+\n+        while (cnt <= numChars) {\n+            lastret = ret;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8548850a4ef66355c2dba8b8ee26e491311cfc6"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA2MjkyOA==", "bodyText": "MariaDB is dying because it is throwing a different Exception and so its not getting caught here.\norg.springframework.jdbc.BadSqlGrammarException: PreparedStatementCallback; bad SQL grammar [INSERT INTO ocfl_id_map_session_operations (fedora_id, fedora_root_id, ocfl_id, session_id, operation) VALUES (?, ?, ?, ?, ?) ON DUPLICATE KEY UPDATE fedora_root_id = VALUES(fedora_id), ocfl_id = VALUES(ocfl_id), operation = VALUES(operation)]; nested exception is java.sql.SQLSyntaxErrorException: (conn=33) Data too long for column 'fedora_id' at row 1\n\nSo you'll need to catch both Exceptions here, ala\n} catch (final DataIntegrityViolationException | BadSqlGrammarException e) {", "url": "https://github.com/fcrepo/fcrepo/pull/1806#discussion_r530062928", "createdAt": "2020-11-25T02:13:15Z", "author": {"login": "whikloj"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DbFedoraToOcflObjectIndex.java", "diffHunk": "@@ -265,7 +267,11 @@ private void upsert(final String transactionId, final FedoraId fedoraId, final S\n         parameterSource.addValue(\"ocflId\", ocflId);\n         parameterSource.addValue(\"transactionId\", transactionId);\n         parameterSource.addValue(\"operation\", operation);\n-        jdbcTemplate.update(UPSERT_MAPPING_TX_MAP.get(dbPlatform), parameterSource);\n+        try {\n+            jdbcTemplate.update(UPSERT_MAPPING_TX_MAP.get(dbPlatform), parameterSource);\n+        } catch (final DataIntegrityViolationException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8548850a4ef66355c2dba8b8ee26e491311cfc6"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "903cde2db970e2269460414cd780f66ed60aaf61", "author": {"user": {"login": "robyj", "name": "Jon Roby"}}, "url": "https://github.com/fcrepo/fcrepo/commit/903cde2db970e2269460414cd780f66ed60aaf61", "committedDate": "2020-11-25T14:50:50Z", "message": "removed that dangling import for InvalidResourceIdentifierException\n\nChanged the definition of the genLongUrl function\n\nremoved lastret. this altered the returned string length, so the comparison values in the asserts had to\nbe modified down slightly\n\nnow catch the MariaDB exception BadSqlGrammarException as well as the DataIntegrityViolationException"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NjA2MjQ0", "url": "https://github.com/fcrepo/fcrepo/pull/1806#pullrequestreview-538606244", "createdAt": "2020-11-25T15:21:36Z", "commit": {"oid": "903cde2db970e2269460414cd780f66ed60aaf61"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NjEyNTQ0", "url": "https://github.com/fcrepo/fcrepo/pull/1806#pullrequestreview-538612544", "createdAt": "2020-11-25T15:28:18Z", "commit": {"oid": "903cde2db970e2269460414cd780f66ed60aaf61"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89211194f304d6874ae9d63da68fde8c11c4f208", "author": {"user": {"login": "robyj", "name": "Jon Roby"}}, "url": "https://github.com/fcrepo/fcrepo/commit/89211194f304d6874ae9d63da68fde8c11c4f208", "committedDate": "2020-11-25T16:24:35Z", "message": "improved the exception handler as per @pwinckles, checks for part of the specific string and if not found\nthrows another error with a descriptive error message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4Njk4MjAy", "url": "https://github.com/fcrepo/fcrepo/pull/1806#pullrequestreview-538698202", "createdAt": "2020-11-25T17:03:44Z", "commit": {"oid": "89211194f304d6874ae9d63da68fde8c11c4f208"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwMDUwODYx", "url": "https://github.com/fcrepo/fcrepo/pull/1806#pullrequestreview-540050861", "createdAt": "2020-11-27T15:18:01Z", "commit": {"oid": "89211194f304d6874ae9d63da68fde8c11c4f208"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3019, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}