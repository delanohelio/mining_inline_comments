{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxMTYxNTM3", "number": 1773, "title": "Reduce number of queries and make updates batched in SearchIndex", "bodyText": "JIRA Ticket: https://jira.lyrasis.org/browse/FCREPO-3455\nWhat does this Pull Request do?\nReduces the number of for loops with individual queries or inserts in favour of single batchs of multiple records.\nHow should this be tested?\nThe ol' @awoods batch ingest test would be best.\nInterested parties\n@fcrepo/committers", "createdAt": "2020-10-11T16:04:02Z", "url": "https://github.com/fcrepo/fcrepo/pull/1773", "merged": true, "mergeCommit": {"oid": "bfe253ba477cf0363c15a3cb45384162615dff99"}, "closed": true, "closedAt": "2020-10-14T13:42:28Z", "author": {"login": "whikloj"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdRhj93AH2gAyNTAxMTYxNTM3OjIxMjJiMGQ2ZjVjYTQ3M2JmNWFlYWFkMzJiN2EwZmNiZWRlZDdkNmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSJMxVAFqTUwNzQ3ODkwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2122b0d6f5ca473bf5aeaad32b7a0fcbeded7d6a", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/2122b0d6f5ca473bf5aeaad32b7a0fcbeded7d6a", "committedDate": "2020-10-11T16:00:06Z", "message": "Reduce number of queries and make updates batched"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c016b404e3090e524eb72cbe2dc485ab7ec6f0a", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/3c016b404e3090e524eb72cbe2dc485ab7ec6f0a", "committedDate": "2020-10-12T03:55:09Z", "message": "Use a set instead of a list"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2NTczNjQw", "url": "https://github.com/fcrepo/fcrepo/pull/1773#pullrequestreview-506573640", "createdAt": "2020-10-12T12:28:22Z", "commit": {"oid": "3c016b404e3090e524eb72cbe2dc485ab7ec6f0a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxMjoyODoyMlrOHf8m3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxMjoyODoyMlrOHf8m3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI2MDg5Mg==", "bodyText": "As you noted, this can fail if multiple threads attempt to concurrently add the same types. Does it not throw an exception in that case? If so, I think you could safely swallow it and proceed because you'll get a failure on line 394 if the types weren't actually created.", "url": "https://github.com/fcrepo/fcrepo/pull/1773#discussion_r503260892", "createdAt": "2020-10-12T12:28:22Z", "author": {"login": "pwinckles"}, "path": "fcrepo-search-impl/src/main/java/org/fcrepo/search/impl/DbSearchIndexImpl.java", "diffHunk": "@@ -346,33 +363,69 @@ private void deleteRdfTypeAssociations(final Long resourceId) {\n                 deleteParams);\n     }\n \n-    private ArrayList<Long> findOrCreateRdfTypesInDb(final List<URI> rdfTypes) {\n-        final var jdbcInsertRdfTypes = new SimpleJdbcInsert(this.jdbcTemplate.getJdbcTemplate());\n-        jdbcInsertRdfTypes.withTableName(SEARCH_RDF_TYPE_TABLE).usingGeneratedKeyColumns(\n-                ID_COLUMN);\n-        final var rdfTypeIds = new ArrayList<Long>();\n-        for (var rdfTypeUri : rdfTypes) {\n-            final var typeParams = new MapSqlParameterSource();\n-            typeParams.addValue(RDF_TYPE_URI_PARAM, rdfTypeUri.toString());\n-            final var results = jdbcTemplate.queryForList(SELECT_RDF_TYPE_ID,\n-                    typeParams);\n-            if (CollectionUtils.isEmpty(results)) {\n-                final Number key = jdbcInsertRdfTypes.executeAndReturnKey(typeParams);\n-                rdfTypeIds.add(key.longValue());\n-            } else {\n-                rdfTypeIds.add((long) results.get(0).get(ID_COLUMN));\n+    private List<Long> findOrCreateRdfTypesInDb(final List<URI> rdfTypes) {\n+        final List<String> rdfTypes_str = rdfTypes.stream().map(URI::toString).collect(Collectors.toList());\n+\n+        final List<RdfType> results = jdbcTemplate.query(SELECT_RDF_TYPE_ID,\n+                Map.of(RDF_TYPE_URI_PARAM, rdfTypes_str), RDF_TYPE_ROW_MAPPER);\n+        // List of existing type ids.\n+        final var rdfTypeIds = results.stream().map(RdfType::getTypeId).collect(Collectors.toList());\n+        // List of existing type uris.\n+        final var rdfTypeUris = results.stream().map(RdfType::getTypeUri).collect(Collectors.toList());\n+        // Type uris that don't already have a record. Needs to be a set to avoid inserting the same URI and\n+        final var missingUris = rdfTypes_str.stream().filter(t -> !rdfTypeUris.contains(t))\n+                .collect(Collectors.toSet());\n+\n+        if (!missingUris.isEmpty()) {\n+            final List<MapSqlParameterSource> parameterSourcesList = new ArrayList<>();\n+            missingUris.forEach(u -> {\n+                final var assocParams = new MapSqlParameterSource();\n+                assocParams.addValue(RDF_TYPE_URI_PARAM, u);\n+                LOGGER.debug(\"Adding rdf type uri: \" + u);\n+                parameterSourcesList.add(assocParams);\n+            });\n+            final MapSqlParameterSource[] psArray = parameterSourcesList.toArray(new MapSqlParameterSource[0]);\n+            // Batch insert all the records.\n+            jdbcTemplate.batchUpdate(INSERT_RDF_TYPE, psArray);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c016b404e3090e524eb72cbe2dc485ab7ec6f0a"}, "originalPosition": 221}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ed7af2db94e65734d69b0068908b913222e543a", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/1ed7af2db94e65734d69b0068908b913222e543a", "committedDate": "2020-10-12T21:31:41Z", "message": "Ignore duplicate rdf_types"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MzYwNDkx", "url": "https://github.com/fcrepo/fcrepo/pull/1773#pullrequestreview-507360491", "createdAt": "2020-10-13T12:05:35Z", "commit": {"oid": "1ed7af2db94e65734d69b0068908b913222e543a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMjowNTozNlrOHgjVtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMjowNTozNlrOHgjVtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg5NTQ3Ng==", "bodyText": "Doesn't matter that much because I suspect we're only ever dealing with a handful of types, but this can be optimized a little:\nfinal var rdfTypeIds = new ArrayList<Long>(rdfTypes.size());\nfinal var rdfTypeUris = new HashSet<String>();\n\nfor (final var type : results) {\n    rdfTypeIds.add(type.getTypeId());\n    rdfTypeUris.add(type.getTypeUri());\n}\n\nfinal var missingUris = rdfTypes.stream().map(URI::toString).filter(t -> !rdfTypeUris.contains(t)).collect(Collectors.toSet());", "url": "https://github.com/fcrepo/fcrepo/pull/1773#discussion_r503895476", "createdAt": "2020-10-13T12:05:36Z", "author": {"login": "pwinckles"}, "path": "fcrepo-search-impl/src/main/java/org/fcrepo/search/impl/DbSearchIndexImpl.java", "diffHunk": "@@ -346,33 +376,69 @@ private void deleteRdfTypeAssociations(final Long resourceId) {\n                 deleteParams);\n     }\n \n-    private ArrayList<Long> findOrCreateRdfTypesInDb(final List<URI> rdfTypes) {\n-        final var jdbcInsertRdfTypes = new SimpleJdbcInsert(this.jdbcTemplate.getJdbcTemplate());\n-        jdbcInsertRdfTypes.withTableName(SEARCH_RDF_TYPE_TABLE).usingGeneratedKeyColumns(\n-                ID_COLUMN);\n-        final var rdfTypeIds = new ArrayList<Long>();\n-        for (var rdfTypeUri : rdfTypes) {\n-            final var typeParams = new MapSqlParameterSource();\n-            typeParams.addValue(RDF_TYPE_URI_PARAM, rdfTypeUri.toString());\n-            final var results = jdbcTemplate.queryForList(SELECT_RDF_TYPE_ID,\n-                    typeParams);\n-            if (CollectionUtils.isEmpty(results)) {\n-                final Number key = jdbcInsertRdfTypes.executeAndReturnKey(typeParams);\n-                rdfTypeIds.add(key.longValue());\n-            } else {\n-                rdfTypeIds.add((long) results.get(0).get(ID_COLUMN));\n+    private List<Long> findOrCreateRdfTypesInDb(final List<URI> rdfTypes) {\n+        final List<String> rdfTypes_str = rdfTypes.stream().map(URI::toString).collect(Collectors.toList());\n+\n+        final List<RdfType> results = jdbcTemplate.query(SELECT_RDF_TYPE_ID,\n+                Map.of(RDF_TYPE_URI_PARAM, rdfTypes_str), RDF_TYPE_ROW_MAPPER);\n+        // List of existing type ids.\n+        final var rdfTypeIds = results.stream().map(RdfType::getTypeId).collect(Collectors.toList());\n+        // List of existing type uris.\n+        final var rdfTypeUris = results.stream().map(RdfType::getTypeUri).collect(Collectors.toList());\n+        // Type uris that don't already have a record. Needs to be a set to avoid inserting the same URI and\n+        final var missingUris = rdfTypes_str.stream().filter(t -> !rdfTypeUris.contains(t))\n+                .collect(Collectors.toSet());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ed7af2db94e65734d69b0068908b913222e543a"}, "originalPosition": 231}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da10ba05b62f3410396094af11d8bc6310b41027", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/da10ba05b62f3410396094af11d8bc6310b41027", "committedDate": "2020-10-13T14:08:19Z", "message": "Reduce 2 streams to one loop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NDc4OTA1", "url": "https://github.com/fcrepo/fcrepo/pull/1773#pullrequestreview-507478905", "createdAt": "2020-10-13T14:10:58Z", "commit": {"oid": "da10ba05b62f3410396094af11d8bc6310b41027"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2978, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}