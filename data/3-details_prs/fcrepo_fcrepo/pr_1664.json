{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0NDQ3NTU0", "number": 1664, "title": "Use RDF extension when looking for files", "bodyText": "JIRA Ticket: https://jira.lyrasis.org/projects/FCREPO/issues/FCREPO-3278\nWhat does this Pull Request do?\nWhen we write RDF we append the .nt extension to the id, but when we delete we just look for a file with the id name.\nWhen trying to delete a child in an AG I got a 500 because it was trying to find a file called test2, but the actual file was test2.nt.\nThis refactors the Delete operations to track whether we are deleting a RDFSource or NonRDFSource object.\nHow should this be tested?\nBefore the PR:\n\nCreate an Archival Group\ncurl -i -ufedoraAdmin:fedoraAdmin -H\"Slug: parent\" -H'Link: <http://fedora.info/definitions/v4/repository#ArchivalGroup>;rel=\"type\"' -H\"Content-type: text/turtle\" -XPOST http://localhost:8080/rest\n\n\nCreate a child resource in the AG.\ncurl -i -ufedoraAdmin:fedoraAdmin -H\"Slug: child\" -H\"Content-type: text/turtle\" -XPOST http://localhost:8080/rest/parent\n\n\nDelete the child resource\n curl -i -ufedoraAdmin:fedoraAdmin -XDELETE http://localhost:8080/rest/parent/child\n\n\nSee 500 and explosion\nPull in this PR\nRepeat steps\nJoy.\n\nInterested parties\n@fcrepo4/committers", "createdAt": "2020-04-16T15:08:40Z", "url": "https://github.com/fcrepo/fcrepo/pull/1664", "merged": true, "mergeCommit": {"oid": "7be191378e579f2f5f6a341c9b97a3c50f31f80b"}, "closed": true, "closedAt": "2020-04-22T22:33:38Z", "author": {"login": "whikloj"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYQI5mAFqTM5NDgzNzk3Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcaJhhAABqjMyNjA5OTUxODk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0ODM3OTc2", "url": "https://github.com/fcrepo/fcrepo/pull/1664#pullrequestreview-394837976", "createdAt": "2020-04-16T17:13:18Z", "commit": {"oid": "2f3e2f2bb73b2c532735c88b5eca7d76a36044fa"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNzoxMzoxOFrOGGvNkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNzoxMzoxOFrOGGvNkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcxODE2MA==", "bodyText": "This seems like something that should be done within the Utils class so that it can be reused other places if needed.", "url": "https://github.com/fcrepo/fcrepo/pull/1664#discussion_r409718160", "createdAt": "2020-04-16T17:13:18Z", "author": {"login": "pwinckles"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DeleteResourcePersister.java", "diffHunk": "@@ -46,13 +48,15 @@ public void persist(final OCFLPersistentStorageSession session, final ResourceOp\n         final var fedoraResourceRoot = mapping.getRootObjectIdentifier();\n         final var resourceId = operation.getResourceId();\n         final var objectSession = session.findOrCreateSession(mapping.getOcflObjectId());\n+        final var isRdf = ((DeleteResourceOperation) operation).isRdf();\n         log.debug(\"Deleting {} from {}\", resourceId, mapping.getOcflObjectId());\n         if (fedoraResourceRoot.equals(resourceId)) {\n             // We are at the root of the object.\n             objectSession.deleteObject();\n         } else {\n             final var relativeSubPath = relativizeSubpath(fedoraResourceRoot, operation.getResourceId());\n-            final var ocflSubPath = resolveOCFLSubpath(fedoraResourceRoot, relativeSubPath);\n+            final var ocflSubPath = resolveOCFLSubpath(fedoraResourceRoot, relativeSubPath) +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f3e2f2bb73b2c532735c88b5eca7d76a36044fa"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NTc0MDk5", "url": "https://github.com/fcrepo/fcrepo/pull/1664#pullrequestreview-397574099", "createdAt": "2020-04-21T18:38:22Z", "commit": {"oid": "0f51dabe3727234c390d6d673b01aac118bc7c14"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxODozODoyMlrOGJS23Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxODozODoyMlrOGJS23Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM5OTMyNQ==", "bodyText": "Would it be an option to call readHeaders here in the persister to determine that the object being deleted is a binary or not, rather than passing it down through the Operation stuff?", "url": "https://github.com/fcrepo/fcrepo/pull/1664#discussion_r412399325", "createdAt": "2020-04-21T18:38:22Z", "author": {"login": "bbpennel"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DeleteResourcePersister.java", "diffHunk": "@@ -46,13 +48,14 @@ public void persist(final OCFLPersistentStorageSession session, final ResourceOp\n         final var fedoraResourceRoot = mapping.getRootObjectIdentifier();\n         final var resourceId = operation.getResourceId();\n         final var objectSession = session.findOrCreateSession(mapping.getOcflObjectId());\n+        final var isRdf = ((DeleteResourceOperation) operation).isRdf();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f51dabe3727234c390d6d673b01aac118bc7c14"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NzAwNTk2", "url": "https://github.com/fcrepo/fcrepo/pull/1664#pullrequestreview-397700596", "createdAt": "2020-04-21T21:48:25Z", "commit": {"oid": "0f51dabe3727234c390d6d673b01aac118bc7c14"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMTo0ODoyNVrOGJZ6yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMTo0ODoyNVrOGJZ6yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUxNTAxOA==", "bodyText": "I don't have a strong opinion on it,  but it does seem cleaner not to pass the isRdf flag.", "url": "https://github.com/fcrepo/fcrepo/pull/1664#discussion_r412515018", "createdAt": "2020-04-21T21:48:25Z", "author": {"login": "dbernstein"}, "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DeleteResourcePersister.java", "diffHunk": "@@ -46,13 +48,14 @@ public void persist(final OCFLPersistentStorageSession session, final ResourceOp\n         final var fedoraResourceRoot = mapping.getRootObjectIdentifier();\n         final var resourceId = operation.getResourceId();\n         final var objectSession = session.findOrCreateSession(mapping.getOcflObjectId());\n+        final var isRdf = ((DeleteResourceOperation) operation).isRdf();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM5OTMyNQ=="}, "originalCommit": {"oid": "0f51dabe3727234c390d6d673b01aac118bc7c14"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8af8f21cde42652a4f62ad6c430fcecfa457ed53", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/8af8f21cde42652a4f62ad6c430fcecfa457ed53", "committedDate": "2020-04-22T14:53:34Z", "message": "Fix delete to point to actual file path."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0f51dabe3727234c390d6d673b01aac118bc7c14", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/0f51dabe3727234c390d6d673b01aac118bc7c14", "committedDate": "2020-04-20T03:51:20Z", "message": "Formalize adding the RDF extension."}, "afterCommit": {"oid": "8af8f21cde42652a4f62ad6c430fcecfa457ed53", "author": {"user": {"login": "whikloj", "name": "Jared Whiklo"}}, "url": "https://github.com/fcrepo/fcrepo/commit/8af8f21cde42652a4f62ad6c430fcecfa457ed53", "committedDate": "2020-04-22T14:53:34Z", "message": "Fix delete to point to actual file path."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3094, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}