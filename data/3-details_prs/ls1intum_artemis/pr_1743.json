{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxMzI5MDU3", "number": 1743, "title": "Catch EntityNotFoundException for websocket  subscribe.", "bodyText": "Checklist\n\n I tested all changes and all related features with different users (student, tutor, instructor, admin) on the test server https://artemistest.ase.in.tum.de.\n\nMotivation and Context\nThere seems to be an error where an not-logged-in (anonymous) user tries to subscribe to a protected channel (e.g. due to him being logged off but a bug in the client still assuming he is logged in), which causes an error as the user cannot be found.\nDescription\nCatch the EntityNotFoundException thrown when the using could not be found.\nSteps for Testing\n\nVerify that subscriptions are still working as expected, e.g. by using the code editor.", "createdAt": "2020-06-29T11:14:32Z", "url": "https://github.com/ls1intum/Artemis/pull/1743", "merged": true, "mergeCommit": {"oid": "8ca28c195d736d5e16647206c8cfe568dcc667f1"}, "closed": true, "closedAt": "2020-06-29T18:56:59Z", "author": {"login": "sleiss"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcv9vKpgH2gAyNDQxMzI5MDU3OjA1NjA0NTlkYTVkYmVmMjNlNjk0NjI4ZjU4YjgwZTRjNDg2YmM2OTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwFwKrgH2gAyNDQxMzI5MDU3OjEwN2E3ODFlMGVmZGM1OGY3Yjg3YmU3OGRkOGQ4OTVjOTFjNzc0ZTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0560459da5dbef23e694628f58b80e4c486bc696", "author": {"user": {"login": "sleiss", "name": "Simon Lei\u00df"}}, "url": "https://github.com/ls1intum/Artemis/commit/0560459da5dbef23e694628f58b80e4c486bc696", "committedDate": "2020-06-29T09:36:15Z", "message": "Catch EntityNotFoundException for websocket  subscribe."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b57b33639fabb382c962083005ae687a37f41420", "author": {"user": {"login": "sleiss", "name": "Simon Lei\u00df"}}, "url": "https://github.com/ls1intum/Artemis/commit/b57b33639fabb382c962083005ae687a37f41420", "committedDate": "2020-06-29T10:41:22Z", "message": "Merge branch 'develop' into bugfix/websocket-subscribe-anonymous"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aad2895de029805394e2bc4a77975536a0e60186", "author": {"user": {"login": "sleiss", "name": "Simon Lei\u00df"}}, "url": "https://github.com/ls1intum/Artemis/commit/aad2895de029805394e2bc4a77975536a0e60186", "committedDate": "2020-06-29T11:45:52Z", "message": "Merge branch 'develop' into bugfix/websocket-subscribe-anonymous"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MTI1MTcy", "url": "https://github.com/ls1intum/Artemis/pull/1743#pullrequestreview-439125172", "createdAt": "2020-06-29T13:09:37Z", "commit": {"oid": "aad2895de029805394e2bc4a77975536a0e60186"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxMzowOTozN1rOGqQJFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxMzowOTozN1rOGqQJFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk1Nzg0Nw==", "bodyText": "log.warn(\"Catcher an exception during SUBSCRIBE...\")", "url": "https://github.com/ls1intum/Artemis/pull/1743#discussion_r446957847", "createdAt": "2020-06-29T13:09:37Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/config/websocket/WebsocketConfiguration.java", "diffHunk": "@@ -262,9 +263,15 @@ protected Principal determineUser(ServerHttpRequest request, WebSocketHandler ws\n             String destination = headerAccessor.getDestination();\n \n             if (StompCommand.SUBSCRIBE.equals(headerAccessor.getCommand())) {\n-                if (!allowSubscription(principal, destination)) {\n-                    logUnauthorizedDestinationAccess(principal, destination);\n-                    return null; // erase the forbidden SUBSCRIBE command the user was trying to send\n+                try {\n+                    if (!allowSubscription(principal, destination)) {\n+                        logUnauthorizedDestinationAccess(principal, destination);\n+                        return null; // erase the forbidden SUBSCRIBE command the user was trying to send\n+                    }\n+                }\n+                catch (EntityNotFoundException e) {\n+                    // If the user is not found (e.g. because he is not logged in), he should not be able to subscribe to these topics", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aad2895de029805394e2bc4a77975536a0e60186"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f96e7858d7b5cb5c90a2a35d3fa9d47dc830f5a1", "author": {"user": {"login": "sleiss", "name": "Simon Lei\u00df"}}, "url": "https://github.com/ls1intum/Artemis/commit/f96e7858d7b5cb5c90a2a35d3fa9d47dc830f5a1", "committedDate": "2020-06-29T13:16:23Z", "message": "Add log.warn message if permission check failed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7936949c7dd5dc2c720cfa320fe380c564ae1e31", "author": {"user": {"login": "sleiss", "name": "Simon Lei\u00df"}}, "url": "https://github.com/ls1intum/Artemis/commit/7936949c7dd5dc2c720cfa320fe380c564ae1e31", "committedDate": "2020-06-29T13:16:43Z", "message": "Merge remote-tracking branch 'origin/bugfix/websocket-subscribe-anonymous' into bugfix/websocket-subscribe-anonymous"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NDE2MTA5", "url": "https://github.com/ls1intum/Artemis/pull/1743#pullrequestreview-439416109", "createdAt": "2020-06-29T18:56:17Z", "commit": {"oid": "7936949c7dd5dc2c720cfa320fe380c564ae1e31"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "107a781e0efdc58f7b87be78dd8d895c91c774e1", "author": {"user": {"login": "krusche", "name": "Stephan Krusche"}}, "url": "https://github.com/ls1intum/Artemis/commit/107a781e0efdc58f7b87be78dd8d895c91c774e1", "committedDate": "2020-06-29T18:56:35Z", "message": "Merge branch 'develop' into bugfix/websocket-subscribe-anonymous"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2555, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}