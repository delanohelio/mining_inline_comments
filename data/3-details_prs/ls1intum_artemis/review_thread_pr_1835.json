{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2MjUyOTEx", "number": 1835, "reviewThreads": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxMzoyNzoyNFrOENRn5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQxNjo0ODoyOVrOENnTSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyMzU1Njg3OnYy", "diffSide": "RIGHT", "path": "src/main/java/de/tum/in/www1/artemis/service/SubmissionExportService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxMzoyNzoyNFrOGv3UMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxMzoyNzoyNFrOGv3UMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg0MjU0Ng==", "bodyText": "Use { }", "url": "https://github.com/ls1intum/Artemis/pull/1835#discussion_r452842546", "createdAt": "2020-07-10T13:27:24Z", "author": {"login": "kloessst"}, "path": "src/main/java/de/tum/in/www1/artemis/service/SubmissionExportService.java", "diffHunk": "@@ -0,0 +1,249 @@\n+package de.tum.in.www1.artemis.service;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.ZoneOffset;\n+import java.time.ZonedDateTime;\n+import java.time.format.DateTimeFormatter;\n+import java.util.*;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+import java.util.stream.Collectors;\n+import java.util.zip.ZipEntry;\n+import java.util.zip.ZipOutputStream;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Service;\n+\n+import de.tum.in.www1.artemis.domain.Course;\n+import de.tum.in.www1.artemis.domain.Exercise;\n+import de.tum.in.www1.artemis.domain.Submission;\n+import de.tum.in.www1.artemis.domain.participation.StudentParticipation;\n+import de.tum.in.www1.artemis.repository.ExerciseRepository;\n+import de.tum.in.www1.artemis.web.rest.dto.SubmissionExportOptionsDTO;\n+\n+@Service\n+public abstract class SubmissionExportService {\n+\n+    private final Logger log = LoggerFactory.getLogger(SubmissionExportService.class);\n+\n+    private final ExerciseRepository exerciseRepository;\n+\n+    public SubmissionExportService(ExerciseRepository exerciseRepository) {\n+        this.exerciseRepository = exerciseRepository;\n+    }\n+\n+    @Value(\"${artemis.submission-export-path}\")\n+    private String SUBMISSION_EXPORT_PATH;\n+\n+    /**\n+     * Exports student submissions to a zip file for an exercise\n+     * @param exerciseId the id of the exercise to be exported\n+     * @param submissionExportOptions the options for the expot\n+     * @return a reference to the zipped file\n+     * @throws IOException\n+     */\n+    @Nullable\n+    public File exportStudentSubmissions(Long exerciseId, SubmissionExportOptionsDTO submissionExportOptions) throws IOException {\n+\n+        Optional<Exercise> exerciseOpt = exerciseRepository.findWithEagerStudentParticipationsStudentAndSubmissionsById(exerciseId);\n+\n+        if (exerciseOpt.isEmpty())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723144a5aa43cc6147471925ee15811a77160fcd"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyMzY5NDA1OnYy", "diffSide": "RIGHT", "path": "src/main/java/de/tum/in/www1/artemis/service/SubmissionExportService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNDowNDoyN1rOGv4p4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNDowNDoyN1rOGv4p4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg2NDQ4MQ==", "bodyText": "Returning an Optional might be safer for the caller", "url": "https://github.com/ls1intum/Artemis/pull/1835#discussion_r452864481", "createdAt": "2020-07-10T14:04:27Z", "author": {"login": "kloessst"}, "path": "src/main/java/de/tum/in/www1/artemis/service/SubmissionExportService.java", "diffHunk": "@@ -0,0 +1,249 @@\n+package de.tum.in.www1.artemis.service;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.ZoneOffset;\n+import java.time.ZonedDateTime;\n+import java.time.format.DateTimeFormatter;\n+import java.util.*;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+import java.util.stream.Collectors;\n+import java.util.zip.ZipEntry;\n+import java.util.zip.ZipOutputStream;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Service;\n+\n+import de.tum.in.www1.artemis.domain.Course;\n+import de.tum.in.www1.artemis.domain.Exercise;\n+import de.tum.in.www1.artemis.domain.Submission;\n+import de.tum.in.www1.artemis.domain.participation.StudentParticipation;\n+import de.tum.in.www1.artemis.repository.ExerciseRepository;\n+import de.tum.in.www1.artemis.web.rest.dto.SubmissionExportOptionsDTO;\n+\n+@Service\n+public abstract class SubmissionExportService {\n+\n+    private final Logger log = LoggerFactory.getLogger(SubmissionExportService.class);\n+\n+    private final ExerciseRepository exerciseRepository;\n+\n+    public SubmissionExportService(ExerciseRepository exerciseRepository) {\n+        this.exerciseRepository = exerciseRepository;\n+    }\n+\n+    @Value(\"${artemis.submission-export-path}\")\n+    private String SUBMISSION_EXPORT_PATH;\n+\n+    /**\n+     * Exports student submissions to a zip file for an exercise\n+     * @param exerciseId the id of the exercise to be exported\n+     * @param submissionExportOptions the options for the expot\n+     * @return a reference to the zipped file\n+     * @throws IOException\n+     */\n+    @Nullable\n+    public File exportStudentSubmissions(Long exerciseId, SubmissionExportOptionsDTO submissionExportOptions) throws IOException {\n+\n+        Optional<Exercise> exerciseOpt = exerciseRepository.findWithEagerStudentParticipationsStudentAndSubmissionsById(exerciseId);\n+\n+        if (exerciseOpt.isEmpty())\n+            return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723144a5aa43cc6147471925ee15811a77160fcd"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyMzY5NzgwOnYy", "diffSide": "RIGHT", "path": "src/main/java/de/tum/in/www1/artemis/service/SubmissionExportService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNDowNToyOFrOGv4sZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNDowNToyOFrOGv4sZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg2NTEyNw==", "bodyText": "See above", "url": "https://github.com/ls1intum/Artemis/pull/1835#discussion_r452865127", "createdAt": "2020-07-10T14:05:28Z", "author": {"login": "kloessst"}, "path": "src/main/java/de/tum/in/www1/artemis/service/SubmissionExportService.java", "diffHunk": "@@ -0,0 +1,249 @@\n+package de.tum.in.www1.artemis.service;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.ZoneOffset;\n+import java.time.ZonedDateTime;\n+import java.time.format.DateTimeFormatter;\n+import java.util.*;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+import java.util.stream.Collectors;\n+import java.util.zip.ZipEntry;\n+import java.util.zip.ZipOutputStream;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Service;\n+\n+import de.tum.in.www1.artemis.domain.Course;\n+import de.tum.in.www1.artemis.domain.Exercise;\n+import de.tum.in.www1.artemis.domain.Submission;\n+import de.tum.in.www1.artemis.domain.participation.StudentParticipation;\n+import de.tum.in.www1.artemis.repository.ExerciseRepository;\n+import de.tum.in.www1.artemis.web.rest.dto.SubmissionExportOptionsDTO;\n+\n+@Service\n+public abstract class SubmissionExportService {\n+\n+    private final Logger log = LoggerFactory.getLogger(SubmissionExportService.class);\n+\n+    private final ExerciseRepository exerciseRepository;\n+\n+    public SubmissionExportService(ExerciseRepository exerciseRepository) {\n+        this.exerciseRepository = exerciseRepository;\n+    }\n+\n+    @Value(\"${artemis.submission-export-path}\")\n+    private String SUBMISSION_EXPORT_PATH;\n+\n+    /**\n+     * Exports student submissions to a zip file for an exercise\n+     * @param exerciseId the id of the exercise to be exported\n+     * @param submissionExportOptions the options for the expot\n+     * @return a reference to the zipped file\n+     * @throws IOException\n+     */\n+    @Nullable\n+    public File exportStudentSubmissions(Long exerciseId, SubmissionExportOptionsDTO submissionExportOptions) throws IOException {\n+\n+        Optional<Exercise> exerciseOpt = exerciseRepository.findWithEagerStudentParticipationsStudentAndSubmissionsById(exerciseId);\n+\n+        if (exerciseOpt.isEmpty())\n+            return null;\n+\n+        Exercise exercise = exerciseOpt.get();\n+\n+        // Select the participations that should be exported\n+        List<StudentParticipation> exportedStudentParticipations;\n+\n+        if (submissionExportOptions.isExportAllParticipants()) {\n+            exportedStudentParticipations = new ArrayList<>(exercise.getStudentParticipations());\n+        }\n+        else {\n+            List<String> participantIds = Arrays.stream(submissionExportOptions.getParticipantIdentifierList().split(\",\")).map(String::trim).collect(Collectors.toList());\n+\n+            exportedStudentParticipations = exercise.getStudentParticipations().stream().filter(participation -> participantIds.contains(participation.getParticipantIdentifier()))\n+                    .collect(Collectors.toList());\n+        }\n+\n+        if (exportedStudentParticipations.isEmpty()) {\n+            return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723144a5aa43cc6147471925ee15811a77160fcd"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyMzczNDM3OnYy", "diffSide": "RIGHT", "path": "src/main/java/de/tum/in/www1/artemis/service/SubmissionExportService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNDoxNToxOFrOGv5DiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNDoxNToxOFrOGv5DiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg3MTA0OQ==", "bodyText": "Use { }", "url": "https://github.com/ls1intum/Artemis/pull/1835#discussion_r452871049", "createdAt": "2020-07-10T14:15:18Z", "author": {"login": "kloessst"}, "path": "src/main/java/de/tum/in/www1/artemis/service/SubmissionExportService.java", "diffHunk": "@@ -0,0 +1,249 @@\n+package de.tum.in.www1.artemis.service;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.ZoneOffset;\n+import java.time.ZonedDateTime;\n+import java.time.format.DateTimeFormatter;\n+import java.util.*;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+import java.util.stream.Collectors;\n+import java.util.zip.ZipEntry;\n+import java.util.zip.ZipOutputStream;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Service;\n+\n+import de.tum.in.www1.artemis.domain.Course;\n+import de.tum.in.www1.artemis.domain.Exercise;\n+import de.tum.in.www1.artemis.domain.Submission;\n+import de.tum.in.www1.artemis.domain.participation.StudentParticipation;\n+import de.tum.in.www1.artemis.repository.ExerciseRepository;\n+import de.tum.in.www1.artemis.web.rest.dto.SubmissionExportOptionsDTO;\n+\n+@Service\n+public abstract class SubmissionExportService {\n+\n+    private final Logger log = LoggerFactory.getLogger(SubmissionExportService.class);\n+\n+    private final ExerciseRepository exerciseRepository;\n+\n+    public SubmissionExportService(ExerciseRepository exerciseRepository) {\n+        this.exerciseRepository = exerciseRepository;\n+    }\n+\n+    @Value(\"${artemis.submission-export-path}\")\n+    private String SUBMISSION_EXPORT_PATH;\n+\n+    /**\n+     * Exports student submissions to a zip file for an exercise\n+     * @param exerciseId the id of the exercise to be exported\n+     * @param submissionExportOptions the options for the expot\n+     * @return a reference to the zipped file\n+     * @throws IOException\n+     */\n+    @Nullable\n+    public File exportStudentSubmissions(Long exerciseId, SubmissionExportOptionsDTO submissionExportOptions) throws IOException {\n+\n+        Optional<Exercise> exerciseOpt = exerciseRepository.findWithEagerStudentParticipationsStudentAndSubmissionsById(exerciseId);\n+\n+        if (exerciseOpt.isEmpty())\n+            return null;\n+\n+        Exercise exercise = exerciseOpt.get();\n+\n+        // Select the participations that should be exported\n+        List<StudentParticipation> exportedStudentParticipations;\n+\n+        if (submissionExportOptions.isExportAllParticipants()) {\n+            exportedStudentParticipations = new ArrayList<>(exercise.getStudentParticipations());\n+        }\n+        else {\n+            List<String> participantIds = Arrays.stream(submissionExportOptions.getParticipantIdentifierList().split(\",\")).map(String::trim).collect(Collectors.toList());\n+\n+            exportedStudentParticipations = exercise.getStudentParticipations().stream().filter(participation -> participantIds.contains(participation.getParticipantIdentifier()))\n+                    .collect(Collectors.toList());\n+        }\n+\n+        if (exportedStudentParticipations.isEmpty()) {\n+            return null;\n+        }\n+\n+        ZonedDateTime filterLateSubmissionsDate = null;\n+        if (submissionExportOptions.isFilterLateSubmissions()) {\n+            if (submissionExportOptions.getFilterLateSubmissionsDate() == null) {\n+                filterLateSubmissionsDate = exercise.getDueDate();\n+            }\n+            else {\n+                filterLateSubmissionsDate = submissionExportOptions.getFilterLateSubmissionsDate();\n+            }\n+        }\n+\n+        return this.createZipFileFromParticipations(exercise, exportedStudentParticipations, filterLateSubmissionsDate);\n+\n+    }\n+\n+    /**\n+     * Creates a zip file from a list of participations for an exercise\n+     * @param exercise the exercise in question\n+     * @param participations a list of participations to include\n+     * @param lateSubmissionFilter an optional date filter for submissions\n+     * @return the zipped file\n+     * @throws IOException\n+     */\n+    @Nullable\n+    private File createZipFileFromParticipations(Exercise exercise, List<StudentParticipation> participations, @Nullable ZonedDateTime lateSubmissionFilter) throws IOException {\n+\n+        Course course = exercise.getCourseViaExerciseGroupOrCourseMember();\n+\n+        String zipGroupName = course.getTitle() + \"-\" + exercise.getTitle() + \"-submissions\";\n+        String zipFileName = zipGroupName + \"-\" + ZonedDateTime.now(ZoneOffset.UTC).format(DateTimeFormatter.ISO_INSTANT) + \".zip\";\n+\n+        Path submissionsFolderPath = Paths.get(SUBMISSION_EXPORT_PATH, \"zippedSubmissions\", zipGroupName);\n+        Path zipFilePath = Paths.get(SUBMISSION_EXPORT_PATH, \"zippedSubmissions\", zipFileName);\n+\n+        // Save all Submissions\n+        List<Path> submissionFilePaths = participations.stream().map((participation) -> {\n+\n+            Set<Submission> submissions = participation.getSubmissions();\n+            Submission latestSubmission = null;\n+\n+            for (Submission s : submissions) {\n+                if (lateSubmissionFilter == null || s.getSubmissionDate().isBefore(lateSubmissionFilter)) {\n+                    if (latestSubmission == null || s.getSubmissionDate().isAfter(latestSubmission.getSubmissionDate())) {\n+                        latestSubmission = s;\n+                    }\n+                }\n+            }\n+\n+            if (latestSubmission == null)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723144a5aa43cc6147471925ee15811a77160fcd"}, "originalPosition": 129}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyMzg3Mzk5OnYy", "diffSide": "RIGHT", "path": "src/main/java/de/tum/in/www1/artemis/service/SubmissionExportService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNDo1MjowMFrOGv6bDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNDo1MjowMFrOGv6bDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg5MzQ1NA==", "bodyText": "You could move this to outside the lambda as submissionsFolderPath has to be created only once.", "url": "https://github.com/ls1intum/Artemis/pull/1835#discussion_r452893454", "createdAt": "2020-07-10T14:52:00Z", "author": {"login": "kloessst"}, "path": "src/main/java/de/tum/in/www1/artemis/service/SubmissionExportService.java", "diffHunk": "@@ -0,0 +1,249 @@\n+package de.tum.in.www1.artemis.service;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.ZoneOffset;\n+import java.time.ZonedDateTime;\n+import java.time.format.DateTimeFormatter;\n+import java.util.*;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+import java.util.stream.Collectors;\n+import java.util.zip.ZipEntry;\n+import java.util.zip.ZipOutputStream;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Service;\n+\n+import de.tum.in.www1.artemis.domain.Course;\n+import de.tum.in.www1.artemis.domain.Exercise;\n+import de.tum.in.www1.artemis.domain.Submission;\n+import de.tum.in.www1.artemis.domain.participation.StudentParticipation;\n+import de.tum.in.www1.artemis.repository.ExerciseRepository;\n+import de.tum.in.www1.artemis.web.rest.dto.SubmissionExportOptionsDTO;\n+\n+@Service\n+public abstract class SubmissionExportService {\n+\n+    private final Logger log = LoggerFactory.getLogger(SubmissionExportService.class);\n+\n+    private final ExerciseRepository exerciseRepository;\n+\n+    public SubmissionExportService(ExerciseRepository exerciseRepository) {\n+        this.exerciseRepository = exerciseRepository;\n+    }\n+\n+    @Value(\"${artemis.submission-export-path}\")\n+    private String SUBMISSION_EXPORT_PATH;\n+\n+    /**\n+     * Exports student submissions to a zip file for an exercise\n+     * @param exerciseId the id of the exercise to be exported\n+     * @param submissionExportOptions the options for the expot\n+     * @return a reference to the zipped file\n+     * @throws IOException\n+     */\n+    @Nullable\n+    public File exportStudentSubmissions(Long exerciseId, SubmissionExportOptionsDTO submissionExportOptions) throws IOException {\n+\n+        Optional<Exercise> exerciseOpt = exerciseRepository.findWithEagerStudentParticipationsStudentAndSubmissionsById(exerciseId);\n+\n+        if (exerciseOpt.isEmpty())\n+            return null;\n+\n+        Exercise exercise = exerciseOpt.get();\n+\n+        // Select the participations that should be exported\n+        List<StudentParticipation> exportedStudentParticipations;\n+\n+        if (submissionExportOptions.isExportAllParticipants()) {\n+            exportedStudentParticipations = new ArrayList<>(exercise.getStudentParticipations());\n+        }\n+        else {\n+            List<String> participantIds = Arrays.stream(submissionExportOptions.getParticipantIdentifierList().split(\",\")).map(String::trim).collect(Collectors.toList());\n+\n+            exportedStudentParticipations = exercise.getStudentParticipations().stream().filter(participation -> participantIds.contains(participation.getParticipantIdentifier()))\n+                    .collect(Collectors.toList());\n+        }\n+\n+        if (exportedStudentParticipations.isEmpty()) {\n+            return null;\n+        }\n+\n+        ZonedDateTime filterLateSubmissionsDate = null;\n+        if (submissionExportOptions.isFilterLateSubmissions()) {\n+            if (submissionExportOptions.getFilterLateSubmissionsDate() == null) {\n+                filterLateSubmissionsDate = exercise.getDueDate();\n+            }\n+            else {\n+                filterLateSubmissionsDate = submissionExportOptions.getFilterLateSubmissionsDate();\n+            }\n+        }\n+\n+        return this.createZipFileFromParticipations(exercise, exportedStudentParticipations, filterLateSubmissionsDate);\n+\n+    }\n+\n+    /**\n+     * Creates a zip file from a list of participations for an exercise\n+     * @param exercise the exercise in question\n+     * @param participations a list of participations to include\n+     * @param lateSubmissionFilter an optional date filter for submissions\n+     * @return the zipped file\n+     * @throws IOException\n+     */\n+    @Nullable\n+    private File createZipFileFromParticipations(Exercise exercise, List<StudentParticipation> participations, @Nullable ZonedDateTime lateSubmissionFilter) throws IOException {\n+\n+        Course course = exercise.getCourseViaExerciseGroupOrCourseMember();\n+\n+        String zipGroupName = course.getTitle() + \"-\" + exercise.getTitle() + \"-submissions\";\n+        String zipFileName = zipGroupName + \"-\" + ZonedDateTime.now(ZoneOffset.UTC).format(DateTimeFormatter.ISO_INSTANT) + \".zip\";\n+\n+        Path submissionsFolderPath = Paths.get(SUBMISSION_EXPORT_PATH, \"zippedSubmissions\", zipGroupName);\n+        Path zipFilePath = Paths.get(SUBMISSION_EXPORT_PATH, \"zippedSubmissions\", zipFileName);\n+\n+        // Save all Submissions\n+        List<Path> submissionFilePaths = participations.stream().map((participation) -> {\n+\n+            Set<Submission> submissions = participation.getSubmissions();\n+            Submission latestSubmission = null;\n+\n+            for (Submission s : submissions) {\n+                if (lateSubmissionFilter == null || s.getSubmissionDate().isBefore(lateSubmissionFilter)) {\n+                    if (latestSubmission == null || s.getSubmissionDate().isAfter(latestSubmission.getSubmissionDate())) {\n+                        latestSubmission = s;\n+                    }\n+                }\n+            }\n+\n+            if (latestSubmission == null)\n+                return Optional.<Path>empty();\n+\n+            String submissionFileName = exercise.getTitle() + \"-\" + participation.getParticipantIdentifier() + \"-\" + latestSubmission.getId()\n+                    + this.getFileEndingForSubmission(latestSubmission);\n+            Path submissionFilePath = Paths.get(submissionsFolderPath.toString(), submissionFileName);\n+\n+            try {\n+\n+                File parent = submissionFilePath.getParent().toFile();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723144a5aa43cc6147471925ee15811a77160fcd"}, "originalPosition": 138}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyMzg3ODQ2OnYy", "diffSide": "RIGHT", "path": "src/main/java/de/tum/in/www1/artemis/service/SubmissionExportService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNDo1MzoxNlrOGv6eAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNDo1MzoxNlrOGv6eAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg5NDIxMA==", "bodyText": "Could use Optional", "url": "https://github.com/ls1intum/Artemis/pull/1835#discussion_r452894210", "createdAt": "2020-07-10T14:53:16Z", "author": {"login": "kloessst"}, "path": "src/main/java/de/tum/in/www1/artemis/service/SubmissionExportService.java", "diffHunk": "@@ -0,0 +1,249 @@\n+package de.tum.in.www1.artemis.service;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.ZoneOffset;\n+import java.time.ZonedDateTime;\n+import java.time.format.DateTimeFormatter;\n+import java.util.*;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+import java.util.stream.Collectors;\n+import java.util.zip.ZipEntry;\n+import java.util.zip.ZipOutputStream;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Service;\n+\n+import de.tum.in.www1.artemis.domain.Course;\n+import de.tum.in.www1.artemis.domain.Exercise;\n+import de.tum.in.www1.artemis.domain.Submission;\n+import de.tum.in.www1.artemis.domain.participation.StudentParticipation;\n+import de.tum.in.www1.artemis.repository.ExerciseRepository;\n+import de.tum.in.www1.artemis.web.rest.dto.SubmissionExportOptionsDTO;\n+\n+@Service\n+public abstract class SubmissionExportService {\n+\n+    private final Logger log = LoggerFactory.getLogger(SubmissionExportService.class);\n+\n+    private final ExerciseRepository exerciseRepository;\n+\n+    public SubmissionExportService(ExerciseRepository exerciseRepository) {\n+        this.exerciseRepository = exerciseRepository;\n+    }\n+\n+    @Value(\"${artemis.submission-export-path}\")\n+    private String SUBMISSION_EXPORT_PATH;\n+\n+    /**\n+     * Exports student submissions to a zip file for an exercise\n+     * @param exerciseId the id of the exercise to be exported\n+     * @param submissionExportOptions the options for the expot\n+     * @return a reference to the zipped file\n+     * @throws IOException\n+     */\n+    @Nullable\n+    public File exportStudentSubmissions(Long exerciseId, SubmissionExportOptionsDTO submissionExportOptions) throws IOException {\n+\n+        Optional<Exercise> exerciseOpt = exerciseRepository.findWithEagerStudentParticipationsStudentAndSubmissionsById(exerciseId);\n+\n+        if (exerciseOpt.isEmpty())\n+            return null;\n+\n+        Exercise exercise = exerciseOpt.get();\n+\n+        // Select the participations that should be exported\n+        List<StudentParticipation> exportedStudentParticipations;\n+\n+        if (submissionExportOptions.isExportAllParticipants()) {\n+            exportedStudentParticipations = new ArrayList<>(exercise.getStudentParticipations());\n+        }\n+        else {\n+            List<String> participantIds = Arrays.stream(submissionExportOptions.getParticipantIdentifierList().split(\",\")).map(String::trim).collect(Collectors.toList());\n+\n+            exportedStudentParticipations = exercise.getStudentParticipations().stream().filter(participation -> participantIds.contains(participation.getParticipantIdentifier()))\n+                    .collect(Collectors.toList());\n+        }\n+\n+        if (exportedStudentParticipations.isEmpty()) {\n+            return null;\n+        }\n+\n+        ZonedDateTime filterLateSubmissionsDate = null;\n+        if (submissionExportOptions.isFilterLateSubmissions()) {\n+            if (submissionExportOptions.getFilterLateSubmissionsDate() == null) {\n+                filterLateSubmissionsDate = exercise.getDueDate();\n+            }\n+            else {\n+                filterLateSubmissionsDate = submissionExportOptions.getFilterLateSubmissionsDate();\n+            }\n+        }\n+\n+        return this.createZipFileFromParticipations(exercise, exportedStudentParticipations, filterLateSubmissionsDate);\n+\n+    }\n+\n+    /**\n+     * Creates a zip file from a list of participations for an exercise\n+     * @param exercise the exercise in question\n+     * @param participations a list of participations to include\n+     * @param lateSubmissionFilter an optional date filter for submissions\n+     * @return the zipped file\n+     * @throws IOException\n+     */\n+    @Nullable\n+    private File createZipFileFromParticipations(Exercise exercise, List<StudentParticipation> participations, @Nullable ZonedDateTime lateSubmissionFilter) throws IOException {\n+\n+        Course course = exercise.getCourseViaExerciseGroupOrCourseMember();\n+\n+        String zipGroupName = course.getTitle() + \"-\" + exercise.getTitle() + \"-submissions\";\n+        String zipFileName = zipGroupName + \"-\" + ZonedDateTime.now(ZoneOffset.UTC).format(DateTimeFormatter.ISO_INSTANT) + \".zip\";\n+\n+        Path submissionsFolderPath = Paths.get(SUBMISSION_EXPORT_PATH, \"zippedSubmissions\", zipGroupName);\n+        Path zipFilePath = Paths.get(SUBMISSION_EXPORT_PATH, \"zippedSubmissions\", zipFileName);\n+\n+        // Save all Submissions\n+        List<Path> submissionFilePaths = participations.stream().map((participation) -> {\n+\n+            Set<Submission> submissions = participation.getSubmissions();\n+            Submission latestSubmission = null;\n+\n+            for (Submission s : submissions) {\n+                if (lateSubmissionFilter == null || s.getSubmissionDate().isBefore(lateSubmissionFilter)) {\n+                    if (latestSubmission == null || s.getSubmissionDate().isAfter(latestSubmission.getSubmissionDate())) {\n+                        latestSubmission = s;\n+                    }\n+                }\n+            }\n+\n+            if (latestSubmission == null)\n+                return Optional.<Path>empty();\n+\n+            String submissionFileName = exercise.getTitle() + \"-\" + participation.getParticipantIdentifier() + \"-\" + latestSubmission.getId()\n+                    + this.getFileEndingForSubmission(latestSubmission);\n+            Path submissionFilePath = Paths.get(submissionsFolderPath.toString(), submissionFileName);\n+\n+            try {\n+\n+                File parent = submissionFilePath.getParent().toFile();\n+                if (!parent.exists() && !parent.mkdirs()) {\n+                    log.error(\"Couldn't create dir: \" + parent);\n+                    return Optional.<Path>empty();\n+                }\n+\n+                this.saveSubmissionToFile(exercise, latestSubmission, submissionFilePath.toFile());\n+                return Optional.of(submissionFilePath);\n+\n+            }\n+            catch (IOException ioException) {\n+                log.error(\"Could not create file \" + submissionFilePath.toString() + \"for exporting: \" + ioException.getMessage());\n+                return Optional.<Path>empty();\n+            }\n+\n+        }).filter(Optional::isPresent).map(Optional::get).collect(Collectors.toList());\n+\n+        if (submissionFilePaths.isEmpty())\n+            return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723144a5aa43cc6147471925ee15811a77160fcd"}, "originalPosition": 156}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyMzk3NDIwOnYy", "diffSide": "RIGHT", "path": "src/main/java/de/tum/in/www1/artemis/service/SubmissionExportService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNToxODozM1rOGv7Z1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNToxODozM1rOGv7Z1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjkwOTUyNg==", "bodyText": "Would be nice if we could issue a warning in the UI if something went wrong and some submissions might be missing. But I guess this is out of scope.", "url": "https://github.com/ls1intum/Artemis/pull/1835#discussion_r452909526", "createdAt": "2020-07-10T15:18:33Z", "author": {"login": "kloessst"}, "path": "src/main/java/de/tum/in/www1/artemis/service/SubmissionExportService.java", "diffHunk": "@@ -0,0 +1,249 @@\n+package de.tum.in.www1.artemis.service;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.ZoneOffset;\n+import java.time.ZonedDateTime;\n+import java.time.format.DateTimeFormatter;\n+import java.util.*;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+import java.util.stream.Collectors;\n+import java.util.zip.ZipEntry;\n+import java.util.zip.ZipOutputStream;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Service;\n+\n+import de.tum.in.www1.artemis.domain.Course;\n+import de.tum.in.www1.artemis.domain.Exercise;\n+import de.tum.in.www1.artemis.domain.Submission;\n+import de.tum.in.www1.artemis.domain.participation.StudentParticipation;\n+import de.tum.in.www1.artemis.repository.ExerciseRepository;\n+import de.tum.in.www1.artemis.web.rest.dto.SubmissionExportOptionsDTO;\n+\n+@Service\n+public abstract class SubmissionExportService {\n+\n+    private final Logger log = LoggerFactory.getLogger(SubmissionExportService.class);\n+\n+    private final ExerciseRepository exerciseRepository;\n+\n+    public SubmissionExportService(ExerciseRepository exerciseRepository) {\n+        this.exerciseRepository = exerciseRepository;\n+    }\n+\n+    @Value(\"${artemis.submission-export-path}\")\n+    private String SUBMISSION_EXPORT_PATH;\n+\n+    /**\n+     * Exports student submissions to a zip file for an exercise\n+     * @param exerciseId the id of the exercise to be exported\n+     * @param submissionExportOptions the options for the expot\n+     * @return a reference to the zipped file\n+     * @throws IOException\n+     */\n+    @Nullable\n+    public File exportStudentSubmissions(Long exerciseId, SubmissionExportOptionsDTO submissionExportOptions) throws IOException {\n+\n+        Optional<Exercise> exerciseOpt = exerciseRepository.findWithEagerStudentParticipationsStudentAndSubmissionsById(exerciseId);\n+\n+        if (exerciseOpt.isEmpty())\n+            return null;\n+\n+        Exercise exercise = exerciseOpt.get();\n+\n+        // Select the participations that should be exported\n+        List<StudentParticipation> exportedStudentParticipations;\n+\n+        if (submissionExportOptions.isExportAllParticipants()) {\n+            exportedStudentParticipations = new ArrayList<>(exercise.getStudentParticipations());\n+        }\n+        else {\n+            List<String> participantIds = Arrays.stream(submissionExportOptions.getParticipantIdentifierList().split(\",\")).map(String::trim).collect(Collectors.toList());\n+\n+            exportedStudentParticipations = exercise.getStudentParticipations().stream().filter(participation -> participantIds.contains(participation.getParticipantIdentifier()))\n+                    .collect(Collectors.toList());\n+        }\n+\n+        if (exportedStudentParticipations.isEmpty()) {\n+            return null;\n+        }\n+\n+        ZonedDateTime filterLateSubmissionsDate = null;\n+        if (submissionExportOptions.isFilterLateSubmissions()) {\n+            if (submissionExportOptions.getFilterLateSubmissionsDate() == null) {\n+                filterLateSubmissionsDate = exercise.getDueDate();\n+            }\n+            else {\n+                filterLateSubmissionsDate = submissionExportOptions.getFilterLateSubmissionsDate();\n+            }\n+        }\n+\n+        return this.createZipFileFromParticipations(exercise, exportedStudentParticipations, filterLateSubmissionsDate);\n+\n+    }\n+\n+    /**\n+     * Creates a zip file from a list of participations for an exercise\n+     * @param exercise the exercise in question\n+     * @param participations a list of participations to include\n+     * @param lateSubmissionFilter an optional date filter for submissions\n+     * @return the zipped file\n+     * @throws IOException\n+     */\n+    @Nullable\n+    private File createZipFileFromParticipations(Exercise exercise, List<StudentParticipation> participations, @Nullable ZonedDateTime lateSubmissionFilter) throws IOException {\n+\n+        Course course = exercise.getCourseViaExerciseGroupOrCourseMember();\n+\n+        String zipGroupName = course.getTitle() + \"-\" + exercise.getTitle() + \"-submissions\";\n+        String zipFileName = zipGroupName + \"-\" + ZonedDateTime.now(ZoneOffset.UTC).format(DateTimeFormatter.ISO_INSTANT) + \".zip\";\n+\n+        Path submissionsFolderPath = Paths.get(SUBMISSION_EXPORT_PATH, \"zippedSubmissions\", zipGroupName);\n+        Path zipFilePath = Paths.get(SUBMISSION_EXPORT_PATH, \"zippedSubmissions\", zipFileName);\n+\n+        // Save all Submissions\n+        List<Path> submissionFilePaths = participations.stream().map((participation) -> {\n+\n+            Set<Submission> submissions = participation.getSubmissions();\n+            Submission latestSubmission = null;\n+\n+            for (Submission s : submissions) {\n+                if (lateSubmissionFilter == null || s.getSubmissionDate().isBefore(lateSubmissionFilter)) {\n+                    if (latestSubmission == null || s.getSubmissionDate().isAfter(latestSubmission.getSubmissionDate())) {\n+                        latestSubmission = s;\n+                    }\n+                }\n+            }\n+\n+            if (latestSubmission == null)\n+                return Optional.<Path>empty();\n+\n+            String submissionFileName = exercise.getTitle() + \"-\" + participation.getParticipantIdentifier() + \"-\" + latestSubmission.getId()\n+                    + this.getFileEndingForSubmission(latestSubmission);\n+            Path submissionFilePath = Paths.get(submissionsFolderPath.toString(), submissionFileName);\n+\n+            try {\n+\n+                File parent = submissionFilePath.getParent().toFile();\n+                if (!parent.exists() && !parent.mkdirs()) {\n+                    log.error(\"Couldn't create dir: \" + parent);\n+                    return Optional.<Path>empty();\n+                }\n+\n+                this.saveSubmissionToFile(exercise, latestSubmission, submissionFilePath.toFile());\n+                return Optional.of(submissionFilePath);\n+\n+            }\n+            catch (IOException ioException) {\n+                log.error(\"Could not create file \" + submissionFilePath.toString() + \"for exporting: \" + ioException.getMessage());\n+                return Optional.<Path>empty();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723144a5aa43cc6147471925ee15811a77160fcd"}, "originalPosition": 150}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNDA2OTU4OnYy", "diffSide": "RIGHT", "path": "src/main/java/de/tum/in/www1/artemis/service/SubmissionExportService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNTo0NjowNlrOGv8Wdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNTo0NjowNlrOGv8Wdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjkyNTA0Ng==", "bodyText": "Shouldn't this folder already exist because zipFilePath parent is \".../zippedSubmissions\" and submissionFolderPath was already created and contains the path segment \".../zippedSubmissions\"?", "url": "https://github.com/ls1intum/Artemis/pull/1835#discussion_r452925046", "createdAt": "2020-07-10T15:46:06Z", "author": {"login": "kloessst"}, "path": "src/main/java/de/tum/in/www1/artemis/service/SubmissionExportService.java", "diffHunk": "@@ -0,0 +1,249 @@\n+package de.tum.in.www1.artemis.service;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.ZoneOffset;\n+import java.time.ZonedDateTime;\n+import java.time.format.DateTimeFormatter;\n+import java.util.*;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+import java.util.stream.Collectors;\n+import java.util.zip.ZipEntry;\n+import java.util.zip.ZipOutputStream;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Service;\n+\n+import de.tum.in.www1.artemis.domain.Course;\n+import de.tum.in.www1.artemis.domain.Exercise;\n+import de.tum.in.www1.artemis.domain.Submission;\n+import de.tum.in.www1.artemis.domain.participation.StudentParticipation;\n+import de.tum.in.www1.artemis.repository.ExerciseRepository;\n+import de.tum.in.www1.artemis.web.rest.dto.SubmissionExportOptionsDTO;\n+\n+@Service\n+public abstract class SubmissionExportService {\n+\n+    private final Logger log = LoggerFactory.getLogger(SubmissionExportService.class);\n+\n+    private final ExerciseRepository exerciseRepository;\n+\n+    public SubmissionExportService(ExerciseRepository exerciseRepository) {\n+        this.exerciseRepository = exerciseRepository;\n+    }\n+\n+    @Value(\"${artemis.submission-export-path}\")\n+    private String SUBMISSION_EXPORT_PATH;\n+\n+    /**\n+     * Exports student submissions to a zip file for an exercise\n+     * @param exerciseId the id of the exercise to be exported\n+     * @param submissionExportOptions the options for the expot\n+     * @return a reference to the zipped file\n+     * @throws IOException\n+     */\n+    @Nullable\n+    public File exportStudentSubmissions(Long exerciseId, SubmissionExportOptionsDTO submissionExportOptions) throws IOException {\n+\n+        Optional<Exercise> exerciseOpt = exerciseRepository.findWithEagerStudentParticipationsStudentAndSubmissionsById(exerciseId);\n+\n+        if (exerciseOpt.isEmpty())\n+            return null;\n+\n+        Exercise exercise = exerciseOpt.get();\n+\n+        // Select the participations that should be exported\n+        List<StudentParticipation> exportedStudentParticipations;\n+\n+        if (submissionExportOptions.isExportAllParticipants()) {\n+            exportedStudentParticipations = new ArrayList<>(exercise.getStudentParticipations());\n+        }\n+        else {\n+            List<String> participantIds = Arrays.stream(submissionExportOptions.getParticipantIdentifierList().split(\",\")).map(String::trim).collect(Collectors.toList());\n+\n+            exportedStudentParticipations = exercise.getStudentParticipations().stream().filter(participation -> participantIds.contains(participation.getParticipantIdentifier()))\n+                    .collect(Collectors.toList());\n+        }\n+\n+        if (exportedStudentParticipations.isEmpty()) {\n+            return null;\n+        }\n+\n+        ZonedDateTime filterLateSubmissionsDate = null;\n+        if (submissionExportOptions.isFilterLateSubmissions()) {\n+            if (submissionExportOptions.getFilterLateSubmissionsDate() == null) {\n+                filterLateSubmissionsDate = exercise.getDueDate();\n+            }\n+            else {\n+                filterLateSubmissionsDate = submissionExportOptions.getFilterLateSubmissionsDate();\n+            }\n+        }\n+\n+        return this.createZipFileFromParticipations(exercise, exportedStudentParticipations, filterLateSubmissionsDate);\n+\n+    }\n+\n+    /**\n+     * Creates a zip file from a list of participations for an exercise\n+     * @param exercise the exercise in question\n+     * @param participations a list of participations to include\n+     * @param lateSubmissionFilter an optional date filter for submissions\n+     * @return the zipped file\n+     * @throws IOException\n+     */\n+    @Nullable\n+    private File createZipFileFromParticipations(Exercise exercise, List<StudentParticipation> participations, @Nullable ZonedDateTime lateSubmissionFilter) throws IOException {\n+\n+        Course course = exercise.getCourseViaExerciseGroupOrCourseMember();\n+\n+        String zipGroupName = course.getTitle() + \"-\" + exercise.getTitle() + \"-submissions\";\n+        String zipFileName = zipGroupName + \"-\" + ZonedDateTime.now(ZoneOffset.UTC).format(DateTimeFormatter.ISO_INSTANT) + \".zip\";\n+\n+        Path submissionsFolderPath = Paths.get(SUBMISSION_EXPORT_PATH, \"zippedSubmissions\", zipGroupName);\n+        Path zipFilePath = Paths.get(SUBMISSION_EXPORT_PATH, \"zippedSubmissions\", zipFileName);\n+\n+        // Save all Submissions\n+        List<Path> submissionFilePaths = participations.stream().map((participation) -> {\n+\n+            Set<Submission> submissions = participation.getSubmissions();\n+            Submission latestSubmission = null;\n+\n+            for (Submission s : submissions) {\n+                if (lateSubmissionFilter == null || s.getSubmissionDate().isBefore(lateSubmissionFilter)) {\n+                    if (latestSubmission == null || s.getSubmissionDate().isAfter(latestSubmission.getSubmissionDate())) {\n+                        latestSubmission = s;\n+                    }\n+                }\n+            }\n+\n+            if (latestSubmission == null)\n+                return Optional.<Path>empty();\n+\n+            String submissionFileName = exercise.getTitle() + \"-\" + participation.getParticipantIdentifier() + \"-\" + latestSubmission.getId()\n+                    + this.getFileEndingForSubmission(latestSubmission);\n+            Path submissionFilePath = Paths.get(submissionsFolderPath.toString(), submissionFileName);\n+\n+            try {\n+\n+                File parent = submissionFilePath.getParent().toFile();\n+                if (!parent.exists() && !parent.mkdirs()) {\n+                    log.error(\"Couldn't create dir: \" + parent);\n+                    return Optional.<Path>empty();\n+                }\n+\n+                this.saveSubmissionToFile(exercise, latestSubmission, submissionFilePath.toFile());\n+                return Optional.of(submissionFilePath);\n+\n+            }\n+            catch (IOException ioException) {\n+                log.error(\"Could not create file \" + submissionFilePath.toString() + \"for exporting: \" + ioException.getMessage());\n+                return Optional.<Path>empty();\n+            }\n+\n+        }).filter(Optional::isPresent).map(Optional::get).collect(Collectors.toList());\n+\n+        if (submissionFilePaths.isEmpty())\n+            return null;\n+\n+        try {\n+\n+            File parent = zipFilePath.getParent().toFile();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723144a5aa43cc6147471925ee15811a77160fcd"}, "originalPosition": 160}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNDExMDMzOnYy", "diffSide": "RIGHT", "path": "src/main/java/de/tum/in/www1/artemis/service/SubmissionExportService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNTo1NzozNVrOGv8vvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNTo1NzozNVrOGv8vvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjkzMTUxNw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @param paths the paths that should be zipped\n          \n          \n            \n                 * @param paths the paths that should be zipped\n          \n          \n            \n                 * @param pathsRoot the root path relative to <code>paths</code>", "url": "https://github.com/ls1intum/Artemis/pull/1835#discussion_r452931517", "createdAt": "2020-07-10T15:57:35Z", "author": {"login": "kloessst"}, "path": "src/main/java/de/tum/in/www1/artemis/service/SubmissionExportService.java", "diffHunk": "@@ -0,0 +1,249 @@\n+package de.tum.in.www1.artemis.service;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.ZoneOffset;\n+import java.time.ZonedDateTime;\n+import java.time.format.DateTimeFormatter;\n+import java.util.*;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+import java.util.stream.Collectors;\n+import java.util.zip.ZipEntry;\n+import java.util.zip.ZipOutputStream;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Service;\n+\n+import de.tum.in.www1.artemis.domain.Course;\n+import de.tum.in.www1.artemis.domain.Exercise;\n+import de.tum.in.www1.artemis.domain.Submission;\n+import de.tum.in.www1.artemis.domain.participation.StudentParticipation;\n+import de.tum.in.www1.artemis.repository.ExerciseRepository;\n+import de.tum.in.www1.artemis.web.rest.dto.SubmissionExportOptionsDTO;\n+\n+@Service\n+public abstract class SubmissionExportService {\n+\n+    private final Logger log = LoggerFactory.getLogger(SubmissionExportService.class);\n+\n+    private final ExerciseRepository exerciseRepository;\n+\n+    public SubmissionExportService(ExerciseRepository exerciseRepository) {\n+        this.exerciseRepository = exerciseRepository;\n+    }\n+\n+    @Value(\"${artemis.submission-export-path}\")\n+    private String SUBMISSION_EXPORT_PATH;\n+\n+    /**\n+     * Exports student submissions to a zip file for an exercise\n+     * @param exerciseId the id of the exercise to be exported\n+     * @param submissionExportOptions the options for the expot\n+     * @return a reference to the zipped file\n+     * @throws IOException\n+     */\n+    @Nullable\n+    public File exportStudentSubmissions(Long exerciseId, SubmissionExportOptionsDTO submissionExportOptions) throws IOException {\n+\n+        Optional<Exercise> exerciseOpt = exerciseRepository.findWithEagerStudentParticipationsStudentAndSubmissionsById(exerciseId);\n+\n+        if (exerciseOpt.isEmpty())\n+            return null;\n+\n+        Exercise exercise = exerciseOpt.get();\n+\n+        // Select the participations that should be exported\n+        List<StudentParticipation> exportedStudentParticipations;\n+\n+        if (submissionExportOptions.isExportAllParticipants()) {\n+            exportedStudentParticipations = new ArrayList<>(exercise.getStudentParticipations());\n+        }\n+        else {\n+            List<String> participantIds = Arrays.stream(submissionExportOptions.getParticipantIdentifierList().split(\",\")).map(String::trim).collect(Collectors.toList());\n+\n+            exportedStudentParticipations = exercise.getStudentParticipations().stream().filter(participation -> participantIds.contains(participation.getParticipantIdentifier()))\n+                    .collect(Collectors.toList());\n+        }\n+\n+        if (exportedStudentParticipations.isEmpty()) {\n+            return null;\n+        }\n+\n+        ZonedDateTime filterLateSubmissionsDate = null;\n+        if (submissionExportOptions.isFilterLateSubmissions()) {\n+            if (submissionExportOptions.getFilterLateSubmissionsDate() == null) {\n+                filterLateSubmissionsDate = exercise.getDueDate();\n+            }\n+            else {\n+                filterLateSubmissionsDate = submissionExportOptions.getFilterLateSubmissionsDate();\n+            }\n+        }\n+\n+        return this.createZipFileFromParticipations(exercise, exportedStudentParticipations, filterLateSubmissionsDate);\n+\n+    }\n+\n+    /**\n+     * Creates a zip file from a list of participations for an exercise\n+     * @param exercise the exercise in question\n+     * @param participations a list of participations to include\n+     * @param lateSubmissionFilter an optional date filter for submissions\n+     * @return the zipped file\n+     * @throws IOException\n+     */\n+    @Nullable\n+    private File createZipFileFromParticipations(Exercise exercise, List<StudentParticipation> participations, @Nullable ZonedDateTime lateSubmissionFilter) throws IOException {\n+\n+        Course course = exercise.getCourseViaExerciseGroupOrCourseMember();\n+\n+        String zipGroupName = course.getTitle() + \"-\" + exercise.getTitle() + \"-submissions\";\n+        String zipFileName = zipGroupName + \"-\" + ZonedDateTime.now(ZoneOffset.UTC).format(DateTimeFormatter.ISO_INSTANT) + \".zip\";\n+\n+        Path submissionsFolderPath = Paths.get(SUBMISSION_EXPORT_PATH, \"zippedSubmissions\", zipGroupName);\n+        Path zipFilePath = Paths.get(SUBMISSION_EXPORT_PATH, \"zippedSubmissions\", zipFileName);\n+\n+        // Save all Submissions\n+        List<Path> submissionFilePaths = participations.stream().map((participation) -> {\n+\n+            Set<Submission> submissions = participation.getSubmissions();\n+            Submission latestSubmission = null;\n+\n+            for (Submission s : submissions) {\n+                if (lateSubmissionFilter == null || s.getSubmissionDate().isBefore(lateSubmissionFilter)) {\n+                    if (latestSubmission == null || s.getSubmissionDate().isAfter(latestSubmission.getSubmissionDate())) {\n+                        latestSubmission = s;\n+                    }\n+                }\n+            }\n+\n+            if (latestSubmission == null)\n+                return Optional.<Path>empty();\n+\n+            String submissionFileName = exercise.getTitle() + \"-\" + participation.getParticipantIdentifier() + \"-\" + latestSubmission.getId()\n+                    + this.getFileEndingForSubmission(latestSubmission);\n+            Path submissionFilePath = Paths.get(submissionsFolderPath.toString(), submissionFileName);\n+\n+            try {\n+\n+                File parent = submissionFilePath.getParent().toFile();\n+                if (!parent.exists() && !parent.mkdirs()) {\n+                    log.error(\"Couldn't create dir: \" + parent);\n+                    return Optional.<Path>empty();\n+                }\n+\n+                this.saveSubmissionToFile(exercise, latestSubmission, submissionFilePath.toFile());\n+                return Optional.of(submissionFilePath);\n+\n+            }\n+            catch (IOException ioException) {\n+                log.error(\"Could not create file \" + submissionFilePath.toString() + \"for exporting: \" + ioException.getMessage());\n+                return Optional.<Path>empty();\n+            }\n+\n+        }).filter(Optional::isPresent).map(Optional::get).collect(Collectors.toList());\n+\n+        if (submissionFilePaths.isEmpty())\n+            return null;\n+\n+        try {\n+\n+            File parent = zipFilePath.getParent().toFile();\n+            if (!parent.exists() && !parent.mkdirs()) {\n+                log.error(\"Couldn't create dir: \" + parent);\n+                return null;\n+            }\n+\n+            createZipFile(zipFilePath, submissionFilePaths, submissionsFolderPath);\n+        }\n+        finally {\n+            deleteTempFiles(submissionFilePaths);\n+        }\n+\n+        scheduleForDeletion(zipFilePath, 15);\n+\n+        return zipFilePath.toFile();\n+    }\n+\n+    protected abstract void saveSubmissionToFile(Exercise exercise, Submission submission, File file) throws IOException;\n+\n+    protected abstract String getFileEndingForSubmission(Submission submission);\n+\n+    /**\n+     * Create a zipfile of the given paths and save it in the zipFilePath\n+     *\n+     * @param zipFilePath path where the zip file should be saved\n+     * @param paths the paths that should be zipped", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723144a5aa43cc6147471925ee15811a77160fcd"}, "originalPosition": 185}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNDIxMDUyOnYy", "diffSide": "RIGHT", "path": "src/main/webapp/app/exercises/shared/submission-export/submission-export-dialog.component.html", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNjoyODoyOFrOGv9u_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNjoyODoyOFrOGv9u_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk0NzcxMA==", "bodyText": "Should also check this on the server. if submissionExportOptions.exportAllParticipants is true but the user is just TA return forbidden()", "url": "https://github.com/ls1intum/Artemis/pull/1835#discussion_r452947710", "createdAt": "2020-07-10T16:28:28Z", "author": {"login": "kloessst"}, "path": "src/main/webapp/app/exercises/shared/submission-export/submission-export-dialog.component.html", "diffHunk": "@@ -0,0 +1,69 @@\n+<form *ngIf=\"!isLoading; else loadingContainer\" name=\"exportForm\" role=\"form\" (ngSubmit)=\"exportSubmissions(exercise.id)\" #exportForm=\"ngForm\">\n+    <div class=\"modal-header\">\n+        <h4 class=\"modal-title\" jhiTranslate=\"instructorDashboard.exportSubmissions.title\">Confirm export operation</h4>\n+        <button type=\"button\" class=\"close\" data-dismiss=\"modal\" (click)=\"clear()\">&times;</button>\n+    </div>\n+    <div class=\"modal-body\">\n+        <jhi-alert-error></jhi-alert-error>\n+        <p [jhiTranslate]=\"'instructorDashboard.exportSubmissions.question'\" [translateValues]=\"{ exerciseTitle: exercise.title, courseTitle: exercise.course?.title }\">\n+            Confirm export\n+        </p>\n+        <textarea\n+            name=\"studentIds\"\n+            class=\"export-textarea\"\n+            [(ngModel)]=\"submissionExportOptions.participantIdentifierList\"\n+            required\n+            [disabled]=\"submissionExportOptions.exportAllParticipants\"\n+        ></textarea>\n+\n+        <!--\n+        Only show download all checkbox for instructors & admins.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723144a5aa43cc6147471925ee15811a77160fcd"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNDIzMDgyOnYy", "diffSide": "RIGHT", "path": "src/main/webapp/app/exercises/shared/submission-export/submission-export-dialog.component.html", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNjozNDo1MlrOGv973Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNjozNDo1MlrOGv973Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk1MTAwNQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        [disabled]=\"!submissionExportOptions.participantIdentifierList && !submissionExportOptions.exportAllParticipants && !exportInProgress\"\n          \n          \n            \n                        [disabled]=\"(!submissionExportOptions.participantIdentifierList && !submissionExportOptions.exportAllParticipants) || exportInProgress\"", "url": "https://github.com/ls1intum/Artemis/pull/1835#discussion_r452951005", "createdAt": "2020-07-10T16:34:52Z", "author": {"login": "kloessst"}, "path": "src/main/webapp/app/exercises/shared/submission-export/submission-export-dialog.component.html", "diffHunk": "@@ -0,0 +1,69 @@\n+<form *ngIf=\"!isLoading; else loadingContainer\" name=\"exportForm\" role=\"form\" (ngSubmit)=\"exportSubmissions(exercise.id)\" #exportForm=\"ngForm\">\n+    <div class=\"modal-header\">\n+        <h4 class=\"modal-title\" jhiTranslate=\"instructorDashboard.exportSubmissions.title\">Confirm export operation</h4>\n+        <button type=\"button\" class=\"close\" data-dismiss=\"modal\" (click)=\"clear()\">&times;</button>\n+    </div>\n+    <div class=\"modal-body\">\n+        <jhi-alert-error></jhi-alert-error>\n+        <p [jhiTranslate]=\"'instructorDashboard.exportSubmissions.question'\" [translateValues]=\"{ exerciseTitle: exercise.title, courseTitle: exercise.course?.title }\">\n+            Confirm export\n+        </p>\n+        <textarea\n+            name=\"studentIds\"\n+            class=\"export-textarea\"\n+            [(ngModel)]=\"submissionExportOptions.participantIdentifierList\"\n+            required\n+            [disabled]=\"submissionExportOptions.exportAllParticipants\"\n+        ></textarea>\n+\n+        <!--\n+        Only show download all checkbox for instructors & admins.\n+        -->\n+        <ng-container>\n+            <div *jhiHasAnyAuthority=\"['ROLE_ADMIN', 'ROLE_INSTRUCTOR']\" class=\"checkbox\">\n+                <label class=\"control-label\">\n+                    <input type=\"checkbox\" name=\"allStudents\" [(ngModel)]=\"submissionExportOptions.exportAllParticipants\" />\n+                    <strong [jhiTranslate]=\"'instructorDashboard.exportSubmissions.downloadAllStudents'\">\n+                        Or download the submissions of all students }}\n+                    </strong>\n+                </label>\n+            </div>\n+        </ng-container>\n+        <ng-container>\n+            <div class=\"checkbox\">\n+                <label class=\"control-label\">\n+                    <input type=\"checkbox\" name=\"filterLateSubmissions\" [(ngModel)]=\"this.submissionExportOptions.filterLateSubmissions\" />\n+                    <strong jhiTranslate=\"instructorDashboard.exportSubmissions.filterLateSubmissions\">Filter late submissions</strong>\n+                </label>\n+            </div>\n+            <div class=\"form-group\">\n+                <strong jhiTranslate=\"instructorDashboard.exportSubmissions.filterLateSubmissionsDate\"\n+                    >Date for filter late submissions (defaults to exercise due date if not set)</strong\n+                >\n+                <jhi-date-time-picker\n+                    [(ngModel)]=\"this.submissionExportOptions.filterLateSubmissionsDate\"\n+                    [disabled]=\"!this.submissionExportOptions.filterLateSubmissions\"\n+                    name=\"filterLateSubmissionsDate\"\n+                ></jhi-date-time-picker>\n+            </div>\n+        </ng-container>\n+    </div>\n+    <div class=\"modal-footer\">\n+        <button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\" (click)=\"clear()\">\n+            <span class=\"glyphicon glyphicon-ban-circle\"></span>&nbsp;<span jhiTranslate=\"entity.action.cancel\">Cancel</span>\n+        </button>\n+        <button\n+            type=\"submit\"\n+            [disabled]=\"!submissionExportOptions.participantIdentifierList && !submissionExportOptions.exportAllParticipants && !exportInProgress\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723144a5aa43cc6147471925ee15811a77160fcd"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNDI3MjYzOnYy", "diffSide": "RIGHT", "path": "src/main/webapp/i18n/de/instructorDashboard.json", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNjo0ODo0NVrOGv-WVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNjo0ODo0NVrOGv-WVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk1Nzc4Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        \"question\": \"Tragen sie hier alle Kennungen der Studenten ein, die heruntergeladen werden sollen getrennt durch ein Komma (z.B. ga87fix,ga63dut)\",\n          \n          \n            \n                        \"question\": \"Tragen sie hier alle Kennungen der Studenten getrennt durch ein Komma ein, deren Abgaben heruntergeladen werden sollen (z.B. ga87fix,ga63dut)\",", "url": "https://github.com/ls1intum/Artemis/pull/1835#discussion_r452957782", "createdAt": "2020-07-10T16:48:45Z", "author": {"login": "kloessst"}, "path": "src/main/webapp/i18n/de/instructorDashboard.json", "diffHunk": "@@ -34,6 +34,14 @@\n             \"timeWarning\": \"<b>Achtung:</b> Diese Aktion kann abh\u00e4ngig von Gr\u00f6\u00dfe und Anzahl der Repositories mehrere Minuten dauern.\"\n         },\n         \"exportCSV\": \"Als CSV exportieren\",\n+        \"exportSubmissions\": {\n+            \"title\": \"Abgaben exportieren\",\n+            \"downloadAllStudents\": \"Oder lade die Abgaben aller Studenten herunter\",\n+            \"question\": \"Tragen sie hier alle Kennungen der Studenten ein, die heruntergeladen werden sollen getrennt durch ein Komma (z.B. ga87fix,ga63dut)\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723144a5aa43cc6147471925ee15811a77160fcd"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNzEwMjYzOnYy", "diffSide": "RIGHT", "path": "src/main/java/de/tum/in/www1/artemis/service/FileUploadSubmissionExportService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQxNjo0MDo0OVrOGwVjdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQxNjo0MDo0OVrOGwVjdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzMzNzk3NQ==", "bodyText": "Please use { and }.", "url": "https://github.com/ls1intum/Artemis/pull/1835#discussion_r453337975", "createdAt": "2020-07-12T16:40:49Z", "author": {"login": "sleiss"}, "path": "src/main/java/de/tum/in/www1/artemis/service/FileUploadSubmissionExportService.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package de.tum.in.www1.artemis.service;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+\n+import org.springframework.stereotype.Service;\n+\n+import de.tum.in.www1.artemis.domain.Exercise;\n+import de.tum.in.www1.artemis.domain.FileUploadSubmission;\n+import de.tum.in.www1.artemis.domain.Submission;\n+import de.tum.in.www1.artemis.repository.ExerciseRepository;\n+\n+@Service\n+public class FileUploadSubmissionExportService extends SubmissionExportService {\n+\n+    public FileUploadSubmissionExportService(ExerciseRepository exerciseRepository) {\n+        super(exerciseRepository);\n+    }\n+\n+    @Override\n+    protected void saveSubmissionToFile(Exercise exercise, Submission submission, File file) throws IOException {\n+\n+        if (((FileUploadSubmission) submission).getFilePath() == null) {\n+            throw new IOException(\"Could not find uploaded file for submission.\");\n+        }\n+\n+        // we need to get the 'real' file path here, the submission only has the api url path\n+        String filePath = FileUploadSubmission.buildFilePath(exercise.getId(), submission.getId());\n+        String[] apiFilePathParts = ((FileUploadSubmission) submission).getFilePath().split(\"/\");\n+\n+        Path submissionPath = Path.of(filePath, apiFilePathParts[apiFilePathParts.length - 1]);\n+\n+        if (!submissionPath.toFile().exists()) // throw if submission file does not exist", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce3cc6c0bb94d75070e9519a0216c784e5feef5a"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNzEwMjk5OnYy", "diffSide": "RIGHT", "path": "src/main/java/de/tum/in/www1/artemis/service/ModelingSubmissionExportService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQxNjo0MToyM1rOGwVjqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQxNjo0MToyM1rOGwVjqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzMzODAyNQ==", "bodyText": "Please use { and }.", "url": "https://github.com/ls1intum/Artemis/pull/1835#discussion_r453338025", "createdAt": "2020-07-12T16:41:23Z", "author": {"login": "sleiss"}, "path": "src/main/java/de/tum/in/www1/artemis/service/ModelingSubmissionExportService.java", "diffHunk": "@@ -0,0 +1,39 @@\n+package de.tum.in.www1.artemis.service;\n+\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+\n+import org.springframework.stereotype.Service;\n+\n+import de.tum.in.www1.artemis.domain.Exercise;\n+import de.tum.in.www1.artemis.domain.Submission;\n+import de.tum.in.www1.artemis.domain.modeling.ModelingSubmission;\n+import de.tum.in.www1.artemis.repository.ExerciseRepository;\n+\n+@Service\n+public class ModelingSubmissionExportService extends SubmissionExportService {\n+\n+    public ModelingSubmissionExportService(ExerciseRepository exerciseRepository) {\n+        super(exerciseRepository);\n+    }\n+\n+    @Override\n+    protected void saveSubmissionToFile(Exercise exercise, Submission submission, File file) throws IOException {\n+        if (((ModelingSubmission) submission).getModel() == null) {\n+            if (!file.exists())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce3cc6c0bb94d75070e9519a0216c784e5feef5a"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNzEwMzg0OnYy", "diffSide": "RIGHT", "path": "src/main/java/de/tum/in/www1/artemis/service/SubmissionExportService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQxNjo0MjoyNVrOGwVkFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQxNjo0MjoyNVrOGwVkFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzMzODEzNQ==", "bodyText": "Please use { and }.", "url": "https://github.com/ls1intum/Artemis/pull/1835#discussion_r453338135", "createdAt": "2020-07-12T16:42:25Z", "author": {"login": "sleiss"}, "path": "src/main/java/de/tum/in/www1/artemis/service/SubmissionExportService.java", "diffHunk": "@@ -0,0 +1,242 @@\n+package de.tum.in.www1.artemis.service;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.ZoneOffset;\n+import java.time.ZonedDateTime;\n+import java.time.format.DateTimeFormatter;\n+import java.util.*;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+import java.util.stream.Collectors;\n+import java.util.zip.ZipEntry;\n+import java.util.zip.ZipOutputStream;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Service;\n+\n+import de.tum.in.www1.artemis.domain.Course;\n+import de.tum.in.www1.artemis.domain.Exercise;\n+import de.tum.in.www1.artemis.domain.Submission;\n+import de.tum.in.www1.artemis.domain.participation.StudentParticipation;\n+import de.tum.in.www1.artemis.repository.ExerciseRepository;\n+import de.tum.in.www1.artemis.web.rest.dto.SubmissionExportOptionsDTO;\n+\n+@Service\n+public abstract class SubmissionExportService {\n+\n+    private final Logger log = LoggerFactory.getLogger(SubmissionExportService.class);\n+\n+    private final ExerciseRepository exerciseRepository;\n+\n+    public SubmissionExportService(ExerciseRepository exerciseRepository) {\n+        this.exerciseRepository = exerciseRepository;\n+    }\n+\n+    @Value(\"${artemis.submission-export-path}\")\n+    private String SUBMISSION_EXPORT_PATH;\n+\n+    /**\n+     * Exports student submissions to a zip file for an exercise\n+     * @param exerciseId the id of the exercise to be exported\n+     * @param submissionExportOptions the options for the expot\n+     * @return a reference to the zipped file\n+     * @throws IOException\n+     */\n+    public Optional<File> exportStudentSubmissions(Long exerciseId, SubmissionExportOptionsDTO submissionExportOptions) throws IOException {\n+\n+        Optional<Exercise> exerciseOpt = exerciseRepository.findWithEagerStudentParticipationsStudentAndSubmissionsById(exerciseId);\n+\n+        if (exerciseOpt.isEmpty()) {\n+            return Optional.empty();\n+        }\n+\n+        Exercise exercise = exerciseOpt.get();\n+\n+        // Select the participations that should be exported\n+        List<StudentParticipation> exportedStudentParticipations;\n+\n+        if (submissionExportOptions.isExportAllParticipants()) {\n+            exportedStudentParticipations = new ArrayList<>(exercise.getStudentParticipations());\n+        }\n+        else {\n+            List<String> participantIds = Arrays.stream(submissionExportOptions.getParticipantIdentifierList().split(\",\")).map(String::trim).collect(Collectors.toList());\n+\n+            exportedStudentParticipations = exercise.getStudentParticipations().stream().filter(participation -> participantIds.contains(participation.getParticipantIdentifier()))\n+                    .collect(Collectors.toList());\n+        }\n+\n+        if (exportedStudentParticipations.isEmpty()) {\n+            return Optional.empty();\n+        }\n+\n+        ZonedDateTime filterLateSubmissionsDate = null;\n+        if (submissionExportOptions.isFilterLateSubmissions()) {\n+            if (submissionExportOptions.getFilterLateSubmissionsDate() == null) {\n+                filterLateSubmissionsDate = exercise.getDueDate();\n+            }\n+            else {\n+                filterLateSubmissionsDate = submissionExportOptions.getFilterLateSubmissionsDate();\n+            }\n+        }\n+\n+        return this.createZipFileFromParticipations(exercise, exportedStudentParticipations, filterLateSubmissionsDate);\n+\n+    }\n+\n+    /**\n+     * Creates a zip file from a list of participations for an exercise\n+     * @param exercise the exercise in question\n+     * @param participations a list of participations to include\n+     * @param lateSubmissionFilter an optional date filter for submissions\n+     * @return the zipped file\n+     * @throws IOException\n+     */\n+    private Optional<File> createZipFileFromParticipations(Exercise exercise, List<StudentParticipation> participations, @Nullable ZonedDateTime lateSubmissionFilter)\n+            throws IOException {\n+\n+        Course course = exercise.getCourseViaExerciseGroupOrCourseMember();\n+\n+        String zipGroupName = course.getTitle() + \"-\" + exercise.getTitle() + \"-submissions\";\n+        String zipFileName = zipGroupName + \"-\" + ZonedDateTime.now(ZoneOffset.UTC).format(DateTimeFormatter.ISO_INSTANT) + \".zip\";\n+\n+        Path submissionsFolderPath = Paths.get(SUBMISSION_EXPORT_PATH, \"zippedSubmissions\", zipGroupName);\n+        Path zipFilePath = Paths.get(SUBMISSION_EXPORT_PATH, \"zippedSubmissions\", zipFileName);\n+\n+        File submissionFolder = submissionsFolderPath.toFile();\n+        if (!submissionFolder.exists() && !submissionFolder.mkdirs()) {\n+            log.error(\"Couldn't create dir: \" + submissionFolder);\n+            return Optional.empty();\n+        }\n+\n+        // Save all Submissions\n+        List<Path> submissionFilePaths = participations.stream().map((participation) -> {\n+\n+            Set<Submission> submissions = participation.getSubmissions();\n+            Submission latestSubmission = null;\n+\n+            for (Submission s : submissions) {\n+                if (lateSubmissionFilter == null || s.getSubmissionDate().isBefore(lateSubmissionFilter)) {\n+                    if (latestSubmission == null || s.getSubmissionDate().isAfter(latestSubmission.getSubmissionDate())) {\n+                        latestSubmission = s;\n+                    }\n+                }\n+            }\n+\n+            if (latestSubmission == null) {\n+                return Optional.<Path>empty();\n+            }\n+\n+            String submissionFileName = exercise.getTitle() + \"-\" + participation.getParticipantIdentifier() + \"-\" + latestSubmission.getId()\n+                    + this.getFileEndingForSubmission(latestSubmission);\n+            Path submissionFilePath = Paths.get(submissionsFolderPath.toString(), submissionFileName);\n+\n+            try {\n+                this.saveSubmissionToFile(exercise, latestSubmission, submissionFilePath.toFile());\n+                return Optional.of(submissionFilePath);\n+            }\n+            catch (IOException ioException) {\n+                log.error(\"Could not create file \" + submissionFilePath.toString() + \" for exporting: \" + ioException.getMessage());\n+                return Optional.<Path>empty();\n+            }\n+\n+        }).filter(Optional::isPresent).map(Optional::get).collect(Collectors.toList());\n+\n+        if (submissionFilePaths.isEmpty())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce3cc6c0bb94d75070e9519a0216c784e5feef5a"}, "originalPosition": 154}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNzEwNDE5OnYy", "diffSide": "RIGHT", "path": "src/main/java/de/tum/in/www1/artemis/service/TextSubmissionExportService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQxNjo0Mjo1N1rOGwVkPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQxNjo0Mjo1N1rOGwVkPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzMzODE3NQ==", "bodyText": "Please use { and }.", "url": "https://github.com/ls1intum/Artemis/pull/1835#discussion_r453338175", "createdAt": "2020-07-12T16:42:57Z", "author": {"login": "sleiss"}, "path": "src/main/java/de/tum/in/www1/artemis/service/TextSubmissionExportService.java", "diffHunk": "@@ -0,0 +1,39 @@\n+package de.tum.in.www1.artemis.service;\n+\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+\n+import org.springframework.stereotype.Service;\n+\n+import de.tum.in.www1.artemis.domain.Exercise;\n+import de.tum.in.www1.artemis.domain.Submission;\n+import de.tum.in.www1.artemis.domain.TextSubmission;\n+import de.tum.in.www1.artemis.repository.ExerciseRepository;\n+\n+@Service\n+public class TextSubmissionExportService extends SubmissionExportService {\n+\n+    public TextSubmissionExportService(ExerciseRepository exerciseRepository) {\n+        super(exerciseRepository);\n+    }\n+\n+    @Override\n+    protected void saveSubmissionToFile(Exercise exercise, Submission submission, File file) throws IOException {\n+        if (((TextSubmission) submission).getText() == null) {\n+            if (!file.exists())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce3cc6c0bb94d75070e9519a0216c784e5feef5a"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNzEwODQ1OnYy", "diffSide": "RIGHT", "path": "src/main/java/de/tum/in/www1/artemis/web/rest/FileUploadExerciseResource.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQxNjo0ODoxM1rOGwVmOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQxNjo0ODoxM1rOGwVmOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzMzODY4MQ==", "bodyText": "This check caused some problems for me during testing: If you are both instructor/admin AND tutor, you cannot download all submissions.\nI do not know if this is a real scenario in normal courses, but in test courses, this can happen.\nMaybe you should change the check to something like submissionExportOptions.isExportAllParticipants() && !authCheckService.isAtLeastInstructorInCourse.\nAlso, no error message was shown to me, so I had to check the source code to identify the issue. Maybe you can display error messages in a follow up or so.", "url": "https://github.com/ls1intum/Artemis/pull/1835#discussion_r453338681", "createdAt": "2020-07-12T16:48:13Z", "author": {"login": "sleiss"}, "path": "src/main/java/de/tum/in/www1/artemis/web/rest/FileUploadExerciseResource.java", "diffHunk": "@@ -274,4 +284,51 @@ else if (!authCheckService.isAtLeastTeachingAssistantForExercise(fileUploadExerc\n         exerciseService.delete(exerciseId, false, false);\n         return ResponseEntity.ok().headers(HeaderUtil.createEntityDeletionAlert(applicationName, true, ENTITY_NAME, fileUploadExercise.getTitle())).build();\n     }\n+\n+    /**\n+     * POST /file-upload-exercises/:exerciseId/export-submissions : sends exercise submissions as zip\n+     *\n+     * @param exerciseId the id of the exercise to get the repos from\n+     * @param submissionExportOptions the options that should be used for the export\n+     * @return ResponseEntity with status\n+     */\n+    @PostMapping(\"/file-upload-exercises/{exerciseId}/export-submissions\")\n+    @PreAuthorize(\"hasAnyRole('TA', 'INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<Resource> exportSubmissions(@PathVariable long exerciseId, @RequestBody SubmissionExportOptionsDTO submissionExportOptions) {\n+\n+        Optional<FileUploadExercise> optionalFileUploadExercise = fileUploadExerciseRepository.findById(exerciseId);\n+        if (optionalFileUploadExercise.isEmpty()) {\n+            return notFound();\n+        }\n+\n+        FileUploadExercise fileUploadExercise = optionalFileUploadExercise.get();\n+\n+        if (!authCheckService.isAtLeastTeachingAssistantForExercise(fileUploadExercise)) {\n+            return forbidden();\n+        }\n+\n+        // ta's are not allowed to download all participations\n+        if (submissionExportOptions.isExportAllParticipants() && authCheckService.isTeachingAssistantInCourse(fileUploadExercise.getCourseViaExerciseGroupOrCourseMember(), null)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce3cc6c0bb94d75070e9519a0216c784e5feef5a"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNzEwODU5OnYy", "diffSide": "RIGHT", "path": "src/main/java/de/tum/in/www1/artemis/web/rest/ModelingExerciseResource.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQxNjo0ODoyOVrOGwVmSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQxNjo0ODoyOVrOGwVmSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzMzODY5Nw==", "bodyText": "See above.", "url": "https://github.com/ls1intum/Artemis/pull/1835#discussion_r453338697", "createdAt": "2020-07-12T16:48:29Z", "author": {"login": "sleiss"}, "path": "src/main/java/de/tum/in/www1/artemis/web/rest/ModelingExerciseResource.java", "diffHunk": "@@ -340,4 +351,50 @@ public ModelingExerciseResource(ModelingExerciseRepository modelingExerciseRepos\n         return ResponseEntity.created(new URI(\"/api/modeling-exercises/\" + newExercise.getId()))\n                 .headers(HeaderUtil.createEntityCreationAlert(applicationName, true, ENTITY_NAME, newExercise.getId().toString())).body((ModelingExercise) newExercise);\n     }\n+\n+    /**\n+     * POST /modeling-exercises/:exerciseId/export-submissions : sends exercise submissions as zip\n+     *\n+     * @param exerciseId the id of the exercise to get the repos from\n+     * @param submissionExportOptions the options that should be used for the export\n+     * @return ResponseEntity with status\n+     */\n+    @PostMapping(\"/modeling-exercises/{exerciseId}/export-submissions\")\n+    @PreAuthorize(\"hasAnyRole('TA', 'INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<Resource> exportSubmissions(@PathVariable long exerciseId, @RequestBody SubmissionExportOptionsDTO submissionExportOptions) {\n+\n+        Optional<ModelingExercise> optionalModelingExercise = modelingExerciseRepository.findById(exerciseId);\n+        if (optionalModelingExercise.isEmpty()) {\n+            return notFound();\n+        }\n+        ModelingExercise modelingExercise = optionalModelingExercise.get();\n+\n+        if (!authCheckService.isAtLeastTeachingAssistantForExercise(modelingExercise)) {\n+            return forbidden();\n+        }\n+\n+        // ta's are not allowed to download all participations\n+        if (submissionExportOptions.isExportAllParticipants() && authCheckService.isTeachingAssistantInCourse(modelingExercise.getCourseViaExerciseGroupOrCourseMember(), null)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce3cc6c0bb94d75070e9519a0216c784e5feef5a"}, "originalPosition": 78}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4744, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}