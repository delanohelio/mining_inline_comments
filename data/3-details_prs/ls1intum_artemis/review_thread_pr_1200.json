{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1MDQzNjEx", "number": 1200, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNlQyMDoxNTozMFrODavTaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNlQyMDozNToxM1rODavWyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MzY0NTg0OnYy", "diffSide": "RIGHT", "path": "src/main/java/de/tum/in/www1/artemis/service/AssessmentService.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNlQyMDoxNTozMFrOFh1p7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxMToxNjozNFrOFh_N5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAyNjQxNA==", "bodyText": "What if there is no assessment due date? I noticed this when testing, for exercises without assessment due date, a tutor cannot override his own assessment. The override button can be clicked but the tutor just receives a 403 from the backend then.", "url": "https://github.com/ls1intum/Artemis/pull/1200#discussion_r371026414", "createdAt": "2020-01-26T20:15:30Z", "author": {"login": "madwau"}, "path": "src/main/java/de/tum/in/www1/artemis/service/AssessmentService.java", "diffHunk": "@@ -94,6 +96,31 @@ public Result updateAssessmentAfterComplaint(Result originalResult, Exercise exe\n         return resultRepository.save(originalResult);\n     }\n \n+    /**\n+     * checks if the user can override an already submitted result. This is only possible if the same tutor overrides before the assessment due date\n+     * or if an instructor overrides it.\n+     *\n+     * If the result does not yet exist or is not yet submitted, this method returns true\n+     *\n+     * @param existingResult the existing result in case the result is updated (submitted or overridden)\n+     * @param exercise the exercise to which the submission and result belong and which potentially includes an assessment due date\n+     * @param user the user who initiates a request\n+     * @param isAtLeastInstructor whether the given user is an instructor for the given exercise\n+     * @return true of the the given user can override a potentially existing result\n+     */\n+    public boolean isAllowedToOverrideExistingResult(@NotNull Result existingResult, Exercise exercise, User user, boolean isAtLeastInstructor) {\n+        // if the assessor is null, the user can save / submit / override the existing result\n+        final var isAssessor = existingResult.getAssessor() == null || user.equals(existingResult.getAssessor());\n+        if (existingResult.getCompletionDate() == null) {\n+            // if the result exists, but was not yet submitted (i.e. completionDate not set), the tutor and the instructor can override, independent of the assessment due date\n+            return isAssessor || isAtLeastInstructor;\n+        }\n+        // if the result was already submitted, the tutor can only override before a potentially existing assessment due date\n+        var assessmentDueDate = exercise.getAssessmentDueDate();\n+        final var isBeforeAssessmentDueDate = assessmentDueDate != null && ZonedDateTime.now().isBefore(assessmentDueDate);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "22937abadb8ed6eeb2683a1c0a05d884b2e2ac49"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTEyMDgyNA==", "bodyText": "That's intended. The general idea is that as soon as a student can see the result, it should not change anymore. So if the assessment due date has passed or there is no assessment due date, tutors cannot change the assessment any more after submitting it.\nIf the buttons are still shown on the client side, we should hide them", "url": "https://github.com/ls1intum/Artemis/pull/1200#discussion_r371120824", "createdAt": "2020-01-27T08:59:15Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/service/AssessmentService.java", "diffHunk": "@@ -94,6 +96,31 @@ public Result updateAssessmentAfterComplaint(Result originalResult, Exercise exe\n         return resultRepository.save(originalResult);\n     }\n \n+    /**\n+     * checks if the user can override an already submitted result. This is only possible if the same tutor overrides before the assessment due date\n+     * or if an instructor overrides it.\n+     *\n+     * If the result does not yet exist or is not yet submitted, this method returns true\n+     *\n+     * @param existingResult the existing result in case the result is updated (submitted or overridden)\n+     * @param exercise the exercise to which the submission and result belong and which potentially includes an assessment due date\n+     * @param user the user who initiates a request\n+     * @param isAtLeastInstructor whether the given user is an instructor for the given exercise\n+     * @return true of the the given user can override a potentially existing result\n+     */\n+    public boolean isAllowedToOverrideExistingResult(@NotNull Result existingResult, Exercise exercise, User user, boolean isAtLeastInstructor) {\n+        // if the assessor is null, the user can save / submit / override the existing result\n+        final var isAssessor = existingResult.getAssessor() == null || user.equals(existingResult.getAssessor());\n+        if (existingResult.getCompletionDate() == null) {\n+            // if the result exists, but was not yet submitted (i.e. completionDate not set), the tutor and the instructor can override, independent of the assessment due date\n+            return isAssessor || isAtLeastInstructor;\n+        }\n+        // if the result was already submitted, the tutor can only override before a potentially existing assessment due date\n+        var assessmentDueDate = exercise.getAssessmentDueDate();\n+        final var isBeforeAssessmentDueDate = assessmentDueDate != null && ZonedDateTime.now().isBefore(assessmentDueDate);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAyNjQxNA=="}, "originalCommit": {"oid": "22937abadb8ed6eeb2683a1c0a05d884b2e2ac49"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE4MzA3OQ==", "bodyText": "Ok, makes sense, thanks for clarifying.", "url": "https://github.com/ls1intum/Artemis/pull/1200#discussion_r371183079", "createdAt": "2020-01-27T11:16:34Z", "author": {"login": "madwau"}, "path": "src/main/java/de/tum/in/www1/artemis/service/AssessmentService.java", "diffHunk": "@@ -94,6 +96,31 @@ public Result updateAssessmentAfterComplaint(Result originalResult, Exercise exe\n         return resultRepository.save(originalResult);\n     }\n \n+    /**\n+     * checks if the user can override an already submitted result. This is only possible if the same tutor overrides before the assessment due date\n+     * or if an instructor overrides it.\n+     *\n+     * If the result does not yet exist or is not yet submitted, this method returns true\n+     *\n+     * @param existingResult the existing result in case the result is updated (submitted or overridden)\n+     * @param exercise the exercise to which the submission and result belong and which potentially includes an assessment due date\n+     * @param user the user who initiates a request\n+     * @param isAtLeastInstructor whether the given user is an instructor for the given exercise\n+     * @return true of the the given user can override a potentially existing result\n+     */\n+    public boolean isAllowedToOverrideExistingResult(@NotNull Result existingResult, Exercise exercise, User user, boolean isAtLeastInstructor) {\n+        // if the assessor is null, the user can save / submit / override the existing result\n+        final var isAssessor = existingResult.getAssessor() == null || user.equals(existingResult.getAssessor());\n+        if (existingResult.getCompletionDate() == null) {\n+            // if the result exists, but was not yet submitted (i.e. completionDate not set), the tutor and the instructor can override, independent of the assessment due date\n+            return isAssessor || isAtLeastInstructor;\n+        }\n+        // if the result was already submitted, the tutor can only override before a potentially existing assessment due date\n+        var assessmentDueDate = exercise.getAssessmentDueDate();\n+        final var isBeforeAssessmentDueDate = assessmentDueDate != null && ZonedDateTime.now().isBefore(assessmentDueDate);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAyNjQxNA=="}, "originalCommit": {"oid": "22937abadb8ed6eeb2683a1c0a05d884b2e2ac49"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MzY1NDQ5OnYy", "diffSide": "RIGHT", "path": "src/main/java/de/tum/in/www1/artemis/web/rest/AssessmentResource.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNlQyMDozNToxM1rOFh1uNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QwODo1OTo1MFrOFh7btg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAyNzUxMQ==", "bodyText": "Maybe the name of this method and the one below can be slightly changed to differentiate them from the method with the same name in the assessment service that has slightly different preconditions? For the latter, a concrete existing result is passed in as a parameter while the former do not actually require a result to exist to return a useful boolean value. Maybe something like isAllowedToCreateOrUpdateResult or isAllowedToCreateOrOverrideResult?", "url": "https://github.com/ls1intum/Artemis/pull/1200#discussion_r371027511", "createdAt": "2020-01-26T20:35:13Z", "author": {"login": "madwau"}, "path": "src/main/java/de/tum/in/www1/artemis/web/rest/AssessmentResource.java", "diffHunk": "@@ -35,4 +60,67 @@ void validateExercise(Exercise exercise) throws BadRequestAlertException {\n             throw new BadRequestAlertException(\"The course belonging to this exercise does not exist\", getEntityName(), \"courseNotFound\");\n         }\n     }\n+\n+    /**\n+     * checks if the user can override an already submitted result. This is only possible if the same tutor overrides before the assessment due date\n+     * or if an instructor overrides it.\n+     *\n+     * If the result does not yet exist or is not yet submitted, this method returns true\n+     *\n+     * @param submission the submission that might include an existing result which would include information about the assessor\n+     * @param exercise the exercise to which the submission and result belong and which potentially includes an assessment due date\n+     * @param user the user who initiates a request\n+     * @param isAtLeastInstructor whether the given user is an instructor for the given exercise\n+     * @return true of the the given user can override a potentially existing result\n+     */\n+    protected boolean isAllowedToOverrideExistingResult(Submission submission, Exercise exercise, User user, boolean isAtLeastInstructor) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "22937abadb8ed6eeb2683a1c0a05d884b2e2ac49"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTEyMTA3OA==", "bodyText": "good point, will adapt it", "url": "https://github.com/ls1intum/Artemis/pull/1200#discussion_r371121078", "createdAt": "2020-01-27T08:59:50Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/web/rest/AssessmentResource.java", "diffHunk": "@@ -35,4 +60,67 @@ void validateExercise(Exercise exercise) throws BadRequestAlertException {\n             throw new BadRequestAlertException(\"The course belonging to this exercise does not exist\", getEntityName(), \"courseNotFound\");\n         }\n     }\n+\n+    /**\n+     * checks if the user can override an already submitted result. This is only possible if the same tutor overrides before the assessment due date\n+     * or if an instructor overrides it.\n+     *\n+     * If the result does not yet exist or is not yet submitted, this method returns true\n+     *\n+     * @param submission the submission that might include an existing result which would include information about the assessor\n+     * @param exercise the exercise to which the submission and result belong and which potentially includes an assessment due date\n+     * @param user the user who initiates a request\n+     * @param isAtLeastInstructor whether the given user is an instructor for the given exercise\n+     * @return true of the the given user can override a potentially existing result\n+     */\n+    protected boolean isAllowedToOverrideExistingResult(Submission submission, Exercise exercise, User user, boolean isAtLeastInstructor) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAyNzUxMQ=="}, "originalCommit": {"oid": "22937abadb8ed6eeb2683a1c0a05d884b2e2ac49"}, "originalPosition": 69}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 197, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}