{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0MjgzNTEy", "number": 1814, "title": "Fix non working authentication over LTI", "bodyText": "This should fix an issue with the authentication over LTI\nWe currently assume that the forwarding of the full URL is not working correctly and therefore the request cannot be verified.\nIt seems that Spring does not check the header value 'X-Forwarded-Proto' set by nginx.\nMotivation and Context\nUsers of online courses cannot participate in exercises over LTI\nDescription\nAdditionally, I made the whole LTI config optional, so that administrators of other Artemis instances can also deactivate it.\nSteps for Testing\n\nMake sure you are logged out on Artemis\nCreate an account on edx (do not use your TUM Email) and register for the software engineering essentials course\nParticipate in one programming exercises (use OOP1 because this is synced with TS1) over LTI\nYou should automatically get a new Artemis account (starting with 'edx_') when you first try this. There should be no issue with unauthorized errors", "createdAt": "2020-07-04T13:14:25Z", "url": "https://github.com/ls1intum/Artemis/pull/1814", "merged": true, "mergeCommit": {"oid": "3377a8e2f767c89a25c66c2c703256b594de6cde"}, "closed": true, "closedAt": "2020-07-05T19:30:33Z", "author": {"login": "krusche"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxlVsKgH2gAyNDQ0MjgzNTEyOmI2NmZjNjM5OWFmYWZkY2Q4N2FjMjgwODgxZjRlMmU2Y2JiOTU3YzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyBrfLAFqTQ0MjcwMDI3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b66fc6399afafdcd87ac280881f4e2e6cbb957c4", "author": {"user": null}, "url": "https://github.com/ls1intum/Artemis/commit/b66fc6399afafdcd87ac280881f4e2e6cbb957c4", "committedDate": "2020-07-04T10:18:33Z", "message": "better error logs in case LTI verification fails\n\nalso make the whole LTI section more optional for Artemis admins who do not like to use it"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44ec3a725ae8f932b4322ebc53f0913c7d4f6dd1", "author": {"user": null}, "url": "https://github.com/ls1intum/Artemis/commit/44ec3a725ae8f932b4322ebc53f0913c7d4f6dd1", "committedDate": "2020-07-04T21:13:09Z", "message": "fix http\u2014>https issue in Spring\n\nalso make the whole LTI code optional for Artemis admins who do not like to use it\nimprove log in case something does not work\nadd forward-headers-strategy: native to application.yml"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "70dec02bc1cd6467241c1015b2626ca459accb57", "author": {"user": null}, "url": "https://github.com/ls1intum/Artemis/commit/70dec02bc1cd6467241c1015b2626ca459accb57", "committedDate": "2020-07-04T20:47:46Z", "message": "add forward-headers-strategy: native to application.yml\n\nthis fixed the issue with the wrong scheme http instad of https"}, "afterCommit": {"oid": "44ec3a725ae8f932b4322ebc53f0913c7d4f6dd1", "author": {"user": null}, "url": "https://github.com/ls1intum/Artemis/commit/44ec3a725ae8f932b4322ebc53f0913c7d4f6dd1", "committedDate": "2020-07-04T21:13:09Z", "message": "fix http\u2014>https issue in Spring\n\nalso make the whole LTI code optional for Artemis admins who do not like to use it\nimprove log in case something does not work\nadd forward-headers-strategy: native to application.yml"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjMzMzgy", "url": "https://github.com/ls1intum/Artemis/pull/1814#pullrequestreview-442633382", "createdAt": "2020-07-04T21:58:39Z", "commit": {"oid": "44ec3a725ae8f932b4322ebc53f0913c7d4f6dd1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNFQyMTo1ODozOVrOGs-IyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNFQyMTo1ODozOVrOGs-IyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgwODU4NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        String message = \"verifyRequest for LTI is not supported on this Artemis instance, not artemis.lti.oauth-secret was specified in the yml configuration\";\n          \n          \n            \n                        String message = \"verifyRequest for LTI is not supported on this Artemis instance, artemis.lti.oauth-secret was not specified in the yml configuration\";", "url": "https://github.com/ls1intum/Artemis/pull/1814#discussion_r449808585", "createdAt": "2020-07-04T21:58:39Z", "author": {"login": "sleiss"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/LtiService.java", "diffHunk": "@@ -362,23 +368,66 @@ private void saveLtiUserId(User user, String ltiUserIdString) {\n      * Checks if a LTI request is correctly signed via OAuth with the secret\n      *\n      * @param request The request to check\n-     * @return True if the request is valid, otherwise false\n+     * @return null if the request is valid, otherwise an error message which indicates the reason why the verification failed\n      */\n-    public Boolean verifyRequest(HttpServletRequest request) {\n+    public String verifyRequest(HttpServletRequest request) {\n         LtiVerifier ltiVerifier = new LtiOauthVerifier();\n-        Boolean success = false;\n+        if (this.OAUTH_SECRET.isEmpty()) {\n+            // this means Artemis does not support this\n+            String message = \"verifyRequest for LTI is not supported on this Artemis instance, not artemis.lti.oauth-secret was specified in the yml configuration\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44ec3a725ae8f932b4322ebc53f0913c7d4f6dd1"}, "originalPosition": 198}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjMzNDY4", "url": "https://github.com/ls1intum/Artemis/pull/1814#pullrequestreview-442633468", "createdAt": "2020-07-04T22:01:39Z", "commit": {"oid": "44ec3a725ae8f932b4322ebc53f0913c7d4f6dd1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNFQyMjowMTozOVrOGs-Jhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNFQyMjowMTozOVrOGs-Jhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgwODc3NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                \"LTI not configure on this Artemis server. Cannot launch exercise \" + exerciseId + \". \" + \"Please contact an admin or try again.\");\n          \n          \n            \n                                \"LTI not configured on this Artemis server. Cannot launch exercise \" + exerciseId + \". \" + \"Please contact an admin or try again.\");", "url": "https://github.com/ls1intum/Artemis/pull/1814#discussion_r449808775", "createdAt": "2020-07-04T22:01:39Z", "author": {"login": "sleiss"}, "path": "src/main/java/de/tum/in/www1/artemis/web/rest/LtiResource.java", "diffHunk": "@@ -77,11 +84,22 @@ public LtiResource(LtiService ltiService, UserService userService, ExerciseRepos\n     public void launch(@ModelAttribute LtiLaunchRequestDTO launchRequest, @PathVariable(\"exerciseId\") Long exerciseId, HttpServletRequest request, HttpServletResponse response)\n             throws IOException {\n \n-        log.debug(\"Launch request : {}\", launchRequest);\n+        if (this.LTI_OAUTH_SECRET.isEmpty() || this.LTI_ID.isEmpty() || this.LTI_OAUTH_KEY.isEmpty()) {\n+            response.sendError(HttpServletResponse.SC_FORBIDDEN,\n+                    \"LTI not configure on this Artemis server. Cannot launch exercise \" + exerciseId + \". \" + \"Please contact an admin or try again.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44ec3a725ae8f932b4322ebc53f0913c7d4f6dd1"}, "originalPosition": 67}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19aa1771ad3b7e566cc84ec33bd4f9769ed4ce34", "author": {"user": {"login": "krusche", "name": "Stephan Krusche"}}, "url": "https://github.com/ls1intum/Artemis/commit/19aa1771ad3b7e566cc84ec33bd4f9769ed4ce34", "committedDate": "2020-07-04T22:31:52Z", "message": "Update src/main/java/de/tum/in/www1/artemis/service/connectors/LtiService.java\n\nCo-authored-by: Simon Lei\u00df <5084100+sleiss@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f45c593aa1efc9434ec10f94561297dd6b7b9b71", "author": {"user": {"login": "krusche", "name": "Stephan Krusche"}}, "url": "https://github.com/ls1intum/Artemis/commit/f45c593aa1efc9434ec10f94561297dd6b7b9b71", "committedDate": "2020-07-04T22:32:00Z", "message": "Update src/main/java/de/tum/in/www1/artemis/web/rest/LtiResource.java\n\nCo-authored-by: Simon Lei\u00df <5084100+sleiss@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1448d635464b863a963599b631ec6e7a99437bcf", "author": {"user": {"login": "krusche", "name": "Stephan Krusche"}}, "url": "https://github.com/ls1intum/Artemis/commit/1448d635464b863a963599b631ec6e7a99437bcf", "committedDate": "2020-07-04T22:53:26Z", "message": "Merge branch 'develop' into bugfix/lti-oauth"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjk4NzM4", "url": "https://github.com/ls1intum/Artemis/pull/1814#pullrequestreview-442698738", "createdAt": "2020-07-05T18:52:46Z", "commit": {"oid": "1448d635464b863a963599b631ec6e7a99437bcf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNzAwMjc1", "url": "https://github.com/ls1intum/Artemis/pull/1814#pullrequestreview-442700275", "createdAt": "2020-07-05T19:19:42Z", "commit": {"oid": "1448d635464b863a963599b631ec6e7a99437bcf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4483, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}