{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyMDgzMDA3", "number": 2414, "title": "[Feature] Update Template on Import", "bodyText": "Checklist\n\n I tested all changes and all related features with different users (student, tutor, instructor, admin) on the test server https://artemistest.ase.in.tum.de.\n Server: I followed the coding and design guidelines.\n Server: I documented the Java code using JavaDoc style.\n Client: I followed the coding and design guidelines.\n Client: I added multiple screenshots/screencasts of my UI changes\n Client: I translated all the newly inserted strings into German and English\n\nMotivation and Context\n\n\nThis PR adds an option to the import of programming exercises which updates the template files with the latest template of Artemis. In later iterations of this feature, this will allow instructors to enable/disable feature which were locked on import before. For this first iteration the Maven pom files found in the test, exercise, solution repositories are updated with dependencies and plugins found in the latest template. This only works for non-sequential tests for now.\nDescription\n\n\nImplements a strategy pattern for different upgrade strategies per programming language\nImplements a strategy for Java which updates the repository project object models plugins and dependencies with the ones found in the template.\n\nSteps for Testing\n\n\nLog in to Artemis\nIdentify a old Java programming exercise (still using JUnit4) or manipulate pom files of Java exercises yourself (add plugins, dependencies, change versions and JDK, add JUNIT\nImport this exercise, and activate the Upgrade Template option\nCheck the pom.xml files in the Test/Solution/Template repository using 'Edit in Editor'\n--> JUnit should be gone\n--> Legacy dependencies org.json.json and me.xdrop.fuzzywuzzy should be gone\n--> AJTS should be added\n--> Plugins failsafe, surefire, compiler should have the same version and configuration as in the latest template (check the JDK version)\n--> Overall, all dependencies except ones the instructor added himself should use the version of found in the template.\nThe tests will most likely not work out of the box after activating this option. This is expected\nAlso test this with a maven project type programming exercise. As they are quite new, you will have to fabricate the pom.xml files for this exercise yourself e.g. downgrade to JDK 14, introduce junit4...\nQuickly create a programming exercise with SCA and another one with sequential test runs to check that this still works.\n\nTest Coverage\n\n\n\nDecreases. The new functionality file be covered in a follow up.\nScreenshots", "createdAt": "2020-11-17T01:49:40Z", "url": "https://github.com/ls1intum/Artemis/pull/2414", "merged": true, "mergeCommit": {"oid": "6f0096fab51843a1e709c3af28f2b5f65c58fe80"}, "closed": true, "closedAt": "2020-11-23T21:45:35Z", "author": {"login": "kloessst"}, "timelineItems": {"totalCount": 41, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbP6XXgH2gAyNTIyMDgzMDA3OjFlYTdiNjY1MzhiZDA2MWY3YmU4MjE5Mzc5ZTk1NzIxNGNlZTgzOWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfcRSrgFqTUzNjg2OTI1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1ea7b66538bd061f7be8219379e957214cee839b", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/1ea7b66538bd061f7be8219379e957214cee839b", "committedDate": "2020-11-10T21:05:31Z", "message": "First attempt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08a9f64415b8873030d1ed472c8a4b3277cffd0e", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/08a9f64415b8873030d1ed472c8a4b3277cffd0e", "committedDate": "2020-11-14T02:15:27Z", "message": "Use comments and placeholders to have a valid test pom for easy reading."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "942433927fabfb5c863235112fc9f3eb671c844d", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/942433927fabfb5c863235112fc9f3eb671c844d", "committedDate": "2020-11-14T02:17:33Z", "message": "Use strategy pattern for import service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "066a3ff23f3d135d246ed4b3a37d4c52598e79b8", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/066a3ff23f3d135d246ed4b3a37d4c52598e79b8", "committedDate": "2020-11-14T02:20:22Z", "message": "Add maven model dep"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dadc7211604cc1f942e750b2f1a03b82ff3e632d", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/dadc7211604cc1f942e750b2f1a03b82ff3e632d", "committedDate": "2020-11-14T02:23:40Z", "message": "Merge remote-tracking branch 'origin/develop' into feature/upgrade-repos"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ffadac5ad8113e0153649ccd454f94d39a765ce", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/8ffadac5ad8113e0153649ccd454f94d39a765ce", "committedDate": "2020-11-14T02:41:07Z", "message": "Use the update service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a912f6efd96924ffb8b848a110ad977c9ed3f93d", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/a912f6efd96924ffb8b848a110ad977c9ed3f93d", "committedDate": "2020-11-14T03:10:18Z", "message": "Add checkbox to import dialog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa5a03552fface511e3ab08170c0b3878a2e8d82", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/fa5a03552fface511e3ab08170c0b3878a2e8d82", "committedDate": "2020-11-15T00:16:03Z", "message": "Only replace with Ares if it doesn't already exist"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2a84cbd1504c8745d00c42217bf849d54f27933", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/d2a84cbd1504c8745d00c42217bf849d54f27933", "committedDate": "2020-11-15T02:33:27Z", "message": "Commit template"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8eee2c92bb1f8d9e5ebaee9b3f87232914c61ea6", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/8eee2c92bb1f8d9e5ebaee9b3f87232914c61ea6", "committedDate": "2020-11-15T15:14:47Z", "message": "Fix path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc00740166ab5dc8af3f06da38cc4828d1f0b50d", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/cc00740166ab5dc8af3f06da38cc4828d1f0b50d", "committedDate": "2020-11-15T15:44:50Z", "message": "Fix wrong dependency typr"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d69281136dc32f128f9e7269eb816de107bb496", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/7d69281136dc32f128f9e7269eb816de107bb496", "committedDate": "2020-11-15T16:17:04Z", "message": "Fix wrong dep type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc0ca75ba0189d67ca0c6c35e1c0999f0b064a8c", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/dc0ca75ba0189d67ca0c6c35e1c0999f0b064a8c", "committedDate": "2020-11-15T17:02:20Z", "message": "Remove legacy dependencies"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e50110d5ec1ed5e9e597d91466d9b7b470a14e6e", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/e50110d5ec1ed5e9e597d91466d9b7b470a14e6e", "committedDate": "2020-11-20T16:38:10Z", "message": "Merge branch 'develop' into feature/upgrade-repos"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "801c4b4df8f06a2163f4a01db69712ce70a420e9", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/801c4b4df8f06a2163f4a01db69712ce70a420e9", "committedDate": "2020-11-20T16:56:49Z", "message": "Rename to template upgrade"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56de967b0e015ae91e0f7099e488f419178fe777", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/56de967b0e015ae91e0f7099e488f419178fe777", "committedDate": "2020-11-20T17:02:30Z", "message": "Add documentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89b6ff65c288316864ca7b2c2f6f22a9f49db1a6", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/89b6ff65c288316864ca7b2c2f6f22a9f49db1a6", "committedDate": "2020-11-20T18:37:06Z", "message": "Improve error handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "096cef02644639095f405eba021f9e6b9dcb68a1", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/096cef02644639095f405eba021f9e6b9dcb68a1", "committedDate": "2020-11-20T19:16:25Z", "message": "Remove Kotlin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "679203480fa88f8374aee105befe287fd156aaa7", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/679203480fa88f8374aee105befe287fd156aaa7", "committedDate": "2020-11-20T19:28:03Z", "message": "Refactor retrieval of repository url for type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "964109593a0d6dcb3d1f01ffcd58d9a6f559ef60", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/964109593a0d6dcb3d1f01ffcd58d9a6f559ef60", "committedDate": "2020-11-20T19:31:28Z", "message": "Use interface instead of class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9665d8e1fe31bb2f616ec5b0ab28e0c574e74f28", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/9665d8e1fe31bb2f616ec5b0ab28e0c574e74f28", "committedDate": "2020-11-20T19:48:12Z", "message": "Add override for Javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1f55a73b0eb46f99a8db0ee9ffd6368eddc018d", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/b1f55a73b0eb46f99a8db0ee9ffd6368eddc018d", "committedDate": "2020-11-20T19:48:58Z", "message": "Merge branch 'develop' into feature/upgrade-repos"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f04209b14d09f24a63ff5331c35752edbb588dc2", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/f04209b14d09f24a63ff5331c35752edbb588dc2", "committedDate": "2020-11-20T20:10:05Z", "message": "Do use InputStream directly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6af4431f41a10dd82b27457a2abcf91774ec3b09", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/6af4431f41a10dd82b27457a2abcf91774ec3b09", "committedDate": "2020-11-20T20:11:01Z", "message": "Merge branch 'feature/upgrade-repos' of https://github.com/ls1intum/Artemis into feature/upgrade-repos"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e59dcc1fd56d4412a5068e8729354758c0b4e48", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/8e59dcc1fd56d4412a5068e8729354758c0b4e48", "committedDate": "2020-11-20T20:20:04Z", "message": "Codacy issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1ODE0MDA4", "url": "https://github.com/ls1intum/Artemis/pull/2414#pullrequestreview-535814008", "createdAt": "2020-11-20T22:17:45Z", "commit": {"oid": "8e59dcc1fd56d4412a5068e8729354758c0b4e48"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e14d2981f9d7b2a2edb1349f313bb8edfe177a39", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/e14d2981f9d7b2a2edb1349f313bb8edfe177a39", "committedDate": "2020-11-20T23:18:40Z", "message": "Adjust maven template sections"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1OTUxNzI3", "url": "https://github.com/ls1intum/Artemis/pull/2414#pullrequestreview-535951727", "createdAt": "2020-11-21T08:56:02Z", "commit": {"oid": "e14d2981f9d7b2a2edb1349f313bb8edfe177a39"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1OTU4NjE3", "url": "https://github.com/ls1intum/Artemis/pull/2414#pullrequestreview-535958617", "createdAt": "2020-11-21T11:05:27Z", "commit": {"oid": "e14d2981f9d7b2a2edb1349f313bb8edfe177a39"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1OTU5OTg0", "url": "https://github.com/ls1intum/Artemis/pull/2414#pullrequestreview-535959984", "createdAt": "2020-11-21T11:32:07Z", "commit": {"oid": "e14d2981f9d7b2a2edb1349f313bb8edfe177a39"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MDA3MTgx", "url": "https://github.com/ls1intum/Artemis/pull/2414#pullrequestreview-536007181", "createdAt": "2020-11-21T20:36:17Z", "commit": {"oid": "e14d2981f9d7b2a2edb1349f313bb8edfe177a39"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQyMDozNjoxN1rOH3xNhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQyMDozNjoxN1rOH3xNhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI0MDAwNQ==", "bodyText": "This should remove the dependencies also from the TEST repo right?", "url": "https://github.com/ls1intum/Artemis/pull/2414#discussion_r528240005", "createdAt": "2020-11-21T20:36:17Z", "author": {"login": "fde312"}, "path": "src/main/java/de/tum/in/www1/artemis/service/programming/JavaTemplateUpgradeService.java", "diffHunk": "@@ -0,0 +1,217 @@\n+package de.tum.in.www1.artemis.service.programming;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+\n+import org.apache.maven.model.Dependency;\n+import org.apache.maven.model.Model;\n+import org.apache.maven.model.Plugin;\n+import org.apache.maven.model.io.xpp3.MavenXpp3Reader;\n+import org.apache.maven.model.io.xpp3.MavenXpp3Writer;\n+import org.codehaus.plexus.util.xml.pull.XmlPullParserException;\n+import org.eclipse.jgit.api.errors.GitAPIException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.core.io.Resource;\n+import org.springframework.stereotype.Service;\n+\n+import de.tum.in.www1.artemis.ResourceLoaderService;\n+import de.tum.in.www1.artemis.domain.ProgrammingExercise;\n+import de.tum.in.www1.artemis.domain.Repository;\n+import de.tum.in.www1.artemis.domain.enumeration.RepositoryType;\n+import de.tum.in.www1.artemis.service.ProgrammingExerciseService;\n+import de.tum.in.www1.artemis.service.UserService;\n+import de.tum.in.www1.artemis.service.connectors.GitService;\n+\n+/**\n+ * Service for upgrading of Java template files\n+ */\n+@Service\n+public class JavaTemplateUpgradeService implements TemplateUpgradeService {\n+\n+    private final Logger log = LoggerFactory.getLogger(JavaTemplateUpgradeService.class);\n+\n+    private final ProgrammingExerciseService programmingExerciseService;\n+\n+    private final GitService gitService;\n+\n+    private final UserService userService;\n+\n+    private final ResourceLoaderService resourceLoaderService;\n+\n+    public JavaTemplateUpgradeService(ProgrammingExerciseService programmingExerciseService, GitService gitService, ResourceLoaderService resourceLoaderService,\n+            UserService userService) {\n+        this.programmingExerciseService = programmingExerciseService;\n+        this.gitService = gitService;\n+        this.userService = userService;\n+        this.resourceLoaderService = resourceLoaderService;\n+    }\n+\n+    @Override\n+    public void upgradeTemplate(ProgrammingExercise exercise) {\n+        // TODO: Support sequential test runs\n+        if (exercise.hasSequentialTestRuns()) {\n+            return;\n+        }\n+        // Template and solution repository can also contain a project object model for some project types\n+        updateRepository(exercise, RepositoryType.TEMPLATE.getName(), RepositoryType.TEMPLATE);\n+        updateRepository(exercise, RepositoryType.SOLUTION.getName(), RepositoryType.SOLUTION);\n+        updateRepository(exercise, \"test/projectTemplate\", RepositoryType.TESTS);\n+    }\n+\n+    /**\n+     * Upgrades the template files of a specific Java or Kotlin repository. Prefers project type specific templates as the\n+     * reference. The method updates the project object models (pom) in the target repository with the pom of the latest\n+     * Artemis template.\n+     *\n+     * @param exercise The exercise for the the template files should be updated\n+     * @param templateFolder The folder containing the latest reference template\n+     * @param repositoryType The type of repository to be updated\n+     */\n+    private void updateRepository(ProgrammingExercise exercise, String templateFolder, RepositoryType repositoryType) {\n+        try {\n+            // Get general template poms\n+            String programmingLanguageTemplate = programmingExerciseService.getProgrammingLanguageTemplatePath(exercise.getProgrammingLanguage());\n+            String templatePomPath = programmingLanguageTemplate + \"/\" + templateFolder + \"/**/pom.xml\";\n+\n+            Resource[] templatePoms = resourceLoaderService.getResources(templatePomPath);\n+\n+            // Get project type specific template poms\n+            if (exercise.getProjectType() != null) {\n+                String projectTypeTemplate = programmingExerciseService.getProgrammingLanguageProjectTypePath(exercise.getProgrammingLanguage(), exercise.getProjectType());\n+                String projectTypePomPath = projectTypeTemplate + \"/\" + templateFolder + \"/**/pom.xml\";\n+\n+                Resource[] projectTypePoms = resourceLoaderService.getResources(projectTypePomPath);\n+\n+                // Prefer project type specific poms\n+                templatePoms = projectTypePoms.length > 0 ? projectTypePoms : templatePoms;\n+            }\n+\n+            Repository repository = gitService.getOrCheckoutRepository(exercise.getRepositoryURL(repositoryType), true);\n+            List<File> repositoryPoms = gitService.listFiles(repository).stream().filter(file -> \"pom.xml\".equals(file.getName())).collect(Collectors.toList());\n+\n+            // Validate that template and repository have the same number of pom.xml files, otherwise no upgrade will take place\n+            // TODO: Improve matching of repository and template poms, support sequential test runs\n+            if (templatePoms.length == 1 && repositoryPoms.size() == 1) {\n+                Model updatedRepoModel = upgradeProjectObjectModel(templatePoms[0], repositoryPoms.get(0));\n+                writeProjectObjectModel(updatedRepoModel, repositoryPoms.get(0));\n+                programmingExerciseService.commitAndPushRepository(repository, \"Template upgraded by Artemis\", userService.getUser());\n+            }\n+        }\n+        catch (IOException | GitAPIException | InterruptedException | XmlPullParserException exception) {\n+            log.error(\"Updating of template files of repository \" + repositoryType.name() + \" for exercise \" + exercise.getId() + \" failed with error\" + exception.getMessage());\n+            // Rollback local changes in case of errors\n+            gitService.deleteLocalRepository(exercise.getRepositoryURL(repositoryType));\n+        }\n+    }\n+\n+    private void writeProjectObjectModel(Model repositoryModel, File repositoryPom) throws IOException {\n+        try (OutputStream outputStream = new FileOutputStream(repositoryPom)) {\n+            var pomWriter = new MavenXpp3Writer();\n+            pomWriter.write(outputStream, repositoryModel);\n+        }\n+    }\n+\n+    private Model upgradeProjectObjectModel(Resource templatePom, File repositoryPom) throws IOException, XmlPullParserException {\n+        try (InputStream templateInput = templatePom.getInputStream(); InputStream repoInput = new FileInputStream(repositoryPom)) {\n+\n+            var pomReader = new MavenXpp3Reader();\n+            Model templateModel = pomReader.read(templateInput);\n+            Model repoModel = pomReader.read(repoInput);\n+\n+            // Update all dependencies found in the repository pom with version found in the template\n+            updateDependencies(repoModel, templateModel);\n+\n+            // Update Maven Compiler Plugin with JDK version, Maven Surefire Plugin and Maven Failsafe Plugin by replacing them with template plugins\n+            upgradePlugin(repoModel, templateModel, \"org.apache.maven.plugins\", \"maven-compiler-plugin\");\n+            upgradePlugin(repoModel, templateModel, \"org.apache.maven.plugins\", \"maven-surefire-plugin\");\n+            upgradePlugin(repoModel, templateModel, \"org.apache.maven.plugins\", \"maven-failsafe-plugin\");\n+\n+            // Replace JUnit4 with AJTS\n+            removeDependency(repoModel, \"junit\", \"junit\");\n+            addDependency(repoModel, templateModel, \"de.tum.in.ase\", \"artemis-java-test-sandbox\");\n+\n+            // Remove legacy dependencies which are no longer needed or were moved to AJTS\n+            removeDependency(repoModel, \"org.json\", \"json\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e14d2981f9d7b2a2edb1349f313bb8edfe177a39"}, "originalPosition": 143}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MDA3NDQz", "url": "https://github.com/ls1intum/Artemis/pull/2414#pullrequestreview-536007443", "createdAt": "2020-11-21T20:40:27Z", "commit": {"oid": "e14d2981f9d7b2a2edb1349f313bb8edfe177a39"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQyMDo0MDoyN1rOH3xPKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQyMDo0MDoyN1rOH3xPKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI0MDQyNA==", "bodyText": "why are we not using here RepositoryType.TEST.getName()? Could you add a comment?", "url": "https://github.com/ls1intum/Artemis/pull/2414#discussion_r528240424", "createdAt": "2020-11-21T20:40:27Z", "author": {"login": "fde312"}, "path": "src/main/java/de/tum/in/www1/artemis/service/programming/JavaTemplateUpgradeService.java", "diffHunk": "@@ -0,0 +1,217 @@\n+package de.tum.in.www1.artemis.service.programming;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+\n+import org.apache.maven.model.Dependency;\n+import org.apache.maven.model.Model;\n+import org.apache.maven.model.Plugin;\n+import org.apache.maven.model.io.xpp3.MavenXpp3Reader;\n+import org.apache.maven.model.io.xpp3.MavenXpp3Writer;\n+import org.codehaus.plexus.util.xml.pull.XmlPullParserException;\n+import org.eclipse.jgit.api.errors.GitAPIException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.core.io.Resource;\n+import org.springframework.stereotype.Service;\n+\n+import de.tum.in.www1.artemis.ResourceLoaderService;\n+import de.tum.in.www1.artemis.domain.ProgrammingExercise;\n+import de.tum.in.www1.artemis.domain.Repository;\n+import de.tum.in.www1.artemis.domain.enumeration.RepositoryType;\n+import de.tum.in.www1.artemis.service.ProgrammingExerciseService;\n+import de.tum.in.www1.artemis.service.UserService;\n+import de.tum.in.www1.artemis.service.connectors.GitService;\n+\n+/**\n+ * Service for upgrading of Java template files\n+ */\n+@Service\n+public class JavaTemplateUpgradeService implements TemplateUpgradeService {\n+\n+    private final Logger log = LoggerFactory.getLogger(JavaTemplateUpgradeService.class);\n+\n+    private final ProgrammingExerciseService programmingExerciseService;\n+\n+    private final GitService gitService;\n+\n+    private final UserService userService;\n+\n+    private final ResourceLoaderService resourceLoaderService;\n+\n+    public JavaTemplateUpgradeService(ProgrammingExerciseService programmingExerciseService, GitService gitService, ResourceLoaderService resourceLoaderService,\n+            UserService userService) {\n+        this.programmingExerciseService = programmingExerciseService;\n+        this.gitService = gitService;\n+        this.userService = userService;\n+        this.resourceLoaderService = resourceLoaderService;\n+    }\n+\n+    @Override\n+    public void upgradeTemplate(ProgrammingExercise exercise) {\n+        // TODO: Support sequential test runs\n+        if (exercise.hasSequentialTestRuns()) {\n+            return;\n+        }\n+        // Template and solution repository can also contain a project object model for some project types\n+        updateRepository(exercise, RepositoryType.TEMPLATE.getName(), RepositoryType.TEMPLATE);\n+        updateRepository(exercise, RepositoryType.SOLUTION.getName(), RepositoryType.SOLUTION);\n+        updateRepository(exercise, \"test/projectTemplate\", RepositoryType.TESTS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e14d2981f9d7b2a2edb1349f313bb8edfe177a39"}, "originalPosition": 67}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MDA3ODg2", "url": "https://github.com/ls1intum/Artemis/pull/2414#pullrequestreview-536007886", "createdAt": "2020-11-21T20:48:08Z", "commit": {"oid": "e14d2981f9d7b2a2edb1349f313bb8edfe177a39"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQyMDo0ODowOFrOH3xR1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQyMDo0ODowOFrOH3xR1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI0MTEwOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            \"description\": \"Durch Aktivierung dieser Option werden die Template Dateien in den Repositories aktualisiert. Dies ist sinnvoll, wenn die importierte Aufgabe veraltete Abh\u00e4ngigkeiten enth\u00e4lt. F\u00fcr Java ersetzt Artemis JUnit4 durch Ares (enth\u00e4lt JUnit5) und aktualisiert die Abh\u00e4ngigkeiten und Plugins mit den Versionen aus dem neusten Template. Danach musst du wahrscheinlich die Testcases anpassen.\"\n          \n          \n            \n                            \"description\": \"Durch Aktivierung dieser Option werden die Template Dateien in den Repositories aktualisiert. Dies ist sinnvoll, wenn die importierte Aufgabe veraltete Abh\u00e4ngigkeiten enth\u00e4lt. F\u00fcr Java ersetzt Artemis JUnit4 durch Ares (enth\u00e4lt JUnit5) und aktualisiert die Abh\u00e4ngigkeiten und Plugins mit den Versionen aus dem neusten Template. Danach m\u00fcssen die Testcases wahrscheinlich angepasst werden.\"", "url": "https://github.com/ls1intum/Artemis/pull/2414#discussion_r528241108", "createdAt": "2020-11-21T20:48:08Z", "author": {"login": "fde312"}, "path": "src/main/webapp/i18n/de/programmingExercise.json", "diffHunk": "@@ -68,6 +68,10 @@\n                 \"title\": \"Build Pl\u00e4ne neu erstellen\",\n                 \"description\": \"Durch Aktivierung dieser Option werden die Build Pl\u00e4ne neu erstellt und nicht von der importierten Aufgabe kopiert. Neu erstellte Build Pl\u00e4ne unterst\u00fctzen standardm\u00e4\u00dfig die neuesten Features der Artemis Aufgabenvorlagen.\"\n             },\n+            \"updateTemplate\": {\n+                \"title\": \"Aktualisiere Template\",\n+                \"description\": \"Durch Aktivierung dieser Option werden die Template Dateien in den Repositories aktualisiert. Dies ist sinnvoll, wenn die importierte Aufgabe veraltete Abh\u00e4ngigkeiten enth\u00e4lt. F\u00fcr Java ersetzt Artemis JUnit4 durch Ares (enth\u00e4lt JUnit5) und aktualisiert die Abh\u00e4ngigkeiten und Plugins mit den Versionen aus dem neusten Template. Danach musst du wahrscheinlich die Testcases anpassen.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e14d2981f9d7b2a2edb1349f313bb8edfe177a39"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MDA3OTM0", "url": "https://github.com/ls1intum/Artemis/pull/2414#pullrequestreview-536007934", "createdAt": "2020-11-21T20:49:01Z", "commit": {"oid": "e14d2981f9d7b2a2edb1349f313bb8edfe177a39"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQyMDo0OTowMVrOH3xSKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQyMDo0OTowMVrOH3xSKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI0MTE5NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            \"description\": \"Activate this option to update the template files in the repositories. This can be useful if the imported exercise is old and contains outdated dependencies. For Java, Artemis replaces JUnit4 by Ares (which includes JUnit5) and updates the dependencies and plugins with the versions found in the latest template. Afterwards you might need to adapt the test cases.\"\n          \n          \n            \n                            \"description\": \"Activate this option to update the template files in the repositories. This can be useful if the imported exercise is old and contains outdated dependencies. For Java, Artemis replaces JUnit4 by Ares (which includes JUnit5) and updates the dependencies and plugins with the versions found in the latest template. Afterwards test cases might need to be adapted.\"", "url": "https://github.com/ls1intum/Artemis/pull/2414#discussion_r528241195", "createdAt": "2020-11-21T20:49:01Z", "author": {"login": "fde312"}, "path": "src/main/webapp/i18n/en/programmingExercise.json", "diffHunk": "@@ -68,6 +68,10 @@\n                 \"title\": \"Recreate Build Plans\",\n                 \"description\": \"Activate this option to create new build plans instead of copying them from the imported exercise. Newly created build plans support the latest features of the Artemis exercise templates by default.\"\n             },\n+            \"updateTemplate\": {\n+                \"title\": \"Update Template\",\n+                \"description\": \"Activate this option to update the template files in the repositories. This can be useful if the imported exercise is old and contains outdated dependencies. For Java, Artemis replaces JUnit4 by Ares (which includes JUnit5) and updates the dependencies and plugins with the versions found in the latest template. Afterwards you might need to adapt the test cases.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e14d2981f9d7b2a2edb1349f313bb8edfe177a39"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MDA4MTk1", "url": "https://github.com/ls1intum/Artemis/pull/2414#pullrequestreview-536008195", "createdAt": "2020-11-21T20:53:20Z", "commit": {"oid": "e14d2981f9d7b2a2edb1349f313bb8edfe177a39"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MDA5MTcx", "url": "https://github.com/ls1intum/Artemis/pull/2414#pullrequestreview-536009171", "createdAt": "2020-11-21T21:10:25Z", "commit": {"oid": "e14d2981f9d7b2a2edb1349f313bb8edfe177a39"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MDk5MzYy", "url": "https://github.com/ls1intum/Artemis/pull/2414#pullrequestreview-536099362", "createdAt": "2020-11-22T18:08:30Z", "commit": {"oid": "e14d2981f9d7b2a2edb1349f313bb8edfe177a39"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48149003978efb83354c224ca88e47b958e75db3", "author": {"user": {"login": "fde312", "name": "Francisco De las Casas Young"}}, "url": "https://github.com/ls1intum/Artemis/commit/48149003978efb83354c224ca88e47b958e75db3", "committedDate": "2020-11-23T12:34:47Z", "message": "Merge branch 'develop' into feature/upgrade-repos"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NTUyMDI4", "url": "https://github.com/ls1intum/Artemis/pull/2414#pullrequestreview-536552028", "createdAt": "2020-11-23T14:58:09Z", "commit": {"oid": "48149003978efb83354c224ca88e47b958e75db3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NjE2OTU2", "url": "https://github.com/ls1intum/Artemis/pull/2414#pullrequestreview-536616956", "createdAt": "2020-11-23T16:02:01Z", "commit": {"oid": "48149003978efb83354c224ca88e47b958e75db3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2ODY5MjUy", "url": "https://github.com/ls1intum/Artemis/pull/2414#pullrequestreview-536869252", "createdAt": "2020-11-23T21:45:07Z", "commit": {"oid": "48149003978efb83354c224ca88e47b958e75db3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3675, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}