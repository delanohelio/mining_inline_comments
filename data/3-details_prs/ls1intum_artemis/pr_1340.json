{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4MjAzOTU5", "number": 1340, "title": "Performance improvement for courses on dashboard", "bodyText": "Due to a change in one hibernate query, the performance of the courses for dashboard REST call (to initially load all data for the course overview) has deteriorated.\nThe problem was the use of or within a join condition, which could not be optimized by the database.\nThe performance of the initial courses for dashboard REST call was 5x - 10x slower than usual.\nThis PR fixes the problem by splitting the problematic query into two distinct ones, one for individual and one for team exercises. It also avoids two eager attributes in Exercise which can be fetched differently.\nChecklist\n\n I tested all changes and all related features with different users (student, tutor, instructor, admin) on the test server https://artemistest.ase.in.tum.de.\n\nSteps for Testing\n\nOpen developer tools\nLog in to Artemis\nNavigate between Course Overview and Course Administration\nCheck that the REST call courses for dashboard is less than 100ms.\nCheck that categories and team config are displayed correctly in course overview (students) and when editing exercises (course administration)\n\nNo UI changes, no changes to tests needed", "createdAt": "2020-04-23T21:17:20Z", "url": "https://github.com/ls1intum/Artemis/pull/1340", "merged": true, "mergeCommit": {"oid": "7453074fad2c8f01e0d29450ea6940e24f5b3f55"}, "closed": true, "closedAt": "2020-04-27T12:42:45Z", "author": {"login": "madwau"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcajDlFAH2gAyNDA4MjAzOTU5OmEwMzgxZjgwY2FkZWQ5MzUzZDcyZmFmZTMzOGM5MmQ1MTNiNGI3NmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcaxf0cgFqTM5OTkzODk5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a0381f80caded9353d72fafe338c92d513b4b76d", "author": {"user": null}, "url": "https://github.com/ls1intum/Artemis/commit/a0381f80caded9353d72fafe338c92d513b4b76d", "committedDate": "2020-04-23T20:38:42Z", "message": "start to improve performance for courses-for-dashboard\n\nWork in progress"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aaf34f39be49b2ac07498f6c88ca1f5363078885", "author": {"user": null}, "url": "https://github.com/ls1intum/Artemis/commit/aaf34f39be49b2ac07498f6c88ca1f5363078885", "committedDate": "2020-04-23T20:42:20Z", "message": "fetch with team assignment config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1143ffb908b481f581e56441c9da443704e5eb13", "author": {"user": {"login": "madwau", "name": "Martin Wauligmann"}}, "url": "https://github.com/ls1intum/Artemis/commit/1143ffb908b481f581e56441c9da443704e5eb13", "committedDate": "2020-04-23T21:05:40Z", "message": "Split exercises into individual and team exercises in dashboard endpoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e85a38bc3b37518baafa08de92b219dead4946e", "author": {"user": {"login": "madwau", "name": "Martin Wauligmann"}}, "url": "https://github.com/ls1intum/Artemis/commit/1e85a38bc3b37518baafa08de92b219dead4946e", "committedDate": "2020-04-23T21:30:33Z", "message": "Merge branch 'develop' into performance/courses-for-dashboard"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a92c061b32c88ee52740458b5ccf4f23b19ff9e8", "author": {"user": {"login": "madwau", "name": "Martin Wauligmann"}}, "url": "https://github.com/ls1intum/Artemis/commit/a92c061b32c88ee52740458b5ccf4f23b19ff9e8", "committedDate": "2020-04-23T21:34:30Z", "message": "Load team assignment config when needed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0520402a080d1b8ad84375b756c9925909a32a9", "author": {"user": null}, "url": "https://github.com/ls1intum/Artemis/commit/d0520402a080d1b8ad84375b756c9925909a32a9", "committedDate": "2020-04-23T22:00:05Z", "message": "improve log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d93cb2e61121abf6d5d78ef231767365596c4ad", "author": {"user": {"login": "madwau", "name": "Martin Wauligmann"}}, "url": "https://github.com/ls1intum/Artemis/commit/6d93cb2e61121abf6d5d78ef231767365596c4ad", "committedDate": "2020-04-23T22:03:39Z", "message": "Fix activeExercises size in log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47c88f46acb0aec4fe0a254520754fbcacdf8ddd", "author": {"user": null}, "url": "https://github.com/ls1intum/Artemis/commit/47c88f46acb0aec4fe0a254520754fbcacdf8ddd", "committedDate": "2020-04-23T22:05:37Z", "message": "Merge branch 'performance/courses-for-dashboard' of https://github.com/ls1intum/Artemis into performance/courses-for-dashboard\n\n# Conflicts:\n#\tsrc/main/java/de/tum/in/www1/artemis/web/rest/CourseResource.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74fabfc717f2b4d886660af31ff3be1a8f3173a7", "author": {"user": null}, "url": "https://github.com/ls1intum/Artemis/commit/74fabfc717f2b4d886660af31ff3be1a8f3173a7", "committedDate": "2020-04-23T22:18:27Z", "message": "eagerly fetch categories more often"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "321e2079bdc807ffda6273aecf8bcbc0beeed9be", "author": {"user": {"login": "krusche", "name": "Stephan Krusche"}}, "url": "https://github.com/ls1intum/Artemis/commit/321e2079bdc807ffda6273aecf8bcbc0beeed9be", "committedDate": "2020-04-24T12:51:37Z", "message": "Merge branch 'develop' into performance/courses-for-dashboard"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5OTM4OTk2", "url": "https://github.com/ls1intum/Artemis/pull/1340#pullrequestreview-399938996", "createdAt": "2020-04-24T13:20:37Z", "commit": {"oid": "321e2079bdc807ffda6273aecf8bcbc0beeed9be"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMzoyMDozN1rOGLXW-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMzoyNjozN1rOGLXoGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU3MDIzNQ==", "bodyText": "I'm not sure if this is relevant, but the method name no longer indicates exactly what is loaded.", "url": "https://github.com/ls1intum/Artemis/pull/1340#discussion_r414570235", "createdAt": "2020-04-24T13:20:37Z", "author": {"login": "sleiss"}, "path": "src/main/java/de/tum/in/www1/artemis/repository/CourseRepository.java", "diffHunk": "@@ -32,7 +32,7 @@\n     @Query(\"select distinct course from Course course left join fetch course.exercises exercises left join fetch course.lectures lectures left join fetch lectures.attachments left join fetch exercises.categories where (course.startDate <= current_timestamp or course.startDate is null) and (course.endDate >= current_timestamp or course.endDate is null)\")\n     List<Course> findAllActiveWithEagerExercisesAndLectures();\n \n-    @EntityGraph(type = LOAD, attributePaths = { \"exercises\" })\n+    @EntityGraph(type = LOAD, attributePaths = { \"exercises\", \"exercises.categories\", \"exercises.teamAssignmentConfig\" })\n     Course findWithEagerExercisesById(long courseId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "321e2079bdc807ffda6273aecf8bcbc0beeed9be"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU3MTQzMw==", "bodyText": "Same as above, the name does not reflect the attributePaths anymore.", "url": "https://github.com/ls1intum/Artemis/pull/1340#discussion_r414571433", "createdAt": "2020-04-24T13:22:16Z", "author": {"login": "sleiss"}, "path": "src/main/java/de/tum/in/www1/artemis/repository/ModelingExerciseRepository.java", "diffHunk": "@@ -20,7 +23,7 @@\n     @Query(\"SELECT e FROM ModelingExercise e WHERE e.course.id = :#{#courseId}\")\n     List<ModelingExercise> findByCourseId(@Param(\"courseId\") Long courseId);\n \n-    @Query(\"select distinct modelingExercise from ModelingExercise modelingExercise left join fetch modelingExercise.exampleSubmissions where modelingExercise.id = :#{#exerciseId}\")\n-    Optional<ModelingExercise> findByIdWithEagerExampleSubmissions(@Param(\"exerciseId\") Long exerciseId);\n+    @EntityGraph(type = LOAD, attributePaths = { \"exampleSubmissions\", \"teamAssignmentConfig\", \"categories\" })\n+    Optional<ModelingExercise> findWithEagerExampleSubmissionsById(@Param(\"exerciseId\") Long exerciseId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "321e2079bdc807ffda6273aecf8bcbc0beeed9be"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU3MTUzNA==", "bodyText": "Same as above, the name does not reflect the attributePaths anymore.", "url": "https://github.com/ls1intum/Artemis/pull/1340#discussion_r414571534", "createdAt": "2020-04-24T13:22:26Z", "author": {"login": "sleiss"}, "path": "src/main/java/de/tum/in/www1/artemis/repository/ProgrammingExerciseRepository.java", "diffHunk": "@@ -29,7 +29,7 @@\n     @Query(\"select distinct pe from ProgrammingExercise pe left join fetch pe.templateParticipation tp left join fetch pe.solutionParticipation sp left join fetch tp.results as tpr left join fetch sp.results as spr where pe.course.id = :#{#courseId} and (tpr.id = (select max(id) from tp.results) or tpr.id = null) and (spr.id = (select max(id) from sp.results) or spr.id = null)\")\n     List<ProgrammingExercise> findByCourseIdWithLatestResultForTemplateSolutionParticipations(@Param(\"courseId\") Long courseId);\n \n-    @EntityGraph(type = LOAD, attributePaths = { \"templateParticipation\", \"solutionParticipation\" })\n+    @EntityGraph(type = LOAD, attributePaths = { \"templateParticipation\", \"solutionParticipation\", \"teamAssignmentConfig\", \"categories\" })\n     Optional<ProgrammingExercise> findWithTemplateParticipationAndSolutionParticipationById(Long exerciseId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "321e2079bdc807ffda6273aecf8bcbc0beeed9be"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU3NDYxOQ==", "bodyText": "Are there any cases where activeExercises is not empty but both activeIndividualExercises and activeTeamExercises are? If not, can we simplify it to:\nactiveExercises.isEmpty()? (Was like this before).", "url": "https://github.com/ls1intum/Artemis/pull/1340#discussion_r414574619", "createdAt": "2020-04-24T13:26:37Z", "author": {"login": "sleiss"}, "path": "src/main/java/de/tum/in/www1/artemis/web/rest/CourseResource.java", "diffHunk": "@@ -422,15 +423,29 @@ private void validateComplaintsConfig(Course course) {\n \n         // get all courses with exercises for this user\n         List<Course> courses = courseService.findAllActiveWithExercisesAndLecturesForUser(user);\n-        Set<Exercise> activeExercises = courses.stream().flatMap(course -> course.getExercises().stream()).collect(Collectors.toSet());\n-        log.debug(\"          /courses/for-dashboard.findAllActiveWithExercisesForUser in \" + (System.currentTimeMillis() - start) + \"ms\");\n+        log.debug(\"          /courses/for-dashboard.findAllActiveWithExercisesAndLecturesForUser in \" + (System.currentTimeMillis() - start) + \"ms\");\n \n-        if (activeExercises.isEmpty()) {\n+        Map<ExerciseMode, List<Exercise>> activeExercises = courses.stream().flatMap(course -> course.getExercises().stream()).collect(Collectors.groupingBy(Exercise::getMode));\n+        List<Exercise> activeIndividualExercises = Optional.ofNullable(activeExercises.get(ExerciseMode.INDIVIDUAL)).orElse(List.of());\n+        List<Exercise> activeTeamExercises = Optional.ofNullable(activeExercises.get(ExerciseMode.TEAM)).orElse(List.of());\n+\n+        if (activeIndividualExercises.isEmpty() && activeTeamExercises.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "321e2079bdc807ffda6273aecf8bcbc0beeed9be"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2937, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}