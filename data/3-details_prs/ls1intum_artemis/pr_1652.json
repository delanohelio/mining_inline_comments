{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0MjAyMTg4", "number": 1652, "title": "Server side implementation to register students in exams", "bodyText": "Checklist\n\n Server: I added multiple integration tests (Spring) related to the features\n Server: I added @PreAuthorize and check the course groups for all new REST Calls (security)\n Server: I implemented the changes with a good performance and prevented too many database calls\n Server: I documented the Java code using JavaDoc style.\n\nMotivation and Context\nInstructors want to register students to an exam.\nDescription\nThis PR includes the server side implementation to add students to exam.\nThe client side implementation will follow in a separate PR by @madwau in the next days.\nThere are 3 new REST Calls:\n\nAdd one student to the exam (based on the login)\nRemove one student from the exam (based on the login)\nAdd multiple students to the exam (based on the registration number)\n\nThe most interesting one is (3). Instructors will be able to choose a CSV file exported from TUM Online that contains students and the registration number. The list of students (with the registration number) can then be sent to the server. The server tries to find the corresponding user objects and adds them to the registeredUser list in the exam.\na) First, the server tries to find an existing user in the database\nb) If one user with the given registration number cannot be found, the server tries to retrieve the user data from the TUM LDAP and will create a new Artemis user. Then, it should be possible that the actual user logs into Artemis (for the first time) shortly before the exam, and the user then has access to the course and the exam.\nAdditional notes:\nThis PR also removes the LDAP search for users without registration number right after the app start, which is not really necessary! You can see the removed lines in the method applicationReady() in UserService.\nSteps for Testing\nYou can only test the changes at the moment by sending REST requests to the server. The changes will be tested thoroughly when the client implementation is available.\nI tested the LDAP search for \"non\" Artemis users locally with my own registration number. We can surely test this better on the test server as soon as the client side functionality is available.", "createdAt": "2020-06-14T21:06:27Z", "url": "https://github.com/ls1intum/Artemis/pull/1652", "merged": true, "mergeCommit": {"oid": "9f71b69988d66015e910cd91fb2b3721515087d8"}, "closed": true, "closedAt": "2020-06-15T20:20:43Z", "author": {"login": "krusche"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcrRlxSAH2gAyNDM0MjAyMTg4OjhlN2JkMTE3N2EyNWVkY2MzM2YzOGZmMGEwZGU3YTRkODc2ZGUwMDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcrmh9vgFqTQzMDk2MjY2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8e7bd1177a25edcc33f38ff0a0de7a4d876de001", "author": {"user": null}, "url": "https://github.com/ls1intum/Artemis/commit/8e7bd1177a25edcc33f38ff0a0de7a4d876de001", "committedDate": "2020-06-14T19:54:28Z", "message": "server implementation for registration of students in an exam"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d934a7aae52e9924cf615127bd004cafe66ef6d3", "author": {"user": null}, "url": "https://github.com/ls1intum/Artemis/commit/d934a7aae52e9924cf615127bd004cafe66ef6d3", "committedDate": "2020-06-14T20:54:51Z", "message": "Merge branch 'develop' into exam/management/register-students\n\n# Conflicts:\n#\tsrc/main/java/de/tum/in/www1/artemis/repository/ExamRepository.java\n#\tsrc/main/java/de/tum/in/www1/artemis/service/ExamService.java\n#\tsrc/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java\n#\tsrc/test/java/de/tum/in/www1/artemis/ExamIntegrationTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d9b3cfa79cde5fe638f18a8b40e4ea042ed466b", "author": {"user": {"login": "krusche", "name": "Stephan Krusche"}}, "url": "https://github.com/ls1intum/Artemis/commit/2d9b3cfa79cde5fe638f18a8b40e4ea042ed466b", "committedDate": "2020-06-14T21:23:59Z", "message": "Merge branch 'develop' into exam/management/register-students"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMjUyNzY2", "url": "https://github.com/ls1intum/Artemis/pull/1652#pullrequestreview-430252766", "createdAt": "2020-06-14T21:31:28Z", "commit": {"oid": "2d9b3cfa79cde5fe638f18a8b40e4ea042ed466b"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQyMTozMToyOVrOGjfgSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQyMjowMTowOFrOGjfo7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg2OTUxMw==", "bodyText": "Why removing the TODO?\nThe length of the method won't go away.", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r439869513", "createdAt": "2020-06-14T21:31:29Z", "author": {"login": "julian-christl"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/jira/JiraAuthenticationProvider.java", "diffHunk": "@@ -120,7 +120,6 @@ public User getOrCreateUser(Authentication authentication, String firstName, Str\n         return getOrCreateUser(authentication, skipPasswordCheck);\n     }\n \n-    // TODO this method is way too long, split it up", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d9b3cfa79cde5fe638f18a8b40e4ea042ed466b"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg2OTY1MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static final String TUM_LDAP_MATRIKEL_NUMBER = \"imMatrikelNr\";\n          \n          \n            \n                public static final String TUM_LDAP_REGISTRATION_NUMBER = \"imMatrikelNr\";\n          \n      \n    \n    \n  \n\nSince you use the term \"registration number\" for all your attributes I think it would make sense to use it here too.", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r439869650", "createdAt": "2020-06-14T21:33:04Z", "author": {"login": "julian-christl"}, "path": "src/main/java/de/tum/in/www1/artemis/config/Constants.java", "diffHunk": "@@ -71,6 +71,8 @@\n \n     public static final Pattern TITLE_NAME_PATTERN = Pattern.compile(\"^[a-zA-Z0-9_\\\\-\\\\s]*\");\n \n+    public static final String TUM_LDAP_MATRIKEL_NUMBER = \"imMatrikelNr\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d9b3cfa79cde5fe638f18a8b40e4ea042ed466b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg2OTg4Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        return forbidden();\n          \n          \n            \n                        return conflict();\n          \n      \n    \n    \n  \n\nWe introduced a new HTTP status earlier this weekend I think it would fit here.", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r439869882", "createdAt": "2020-06-14T21:35:54Z", "author": {"login": "julian-christl"}, "path": "src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java", "diffHunk": "@@ -177,4 +186,119 @@ public ExamResource(UserService userService, ExamService examService, ExamAccess\n \n         return ResponseEntity.ok().headers(HeaderUtil.createEntityDeletionAlert(applicationName, true, ENTITY_NAME, exam.getTitle())).build();\n     }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students/:studentLogin : Add one single given user (based on the login) to the students of the exam so that the student can access the exam\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param studentLogin the login of the user who should get student access\n+     * @return empty ResponseEntity with status 200 (OK) or with status 404 (Not Found)\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<Void> addStudentToCourse(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+        log.debug(\"REST request to add {} as student to exam : {}\", studentLogin, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return forbidden();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d9b3cfa79cde5fe638f18a8b40e4ea042ed466b"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg3MDA2MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        return forbidden();\n          \n          \n            \n                        return conflict();\n          \n      \n    \n    \n  \n\nWe introduced a new HTTP status earlier this weekend I think it would fit here.", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r439870060", "createdAt": "2020-06-14T21:38:08Z", "author": {"login": "julian-christl"}, "path": "src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java", "diffHunk": "@@ -177,4 +186,119 @@ public ExamResource(UserService userService, ExamService examService, ExamAccess\n \n         return ResponseEntity.ok().headers(HeaderUtil.createEntityDeletionAlert(applicationName, true, ENTITY_NAME, exam.getTitle())).build();\n     }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students/:studentLogin : Add one single given user (based on the login) to the students of the exam so that the student can access the exam\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param studentLogin the login of the user who should get student access\n+     * @return empty ResponseEntity with status 200 (OK) or with status 404 (Not Found)\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<Void> addStudentToCourse(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+        log.debug(\"REST request to add {} as student to exam : {}\", studentLogin, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return forbidden();\n+        }\n+        Optional<User> student = userService.getUserWithGroupsAndAuthoritiesByLogin(studentLogin);\n+        if (student.isEmpty()) {\n+            return notFound();\n+        }\n+        exam.addUser(student.get());\n+        examRepository.save(exam);\n+        return ResponseEntity.ok().body(null);\n+    }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students : Add multiple users to the students of the exam so that they can access the exam\n+     * The passed list of UserDTOs must include the registration number (the other entries are currently ignored and can be left out)\n+     * Note: registration based on other user attributes (e.g. email, name, login) is currently NOT supported\n+     *\n+     * This method first tries to find the student in the internal Artemis user database (because the user is most probably already using Artemis).\n+     * In case the user cannot be found, we additionally search the (TUM) LDAP in case it is configured properly.\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param students     the list of students (with at least registration number) who should get access to the exam\n+     * @return             the list of students who could not be registered for the exam, because they could NOT be found in the Artemis database and could NOT be found in the TUM LDAP\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<List<StudentDTO>> addStudentToCourse(@PathVariable Long courseId, @PathVariable Long examId, @RequestBody List<StudentDTO> students) {\n+        log.debug(\"REST request to add {} as students to exam : {}\", students, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return forbidden();\n+        }\n+        List<StudentDTO> notFoundStudents = new ArrayList<>();\n+        for (var student : students) {\n+            var registrationNumber = student.getRegistrationNumber();\n+            // 1) we use the registration number and try to find the student in the Artemis user database\n+            Optional<User> user = userService.findUserWithGroupsAndAuthoritiesByRegistrationNumber(registrationNumber);\n+            if (user.isPresent()) {\n+                exam.addUser(user.get());\n+                // we only need to add the user to the course group, if the student is not yet part of it, otherwise the student cannot access the exam (within the course)\n+                if (!user.get().getGroups().contains(course.getStudentGroupName())) {\n+                    userService.addUserToGroup(user.get(), course.getStudentGroupName());\n+                }\n+                continue;\n+            }\n+            // 2) if we cannot find the user, we use the registration number and try to find the student in the (TUM) LDAP\n+            user = userService.createUserFromLdap(registrationNumber);\n+            if (user.isPresent()) {\n+                exam.addUser(user.get());\n+                // the newly created user needs to get the rights to access the course, otherwise the student cannot access the exam (within the course)\n+                userService.addUserToGroup(user.get(), course.getStudentGroupName());\n+                continue;\n+            }\n+            // 3) if we cannot find the user in the (TUM) LDAP, we report this to the client\n+            log.warn(\"User with registration number \" + registrationNumber + \" not found in Artemis user database and not found in (TUM) LDAP\");\n+            notFoundStudents.add(student);\n+        }\n+        examRepository.save(exam);\n+        return ResponseEntity.ok().body(notFoundStudents);\n+    }\n+\n+    /**\n+     * DELETE /courses/:courseId/exams/:examId/students/:studentLogin : Remove one single given user (based on the login) from the students of the exam so that the student cannot access the exam any more\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param studentLogin the login of the user who should lose student access\n+     * @return empty ResponseEntity with status 200 (OK) or with status 404 (Not Found)\n+     */\n+    @DeleteMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<Void> removeStudentFromExam(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+        log.debug(\"REST request to remove {} as student from exam : {}\", studentLogin, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return forbidden();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d9b3cfa79cde5fe638f18a8b40e4ea042ed466b"}, "originalPosition": 164}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg3MDE2OA==", "bodyText": "If I see this correctly if the user is not part of the exam but has access to the course there will still be a HTTP 200, right? I think that should either be a HTTP 404 or HTTP 409 as well in that case.", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r439870168", "createdAt": "2020-06-14T21:39:52Z", "author": {"login": "julian-christl"}, "path": "src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java", "diffHunk": "@@ -177,4 +186,119 @@ public ExamResource(UserService userService, ExamService examService, ExamAccess\n \n         return ResponseEntity.ok().headers(HeaderUtil.createEntityDeletionAlert(applicationName, true, ENTITY_NAME, exam.getTitle())).build();\n     }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students/:studentLogin : Add one single given user (based on the login) to the students of the exam so that the student can access the exam\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param studentLogin the login of the user who should get student access\n+     * @return empty ResponseEntity with status 200 (OK) or with status 404 (Not Found)\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<Void> addStudentToCourse(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+        log.debug(\"REST request to add {} as student to exam : {}\", studentLogin, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return forbidden();\n+        }\n+        Optional<User> student = userService.getUserWithGroupsAndAuthoritiesByLogin(studentLogin);\n+        if (student.isEmpty()) {\n+            return notFound();\n+        }\n+        exam.addUser(student.get());\n+        examRepository.save(exam);\n+        return ResponseEntity.ok().body(null);\n+    }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students : Add multiple users to the students of the exam so that they can access the exam\n+     * The passed list of UserDTOs must include the registration number (the other entries are currently ignored and can be left out)\n+     * Note: registration based on other user attributes (e.g. email, name, login) is currently NOT supported\n+     *\n+     * This method first tries to find the student in the internal Artemis user database (because the user is most probably already using Artemis).\n+     * In case the user cannot be found, we additionally search the (TUM) LDAP in case it is configured properly.\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param students     the list of students (with at least registration number) who should get access to the exam\n+     * @return             the list of students who could not be registered for the exam, because they could NOT be found in the Artemis database and could NOT be found in the TUM LDAP\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<List<StudentDTO>> addStudentToCourse(@PathVariable Long courseId, @PathVariable Long examId, @RequestBody List<StudentDTO> students) {\n+        log.debug(\"REST request to add {} as students to exam : {}\", students, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return forbidden();\n+        }\n+        List<StudentDTO> notFoundStudents = new ArrayList<>();\n+        for (var student : students) {\n+            var registrationNumber = student.getRegistrationNumber();\n+            // 1) we use the registration number and try to find the student in the Artemis user database\n+            Optional<User> user = userService.findUserWithGroupsAndAuthoritiesByRegistrationNumber(registrationNumber);\n+            if (user.isPresent()) {\n+                exam.addUser(user.get());\n+                // we only need to add the user to the course group, if the student is not yet part of it, otherwise the student cannot access the exam (within the course)\n+                if (!user.get().getGroups().contains(course.getStudentGroupName())) {\n+                    userService.addUserToGroup(user.get(), course.getStudentGroupName());\n+                }\n+                continue;\n+            }\n+            // 2) if we cannot find the user, we use the registration number and try to find the student in the (TUM) LDAP\n+            user = userService.createUserFromLdap(registrationNumber);\n+            if (user.isPresent()) {\n+                exam.addUser(user.get());\n+                // the newly created user needs to get the rights to access the course, otherwise the student cannot access the exam (within the course)\n+                userService.addUserToGroup(user.get(), course.getStudentGroupName());\n+                continue;\n+            }\n+            // 3) if we cannot find the user in the (TUM) LDAP, we report this to the client\n+            log.warn(\"User with registration number \" + registrationNumber + \" not found in Artemis user database and not found in (TUM) LDAP\");\n+            notFoundStudents.add(student);\n+        }\n+        examRepository.save(exam);\n+        return ResponseEntity.ok().body(notFoundStudents);\n+    }\n+\n+    /**\n+     * DELETE /courses/:courseId/exams/:examId/students/:studentLogin : Remove one single given user (based on the login) from the students of the exam so that the student cannot access the exam any more\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param studentLogin the login of the user who should lose student access\n+     * @return empty ResponseEntity with status 200 (OK) or with status 404 (Not Found)\n+     */\n+    @DeleteMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<Void> removeStudentFromExam(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+        log.debug(\"REST request to remove {} as student from exam : {}\", studentLogin, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return forbidden();\n+        }\n+        Optional<User> student = userService.getUserWithGroupsAndAuthoritiesByLogin(studentLogin);\n+        if (student.isEmpty()) {\n+            return notFound();\n+        }\n+        exam.removeUser(student.get());\n+        examRepository.save(exam);\n+        return ResponseEntity.ok().body(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d9b3cfa79cde5fe638f18a8b40e4ea042ed466b"}, "originalPosition": 172}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg3MDI2NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        return forbidden();\n          \n          \n            \n                        return conflict();\n          \n      \n    \n    \n  \n\nWe introduced a new HTTP status earlier this weekend I think it would fit here.", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r439870264", "createdAt": "2020-06-14T21:40:44Z", "author": {"login": "julian-christl"}, "path": "src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java", "diffHunk": "@@ -177,4 +186,119 @@ public ExamResource(UserService userService, ExamService examService, ExamAccess\n \n         return ResponseEntity.ok().headers(HeaderUtil.createEntityDeletionAlert(applicationName, true, ENTITY_NAME, exam.getTitle())).build();\n     }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students/:studentLogin : Add one single given user (based on the login) to the students of the exam so that the student can access the exam\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param studentLogin the login of the user who should get student access\n+     * @return empty ResponseEntity with status 200 (OK) or with status 404 (Not Found)\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<Void> addStudentToCourse(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+        log.debug(\"REST request to add {} as student to exam : {}\", studentLogin, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return forbidden();\n+        }\n+        Optional<User> student = userService.getUserWithGroupsAndAuthoritiesByLogin(studentLogin);\n+        if (student.isEmpty()) {\n+            return notFound();\n+        }\n+        exam.addUser(student.get());\n+        examRepository.save(exam);\n+        return ResponseEntity.ok().body(null);\n+    }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students : Add multiple users to the students of the exam so that they can access the exam\n+     * The passed list of UserDTOs must include the registration number (the other entries are currently ignored and can be left out)\n+     * Note: registration based on other user attributes (e.g. email, name, login) is currently NOT supported\n+     *\n+     * This method first tries to find the student in the internal Artemis user database (because the user is most probably already using Artemis).\n+     * In case the user cannot be found, we additionally search the (TUM) LDAP in case it is configured properly.\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param students     the list of students (with at least registration number) who should get access to the exam\n+     * @return             the list of students who could not be registered for the exam, because they could NOT be found in the Artemis database and could NOT be found in the TUM LDAP\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<List<StudentDTO>> addStudentToCourse(@PathVariable Long courseId, @PathVariable Long examId, @RequestBody List<StudentDTO> students) {\n+        log.debug(\"REST request to add {} as students to exam : {}\", students, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return forbidden();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d9b3cfa79cde5fe638f18a8b40e4ea042ed466b"}, "originalPosition": 114}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg3MTcyNg==", "bodyText": "Could this be an improvement? I think you can cut the for loop there and improve the performance through intelligend Database queries instead of tackeling this one by one.\nDon't know for sure though. Would be interesting what you think.\nKeep in mind this was only written in Github not with a proper IDE and I invented some \"multiple count\"-variations of already existing methods were I thought it would help the performance. This is not a safe and finished code.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    List<StudentDTO> notFoundStudents = new ArrayList<>();\n          \n          \n            \n                    for (var student : students) {\n          \n          \n            \n                        var registrationNumber = student.getRegistrationNumber();\n          \n          \n            \n                        // 1) we use the registration number and try to find the student in the Artemis user database\n          \n          \n            \n                        Optional<User> user = userService.findUserWithGroupsAndAuthoritiesByRegistrationNumber(registrationNumber);\n          \n          \n            \n                        if (user.isPresent()) {\n          \n          \n            \n                            exam.addUser(user.get());\n          \n          \n            \n                            // we only need to add the user to the course group, if the student is not yet part of it, otherwise the student cannot access the exam (within the course)\n          \n          \n            \n                            if (!user.get().getGroups().contains(course.getStudentGroupName())) {\n          \n          \n            \n                                userService.addUserToGroup(user.get(), course.getStudentGroupName());\n          \n          \n            \n                            }\n          \n          \n            \n                            continue;\n          \n          \n            \n                        }\n          \n          \n            \n                        // 2) if we cannot find the user, we use the registration number and try to find the student in the (TUM) LDAP\n          \n          \n            \n                        user = userService.createUserFromLdap(registrationNumber);\n          \n          \n            \n                        if (user.isPresent()) {\n          \n          \n            \n                            exam.addUser(user.get());\n          \n          \n            \n                            // the newly created user needs to get the rights to access the course, otherwise the student cannot access the exam (within the course)\n          \n          \n            \n                            userService.addUserToGroup(user.get(), course.getStudentGroupName());\n          \n          \n            \n                            continue;\n          \n          \n            \n                        }\n          \n          \n            \n                        // 3) if we cannot find the user in the (TUM) LDAP, we report this to the client\n          \n          \n            \n                        log.warn(\"User with registration number \" + registrationNumber + \" not found in Artemis user database and not found in (TUM) LDAP\");\n          \n          \n            \n                        notFoundStudents.add(student);\n          \n          \n            \n                    }\n          \n          \n            \n                    examRepository.save(exam);\n          \n          \n            \n                    return ResponseEntity.ok().body(notFoundStudents);\n          \n          \n            \n                }\n          \n          \n            \n                    List<String> registrationNumbers = students.stream().map(StudentDTO::getRegistrationNumber()).collect(Collections.toList());\n          \n          \n            \n                    List<User> artemisUsers = userService.findAllUsersWithGroupsAndAuthoritiesByRegistrationNumber(registrationNumbers);\n          \n          \n            \n                    exam.addAllUsers(artemisUsers);\n          \n          \n            \n                    \n          \n          \n            \n                    //Get only registration numbers in here that are not present in artemis\n          \n          \n            \n                    registrationNumbers.removeAll(artemisUsers.stream().map(User::getRegistrationNumber()).collect(Collections.toList());\n          \n          \n            \n                    List<User> artemisUsersFromLdap = registrationNumbers.stream().map(e->userService.createUserFromLdap(e)).collect(Collections.toList());\n          \n          \n            \n                    exam.addAllUsers(artemisUsersFromLdap);\n          \n          \n            \n                    userService.addUsersToGroup(artemisUsersFromLdap, course.getStudentGroupName());\n          \n          \n            \n                    \n          \n          \n            \n                    //Get only registration numbers in here that were not found at all\n          \n          \n            \n                    registrationNumbers.removeAll(artemisUsersFromLdap.stream().map(User::getRegistrationNumber()).collect(Collections.toList());\n          \n          \n            \n                    \n          \n          \n            \n                    //ToDo: print proper warning\n          \n          \n            \n                        // 3) if we cannot find the user in the (TUM) LDAP, we report this to the client\n          \n          \n            \n                        log.warn(\"User with registration number \" + registrationNumber + \" not found in Artemis user database and not found in (TUM) LDAP\");\n          \n          \n            \n                    examRepository.save(exam);\n          \n          \n            \n                    \n          \n          \n            \n                    return ResponseEntity.ok().body(students.stream.filter(e->registrationNumbers.contains(e.getRegistrationNumber())).collect(Collections.toList()));\n          \n          \n            \n                }", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r439871726", "createdAt": "2020-06-14T22:01:08Z", "author": {"login": "julian-christl"}, "path": "src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java", "diffHunk": "@@ -177,4 +186,119 @@ public ExamResource(UserService userService, ExamService examService, ExamAccess\n \n         return ResponseEntity.ok().headers(HeaderUtil.createEntityDeletionAlert(applicationName, true, ENTITY_NAME, exam.getTitle())).build();\n     }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students/:studentLogin : Add one single given user (based on the login) to the students of the exam so that the student can access the exam\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param studentLogin the login of the user who should get student access\n+     * @return empty ResponseEntity with status 200 (OK) or with status 404 (Not Found)\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<Void> addStudentToCourse(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+        log.debug(\"REST request to add {} as student to exam : {}\", studentLogin, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return forbidden();\n+        }\n+        Optional<User> student = userService.getUserWithGroupsAndAuthoritiesByLogin(studentLogin);\n+        if (student.isEmpty()) {\n+            return notFound();\n+        }\n+        exam.addUser(student.get());\n+        examRepository.save(exam);\n+        return ResponseEntity.ok().body(null);\n+    }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students : Add multiple users to the students of the exam so that they can access the exam\n+     * The passed list of UserDTOs must include the registration number (the other entries are currently ignored and can be left out)\n+     * Note: registration based on other user attributes (e.g. email, name, login) is currently NOT supported\n+     *\n+     * This method first tries to find the student in the internal Artemis user database (because the user is most probably already using Artemis).\n+     * In case the user cannot be found, we additionally search the (TUM) LDAP in case it is configured properly.\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param students     the list of students (with at least registration number) who should get access to the exam\n+     * @return             the list of students who could not be registered for the exam, because they could NOT be found in the Artemis database and could NOT be found in the TUM LDAP\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<List<StudentDTO>> addStudentToCourse(@PathVariable Long courseId, @PathVariable Long examId, @RequestBody List<StudentDTO> students) {\n+        log.debug(\"REST request to add {} as students to exam : {}\", students, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return forbidden();\n+        }\n+        List<StudentDTO> notFoundStudents = new ArrayList<>();\n+        for (var student : students) {\n+            var registrationNumber = student.getRegistrationNumber();\n+            // 1) we use the registration number and try to find the student in the Artemis user database\n+            Optional<User> user = userService.findUserWithGroupsAndAuthoritiesByRegistrationNumber(registrationNumber);\n+            if (user.isPresent()) {\n+                exam.addUser(user.get());\n+                // we only need to add the user to the course group, if the student is not yet part of it, otherwise the student cannot access the exam (within the course)\n+                if (!user.get().getGroups().contains(course.getStudentGroupName())) {\n+                    userService.addUserToGroup(user.get(), course.getStudentGroupName());\n+                }\n+                continue;\n+            }\n+            // 2) if we cannot find the user, we use the registration number and try to find the student in the (TUM) LDAP\n+            user = userService.createUserFromLdap(registrationNumber);\n+            if (user.isPresent()) {\n+                exam.addUser(user.get());\n+                // the newly created user needs to get the rights to access the course, otherwise the student cannot access the exam (within the course)\n+                userService.addUserToGroup(user.get(), course.getStudentGroupName());\n+                continue;\n+            }\n+            // 3) if we cannot find the user in the (TUM) LDAP, we report this to the client\n+            log.warn(\"User with registration number \" + registrationNumber + \" not found in Artemis user database and not found in (TUM) LDAP\");\n+            notFoundStudents.add(student);\n+        }\n+        examRepository.save(exam);\n+        return ResponseEntity.ok().body(notFoundStudents);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d9b3cfa79cde5fe638f18a8b40e4ea042ed466b"}, "originalPosition": 143}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMzgwMzg0", "url": "https://github.com/ls1intum/Artemis/pull/1652#pullrequestreview-430380384", "createdAt": "2020-06-15T07:22:09Z", "commit": {"oid": "2d9b3cfa79cde5fe638f18a8b40e4ea042ed466b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwNzoyMjowOVrOGjmA_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwNzoyMjowOVrOGjmA_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk3NjE4OA==", "bodyText": "Maybe it would be a good idea to create the users with a randomised password and send it to them via email. As the users will access their exams from Artemis, there might be data privacy concerns if their accounts are left with an empty password. To my knowledge, it is not possible to change the password later in Artemis?\nThis extension could be part of a follow-up PR.", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r439976188", "createdAt": "2020-06-15T07:22:09Z", "author": {"login": "anditurdiu"}, "path": "src/main/java/de/tum/in/www1/artemis/service/UserService.java", "diffHunk": "@@ -325,6 +311,35 @@ private boolean removeNonActivatedUser(User existingUser) {\n         return true;\n     }\n \n+    /**\n+     * searches the (optional) LDAP service for a user with the give registration number (= Matrikelnummer) and returns a new Artemis user\n+     * Note: this method should only be used if the user does not yet exist in the database\n+     *\n+     * @param registrationNumber the matriculation number of the student\n+     * @return a new user or null if the LDAP user was not found\n+     */\n+    public Optional<User> createUserFromLdap(String registrationNumber) {\n+        if (ldapUserService.isPresent()) {\n+            Optional<LdapUserDto> ldapUserOptional = ldapUserService.get().findByRegistrationNumber(registrationNumber);\n+            if (ldapUserOptional.isPresent()) {\n+                LdapUserDto ldapUser = ldapUserOptional.get();\n+                log.info(\"Ldap User \" + ldapUser.getUsername() + \" has registration number: \" + ldapUser.getRegistrationNumber());\n+                // Use empty password, so that we don't store the credentials of Jira users in the Artemis DB\n+                User user = createUser(ldapUser.getUsername(), \"\", ldapUser.getFirstName(), ldapUser.getLastName(), ldapUser.getEmail(), null, \"en\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d9b3cfa79cde5fe638f18a8b40e4ea042ed466b"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNDYyOTA0", "url": "https://github.com/ls1intum/Artemis/pull/1652#pullrequestreview-430462904", "createdAt": "2020-06-15T09:16:06Z", "commit": {"oid": "2d9b3cfa79cde5fe638f18a8b40e4ea042ed466b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwOToxNjowNlrOGjp4UQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwOToxNjowNlrOGjp4UQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDAzOTUwNQ==", "bodyText": "TODO: make sure the user is actually created in the external authentication provider (e.g. JIRA), otherwise the call below userService.addUserToGroup(..) will throw an exception", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r440039505", "createdAt": "2020-06-15T09:16:06Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java", "diffHunk": "@@ -177,4 +186,119 @@ public ExamResource(UserService userService, ExamService examService, ExamAccess\n \n         return ResponseEntity.ok().headers(HeaderUtil.createEntityDeletionAlert(applicationName, true, ENTITY_NAME, exam.getTitle())).build();\n     }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students/:studentLogin : Add one single given user (based on the login) to the students of the exam so that the student can access the exam\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param studentLogin the login of the user who should get student access\n+     * @return empty ResponseEntity with status 200 (OK) or with status 404 (Not Found)\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<Void> addStudentToCourse(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+        log.debug(\"REST request to add {} as student to exam : {}\", studentLogin, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return forbidden();\n+        }\n+        Optional<User> student = userService.getUserWithGroupsAndAuthoritiesByLogin(studentLogin);\n+        if (student.isEmpty()) {\n+            return notFound();\n+        }\n+        exam.addUser(student.get());\n+        examRepository.save(exam);\n+        return ResponseEntity.ok().body(null);\n+    }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students : Add multiple users to the students of the exam so that they can access the exam\n+     * The passed list of UserDTOs must include the registration number (the other entries are currently ignored and can be left out)\n+     * Note: registration based on other user attributes (e.g. email, name, login) is currently NOT supported\n+     *\n+     * This method first tries to find the student in the internal Artemis user database (because the user is most probably already using Artemis).\n+     * In case the user cannot be found, we additionally search the (TUM) LDAP in case it is configured properly.\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param students     the list of students (with at least registration number) who should get access to the exam\n+     * @return             the list of students who could not be registered for the exam, because they could NOT be found in the Artemis database and could NOT be found in the TUM LDAP\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<List<StudentDTO>> addStudentToCourse(@PathVariable Long courseId, @PathVariable Long examId, @RequestBody List<StudentDTO> students) {\n+        log.debug(\"REST request to add {} as students to exam : {}\", students, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return forbidden();\n+        }\n+        List<StudentDTO> notFoundStudents = new ArrayList<>();\n+        for (var student : students) {\n+            var registrationNumber = student.getRegistrationNumber();\n+            // 1) we use the registration number and try to find the student in the Artemis user database\n+            Optional<User> user = userService.findUserWithGroupsAndAuthoritiesByRegistrationNumber(registrationNumber);\n+            if (user.isPresent()) {\n+                exam.addUser(user.get());\n+                // we only need to add the user to the course group, if the student is not yet part of it, otherwise the student cannot access the exam (within the course)\n+                if (!user.get().getGroups().contains(course.getStudentGroupName())) {\n+                    userService.addUserToGroup(user.get(), course.getStudentGroupName());\n+                }\n+                continue;\n+            }\n+            // 2) if we cannot find the user, we use the registration number and try to find the student in the (TUM) LDAP\n+            user = userService.createUserFromLdap(registrationNumber);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d9b3cfa79cde5fe638f18a8b40e4ea042ed466b"}, "originalPosition": 130}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "624061e0258559f0629e13f94ea9051e350364d1", "author": {"user": null}, "url": "https://github.com/ls1intum/Artemis/commit/624061e0258559f0629e13f94ea9051e350364d1", "committedDate": "2020-06-15T12:47:42Z", "message": "specify JavaDoc in more detail"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "002c8ee88faeb3e6e36b1805b9cf18a824b09de2", "author": {"user": null}, "url": "https://github.com/ls1intum/Artemis/commit/002c8ee88faeb3e6e36b1805b9cf18a824b09de2", "committedDate": "2020-06-15T14:15:00Z", "message": "also create the user in the external user management when they are registered in the exam and can be found using Ldap\n\nrefactor the LDAP integration when user log in on Artemis\nfirst example for mocking the LdapService\napply some of the PR feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNjk5MTY4", "url": "https://github.com/ls1intum/Artemis/pull/1652#pullrequestreview-430699168", "createdAt": "2020-06-15T14:29:30Z", "commit": {"oid": "002c8ee88faeb3e6e36b1805b9cf18a824b09de2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNDoyOTozMFrOGj0vGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNDoyOTozMFrOGj0vGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDIxNzM2OQ==", "bodyText": "This should be Typo instead of Type, also in the 2 other occurrences. Also, we could probably replace \"3456789\" with registrationNumber3.", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r440217369", "createdAt": "2020-06-15T14:29:30Z", "author": {"login": "sleiss"}, "path": "src/test/java/de/tum/in/www1/artemis/ExamIntegrationTest.java", "diffHunk": "@@ -70,22 +75,108 @@\n     private Exam exam1;\n \n     @BeforeEach\n-    public void initTestCase() {\n+    public void initTestCase() throws URISyntaxException {\n         users = database.addUsers(4, 5, 1);\n         course1 = database.addEmptyCourse();\n         course2 = database.addEmptyCourse();\n         exam1 = database.addExam(course1);\n+        jiraRequestMockProvider.enableMockingOfRequests();\n+        jiraRequestMockProvider.mockAddUserToGroup(Set.of(course1.getStudentGroupName()));\n     }\n \n     @AfterEach\n     public void resetDatabase() {\n         database.resetDatabase();\n     }\n \n+    @Test\n+    @WithMockUser(username = \"instructor1\", roles = \"INSTRUCTOR\")\n+    public void registerUsersInExam() throws Exception {\n+\n+        var exam = createExam();\n+        var savedExam = examRepository.save(exam);\n+        var student1 = database.getUserByLogin(\"student1\");\n+        var student2 = database.getUserByLogin(\"student2\");\n+        var student3 = database.getUserByLogin(\"student3\");\n+        var registrationNumber1 = \"1234567\";\n+        var registrationNumber2 = \"2345678\";\n+        var registrationNumber3 = \"3456789\";\n+        var registrationNumber3WithType = \"3456789\" + \"0\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "002c8ee88faeb3e6e36b1805b9cf18a824b09de2"}, "originalPosition": 90}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98d14826ccb3e8ef4d3f33111ce8093d653d48e5", "author": {"user": null}, "url": "https://github.com/ls1intum/Artemis/commit/98d14826ccb3e8ef4d3f33111ce8093d653d48e5", "committedDate": "2020-06-15T14:35:19Z", "message": "fix logic error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35c345dfdabe7dbd14e4a49aea5394a734fec3ba", "author": {"user": null}, "url": "https://github.com/ls1intum/Artemis/commit/35c345dfdabe7dbd14e4a49aea5394a734fec3ba", "committedDate": "2020-06-15T14:46:14Z", "message": "fix Typo in Typo :-D"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ac6dbd444246d934dc05706d749657374950c11", "author": {"user": null}, "url": "https://github.com/ls1intum/Artemis/commit/2ac6dbd444246d934dc05706d749657374950c11", "committedDate": "2020-06-15T16:29:56Z", "message": "further improve server integration tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28215c323f743b5b281e54f6b2d359d809989da4", "author": {"user": null}, "url": "https://github.com/ls1intum/Artemis/commit/28215c323f743b5b281e54f6b2d359d809989da4", "committedDate": "2020-06-15T16:30:24Z", "message": "Merge branch 'develop' into exam/management/register-students"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4d3970f65651b0ce006680282571350b43171ab", "author": {"user": null}, "url": "https://github.com/ls1intum/Artemis/commit/d4d3970f65651b0ce006680282571350b43171ab", "committedDate": "2020-06-15T17:03:05Z", "message": "improve createUserInExternalUserManagement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80773e20d2be5223bc144a69141141c18f462cd4", "author": {"user": null}, "url": "https://github.com/ls1intum/Artemis/commit/80773e20d2be5223bc144a69141141c18f462cd4", "committedDate": "2020-06-15T17:14:25Z", "message": "also add single users to the course student group if they are not yet part of it when they are registered for an exam\n\nsome smaller code improvements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f77c56a97c204915a78901846fa9e30a8bf3b9eb", "author": {"user": null}, "url": "https://github.com/ls1intum/Artemis/commit/f77c56a97c204915a78901846fa9e30a8bf3b9eb", "committedDate": "2020-06-15T17:25:06Z", "message": "fix wrong parameters in mock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d4212faeb47276b33f8e74c1ca4e7ba6bcaaa4f", "author": {"user": null}, "url": "https://github.com/ls1intum/Artemis/commit/8d4212faeb47276b33f8e74c1ca4e7ba6bcaaa4f", "committedDate": "2020-06-15T18:22:56Z", "message": "fix JavaDoc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwOTI3MDM3", "url": "https://github.com/ls1intum/Artemis/pull/1652#pullrequestreview-430927037", "createdAt": "2020-06-15T19:21:53Z", "commit": {"oid": "8d4212faeb47276b33f8e74c1ca4e7ba6bcaaa4f"}, "state": "DISMISSED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxOToyMTo1M1rOGj_iPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxOToyMjo0NVrOGj_kFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM5NDMwMQ==", "bodyText": "We could use checkCourseAndExamAccess() from ExamAccessService here.", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r440394301", "createdAt": "2020-06-15T19:21:53Z", "author": {"login": "sascha11110"}, "path": "src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java", "diffHunk": "@@ -177,4 +186,136 @@ public ExamResource(UserService userService, ExamService examService, ExamAccess\n \n         return ResponseEntity.ok().headers(HeaderUtil.createEntityDeletionAlert(applicationName, true, ENTITY_NAME, exam.getTitle())).build();\n     }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students/:studentLogin : Add one single given user (based on the login) to the students of the exam so that the student can access the exam\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param studentLogin the login of the user who should get student access\n+     * @return empty ResponseEntity with status 200 (OK) or with status 404 (Not Found)\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<Void> addStudentToExam(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+        log.debug(\"REST request to add {} as student to exam : {}\", studentLogin, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return conflict();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d4212faeb47276b33f8e74c1ca4e7ba6bcaaa4f"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM5NDUyOQ==", "bodyText": "We could use checkCourseAndExamAccess() from ExamAccessService here.", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r440394529", "createdAt": "2020-06-15T19:22:21Z", "author": {"login": "sascha11110"}, "path": "src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java", "diffHunk": "@@ -177,4 +186,136 @@ public ExamResource(UserService userService, ExamService examService, ExamAccess\n \n         return ResponseEntity.ok().headers(HeaderUtil.createEntityDeletionAlert(applicationName, true, ENTITY_NAME, exam.getTitle())).build();\n     }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students/:studentLogin : Add one single given user (based on the login) to the students of the exam so that the student can access the exam\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param studentLogin the login of the user who should get student access\n+     * @return empty ResponseEntity with status 200 (OK) or with status 404 (Not Found)\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<Void> addStudentToExam(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+        log.debug(\"REST request to add {} as student to exam : {}\", studentLogin, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return conflict();\n+        }\n+        Optional<User> student = userService.getUserWithGroupsAndAuthoritiesByLogin(studentLogin);\n+        if (student.isEmpty()) {\n+            return notFound();\n+        }\n+        exam.addUser(student.get());\n+        // NOTE: we intentionally add the user to the course group, because the user only has access to the exam of a course, if the student also\n+        // has access to the course of the exam.\n+        // we only need to add the user to the course group, if the student is not yet part of it, otherwise the student cannot access the exam (within the course)\n+        if (!student.get().getGroups().contains(course.getStudentGroupName())) {\n+            userService.addUserToGroup(student.get(), course.getStudentGroupName());\n+        }\n+        examRepository.save(exam);\n+        return ResponseEntity.ok().body(null);\n+    }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students : Add multiple users to the students of the exam so that they can access the exam\n+     * The passed list of UserDTOs must include the registration number (the other entries are currently ignored and can be left out)\n+     * Note: registration based on other user attributes (e.g. email, name, login) is currently NOT supported\n+     *\n+     * This method first tries to find the student in the internal Artemis user database (because the user is most probably already using Artemis).\n+     * In case the user cannot be found, we additionally search the (TUM) LDAP in case it is configured properly.\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param studentDtos     the list of students (with at least registration number) who should get access to the exam\n+     * @return             the list of students who could not be registered for the exam, because they could NOT be found in the Artemis database and could NOT be found in the TUM LDAP\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<List<StudentDTO>> addStudentsToExam(@PathVariable Long courseId, @PathVariable Long examId, @RequestBody List<StudentDTO> studentDtos) {\n+        log.debug(\"REST request to add {} as students to exam {}\", studentDtos, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return conflict();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d4212faeb47276b33f8e74c1ca4e7ba6bcaaa4f"}, "originalPosition": 121}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM5NDc3Mw==", "bodyText": "We could use checkCourseAndExamAccess() from ExamAccessService here.", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r440394773", "createdAt": "2020-06-15T19:22:45Z", "author": {"login": "sascha11110"}, "path": "src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java", "diffHunk": "@@ -177,4 +186,136 @@ public ExamResource(UserService userService, ExamService examService, ExamAccess\n \n         return ResponseEntity.ok().headers(HeaderUtil.createEntityDeletionAlert(applicationName, true, ENTITY_NAME, exam.getTitle())).build();\n     }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students/:studentLogin : Add one single given user (based on the login) to the students of the exam so that the student can access the exam\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param studentLogin the login of the user who should get student access\n+     * @return empty ResponseEntity with status 200 (OK) or with status 404 (Not Found)\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<Void> addStudentToExam(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+        log.debug(\"REST request to add {} as student to exam : {}\", studentLogin, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return conflict();\n+        }\n+        Optional<User> student = userService.getUserWithGroupsAndAuthoritiesByLogin(studentLogin);\n+        if (student.isEmpty()) {\n+            return notFound();\n+        }\n+        exam.addUser(student.get());\n+        // NOTE: we intentionally add the user to the course group, because the user only has access to the exam of a course, if the student also\n+        // has access to the course of the exam.\n+        // we only need to add the user to the course group, if the student is not yet part of it, otherwise the student cannot access the exam (within the course)\n+        if (!student.get().getGroups().contains(course.getStudentGroupName())) {\n+            userService.addUserToGroup(student.get(), course.getStudentGroupName());\n+        }\n+        examRepository.save(exam);\n+        return ResponseEntity.ok().body(null);\n+    }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students : Add multiple users to the students of the exam so that they can access the exam\n+     * The passed list of UserDTOs must include the registration number (the other entries are currently ignored and can be left out)\n+     * Note: registration based on other user attributes (e.g. email, name, login) is currently NOT supported\n+     *\n+     * This method first tries to find the student in the internal Artemis user database (because the user is most probably already using Artemis).\n+     * In case the user cannot be found, we additionally search the (TUM) LDAP in case it is configured properly.\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param studentDtos     the list of students (with at least registration number) who should get access to the exam\n+     * @return             the list of students who could not be registered for the exam, because they could NOT be found in the Artemis database and could NOT be found in the TUM LDAP\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<List<StudentDTO>> addStudentsToExam(@PathVariable Long courseId, @PathVariable Long examId, @RequestBody List<StudentDTO> studentDtos) {\n+        log.debug(\"REST request to add {} as students to exam {}\", studentDtos, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return conflict();\n+        }\n+        List<StudentDTO> notFoundStudentsDtos = new ArrayList<>();\n+        for (var studentDto : studentDtos) {\n+            var registrationNumber = studentDto.getRegistrationNumber();\n+            try {\n+                // 1) we use the registration number and try to find the student in the Artemis user database\n+                Optional<User> optionalStudent = userService.findUserWithGroupsAndAuthoritiesByRegistrationNumber(registrationNumber);\n+                if (optionalStudent.isPresent()) {\n+                    var student = optionalStudent.get();\n+                    exam.addUser(student);\n+                    // we only need to add the student to the course group, if the student is not yet part of it, otherwise the student cannot access the exam (within the course)\n+                    if (!student.getGroups().contains(course.getStudentGroupName())) {\n+                        userService.addUserToGroup(student, course.getStudentGroupName());\n+                    }\n+                    continue;\n+                }\n+                // 2) if we cannot find the student, we use the registration number and try to find the student in the (TUM) LDAP, create it in the Artemis DB and in a potential\n+                // external user management system\n+                optionalStudent = userService.createUserFromLdap(registrationNumber);\n+                if (optionalStudent.isPresent()) {\n+                    var student = optionalStudent.get();\n+                    exam.addUser(student);\n+                    // the newly created student needs to get the rights to access the course, otherwise the student cannot access the exam (within the course)\n+                    userService.addUserToGroup(student, course.getStudentGroupName());\n+                    continue;\n+                }\n+                // 3) if we cannot find the user in the (TUM) LDAP, we report this to the client\n+                log.warn(\"User with registration number \" + registrationNumber + \" not found in Artemis user database and not found in (TUM) LDAP\");\n+            }\n+            catch (Exception ex) {\n+                log.warn(\"Error while processing user with registration number \" + registrationNumber + \": \" + ex.getMessage(), ex);\n+            }\n+\n+            notFoundStudentsDtos.add(studentDto);\n+        }\n+        examRepository.save(exam);\n+        return ResponseEntity.ok().body(notFoundStudentsDtos);\n+    }\n+\n+    /**\n+     * DELETE /courses/:courseId/exams/:examId/students/:studentLogin : Remove one single given user (based on the login) from the students of the exam so that the student cannot access the exam any more\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param studentLogin the login of the user who should lose student access\n+     * @return empty ResponseEntity with status 200 (OK) or with status 404 (Not Found)\n+     */\n+    @DeleteMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<Void> removeStudentFromExam(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+        log.debug(\"REST request to remove {} as student from exam : {}\", studentLogin, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return conflict();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d4212faeb47276b33f8e74c1ca4e7ba6bcaaa4f"}, "originalPosition": 180}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffcd513fd76bcb2db857a9720e1907cebc5978b7", "author": {"user": {"login": "krusche", "name": "Stephan Krusche"}}, "url": "https://github.com/ls1intum/Artemis/commit/ffcd513fd76bcb2db857a9720e1907cebc5978b7", "committedDate": "2020-06-15T19:28:52Z", "message": "Merge branch 'develop' into exam/management/register-students"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "032e6727612850457185e520fc90640188a168bd", "author": {"user": null}, "url": "https://github.com/ls1intum/Artemis/commit/032e6727612850457185e520fc90640188a168bd", "committedDate": "2020-06-15T19:38:25Z", "message": "fix issue when ldap user during login is not found"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwOTQyNDc5", "url": "https://github.com/ls1intum/Artemis/pull/1652#pullrequestreview-430942479", "createdAt": "2020-06-15T19:46:26Z", "commit": {"oid": "ffcd513fd76bcb2db857a9720e1907cebc5978b7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwOTYyNjY1", "url": "https://github.com/ls1intum/Artemis/pull/1652#pullrequestreview-430962665", "createdAt": "2020-06-15T20:18:19Z", "commit": {"oid": "032e6727612850457185e520fc90640188a168bd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2424, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}