{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5NTAwMDI0", "number": 2480, "title": "[Bugfix] Import a prog. exercise by cloning instead of forking", "bodyText": "Checklist\n\n I tested all changes and all related features with different users (student, tutor, instructor, admin) on the test server https://artemistest.ase.in.tum.de.\n Server: I followed the coding and design guidelines.\n Server: I added multiple integration tests (Spring) related to the features (with a high test coverage)\n Server: I implemented the changes with a good performance and prevented too many database calls\n Server: I documented the Java code using JavaDoc style.\n\nMotivation and Context\n\n\n@kloessst found an issue (#2451) when importing programming exercises more than 5 times. Bitbucket does not allow forking for more than 5 times of the same root repository.\nDescription\n\nWe solve this issue by not forking at all but rather pushing the content of a source repository into a target's repository.\nCloses #2451\nSteps for Testing\n\n\nLog in to Artemis\nNavigate to Course Administration\nCreate a new programming exercise A\nImport this exercise and name it A1\nImport exercise A1 and name it A2.\nRepeat step 4 and 5 five times until you get the exercises A1-A5\nImport the exercise A5 and verify that the sixth importing still succeeds\n\nTest Coverage\n\nBitbucketService.java: 76%\nGitService.java: 79%", "createdAt": "2020-11-30T11:59:06Z", "url": "https://github.com/ls1intum/Artemis/pull/2480", "merged": true, "mergeCommit": {"oid": "75f46f9c9fdda776fabc78bcc4cc035bbffbd8a6"}, "closed": true, "closedAt": "2020-12-01T23:32:39Z", "author": {"login": "derLalla"}, "timelineItems": {"totalCount": 34, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgoCkMgH2gAyNTI5NTAwMDI0OmZjZWU4YjI3NDA2ZWIwMjZlNzZmZDMwMjhiOWFlMDY0MTk4YjA0MTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiCl_bAFqTU0MjM4NDEyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fcee8b27406eb026e76fd3028b9ae064198b0418", "author": {"user": {"login": "derLalla", "name": "Ren\u00e9 Lalla"}}, "url": "https://github.com/ls1intum/Artemis/commit/fcee8b27406eb026e76fd3028b9ae064198b0418", "committedDate": "2020-11-27T14:01:49Z", "message": "rename copy to fork repository"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce74848ca38e048bf4c60f358c8b577399482617", "author": {"user": {"login": "derLalla", "name": "Ren\u00e9 Lalla"}}, "url": "https://github.com/ls1intum/Artemis/commit/ce74848ca38e048bf4c60f358c8b577399482617", "committedDate": "2020-11-27T16:00:24Z", "message": "fix source url"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6899ec22d81902b749f3e3cce134b0266d33e35", "author": {"user": {"login": "derLalla", "name": "Ren\u00e9 Lalla"}}, "url": "https://github.com/ls1intum/Artemis/commit/a6899ec22d81902b749f3e3cce134b0266d33e35", "committedDate": "2020-11-27T16:20:45Z", "message": "forgot to call() git"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd77faa0c843fe95c4ccc38657c828746aec0897", "author": {"user": {"login": "derLalla", "name": "Ren\u00e9 Lalla"}}, "url": "https://github.com/ls1intum/Artemis/commit/fd77faa0c843fe95c4ccc38657c828746aec0897", "committedDate": "2020-11-30T08:24:35Z", "message": "refactoring"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55a7073a4f5a3db86caf0574476edf909a2f5864", "author": {"user": {"login": "derLalla", "name": "Ren\u00e9 Lalla"}}, "url": "https://github.com/ls1intum/Artemis/commit/55a7073a4f5a3db86caf0574476edf909a2f5864", "committedDate": "2020-11-30T08:27:38Z", "message": "Merge branch 'develop' into bugfix/change-forking-to-cloning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0ced3c984e367f9c236e175c2fb4afe5788245d", "author": {"user": {"login": "derLalla", "name": "Ren\u00e9 Lalla"}}, "url": "https://github.com/ls1intum/Artemis/commit/d0ced3c984e367f9c236e175c2fb4afe5788245d", "committedDate": "2020-11-30T11:19:57Z", "message": "fix testcase for import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e68a99bd849d7766d3f24333505282f694b73ad", "author": {"user": {"login": "derLalla", "name": "Ren\u00e9 Lalla"}}, "url": "https://github.com/ls1intum/Artemis/commit/2e68a99bd849d7766d3f24333505282f694b73ad", "committedDate": "2020-11-30T11:26:41Z", "message": "rename mockCopy... to mockFork..."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e5487a156bb3d5c1b1529fb4e845017e07299f3", "author": {"user": {"login": "derLalla", "name": "Ren\u00e9 Lalla"}}, "url": "https://github.com/ls1intum/Artemis/commit/5e5487a156bb3d5c1b1529fb4e845017e07299f3", "committedDate": "2020-11-30T11:45:46Z", "message": "setup repo mocks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwOTQxOTA2", "url": "https://github.com/ls1intum/Artemis/pull/2480#pullrequestreview-540941906", "createdAt": "2020-11-30T14:10:19Z", "commit": {"oid": "5e5487a156bb3d5c1b1529fb4e845017e07299f3"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwOTQxOTY0", "url": "https://github.com/ls1intum/Artemis/pull/2480#pullrequestreview-540941964", "createdAt": "2020-11-30T14:10:22Z", "commit": {"oid": "5e5487a156bb3d5c1b1529fb4e845017e07299f3"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwOTQ5Njg2", "url": "https://github.com/ls1intum/Artemis/pull/2480#pullrequestreview-540949686", "createdAt": "2020-11-30T14:18:53Z", "commit": {"oid": "5e5487a156bb3d5c1b1529fb4e845017e07299f3"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwOTU0MjM5", "url": "https://github.com/ls1intum/Artemis/pull/2480#pullrequestreview-540954239", "createdAt": "2020-11-30T14:23:42Z", "commit": {"oid": "5e5487a156bb3d5c1b1529fb4e845017e07299f3"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwOTYxMDA3", "url": "https://github.com/ls1intum/Artemis/pull/2480#pullrequestreview-540961007", "createdAt": "2020-11-30T14:30:48Z", "commit": {"oid": "5e5487a156bb3d5c1b1529fb4e845017e07299f3"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwOTYxMTEy", "url": "https://github.com/ls1intum/Artemis/pull/2480#pullrequestreview-540961112", "createdAt": "2020-11-30T14:30:55Z", "commit": {"oid": "5e5487a156bb3d5c1b1529fb4e845017e07299f3"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMDEwMTk0", "url": "https://github.com/ls1intum/Artemis/pull/2480#pullrequestreview-541010194", "createdAt": "2020-11-30T15:20:43Z", "commit": {"oid": "5e5487a156bb3d5c1b1529fb4e845017e07299f3"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMDM3ODk1", "url": "https://github.com/ls1intum/Artemis/pull/2480#pullrequestreview-541037895", "createdAt": "2020-11-30T15:48:33Z", "commit": {"oid": "5e5487a156bb3d5c1b1529fb4e845017e07299f3"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMDU1NjI3", "url": "https://github.com/ls1intum/Artemis/pull/2480#pullrequestreview-541055627", "createdAt": "2020-11-30T16:06:07Z", "commit": {"oid": "5e5487a156bb3d5c1b1529fb4e845017e07299f3"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMDY3Mzgz", "url": "https://github.com/ls1intum/Artemis/pull/2480#pullrequestreview-541067383", "createdAt": "2020-11-30T16:18:09Z", "commit": {"oid": "5e5487a156bb3d5c1b1529fb4e845017e07299f3"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMDkyODcy", "url": "https://github.com/ls1intum/Artemis/pull/2480#pullrequestreview-541092872", "createdAt": "2020-11-30T16:44:19Z", "commit": {"oid": "5e5487a156bb3d5c1b1529fb4e845017e07299f3"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMjAwNjQ5", "url": "https://github.com/ls1intum/Artemis/pull/2480#pullrequestreview-541200649", "createdAt": "2020-11-30T18:56:21Z", "commit": {"oid": "5e5487a156bb3d5c1b1529fb4e845017e07299f3"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMzQ3NjU3", "url": "https://github.com/ls1intum/Artemis/pull/2480#pullrequestreview-541347657", "createdAt": "2020-11-30T22:30:44Z", "commit": {"oid": "5e5487a156bb3d5c1b1529fb4e845017e07299f3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMjozMDo0NFrOH8QcIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMjozMDo0NFrOH8QcIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk0NTk1NQ==", "bodyText": "what happens in the following scenario (which happens rather often)?\n\nAn instructor works in the online code editor in the source template repository, commits&pushes changes.\nThe instructor also works offline in his IDE and commits&pushes changes\nThere is a merge conflict in the template repository on the Artemis server\nSometimes later, the instructor imports the exercise.\n\nI would assume that getOrCheckoutRepository(...) will reuse the existing repository (which is in a conflict state), and will try to pull the latest changes, which will fail. Then the whole import would fail.\nI think we should avoid this issue. I see the following easy fix: Instead of reusing the existing repository with getOrCheckoutRepository(url, boolean), we should rather clone the repository from Bitbucket again into a new folder (this is e.g. also done when we export git repos) using the method getOrCheckoutRepository(URL repoUrl, boolean pullOnGet, String targetPath). The targetPath could e.g. be REPO_CLONE_PATH", "url": "https://github.com/ls1intum/Artemis/pull/2480#discussion_r532945955", "createdAt": "2020-11-30T22:30:44Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/bitbucket/BitbucketService.java", "diffHunk": "@@ -265,6 +270,29 @@ public VcsRepositoryUrl copyRepository(String sourceProjectKey, String sourceRep\n         throw new BitbucketException(\"Max retries for forking reached. Could not fork repository \" + sourceRepositoryName + \" to \" + targetRepositoryName);\n     }\n \n+    @Override\n+    public VcsRepositoryUrl copyRepository(String sourceProjectKey, String sourceRepositoryName, String targetProjectKey, String targetRepositoryName) {\n+        final var targetRepoSlug = targetProjectKey.toLowerCase() + \"-\" + targetRepositoryName.toLowerCase();\n+        try {\n+            var sourceRepoUrl = getCloneRepositoryUrl(sourceProjectKey, sourceRepositoryName.toLowerCase());\n+            URL sourceRepositoryUrlAsUrl = new URL(sourceRepoUrl.toString());\n+            // checkout the source repo\n+            Repository sourceRepo = gitService.getOrCheckoutRepository(sourceRepositoryUrlAsUrl, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e5487a156bb3d5c1b1529fb4e845017e07299f3"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMzQ3OTk3", "url": "https://github.com/ls1intum/Artemis/pull/2480#pullrequestreview-541347997", "createdAt": "2020-11-30T22:31:20Z", "commit": {"oid": "5e5487a156bb3d5c1b1529fb4e845017e07299f3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e97d40dc4ae3f17af0d7aa447b24239cef353047", "author": {"user": {"login": "derLalla", "name": "Ren\u00e9 Lalla"}}, "url": "https://github.com/ls1intum/Artemis/commit/e97d40dc4ae3f17af0d7aa447b24239cef353047", "committedDate": "2020-12-01T12:47:03Z", "message": "Merge branch 'develop' into bugfix/change-forking-to-cloning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ae74c2a08a26859d4de8a66add06da574172749", "author": {"user": {"login": "derLalla", "name": "Ren\u00e9 Lalla"}}, "url": "https://github.com/ls1intum/Artemis/commit/3ae74c2a08a26859d4de8a66add06da574172749", "committedDate": "2020-12-01T13:22:34Z", "message": "clone source repo to different location"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f9e3bda776a08ccbdf6e1fdc90d79255780df58", "author": {"user": {"login": "derLalla", "name": "Ren\u00e9 Lalla"}}, "url": "https://github.com/ls1intum/Artemis/commit/6f9e3bda776a08ccbdf6e1fdc90d79255780df58", "committedDate": "2020-12-01T14:46:08Z", "message": "revert to test old behaviour"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c75faa35ec70668764fc23f5a4d448fe06af7ae1", "author": {"user": {"login": "derLalla", "name": "Ren\u00e9 Lalla"}}, "url": "https://github.com/ls1intum/Artemis/commit/c75faa35ec70668764fc23f5a4d448fe06af7ae1", "committedDate": "2020-12-01T15:11:03Z", "message": "revert back to fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMDM3MTEx", "url": "https://github.com/ls1intum/Artemis/pull/2480#pullrequestreview-542037111", "createdAt": "2020-12-01T15:48:25Z", "commit": {"oid": "c75faa35ec70668764fc23f5a4d448fe06af7ae1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMDM3NTY5", "url": "https://github.com/ls1intum/Artemis/pull/2480#pullrequestreview-542037569", "createdAt": "2020-12-01T15:48:51Z", "commit": {"oid": "c75faa35ec70668764fc23f5a4d448fe06af7ae1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMDQzNjcx", "url": "https://github.com/ls1intum/Artemis/pull/2480#pullrequestreview-542043671", "createdAt": "2020-12-01T15:54:37Z", "commit": {"oid": "c75faa35ec70668764fc23f5a4d448fe06af7ae1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMDUxMDA3", "url": "https://github.com/ls1intum/Artemis/pull/2480#pullrequestreview-542051007", "createdAt": "2020-12-01T16:01:22Z", "commit": {"oid": "c75faa35ec70668764fc23f5a4d448fe06af7ae1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMTcxMDE3", "url": "https://github.com/ls1intum/Artemis/pull/2480#pullrequestreview-542171017", "createdAt": "2020-12-01T18:14:42Z", "commit": {"oid": "c75faa35ec70668764fc23f5a4d448fe06af7ae1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMjc3NzY5", "url": "https://github.com/ls1intum/Artemis/pull/2480#pullrequestreview-542277769", "createdAt": "2020-12-01T20:40:06Z", "commit": {"oid": "c75faa35ec70668764fc23f5a4d448fe06af7ae1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMzM1NzE2", "url": "https://github.com/ls1intum/Artemis/pull/2480#pullrequestreview-542335716", "createdAt": "2020-12-01T22:06:02Z", "commit": {"oid": "c75faa35ec70668764fc23f5a4d448fe06af7ae1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMzg0MTIz", "url": "https://github.com/ls1intum/Artemis/pull/2480#pullrequestreview-542384123", "createdAt": "2020-12-01T23:31:58Z", "commit": {"oid": "c75faa35ec70668764fc23f5a4d448fe06af7ae1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3354, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}