{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2NTI5NjIy", "number": 1840, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNDo1NzoxOFrOEMvcMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNToxMjo0NlrOEMvl2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNzk1NjMyOnYy", "diffSide": "RIGHT", "path": "src/main/webapp/app/exercises/programming/shared/instructions-render/extensions/programming-exercise-plant-uml.extension.ts", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNDo1NzoxOFrOGvBrug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNDo1NzoxOFrOGvBrug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk2MzgzNA==", "bodyText": "Good fix!", "url": "https://github.com/ls1intum/Artemis/pull/1840#discussion_r451963834", "createdAt": "2020-07-09T04:57:18Z", "author": {"login": "thilo-behnke"}, "path": "src/main/webapp/app/exercises/programming/shared/instructions-render/extensions/programming-exercise-plant-uml.extension.ts", "diffHunk": "@@ -14,6 +14,8 @@ export class ProgrammingExercisePlantUmlExtensionWrapper implements ArtemisShowd\n     private latestResult: Result | null = null;\n     private injectableElementsFoundSubject = new Subject<() => void>();\n \n+    // unique index, even if multiple plant uml diagrams are shown from different problem statements on the same page (in different tabs)\n+    private plantUmlIndex = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30aa69c6263f519010a29bf7a872dea93a86d9a3"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNzk4MTA2OnYy", "diffSide": "RIGHT", "path": "src/main/webapp/app/exercises/programming/shared/instructions-render/extensions/programming-exercise-plant-uml.extension.ts", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNToxMjo0NlrOGvB6gQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwNjoxODo1MFrOGvrKZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk2NzYxNw==", "bodyText": "I think this is the correct approach to fixing the issue, however I'm not sure the implementation is bulletproof:\nthis.loadAndInjectPlantUml(plantUml, this.plantUmlIndex - plantUmlsValidated.length + index + 1\nAs far as I see it, this.plantUmlIndex - plantUmlsValidated.length will lead to the wrong id range start for e.g. the first exercise in the exam:\nE.g. exercise 1 has 5 umls, exercise 2 has 3.\nFor exercise 1:\nthis.plantUmlIndex - plantUmlsValidated.length = 7 - 5 = 2\n=> Should be 0\nFor exercise 2:\nthis.plantUmlIndex - plantUmlsValidated.length = 7 - 3 = 4\n=> Should be 4\nI would suggest to directly determine the plantUml ids at the beginning, something like (untested):\n                        const plantUmls = text.match(plantUmlRegex) || [];\n                        // Assign unique ids to uml data structure at the beginning. \n                        const plantUmlsIndexed = plantUmls.map(uml -> {\n                            plantUmlIndex++;\n                            const nextIndex = plantUmlIndex;\n                            return {id: nextIndex, uml}; \n                        })\n                        const replacedText = plantUmlsIndexed.reduce((acc: string, {uml, id}): string => {\n                            return acc.replace(new RegExp(escapeStringForUseInRegex(uml), 'g'), plantUmlContainer.replace(idPlaceholder, id.toString()));              \n                        }, text);\n                        ... more stuff about validation, leaving out for brevity sake.\n                        // Now here the advantage is that the id is part of the data structure:\n                        plantUmlsValidated.forEach(({id, uml}) => {\n                            this.loadAndInjectPlantUml(uml, id);\n                        }", "url": "https://github.com/ls1intum/Artemis/pull/1840#discussion_r451967617", "createdAt": "2020-07-09T05:12:46Z", "author": {"login": "thilo-behnke"}, "path": "src/main/webapp/app/exercises/programming/shared/instructions-render/extensions/programming-exercise-plant-uml.extension.ts", "diffHunk": "@@ -66,19 +67,22 @@ export class ProgrammingExercisePlantUmlExtensionWrapper implements ArtemisShowd\n                 const plantUmlContainer = `<div class=\"mb-4\" id=\"plantUml-${idPlaceholder}\"></div>`;\n                 // Replace test status markers.\n                 const plantUmls = text.match(plantUmlRegex) || [];\n-                const replacedText = plantUmls.reduce(\n-                    (acc: string, plantUml: string, index: number): string =>\n-                        acc.replace(new RegExp(escapeStringForUseInRegex(plantUml), 'g'), plantUmlContainer.replace(idPlaceholder, index.toString())),\n-                    text,\n-                );\n+                const replacedText = plantUmls.reduce((acc: string, plantUml: string): string => {\n+                    this.plantUmlIndex++;\n+                    return acc.replace(new RegExp(escapeStringForUseInRegex(plantUml), 'g'), plantUmlContainer.replace(idPlaceholder, this.plantUmlIndex.toString()));\n+                }, text);\n                 const plantUmlsValidated = plantUmls.map((plantUml) =>\n                     plantUml.replace(/testsColor\\(([^)]+)\\)/g, (match: any, capture: string) => {\n                         const tests = capture.split(',');\n                         const { testCaseState } = this.programmingExerciseInstructionService.testStatusForTask(tests, this.latestResult);\n                         return testCaseState === TestCaseState.SUCCESS ? 'green' : testCaseState === TestCaseState.FAIL ? 'red' : 'grey';\n                     }),\n                 );\n-                this.injectableElementsFoundSubject.next(() => this.loadAndInjectPlantUmls(plantUmlsValidated));\n+                this.injectableElementsFoundSubject.next(() => {\n+                    plantUmlsValidated.forEach((plantUml: string, index: number) => {\n+                        this.loadAndInjectPlantUml(plantUml, this.plantUmlIndex - plantUmlsValidated.length + index + 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30aa69c6263f519010a29bf7a872dea93a86d9a3"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk2ODM4Mg==", "bodyText": "Another possible fix would be to save the plantUmlIndex in a closure outside of the thunk.\nThis has the advantage that the plantUml index range start will be the same, even if the service variable changes (this.plantUmlIndex).\nAgain not tested:\n// Store variable in closure.\nconst plantUmlIndexRangeStart = this.plantUmlIndex - plantUmlsValidated.length;\nplantUmlsValidated.forEach((plantUml: string, index: number) => {]\n                        // Access the closure variable instead of the class property.\n                        this.loadAndInjectPlantUml(plantUml, plantUmlIndexRangeStart + index + 1);\n}", "url": "https://github.com/ls1intum/Artemis/pull/1840#discussion_r451968382", "createdAt": "2020-07-09T05:15:47Z", "author": {"login": "thilo-behnke"}, "path": "src/main/webapp/app/exercises/programming/shared/instructions-render/extensions/programming-exercise-plant-uml.extension.ts", "diffHunk": "@@ -66,19 +67,22 @@ export class ProgrammingExercisePlantUmlExtensionWrapper implements ArtemisShowd\n                 const plantUmlContainer = `<div class=\"mb-4\" id=\"plantUml-${idPlaceholder}\"></div>`;\n                 // Replace test status markers.\n                 const plantUmls = text.match(plantUmlRegex) || [];\n-                const replacedText = plantUmls.reduce(\n-                    (acc: string, plantUml: string, index: number): string =>\n-                        acc.replace(new RegExp(escapeStringForUseInRegex(plantUml), 'g'), plantUmlContainer.replace(idPlaceholder, index.toString())),\n-                    text,\n-                );\n+                const replacedText = plantUmls.reduce((acc: string, plantUml: string): string => {\n+                    this.plantUmlIndex++;\n+                    return acc.replace(new RegExp(escapeStringForUseInRegex(plantUml), 'g'), plantUmlContainer.replace(idPlaceholder, this.plantUmlIndex.toString()));\n+                }, text);\n                 const plantUmlsValidated = plantUmls.map((plantUml) =>\n                     plantUml.replace(/testsColor\\(([^)]+)\\)/g, (match: any, capture: string) => {\n                         const tests = capture.split(',');\n                         const { testCaseState } = this.programmingExerciseInstructionService.testStatusForTask(tests, this.latestResult);\n                         return testCaseState === TestCaseState.SUCCESS ? 'green' : testCaseState === TestCaseState.FAIL ? 'red' : 'grey';\n                     }),\n                 );\n-                this.injectableElementsFoundSubject.next(() => this.loadAndInjectPlantUmls(plantUmlsValidated));\n+                this.injectableElementsFoundSubject.next(() => {\n+                    plantUmlsValidated.forEach((plantUml: string, index: number) => {\n+                        this.loadAndInjectPlantUml(plantUml, this.plantUmlIndex - plantUmlsValidated.length + index + 1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk2NzYxNw=="}, "originalCommit": {"oid": "30aa69c6263f519010a29bf7a872dea93a86d9a3"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE0MDA2Mw==", "bodyText": "I assumed that the calculation of the indices is not done at the same time for different exercises (only when you switch between 2). So in your example, it would be instead\nFor exercise 1:\nthis.plantUmlIndex - plantUmlsValidated.length = 5 - 5 = 2\nHowever, I agree that my approach is too simple and we should implement this in a more bulletproof fashion. The problem is, I am not so experienced with the mechanisms and did not have enough time to implement this properly", "url": "https://github.com/ls1intum/Artemis/pull/1840#discussion_r452140063", "createdAt": "2020-07-09T11:08:29Z", "author": {"login": "krusche"}, "path": "src/main/webapp/app/exercises/programming/shared/instructions-render/extensions/programming-exercise-plant-uml.extension.ts", "diffHunk": "@@ -66,19 +67,22 @@ export class ProgrammingExercisePlantUmlExtensionWrapper implements ArtemisShowd\n                 const plantUmlContainer = `<div class=\"mb-4\" id=\"plantUml-${idPlaceholder}\"></div>`;\n                 // Replace test status markers.\n                 const plantUmls = text.match(plantUmlRegex) || [];\n-                const replacedText = plantUmls.reduce(\n-                    (acc: string, plantUml: string, index: number): string =>\n-                        acc.replace(new RegExp(escapeStringForUseInRegex(plantUml), 'g'), plantUmlContainer.replace(idPlaceholder, index.toString())),\n-                    text,\n-                );\n+                const replacedText = plantUmls.reduce((acc: string, plantUml: string): string => {\n+                    this.plantUmlIndex++;\n+                    return acc.replace(new RegExp(escapeStringForUseInRegex(plantUml), 'g'), plantUmlContainer.replace(idPlaceholder, this.plantUmlIndex.toString()));\n+                }, text);\n                 const plantUmlsValidated = plantUmls.map((plantUml) =>\n                     plantUml.replace(/testsColor\\(([^)]+)\\)/g, (match: any, capture: string) => {\n                         const tests = capture.split(',');\n                         const { testCaseState } = this.programmingExerciseInstructionService.testStatusForTask(tests, this.latestResult);\n                         return testCaseState === TestCaseState.SUCCESS ? 'green' : testCaseState === TestCaseState.FAIL ? 'red' : 'grey';\n                     }),\n                 );\n-                this.injectableElementsFoundSubject.next(() => this.loadAndInjectPlantUmls(plantUmlsValidated));\n+                this.injectableElementsFoundSubject.next(() => {\n+                    plantUmlsValidated.forEach((plantUml: string, index: number) => {\n+                        this.loadAndInjectPlantUml(plantUml, this.plantUmlIndex - plantUmlsValidated.length + index + 1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk2NzYxNw=="}, "originalCommit": {"oid": "30aa69c6263f519010a29bf7a872dea93a86d9a3"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY0MzQzMQ==", "bodyText": "fixed by @kloessst", "url": "https://github.com/ls1intum/Artemis/pull/1840#discussion_r452643431", "createdAt": "2020-07-10T06:18:50Z", "author": {"login": "krusche"}, "path": "src/main/webapp/app/exercises/programming/shared/instructions-render/extensions/programming-exercise-plant-uml.extension.ts", "diffHunk": "@@ -66,19 +67,22 @@ export class ProgrammingExercisePlantUmlExtensionWrapper implements ArtemisShowd\n                 const plantUmlContainer = `<div class=\"mb-4\" id=\"plantUml-${idPlaceholder}\"></div>`;\n                 // Replace test status markers.\n                 const plantUmls = text.match(plantUmlRegex) || [];\n-                const replacedText = plantUmls.reduce(\n-                    (acc: string, plantUml: string, index: number): string =>\n-                        acc.replace(new RegExp(escapeStringForUseInRegex(plantUml), 'g'), plantUmlContainer.replace(idPlaceholder, index.toString())),\n-                    text,\n-                );\n+                const replacedText = plantUmls.reduce((acc: string, plantUml: string): string => {\n+                    this.plantUmlIndex++;\n+                    return acc.replace(new RegExp(escapeStringForUseInRegex(plantUml), 'g'), plantUmlContainer.replace(idPlaceholder, this.plantUmlIndex.toString()));\n+                }, text);\n                 const plantUmlsValidated = plantUmls.map((plantUml) =>\n                     plantUml.replace(/testsColor\\(([^)]+)\\)/g, (match: any, capture: string) => {\n                         const tests = capture.split(',');\n                         const { testCaseState } = this.programmingExerciseInstructionService.testStatusForTask(tests, this.latestResult);\n                         return testCaseState === TestCaseState.SUCCESS ? 'green' : testCaseState === TestCaseState.FAIL ? 'red' : 'grey';\n                     }),\n                 );\n-                this.injectableElementsFoundSubject.next(() => this.loadAndInjectPlantUmls(plantUmlsValidated));\n+                this.injectableElementsFoundSubject.next(() => {\n+                    plantUmlsValidated.forEach((plantUml: string, index: number) => {\n+                        this.loadAndInjectPlantUml(plantUml, this.plantUmlIndex - plantUmlsValidated.length + index + 1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk2NzYxNw=="}, "originalCommit": {"oid": "30aa69c6263f519010a29bf7a872dea93a86d9a3"}, "originalPosition": 73}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4745, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}