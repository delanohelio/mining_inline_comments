{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxOTcwNDI2", "number": 2557, "title": "[Tests] Fixing leaky tests", "bodyText": "Motivation and Context\n\n\nTrying to lower the memory usage of our test suite by identifying leaky tests\nDescription\n\nWe have a big problem in our application that running all client test suites requires an absurd amount of memory. One of the reasons for this are leaky tests. What are memory leaks in JS and what causes them?\nWhat are memory leaks?\nA very good explanation that you should definitely read to understand the problem: https://auth0.com/blog/four-types-of-leaks-in-your-javascript-code-and-how-to-get-rid-of-them/\nIn essence:\n\nJS is a garbage collected language\nModern garbage collectors improve on this algorithm in different ways, but the essence is the same: reachable pieces of memory are marked as such and the rest is considered garbage.\nUnwanted references are references to pieces of memory that the developer knows he or she won't be needing anymore but that for some reason are kept inside the tree of an active root. In the context of JavaScript, unwanted references are variables kept somewhere in the code that will not be used anymore and point to a piece of memory that could otherwise be freed. Some would argue these are developer mistakes.\n\nI found a way to manually request the garbage collection after jest runs a test.\nIf we look into the jest source code we find the following condition: https://github.com/facebook/jest/blob/40b8e1e157c9981dda5a68d73fff647e80fc9f5c/packages/jest-runner/src/runTest.ts#L291\n\nThis means by setting both the --expose-gc in node and --logHeapUsage in jest, a minor garbage collection will be requested by jest after each test. Requested means that the runtime will schedule one to occur soon. This should fix our leaky test problem and dramatically lower the memory usage on bamboo etc. There will probably be some performance cost but imo it will be worth it.\nI therefore changed the testing commands to :\n \"test\": \"node --expose-gc ./node_modules/.bin/jest  --logHeapUsage --config ./src/test/javascript/jest.config.js --env=jsdom -w=4\"\n\"test:ci\": \"node --expose-gc ./node_modules/.bin/jest  --logHeapUsage --config ./src/test/javascript/jest.config.ci.js --env=jsdom -w=1 --coverage\"\n \"test:coverage\": \"node --expose-gc ./node_modules/.bin/jest  --logHeapUsage --config ./src/test/javascript/jest.config.js --env=jsdom -w=4 --coverage\"\nThe --expose-gc option will make the function gc() available on the global object, which the custom command needs in order to request the garbage collection.\nI can confirm in tests that this seem to fix our memory leak problem as the heap does not go over 700mb. For example see the test log here: https://pastebin.com/raw/JR6HZ68N\nThe crucial commit is this one: dbb08f1", "createdAt": "2020-12-17T16:13:05Z", "url": "https://github.com/ls1intum/Artemis/pull/2557", "merged": true, "mergeCommit": {"oid": "9055fe565fe252b385cd02368baff461bf0b7cfb"}, "closed": true, "closedAt": "2020-12-18T09:12:31Z", "author": {"login": "stefanwaldhauser"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdnFirUgH2gAyNTQxOTcwNDI2OjNkMzg4MTg3MDIwMzIwNjFlOTdmYWQ1YTZhOTFmNDIxY2ZlNzBiMTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnUeq6gFqTU1NTMxNzA3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3d38818702032061e97fad5a6a91f421cfe70b11", "author": {"user": {"login": "stefanwaldhauser", "name": "Stefan Waldhauser"}}, "url": "https://github.com/ls1intum/Artemis/commit/3d38818702032061e97fad5a6a91f421cfe70b11", "committedDate": "2020-12-17T15:47:41Z", "message": "Added weak-napi dependendency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94f50212618fc6cd047a5bbdbfd3799727707f7b", "author": {"user": {"login": "stefanwaldhauser", "name": "Stefan Waldhauser"}}, "url": "https://github.com/ls1intum/Artemis/commit/94f50212618fc6cd047a5bbdbfd3799727707f7b", "committedDate": "2020-12-17T16:11:52Z", "message": "Deactived tests identified by running jest --detectLeaks --env=jsdom"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b042efb5182a6e773e2fac8df004a177f4ffb09", "author": {"user": {"login": "stefanwaldhauser", "name": "Stefan Waldhauser"}}, "url": "https://github.com/ls1intum/Artemis/commit/1b042efb5182a6e773e2fac8df004a177f4ffb09", "committedDate": "2020-12-17T16:25:02Z", "message": "Deactivated another leaky test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2d79e9bd5e53f961ff15613b7d8aa928411783b", "author": {"user": {"login": "stefanwaldhauser", "name": "Stefan Waldhauser"}}, "url": "https://github.com/ls1intum/Artemis/commit/d2d79e9bd5e53f961ff15613b7d8aa928411783b", "committedDate": "2020-12-17T17:00:43Z", "message": "Deactivated more leaky tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75387bf76cf3d0e95009bd79b7cb5ce5aae51b3f", "author": {"user": {"login": "stefanwaldhauser", "name": "Stefan Waldhauser"}}, "url": "https://github.com/ls1intum/Artemis/commit/75387bf76cf3d0e95009bd79b7cb5ce5aae51b3f", "committedDate": "2020-12-17T17:07:30Z", "message": "Deactivated leaky test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0ODUzODQ0", "url": "https://github.com/ls1intum/Artemis/pull/2557#pullrequestreview-554853844", "createdAt": "2020-12-17T18:00:20Z", "commit": {"oid": "75387bf76cf3d0e95009bd79b7cb5ce5aae51b3f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxODowMDoyMFrOIIB7_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxODowMDoyMFrOIIB7_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI5MTI2MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    \"weak-napi\": \"^2.0.2\",\n          \n          \n            \n                    \"weak-napi\": \"2.0.2\",", "url": "https://github.com/ls1intum/Artemis/pull/2557#discussion_r545291261", "createdAt": "2020-12-17T18:00:20Z", "author": {"login": "krusche"}, "path": "package.json", "diffHunk": "@@ -75,6 +75,7 @@\n         \"split.js\": \"1.6.2\",\n         \"ts-cacheable\": \"1.0.2\",\n         \"tslib\": \"2.0.3\",\n+        \"weak-napi\": \"^2.0.2\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75387bf76cf3d0e95009bd79b7cb5ce5aae51b3f"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbb08f1a22884587284ab2921065541cba4774d7", "author": {"user": {"login": "stefanwaldhauser", "name": "Stefan Waldhauser"}}, "url": "https://github.com/ls1intum/Artemis/commit/dbb08f1a22884587284ab2921065541cba4774d7", "committedDate": "2020-12-17T21:21:24Z", "message": "Switched to different testing scripts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8215e01b0304ffe254a9c7b527ca279caf980e22", "author": {"user": {"login": "stefanwaldhauser", "name": "Stefan Waldhauser"}}, "url": "https://github.com/ls1intum/Artemis/commit/8215e01b0304ffe254a9c7b527ca279caf980e22", "committedDate": "2020-12-17T21:37:21Z", "message": "Merge branch 'develop' into fix/leaky-tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c06062a508defd69e958a1fb88c3a68bf7f1a39", "author": {"user": {"login": "stefanwaldhauser", "name": "Stefan Waldhauser"}}, "url": "https://github.com/ls1intum/Artemis/commit/5c06062a508defd69e958a1fb88c3a68bf7f1a39", "committedDate": "2020-12-18T08:52:52Z", "message": "Merge branch 'develop' into fix/leaky-tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "089e7020eedb5ed6cc98a7425f377195048d72ee", "author": {"user": {"login": "stefanwaldhauser", "name": "Stefan Waldhauser"}}, "url": "https://github.com/ls1intum/Artemis/commit/089e7020eedb5ed6cc98a7425f377195048d72ee", "committedDate": "2020-12-18T08:54:36Z", "message": "Removed weak napi from normal dependencies"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1MzE3MDcw", "url": "https://github.com/ls1intum/Artemis/pull/2557#pullrequestreview-555317070", "createdAt": "2020-12-18T09:11:53Z", "commit": {"oid": "089e7020eedb5ed6cc98a7425f377195048d72ee"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3478, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}