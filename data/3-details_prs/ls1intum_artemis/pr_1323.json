{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1OTY2MDkx", "number": 1323, "title": "Ensure that users only receive notifications for their courses", "bodyText": "Checklist\n\n I tested all changes and all related features with different users (student, tutor, instructor, admin) on the test server https://artemistest.ase.in.tum.de.\n\nMotivation and Context\nSome users receive recent notifications for courses to which they do not belong.\nDescription\nThe REST route /notifications related to findAllExceptSystem() in the NotficationService seems to work as the unwanted notifications are not displayed there, only in the notification-container.component.\nTherefore I adapted the implementation of findAllRecentExceptSystem() in the NotficationService that is related to the REST route /notifications/for-user as closely as possible to the implementation of findAllExceptSystem().\nI also added several test cases for the above mentioned rest routes.\nAdditionally, I made sure that the notification service gets cleaned up when the user logs out.\nSteps for Testing\n\nLog in to Artemis\nNavigate to Course Administration\nClick on the notification bell in the top navigation\nCheck that the displayed notifications only belong to courses of the current user", "createdAt": "2020-04-20T10:14:11Z", "url": "https://github.com/ls1intum/Artemis/pull/1323", "merged": true, "mergeCommit": {"oid": "65eca3b17f3b1371cd12a494ecba6a28baf13059"}, "closed": true, "closedAt": "2020-04-21T18:20:25Z", "author": {"login": "sascha11110"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZb8MBAH2gAyNDA1OTY2MDkxOjcwOTUxZDc0ZWU3ZGM2NDIwZDk4NTJjNjQ1MDUyOTA0Mjg0NzFmNzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZ33zPgFqTM5NzU2MDYyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "70951d74ee7dc6420d9852c64505290428471f70", "author": {"user": {"login": "sascha11110", "name": "Sascha Beele"}}, "url": "https://github.com/ls1intum/Artemis/commit/70951d74ee7dc6420d9852c64505290428471f70", "committedDate": "2020-04-20T09:47:22Z", "message": "Add findAllRecentNotificationsForRecipientWithLogin() to NotificationRespository"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a76377a3f966ad8c8707d000e2caae1966e87c52", "author": {"user": {"login": "sascha11110", "name": "Sascha Beele"}}, "url": "https://github.com/ls1intum/Artemis/commit/a76377a3f966ad8c8707d000e2caae1966e87c52", "committedDate": "2020-04-20T09:47:59Z", "message": "Use findAllRecentNotificationsForRecipientWithLogin() in NotificationService"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9448fd0459c68e3d9a7a6d25f5d3c9826daf989", "author": {"user": null}, "url": "https://github.com/ls1intum/Artemis/commit/c9448fd0459c68e3d9a7a6d25f5d3c9826daf989", "committedDate": "2020-04-20T12:15:59Z", "message": "small refactoring and code quality improvements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d229293b74eb12fab6a6ad5ae850812407456fdd", "author": {"user": {"login": "sascha11110", "name": "Sascha Beele"}}, "url": "https://github.com/ls1intum/Artemis/commit/d229293b74eb12fab6a6ad5ae850812407456fdd", "committedDate": "2020-04-20T15:06:17Z", "message": "Delete cached notifications on logout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fff3ea2afde70c198ec5fb3aab51ab41458dba1", "author": {"user": {"login": "sascha11110", "name": "Sascha Beele"}}, "url": "https://github.com/ls1intum/Artemis/commit/3fff3ea2afde70c198ec5fb3aab51ab41458dba1", "committedDate": "2020-04-20T15:07:21Z", "message": "Remove shareReplay as notification cache ensures that get request is not send twice"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd928cab90f88118cf8d89a186527aafbf925746", "author": {"user": {"login": "sascha11110", "name": "Sascha Beele"}}, "url": "https://github.com/ls1intum/Artemis/commit/dd928cab90f88118cf8d89a186527aafbf925746", "committedDate": "2020-04-20T15:31:40Z", "message": "Initialize notification observer on service instantiation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5532dec0be8da2476be3f193207dad7bed4bc114", "author": {"user": {"login": "sascha11110", "name": "Sascha Beele"}}, "url": "https://github.com/ls1intum/Artemis/commit/5532dec0be8da2476be3f193207dad7bed4bc114", "committedDate": "2020-04-20T15:33:12Z", "message": "Clean up notification observer on log out"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1430d50197da84980bf6294e11dbcf9ef2d50756", "author": {"user": {"login": "sascha11110", "name": "Sascha Beele"}}, "url": "https://github.com/ls1intum/Artemis/commit/1430d50197da84980bf6294e11dbcf9ef2d50756", "committedDate": "2020-04-20T15:53:58Z", "message": "Add notification service to login-service.spec.ts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "beb2c8cfee202167579b1fa2730cce7c3874e98b", "author": {"user": {"login": "sascha11110", "name": "Sascha Beele"}}, "url": "https://github.com/ls1intum/Artemis/commit/beb2c8cfee202167579b1fa2730cce7c3874e98b", "committedDate": "2020-04-20T16:28:45Z", "message": "Remove now unnecessary service and repository methods"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2Nzg0NTQ3", "url": "https://github.com/ls1intum/Artemis/pull/1323#pullrequestreview-396784547", "createdAt": "2020-04-20T20:23:51Z", "commit": {"oid": "beb2c8cfee202167579b1fa2730cce7c3874e98b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQyMDoyMzo1MVrOGImJ0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQyMDoyMzo1MVrOGImJ0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY2Njg5OA==", "bodyText": "I guess we should cleanup subscribedTopics as well, right?", "url": "https://github.com/ls1intum/Artemis/pull/1323#discussion_r411666898", "createdAt": "2020-04-20T20:23:51Z", "author": {"login": "krusche"}, "path": "src/main/webapp/app/overview/notification/notification.service.ts", "diffHunk": "@@ -183,4 +174,13 @@ export class NotificationService {\n         const courseId = target.course || notification.course.id;\n         this.router.navigate([target.mainPage, courseId, target.entity, target.id]);\n     }\n+\n+    private initNotificationObserver(): void {\n+        this.notificationObserver = new BehaviorSubject<Notification | null>(null);\n+    }\n+\n+    public cleanUp(): void {\n+        this.cachedNotifications = new Observable<EntityArrayResponseType>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "beb2c8cfee202167579b1fa2730cce7c3874e98b"}, "originalPosition": 84}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2Nzg1OTA3", "url": "https://github.com/ls1intum/Artemis/pull/1323#pullrequestreview-396785907", "createdAt": "2020-04-20T20:25:53Z", "commit": {"oid": "beb2c8cfee202167579b1fa2730cce7c3874e98b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88fadcde55fff33c1e28896dfea235bcc36f6562", "author": {"user": {"login": "sascha11110", "name": "Sascha Beele"}}, "url": "https://github.com/ls1intum/Artemis/commit/88fadcde55fff33c1e28896dfea235bcc36f6562", "committedDate": "2020-04-20T21:27:46Z", "message": "Improve tests in NotificationResourceIntegrationTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0af1890947ced7227abc9f4e7db24fe3ed1a5505", "author": {"user": {"login": "sascha11110", "name": "Sascha Beele"}}, "url": "https://github.com/ls1intum/Artemis/commit/0af1890947ced7227abc9f4e7db24fe3ed1a5505", "committedDate": "2020-04-20T21:29:14Z", "message": "Clean up subscribedTopics in notification service on log out"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d06b7e97a6990dc663e28d6e89dcfd615c655686", "author": {"user": {"login": "sascha11110", "name": "Sascha Beele"}}, "url": "https://github.com/ls1intum/Artemis/commit/d06b7e97a6990dc663e28d6e89dcfd615c655686", "committedDate": "2020-04-20T21:55:43Z", "message": "Apply tests for api/notification/recent-for-user"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e22b460dd7dd8692cfb2818e07e93cb9d421b0f3", "author": {"user": {"login": "sascha11110", "name": "Sascha Beele"}}, "url": "https://github.com/ls1intum/Artemis/commit/e22b460dd7dd8692cfb2818e07e93cb9d421b0f3", "committedDate": "2020-04-20T21:59:48Z", "message": "Adjust SystemNotificationIntegrationTest to new parameter order of generateSystemNotification()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0abae33fc7013e0815d77e20172da13b68253f0f", "author": {"user": {"login": "sascha11110", "name": "Sascha Beele"}}, "url": "https://github.com/ls1intum/Artemis/commit/0abae33fc7013e0815d77e20172da13b68253f0f", "committedDate": "2020-04-20T22:01:05Z", "message": "Remove now unnecessary test case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f3fe0f1725171f1d4e8eea9f638d77ce117ca47", "author": {"user": {"login": "sascha11110", "name": "Sascha Beele"}}, "url": "https://github.com/ls1intum/Artemis/commit/9f3fe0f1725171f1d4e8eea9f638d77ce117ca47", "committedDate": "2020-04-20T22:11:18Z", "message": "Merge branch 'develop' into bugfix/notifications/rest-only-notifications-for-user"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3MTU4NDI0", "url": "https://github.com/ls1intum/Artemis/pull/1323#pullrequestreview-397158424", "createdAt": "2020-04-21T09:35:32Z", "commit": {"oid": "9f3fe0f1725171f1d4e8eea9f638d77ce117ca47"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3MTYzNDMy", "url": "https://github.com/ls1intum/Artemis/pull/1323#pullrequestreview-397163432", "createdAt": "2020-04-21T09:41:58Z", "commit": {"oid": "9f3fe0f1725171f1d4e8eea9f638d77ce117ca47"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3MTY3MzYw", "url": "https://github.com/ls1intum/Artemis/pull/1323#pullrequestreview-397167360", "createdAt": "2020-04-21T09:46:50Z", "commit": {"oid": "9f3fe0f1725171f1d4e8eea9f638d77ce117ca47"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwOTo0Njo1MFrOGI81WQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwOTo0Njo1MFrOGI81WQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjAzODQ4OQ==", "bodyText": "One thing regarding all the test cases:\nYou currently only check that the notification is returned when calling recent-for-user, which is totally fine.\nI think you do not test right now that the notification is only delivered once (correct me if I'm wrong), so I propose you execute another call to the same endpoint again and verify that the list is either empty or does at least not contain notification1 and notification2.\nThe same applies to the other test cases.", "url": "https://github.com/ls1intum/Artemis/pull/1323#discussion_r412038489", "createdAt": "2020-04-21T09:46:50Z", "author": {"login": "sleiss"}, "path": "src/test/java/de/tum/in/www1/artemis/NotificationResourceIntegrationTest.java", "diffHunk": "@@ -101,36 +115,132 @@ public void testCreateNotification_asInstructor_BAD_REQUEST() throws Exception {\n     }\n \n     @Test\n-    @WithMockUser(username = \"instructor1\", roles = \"INSTRUCTOR\")\n-    public void testGetNotifications_asInstructor() throws Exception {\n-        GroupNotificationType type = GroupNotificationType.INSTRUCTOR;\n-        GroupNotification groupNotification = new GroupNotification(exercise.getCourse(), \"Title\", \"Notification Text\", null, type);\n-        groupNotification.setTarget(groupNotification.getExerciseUpdatedTarget(exercise));\n-        notificationRepository.save(groupNotification);\n-        List<Notification> notificationResponse = request.get(\"/api/notifications\", HttpStatus.OK, List.class);\n-        assertThat(notificationResponse.size()).as(\"response length is 1\").isEqualTo(1);\n+    @Sql({ \"/h2/custom-functions.sql\" })\n+    @WithMockUser(username = \"student1\", roles = \"USER\")\n+    public void testGetNotifications_recipientEvaluation() throws Exception {\n+        User recipient = userService.getUser();\n+        SingleUserNotification notification1 = ModelFactory.generateSingleUserNotification(ZonedDateTime.now(), recipient);\n+        notificationRepository.save(notification1);\n+        SingleUserNotification notification2 = ModelFactory.generateSingleUserNotification(ZonedDateTime.now(), users.get(1));\n+        notificationRepository.save(notification2);\n+\n+        List<Notification> notifications = request.getList(\"/api/notifications\", HttpStatus.OK, Notification.class);\n+        assertThat(notifications).as(\"Notification with recipient equal to current user is returned\").contains(notification1);\n+        assertThat(notifications).as(\"Notification with recipient not equal to current user is not returned\").doesNotContain(notification2);\n+\n+        List<Notification> recentNotifications = request.getList(\"/api/notifications/recent-for-user\", HttpStatus.OK, Notification.class);\n+        assertThat(recentNotifications).as(\"Recent notification with recipient equal to current user is returned\").contains(notification1);\n+        assertThat(recentNotifications).as(\"Recent notification with recipient not equal to current user is not returned\").doesNotContain(notification2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f3fe0f1725171f1d4e8eea9f638d77ce117ca47"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3MjAzMTIw", "url": "https://github.com/ls1intum/Artemis/pull/1323#pullrequestreview-397203120", "createdAt": "2020-04-21T10:35:01Z", "commit": {"oid": "9f3fe0f1725171f1d4e8eea9f638d77ce117ca47"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b32616a45df11759e49d39355648cb7f401ce572", "author": {"user": {"login": "sascha11110", "name": "Sascha Beele"}}, "url": "https://github.com/ls1intum/Artemis/commit/b32616a45df11759e49d39355648cb7f401ce572", "committedDate": "2020-04-21T16:15:15Z", "message": "Fix evaluation of lastNotificationRead and notificationDate"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NDk2OTM0", "url": "https://github.com/ls1intum/Artemis/pull/1323#pullrequestreview-397496934", "createdAt": "2020-04-21T16:59:18Z", "commit": {"oid": "b32616a45df11759e49d39355648cb7f401ce572"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4f4b7327cff990017fe7515f093f81dfdcdd8f9", "author": {"user": {"login": "sascha11110", "name": "Sascha Beele"}}, "url": "https://github.com/ls1intum/Artemis/commit/d4f4b7327cff990017fe7515f093f81dfdcdd8f9", "committedDate": "2020-04-21T17:29:17Z", "message": "Update user lastNotificationRead differently to avoid side-effects when saving user completely"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00e2cc9568c3b6e0214cd9d9a4510869298ca40e", "author": {"user": {"login": "sascha11110", "name": "Sascha Beele"}}, "url": "https://github.com/ls1intum/Artemis/commit/00e2cc9568c3b6e0214cd9d9a4510869298ca40e", "committedDate": "2020-04-21T17:49:44Z", "message": "Merge branch 'develop' into bugfix/notifications/rest-only-notifications-for-user"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NTYwNjIw", "url": "https://github.com/ls1intum/Artemis/pull/1323#pullrequestreview-397560620", "createdAt": "2020-04-21T18:19:55Z", "commit": {"oid": "00e2cc9568c3b6e0214cd9d9a4510869298ca40e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2920, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}