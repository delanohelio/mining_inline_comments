{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2NTI5NjIy", "number": 1840, "title": "Bugfix for LTI oauth and tasks/plantUmls in multiple programming exercises in exams", "bodyText": "Fix LTI oauth on the client side\nFix issues with tasks/plantUmls in multiple programming exercises in exams\nFix an issue when programming exercise repos are exported and the Jgit repository was not closed properly\n\nChecklist\n\n I tested all changes and all related features with different users (student, tutor, instructor, admin) on the test server https://artemistest.ase.in.tum.de.\n\nMotivation and Context\nBugfixes ;-)\nDescription\n\nFix for LTI oauth: Make sure that the system notification component does not send a request to api/account\nFix for tasks: Refresh the markdown every time the user navigates between exercises and use unique ids (see plantUmls)\nFix for plantUmls: Use unique ids even when multiple problem statements are rendered in the DOM (on the same page but hidden in a different \"tab\")\n\nNote: I also increased the plantUml cache which was not really used until now. This should prevent unnecessary REST calls to the server and improve the performance\nThere is still an issue with results of one exercise affecting the task and uml status of other exercises. This is out of scope until further notice.\nSteps for Testing\n\nTry out an exam with multiple programming exercises but different tasks and plantUmls\nNavigate between those\nTasks and PlantUmls should refresh correctly\nNote: There is an ongoing exam on the test server 1 that you might want to join for testing", "createdAt": "2020-07-08T23:09:48Z", "url": "https://github.com/ls1intum/Artemis/pull/1840", "merged": true, "mergeCommit": {"oid": "6da3b01e1f0608134690efc260566e4440ab454d"}, "closed": true, "closedAt": "2020-07-10T06:19:58Z", "author": {"login": "krusche"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczBOcVAH2gAyNDQ2NTI5NjIyOjVjNjk5YjVmZGM3OWQwZGQzMDg0NzFkNDVkZDkxMmE0OWVjMjBkMjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczWQBhAH2gAyNDQ2NTI5NjIyOmEyY2YxNDVhNTYxNTdjYTBmNjlhODYwN2Q0NWUyZWNhZWUzZmVjZjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5c699b5fdc79d0dd308471d45dd912a49ec20d20", "author": {"user": null}, "url": "https://github.com/ls1intum/Artemis/commit/5c699b5fdc79d0dd308471d45dd912a49ec20d20", "committedDate": "2020-07-08T21:21:54Z", "message": "remove duplicated account call in system-notification.component.ts\n\nthis hopefully also solves the issue with the lti oauth authentication"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff84baa89232b21e5613a9c2b833f80d500f00ab", "author": {"user": null}, "url": "https://github.com/ls1intum/Artemis/commit/ff84baa89232b21e5613a9c2b833f80d500f00ab", "committedDate": "2020-07-08T22:09:46Z", "message": "update markdown when activating online code editor in exams"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30aa69c6263f519010a29bf7a872dea93a86d9a3", "author": {"user": null}, "url": "https://github.com/ls1intum/Artemis/commit/30aa69c6263f519010a29bf7a872dea93a86d9a3", "committedDate": "2020-07-08T22:47:17Z", "message": "fix bug that tasks and plantUmls are not correctly reloaded in exams when switching between multiple programming exercises in the online code editor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1Mjg5MDQz", "url": "https://github.com/ls1intum/Artemis/pull/1840#pullrequestreview-445289043", "createdAt": "2020-07-09T04:57:18Z", "commit": {"oid": "30aa69c6263f519010a29bf7a872dea93a86d9a3"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNDo1NzoxOFrOGvBrug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNToxNTo0N1rOGvB9fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk2MzgzNA==", "bodyText": "Good fix!", "url": "https://github.com/ls1intum/Artemis/pull/1840#discussion_r451963834", "createdAt": "2020-07-09T04:57:18Z", "author": {"login": "thilo-behnke"}, "path": "src/main/webapp/app/exercises/programming/shared/instructions-render/extensions/programming-exercise-plant-uml.extension.ts", "diffHunk": "@@ -14,6 +14,8 @@ export class ProgrammingExercisePlantUmlExtensionWrapper implements ArtemisShowd\n     private latestResult: Result | null = null;\n     private injectableElementsFoundSubject = new Subject<() => void>();\n \n+    // unique index, even if multiple plant uml diagrams are shown from different problem statements on the same page (in different tabs)\n+    private plantUmlIndex = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30aa69c6263f519010a29bf7a872dea93a86d9a3"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk2NzYxNw==", "bodyText": "I think this is the correct approach to fixing the issue, however I'm not sure the implementation is bulletproof:\nthis.loadAndInjectPlantUml(plantUml, this.plantUmlIndex - plantUmlsValidated.length + index + 1\nAs far as I see it, this.plantUmlIndex - plantUmlsValidated.length will lead to the wrong id range start for e.g. the first exercise in the exam:\nE.g. exercise 1 has 5 umls, exercise 2 has 3.\nFor exercise 1:\nthis.plantUmlIndex - plantUmlsValidated.length = 7 - 5 = 2\n=> Should be 0\nFor exercise 2:\nthis.plantUmlIndex - plantUmlsValidated.length = 7 - 3 = 4\n=> Should be 4\nI would suggest to directly determine the plantUml ids at the beginning, something like (untested):\n                        const plantUmls = text.match(plantUmlRegex) || [];\n                        // Assign unique ids to uml data structure at the beginning. \n                        const plantUmlsIndexed = plantUmls.map(uml -> {\n                            plantUmlIndex++;\n                            const nextIndex = plantUmlIndex;\n                            return {id: nextIndex, uml}; \n                        })\n                        const replacedText = plantUmlsIndexed.reduce((acc: string, {uml, id}): string => {\n                            return acc.replace(new RegExp(escapeStringForUseInRegex(uml), 'g'), plantUmlContainer.replace(idPlaceholder, id.toString()));              \n                        }, text);\n                        ... more stuff about validation, leaving out for brevity sake.\n                        // Now here the advantage is that the id is part of the data structure:\n                        plantUmlsValidated.forEach(({id, uml}) => {\n                            this.loadAndInjectPlantUml(uml, id);\n                        }", "url": "https://github.com/ls1intum/Artemis/pull/1840#discussion_r451967617", "createdAt": "2020-07-09T05:12:46Z", "author": {"login": "thilo-behnke"}, "path": "src/main/webapp/app/exercises/programming/shared/instructions-render/extensions/programming-exercise-plant-uml.extension.ts", "diffHunk": "@@ -66,19 +67,22 @@ export class ProgrammingExercisePlantUmlExtensionWrapper implements ArtemisShowd\n                 const plantUmlContainer = `<div class=\"mb-4\" id=\"plantUml-${idPlaceholder}\"></div>`;\n                 // Replace test status markers.\n                 const plantUmls = text.match(plantUmlRegex) || [];\n-                const replacedText = plantUmls.reduce(\n-                    (acc: string, plantUml: string, index: number): string =>\n-                        acc.replace(new RegExp(escapeStringForUseInRegex(plantUml), 'g'), plantUmlContainer.replace(idPlaceholder, index.toString())),\n-                    text,\n-                );\n+                const replacedText = plantUmls.reduce((acc: string, plantUml: string): string => {\n+                    this.plantUmlIndex++;\n+                    return acc.replace(new RegExp(escapeStringForUseInRegex(plantUml), 'g'), plantUmlContainer.replace(idPlaceholder, this.plantUmlIndex.toString()));\n+                }, text);\n                 const plantUmlsValidated = plantUmls.map((plantUml) =>\n                     plantUml.replace(/testsColor\\(([^)]+)\\)/g, (match: any, capture: string) => {\n                         const tests = capture.split(',');\n                         const { testCaseState } = this.programmingExerciseInstructionService.testStatusForTask(tests, this.latestResult);\n                         return testCaseState === TestCaseState.SUCCESS ? 'green' : testCaseState === TestCaseState.FAIL ? 'red' : 'grey';\n                     }),\n                 );\n-                this.injectableElementsFoundSubject.next(() => this.loadAndInjectPlantUmls(plantUmlsValidated));\n+                this.injectableElementsFoundSubject.next(() => {\n+                    plantUmlsValidated.forEach((plantUml: string, index: number) => {\n+                        this.loadAndInjectPlantUml(plantUml, this.plantUmlIndex - plantUmlsValidated.length + index + 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30aa69c6263f519010a29bf7a872dea93a86d9a3"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk2ODM4Mg==", "bodyText": "Another possible fix would be to save the plantUmlIndex in a closure outside of the thunk.\nThis has the advantage that the plantUml index range start will be the same, even if the service variable changes (this.plantUmlIndex).\nAgain not tested:\n// Store variable in closure.\nconst plantUmlIndexRangeStart = this.plantUmlIndex - plantUmlsValidated.length;\nplantUmlsValidated.forEach((plantUml: string, index: number) => {]\n                        // Access the closure variable instead of the class property.\n                        this.loadAndInjectPlantUml(plantUml, plantUmlIndexRangeStart + index + 1);\n}", "url": "https://github.com/ls1intum/Artemis/pull/1840#discussion_r451968382", "createdAt": "2020-07-09T05:15:47Z", "author": {"login": "thilo-behnke"}, "path": "src/main/webapp/app/exercises/programming/shared/instructions-render/extensions/programming-exercise-plant-uml.extension.ts", "diffHunk": "@@ -66,19 +67,22 @@ export class ProgrammingExercisePlantUmlExtensionWrapper implements ArtemisShowd\n                 const plantUmlContainer = `<div class=\"mb-4\" id=\"plantUml-${idPlaceholder}\"></div>`;\n                 // Replace test status markers.\n                 const plantUmls = text.match(plantUmlRegex) || [];\n-                const replacedText = plantUmls.reduce(\n-                    (acc: string, plantUml: string, index: number): string =>\n-                        acc.replace(new RegExp(escapeStringForUseInRegex(plantUml), 'g'), plantUmlContainer.replace(idPlaceholder, index.toString())),\n-                    text,\n-                );\n+                const replacedText = plantUmls.reduce((acc: string, plantUml: string): string => {\n+                    this.plantUmlIndex++;\n+                    return acc.replace(new RegExp(escapeStringForUseInRegex(plantUml), 'g'), plantUmlContainer.replace(idPlaceholder, this.plantUmlIndex.toString()));\n+                }, text);\n                 const plantUmlsValidated = plantUmls.map((plantUml) =>\n                     plantUml.replace(/testsColor\\(([^)]+)\\)/g, (match: any, capture: string) => {\n                         const tests = capture.split(',');\n                         const { testCaseState } = this.programmingExerciseInstructionService.testStatusForTask(tests, this.latestResult);\n                         return testCaseState === TestCaseState.SUCCESS ? 'green' : testCaseState === TestCaseState.FAIL ? 'red' : 'grey';\n                     }),\n                 );\n-                this.injectableElementsFoundSubject.next(() => this.loadAndInjectPlantUmls(plantUmlsValidated));\n+                this.injectableElementsFoundSubject.next(() => {\n+                    plantUmlsValidated.forEach((plantUml: string, index: number) => {\n+                        this.loadAndInjectPlantUml(plantUml, this.plantUmlIndex - plantUmlsValidated.length + index + 1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk2NzYxNw=="}, "originalCommit": {"oid": "30aa69c6263f519010a29bf7a872dea93a86d9a3"}, "originalPosition": 73}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NDA3NDE5", "url": "https://github.com/ls1intum/Artemis/pull/1840#pullrequestreview-445407419", "createdAt": "2020-07-09T08:40:43Z", "commit": {"oid": "30aa69c6263f519010a29bf7a872dea93a86d9a3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NDkwNzcz", "url": "https://github.com/ls1intum/Artemis/pull/1840#pullrequestreview-445490773", "createdAt": "2020-07-09T10:30:12Z", "commit": {"oid": "30aa69c6263f519010a29bf7a872dea93a86d9a3"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31156f5be042d3a7331f1ecdfd3f36fc3178573c", "author": {"user": null}, "url": "https://github.com/ls1intum/Artemis/commit/31156f5be042d3a7331f1ecdfd3f36fc3178573c", "committedDate": "2020-07-09T14:24:40Z", "message": "make sure to close repos after download so that the delete operation works"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a01077e3dc3c3b220cc500d76b84dfe425b7dd26", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/a01077e3dc3c3b220cc500d76b84dfe425b7dd26", "committedDate": "2020-07-09T18:40:55Z", "message": "Store index with uml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0931d965f6a630ec7c13add92ea9df09efab2dd7", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/0931d965f6a630ec7c13add92ea9df09efab2dd7", "committedDate": "2020-07-09T18:48:24Z", "message": "Add id to tasks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b02f03bc2497d8108f418af82b2c8325a638dea7", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/b02f03bc2497d8108f418af82b2c8325a638dea7", "committedDate": "2020-07-09T18:48:51Z", "message": "Merge branch 'bugfix/lti-oauth2' of https://github.com/ls1intum/Artemis into bugfix/lti-oauth2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e433a66e9b1792b4e62f60f9f4a6f99b1fab59c", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/0e433a66e9b1792b4e62f60f9f4a6f99b1fab59c", "committedDate": "2020-07-09T19:27:35Z", "message": "Fix task tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e4a00788115dc466a98bcd0e56bd9ce83b24db2", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/5e4a00788115dc466a98bcd0e56bd9ce83b24db2", "committedDate": "2020-07-09T19:37:29Z", "message": "Remove unnecessary test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "190767c0e175bce50a26713228dcfb4cbc69835a", "author": {"user": {"login": "kloessst", "name": "Stefan Kl\u00f6ss-Schuster"}}, "url": "https://github.com/ls1intum/Artemis/commit/190767c0e175bce50a26713228dcfb4cbc69835a", "committedDate": "2020-07-09T20:04:53Z", "message": "Linting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1OTgwMzY5", "url": "https://github.com/ls1intum/Artemis/pull/1840#pullrequestreview-445980369", "createdAt": "2020-07-09T21:25:59Z", "commit": {"oid": "190767c0e175bce50a26713228dcfb4cbc69835a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2cf145a56157ca0f69a8607d45e2ecaee3fecf2", "author": {"user": {"login": "krusche", "name": "Stephan Krusche"}}, "url": "https://github.com/ls1intum/Artemis/commit/a2cf145a56157ca0f69a8607d45e2ecaee3fecf2", "committedDate": "2020-07-09T21:51:38Z", "message": "Merge branch 'develop' into bugfix/lti-oauth2"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4291, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}