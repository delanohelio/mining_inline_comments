{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3Njg1OTY3", "number": 2157, "title": "athene load balancer", "bodyText": "Checklist\n\n I tested all changes and all related features with different users (student, tutor, instructor, admin) on the test server https://artemistest.ase.in.tum.de.\n Server: I added multiple integration tests (Spring) related to the features (with a high test coverage)\n Server: I added @PreAuthorize and check the course groups for all new REST Calls (security)\n Server: I implemented the changes with a good performance and prevented too many database calls\n Server: I documented the Java code using JavaDoc style.\n Client: I added multiple integration tests (Jest) related to the features (with a high test coverage)\n Client: I added authorities to all new routes and check the course groups for displaying navigation elements (links, buttons)\n Client: I documented the TypeScript code using JSDoc style.\n Client: I added multiple screenshots/screencasts of my UI changes\n Client: I translated all the newly inserted strings into German and English\n\nMotivation and Context\nArtemis currently calls each Athene-component (segmentation, embedding, clustering) sequentially by itself. This blocks an Artemis thread as long as these calculations are running and does not support load-balancing of the calculation. Since especially the embedding-process is a long-running job, we introduced a load-balancing-component to the Athene system, which will handle a request for automatic feedback suggestion calculation and will send the results back to Artemis via a callbackUrl (${server.url}/api/athene-result({exerciseId}).\nDescription\nThe changes in this PR support the conversion of the existing stand-alone Athene components to the new load-balanced system. Thus, Artemis will only send one single request to the Athene system to invoke the calculation of automatic feedback suggestions for text exercises. This PR is related to PR #27 in Athene.\nSteps for Testing\n\nStart the Athene-system in the state of PR #27 using docker-compose up -d\nIf needed, adjust the ports used by Athene to unused ones on your machine using the .env-file:\n\n\nTRAEFIK_DASHBOARD_PORT=8081 (unimportant for this PR, this gives status information)\nTRAEFIK_HTTP_PORT=80\nTRAEFIK_HTTPS_PORT=443 (unimportant for this PR, since we use unencrypted HTTP in non-production setups)\n\n\nAdjust the variable server.url in the Artemis config (e.g. in application-local.yml): Set this variable to the IP of your machine in its current local network (e.g. 192.168.1.20, NOT localhost). Otherwise, the Athene system will not be able to reach out to Artemis out of its docker bridge-network, if all is running on the same machine. You can get this IP using ipconfig (Windows), ifconfig (Linux and macOS), or by inspecting your network adapter elsewhere in the OS.\nIf you changed the TRAEFIK_HTTP_PORT of Athene in step 2, make sure to adjust the variable artemis.athene.submit-url corresponding to your change\nStart Artemis with the profiles dev,bamboo,bitbucket,jira,artemis,scheduling,local,athene\nLog in to Artemis\nNavigate to Course Management\nSelect a course, create a new text exercise and enable \"Automatic assessment suggestions enabled\"\nCreate at least 10 submissions for this exercise before the deadline\nLet the deadline pass\nInspect the logs and check for errors of the Athene components using\n\n\ndocker logs -f athene-load-balancer (Interaction with Artemis and all calculation components)\ndocker logs -f athene-segmentation (1st calculation step)\ndocker logs -f athene-embedding (2nd calculation step)\ndocker logs -f athene-clustering (3rd calculation step)\n\n\nCheck the database tables text_block and text_cluster for entries\nCheck the automatic feedback suggestions by starting an assessment as a tutor of the course the created exercise of step 8 belongs to\n\nTest Coverage\n\nAtheneService.java: 92%\nTextAssessmentConflictService.java: 100%", "createdAt": "2020-10-05T08:29:38Z", "url": "https://github.com/ls1intum/Artemis/pull/2157", "merged": true, "mergeCommit": {"oid": "bec5fb2eff514c1cf5fd55a5d9d06a13890c239c"}, "closed": true, "closedAt": "2020-10-29T09:55:35Z", "author": {"login": "linusmichel"}, "timelineItems": {"totalCount": 86, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOpPnEAH2gAyNDk3Njg1OTY3OmRhOTJkOGQ5Yjg2MDZhMDBmODlhODYyYTEzZGUzMTA4ZTgyZGZhYTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXPH4ugFqTUxOTQ5ODEwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "da92d8d9b8606a00f89a862a13de3108e82dfaa0", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/da92d8d9b8606a00f89a862a13de3108e82dfaa0", "committedDate": "2020-10-02T17:15:20Z", "message": "First working version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eeaddc06c05fbd113773ebbb77761d605581f247", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/eeaddc06c05fbd113773ebbb77761d605581f247", "committedDate": "2020-10-02T19:05:03Z", "message": "Add athene submit-url to application-artemis"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3eaba821cb43790ca9571670fa13ead5f903cc9d", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/3eaba821cb43790ca9571670fa13ead5f903cc9d", "committedDate": "2020-10-03T12:10:40Z", "message": "Fix response Exception error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b5668da953cd2f0026845154379dabd8bb1fafc", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/4b5668da953cd2f0026845154379dabd8bb1fafc", "committedDate": "2020-10-04T18:02:31Z", "message": "Conversion to AtheneService"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6192253bedfa5059ccc6158f2261d751bb87ea0e", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/6192253bedfa5059ccc6158f2261d751bb87ea0e", "committedDate": "2020-10-04T18:02:51Z", "message": "."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxODMyMDcx", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-501832071", "createdAt": "2020-10-05T08:34:40Z", "commit": {"oid": "6192253bedfa5059ccc6158f2261d751bb87ea0e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwODozNDo0MVrOHcSxqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwODozNDo0MVrOHcSxqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQyOTgwMQ==", "bodyText": "please move into a service", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r499429801", "createdAt": "2020-10-05T08:34:41Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/web/rest/AtheneResource.java", "diffHunk": "@@ -0,0 +1,171 @@\n+package de.tum.in.www1.artemis.web.rest;\n+\n+import de.tum.in.www1.artemis.config.Constants;\n+import de.tum.in.www1.artemis.domain.*;\n+import de.tum.in.www1.artemis.repository.TextBlockRepository;\n+import de.tum.in.www1.artemis.repository.TextClusterRepository;\n+import de.tum.in.www1.artemis.repository.TextExerciseRepository;\n+import de.tum.in.www1.artemis.service.*;\n+import de.tum.in.www1.artemis.service.connectors.AtheneService;\n+import de.tum.in.www1.artemis.web.rest.dto.AtheneDTO;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.transaction.annotation.Transactional;\n+import org.springframework.web.bind.annotation.*;\n+\n+import java.util.*;\n+\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.Collectors.toMap;\n+import static org.springframework.http.MediaType.APPLICATION_JSON_VALUE;\n+\n+/**\n+ * REST controller for managing Athene results.\n+ */\n+@RestController\n+@RequestMapping(Constants.ATHENE_RESULT_API_PATH)\n+@Profile(\"athene\")\n+public class AtheneResource {\n+\n+    @Value(\"${artemis.athene.base64-secret}\")\n+    private String API_SECRET;\n+\n+    private final Logger log = LoggerFactory.getLogger(AtheneResource.class);\n+\n+    private final TextBlockRepository textBlockRepository;\n+\n+    private final TextClusterRepository textClusterRepository;\n+\n+    private final TextAssessmentQueueService textAssessmentQueueService;\n+\n+    private final TextExerciseRepository textExerciseRepository;\n+\n+    private final TextSubmissionService textSubmissionService;\n+\n+    private final AtheneService atheneService;\n+\n+    public AtheneResource(TextBlockRepository textBlockRepository, TextClusterRepository textClusterRepository, TextAssessmentQueueService textAssessmentQueueService,\n+                          TextExerciseRepository textExerciseRepository, TextSubmissionService textSubmissionService, AtheneService atheneService) {\n+        this.textBlockRepository = textBlockRepository;\n+        this.textClusterRepository = textClusterRepository;\n+        this.textAssessmentQueueService = textAssessmentQueueService;\n+        this.textExerciseRepository = textExerciseRepository;\n+        this.textSubmissionService = textSubmissionService;\n+        this.atheneService = atheneService;\n+    }\n+\n+    /**\n+     * Parse text blocks of type AtheneDTO.TextBlock to TextBlocks linked to their submission\n+     *\n+     * @param blocks The list of AtheneDTO-blocks to parse\n+     * @param exerciseId The exerciseId of the exercise the blocks belong to\n+     * @return list of TextBlocks\n+     */\n+    private List<TextBlock> parseTextBlocks(List<AtheneDTO.TextBlock> blocks, Long exerciseId) {\n+        // Create submissionsMap for lookup\n+        List<TextSubmission> submissions = textSubmissionService.getTextSubmissionsByExerciseId(exerciseId, true, false);\n+        Map<Long, TextSubmission> submissionsMap = submissions.stream()\n+            .collect(toMap(/* Key: */ (submission -> submission.getId()), /* Value: */ (submission -> submission)));\n+\n+        // Map textBlocks to submissions\n+        List<TextBlock> textBlocks = new LinkedList();\n+        for (AtheneDTO.TextBlock t: blocks) {\n+            // Convert DTO-TextBlock (including the submissionId) to TextBlock Entity\n+            TextBlock newBlock = new TextBlock();\n+            newBlock.setId(t.id);\n+            newBlock.setText(t.text);\n+            newBlock.setStartIndex(t.startIndex);\n+            newBlock.setEndIndex(t.endIndex);\n+            newBlock.automatic();\n+\n+            // take the corresponding TextSubmission and add the text blocks.\n+            // The addBlocks method also sets the submission in the textBlock\n+            TextSubmission s = submissionsMap.get(t.submissionId);\n+            submissionsMap.get(t.submissionId).addBlock(newBlock);\n+            textBlocks.add(newBlock);\n+        }\n+\n+        return textBlocks;\n+\n+    }\n+\n+    /**\n+     * Process clusters and save to database\n+     *\n+     * @param clusterMap The map of clusters to process\n+     * @param textBlockMap The map of textBlocks belonging to the clusters\n+     * @param exerciseId The exerciseId of the exercise the blocks belong to\n+     */\n+    private void processClusters(Map<Integer, TextCluster> clusterMap, Map<String, TextBlock> textBlockMap, Long exerciseId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6192253bedfa5059ccc6158f2261d751bb87ea0e"}, "originalPosition": 103}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxODMyMTUw", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-501832150", "createdAt": "2020-10-05T08:34:47Z", "commit": {"oid": "6192253bedfa5059ccc6158f2261d751bb87ea0e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwODozNDo0N1rOHcSx2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwODozNDo0N1rOHcSx2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQyOTg1MQ==", "bodyText": "please move into a service", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r499429851", "createdAt": "2020-10-05T08:34:47Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/web/rest/AtheneResource.java", "diffHunk": "@@ -0,0 +1,171 @@\n+package de.tum.in.www1.artemis.web.rest;\n+\n+import de.tum.in.www1.artemis.config.Constants;\n+import de.tum.in.www1.artemis.domain.*;\n+import de.tum.in.www1.artemis.repository.TextBlockRepository;\n+import de.tum.in.www1.artemis.repository.TextClusterRepository;\n+import de.tum.in.www1.artemis.repository.TextExerciseRepository;\n+import de.tum.in.www1.artemis.service.*;\n+import de.tum.in.www1.artemis.service.connectors.AtheneService;\n+import de.tum.in.www1.artemis.web.rest.dto.AtheneDTO;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.transaction.annotation.Transactional;\n+import org.springframework.web.bind.annotation.*;\n+\n+import java.util.*;\n+\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.Collectors.toMap;\n+import static org.springframework.http.MediaType.APPLICATION_JSON_VALUE;\n+\n+/**\n+ * REST controller for managing Athene results.\n+ */\n+@RestController\n+@RequestMapping(Constants.ATHENE_RESULT_API_PATH)\n+@Profile(\"athene\")\n+public class AtheneResource {\n+\n+    @Value(\"${artemis.athene.base64-secret}\")\n+    private String API_SECRET;\n+\n+    private final Logger log = LoggerFactory.getLogger(AtheneResource.class);\n+\n+    private final TextBlockRepository textBlockRepository;\n+\n+    private final TextClusterRepository textClusterRepository;\n+\n+    private final TextAssessmentQueueService textAssessmentQueueService;\n+\n+    private final TextExerciseRepository textExerciseRepository;\n+\n+    private final TextSubmissionService textSubmissionService;\n+\n+    private final AtheneService atheneService;\n+\n+    public AtheneResource(TextBlockRepository textBlockRepository, TextClusterRepository textClusterRepository, TextAssessmentQueueService textAssessmentQueueService,\n+                          TextExerciseRepository textExerciseRepository, TextSubmissionService textSubmissionService, AtheneService atheneService) {\n+        this.textBlockRepository = textBlockRepository;\n+        this.textClusterRepository = textClusterRepository;\n+        this.textAssessmentQueueService = textAssessmentQueueService;\n+        this.textExerciseRepository = textExerciseRepository;\n+        this.textSubmissionService = textSubmissionService;\n+        this.atheneService = atheneService;\n+    }\n+\n+    /**\n+     * Parse text blocks of type AtheneDTO.TextBlock to TextBlocks linked to their submission\n+     *\n+     * @param blocks The list of AtheneDTO-blocks to parse\n+     * @param exerciseId The exerciseId of the exercise the blocks belong to\n+     * @return list of TextBlocks\n+     */\n+    private List<TextBlock> parseTextBlocks(List<AtheneDTO.TextBlock> blocks, Long exerciseId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6192253bedfa5059ccc6158f2261d751bb87ea0e"}, "originalPosition": 68}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxODMyMzk4", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-501832398", "createdAt": "2020-10-05T08:35:05Z", "commit": {"oid": "6192253bedfa5059ccc6158f2261d751bb87ea0e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwODozNTowNVrOHcSyog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwODozNTowNVrOHcSyog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQzMDA1MA==", "bodyText": "please avoid Transactional", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r499430050", "createdAt": "2020-10-05T08:35:05Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/web/rest/AtheneResource.java", "diffHunk": "@@ -0,0 +1,171 @@\n+package de.tum.in.www1.artemis.web.rest;\n+\n+import de.tum.in.www1.artemis.config.Constants;\n+import de.tum.in.www1.artemis.domain.*;\n+import de.tum.in.www1.artemis.repository.TextBlockRepository;\n+import de.tum.in.www1.artemis.repository.TextClusterRepository;\n+import de.tum.in.www1.artemis.repository.TextExerciseRepository;\n+import de.tum.in.www1.artemis.service.*;\n+import de.tum.in.www1.artemis.service.connectors.AtheneService;\n+import de.tum.in.www1.artemis.web.rest.dto.AtheneDTO;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.transaction.annotation.Transactional;\n+import org.springframework.web.bind.annotation.*;\n+\n+import java.util.*;\n+\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.Collectors.toMap;\n+import static org.springframework.http.MediaType.APPLICATION_JSON_VALUE;\n+\n+/**\n+ * REST controller for managing Athene results.\n+ */\n+@RestController\n+@RequestMapping(Constants.ATHENE_RESULT_API_PATH)\n+@Profile(\"athene\")\n+public class AtheneResource {\n+\n+    @Value(\"${artemis.athene.base64-secret}\")\n+    private String API_SECRET;\n+\n+    private final Logger log = LoggerFactory.getLogger(AtheneResource.class);\n+\n+    private final TextBlockRepository textBlockRepository;\n+\n+    private final TextClusterRepository textClusterRepository;\n+\n+    private final TextAssessmentQueueService textAssessmentQueueService;\n+\n+    private final TextExerciseRepository textExerciseRepository;\n+\n+    private final TextSubmissionService textSubmissionService;\n+\n+    private final AtheneService atheneService;\n+\n+    public AtheneResource(TextBlockRepository textBlockRepository, TextClusterRepository textClusterRepository, TextAssessmentQueueService textAssessmentQueueService,\n+                          TextExerciseRepository textExerciseRepository, TextSubmissionService textSubmissionService, AtheneService atheneService) {\n+        this.textBlockRepository = textBlockRepository;\n+        this.textClusterRepository = textClusterRepository;\n+        this.textAssessmentQueueService = textAssessmentQueueService;\n+        this.textExerciseRepository = textExerciseRepository;\n+        this.textSubmissionService = textSubmissionService;\n+        this.atheneService = atheneService;\n+    }\n+\n+    /**\n+     * Parse text blocks of type AtheneDTO.TextBlock to TextBlocks linked to their submission\n+     *\n+     * @param blocks The list of AtheneDTO-blocks to parse\n+     * @param exerciseId The exerciseId of the exercise the blocks belong to\n+     * @return list of TextBlocks\n+     */\n+    private List<TextBlock> parseTextBlocks(List<AtheneDTO.TextBlock> blocks, Long exerciseId) {\n+        // Create submissionsMap for lookup\n+        List<TextSubmission> submissions = textSubmissionService.getTextSubmissionsByExerciseId(exerciseId, true, false);\n+        Map<Long, TextSubmission> submissionsMap = submissions.stream()\n+            .collect(toMap(/* Key: */ (submission -> submission.getId()), /* Value: */ (submission -> submission)));\n+\n+        // Map textBlocks to submissions\n+        List<TextBlock> textBlocks = new LinkedList();\n+        for (AtheneDTO.TextBlock t: blocks) {\n+            // Convert DTO-TextBlock (including the submissionId) to TextBlock Entity\n+            TextBlock newBlock = new TextBlock();\n+            newBlock.setId(t.id);\n+            newBlock.setText(t.text);\n+            newBlock.setStartIndex(t.startIndex);\n+            newBlock.setEndIndex(t.endIndex);\n+            newBlock.automatic();\n+\n+            // take the corresponding TextSubmission and add the text blocks.\n+            // The addBlocks method also sets the submission in the textBlock\n+            TextSubmission s = submissionsMap.get(t.submissionId);\n+            submissionsMap.get(t.submissionId).addBlock(newBlock);\n+            textBlocks.add(newBlock);\n+        }\n+\n+        return textBlocks;\n+\n+    }\n+\n+    /**\n+     * Process clusters and save to database\n+     *\n+     * @param clusterMap The map of clusters to process\n+     * @param textBlockMap The map of textBlocks belonging to the clusters\n+     * @param exerciseId The exerciseId of the exercise the blocks belong to\n+     */\n+    private void processClusters(Map<Integer, TextCluster> clusterMap, Map<String, TextBlock> textBlockMap, Long exerciseId) {\n+        // Remove Cluster with Key \"-1\" as it is only contains the blocks belonging to no cluster.\n+        clusterMap.remove(-1);\n+        final List<TextCluster> savedClusters = textClusterRepository.saveAll(clusterMap.values());\n+\n+        // Find exercise, which the clusters belong to\n+        Optional<TextExercise> optionalTextExercise = textExerciseRepository.findWithEagerTeamAssignmentConfigAndCategoriesById(exerciseId);\n+        if (optionalTextExercise.isEmpty()) {\n+            log.error(\"Error while processing Athene clusters. Exercise with id \" + exerciseId + \"not found\");\n+            new Error().printStackTrace();\n+            return;\n+        }\n+        TextExercise textExercise = optionalTextExercise.get();\n+\n+        // Link clusters with blocks\n+        for (TextCluster cluster : savedClusters) {\n+            cluster.setExercise(textExercise);\n+            List<TextBlock> updatedBlockReferences = cluster.getBlocks().parallelStream().map(block -> textBlockMap.get(block.getId())).peek(block -> block.setCluster(cluster))\n+                .collect(toList());\n+            textAssessmentQueueService.setAddedDistances(updatedBlockReferences, cluster);\n+            updatedBlockReferences = textBlockRepository.saveAll(updatedBlockReferences);\n+            cluster.setBlocks(updatedBlockReferences);\n+        }\n+\n+        // Save clusters in Database\n+        textClusterRepository.saveAll(savedClusters);\n+    }\n+\n+    /**\n+     * Saves automatic textAssessments of Athene\n+     *\n+     * @param exerciseId The exerciseId of the exercise which will be saved\n+     * @param requestBody The calculation results containing blocks and clusters\n+     * @param auth The secret for authorization\n+     * @return 200 Ok if successful or 401 unauthorized if secret is wrong\n+     */\n+    @PostMapping(value = \"/{exerciseId}\", consumes = APPLICATION_JSON_VALUE)\n+    @Transactional", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6192253bedfa5059ccc6158f2261d751bb87ea0e"}, "originalPosition": 140}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxODMyOTEx", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-501832911", "createdAt": "2020-10-05T08:35:45Z", "commit": {"oid": "6192253bedfa5059ccc6158f2261d751bb87ea0e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwODozNTo0NlrOHcS0HQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwODozNTo0NlrOHcS0HQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQzMDQyOQ==", "bodyText": "A resource should only check if the request is valid.\nAll processing logic (including db read and save) that is not necessary to checking the validity of the request should be done in a service", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r499430429", "createdAt": "2020-10-05T08:35:46Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/web/rest/AtheneResource.java", "diffHunk": "@@ -0,0 +1,171 @@\n+package de.tum.in.www1.artemis.web.rest;\n+\n+import de.tum.in.www1.artemis.config.Constants;\n+import de.tum.in.www1.artemis.domain.*;\n+import de.tum.in.www1.artemis.repository.TextBlockRepository;\n+import de.tum.in.www1.artemis.repository.TextClusterRepository;\n+import de.tum.in.www1.artemis.repository.TextExerciseRepository;\n+import de.tum.in.www1.artemis.service.*;\n+import de.tum.in.www1.artemis.service.connectors.AtheneService;\n+import de.tum.in.www1.artemis.web.rest.dto.AtheneDTO;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.transaction.annotation.Transactional;\n+import org.springframework.web.bind.annotation.*;\n+\n+import java.util.*;\n+\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.Collectors.toMap;\n+import static org.springframework.http.MediaType.APPLICATION_JSON_VALUE;\n+\n+/**\n+ * REST controller for managing Athene results.\n+ */\n+@RestController\n+@RequestMapping(Constants.ATHENE_RESULT_API_PATH)\n+@Profile(\"athene\")\n+public class AtheneResource {\n+\n+    @Value(\"${artemis.athene.base64-secret}\")\n+    private String API_SECRET;\n+\n+    private final Logger log = LoggerFactory.getLogger(AtheneResource.class);\n+\n+    private final TextBlockRepository textBlockRepository;\n+\n+    private final TextClusterRepository textClusterRepository;\n+\n+    private final TextAssessmentQueueService textAssessmentQueueService;\n+\n+    private final TextExerciseRepository textExerciseRepository;\n+\n+    private final TextSubmissionService textSubmissionService;\n+\n+    private final AtheneService atheneService;\n+\n+    public AtheneResource(TextBlockRepository textBlockRepository, TextClusterRepository textClusterRepository, TextAssessmentQueueService textAssessmentQueueService,\n+                          TextExerciseRepository textExerciseRepository, TextSubmissionService textSubmissionService, AtheneService atheneService) {\n+        this.textBlockRepository = textBlockRepository;\n+        this.textClusterRepository = textClusterRepository;\n+        this.textAssessmentQueueService = textAssessmentQueueService;\n+        this.textExerciseRepository = textExerciseRepository;\n+        this.textSubmissionService = textSubmissionService;\n+        this.atheneService = atheneService;\n+    }\n+\n+    /**\n+     * Parse text blocks of type AtheneDTO.TextBlock to TextBlocks linked to their submission\n+     *\n+     * @param blocks The list of AtheneDTO-blocks to parse\n+     * @param exerciseId The exerciseId of the exercise the blocks belong to\n+     * @return list of TextBlocks\n+     */\n+    private List<TextBlock> parseTextBlocks(List<AtheneDTO.TextBlock> blocks, Long exerciseId) {\n+        // Create submissionsMap for lookup\n+        List<TextSubmission> submissions = textSubmissionService.getTextSubmissionsByExerciseId(exerciseId, true, false);\n+        Map<Long, TextSubmission> submissionsMap = submissions.stream()\n+            .collect(toMap(/* Key: */ (submission -> submission.getId()), /* Value: */ (submission -> submission)));\n+\n+        // Map textBlocks to submissions\n+        List<TextBlock> textBlocks = new LinkedList();\n+        for (AtheneDTO.TextBlock t: blocks) {\n+            // Convert DTO-TextBlock (including the submissionId) to TextBlock Entity\n+            TextBlock newBlock = new TextBlock();\n+            newBlock.setId(t.id);\n+            newBlock.setText(t.text);\n+            newBlock.setStartIndex(t.startIndex);\n+            newBlock.setEndIndex(t.endIndex);\n+            newBlock.automatic();\n+\n+            // take the corresponding TextSubmission and add the text blocks.\n+            // The addBlocks method also sets the submission in the textBlock\n+            TextSubmission s = submissionsMap.get(t.submissionId);\n+            submissionsMap.get(t.submissionId).addBlock(newBlock);\n+            textBlocks.add(newBlock);\n+        }\n+\n+        return textBlocks;\n+\n+    }\n+\n+    /**\n+     * Process clusters and save to database\n+     *\n+     * @param clusterMap The map of clusters to process\n+     * @param textBlockMap The map of textBlocks belonging to the clusters\n+     * @param exerciseId The exerciseId of the exercise the blocks belong to\n+     */\n+    private void processClusters(Map<Integer, TextCluster> clusterMap, Map<String, TextBlock> textBlockMap, Long exerciseId) {\n+        // Remove Cluster with Key \"-1\" as it is only contains the blocks belonging to no cluster.\n+        clusterMap.remove(-1);\n+        final List<TextCluster> savedClusters = textClusterRepository.saveAll(clusterMap.values());\n+\n+        // Find exercise, which the clusters belong to\n+        Optional<TextExercise> optionalTextExercise = textExerciseRepository.findWithEagerTeamAssignmentConfigAndCategoriesById(exerciseId);\n+        if (optionalTextExercise.isEmpty()) {\n+            log.error(\"Error while processing Athene clusters. Exercise with id \" + exerciseId + \"not found\");\n+            new Error().printStackTrace();\n+            return;\n+        }\n+        TextExercise textExercise = optionalTextExercise.get();\n+\n+        // Link clusters with blocks\n+        for (TextCluster cluster : savedClusters) {\n+            cluster.setExercise(textExercise);\n+            List<TextBlock> updatedBlockReferences = cluster.getBlocks().parallelStream().map(block -> textBlockMap.get(block.getId())).peek(block -> block.setCluster(cluster))\n+                .collect(toList());\n+            textAssessmentQueueService.setAddedDistances(updatedBlockReferences, cluster);\n+            updatedBlockReferences = textBlockRepository.saveAll(updatedBlockReferences);\n+            cluster.setBlocks(updatedBlockReferences);\n+        }\n+\n+        // Save clusters in Database\n+        textClusterRepository.saveAll(savedClusters);\n+    }\n+\n+    /**\n+     * Saves automatic textAssessments of Athene\n+     *\n+     * @param exerciseId The exerciseId of the exercise which will be saved\n+     * @param requestBody The calculation results containing blocks and clusters\n+     * @param auth The secret for authorization\n+     * @return 200 Ok if successful or 401 unauthorized if secret is wrong\n+     */\n+    @PostMapping(value = \"/{exerciseId}\", consumes = APPLICATION_JSON_VALUE)\n+    @Transactional\n+    public ResponseEntity<Result> saveAtheneResult(@PathVariable Long exerciseId, @RequestBody AtheneDTO requestBody, @RequestHeader(\"Authorization\") String auth) {\n+        log.debug(\"REST request to inform about new Athene results for exercise: {}\", exerciseId);\n+\n+        // Check Authorization header\n+        if (!auth.equals(API_SECRET)) {\n+            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();\n+        }\n+\n+        // Check if job should be running, otherwise reject results\n+        if (!atheneService.isTaskRunning(exerciseId)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6192253bedfa5059ccc6158f2261d751bb87ea0e"}, "originalPosition": 150}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac948561c4fac13e850f91b2a5e8b29c0dc84ff1", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/ac948561c4fac13e850f91b2a5e8b29c0dc84ff1", "committedDate": "2020-10-05T09:36:27Z", "message": "Fixing codacy issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4ffb4d561bb64737fb069762d087feccfbdfb07", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/c4ffb4d561bb64737fb069762d087feccfbdfb07", "committedDate": "2020-10-05T09:55:54Z", "message": "Fix PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87cbe7ad2184725f22231b01015844026e0b2e4b", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/87cbe7ad2184725f22231b01015844026e0b2e4b", "committedDate": "2020-10-05T10:13:56Z", "message": "Separate request-logic from processing-logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db25b4522bd838b91a2eb2ddae86c0dca5ece304", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/db25b4522bd838b91a2eb2ddae86c0dca5ece304", "committedDate": "2020-10-05T10:28:48Z", "message": "Remove unused variable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "faa39135b7ff1c70e111ceb90f190b994a8cfedd", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/faa39135b7ff1c70e111ceb90f190b994a8cfedd", "committedDate": "2020-10-05T15:24:26Z", "message": "Eliminate processing logic in AtheneResource"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c4cdcdefcf3dfab7db34266b57fb771120b27d8", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/6c4cdcdefcf3dfab7db34266b57fb771120b27d8", "committedDate": "2020-10-06T09:29:03Z", "message": "Merge branch 'develop' into feature/athene-load-balancer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06f5f86c5423d498999bbbd26254bca2c520439e", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/06f5f86c5423d498999bbbd26254bca2c520439e", "committedDate": "2020-10-20T11:12:53Z", "message": "Add Tests for AtheneService"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c3fb5c47f5163ef1604b745d3bffb1e6f914213", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/5c3fb5c47f5163ef1604b745d3bffb1e6f914213", "committedDate": "2020-10-20T11:29:27Z", "message": "Remove old classes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5de7cb7c4243c14571c019647948fe673cb14b5", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/a5de7cb7c4243c14571c019647948fe673cb14b5", "committedDate": "2020-10-20T11:30:01Z", "message": "Get rid of old automaticText profile"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c91ca03c9f90325de88b4b033b7b9ffbf00f42ad", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/c91ca03c9f90325de88b4b033b7b9ffbf00f42ad", "committedDate": "2020-10-20T11:31:14Z", "message": "Fix codestyle issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2eb85f846ea4b45d9e9a3ac8863b617837491d7", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/d2eb85f846ea4b45d9e9a3ac8863b617837491d7", "committedDate": "2020-10-20T12:00:15Z", "message": "Add Test properties"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf5028bfa679f5ee8f721c3b74df0adf29dbb70b", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/bf5028bfa679f5ee8f721c3b74df0adf29dbb70b", "committedDate": "2020-10-20T12:30:45Z", "message": "Migrate old automatic-text variables to new athene profile"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f28a374e8c6d73f890b7b074d946a5fac1584068", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/f28a374e8c6d73f890b7b074d946a5fac1584068", "committedDate": "2020-10-20T13:07:34Z", "message": "Change config and documentation for new athene profile"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0148b1a06aa81fd71894fe5968399e78d91058fd", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/0148b1a06aa81fd71894fe5968399e78d91058fd", "committedDate": "2020-10-20T13:39:28Z", "message": "Merge commit 'a718e9f2c1575dbd6565b13b4972f15db1d15219' into feature/athene-load-balancer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b07029b9c77b9167c7c167a98751a3cfb34aceb", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/7b07029b9c77b9167c7c167a98751a3cfb34aceb", "committedDate": "2020-10-20T13:44:47Z", "message": "Undo changes in intellij run configuration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ec978887d24146940547d8ae7f3508d04d6746a", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/7ec978887d24146940547d8ae7f3508d04d6746a", "committedDate": "2020-10-21T08:16:01Z", "message": "Fix codacy issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6999784f2045a4ce803968dc1677734d580b7855", "author": {"user": {"login": "krusche", "name": "Stephan Krusche"}}, "url": "https://github.com/ls1intum/Artemis/commit/6999784f2045a4ce803968dc1677734d580b7855", "committedDate": "2020-10-21T19:46:47Z", "message": "Merge branch 'develop' into feature/athene-load-balancer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0ODUwMjcw", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-514850270", "createdAt": "2020-10-22T15:24:38Z", "commit": {"oid": "6999784f2045a4ce803968dc1677734d580b7855"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNToyNDozOFrOHmnT1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNTo0NToyNFrOHmoRMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI1MTk5MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Athene Service (Text Assessment Clustering)\n          \n          \n            \n            Athene Service", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r510251991", "createdAt": "2020-10-22T15:24:38Z", "author": {"login": "jpbernius"}, "path": "docs/dev/setup.rst", "diffHunk": "@@ -342,18 +339,18 @@ Other useful commands:\n -  Stop the client: ``docker-compose stop artemis-client`` (restart via\n    ``docker-compose start artemis-client``)\n \n-Text Assessment Clustering Service\n+Athene Service (Text Assessment Clustering)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6999784f2045a4ce803968dc1677734d580b7855"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI1MzM0Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    private List<TextSubmission> submissionDTOs(@NotNull List<TextSubmission> submissions) {\n          \n          \n            \n                    private static List<TextSubmission> submissionDTOs(@NotNull List<TextSubmission> submissions) {", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r510253347", "createdAt": "2020-10-22T15:26:13Z", "author": {"login": "jpbernius"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/AtheneService.java", "diffHunk": "@@ -0,0 +1,288 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import static de.tum.in.www1.artemis.config.Constants.ATHENE_RESULT_API_PATH;\n+import static de.tum.in.www1.artemis.service.connectors.RemoteArtemisServiceConnector.authorizationHeaderForSymmetricSecret;\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.Collectors.toMap;\n+\n+import java.util.*;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import de.tum.in.www1.artemis.domain.*;\n+import de.tum.in.www1.artemis.domain.enumeration.Language;\n+import de.tum.in.www1.artemis.exception.NetworkingError;\n+import de.tum.in.www1.artemis.repository.TextBlockRepository;\n+import de.tum.in.www1.artemis.repository.TextClusterRepository;\n+import de.tum.in.www1.artemis.repository.TextExerciseRepository;\n+import de.tum.in.www1.artemis.service.TextAssessmentQueueService;\n+import de.tum.in.www1.artemis.service.TextBlockService;\n+import de.tum.in.www1.artemis.service.TextSubmissionService;\n+import de.tum.in.www1.artemis.web.rest.dto.AtheneDTO;\n+\n+@Service\n+@Profile(\"athene\")\n+public class AtheneService {\n+\n+    private final Logger log = LoggerFactory.getLogger(AtheneService.class);\n+\n+    @Value(\"${server.url}\")\n+    protected String ARTEMIS_SERVER_URL;\n+\n+    @Value(\"${artemis.athene.submit-url}\")\n+    private String API_ENDPOINT;\n+\n+    @Value(\"${artemis.athene.base64-secret}\")\n+    private String API_SECRET;\n+\n+    private final TextAssessmentQueueService textAssessmentQueueService;\n+\n+    private final TextBlockRepository textBlockRepository;\n+\n+    private final TextBlockService textBlockService;\n+\n+    private final TextClusterRepository textClusterRepository;\n+\n+    private final TextExerciseRepository textExerciseRepository;\n+\n+    private final TextSubmissionService textSubmissionService;\n+\n+    private final RemoteArtemisServiceConnector<Request, Response> connector = new RemoteArtemisServiceConnector<>(log, Response.class);\n+\n+    // Contains tasks submitted to Athene and currently processing\n+    private final List<Long> runningAtheneTasks = new ArrayList<>();\n+\n+    public AtheneService(TextSubmissionService textSubmissionService, TextBlockRepository textBlockRepository, TextBlockService textBlockService,\n+            TextClusterRepository textClusterRepository, TextExerciseRepository textExerciseRepository, TextAssessmentQueueService textAssessmentQueueService) {\n+        this.textSubmissionService = textSubmissionService;\n+        this.textBlockRepository = textBlockRepository;\n+        this.textBlockService = textBlockService;\n+        this.textClusterRepository = textClusterRepository;\n+        this.textExerciseRepository = textExerciseRepository;\n+        this.textAssessmentQueueService = textAssessmentQueueService;\n+    }\n+\n+    // region Request/Response DTOs\n+    private static class Request {\n+\n+        public long courseId;\n+\n+        public String callbackUrl;\n+\n+        public List<TextSubmission> submissions;\n+\n+        Request(@NotNull long courseId, @NotNull List<TextSubmission> submissions, @NotNull String callbackUrl) {\n+            this.courseId = courseId;\n+            this.callbackUrl = callbackUrl;\n+            this.submissions = submissionDTOs(submissions);\n+        }\n+\n+        /**\n+         * Create new TextSubmission as DTO.\n+         */\n+        @NotNull\n+        private List<TextSubmission> submissionDTOs(@NotNull List<TextSubmission> submissions) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6999784f2045a4ce803968dc1677734d580b7855"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI1NjQ4OQ==", "bodyText": "I think we can even skip this part. This should be done before assessing each submission. so only exit if there are < 10", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r510256489", "createdAt": "2020-10-22T15:30:19Z", "author": {"login": "jpbernius"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/AtheneService.java", "diffHunk": "@@ -0,0 +1,288 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import static de.tum.in.www1.artemis.config.Constants.ATHENE_RESULT_API_PATH;\n+import static de.tum.in.www1.artemis.service.connectors.RemoteArtemisServiceConnector.authorizationHeaderForSymmetricSecret;\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.Collectors.toMap;\n+\n+import java.util.*;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import de.tum.in.www1.artemis.domain.*;\n+import de.tum.in.www1.artemis.domain.enumeration.Language;\n+import de.tum.in.www1.artemis.exception.NetworkingError;\n+import de.tum.in.www1.artemis.repository.TextBlockRepository;\n+import de.tum.in.www1.artemis.repository.TextClusterRepository;\n+import de.tum.in.www1.artemis.repository.TextExerciseRepository;\n+import de.tum.in.www1.artemis.service.TextAssessmentQueueService;\n+import de.tum.in.www1.artemis.service.TextBlockService;\n+import de.tum.in.www1.artemis.service.TextSubmissionService;\n+import de.tum.in.www1.artemis.web.rest.dto.AtheneDTO;\n+\n+@Service\n+@Profile(\"athene\")\n+public class AtheneService {\n+\n+    private final Logger log = LoggerFactory.getLogger(AtheneService.class);\n+\n+    @Value(\"${server.url}\")\n+    protected String ARTEMIS_SERVER_URL;\n+\n+    @Value(\"${artemis.athene.submit-url}\")\n+    private String API_ENDPOINT;\n+\n+    @Value(\"${artemis.athene.base64-secret}\")\n+    private String API_SECRET;\n+\n+    private final TextAssessmentQueueService textAssessmentQueueService;\n+\n+    private final TextBlockRepository textBlockRepository;\n+\n+    private final TextBlockService textBlockService;\n+\n+    private final TextClusterRepository textClusterRepository;\n+\n+    private final TextExerciseRepository textExerciseRepository;\n+\n+    private final TextSubmissionService textSubmissionService;\n+\n+    private final RemoteArtemisServiceConnector<Request, Response> connector = new RemoteArtemisServiceConnector<>(log, Response.class);\n+\n+    // Contains tasks submitted to Athene and currently processing\n+    private final List<Long> runningAtheneTasks = new ArrayList<>();\n+\n+    public AtheneService(TextSubmissionService textSubmissionService, TextBlockRepository textBlockRepository, TextBlockService textBlockService,\n+            TextClusterRepository textClusterRepository, TextExerciseRepository textExerciseRepository, TextAssessmentQueueService textAssessmentQueueService) {\n+        this.textSubmissionService = textSubmissionService;\n+        this.textBlockRepository = textBlockRepository;\n+        this.textBlockService = textBlockService;\n+        this.textClusterRepository = textClusterRepository;\n+        this.textExerciseRepository = textExerciseRepository;\n+        this.textAssessmentQueueService = textAssessmentQueueService;\n+    }\n+\n+    // region Request/Response DTOs\n+    private static class Request {\n+\n+        public long courseId;\n+\n+        public String callbackUrl;\n+\n+        public List<TextSubmission> submissions;\n+\n+        Request(@NotNull long courseId, @NotNull List<TextSubmission> submissions, @NotNull String callbackUrl) {\n+            this.courseId = courseId;\n+            this.callbackUrl = callbackUrl;\n+            this.submissions = submissionDTOs(submissions);\n+        }\n+\n+        /**\n+         * Create new TextSubmission as DTO.\n+         */\n+        @NotNull\n+        private List<TextSubmission> submissionDTOs(@NotNull List<TextSubmission> submissions) {\n+            return submissions.stream().map(textSubmission -> {\n+                final TextSubmission submission = new TextSubmission();\n+                submission.setText(textSubmission.getText());\n+                submission.setId(textSubmission.getId());\n+                return submission;\n+            }).collect(toList());\n+        }\n+    }\n+\n+    private static class Response {\n+\n+        public String detail;\n+\n+    }\n+    // endregion\n+\n+    /**\n+     * Register an Athene task for an exercise as running\n+     * @param exerciseId the exerciseId which the Athene task is running for\n+     */\n+    public void startTask(Long exerciseId) {\n+        runningAtheneTasks.add(exerciseId);\n+    }\n+\n+    /**\n+     * Delete an Athene task for an exercise from the running tasks\n+     * @param exerciseId the exerciseId which the Athene task finished for\n+     */\n+    public void finishTask(Long exerciseId) {\n+        runningAtheneTasks.remove(exerciseId);\n+    }\n+\n+    /**\n+     * Check whether an Athene task is running for the given exerciseId\n+     * @param exerciseId the exerciseId to check for a running Athene task\n+     * @return true, if a task for the given exerciseId is running\n+     */\n+    public boolean isTaskRunning(Long exerciseId) {\n+        return runningAtheneTasks.contains(exerciseId);\n+    }\n+\n+    /**\n+     * Calls the remote Athene service to submit a Job for calculating automatic feedback\n+     * @param exercise the exercise the automatic assessments should be calculated for\n+     */\n+    public void submitJob(TextExercise exercise) {\n+        submitJob(exercise, 1);\n+    }\n+\n+    /**\n+     * Calls the remote Athene service to submit a Job for calculating automatic feedback\n+     * Falls back to naive splitting for less than 10 submissions\n+     * Note: See `TextSubmissionService:getTextSubmissionsByExerciseId` for selection of Submissions.\n+     * @param exercise the exercise the automatic assessments should be calculated for\n+     * @param maxRetries number of retries before the request will be canceled\n+     */\n+    public void submitJob(TextExercise exercise, int maxRetries) {\n+        log.debug(\"Start Athene Service for Text Exercise \\\"\" + exercise.getTitle() + \"\\\" (#\" + exercise.getId() + \").\");\n+\n+        // Find all submissions for Exercise\n+        List<TextSubmission> textSubmissions = textSubmissionService.getTextSubmissionsByExerciseId(exercise.getId(), true, false);\n+\n+        // We only support english languages so far, to prevent corruption of the clustering\n+        textSubmissions.removeIf(textSubmission -> textSubmission.getLanguage() != Language.ENGLISH);\n+\n+        // Athene only works if more than 10 submissions are available\n+        // else textBlockService is used\n+        if (textSubmissions.size() >= 10) {\n+\n+            log.info(\"Calling Remote Service to calculate automatic feedback for \" + textSubmissions.size() + \" submissions.\");\n+\n+            try {\n+                final Request request = new Request(exercise.getId(), textSubmissions, ARTEMIS_SERVER_URL + ATHENE_RESULT_API_PATH + exercise.getId());\n+                Response response = connector.invokeWithRetry(API_ENDPOINT, request, authorizationHeaderForSymmetricSecret(API_SECRET), maxRetries);\n+                log.info(\"Remote Service to calculate automatic feedback responded: \" + response.detail);\n+\n+                // Register task for exercise as running, AtheneResource calls finishTask on result receive\n+                startTask(exercise.getId());\n+            }\n+            catch (NetworkingError networkingError) {\n+                log.error(\"Error while calling Remote Service\", networkingError);\n+            }\n+\n+        }\n+        else {\n+\n+            log.info(\"More than 10 submissions needed to calculate automatic feedback. Falling back to naive splitting\");\n+\n+            List<TextBlock> set = new ArrayList<>();\n+\n+            // Split Submissions into Blocks\n+            for (TextSubmission textSubmission : textSubmissions) {\n+\n+                final List<TextBlock> blocks = textBlockService.splitSubmissionIntoBlocks(textSubmission);\n+                textSubmission.setBlocks(blocks);\n+                set.addAll(blocks);\n+\n+            }\n+\n+            textBlockRepository.saveAll(set);\n+\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6999784f2045a4ce803968dc1677734d580b7855"}, "originalPosition": 193}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI2NDQ0Mg==", "bodyText": "Not sure what @Profile does here. But I am happy to keep it if it does anything.", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r510264442", "createdAt": "2020-10-22T15:41:00Z", "author": {"login": "jpbernius"}, "path": "src/main/java/de/tum/in/www1/artemis/web/rest/dto/AtheneDTO.java", "diffHunk": "@@ -0,0 +1,37 @@\n+package de.tum.in.www1.artemis.web.rest.dto;\n+\n+import java.util.*;\n+\n+import org.springframework.context.annotation.Profile;\n+\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+\n+import de.tum.in.www1.artemis.domain.TextBlockType;\n+import de.tum.in.www1.artemis.domain.TextCluster;\n+\n+@Profile(\"athene\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6999784f2045a4ce803968dc1677734d580b7855"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI2NzY5OA==", "bodyText": "Please use the JUnit assertThat or assertEquals methods.", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r510267698", "createdAt": "2020-10-22T15:45:24Z", "author": {"login": "jpbernius"}, "path": "src/test/java/de/tum/in/www1/artemis/service/connectors/AtheneServiceTest.java", "diffHunk": "@@ -0,0 +1,278 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import static org.apache.commons.codec.digest.DigestUtils.sha1Hex;\n+import static org.mockito.Mockito.*;\n+import static org.springframework.test.web.client.match.MockRestRequestMatchers.method;\n+import static org.springframework.test.web.client.match.MockRestRequestMatchers.requestTo;\n+import static org.springframework.test.web.client.response.MockRestResponseCreators.withSuccess;\n+\n+import java.time.ZonedDateTime;\n+import java.util.*;\n+\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.*;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.HttpMethod;\n+import org.springframework.http.MediaType;\n+import org.springframework.test.util.ReflectionTestUtils;\n+import org.springframework.test.web.client.ExpectedCount;\n+import org.springframework.test.web.client.MockRestServiceServer;\n+import org.springframework.web.client.RestTemplate;\n+\n+import de.tum.in.www1.artemis.AbstractSpringIntegrationBambooBitbucketJiraTest;\n+import de.tum.in.www1.artemis.domain.*;\n+import de.tum.in.www1.artemis.domain.enumeration.Language;\n+import de.tum.in.www1.artemis.repository.*;\n+import de.tum.in.www1.artemis.service.TextAssessmentQueueService;\n+import de.tum.in.www1.artemis.service.TextBlockService;\n+import de.tum.in.www1.artemis.service.TextSubmissionService;\n+import de.tum.in.www1.artemis.util.ModelFactory;\n+import de.tum.in.www1.artemis.web.rest.dto.AtheneDTO;\n+\n+public class AtheneServiceTest extends AbstractSpringIntegrationBambooBitbucketJiraTest {\n+\n+    @Autowired\n+    RestTemplate restTemplate;\n+\n+    @Autowired\n+    TextBlockService textBlockService;\n+\n+    @Autowired\n+    TextAssessmentQueueService textAssessmentQueueService;\n+\n+    @Mock\n+    TextExerciseRepository textExerciseRepository;\n+\n+    @Mock\n+    TextBlockRepository textBlockRepository;\n+\n+    @Mock\n+    TextSubmissionService textSubmissionService;\n+\n+    @Mock\n+    TextClusterRepository textClusterRepository;\n+\n+    private final String API_ENDPOINT = \"http://localhost/submit\";\n+\n+    AtheneService atheneService;\n+\n+    TextExercise exercise1;\n+\n+    /**\n+     * Initializes atheneService and example exercise\n+     */\n+    @BeforeEach\n+    public void init() {\n+        // Create atheneService and inject @Value fields\n+        atheneService = new AtheneService(textSubmissionService, textBlockRepository, textBlockService, textClusterRepository, textExerciseRepository, textAssessmentQueueService);\n+        ReflectionTestUtils.setField(atheneService, \"ARTEMIS_SERVER_URL\", ARTEMIS_SERVER_URL);\n+        ReflectionTestUtils.setField(atheneService, \"API_ENDPOINT\", API_ENDPOINT);\n+        String API_SECRET = \"YWVuaXF1YWRpNWNlaXJpNmFlbTZkb283dXphaVF1b29oM3J1MWNoYWlyNHRoZWUzb2huZ2FpM211bGVlM0VpcAo=\";\n+        ReflectionTestUtils.setField(atheneService, \"API_SECRET\", API_SECRET);\n+\n+        // Create example exercise\n+        ZonedDateTime pastTimestamp = ZonedDateTime.now().minusDays(5);\n+        ZonedDateTime futureTimestamp = ZonedDateTime.now().plusDays(5);\n+        Course course1 = ModelFactory.generateCourse(1L, pastTimestamp, futureTimestamp, new HashSet<>(), \"tumuser\", \"tutor\", \"instructor\");\n+        course1.setRegistrationEnabled(true);\n+        exercise1 = ModelFactory.generateTextExercise(pastTimestamp, futureTimestamp, futureTimestamp, course1);\n+        exercise1.setId(1L);\n+\n+        when(textExerciseRepository.findWithEagerTeamAssignmentConfigAndCategoriesById(exercise1.getId())).thenReturn(Optional.ofNullable(exercise1));\n+    }\n+\n+    /**\n+     * Submits a job to atheneService without any submissions\n+     */\n+    @Test\n+    public void submitJobWithoutSubmissions() {\n+        // Catch call of atheneService to the textBlockRepository\n+        when(textBlockRepository.saveAll(anyIterable())).thenAnswer(invocation -> {\n+            ArrayList<TextBlock> set = invocation.getArgument(0);\n+            // Check for correct number of textBlocks\n+            assert set.size() == 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6999784f2045a4ce803968dc1677734d580b7855"}, "originalPosition": 94}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9693a96a1c02526084fc4da15f3c686b13cd445", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/f9693a96a1c02526084fc4da15f3c686b13cd445", "committedDate": "2020-10-22T17:47:07Z", "message": "Apply suggestions from code review\n\nCo-authored-by: Jan Philip Bernius <janphilip.bernius@tum.de>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f64c8384b57d80487754a0e9a37524c95d44d6a", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/7f64c8384b57d80487754a0e9a37524c95d44d6a", "committedDate": "2020-10-22T18:28:13Z", "message": "Implement requested changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ead6b158e8d6c6eb41a29c2e6bc46c9a8c0dd792", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/ead6b158e8d6c6eb41a29c2e6bc46c9a8c0dd792", "committedDate": "2020-10-22T18:29:09Z", "message": "Merge branch 'feature/athene-load-balancer' of https://github.com/ls1intum/Artemis into feature/athene-load-balancer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MDQ2NDU4", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-515046458", "createdAt": "2020-10-22T19:21:13Z", "commit": {"oid": "ead6b158e8d6c6eb41a29c2e6bc46c9a8c0dd792"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b81a76378d0898657ac0b861371fd33571b73121", "author": {"user": {"login": "jpbernius", "name": "Jan Philip Bernius"}}, "url": "https://github.com/ls1intum/Artemis/commit/b81a76378d0898657ac0b861371fd33571b73121", "committedDate": "2020-10-22T19:21:23Z", "message": "Merge branch 'develop' into feature/athene-load-balancer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MDU2MTE5", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-515056119", "createdAt": "2020-10-22T19:35:05Z", "commit": {"oid": "b81a76378d0898657ac0b861371fd33571b73121"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxOTozNTowNVrOHmw2hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxOTozNTowNVrOHmw2hw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQwODMyNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Transactional\n          \n      \n    \n    \n  \n\nDo we need this actually?", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r510408327", "createdAt": "2020-10-22T19:35:05Z", "author": {"login": "jpbernius"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/AtheneService.java", "diffHunk": "@@ -0,0 +1,269 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import static de.tum.in.www1.artemis.config.Constants.ATHENE_RESULT_API_PATH;\n+import static de.tum.in.www1.artemis.service.connectors.RemoteArtemisServiceConnector.authorizationHeaderForSymmetricSecret;\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.Collectors.toMap;\n+\n+import java.util.*;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import de.tum.in.www1.artemis.domain.*;\n+import de.tum.in.www1.artemis.domain.enumeration.Language;\n+import de.tum.in.www1.artemis.exception.NetworkingError;\n+import de.tum.in.www1.artemis.repository.TextBlockRepository;\n+import de.tum.in.www1.artemis.repository.TextClusterRepository;\n+import de.tum.in.www1.artemis.repository.TextExerciseRepository;\n+import de.tum.in.www1.artemis.service.TextAssessmentQueueService;\n+import de.tum.in.www1.artemis.service.TextBlockService;\n+import de.tum.in.www1.artemis.service.TextSubmissionService;\n+import de.tum.in.www1.artemis.web.rest.dto.AtheneDTO;\n+\n+@Service\n+@Profile(\"athene\")\n+public class AtheneService {\n+\n+    private final Logger log = LoggerFactory.getLogger(AtheneService.class);\n+\n+    @Value(\"${server.url}\")\n+    protected String ARTEMIS_SERVER_URL;\n+\n+    @Value(\"${artemis.athene.submit-url}\")\n+    private String API_ENDPOINT;\n+\n+    @Value(\"${artemis.athene.base64-secret}\")\n+    private String API_SECRET;\n+\n+    private final TextAssessmentQueueService textAssessmentQueueService;\n+\n+    private final TextBlockRepository textBlockRepository;\n+\n+    private final TextBlockService textBlockService;\n+\n+    private final TextClusterRepository textClusterRepository;\n+\n+    private final TextExerciseRepository textExerciseRepository;\n+\n+    private final TextSubmissionService textSubmissionService;\n+\n+    private final RemoteArtemisServiceConnector<Request, Response> connector = new RemoteArtemisServiceConnector<>(log, Response.class);\n+\n+    // Contains tasks submitted to Athene and currently processing\n+    private final List<Long> runningAtheneTasks = new ArrayList<>();\n+\n+    public AtheneService(TextSubmissionService textSubmissionService, TextBlockRepository textBlockRepository, TextBlockService textBlockService,\n+            TextClusterRepository textClusterRepository, TextExerciseRepository textExerciseRepository, TextAssessmentQueueService textAssessmentQueueService) {\n+        this.textSubmissionService = textSubmissionService;\n+        this.textBlockRepository = textBlockRepository;\n+        this.textBlockService = textBlockService;\n+        this.textClusterRepository = textClusterRepository;\n+        this.textExerciseRepository = textExerciseRepository;\n+        this.textAssessmentQueueService = textAssessmentQueueService;\n+    }\n+\n+    // region Request/Response DTOs\n+    private static class Request {\n+\n+        public long courseId;\n+\n+        public String callbackUrl;\n+\n+        public List<TextSubmission> submissions;\n+\n+        Request(@NotNull long courseId, @NotNull List<TextSubmission> submissions, @NotNull String callbackUrl) {\n+            this.courseId = courseId;\n+            this.callbackUrl = callbackUrl;\n+            this.submissions = submissionDTOs(submissions);\n+        }\n+\n+        /**\n+         * Create new TextSubmission as DTO.\n+         */\n+        @NotNull\n+        private static List<TextSubmission> submissionDTOs(@NotNull List<TextSubmission> submissions) {\n+            return submissions.stream().map(textSubmission -> {\n+                final TextSubmission submission = new TextSubmission();\n+                submission.setText(textSubmission.getText());\n+                submission.setId(textSubmission.getId());\n+                return submission;\n+            }).collect(toList());\n+        }\n+    }\n+\n+    private static class Response {\n+\n+        public String detail;\n+\n+    }\n+    // endregion\n+\n+    /**\n+     * Register an Athene task for an exercise as running\n+     * @param exerciseId the exerciseId which the Athene task is running for\n+     */\n+    public void startTask(Long exerciseId) {\n+        runningAtheneTasks.add(exerciseId);\n+    }\n+\n+    /**\n+     * Delete an Athene task for an exercise from the running tasks\n+     * @param exerciseId the exerciseId which the Athene task finished for\n+     */\n+    public void finishTask(Long exerciseId) {\n+        runningAtheneTasks.remove(exerciseId);\n+    }\n+\n+    /**\n+     * Check whether an Athene task is running for the given exerciseId\n+     * @param exerciseId the exerciseId to check for a running Athene task\n+     * @return true, if a task for the given exerciseId is running\n+     */\n+    public boolean isTaskRunning(Long exerciseId) {\n+        return runningAtheneTasks.contains(exerciseId);\n+    }\n+\n+    /**\n+     * Calls the remote Athene service to submit a Job for calculating automatic feedback\n+     * @param exercise the exercise the automatic assessments should be calculated for\n+     */\n+    public void submitJob(TextExercise exercise) {\n+        submitJob(exercise, 1);\n+    }\n+\n+    /**\n+     * Calls the remote Athene service to submit a Job for calculating automatic feedback\n+     * Falls back to naive splitting for less than 10 submissions\n+     * Note: See `TextSubmissionService:getTextSubmissionsByExerciseId` for selection of Submissions.\n+     * @param exercise the exercise the automatic assessments should be calculated for\n+     * @param maxRetries number of retries before the request will be canceled\n+     */\n+    public void submitJob(TextExercise exercise, int maxRetries) {\n+        log.debug(\"Start Athene Service for Text Exercise \\\"\" + exercise.getTitle() + \"\\\" (#\" + exercise.getId() + \").\");\n+\n+        // Find all submissions for Exercise\n+        List<TextSubmission> textSubmissions = textSubmissionService.getTextSubmissionsByExerciseId(exercise.getId(), true, false);\n+\n+        // We only support english languages so far, to prevent corruption of the clustering\n+        textSubmissions.removeIf(textSubmission -> textSubmission.getLanguage() != Language.ENGLISH);\n+\n+        // Athene only works with 10 or more submissions\n+        if (textSubmissions.size() >= 10) {\n+\n+            log.info(\"Calling Remote Service to calculate automatic feedback for \" + textSubmissions.size() + \" submissions.\");\n+\n+            try {\n+                final Request request = new Request(exercise.getId(), textSubmissions, ARTEMIS_SERVER_URL + ATHENE_RESULT_API_PATH + exercise.getId());\n+                Response response = connector.invokeWithRetry(API_ENDPOINT, request, authorizationHeaderForSymmetricSecret(API_SECRET), maxRetries);\n+                log.info(\"Remote Service to calculate automatic feedback responded: \" + response.detail);\n+\n+                // Register task for exercise as running, AtheneResource calls finishTask on result receive\n+                startTask(exercise.getId());\n+            }\n+            catch (NetworkingError networkingError) {\n+                log.error(\"Error while calling Remote Service\", networkingError);\n+            }\n+\n+        }\n+    }\n+\n+    /**\n+     * Processes results coming back from the Athene system via callbackUrl (see AtheneResource)\n+     * @param clusters the Map of calculated clusters to save to the database\n+     * @param blocks the list of calculated textBlocks to save to the database\n+     * @param exerciseId the exercise the automatic feedback suggestions were calculated for\n+     */\n+    @Transactional", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b81a76378d0898657ac0b861371fd33571b73121"}, "originalPosition": 183}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MDU1NDUz", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-515055453", "createdAt": "2020-10-22T19:34:10Z", "commit": {"oid": "b81a76378d0898657ac0b861371fd33571b73121"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxOTozNDoxMFrOHmw0zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxOTozNTozNlrOHmw3mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQwNzg4Ng==", "bodyText": "Can we remove transactional?", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r510407886", "createdAt": "2020-10-22T19:34:10Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/AtheneService.java", "diffHunk": "@@ -0,0 +1,269 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import static de.tum.in.www1.artemis.config.Constants.ATHENE_RESULT_API_PATH;\n+import static de.tum.in.www1.artemis.service.connectors.RemoteArtemisServiceConnector.authorizationHeaderForSymmetricSecret;\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.Collectors.toMap;\n+\n+import java.util.*;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import de.tum.in.www1.artemis.domain.*;\n+import de.tum.in.www1.artemis.domain.enumeration.Language;\n+import de.tum.in.www1.artemis.exception.NetworkingError;\n+import de.tum.in.www1.artemis.repository.TextBlockRepository;\n+import de.tum.in.www1.artemis.repository.TextClusterRepository;\n+import de.tum.in.www1.artemis.repository.TextExerciseRepository;\n+import de.tum.in.www1.artemis.service.TextAssessmentQueueService;\n+import de.tum.in.www1.artemis.service.TextBlockService;\n+import de.tum.in.www1.artemis.service.TextSubmissionService;\n+import de.tum.in.www1.artemis.web.rest.dto.AtheneDTO;\n+\n+@Service\n+@Profile(\"athene\")\n+public class AtheneService {\n+\n+    private final Logger log = LoggerFactory.getLogger(AtheneService.class);\n+\n+    @Value(\"${server.url}\")\n+    protected String ARTEMIS_SERVER_URL;\n+\n+    @Value(\"${artemis.athene.submit-url}\")\n+    private String API_ENDPOINT;\n+\n+    @Value(\"${artemis.athene.base64-secret}\")\n+    private String API_SECRET;\n+\n+    private final TextAssessmentQueueService textAssessmentQueueService;\n+\n+    private final TextBlockRepository textBlockRepository;\n+\n+    private final TextBlockService textBlockService;\n+\n+    private final TextClusterRepository textClusterRepository;\n+\n+    private final TextExerciseRepository textExerciseRepository;\n+\n+    private final TextSubmissionService textSubmissionService;\n+\n+    private final RemoteArtemisServiceConnector<Request, Response> connector = new RemoteArtemisServiceConnector<>(log, Response.class);\n+\n+    // Contains tasks submitted to Athene and currently processing\n+    private final List<Long> runningAtheneTasks = new ArrayList<>();\n+\n+    public AtheneService(TextSubmissionService textSubmissionService, TextBlockRepository textBlockRepository, TextBlockService textBlockService,\n+            TextClusterRepository textClusterRepository, TextExerciseRepository textExerciseRepository, TextAssessmentQueueService textAssessmentQueueService) {\n+        this.textSubmissionService = textSubmissionService;\n+        this.textBlockRepository = textBlockRepository;\n+        this.textBlockService = textBlockService;\n+        this.textClusterRepository = textClusterRepository;\n+        this.textExerciseRepository = textExerciseRepository;\n+        this.textAssessmentQueueService = textAssessmentQueueService;\n+    }\n+\n+    // region Request/Response DTOs\n+    private static class Request {\n+\n+        public long courseId;\n+\n+        public String callbackUrl;\n+\n+        public List<TextSubmission> submissions;\n+\n+        Request(@NotNull long courseId, @NotNull List<TextSubmission> submissions, @NotNull String callbackUrl) {\n+            this.courseId = courseId;\n+            this.callbackUrl = callbackUrl;\n+            this.submissions = submissionDTOs(submissions);\n+        }\n+\n+        /**\n+         * Create new TextSubmission as DTO.\n+         */\n+        @NotNull\n+        private static List<TextSubmission> submissionDTOs(@NotNull List<TextSubmission> submissions) {\n+            return submissions.stream().map(textSubmission -> {\n+                final TextSubmission submission = new TextSubmission();\n+                submission.setText(textSubmission.getText());\n+                submission.setId(textSubmission.getId());\n+                return submission;\n+            }).collect(toList());\n+        }\n+    }\n+\n+    private static class Response {\n+\n+        public String detail;\n+\n+    }\n+    // endregion\n+\n+    /**\n+     * Register an Athene task for an exercise as running\n+     * @param exerciseId the exerciseId which the Athene task is running for\n+     */\n+    public void startTask(Long exerciseId) {\n+        runningAtheneTasks.add(exerciseId);\n+    }\n+\n+    /**\n+     * Delete an Athene task for an exercise from the running tasks\n+     * @param exerciseId the exerciseId which the Athene task finished for\n+     */\n+    public void finishTask(Long exerciseId) {\n+        runningAtheneTasks.remove(exerciseId);\n+    }\n+\n+    /**\n+     * Check whether an Athene task is running for the given exerciseId\n+     * @param exerciseId the exerciseId to check for a running Athene task\n+     * @return true, if a task for the given exerciseId is running\n+     */\n+    public boolean isTaskRunning(Long exerciseId) {\n+        return runningAtheneTasks.contains(exerciseId);\n+    }\n+\n+    /**\n+     * Calls the remote Athene service to submit a Job for calculating automatic feedback\n+     * @param exercise the exercise the automatic assessments should be calculated for\n+     */\n+    public void submitJob(TextExercise exercise) {\n+        submitJob(exercise, 1);\n+    }\n+\n+    /**\n+     * Calls the remote Athene service to submit a Job for calculating automatic feedback\n+     * Falls back to naive splitting for less than 10 submissions\n+     * Note: See `TextSubmissionService:getTextSubmissionsByExerciseId` for selection of Submissions.\n+     * @param exercise the exercise the automatic assessments should be calculated for\n+     * @param maxRetries number of retries before the request will be canceled\n+     */\n+    public void submitJob(TextExercise exercise, int maxRetries) {\n+        log.debug(\"Start Athene Service for Text Exercise \\\"\" + exercise.getTitle() + \"\\\" (#\" + exercise.getId() + \").\");\n+\n+        // Find all submissions for Exercise\n+        List<TextSubmission> textSubmissions = textSubmissionService.getTextSubmissionsByExerciseId(exercise.getId(), true, false);\n+\n+        // We only support english languages so far, to prevent corruption of the clustering\n+        textSubmissions.removeIf(textSubmission -> textSubmission.getLanguage() != Language.ENGLISH);\n+\n+        // Athene only works with 10 or more submissions\n+        if (textSubmissions.size() >= 10) {\n+\n+            log.info(\"Calling Remote Service to calculate automatic feedback for \" + textSubmissions.size() + \" submissions.\");\n+\n+            try {\n+                final Request request = new Request(exercise.getId(), textSubmissions, ARTEMIS_SERVER_URL + ATHENE_RESULT_API_PATH + exercise.getId());\n+                Response response = connector.invokeWithRetry(API_ENDPOINT, request, authorizationHeaderForSymmetricSecret(API_SECRET), maxRetries);\n+                log.info(\"Remote Service to calculate automatic feedback responded: \" + response.detail);\n+\n+                // Register task for exercise as running, AtheneResource calls finishTask on result receive\n+                startTask(exercise.getId());\n+            }\n+            catch (NetworkingError networkingError) {\n+                log.error(\"Error while calling Remote Service\", networkingError);\n+            }\n+\n+        }\n+    }\n+\n+    /**\n+     * Processes results coming back from the Athene system via callbackUrl (see AtheneResource)\n+     * @param clusters the Map of calculated clusters to save to the database\n+     * @param blocks the list of calculated textBlocks to save to the database\n+     * @param exerciseId the exercise the automatic feedback suggestions were calculated for\n+     */\n+    @Transactional", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b81a76378d0898657ac0b861371fd33571b73121"}, "originalPosition": 183}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQwODYwMw==", "bodyText": "We use RestTemplates for all other external connectors. Would this be possible here as well?", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r510408603", "createdAt": "2020-10-22T19:35:36Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/RemoteArtemisServiceConnector.java", "diffHunk": "@@ -123,4 +123,16 @@ static HttpHeaders authenticationHeaderForSecret(String secret) {\n         headers.setBearerAuth(secret);\n         return headers;\n     }\n+\n+    /**\n+     * Helper to generate HttpHeaders for a symmetric secret.\n+     *\n+     * @param secret Authorization secret\n+     * @return HttpHeaders\n+     */\n+    static HttpHeaders authorizationHeaderForSymmetricSecret(String secret) {\n+        HttpHeaders headers = new HttpHeaders();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b81a76378d0898657ac0b861371fd33571b73121"}, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MDc5ODE1", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-515079815", "createdAt": "2020-10-22T20:08:33Z", "commit": {"oid": "b81a76378d0898657ac0b861371fd33571b73121"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDowODozM1rOHmx9QQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDowODozOVrOHmx9eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQyNjQzMw==", "bodyText": "This should be trimmed to the headline length to be consistent with the rest of our docs:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Text Assessment Clustering Service\n          \n          \n            \n            Athene Service\n          \n          \n            \n            ----------------------------------\n          \n          \n            \n            Athene Service\n          \n          \n            \n            --------------", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r510426433", "createdAt": "2020-10-22T20:08:33Z", "author": {"login": "FrankeLukas"}, "path": "docs/dev/setup.rst", "diffHunk": "@@ -342,18 +339,18 @@ Other useful commands:\n -  Stop the client: ``docker-compose stop artemis-client`` (restart via\n    ``docker-compose start artemis-client``)\n \n-Text Assessment Clustering Service\n+Athene Service\n ----------------------------------", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b81a76378d0898657ac0b861371fd33571b73121"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQyNjQ5MA==", "bodyText": "Same here.", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r510426490", "createdAt": "2020-10-22T20:08:39Z", "author": {"login": "FrankeLukas"}, "path": "docs/dev/setup.rst", "diffHunk": "@@ -342,18 +339,18 @@ Other useful commands:\n -  Stop the client: ``docker-compose stop artemis-client`` (restart via\n    ``docker-compose start artemis-client``)\n \n-Text Assessment Clustering Service\n+Athene Service\n ----------------------------------\n \n The semi-automatic text assessment relies on the Athene_ service.\n To enable automatic text assessments, special configuration is required:\n \n-Enable the ``automaticText`` Spring profile:\n+Enable the ``athene`` Spring profile:\n ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b81a76378d0898657ac0b861371fd33571b73121"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa76f4dc5467d32171b6b8150b6f499f192049b6", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/fa76f4dc5467d32171b6b8150b6f499f192049b6", "committedDate": "2020-10-22T20:14:34Z", "message": "Fix rst style issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/88e97c2f2a748b7d50b67f2645fd2afed85b40ac", "committedDate": "2020-10-22T20:15:01Z", "message": "Merge branch 'feature/athene-load-balancer' of https://github.com/ls1intum/Artemis into feature/athene-load-balancer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MDkyMzkw", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-515092390", "createdAt": "2020-10-22T20:26:34Z", "commit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDoyNjozNFrOHmyjQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDoyNjozNFrOHmyjQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQzNjE2MQ==", "bodyText": "we are now using camelCase for those variables.\nWhy is this one protected and not private?", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r510436161", "createdAt": "2020-10-22T20:26:34Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/AtheneService.java", "diffHunk": "@@ -0,0 +1,269 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import static de.tum.in.www1.artemis.config.Constants.ATHENE_RESULT_API_PATH;\n+import static de.tum.in.www1.artemis.service.connectors.RemoteArtemisServiceConnector.authorizationHeaderForSymmetricSecret;\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.Collectors.toMap;\n+\n+import java.util.*;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import de.tum.in.www1.artemis.domain.*;\n+import de.tum.in.www1.artemis.domain.enumeration.Language;\n+import de.tum.in.www1.artemis.exception.NetworkingError;\n+import de.tum.in.www1.artemis.repository.TextBlockRepository;\n+import de.tum.in.www1.artemis.repository.TextClusterRepository;\n+import de.tum.in.www1.artemis.repository.TextExerciseRepository;\n+import de.tum.in.www1.artemis.service.TextAssessmentQueueService;\n+import de.tum.in.www1.artemis.service.TextBlockService;\n+import de.tum.in.www1.artemis.service.TextSubmissionService;\n+import de.tum.in.www1.artemis.web.rest.dto.AtheneDTO;\n+\n+@Service\n+@Profile(\"athene\")\n+public class AtheneService {\n+\n+    private final Logger log = LoggerFactory.getLogger(AtheneService.class);\n+\n+    @Value(\"${server.url}\")\n+    protected String ARTEMIS_SERVER_URL;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MDkyODg3", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-515092887", "createdAt": "2020-10-22T20:27:14Z", "commit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDoyNzoxNFrOHmykhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDoyNzoxNFrOHmykhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQzNjQ4Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private String API_ENDPOINT;\n          \n          \n            \n                private String submitApiEndpoint;", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r510436487", "createdAt": "2020-10-22T20:27:14Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/AtheneService.java", "diffHunk": "@@ -0,0 +1,269 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import static de.tum.in.www1.artemis.config.Constants.ATHENE_RESULT_API_PATH;\n+import static de.tum.in.www1.artemis.service.connectors.RemoteArtemisServiceConnector.authorizationHeaderForSymmetricSecret;\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.Collectors.toMap;\n+\n+import java.util.*;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import de.tum.in.www1.artemis.domain.*;\n+import de.tum.in.www1.artemis.domain.enumeration.Language;\n+import de.tum.in.www1.artemis.exception.NetworkingError;\n+import de.tum.in.www1.artemis.repository.TextBlockRepository;\n+import de.tum.in.www1.artemis.repository.TextClusterRepository;\n+import de.tum.in.www1.artemis.repository.TextExerciseRepository;\n+import de.tum.in.www1.artemis.service.TextAssessmentQueueService;\n+import de.tum.in.www1.artemis.service.TextBlockService;\n+import de.tum.in.www1.artemis.service.TextSubmissionService;\n+import de.tum.in.www1.artemis.web.rest.dto.AtheneDTO;\n+\n+@Service\n+@Profile(\"athene\")\n+public class AtheneService {\n+\n+    private final Logger log = LoggerFactory.getLogger(AtheneService.class);\n+\n+    @Value(\"${server.url}\")\n+    protected String ARTEMIS_SERVER_URL;\n+\n+    @Value(\"${artemis.athene.submit-url}\")\n+    private String API_ENDPOINT;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MDkyOTg0", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-515092984", "createdAt": "2020-10-22T20:27:24Z", "commit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDoyNzoyNFrOHmyk0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDoyNzoyNFrOHmyk0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQzNjU2MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private String API_SECRET;\n          \n          \n            \n                private String apiSecret;", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r510436561", "createdAt": "2020-10-22T20:27:24Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/AtheneService.java", "diffHunk": "@@ -0,0 +1,269 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import static de.tum.in.www1.artemis.config.Constants.ATHENE_RESULT_API_PATH;\n+import static de.tum.in.www1.artemis.service.connectors.RemoteArtemisServiceConnector.authorizationHeaderForSymmetricSecret;\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.Collectors.toMap;\n+\n+import java.util.*;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import de.tum.in.www1.artemis.domain.*;\n+import de.tum.in.www1.artemis.domain.enumeration.Language;\n+import de.tum.in.www1.artemis.exception.NetworkingError;\n+import de.tum.in.www1.artemis.repository.TextBlockRepository;\n+import de.tum.in.www1.artemis.repository.TextClusterRepository;\n+import de.tum.in.www1.artemis.repository.TextExerciseRepository;\n+import de.tum.in.www1.artemis.service.TextAssessmentQueueService;\n+import de.tum.in.www1.artemis.service.TextBlockService;\n+import de.tum.in.www1.artemis.service.TextSubmissionService;\n+import de.tum.in.www1.artemis.web.rest.dto.AtheneDTO;\n+\n+@Service\n+@Profile(\"athene\")\n+public class AtheneService {\n+\n+    private final Logger log = LoggerFactory.getLogger(AtheneService.class);\n+\n+    @Value(\"${server.url}\")\n+    protected String ARTEMIS_SERVER_URL;\n+\n+    @Value(\"${artemis.athene.submit-url}\")\n+    private String API_ENDPOINT;\n+\n+    @Value(\"${artemis.athene.base64-secret}\")\n+    private String API_SECRET;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MDk0MzU5", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-515094359", "createdAt": "2020-10-22T20:29:20Z", "commit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDoyOToyMFrOHmyo3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDoyOToyMFrOHmyo3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQzNzU5OQ==", "bodyText": "this comment is not really helpful. Can you explain why you copy those elements?\nWhy is the method called submissionDTOs if there are no real DTOs involved here?\nI would rather call this method clone or copy", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r510437599", "createdAt": "2020-10-22T20:29:20Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/AtheneService.java", "diffHunk": "@@ -0,0 +1,269 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import static de.tum.in.www1.artemis.config.Constants.ATHENE_RESULT_API_PATH;\n+import static de.tum.in.www1.artemis.service.connectors.RemoteArtemisServiceConnector.authorizationHeaderForSymmetricSecret;\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.Collectors.toMap;\n+\n+import java.util.*;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import de.tum.in.www1.artemis.domain.*;\n+import de.tum.in.www1.artemis.domain.enumeration.Language;\n+import de.tum.in.www1.artemis.exception.NetworkingError;\n+import de.tum.in.www1.artemis.repository.TextBlockRepository;\n+import de.tum.in.www1.artemis.repository.TextClusterRepository;\n+import de.tum.in.www1.artemis.repository.TextExerciseRepository;\n+import de.tum.in.www1.artemis.service.TextAssessmentQueueService;\n+import de.tum.in.www1.artemis.service.TextBlockService;\n+import de.tum.in.www1.artemis.service.TextSubmissionService;\n+import de.tum.in.www1.artemis.web.rest.dto.AtheneDTO;\n+\n+@Service\n+@Profile(\"athene\")\n+public class AtheneService {\n+\n+    private final Logger log = LoggerFactory.getLogger(AtheneService.class);\n+\n+    @Value(\"${server.url}\")\n+    protected String ARTEMIS_SERVER_URL;\n+\n+    @Value(\"${artemis.athene.submit-url}\")\n+    private String API_ENDPOINT;\n+\n+    @Value(\"${artemis.athene.base64-secret}\")\n+    private String API_SECRET;\n+\n+    private final TextAssessmentQueueService textAssessmentQueueService;\n+\n+    private final TextBlockRepository textBlockRepository;\n+\n+    private final TextBlockService textBlockService;\n+\n+    private final TextClusterRepository textClusterRepository;\n+\n+    private final TextExerciseRepository textExerciseRepository;\n+\n+    private final TextSubmissionService textSubmissionService;\n+\n+    private final RemoteArtemisServiceConnector<Request, Response> connector = new RemoteArtemisServiceConnector<>(log, Response.class);\n+\n+    // Contains tasks submitted to Athene and currently processing\n+    private final List<Long> runningAtheneTasks = new ArrayList<>();\n+\n+    public AtheneService(TextSubmissionService textSubmissionService, TextBlockRepository textBlockRepository, TextBlockService textBlockService,\n+            TextClusterRepository textClusterRepository, TextExerciseRepository textExerciseRepository, TextAssessmentQueueService textAssessmentQueueService) {\n+        this.textSubmissionService = textSubmissionService;\n+        this.textBlockRepository = textBlockRepository;\n+        this.textBlockService = textBlockService;\n+        this.textClusterRepository = textClusterRepository;\n+        this.textExerciseRepository = textExerciseRepository;\n+        this.textAssessmentQueueService = textAssessmentQueueService;\n+    }\n+\n+    // region Request/Response DTOs\n+    private static class Request {\n+\n+        public long courseId;\n+\n+        public String callbackUrl;\n+\n+        public List<TextSubmission> submissions;\n+\n+        Request(@NotNull long courseId, @NotNull List<TextSubmission> submissions, @NotNull String callbackUrl) {\n+            this.courseId = courseId;\n+            this.callbackUrl = callbackUrl;\n+            this.submissions = submissionDTOs(submissions);\n+        }\n+\n+        /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "originalPosition": 87}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MDk2MTE0", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-515096114", "createdAt": "2020-10-22T20:32:00Z", "commit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDozMjowMFrOHmyuXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDozMjowMFrOHmyuXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQzOTAwNA==", "bodyText": "do we really need log.info here? And if yes, I would propose to add some additional information, e.g. which exerciseId is involved, how many results are processed, etc. otherwise the log does not really help", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r510439004", "createdAt": "2020-10-22T20:32:00Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/AtheneService.java", "diffHunk": "@@ -0,0 +1,269 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import static de.tum.in.www1.artemis.config.Constants.ATHENE_RESULT_API_PATH;\n+import static de.tum.in.www1.artemis.service.connectors.RemoteArtemisServiceConnector.authorizationHeaderForSymmetricSecret;\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.Collectors.toMap;\n+\n+import java.util.*;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import de.tum.in.www1.artemis.domain.*;\n+import de.tum.in.www1.artemis.domain.enumeration.Language;\n+import de.tum.in.www1.artemis.exception.NetworkingError;\n+import de.tum.in.www1.artemis.repository.TextBlockRepository;\n+import de.tum.in.www1.artemis.repository.TextClusterRepository;\n+import de.tum.in.www1.artemis.repository.TextExerciseRepository;\n+import de.tum.in.www1.artemis.service.TextAssessmentQueueService;\n+import de.tum.in.www1.artemis.service.TextBlockService;\n+import de.tum.in.www1.artemis.service.TextSubmissionService;\n+import de.tum.in.www1.artemis.web.rest.dto.AtheneDTO;\n+\n+@Service\n+@Profile(\"athene\")\n+public class AtheneService {\n+\n+    private final Logger log = LoggerFactory.getLogger(AtheneService.class);\n+\n+    @Value(\"${server.url}\")\n+    protected String ARTEMIS_SERVER_URL;\n+\n+    @Value(\"${artemis.athene.submit-url}\")\n+    private String API_ENDPOINT;\n+\n+    @Value(\"${artemis.athene.base64-secret}\")\n+    private String API_SECRET;\n+\n+    private final TextAssessmentQueueService textAssessmentQueueService;\n+\n+    private final TextBlockRepository textBlockRepository;\n+\n+    private final TextBlockService textBlockService;\n+\n+    private final TextClusterRepository textClusterRepository;\n+\n+    private final TextExerciseRepository textExerciseRepository;\n+\n+    private final TextSubmissionService textSubmissionService;\n+\n+    private final RemoteArtemisServiceConnector<Request, Response> connector = new RemoteArtemisServiceConnector<>(log, Response.class);\n+\n+    // Contains tasks submitted to Athene and currently processing\n+    private final List<Long> runningAtheneTasks = new ArrayList<>();\n+\n+    public AtheneService(TextSubmissionService textSubmissionService, TextBlockRepository textBlockRepository, TextBlockService textBlockService,\n+            TextClusterRepository textClusterRepository, TextExerciseRepository textExerciseRepository, TextAssessmentQueueService textAssessmentQueueService) {\n+        this.textSubmissionService = textSubmissionService;\n+        this.textBlockRepository = textBlockRepository;\n+        this.textBlockService = textBlockService;\n+        this.textClusterRepository = textClusterRepository;\n+        this.textExerciseRepository = textExerciseRepository;\n+        this.textAssessmentQueueService = textAssessmentQueueService;\n+    }\n+\n+    // region Request/Response DTOs\n+    private static class Request {\n+\n+        public long courseId;\n+\n+        public String callbackUrl;\n+\n+        public List<TextSubmission> submissions;\n+\n+        Request(@NotNull long courseId, @NotNull List<TextSubmission> submissions, @NotNull String callbackUrl) {\n+            this.courseId = courseId;\n+            this.callbackUrl = callbackUrl;\n+            this.submissions = submissionDTOs(submissions);\n+        }\n+\n+        /**\n+         * Create new TextSubmission as DTO.\n+         */\n+        @NotNull\n+        private static List<TextSubmission> submissionDTOs(@NotNull List<TextSubmission> submissions) {\n+            return submissions.stream().map(textSubmission -> {\n+                final TextSubmission submission = new TextSubmission();\n+                submission.setText(textSubmission.getText());\n+                submission.setId(textSubmission.getId());\n+                return submission;\n+            }).collect(toList());\n+        }\n+    }\n+\n+    private static class Response {\n+\n+        public String detail;\n+\n+    }\n+    // endregion\n+\n+    /**\n+     * Register an Athene task for an exercise as running\n+     * @param exerciseId the exerciseId which the Athene task is running for\n+     */\n+    public void startTask(Long exerciseId) {\n+        runningAtheneTasks.add(exerciseId);\n+    }\n+\n+    /**\n+     * Delete an Athene task for an exercise from the running tasks\n+     * @param exerciseId the exerciseId which the Athene task finished for\n+     */\n+    public void finishTask(Long exerciseId) {\n+        runningAtheneTasks.remove(exerciseId);\n+    }\n+\n+    /**\n+     * Check whether an Athene task is running for the given exerciseId\n+     * @param exerciseId the exerciseId to check for a running Athene task\n+     * @return true, if a task for the given exerciseId is running\n+     */\n+    public boolean isTaskRunning(Long exerciseId) {\n+        return runningAtheneTasks.contains(exerciseId);\n+    }\n+\n+    /**\n+     * Calls the remote Athene service to submit a Job for calculating automatic feedback\n+     * @param exercise the exercise the automatic assessments should be calculated for\n+     */\n+    public void submitJob(TextExercise exercise) {\n+        submitJob(exercise, 1);\n+    }\n+\n+    /**\n+     * Calls the remote Athene service to submit a Job for calculating automatic feedback\n+     * Falls back to naive splitting for less than 10 submissions\n+     * Note: See `TextSubmissionService:getTextSubmissionsByExerciseId` for selection of Submissions.\n+     * @param exercise the exercise the automatic assessments should be calculated for\n+     * @param maxRetries number of retries before the request will be canceled\n+     */\n+    public void submitJob(TextExercise exercise, int maxRetries) {\n+        log.debug(\"Start Athene Service for Text Exercise \\\"\" + exercise.getTitle() + \"\\\" (#\" + exercise.getId() + \").\");\n+\n+        // Find all submissions for Exercise\n+        List<TextSubmission> textSubmissions = textSubmissionService.getTextSubmissionsByExerciseId(exercise.getId(), true, false);\n+\n+        // We only support english languages so far, to prevent corruption of the clustering\n+        textSubmissions.removeIf(textSubmission -> textSubmission.getLanguage() != Language.ENGLISH);\n+\n+        // Athene only works with 10 or more submissions\n+        if (textSubmissions.size() >= 10) {\n+\n+            log.info(\"Calling Remote Service to calculate automatic feedback for \" + textSubmissions.size() + \" submissions.\");\n+\n+            try {\n+                final Request request = new Request(exercise.getId(), textSubmissions, ARTEMIS_SERVER_URL + ATHENE_RESULT_API_PATH + exercise.getId());\n+                Response response = connector.invokeWithRetry(API_ENDPOINT, request, authorizationHeaderForSymmetricSecret(API_SECRET), maxRetries);\n+                log.info(\"Remote Service to calculate automatic feedback responded: \" + response.detail);\n+\n+                // Register task for exercise as running, AtheneResource calls finishTask on result receive\n+                startTask(exercise.getId());\n+            }\n+            catch (NetworkingError networkingError) {\n+                log.error(\"Error while calling Remote Service\", networkingError);\n+            }\n+\n+        }\n+    }\n+\n+    /**\n+     * Processes results coming back from the Athene system via callbackUrl (see AtheneResource)\n+     * @param clusters the Map of calculated clusters to save to the database\n+     * @param blocks the list of calculated textBlocks to save to the database\n+     * @param exerciseId the exercise the automatic feedback suggestions were calculated for\n+     */\n+    @Transactional\n+    public void processResult(Map<Integer, TextCluster> clusters, List<AtheneDTO.TextBlock> blocks, Long exerciseId) {\n+        log.info(\"Start processing incoming Athene results\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "originalPosition": 185}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MDk2MzQ2", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-515096346", "createdAt": "2020-10-22T20:32:22Z", "commit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDozMjoyM1rOHmyvEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDozMjoyM1rOHmyvEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQzOTE4Nw==", "bodyText": "do we really need log.info here? And if yes, I would propose to add some additional information, e.g. which exerciseId is involved, how many results are processed, etc. otherwise the log does not really help", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r510439187", "createdAt": "2020-10-22T20:32:23Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/AtheneService.java", "diffHunk": "@@ -0,0 +1,269 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import static de.tum.in.www1.artemis.config.Constants.ATHENE_RESULT_API_PATH;\n+import static de.tum.in.www1.artemis.service.connectors.RemoteArtemisServiceConnector.authorizationHeaderForSymmetricSecret;\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.Collectors.toMap;\n+\n+import java.util.*;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import de.tum.in.www1.artemis.domain.*;\n+import de.tum.in.www1.artemis.domain.enumeration.Language;\n+import de.tum.in.www1.artemis.exception.NetworkingError;\n+import de.tum.in.www1.artemis.repository.TextBlockRepository;\n+import de.tum.in.www1.artemis.repository.TextClusterRepository;\n+import de.tum.in.www1.artemis.repository.TextExerciseRepository;\n+import de.tum.in.www1.artemis.service.TextAssessmentQueueService;\n+import de.tum.in.www1.artemis.service.TextBlockService;\n+import de.tum.in.www1.artemis.service.TextSubmissionService;\n+import de.tum.in.www1.artemis.web.rest.dto.AtheneDTO;\n+\n+@Service\n+@Profile(\"athene\")\n+public class AtheneService {\n+\n+    private final Logger log = LoggerFactory.getLogger(AtheneService.class);\n+\n+    @Value(\"${server.url}\")\n+    protected String ARTEMIS_SERVER_URL;\n+\n+    @Value(\"${artemis.athene.submit-url}\")\n+    private String API_ENDPOINT;\n+\n+    @Value(\"${artemis.athene.base64-secret}\")\n+    private String API_SECRET;\n+\n+    private final TextAssessmentQueueService textAssessmentQueueService;\n+\n+    private final TextBlockRepository textBlockRepository;\n+\n+    private final TextBlockService textBlockService;\n+\n+    private final TextClusterRepository textClusterRepository;\n+\n+    private final TextExerciseRepository textExerciseRepository;\n+\n+    private final TextSubmissionService textSubmissionService;\n+\n+    private final RemoteArtemisServiceConnector<Request, Response> connector = new RemoteArtemisServiceConnector<>(log, Response.class);\n+\n+    // Contains tasks submitted to Athene and currently processing\n+    private final List<Long> runningAtheneTasks = new ArrayList<>();\n+\n+    public AtheneService(TextSubmissionService textSubmissionService, TextBlockRepository textBlockRepository, TextBlockService textBlockService,\n+            TextClusterRepository textClusterRepository, TextExerciseRepository textExerciseRepository, TextAssessmentQueueService textAssessmentQueueService) {\n+        this.textSubmissionService = textSubmissionService;\n+        this.textBlockRepository = textBlockRepository;\n+        this.textBlockService = textBlockService;\n+        this.textClusterRepository = textClusterRepository;\n+        this.textExerciseRepository = textExerciseRepository;\n+        this.textAssessmentQueueService = textAssessmentQueueService;\n+    }\n+\n+    // region Request/Response DTOs\n+    private static class Request {\n+\n+        public long courseId;\n+\n+        public String callbackUrl;\n+\n+        public List<TextSubmission> submissions;\n+\n+        Request(@NotNull long courseId, @NotNull List<TextSubmission> submissions, @NotNull String callbackUrl) {\n+            this.courseId = courseId;\n+            this.callbackUrl = callbackUrl;\n+            this.submissions = submissionDTOs(submissions);\n+        }\n+\n+        /**\n+         * Create new TextSubmission as DTO.\n+         */\n+        @NotNull\n+        private static List<TextSubmission> submissionDTOs(@NotNull List<TextSubmission> submissions) {\n+            return submissions.stream().map(textSubmission -> {\n+                final TextSubmission submission = new TextSubmission();\n+                submission.setText(textSubmission.getText());\n+                submission.setId(textSubmission.getId());\n+                return submission;\n+            }).collect(toList());\n+        }\n+    }\n+\n+    private static class Response {\n+\n+        public String detail;\n+\n+    }\n+    // endregion\n+\n+    /**\n+     * Register an Athene task for an exercise as running\n+     * @param exerciseId the exerciseId which the Athene task is running for\n+     */\n+    public void startTask(Long exerciseId) {\n+        runningAtheneTasks.add(exerciseId);\n+    }\n+\n+    /**\n+     * Delete an Athene task for an exercise from the running tasks\n+     * @param exerciseId the exerciseId which the Athene task finished for\n+     */\n+    public void finishTask(Long exerciseId) {\n+        runningAtheneTasks.remove(exerciseId);\n+    }\n+\n+    /**\n+     * Check whether an Athene task is running for the given exerciseId\n+     * @param exerciseId the exerciseId to check for a running Athene task\n+     * @return true, if a task for the given exerciseId is running\n+     */\n+    public boolean isTaskRunning(Long exerciseId) {\n+        return runningAtheneTasks.contains(exerciseId);\n+    }\n+\n+    /**\n+     * Calls the remote Athene service to submit a Job for calculating automatic feedback\n+     * @param exercise the exercise the automatic assessments should be calculated for\n+     */\n+    public void submitJob(TextExercise exercise) {\n+        submitJob(exercise, 1);\n+    }\n+\n+    /**\n+     * Calls the remote Athene service to submit a Job for calculating automatic feedback\n+     * Falls back to naive splitting for less than 10 submissions\n+     * Note: See `TextSubmissionService:getTextSubmissionsByExerciseId` for selection of Submissions.\n+     * @param exercise the exercise the automatic assessments should be calculated for\n+     * @param maxRetries number of retries before the request will be canceled\n+     */\n+    public void submitJob(TextExercise exercise, int maxRetries) {\n+        log.debug(\"Start Athene Service for Text Exercise \\\"\" + exercise.getTitle() + \"\\\" (#\" + exercise.getId() + \").\");\n+\n+        // Find all submissions for Exercise\n+        List<TextSubmission> textSubmissions = textSubmissionService.getTextSubmissionsByExerciseId(exercise.getId(), true, false);\n+\n+        // We only support english languages so far, to prevent corruption of the clustering\n+        textSubmissions.removeIf(textSubmission -> textSubmission.getLanguage() != Language.ENGLISH);\n+\n+        // Athene only works with 10 or more submissions\n+        if (textSubmissions.size() >= 10) {\n+\n+            log.info(\"Calling Remote Service to calculate automatic feedback for \" + textSubmissions.size() + \" submissions.\");\n+\n+            try {\n+                final Request request = new Request(exercise.getId(), textSubmissions, ARTEMIS_SERVER_URL + ATHENE_RESULT_API_PATH + exercise.getId());\n+                Response response = connector.invokeWithRetry(API_ENDPOINT, request, authorizationHeaderForSymmetricSecret(API_SECRET), maxRetries);\n+                log.info(\"Remote Service to calculate automatic feedback responded: \" + response.detail);\n+\n+                // Register task for exercise as running, AtheneResource calls finishTask on result receive\n+                startTask(exercise.getId());\n+            }\n+            catch (NetworkingError networkingError) {\n+                log.error(\"Error while calling Remote Service\", networkingError);\n+            }\n+\n+        }\n+    }\n+\n+    /**\n+     * Processes results coming back from the Athene system via callbackUrl (see AtheneResource)\n+     * @param clusters the Map of calculated clusters to save to the database\n+     * @param blocks the list of calculated textBlocks to save to the database\n+     * @param exerciseId the exercise the automatic feedback suggestions were calculated for\n+     */\n+    @Transactional\n+    public void processResult(Map<Integer, TextCluster> clusters, List<AtheneDTO.TextBlock> blocks, Long exerciseId) {\n+        log.info(\"Start processing incoming Athene results\");\n+\n+        // Parse textBlocks (blocks will come as AtheneDTO.TextBlock with their submissionId and need to be parsed)\n+        List<TextBlock> textBlocks = parseTextBlocks(blocks, exerciseId);\n+\n+        // Save textBlocks in Database\n+        final Map<String, TextBlock> textBlockMap;\n+        textBlockMap = textBlockRepository.saveAll(textBlocks).stream().collect(toMap(TextBlock::getId, block -> block));\n+\n+        // Save clusters in Database\n+        processClusters(clusters, textBlockMap, exerciseId);\n+\n+        // Notify atheneService of finished task\n+        finishTask(exerciseId);\n+\n+        log.info(\"Finished processing incoming Athene results\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "originalPosition": 200}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MDk3NTA3", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-515097507", "createdAt": "2020-10-22T20:34:01Z", "commit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDozNDowMVrOHmyyWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDozNDowMVrOHmyyWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0MDAyNA==", "bodyText": "please call the object in AtheneDTO TextBlockDTO to avoid confusion here", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r510440024", "createdAt": "2020-10-22T20:34:01Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/AtheneService.java", "diffHunk": "@@ -0,0 +1,269 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import static de.tum.in.www1.artemis.config.Constants.ATHENE_RESULT_API_PATH;\n+import static de.tum.in.www1.artemis.service.connectors.RemoteArtemisServiceConnector.authorizationHeaderForSymmetricSecret;\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.Collectors.toMap;\n+\n+import java.util.*;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import de.tum.in.www1.artemis.domain.*;\n+import de.tum.in.www1.artemis.domain.enumeration.Language;\n+import de.tum.in.www1.artemis.exception.NetworkingError;\n+import de.tum.in.www1.artemis.repository.TextBlockRepository;\n+import de.tum.in.www1.artemis.repository.TextClusterRepository;\n+import de.tum.in.www1.artemis.repository.TextExerciseRepository;\n+import de.tum.in.www1.artemis.service.TextAssessmentQueueService;\n+import de.tum.in.www1.artemis.service.TextBlockService;\n+import de.tum.in.www1.artemis.service.TextSubmissionService;\n+import de.tum.in.www1.artemis.web.rest.dto.AtheneDTO;\n+\n+@Service\n+@Profile(\"athene\")\n+public class AtheneService {\n+\n+    private final Logger log = LoggerFactory.getLogger(AtheneService.class);\n+\n+    @Value(\"${server.url}\")\n+    protected String ARTEMIS_SERVER_URL;\n+\n+    @Value(\"${artemis.athene.submit-url}\")\n+    private String API_ENDPOINT;\n+\n+    @Value(\"${artemis.athene.base64-secret}\")\n+    private String API_SECRET;\n+\n+    private final TextAssessmentQueueService textAssessmentQueueService;\n+\n+    private final TextBlockRepository textBlockRepository;\n+\n+    private final TextBlockService textBlockService;\n+\n+    private final TextClusterRepository textClusterRepository;\n+\n+    private final TextExerciseRepository textExerciseRepository;\n+\n+    private final TextSubmissionService textSubmissionService;\n+\n+    private final RemoteArtemisServiceConnector<Request, Response> connector = new RemoteArtemisServiceConnector<>(log, Response.class);\n+\n+    // Contains tasks submitted to Athene and currently processing\n+    private final List<Long> runningAtheneTasks = new ArrayList<>();\n+\n+    public AtheneService(TextSubmissionService textSubmissionService, TextBlockRepository textBlockRepository, TextBlockService textBlockService,\n+            TextClusterRepository textClusterRepository, TextExerciseRepository textExerciseRepository, TextAssessmentQueueService textAssessmentQueueService) {\n+        this.textSubmissionService = textSubmissionService;\n+        this.textBlockRepository = textBlockRepository;\n+        this.textBlockService = textBlockService;\n+        this.textClusterRepository = textClusterRepository;\n+        this.textExerciseRepository = textExerciseRepository;\n+        this.textAssessmentQueueService = textAssessmentQueueService;\n+    }\n+\n+    // region Request/Response DTOs\n+    private static class Request {\n+\n+        public long courseId;\n+\n+        public String callbackUrl;\n+\n+        public List<TextSubmission> submissions;\n+\n+        Request(@NotNull long courseId, @NotNull List<TextSubmission> submissions, @NotNull String callbackUrl) {\n+            this.courseId = courseId;\n+            this.callbackUrl = callbackUrl;\n+            this.submissions = submissionDTOs(submissions);\n+        }\n+\n+        /**\n+         * Create new TextSubmission as DTO.\n+         */\n+        @NotNull\n+        private static List<TextSubmission> submissionDTOs(@NotNull List<TextSubmission> submissions) {\n+            return submissions.stream().map(textSubmission -> {\n+                final TextSubmission submission = new TextSubmission();\n+                submission.setText(textSubmission.getText());\n+                submission.setId(textSubmission.getId());\n+                return submission;\n+            }).collect(toList());\n+        }\n+    }\n+\n+    private static class Response {\n+\n+        public String detail;\n+\n+    }\n+    // endregion\n+\n+    /**\n+     * Register an Athene task for an exercise as running\n+     * @param exerciseId the exerciseId which the Athene task is running for\n+     */\n+    public void startTask(Long exerciseId) {\n+        runningAtheneTasks.add(exerciseId);\n+    }\n+\n+    /**\n+     * Delete an Athene task for an exercise from the running tasks\n+     * @param exerciseId the exerciseId which the Athene task finished for\n+     */\n+    public void finishTask(Long exerciseId) {\n+        runningAtheneTasks.remove(exerciseId);\n+    }\n+\n+    /**\n+     * Check whether an Athene task is running for the given exerciseId\n+     * @param exerciseId the exerciseId to check for a running Athene task\n+     * @return true, if a task for the given exerciseId is running\n+     */\n+    public boolean isTaskRunning(Long exerciseId) {\n+        return runningAtheneTasks.contains(exerciseId);\n+    }\n+\n+    /**\n+     * Calls the remote Athene service to submit a Job for calculating automatic feedback\n+     * @param exercise the exercise the automatic assessments should be calculated for\n+     */\n+    public void submitJob(TextExercise exercise) {\n+        submitJob(exercise, 1);\n+    }\n+\n+    /**\n+     * Calls the remote Athene service to submit a Job for calculating automatic feedback\n+     * Falls back to naive splitting for less than 10 submissions\n+     * Note: See `TextSubmissionService:getTextSubmissionsByExerciseId` for selection of Submissions.\n+     * @param exercise the exercise the automatic assessments should be calculated for\n+     * @param maxRetries number of retries before the request will be canceled\n+     */\n+    public void submitJob(TextExercise exercise, int maxRetries) {\n+        log.debug(\"Start Athene Service for Text Exercise \\\"\" + exercise.getTitle() + \"\\\" (#\" + exercise.getId() + \").\");\n+\n+        // Find all submissions for Exercise\n+        List<TextSubmission> textSubmissions = textSubmissionService.getTextSubmissionsByExerciseId(exercise.getId(), true, false);\n+\n+        // We only support english languages so far, to prevent corruption of the clustering\n+        textSubmissions.removeIf(textSubmission -> textSubmission.getLanguage() != Language.ENGLISH);\n+\n+        // Athene only works with 10 or more submissions\n+        if (textSubmissions.size() >= 10) {\n+\n+            log.info(\"Calling Remote Service to calculate automatic feedback for \" + textSubmissions.size() + \" submissions.\");\n+\n+            try {\n+                final Request request = new Request(exercise.getId(), textSubmissions, ARTEMIS_SERVER_URL + ATHENE_RESULT_API_PATH + exercise.getId());\n+                Response response = connector.invokeWithRetry(API_ENDPOINT, request, authorizationHeaderForSymmetricSecret(API_SECRET), maxRetries);\n+                log.info(\"Remote Service to calculate automatic feedback responded: \" + response.detail);\n+\n+                // Register task for exercise as running, AtheneResource calls finishTask on result receive\n+                startTask(exercise.getId());\n+            }\n+            catch (NetworkingError networkingError) {\n+                log.error(\"Error while calling Remote Service\", networkingError);\n+            }\n+\n+        }\n+    }\n+\n+    /**\n+     * Processes results coming back from the Athene system via callbackUrl (see AtheneResource)\n+     * @param clusters the Map of calculated clusters to save to the database\n+     * @param blocks the list of calculated textBlocks to save to the database\n+     * @param exerciseId the exercise the automatic feedback suggestions were calculated for\n+     */\n+    @Transactional\n+    public void processResult(Map<Integer, TextCluster> clusters, List<AtheneDTO.TextBlock> blocks, Long exerciseId) {\n+        log.info(\"Start processing incoming Athene results\");\n+\n+        // Parse textBlocks (blocks will come as AtheneDTO.TextBlock with their submissionId and need to be parsed)\n+        List<TextBlock> textBlocks = parseTextBlocks(blocks, exerciseId);\n+\n+        // Save textBlocks in Database\n+        final Map<String, TextBlock> textBlockMap;\n+        textBlockMap = textBlockRepository.saveAll(textBlocks).stream().collect(toMap(TextBlock::getId, block -> block));\n+\n+        // Save clusters in Database\n+        processClusters(clusters, textBlockMap, exerciseId);\n+\n+        // Notify atheneService of finished task\n+        finishTask(exerciseId);\n+\n+        log.info(\"Finished processing incoming Athene results\");\n+    }\n+\n+    /**\n+     * Parse text blocks of type AtheneDTO.TextBlock to TextBlocks linked to their submission\n+     *\n+     * @param blocks The list of AtheneDTO-blocks to parse\n+     * @param exerciseId The exerciseId of the exercise the blocks belong to\n+     * @return list of TextBlocks\n+     */\n+    public List<TextBlock> parseTextBlocks(List<AtheneDTO.TextBlock> blocks, Long exerciseId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "originalPosition": 210}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MDk3NzI4", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-515097728", "createdAt": "2020-10-22T20:34:19Z", "commit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDozNDoyMFrOHmyzGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDozNDoyMFrOHmyzGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0MDIxNg==", "bodyText": "t is not a good variable name", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r510440216", "createdAt": "2020-10-22T20:34:20Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/AtheneService.java", "diffHunk": "@@ -0,0 +1,269 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import static de.tum.in.www1.artemis.config.Constants.ATHENE_RESULT_API_PATH;\n+import static de.tum.in.www1.artemis.service.connectors.RemoteArtemisServiceConnector.authorizationHeaderForSymmetricSecret;\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.Collectors.toMap;\n+\n+import java.util.*;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import de.tum.in.www1.artemis.domain.*;\n+import de.tum.in.www1.artemis.domain.enumeration.Language;\n+import de.tum.in.www1.artemis.exception.NetworkingError;\n+import de.tum.in.www1.artemis.repository.TextBlockRepository;\n+import de.tum.in.www1.artemis.repository.TextClusterRepository;\n+import de.tum.in.www1.artemis.repository.TextExerciseRepository;\n+import de.tum.in.www1.artemis.service.TextAssessmentQueueService;\n+import de.tum.in.www1.artemis.service.TextBlockService;\n+import de.tum.in.www1.artemis.service.TextSubmissionService;\n+import de.tum.in.www1.artemis.web.rest.dto.AtheneDTO;\n+\n+@Service\n+@Profile(\"athene\")\n+public class AtheneService {\n+\n+    private final Logger log = LoggerFactory.getLogger(AtheneService.class);\n+\n+    @Value(\"${server.url}\")\n+    protected String ARTEMIS_SERVER_URL;\n+\n+    @Value(\"${artemis.athene.submit-url}\")\n+    private String API_ENDPOINT;\n+\n+    @Value(\"${artemis.athene.base64-secret}\")\n+    private String API_SECRET;\n+\n+    private final TextAssessmentQueueService textAssessmentQueueService;\n+\n+    private final TextBlockRepository textBlockRepository;\n+\n+    private final TextBlockService textBlockService;\n+\n+    private final TextClusterRepository textClusterRepository;\n+\n+    private final TextExerciseRepository textExerciseRepository;\n+\n+    private final TextSubmissionService textSubmissionService;\n+\n+    private final RemoteArtemisServiceConnector<Request, Response> connector = new RemoteArtemisServiceConnector<>(log, Response.class);\n+\n+    // Contains tasks submitted to Athene and currently processing\n+    private final List<Long> runningAtheneTasks = new ArrayList<>();\n+\n+    public AtheneService(TextSubmissionService textSubmissionService, TextBlockRepository textBlockRepository, TextBlockService textBlockService,\n+            TextClusterRepository textClusterRepository, TextExerciseRepository textExerciseRepository, TextAssessmentQueueService textAssessmentQueueService) {\n+        this.textSubmissionService = textSubmissionService;\n+        this.textBlockRepository = textBlockRepository;\n+        this.textBlockService = textBlockService;\n+        this.textClusterRepository = textClusterRepository;\n+        this.textExerciseRepository = textExerciseRepository;\n+        this.textAssessmentQueueService = textAssessmentQueueService;\n+    }\n+\n+    // region Request/Response DTOs\n+    private static class Request {\n+\n+        public long courseId;\n+\n+        public String callbackUrl;\n+\n+        public List<TextSubmission> submissions;\n+\n+        Request(@NotNull long courseId, @NotNull List<TextSubmission> submissions, @NotNull String callbackUrl) {\n+            this.courseId = courseId;\n+            this.callbackUrl = callbackUrl;\n+            this.submissions = submissionDTOs(submissions);\n+        }\n+\n+        /**\n+         * Create new TextSubmission as DTO.\n+         */\n+        @NotNull\n+        private static List<TextSubmission> submissionDTOs(@NotNull List<TextSubmission> submissions) {\n+            return submissions.stream().map(textSubmission -> {\n+                final TextSubmission submission = new TextSubmission();\n+                submission.setText(textSubmission.getText());\n+                submission.setId(textSubmission.getId());\n+                return submission;\n+            }).collect(toList());\n+        }\n+    }\n+\n+    private static class Response {\n+\n+        public String detail;\n+\n+    }\n+    // endregion\n+\n+    /**\n+     * Register an Athene task for an exercise as running\n+     * @param exerciseId the exerciseId which the Athene task is running for\n+     */\n+    public void startTask(Long exerciseId) {\n+        runningAtheneTasks.add(exerciseId);\n+    }\n+\n+    /**\n+     * Delete an Athene task for an exercise from the running tasks\n+     * @param exerciseId the exerciseId which the Athene task finished for\n+     */\n+    public void finishTask(Long exerciseId) {\n+        runningAtheneTasks.remove(exerciseId);\n+    }\n+\n+    /**\n+     * Check whether an Athene task is running for the given exerciseId\n+     * @param exerciseId the exerciseId to check for a running Athene task\n+     * @return true, if a task for the given exerciseId is running\n+     */\n+    public boolean isTaskRunning(Long exerciseId) {\n+        return runningAtheneTasks.contains(exerciseId);\n+    }\n+\n+    /**\n+     * Calls the remote Athene service to submit a Job for calculating automatic feedback\n+     * @param exercise the exercise the automatic assessments should be calculated for\n+     */\n+    public void submitJob(TextExercise exercise) {\n+        submitJob(exercise, 1);\n+    }\n+\n+    /**\n+     * Calls the remote Athene service to submit a Job for calculating automatic feedback\n+     * Falls back to naive splitting for less than 10 submissions\n+     * Note: See `TextSubmissionService:getTextSubmissionsByExerciseId` for selection of Submissions.\n+     * @param exercise the exercise the automatic assessments should be calculated for\n+     * @param maxRetries number of retries before the request will be canceled\n+     */\n+    public void submitJob(TextExercise exercise, int maxRetries) {\n+        log.debug(\"Start Athene Service for Text Exercise \\\"\" + exercise.getTitle() + \"\\\" (#\" + exercise.getId() + \").\");\n+\n+        // Find all submissions for Exercise\n+        List<TextSubmission> textSubmissions = textSubmissionService.getTextSubmissionsByExerciseId(exercise.getId(), true, false);\n+\n+        // We only support english languages so far, to prevent corruption of the clustering\n+        textSubmissions.removeIf(textSubmission -> textSubmission.getLanguage() != Language.ENGLISH);\n+\n+        // Athene only works with 10 or more submissions\n+        if (textSubmissions.size() >= 10) {\n+\n+            log.info(\"Calling Remote Service to calculate automatic feedback for \" + textSubmissions.size() + \" submissions.\");\n+\n+            try {\n+                final Request request = new Request(exercise.getId(), textSubmissions, ARTEMIS_SERVER_URL + ATHENE_RESULT_API_PATH + exercise.getId());\n+                Response response = connector.invokeWithRetry(API_ENDPOINT, request, authorizationHeaderForSymmetricSecret(API_SECRET), maxRetries);\n+                log.info(\"Remote Service to calculate automatic feedback responded: \" + response.detail);\n+\n+                // Register task for exercise as running, AtheneResource calls finishTask on result receive\n+                startTask(exercise.getId());\n+            }\n+            catch (NetworkingError networkingError) {\n+                log.error(\"Error while calling Remote Service\", networkingError);\n+            }\n+\n+        }\n+    }\n+\n+    /**\n+     * Processes results coming back from the Athene system via callbackUrl (see AtheneResource)\n+     * @param clusters the Map of calculated clusters to save to the database\n+     * @param blocks the list of calculated textBlocks to save to the database\n+     * @param exerciseId the exercise the automatic feedback suggestions were calculated for\n+     */\n+    @Transactional\n+    public void processResult(Map<Integer, TextCluster> clusters, List<AtheneDTO.TextBlock> blocks, Long exerciseId) {\n+        log.info(\"Start processing incoming Athene results\");\n+\n+        // Parse textBlocks (blocks will come as AtheneDTO.TextBlock with their submissionId and need to be parsed)\n+        List<TextBlock> textBlocks = parseTextBlocks(blocks, exerciseId);\n+\n+        // Save textBlocks in Database\n+        final Map<String, TextBlock> textBlockMap;\n+        textBlockMap = textBlockRepository.saveAll(textBlocks).stream().collect(toMap(TextBlock::getId, block -> block));\n+\n+        // Save clusters in Database\n+        processClusters(clusters, textBlockMap, exerciseId);\n+\n+        // Notify atheneService of finished task\n+        finishTask(exerciseId);\n+\n+        log.info(\"Finished processing incoming Athene results\");\n+    }\n+\n+    /**\n+     * Parse text blocks of type AtheneDTO.TextBlock to TextBlocks linked to their submission\n+     *\n+     * @param blocks The list of AtheneDTO-blocks to parse\n+     * @param exerciseId The exerciseId of the exercise the blocks belong to\n+     * @return list of TextBlocks\n+     */\n+    public List<TextBlock> parseTextBlocks(List<AtheneDTO.TextBlock> blocks, Long exerciseId) {\n+        // Create submissionsMap for lookup\n+        List<TextSubmission> submissions = textSubmissionService.getTextSubmissionsByExerciseId(exerciseId, true, false);\n+        Map<Long, TextSubmission> submissionsMap = submissions.stream().collect(toMap(/* Key: */ Submission::getId, /* Value: */ submission -> submission));\n+\n+        // Map textBlocks to submissions\n+        List<TextBlock> textBlocks = new LinkedList();\n+        for (AtheneDTO.TextBlock t : blocks) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "originalPosition": 217}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MDk4MTEw", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-515098110", "createdAt": "2020-10-22T20:34:55Z", "commit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDozNDo1NlrOHmy0Ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDozNDo1NlrOHmy0Ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0MDUwNw==", "bodyText": "a bit more documentation would be nice.", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r510440507", "createdAt": "2020-10-22T20:34:56Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/AtheneService.java", "diffHunk": "@@ -0,0 +1,269 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import static de.tum.in.www1.artemis.config.Constants.ATHENE_RESULT_API_PATH;\n+import static de.tum.in.www1.artemis.service.connectors.RemoteArtemisServiceConnector.authorizationHeaderForSymmetricSecret;\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.Collectors.toMap;\n+\n+import java.util.*;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import de.tum.in.www1.artemis.domain.*;\n+import de.tum.in.www1.artemis.domain.enumeration.Language;\n+import de.tum.in.www1.artemis.exception.NetworkingError;\n+import de.tum.in.www1.artemis.repository.TextBlockRepository;\n+import de.tum.in.www1.artemis.repository.TextClusterRepository;\n+import de.tum.in.www1.artemis.repository.TextExerciseRepository;\n+import de.tum.in.www1.artemis.service.TextAssessmentQueueService;\n+import de.tum.in.www1.artemis.service.TextBlockService;\n+import de.tum.in.www1.artemis.service.TextSubmissionService;\n+import de.tum.in.www1.artemis.web.rest.dto.AtheneDTO;\n+\n+@Service\n+@Profile(\"athene\")\n+public class AtheneService {\n+\n+    private final Logger log = LoggerFactory.getLogger(AtheneService.class);\n+\n+    @Value(\"${server.url}\")\n+    protected String ARTEMIS_SERVER_URL;\n+\n+    @Value(\"${artemis.athene.submit-url}\")\n+    private String API_ENDPOINT;\n+\n+    @Value(\"${artemis.athene.base64-secret}\")\n+    private String API_SECRET;\n+\n+    private final TextAssessmentQueueService textAssessmentQueueService;\n+\n+    private final TextBlockRepository textBlockRepository;\n+\n+    private final TextBlockService textBlockService;\n+\n+    private final TextClusterRepository textClusterRepository;\n+\n+    private final TextExerciseRepository textExerciseRepository;\n+\n+    private final TextSubmissionService textSubmissionService;\n+\n+    private final RemoteArtemisServiceConnector<Request, Response> connector = new RemoteArtemisServiceConnector<>(log, Response.class);\n+\n+    // Contains tasks submitted to Athene and currently processing\n+    private final List<Long> runningAtheneTasks = new ArrayList<>();\n+\n+    public AtheneService(TextSubmissionService textSubmissionService, TextBlockRepository textBlockRepository, TextBlockService textBlockService,\n+            TextClusterRepository textClusterRepository, TextExerciseRepository textExerciseRepository, TextAssessmentQueueService textAssessmentQueueService) {\n+        this.textSubmissionService = textSubmissionService;\n+        this.textBlockRepository = textBlockRepository;\n+        this.textBlockService = textBlockService;\n+        this.textClusterRepository = textClusterRepository;\n+        this.textExerciseRepository = textExerciseRepository;\n+        this.textAssessmentQueueService = textAssessmentQueueService;\n+    }\n+\n+    // region Request/Response DTOs\n+    private static class Request {\n+\n+        public long courseId;\n+\n+        public String callbackUrl;\n+\n+        public List<TextSubmission> submissions;\n+\n+        Request(@NotNull long courseId, @NotNull List<TextSubmission> submissions, @NotNull String callbackUrl) {\n+            this.courseId = courseId;\n+            this.callbackUrl = callbackUrl;\n+            this.submissions = submissionDTOs(submissions);\n+        }\n+\n+        /**\n+         * Create new TextSubmission as DTO.\n+         */\n+        @NotNull\n+        private static List<TextSubmission> submissionDTOs(@NotNull List<TextSubmission> submissions) {\n+            return submissions.stream().map(textSubmission -> {\n+                final TextSubmission submission = new TextSubmission();\n+                submission.setText(textSubmission.getText());\n+                submission.setId(textSubmission.getId());\n+                return submission;\n+            }).collect(toList());\n+        }\n+    }\n+\n+    private static class Response {\n+\n+        public String detail;\n+\n+    }\n+    // endregion\n+\n+    /**\n+     * Register an Athene task for an exercise as running\n+     * @param exerciseId the exerciseId which the Athene task is running for\n+     */\n+    public void startTask(Long exerciseId) {\n+        runningAtheneTasks.add(exerciseId);\n+    }\n+\n+    /**\n+     * Delete an Athene task for an exercise from the running tasks\n+     * @param exerciseId the exerciseId which the Athene task finished for\n+     */\n+    public void finishTask(Long exerciseId) {\n+        runningAtheneTasks.remove(exerciseId);\n+    }\n+\n+    /**\n+     * Check whether an Athene task is running for the given exerciseId\n+     * @param exerciseId the exerciseId to check for a running Athene task\n+     * @return true, if a task for the given exerciseId is running\n+     */\n+    public boolean isTaskRunning(Long exerciseId) {\n+        return runningAtheneTasks.contains(exerciseId);\n+    }\n+\n+    /**\n+     * Calls the remote Athene service to submit a Job for calculating automatic feedback\n+     * @param exercise the exercise the automatic assessments should be calculated for\n+     */\n+    public void submitJob(TextExercise exercise) {\n+        submitJob(exercise, 1);\n+    }\n+\n+    /**\n+     * Calls the remote Athene service to submit a Job for calculating automatic feedback\n+     * Falls back to naive splitting for less than 10 submissions\n+     * Note: See `TextSubmissionService:getTextSubmissionsByExerciseId` for selection of Submissions.\n+     * @param exercise the exercise the automatic assessments should be calculated for\n+     * @param maxRetries number of retries before the request will be canceled\n+     */\n+    public void submitJob(TextExercise exercise, int maxRetries) {\n+        log.debug(\"Start Athene Service for Text Exercise \\\"\" + exercise.getTitle() + \"\\\" (#\" + exercise.getId() + \").\");\n+\n+        // Find all submissions for Exercise\n+        List<TextSubmission> textSubmissions = textSubmissionService.getTextSubmissionsByExerciseId(exercise.getId(), true, false);\n+\n+        // We only support english languages so far, to prevent corruption of the clustering\n+        textSubmissions.removeIf(textSubmission -> textSubmission.getLanguage() != Language.ENGLISH);\n+\n+        // Athene only works with 10 or more submissions\n+        if (textSubmissions.size() >= 10) {\n+\n+            log.info(\"Calling Remote Service to calculate automatic feedback for \" + textSubmissions.size() + \" submissions.\");\n+\n+            try {\n+                final Request request = new Request(exercise.getId(), textSubmissions, ARTEMIS_SERVER_URL + ATHENE_RESULT_API_PATH + exercise.getId());\n+                Response response = connector.invokeWithRetry(API_ENDPOINT, request, authorizationHeaderForSymmetricSecret(API_SECRET), maxRetries);\n+                log.info(\"Remote Service to calculate automatic feedback responded: \" + response.detail);\n+\n+                // Register task for exercise as running, AtheneResource calls finishTask on result receive\n+                startTask(exercise.getId());\n+            }\n+            catch (NetworkingError networkingError) {\n+                log.error(\"Error while calling Remote Service\", networkingError);\n+            }\n+\n+        }\n+    }\n+\n+    /**\n+     * Processes results coming back from the Athene system via callbackUrl (see AtheneResource)\n+     * @param clusters the Map of calculated clusters to save to the database\n+     * @param blocks the list of calculated textBlocks to save to the database\n+     * @param exerciseId the exercise the automatic feedback suggestions were calculated for\n+     */\n+    @Transactional\n+    public void processResult(Map<Integer, TextCluster> clusters, List<AtheneDTO.TextBlock> blocks, Long exerciseId) {\n+        log.info(\"Start processing incoming Athene results\");\n+\n+        // Parse textBlocks (blocks will come as AtheneDTO.TextBlock with their submissionId and need to be parsed)\n+        List<TextBlock> textBlocks = parseTextBlocks(blocks, exerciseId);\n+\n+        // Save textBlocks in Database\n+        final Map<String, TextBlock> textBlockMap;\n+        textBlockMap = textBlockRepository.saveAll(textBlocks).stream().collect(toMap(TextBlock::getId, block -> block));\n+\n+        // Save clusters in Database\n+        processClusters(clusters, textBlockMap, exerciseId);\n+\n+        // Notify atheneService of finished task\n+        finishTask(exerciseId);\n+\n+        log.info(\"Finished processing incoming Athene results\");\n+    }\n+\n+    /**\n+     * Parse text blocks of type AtheneDTO.TextBlock to TextBlocks linked to their submission\n+     *\n+     * @param blocks The list of AtheneDTO-blocks to parse\n+     * @param exerciseId The exerciseId of the exercise the blocks belong to\n+     * @return list of TextBlocks\n+     */\n+    public List<TextBlock> parseTextBlocks(List<AtheneDTO.TextBlock> blocks, Long exerciseId) {\n+        // Create submissionsMap for lookup\n+        List<TextSubmission> submissions = textSubmissionService.getTextSubmissionsByExerciseId(exerciseId, true, false);\n+        Map<Long, TextSubmission> submissionsMap = submissions.stream().collect(toMap(/* Key: */ Submission::getId, /* Value: */ submission -> submission));\n+\n+        // Map textBlocks to submissions\n+        List<TextBlock> textBlocks = new LinkedList();\n+        for (AtheneDTO.TextBlock t : blocks) {\n+            // Convert DTO-TextBlock (including the submissionId) to TextBlock Entity\n+            TextBlock newBlock = new TextBlock();\n+            newBlock.setId(t.id);\n+            newBlock.setText(t.text);\n+            newBlock.setStartIndex(t.startIndex);\n+            newBlock.setEndIndex(t.endIndex);\n+            newBlock.automatic();\n+\n+            // take the corresponding TextSubmission and add the text blocks.\n+            // The addBlocks method also sets the submission in the textBlock\n+            submissionsMap.get(t.submissionId).addBlock(newBlock);\n+            textBlocks.add(newBlock);\n+        }\n+\n+        return textBlocks;\n+    }\n+\n+    /**\n+     * Process clusters and save to database", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "originalPosition": 236}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MTAwNTQx", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-515100541", "createdAt": "2020-10-22T20:38:45Z", "commit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDozODo0NVrOHmy7pg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDozODo0NVrOHmy7pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0MjQwNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private String API_SECRET;\n          \n          \n            \n                private String atheneApiSecret;", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r510442406", "createdAt": "2020-10-22T20:38:45Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/web/rest/AtheneResource.java", "diffHunk": "@@ -0,0 +1,67 @@\n+package de.tum.in.www1.artemis.web.rest;\n+\n+import static org.springframework.http.MediaType.APPLICATION_JSON_VALUE;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.web.bind.annotation.*;\n+\n+import de.tum.in.www1.artemis.config.Constants;\n+import de.tum.in.www1.artemis.domain.*;\n+import de.tum.in.www1.artemis.service.connectors.AtheneService;\n+import de.tum.in.www1.artemis.web.rest.dto.AtheneDTO;\n+\n+/**\n+ * REST controller for managing Athene results.\n+ */\n+@RestController\n+@RequestMapping(Constants.ATHENE_RESULT_API_PATH)\n+@Profile(\"athene\")\n+public class AtheneResource {\n+\n+    @Value(\"${artemis.athene.base64-secret}\")\n+    private String API_SECRET;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MTAxMzQx", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-515101341", "createdAt": "2020-10-22T20:39:57Z", "commit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDozOTo1N1rOHmy-FQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDozOTo1N1rOHmy-FQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0MzAyOQ==", "bodyText": "I would turn this around to avoid null pointer exceptions in case auth is null:\nIf (!atheneApiSecret.equals(auth)) {", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r510443029", "createdAt": "2020-10-22T20:39:57Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/web/rest/AtheneResource.java", "diffHunk": "@@ -0,0 +1,67 @@\n+package de.tum.in.www1.artemis.web.rest;\n+\n+import static org.springframework.http.MediaType.APPLICATION_JSON_VALUE;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.web.bind.annotation.*;\n+\n+import de.tum.in.www1.artemis.config.Constants;\n+import de.tum.in.www1.artemis.domain.*;\n+import de.tum.in.www1.artemis.service.connectors.AtheneService;\n+import de.tum.in.www1.artemis.web.rest.dto.AtheneDTO;\n+\n+/**\n+ * REST controller for managing Athene results.\n+ */\n+@RestController\n+@RequestMapping(Constants.ATHENE_RESULT_API_PATH)\n+@Profile(\"athene\")\n+public class AtheneResource {\n+\n+    @Value(\"${artemis.athene.base64-secret}\")\n+    private String API_SECRET;\n+\n+    private final Logger log = LoggerFactory.getLogger(AtheneResource.class);\n+\n+    private final AtheneService atheneService;\n+\n+    public AtheneResource(AtheneService atheneService) {\n+        this.atheneService = atheneService;\n+    }\n+\n+    /**\n+     * Saves automatic textAssessments of Athene\n+     *\n+     * @param exerciseId The exerciseId of the exercise which will be saved\n+     * @param requestBody The calculation results containing blocks and clusters\n+     * @param auth The secret for authorization\n+     * @return 200 Ok if successful or 401 unauthorized if secret is wrong\n+     */\n+    @PostMapping(value = \"/{exerciseId}\", consumes = APPLICATION_JSON_VALUE)\n+    public ResponseEntity<Result> saveAtheneResult(@PathVariable Long exerciseId, @RequestBody AtheneDTO requestBody, @RequestHeader(\"Authorization\") String auth) {\n+        log.debug(\"REST call to inform about new Athene results for exercise: {}\", exerciseId);\n+\n+        // Check Authorization header\n+        if (!auth.equals(API_SECRET)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MTAxOTg5", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-515101989", "createdAt": "2020-10-22T20:40:57Z", "commit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDo0MDo1N1rOHmzAKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDo0MDo1N1rOHmzAKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0MzU2Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static class TextBlock {\n          \n          \n            \n                public static class TextBlockDTO {", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r510443563", "createdAt": "2020-10-22T20:40:57Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/web/rest/dto/AtheneDTO.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package de.tum.in.www1.artemis.web.rest.dto;\n+\n+import java.util.*;\n+\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+\n+import de.tum.in.www1.artemis.domain.TextBlockType;\n+import de.tum.in.www1.artemis.domain.TextCluster;\n+\n+@JsonInclude(JsonInclude.Include.NON_EMPTY)\n+public class AtheneDTO {\n+\n+    public List<TextBlock> blocks = new ArrayList<>();\n+\n+    public Map<Integer, TextCluster> clusters = new LinkedHashMap<>();\n+\n+    // Inner DTO\n+    public static class TextBlock {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MTAyMTMx", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-515102131", "createdAt": "2020-10-22T20:41:11Z", "commit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDo0MToxMVrOHmzAlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDo0MToxMVrOHmzAlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0MzY3MQ==", "bodyText": "please use private attributes and getters and setters here", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r510443671", "createdAt": "2020-10-22T20:41:11Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/web/rest/dto/AtheneDTO.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package de.tum.in.www1.artemis.web.rest.dto;\n+\n+import java.util.*;\n+\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+\n+import de.tum.in.www1.artemis.domain.TextBlockType;\n+import de.tum.in.www1.artemis.domain.TextCluster;\n+\n+@JsonInclude(JsonInclude.Include.NON_EMPTY)\n+public class AtheneDTO {\n+\n+    public List<TextBlock> blocks = new ArrayList<>();\n+\n+    public Map<Integer, TextCluster> clusters = new LinkedHashMap<>();\n+\n+    // Inner DTO\n+    public static class TextBlock {\n+\n+        public String id;\n+\n+        public long submissionId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MTAyMjMy", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-515102232", "createdAt": "2020-10-22T20:41:21Z", "commit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDo0MToyMlrOHmzA6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDo0MToyMlrOHmzA6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0Mzc1NA==", "bodyText": "please use private attributes and getters and setters here", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r510443754", "createdAt": "2020-10-22T20:41:22Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/web/rest/dto/AtheneDTO.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package de.tum.in.www1.artemis.web.rest.dto;\n+\n+import java.util.*;\n+\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+\n+import de.tum.in.www1.artemis.domain.TextBlockType;\n+import de.tum.in.www1.artemis.domain.TextCluster;\n+\n+@JsonInclude(JsonInclude.Include.NON_EMPTY)\n+public class AtheneDTO {\n+\n+    public List<TextBlock> blocks = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MTA0NTY5", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-515104569", "createdAt": "2020-10-22T20:45:01Z", "commit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDo0NTowMlrOHmzIIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDo0NTowMlrOHmzIIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0NTYwMQ==", "bodyText": "why do you mock the repositories and services here? Please work with the actual repositories and services and rather mock the communication with Athene using restTemplates and mockProviders. Have a look at BambooRequestMockProvider\nAlso mocks here have the disadvantage that they significantly increase the test execution time, because the Artemis server needs to be restarted before this test is executed and needs to be restarted again after this test has been executed", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r510445601", "createdAt": "2020-10-22T20:45:02Z", "author": {"login": "krusche"}, "path": "src/test/java/de/tum/in/www1/artemis/service/connectors/AtheneServiceTest.java", "diffHunk": "@@ -0,0 +1,265 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import static org.apache.commons.codec.digest.DigestUtils.sha1Hex;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.*;\n+import static org.mockito.Mockito.*;\n+import static org.springframework.test.web.client.match.MockRestRequestMatchers.method;\n+import static org.springframework.test.web.client.match.MockRestRequestMatchers.requestTo;\n+import static org.springframework.test.web.client.response.MockRestResponseCreators.withSuccess;\n+\n+import java.time.ZonedDateTime;\n+import java.util.*;\n+\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.*;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.HttpMethod;\n+import org.springframework.http.MediaType;\n+import org.springframework.test.util.ReflectionTestUtils;\n+import org.springframework.test.web.client.ExpectedCount;\n+import org.springframework.test.web.client.MockRestServiceServer;\n+import org.springframework.web.client.RestTemplate;\n+\n+import de.tum.in.www1.artemis.AbstractSpringIntegrationBambooBitbucketJiraTest;\n+import de.tum.in.www1.artemis.domain.*;\n+import de.tum.in.www1.artemis.domain.enumeration.Language;\n+import de.tum.in.www1.artemis.repository.*;\n+import de.tum.in.www1.artemis.service.TextAssessmentQueueService;\n+import de.tum.in.www1.artemis.service.TextBlockService;\n+import de.tum.in.www1.artemis.service.TextSubmissionService;\n+import de.tum.in.www1.artemis.util.ModelFactory;\n+import de.tum.in.www1.artemis.web.rest.dto.AtheneDTO;\n+\n+public class AtheneServiceTest extends AbstractSpringIntegrationBambooBitbucketJiraTest {\n+\n+    @Autowired\n+    RestTemplate restTemplate;\n+\n+    @Autowired\n+    TextBlockService textBlockService;\n+\n+    @Autowired\n+    TextAssessmentQueueService textAssessmentQueueService;\n+\n+    @Mock\n+    TextExerciseRepository textExerciseRepository;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MTA1Mzcw", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-515105370", "createdAt": "2020-10-22T20:46:13Z", "commit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MTA1OTcz", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-515105973", "createdAt": "2020-10-22T20:47:07Z", "commit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDo0NzowN1rOHmzMgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDo0NzowN1rOHmzMgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0NjcyMA==", "bodyText": "I consider ReflectionTestUtils.setField bad practice here.\nInstead let the application-artemis.yml in the test folder set those values for test cases automatically", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r510446720", "createdAt": "2020-10-22T20:47:07Z", "author": {"login": "krusche"}, "path": "src/test/java/de/tum/in/www1/artemis/service/connectors/AtheneServiceTest.java", "diffHunk": "@@ -0,0 +1,265 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import static org.apache.commons.codec.digest.DigestUtils.sha1Hex;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.*;\n+import static org.mockito.Mockito.*;\n+import static org.springframework.test.web.client.match.MockRestRequestMatchers.method;\n+import static org.springframework.test.web.client.match.MockRestRequestMatchers.requestTo;\n+import static org.springframework.test.web.client.response.MockRestResponseCreators.withSuccess;\n+\n+import java.time.ZonedDateTime;\n+import java.util.*;\n+\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.*;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.HttpMethod;\n+import org.springframework.http.MediaType;\n+import org.springframework.test.util.ReflectionTestUtils;\n+import org.springframework.test.web.client.ExpectedCount;\n+import org.springframework.test.web.client.MockRestServiceServer;\n+import org.springframework.web.client.RestTemplate;\n+\n+import de.tum.in.www1.artemis.AbstractSpringIntegrationBambooBitbucketJiraTest;\n+import de.tum.in.www1.artemis.domain.*;\n+import de.tum.in.www1.artemis.domain.enumeration.Language;\n+import de.tum.in.www1.artemis.repository.*;\n+import de.tum.in.www1.artemis.service.TextAssessmentQueueService;\n+import de.tum.in.www1.artemis.service.TextBlockService;\n+import de.tum.in.www1.artemis.service.TextSubmissionService;\n+import de.tum.in.www1.artemis.util.ModelFactory;\n+import de.tum.in.www1.artemis.web.rest.dto.AtheneDTO;\n+\n+public class AtheneServiceTest extends AbstractSpringIntegrationBambooBitbucketJiraTest {\n+\n+    @Autowired\n+    RestTemplate restTemplate;\n+\n+    @Autowired\n+    TextBlockService textBlockService;\n+\n+    @Autowired\n+    TextAssessmentQueueService textAssessmentQueueService;\n+\n+    @Mock\n+    TextExerciseRepository textExerciseRepository;\n+\n+    @Mock\n+    TextBlockRepository textBlockRepository;\n+\n+    @Mock\n+    TextSubmissionService textSubmissionService;\n+\n+    @Mock\n+    TextClusterRepository textClusterRepository;\n+\n+    private final String API_ENDPOINT = \"http://localhost/submit\";\n+\n+    AtheneService atheneService;\n+\n+    TextExercise exercise1;\n+\n+    /**\n+     * Initializes atheneService and example exercise\n+     */\n+    @BeforeEach\n+    public void init() {\n+        // Create atheneService and inject @Value fields\n+        atheneService = new AtheneService(textSubmissionService, textBlockRepository, textBlockService, textClusterRepository, textExerciseRepository, textAssessmentQueueService);\n+        ReflectionTestUtils.setField(atheneService, \"ARTEMIS_SERVER_URL\", ARTEMIS_SERVER_URL);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "originalPosition": 72}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MTA2MDk3", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-515106097", "createdAt": "2020-10-22T20:47:18Z", "commit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDo0NzoxOFrOHmzM8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDo0NzoxOFrOHmzM8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0NjgzNA==", "bodyText": "you don't need to mock a repository. just work with the actual database by saving the above exercise to the database!", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r510446834", "createdAt": "2020-10-22T20:47:18Z", "author": {"login": "krusche"}, "path": "src/test/java/de/tum/in/www1/artemis/service/connectors/AtheneServiceTest.java", "diffHunk": "@@ -0,0 +1,265 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import static org.apache.commons.codec.digest.DigestUtils.sha1Hex;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.*;\n+import static org.mockito.Mockito.*;\n+import static org.springframework.test.web.client.match.MockRestRequestMatchers.method;\n+import static org.springframework.test.web.client.match.MockRestRequestMatchers.requestTo;\n+import static org.springframework.test.web.client.response.MockRestResponseCreators.withSuccess;\n+\n+import java.time.ZonedDateTime;\n+import java.util.*;\n+\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.*;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.HttpMethod;\n+import org.springframework.http.MediaType;\n+import org.springframework.test.util.ReflectionTestUtils;\n+import org.springframework.test.web.client.ExpectedCount;\n+import org.springframework.test.web.client.MockRestServiceServer;\n+import org.springframework.web.client.RestTemplate;\n+\n+import de.tum.in.www1.artemis.AbstractSpringIntegrationBambooBitbucketJiraTest;\n+import de.tum.in.www1.artemis.domain.*;\n+import de.tum.in.www1.artemis.domain.enumeration.Language;\n+import de.tum.in.www1.artemis.repository.*;\n+import de.tum.in.www1.artemis.service.TextAssessmentQueueService;\n+import de.tum.in.www1.artemis.service.TextBlockService;\n+import de.tum.in.www1.artemis.service.TextSubmissionService;\n+import de.tum.in.www1.artemis.util.ModelFactory;\n+import de.tum.in.www1.artemis.web.rest.dto.AtheneDTO;\n+\n+public class AtheneServiceTest extends AbstractSpringIntegrationBambooBitbucketJiraTest {\n+\n+    @Autowired\n+    RestTemplate restTemplate;\n+\n+    @Autowired\n+    TextBlockService textBlockService;\n+\n+    @Autowired\n+    TextAssessmentQueueService textAssessmentQueueService;\n+\n+    @Mock\n+    TextExerciseRepository textExerciseRepository;\n+\n+    @Mock\n+    TextBlockRepository textBlockRepository;\n+\n+    @Mock\n+    TextSubmissionService textSubmissionService;\n+\n+    @Mock\n+    TextClusterRepository textClusterRepository;\n+\n+    private final String API_ENDPOINT = \"http://localhost/submit\";\n+\n+    AtheneService atheneService;\n+\n+    TextExercise exercise1;\n+\n+    /**\n+     * Initializes atheneService and example exercise\n+     */\n+    @BeforeEach\n+    public void init() {\n+        // Create atheneService and inject @Value fields\n+        atheneService = new AtheneService(textSubmissionService, textBlockRepository, textBlockService, textClusterRepository, textExerciseRepository, textAssessmentQueueService);\n+        ReflectionTestUtils.setField(atheneService, \"ARTEMIS_SERVER_URL\", ARTEMIS_SERVER_URL);\n+        ReflectionTestUtils.setField(atheneService, \"API_ENDPOINT\", API_ENDPOINT);\n+        String API_SECRET = \"YWVuaXF1YWRpNWNlaXJpNmFlbTZkb283dXphaVF1b29oM3J1MWNoYWlyNHRoZWUzb2huZ2FpM211bGVlM0VpcAo=\";\n+        ReflectionTestUtils.setField(atheneService, \"API_SECRET\", API_SECRET);\n+\n+        // Create example exercise\n+        ZonedDateTime pastTimestamp = ZonedDateTime.now().minusDays(5);\n+        ZonedDateTime futureTimestamp = ZonedDateTime.now().plusDays(5);\n+        Course course1 = ModelFactory.generateCourse(1L, pastTimestamp, futureTimestamp, new HashSet<>(), \"tumuser\", \"tutor\", \"instructor\");\n+        course1.setRegistrationEnabled(true);\n+        exercise1 = ModelFactory.generateTextExercise(pastTimestamp, futureTimestamp, futureTimestamp, course1);\n+        exercise1.setId(1L);\n+\n+        when(textExerciseRepository.findWithEagerTeamAssignmentConfigAndCategoriesById(exercise1.getId())).thenReturn(Optional.ofNullable(exercise1));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "originalPosition": 85}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MTA4MjM5", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-515108239", "createdAt": "2020-10-22T20:50:34Z", "commit": {"oid": "88e97c2f2a748b7d50b67f2645fd2afed85b40ac"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a476669336de0fea96eea90f17e1154cfddbb4e", "author": {"user": {"login": "jpbernius", "name": "Jan Philip Bernius"}}, "url": "https://github.com/ls1intum/Artemis/commit/7a476669336de0fea96eea90f17e1154cfddbb4e", "committedDate": "2020-10-22T20:59:37Z", "message": "Remove Transactional"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f50434aa39a5bb2b8362a4b2e144365dc99eaff0", "author": {"user": {"login": "jpbernius", "name": "Jan Philip Bernius"}}, "url": "https://github.com/ls1intum/Artemis/commit/f50434aa39a5bb2b8362a4b2e144365dc99eaff0", "committedDate": "2020-10-22T21:03:08Z", "message": "TextBlock -> TextBlockDTO"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eaa30e028b4ab6e0c1a9b2edcbdef56964f5c625", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/eaa30e028b4ab6e0c1a9b2edcbdef56964f5c625", "committedDate": "2020-10-22T21:18:47Z", "message": "Implement requested changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df9e430e1741a861ceb84d27b7253046d90504a7", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/df9e430e1741a861ceb84d27b7253046d90504a7", "committedDate": "2020-10-22T21:30:23Z", "message": "merge commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d30963a78ea6b384a9e5c67efc67f50b4c52d6f", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/1d30963a78ea6b384a9e5c67efc67f50b4c52d6f", "committedDate": "2020-10-22T21:34:05Z", "message": "Adjust variable name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cca0e7fd0108a07c14e4df3d838c8fb65bc25284", "author": {"user": {"login": "linusmichel", "name": "Linus Michel"}}, "url": "https://github.com/ls1intum/Artemis/commit/cca0e7fd0108a07c14e4df3d838c8fb65bc25284", "committedDate": "2020-10-23T06:25:23Z", "message": "Fix codacy issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1NjIyNTYy", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-515622562", "createdAt": "2020-10-23T12:33:14Z", "commit": {"oid": "cca0e7fd0108a07c14e4df3d838c8fb65bc25284"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2ff7a55ed1e75501a23816438877082ec4587d4", "author": {"user": {"login": "bigultekin", "name": "Birtan G\u00fcltekin"}}, "url": "https://github.com/ls1intum/Artemis/commit/e2ff7a55ed1e75501a23816438877082ec4587d4", "committedDate": "2020-10-25T18:54:41Z", "message": "Merge branch 'develop' into feature/athene-load-balancer\n\n# Conflicts:\n#\tsrc/main/java/de/tum/in/www1/artemis/service/connectors/TextAssessmentConflictService.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0224b6737adfc32d8b9471c8da6e3307db1cbab6", "author": {"user": {"login": "bigultekin", "name": "Birtan G\u00fcltekin"}}, "url": "https://github.com/ls1intum/Artemis/commit/0224b6737adfc32d8b9471c8da6e3307db1cbab6", "committedDate": "2020-10-25T22:26:12Z", "message": "added AtheneRequestMockProvider and fixed tests related to feedback conflicts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTU2NzAz", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-516956703", "createdAt": "2020-10-26T16:27:36Z", "commit": {"oid": "0224b6737adfc32d8b9471c8da6e3307db1cbab6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyNzozNlrOHoX09A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyNzozNlrOHoX09A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5NTQ3Ng==", "bodyText": "can we use a better name here and append DTO?", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r512095476", "createdAt": "2020-10-26T16:27:36Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/AtheneService.java", "diffHunk": "@@ -0,0 +1,263 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import static de.tum.in.www1.artemis.config.Constants.ATHENE_RESULT_API_PATH;\n+import static de.tum.in.www1.artemis.service.connectors.RemoteArtemisServiceConnector.authorizationHeaderForSymmetricSecret;\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.Collectors.toMap;\n+\n+import java.util.*;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import org.hibernate.Hibernate;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.stereotype.Service;\n+\n+import de.tum.in.www1.artemis.domain.*;\n+import de.tum.in.www1.artemis.domain.enumeration.Language;\n+import de.tum.in.www1.artemis.exception.NetworkingError;\n+import de.tum.in.www1.artemis.repository.TextBlockRepository;\n+import de.tum.in.www1.artemis.repository.TextClusterRepository;\n+import de.tum.in.www1.artemis.repository.TextExerciseRepository;\n+import de.tum.in.www1.artemis.service.TextAssessmentQueueService;\n+import de.tum.in.www1.artemis.service.TextSubmissionService;\n+import de.tum.in.www1.artemis.web.rest.dto.AtheneDTO;\n+\n+@Service\n+@Profile(\"athene\")\n+public class AtheneService {\n+\n+    private final Logger log = LoggerFactory.getLogger(AtheneService.class);\n+\n+    @Value(\"${server.url}\")\n+    private String artemisServerUrl;\n+\n+    @Value(\"${artemis.athene.submit-url}\")\n+    private String submitApiEndpoint;\n+\n+    @Value(\"${artemis.athene.base64-secret}\")\n+    private String apiSecret;\n+\n+    private final TextAssessmentQueueService textAssessmentQueueService;\n+\n+    private final TextBlockRepository textBlockRepository;\n+\n+    private final TextClusterRepository textClusterRepository;\n+\n+    private final TextExerciseRepository textExerciseRepository;\n+\n+    private final TextSubmissionService textSubmissionService;\n+\n+    private final RemoteArtemisServiceConnector<Request, Response> connector = new RemoteArtemisServiceConnector<>(log, Response.class);\n+\n+    // Contains tasks submitted to Athene and currently processing\n+    private final List<Long> runningAtheneTasks = new ArrayList<>();\n+\n+    public AtheneService(TextSubmissionService textSubmissionService, TextBlockRepository textBlockRepository, TextClusterRepository textClusterRepository,\n+            TextExerciseRepository textExerciseRepository, TextAssessmentQueueService textAssessmentQueueService) {\n+        this.textSubmissionService = textSubmissionService;\n+        this.textBlockRepository = textBlockRepository;\n+        this.textClusterRepository = textClusterRepository;\n+        this.textExerciseRepository = textExerciseRepository;\n+        this.textAssessmentQueueService = textAssessmentQueueService;\n+    }\n+\n+    // region Request/Response DTOs\n+    private static class Request {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0224b6737adfc32d8b9471c8da6e3307db1cbab6"}, "originalPosition": 69}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "653daa3acbde3fdc8943e9ae6db16404a6edc341", "author": {"user": {"login": "bigultekin", "name": "Birtan G\u00fcltekin"}}, "url": "https://github.com/ls1intum/Artemis/commit/653daa3acbde3fdc8943e9ae6db16404a6edc341", "committedDate": "2020-10-26T17:17:49Z", "message": "Merge branch 'develop' into feature/athene-load-balancer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf9586a2322e1f01e56822427852cf3291c26721", "author": {"user": {"login": "bigultekin", "name": "Birtan G\u00fcltekin"}}, "url": "https://github.com/ls1intum/Artemis/commit/cf9586a2322e1f01e56822427852cf3291c26721", "committedDate": "2020-10-26T17:19:36Z", "message": "remove obsolete FeedbackConflictServiceTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc8dac30e8f3ca6e8cfe17f4c1830a4836a4b77e", "author": {"user": {"login": "bigultekin", "name": "Birtan G\u00fcltekin"}}, "url": "https://github.com/ls1intum/Artemis/commit/dc8dac30e8f3ca6e8cfe17f4c1830a4836a4b77e", "committedDate": "2020-10-26T17:43:20Z", "message": "fixed javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abe03f8735b66a9fcc466ff085975200b7832083", "author": {"user": {"login": "bigultekin", "name": "Birtan G\u00fcltekin"}}, "url": "https://github.com/ls1intum/Artemis/commit/abe03f8735b66a9fcc466ff085975200b7832083", "committedDate": "2020-10-26T18:13:34Z", "message": "fixed failing tests in AutomaticFeedbackConflictServiceTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b90949393df0df420409be7d9026d3970d093926", "author": {"user": {"login": "jpbernius", "name": "Jan Philip Bernius"}}, "url": "https://github.com/ls1intum/Artemis/commit/b90949393df0df420409be7d9026d3970d093926", "committedDate": "2020-10-28T15:44:02Z", "message": "Add Integration Test for Athene Resource"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f99ba5e6723a7e8eb8d537dd220660b240ea0e0a", "author": {"user": {"login": "jpbernius", "name": "Jan Philip Bernius"}}, "url": "https://github.com/ls1intum/Artemis/commit/f99ba5e6723a7e8eb8d537dd220660b240ea0e0a", "committedDate": "2020-10-28T15:45:43Z", "message": "Log Networking Error Message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c66397137ebe4af15c16f5557a0934c3547a6f47", "author": {"user": {"login": "jpbernius", "name": "Jan Philip Bernius"}}, "url": "https://github.com/ls1intum/Artemis/commit/c66397137ebe4af15c16f5557a0934c3547a6f47", "committedDate": "2020-10-28T15:46:49Z", "message": "Rename Test Constant"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76407f4d7e77df7d71c77db80699abb25057430d", "author": {"user": {"login": "jpbernius", "name": "Jan Philip Bernius"}}, "url": "https://github.com/ls1intum/Artemis/commit/76407f4d7e77df7d71c77db80699abb25057430d", "committedDate": "2020-10-28T15:47:20Z", "message": "Merge branch 'develop' into feature/athene-load-balancer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22687b75ed5abe451e08696bb53c715f252bab24", "author": {"user": {"login": "jpbernius", "name": "Jan Philip Bernius"}}, "url": "https://github.com/ls1intum/Artemis/commit/22687b75ed5abe451e08696bb53c715f252bab24", "committedDate": "2020-10-28T16:14:02Z", "message": "Fix positionInCluster save\n\nSave Text Blocks after setting them them to the cluster.\nTextCluster:setBlocks sets the positionInCluster attribute."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95bcc556c7ba925eddba1973ccf599870b24495c", "author": {"user": {"login": "jpbernius", "name": "Jan Philip Bernius"}}, "url": "https://github.com/ls1intum/Artemis/commit/95bcc556c7ba925eddba1973ccf599870b24495c", "committedDate": "2020-10-28T16:18:43Z", "message": "Extend Test to detect positionInCluster"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fc615bf554bd71d4d03ec8862410ac45b8629fb", "author": {"user": {"login": "jpbernius", "name": "Jan Philip Bernius"}}, "url": "https://github.com/ls1intum/Artemis/commit/5fc615bf554bd71d4d03ec8862410ac45b8629fb", "committedDate": "2020-10-28T16:22:31Z", "message": "Spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5aa2f3ef4f661d3c99d1d58f919370e957560649", "author": {"user": {"login": "jpbernius", "name": "Jan Philip Bernius"}}, "url": "https://github.com/ls1intum/Artemis/commit/5aa2f3ef4f661d3c99d1d58f919370e957560649", "committedDate": "2020-10-28T16:24:30Z", "message": "Request/Response -> DTO"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6c6ebe37717ba40a69a98bd9f9a5c4d03b0f619", "author": {"user": {"login": "jpbernius", "name": "Jan Philip Bernius"}}, "url": "https://github.com/ls1intum/Artemis/commit/a6c6ebe37717ba40a69a98bd9f9a5c4d03b0f619", "committedDate": "2020-10-28T20:14:20Z", "message": "TeadDown Test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f40d708c97fdbdb100dc8a026f630aed8fc204bd", "author": {"user": {"login": "jpbernius", "name": "Jan Philip Bernius"}}, "url": "https://github.com/ls1intum/Artemis/commit/f40d708c97fdbdb100dc8a026f630aed8fc204bd", "committedDate": "2020-10-28T20:32:05Z", "message": "Try to fix InvalidDataAccessApiUsageException"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c2538c6652bafcb0849e100fe29edf477abc957", "author": {"user": {"login": "jpbernius", "name": "Jan Philip Bernius"}}, "url": "https://github.com/ls1intum/Artemis/commit/7c2538c6652bafcb0849e100fe29edf477abc957", "committedDate": "2020-10-28T20:34:29Z", "message": "Add JavaDoc for Test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31ebbfcb4a6d6add0638643340532a5cf9e9b0b9", "author": {"user": {"login": "jpbernius", "name": "Jan Philip Bernius"}}, "url": "https://github.com/ls1intum/Artemis/commit/31ebbfcb4a6d6add0638643340532a5cf9e9b0b9", "committedDate": "2020-10-28T21:02:59Z", "message": "Fix up Imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5MDgxOTM4", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-519081938", "createdAt": "2020-10-28T21:03:40Z", "commit": {"oid": "31ebbfcb4a6d6add0638643340532a5cf9e9b0b9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5MDg0ODAz", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-519084803", "createdAt": "2020-10-28T21:07:50Z", "commit": {"oid": "31ebbfcb4a6d6add0638643340532a5cf9e9b0b9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMTowNzo1MFrOHp9fmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMTowNzo1MFrOHp9fmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc2MTE3Nw==", "bodyText": "Codacy found an issue: The instance method name 'findByParticipation_ExerciseIdAndSubmittedIsTrue' doesn't match '[a-z][a-zA-Z0-9]*'", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r513761177", "createdAt": "2020-10-28T21:07:50Z", "author": {"login": "artemis-bot"}, "path": "src/main/java/de/tum/in/www1/artemis/repository/TextSubmissionRepository.java", "diffHunk": "@@ -39,4 +40,20 @@\n \n     @EntityGraph(type = LOAD, attributePaths = { \"result\", \"result.assessor\", \"blocks\" })\n     Optional<TextSubmission> findByResult_Id(Long resultId);\n+\n+    /**\n+     * Gets all TextSubmissions which are submitted and loads all blocks\n+     * @param exerciseId the Id of the exercise\n+     * @return List of Text Submissions\n+     */\n+    @EntityGraph(type = LOAD, attributePaths = { \"blocks\" })\n+    List<TextSubmission> findByParticipation_ExerciseIdAndSubmittedIsTrue(Long exerciseId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31ebbfcb4a6d6add0638643340532a5cf9e9b0b9"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5MDg0ODIx", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-519084821", "createdAt": "2020-10-28T21:07:51Z", "commit": {"oid": "31ebbfcb4a6d6add0638643340532a5cf9e9b0b9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMTowNzo1MVrOHp9foQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMTowNzo1MVrOHp9foQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc2MTE4NQ==", "bodyText": "Codacy found an issue: The instance method name 'findByParticipation_ExerciseIdAndSubmittedIsTrueAndLanguage' doesn't match '[a-z][a-zA-Z0-9]*'", "url": "https://github.com/ls1intum/Artemis/pull/2157#discussion_r513761185", "createdAt": "2020-10-28T21:07:51Z", "author": {"login": "artemis-bot"}, "path": "src/main/java/de/tum/in/www1/artemis/repository/TextSubmissionRepository.java", "diffHunk": "@@ -39,4 +40,20 @@\n \n     @EntityGraph(type = LOAD, attributePaths = { \"result\", \"result.assessor\", \"blocks\" })\n     Optional<TextSubmission> findByResult_Id(Long resultId);\n+\n+    /**\n+     * Gets all TextSubmissions which are submitted and loads all blocks\n+     * @param exerciseId the Id of the exercise\n+     * @return List of Text Submissions\n+     */\n+    @EntityGraph(type = LOAD, attributePaths = { \"blocks\" })\n+    List<TextSubmission> findByParticipation_ExerciseIdAndSubmittedIsTrue(Long exerciseId);\n+\n+    /**\n+     * Gets all TextSubmissions which are submitted, with matching and loads all blocks\n+     * @param exerciseId the Id of the exercise\n+     * @param language language of the exercise\n+     * @return List of Text Submissions\n+     */\n+    List<TextSubmission> findByParticipation_ExerciseIdAndSubmittedIsTrueAndLanguage(Long exerciseId, Language language);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31ebbfcb4a6d6add0638643340532a5cf9e9b0b9"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5NDk4MTA3", "url": "https://github.com/ls1intum/Artemis/pull/2157#pullrequestreview-519498107", "createdAt": "2020-10-29T09:54:41Z", "commit": {"oid": "31ebbfcb4a6d6add0638643340532a5cf9e9b0b9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3741, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}