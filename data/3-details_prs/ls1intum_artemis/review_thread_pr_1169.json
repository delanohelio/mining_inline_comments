{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5MzI2NDE3", "number": 1169, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNVQxOTozNjo1MVrODV206g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxMDo1OTozMlrODWgcLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MjQ0OTcwOnYy", "diffSide": "RIGHT", "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/BitbucketService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNVQxOTozNjo1MVrOFaSogg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNVQxOTozNjo1MVrOFaSogg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExMjU3OA==", "bodyText": "The null check was always true", "url": "https://github.com/ls1intum/Artemis/pull/1169#discussion_r363112578", "createdAt": "2020-01-05T19:36:51Z", "author": {"login": "ungaralex"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/BitbucketService.java", "diffHunk": "@@ -622,7 +610,7 @@ private void grantGroupPermissionToProject(String projectKey, String groupName,\n \n         Map<Integer, String> webHooks = new HashMap<>();\n \n-        if (response != null && response.getStatusCode().equals(HttpStatus.OK)) {\n+        if (response.getStatusCode().equals(HttpStatus.OK)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a7c6a32f22cc576bb85b6cd67ed1535d908797e"}, "originalPosition": 110}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MjQ1MDg2OnYy", "diffSide": "RIGHT", "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/BitbucketService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNVQxOTozOTozN1rOFaSpHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNVQxOTozOTozN1rOFaSpHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExMjczNA==", "bodyText": "Was not working if we used other URLs in our tests, that don't have the Bitbucket format (which is sometimes the case because we don't only write specific Bitbucket tests, but some also just want to validate the generic VCS service functionality)", "url": "https://github.com/ls1intum/Artemis/pull/1169#discussion_r363112734", "createdAt": "2020-01-05T19:39:37Z", "author": {"login": "ungaralex"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/BitbucketService.java", "diffHunk": "@@ -296,11 +281,9 @@ private String getProjectKeyFromUrl(URL repositoryUrl) throws BitbucketException\n     public String getRepositorySlugFromUrl(URL repositoryUrl) throws BitbucketException {\n         // https://ga42xab@repobruegge.in.tum.de/scm/EIST2016RME/RMEXERCISE-ga42xab.git\n         String[] urlParts = repositoryUrl.getFile().split(\"/\");\n-        if (urlParts.length > 3) {\n-            String repositorySlug = urlParts[3];\n-            if (repositorySlug.endsWith(\".git\")) {\n-                repositorySlug = repositorySlug.substring(0, repositorySlug.length() - 4);\n-            }\n+        if (urlParts[urlParts.length - 1].endsWith(\".git\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a7c6a32f22cc576bb85b6cd67ed1535d908797e"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MjU0OTg0OnYy", "diffSide": "RIGHT", "path": "src/main/java/de/tum/in/www1/artemis/config/connector/BambooServerConfiguration.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNVQyMzo0NDo0MlrOFaTc6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMjoyMToyNVrOFa35dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzEyNTk5NQ==", "bodyText": "do we really have this case that the bitbucket profile is not active?\nAlso I guess sometimes we still need the simple bamboo client, right?", "url": "https://github.com/ls1intum/Artemis/pull/1169#discussion_r363125995", "createdAt": "2020-01-05T23:44:42Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/config/connector/BambooServerConfiguration.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package de.tum.in.www1.artemis.config.connector;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.PrintStream;\n+import java.net.URL;\n+\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.Profile;\n+\n+import com.appfire.bamboo.cli.BambooClient;\n+import com.appfire.common.cli.Base;\n+import com.appfire.common.cli.Settings;\n+import com.atlassian.bamboo.specs.util.BambooServer;\n+import com.atlassian.bamboo.specs.util.SimpleUserPasswordCredentials;\n+import com.atlassian.bamboo.specs.util.UserPasswordCredentials;\n+\n+@Configuration\n+@Profile(\"bamboo\")\n+public class BambooServerConfiguration {\n+\n+    @Value(\"${artemis.continuous-integration.user}\")\n+    private String BAMBOO_USER;\n+\n+    @Value(\"${artemis.continuous-integration.password}\")\n+    private String BAMBOO_PASSWORD;\n+\n+    @Value(\"${artemis.continuous-integration.url}\")\n+    private URL BAMBOO_SERVER_URL;\n+\n+    @Value(\"${artemis.version-control.user}\")\n+    private String BITBUCKET_USER;\n+\n+    @Value(\"${artemis.version-control.password}\")\n+    private String BITBUCKET_PASSWORD;\n+\n+    @Value(\"${artemis.version-control.url}\")\n+    private URL BITBUCKET_SERVER;\n+\n+    @Bean\n+    public BambooServer bambooServer() {\n+        UserPasswordCredentials userPasswordCredentials = new SimpleUserPasswordCredentials(BAMBOO_USER, BAMBOO_PASSWORD);\n+        return new BambooServer(BAMBOO_SERVER_URL.toString(), userPasswordCredentials);\n+    }\n+\n+    /**\n+     * Creates a Bamboo client for communication with the Bamboo instance over the non-REST API. This beans is also connected to the Bitbucket server\n+     * if the bitbucket profile is activated (incl. authentication).\n+     *\n+     * @return BambooClient instance for the Bamboo server that is defined in the environment yml files.\n+     */\n+    @Bean\n+    @Profile(\"bitbucket\")\n+    public BambooClient bambooClient() {\n+        final var bambooClient = new BambooClient(createBase());\n+        // setup the Bamboo Client to use the correct username and password\n+        final var args = new String[] { \"-s\", BAMBOO_SERVER_URL.toString(), \"--user\", BAMBOO_USER, \"--password\", BAMBOO_PASSWORD, \"--targetServer\", BITBUCKET_SERVER.toString(),\n+                \"--targetUser\", BITBUCKET_USER, \"--targetPassword\", BITBUCKET_PASSWORD };\n+\n+        bambooClient.doWork(args); // only invoke this to set server address, username and password so that the following action will work\n+        return bambooClient;\n+    }\n+\n+    /**\n+     * Creates a Bamboo client for communication with the Bamboo instance over the non-REST API. This bean has NO connection\n+     * to the Bitbucket server and only gets instantiated if the Bitbucket profile is not active\n+     *\n+     * @return\n+     */\n+    @Bean(\"bambooClient\")\n+    @Profile(\"!bitbucket\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "829eda1162239686b493b2db1b47fe75c5191541"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY3OTczOQ==", "bodyText": "remove", "url": "https://github.com/ls1intum/Artemis/pull/1169#discussion_r363679739", "createdAt": "2020-01-07T10:18:15Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/config/connector/BambooServerConfiguration.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package de.tum.in.www1.artemis.config.connector;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.PrintStream;\n+import java.net.URL;\n+\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.Profile;\n+\n+import com.appfire.bamboo.cli.BambooClient;\n+import com.appfire.common.cli.Base;\n+import com.appfire.common.cli.Settings;\n+import com.atlassian.bamboo.specs.util.BambooServer;\n+import com.atlassian.bamboo.specs.util.SimpleUserPasswordCredentials;\n+import com.atlassian.bamboo.specs.util.UserPasswordCredentials;\n+\n+@Configuration\n+@Profile(\"bamboo\")\n+public class BambooServerConfiguration {\n+\n+    @Value(\"${artemis.continuous-integration.user}\")\n+    private String BAMBOO_USER;\n+\n+    @Value(\"${artemis.continuous-integration.password}\")\n+    private String BAMBOO_PASSWORD;\n+\n+    @Value(\"${artemis.continuous-integration.url}\")\n+    private URL BAMBOO_SERVER_URL;\n+\n+    @Value(\"${artemis.version-control.user}\")\n+    private String BITBUCKET_USER;\n+\n+    @Value(\"${artemis.version-control.password}\")\n+    private String BITBUCKET_PASSWORD;\n+\n+    @Value(\"${artemis.version-control.url}\")\n+    private URL BITBUCKET_SERVER;\n+\n+    @Bean\n+    public BambooServer bambooServer() {\n+        UserPasswordCredentials userPasswordCredentials = new SimpleUserPasswordCredentials(BAMBOO_USER, BAMBOO_PASSWORD);\n+        return new BambooServer(BAMBOO_SERVER_URL.toString(), userPasswordCredentials);\n+    }\n+\n+    /**\n+     * Creates a Bamboo client for communication with the Bamboo instance over the non-REST API. This beans is also connected to the Bitbucket server\n+     * if the bitbucket profile is activated (incl. authentication).\n+     *\n+     * @return BambooClient instance for the Bamboo server that is defined in the environment yml files.\n+     */\n+    @Bean\n+    @Profile(\"bitbucket\")\n+    public BambooClient bambooClient() {\n+        final var bambooClient = new BambooClient(createBase());\n+        // setup the Bamboo Client to use the correct username and password\n+        final var args = new String[] { \"-s\", BAMBOO_SERVER_URL.toString(), \"--user\", BAMBOO_USER, \"--password\", BAMBOO_PASSWORD, \"--targetServer\", BITBUCKET_SERVER.toString(),\n+                \"--targetUser\", BITBUCKET_USER, \"--targetPassword\", BITBUCKET_PASSWORD };\n+\n+        bambooClient.doWork(args); // only invoke this to set server address, username and password so that the following action will work\n+        return bambooClient;\n+    }\n+\n+    /**\n+     * Creates a Bamboo client for communication with the Bamboo instance over the non-REST API. This bean has NO connection\n+     * to the Bitbucket server and only gets instantiated if the Bitbucket profile is not active\n+     *\n+     * @return\n+     */\n+    @Bean(\"bambooClient\")\n+    @Profile(\"!bitbucket\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzEyNTk5NQ=="}, "originalCommit": {"oid": "829eda1162239686b493b2db1b47fe75c5191541"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzcyMzEyNg==", "bodyText": "Removed this bean", "url": "https://github.com/ls1intum/Artemis/pull/1169#discussion_r363723126", "createdAt": "2020-01-07T12:21:25Z", "author": {"login": "ungaralex"}, "path": "src/main/java/de/tum/in/www1/artemis/config/connector/BambooServerConfiguration.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package de.tum.in.www1.artemis.config.connector;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.PrintStream;\n+import java.net.URL;\n+\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.Profile;\n+\n+import com.appfire.bamboo.cli.BambooClient;\n+import com.appfire.common.cli.Base;\n+import com.appfire.common.cli.Settings;\n+import com.atlassian.bamboo.specs.util.BambooServer;\n+import com.atlassian.bamboo.specs.util.SimpleUserPasswordCredentials;\n+import com.atlassian.bamboo.specs.util.UserPasswordCredentials;\n+\n+@Configuration\n+@Profile(\"bamboo\")\n+public class BambooServerConfiguration {\n+\n+    @Value(\"${artemis.continuous-integration.user}\")\n+    private String BAMBOO_USER;\n+\n+    @Value(\"${artemis.continuous-integration.password}\")\n+    private String BAMBOO_PASSWORD;\n+\n+    @Value(\"${artemis.continuous-integration.url}\")\n+    private URL BAMBOO_SERVER_URL;\n+\n+    @Value(\"${artemis.version-control.user}\")\n+    private String BITBUCKET_USER;\n+\n+    @Value(\"${artemis.version-control.password}\")\n+    private String BITBUCKET_PASSWORD;\n+\n+    @Value(\"${artemis.version-control.url}\")\n+    private URL BITBUCKET_SERVER;\n+\n+    @Bean\n+    public BambooServer bambooServer() {\n+        UserPasswordCredentials userPasswordCredentials = new SimpleUserPasswordCredentials(BAMBOO_USER, BAMBOO_PASSWORD);\n+        return new BambooServer(BAMBOO_SERVER_URL.toString(), userPasswordCredentials);\n+    }\n+\n+    /**\n+     * Creates a Bamboo client for communication with the Bamboo instance over the non-REST API. This beans is also connected to the Bitbucket server\n+     * if the bitbucket profile is activated (incl. authentication).\n+     *\n+     * @return BambooClient instance for the Bamboo server that is defined in the environment yml files.\n+     */\n+    @Bean\n+    @Profile(\"bitbucket\")\n+    public BambooClient bambooClient() {\n+        final var bambooClient = new BambooClient(createBase());\n+        // setup the Bamboo Client to use the correct username and password\n+        final var args = new String[] { \"-s\", BAMBOO_SERVER_URL.toString(), \"--user\", BAMBOO_USER, \"--password\", BAMBOO_PASSWORD, \"--targetServer\", BITBUCKET_SERVER.toString(),\n+                \"--targetUser\", BITBUCKET_USER, \"--targetPassword\", BITBUCKET_PASSWORD };\n+\n+        bambooClient.doWork(args); // only invoke this to set server address, username and password so that the following action will work\n+        return bambooClient;\n+    }\n+\n+    /**\n+     * Creates a Bamboo client for communication with the Bamboo instance over the non-REST API. This bean has NO connection\n+     * to the Bitbucket server and only gets instantiated if the Bitbucket profile is not active\n+     *\n+     * @return\n+     */\n+    @Bean(\"bambooClient\")\n+    @Profile(\"!bitbucket\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzEyNTk5NQ=="}, "originalCommit": {"oid": "829eda1162239686b493b2db1b47fe75c5191541"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MjU1MDU3OnYy", "diffSide": "RIGHT", "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/BitbucketBambooUpdateService.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNVQyMzo0NjozOFrOFaTdSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMjoyMToxM1rOFa35MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzEyNjA4OA==", "bodyText": "should this not be written like?\n@Profile({ \"bamboo\", \"bitbucket\" })", "url": "https://github.com/ls1intum/Artemis/pull/1169#discussion_r363126088", "createdAt": "2020-01-05T23:46:38Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/BitbucketBambooUpdateService.java", "diffHunk": "@@ -0,0 +1,114 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import java.net.URL;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.lang3.math.NumberUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.stereotype.Service;\n+\n+import com.appfire.bamboo.cli.BambooClient;\n+import com.appfire.bitbucket.cli.BitbucketClient;\n+import com.appfire.common.cli.CliClient;\n+\n+import de.tum.in.www1.artemis.config.Constants;\n+import de.tum.in.www1.artemis.exception.BambooException;\n+import de.tum.in.www1.artemis.service.connectors.bamboo.BambooBuildPlanUpdateProvider;\n+\n+@Service\n+@Profile(\"bamboo & bitbucket\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "829eda1162239686b493b2db1b47fe75c5191541"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY4MDA5Mg==", "bodyText": "add comment", "url": "https://github.com/ls1intum/Artemis/pull/1169#discussion_r363680092", "createdAt": "2020-01-07T10:19:01Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/BitbucketBambooUpdateService.java", "diffHunk": "@@ -0,0 +1,114 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import java.net.URL;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.lang3.math.NumberUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.stereotype.Service;\n+\n+import com.appfire.bamboo.cli.BambooClient;\n+import com.appfire.bitbucket.cli.BitbucketClient;\n+import com.appfire.common.cli.CliClient;\n+\n+import de.tum.in.www1.artemis.config.Constants;\n+import de.tum.in.www1.artemis.exception.BambooException;\n+import de.tum.in.www1.artemis.service.connectors.bamboo.BambooBuildPlanUpdateProvider;\n+\n+@Service\n+@Profile(\"bamboo & bitbucket\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzEyNjA4OA=="}, "originalCommit": {"oid": "829eda1162239686b493b2db1b47fe75c5191541"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzcyMzA1Ng==", "bodyText": "Added a comment", "url": "https://github.com/ls1intum/Artemis/pull/1169#discussion_r363723056", "createdAt": "2020-01-07T12:21:13Z", "author": {"login": "ungaralex"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/BitbucketBambooUpdateService.java", "diffHunk": "@@ -0,0 +1,114 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import java.net.URL;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.lang3.math.NumberUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.stereotype.Service;\n+\n+import com.appfire.bamboo.cli.BambooClient;\n+import com.appfire.bitbucket.cli.BitbucketClient;\n+import com.appfire.common.cli.CliClient;\n+\n+import de.tum.in.www1.artemis.config.Constants;\n+import de.tum.in.www1.artemis.exception.BambooException;\n+import de.tum.in.www1.artemis.service.connectors.bamboo.BambooBuildPlanUpdateProvider;\n+\n+@Service\n+@Profile(\"bamboo & bitbucket\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzEyNjA4OA=="}, "originalCommit": {"oid": "829eda1162239686b493b2db1b47fe75c5191541"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0NjYyNTUwOnYy", "diffSide": "RIGHT", "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/BitbucketBambooUpdateService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMzo1NzozN1rOFa6EIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMzo1NzozN1rOFa6EIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc1ODYyNA==", "bodyText": "Should this not be in the configuration file?", "url": "https://github.com/ls1intum/Artemis/pull/1169#discussion_r363758624", "createdAt": "2020-01-07T13:57:37Z", "author": {"login": "maxr96"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/BitbucketBambooUpdateService.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import java.net.URL;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.lang3.math.NumberUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.stereotype.Service;\n+\n+import com.appfire.bamboo.cli.BambooClient;\n+import com.appfire.common.cli.CliClient;\n+\n+import de.tum.in.www1.artemis.config.Constants;\n+import de.tum.in.www1.artemis.exception.BambooException;\n+import de.tum.in.www1.artemis.service.connectors.bamboo.BambooBuildPlanUpdateProvider;\n+\n+@Service\n+// Only activate this service bean, if both Bamboo and Bitbucket are activated (@Profile({\"bitbucket\",\"bamboo\"}) would activate\n+// this if any profile is active (OR). We want both (AND)\n+@Profile(\"bamboo & bitbucket\")\n+public class BitbucketBambooUpdateService implements ContinuousIntegrationUpdateService {\n+\n+    @Value(\"${artemis.version-control.url}\")\n+    private URL BITBUCKET_SERVER;\n+\n+    private final Logger log = LoggerFactory.getLogger(BitbucketBambooUpdateService.class);\n+\n+    private final BambooClient bambooClient;\n+\n+    private final BambooBuildPlanUpdateProvider bambooBuildPlanUpdateProvider;\n+\n+    public BitbucketBambooUpdateService(BambooClient bambooClient, BambooBuildPlanUpdateProvider bambooBuildPlanUpdateProvider) {\n+        this.bambooClient = bambooClient;\n+        this.bambooBuildPlanUpdateProvider = bambooBuildPlanUpdateProvider;\n+    }\n+\n+    @Override\n+    public void updatePlanRepository(String bambooProject, String planKey, String bambooRepositoryName, String bitbucketProject, String bitbucketRepository,\n+            Optional<List<String>> triggeredBy) {\n+        try {\n+            log.debug(\"Update plan repository for build plan \" + planKey);\n+            com.appfire.bamboo.cli.objects.RemoteRepository bambooRemoteRepository = bambooClient.getRepositoryHelper().getRemoteRepository(bambooRepositoryName, planKey, false);\n+            // Workaround for old exercises which used a different repositoryName\n+            if (bambooRemoteRepository == null) {\n+                bambooRemoteRepository = bambooClient.getRepositoryHelper().getRemoteRepository(\"Assignment\", planKey, false);\n+                if (bambooRemoteRepository == null) {\n+                    throw new BambooException(\"Something went wrong while updating the template repository of the build plan \" + planKey\n+                            + \" to the student repository : Could not find assignment nor Assignment repository\");\n+                }\n+            }\n+\n+            bambooBuildPlanUpdateProvider.updateRepository(bambooRemoteRepository, bitbucketRepository, bitbucketProject, planKey);\n+\n+            // Overwrite triggers if needed, incl workaround for different repo names\n+            if (triggeredBy.isPresent() && bambooRemoteRepository.getName().equals(\"Assignment\")) {\n+                triggeredBy = Optional.of(triggeredBy.get().stream().map(trigger -> trigger.replace(Constants.ASSIGNMENT_REPO_NAME, \"Assignment\")).collect(Collectors.toList()));\n+            }\n+            triggeredBy.ifPresent(repoTriggers -> overwriteTriggers(planKey, bambooClient, repoTriggers));\n+\n+            log.info(\"Update plan repository for build plan \" + planKey + \" was successful\");\n+        }\n+        catch (CliClient.ClientException | CliClient.RemoteRestException e) {\n+            throw new BambooException(\"Something went wrong while updating the template repository of the build plan \" + planKey + \" to the student repository : \" + e.getMessage(),\n+                    e);\n+        }\n+    }\n+\n+    private void overwriteTriggers(final String planKey, final BambooClient bambooClient, final List<String> triggeredBy) {\n+        try {\n+            final var triggersString = bambooClient.getTriggerHelper().getTriggerList(planKey, null, null, 99, Pattern.compile(\".*\"));\n+            // Bamboo CLI returns a weird String, which is the reason for this way of parsing it\n+            final var oldTriggers = Arrays.stream(triggersString.split(\"\\n\")).map(trigger -> trigger.replace(\"\\\"\", \"\").split(\",\"))\n+                    .filter(trigger -> trigger.length > 2 && NumberUtils.isCreatable(trigger[1])).map(trigger -> Long.parseLong(trigger[1])).collect(Collectors.toSet());\n+\n+            // Remove all old triggers\n+            for (final var triggerId : oldTriggers) {\n+                bambooClient.getTriggerHelper().removeTrigger(planKey, null, null, triggerId, null, false);\n+            }\n+\n+            // Add new triggers\n+            for (final var repo : triggeredBy) {\n+                bambooClient.getTriggerHelper().addTrigger(planKey, null, \"remoteBitbucketServer\", null, null, repo, null, null, false);\n+            }\n+        }\n+        catch (CliClient.ClientException | CliClient.RemoteRestException e) {\n+            throw new BambooException(\"Unable to overwrite triggers for \" + planKey + \"\\n\" + e.getMessage(), e);\n+        }\n+    }\n+\n+    @Override\n+    public void triggerUpdate(String buildPlanId, boolean initialBuild) {\n+        // NOT NEEDED\n+    }\n+\n+    /**\n+     * e.g. \"ssh://git@repobruegge.in.tum.de:7999/madm/helloworld.git\"\n+     * @param project the bitbucket project name\n+     * @param slug the bitbucket repo name\n+     * @return the ssh repository url\n+     */\n+    private String buildSshRepositoryUrl(String project, String slug) {\n+        final int sshPort = 7999;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea73700f3f0e069dac3d39a4a51371a2ee899925"}, "originalPosition": 109}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0NjY0ODIzOnYy", "diffSide": "RIGHT", "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/BitbucketBambooUpdateService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNDowNToxMVrOFa6RyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNTozMDowNVrOFa80iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc2MjEyMQ==", "bodyText": "Could the string be replaced by an enum or at least a local variable to not repeat \"Assignment\"?", "url": "https://github.com/ls1intum/Artemis/pull/1169#discussion_r363762121", "createdAt": "2020-01-07T14:05:11Z", "author": {"login": "madwau"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/BitbucketBambooUpdateService.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import java.net.URL;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.lang3.math.NumberUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.stereotype.Service;\n+\n+import com.appfire.bamboo.cli.BambooClient;\n+import com.appfire.common.cli.CliClient;\n+\n+import de.tum.in.www1.artemis.config.Constants;\n+import de.tum.in.www1.artemis.exception.BambooException;\n+import de.tum.in.www1.artemis.service.connectors.bamboo.BambooBuildPlanUpdateProvider;\n+\n+@Service\n+// Only activate this service bean, if both Bamboo and Bitbucket are activated (@Profile({\"bitbucket\",\"bamboo\"}) would activate\n+// this if any profile is active (OR). We want both (AND)\n+@Profile(\"bamboo & bitbucket\")\n+public class BitbucketBambooUpdateService implements ContinuousIntegrationUpdateService {\n+\n+    @Value(\"${artemis.version-control.url}\")\n+    private URL BITBUCKET_SERVER;\n+\n+    private final Logger log = LoggerFactory.getLogger(BitbucketBambooUpdateService.class);\n+\n+    private final BambooClient bambooClient;\n+\n+    private final BambooBuildPlanUpdateProvider bambooBuildPlanUpdateProvider;\n+\n+    public BitbucketBambooUpdateService(BambooClient bambooClient, BambooBuildPlanUpdateProvider bambooBuildPlanUpdateProvider) {\n+        this.bambooClient = bambooClient;\n+        this.bambooBuildPlanUpdateProvider = bambooBuildPlanUpdateProvider;\n+    }\n+\n+    @Override\n+    public void updatePlanRepository(String bambooProject, String planKey, String bambooRepositoryName, String bitbucketProject, String bitbucketRepository,\n+            Optional<List<String>> triggeredBy) {\n+        try {\n+            log.debug(\"Update plan repository for build plan \" + planKey);\n+            com.appfire.bamboo.cli.objects.RemoteRepository bambooRemoteRepository = bambooClient.getRepositoryHelper().getRemoteRepository(bambooRepositoryName, planKey, false);\n+            // Workaround for old exercises which used a different repositoryName\n+            if (bambooRemoteRepository == null) {\n+                bambooRemoteRepository = bambooClient.getRepositoryHelper().getRemoteRepository(\"Assignment\", planKey, false);\n+                if (bambooRemoteRepository == null) {\n+                    throw new BambooException(\"Something went wrong while updating the template repository of the build plan \" + planKey\n+                            + \" to the student repository : Could not find assignment nor Assignment repository\");\n+                }\n+            }\n+\n+            bambooBuildPlanUpdateProvider.updateRepository(bambooRemoteRepository, bitbucketRepository, bitbucketProject, planKey);\n+\n+            // Overwrite triggers if needed, incl workaround for different repo names\n+            if (triggeredBy.isPresent() && bambooRemoteRepository.getName().equals(\"Assignment\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea73700f3f0e069dac3d39a4a51371a2ee899925"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgwMzc4Nw==", "bodyText": "I refactored this into a constant.", "url": "https://github.com/ls1intum/Artemis/pull/1169#discussion_r363803787", "createdAt": "2020-01-07T15:30:05Z", "author": {"login": "ungaralex"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/BitbucketBambooUpdateService.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import java.net.URL;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.lang3.math.NumberUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.stereotype.Service;\n+\n+import com.appfire.bamboo.cli.BambooClient;\n+import com.appfire.common.cli.CliClient;\n+\n+import de.tum.in.www1.artemis.config.Constants;\n+import de.tum.in.www1.artemis.exception.BambooException;\n+import de.tum.in.www1.artemis.service.connectors.bamboo.BambooBuildPlanUpdateProvider;\n+\n+@Service\n+// Only activate this service bean, if both Bamboo and Bitbucket are activated (@Profile({\"bitbucket\",\"bamboo\"}) would activate\n+// this if any profile is active (OR). We want both (AND)\n+@Profile(\"bamboo & bitbucket\")\n+public class BitbucketBambooUpdateService implements ContinuousIntegrationUpdateService {\n+\n+    @Value(\"${artemis.version-control.url}\")\n+    private URL BITBUCKET_SERVER;\n+\n+    private final Logger log = LoggerFactory.getLogger(BitbucketBambooUpdateService.class);\n+\n+    private final BambooClient bambooClient;\n+\n+    private final BambooBuildPlanUpdateProvider bambooBuildPlanUpdateProvider;\n+\n+    public BitbucketBambooUpdateService(BambooClient bambooClient, BambooBuildPlanUpdateProvider bambooBuildPlanUpdateProvider) {\n+        this.bambooClient = bambooClient;\n+        this.bambooBuildPlanUpdateProvider = bambooBuildPlanUpdateProvider;\n+    }\n+\n+    @Override\n+    public void updatePlanRepository(String bambooProject, String planKey, String bambooRepositoryName, String bitbucketProject, String bitbucketRepository,\n+            Optional<List<String>> triggeredBy) {\n+        try {\n+            log.debug(\"Update plan repository for build plan \" + planKey);\n+            com.appfire.bamboo.cli.objects.RemoteRepository bambooRemoteRepository = bambooClient.getRepositoryHelper().getRemoteRepository(bambooRepositoryName, planKey, false);\n+            // Workaround for old exercises which used a different repositoryName\n+            if (bambooRemoteRepository == null) {\n+                bambooRemoteRepository = bambooClient.getRepositoryHelper().getRemoteRepository(\"Assignment\", planKey, false);\n+                if (bambooRemoteRepository == null) {\n+                    throw new BambooException(\"Something went wrong while updating the template repository of the build plan \" + planKey\n+                            + \" to the student repository : Could not find assignment nor Assignment repository\");\n+                }\n+            }\n+\n+            bambooBuildPlanUpdateProvider.updateRepository(bambooRemoteRepository, bitbucketRepository, bitbucketProject, planKey);\n+\n+            // Overwrite triggers if needed, incl workaround for different repo names\n+            if (triggeredBy.isPresent() && bambooRemoteRepository.getName().equals(\"Assignment\")) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc2MjEyMQ=="}, "originalCommit": {"oid": "ea73700f3f0e069dac3d39a4a51371a2ee899925"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0NjY1MzgzOnYy", "diffSide": "RIGHT", "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/BitbucketBambooUpdateService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNDowNzoxOFrOFa6VQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNToyOToyN1rOFa8zYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc2MzAwOQ==", "bodyText": "Can the magic number be avoided?", "url": "https://github.com/ls1intum/Artemis/pull/1169#discussion_r363763009", "createdAt": "2020-01-07T14:07:18Z", "author": {"login": "madwau"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/BitbucketBambooUpdateService.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import java.net.URL;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.lang3.math.NumberUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.stereotype.Service;\n+\n+import com.appfire.bamboo.cli.BambooClient;\n+import com.appfire.common.cli.CliClient;\n+\n+import de.tum.in.www1.artemis.config.Constants;\n+import de.tum.in.www1.artemis.exception.BambooException;\n+import de.tum.in.www1.artemis.service.connectors.bamboo.BambooBuildPlanUpdateProvider;\n+\n+@Service\n+// Only activate this service bean, if both Bamboo and Bitbucket are activated (@Profile({\"bitbucket\",\"bamboo\"}) would activate\n+// this if any profile is active (OR). We want both (AND)\n+@Profile(\"bamboo & bitbucket\")\n+public class BitbucketBambooUpdateService implements ContinuousIntegrationUpdateService {\n+\n+    @Value(\"${artemis.version-control.url}\")\n+    private URL BITBUCKET_SERVER;\n+\n+    private final Logger log = LoggerFactory.getLogger(BitbucketBambooUpdateService.class);\n+\n+    private final BambooClient bambooClient;\n+\n+    private final BambooBuildPlanUpdateProvider bambooBuildPlanUpdateProvider;\n+\n+    public BitbucketBambooUpdateService(BambooClient bambooClient, BambooBuildPlanUpdateProvider bambooBuildPlanUpdateProvider) {\n+        this.bambooClient = bambooClient;\n+        this.bambooBuildPlanUpdateProvider = bambooBuildPlanUpdateProvider;\n+    }\n+\n+    @Override\n+    public void updatePlanRepository(String bambooProject, String planKey, String bambooRepositoryName, String bitbucketProject, String bitbucketRepository,\n+            Optional<List<String>> triggeredBy) {\n+        try {\n+            log.debug(\"Update plan repository for build plan \" + planKey);\n+            com.appfire.bamboo.cli.objects.RemoteRepository bambooRemoteRepository = bambooClient.getRepositoryHelper().getRemoteRepository(bambooRepositoryName, planKey, false);\n+            // Workaround for old exercises which used a different repositoryName\n+            if (bambooRemoteRepository == null) {\n+                bambooRemoteRepository = bambooClient.getRepositoryHelper().getRemoteRepository(\"Assignment\", planKey, false);\n+                if (bambooRemoteRepository == null) {\n+                    throw new BambooException(\"Something went wrong while updating the template repository of the build plan \" + planKey\n+                            + \" to the student repository : Could not find assignment nor Assignment repository\");\n+                }\n+            }\n+\n+            bambooBuildPlanUpdateProvider.updateRepository(bambooRemoteRepository, bitbucketRepository, bitbucketProject, planKey);\n+\n+            // Overwrite triggers if needed, incl workaround for different repo names\n+            if (triggeredBy.isPresent() && bambooRemoteRepository.getName().equals(\"Assignment\")) {\n+                triggeredBy = Optional.of(triggeredBy.get().stream().map(trigger -> trigger.replace(Constants.ASSIGNMENT_REPO_NAME, \"Assignment\")).collect(Collectors.toList()));\n+            }\n+            triggeredBy.ifPresent(repoTriggers -> overwriteTriggers(planKey, bambooClient, repoTriggers));\n+\n+            log.info(\"Update plan repository for build plan \" + planKey + \" was successful\");\n+        }\n+        catch (CliClient.ClientException | CliClient.RemoteRestException e) {\n+            throw new BambooException(\"Something went wrong while updating the template repository of the build plan \" + planKey + \" to the student repository : \" + e.getMessage(),\n+                    e);\n+        }\n+    }\n+\n+    private void overwriteTriggers(final String planKey, final BambooClient bambooClient, final List<String> triggeredBy) {\n+        try {\n+            final var triggersString = bambooClient.getTriggerHelper().getTriggerList(planKey, null, null, 99, Pattern.compile(\".*\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea73700f3f0e069dac3d39a4a51371a2ee899925"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgwMzQ4OQ==", "bodyText": "See my other comment", "url": "https://github.com/ls1intum/Artemis/pull/1169#discussion_r363803489", "createdAt": "2020-01-07T15:29:27Z", "author": {"login": "ungaralex"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/BitbucketBambooUpdateService.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import java.net.URL;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.lang3.math.NumberUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.stereotype.Service;\n+\n+import com.appfire.bamboo.cli.BambooClient;\n+import com.appfire.common.cli.CliClient;\n+\n+import de.tum.in.www1.artemis.config.Constants;\n+import de.tum.in.www1.artemis.exception.BambooException;\n+import de.tum.in.www1.artemis.service.connectors.bamboo.BambooBuildPlanUpdateProvider;\n+\n+@Service\n+// Only activate this service bean, if both Bamboo and Bitbucket are activated (@Profile({\"bitbucket\",\"bamboo\"}) would activate\n+// this if any profile is active (OR). We want both (AND)\n+@Profile(\"bamboo & bitbucket\")\n+public class BitbucketBambooUpdateService implements ContinuousIntegrationUpdateService {\n+\n+    @Value(\"${artemis.version-control.url}\")\n+    private URL BITBUCKET_SERVER;\n+\n+    private final Logger log = LoggerFactory.getLogger(BitbucketBambooUpdateService.class);\n+\n+    private final BambooClient bambooClient;\n+\n+    private final BambooBuildPlanUpdateProvider bambooBuildPlanUpdateProvider;\n+\n+    public BitbucketBambooUpdateService(BambooClient bambooClient, BambooBuildPlanUpdateProvider bambooBuildPlanUpdateProvider) {\n+        this.bambooClient = bambooClient;\n+        this.bambooBuildPlanUpdateProvider = bambooBuildPlanUpdateProvider;\n+    }\n+\n+    @Override\n+    public void updatePlanRepository(String bambooProject, String planKey, String bambooRepositoryName, String bitbucketProject, String bitbucketRepository,\n+            Optional<List<String>> triggeredBy) {\n+        try {\n+            log.debug(\"Update plan repository for build plan \" + planKey);\n+            com.appfire.bamboo.cli.objects.RemoteRepository bambooRemoteRepository = bambooClient.getRepositoryHelper().getRemoteRepository(bambooRepositoryName, planKey, false);\n+            // Workaround for old exercises which used a different repositoryName\n+            if (bambooRemoteRepository == null) {\n+                bambooRemoteRepository = bambooClient.getRepositoryHelper().getRemoteRepository(\"Assignment\", planKey, false);\n+                if (bambooRemoteRepository == null) {\n+                    throw new BambooException(\"Something went wrong while updating the template repository of the build plan \" + planKey\n+                            + \" to the student repository : Could not find assignment nor Assignment repository\");\n+                }\n+            }\n+\n+            bambooBuildPlanUpdateProvider.updateRepository(bambooRemoteRepository, bitbucketRepository, bitbucketProject, planKey);\n+\n+            // Overwrite triggers if needed, incl workaround for different repo names\n+            if (triggeredBy.isPresent() && bambooRemoteRepository.getName().equals(\"Assignment\")) {\n+                triggeredBy = Optional.of(triggeredBy.get().stream().map(trigger -> trigger.replace(Constants.ASSIGNMENT_REPO_NAME, \"Assignment\")).collect(Collectors.toList()));\n+            }\n+            triggeredBy.ifPresent(repoTriggers -> overwriteTriggers(planKey, bambooClient, repoTriggers));\n+\n+            log.info(\"Update plan repository for build plan \" + planKey + \" was successful\");\n+        }\n+        catch (CliClient.ClientException | CliClient.RemoteRestException e) {\n+            throw new BambooException(\"Something went wrong while updating the template repository of the build plan \" + planKey + \" to the student repository : \" + e.getMessage(),\n+                    e);\n+        }\n+    }\n+\n+    private void overwriteTriggers(final String planKey, final BambooClient bambooClient, final List<String> triggeredBy) {\n+        try {\n+            final var triggersString = bambooClient.getTriggerHelper().getTriggerList(planKey, null, null, 99, Pattern.compile(\".*\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc2MzAwOQ=="}, "originalCommit": {"oid": "ea73700f3f0e069dac3d39a4a51371a2ee899925"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0NjY1NTY5OnYy", "diffSide": "RIGHT", "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/BitbucketBambooUpdateService.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNDowODowM1rOFa6WdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxMDowMzo1N1rOFbSBRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc2MzMxNg==", "bodyText": "Why not needed?", "url": "https://github.com/ls1intum/Artemis/pull/1169#discussion_r363763316", "createdAt": "2020-01-07T14:08:03Z", "author": {"login": "madwau"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/BitbucketBambooUpdateService.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import java.net.URL;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.lang3.math.NumberUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.stereotype.Service;\n+\n+import com.appfire.bamboo.cli.BambooClient;\n+import com.appfire.common.cli.CliClient;\n+\n+import de.tum.in.www1.artemis.config.Constants;\n+import de.tum.in.www1.artemis.exception.BambooException;\n+import de.tum.in.www1.artemis.service.connectors.bamboo.BambooBuildPlanUpdateProvider;\n+\n+@Service\n+// Only activate this service bean, if both Bamboo and Bitbucket are activated (@Profile({\"bitbucket\",\"bamboo\"}) would activate\n+// this if any profile is active (OR). We want both (AND)\n+@Profile(\"bamboo & bitbucket\")\n+public class BitbucketBambooUpdateService implements ContinuousIntegrationUpdateService {\n+\n+    @Value(\"${artemis.version-control.url}\")\n+    private URL BITBUCKET_SERVER;\n+\n+    private final Logger log = LoggerFactory.getLogger(BitbucketBambooUpdateService.class);\n+\n+    private final BambooClient bambooClient;\n+\n+    private final BambooBuildPlanUpdateProvider bambooBuildPlanUpdateProvider;\n+\n+    public BitbucketBambooUpdateService(BambooClient bambooClient, BambooBuildPlanUpdateProvider bambooBuildPlanUpdateProvider) {\n+        this.bambooClient = bambooClient;\n+        this.bambooBuildPlanUpdateProvider = bambooBuildPlanUpdateProvider;\n+    }\n+\n+    @Override\n+    public void updatePlanRepository(String bambooProject, String planKey, String bambooRepositoryName, String bitbucketProject, String bitbucketRepository,\n+            Optional<List<String>> triggeredBy) {\n+        try {\n+            log.debug(\"Update plan repository for build plan \" + planKey);\n+            com.appfire.bamboo.cli.objects.RemoteRepository bambooRemoteRepository = bambooClient.getRepositoryHelper().getRemoteRepository(bambooRepositoryName, planKey, false);\n+            // Workaround for old exercises which used a different repositoryName\n+            if (bambooRemoteRepository == null) {\n+                bambooRemoteRepository = bambooClient.getRepositoryHelper().getRemoteRepository(\"Assignment\", planKey, false);\n+                if (bambooRemoteRepository == null) {\n+                    throw new BambooException(\"Something went wrong while updating the template repository of the build plan \" + planKey\n+                            + \" to the student repository : Could not find assignment nor Assignment repository\");\n+                }\n+            }\n+\n+            bambooBuildPlanUpdateProvider.updateRepository(bambooRemoteRepository, bitbucketRepository, bitbucketProject, planKey);\n+\n+            // Overwrite triggers if needed, incl workaround for different repo names\n+            if (triggeredBy.isPresent() && bambooRemoteRepository.getName().equals(\"Assignment\")) {\n+                triggeredBy = Optional.of(triggeredBy.get().stream().map(trigger -> trigger.replace(Constants.ASSIGNMENT_REPO_NAME, \"Assignment\")).collect(Collectors.toList()));\n+            }\n+            triggeredBy.ifPresent(repoTriggers -> overwriteTriggers(planKey, bambooClient, repoTriggers));\n+\n+            log.info(\"Update plan repository for build plan \" + planKey + \" was successful\");\n+        }\n+        catch (CliClient.ClientException | CliClient.RemoteRestException e) {\n+            throw new BambooException(\"Something went wrong while updating the template repository of the build plan \" + planKey + \" to the student repository : \" + e.getMessage(),\n+                    e);\n+        }\n+    }\n+\n+    private void overwriteTriggers(final String planKey, final BambooClient bambooClient, final List<String> triggeredBy) {\n+        try {\n+            final var triggersString = bambooClient.getTriggerHelper().getTriggerList(planKey, null, null, 99, Pattern.compile(\".*\"));\n+            // Bamboo CLI returns a weird String, which is the reason for this way of parsing it\n+            final var oldTriggers = Arrays.stream(triggersString.split(\"\\n\")).map(trigger -> trigger.replace(\"\\\"\", \"\").split(\",\"))\n+                    .filter(trigger -> trigger.length > 2 && NumberUtils.isCreatable(trigger[1])).map(trigger -> Long.parseLong(trigger[1])).collect(Collectors.toSet());\n+\n+            // Remove all old triggers\n+            for (final var triggerId : oldTriggers) {\n+                bambooClient.getTriggerHelper().removeTrigger(planKey, null, null, triggerId, null, false);\n+            }\n+\n+            // Add new triggers\n+            for (final var repo : triggeredBy) {\n+                bambooClient.getTriggerHelper().addTrigger(planKey, null, \"remoteBitbucketServer\", null, null, repo, null, null, false);\n+            }\n+        }\n+        catch (CliClient.ClientException | CliClient.RemoteRestException e) {\n+            throw new BambooException(\"Unable to overwrite triggers for \" + planKey + \"\\n\" + e.getMessage(), e);\n+        }\n+    }\n+\n+    @Override\n+    public void triggerUpdate(String buildPlanId, boolean initialBuild) {\n+        // NOT NEEDED", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea73700f3f0e069dac3d39a4a51371a2ee899925"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgwMjAxOA==", "bodyText": "I didn't write this code and I also don't really get why this is here \ud83d\ude04 . The JavaDoc also doesn't really match the by the method name implied usage. I would suggest to maybe remove this in a future PR", "url": "https://github.com/ls1intum/Artemis/pull/1169#discussion_r363802018", "createdAt": "2020-01-07T15:26:32Z", "author": {"login": "ungaralex"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/BitbucketBambooUpdateService.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import java.net.URL;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.lang3.math.NumberUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.stereotype.Service;\n+\n+import com.appfire.bamboo.cli.BambooClient;\n+import com.appfire.common.cli.CliClient;\n+\n+import de.tum.in.www1.artemis.config.Constants;\n+import de.tum.in.www1.artemis.exception.BambooException;\n+import de.tum.in.www1.artemis.service.connectors.bamboo.BambooBuildPlanUpdateProvider;\n+\n+@Service\n+// Only activate this service bean, if both Bamboo and Bitbucket are activated (@Profile({\"bitbucket\",\"bamboo\"}) would activate\n+// this if any profile is active (OR). We want both (AND)\n+@Profile(\"bamboo & bitbucket\")\n+public class BitbucketBambooUpdateService implements ContinuousIntegrationUpdateService {\n+\n+    @Value(\"${artemis.version-control.url}\")\n+    private URL BITBUCKET_SERVER;\n+\n+    private final Logger log = LoggerFactory.getLogger(BitbucketBambooUpdateService.class);\n+\n+    private final BambooClient bambooClient;\n+\n+    private final BambooBuildPlanUpdateProvider bambooBuildPlanUpdateProvider;\n+\n+    public BitbucketBambooUpdateService(BambooClient bambooClient, BambooBuildPlanUpdateProvider bambooBuildPlanUpdateProvider) {\n+        this.bambooClient = bambooClient;\n+        this.bambooBuildPlanUpdateProvider = bambooBuildPlanUpdateProvider;\n+    }\n+\n+    @Override\n+    public void updatePlanRepository(String bambooProject, String planKey, String bambooRepositoryName, String bitbucketProject, String bitbucketRepository,\n+            Optional<List<String>> triggeredBy) {\n+        try {\n+            log.debug(\"Update plan repository for build plan \" + planKey);\n+            com.appfire.bamboo.cli.objects.RemoteRepository bambooRemoteRepository = bambooClient.getRepositoryHelper().getRemoteRepository(bambooRepositoryName, planKey, false);\n+            // Workaround for old exercises which used a different repositoryName\n+            if (bambooRemoteRepository == null) {\n+                bambooRemoteRepository = bambooClient.getRepositoryHelper().getRemoteRepository(\"Assignment\", planKey, false);\n+                if (bambooRemoteRepository == null) {\n+                    throw new BambooException(\"Something went wrong while updating the template repository of the build plan \" + planKey\n+                            + \" to the student repository : Could not find assignment nor Assignment repository\");\n+                }\n+            }\n+\n+            bambooBuildPlanUpdateProvider.updateRepository(bambooRemoteRepository, bitbucketRepository, bitbucketProject, planKey);\n+\n+            // Overwrite triggers if needed, incl workaround for different repo names\n+            if (triggeredBy.isPresent() && bambooRemoteRepository.getName().equals(\"Assignment\")) {\n+                triggeredBy = Optional.of(triggeredBy.get().stream().map(trigger -> trigger.replace(Constants.ASSIGNMENT_REPO_NAME, \"Assignment\")).collect(Collectors.toList()));\n+            }\n+            triggeredBy.ifPresent(repoTriggers -> overwriteTriggers(planKey, bambooClient, repoTriggers));\n+\n+            log.info(\"Update plan repository for build plan \" + planKey + \" was successful\");\n+        }\n+        catch (CliClient.ClientException | CliClient.RemoteRestException e) {\n+            throw new BambooException(\"Something went wrong while updating the template repository of the build plan \" + planKey + \" to the student repository : \" + e.getMessage(),\n+                    e);\n+        }\n+    }\n+\n+    private void overwriteTriggers(final String planKey, final BambooClient bambooClient, final List<String> triggeredBy) {\n+        try {\n+            final var triggersString = bambooClient.getTriggerHelper().getTriggerList(planKey, null, null, 99, Pattern.compile(\".*\"));\n+            // Bamboo CLI returns a weird String, which is the reason for this way of parsing it\n+            final var oldTriggers = Arrays.stream(triggersString.split(\"\\n\")).map(trigger -> trigger.replace(\"\\\"\", \"\").split(\",\"))\n+                    .filter(trigger -> trigger.length > 2 && NumberUtils.isCreatable(trigger[1])).map(trigger -> Long.parseLong(trigger[1])).collect(Collectors.toSet());\n+\n+            // Remove all old triggers\n+            for (final var triggerId : oldTriggers) {\n+                bambooClient.getTriggerHelper().removeTrigger(planKey, null, null, triggerId, null, false);\n+            }\n+\n+            // Add new triggers\n+            for (final var repo : triggeredBy) {\n+                bambooClient.getTriggerHelper().addTrigger(planKey, null, \"remoteBitbucketServer\", null, null, repo, null, null, false);\n+            }\n+        }\n+        catch (CliClient.ClientException | CliClient.RemoteRestException e) {\n+            throw new BambooException(\"Unable to overwrite triggers for \" + planKey + \"\\n\" + e.getMessage(), e);\n+        }\n+    }\n+\n+    @Override\n+    public void triggerUpdate(String buildPlanId, boolean initialBuild) {\n+        // NOT NEEDED", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc2MzMxNg=="}, "originalCommit": {"oid": "ea73700f3f0e069dac3d39a4a51371a2ee899925"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzg4ODA3Mg==", "bodyText": "I guess this is outdated. The corresponding method triggerUpdate in ContinuousIntegrationUpdateService is not used. I guess the trigger build was implemented differently. Please remove it.", "url": "https://github.com/ls1intum/Artemis/pull/1169#discussion_r363888072", "createdAt": "2020-01-07T18:31:32Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/BitbucketBambooUpdateService.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import java.net.URL;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.lang3.math.NumberUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.stereotype.Service;\n+\n+import com.appfire.bamboo.cli.BambooClient;\n+import com.appfire.common.cli.CliClient;\n+\n+import de.tum.in.www1.artemis.config.Constants;\n+import de.tum.in.www1.artemis.exception.BambooException;\n+import de.tum.in.www1.artemis.service.connectors.bamboo.BambooBuildPlanUpdateProvider;\n+\n+@Service\n+// Only activate this service bean, if both Bamboo and Bitbucket are activated (@Profile({\"bitbucket\",\"bamboo\"}) would activate\n+// this if any profile is active (OR). We want both (AND)\n+@Profile(\"bamboo & bitbucket\")\n+public class BitbucketBambooUpdateService implements ContinuousIntegrationUpdateService {\n+\n+    @Value(\"${artemis.version-control.url}\")\n+    private URL BITBUCKET_SERVER;\n+\n+    private final Logger log = LoggerFactory.getLogger(BitbucketBambooUpdateService.class);\n+\n+    private final BambooClient bambooClient;\n+\n+    private final BambooBuildPlanUpdateProvider bambooBuildPlanUpdateProvider;\n+\n+    public BitbucketBambooUpdateService(BambooClient bambooClient, BambooBuildPlanUpdateProvider bambooBuildPlanUpdateProvider) {\n+        this.bambooClient = bambooClient;\n+        this.bambooBuildPlanUpdateProvider = bambooBuildPlanUpdateProvider;\n+    }\n+\n+    @Override\n+    public void updatePlanRepository(String bambooProject, String planKey, String bambooRepositoryName, String bitbucketProject, String bitbucketRepository,\n+            Optional<List<String>> triggeredBy) {\n+        try {\n+            log.debug(\"Update plan repository for build plan \" + planKey);\n+            com.appfire.bamboo.cli.objects.RemoteRepository bambooRemoteRepository = bambooClient.getRepositoryHelper().getRemoteRepository(bambooRepositoryName, planKey, false);\n+            // Workaround for old exercises which used a different repositoryName\n+            if (bambooRemoteRepository == null) {\n+                bambooRemoteRepository = bambooClient.getRepositoryHelper().getRemoteRepository(\"Assignment\", planKey, false);\n+                if (bambooRemoteRepository == null) {\n+                    throw new BambooException(\"Something went wrong while updating the template repository of the build plan \" + planKey\n+                            + \" to the student repository : Could not find assignment nor Assignment repository\");\n+                }\n+            }\n+\n+            bambooBuildPlanUpdateProvider.updateRepository(bambooRemoteRepository, bitbucketRepository, bitbucketProject, planKey);\n+\n+            // Overwrite triggers if needed, incl workaround for different repo names\n+            if (triggeredBy.isPresent() && bambooRemoteRepository.getName().equals(\"Assignment\")) {\n+                triggeredBy = Optional.of(triggeredBy.get().stream().map(trigger -> trigger.replace(Constants.ASSIGNMENT_REPO_NAME, \"Assignment\")).collect(Collectors.toList()));\n+            }\n+            triggeredBy.ifPresent(repoTriggers -> overwriteTriggers(planKey, bambooClient, repoTriggers));\n+\n+            log.info(\"Update plan repository for build plan \" + planKey + \" was successful\");\n+        }\n+        catch (CliClient.ClientException | CliClient.RemoteRestException e) {\n+            throw new BambooException(\"Something went wrong while updating the template repository of the build plan \" + planKey + \" to the student repository : \" + e.getMessage(),\n+                    e);\n+        }\n+    }\n+\n+    private void overwriteTriggers(final String planKey, final BambooClient bambooClient, final List<String> triggeredBy) {\n+        try {\n+            final var triggersString = bambooClient.getTriggerHelper().getTriggerList(planKey, null, null, 99, Pattern.compile(\".*\"));\n+            // Bamboo CLI returns a weird String, which is the reason for this way of parsing it\n+            final var oldTriggers = Arrays.stream(triggersString.split(\"\\n\")).map(trigger -> trigger.replace(\"\\\"\", \"\").split(\",\"))\n+                    .filter(trigger -> trigger.length > 2 && NumberUtils.isCreatable(trigger[1])).map(trigger -> Long.parseLong(trigger[1])).collect(Collectors.toSet());\n+\n+            // Remove all old triggers\n+            for (final var triggerId : oldTriggers) {\n+                bambooClient.getTriggerHelper().removeTrigger(planKey, null, null, triggerId, null, false);\n+            }\n+\n+            // Add new triggers\n+            for (final var repo : triggeredBy) {\n+                bambooClient.getTriggerHelper().addTrigger(planKey, null, \"remoteBitbucketServer\", null, null, repo, null, null, false);\n+            }\n+        }\n+        catch (CliClient.ClientException | CliClient.RemoteRestException e) {\n+            throw new BambooException(\"Unable to overwrite triggers for \" + planKey + \"\\n\" + e.getMessage(), e);\n+        }\n+    }\n+\n+    @Override\n+    public void triggerUpdate(String buildPlanId, boolean initialBuild) {\n+        // NOT NEEDED", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc2MzMxNg=="}, "originalCommit": {"oid": "ea73700f3f0e069dac3d39a4a51371a2ee899925"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDE1MTEwOQ==", "bodyText": "I just removed the outdated code", "url": "https://github.com/ls1intum/Artemis/pull/1169#discussion_r364151109", "createdAt": "2020-01-08T10:03:57Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/BitbucketBambooUpdateService.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package de.tum.in.www1.artemis.service.connectors;\n+\n+import java.net.URL;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.lang3.math.NumberUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.stereotype.Service;\n+\n+import com.appfire.bamboo.cli.BambooClient;\n+import com.appfire.common.cli.CliClient;\n+\n+import de.tum.in.www1.artemis.config.Constants;\n+import de.tum.in.www1.artemis.exception.BambooException;\n+import de.tum.in.www1.artemis.service.connectors.bamboo.BambooBuildPlanUpdateProvider;\n+\n+@Service\n+// Only activate this service bean, if both Bamboo and Bitbucket are activated (@Profile({\"bitbucket\",\"bamboo\"}) would activate\n+// this if any profile is active (OR). We want both (AND)\n+@Profile(\"bamboo & bitbucket\")\n+public class BitbucketBambooUpdateService implements ContinuousIntegrationUpdateService {\n+\n+    @Value(\"${artemis.version-control.url}\")\n+    private URL BITBUCKET_SERVER;\n+\n+    private final Logger log = LoggerFactory.getLogger(BitbucketBambooUpdateService.class);\n+\n+    private final BambooClient bambooClient;\n+\n+    private final BambooBuildPlanUpdateProvider bambooBuildPlanUpdateProvider;\n+\n+    public BitbucketBambooUpdateService(BambooClient bambooClient, BambooBuildPlanUpdateProvider bambooBuildPlanUpdateProvider) {\n+        this.bambooClient = bambooClient;\n+        this.bambooBuildPlanUpdateProvider = bambooBuildPlanUpdateProvider;\n+    }\n+\n+    @Override\n+    public void updatePlanRepository(String bambooProject, String planKey, String bambooRepositoryName, String bitbucketProject, String bitbucketRepository,\n+            Optional<List<String>> triggeredBy) {\n+        try {\n+            log.debug(\"Update plan repository for build plan \" + planKey);\n+            com.appfire.bamboo.cli.objects.RemoteRepository bambooRemoteRepository = bambooClient.getRepositoryHelper().getRemoteRepository(bambooRepositoryName, planKey, false);\n+            // Workaround for old exercises which used a different repositoryName\n+            if (bambooRemoteRepository == null) {\n+                bambooRemoteRepository = bambooClient.getRepositoryHelper().getRemoteRepository(\"Assignment\", planKey, false);\n+                if (bambooRemoteRepository == null) {\n+                    throw new BambooException(\"Something went wrong while updating the template repository of the build plan \" + planKey\n+                            + \" to the student repository : Could not find assignment nor Assignment repository\");\n+                }\n+            }\n+\n+            bambooBuildPlanUpdateProvider.updateRepository(bambooRemoteRepository, bitbucketRepository, bitbucketProject, planKey);\n+\n+            // Overwrite triggers if needed, incl workaround for different repo names\n+            if (triggeredBy.isPresent() && bambooRemoteRepository.getName().equals(\"Assignment\")) {\n+                triggeredBy = Optional.of(triggeredBy.get().stream().map(trigger -> trigger.replace(Constants.ASSIGNMENT_REPO_NAME, \"Assignment\")).collect(Collectors.toList()));\n+            }\n+            triggeredBy.ifPresent(repoTriggers -> overwriteTriggers(planKey, bambooClient, repoTriggers));\n+\n+            log.info(\"Update plan repository for build plan \" + planKey + \" was successful\");\n+        }\n+        catch (CliClient.ClientException | CliClient.RemoteRestException e) {\n+            throw new BambooException(\"Something went wrong while updating the template repository of the build plan \" + planKey + \" to the student repository : \" + e.getMessage(),\n+                    e);\n+        }\n+    }\n+\n+    private void overwriteTriggers(final String planKey, final BambooClient bambooClient, final List<String> triggeredBy) {\n+        try {\n+            final var triggersString = bambooClient.getTriggerHelper().getTriggerList(planKey, null, null, 99, Pattern.compile(\".*\"));\n+            // Bamboo CLI returns a weird String, which is the reason for this way of parsing it\n+            final var oldTriggers = Arrays.stream(triggersString.split(\"\\n\")).map(trigger -> trigger.replace(\"\\\"\", \"\").split(\",\"))\n+                    .filter(trigger -> trigger.length > 2 && NumberUtils.isCreatable(trigger[1])).map(trigger -> Long.parseLong(trigger[1])).collect(Collectors.toSet());\n+\n+            // Remove all old triggers\n+            for (final var triggerId : oldTriggers) {\n+                bambooClient.getTriggerHelper().removeTrigger(planKey, null, null, triggerId, null, false);\n+            }\n+\n+            // Add new triggers\n+            for (final var repo : triggeredBy) {\n+                bambooClient.getTriggerHelper().addTrigger(planKey, null, \"remoteBitbucketServer\", null, null, repo, null, null, false);\n+            }\n+        }\n+        catch (CliClient.ClientException | CliClient.RemoteRestException e) {\n+            throw new BambooException(\"Unable to overwrite triggers for \" + planKey + \"\\n\" + e.getMessage(), e);\n+        }\n+    }\n+\n+    @Override\n+    public void triggerUpdate(String buildPlanId, boolean initialBuild) {\n+        // NOT NEEDED", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc2MzMxNg=="}, "originalCommit": {"oid": "ea73700f3f0e069dac3d39a4a51371a2ee899925"}, "originalPosition": 99}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0NjY2NTc4OnYy", "diffSide": "RIGHT", "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/bamboo/BambooBuildPlanUpdateProvider.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNDoxMTo0OVrOFa6czQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNToyODo0OFrOFa8yKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc2NDk0MQ==", "bodyText": "Could you add a link to the source?", "url": "https://github.com/ls1intum/Artemis/pull/1169#discussion_r363764941", "createdAt": "2020-01-07T14:11:49Z", "author": {"login": "madwau"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/bamboo/BambooBuildPlanUpdateProvider.java", "diffHunk": "@@ -0,0 +1,122 @@\n+package de.tum.in.www1.artemis.service.connectors.bamboo;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import javax.annotation.Nonnull;\n+\n+import org.json.simple.JSONObject;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.stereotype.Component;\n+\n+import com.appfire.bamboo.cli.BambooClient;\n+import com.appfire.common.cli.CliClient;\n+import com.appfire.common.cli.CliUtils;\n+import com.appfire.common.cli.JsonUtils;\n+import com.appfire.common.cli.objects.RemoteApplicationLink;\n+import com.appfire.common.cli.requesthelpers.DefaultRequestHelper;\n+\n+@Component\n+@Profile(\"bamboo\")\n+public class BambooBuildPlanUpdateProvider {\n+\n+    private final BambooClient bambooClient;\n+\n+    public BambooBuildPlanUpdateProvider(BambooClient bambooClient) {\n+        this.bambooClient = bambooClient;\n+    }\n+\n+    public void updateRepository(@Nonnull com.appfire.bamboo.cli.objects.RemoteRepository bambooRemoteRepository, String bitbucketRepositoryName, String bitbucketProjectKey,\n+            String completePlanName) throws CliClient.ClientException, CliClient.RemoteRestException {\n+\n+        Map<String, String> parameters = new HashMap<>();\n+        parameters.put(\"planKey\", completePlanName);\n+\n+        bambooClient.getRepositoryHelper().addRepositoryDetails(bambooRemoteRepository);\n+\n+        parameters.put(\"selectedRepository\", \"com.atlassian.bamboo.plugins.stash.atlassian-bamboo-plugin-stash:stash-rep\");\n+        // IMPORTANT: Don't change the name of the repo! We depend on the naming (assignment, tests) in some other parts of the application\n+        parameters.put(\"repositoryName\", bambooRemoteRepository.getName());\n+        parameters.put(\"repositoryId\", Long.toString(bambooRemoteRepository.getId()));\n+        parameters.put(\"confirm\", \"true\");\n+        parameters.put(\"save\", \"Save repository\");\n+        parameters.put(\"bamboo.successReturnMode\", \"json\");\n+        parameters.put(\"repository.stash.branch\", \"master\");\n+\n+        com.appfire.bitbucket.cli.objects.RemoteRepository bitbucketRepository;\n+        try {\n+            bitbucketRepository = bambooClient.getBitbucketClient().getRepositoryHelper().getRemoteRepository(bitbucketProjectKey, bitbucketRepositoryName, true);\n+        }\n+        catch (CliClient.ClientException | CliClient.RemoteRestException ex) {\n+            throw new CliClient.ClientException(\"Bitbucket failed trying to get repository details: \" + ex.getMessage());\n+        }\n+\n+        RemoteApplicationLink link = bambooClient.getBitbucketClient().getApplicationLink();\n+        if (link == null) {\n+            link = bambooClient.getApplicationLinksRequestHelper().getApplicationLink(bambooClient.getString(\"targetServer\"), \"stash\", true);\n+        }\n+\n+        if (link != null) {\n+            parameters.put(\"repository.stash.server\", link.getId());\n+        }\n+\n+        parameters.put(\"repository.stash.repositoryId\", bitbucketRepository.getIdString());\n+        parameters.put(\"repository.stash.repositorySlug\", bitbucketRepository.getSlug());\n+        parameters.put(\"repository.stash.projectKey\", bitbucketRepository.getProject());\n+        parameters.put(\"repository.stash.repositoryUrl\", bitbucketRepository.getCloneSshUrl());\n+\n+        String responseData = \"\";\n+\n+        try {\n+\n+            DefaultRequestHelper helper = bambooClient.getPseudoRequestHelper();\n+            helper.setRequestType(DefaultRequestHelper.RequestType.POST);\n+            helper.setContentType(DefaultRequestHelper.RequestContentType.JSON);\n+            helper.setParameters(parameters);\n+            helper.makeRequest(\"/chain/admin/config/updateRepository.action\");\n+            responseData = helper.getResponseData();\n+\n+        }\n+        catch (CliClient.RemoteInternalServerErrorException ex) {\n+            String message = \"Request failed on the server with response code 500. Make sure all required fields have been provided using the various field and value parameters. \"\n+                    + \"The server log may provide insight into missing fields: \" + ex.getMessage();\n+            throw new CliClient.ClientException(message);\n+        }\n+\n+        JSONObject json = bambooClient.getJsonWithVerboseLogging(responseData);\n+        JSONObject repositoryJson = JsonUtils.getJsonOrNull(JsonUtils.getStringOrNull(json, \"repositoryResult\"));\n+        if (repositoryJson == null) {\n+            String error = checkForError(responseData);\n+            throw new CliClient.ClientException(error.equals(\"\") ? \"Unknown error occurred.\" : error);\n+        }\n+    }\n+\n+    /**\n+     * This method was taken from RepositoryHelper of the Bamboo CLI Plugin", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea73700f3f0e069dac3d39a4a51371a2ee899925"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgwMzE3OA==", "bodyText": "I added an @see link in the JavaDoc", "url": "https://github.com/ls1intum/Artemis/pull/1169#discussion_r363803178", "createdAt": "2020-01-07T15:28:48Z", "author": {"login": "ungaralex"}, "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/bamboo/BambooBuildPlanUpdateProvider.java", "diffHunk": "@@ -0,0 +1,122 @@\n+package de.tum.in.www1.artemis.service.connectors.bamboo;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import javax.annotation.Nonnull;\n+\n+import org.json.simple.JSONObject;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.stereotype.Component;\n+\n+import com.appfire.bamboo.cli.BambooClient;\n+import com.appfire.common.cli.CliClient;\n+import com.appfire.common.cli.CliUtils;\n+import com.appfire.common.cli.JsonUtils;\n+import com.appfire.common.cli.objects.RemoteApplicationLink;\n+import com.appfire.common.cli.requesthelpers.DefaultRequestHelper;\n+\n+@Component\n+@Profile(\"bamboo\")\n+public class BambooBuildPlanUpdateProvider {\n+\n+    private final BambooClient bambooClient;\n+\n+    public BambooBuildPlanUpdateProvider(BambooClient bambooClient) {\n+        this.bambooClient = bambooClient;\n+    }\n+\n+    public void updateRepository(@Nonnull com.appfire.bamboo.cli.objects.RemoteRepository bambooRemoteRepository, String bitbucketRepositoryName, String bitbucketProjectKey,\n+            String completePlanName) throws CliClient.ClientException, CliClient.RemoteRestException {\n+\n+        Map<String, String> parameters = new HashMap<>();\n+        parameters.put(\"planKey\", completePlanName);\n+\n+        bambooClient.getRepositoryHelper().addRepositoryDetails(bambooRemoteRepository);\n+\n+        parameters.put(\"selectedRepository\", \"com.atlassian.bamboo.plugins.stash.atlassian-bamboo-plugin-stash:stash-rep\");\n+        // IMPORTANT: Don't change the name of the repo! We depend on the naming (assignment, tests) in some other parts of the application\n+        parameters.put(\"repositoryName\", bambooRemoteRepository.getName());\n+        parameters.put(\"repositoryId\", Long.toString(bambooRemoteRepository.getId()));\n+        parameters.put(\"confirm\", \"true\");\n+        parameters.put(\"save\", \"Save repository\");\n+        parameters.put(\"bamboo.successReturnMode\", \"json\");\n+        parameters.put(\"repository.stash.branch\", \"master\");\n+\n+        com.appfire.bitbucket.cli.objects.RemoteRepository bitbucketRepository;\n+        try {\n+            bitbucketRepository = bambooClient.getBitbucketClient().getRepositoryHelper().getRemoteRepository(bitbucketProjectKey, bitbucketRepositoryName, true);\n+        }\n+        catch (CliClient.ClientException | CliClient.RemoteRestException ex) {\n+            throw new CliClient.ClientException(\"Bitbucket failed trying to get repository details: \" + ex.getMessage());\n+        }\n+\n+        RemoteApplicationLink link = bambooClient.getBitbucketClient().getApplicationLink();\n+        if (link == null) {\n+            link = bambooClient.getApplicationLinksRequestHelper().getApplicationLink(bambooClient.getString(\"targetServer\"), \"stash\", true);\n+        }\n+\n+        if (link != null) {\n+            parameters.put(\"repository.stash.server\", link.getId());\n+        }\n+\n+        parameters.put(\"repository.stash.repositoryId\", bitbucketRepository.getIdString());\n+        parameters.put(\"repository.stash.repositorySlug\", bitbucketRepository.getSlug());\n+        parameters.put(\"repository.stash.projectKey\", bitbucketRepository.getProject());\n+        parameters.put(\"repository.stash.repositoryUrl\", bitbucketRepository.getCloneSshUrl());\n+\n+        String responseData = \"\";\n+\n+        try {\n+\n+            DefaultRequestHelper helper = bambooClient.getPseudoRequestHelper();\n+            helper.setRequestType(DefaultRequestHelper.RequestType.POST);\n+            helper.setContentType(DefaultRequestHelper.RequestContentType.JSON);\n+            helper.setParameters(parameters);\n+            helper.makeRequest(\"/chain/admin/config/updateRepository.action\");\n+            responseData = helper.getResponseData();\n+\n+        }\n+        catch (CliClient.RemoteInternalServerErrorException ex) {\n+            String message = \"Request failed on the server with response code 500. Make sure all required fields have been provided using the various field and value parameters. \"\n+                    + \"The server log may provide insight into missing fields: \" + ex.getMessage();\n+            throw new CliClient.ClientException(message);\n+        }\n+\n+        JSONObject json = bambooClient.getJsonWithVerboseLogging(responseData);\n+        JSONObject repositoryJson = JsonUtils.getJsonOrNull(JsonUtils.getStringOrNull(json, \"repositoryResult\"));\n+        if (repositoryJson == null) {\n+            String error = checkForError(responseData);\n+            throw new CliClient.ClientException(error.equals(\"\") ? \"Unknown error occurred.\" : error);\n+        }\n+    }\n+\n+    /**\n+     * This method was taken from RepositoryHelper of the Bamboo CLI Plugin", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc2NDk0MQ=="}, "originalCommit": {"oid": "ea73700f3f0e069dac3d39a4a51371a2ee899925"}, "originalPosition": 97}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0OTI2NzY2OnYy", "diffSide": "RIGHT", "path": "src/main/java/de/tum/in/www1/artemis/config/connector/BitbucketServerConfiguration.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxMDo1OTozMlrOFbTebQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxMDo1OTozMlrOFbTebQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDE3NDk1Nw==", "bodyText": "At the moment, it seems that we don't really need this class.", "url": "https://github.com/ls1intum/Artemis/pull/1169#discussion_r364174957", "createdAt": "2020-01-08T10:59:32Z", "author": {"login": "krusche"}, "path": "src/main/java/de/tum/in/www1/artemis/config/connector/BitbucketServerConfiguration.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package de.tum.in.www1.artemis.config.connector;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.PrintStream;\n+import java.net.URL;\n+\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.Profile;\n+\n+import com.appfire.bitbucket.cli.BitbucketClient;\n+import com.appfire.common.cli.Base;\n+import com.appfire.common.cli.Settings;\n+\n+@Configuration\n+@Profile(\"bitbucket\")\n+public class BitbucketServerConfiguration {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ecca1f2ffdc1362aac99bdcd1f4f5c2529d2cbc"}, "originalPosition": 18}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 165, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}