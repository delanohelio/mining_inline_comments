{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwMjk5OTQ3", "number": 849, "title": "PARQUET-1954: TCP connection leak in parquet dump", "bodyText": "Make sure you have checked all steps below.\nJira\nMy PR addresses the following PARQUET-1954\nTests\ndoes not need testing", "createdAt": "2020-12-15T14:39:26Z", "url": "https://github.com/apache/parquet-mr/pull/849", "merged": true, "mergeCommit": {"oid": "74af3a8a5404e3a56d3d8d6bf3ebc8c09ff5fa1d"}, "closed": true, "closedAt": "2021-01-05T10:50:17Z", "author": {"login": "StefanXiepj"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmaP4RAH2gAyNTQwMjk5OTQ3OjAyOWFlOWE3Nzk5YmRiN2Y3NTVhN2ExNzdkNzUwNzMzYzJlYzcyNzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABds4NbLgFqTU2MTEyNjYyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "029ae9a7799bdb7f755a7a177d750733c2ec7271", "author": {"user": null}, "url": "https://github.com/apache/parquet-mr/commit/029ae9a7799bdb7f755a7a177d750733c2ec7271", "committedDate": "2020-12-15T13:21:14Z", "message": "PARQUET-1954: TCP connection leak in parquet dump"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNjI5OTg3", "url": "https://github.com/apache/parquet-mr/pull/849#pullrequestreview-552629987", "createdAt": "2020-12-15T16:18:10Z", "commit": {"oid": "029ae9a7799bdb7f755a7a177d750733c2ec7271"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNjoxODoxMFrOIGTvrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNjoxODoxMFrOIGTvrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ4NTg3MQ==", "bodyText": "If an I/O exception occurs in the ParquetFileReader constructor then you might try to close the previous reader object. I would guess there is no problem with invoking close multiple times on the same object but who knows? It might be a good idea to reset the reference so you would not close the same object again. Another idea would be to use try-with-resources for the code part where the reader is really needed.", "url": "https://github.com/apache/parquet-mr/pull/849#discussion_r543485871", "createdAt": "2020-12-15T16:18:10Z", "author": {"login": "gszadovszky"}, "path": "parquet-tools/src/main/java/org/apache/parquet/tools/command/DumpCommand.java", "diffHunk": "@@ -165,48 +165,47 @@ public static void dump(PrettyPrintWriter out, ParquetMetadata meta, MessageType\n \n         ParquetFileReader freader = null;\n         if (showmd) {\n+          long group = 0;\n+          for (BlockMetaData block : blocks) {\n             try {\n-                long group = 0;\n-                for (BlockMetaData block : blocks) {\n-                    if (group != 0) out.println();\n-                    out.format(\"row group %d%n\", group++);\n-                    out.rule('-');\n-\n-\n-                    List<ColumnChunkMetaData> ccmds = block.getColumns();\n-                    if (showColumns != null) {\n-                        ccmds = new ArrayList<ColumnChunkMetaData>();\n-                        for (ColumnChunkMetaData ccmd : block.getColumns()) {\n-                            String path = Joiner.on('.').skipNulls().join(ccmd.getPath().toArray());\n-                            if (showColumns.contains(path)) {\n-                                ccmds.add(ccmd);\n-                            }\n-                        }\n-                    }\n-\n-                    MetadataUtils.showDetails(out, ccmds);\n+              if (group != 0)\n+                out.println();\n+              out.format(\"row group %d%n\", group++);\n+              out.rule('-');\n+\n+              List<ColumnChunkMetaData> ccmds = block.getColumns();\n+              if (showColumns != null) {\n+                ccmds = new ArrayList<ColumnChunkMetaData>();\n+                for (ColumnChunkMetaData ccmd : block.getColumns()) {\n+                  String path = Joiner.on('.').skipNulls().join(ccmd.getPath().toArray());\n+                  if (showColumns.contains(path)) {\n+                    ccmds.add(ccmd);\n+                  }\n+                }\n+              }\n \n-                    List<BlockMetaData> rblocks = Collections.singletonList(block);\n-                    freader = new ParquetFileReader(\n-                        conf, meta.getFileMetaData(), inpath, rblocks, columns);\n-                    PageReadStore store = freader.readNextRowGroup();\n-                    while (store != null) {\n-                        out.incrementTabLevel();\n-                        for (ColumnDescriptor column : columns) {\n-                            out.println();\n-                            dump(out, store, column);\n-                        }\n-                        out.decrementTabLevel();\n+              MetadataUtils.showDetails(out, ccmds);\n \n-                        store = freader.readNextRowGroup();\n-                    }\n-                    out.flushColumns();\n+              List<BlockMetaData> rblocks = Collections.singletonList(block);\n+              freader = new ParquetFileReader(conf, meta.getFileMetaData(), inpath, rblocks, columns);\n+              PageReadStore store = freader.readNextRowGroup();\n+              while (store != null) {\n+                out.incrementTabLevel();\n+                for (ColumnDescriptor column : columns) {\n+                  out.println();\n+                  dump(out, store, column);\n                 }\n+                out.decrementTabLevel();\n+\n+                store = freader.readNextRowGroup();\n+              }\n+              out.flushColumns();\n             } finally {\n-                if (freader != null) {\n-                    freader.close();\n-                }\n+              if (freader != null) {\n+                freader.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "029ae9a7799bdb7f755a7a177d750733c2ec7271"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "511b4e8893fd164b9a238620a1dd14a9508a5635", "author": {"user": null}, "url": "https://github.com/apache/parquet-mr/commit/511b4e8893fd164b9a238620a1dd14a9508a5635", "committedDate": "2020-12-17T03:31:36Z", "message": "reset freader is null, avoid closing a reader twice"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1de703df6ef9046cf3d5a62f8ae4a293a5c1dce5", "author": {"user": null}, "url": "https://github.com/apache/parquet-mr/commit/1de703df6ef9046cf3d5a62f8ae4a293a5c1dce5", "committedDate": "2020-12-29T06:55:09Z", "message": "using the try-with-resource pattern"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxMTI2NjI5", "url": "https://github.com/apache/parquet-mr/pull/849#pullrequestreview-561126629", "createdAt": "2021-01-04T15:39:15Z", "commit": {"oid": "1de703df6ef9046cf3d5a62f8ae4a293a5c1dce5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2143, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}