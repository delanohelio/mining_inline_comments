{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxMTA1MDk5", "number": 774, "title": "PARQUET-1821: Add 'column-size' command to parquet-cli and parquet-tools", "bodyText": "Make sure you have checked all steps below.\nJira\n\n My PR addresses the following Parquet Jira issues and references them in the PR title. For example, \"PARQUET-1234: My Parquet PR\"\n\nhttps://issues.apache.org/jira/browse/PARQUET-XXX\nIn case you are adding a dependency, check if the license complies with the ASF 3rd Party License Policy.\n\n\n\nTests\n\n My PR adds the following unit tests OR does not need testing for this extremely good reason:\n\nCommits\n\n My commits all reference Jira issues in their subject lines. In addition, my commits follow the guidelines from \"How to write a good git commit message\":\n\nSubject is separated from body by a blank line\nSubject is limited to 50 characters (not including Jira issue reference)\nSubject does not end with a period\nSubject uses the imperative mood (\"add\", not \"adding\")\nBody wraps at 72 characters\nBody explains \"what\" and \"why\", not \"how\"\n\n\n\nDocumentation\n\n In case of new functionality, my PR adds documentation that describes how to use it.\n\nAll the public functions and the classes in the PR contain Javadoc that explain what it does", "createdAt": "2020-03-19T16:25:37Z", "url": "https://github.com/apache/parquet-mr/pull/774", "merged": true, "mergeCommit": {"oid": "d00b2f105f9f732e310ed43c7bfb318213e1ac81"}, "closed": true, "closedAt": "2020-04-01T09:49:47Z", "author": {"login": "shangxinli"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPgtijgBqjMxNDkzNzAyMTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcS98G_gFqTM4NDQ2NDk4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d4d067ea9ba64f2b481ffbb7431c0990ccdd98de", "author": {"user": {"login": "shangxinli", "name": "Xinli Shang"}}, "url": "https://github.com/apache/parquet-mr/commit/d4d067ea9ba64f2b481ffbb7431c0990ccdd98de", "committedDate": "2020-03-19T16:24:22Z", "message": "PARQUET-1821: Add 'column-size' command to parquet-cli and parquet-tools"}, "afterCommit": {"oid": "f12c04b9bba3fb6274308f587cd3634fc9c6308d", "author": {"user": {"login": "shangxinli", "name": "Xinli Shang"}}, "url": "https://github.com/apache/parquet-mr/commit/f12c04b9bba3fb6274308f587cd3634fc9c6308d", "committedDate": "2020-03-20T13:41:08Z", "message": "PARQUET-1821: Add 'column-size' command to parquet-cli and parquet-tools"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "15a4108363cca220d88c60d1038b0eca957a074d", "author": {"user": {"login": "shangxinli", "name": "Xinli Shang"}}, "url": "https://github.com/apache/parquet-mr/commit/15a4108363cca220d88c60d1038b0eca957a074d", "committedDate": "2020-03-20T13:43:42Z", "message": "revert change"}, "afterCommit": {"oid": "30e451b80fd81433ddabeb666bda89ab8b43d50c", "author": {"user": {"login": "shangxinli", "name": "Xinli Shang"}}, "url": "https://github.com/apache/parquet-mr/commit/30e451b80fd81433ddabeb666bda89ab8b43d50c", "committedDate": "2020-03-20T13:44:18Z", "message": "PARQUET-1821: Add 'column-size' command to parquet-cli and parquet-tools"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "749e5dfff61e1dbbe050dc9ad6916f366bbd8b08", "author": {"user": {"login": "shangxinli", "name": "Xinli Shang"}}, "url": "https://github.com/apache/parquet-mr/commit/749e5dfff61e1dbbe050dc9ad6916f366bbd8b08", "committedDate": "2020-03-20T14:09:00Z", "message": "PARQUET-1821: Add 'column-size' command to parquet-cli and parquet-tools"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "30e451b80fd81433ddabeb666bda89ab8b43d50c", "author": {"user": {"login": "shangxinli", "name": "Xinli Shang"}}, "url": "https://github.com/apache/parquet-mr/commit/30e451b80fd81433ddabeb666bda89ab8b43d50c", "committedDate": "2020-03-20T13:44:18Z", "message": "PARQUET-1821: Add 'column-size' command to parquet-cli and parquet-tools"}, "afterCommit": {"oid": "749e5dfff61e1dbbe050dc9ad6916f366bbd8b08", "author": {"user": {"login": "shangxinli", "name": "Xinli Shang"}}, "url": "https://github.com/apache/parquet-mr/commit/749e5dfff61e1dbbe050dc9ad6916f366bbd8b08", "committedDate": "2020-03-20T14:09:00Z", "message": "PARQUET-1821: Add 'column-size' command to parquet-cli and parquet-tools"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxODU1OTAx", "url": "https://github.com/apache/parquet-mr/pull/774#pullrequestreview-381855901", "createdAt": "2020-03-26T10:01:14Z", "commit": {"oid": "749e5dfff61e1dbbe050dc9ad6916f366bbd8b08"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMDowMToxNFrOF7_Wig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMDo0MDoxNVrOF8A0Zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ0ODI2Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // If user inputted columns, only print out size for those columns\n          \n          \n            \n                // If user defined columns, only print out size for those columns", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r398448266", "createdAt": "2020-03-26T10:01:14Z", "author": {"login": "gszadovszky"}, "path": "parquet-cli/src/main/java/org/apache/parquet/cli/commands/ColumnSizeCommand.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.parquet.cli.commands;\n+\n+import com.beust.jcommander.Parameter;\n+import com.beust.jcommander.Parameters;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.Lists;\n+import org.apache.avro.file.SeekableInput;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.parquet.cli.BaseCommand;\n+import org.apache.parquet.cli.util.Formats;\n+import org.apache.parquet.format.converter.ParquetMetadataConverter;\n+import org.apache.parquet.hadoop.ParquetFileReader;\n+import org.apache.parquet.hadoop.metadata.BlockMetaData;\n+import org.apache.parquet.hadoop.metadata.ColumnChunkMetaData;\n+import org.apache.parquet.hadoop.metadata.ParquetMetadata;\n+import org.slf4j.Logger;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+@Parameters(commandDescription=\"Print the column sizes of a parquet file\")\n+public class ColumnSizeCommand extends BaseCommand {\n+\n+  public ColumnSizeCommand(Logger console) {\n+    super(console);\n+  }\n+\n+  @Parameter(description = \"<parquet path>\")\n+  String target;\n+\n+  @Parameter(\n+    names = {\"-c\", \"--column\", \"--columns\"},\n+    description = \"List of columns\",\n+    required = false)\n+  List<String> columns;\n+\n+  @Override\n+  @SuppressWarnings(\"unchecked\")\n+  public int run() throws IOException {\n+    Preconditions.checkArgument(target != null,\n+      \"A Parquet file is required.\");\n+\n+    Path inputFile = new Path(target);\n+    Map<String, Long> columnSizes = getColumnSizeInBytes(inputFile);\n+    Map<String, Float> columnPercentage = getColumnPercentage(columnSizes);\n+\n+    // If user inputted columns, only print out size for those columns", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "749e5dfff61e1dbbe050dc9ad6916f366bbd8b08"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ1ODQzMw==", "bodyText": "I think this behavior is misleading. What if the columns in the file are id and identity and you want to query the size of the column id?\nI would suggest checking equality and simply print the result instead of summarizing.", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r398458433", "createdAt": "2020-03-26T10:17:39Z", "author": {"login": "gszadovszky"}, "path": "parquet-cli/src/main/java/org/apache/parquet/cli/commands/ColumnSizeCommand.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.parquet.cli.commands;\n+\n+import com.beust.jcommander.Parameter;\n+import com.beust.jcommander.Parameters;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.Lists;\n+import org.apache.avro.file.SeekableInput;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.parquet.cli.BaseCommand;\n+import org.apache.parquet.cli.util.Formats;\n+import org.apache.parquet.format.converter.ParquetMetadataConverter;\n+import org.apache.parquet.hadoop.ParquetFileReader;\n+import org.apache.parquet.hadoop.metadata.BlockMetaData;\n+import org.apache.parquet.hadoop.metadata.ColumnChunkMetaData;\n+import org.apache.parquet.hadoop.metadata.ParquetMetadata;\n+import org.slf4j.Logger;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+@Parameters(commandDescription=\"Print the column sizes of a parquet file\")\n+public class ColumnSizeCommand extends BaseCommand {\n+\n+  public ColumnSizeCommand(Logger console) {\n+    super(console);\n+  }\n+\n+  @Parameter(description = \"<parquet path>\")\n+  String target;\n+\n+  @Parameter(\n+    names = {\"-c\", \"--column\", \"--columns\"},\n+    description = \"List of columns\",\n+    required = false)\n+  List<String> columns;\n+\n+  @Override\n+  @SuppressWarnings(\"unchecked\")\n+  public int run() throws IOException {\n+    Preconditions.checkArgument(target != null,\n+      \"A Parquet file is required.\");\n+\n+    Path inputFile = new Path(target);\n+    Map<String, Long> columnSizes = getColumnSizeInBytes(inputFile);\n+    Map<String, Float> columnPercentage = getColumnPercentage(columnSizes);\n+\n+    // If user inputted columns, only print out size for those columns\n+    if (columns != null && columns.size() > 0) {\n+      for (String inputColumn : columns) {\n+        long size = 0;\n+        float percentage = 0;\n+        for (String column : columnSizes.keySet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "749e5dfff61e1dbbe050dc9ad6916f366bbd8b08"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ2MjA5Mg==", "bodyText": "I think, one of -c, --column or --columns is missing from here", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r398462092", "createdAt": "2020-03-26T10:23:26Z", "author": {"login": "gszadovszky"}, "path": "parquet-cli/src/main/java/org/apache/parquet/cli/commands/ColumnSizeCommand.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.parquet.cli.commands;\n+\n+import com.beust.jcommander.Parameter;\n+import com.beust.jcommander.Parameters;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.Lists;\n+import org.apache.avro.file.SeekableInput;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.parquet.cli.BaseCommand;\n+import org.apache.parquet.cli.util.Formats;\n+import org.apache.parquet.format.converter.ParquetMetadataConverter;\n+import org.apache.parquet.hadoop.ParquetFileReader;\n+import org.apache.parquet.hadoop.metadata.BlockMetaData;\n+import org.apache.parquet.hadoop.metadata.ColumnChunkMetaData;\n+import org.apache.parquet.hadoop.metadata.ParquetMetadata;\n+import org.slf4j.Logger;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+@Parameters(commandDescription=\"Print the column sizes of a parquet file\")\n+public class ColumnSizeCommand extends BaseCommand {\n+\n+  public ColumnSizeCommand(Logger console) {\n+    super(console);\n+  }\n+\n+  @Parameter(description = \"<parquet path>\")\n+  String target;\n+\n+  @Parameter(\n+    names = {\"-c\", \"--column\", \"--columns\"},\n+    description = \"List of columns\",\n+    required = false)\n+  List<String> columns;\n+\n+  @Override\n+  @SuppressWarnings(\"unchecked\")\n+  public int run() throws IOException {\n+    Preconditions.checkArgument(target != null,\n+      \"A Parquet file is required.\");\n+\n+    Path inputFile = new Path(target);\n+    Map<String, Long> columnSizes = getColumnSizeInBytes(inputFile);\n+    Map<String, Float> columnPercentage = getColumnPercentage(columnSizes);\n+\n+    // If user inputted columns, only print out size for those columns\n+    if (columns != null && columns.size() > 0) {\n+      for (String inputColumn : columns) {\n+        long size = 0;\n+        float percentage = 0;\n+        for (String column : columnSizes.keySet()) {\n+          if (column.startsWith(inputColumn)) {\n+            size += columnSizes.get(column);\n+            percentage += columnPercentage.get(column);\n+          }\n+        }\n+        console.info(inputColumn + \"->\" + \" Size In Bytes: \" + size + \" Size In Percentage: \" + percentage);\n+      }\n+    } else {\n+      for (String column : columnSizes.keySet()) {\n+        console.info(column + \"->\" + \" Size In Bytes: \" + columnSizes.get(column)\n+          + \" Size In Percentage: \" + columnPercentage.get(column));\n+      }\n+    }\n+\n+    return 0;\n+  }\n+\n+  @Override\n+  public List<String> getExamples() {\n+    return Lists.newArrayList(\n+        \"# Print every column size in byte and percentage for a Parquet file\",\n+        \"sample.parquet\",\n+        \"sample.parquet col_1 col_2\",\n+        \"sample.parquet col_1 col_2.sub_col_a\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "749e5dfff61e1dbbe050dc9ad6916f366bbd8b08"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ2Njg2MQ==", "bodyText": "This is not percentage but ratio.", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r398466861", "createdAt": "2020-03-26T10:31:17Z", "author": {"login": "gszadovszky"}, "path": "parquet-cli/src/main/java/org/apache/parquet/cli/commands/ColumnSizeCommand.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.parquet.cli.commands;\n+\n+import com.beust.jcommander.Parameter;\n+import com.beust.jcommander.Parameters;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.Lists;\n+import org.apache.avro.file.SeekableInput;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.parquet.cli.BaseCommand;\n+import org.apache.parquet.cli.util.Formats;\n+import org.apache.parquet.format.converter.ParquetMetadataConverter;\n+import org.apache.parquet.hadoop.ParquetFileReader;\n+import org.apache.parquet.hadoop.metadata.BlockMetaData;\n+import org.apache.parquet.hadoop.metadata.ColumnChunkMetaData;\n+import org.apache.parquet.hadoop.metadata.ParquetMetadata;\n+import org.slf4j.Logger;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+@Parameters(commandDescription=\"Print the column sizes of a parquet file\")\n+public class ColumnSizeCommand extends BaseCommand {\n+\n+  public ColumnSizeCommand(Logger console) {\n+    super(console);\n+  }\n+\n+  @Parameter(description = \"<parquet path>\")\n+  String target;\n+\n+  @Parameter(\n+    names = {\"-c\", \"--column\", \"--columns\"},\n+    description = \"List of columns\",\n+    required = false)\n+  List<String> columns;\n+\n+  @Override\n+  @SuppressWarnings(\"unchecked\")\n+  public int run() throws IOException {\n+    Preconditions.checkArgument(target != null,\n+      \"A Parquet file is required.\");\n+\n+    Path inputFile = new Path(target);\n+    Map<String, Long> columnSizes = getColumnSizeInBytes(inputFile);\n+    Map<String, Float> columnPercentage = getColumnPercentage(columnSizes);\n+\n+    // If user inputted columns, only print out size for those columns\n+    if (columns != null && columns.size() > 0) {\n+      for (String inputColumn : columns) {\n+        long size = 0;\n+        float percentage = 0;\n+        for (String column : columnSizes.keySet()) {\n+          if (column.startsWith(inputColumn)) {\n+            size += columnSizes.get(column);\n+            percentage += columnPercentage.get(column);\n+          }\n+        }\n+        console.info(inputColumn + \"->\" + \" Size In Bytes: \" + size + \" Size In Percentage: \" + percentage);\n+      }\n+    } else {\n+      for (String column : columnSizes.keySet()) {\n+        console.info(column + \"->\" + \" Size In Bytes: \" + columnSizes.get(column)\n+          + \" Size In Percentage: \" + columnPercentage.get(column));\n+      }\n+    }\n+\n+    return 0;\n+  }\n+\n+  @Override\n+  public List<String> getExamples() {\n+    return Lists.newArrayList(\n+        \"# Print every column size in byte and percentage for a Parquet file\",\n+        \"sample.parquet\",\n+        \"sample.parquet col_1 col_2\",\n+        \"sample.parquet col_1 col_2.sub_col_a\"\n+    );\n+  }\n+\n+  // Make it public to allow some automation tools to call it\n+  public Map<String, Long> getColumnSizeInBytes(Path inputFile) throws IOException {\n+    Map<String, Long> colSizes = new HashMap<>();\n+    ParquetMetadata pmd = ParquetFileReader.readFooter(new Configuration(), inputFile, ParquetMetadataConverter.NO_FILTER);\n+\n+    for (BlockMetaData block : pmd.getBlocks()) {\n+      for (ColumnChunkMetaData column : block.getColumns()) {\n+        String colName = column.getPath().toDotString();\n+        colSizes.put(colName, column.getTotalSize() + colSizes.getOrDefault(colName, 0L));\n+      }\n+    }\n+\n+    return colSizes;\n+  }\n+\n+  // Make it public to allow some automation tools to call it\n+  public Map<String, Float> getColumnPercentage(Map<String, Long> colSizes) {\n+    long totalSize = colSizes.values().stream().reduce(0L, Long::sum);\n+    Map<String, Float> colPercentage = new HashMap<>();\n+\n+    for (Map.Entry<String, Long> entry : colSizes.entrySet()) {\n+      colPercentage.put(entry.getKey(), ((float) entry.getValue()) / ((float) totalSize));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "749e5dfff61e1dbbe050dc9ad6916f366bbd8b08"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ3MTA0Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                \"where <input> is the parquet file to calculate teh column size\" +\n          \n          \n            \n                \"     [<column> ...] are the columns in the case sensitive dot format\" +\n          \n          \n            \n                \"     to be calculated, for example a.b.c. If no columns are input, all the\" +\n          \n          \n            \n                \"     columns will be printed out\"\n          \n          \n            \n                \"where <input> is the parquet file to calculate the column size\" +\n          \n          \n            \n                \"     [<column> ...] are the columns in the case sensitive dot format\" +\n          \n          \n            \n                \"     to be calculated, for example a.b.c. If no columns are set, all the\" +\n          \n          \n            \n                \"     columns will be printed out\"", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r398471043", "createdAt": "2020-03-26T10:38:13Z", "author": {"login": "gszadovszky"}, "path": "parquet-tools/src/main/java/org/apache/parquet/tools/command/ColumnSizeCommand.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.parquet.tools.command;\n+\n+import org.apache.commons.cli.CommandLine;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.parquet.format.converter.ParquetMetadataConverter;\n+import org.apache.parquet.hadoop.ParquetFileReader;\n+import org.apache.parquet.hadoop.metadata.BlockMetaData;\n+import org.apache.parquet.hadoop.metadata.ColumnChunkMetaData;\n+import org.apache.parquet.hadoop.metadata.ParquetMetadata;\n+import org.apache.parquet.tools.Main;\n+\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class ColumnSizeCommand extends ArgsOnlyCommand {\n+\n+  public static final String[] USAGE = new String[] {\n+    \"<input>\",\n+    \"where <input> is the parquet file to calculate teh column size\" +\n+    \"     [<column> ...] are the columns in the case sensitive dot format\" +\n+    \"     to be calculated, for example a.b.c. If no columns are input, all the\" +\n+    \"     columns will be printed out\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "749e5dfff61e1dbbe050dc9ad6916f366bbd8b08"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ3MjE5Nw==", "bodyText": "See my comment at cli.", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r398472197", "createdAt": "2020-03-26T10:40:07Z", "author": {"login": "gszadovszky"}, "path": "parquet-tools/src/main/java/org/apache/parquet/tools/command/ColumnSizeCommand.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.parquet.tools.command;\n+\n+import org.apache.commons.cli.CommandLine;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.parquet.format.converter.ParquetMetadataConverter;\n+import org.apache.parquet.hadoop.ParquetFileReader;\n+import org.apache.parquet.hadoop.metadata.BlockMetaData;\n+import org.apache.parquet.hadoop.metadata.ColumnChunkMetaData;\n+import org.apache.parquet.hadoop.metadata.ParquetMetadata;\n+import org.apache.parquet.tools.Main;\n+\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class ColumnSizeCommand extends ArgsOnlyCommand {\n+\n+  public static final String[] USAGE = new String[] {\n+    \"<input>\",\n+    \"where <input> is the parquet file to calculate teh column size\" +\n+    \"     [<column> ...] are the columns in the case sensitive dot format\" +\n+    \"     to be calculated, for example a.b.c. If no columns are input, all the\" +\n+    \"     columns will be printed out\"\n+  };\n+\n+  /**\n+   * Biggest number of columns we can calculate.\n+   */\n+  private static final int MAX_COL_NUM = 100;\n+\n+  public ColumnSizeCommand() {\n+    super(1, 1 + MAX_COL_NUM);\n+  }\n+\n+  @Override\n+  public String[] getUsageDescription() {\n+    return USAGE;\n+  }\n+\n+  @Override\n+  public String getCommandDescription() {\n+    return \"Print out the size in bytes and percentage of column(s) in the input Parquet file\";\n+  }\n+\n+  @Override\n+  public void execute(CommandLine options) throws Exception {\n+    super.execute(options);\n+    List<String> args = options.getArgList();\n+    Path inputFile = new Path(args.get(0));\n+\n+    Map<String, Long> columnSizes = getColumnSizeInBytes(inputFile);\n+    Map<String, Float> columnPercentage = getColumnPercentage(columnSizes);\n+\n+    if (args.size() > 1) {\n+      for (String inputColumn : args.subList(1, args.size())) {\n+        long size = 0;\n+        float percentage = 0;\n+        for (String column : columnSizes.keySet()) {\n+          if (column.startsWith(inputColumn)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "749e5dfff61e1dbbe050dc9ad6916f366bbd8b08"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ3MjI5NA==", "bodyText": "See my comment at cli.", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r398472294", "createdAt": "2020-03-26T10:40:15Z", "author": {"login": "gszadovszky"}, "path": "parquet-tools/src/main/java/org/apache/parquet/tools/command/ColumnSizeCommand.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.parquet.tools.command;\n+\n+import org.apache.commons.cli.CommandLine;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.parquet.format.converter.ParquetMetadataConverter;\n+import org.apache.parquet.hadoop.ParquetFileReader;\n+import org.apache.parquet.hadoop.metadata.BlockMetaData;\n+import org.apache.parquet.hadoop.metadata.ColumnChunkMetaData;\n+import org.apache.parquet.hadoop.metadata.ParquetMetadata;\n+import org.apache.parquet.tools.Main;\n+\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class ColumnSizeCommand extends ArgsOnlyCommand {\n+\n+  public static final String[] USAGE = new String[] {\n+    \"<input>\",\n+    \"where <input> is the parquet file to calculate teh column size\" +\n+    \"     [<column> ...] are the columns in the case sensitive dot format\" +\n+    \"     to be calculated, for example a.b.c. If no columns are input, all the\" +\n+    \"     columns will be printed out\"\n+  };\n+\n+  /**\n+   * Biggest number of columns we can calculate.\n+   */\n+  private static final int MAX_COL_NUM = 100;\n+\n+  public ColumnSizeCommand() {\n+    super(1, 1 + MAX_COL_NUM);\n+  }\n+\n+  @Override\n+  public String[] getUsageDescription() {\n+    return USAGE;\n+  }\n+\n+  @Override\n+  public String getCommandDescription() {\n+    return \"Print out the size in bytes and percentage of column(s) in the input Parquet file\";\n+  }\n+\n+  @Override\n+  public void execute(CommandLine options) throws Exception {\n+    super.execute(options);\n+    List<String> args = options.getArgList();\n+    Path inputFile = new Path(args.get(0));\n+\n+    Map<String, Long> columnSizes = getColumnSizeInBytes(inputFile);\n+    Map<String, Float> columnPercentage = getColumnPercentage(columnSizes);\n+\n+    if (args.size() > 1) {\n+      for (String inputColumn : args.subList(1, args.size())) {\n+        long size = 0;\n+        float percentage = 0;\n+        for (String column : columnSizes.keySet()) {\n+          if (column.startsWith(inputColumn)) {\n+            size += columnSizes.get(column);\n+            percentage += columnPercentage.get(column);\n+          }\n+        }\n+        Main.out.println(inputColumn + \"->\" + \" Size In Bytes: \" + size + \" Size In Percentage: \" + percentage);\n+      }\n+    } else {\n+      for (String column : columnSizes.keySet()) {\n+        Main.out.println(column + \"->\" + \" Size In Bytes: \" + columnSizes.get(column)\n+          + \" Size In Percentage: \" + columnPercentage.get(column));\n+      }\n+    }\n+  }\n+\n+  // Make it public to allow some automation tools to call it\n+  public Map<String, Long> getColumnSizeInBytes(Path inputFile) throws IOException {\n+    Map<String, Long> colSizes = new HashMap<>();\n+    ParquetMetadata pmd = ParquetFileReader.readFooter(new Configuration(), inputFile, ParquetMetadataConverter.NO_FILTER);\n+\n+    for (BlockMetaData block : pmd.getBlocks()) {\n+      for (ColumnChunkMetaData column : block.getColumns()) {\n+        String colName = column.getPath().toDotString();\n+        colSizes.put(colName, column.getTotalSize() + colSizes.getOrDefault(colName, 0L));\n+      }\n+    }\n+\n+    return colSizes;\n+  }\n+\n+  // Make it public to allow some automation tools to call it\n+  public Map<String, Float> getColumnPercentage(Map<String, Long> colSizes) {\n+    long totalSize = colSizes.values().stream().reduce(0L, Long::sum);\n+    Map<String, Float> colPercentage = new HashMap<>();\n+\n+    for (Map.Entry<String, Long> entry : colSizes.entrySet()) {\n+      colPercentage.put(entry.getKey(), ((float) entry.getValue()) / ((float) totalSize));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "749e5dfff61e1dbbe050dc9ad6916f366bbd8b08"}, "originalPosition": 115}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b9327444535cfcab2184f138ca440d8c822c6d0", "author": {"user": {"login": "shangxinli", "name": "Xinli Shang"}}, "url": "https://github.com/apache/parquet-mr/commit/6b9327444535cfcab2184f138ca440d8c822c6d0", "committedDate": "2020-03-26T14:36:47Z", "message": "Update parquet-cli/src/main/java/org/apache/parquet/cli/commands/ColumnSizeCommand.java\n\nCo-Authored-By: Gabor Szadovszky <gabor@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c19fab8b7810113862bc4d656f2c422f534533f", "author": {"user": {"login": "shangxinli", "name": "Xinli Shang"}}, "url": "https://github.com/apache/parquet-mr/commit/2c19fab8b7810113862bc4d656f2c422f534533f", "committedDate": "2020-03-26T14:46:09Z", "message": "Update parquet-tools/src/main/java/org/apache/parquet/tools/command/ColumnSizeCommand.java\n\nCo-Authored-By: Gabor Szadovszky <gabor@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3f2cac3c8a954f4a20fb1026507a011d5151aff", "author": {"user": {"login": "shangxinli", "name": "Xinli Shang"}}, "url": "https://github.com/apache/parquet-mr/commit/e3f2cac3c8a954f4a20fb1026507a011d5151aff", "committedDate": "2020-03-26T18:02:51Z", "message": "Address feedback"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1060e8fd56ee6f4dc8a7db4b1b18d2fab5b226f1", "author": {"user": {"login": "shangxinli", "name": "Xinli Shang"}}, "url": "https://github.com/apache/parquet-mr/commit/1060e8fd56ee6f4dc8a7db4b1b18d2fab5b226f1", "committedDate": "2020-03-26T18:02:26Z", "message": "Fix tests"}, "afterCommit": {"oid": "e3f2cac3c8a954f4a20fb1026507a011d5151aff", "author": {"user": {"login": "shangxinli", "name": "Xinli Shang"}}, "url": "https://github.com/apache/parquet-mr/commit/e3f2cac3c8a954f4a20fb1026507a011d5151aff", "committedDate": "2020-03-26T18:02:51Z", "message": "Address feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNzIwNjM5", "url": "https://github.com/apache/parquet-mr/pull/774#pullrequestreview-382720639", "createdAt": "2020-03-27T10:02:26Z", "commit": {"oid": "e3f2cac3c8a954f4a20fb1026507a011d5151aff"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMDowMjoyNlrOF8qbIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMDowMjoyNlrOF8qbIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE1Mzk1Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    \"sample.parquet -column col_2\",\n          \n          \n            \n                    \"sample.parquet -columns col_1 col_2\",\n          \n          \n            \n                    \"sample.parquet -columns col_1 col_2.sub_col_a\"\n          \n          \n            \n                    \"sample.parquet --column col_2\",\n          \n          \n            \n                    \"sample.parquet --columns col_1 col_2\",\n          \n          \n            \n                    \"sample.parquet --columns col_1 col_2.sub_col_a\"", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r399153953", "createdAt": "2020-03-27T10:02:26Z", "author": {"login": "gszadovszky"}, "path": "parquet-cli/src/main/java/org/apache/parquet/cli/commands/ColumnSizeCommand.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.parquet.cli.commands;\n+\n+import com.beust.jcommander.Parameter;\n+import com.beust.jcommander.Parameters;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.Lists;\n+import org.apache.avro.file.SeekableInput;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.parquet.cli.BaseCommand;\n+import org.apache.parquet.cli.util.Formats;\n+import org.apache.parquet.format.converter.ParquetMetadataConverter;\n+import org.apache.parquet.hadoop.ParquetFileReader;\n+import org.apache.parquet.hadoop.metadata.BlockMetaData;\n+import org.apache.parquet.hadoop.metadata.ColumnChunkMetaData;\n+import org.apache.parquet.hadoop.metadata.ParquetMetadata;\n+import org.slf4j.Logger;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+@Parameters(commandDescription=\"Print the column sizes of a parquet file\")\n+public class ColumnSizeCommand extends BaseCommand {\n+\n+  public ColumnSizeCommand(Logger console) {\n+    super(console);\n+  }\n+\n+  @Parameter(description = \"<parquet path>\")\n+  String target;\n+\n+  @Parameter(\n+    names = {\"-c\", \"--column\", \"--columns\"},\n+    description = \"List of columns\",\n+    required = false)\n+  List<String> columns;\n+\n+  @Override\n+  @SuppressWarnings(\"unchecked\")\n+  public int run() throws IOException {\n+    Preconditions.checkArgument(target != null,\n+      \"A Parquet file is required.\");\n+\n+    Path inputFile = new Path(target);\n+    Map<String, Long> columnSizes = getColumnSizeInBytes(inputFile);\n+    Map<String, Float> columnRatio = getColumnRatio(columnSizes);\n+\n+    // If user defined columns, only print out size for those columns\n+    if (columns != null && columns.size() > 0) {\n+      for (String inputColumn : columns) {\n+        long size = 0;\n+        float ratio = 0;\n+        for (String column : columnSizes.keySet()) {\n+          if (column.equals(inputColumn) || column.startsWith(inputColumn + \".\")) {\n+            size += columnSizes.get(column);\n+            ratio += columnRatio.get(column);\n+          }\n+        }\n+        console.info(inputColumn + \"->\" + \" Size In Bytes: \" + size + \" Size In Ratio: \" + ratio);\n+      }\n+    } else {\n+      for (String column : columnSizes.keySet()) {\n+        console.info(column + \"->\" + \" Size In Bytes: \" + columnSizes.get(column)\n+          + \" Size In Ratio: \" + columnRatio.get(column));\n+      }\n+    }\n+\n+    return 0;\n+  }\n+\n+  @Override\n+  public List<String> getExamples() {\n+    return Lists.newArrayList(\n+        \"# Print every column size in byte and ratio for a Parquet file\",\n+        \"sample.parquet\",\n+        \"sample.parquet -c col_1\",\n+        \"sample.parquet -column col_2\",\n+        \"sample.parquet -columns col_1 col_2\",\n+        \"sample.parquet -columns col_1 col_2.sub_col_a\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3f2cac3c8a954f4a20fb1026507a011d5151aff"}, "originalPosition": 104}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e60f0a5f724aa36a72d8c6a0b5fb9dc76f61b2aa", "author": {"user": {"login": "shangxinli", "name": "Xinli Shang"}}, "url": "https://github.com/apache/parquet-mr/commit/e60f0a5f724aa36a72d8c6a0b5fb9dc76f61b2aa", "committedDate": "2020-03-27T14:30:33Z", "message": "Update parquet-cli/src/main/java/org/apache/parquet/cli/commands/ColumnSizeCommand.java\n\nCo-Authored-By: Gabor Szadovszky <gabor@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1be782b2f1609d9aa6386d48aacfd64c622d0035", "author": {"user": {"login": "shangxinli", "name": "Xinli Shang"}}, "url": "https://github.com/apache/parquet-mr/commit/1be782b2f1609d9aa6386d48aacfd64c622d0035", "committedDate": "2020-03-27T14:55:19Z", "message": "Add comments for column path in help document"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMzkxMTc5", "url": "https://github.com/apache/parquet-mr/pull/774#pullrequestreview-383391179", "createdAt": "2020-03-29T09:36:36Z", "commit": {"oid": "1be782b2f1609d9aa6386d48aacfd64c622d0035"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOVQwOTozNjozN1rOF9QHtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOVQwOTozODoyM1rOF9QIWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc3MTU3Mg==", "bodyText": "Instead of having this file, we can use a JUnit rule: \n  \n    \n      parquet-mr/parquet-cli/src/test/java/org/apache/parquet/cli/commands/FileTest.java\n    \n    \n         Line 42\n      in\n      c3e1a84\n    \n    \n    \n    \n\n        \n          \n           public TemporaryFolder tempFolder = new TemporaryFolder(); \n        \n    \n  \n\n\nThen we can do: temporaryFolder.newFile(\"test.parquet\");\nWould be nice to keep this consistent", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r399771572", "createdAt": "2020-03-29T09:36:37Z", "author": {"login": "Fokko"}, "path": "parquet-tools/src/test/java/org/apache/parquet/tools/command/TestColumnSizeCommand.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.parquet.tools.command;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.parquet.example.data.simple.SimpleGroup;\n+import org.apache.parquet.hadoop.ParquetWriter;\n+import org.apache.parquet.hadoop.example.ExampleParquetWriter;\n+import org.apache.parquet.hadoop.example.GroupWriteSupport;\n+import org.apache.parquet.schema.MessageType;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.util.Map;\n+import java.util.Random;\n+\n+import static org.apache.parquet.schema.PrimitiveType.PrimitiveTypeName.INT32;\n+import static org.apache.parquet.schema.PrimitiveType.PrimitiveTypeName.INT64;\n+import static org.apache.parquet.schema.Type.Repetition.REQUIRED;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+public class TestColumnSizeCommand {\n+\n+  private final int numRecord = 10000;\n+  private ColumnSizeCommand command = new ColumnSizeCommand();\n+  private Configuration conf = new Configuration();\n+\n+  @Test\n+  public void testColumnSize() throws Exception {\n+    String inputFile = createParquetFile(\"input\");\n+    Map<String, Long> columnSizeInBytes = command.getColumnSizeInBytes(new Path(inputFile));\n+    assertEquals(columnSizeInBytes.size(), 2);\n+    assertTrue(columnSizeInBytes.get(\"DocId\") > columnSizeInBytes.get(\"Num\"));\n+    Map<String, Float> columnRatio = command.getColumnRatio(columnSizeInBytes);\n+    assertTrue(columnRatio.get(\"DocId\") > columnRatio.get(\"Num\"));\n+  }\n+\n+  private String createParquetFile(String prefix) throws IOException {\n+    MessageType schema = new MessageType(\"schema\",\n+      new PrimitiveType(REQUIRED, INT64, \"DocId\"),\n+      new PrimitiveType(REQUIRED, INT32, \"Num\"));\n+\n+    conf.set(GroupWriteSupport.PARQUET_EXAMPLE_SCHEMA, schema.toString());\n+\n+    String file = createTempFile(prefix);\n+    ExampleParquetWriter.Builder builder = ExampleParquetWriter.builder(new Path(file)).withConf(conf);\n+    Random rnd = new Random();\n+    try (ParquetWriter writer = builder.build()) {\n+      for (int i = 0; i < numRecord; i++) {\n+        SimpleGroup g = new SimpleGroup(schema);\n+        g.add(\"DocId\", rnd.nextLong());\n+        g.add(\"Num\", rnd.nextInt());\n+        writer.write(g);\n+      }\n+    }\n+\n+    return file;\n+  }\n+\n+  private static String createTempFile(String prefix) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1be782b2f1609d9aa6386d48aacfd64c622d0035"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc3MTY0Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Main.out.println(inputColumn + \"->\" + \" Size In Bytes: \" + size + \" Size In Ratio: \" + ratio);\n          \n          \n            \n                    Main.out.println(inputColumn + \"-> Size In Bytes: \" + size + \" Size In Ratio: \" + ratio);", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r399771647", "createdAt": "2020-03-29T09:37:27Z", "author": {"login": "Fokko"}, "path": "parquet-tools/src/main/java/org/apache/parquet/tools/command/ColumnSizeCommand.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.parquet.tools.command;\n+\n+import org.apache.commons.cli.CommandLine;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.parquet.format.converter.ParquetMetadataConverter;\n+import org.apache.parquet.hadoop.ParquetFileReader;\n+import org.apache.parquet.hadoop.metadata.BlockMetaData;\n+import org.apache.parquet.hadoop.metadata.ColumnChunkMetaData;\n+import org.apache.parquet.hadoop.metadata.ParquetMetadata;\n+import org.apache.parquet.tools.Main;\n+\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class ColumnSizeCommand extends ArgsOnlyCommand {\n+\n+  public static final String[] USAGE = new String[] {\n+    \"<input>\",\n+    \"where <input> is the parquet file to calculate the column size\" +\n+    \"     [<column> ...] are the columns in the case sensitive dot format\" +\n+    \"     to be calculated, for example a.b.c. If an input column is intermediate\" +\n+    \"     column, all the child columns will be printed out. If no columns are\" +\n+    \"     set, all the columns will be printed out.\"\n+  };\n+\n+  /**\n+   * Biggest number of columns we can calculate.\n+   */\n+  private static final int MAX_COL_NUM = 100;\n+\n+  public ColumnSizeCommand() {\n+    super(1, 1 + MAX_COL_NUM);\n+  }\n+\n+  @Override\n+  public String[] getUsageDescription() {\n+    return USAGE;\n+  }\n+\n+  @Override\n+  public String getCommandDescription() {\n+    return \"Print out the size in bytes and ratio of column(s) in the input Parquet file\";\n+  }\n+\n+  @Override\n+  public void execute(CommandLine options) throws Exception {\n+    super.execute(options);\n+    List<String> args = options.getArgList();\n+    Path inputFile = new Path(args.get(0));\n+\n+    Map<String, Long> columnSizes = getColumnSizeInBytes(inputFile);\n+    Map<String, Float> columnRatio = getColumnRatio(columnSizes);\n+\n+    if (args.size() > 1) {\n+      for (String inputColumn : args.subList(1, args.size())) {\n+        long size = 0;\n+        float ratio = 0;\n+        for (String column : columnSizes.keySet()) {\n+          if (column.equals(inputColumn) || column.startsWith(inputColumn + \".\")) {\n+            size += columnSizes.get(column);\n+            ratio += columnRatio.get(column);\n+          }\n+        }\n+        Main.out.println(inputColumn + \"->\" + \" Size In Bytes: \" + size + \" Size In Ratio: \" + ratio);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1be782b2f1609d9aa6386d48aacfd64c622d0035"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc3MTczNw==", "bodyText": "See comment in TestColumnSizeCommand.java \ud83d\udc4d", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r399771737", "createdAt": "2020-03-29T09:38:23Z", "author": {"login": "Fokko"}, "path": "parquet-cli/src/test/java/org/apache/parquet/cli/commands/ColumnSizeCommandTest.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.parquet.cli.commands;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.parquet.example.data.simple.SimpleGroup;\n+import org.apache.parquet.hadoop.ParquetWriter;\n+import org.apache.parquet.hadoop.example.ExampleParquetWriter;\n+import org.apache.parquet.hadoop.example.GroupWriteSupport;\n+import org.apache.parquet.schema.MessageType;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.util.Arrays;\n+import java.util.Map;\n+import java.util.Random;\n+\n+import static org.apache.parquet.schema.PrimitiveType.PrimitiveTypeName.INT32;\n+import static org.apache.parquet.schema.PrimitiveType.PrimitiveTypeName.INT64;\n+import static org.apache.parquet.schema.Type.Repetition.REQUIRED;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+public class ColumnSizeCommandTest extends ParquetFileTest {\n+\n+  private final int numRecord = 10000;\n+  private ColumnSizeCommand command = new ColumnSizeCommand(createLogger());\n+  private Configuration conf = new Configuration();\n+\n+  @Test\n+  public void testColumnSizeCommand() throws IOException {\n+    File file = parquetFile();\n+    ColumnSizeCommand command = new ColumnSizeCommand(createLogger());\n+    command.target = file.getAbsolutePath();\n+    command.setConf(new Configuration());\n+    Assert.assertEquals(0, command.run());\n+  }\n+\n+  @Test\n+  public void testColumnSize() throws Exception {\n+    String inputFile = createParquetFile(\"input\");\n+    Map<String, Long> columnSizeInBytes = command.getColumnSizeInBytes(new Path(inputFile));\n+    assertEquals(columnSizeInBytes.size(), 2);\n+    assertTrue(columnSizeInBytes.get(\"DocId\") > columnSizeInBytes.get(\"Num\"));\n+    Map<String, Float> columnRatio = command.getColumnRatio(columnSizeInBytes);\n+    assertTrue(columnRatio.get(\"DocId\") > columnRatio.get(\"Num\"));\n+  }\n+\n+  private String createParquetFile(String prefix) throws IOException {\n+    MessageType schema = new MessageType(\"schema\",\n+      new PrimitiveType(REQUIRED, INT64, \"DocId\"),\n+      new PrimitiveType(REQUIRED, INT32, \"Num\"));\n+\n+    conf.set(GroupWriteSupport.PARQUET_EXAMPLE_SCHEMA, schema.toString());\n+\n+    String file = createTempFile(prefix);\n+    ExampleParquetWriter.Builder builder = ExampleParquetWriter.builder(new Path(file)).withConf(conf);\n+    Random rnd = new Random();\n+    try (ParquetWriter writer = builder.build()) {\n+      for (int i = 0; i < numRecord; i++) {\n+        SimpleGroup g = new SimpleGroup(schema);\n+        g.add(\"DocId\", rnd.nextLong());\n+        g.add(\"Num\", rnd.nextInt());\n+        writer.write(g);\n+      }\n+    }\n+\n+    return file;\n+  }\n+\n+  private static String createTempFile(String prefix) {\n+    try {\n+      return Files.createTempDirectory(prefix).toAbsolutePath().toString() + \"/test.parquet\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1be782b2f1609d9aa6386d48aacfd64c622d0035"}, "originalPosition": 94}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6ca2b75c88166dbb2aa4185692dc7e3e529b227", "author": {"user": {"login": "shangxinli", "name": "Xinli Shang"}}, "url": "https://github.com/apache/parquet-mr/commit/d6ca2b75c88166dbb2aa4185692dc7e3e529b227", "committedDate": "2020-03-29T15:29:50Z", "message": "Update parquet-tools/src/main/java/org/apache/parquet/tools/command/ColumnSizeCommand.java\n\nCo-Authored-By: Fokko Driesprong <fokko@driesprong.frl>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01ebbdf6b6a3583a60697e341e82b046aa1bb2d8", "author": {"user": {"login": "shangxinli", "name": "Xinli Shang"}}, "url": "https://github.com/apache/parquet-mr/commit/01ebbdf6b6a3583a60697e341e82b046aa1bb2d8", "committedDate": "2020-03-29T15:55:27Z", "message": "Address feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzNjY5MTUw", "url": "https://github.com/apache/parquet-mr/pull/774#pullrequestreview-383669150", "createdAt": "2020-03-30T09:16:46Z", "commit": {"oid": "01ebbdf6b6a3583a60697e341e82b046aa1bb2d8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwOToxNjo0NlrOF9gpkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwOToxNzoxM1rOF9gqlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA0MjM4Ng==", "bodyText": "prefix is never used and so it is misleading.\nTravis fails because parquetFile() uses the class name to create the file while there are two test methods invoking it. The file already exist after executing the second test method.\nI would suggest correcting the super class implementation by generating a unique file name each time parquetFile is invoked.", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r400042386", "createdAt": "2020-03-30T09:16:46Z", "author": {"login": "gszadovszky"}, "path": "parquet-cli/src/test/java/org/apache/parquet/cli/commands/ColumnSizeCommandTest.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.parquet.cli.commands;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.parquet.example.data.simple.SimpleGroup;\n+import org.apache.parquet.hadoop.ParquetWriter;\n+import org.apache.parquet.hadoop.example.ExampleParquetWriter;\n+import org.apache.parquet.hadoop.example.GroupWriteSupport;\n+import org.apache.parquet.schema.MessageType;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.util.Arrays;\n+import java.util.Map;\n+import java.util.Random;\n+\n+import static org.apache.parquet.schema.PrimitiveType.PrimitiveTypeName.INT32;\n+import static org.apache.parquet.schema.PrimitiveType.PrimitiveTypeName.INT64;\n+import static org.apache.parquet.schema.Type.Repetition.REQUIRED;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+public class ColumnSizeCommandTest extends ParquetFileTest {\n+\n+  private final int numRecord = 10000;\n+  private ColumnSizeCommand command = new ColumnSizeCommand(createLogger());\n+  private Configuration conf = new Configuration();\n+\n+  @Test\n+  public void testColumnSizeCommand() throws IOException {\n+    File file = parquetFile();\n+    ColumnSizeCommand command = new ColumnSizeCommand(createLogger());\n+    command.target = file.getAbsolutePath();\n+    command.setConf(new Configuration());\n+    Assert.assertEquals(0, command.run());\n+  }\n+\n+  @Test\n+  public void testColumnSize() throws Exception {\n+    String inputFile = createParquetFile(\"input\");\n+    Map<String, Long> columnSizeInBytes = command.getColumnSizeInBytes(new Path(inputFile));\n+    assertEquals(columnSizeInBytes.size(), 2);\n+    assertTrue(columnSizeInBytes.get(\"DocId\") > columnSizeInBytes.get(\"Num\"));\n+    Map<String, Float> columnRatio = command.getColumnRatio(columnSizeInBytes);\n+    assertTrue(columnRatio.get(\"DocId\") > columnRatio.get(\"Num\"));\n+  }\n+\n+  private String createParquetFile(String prefix) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01ebbdf6b6a3583a60697e341e82b046aa1bb2d8"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA0MjY0NA==", "bodyText": "prefix is not used and so it is misleading.", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r400042644", "createdAt": "2020-03-30T09:17:13Z", "author": {"login": "gszadovszky"}, "path": "parquet-tools/src/test/java/org/apache/parquet/tools/command/TestColumnSizeCommand.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.parquet.tools.command;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.parquet.example.data.simple.SimpleGroup;\n+import org.apache.parquet.hadoop.ParquetWriter;\n+import org.apache.parquet.hadoop.example.ExampleParquetWriter;\n+import org.apache.parquet.hadoop.example.GroupWriteSupport;\n+import org.apache.parquet.schema.MessageType;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.Map;\n+import java.util.Random;\n+\n+import static org.apache.parquet.schema.PrimitiveType.PrimitiveTypeName.INT32;\n+import static org.apache.parquet.schema.PrimitiveType.PrimitiveTypeName.INT64;\n+import static org.apache.parquet.schema.Type.Repetition.REQUIRED;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+public class TestColumnSizeCommand {\n+\n+  private final int numRecord = 10000;\n+  private ColumnSizeCommand command = new ColumnSizeCommand();\n+  private Configuration conf = new Configuration();\n+\n+  @Rule\n+  public TemporaryFolder tempFolder = new TemporaryFolder();\n+\n+  @Test\n+  public void testColumnSize() throws Exception {\n+    String inputFile = createParquetFile(\"input\");\n+    Map<String, Long> columnSizeInBytes = command.getColumnSizeInBytes(new Path(inputFile));\n+    assertEquals(columnSizeInBytes.size(), 2);\n+    assertTrue(columnSizeInBytes.get(\"DocId\") > columnSizeInBytes.get(\"Num\"));\n+    Map<String, Float> columnRatio = command.getColumnRatio(columnSizeInBytes);\n+    assertTrue(columnRatio.get(\"DocId\") > columnRatio.get(\"Num\"));\n+  }\n+\n+  private String createParquetFile(String prefix) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01ebbdf6b6a3583a60697e341e82b046aa1bb2d8"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "801ed79846e0b84152314f29a5655d12721e35e7", "author": {"user": {"login": "shangxinli", "name": "Xinli Shang"}}, "url": "https://github.com/apache/parquet-mr/commit/801ed79846e0b84152314f29a5655d12721e35e7", "committedDate": "2020-03-30T21:36:45Z", "message": "Fix building error"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "14a45939dd2307c56ad376dacdd8b56bf649025f", "author": {"user": {"login": "shangxinli", "name": "Xinli Shang"}}, "url": "https://github.com/apache/parquet-mr/commit/14a45939dd2307c56ad376dacdd8b56bf649025f", "committedDate": "2020-03-30T15:27:23Z", "message": "Fix building error"}, "afterCommit": {"oid": "801ed79846e0b84152314f29a5655d12721e35e7", "author": {"user": {"login": "shangxinli", "name": "Xinli Shang"}}, "url": "https://github.com/apache/parquet-mr/commit/801ed79846e0b84152314f29a5655d12721e35e7", "committedDate": "2020-03-30T21:36:45Z", "message": "Fix building error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NDY0OTg1", "url": "https://github.com/apache/parquet-mr/pull/774#pullrequestreview-384464985", "createdAt": "2020-03-31T07:26:35Z", "commit": {"oid": "801ed79846e0b84152314f29a5655d12721e35e7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2189, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}