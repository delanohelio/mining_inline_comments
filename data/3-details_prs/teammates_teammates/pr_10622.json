{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcxMDEyNzI4", "number": 10622, "title": "[#10613] Reconfigure InstructorFeedbackSubmission access control", "bodyText": "Fixes #10613", "createdAt": "2020-08-20T15:52:01Z", "url": "https://github.com/TEAMMATES/teammates/pull/10622", "merged": true, "mergeCommit": {"oid": "eb31d080e4cfc1bb8970ab8d3f06a8a57eb77830"}, "closed": true, "closedAt": "2020-09-07T02:59:14Z", "author": {"login": "madanalogy"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdA5bD_gFqTQ3MjAzNjIyMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdGZiAUgH2gAyNDcxMDEyNzI4OjNjYmY1YjM3OGMzNTZkMTA2ODdlMjZjMTBhMGJiM2Q1Y2MyZmY3MmY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyMDM2MjIz", "url": "https://github.com/TEAMMATES/teammates/pull/10622#pullrequestreview-472036223", "createdAt": "2020-08-20T22:49:40Z", "commit": {"oid": "bc23cd911d58bd8677dd7a70b01002d25d5bf832"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQyMjo0OTo0MFrOHEVz9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQyMjo1Mjo0NlrOHEV4Fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMxMzcxOQ==", "bodyText": "You should update this as well. This should require the MODIFY_SESSION privilege.", "url": "https://github.com/TEAMMATES/teammates/pull/10622#discussion_r474313719", "createdAt": "2020-08-20T22:49:40Z", "author": {"login": "wkurniawan07"}, "path": "src/main/java/teammates/ui/webapi/action/GetFeedbackSessionAction.java", "diffHunk": "@@ -38,10 +39,12 @@ public void checkSpecificAccessControl() {\n             gateKeeper.verifyAccessible(logic.getInstructorForGoogleId(courseId, userInfo.getId()), feedbackSession);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc23cd911d58bd8677dd7a70b01002d25d5bf832"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMxNDc3NQ==", "bodyText": "This privilege is used to modify the session object itself. The privilege here should be INSTRUCTOR_PERMISSION_MODIFY_SESSION_COMMENT_IN_SECTIONS.\nI think there are a few places whereby this mistake happens. Let's take this time to correct them all.", "url": "https://github.com/TEAMMATES/teammates/pull/10622#discussion_r474314775", "createdAt": "2020-08-20T22:52:46Z", "author": {"login": "wkurniawan07"}, "path": "src/main/java/teammates/ui/webapi/action/GetFeedbackSessionAction.java", "diffHunk": "@@ -79,4 +82,19 @@ public ActionResult execute() {\n \n         return new JsonResult(response);\n     }\n+\n+    /**\n+     * Checks the access control for instructor feedback submission.\n+     */\n+    private void checkInstructorForSessionAccessPrivilege(FeedbackSessionAttributes feedbackSession) {\n+        String moderatedPerson = getRequestParamValue(Const.ParamsNames.FEEDBACK_SESSION_MODERATED_PERSON);\n+        gateKeeper.verifyLoggedInUserPrivileges();\n+        if (StringHelper.isEmpty(moderatedPerson)) {\n+            gateKeeper.verifyAccessible(logic.getInstructorForGoogleId(feedbackSession.getCourseId(), userInfo.getId()),\n+                    feedbackSession, Const.ParamsNames.INSTRUCTOR_PERMISSION_VIEW_SESSION_IN_SECTIONS);\n+        } else {\n+            gateKeeper.verifyAccessible(logic.getInstructorForGoogleId(feedbackSession.getCourseId(), userInfo.getId()),\n+                    feedbackSession, Const.ParamsNames.INSTRUCTOR_PERMISSION_MODIFY_SESSION);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc23cd911d58bd8677dd7a70b01002d25d5bf832"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyMDk1OTA4", "url": "https://github.com/TEAMMATES/teammates/pull/10622#pullrequestreview-472095908", "createdAt": "2020-08-21T02:03:02Z", "commit": {"oid": "bc23cd911d58bd8677dd7a70b01002d25d5bf832"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQwMjowMzowMlrOHEZCjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQwMjowMzowMlrOHEZCjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM2NjYwNQ==", "bodyText": "Why there is a moderatedPerson here?", "url": "https://github.com/TEAMMATES/teammates/pull/10622#discussion_r474366605", "createdAt": "2020-08-21T02:03:02Z", "author": {"login": "xpdavid"}, "path": "src/main/java/teammates/ui/webapi/action/GetFeedbackSessionAction.java", "diffHunk": "@@ -79,4 +82,19 @@ public ActionResult execute() {\n \n         return new JsonResult(response);\n     }\n+\n+    /**\n+     * Checks the access control for instructor feedback submission.\n+     */\n+    private void checkInstructorForSessionAccessPrivilege(FeedbackSessionAttributes feedbackSession) {\n+        String moderatedPerson = getRequestParamValue(Const.ParamsNames.FEEDBACK_SESSION_MODERATED_PERSON);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc23cd911d58bd8677dd7a70b01002d25d5bf832"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3OTE0ODc1", "url": "https://github.com/TEAMMATES/teammates/pull/10622#pullrequestreview-477914875", "createdAt": "2020-08-28T17:42:37Z", "commit": {"oid": "3aa36a12a88dc9bc6cc9fccac28b64b99fba1c86"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxNzo0MjozOFrOHJPMcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxNzo0MjozOFrOHJPMcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ0ODE3Nw==", "bodyText": "The previous setting INSTRUCTOR_PERMISSION_MODIFY_SESSION is correct for previewing. This is correct for moderation only. Refer to checkAccessControlForStudentFeedbackSubmission.", "url": "https://github.com/TEAMMATES/teammates/pull/10622#discussion_r479448177", "createdAt": "2020-08-28T17:42:38Z", "author": {"login": "wkurniawan07"}, "path": "src/main/java/teammates/ui/webapi/action/BasicFeedbackSubmissionAction.java", "diffHunk": "@@ -126,7 +126,7 @@ protected void checkAccessControlForInstructorFeedbackSubmission(\n         } else {\n             gateKeeper.verifyLoggedInUserPrivileges();\n             gateKeeper.verifyAccessible(logic.getInstructorForGoogleId(feedbackSession.getCourseId(), userInfo.getId()),\n-                    feedbackSession, Const.ParamsNames.INSTRUCTOR_PERMISSION_MODIFY_SESSION);\n+                    feedbackSession, Const.ParamsNames.INSTRUCTOR_PERMISSION_MODIFY_SESSION_COMMENT_IN_SECTIONS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3aa36a12a88dc9bc6cc9fccac28b64b99fba1c86"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b593c75394fdeb8581ca6442352a80dd7e0ab39d", "author": {"user": {"login": "madanalogy", "name": "Ahmed Bahajjaj"}}, "url": "https://github.com/TEAMMATES/teammates/commit/b593c75394fdeb8581ca6442352a80dd7e0ab39d", "committedDate": "2020-09-06T16:46:13Z", "message": "Refactor InstructorFeedbackSubmission access control"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3aa36a12a88dc9bc6cc9fccac28b64b99fba1c86", "author": {"user": {"login": "madanalogy", "name": "Ahmed Bahajjaj"}}, "url": "https://github.com/TEAMMATES/teammates/commit/3aa36a12a88dc9bc6cc9fccac28b64b99fba1c86", "committedDate": "2020-08-28T04:07:23Z", "message": "Refactor access control to more specific requirements"}, "afterCommit": {"oid": "b593c75394fdeb8581ca6442352a80dd7e0ab39d", "author": {"user": {"login": "madanalogy", "name": "Ahmed Bahajjaj"}}, "url": "https://github.com/TEAMMATES/teammates/commit/b593c75394fdeb8581ca6442352a80dd7e0ab39d", "committedDate": "2020-09-06T16:46:13Z", "message": "Refactor InstructorFeedbackSubmission access control"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMjAxMzU0", "url": "https://github.com/TEAMMATES/teammates/pull/10622#pullrequestreview-483201354", "createdAt": "2020-09-07T01:54:41Z", "commit": {"oid": "b593c75394fdeb8581ca6442352a80dd7e0ab39d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwMTo1NDo0MVrOHNuAsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwMTo1NDo0MVrOHNuAsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE0NzM3OQ==", "bodyText": "Note that this is an unintended change", "url": "https://github.com/TEAMMATES/teammates/pull/10622#discussion_r484147379", "createdAt": "2020-09-07T01:54:41Z", "author": {"login": "wkurniawan07"}, "path": "src/test/java/teammates/test/cases/webapi/GetFeedbackQuestionRecipientsActionTest.java", "diffHunk": "@@ -291,15 +291,17 @@ protected void testAccessControl_instructorSubmission()\n                 generateParameters(firstSessionInCourse1, 3, Intent.INSTRUCTOR_SUBMISSION,\n                         \"\", instructor1OfCourse1.email, \"\");\n         verifyOnlyInstructorsOfTheSameCourseWithCorrectCoursePrivilegeCanAccess(\n-                Const.ParamsNames.INSTRUCTOR_PERMISSION_MODIFY_SESSION, moderatedInstructorSubmissionParams);\n+                Const.ParamsNames.INSTRUCTOR_PERMISSION_MODIFY_SESSION_COMMENT_IN_SECTIONS,\n+                moderatedInstructorSubmissionParams);\n \n         ______TS(\"Instructor previews another instructor's question,\"\n                 + \" should be accessible if he has privilege\");\n         String[] previewInstructorSubmissionParams =\n                 generateParameters(firstSessionInCourse1, 3, Intent.INSTRUCTOR_SUBMISSION,\n                         \"\", \"\", instructor1OfCourse1.email);\n         verifyOnlyInstructorsOfTheSameCourseWithCorrectCoursePrivilegeCanAccess(\n-                Const.ParamsNames.INSTRUCTOR_PERMISSION_MODIFY_SESSION, previewInstructorSubmissionParams);\n+                Const.ParamsNames.INSTRUCTOR_PERMISSION_MODIFY_SESSION,\n+                previewInstructorSubmissionParams);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b593c75394fdeb8581ca6442352a80dd7e0ab39d"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9bfb6d9c3676bd0e02c73883aec5b1e8c63f8f5b", "author": {"user": {"login": "madanalogy", "name": "Ahmed Bahajjaj"}}, "url": "https://github.com/TEAMMATES/teammates/commit/9bfb6d9c3676bd0e02c73883aec5b1e8c63f8f5b", "committedDate": "2020-09-07T02:24:46Z", "message": "Revert unintended change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3cbf5b378c356d10687e26c10a0bb3d5cc2ff72f", "author": {"user": {"login": "madanalogy", "name": "Ahmed Bahajjaj"}}, "url": "https://github.com/TEAMMATES/teammates/commit/3cbf5b378c356d10687e26c10a0bb3d5cc2ff72f", "committedDate": "2020-09-07T02:25:33Z", "message": "Merge branch 'master' into 10613-results\n# Please enter a commit message to explain why this merge is necessary,\n# especially if it merges an updated upstream into a topic branch.\n#\n# Lines starting with '#' will be ignored, and an empty message aborts\n# the commit."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4242, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}