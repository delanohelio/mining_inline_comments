{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzNzc5NDUx", "number": 10827, "title": "[#9536] Improve E2E for Production Server Testing", "bodyText": "Part of #9536\nOutline of Solution\n\nSubmit page was not actually loading slowly but required certain access rules to be followed. (Weirdly the data loads in incognito sometimes)\n\nAdded TEST_ADMIN_ID to store the Google ID of the admin account used to login to production server.\nUse this Google ID as a instructor in the test so that it has access to previews, moderation etc.\nRemove reloading\n\n\nEmail checking could not run in parallel as all unread mail is marked as read and only unread mail is checked\n\nChange to only marking the expected mail as read\n\n\nAnother problem with email is the free quota on GAE is really low, so the quota will surely be hit quickly\n\nTurn off email checking once quota is hit\nAdded a flag INCLUDE_EMAIL_VERIFICATION to stop verifying, also affects status message to check for (success/failure)\n\n\nAdmin Accounts E2E Test failing as cannot delete last instructor in course. (Not sure why works on dev server)\n\nAdded another instructor to the test data\n\n\nSimilar to the first point, for any page that requires login, we insert TEST_ADMIN_ID as the user's google id.\nFix timing issues\n\nAlso I have verified that we can run the whole test suite on Chrome if we run tests sequentially with close on failure turned on. However, I have not added this functionality in this PR.\nNote: Only can insert TEST_ADMIN_ID in staging server with a real account. TEST_ADMIN_ID does not exist in dev server and will lead to NullPointerException\nWaiting for #10662 to be resolved", "createdAt": "2020-11-02T04:40:17Z", "url": "https://github.com/TEAMMATES/teammates/pull/10827", "merged": true, "mergeCommit": {"oid": "00857992315f333b43fed8deb0e6dfe3bde5fbb8"}, "closed": true, "closedAt": "2020-11-11T06:05:54Z", "author": {"login": "jtankw3"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYhv7TABqjM5NDcyOTIzODg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbVMWOgH2gAyNTEzNzc5NDUxOmExYmIwZmMzMDJlYjA0NWRmODA1Nzg2MTU3MTc0ZDRiZmZlOTcxNjM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "643e702bb8334d08e171037ad43f1133501c0fc4", "author": {"user": {"login": "jtankw3", "name": "Tan Kian Wei Jason"}}, "url": "https://github.com/TEAMMATES/teammates/commit/643e702bb8334d08e171037ad43f1133501c0fc4", "committedDate": "2020-11-02T06:08:51Z", "message": "Merge branch 'master' of https://github.com/TEAMMATES/teammates into production-server-e2e\n\n# Conflicts:\n#\tsrc/e2e/java/teammates/e2e/cases/FeedbackSubmitPageE2ETest.java\n#\tsrc/e2e/java/teammates/e2e/cases/InstructorCourseDetailsPageE2ETest.java\n#\tsrc/e2e/java/teammates/e2e/cases/InstructorCourseJoinConfirmationPageE2ETest.java\n#\tsrc/e2e/java/teammates/e2e/cases/InstructorFeedbackSessionsPageE2ETest.java\n#\tsrc/e2e/java/teammates/e2e/cases/InstructorHomePageE2ETest.java\n#\tsrc/e2e/java/teammates/e2e/cases/StudentCourseJoinConfirmationPageE2ETest.java\n#\tsrc/e2e/resources/data/AdminAccountsPageE2ETest.json"}, "afterCommit": {"oid": "3e472a6dc1464bc07a0cdfd0952696cef1502114", "author": {"user": {"login": "jtankw3", "name": "Tan Kian Wei Jason"}}, "url": "https://github.com/TEAMMATES/teammates/commit/3e472a6dc1464bc07a0cdfd0952696cef1502114", "committedDate": "2020-11-02T10:10:20Z", "message": "Fix accounts used in dev server tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1NTk0NTY5", "url": "https://github.com/TEAMMATES/teammates/pull/10827#pullrequestreview-525594569", "createdAt": "2020-11-07T03:44:39Z", "commit": {"oid": "a4a3decf3b0be12d4b182776914c2cce6467091c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QwMzo0NDozOVrOHvDBxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQwMjowNTowOFrOHvMN3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA5NDcyNA==", "bodyText": "The logic is not right here for two reasons:\n\nProduction server is not the cause for emails failing to send\nTestProperties does not affect the production system logic in that the value of INCLUDE_EMAIL_VERIFICATION is not going to affect whether emails are sent or not", "url": "https://github.com/TEAMMATES/teammates/pull/10827#discussion_r519094724", "createdAt": "2020-11-07T03:44:39Z", "author": {"login": "wkurniawan07"}, "path": "src/e2e/java/teammates/e2e/cases/AdminSearchPageE2ETest.java", "diffHunk": "@@ -237,8 +238,13 @@ private void verifyLinkExpansionButtons(StudentAttributes student, InstructorAtt\n     }\n \n     private void verifyRegenerateStudentCourseLinks(WebElement studentRow, String originalJoinLink) {\n-        searchPage.verifyStatusMessage(\"Student's links for this course have been successfully regenerated,\"\n-                + \" and the email has been sent.\");\n+        if (TestProperties.isDevServer() || TestProperties.INCLUDE_EMAIL_VERIFICATION) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4a3decf3b0be12d4b182776914c2cce6467091c"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE3NTY2NQ==", "bodyText": "TestProperties.isDevServer() is actually another hard requirement. So the condition here should be either it is a dev server or it is explicitly requested to not verify emails.", "url": "https://github.com/TEAMMATES/teammates/pull/10827#discussion_r519175665", "createdAt": "2020-11-07T13:04:43Z", "author": {"login": "wkurniawan07"}, "path": "src/e2e/java/teammates/e2e/cases/BaseE2ETestCase.java", "diffHunk": "@@ -189,7 +190,7 @@ protected void verifyDownloadedFile(String expectedFileName, List<String> expect\n      * Email used must be an authentic gmail account.\n      */\n     protected void verifyEmailSent(String email, String subject) {\n-        if (TestProperties.isDevServer()) {\n+        if (!TestProperties.INCLUDE_EMAIL_VERIFICATION) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4a3decf3b0be12d4b182776914c2cce6467091c"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE3NTcwOQ==", "bodyText": "What is this for?", "url": "https://github.com/TEAMMATES/teammates/pull/10827#discussion_r519175709", "createdAt": "2020-11-07T13:05:01Z", "author": {"login": "wkurniawan07"}, "path": "src/e2e/java/teammates/e2e/cases/BaseE2ETestCase.java", "diffHunk": "@@ -105,7 +105,9 @@ protected static AppUrl createUrl(String relativeUrl) {\n         // To log in, log in manually to teammates in your browser before running e2e tests.\n         // Refer to teammates.e2e.pageobjects.Browser for more information.\n         if (!TestProperties.isDevServer()) {\n-            // skip login and navigate to the desired page.\n+            // skip login and start at admin home page\n+            AppPage.getNewPageInstance(browser, createUrl(Const.WebPageURIs.ADMIN_HOME_PAGE), AdminHomePage.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4a3decf3b0be12d4b182776914c2cce6467091c"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE3NTgxNQ==", "bodyText": "Unrelated change?", "url": "https://github.com/TEAMMATES/teammates/pull/10827#discussion_r519175815", "createdAt": "2020-11-07T13:06:18Z", "author": {"login": "wkurniawan07"}, "path": "src/e2e/java/teammates/e2e/cases/InstructorFeedbackSessionsPageE2ETest.java", "diffHunk": "@@ -42,6 +42,7 @@ protected void prepareTestData() {\n         testData = loadDataBundle(\"/InstructorFeedbackSessionsPageE2ETest.json\");\n         studentToEmail = testData.students.get(\"charlie.tmms@IFSess.CS1101\");\n         studentToEmail.email = TestProperties.TEST_EMAIL;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4a3decf3b0be12d4b182776914c2cce6467091c"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTI0NTAyMA==", "bodyText": "This should not be necessary once #10694 is merged", "url": "https://github.com/TEAMMATES/teammates/pull/10827#discussion_r519245020", "createdAt": "2020-11-08T02:01:06Z", "author": {"login": "wkurniawan07"}, "path": "src/e2e/java/teammates/e2e/util/TestProperties.java", "diffHunk": "@@ -74,6 +80,7 @@\n \n             TEAMMATES_URL = UrlExtension.trimTrailingSlash(prop.getProperty(\"test.app.url\"));\n \n+            TEST_ADMIN_ID = prop.getProperty(\"test.admin.id\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4a3decf3b0be12d4b182776914c2cce6467091c"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTI0NTExMA==", "bodyText": "This should be changed to @gmail.tmt. Similarly for the travis and travis-chrome ones (although they won't affect anything).", "url": "https://github.com/TEAMMATES/teammates/pull/10827#discussion_r519245110", "createdAt": "2020-11-08T02:02:24Z", "author": {"login": "wkurniawan07"}, "path": "src/e2e/resources/test.template.properties", "diffHunk": "@@ -70,7 +70,19 @@ test.timeout=15\n test.persistence.timeout=16\n \n ###############################################################################\n+# The Google account of a user that has 'admin access' to the application.\n+# This is the account used to login when testing against staging server.\n+# It is also used as the main user whenever login is required for testing.\n+\n+test.admin.id=yourGoogleId\n+\n # The email address below will receive some emails from the production server,\n # which will be programmatically checked as part of E2E tests.\n \n test.email=alice.tmms@example.tmt", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4a3decf3b0be12d4b182776914c2cce6467091c"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTI0NTE4Mw==", "bodyText": "The reason the test passes in the dev server but not in staging is because very likely in staging the admin is also an instructor. It is because of the wrongly configured logic here:\n\n  \n    \n      teammates/src/main/java/teammates/ui/webapi/DeleteInstructorAction.java\n    \n    \n        Lines 57 to 58\n      in\n      dda027e\n    \n    \n    \n    \n\n        \n          \n           // Deleting last instructor from the course is not allowed if you're not the admin \n        \n\n        \n          \n           if (userInfo.isInstructor && !hasAlternativeInstructor(courseId, instructor.email)) {", "url": "https://github.com/TEAMMATES/teammates/pull/10827#discussion_r519245183", "createdAt": "2020-11-08T02:03:58Z", "author": {"login": "wkurniawan07"}, "path": "src/e2e/resources/data/AdminAccountsPageE2ETest.json", "diffHunk": "@@ -1,5 +1,12 @@\n {\n   \"accounts\": {\n+    \"AAccounts.instr\": {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4a3decf3b0be12d4b182776914c2cce6467091c"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTI0NTI2OQ==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/TEAMMATES/teammates/pull/10827#discussion_r519245269", "createdAt": "2020-11-08T02:05:02Z", "author": {"login": "wkurniawan07"}, "path": "src/e2e/java/teammates/e2e/cases/BaseE2ETestCase.java", "diffHunk": "@@ -205,7 +206,6 @@ protected void verifyEmailSent(String email, String subject) {\n                 ThreadHelper.waitFor(1000);\n                 actual = emailAccount.isEmailWithSubjectPresent(subject);\n             }\n-            emailAccount.markAllUnreadEmailAsRead();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4a3decf3b0be12d4b182776914c2cce6467091c"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTI0NTI3OA==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/TEAMMATES/teammates/pull/10827#discussion_r519245278", "createdAt": "2020-11-08T02:05:08Z", "author": {"login": "wkurniawan07"}, "path": "src/e2e/java/teammates/e2e/util/EmailAccount.java", "diffHunk": "@@ -114,6 +114,7 @@ public boolean isEmailWithSubjectPresent(String subject)\n             MimeMessage email = convertFromMessageToMimeMessage(message);\n \n             if (email.getSubject().equals(subject)) {\n+                markMessageAsRead(messageStub);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4a3decf3b0be12d4b182776914c2cce6467091c"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cd9d4ea7b2a3d2c9ed82e12050e6f903b73c841", "author": {"user": {"login": "jtankw3", "name": "Tan Kian Wei Jason"}}, "url": "https://github.com/TEAMMATES/teammates/commit/8cd9d4ea7b2a3d2c9ed82e12050e6f903b73c841", "committedDate": "2020-11-08T14:29:16Z", "message": "Fix submit page access issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd25ef90bbb3c412672dbb692c0ffda4d3737742", "author": {"user": {"login": "jtankw3", "name": "Tan Kian Wei Jason"}}, "url": "https://github.com/TEAMMATES/teammates/commit/fd25ef90bbb3c412672dbb692c0ffda4d3737742", "committedDate": "2020-11-08T16:52:30Z", "message": "Fix email related issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6eba02093707d90eaa7b3bffab0c38b72cf1170d", "author": {"user": {"login": "jtankw3", "name": "Tan Kian Wei Jason"}}, "url": "https://github.com/TEAMMATES/teammates/commit/6eba02093707d90eaa7b3bffab0c38b72cf1170d", "committedDate": "2020-11-08T16:52:51Z", "message": "Add changes to improve stability"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "503251948ca86310319c7fa3e6ae7003b57791d5", "author": {"user": {"login": "jtankw3", "name": "Tan Kian Wei Jason"}}, "url": "https://github.com/TEAMMATES/teammates/commit/503251948ca86310319c7fa3e6ae7003b57791d5", "committedDate": "2020-11-08T18:18:43Z", "message": "Run E2E in single thread for production server"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a94b606f947a14e2831d0302674958dd45c54f64", "author": {"user": {"login": "jtankw3", "name": "Tan Kian Wei Jason"}}, "url": "https://github.com/TEAMMATES/teammates/commit/a94b606f947a14e2831d0302674958dd45c54f64", "committedDate": "2020-11-08T18:20:07Z", "message": "Fix timing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e1ca9445b13070ee3bf32ca5d0029cbd997f78c", "author": {"user": {"login": "jtankw3", "name": "Tan Kian Wei Jason"}}, "url": "https://github.com/TEAMMATES/teammates/commit/1e1ca9445b13070ee3bf32ca5d0029cbd997f78c", "committedDate": "2020-11-08T18:20:21Z", "message": "Remove logouts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4eee4e3f982a8c50148e90e94b0bb805dc3a1466", "author": {"user": {"login": "jtankw3", "name": "Tan Kian Wei Jason"}}, "url": "https://github.com/TEAMMATES/teammates/commit/4eee4e3f982a8c50148e90e94b0bb805dc3a1466", "committedDate": "2020-11-08T18:20:33Z", "message": "Fix chrome preference settings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ceeeaff1147f33a024eea6632ad56c6f72308378", "author": {"user": {"login": "jtankw3", "name": "Tan Kian Wei Jason"}}, "url": "https://github.com/TEAMMATES/teammates/commit/ceeeaff1147f33a024eea6632ad56c6f72308378", "committedDate": "2020-11-08T18:23:41Z", "message": "Merge branch 'master' of https://github.com/TEAMMATES/teammates into production-server-e2e\n\n# Conflicts:\n#\tsrc/e2e/java/teammates/e2e/cases/FeedbackSubmitPageE2ETest.java\n#\tsrc/e2e/java/teammates/e2e/cases/InstructorCourseDetailsPageE2ETest.java\n#\tsrc/e2e/java/teammates/e2e/cases/InstructorFeedbackSessionsPageE2ETest.java\n#\tsrc/e2e/java/teammates/e2e/cases/InstructorHomePageE2ETest.java"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a4a3decf3b0be12d4b182776914c2cce6467091c", "author": {"user": {"login": "jtankw3", "name": "Tan Kian Wei Jason"}}, "url": "https://github.com/TEAMMATES/teammates/commit/a4a3decf3b0be12d4b182776914c2cce6467091c", "committedDate": "2020-11-03T05:33:15Z", "message": "Merge branch 'master' into production-server-e2e"}, "afterCommit": {"oid": "ceeeaff1147f33a024eea6632ad56c6f72308378", "author": {"user": {"login": "jtankw3", "name": "Tan Kian Wei Jason"}}, "url": "https://github.com/TEAMMATES/teammates/commit/ceeeaff1147f33a024eea6632ad56c6f72308378", "committedDate": "2020-11-08T18:23:41Z", "message": "Merge branch 'master' of https://github.com/TEAMMATES/teammates into production-server-e2e\n\n# Conflicts:\n#\tsrc/e2e/java/teammates/e2e/cases/FeedbackSubmitPageE2ETest.java\n#\tsrc/e2e/java/teammates/e2e/cases/InstructorCourseDetailsPageE2ETest.java\n#\tsrc/e2e/java/teammates/e2e/cases/InstructorFeedbackSessionsPageE2ETest.java\n#\tsrc/e2e/java/teammates/e2e/cases/InstructorHomePageE2ETest.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1ODQ0OTA3", "url": "https://github.com/TEAMMATES/teammates/pull/10827#pullrequestreview-525844907", "createdAt": "2020-11-08T21:04:35Z", "commit": {"oid": "ceeeaff1147f33a024eea6632ad56c6f72308378"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQyMTowNDozNVrOHvaWng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQyMTowODozOFrOHvaYdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ3Njg5NA==", "bodyText": "Let's keep the SLAP principle: extract out email.getSubject().equals(subject) to a variable as well.", "url": "https://github.com/TEAMMATES/teammates/pull/10827#discussion_r519476894", "createdAt": "2020-11-08T21:04:35Z", "author": {"login": "wkurniawan07"}, "path": "src/e2e/java/teammates/e2e/util/EmailAccount.java", "diffHunk": "@@ -100,20 +101,23 @@ public String getRegistrationKeyFromUnreadEmails(String courseName, String cours\n     }\n \n     /**\n-     * Returns true if unread mail contains mail with the specified subject.\n+     * Returns true if unread mail that arrived in the past minute contains mail with the specified subject.\n      */\n-    public boolean isEmailWithSubjectPresent(String subject)\n+    public boolean isRecentEmailWithSubjectPresent(String subject, String senderName)\n             throws IOException, MessagingException {\n \n-        List<Message> messageStubs = getListOfUnreadEmailOfUser();\n+        List<Message> messageStubs = getListOfUnreadEmailFromSender(10L, senderName);\n \n         for (Message messageStub : messageStubs) {\n             Message message = service.users().messages().get(username, messageStub.getId()).setFormat(\"raw\")\n                     .execute();\n \n             MimeMessage email = convertFromMessageToMimeMessage(message);\n+            boolean isSentWithinLastMin =\n+                    message.getInternalDate() > System.currentTimeMillis() - TimeUnit.MINUTES.toMillis(1);\n \n-            if (email.getSubject().equals(subject)) {\n+            if (email.getSubject().equals(subject) && isSentWithinLastMin) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ceeeaff1147f33a024eea6632ad56c6f72308378"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ3NzAzMg==", "bodyText": "This method (getListOfUnreadEmailOfUser) should not be useful anymore now? The other call sites are markAllUnreadEmailAsRead (no longer used, can remove), getRegistrationKeyFromUnreadEmails (no longer used, can remove), getUserAuthenticated (should be changed to a more efficient method).", "url": "https://github.com/TEAMMATES/teammates/pull/10827#discussion_r519477032", "createdAt": "2020-11-08T21:05:30Z", "author": {"login": "wkurniawan07"}, "path": "src/e2e/java/teammates/e2e/util/EmailAccount.java", "diffHunk": "@@ -100,20 +101,23 @@ public String getRegistrationKeyFromUnreadEmails(String courseName, String cours\n     }\n \n     /**\n-     * Returns true if unread mail contains mail with the specified subject.\n+     * Returns true if unread mail that arrived in the past minute contains mail with the specified subject.\n      */\n-    public boolean isEmailWithSubjectPresent(String subject)\n+    public boolean isRecentEmailWithSubjectPresent(String subject, String senderName)\n             throws IOException, MessagingException {\n \n-        List<Message> messageStubs = getListOfUnreadEmailOfUser();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ceeeaff1147f33a024eea6632ad56c6f72308378"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ3NzA0Nw==", "bodyText": "Use the primitive long instead of Long?", "url": "https://github.com/TEAMMATES/teammates/pull/10827#discussion_r519477047", "createdAt": "2020-11-08T21:05:44Z", "author": {"login": "wkurniawan07"}, "path": "src/e2e/java/teammates/e2e/util/EmailAccount.java", "diffHunk": "@@ -140,6 +144,18 @@ public void markAllUnreadEmailAsRead() throws IOException {\n         return messageStubs == null ? new ArrayList<>() : messageStubs;\n     }\n \n+    /**\n+     * Returns a list of up to maxResults number of unread emails from the sender.\n+     * Returns an empty list if there is no unread email from sender.\n+     */\n+    private List<Message> getListOfUnreadEmailFromSender(Long maxResults, String senderName) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ceeeaff1147f33a024eea6632ad56c6f72308378"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ3NzM2Ng==", "bodyText": "TEAMMATES Admin is not hardcoded; it's one of the values inbuild.properties. That means the value needs to be obtained from test.properties.\nAlso, checking by sender email should be more foolproof, i.e. there is less likelihood of other emails we're not interested in having the same sender address than having the same sender name.", "url": "https://github.com/TEAMMATES/teammates/pull/10827#discussion_r519477366", "createdAt": "2020-11-08T21:08:38Z", "author": {"login": "wkurniawan07"}, "path": "src/e2e/java/teammates/e2e/cases/BaseE2ETestCase.java", "diffHunk": "@@ -199,13 +221,12 @@ protected void verifyEmailSent(String email, String subject) {\n         try {\n             emailAccount.getUserAuthenticated();\n             int retryLimit = 5;\n-            boolean actual = emailAccount.isEmailWithSubjectPresent(subject);\n+            boolean actual = emailAccount.isRecentEmailWithSubjectPresent(subject, \"TEAMMATES Admin\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ceeeaff1147f33a024eea6632ad56c6f72308378"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "778a2ba6e1c3fd6e674ca2b35cecf3b82b921bb1", "author": {"user": {"login": "jtankw3", "name": "Tan Kian Wei Jason"}}, "url": "https://github.com/TEAMMATES/teammates/commit/778a2ba6e1c3fd6e674ca2b35cecf3b82b921bb1", "committedDate": "2020-11-09T06:42:55Z", "message": "Improve email checks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89075770243814001017efd8c3bd5a366d0d4a5a", "author": {"user": {"login": "jtankw3", "name": "Tan Kian Wei Jason"}}, "url": "https://github.com/TEAMMATES/teammates/commit/89075770243814001017efd8c3bd5a366d0d4a5a", "committedDate": "2020-11-09T06:46:22Z", "message": "Update E2E documetation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "995d6384e361edd90b5c38ec629ec5d0889b6197", "author": {"user": {"login": "jtankw3", "name": "Tan Kian Wei Jason"}}, "url": "https://github.com/TEAMMATES/teammates/commit/995d6384e361edd90b5c38ec629ec5d0889b6197", "committedDate": "2020-11-09T06:50:00Z", "message": "Remove infinite loop in FeedbackSubmitPage"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NzE2MDU1", "url": "https://github.com/TEAMMATES/teammates/pull/10827#pullrequestreview-526716055", "createdAt": "2020-11-09T22:46:03Z", "commit": {"oid": "995d6384e361edd90b5c38ec629ec5d0889b6197"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMjo0NjowNFrOHwEnzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMjo0NjowNFrOHwEnzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE2OTQyMQ==", "bodyText": "You should be able to use getListOfUnreadEmailFromSender here", "url": "https://github.com/TEAMMATES/teammates/pull/10827#discussion_r520169421", "createdAt": "2020-11-09T22:46:04Z", "author": {"login": "wkurniawan07"}, "path": "src/e2e/java/teammates/e2e/util/EmailAccount.java", "diffHunk": "@@ -47,10 +43,12 @@ public void getUserAuthenticated() throws IOException {\n         // assume user is authenticated before\n         service = new GmailServiceMaker(username).makeGmailService();\n \n-        while (true) {\n+        int retryLimit = 5;\n+        while (retryLimit > 0) {\n             try {\n+                retryLimit--;\n                 // touch one API endpoint to check authentication\n-                getListOfUnreadEmailOfUser();\n+                service.users().messages().list(username).setMaxResults(1L).execute();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "995d6384e361edd90b5c38ec629ec5d0889b6197"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65fe7e2d64820884fd0d749f0cd3e206b3c49c26", "author": {"user": {"login": "wkurniawan07", "name": "Wilson Kurniawan"}}, "url": "https://github.com/TEAMMATES/teammates/commit/65fe7e2d64820884fd0d749f0cd3e206b3c49c26", "committedDate": "2020-11-10T23:33:42Z", "message": "Merge branch 'master' into production-server-e2e"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1bb0fc302eb045df805786157174d4bffe97163", "author": {"user": {"login": "jtankw3", "name": "Tan Kian Wei Jason"}}, "url": "https://github.com/TEAMMATES/teammates/commit/a1bb0fc302eb045df805786157174d4bffe97163", "committedDate": "2020-11-11T03:14:41Z", "message": "Use getListOfUnreadEmailFromSender for getUserAuthenticated"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4213, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}