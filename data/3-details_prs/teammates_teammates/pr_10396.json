{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1NzkyODcx", "number": 10396, "title": "[#10299] Fix Distribute Points (among recipients) Question Submission", "bodyText": "Part of #10299\nOutline of solution\nEnforce 0 for \"empty\" responses in same question submission. Add frontend validation for question constraints\nEdit: Moving frontend validation to a separate PR", "createdAt": "2020-07-23T15:28:42Z", "url": "https://github.com/TEAMMATES/teammates/pull/10396", "merged": true, "mergeCommit": {"oid": "11c847d5fbc81818f7586158d33e3733755ea755"}, "closed": true, "closedAt": "2020-07-25T14:52:44Z", "author": {"login": "madanalogy"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3vFB-gH2gAyNDU1NzkyODcxOjFlYzAwYTEyZjM4ZmMyNDE5ZjllMWM2OTUxNDk1NmU2MDM5NzY1MzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc4YOLdgH2gAyNDU1NzkyODcxOmNmNTY4OTEwNTVlMjYxNGRhYTE4NjU5ZWY1NzEyMjkyYjMyYjBlMTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1ec00a12f38fc2419f9e1c69514956e603976535", "author": {"user": {"login": "madanalogy", "name": "Ahmed Bahajjaj"}}, "url": "https://github.com/TEAMMATES/teammates/commit/1ec00a12f38fc2419f9e1c69514956e603976535", "committedDate": "2020-07-23T13:02:57Z", "message": "Fix empty responses should count as zero"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NTk5OTQ3", "url": "https://github.com/TEAMMATES/teammates/pull/10396#pullrequestreview-454599947", "createdAt": "2020-07-24T02:02:07Z", "commit": {"oid": "87f66921a6b9c85ee83c14ab9ba7784e9be72c76"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMjowMjowN1rOG2hJvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMjoxMDo0M1rOG2hQqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgxOTQ1NQ==", "bodyText": "The task might be slightly difficult than you think, the current solution works but not the best I think. Firstly\n\nViolation: Event should be used for parent-child communication\nViolation: Not follow OCP principle. Image if we want to add validation and disable the button for other question types?", "url": "https://github.com/TEAMMATES/teammates/pull/10396#discussion_r459819455", "createdAt": "2020-07-24T02:02:07Z", "author": {"login": "xpdavid"}, "path": "src/web/app/components/question-submission-form/question-submission-form.component.ts", "diffHunk": "@@ -27,6 +28,9 @@ import {\n })\n export class QuestionSubmissionFormComponent implements OnInit {\n \n+  @ViewChild(ConstsumRecipientsQuestionConstraintComponent)\n+  constSumConstraint: ConstsumRecipientsQuestionConstraintComponent | undefined;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87f66921a6b9c85ee83c14ab9ba7784e9be72c76"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgxOTY5Mw==", "bodyText": "This is better suited as a interface which every *-constraint should override.", "url": "https://github.com/TEAMMATES/teammates/pull/10396#discussion_r459819693", "createdAt": "2020-07-24T02:03:19Z", "author": {"login": "xpdavid"}, "path": "src/web/app/components/question-types/question-constraint/constsum-recipients-question-constraint.component.ts", "diffHunk": "@@ -101,4 +101,43 @@ export class ConstsumRecipientsQuestionConstraintComponent implements OnInit {\n \n     return set.size !== 1;\n   }\n+\n+  get isAllPointsDistributed(): boolean {\n+    return this.totalAnsweredPoints < this.totalRequiredPoints;\n+  }\n+\n+  get isPointsOverAllocated(): boolean {\n+    return this.totalAnsweredPoints > this.totalRequiredPoints;\n+  }\n+\n+  get isWronglyAllUneven(): boolean {\n+    return this.questionDetails.distributePointsFor === FeedbackConstantSumDistributePointsType.DISTRIBUTE_ALL_UNEVENLY\n+        && !this.isAllPointsUneven;\n+  }\n+\n+  get isCorrectlyAllUneven(): boolean {\n+    return this.questionDetails.distributePointsFor === FeedbackConstantSumDistributePointsType.DISTRIBUTE_ALL_UNEVENLY\n+        && this.isAllPointsUneven;\n+  }\n+\n+  get isWronglySomeUneven(): boolean {\n+    return this.questionDetails.distributePointsFor === FeedbackConstantSumDistributePointsType.DISTRIBUTE_SOME_UNEVENLY\n+        && !this.isSomePointsUneven;\n+  }\n+\n+  get isCorrectlySomeUneven(): boolean {\n+    return this.questionDetails.distributePointsFor === FeedbackConstantSumDistributePointsType.DISTRIBUTE_SOME_UNEVENLY\n+        && this.isSomePointsUneven;\n+  }\n+\n+  get isSubmissionValid(): boolean {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87f66921a6b9c85ee83c14ab9ba7784e9be72c76"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgyMDIwNg==", "bodyText": "Same here:\nViolation: Event should be used for parent-child communication\nIdeally, there should be a event stream from the child component (that keep firing whether the input is valid or not) and here we just need to aggregate them (maybe reducer in rxjs).\nThought, honestly I am 100% sure it will works and need some research on this.", "url": "https://github.com/TEAMMATES/teammates/pull/10396#discussion_r459820206", "createdAt": "2020-07-24T02:05:37Z", "author": {"login": "xpdavid"}, "path": "src/web/app/pages-session/session-submission-page/session-submission-page.component.ts", "diffHunk": "@@ -67,6 +68,9 @@ export interface FeedbackResponsesResponse {\n })\n export class SessionSubmissionPageComponent implements OnInit, AfterViewInit {\n \n+  @ViewChild(QuestionSubmissionFormComponent)\n+  submissionForm: QuestionSubmissionFormComponent | undefined;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87f66921a6b9c85ee83c14ab9ba7784e9be72c76"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgyMDQ2MQ==", "bodyText": "I think there is no need to show error-specific message here (as they have been shown in the constraint). Just disable the submission button and say \"please check the constrains\" or something.", "url": "https://github.com/TEAMMATES/teammates/pull/10396#discussion_r459820461", "createdAt": "2020-07-24T02:06:55Z", "author": {"login": "xpdavid"}, "path": "src/web/app/pages-session/session-submission-page/session-submission-page.component.ts", "diffHunk": "@@ -525,6 +529,11 @@ export class SessionSubmissionPageComponent implements OnInit, AfterViewInit {\n    * <p>All empty feedback response will be deleted; For non-empty responses, update/create them if necessary.\n    */\n   saveFeedbackResponses(): void {\n+    if (this.submissionForm && !this.submissionForm.isValidSubmission) {\n+      this.statusMessageService.showErrorToast(\n+          'A distribute points question has an invalid response, please check your submission again');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87f66921a6b9c85ee83c14ab9ba7784e9be72c76"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgyMDcwNA==", "bodyText": "It will be a huge chaining if-else if we want to extend this to other question.", "url": "https://github.com/TEAMMATES/teammates/pull/10396#discussion_r459820704", "createdAt": "2020-07-24T02:08:12Z", "author": {"login": "xpdavid"}, "path": "src/web/app/components/question-submission-form/question-submission-form.component.ts", "diffHunk": "@@ -207,4 +211,8 @@ export class QuestionSubmissionFormComponent implements OnInit {\n     return this.feedbackResponseService.isFeedbackResponseDetailsEmpty(\n         this.model.questionType, responseDetails);\n   }\n+\n+  get isValidSubmission(): boolean {\n+    return !!(this.constSumConstraint && this.constSumConstraint.isSubmissionValid);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87f66921a6b9c85ee83c14ab9ba7784e9be72c76"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgyMDk4Mg==", "bodyText": "If you abstract others, why not do it for this also? isAllPointsDistributed?", "url": "https://github.com/TEAMMATES/teammates/pull/10396#discussion_r459820982", "createdAt": "2020-07-24T02:09:33Z", "author": {"login": "xpdavid"}, "path": "src/web/app/components/question-types/question-constraint/constsum-recipients-question-constraint.component.html", "diffHunk": "@@ -1,24 +1,24 @@\n <div class=\"row\" *ngIf=\"!isAllFormsNotAnswered\">\n   <div class=\"col-12\">\n-    <p *ngIf=\"totalAnsweredPoints < totalRequiredPoints\" class=\"text-danger\"><span class=\"fa fa-times\"></span>\n+    <p *ngIf=\"isAllPointsDistributed\" class=\"text-danger\"><span class=\"fa fa-times\"></span>\n       Actual total is {{ totalAnsweredPoints }}! Distribute the remaining {{ totalRequiredPoints - totalAnsweredPoints }} points.</p>\n \n-    <p *ngIf=\"totalAnsweredPoints > totalRequiredPoints\" class=\"text-danger\"><span class=\"fa fa-times\"></span>\n+    <p *ngIf=\"isPointsOverAllocated\" class=\"text-danger\"><span class=\"fa fa-times\"></span>\n       Actual total is {{ totalAnsweredPoints }}! Remove the extra  {{ totalAnsweredPoints - totalRequiredPoints }} points allocated.</p>\n \n     <p *ngIf=\"totalAnsweredPoints === totalRequiredPoints\" class=\"text-success\"><span class=\"fa fa-check\"></span>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87f66921a6b9c85ee83c14ab9ba7784e9be72c76"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgyMTIyNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              get isAllPointsDistributed(): boolean {\n          \n          \n            \n              get isInsufficientPointsDistributed(): boolean {\n          \n      \n    \n    \n  \n\n?", "url": "https://github.com/TEAMMATES/teammates/pull/10396#discussion_r459821224", "createdAt": "2020-07-24T02:10:43Z", "author": {"login": "xpdavid"}, "path": "src/web/app/components/question-types/question-constraint/constsum-recipients-question-constraint.component.ts", "diffHunk": "@@ -101,4 +101,43 @@ export class ConstsumRecipientsQuestionConstraintComponent implements OnInit {\n \n     return set.size !== 1;\n   }\n+\n+  get isAllPointsDistributed(): boolean {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87f66921a6b9c85ee83c14ab9ba7784e9be72c76"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "87f66921a6b9c85ee83c14ab9ba7784e9be72c76", "author": {"user": {"login": "madanalogy", "name": "Ahmed Bahajjaj"}}, "url": "https://github.com/TEAMMATES/teammates/commit/87f66921a6b9c85ee83c14ab9ba7784e9be72c76", "committedDate": "2020-07-23T15:04:53Z", "message": "Add frontend validation to constsum recipients question"}, "afterCommit": {"oid": "1ec00a12f38fc2419f9e1c69514956e603976535", "author": {"user": {"login": "madanalogy", "name": "Ahmed Bahajjaj"}}, "url": "https://github.com/TEAMMATES/teammates/commit/1ec00a12f38fc2419f9e1c69514956e603976535", "committedDate": "2020-07-23T13:02:57Z", "message": "Fix empty responses should count as zero"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NjMzMTc0", "url": "https://github.com/TEAMMATES/teammates/pull/10396#pullrequestreview-454633174", "createdAt": "2020-07-24T04:51:27Z", "commit": {"oid": "1ec00a12f38fc2419f9e1c69514956e603976535"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwNDo1MToyN1rOG2jELA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwNDo1MToyN1rOG2jELA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg1MDc5Ng==", "bodyText": "I think the problem here is the check (not the empty array thing). The check says that if user want to delete the response, they can use backspace to delete the answer (though it is not possible to pass the constraint check). If event is 0 which is valid answer, it will incorrectly enter this branch as !0 is true in JavaScript.", "url": "https://github.com/TEAMMATES/teammates/pull/10396#discussion_r459850796", "createdAt": "2020-07-24T04:51:27Z", "author": {"login": "xpdavid"}, "path": "src/web/app/components/question-types/question-edit-answer-form/constsum-recipients-question-edit-answer-form.component.ts", "diffHunk": "@@ -28,8 +28,8 @@ export class ConstsumRecipientsQuestionEditAnswerFormComponent\n    */\n   triggerResponse(event: number): void {\n     if (!event) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ec00a12f38fc2419f9e1c69514956e603976535"}, "originalPosition": 3}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6aa933a7f942ffd4bd7486fdfffdfc5cc9518e96", "author": {"user": {"login": "madanalogy", "name": "Ahmed Bahajjaj"}}, "url": "https://github.com/TEAMMATES/teammates/commit/6aa933a7f942ffd4bd7486fdfffdfc5cc9518e96", "committedDate": "2020-07-25T02:00:00Z", "message": "Remove check in constsum-recipients-question-edit-answer-form.component.ts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MjUyNDgy", "url": "https://github.com/TEAMMATES/teammates/pull/10396#pullrequestreview-455252482", "createdAt": "2020-07-25T02:04:49Z", "commit": {"oid": "6aa933a7f942ffd4bd7486fdfffdfc5cc9518e96"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf56891055e2614daa18659ef5712292b32b0e15", "author": {"user": {"login": "madanalogy", "name": "Ahmed Bahajjaj"}}, "url": "https://github.com/TEAMMATES/teammates/commit/cf56891055e2614daa18659ef5712292b32b0e15", "committedDate": "2020-07-25T12:59:03Z", "message": "Merge branch 'master' into 10299-constsum"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4309, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}