{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0OTkxNzY3", "number": 10282, "title": "[#10212] Refactor search service's searchInstructor method", "bodyText": "Fixes #10212\nSolution\nIn order to use StudentListRowModel, I replaced every SearchStudentsTable with SearchStudentsListRowTable.\nModified InstructorSearchResult, getPrivileges, combinePrivileges, getCoursesWithSections to support the new interface.\nAfter the modification, flattenStudentTable function is no longer needed, so I deleted the function.\nAlso, modified the component test to reflect the changes and changed the name of getCoursesWithSections to getCoursesWithStudents because the new interface, SearchStudentsListRowTable, does not contain direct information about sections.", "createdAt": "2020-07-06T20:43:07Z", "url": "https://github.com/TEAMMATES/teammates/pull/10282", "merged": true, "mergeCommit": {"oid": "1df7a07640bb533ab4202a2b745107e2e64cfd5e"}, "closed": true, "closedAt": "2020-07-15T03:36:47Z", "author": {"login": "edwardkang0925"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyWLpsAH2gAyNDQ0OTkxNzY3OmY0OTdkNTk3MmYwYWJmZTg1N2Q3YjA2OGI4MGE4MTIyZWI5MjZhYzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1B3BGAH2gAyNDQ0OTkxNzY3OmY5NTBhMzU1ZjY2NzAyOGYyMmE2ZGY0Mjg0NTQwNDBjMmY5MTRjYTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f497d5972f0abfe857d7b068b80a8122eb926ac8", "author": {"user": {"login": "edwardkang0925", "name": "edwardkang0925"}}, "url": "https://github.com/TEAMMATES/teammates/commit/f497d5972f0abfe857d7b068b80a8122eb926ac8", "committedDate": "2020-07-06T19:12:56Z", "message": "refactor search service (before modifying component test)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2a3b9ef0298b8e68154393e5988112310877e2f", "author": {"user": {"login": "edwardkang0925", "name": "edwardkang0925"}}, "url": "https://github.com/TEAMMATES/teammates/commit/d2a3b9ef0298b8e68154393e5988112310877e2f", "committedDate": "2020-07-06T20:10:11Z", "message": "modified the component tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3601d5cd5f987bfa61ae8258b9e12b003ce0ee46", "author": {"user": {"login": "edwardkang0925", "name": "edwardkang0925"}}, "url": "https://github.com/TEAMMATES/teammates/commit/3601d5cd5f987bfa61ae8258b9e12b003ce0ee46", "committedDate": "2020-07-06T20:32:41Z", "message": "changed naming convention more intuitively"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNTM4NDE2", "url": "https://github.com/TEAMMATES/teammates/pull/10282#pullrequestreview-443538416", "createdAt": "2020-07-07T03:29:43Z", "commit": {"oid": "3601d5cd5f987bfa61ae8258b9e12b003ce0ee46"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwMzoyOTo0M1rOGtt8BA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwMzozMDoxOFrOGtt8yA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU5MTc0OA==", "bodyText": "Although the data has changed shape, we should still have a test for sections to ensure that the number of sections matches.", "url": "https://github.com/TEAMMATES/teammates/pull/10282#discussion_r450591748", "createdAt": "2020-07-07T03:29:43Z", "author": {"login": "t-cheepeng"}, "path": "src/web/services/search.service.spec.ts", "diffHunk": "@@ -179,37 +179,26 @@ describe('SearchService', () => {\n     );\n   });\n \n-  it('should parse students into courses with sections correctly', () => {\n+  it('should parse students into courses correctly', () => {\n     const { students }: { students: Student[] } = mockStudents;\n \n     // Number of courses should match\n-    expect(coursesWithSections.length).toEqual(\n+    expect(coursesWithStudents.length).toEqual(\n       Array.from(new Set(students.map((s: Student) => s.courseId))).length,\n     );\n \n-    // Number of sections in a course should match\n+    // Number of students in a course should match\n     expect(\n-      coursesWithSections.filter((t: SearchStudentsTable) => t.courseId === students[0].courseId)[0]\n-        .sections.length,\n+      coursesWithStudents.filter((t: SearchStudentsListRowTable) => t.courseId === students[0].courseId)[0]\n+        .students.length,\n     ).toEqual(\n       Array.from(\n         new Set(\n           students\n-            .filter((s: Student) => s.courseId === students[0].courseId)\n-            .map((s: Student) => s.sectionName),\n+            .filter((s: Student) => s.courseId === students[0].courseId),\n         ),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3601d5cd5f987bfa61ae8258b9e12b003ce0ee46"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU5MTk0NA==", "bodyText": "Same here. Should rewrite the test to check for number of students in a section instead of removing it", "url": "https://github.com/TEAMMATES/teammates/pull/10282#discussion_r450591944", "createdAt": "2020-07-07T03:30:18Z", "author": {"login": "t-cheepeng"}, "path": "src/web/services/search.service.spec.ts", "diffHunk": "@@ -179,37 +179,26 @@ describe('SearchService', () => {\n     );\n   });\n \n-  it('should parse students into courses with sections correctly', () => {\n+  it('should parse students into courses correctly', () => {\n     const { students }: { students: Student[] } = mockStudents;\n \n     // Number of courses should match\n-    expect(coursesWithSections.length).toEqual(\n+    expect(coursesWithStudents.length).toEqual(\n       Array.from(new Set(students.map((s: Student) => s.courseId))).length,\n     );\n \n-    // Number of sections in a course should match\n+    // Number of students in a course should match\n     expect(\n-      coursesWithSections.filter((t: SearchStudentsTable) => t.courseId === students[0].courseId)[0]\n-        .sections.length,\n+      coursesWithStudents.filter((t: SearchStudentsListRowTable) => t.courseId === students[0].courseId)[0]\n+        .students.length,\n     ).toEqual(\n       Array.from(\n         new Set(\n           students\n-            .filter((s: Student) => s.courseId === students[0].courseId)\n-            .map((s: Student) => s.sectionName),\n+            .filter((s: Student) => s.courseId === students[0].courseId),\n         ),\n       ).length,\n     );\n-\n-    // Number of students in a section should match\n-    expect(\n-      coursesWithSections\n-        .filter((t: SearchStudentsTable) => t.courseId === students[0].courseId)[0]\n-        .sections.filter((s: StudentListSectionData) => s.sectionName === students[0].sectionName)[0]\n-        .students.length,\n-    ).toEqual(\n-      students.filter((s: Student) => s.sectionName === students[0].sectionName).length,\n-    );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3601d5cd5f987bfa61ae8258b9e12b003ce0ee46"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b1d1fb735bb4b16ff97648b0000c87f193eaae3", "author": {"user": {"login": "edwardkang0925", "name": "edwardkang0925"}}, "url": "https://github.com/TEAMMATES/teammates/commit/2b1d1fb735bb4b16ff97648b0000c87f193eaae3", "committedDate": "2020-07-07T05:58:32Z", "message": "fixed the component tests regarding sections"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNzgxNTY2", "url": "https://github.com/TEAMMATES/teammates/pull/10282#pullrequestreview-443781566", "createdAt": "2020-07-07T10:57:32Z", "commit": {"oid": "2b1d1fb735bb4b16ff97648b0000c87f193eaae3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MjIzODA4", "url": "https://github.com/TEAMMATES/teammates/pull/10282#pullrequestreview-444223808", "createdAt": "2020-07-07T20:25:25Z", "commit": {"oid": "2b1d1fb735bb4b16ff97648b0000c87f193eaae3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMDoyNToyNVrOGuOVZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMDoyNToyNVrOGuOVZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEyMjUzNA==", "bodyText": "It is too expensive to load section for every student. Either you want to group them first to load privilege for one section or use some cache variable to keep the privilege already loaded. Maybe @t-cheepeng can help.", "url": "https://github.com/TEAMMATES/teammates/pull/10282#discussion_r451122534", "createdAt": "2020-07-07T20:25:25Z", "author": {"login": "xpdavid"}, "path": "src/web/services/search.service.ts", "diffHunk": "@@ -167,17 +155,17 @@ export class SearchService {\n   }\n \n   getPrivileges(\n-    coursesWithSections: SearchStudentsTable[],\n+    coursesWithStudents: SearchStudentsListRowTable[],\n   ): Observable<InstructorPrivilege[]> {\n-    if (coursesWithSections.length === 0) {\n+    if (coursesWithStudents.length === 0) {\n       return of([]);\n     }\n     return forkJoin(\n-      coursesWithSections.map((course: SearchStudentsTable) => {\n-        return course.sections.map((section: StudentListSectionData) => {\n+      coursesWithStudents.map((course: SearchStudentsListRowTable) => {\n+        return course.students.map((studentModel: StudentListRowModel) => {\n           return this.instructorService.loadInstructorPrivilege({", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b1d1fb735bb4b16ff97648b0000c87f193eaae3"}, "originalPosition": 100}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "497c5935e4fd346eed7b32722052a987a9f9eedf", "author": {"user": {"login": "edwardkang0925", "name": "edwardkang0925"}}, "url": "https://github.com/TEAMMATES/teammates/commit/497c5935e4fd346eed7b32722052a987a9f9eedf", "committedDate": "2020-07-09T17:04:25Z", "message": "deleted the declaration of SearchStudentsTable and modified getPrivileges for performance improvement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8807f8805339ce6aee9a776717c378ef93ac3f0d", "author": {"user": {"login": "edwardkang0925", "name": "edwardkang0925"}}, "url": "https://github.com/TEAMMATES/teammates/commit/8807f8805339ce6aee9a776717c378ef93ac3f0d", "committedDate": "2020-07-09T18:27:02Z", "message": "Merge branch 'master' into searchInstructorRefactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c12cf274905823a99aec82258bc44e2f0b751af9", "author": {"user": {"login": "edwardkang0925", "name": "edwardkang0925"}}, "url": "https://github.com/TEAMMATES/teammates/commit/c12cf274905823a99aec82258bc44e2f0b751af9", "committedDate": "2020-07-10T02:34:32Z", "message": "Merge branch 'master' into searchInstructorRefactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MzIyMDUz", "url": "https://github.com/TEAMMATES/teammates/pull/10282#pullrequestreview-446322053", "createdAt": "2020-07-10T11:17:51Z", "commit": {"oid": "c12cf274905823a99aec82258bc44e2f0b751af9"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxMToxNzo1MlrOGvzotw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxMToyNTowMlrOGvzz0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc4MjI2Mw==", "bodyText": "@edwardkang0925 Try not to use any[] as the type. You should explicitly state the variable type where possible", "url": "https://github.com/TEAMMATES/teammates/pull/10282#discussion_r452782263", "createdAt": "2020-07-10T11:17:52Z", "author": {"login": "t-cheepeng"}, "path": "src/web/services/search.service.ts", "diffHunk": "@@ -169,47 +157,44 @@ export class SearchService {\n   }\n \n   getPrivileges(\n-    coursesWithSections: SearchStudentsTable[],\n+    coursesWithStudents: SearchStudentsListRowTable[],\n   ): Observable<InstructorPrivilege[]> {\n-    if (coursesWithSections.length === 0) {\n+    if (coursesWithStudents.length === 0) {\n       return of([]);\n     }\n-    return forkJoin(\n-      coursesWithSections.map((course: SearchStudentsTable) => {\n-        return course.sections.map((section: StudentListSectionData) => {\n-          return this.instructorService.loadInstructorPrivilege({\n-            courseId: course.courseId,\n-            sectionName: section.sectionName,\n-          });\n-        });\n-      }).reduce(\n-        (acc: Observable<InstructorPrivilege>[], val: Observable<InstructorPrivilege>[]) =>\n-        acc.concat(val),\n-        [],\n-      ),\n-    );\n+    const privileges: any[] = [];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c12cf274905823a99aec82258bc44e2f0b751af9"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc4NTEwNg==", "bodyText": "You can probably use a Record<string, Observable<InstructorPrivilege>> to make things faster. Map from section name to the observable.", "url": "https://github.com/TEAMMATES/teammates/pull/10282#discussion_r452785106", "createdAt": "2020-07-10T11:25:02Z", "author": {"login": "t-cheepeng"}, "path": "src/web/services/search.service.ts", "diffHunk": "@@ -169,47 +157,44 @@ export class SearchService {\n   }\n \n   getPrivileges(\n-    coursesWithSections: SearchStudentsTable[],\n+    coursesWithStudents: SearchStudentsListRowTable[],\n   ): Observable<InstructorPrivilege[]> {\n-    if (coursesWithSections.length === 0) {\n+    if (coursesWithStudents.length === 0) {\n       return of([]);\n     }\n-    return forkJoin(\n-      coursesWithSections.map((course: SearchStudentsTable) => {\n-        return course.sections.map((section: StudentListSectionData) => {\n-          return this.instructorService.loadInstructorPrivilege({\n-            courseId: course.courseId,\n-            sectionName: section.sectionName,\n-          });\n-        });\n-      }).reduce(\n-        (acc: Observable<InstructorPrivilege>[], val: Observable<InstructorPrivilege>[]) =>\n-        acc.concat(val),\n-        [],\n-      ),\n-    );\n+    const privileges: any[] = [];\n+    for (const course of coursesWithStudents) {\n+      const distinctSections: string[] = Array.from(\n+        new Set(course.students.map((studentModel: StudentListRowModel) => studentModel.student.sectionName)));\n+      const instructorPrivileges: Observable<InstructorPrivilege>[] = distinctSections.map((section: string) =>\n+        this.instructorService.loadInstructorPrivilege({ courseId: course.courseId, sectionName: section }));\n+      for (const studentModel of course.students) {\n+        privileges.push(instructorPrivileges[distinctSections.indexOf(studentModel.student.sectionName)]);\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c12cf274905823a99aec82258bc44e2f0b751af9"}, "originalPosition": 117}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3488abf2eb5782de782c9ce8aa86bbf272978e0", "author": {"user": {"login": "edwardkang0925", "name": "edwardkang0925"}}, "url": "https://github.com/TEAMMATES/teammates/commit/d3488abf2eb5782de782c9ce8aa86bbf272978e0", "committedDate": "2020-07-12T16:11:03Z", "message": "specified type of privileges and used Record for performance improvement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac081a8095791719ea6493e7838beeacd383bf6d", "author": {"user": {"login": "edwardkang0925", "name": "edwardkang0925"}}, "url": "https://github.com/TEAMMATES/teammates/commit/ac081a8095791719ea6493e7838beeacd383bf6d", "committedDate": "2020-07-13T03:25:44Z", "message": "replaced for loops with forEach"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NTkzMzM3", "url": "https://github.com/TEAMMATES/teammates/pull/10282#pullrequestreview-448593337", "createdAt": "2020-07-15T02:50:36Z", "commit": {"oid": "ac081a8095791719ea6493e7838beeacd383bf6d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMjo1MDozNlrOGxsQ8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMjo1MDozNlrOGxsQ8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc1ODY0MQ==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/TEAMMATES/teammates/pull/10282#discussion_r454758641", "createdAt": "2020-07-15T02:50:36Z", "author": {"login": "xpdavid"}, "path": "src/web/services/search.service.ts", "diffHunk": "@@ -169,47 +157,48 @@ export class SearchService {\n   }\n \n   getPrivileges(\n-    coursesWithSections: SearchStudentsTable[],\n+    coursesWithStudents: SearchStudentsListRowTable[],\n   ): Observable<InstructorPrivilege[]> {\n-    if (coursesWithSections.length === 0) {\n+    if (coursesWithStudents.length === 0) {\n       return of([]);\n     }\n-    return forkJoin(\n-      coursesWithSections.map((course: SearchStudentsTable) => {\n-        return course.sections.map((section: StudentListSectionData) => {\n-          return this.instructorService.loadInstructorPrivilege({\n-            courseId: course.courseId,\n-            sectionName: section.sectionName,\n-          });\n-        });\n-      }).reduce(\n-        (acc: Observable<InstructorPrivilege>[], val: Observable<InstructorPrivilege>[]) =>\n-        acc.concat(val),\n-        [],\n-      ),\n-    );\n+    const privileges: Observable<InstructorPrivilege>[] = [];\n+    coursesWithStudents.forEach((course: SearchStudentsListRowTable) => {\n+      const sectionToPrivileges: Record<string, Observable<InstructorPrivilege>> = {};\n+      Array.from(\n+        new Set(course.students.map((studentModel: StudentListRowModel) => studentModel.student.sectionName)),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac081a8095791719ea6493e7838beeacd383bf6d"}, "originalPosition": 113}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f950a355f667028f22a6df428454040c2f914ca4", "author": {"user": {"login": "t-cheepeng", "name": "t-cheepeng"}}, "url": "https://github.com/TEAMMATES/teammates/commit/f950a355f667028f22a6df428454040c2f914ca4", "committedDate": "2020-07-15T03:14:04Z", "message": "Merge branch 'master' into searchInstructorRefactor"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4274, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}