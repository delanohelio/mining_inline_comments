{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5MDM5Mjk5", "number": 5828, "title": "[C][Client]Fix data lost when libcurl write-data callback function is called multiple times", "bodyText": "When using libcurl to get the http response, the application program needs to configure the write-data callback function.\n       curl_easy_setopt(handle,\n                         CURLOPT_WRITEFUNCTION,\n                         writeDataCallback);\n       curl_easy_setopt(handle,\n                         CURLOPT_WRITEDATA,\n                         &apiClient->dataReceived);\nWhen libcurl receives data(http response), it will call the callback function (defined in openapi-generator/c-libcurl)\nsize_t writeDataCallback(void *buffer, size_t size, size_t nmemb, void *userp) {\n...\n}\nto put the data from void *buffer to user's memory location void *userp (&apiClient->dataReceived).\nBut sometimes (commonly the response data is big) for a http request,  the response data will be divided to multiple parts and sent by multiple times, so the callback function writeDataCallback will be called multiple times.\nThe current writeDataCallback will lose the data the last time received:\nsize_t writeDataCallback(void *buffer, size_t size, size_t nmemb, void *userp) {\n    *(char **) userp = strdup(buffer);    <=== The old userp will be discarded, and userp points to a new memory.\n    return size * nmemb;\n}\nSo I changed the apiClient_t and writeDataCallback\ntypedef struct apiClient_t {\n...\n    long dataReceivedLen;\n...\n} apiClient_t;\n\n       curl_easy_setopt(handle,\n                         CURLOPT_WRITEDATA,\n                         apiClient);\n\nsize_t writeDataCallback(void *buffer, size_t size, size_t nmemb, void *userp) {\n    size_t size_this_time = nmemb * size;\n    apiClient_t *apiClient = (apiClient_t *)userp;\n    apiClient->dataReceived = (char *)realloc( apiClient->dataReceived, apiClient->dataReceivedLen + size_this_time + 1);   <== now the previous data will be reserved.\n    memcpy(apiClient->dataReceived + apiClient->dataReceivedLen, buffer, size_this_time);\n    apiClient->dataReceivedLen += size_this_time;\n    return size_this_time;\n}\nReference:\nhttps://stackoverflow.com/questions/3573146/problem-using-libcurl-it-does-not-appear-to-get-the-entire-page\n\n\nPR checklist\n\n Read the contribution guidelines.\n If contributing template-only or documentation-only changes which will change sample output, build the project before.\n Run the shell script(s) under ./bin/ (or Windows batch scripts under.\\bin\\windows) to update Petstore samples related to your fix. This is important, as CI jobs will verify all generator outputs of your HEAD commit, and these must match the expectations made by your contribution. You only need to run ./bin/{LANG}-petstore.sh, ./bin/openapi3/{LANG}-petstore.sh if updating the code or mustache templates for a language ({LANG}) (e.g. php, ruby, python, etc).\n File the PR against the correct branch: master, 4.3.x, 5.0.x. Default: master.\n Copy the technical committee to review the pull request if your PR is targeting a particular programming language.\n\n@wing328 @zhemant @michelealbano", "createdAt": "2020-04-05T11:32:22Z", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5828", "merged": true, "mergeCommit": {"oid": "41664b3ba815ed8819d892e22811f4a87334a0ac"}, "closed": true, "closedAt": "2020-04-16T04:45:45Z", "author": {"login": "ityuhui"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcUoAIlgH2gAyMzk5MDM5Mjk5OmYyMWJkYWVmZGViOWI3YzQzMTM2NWI2ZGZkNTExNzIzZWIzNTViZGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcWciIHAH2gAyMzk5MDM5Mjk5OmI2ZmIyMmZlOTQzZDQ0OGM1OTZiZWYwZWJiMDVlNzU1ZWM0MTMwYTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f21bdaefdeb9b7c431365b6dfd511723eb355bdd", "author": {"user": {"login": "ityuhui", "name": "Hui Yu"}}, "url": "https://github.com/OpenAPITools/openapi-generator/commit/f21bdaefdeb9b7c431365b6dfd511723eb355bdd", "committedDate": "2020-04-05T11:00:55Z", "message": "[C][Client]Fix the defect of data lost when libcurl write-data callback function (configured by CURLOPT_WRITEFUNCTION) is called multiple times."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNTAzMDMx", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5828#pullrequestreview-391503031", "createdAt": "2020-04-10T15:27:47Z", "commit": {"oid": "09cdc31a37127b9304a7cff29fec606914058fae"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNToyNzo0N1rOGD9oPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNToyNzo0N1rOGD9oPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgwODYzNg==", "bodyText": "Is there any specific reason to keep this outside of the if check? or can it be moved inside also? as it will be already 0 if the if statement is false. So the line becomes obsolete.", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5828#discussion_r406808636", "createdAt": "2020-04-10T15:27:47Z", "author": {"login": "zhemant"}, "path": "modules/openapi-generator/src/main/resources/C-libcurl/api-body.mustache", "diffHunk": "@@ -373,7 +373,9 @@ end:\n     {{/returnTypeIsPrimitive}}\n     if (apiClient->dataReceived) {\n         free(apiClient->dataReceived);\n+        apiClient->dataReceived = NULL;\n     }\n+    apiClient->dataReceivedLen = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09cdc31a37127b9304a7cff29fec606914058fae"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d3bdc003f1328c1d2bc2e06919538b9a3cdac4c", "author": {"user": {"login": "ityuhui", "name": "Hui Yu"}}, "url": "https://github.com/OpenAPITools/openapi-generator/commit/9d3bdc003f1328c1d2bc2e06919538b9a3cdac4c", "committedDate": "2020-04-11T02:40:44Z", "message": "Merge branch 'master' of https://github.com/ityuhui/openapi-generator into yhlibcurlwrite"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6fb22fe943d448c596bef0ebb05e755ec4130a5", "author": {"user": {"login": "ityuhui", "name": "Hui Yu"}}, "url": "https://github.com/OpenAPITools/openapi-generator/commit/b6fb22fe943d448c596bef0ebb05e755ec4130a5", "committedDate": "2020-04-11T02:47:02Z", "message": "[C][Client]Fix data lost when libcurl write-data callback function is called multiple times (Reset count)"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2557, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}