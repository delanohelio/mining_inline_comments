{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwMTU3OTcz", "number": 5621, "title": "[python/asyncio] explicitly close client session and asynchronous context manager", "bodyText": "From #5094 python clients expose api-client.close() method and the context manager. In this PR I added closing aiohttp.ClientSession there to allow users clean up objects in a more predictive way.\n\nPR checklist\n\n Read the contribution guidelines.\n If contributing template-only or documentation-only changes which will change sample output, build the project before.\n Run the shell script(s) under ./bin/ (or Windows batch scripts under.\\bin\\windows) to update Petstore samples related to your fix. This is important, as CI jobs will verify all generator outputs of your HEAD commit, and these must match the expectations made by your contribution. You only need to run ./bin/{LANG}-petstore.sh, ./bin/openapi3/{LANG}-petstore.sh if updating the code or mustache templates for a language ({LANG}) (e.g. php, ruby, python, etc).\n File the PR against the correct branch: master, 4.3.x, 5.0.x. Default: master.\n Copy the technical committee to review the pull request if your PR is targeting a particular programming language.\n\ncc: @taxpon (2017/07) @frol (2017/07) @mbohlool (2017/07) @cbornet (2017/09) @kenjones-cisco (2017/11) @tomplus (2018/10) @Jyhess (2019/01) @slash-arun (2019/11) @spacether (2019/11)\nThank you reviewing and merging.", "createdAt": "2020-03-18T01:11:34Z", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5621", "merged": true, "mergeCommit": {"oid": "625c734cfe024f0e0ee2675514e32b11e1f84e8d"}, "closed": true, "closedAt": "2020-03-25T14:59:28Z", "author": {"login": "tomplus"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOs2kfgFqTM3NjUwNDY0NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRI0ZaAFqTM4MTIzMjc1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTA0NjQ1", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5621#pullrequestreview-376504645", "createdAt": "2020-03-18T01:16:27Z", "commit": {"oid": "4914ce8f46b461de882c9dc9ac534a9882f25819"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMToxNjoyN1rOF3zRNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMToxNjoyN1rOF3zRNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NTk4OA==", "bodyText": "I only see this being used in this one file. Why did you move it to the util file?\nIf it is used in more than one file it makes sense to put it there as a common utility tool, but if it is only needed here can you keep it here?", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5621#discussion_r394055988", "createdAt": "2020-03-18T01:16:27Z", "author": {"login": "spacether"}, "path": "samples/client/petstore/python-asyncio/tests/test_pet_api.py", "diffHunk": "@@ -27,15 +27,6 @@\n HOST = 'http://localhost:80/v2'\n \n \n-def async_test(f):\n-    def wrapper(*args, **kwargs):\n-        coro = asyncio.coroutine(f)\n-        future = coro(*args, **kwargs)\n-        loop = asyncio.get_event_loop()\n-        loop.run_until_complete(future)\n-    return wrapper", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4914ce8f46b461de882c9dc9ac534a9882f25819"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTA1NzIx", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5621#pullrequestreview-376505721", "createdAt": "2020-03-18T01:20:27Z", "commit": {"oid": "4914ce8f46b461de882c9dc9ac534a9882f25819"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMToyMDoyN1rOF3zU4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMToyMDoyN1rOF3zU4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NjkyOQ==", "bodyText": "Can you add a test that checks the pool manager and ensures that it is closed like we did here:\nsamples/client/petstore/python-experimental/tests/test_api_client.py?", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5621#discussion_r394056929", "createdAt": "2020-03-18T01:20:27Z", "author": {"login": "spacether"}, "path": "samples/client/petstore/python-asyncio/petstore_api/rest.py", "diffHunk": "@@ -85,8 +85,9 @@ def __init__(self, configuration, pools_size=4, maxsize=None):\n                 connector=connector\n             )\n \n-    def __del__(self):\n-        asyncio.ensure_future(self.pool_manager.close())\n+    def close(self):\n+        if not self.pool_manager.closed:\n+            asyncio.ensure_future(self.pool_manager.close())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4914ce8f46b461de882c9dc9ac534a9882f25819"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTA3NTAy", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5621#pullrequestreview-376507502", "createdAt": "2020-03-18T01:26:51Z", "commit": {"oid": "4c31ab94af0d593d528228361eab32cced07e972"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMToyNjo1MVrOF3zaog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMToyNjo1MVrOF3zaog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1ODQwMg==", "bodyText": "Can you delete HOST, I don't think we use it here", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5621#discussion_r394058402", "createdAt": "2020-03-18T01:26:51Z", "author": {"login": "spacether"}, "path": "samples/client/petstore/python-asyncio/tests/test_api_client.py", "diffHunk": "@@ -0,0 +1,31 @@\n+# coding: utf-8\n+\n+# flake8: noqa\n+\n+import os\n+import unittest\n+import asyncio\n+import weakref\n+\n+from tests.util import async_test\n+import petstore_api\n+\n+HOST = 'http://localhost:80/v2'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c31ab94af0d593d528228361eab32cced07e972"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTgwNDI2", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5621#pullrequestreview-376580426", "createdAt": "2020-03-18T05:53:34Z", "commit": {"oid": "4b2e910c823f7bb5ccaab098dd660449ea849046"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwNTo1MzozNFrOF33KPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwNTo1MzozNFrOF33KPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDExOTc0Mw==", "bodyText": "When do we check that the pool_manager is closed?\nWhy is rest_pool_ref.closed not True?", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5621#discussion_r394119743", "createdAt": "2020-03-18T05:53:34Z", "author": {"login": "spacether"}, "path": "samples/client/petstore/python-asyncio/tests/test_api_client.py", "diffHunk": "@@ -0,0 +1,27 @@\n+# coding: utf-8\n+\n+# flake8: noqa\n+\n+import unittest\n+import weakref\n+\n+from tests.util import async_test\n+import petstore_api\n+\n+\n+class TestApiClient(unittest.TestCase):\n+\n+    @async_test\n+    def test_context_manager_closes_client(self):\n+\n+        with petstore_api.ApiClient() as client:\n+            # thread pool\n+            self.assertIsNotNone(client.pool)\n+            pool_ref = weakref.ref(client._pool)\n+            self.assertIsNotNone(pool_ref())\n+            # pool_manager\n+            self.assertFalse(client.rest_client.pool_manager.closed)\n+            rest_pool_ref = client.rest_client.pool_manager\n+\n+        self.assertIsNone(pool_ref())\n+        self.assertFalse(rest_pool_ref.closed)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b2e910c823f7bb5ccaab098dd660449ea849046"}, "originalPosition": 27}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4b2e910c823f7bb5ccaab098dd660449ea849046", "author": {"user": {"login": "tomplus", "name": "Tomasz Prus"}}, "url": "https://github.com/OpenAPITools/openapi-generator/commit/4b2e910c823f7bb5ccaab098dd660449ea849046", "committedDate": "2020-03-18T01:32:55Z", "message": "[python/asyncio] remove usuned lines"}, "afterCommit": {"oid": "1fb1a25320df76022451760f9008e41f4f9e0623", "author": {"user": {"login": "tomplus", "name": "Tomasz Prus"}}, "url": "https://github.com/OpenAPITools/openapi-generator/commit/1fb1a25320df76022451760f9008e41f4f9e0623", "committedDate": "2020-03-18T11:33:34Z", "message": "[python/asyncio] explicitly close client session via async context manager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "884d0e8a195afe9d537f207a6e99d50da5c52de1", "author": {"user": {"login": "tomplus", "name": "Tomasz Prus"}}, "url": "https://github.com/OpenAPITools/openapi-generator/commit/884d0e8a195afe9d537f207a6e99d50da5c52de1", "committedDate": "2020-03-18T19:22:30Z", "message": "[python/asyncio] explicitly close client session via async context manager"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1fb1a25320df76022451760f9008e41f4f9e0623", "author": {"user": {"login": "tomplus", "name": "Tomasz Prus"}}, "url": "https://github.com/OpenAPITools/openapi-generator/commit/1fb1a25320df76022451760f9008e41f4f9e0623", "committedDate": "2020-03-18T11:33:34Z", "message": "[python/asyncio] explicitly close client session via async context manager"}, "afterCommit": {"oid": "884d0e8a195afe9d537f207a6e99d50da5c52de1", "author": {"user": {"login": "tomplus", "name": "Tomasz Prus"}}, "url": "https://github.com/OpenAPITools/openapi-generator/commit/884d0e8a195afe9d537f207a6e99d50da5c52de1", "committedDate": "2020-03-18T19:22:30Z", "message": "[python/asyncio] explicitly close client session via async context manager"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxMjMyNzU3", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5621#pullrequestreview-381232757", "createdAt": "2020-03-25T14:59:16Z", "commit": {"oid": "884d0e8a195afe9d537f207a6e99d50da5c52de1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2606, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}