{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3Njk3MzI5", "number": 7821, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwODo0Mzo1M1rODuRwIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwODo0ODoxMVrODuR7Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5ODUxOTM5OnYy", "diffSide": "RIGHT", "path": "graylog2-server/src/main/java/org/graylog2/inputs/persistence/InputStatusService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwODo0Mzo1M1rOGALoAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMzoxOToyM1rOGAVGxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg0MzY1MQ==", "bodyText": "I think we should bind this service in a singleton scope (bind(InputStatusService.class).asEagerSingleton() and add @Singleton annotation to this class for documentation purposes) in the guice bindings to avoid multiple instances of this class. The problem is that every instance would register with the EventBus and since we don't have lifecycle support for this object where we could call unregister on shutdown, we would basically leak references into the event bus. We have that issue in other services as well and mostly solve it by binding the service as a singleton.", "url": "https://github.com/Graylog2/graylog2-server/pull/7821#discussion_r402843651", "createdAt": "2020-04-03T08:43:53Z", "author": {"login": "bernd"}, "path": "graylog2-server/src/main/java/org/graylog2/inputs/persistence/InputStatusService.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package org.graylog2.inputs.persistence;\n+\n+import com.google.common.eventbus.EventBus;\n+import com.mongodb.DB;\n+import com.mongodb.DBCollection;\n+import org.apache.shiro.event.Subscribe;\n+import org.bson.types.ObjectId;\n+import org.graylog2.bindings.providers.MongoJackObjectMapperProvider;\n+import org.graylog2.database.MongoConnection;\n+import org.graylog2.rest.models.system.inputs.responses.InputDeleted;\n+import org.mongojack.JacksonDBCollection;\n+import org.mongojack.WriteResult;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.inject.Inject;\n+import java.util.Optional;\n+\n+/**\n+ * This is a simple wrapper around MongoDB to allow storage of state data for stateful Inputs.\n+ *\n+ * Inputs using this service are responsible for defining their own model for InputStatusRecord.inputStateData\n+ */\n+public class InputStatusService {\n+    private static final Logger LOG = LoggerFactory.getLogger(InputStatusService.class);\n+\n+    private static final String INPUT_STATUS_COLLECTION = \"input_status\";\n+\n+    private final JacksonDBCollection<InputStatusRecord, ObjectId> statusCollection;\n+\n+    @Inject\n+    public InputStatusService(MongoConnection mongoConnection,\n+                              MongoJackObjectMapperProvider objectMapperProvider,\n+                              EventBus eventBus) {\n+        DB mongoDatabase = mongoConnection.getDatabase();\n+        DBCollection collection = mongoDatabase.getCollection(INPUT_STATUS_COLLECTION);\n+\n+        eventBus.register(this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "985841150be202ff29ce46033fe9c960e279ccf4"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk5ODk4MA==", "bodyText": "Will do", "url": "https://github.com/Graylog2/graylog2-server/pull/7821#discussion_r402998980", "createdAt": "2020-04-03T13:19:23Z", "author": {"login": "waab76"}, "path": "graylog2-server/src/main/java/org/graylog2/inputs/persistence/InputStatusService.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package org.graylog2.inputs.persistence;\n+\n+import com.google.common.eventbus.EventBus;\n+import com.mongodb.DB;\n+import com.mongodb.DBCollection;\n+import org.apache.shiro.event.Subscribe;\n+import org.bson.types.ObjectId;\n+import org.graylog2.bindings.providers.MongoJackObjectMapperProvider;\n+import org.graylog2.database.MongoConnection;\n+import org.graylog2.rest.models.system.inputs.responses.InputDeleted;\n+import org.mongojack.JacksonDBCollection;\n+import org.mongojack.WriteResult;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.inject.Inject;\n+import java.util.Optional;\n+\n+/**\n+ * This is a simple wrapper around MongoDB to allow storage of state data for stateful Inputs.\n+ *\n+ * Inputs using this service are responsible for defining their own model for InputStatusRecord.inputStateData\n+ */\n+public class InputStatusService {\n+    private static final Logger LOG = LoggerFactory.getLogger(InputStatusService.class);\n+\n+    private static final String INPUT_STATUS_COLLECTION = \"input_status\";\n+\n+    private final JacksonDBCollection<InputStatusRecord, ObjectId> statusCollection;\n+\n+    @Inject\n+    public InputStatusService(MongoConnection mongoConnection,\n+                              MongoJackObjectMapperProvider objectMapperProvider,\n+                              EventBus eventBus) {\n+        DB mongoDatabase = mongoConnection.getDatabase();\n+        DBCollection collection = mongoDatabase.getCollection(INPUT_STATUS_COLLECTION);\n+\n+        eventBus.register(this);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg0MzY1MQ=="}, "originalCommit": {"oid": "985841150be202ff29ce46033fe9c960e279ccf4"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5ODU0NzcwOnYy", "diffSide": "RIGHT", "path": "graylog2-server/src/main/java/org/graylog2/inputs/persistence/InputStateData.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwODo0ODoxMVrOGAL2zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwODo0ODoxMVrOGAL2zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg0NzQzOA==", "bodyText": "Great idea using any-getter/setter! \ud83d\udc4d", "url": "https://github.com/Graylog2/graylog2-server/pull/7821#discussion_r402847438", "createdAt": "2020-04-03T08:48:11Z", "author": {"login": "bernd"}, "path": "graylog2-server/src/main/java/org/graylog2/inputs/persistence/InputStateData.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package org.graylog2.inputs.persistence;\n+\n+import com.fasterxml.jackson.annotation.JsonAnyGetter;\n+import com.fasterxml.jackson.annotation.JsonAnySetter;\n+import com.fasterxml.jackson.annotation.JsonAutoDetect;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.annotation.JsonTypeInfo;\n+import com.google.common.collect.Maps;\n+\n+import java.util.Map;\n+import java.util.Objects;\n+\n+@JsonTypeInfo(\n+        use = JsonTypeInfo.Id.NAME,\n+        include = JsonTypeInfo.As.EXISTING_PROPERTY,\n+        property = InputStateData.TYPE_FIELD,\n+        visible = true,\n+        defaultImpl = InputStateData.Fallback.class\n+)\n+public interface InputStateData {\n+    String TYPE_FIELD = \"type\";\n+\n+    @JsonProperty\n+    String type();\n+\n+    public interface Builder<SELF> {\n+        @JsonProperty(TYPE_FIELD)\n+        SELF type(String type);\n+    }\n+\n+    @JsonAutoDetect\n+    class Fallback implements InputStateData {\n+        @JsonProperty\n+        private String type;\n+\n+        private Map<String, Object> props = Maps.newHashMap();\n+\n+        @Override\n+        public String type() {\n+            return type;\n+        }\n+\n+        @JsonAnySetter", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "985841150be202ff29ce46033fe9c960e279ccf4"}, "originalPosition": 43}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3781, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}