{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwODMzNzc3", "number": 7569, "title": "Using field type of sort field for unmapped type in message list.", "bodyText": "Description\n\nMotivation and Context\n\n\nNote: Requires backport to 3.2.\nBefore this change, no unmapped_type option was passed to Elasticsearch, when a field was used for sorting retrieved messages. This has the effect that when a field that is being sorted on is not present in all indices, an exception is thrown from ES.\nThis change is doing these things to address this:\n\nProviding a map of field types to all search types through the ESGeneratedQueryContext, scoped to the effective streams of this search type\nUsing field types to look up the type of all fields used sorting\nAdding the unmapped_type option to a sort in the ESMessageList class, using the retrieved field type for the respective field\n\nFixes #6490.\nHow Has This Been Tested?\n\n\n\nScreenshots (if appropriate):\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Refactoring (non-breaking change)\n Breaking change (fix or feature that would cause existing functionality to change)\n\nChecklist:\n\n\n\n My code follows the code style of this project.\n My change requires a change to the documentation.\n I have updated the documentation accordingly.\n I have read the CONTRIBUTING document.\n I have added tests to cover my changes.", "createdAt": "2020-02-27T12:52:57Z", "url": "https://github.com/Graylog2/graylog2-server/pull/7569", "merged": true, "mergeCommit": {"oid": "ce377d5031f60c6d90aa3d0e42a76ebd4a13594a"}, "closed": true, "closedAt": "2020-03-05T10:56:25Z", "author": {"login": "dennisoelkers"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKAJArABqjMwOTE2NTM2MzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKpSLIgFqTM2OTQ2OTUwNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "baccddef5f457cc3e9c804a10da8aa7c80db42d7", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/baccddef5f457cc3e9c804a10da8aa7c80db42d7", "committedDate": "2020-02-27T12:47:44Z", "message": "Adding tests for `ElasticsearchBackend`."}, "afterCommit": {"oid": "321f48ae18290b7625231e079c34d1c8ccd075db", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/321f48ae18290b7625231e079c34d1c8ccd075db", "committedDate": "2020-03-03T10:47:28Z", "message": "Adding license header."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "321f48ae18290b7625231e079c34d1c8ccd075db", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/321f48ae18290b7625231e079c34d1c8ccd075db", "committedDate": "2020-03-03T10:47:28Z", "message": "Adding license header."}, "afterCommit": {"oid": "6f72390ea889bb5309c2a0faf4b6fad6701fa2e6", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/6f72390ea889bb5309c2a0faf4b6fad6701fa2e6", "committedDate": "2020-03-04T09:14:08Z", "message": "Extracting retrieval of field types to separate class."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3ac45f8618c53c110c4105802a57c91f8b13bf5", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/f3ac45f8618c53c110c4105802a57c91f8b13bf5", "committedDate": "2020-03-04T09:22:14Z", "message": "Add field for field types in query context."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e7d5dfa4cce35ed0e55421794bd5ffd49308cda", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/3e7d5dfa4cce35ed0e55421794bd5ffd49308cda", "committedDate": "2020-03-04T09:22:14Z", "message": "Add method for retrieving field types for set of stream ids."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4044a91602882f32f220665a8ff343a9e3aa35dc", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/4044a91602882f32f220665a8ff343a9e3aa35dc", "committedDate": "2020-03-04T09:22:14Z", "message": "Add missing dependency in tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abcdfda9dd678f33f4537917f9ee131fd4c96359", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/abcdfda9dd678f33f4537917f9ee131fd4c96359", "committedDate": "2020-03-04T09:22:14Z", "message": "Use field types from context to generate unmapped type for message sort"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fc67c13b71718b849d5428f833da65b92188bf0", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/3fc67c13b71718b849d5428f833da65b92188bf0", "committedDate": "2020-03-04T09:22:14Z", "message": "Adding tests for `ESMessageList`."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32b9cd0695ca4cdf27eb2dd5a3d049089b5d4531", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/32b9cd0695ca4cdf27eb2dd5a3d049089b5d4531", "committedDate": "2020-03-04T09:22:14Z", "message": "Adding tests for `ElasticsearchBackend`."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6db322bbfb3e36d9642395e71b545cca96a493f6", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/6db322bbfb3e36d9642395e71b545cca96a493f6", "committedDate": "2020-03-04T09:22:14Z", "message": "Adding license header."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b2861dfa3bb329933e918e90e4a493b0c63cd6a", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/3b2861dfa3bb329933e918e90e4a493b0c63cd6a", "committedDate": "2020-03-04T09:22:14Z", "message": "Extracting retrieval of field types to separate class."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84d8b8dfd145af187d1600f2f6705b78cdc82924", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/84d8b8dfd145af187d1600f2f6705b78cdc82924", "committedDate": "2020-03-04T09:22:14Z", "message": "Adding stream to message list."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "473e7fe19e5f53bb64036b1536da5ffa6aac8194", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/473e7fe19e5f53bb64036b1536da5ffa6aac8194", "committedDate": "2020-03-04T09:22:14Z", "message": "Adding license header."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b0baa44c5d1d5275a5cbc5f8936a28bf505ff312", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/b0baa44c5d1d5275a5cbc5f8936a28bf505ff312", "committedDate": "2020-03-04T09:22:07Z", "message": "Adding license header."}, "afterCommit": {"oid": "473e7fe19e5f53bb64036b1536da5ffa6aac8194", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/473e7fe19e5f53bb64036b1536da5ffa6aac8194", "committedDate": "2020-03-04T09:22:14Z", "message": "Adding license header."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4OTcwMjkz", "url": "https://github.com/Graylog2/graylog2-server/pull/7569#pullrequestreview-368970293", "createdAt": "2020-03-04T17:19:16Z", "commit": {"oid": "473e7fe19e5f53bb64036b1536da5ffa6aac8194"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNzoxOToxN1rOFx2Uzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNzozODo0NFrOFx2_kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzgxNDYwNg==", "bodyText": "It's unclear at first glance where \"stream1\" and \"someField\" come from.\nI'd suggest either declaring them in variables at the start of test and passing them down or extracting them from the messageList object.", "url": "https://github.com/Graylog2/graylog2-server/pull/7569#discussion_r387814606", "createdAt": "2020-03-04T17:19:17Z", "author": {"login": "alex-konn"}, "path": "graylog2-server/src/test/java/org/graylog/plugins/views/search/elasticsearch/searchtypes/ESMessageListTest.java", "diffHunk": "@@ -88,6 +92,47 @@ public void appliesDecoratorsToQueryStringIfHighlightingActivated() {\n         JsonPathAssert.assertThat(doc).jsonPathAsString(\"$.highlight.highlight_query.query_string.query\").isEqualTo(\"Foobar!\");\n     }\n \n+    @Test\n+    public void passesTypeOfSortingFieldAsUnmappedType() {\n+        final MessageList messageList = someMessageListWithSorting();\n+        final ESGeneratedQueryContext context = mockQueryContext(messageList);\n+        when(context.fieldTypes(Collections.singleton(\"stream1\"))).thenReturn(Collections.singletonMap(\"somefield\", Collections.singleton(\"long\")));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "473e7fe19e5f53bb64036b1536da5ffa6aac8194"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzgxNTAyNg==", "bodyText": "Pass in allFieldTypes directly instead of both the context and the stream IDs.", "url": "https://github.com/Graylog2/graylog2-server/pull/7569#discussion_r387815026", "createdAt": "2020-03-04T17:20:01Z", "author": {"login": "alex-konn"}, "path": "graylog2-server/src/main/java/org/graylog/plugins/views/search/elasticsearch/searchtypes/ESMessageList.java", "diffHunk": "@@ -83,8 +85,22 @@ public void doGenerateQueryPart(SearchJob job, Query query, MessageList messageL\n \n         applyHighlightingIfActivated(searchSourceBuilder, job, query);\n \n+        final Set<String> effectiveStreamIds = messageList.effectiveStreams().isEmpty()\n+                ? query.usedStreamIds()\n+                : messageList.effectiveStreams();\n+\n         final List<Sort> sorts = firstNonNull(messageList.sort(), Collections.singletonList(Sort.create(Message.FIELD_TIMESTAMP, SortOrder.DESC)));\n-        sorts.forEach(sort -> searchSourceBuilder.sort(sort.field(), sort.order()));\n+        sorts.forEach(sort -> searchSourceBuilder.sort(\n+                SortBuilders.fieldSort(sort.field())\n+                        .order(sort.order())\n+                        .unmappedType(unmappedTypeForSort(sort, queryContext, effectiveStreamIds))\n+        ));\n+    }\n+\n+    private String unmappedTypeForSort(Sort sort, ESGeneratedQueryContext queryContext, Set<String> effectiveStreamIds) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "473e7fe19e5f53bb64036b1536da5ffa6aac8194"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzgxODExMg==", "bodyText": "I'd suggest pushing the null check down to ESGeneratedQueryContext or even FieldTypesLookup.\nI even think all of the logic in this method could be pushed down to FieldTypesLookup. Instead of asking for all field types for these streams, ask explicitly for the type of the field, i.e., FieldTypesLookup#getType(String fieldName, Set<String> streamIds). That would encapsulate all this stuff in FieldTypesLookup and this method could be replaced with: queryContext.getFieldType(sort.field(), effectiveStreamIds)", "url": "https://github.com/Graylog2/graylog2-server/pull/7569#discussion_r387818112", "createdAt": "2020-03-04T17:25:29Z", "author": {"login": "alex-konn"}, "path": "graylog2-server/src/main/java/org/graylog/plugins/views/search/elasticsearch/searchtypes/ESMessageList.java", "diffHunk": "@@ -83,8 +85,22 @@ public void doGenerateQueryPart(SearchJob job, Query query, MessageList messageL\n \n         applyHighlightingIfActivated(searchSourceBuilder, job, query);\n \n+        final Set<String> effectiveStreamIds = messageList.effectiveStreams().isEmpty()\n+                ? query.usedStreamIds()\n+                : messageList.effectiveStreams();\n+\n         final List<Sort> sorts = firstNonNull(messageList.sort(), Collections.singletonList(Sort.create(Message.FIELD_TIMESTAMP, SortOrder.DESC)));\n-        sorts.forEach(sort -> searchSourceBuilder.sort(sort.field(), sort.order()));\n+        sorts.forEach(sort -> searchSourceBuilder.sort(\n+                SortBuilders.fieldSort(sort.field())\n+                        .order(sort.order())\n+                        .unmappedType(unmappedTypeForSort(sort, queryContext, effectiveStreamIds))\n+        ));\n+    }\n+\n+    private String unmappedTypeForSort(Sort sort, ESGeneratedQueryContext queryContext, Set<String> effectiveStreamIds) {\n+        final Map<String, Set<String>> allFieldTypes = firstNonNull(queryContext.fieldTypes(effectiveStreamIds), Collections.emptyMap());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "473e7fe19e5f53bb64036b1536da5ffa6aac8194"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzgyNTU1NQ==", "bodyText": "This and the next test would become obsolete, if you followed my suggestion above to move that logic into FieldTypeLookup. I would add a few simpler unit tests for FieldTypesLookup instead.", "url": "https://github.com/Graylog2/graylog2-server/pull/7569#discussion_r387825555", "createdAt": "2020-03-04T17:38:44Z", "author": {"login": "alex-konn"}, "path": "graylog2-server/src/test/java/org/graylog/plugins/views/search/elasticsearch/searchtypes/ESMessageListTest.java", "diffHunk": "@@ -88,6 +92,47 @@ public void appliesDecoratorsToQueryStringIfHighlightingActivated() {\n         JsonPathAssert.assertThat(doc).jsonPathAsString(\"$.highlight.highlight_query.query_string.query\").isEqualTo(\"Foobar!\");\n     }\n \n+    @Test\n+    public void passesTypeOfSortingFieldAsUnmappedType() {\n+        final MessageList messageList = someMessageListWithSorting();\n+        final ESGeneratedQueryContext context = mockQueryContext(messageList);\n+        when(context.fieldTypes(Collections.singleton(\"stream1\"))).thenReturn(Collections.singletonMap(\"somefield\", Collections.singleton(\"long\")));\n+\n+        final ESGeneratedQueryContext queryContext = generateQueryPartWithContextFor(messageList, true, Collections.emptySet(), context);\n+\n+        final DocumentContext doc = JsonPath.parse(queryContext.searchSourceBuilder(messageList).toString());\n+        JsonPathAssert.assertThat(doc).jsonPathAsString(\"$.sort[0].somefield.unmapped_type\").isEqualTo(\"long\");\n+    }\n+\n+    @Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "473e7fe19e5f53bb64036b1536da5ffa6aac8194"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "971123d2396b8ffa4e8a678e7f64653429fd78be", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/971123d2396b8ffa4e8a678e7f64653429fd78be", "committedDate": "2020-03-05T09:47:47Z", "message": "Encapsulating field type lookup logic in `FieldTypesLookup`."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "928f5049d61757edd0391dbae7f0f35014edfe30", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/928f5049d61757edd0391dbae7f0f35014edfe30", "committedDate": "2020-03-05T09:52:16Z", "message": "Making use of constants in tests more explicit."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cc0dde2b8e6dfb16add78169d7ee897d293d595e", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/cc0dde2b8e6dfb16add78169d7ee897d293d595e", "committedDate": "2020-03-05T09:48:31Z", "message": "Making use of constants in tests more explicit."}, "afterCommit": {"oid": "928f5049d61757edd0391dbae7f0f35014edfe30", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/928f5049d61757edd0391dbae7f0f35014edfe30", "committedDate": "2020-03-05T09:52:16Z", "message": "Making use of constants in tests more explicit."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NDY5NTA0", "url": "https://github.com/Graylog2/graylog2-server/pull/7569#pullrequestreview-369469504", "createdAt": "2020-03-05T10:51:17Z", "commit": {"oid": "928f5049d61757edd0391dbae7f0f35014edfe30"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2530, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}