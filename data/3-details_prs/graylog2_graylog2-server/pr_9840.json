{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQzNzc4Njk2", "number": 9840, "title": "Report system stats with OSHI instead of libsigar", "bodyText": "Improved version of this excellent PR from Mario Daniel Ruiz Saavedra (https://github.com/desiderantes)\n#6056\nThank you very much \ud83e\udd1d\nThis commit adds a new Operating System and Hardware Information library, OSHI, that does not require the cumbersome packaging that Sigar currently needs. This library has a very active community and a pretty good set of platform options.\nDescription\nA new config option, disable_native_system_stats_collector, is added, defaults to false.\nImplementations for FS, network, OS, and process probes.\nMotivation and Context\nSigar is pretty much unmaintained, and a replacement with a friendly license would be a nice addition.\nHow Has This Been Tested?\nPersonally tested on Linux (Ubuntu 18.04) and MacOS 10.15.7\nCompared the libsigar stats with oshi, which either match, or provide even more info\nDisk statistics on MacOS need this fix oshi/oshi#1464", "createdAt": "2020-12-21T23:29:52Z", "url": "https://github.com/Graylog2/graylog2-server/pull/9840", "merged": true, "mergeCommit": {"oid": "52bd8f63a360708e361d5b7ece9d0e954d07ec2f"}, "closed": true, "closedAt": "2021-01-18T11:18:34Z", "author": {"login": "mpfz0r"}, "timelineItems": {"totalCount": 30, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-WsrfAH2gAyNTQzNzc4Njk2OjJkOWFhZGI0MGUwYTExZGE0MmUzNjU4YjlmY2EwODQ3MWEwZDc4NmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdxUzDDgFqTU3MDM5MjgwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2d9aadb40e0a11da42e3658b9fca08471a0d786d", "author": {"user": {"login": "desiderantes", "name": "Mario Daniel Ruiz Saavedra"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/2d9aadb40e0a11da42e3658b9fca08471a0d786d", "committedDate": "2020-08-13T02:36:06Z", "message": "Add OSHI as system stats reporter\n\nThis commit adds a new Operating System and Hardware Information library, OSHI, that does not require the cumbersome packaging that Sigar currently needs. This library has a very active community and a pretty good platform options. A new config option, enable_oshi, is added, that defaults to false."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d55467091d9db111ef40e1a271873c655d97834b", "author": {"user": {"login": "desiderantes", "name": "Mario Daniel Ruiz Saavedra"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/d55467091d9db111ef40e1a271873c655d97834b", "committedDate": "2020-08-13T02:37:51Z", "message": "Completely remove sigar, update to latest oshi"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca1847ddbb21ead4dcfa89e1b1e33cbcf88d86dd", "author": {"user": {"login": "desiderantes", "name": "Mario Daniel Ruiz Saavedra"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/ca1847ddbb21ead4dcfa89e1b1e33cbcf88d86dd", "committedDate": "2020-08-13T02:37:52Z", "message": "remove sigar folder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fb6b54c252a463e78cda9945ec9e31c9fbc5b66", "author": {"user": {"login": "desiderantes", "name": "Mario Daniel Ruiz Saavedra"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/2fb6b54c252a463e78cda9945ec9e31c9fbc5b66", "committedDate": "2020-08-13T02:37:52Z", "message": "Add license header"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0bfa9aa8a0c01acaebbbbe11e7c1b98efab8d08", "author": {"user": {"login": "desiderantes", "name": "Mario Daniel Ruiz Saavedra"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/a0bfa9aa8a0c01acaebbbbe11e7c1b98efab8d08", "committedDate": "2020-08-13T02:37:52Z", "message": "Reformat"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdbb28bed76afab2c0fff10686659620532e1611", "author": {"user": {"login": "desiderantes", "name": "Mario Daniel Ruiz Saavedra"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/cdbb28bed76afab2c0fff10686659620532e1611", "committedDate": "2020-08-13T02:37:52Z", "message": "Add init call (whoops)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7046beea4206382d24ec9f70c10c448591b9be72", "author": {"user": {"login": "desiderantes", "name": "Mario Daniel Ruiz Saavedra"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/7046beea4206382d24ec9f70c10c448591b9be72", "committedDate": "2020-08-13T02:47:02Z", "message": "Rebase and update OSHI version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a54e7da2b449f95ef9d2df60a8249480f4041b37", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/a54e7da2b449f95ef9d2df60a8249480f4041b37", "committedDate": "2020-12-15T22:16:00Z", "message": "Merge remote-tracking branch 'origin/master' into oshi"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f759251ed8e38282d9ad58469c1f6643385d1f26", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/f759251ed8e38282d9ad58469c1f6643385d1f26", "committedDate": "2020-12-15T22:19:11Z", "message": "Update licenses"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4714e319b58216a6d70327f06b354698253e6a7b", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/4714e319b58216a6d70327f06b354698253e6a7b", "committedDate": "2020-12-16T21:12:05Z", "message": "Update OSHI to 5.3.6"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bcf01dd8459fbb9b373390c77a73ce1ebff3cc0e", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/bcf01dd8459fbb9b373390c77a73ce1ebff3cc0e", "committedDate": "2020-12-16T21:12:42Z", "message": "Fix filesystem lookup\n\nFlip the mountpoint path comparision the other way around.\nWe need to compare the path against the mountpoint."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e336d6b2baeb7435cedac0b2c14d1c770e23feff", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/e336d6b2baeb7435cedac0b2c14d1c770e23feff", "committedDate": "2020-12-16T21:34:21Z", "message": "Fix JvmStats with Java 11\n\nThere is no bootclasspath option anymore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09d284ca5f21aeb87bf35480285cc456e983236a", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/09d284ca5f21aeb87bf35480285cc456e983236a", "committedDate": "2020-12-17T08:56:13Z", "message": "Report absolute path, like libsigar did."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "000dbd154c2bf3efd6d1b79f293f709f73e3430b", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/000dbd154c2bf3efd6d1b79f293f709f73e3430b", "committedDate": "2020-12-17T10:28:37Z", "message": "Keep libsigar semantics for type_name and sys_type_name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "629fd17e89ed5f53ae2daa3e89e988092860f12f", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/629fd17e89ed5f53ae2daa3e89e988092860f12f", "committedDate": "2020-12-21T23:10:56Z", "message": "Find diskstore via volume name\n\nThis is simpler and also supports LVM mapped disks.\nE.g. with a LUKS setup:\n\n lrwxrwxrwx 1 root root 7 Nov 26 10:33 /dev/mapper/ubuntu--vg-root -> ../dm-1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0203fde9f601e69fe19fea1e288f36a0ed293531", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/0203fde9f601e69fe19fea1e288f36a0ed293531", "committedDate": "2020-12-21T23:15:05Z", "message": "Find primary interface by the systems default gateway\n\nThe lookup via InetAddress.getLocalHost() isn't always\nrelieable. Ubuntu for instance defaults the hostname to 127.0.1.1\nwhich isn't bound to any interface."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f962c5da591eff4666bb6b117e88d38a1d5f3f0", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/0f962c5da591eff4666bb6b117e88d38a1d5f3f0", "committedDate": "2020-12-21T23:27:46Z", "message": "Fix Processor info\n\nkHZ -> MHz\n\nUse full processor string instead of model number"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf4eaffe708bce9ee1c2b4a321a9e2b1b1ffa056", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/cf4eaffe708bce9ee1c2b4a321a9e2b1b1ffa056", "committedDate": "2020-12-22T09:08:20Z", "message": "Try two approaches for searching the diskstore\n\nFirst try search for the diskstore with the logical volume or volume name.\nIf that finds nothing, try to search for the diskstore with the partition of our mountpoint.\n\nUsing only the volume names, did not work on MacOS"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f00cd410770ce8efb90e8056062c5e241aec7a54", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/f00cd410770ce8efb90e8056062c5e241aec7a54", "committedDate": "2020-12-22T09:28:19Z", "message": "Fix space and inodes use percentage calculation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "425f7d94c9805cf8b20c3c6d161981d6cf28b0fe", "author": {"user": {"login": "bernd", "name": "Bernd Ahlers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/425f7d94c9805cf8b20c3c6d161981d6cf28b0fe", "committedDate": "2021-01-13T15:37:36Z", "message": "Merge remote-tracking branch 'origin/master' into oshi"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY3NDU0NjU0", "url": "https://github.com/Graylog2/graylog2-server/pull/9840#pullrequestreview-567454654", "createdAt": "2021-01-13T17:25:11Z", "commit": {"oid": "425f7d94c9805cf8b20c3c6d161981d6cf28b0fe"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxNzoyNToxMVrOIS6Qhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxNzozMjowMlrOIS6ivQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjY5OTc4Mg==", "bodyText": "Can you please update to 5.3.7 release of oshi?", "url": "https://github.com/Graylog2/graylog2-server/pull/9840#discussion_r556699782", "createdAt": "2021-01-13T17:25:11Z", "author": {"login": "bernd"}, "path": "pom.xml", "diffHunk": "@@ -147,7 +147,7 @@\n         <scala.version>2.11.8</scala.version>\n         <semver4j.version>2.2.0-graylog.1</semver4j.version>\n         <shiro.version>1.5.2</shiro.version>\n-        <sigar.version>1.6.4</sigar.version>\n+        <oshi.version>5.3.6</oshi.version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "425f7d94c9805cf8b20c3c6d161981d6cf28b0fe"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjcwMDQyOQ==", "bodyText": "I think we should add this change to the UPGRADING.rst file.", "url": "https://github.com/Graylog2/graylog2-server/pull/9840#discussion_r556700429", "createdAt": "2021-01-13T17:26:02Z", "author": {"login": "bernd"}, "path": "misc/graylog.conf", "diffHunk": "@@ -637,8 +637,8 @@ mongodb_threads_allowed_to_block_multiplier = 5\n # Connection timeout for a configured LDAP server (e. g. ActiveDirectory) in milliseconds.\n #ldap_connection_timeout = 2000\n \n-# Disable the use of SIGAR for collecting system stats\n-#disable_sigar = false\n+# Disable the use of OSHI for collecting system stats\n+#disable_oshi = false", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "425f7d94c9805cf8b20c3c6d161981d6cf28b0fe"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjcwMjkyNQ==", "bodyText": "And what do you think about using something like disable_native_system_stats_collector instead? That way we don't have to rename it again in the future. \ud83d\ude09", "url": "https://github.com/Graylog2/graylog2-server/pull/9840#discussion_r556702925", "createdAt": "2021-01-13T17:29:43Z", "author": {"login": "bernd"}, "path": "misc/graylog.conf", "diffHunk": "@@ -637,8 +637,8 @@ mongodb_threads_allowed_to_block_multiplier = 5\n # Connection timeout for a configured LDAP server (e. g. ActiveDirectory) in milliseconds.\n #ldap_connection_timeout = 2000\n \n-# Disable the use of SIGAR for collecting system stats\n-#disable_sigar = false\n+# Disable the use of OSHI for collecting system stats\n+#disable_oshi = false", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjcwMDQyOQ=="}, "originalCommit": {"oid": "425f7d94c9805cf8b20c3c6d161981d6cf28b0fe"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjcwNDQ0NQ==", "bodyText": "Can we remove the commented code?", "url": "https://github.com/Graylog2/graylog2-server/pull/9840#discussion_r556704445", "createdAt": "2021-01-13T17:32:02Z", "author": {"login": "bernd"}, "path": "graylog2-server/src/main/java/org/graylog2/shared/system/stats/fs/OshiFsProbe.java", "diffHunk": "@@ -0,0 +1,225 @@\n+/*\n+ * Copyright (C) 2020 Graylog, Inc.\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the Server Side Public License, version 1,\n+ * as published by MongoDB, Inc.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * Server Side Public License for more details.\n+ *\n+ * You should have received a copy of the Server Side Public License\n+ * along with this program. If not, see\n+ * <http://www.mongodb.com/licensing/server-side-public-license>.\n+ */\n+package org.graylog2.shared.system.stats.fs;\n+\n+import com.google.common.collect.ImmutableSet;\n+import org.apache.commons.lang3.StringUtils;\n+import org.graylog2.Configuration;\n+import org.graylog2.plugin.KafkaJournalConfiguration;\n+import org.graylog2.shared.system.stats.OshiService;\n+import oshi.hardware.HWDiskStore;\n+import oshi.hardware.HWPartition;\n+import oshi.hardware.HardwareAbstractionLayer;\n+import oshi.hardware.common.AbstractHWDiskStore;\n+import oshi.software.common.AbstractOSFileStore;\n+import oshi.software.os.FileSystem;\n+import oshi.software.os.OSFileStore;\n+import oshi.software.os.OperatingSystem;\n+import oshi.util.tuples.Pair;\n+\n+import javax.inject.Inject;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.*;\n+import java.util.stream.Collectors;\n+\n+public class OshiFsProbe implements FsProbe {\n+\n+    private final OshiService service;\n+\n+    private final Set<Path> locations;\n+    private final Map<Path, Pair<OSFileStore, HWDiskStore>> oshiFileSystems = new HashMap<>();\n+\n+    @Inject\n+    public OshiFsProbe(OshiService service, Configuration configuration,\n+                       KafkaJournalConfiguration kafkaJournalConfiguration) {\n+        this.service = service;\n+\n+        this.locations = ImmutableSet.of(\n+                configuration.getBinDir(),\n+                configuration.getDataDir(),\n+                configuration.getPluginDir(),\n+                kafkaJournalConfiguration.getMessageJournalDir()\n+        );\n+\n+        init();\n+    }\n+\n+    private void init() {\n+        final OperatingSystem os = service.getOs();\n+\n+        final FileSystem fileSystem = os.getFileSystem();\n+\n+        final HardwareAbstractionLayer hardware = service.getHal();\n+\n+        for (Path location : locations) {\n+            Path path = location.toAbsolutePath();\n+            oshiFileSystems.put(path,\n+                    fileSystem.getFileStores().stream()\n+                            .filter(fs -> path.startsWith(fs.getMount()))\n+                            // We want the mountpoint closest to our location\n+                            .max(Comparator.comparingInt(p -> Paths.get(p.getMount()).getNameCount()))\n+                            .map(fs -> {\n+                                // First try search for the diskstore with the logical volume or volume name\n+                                Optional<HWDiskStore> diskStore = hardware.getDiskStores().stream()\n+                                        .filter(ds -> ds.getName().equals(StringUtils.defaultIfEmpty(fs.getLogicalVolume(), fs.getVolume())))\n+                                        .findFirst(); //.orElse(generateDummyDiskStore());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "425f7d94c9805cf8b20c3c6d161981d6cf28b0fe"}, "originalPosition": 80}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d299ea45afab9d771b08e6917f8594d24ae78752", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/d299ea45afab9d771b08e6917f8594d24ae78752", "committedDate": "2021-01-14T09:39:52Z", "message": "Rename disable_oshi to disable_native_system_stats_collector"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "788e88751c56c176d4758b846979feee90423ba3", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/788e88751c56c176d4758b846979feee90423ba3", "committedDate": "2021-01-14T09:40:30Z", "message": "Mention SIGAR removal"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfda09ac2025fcf185046d9a7e01d6b36a475ca1", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/dfda09ac2025fcf185046d9a7e01d6b36a475ca1", "committedDate": "2021-01-14T09:51:11Z", "message": "update oshi to 5.3.7"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "373a52c2ca67882ca17a5348dcbef0d3095e3d90", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/373a52c2ca67882ca17a5348dcbef0d3095e3d90", "committedDate": "2021-01-14T09:51:52Z", "message": "remove stale comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d8f6fecdc4b2616872d5986348ecd0cdb5e9a8e", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/1d8f6fecdc4b2616872d5986348ecd0cdb5e9a8e", "committedDate": "2021-01-14T10:16:43Z", "message": "Avoid division by zero when DummyFileStore is being used"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a2fc62f2079e835993b4eefa38aef79f4a391ac", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/2a2fc62f2079e835993b4eefa38aef79f4a391ac", "committedDate": "2021-01-15T16:47:32Z", "message": "Fix disk statistics on docker\n\n Don't let OSHI filter out \"overlay\" filesystems.\n Otherwise we cannot get proper disk statistics from within Docker."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d90b515da1517e03c63caa55fff02b4bc8c514d", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/9d90b515da1517e03c63caa55fff02b4bc8c514d", "committedDate": "2021-01-15T16:58:42Z", "message": "Add SystemStatsIT full-backend test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88061cc3cedaaa2b5c8bfb0eaaf52933283c330b", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/88061cc3cedaaa2b5c8bfb0eaaf52933283c330b", "committedDate": "2021-01-15T17:01:52Z", "message": "Fix license header"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcwMzkyODAy", "url": "https://github.com/Graylog2/graylog2-server/pull/9840#pullrequestreview-570392802", "createdAt": "2021-01-18T11:13:23Z", "commit": {"oid": "88061cc3cedaaa2b5c8bfb0eaaf52933283c330b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3258, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}