{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzNTYyOTc4", "number": 7199, "title": "Add support to dump the current ProcessBuffer state", "bodyText": "Introduce a new API call that returns the messages\nthat are currently processed in each ProcessBufferProcessor.\nThis is useful to debug cases where message processing got stuck.\nThe most common case is the use of an inefficient regular expression\nin extractors or pipeline rules.\nUnderstanding which regular expression caused the problem can be\ndifficult, without knowing which message triggered the problem.\nExample:\n\n\nSet up pipeline rule with an evil backtracking regex like /(x+x+)+y/\n\n\nSend message that spends hours in processing.\n\n\nGET https://172.16.1.1:9000/api/system/processbufferdump\n\n\n{\n  \"processbuffer_dump\": {\n    \"ProcessBufferProcessor #4\": \"idle\",\n    \"ProcessBufferProcessor #2\": \"MessageEvent{raw=null, message=source: t480 | message: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx { application_name: mpf | level: 5 | gl2_remote_ip: 127.0.0.1 | timestamp: 2020-01-16T11:00:48.296+01:00 } [...] }\",\n    \"ProcessBufferProcessor #3\": \"idle\",\n    \"ProcessBufferProcessor #0\": \"idle\",\n    \"ProcessBufferProcessor #1\": \"idle\"\n  }\n}", "createdAt": "2020-01-16T10:14:37Z", "url": "https://github.com/Graylog2/graylog2-server/pull/7199", "merged": true, "mergeCommit": {"oid": "4529afde652851a05a38d0c75367493f06f646f3"}, "closed": true, "closedAt": "2020-01-22T16:56:21Z", "author": {"login": "mpfz0r"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb63XYLgH2gAyMzYzNTYyOTc4OjliOTI2MGIwZjc1YTdmMTE5ZWQ0MzVjMTAzYTAwMWJhMGM2NjE4ODE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb84J3tgH2gAyMzYzNTYyOTc4OjU2Njc3M2E1MjA2M2E5MTY5ODZkNDhiZWY4MmM4NmQ1NzVmODUwZDE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9b9260b0f75a7f119ed435c103a001ba0c661881", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/9b9260b0f75a7f119ed435c103a001ba0c661881", "committedDate": "2020-01-16T10:12:51Z", "message": "Add support to dump the current ProcessBuffer state\n\nIntroduce a new API call that returns the messages\nthat are currently processed in each ProcessBufferProcessor.\n\nThis is useful to debug cases where message processing got stuck.\nThe most common case is the use of an inefficient regular expression\nin extractors or pipeline rules.\nUnderstanding which regular expression caused the problem can be\ndifficult, without knowing which message triggered the problem.\n\nExample:\n\n- Set up pipeline rule with an evil backtracking regex like `/(x+x+)+y/`\n- Send message that spends hours in processing.\n\n- GET https://172.16.1.1:9000/api/system/processbufferdump\n\n```\n{\n  \"processbuffer_dump\": {\n    \"ProcessBufferProcessor #4\": \"idle\",\n    \"ProcessBufferProcessor #2\": \"MessageEvent{raw=null, message=source: t480 | message: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx { application_name: mpf | level: 5 | gl2_remote_ip: 127.0.0.1 | timestamp: 2020-01-16T11:00:48.296+01:00 } [...] }\",\n    \"ProcessBufferProcessor #3\": \"idle\",\n    \"ProcessBufferProcessor #0\": \"idle\",\n    \"ProcessBufferProcessor #1\": \"idle\"\n  }\n}\n```"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzODk5Njg4", "url": "https://github.com/Graylog2/graylog2-server/pull/7199#pullrequestreview-343899688", "createdAt": "2020-01-16T13:12:22Z", "commit": {"oid": "9b9260b0f75a7f119ed435c103a001ba0c661881"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxMzoxMjoyMlrOFeY16g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxMzozNDozOVrOFeZeFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQwODYxOA==", "bodyText": "I think we should make this variable volatile to ensure cross-thread visibility.", "url": "https://github.com/Graylog2/graylog2-server/pull/7199#discussion_r367408618", "createdAt": "2020-01-16T13:12:22Z", "author": {"login": "bernd"}, "path": "graylog2-server/src/main/java/org/graylog2/shared/buffers/processors/ProcessBufferProcessor.java", "diffHunk": "@@ -56,6 +57,7 @@\n     private final ULID ulid;\n     private final DecodingProcessor decodingProcessor;\n     private final Provider<Stream> defaultStreamProvider;\n+    private MessageEvent currentEvent;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b9260b0f75a7f119ed435c103a001ba0c661881"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQxNDU3OQ==", "bodyText": "How about setting (and clearing) this in #dispatchMessage() instead? That way we only get the single message. The MessageEvent could contain one or more messages.", "url": "https://github.com/Graylog2/graylog2-server/pull/7199#discussion_r367414579", "createdAt": "2020-01-16T13:25:41Z", "author": {"login": "bernd"}, "path": "graylog2-server/src/main/java/org/graylog2/shared/buffers/processors/ProcessBufferProcessor.java", "diffHunk": "@@ -75,11 +77,13 @@ public ProcessBufferProcessor(MetricRegistry metricRegistry,\n         incomingMessages = metricRegistry.meter(name(ProcessBufferProcessor.class, \"incomingMessages\"));\n         outgoingMessages = metricRegistry.meter(name(ProcessBufferProcessor.class, \"outgoingMessages\"));\n         processTime = metricRegistry.timer(name(ProcessBufferProcessor.class, \"processTime\"));\n+        currentEvent = null;\n     }\n \n     @Override\n     public void onEvent(MessageEvent event) throws Exception {\n         try {\n+            currentEvent = event;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b9260b0f75a7f119ed435c103a001ba0c661881"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQxODkwMg==", "bodyText": "What do you think about adding another endpoint that returns the dumps for all nodes? That would make it way easier to use. We have ProxiedResource#getForAllNodes() for that. Example:\n\n  \n    \n      graylog2-server/graylog2-server/src/main/java/org/graylog2/rest/resources/cluster/ClusterSystemJobResource.java\n    \n    \n         Line 74\n      in\n      cb33786\n    \n    \n    \n    \n\n        \n          \n           return getForAllNodes(RemoteSystemJobResource::list, createRemoteInterfaceProvider(RemoteSystemJobResource.class));", "url": "https://github.com/Graylog2/graylog2-server/pull/7199#discussion_r367418902", "createdAt": "2020-01-16T13:34:39Z", "author": {"login": "bernd"}, "path": "graylog2-server/src/main/java/org/graylog2/rest/resources/cluster/ClusterSystemResource.java", "diffHunk": "@@ -116,5 +117,26 @@ public SystemThreadDumpResponse threadDump(@ApiParam(name = \"nodeId\", value = \"T\n             throw new WebApplicationException(response.message(), BAD_GATEWAY);\n         }\n     }\n+\n+    @GET\n+    @Timed\n+    @ApiOperation(value = \"Get a process buffer dump of the given node\")\n+    @RequiresPermissions(RestPermissions.PROCESSBUFFER_DUMP)\n+    @Path(\"{nodeId}/processbufferdump\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b9260b0f75a7f119ed435c103a001ba0c661881"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a7ea6ff6c72716fd095125791578fdcbb075793", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/2a7ea6ff6c72716fd095125791578fdcbb075793", "committedDate": "2020-01-16T14:37:00Z", "message": "Only keep track of single Messages\n\nThe MessageEvent can contain multiple messages.\n\nAlso declare currentMessage as volatile, to avoid visibility problems on\nmultiple threads."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "325583070a020c3d28f277b38b6213587bc4dfbc", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/325583070a020c3d28f277b38b6213587bc4dfbc", "committedDate": "2020-01-16T14:55:50Z", "message": "Add support to get process buffer dump of all cluster nodes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dad6fe3b0e3a94f56c566fe72d5aeea7fa8ba83c", "author": {"user": {"login": "bernd", "name": "Bernd Ahlers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/dad6fe3b0e3a94f56c566fe72d5aeea7fa8ba83c", "committedDate": "2020-01-22T13:58:52Z", "message": "Merge branch 'master' into processbuffer-dumper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b987cf5af9215db5718dc3c8a6279f23c6cdc59", "author": {"user": {"login": "bernd", "name": "Bernd Ahlers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/4b987cf5af9215db5718dc3c8a6279f23c6cdc59", "committedDate": "2020-01-22T15:13:04Z", "message": "Simplify ProcessBuffer#getDump() (approved my mpfz0r)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2Njg1NjE3", "url": "https://github.com/Graylog2/graylog2-server/pull/7199#pullrequestreview-346685617", "createdAt": "2020-01-22T15:39:40Z", "commit": {"oid": "4b987cf5af9215db5718dc3c8a6279f23c6cdc59"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "566773a52063a916986d48bef82c86d575f850d1", "author": {"user": {"login": "bernd", "name": "Bernd Ahlers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/566773a52063a916986d48bef82c86d575f850d1", "committedDate": "2020-01-22T16:15:51Z", "message": "Add UI for process-buffer dumps similar to the thread dump UI"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2685, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}