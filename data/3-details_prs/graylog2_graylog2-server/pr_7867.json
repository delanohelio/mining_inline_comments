{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyNjExMDcz", "number": 7867, "title": "Removing n+1's in `StreamService#loadAll` by consolidating external loads", "bodyText": "Description\n\nMotivation and Context\n\n\nBefore this change, calling StreamService#loadAll triggered loading of associated outputs and index sets, both resulting in n+1 each.\nThis change is now placing fetching of outputs and index sets outside the loop iterating over each stream, leaving only simple lookups to be done inside the loop, effectively turning this into a call with a constant number of mongodb queries.\nSimple tests on my setup showed an improvement of ~270ms -> ~110ms.  While this is already impressive, I expect a much bigger improvement for setups with a high number of outputs.\nHow Has This Been Tested?\n\n\n\nScreenshots (if appropriate):\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Refactoring (non-breaking change)\n Breaking change (fix or feature that would cause existing functionality to change)\n\nChecklist:\n\n\n\n My code follows the code style of this project.\n My change requires a change to the documentation.\n I have updated the documentation accordingly.\n I have read the CONTRIBUTING document.\n I have added tests to cover my changes.", "createdAt": "2020-04-13T11:52:46Z", "url": "https://github.com/Graylog2/graylog2-server/pull/7867", "merged": true, "mergeCommit": {"oid": "7c3b3ba1edf15602615e602af6ab8cd4097b4a3b"}, "closed": true, "closedAt": "2020-04-14T12:49:08Z", "author": {"login": "dennisoelkers"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXNgzQAH2gAyNDAyNjExMDczOmE0MTg4OGExYzQzYzgyNTRlZjUzOGQxNDJlZWIxYjI0OGFjMmVjMTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXik1qgFqTM5Mjg3MzQxNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a41888a1c43c8254ef538d142eeb1b248ac2ec11", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/a41888a1c43c8254ef538d142eeb1b248ac2ec11", "committedDate": "2020-04-13T11:50:56Z", "message": "Removing n+1's in `StreamService#loadAll` by consolidating external loads\n\nBefore this change, calling `StreamService#loadAll` triggered loading of\nassociated outputs and index sets, _both_ resulting in n+1 each.\n\nThis change is now placing fetching of outputs and index sets outside\nthe loop iterating over each stream, leaving only simple lookups to be\ndone inside the loop, effectively turning this into a call with a\n_constant_ number of mongodb queries.\n\nSimple tests on my setup showed an improvement of ~270ms -> ~110ms.\nWhile this is already impressive, I expect a much bigger improvement for\nsetups with a high number of outputs."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyODQ3NjUx", "url": "https://github.com/Graylog2/graylog2-server/pull/7867#pullrequestreview-392847651", "createdAt": "2020-04-14T11:44:27Z", "commit": {"oid": "a41888a1c43c8254ef538d142eeb1b248ac2ec11"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxMTo0NDoyOFrOGFKvhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxMTo0NDoyOFrOGFKvhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA3MjA2OA==", "bodyText": "Maybe we shouldn't call this streamsQuery?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private Map<String, IndexSet> indexSetsForStreams(List<DBObject> streamsQuery) {\n          \n          \n            \n                    final Set<String> indexSetIds = streamsQuery.stream()\n          \n          \n            \n                            .map(stream -> (String)stream.get(StreamImpl.FIELD_INDEX_SET_ID))\n          \n          \n            \n                            .filter(s -> !isNullOrEmpty(s))\n          \n          \n            \n                            .collect(Collectors.toSet());\n          \n          \n            \n                private Map<String, IndexSet> indexSetsForStreams(List<DBObject> streams) {\n          \n          \n            \n                    final Set<String> indexSetIds = streams.stream()\n          \n          \n            \n                            .map(stream -> (String)stream.get(StreamImpl.FIELD_INDEX_SET_ID))\n          \n          \n            \n                            .filter(s -> !isNullOrEmpty(s))\n          \n          \n            \n                            .collect(Collectors.toSet());", "url": "https://github.com/Graylog2/graylog2-server/pull/7867#discussion_r408072068", "createdAt": "2020-04-14T11:44:28Z", "author": {"login": "mpfz0r"}, "path": "graylog2-server/src/main/java/org/graylog2/streams/StreamServiceImpl.java", "diffHunk": "@@ -194,23 +195,57 @@ public Stream load(String id) throws NotFoundException {\n         final Map<String, List<StreamRule>> allStreamRules = streamRuleService.loadForStreamIds(streamIds);\n \n         final ImmutableList.Builder<Stream> streams = ImmutableList.builder();\n+\n+        final Map<String, IndexSet> indexSets = indexSetsForStreams(results);\n+\n+        final Set<String> outputIds = results.stream()\n+                .map(this::outputIdsForRawStream)\n+                .flatMap(outputs -> outputs.stream().map(ObjectId::toHexString))\n+                .collect(Collectors.toSet());\n+\n+        final Map<String, Output> outputsById = outputService.loadByIds(outputIds)\n+                .stream()\n+                .collect(Collectors.toMap(Output::getId, Function.identity()));\n+\n+\n         for (DBObject o : results) {\n             final ObjectId objectId = (ObjectId) o.get(\"_id\");\n             final String id = objectId.toHexString();\n             final List<StreamRule> streamRules = allStreamRules.getOrDefault(id, Collections.emptyList());\n             LOG.debug(\"Found {} rules for stream <{}>\", streamRules.size(), id);\n \n-            final Set<Output> outputs = loadOutputsForRawStream(o);\n+            final Set<Output> outputs = outputIdsForRawStream(o)\n+                    .stream()\n+                    .map(ObjectId::toHexString)\n+                    .map(outputsById::get)\n+                    .collect(Collectors.toSet());\n \n             @SuppressWarnings(\"unchecked\")\n             final Map<String, Object> fields = o.toMap();\n \n-            streams.add(new StreamImpl(objectId, fields, streamRules, outputs, getIndexSet(o)));\n+            final String indexSetId = (String)fields.get(StreamImpl.FIELD_INDEX_SET_ID);\n+\n+            streams.add(new StreamImpl(objectId, fields, streamRules, outputs, indexSets.get(indexSetId)));\n         }\n \n         return streams.build();\n     }\n \n+    private List<ObjectId> outputIdsForRawStream(DBObject o) {\n+        final List<ObjectId> objectIds = (List<ObjectId>) o.get(StreamImpl.FIELD_OUTPUTS);\n+        return objectIds == null ? Collections.emptyList() : objectIds;\n+    }\n+\n+    private Map<String, IndexSet> indexSetsForStreams(List<DBObject> streamsQuery) {\n+        final Set<String> indexSetIds = streamsQuery.stream()\n+                .map(stream -> (String)stream.get(StreamImpl.FIELD_INDEX_SET_ID))\n+                .filter(s -> !isNullOrEmpty(s))\n+                .collect(Collectors.toSet());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a41888a1c43c8254ef538d142eeb1b248ac2ec11"}, "originalPosition": 59}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84c25e6af48578d577d40558641eab6dfc51267e", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/84c25e6af48578d577d40558641eab6dfc51267e", "committedDate": "2020-04-14T12:19:58Z", "message": "Using better naming for parameter."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyODczNDE0", "url": "https://github.com/Graylog2/graylog2-server/pull/7867#pullrequestreview-392873414", "createdAt": "2020-04-14T12:23:21Z", "commit": {"oid": "84c25e6af48578d577d40558641eab6dfc51267e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2524, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}