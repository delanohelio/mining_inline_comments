{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4NTQ5NTgy", "number": 8136, "title": "Add support for more verbose authentication failure", "bodyText": "Description\n\nWith this change, an authenticating realm may throw an\nAuthenticationServiceUnavailableException which will be retained if\nnone of the realms can successfully authenticate the user. This will\nthen be indicated to the API client with a non-successful status code\nand response message.\nMotivation and Context\n\n\nWhen an authenticating realm is using an external service, there was no\nway to indicate that authentication failed in case the external service\nwas unavailable at the moment of checking the credentials. It could only\nindicate that authentication was unsuccessful in general.\nTherefore, in the unavailability case, the user would probably assume\nthat the credentials were wrong.\nHow Has This Been Tested?\n\n\n\nTesting this requires implementing an authenticating realm which throws the appropriate exception.\nScreenshots (if appropriate):\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Refactoring (non-breaking change)\n Breaking change (fix or feature that would cause existing functionality to change)\n\nChecklist:\n\n\n\n My code follows the code style of this project.\n My change requires a change to the documentation.\n I have updated the documentation accordingly.\n I have read the CONTRIBUTING document.\n I have added tests to cover my changes.", "createdAt": "2020-05-15T11:57:24Z", "url": "https://github.com/Graylog2/graylog2-server/pull/8136", "merged": true, "mergeCommit": {"oid": "ccbc17d9fc6290c46a3557ab3206899f1fb92369"}, "closed": true, "closedAt": "2020-05-25T07:50:34Z", "author": {"login": "thll"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchd9htAH2gAyNDE4NTQ5NTgyOmQ4MGEzNDRhMmMzMjU2MGJmZWFhMjcxZjE3MmEwZTVkOGUzN2Q2YmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABckrMZigFqTQxNzUyMDY3Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d80a344a2c32560bfeaa271f172a0e5d8e37d6bf", "author": {"user": {"login": "thll", "name": "Othello Maurer"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/d80a344a2c32560bfeaa271f172a0e5d8e37d6bf", "committedDate": "2020-05-15T08:40:02Z", "message": "Throw exception when creating session but auth service is not available\n\nWhen an authenticating realm is using an external service, there was no\nway to indicate that authentication failed in case the external service\nwas unavailable at the moment of checking the credentials. It could only\nindicate that authentication was unsuccessful in general.\nTherefore, in the unavailability case, the user would probably assume\nthat the credentials were wrong.\n\nWith this change, an authenticating realm may throw an\n`AuthenticationServiceUnavailableException` which will be retained if\nnone of the realms can successfully authenticate the user. This will\nthen be indicated to the API client with a non-successful status code\nand response message."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61480356652313ca8933a8e7e4e6b65e7114dfc1", "author": {"user": {"login": "thll", "name": "Othello Maurer"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/61480356652313ca8933a8e7e4e6b65e7114dfc1", "committedDate": "2020-05-15T11:54:29Z", "message": "Add license headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fef2eaa368c12a15e8f2014bd148a15756e88934", "author": {"user": {"login": "thll", "name": "Othello Maurer"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/fef2eaa368c12a15e8f2014bd148a15756e88934", "committedDate": "2020-05-19T12:26:49Z", "message": "Merge remote-tracking branch 'origin/master' into support-auth-service-not-available"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NzkxNDc0", "url": "https://github.com/Graylog2/graylog2-server/pull/8136#pullrequestreview-416791474", "createdAt": "2020-05-22T09:57:31Z", "commit": {"oid": "fef2eaa368c12a15e8f2014bd148a15756e88934"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwOTo1NzozMVrOGZRkEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwOTo1NzozMVrOGZRkEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE1NTM0NQ==", "bodyText": "I think we shouldn't expose too many details to unauthenticated users.\nThey shouldn't be able to discover which auth backends we are using.\nHow about\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new ServiceUnavailableException(e.getMessage());\n          \n          \n            \n                        throw new ServiceUnavailableException(\"Authentication service unavailable\");", "url": "https://github.com/Graylog2/graylog2-server/pull/8136#discussion_r429155345", "createdAt": "2020-05-22T09:57:31Z", "author": {"login": "mpfz0r"}, "path": "graylog2-server/src/main/java/org/graylog2/rest/resources/system/SessionsResource.java", "diffHunk": "@@ -124,11 +126,15 @@ public JsonNode newSession(@Context ContainerRequestContext requestContext,\n         final String sessionId = shiroSecurityContext.getUsername();\n         final String host = RestTools.getRemoteAddrFromRequest(grizzlyRequest, trustedSubnets);\n \n-        Optional<Session> session = sessionCreator.create(sessionId, host, authToken);\n-        if (session.isPresent()) {\n-            return sessionResponseFactory.forSession(session.get());\n-        } else {\n-            throw new NotAuthorizedException(\"Invalid credentials.\", \"Basic realm=\\\"Graylog Server session\\\"\");\n+        try {\n+            Optional<Session> session = sessionCreator.create(sessionId, host, authToken);\n+            if (session.isPresent()) {\n+                return sessionResponseFactory.forSession(session.get());\n+            } else {\n+                throw new NotAuthorizedException(\"Invalid credentials.\", \"Basic realm=\\\"Graylog Server session\\\"\");\n+            }\n+        } catch (AuthenticationServiceUnavailableException e) {\n+            throw new ServiceUnavailableException(e.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fef2eaa368c12a15e8f2014bd148a15756e88934"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NzkxODY2", "url": "https://github.com/Graylog2/graylog2-server/pull/8136#pullrequestreview-416791866", "createdAt": "2020-05-22T09:58:09Z", "commit": {"oid": "fef2eaa368c12a15e8f2014bd148a15756e88934"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f9364e7150d0ae4b65e9892c43810d2f633a06d", "author": {"user": {"login": "thll", "name": "Othello Maurer"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/1f9364e7150d0ae4b65e9892c43810d2f633a06d", "committedDate": "2020-05-25T05:55:21Z", "message": "Don't expose exception message to user\n\nCo-authored-by: Marco Pfatschbacher <marco@graylog.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3NTIwNjcz", "url": "https://github.com/Graylog2/graylog2-server/pull/8136#pullrequestreview-417520673", "createdAt": "2020-05-25T07:46:49Z", "commit": {"oid": "1f9364e7150d0ae4b65e9892c43810d2f633a06d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3227, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}