{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI1MDEyMDU1", "number": 8236, "title": "Move widget to tab", "bodyText": "Description\nAdd new menu item to widget menu: Move to Page. When clicking the user will see a modal\nwhere he can select the target page. Optionally he can decide to keep a copy of the widget\non the current page. After selecting the target page he clicks on Select. The widget will\nbe moved to the new page and the active page will be set to the target query.\nMotivation and Context\nA user was able to copy a widget from a search to the first page of a dashboard. But the widget\nwas stuck now there. There was no possibility to move the widget to a different page of the dashboard.\nHow Has This Been Tested?\n\nCreate a dashboard\ncreate a widget on the first page\nmove the widget to a different page\n\nFixes #8152\nScreenshots (if appropriate):\n\n\nTypes of changes\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Refactoring (non-breaking change)\n Breaking change (fix or feature that would cause existing functionality to change)\n\nChecklist:\n\n My code follows the code style of this project.\n My change requires a change to the documentation.\n I have updated the documentation accordingly.\n I have read the CONTRIBUTING document.\n I have added tests to cover my changes.", "createdAt": "2020-05-29T10:09:37Z", "url": "https://github.com/Graylog2/graylog2-server/pull/8236", "merged": true, "mergeCommit": {"oid": "4c1d41a24bd406cd68d4d8cc194eba23508ed50d"}, "closed": true, "closedAt": "2020-06-12T13:28:33Z", "author": {"login": "kmerz"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnWQUiAFqTQyMjU4MjExNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqi3mMAFqTQyOTczOTU5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyNTgyMTE2", "url": "https://github.com/Graylog2/graylog2-server/pull/8236#pullrequestreview-422582116", "createdAt": "2020-06-02T11:24:43Z", "commit": {"oid": "6da9c3df76af964e8fb77c830a5ef9128f9907e5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMToyNDo0M1rOGdtSZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNDo0MDozNlrOGd08ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzgwMzg3OQ==", "bodyText": "Let's call the component MoveWidgetToTabModal to unify the naming with comparable components.", "url": "https://github.com/Graylog2/graylog2-server/pull/8236#discussion_r433803879", "createdAt": "2020-06-02T11:24:43Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/views/components/widgets/Widget.jsx", "diffHunk": "@@ -328,6 +361,12 @@ class Widget extends React.Component<Props, State> {\n                                      onCancel={this._onToggleCopyToDashboard} />\n                   )}\n                   {showCsvExport && <CSVExportModal view={view.view} directExportWidgetId={widget.id} closeModal={this._onToggleCSVExport} />}\n+                  {showMoveWidgetToTab && (\n+                    <MoveWidgetToTabForm view={view.view}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6da9c3df76af964e8fb77c830a5ef9128f9907e5"}, "originalPosition": 126}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzgwNjE3Nw==", "bodyText": "Let's use the BootstrapModalForm here.", "url": "https://github.com/Graylog2/graylog2-server/pull/8236#discussion_r433806177", "createdAt": "2020-06-02T11:29:24Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/views/components/widgets/MoveWidgetToTab.jsx", "diffHunk": "@@ -0,0 +1,66 @@\n+// @flow strict\n+import React, { useState } from 'react';\n+import { Map } from 'immutable';\n+import { Button, ListGroup, ListGroupItem, Modal } from 'components/graylog';\n+import Input from 'components/bootstrap/Input';\n+\n+import View from 'views/logic/views/View';\n+\n+type Props = {\n+  view: View,\n+  widgetId: string,\n+  onCancel: () => void,\n+  onSubmit: (widgetId: string, selectedTab: ?string, keepCopy: boolean) => void,\n+};\n+\n+type TabEntry = { id: string, name: string };\n+\n+const _tabList = (view: View): Array<TabEntry> => {\n+  const queryIds = Object.keys(view.state.toObject());\n+  return queryIds.map((queryId, index) => {\n+    const tabTitle = view.state.get(queryId).titles.get('tab', Map({ title: `Page#${index + 1}` }));\n+    return ({ id: queryId, name: tabTitle.get('title') });\n+  });\n+};\n+\n+const MoveWidgetToTab = ({ view, onCancel, onSubmit, widgetId }: Props) => {\n+  const [selectedTab, setSelectedTab] = useState(null);\n+  const [keepCopy, setKeepCopy] = useState(false);\n+\n+  const list = _tabList(view);\n+\n+  const tabList = list.map(({ id, name }) => (\n+    <ListGroupItem header={name}\n+                   onClick={() => setSelectedTab(id)}\n+                   active={id === selectedTab}\n+                   key={id} />\n+  ));\n+  const renderResult = list && list.length > 0\n+    ? <ListGroup>{tabList}</ListGroup>\n+    : <span>No dashboards found</span>;\n+\n+  return (\n+    <Modal show>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6da9c3df76af964e8fb77c830a5ef9128f9907e5"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzgzNzUyNw==", "bodyText": "We should either sort the list alphabetically or use the order defined by the dashboard.", "url": "https://github.com/Graylog2/graylog2-server/pull/8236#discussion_r433837527", "createdAt": "2020-06-02T12:29:46Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/views/components/widgets/MoveWidgetToTab.jsx", "diffHunk": "@@ -0,0 +1,66 @@\n+// @flow strict\n+import React, { useState } from 'react';\n+import { Map } from 'immutable';\n+import { Button, ListGroup, ListGroupItem, Modal } from 'components/graylog';\n+import Input from 'components/bootstrap/Input';\n+\n+import View from 'views/logic/views/View';\n+\n+type Props = {\n+  view: View,\n+  widgetId: string,\n+  onCancel: () => void,\n+  onSubmit: (widgetId: string, selectedTab: ?string, keepCopy: boolean) => void,\n+};\n+\n+type TabEntry = { id: string, name: string };\n+\n+const _tabList = (view: View): Array<TabEntry> => {\n+  const queryIds = Object.keys(view.state.toObject());\n+  return queryIds.map((queryId, index) => {\n+    const tabTitle = view.state.get(queryId).titles.get('tab', Map({ title: `Page#${index + 1}` }));\n+    return ({ id: queryId, name: tabTitle.get('title') });\n+  });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6da9c3df76af964e8fb77c830a5ef9128f9907e5"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg0MzU2Mw==", "bodyText": "I thought about extracting the Page# part and using the reference here, in QueryTitle.js and QueryTabs.jsx. But having a look at QueryTitle.js you can also use the related queryTitle function, like we do it in BigDisplayMode.", "url": "https://github.com/Graylog2/graylog2-server/pull/8236#discussion_r433843563", "createdAt": "2020-06-02T12:40:31Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/views/components/widgets/MoveWidgetToTab.jsx", "diffHunk": "@@ -0,0 +1,66 @@\n+// @flow strict\n+import React, { useState } from 'react';\n+import { Map } from 'immutable';\n+import { Button, ListGroup, ListGroupItem, Modal } from 'components/graylog';\n+import Input from 'components/bootstrap/Input';\n+\n+import View from 'views/logic/views/View';\n+\n+type Props = {\n+  view: View,\n+  widgetId: string,\n+  onCancel: () => void,\n+  onSubmit: (widgetId: string, selectedTab: ?string, keepCopy: boolean) => void,\n+};\n+\n+type TabEntry = { id: string, name: string };\n+\n+const _tabList = (view: View): Array<TabEntry> => {\n+  const queryIds = Object.keys(view.state.toObject());\n+  return queryIds.map((queryId, index) => {\n+    const tabTitle = view.state.get(queryId).titles.get('tab', Map({ title: `Page#${index + 1}` }));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6da9c3df76af964e8fb77c830a5ef9128f9907e5"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg0NzY2MA==", "bodyText": "Just a side note, it would be great if we could unify the styling of this list, the list which is visible when copying a widget to a dashboard and the saved searches list. We are sometimes defining the title as a header and sometimes as a child, which is supposed to be the description. I will create a separate issue for this change.", "url": "https://github.com/Graylog2/graylog2-server/pull/8236#discussion_r433847660", "createdAt": "2020-06-02T12:47:16Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/views/components/widgets/MoveWidgetToTab.jsx", "diffHunk": "@@ -0,0 +1,66 @@\n+// @flow strict\n+import React, { useState } from 'react';\n+import { Map } from 'immutable';\n+import { Button, ListGroup, ListGroupItem, Modal } from 'components/graylog';\n+import Input from 'components/bootstrap/Input';\n+\n+import View from 'views/logic/views/View';\n+\n+type Props = {\n+  view: View,\n+  widgetId: string,\n+  onCancel: () => void,\n+  onSubmit: (widgetId: string, selectedTab: ?string, keepCopy: boolean) => void,\n+};\n+\n+type TabEntry = { id: string, name: string };\n+\n+const _tabList = (view: View): Array<TabEntry> => {\n+  const queryIds = Object.keys(view.state.toObject());\n+  return queryIds.map((queryId, index) => {\n+    const tabTitle = view.state.get(queryId).titles.get('tab', Map({ title: `Page#${index + 1}` }));\n+    return ({ id: queryId, name: tabTitle.get('title') });\n+  });\n+};\n+\n+const MoveWidgetToTab = ({ view, onCancel, onSubmit, widgetId }: Props) => {\n+  const [selectedTab, setSelectedTab] = useState(null);\n+  const [keepCopy, setKeepCopy] = useState(false);\n+\n+  const list = _tabList(view);\n+\n+  const tabList = list.map(({ id, name }) => (\n+    <ListGroupItem header={name}\n+                   onClick={() => setSelectedTab(id)}\n+                   active={id === selectedTab}\n+                   key={id} />\n+  ));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6da9c3df76af964e8fb77c830a5ef9128f9907e5"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg1MzAxMw==", "bodyText": "You could use the newly created WidgetId type from views/types here.", "url": "https://github.com/Graylog2/graylog2-server/pull/8236#discussion_r433853013", "createdAt": "2020-06-02T12:56:07Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/views/logic/views/FindWidgetAndQueryIdInView.js", "diffHunk": "@@ -0,0 +1,21 @@\n+// @flow strict\n+import View from './View';\n+import Widget from '../widgets/Widget';\n+import ViewState from './ViewState';\n+\n+type QueryId = string;\n+\n+const FindWidgetAndQueryIdInView = (widgetId: string, view: View): ?[Widget, QueryId] => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6da9c3df76af964e8fb77c830a5ef9128f9907e5"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg1MzIxOQ==", "bodyText": "You could use the newly created WidgetId type from views/types here as well.", "url": "https://github.com/Graylog2/graylog2-server/pull/8236#discussion_r433853219", "createdAt": "2020-06-02T12:56:26Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/views/logic/views/MoveWidgetToTab.js", "diffHunk": "@@ -0,0 +1,53 @@\n+// @flow strict\n+import uuid from 'uuid/v4';\n+import View from './View';\n+import FindWidgetAndQueryIdInView from './FindWidgetAndQueryIdInView';\n+import Widget from '../widgets/Widget';\n+import UpdateSearchForWidgets from './UpdateSearchForWidgets';\n+\n+type QueryId = string;\n+\n+const _removeWidgetFromTab = (widgetId: string, queryId: string, dashboard: View): View => {\n+  const viewState = dashboard.state.get(queryId);\n+  const widgetIndex = viewState.widgets.findIndex((widget) => widget.id === widgetId);\n+  const widgetPosition = viewState.widgetPositions;\n+  delete widgetPosition[widgetId];\n+  const { widgetMapping } = viewState;\n+  const newWidgetMapping = widgetMapping.remove(widgetId);\n+  const newViewState = viewState.toBuilder()\n+    .widgets(viewState.widgets.delete(widgetIndex))\n+    .widgetMapping(newWidgetMapping)\n+    .widgetPositions(widgetPosition)\n+    .build();\n+  return dashboard.toBuilder()\n+    .state(dashboard.state.set(queryId, newViewState))\n+    .build();\n+};\n+\n+const _addWidgetToTab = (widget: Widget, targetQueryId: QueryId, dashboard: View): View => {\n+  const viewState = dashboard.state.get(targetQueryId);\n+  const newWidget = widget.toBuilder().id(uuid()).build();\n+  const newViewState = viewState.toBuilder()\n+    .widgets(viewState.widgets.push(newWidget))\n+    .build();\n+  return dashboard.toBuilder()\n+    .state(dashboard.state.set(targetQueryId, newViewState))\n+    .build();\n+};\n+\n+const MoveWidgetToTab = (widgetId: string, targetQueryId: QueryId, dashboard: View, copy: boolean = false): ?View => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6da9c3df76af964e8fb77c830a5ef9128f9907e5"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg1NTMwMw==", "bodyText": "I would prefer to expect that this function returns a View and to throw an error if the search type does not match or if the the related Query does not exist.", "url": "https://github.com/Graylog2/graylog2-server/pull/8236#discussion_r433855303", "createdAt": "2020-06-02T12:59:53Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/views/logic/views/MoveWidgetToTab.js", "diffHunk": "@@ -0,0 +1,53 @@\n+// @flow strict\n+import uuid from 'uuid/v4';\n+import View from './View';\n+import FindWidgetAndQueryIdInView from './FindWidgetAndQueryIdInView';\n+import Widget from '../widgets/Widget';\n+import UpdateSearchForWidgets from './UpdateSearchForWidgets';\n+\n+type QueryId = string;\n+\n+const _removeWidgetFromTab = (widgetId: string, queryId: string, dashboard: View): View => {\n+  const viewState = dashboard.state.get(queryId);\n+  const widgetIndex = viewState.widgets.findIndex((widget) => widget.id === widgetId);\n+  const widgetPosition = viewState.widgetPositions;\n+  delete widgetPosition[widgetId];\n+  const { widgetMapping } = viewState;\n+  const newWidgetMapping = widgetMapping.remove(widgetId);\n+  const newViewState = viewState.toBuilder()\n+    .widgets(viewState.widgets.delete(widgetIndex))\n+    .widgetMapping(newWidgetMapping)\n+    .widgetPositions(widgetPosition)\n+    .build();\n+  return dashboard.toBuilder()\n+    .state(dashboard.state.set(queryId, newViewState))\n+    .build();\n+};\n+\n+const _addWidgetToTab = (widget: Widget, targetQueryId: QueryId, dashboard: View): View => {\n+  const viewState = dashboard.state.get(targetQueryId);\n+  const newWidget = widget.toBuilder().id(uuid()).build();\n+  const newViewState = viewState.toBuilder()\n+    .widgets(viewState.widgets.push(newWidget))\n+    .build();\n+  return dashboard.toBuilder()\n+    .state(dashboard.state.set(targetQueryId, newViewState))\n+    .build();\n+};\n+\n+const MoveWidgetToTab = (widgetId: string, targetQueryId: QueryId, dashboard: View, copy: boolean = false): ?View => {\n+  if (dashboard.type !== View.Type.Dashboard) {\n+    return undefined;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6da9c3df76af964e8fb77c830a5ef9128f9907e5"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg3MzkyNA==", "bodyText": "Let's call this variable widgetPositions", "url": "https://github.com/Graylog2/graylog2-server/pull/8236#discussion_r433873924", "createdAt": "2020-06-02T13:28:04Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/views/logic/views/MoveWidgetToTab.js", "diffHunk": "@@ -0,0 +1,53 @@\n+// @flow strict\n+import uuid from 'uuid/v4';\n+import View from './View';\n+import FindWidgetAndQueryIdInView from './FindWidgetAndQueryIdInView';\n+import Widget from '../widgets/Widget';\n+import UpdateSearchForWidgets from './UpdateSearchForWidgets';\n+\n+type QueryId = string;\n+\n+const _removeWidgetFromTab = (widgetId: string, queryId: string, dashboard: View): View => {\n+  const viewState = dashboard.state.get(queryId);\n+  const widgetIndex = viewState.widgets.findIndex((widget) => widget.id === widgetId);\n+  const widgetPosition = viewState.widgetPositions;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6da9c3df76af964e8fb77c830a5ef9128f9907e5"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg5MzEwNw==", "bodyText": "What do you think about not including the current page in the list?\nIf \"Keep Copy\" is not active, nothing happens and otherwise the widget will be copied.\nIf the user wants to copy a widget on the same dashboard page he can also use the copy action.", "url": "https://github.com/Graylog2/graylog2-server/pull/8236#discussion_r433893107", "createdAt": "2020-06-02T13:54:07Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/views/components/widgets/MoveWidgetToTab.jsx", "diffHunk": "@@ -0,0 +1,66 @@\n+// @flow strict\n+import React, { useState } from 'react';\n+import { Map } from 'immutable';\n+import { Button, ListGroup, ListGroupItem, Modal } from 'components/graylog';\n+import Input from 'components/bootstrap/Input';\n+\n+import View from 'views/logic/views/View';\n+\n+type Props = {\n+  view: View,\n+  widgetId: string,\n+  onCancel: () => void,\n+  onSubmit: (widgetId: string, selectedTab: ?string, keepCopy: boolean) => void,\n+};\n+\n+type TabEntry = { id: string, name: string };\n+\n+const _tabList = (view: View): Array<TabEntry> => {\n+  const queryIds = Object.keys(view.state.toObject());\n+  return queryIds.map((queryId, index) => {\n+    const tabTitle = view.state.get(queryId).titles.get('tab', Map({ title: `Page#${index + 1}` }));\n+    return ({ id: queryId, name: tabTitle.get('title') });\n+  });", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzgzNzUyNw=="}, "originalCommit": {"oid": "6da9c3df76af964e8fb77c830a5ef9128f9907e5"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkyOTQxMQ==", "bodyText": "One bigger topic I would like to discuss is the handling of the widget positions when removing / adding a widget.\nWhen the widget is being moved to a page, we do not define / calculate a widget position. This can lead to strange behaviours. During my tests the newly created widget is mostly being displayed in the second row of the widget grid. But when I open and close the widget edit modal, it moves to the first row. It would be great if we could reuse some parts of the logic we are using when creating a widget. (CurrentViewStateStore -> widgets())\nWhen a user removes a widget, by not using the \"Keep Copy\" option, we are just removing the widget position, which is ok, because it behaves like when using the widget action Delete. But in my opinion we should check if this effects other widgets and recalculate their positions. E.g. when the widget was the only one in its row.\nThe WidgetGrid is currently able to handle this \"empty space\", but it is possible that this will lead to problems in the future. For now I would not change this part, but I will create an issue to adjust this behaviour which includes writing a migration which checks if empty spaces theoretically exists on a dashboard and which recalculates the related widget positions.\nWhat do you think?", "url": "https://github.com/Graylog2/graylog2-server/pull/8236#discussion_r433929411", "createdAt": "2020-06-02T14:40:36Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/views/logic/views/MoveWidgetToTab.js", "diffHunk": "@@ -0,0 +1,53 @@\n+// @flow strict\n+import uuid from 'uuid/v4';\n+import View from './View';\n+import FindWidgetAndQueryIdInView from './FindWidgetAndQueryIdInView';\n+import Widget from '../widgets/Widget';\n+import UpdateSearchForWidgets from './UpdateSearchForWidgets';\n+\n+type QueryId = string;\n+\n+const _removeWidgetFromTab = (widgetId: string, queryId: string, dashboard: View): View => {\n+  const viewState = dashboard.state.get(queryId);\n+  const widgetIndex = viewState.widgets.findIndex((widget) => widget.id === widgetId);\n+  const widgetPosition = viewState.widgetPositions;\n+  delete widgetPosition[widgetId];\n+  const { widgetMapping } = viewState;\n+  const newWidgetMapping = widgetMapping.remove(widgetId);\n+  const newViewState = viewState.toBuilder()\n+    .widgets(viewState.widgets.delete(widgetIndex))\n+    .widgetMapping(newWidgetMapping)\n+    .widgetPositions(widgetPosition)\n+    .build();\n+  return dashboard.toBuilder()\n+    .state(dashboard.state.set(queryId, newViewState))\n+    .build();\n+};\n+\n+const _addWidgetToTab = (widget: Widget, targetQueryId: QueryId, dashboard: View): View => {\n+  const viewState = dashboard.state.get(targetQueryId);\n+  const newWidget = widget.toBuilder().id(uuid()).build();\n+  const newViewState = viewState.toBuilder()\n+    .widgets(viewState.widgets.push(newWidget))\n+    .build();\n+  return dashboard.toBuilder()\n+    .state(dashboard.state.set(targetQueryId, newViewState))\n+    .build();\n+};\n+\n+const MoveWidgetToTab = (widgetId: string, targetQueryId: QueryId, dashboard: View, copy: boolean = false): ?View => {\n+  if (dashboard.type !== View.Type.Dashboard) {\n+    return undefined;\n+  }\n+\n+  const match: ?[Widget, QueryId] = FindWidgetAndQueryIdInView(widgetId, dashboard);\n+\n+  if (match) {\n+    const [widget, queryId] = match;\n+    const tempDashboard = copy ? dashboard : _removeWidgetFromTab(widgetId, queryId, dashboard);\n+    return UpdateSearchForWidgets(_addWidgetToTab(widget, targetQueryId, tempDashboard));\n+  }\n+  return undefined;\n+};\n+\n+export default MoveWidgetToTab;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6da9c3df76af964e8fb77c830a5ef9128f9907e5"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8adf9e60f1a1e2e7aba0d42f5b10c39190e00e5b", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/8adf9e60f1a1e2e7aba0d42f5b10c39190e00e5b", "committedDate": "2020-06-05T12:59:07Z", "message": "Add move widget to tab functionallity\n\nPrior to this change, there was no code providing the possibility\nto move a widget from one tab to another.\n\nThis change will add a function."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6d95dbb0da34b9257eb31478212ee56b67f43ae", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/a6d95dbb0da34b9257eb31478212ee56b67f43ae", "committedDate": "2020-06-05T12:59:33Z", "message": "Create MoveWidgetToTab Modal\n\nPrior to this change, there was no Modal where a user\ncould select to which tab he would like to move a widget.\n\nThis change will create a new Modal and connects it\nto the former MoveWidgetToTab logic."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a871e1e364d06710f3af3b843c58372a9ee9a4b", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/9a871e1e364d06710f3af3b843c58372a9ee9a4b", "committedDate": "2020-06-05T12:59:35Z", "message": "Fix failing snapshot tests\n\nPrior to these changes, we did not update the search id,\nwhich needed to be change, since we changed the search.\n\nThis change will mock the id generation so we do not have\nfailing snapshots tests with every run."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e6fbff58a3f408430fd8f59f1a648fda8978dd1", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/3e6fbff58a3f408430fd8f59f1a648fda8978dd1", "committedDate": "2020-06-05T13:00:01Z", "message": "Make it possible to keep a copy of a widget\n\nPrior to this change, you could only move a widget\nto a different page. Now you can also copy it instead.\n\nThis change will add a checkbox where the user can\ndecide to copy the widget instead of moving it."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85f267cd2e7ec101487467905e8c44f060a0dc47", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/85f267cd2e7ec101487467905e8c44f060a0dc47", "committedDate": "2020-06-05T13:00:03Z", "message": "Rename MoveWidgetToTab to MoveWidgetToTabModal"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6595fb8df167e6de738f65af67a9dfca88d1c91d", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/6595fb8df167e6de738f65af67a9dfca88d1c91d", "committedDate": "2020-06-05T13:00:04Z", "message": "Use BootstrapModalForm and beautify ListGroupItem usage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b17769a26d63db8754b373f743d043bdd353b73c", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/b17769a26d63db8754b373f743d043bdd353b73c", "committedDate": "2020-06-05T13:00:04Z", "message": "Filter active query from selection list"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4103753648df9502b3ea1702d0c928d56624523", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/b4103753648df9502b3ea1702d0c928d56624523", "committedDate": "2020-06-05T13:00:04Z", "message": "Use QueryTitle for title generation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88c794c36db41259ac05000ea2e73fee52dfb767", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/88c794c36db41259ac05000ea2e73fee52dfb767", "committedDate": "2020-06-05T13:00:05Z", "message": "Reuse existing types instead of reinventing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adbc3c6a869c29ed1489c216517737b968b921cc", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/adbc3c6a869c29ed1489c216517737b968b921cc", "committedDate": "2020-06-05T13:00:05Z", "message": "use better VariableName and throw Error when type is unexpected"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "754bd74732d096b5b88a3558c90474cd7043d644", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/754bd74732d096b5b88a3558c90474cd7043d644", "committedDate": "2020-06-05T13:00:05Z", "message": "When moving a widget also add new WidgetPostion"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "63f1adc00eaa5b6fe90c43b70581c8b50f01f647", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/63f1adc00eaa5b6fe90c43b70581c8b50f01f647", "committedDate": "2020-06-05T12:58:35Z", "message": "When moving a widget also add new WidgetPostion"}, "afterCommit": {"oid": "754bd74732d096b5b88a3558c90474cd7043d644", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/754bd74732d096b5b88a3558c90474cd7043d644", "committedDate": "2020-06-05T13:00:05Z", "message": "When moving a widget also add new WidgetPostion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a27bea7bc009448c37867762069c411978746d2", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/8a27bea7bc009448c37867762069c411978746d2", "committedDate": "2020-06-05T13:09:03Z", "message": "fix linter warnings"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1OTgzODE0", "url": "https://github.com/Graylog2/graylog2-server/pull/8236#pullrequestreview-425983814", "createdAt": "2020-06-08T07:44:54Z", "commit": {"oid": "8a27bea7bc009448c37867762069c411978746d2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwNzo0NDo1NFrOGgSgNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwODoxNjo1MFrOGgTfbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjUxMDc3Mw==", "bodyText": "What is the reason you've implemented .col(0).row(0) here?\nIt would be great if moving a widget to a dashboard tab would add the widget to the tab in the same way, like when adding a new widget to a tab. We could reuse some of the logic to recalculate the widget positions from CurrentViewStateStore -> widgets()", "url": "https://github.com/Graylog2/graylog2-server/pull/8236#discussion_r436510773", "createdAt": "2020-06-08T07:44:54Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/views/logic/views/MoveWidgetToTab.js", "diffHunk": "@@ -0,0 +1,66 @@\n+// @flow strict\n+import uuid from 'uuid/v4';\n+import type { QueryId } from 'views/logic/queries/Query';\n+import type { WidgetId } from 'views/logic/views/types';\n+import View from './View';\n+import FindWidgetAndQueryIdInView from './FindWidgetAndQueryIdInView';\n+import Widget from '../widgets/Widget';\n+import UpdateSearchForWidgets from './UpdateSearchForWidgets';\n+import WidgetPosition from '../widgets/WidgetPosition';\n+\n+\n+const _removeWidgetFromTab = (widgetId: WidgetId, queryId: QueryId, dashboard: View): View => {\n+  const viewState = dashboard.state.get(queryId);\n+  const widgetIndex = viewState.widgets.findIndex((widget) => widget.id === widgetId);\n+  const { widgetPositions } = viewState;\n+  delete widgetPositions[widgetId];\n+  const { widgetMapping } = viewState;\n+  const newWidgetMapping = widgetMapping.remove(widgetId);\n+  const newViewState = viewState.toBuilder()\n+    .widgets(viewState.widgets.delete(widgetIndex))\n+    .widgetMapping(newWidgetMapping)\n+    .widgetPositions(widgetPositions)\n+    .build();\n+  return dashboard.toBuilder()\n+    .state(dashboard.state.set(queryId, newViewState))\n+    .build();\n+};\n+\n+const _addWidgetToTab = (widget: Widget, targetQueryId: QueryId, dashboard: View, widgetPosition: WidgetPosition): View => {\n+  const viewState = dashboard.state.get(targetQueryId);\n+  const newWidget = widget.toBuilder().id(uuid()).build();\n+  const { widgetPositions } = viewState;\n+  widgetPositions[newWidget.id] = widgetPosition;\n+  const newViewState = viewState.toBuilder()\n+    .widgets(viewState.widgets.push(newWidget))\n+    .widgetPositions(widgetPositions)\n+    .build();\n+  return dashboard.toBuilder()\n+    .state(dashboard.state.set(targetQueryId, newViewState))\n+    .build();\n+};\n+\n+const _getWidgetPosition = (widgetId: WidgetId, queryId: QueryId, view: View): WidgetPosition => {\n+  return view.state.get(queryId).widgetPositions[widgetId];\n+};\n+\n+const MoveWidgetToTab = (widgetId: WidgetId, targetQueryId: QueryId, dashboard: View, copy: boolean = false): ?View => {\n+  if (dashboard.type !== View.Type.Dashboard) {\n+    throw new Error(`Unexpected type ${dashboard.type} expected ${View.Type.Dashboard}`);\n+  }\n+\n+  const match: ?[Widget, QueryId] = FindWidgetAndQueryIdInView(widgetId, dashboard);\n+\n+  if (match) {\n+    const [widget, queryId] = match;\n+    const newWidgetPosition = _getWidgetPosition(widgetId, queryId, dashboard).toBuilder()\n+      .col(0)\n+      .row(0)\n+      .build();\n+    const tempDashboard = copy ? dashboard : _removeWidgetFromTab(widgetId, queryId, dashboard);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a27bea7bc009448c37867762069c411978746d2"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjUxMjM2NQ==", "bodyText": "Let's reimplement submitButtonDisabled={!selectedTab} here.", "url": "https://github.com/Graylog2/graylog2-server/pull/8236#discussion_r436512365", "createdAt": "2020-06-08T07:48:07Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/views/components/widgets/MoveWidgetToTabModal.jsx", "diffHunk": "@@ -30,36 +31,30 @@ const MoveWidgetToTabModal = ({ view, onCancel, onSubmit, widgetId }: Props) =>\n   const list = _tabList(view);\n \n   const tabList = list.map(({ id, name }) => (\n-    <ListGroupItem header={name}\n-                   onClick={() => setSelectedTab(id)}\n+    <ListGroupItem onClick={() => setSelectedTab(id)}\n                    active={id === selectedTab}\n-                   key={id} />\n+                   key={id}>\n+      {name}\n+    </ListGroupItem>\n   ));\n   const renderResult = list && list.length > 0\n     ? <ListGroup>{tabList}</ListGroup>\n     : <span>No dashboards found</span>;\n \n   return (\n-    <Modal show>\n-      <Modal.Body>\n-        {renderResult}\n-        <Input type=\"checkbox\"\n-               id=\"keepCopy\"\n-               name=\"keepCopy\"\n-               label=\"Keep Copy on this Page\"\n-               onChange={(e) => setKeepCopy(e.target.checked)}\n-               help=\"When 'Keep Copy on the Page' is enabled, the widget will be copied and not moved to another page\"\n-               checked={keepCopy} />\n-      </Modal.Body>\n-      <Modal.Footer>\n-        <Button bsStyle=\"primary\"\n-                disabled={selectedTab === null}\n-                onClick={() => onSubmit(widgetId, selectedTab, keepCopy)}>\n-          Select\n-        </Button>\n-        <Button onClick={onCancel}>Cancel</Button>\n-      </Modal.Footer>\n-    </Modal>\n+    <BootstrapModalForm show\n+                        onCancel={onCancel}\n+                        onSubmitForm={() => onSubmit(widgetId, selectedTab, keepCopy)}\n+                        title=\"Choose Target Page\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6595fb8df167e6de738f65af67a9dfca88d1c91d"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjUyMzA5NA==", "bodyText": "Regarding the sort, it does not look correct to me, compared with the dashboard:\n\nOne solution is using the order / values provided by the QueryIdsStore.", "url": "https://github.com/Graylog2/graylog2-server/pull/8236#discussion_r436523094", "createdAt": "2020-06-08T08:09:09Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/views/components/widgets/MoveWidgetToTabModal.jsx", "diffHunk": "@@ -0,0 +1,64 @@\n+// @flow strict\n+import React, { useState } from 'react';\n+import { ListGroup, ListGroupItem } from 'components/graylog';\n+import BootstrapModalForm from 'components/bootstrap/BootstrapModalForm';\n+import Input from 'components/bootstrap/Input';\n+import { useStore } from 'stores/connect';\n+import QueryTitle from 'views/logic/queries/QueryTitle';\n+import { CurrentQueryStore } from 'views/stores/CurrentQueryStore';\n+\n+import View from 'views/logic/views/View';\n+\n+type Props = {\n+  view: View,\n+  widgetId: string,\n+  onCancel: () => void,\n+  onSubmit: (widgetId: string, selectedTab: ?string, keepCopy: boolean) => void,\n+};\n+\n+type TabEntry = { id: string, name: string };\n+\n+const _tabList = (view: View): Array<TabEntry> => {\n+  const queryIds = Object.keys(view.state.toObject());\n+  return queryIds.map((queryId) => {\n+    const tabTitle = QueryTitle(view, queryId) || 'Unknown Page title';\n+    return ({ id: queryId, name: tabTitle });\n+  });\n+};\n+\n+const MoveWidgetToTabModal = ({ view, onCancel, onSubmit, widgetId }: Props) => {\n+  const [selectedTab, setSelectedTab] = useState(null);\n+  const [keepCopy, setKeepCopy] = useState(false);\n+  const { id: activeQuery } = useStore(CurrentQueryStore);\n+\n+  const list = _tabList(view).filter(({ id }) => id !== activeQuery);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a27bea7bc009448c37867762069c411978746d2"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjUyNjk1Nw==", "bodyText": "With the last review I suggested to remove the current tab from the list, but after having another look I prefer to just disable the active tab. It has the benefits, that the user always sees the \"same\" list no matter on which tab he opens the modal and it is easier to find the surrounding tabs.", "url": "https://github.com/Graylog2/graylog2-server/pull/8236#discussion_r436526957", "createdAt": "2020-06-08T08:16:50Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/views/components/widgets/MoveWidgetToTabModal.jsx", "diffHunk": "@@ -0,0 +1,64 @@\n+// @flow strict\n+import React, { useState } from 'react';\n+import { ListGroup, ListGroupItem } from 'components/graylog';\n+import BootstrapModalForm from 'components/bootstrap/BootstrapModalForm';\n+import Input from 'components/bootstrap/Input';\n+import { useStore } from 'stores/connect';\n+import QueryTitle from 'views/logic/queries/QueryTitle';\n+import { CurrentQueryStore } from 'views/stores/CurrentQueryStore';\n+\n+import View from 'views/logic/views/View';\n+\n+type Props = {\n+  view: View,\n+  widgetId: string,\n+  onCancel: () => void,\n+  onSubmit: (widgetId: string, selectedTab: ?string, keepCopy: boolean) => void,\n+};\n+\n+type TabEntry = { id: string, name: string };\n+\n+const _tabList = (view: View): Array<TabEntry> => {\n+  const queryIds = Object.keys(view.state.toObject());\n+  return queryIds.map((queryId) => {\n+    const tabTitle = QueryTitle(view, queryId) || 'Unknown Page title';\n+    return ({ id: queryId, name: tabTitle });\n+  });\n+};\n+\n+const MoveWidgetToTabModal = ({ view, onCancel, onSubmit, widgetId }: Props) => {\n+  const [selectedTab, setSelectedTab] = useState(null);\n+  const [keepCopy, setKeepCopy] = useState(false);\n+  const { id: activeQuery } = useStore(CurrentQueryStore);\n+\n+  const list = _tabList(view).filter(({ id }) => id !== activeQuery);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjUyMzA5NA=="}, "originalCommit": {"oid": "8a27bea7bc009448c37867762069c411978746d2"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5675dd7ede92f5f77234f06f908ea3d68780ac3", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/a5675dd7ede92f5f77234f06f908ea3d68780ac3", "committedDate": "2020-06-09T13:48:09Z", "message": "Use QueryIds store to keep the order of pages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ca17029586be58a60e5b4dbe4188a0a0c8eb44a", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/4ca17029586be58a60e5b4dbe4188a0a0c8eb44a", "committedDate": "2020-06-09T13:49:31Z", "message": "Disable submit button if nothing is selected"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1c3c145c35b45a2fd9bce0e3f912ff738ada056", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/d1c3c145c35b45a2fd9bce0e3f912ff738ada056", "committedDate": "2020-06-09T14:19:24Z", "message": "Use the first row notation from WidgetGrid (starting by 1)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c27fb773b4545ebf5d14d820086130cba94beff", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/7c27fb773b4545ebf5d14d820086130cba94beff", "committedDate": "2020-06-09T14:20:57Z", "message": "zero was correct"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d78309da7871dcfe45b9de824b6945b1085faf2e", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/d78309da7871dcfe45b9de824b6945b1085faf2e", "committedDate": "2020-06-10T12:07:26Z", "message": "Recalcutate WidgetPositions\n\nPrior to this change, we simply add a new WidgetPosition with row 1 and\ncol 1. This will only lead to the problem that now 2 widgets have this\ncoordinates.\n\nThis change will reuse the calculation method from\nCurrentViewStateStore."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MDIwODQ0", "url": "https://github.com/Graylog2/graylog2-server/pull/8236#pullrequestreview-428020844", "createdAt": "2020-06-10T12:53:51Z", "commit": {"oid": "d78309da7871dcfe45b9de824b6945b1085faf2e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6021e6e1208ce9370486b3b3814d709fa169d9fb", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/6021e6e1208ce9370486b3b3814d709fa169d9fb", "committedDate": "2020-06-12T08:47:31Z", "message": "Also move the title of the widget"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "420b22c06b4785844b2c8015f18a0b23a246e149", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/420b22c06b4785844b2c8015f18a0b23a246e149", "committedDate": "2020-06-12T09:12:12Z", "message": "useCallback to memorize the callbacks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5NzM5NTk0", "url": "https://github.com/Graylog2/graylog2-server/pull/8236#pullrequestreview-429739594", "createdAt": "2020-06-12T13:28:24Z", "commit": {"oid": "420b22c06b4785844b2c8015f18a0b23a246e149"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3138, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}