{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzMjE5ODg2", "number": 7189, "title": " Add pipeline functions to modify lookup tables", "bodyText": "This adds the following pipeline functions:\n\nlookup_set_value(\"table-name\", \"key\", \"value\")\nlookup_set_string_list(\"table-name\", \"key\", [\"value1\", \"value2\"])\nlookup_add_string_list(\"table-name\", \"key\", [\"value1\", \"value2\"])\nlookup_remove_string_list(\"table-name\", \"key\", [\"remove1\", \"remove2\"])\nlookup_clear_key(\"table-name\", \"key\")", "createdAt": "2020-01-15T16:15:25Z", "url": "https://github.com/Graylog2/graylog2-server/pull/7189", "merged": true, "mergeCommit": {"oid": "afd6d8dd55869fa5ff306b5f1e425b2376f0e5a2"}, "closed": true, "closedAt": "2020-01-22T11:43:16Z", "author": {"login": "mpfz0r"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6hpGpAH2gAyMzYzMjE5ODg2OmE3YTUzNDQzNzMxZjc1NzM0ZmFjOWQ5YTI2YzBmOThlNDllZTU4NDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb80OonAFqTM0NjUyNDc3NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a7a53443731f75734fac9d9a26c0f98e49ee5842", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/a7a53443731f75734fac9d9a26c0f98e49ee5842", "committedDate": "2020-01-15T08:54:18Z", "message": "Add lookup_string_list pipeline function\n\nIdeally the types should be List<String> but we cannot store\nclass instances of generic types at runtime."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2289208cd4a014f11c666a38f6ceec66265221ec", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/2289208cd4a014f11c666a38f6ceec66265221ec", "committedDate": "2020-01-15T16:01:10Z", "message": "Add pipeline functions to modify lookup tables\n\n- lookup_set_value\n- lookup_add_string_list\n- lookup_remove_string_list\n- lookup_set_string_list"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzMzcyNDM0", "url": "https://github.com/Graylog2/graylog2-server/pull/7189#pullrequestreview-343372434", "createdAt": "2020-01-15T16:57:39Z", "commit": {"oid": "2289208cd4a014f11c666a38f6ceec66265221ec"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNjo1NzozOVrOFd_a6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNzowNjo1MlrOFd_uCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njk5MjEwNw==", "bodyText": "How about just using value instead of list_value? The function is already called lookup_add_string_list so the list_value feels redundant.", "url": "https://github.com/Graylog2/graylog2-server/pull/7189#discussion_r366992107", "createdAt": "2020-01-15T16:57:39Z", "author": {"login": "bernd"}, "path": "graylog2-server/src/main/java/org/graylog/plugins/pipelineprocessor/functions/lookup/LookupAddStringList.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.plugins.pipelineprocessor.functions.lookup;\n+\n+import com.google.inject.Inject;\n+import org.graylog.plugins.pipelineprocessor.EvaluationContext;\n+import org.graylog.plugins.pipelineprocessor.ast.functions.AbstractFunction;\n+import org.graylog.plugins.pipelineprocessor.ast.functions.FunctionArgs;\n+import org.graylog.plugins.pipelineprocessor.ast.functions.FunctionDescriptor;\n+import org.graylog.plugins.pipelineprocessor.ast.functions.ParameterDescriptor;\n+import org.graylog2.lookup.LookupTableService;\n+\n+import java.util.List;\n+\n+import static org.graylog.plugins.pipelineprocessor.ast.functions.ParameterDescriptor.bool;\n+import static org.graylog.plugins.pipelineprocessor.ast.functions.ParameterDescriptor.object;\n+import static org.graylog.plugins.pipelineprocessor.ast.functions.ParameterDescriptor.string;\n+\n+public class LookupAddStringList extends AbstractFunction<Object> {\n+\n+    public static final String NAME = \"lookup_add_string_list\";\n+\n+    private final ParameterDescriptor<String, LookupTableService.Function> lookupTableParam;\n+    private final ParameterDescriptor<Object, Object> keyParam;\n+    @SuppressWarnings(\"rawtypes\")\n+    private final ParameterDescriptor<List, List> valueParam;\n+    private final ParameterDescriptor<Boolean, Boolean> appendOption;\n+\n+    @Inject\n+    public LookupAddStringList(LookupTableService lookupTableService) {\n+        lookupTableParam = string(\"lookup_table\", LookupTableService.Function.class)\n+                .description(\"The existing lookup table to use to add the given list\")\n+                .transform(tableName -> lookupTableService.newBuilder().lookupTable(tableName).build())\n+                .build();\n+        keyParam = object(\"key\")\n+                .description(\"The key to add in the lookup table\")\n+                .build();\n+        valueParam = ParameterDescriptor.type(\"list_value\", List.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2289208cd4a014f11c666a38f6ceec66265221ec"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njk5NDgwNQ==", "bodyText": "What do you think about naming this (and also in other parts of the backend code) keep_duplicates? From reading the parameter name, I wasn't really sure what it meant.", "url": "https://github.com/Graylog2/graylog2-server/pull/7189#discussion_r366994805", "createdAt": "2020-01-15T17:02:38Z", "author": {"login": "bernd"}, "path": "graylog2-server/src/main/java/org/graylog/plugins/pipelineprocessor/functions/lookup/LookupAddStringList.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.plugins.pipelineprocessor.functions.lookup;\n+\n+import com.google.inject.Inject;\n+import org.graylog.plugins.pipelineprocessor.EvaluationContext;\n+import org.graylog.plugins.pipelineprocessor.ast.functions.AbstractFunction;\n+import org.graylog.plugins.pipelineprocessor.ast.functions.FunctionArgs;\n+import org.graylog.plugins.pipelineprocessor.ast.functions.FunctionDescriptor;\n+import org.graylog.plugins.pipelineprocessor.ast.functions.ParameterDescriptor;\n+import org.graylog2.lookup.LookupTableService;\n+\n+import java.util.List;\n+\n+import static org.graylog.plugins.pipelineprocessor.ast.functions.ParameterDescriptor.bool;\n+import static org.graylog.plugins.pipelineprocessor.ast.functions.ParameterDescriptor.object;\n+import static org.graylog.plugins.pipelineprocessor.ast.functions.ParameterDescriptor.string;\n+\n+public class LookupAddStringList extends AbstractFunction<Object> {\n+\n+    public static final String NAME = \"lookup_add_string_list\";\n+\n+    private final ParameterDescriptor<String, LookupTableService.Function> lookupTableParam;\n+    private final ParameterDescriptor<Object, Object> keyParam;\n+    @SuppressWarnings(\"rawtypes\")\n+    private final ParameterDescriptor<List, List> valueParam;\n+    private final ParameterDescriptor<Boolean, Boolean> appendOption;\n+\n+    @Inject\n+    public LookupAddStringList(LookupTableService lookupTableService) {\n+        lookupTableParam = string(\"lookup_table\", LookupTableService.Function.class)\n+                .description(\"The existing lookup table to use to add the given list\")\n+                .transform(tableName -> lookupTableService.newBuilder().lookupTable(tableName).build())\n+                .build();\n+        keyParam = object(\"key\")\n+                .description(\"The key to add in the lookup table\")\n+                .build();\n+        valueParam = ParameterDescriptor.type(\"list_value\", List.class)\n+                .description(\"The list value that should be added into the lookup table\")\n+                .build();\n+        appendOption = bool(\"append_values\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2289208cd4a014f11c666a38f6ceec66265221ec"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njk5NzAwMg==", "bodyText": "What do you think about returning an empty LookupResult instead of nulls here and below? Since we don't have conditionals in the rule language, returning null might result in exceptions if the return value will be used in the rule.\nReturning an empty or even an error LookupResult should avoid that because we always return a value.", "url": "https://github.com/Graylog2/graylog2-server/pull/7189#discussion_r366997002", "createdAt": "2020-01-15T17:06:52Z", "author": {"login": "bernd"}, "path": "graylog2-server/src/main/java/org/graylog/plugins/pipelineprocessor/functions/lookup/LookupAddStringList.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.plugins.pipelineprocessor.functions.lookup;\n+\n+import com.google.inject.Inject;\n+import org.graylog.plugins.pipelineprocessor.EvaluationContext;\n+import org.graylog.plugins.pipelineprocessor.ast.functions.AbstractFunction;\n+import org.graylog.plugins.pipelineprocessor.ast.functions.FunctionArgs;\n+import org.graylog.plugins.pipelineprocessor.ast.functions.FunctionDescriptor;\n+import org.graylog.plugins.pipelineprocessor.ast.functions.ParameterDescriptor;\n+import org.graylog2.lookup.LookupTableService;\n+\n+import java.util.List;\n+\n+import static org.graylog.plugins.pipelineprocessor.ast.functions.ParameterDescriptor.bool;\n+import static org.graylog.plugins.pipelineprocessor.ast.functions.ParameterDescriptor.object;\n+import static org.graylog.plugins.pipelineprocessor.ast.functions.ParameterDescriptor.string;\n+\n+public class LookupAddStringList extends AbstractFunction<Object> {\n+\n+    public static final String NAME = \"lookup_add_string_list\";\n+\n+    private final ParameterDescriptor<String, LookupTableService.Function> lookupTableParam;\n+    private final ParameterDescriptor<Object, Object> keyParam;\n+    @SuppressWarnings(\"rawtypes\")\n+    private final ParameterDescriptor<List, List> valueParam;\n+    private final ParameterDescriptor<Boolean, Boolean> appendOption;\n+\n+    @Inject\n+    public LookupAddStringList(LookupTableService lookupTableService) {\n+        lookupTableParam = string(\"lookup_table\", LookupTableService.Function.class)\n+                .description(\"The existing lookup table to use to add the given list\")\n+                .transform(tableName -> lookupTableService.newBuilder().lookupTable(tableName).build())\n+                .build();\n+        keyParam = object(\"key\")\n+                .description(\"The key to add in the lookup table\")\n+                .build();\n+        valueParam = ParameterDescriptor.type(\"list_value\", List.class)\n+                .description(\"The list value that should be added into the lookup table\")\n+                .build();\n+        appendOption = bool(\"append_values\")\n+                .optional()\n+                .description(\"Append values instead of merging them with existing ones into a set. Defaults to false (merge)\")\n+                .build();\n+    }\n+\n+    @Override\n+    public Object evaluate(FunctionArgs args, EvaluationContext context) {\n+        Object key = keyParam.required(args, context);\n+        if (key == null) {\n+            return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2289208cd4a014f11c666a38f6ceec66265221ec"}, "originalPosition": 65}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a4ba1016b020825605a24402f125a4775bac538", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/9a4ba1016b020825605a24402f125a4775bac538", "committedDate": "2020-01-16T10:49:39Z", "message": "fix review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58c77ef9cfb533098d8c5d8c9dda2c32b7535a11", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/58c77ef9cfb533098d8c5d8c9dda2c32b7535a11", "committedDate": "2020-01-17T12:45:23Z", "message": "Merge remote-tracking branch 'origin/master' into lookup-set-pipeline-functions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "199075abefe746292b10d6dedd128c568902efd9", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/199075abefe746292b10d6dedd128c568902efd9", "committedDate": "2020-01-17T16:59:01Z", "message": "Add test for lookup table pipeline functions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "112c2cd7f475a8bc8b7f2805511751935ffdce98", "author": {"user": {"login": "bernd", "name": "Bernd Ahlers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/112c2cd7f475a8bc8b7f2805511751935ffdce98", "committedDate": "2020-01-20T13:27:07Z", "message": "Merge branch 'master' into lookup-set-pipeline-functions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db2af8b98352ba420e3e5c3243533904836712d4", "author": {"user": {"login": "bernd", "name": "Bernd Ahlers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/db2af8b98352ba420e3e5c3243533904836712d4", "committedDate": "2020-01-21T18:07:57Z", "message": "Add \"lookup_clear_key\" function to remove entries from lookup tables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2477c800f7118a8b1c32fe3a1951efb1414cf2cf", "author": {"user": {"login": "bernd", "name": "Bernd Ahlers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/2477c800f7118a8b1c32fe3a1951efb1414cf2cf", "committedDate": "2020-01-21T18:11:34Z", "message": "Fix function type"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NTI0Nzc0", "url": "https://github.com/Graylog2/graylog2-server/pull/7189#pullrequestreview-346524774", "createdAt": "2020-01-22T11:41:26Z", "commit": {"oid": "2477c800f7118a8b1c32fe3a1951efb1414cf2cf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2682, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}