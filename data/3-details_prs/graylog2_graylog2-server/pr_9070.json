{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3MDc4MDE5", "number": 9070, "title": "Migrate user permissions into grants", "bodyText": "Fixes #8919\n/jenkins-pr-deps Graylog2/graylog-plugin-enterprise#1569", "createdAt": "2020-10-02T18:49:43Z", "url": "https://github.com/Graylog2/graylog2-server/pull/9070", "merged": true, "mergeCommit": {"oid": "d3ae9fab56c17be9fca5b08111f0de277882277a"}, "closed": true, "closedAt": "2020-10-09T10:22:56Z", "author": {"login": "mpfz0r"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOo1-cAH2gAyNDk3MDc4MDE5OmRmMDYzM2FiOTZhODMwYTA3MjJhNjlkZDljY2JkODk5YjZiMWVmOTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQzhGQAFqTUwNTU0NjQ1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "df0633ab96a830a0722a69dd9ccbd899b6b1ef98", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/df0633ab96a830a0722a69dd9ccbd899b6b1ef98", "committedDate": "2020-10-02T16:47:20Z", "message": "Migrate user permissions to grants\n\nFixes #8919"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b058d934c209dd376d8cd8820ee2ef5be4dfa079", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/b058d934c209dd376d8cd8820ee2ef5be4dfa079", "committedDate": "2020-10-02T18:47:40Z", "message": "Clean up file structure and deduplicate code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8ae1de176d4d9abf9c7ed5be679cc9150e18013", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/d8ae1de176d4d9abf9c7ed5be679cc9150e18013", "committedDate": "2020-10-05T08:52:03Z", "message": "Also migrate saved searches and event definition permissions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7786572b29385422a5a0d87f6846d7b85f3d541b", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/7786572b29385422a5a0d87f6846d7b85f3d541b", "committedDate": "2020-10-05T09:04:50Z", "message": "add license"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e4d011c1b6124f1daac9d3e7a6205c98c6ec768", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/6e4d011c1b6124f1daac9d3e7a6205c98c6ec768", "committedDate": "2020-10-05T09:08:47Z", "message": "improve comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58a8c877c6d423ea6167163a2f9e23069b3222b1", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/58a8c877c6d423ea6167163a2f9e23069b3222b1", "committedDate": "2020-10-07T15:30:17Z", "message": "Don't fail on already existing grants"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NjE4NTU5", "url": "https://github.com/Graylog2/graylog2-server/pull/9070#pullrequestreview-504618559", "createdAt": "2020-10-08T09:57:47Z", "commit": {"oid": "58a8c877c6d423ea6167163a2f9e23069b3222b1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NjE5MTMy", "url": "https://github.com/Graylog2/graylog2-server/pull/9070#pullrequestreview-504619132", "createdAt": "2020-10-08T09:58:28Z", "commit": {"oid": "58a8c877c6d423ea6167163a2f9e23069b3222b1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "478cc10192fb6d3dbc9c400addc24b2bd37900b8", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/478cc10192fb6d3dbc9c400addc24b2bd37900b8", "committedDate": "2020-10-08T10:11:54Z", "message": "Handle grants update with different capabilies\n\nChange DBGrantService.ensure() to allow updating grants\nto a higher capability, but not to a lower one.\n\nThis is used by migrations that could try to create\ndifferent grants for the same target.\nAfter all migrations are run, we will end up with the grant that\nhas the most powerful capability."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9d0977b75c98869c38b4bb1562e41ad37fa5b71", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/a9d0977b75c98869c38b4bb1562e41ad37fa5b71", "committedDate": "2020-10-08T10:28:24Z", "message": "don't user assert"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NzQ2Mzg5", "url": "https://github.com/Graylog2/graylog2-server/pull/9070#pullrequestreview-504746389", "createdAt": "2020-10-08T12:50:23Z", "commit": {"oid": "a9d0977b75c98869c38b4bb1562e41ad37fa5b71"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0ODgzNjM3", "url": "https://github.com/Graylog2/graylog2-server/pull/9070#pullrequestreview-504883637", "createdAt": "2020-10-08T15:05:45Z", "commit": {"oid": "a9d0977b75c98869c38b4bb1562e41ad37fa5b71"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxNTowNTo0NVrOHejMGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxNTowNTo0NVrOHejMGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc5NTg2Ng==", "bodyText": "I am not sure if using the #ordinal method of the enum will bite us at one point in the future. The value will change if the enums are reordered at some point. (e.g. someone wants them to be sorted alphabetically and refactors the order) How about adding an explicit priority value to each enum instead?", "url": "https://github.com/Graylog2/graylog2-server/pull/9070#discussion_r501795866", "createdAt": "2020-10-08T15:05:45Z", "author": {"login": "bernd"}, "path": "graylog2-server/src/main/java/org/graylog/security/DBGrantService.java", "diffHunk": "@@ -136,6 +141,27 @@ public GrantDTO create(GRN grantee, Capability capability, GRN target, String cr\n         return create(GrantDTO.of(grantee, capability, target), creatorUsername);\n     }\n \n+    /**\n+     * Ensure that a grant with the requested or a higher capability exists.\n+     * @return the created, updated or existing grant\n+     */\n+    public GrantDTO ensure(GRN grantee, Capability capability, GRN target, String creatorUsername) {\n+        final List<GrantDTO> existingGrants = getForTargetAndGrantee(target, grantee);\n+        if (existingGrants.isEmpty()) {\n+            return create(grantee, capability, target, creatorUsername);\n+        }\n+        // This should never happen\n+        Preconditions.checkState(existingGrants.size() == 1);\n+\n+        final GrantDTO grantDTO = existingGrants.get(0);\n+        // Only upgrade capabilities: VIEW < MANAGE < OWNER\n+        if (capability.ordinal() > grantDTO.capability().ordinal()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9d0977b75c98869c38b4bb1562e41ad37fa5b71"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10a2dcf18a56d7cfd5d3e232ea2d96aa3415c7c5", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/10a2dcf18a56d7cfd5d3e232ea2d96aa3415c7c5", "committedDate": "2020-10-08T17:09:01Z", "message": "Use explicit capability priority instead of ordinal"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5687e36d67e684daf1a796f5b20bd575688abd43", "author": {"user": {"login": "bernd", "name": "Bernd Ahlers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/5687e36d67e684daf1a796f5b20bd575688abd43", "committedDate": "2020-10-09T09:16:15Z", "message": "Merge remote-tracking branch 'origin/feature/permissions' into migrate-user-permissions-to-grants"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NTQ2NDUy", "url": "https://github.com/Graylog2/graylog2-server/pull/9070#pullrequestreview-505546452", "createdAt": "2020-10-09T10:21:20Z", "commit": {"oid": "5687e36d67e684daf1a796f5b20bd575688abd43"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3486, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}