{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4NTE2OTYz", "number": 8291, "title": "Prevent single number widget flickering", "bodyText": "This PR needs a backport for 3.3\nAs described in #7563 the single number widget can flicker when the widget has a small height.\nThis happened because the font size always changed between 11px and 10px. in both cases the defined tolerance did not matched. This PR is fixing the issue by increasing the tolerance. It also refactors the AutoFontSizer code style.\nThe issue is currently not occurring on the master branch, because #8064 changed the widget content height. You can reproduce the error, by checking out the commit ed8998c3251 and following the steps in the mentioned issue.\nFixes #7563\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Refactoring (non-breaking change)\n Breaking change (fix or feature that would cause existing functionality to change)", "createdAt": "2020-06-05T15:06:44Z", "url": "https://github.com/Graylog2/graylog2-server/pull/8291", "merged": true, "mergeCommit": {"oid": "5028e405ee210e38c2993d7906e18f82e53377c1"}, "closed": true, "closedAt": "2020-06-12T14:30:00Z", "author": {"login": "linuspahl"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoT-VUAH2gAyNDI4NTE2OTYzOjhiNDJiZjlhMmZlMjQ5ZWY2YTYxNDUyNzZiODBiYjEzZDhmMTBjMzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqjv5tAFqTQyOTc4OTExNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8b42bf9a2fe249ef6a6145276b80bb13d8f10c38", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/8b42bf9a2fe249ef6a6145276b80bb13d8f10c38", "committedDate": "2020-06-05T14:59:20Z", "message": "Refactor AutoFontSizer code style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d621ab592c12832f57a79d608297404fb7b08d79", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/d621ab592c12832f57a79d608297404fb7b08d79", "committedDate": "2020-06-05T14:59:41Z", "message": "Increase tolerance when calculating most appropriate font size"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MTQ3NTc2", "url": "https://github.com/Graylog2/graylog2-server/pull/8291#pullrequestreview-426147576", "createdAt": "2020-06-08T11:43:56Z", "commit": {"oid": "d621ab592c12832f57a79d608297404fb7b08d79"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMTo0Mzo1NlrOGgaCbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMTo0NTo0MlrOGgaFcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYzNDIyMA==", "bodyText": "Instead of extracting a function for the update step, it would be more helpful to extract a predicate that checks if the new font size should be set, something like:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                _updateFontSize(setFontSize, fontSize, newFontSize);\n          \n          \n            \n                if (newFontSize !== fontSize && isValidFontSize(newFontSize)) {\n          \n          \n            \n                  setFontSize(newFontSize);\n          \n          \n            \n                }", "url": "https://github.com/Graylog2/graylog2-server/pull/8291#discussion_r436634220", "createdAt": "2020-06-08T11:43:56Z", "author": {"login": "dennisoelkers"}, "path": "graylog2-web-interface/src/views/components/visualizations/number/AutoFontSizer.jsx", "diffHunk": "@@ -16,45 +16,51 @@ type Props = {\n };\n \n const _multiplierForElement = (element, targetWidth, targetHeight) => {\n+  const childSizeRatio = 0.8; // Propotion of the child size in relation to the container\n   const contentWidth = element.offsetWidth;\n   const contentHeight = element.offsetHeight;\n \n-  const widthMultiplier = (targetWidth * 0.8) / contentWidth;\n-  const heightMultiplier = (targetHeight * 0.8) / contentHeight;\n+  const widthMultiplier = (targetWidth * childSizeRatio) / contentWidth;\n+  const heightMultiplier = (targetHeight * childSizeRatio) / contentHeight;\n   return Math.min(widthMultiplier, heightMultiplier);\n };\n \n-const AutoFontSizer = ({ children, target, height, width }: Props) => {\n+const _updateFontSize = (setFontSize, currentSize, newSize) => {\n+  if (currentSize !== newSize && newSize !== 0 && Number.isFinite(newSize)) {\n+    setFontSize(newSize);\n+  }\n+};\n+\n+const useAutoFontSize = (target, _container, height, width) => {\n+  // This hook will update the font size based on the difference between the dimensions of the container and its child.\n+  // The font size is being recalculated, until the mentioned difference is within the tolerance.\n+  const tolerance = 0.05;\n   const [fontSize, setFontSize] = useState(20);\n-  const _container = useRef<?HTMLElement>();\n \n   useEffect(() => {\n     const container = target ? { current: { children: [target] } } : _container;\n-    if (!container.current) {\n-      return;\n-    }\n-\n-    const { children: containerChildren } = container.current;\n+    const containerChildren = container?.current?.children;\n \n-    if (containerChildren.length <= 0) {\n+    if (!containerChildren || containerChildren.length <= 0) {\n       return;\n     }\n \n     const contentElement = containerChildren[0];\n     const multiplier = _multiplierForElement(contentElement, width, height);\n-\n-    if (Math.abs(1 - multiplier) <= 0.01) {\n+    if (Math.abs(1 - multiplier) <= tolerance) {\n       return;\n     }\n \n-    const newFontsize = Math.floor(fontSize * multiplier);\n-\n-    if (fontSize !== newFontsize && newFontsize !== 0 && Number.isFinite(newFontsize)) {\n-      // eslint-disable-next-line react/no-did-update-set-state\n-      setFontSize(newFontsize);\n-    }\n+    const newFontSize = Math.floor(fontSize * multiplier);\n+    _updateFontSize(setFontSize, fontSize, newFontSize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d621ab592c12832f57a79d608297404fb7b08d79"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYzNDYyMA==", "bodyText": "This constant could be pulled out of the function scope and into the module scope. Also: Propotion -> Proportion", "url": "https://github.com/Graylog2/graylog2-server/pull/8291#discussion_r436634620", "createdAt": "2020-06-08T11:44:54Z", "author": {"login": "dennisoelkers"}, "path": "graylog2-web-interface/src/views/components/visualizations/number/AutoFontSizer.jsx", "diffHunk": "@@ -16,45 +16,51 @@ type Props = {\n };\n \n const _multiplierForElement = (element, targetWidth, targetHeight) => {\n+  const childSizeRatio = 0.8; // Propotion of the child size in relation to the container", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d621ab592c12832f57a79d608297404fb7b08d79"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYzNDc2Ng==", "bodyText": "This constant could be pulled out of the function scope and into the module scope.", "url": "https://github.com/Graylog2/graylog2-server/pull/8291#discussion_r436634766", "createdAt": "2020-06-08T11:45:13Z", "author": {"login": "dennisoelkers"}, "path": "graylog2-web-interface/src/views/components/visualizations/number/AutoFontSizer.jsx", "diffHunk": "@@ -16,45 +16,51 @@ type Props = {\n };\n \n const _multiplierForElement = (element, targetWidth, targetHeight) => {\n+  const childSizeRatio = 0.8; // Propotion of the child size in relation to the container\n   const contentWidth = element.offsetWidth;\n   const contentHeight = element.offsetHeight;\n \n-  const widthMultiplier = (targetWidth * 0.8) / contentWidth;\n-  const heightMultiplier = (targetHeight * 0.8) / contentHeight;\n+  const widthMultiplier = (targetWidth * childSizeRatio) / contentWidth;\n+  const heightMultiplier = (targetHeight * childSizeRatio) / contentHeight;\n   return Math.min(widthMultiplier, heightMultiplier);\n };\n \n-const AutoFontSizer = ({ children, target, height, width }: Props) => {\n+const _updateFontSize = (setFontSize, currentSize, newSize) => {\n+  if (currentSize !== newSize && newSize !== 0 && Number.isFinite(newSize)) {\n+    setFontSize(newSize);\n+  }\n+};\n+\n+const useAutoFontSize = (target, _container, height, width) => {\n+  // This hook will update the font size based on the difference between the dimensions of the container and its child.\n+  // The font size is being recalculated, until the mentioned difference is within the tolerance.\n+  const tolerance = 0.05;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d621ab592c12832f57a79d608297404fb7b08d79"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYzNDk5Mw==", "bodyText": "We should turn this into a JSDoc comment.", "url": "https://github.com/Graylog2/graylog2-server/pull/8291#discussion_r436634993", "createdAt": "2020-06-08T11:45:42Z", "author": {"login": "dennisoelkers"}, "path": "graylog2-web-interface/src/views/components/visualizations/number/AutoFontSizer.jsx", "diffHunk": "@@ -16,45 +16,51 @@ type Props = {\n };\n \n const _multiplierForElement = (element, targetWidth, targetHeight) => {\n+  const childSizeRatio = 0.8; // Propotion of the child size in relation to the container\n   const contentWidth = element.offsetWidth;\n   const contentHeight = element.offsetHeight;\n \n-  const widthMultiplier = (targetWidth * 0.8) / contentWidth;\n-  const heightMultiplier = (targetHeight * 0.8) / contentHeight;\n+  const widthMultiplier = (targetWidth * childSizeRatio) / contentWidth;\n+  const heightMultiplier = (targetHeight * childSizeRatio) / contentHeight;\n   return Math.min(widthMultiplier, heightMultiplier);\n };\n \n-const AutoFontSizer = ({ children, target, height, width }: Props) => {\n+const _updateFontSize = (setFontSize, currentSize, newSize) => {\n+  if (currentSize !== newSize && newSize !== 0 && Number.isFinite(newSize)) {\n+    setFontSize(newSize);\n+  }\n+};\n+\n+const useAutoFontSize = (target, _container, height, width) => {\n+  // This hook will update the font size based on the difference between the dimensions of the container and its child.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d621ab592c12832f57a79d608297404fb7b08d79"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8307f63253cb7af55d31ee9369a313020c3c0ba9", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/8307f63253cb7af55d31ee9369a313020c3c0ba9", "committedDate": "2020-06-09T12:36:00Z", "message": "Refactor AutoFontSizer code style\n\n* Move module constants tolerance and child size ratio to module scope\n* Create separate function to check if a font size is valid\n* Add JSDoc comment for the component\n* Fixing typo"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c626391a8c7da1a775900bb35c1708f5cdfafdf5", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/c626391a8c7da1a775900bb35c1708f5cdfafdf5", "committedDate": "2020-06-09T12:33:37Z", "message": " Refactor AutoFontSizer code style\n\n* Move module constants tolerance and child size ratio to module scope\n* Create seperate function to check if a font size is valid\n* Add JSDoc comment for the component\n* Fixing typo"}, "afterCommit": {"oid": "8307f63253cb7af55d31ee9369a313020c3c0ba9", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/8307f63253cb7af55d31ee9369a313020c3c0ba9", "committedDate": "2020-06-09T12:36:00Z", "message": "Refactor AutoFontSizer code style\n\n* Move module constants tolerance and child size ratio to module scope\n* Create separate function to check if a font size is valid\n* Add JSDoc comment for the component\n* Fixing typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9e3cabba30ccab88741bd49b9a7a7458cc8f5a1", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/c9e3cabba30ccab88741bd49b9a7a7458cc8f5a1", "committedDate": "2020-06-09T12:41:38Z", "message": "Update AutoFontSizer JSDoc comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MTIxMDU5", "url": "https://github.com/Graylog2/graylog2-server/pull/8291#pullrequestreview-427121059", "createdAt": "2020-06-09T13:03:49Z", "commit": {"oid": "c9e3cabba30ccab88741bd49b9a7a7458cc8f5a1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMzowMzo0OVrOGhIoxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMzowNjoyOFrOGhIyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM5NzcwMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * The calculation is based the difference between the dimensions of the container and its child.\n          \n          \n            \n             * The calculation is based on the ratio of the current dimensions of the child and the dimensions of its container.", "url": "https://github.com/Graylog2/graylog2-server/pull/8291#discussion_r437397700", "createdAt": "2020-06-09T13:03:49Z", "author": {"login": "dennisoelkers"}, "path": "graylog2-web-interface/src/views/components/visualizations/number/AutoFontSizer.jsx", "diffHunk": "@@ -2,6 +2,15 @@\n import React, { type Element, type ElementRef, useEffect, useRef, useState } from 'react';\n import styled, { type StyledComponent } from 'styled-components';\n \n+/**\n+ * This component will calculate the largest possible font size for the provided child.\n+ * The calculation is based the difference between the dimensions of the container and its child.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9e3cabba30ccab88741bd49b9a7a7458cc8f5a1"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQwMDExNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * The font size is being recalculated, until the mentioned difference is within the defined tolerance.\n          \n          \n            \n             * The font size is being multiplied by this ratio, unless it has a difference to 1 that is smaller than the defined tolerance.", "url": "https://github.com/Graylog2/graylog2-server/pull/8291#discussion_r437400116", "createdAt": "2020-06-09T13:06:28Z", "author": {"login": "dennisoelkers"}, "path": "graylog2-web-interface/src/views/components/visualizations/number/AutoFontSizer.jsx", "diffHunk": "@@ -2,6 +2,15 @@\n import React, { type Element, type ElementRef, useEffect, useRef, useState } from 'react';\n import styled, { type StyledComponent } from 'styled-components';\n \n+/**\n+ * This component will calculate the largest possible font size for the provided child.\n+ * The calculation is based the difference between the dimensions of the container and its child.\n+ * The font size is being recalculated, until the mentioned difference is within the defined tolerance.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9e3cabba30ccab88741bd49b9a7a7458cc8f5a1"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a42c245f87d21538b1c0ed9612c8e8ffaa3c564", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/8a42c245f87d21538b1c0ed9612c8e8ffaa3c564", "committedDate": "2020-06-09T14:35:35Z", "message": "Improve AutoFontSizer JSDoc comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MDE2NzM1", "url": "https://github.com/Graylog2/graylog2-server/pull/8291#pullrequestreview-428016735", "createdAt": "2020-06-10T12:48:59Z", "commit": {"oid": "8a42c245f87d21538b1c0ed9612c8e8ffaa3c564"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5Nzg5MTE3", "url": "https://github.com/Graylog2/graylog2-server/pull/8291#pullrequestreview-429789117", "createdAt": "2020-06-12T14:29:54Z", "commit": {"oid": "8a42c245f87d21538b1c0ed9612c8e8ffaa3c564"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3154, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}