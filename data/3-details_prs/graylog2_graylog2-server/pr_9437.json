{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5MDcxMzYw", "number": 9437, "title": "Prevent disabling your own user account", "bodyText": "Motivation\nPrior to this change, a logged in user was able to disable himself (if\nhe had the necessary permissions).\nDescription\nThis change will hide the menu item Enable/Disable for the user\nhimself.\nAlso\nAdd a confirmation dialog for disabling user which explains that\ndisabling a user also stops its current session.", "createdAt": "2020-11-11T09:32:11Z", "url": "https://github.com/Graylog2/graylog2-server/pull/9437", "merged": true, "mergeCommit": {"oid": "66a24b45d7bfbef97aaf43c70cbcee02e7450108"}, "closed": true, "closedAt": "2020-11-12T10:44:30Z", "author": {"login": "kmerz"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbai0MgH2gAyNTE5MDcxMzYwOmUxZjYyOTExYWIzYjU3NjlhMTlkNDg4ZTdlYjUwODEzYWI1MTRmNzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbwLt_AFqTUyODk1OTI0OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e1f62911ab3b5769a19d488e7eb50813ab514f74", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/e1f62911ab3b5769a19d488e7eb50813ab514f74", "committedDate": "2020-11-11T09:28:45Z", "message": "Prevent disabling your own user account\n\n## Motivation\nPrior to this change, a logged in user was able to disable himself (if\nhe had the necessary permissions).\n\n## Description\nThis change will hide the menu item `Enable`/`Disable` for the user\nhimself.\n\n## Also\nAdd a confirmation dialog for disabling user which explains that\ndisabling a user also stops its current session."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09f80bddf2a25eeb93e959902b53e7c8ef6c9732", "author": {"user": {"login": "bernd", "name": "Bernd Ahlers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/09f80bddf2a25eeb93e959902b53e7c8ef6c9732", "committedDate": "2020-11-11T09:58:33Z", "message": "Add backend code to prevent users from setting their own status"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4MDM1NDkx", "url": "https://github.com/Graylog2/graylog2-server/pull/9437#pullrequestreview-528035491", "createdAt": "2020-11-11T10:11:47Z", "commit": {"oid": "09f80bddf2a25eeb93e959902b53e7c8ef6c9732"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxMDoxMTo0N1rOHxGs7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxMDoxMTo0N1rOHxGs7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI1MjA3Nw==", "bodyText": "We have @Context UserContext userContext for this now.", "url": "https://github.com/Graylog2/graylog2-server/pull/9437#discussion_r521252077", "createdAt": "2020-11-11T10:11:47Z", "author": {"login": "mpfz0r"}, "path": "graylog2-server/src/main/java/org/graylog2/rest/resources/users/UsersResource.java", "diffHunk": "@@ -556,11 +557,17 @@ public void changePassword(\n     @ApiOperation(\"Update the account status for a user\")\n     @AuditEvent(type = AuditEventTypes.USER_UPDATE)\n     public Response updateAccountStatus(\n-            @ApiParam(name = \"userId\", value = \"The id of the user whose status to change.\", required = true) @PathParam(\"userId\") String userId,\n+            @ApiParam(name = \"userId\", value = \"The id of the user whose status to change.\", required = true)\n+            @PathParam(\"userId\") @NotBlank String userId,\n             @ApiParam(name = \"newStatus\", value = \"The account status to be set\", required = true,\n-                    defaultValue = \"enabled\", allowableValues = \"enabled,disabled,deleted\")\n+                      defaultValue = \"enabled\", allowableValues = \"enabled,disabled,deleted\")\n             @PathParam(\"newStatus\") @NotBlank String newStatusString) throws ValidationException {\n \n+        final User currentUser = requireNonNull(getCurrentUser(), \"currentUser cannot be null\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09f80bddf2a25eeb93e959902b53e7c8ef6c9732"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42db1c9085452ddc77753212a63b2522dbfb72d4", "author": {"user": {"login": "bernd", "name": "Bernd Ahlers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/42db1c9085452ddc77753212a63b2522dbfb72d4", "committedDate": "2020-11-11T10:15:14Z", "message": "Use UserContext instead of getCurrentUser()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4MTE1OTY4", "url": "https://github.com/Graylog2/graylog2-server/pull/9437#pullrequestreview-528115968", "createdAt": "2020-11-11T12:10:37Z", "commit": {"oid": "42db1c9085452ddc77753212a63b2522dbfb72d4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxMjoxMDozN1rOHxKgaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxMjoxMDozN1rOHxKgaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMxNDQwOA==", "bodyText": "When disabling a user and closing the confirm dialog, UsersDomain.setStatus(id, 'enabled'); is being called and the API responds with Error: Not Modified", "url": "https://github.com/Graylog2/graylog2-server/pull/9437#discussion_r521314408", "createdAt": "2020-11-11T12:10:37Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/components/users/UsersOverview/UserOverviewItem/ActionsCell.jsx", "diffHunk": "@@ -50,9 +52,17 @@ const ReadOnlyActions = ({ user }: { user: UserOverview }) => {\n };\n \n const EditActions = ({ user, user: { username, id, fullName, accountStatus, external, readOnly } }: { user: UserOverview }) => {\n+  const currentUser = useContext(CurrentUserContext) || {};\n+\n   const _toggleStatus = () => {\n-    const newStatus = accountStatus === 'enabled' ? 'disabled' : 'enabled';\n-    UsersDomain.setStatus(id, newStatus);\n+    // eslint-disable-next-line no-alert\n+    if (accountStatus === 'enabled' && window.confirm(`Do you really want to disable user ${fullName}? All current sessions will be terminated.`)) {\n+      UsersDomain.setStatus(id, 'disabled');\n+\n+      return;\n+    }\n+\n+    UsersDomain.setStatus(id, 'enabled');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42db1c9085452ddc77753212a63b2522dbfb72d4"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f261df3d36da612454341abb9cbd02b3f4802b00", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/f261df3d36da612454341abb9cbd02b3f4802b00", "committedDate": "2020-11-11T15:05:22Z", "message": "Break out of the funtion if confirmation was not given"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4MzI1NjQ4", "url": "https://github.com/Graylog2/graylog2-server/pull/9437#pullrequestreview-528325648", "createdAt": "2020-11-11T16:21:43Z", "commit": {"oid": "f261df3d36da612454341abb9cbd02b3f4802b00"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4OTU5MjQ5", "url": "https://github.com/Graylog2/graylog2-server/pull/9437#pullrequestreview-528959249", "createdAt": "2020-11-12T10:41:26Z", "commit": {"oid": "f261df3d36da612454341abb9cbd02b3f4802b00"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3413, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}