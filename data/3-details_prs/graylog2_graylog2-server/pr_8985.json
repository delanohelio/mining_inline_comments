{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4NTEzODY5", "number": 8985, "title": "Submit widget query form before saving edit widget modal.", "bodyText": "Description\n\nMotivation and Context\n\n\nBefore this change, a successful change to the timerange/stream selection/query of a widget on a dashboard required submitting the widget's search after the change and before clicking \"Save\". This was unintuitive and unnecessarily complicated.\nThis change is now submitting the widget's query form when the user clicks \"Save\" and the form is dirty, not requiring the user to have submitted the form manually before.\nFixes #7922.\nHow Has This Been Tested?\n\n\n\nScreenshots (if appropriate):\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Refactoring (non-breaking change)\n Breaking change (fix or feature that would cause existing functionality to change)\n\nChecklist:\n\n\n\n My code follows the code style of this project.\n My change requires a change to the documentation.\n I have updated the documentation accordingly.\n I have read the CONTRIBUTING document.\n I have added tests to cover my changes.", "createdAt": "2020-09-17T08:56:38Z", "url": "https://github.com/Graylog2/graylog2-server/pull/8985", "merged": true, "mergeCommit": {"oid": "7b7925c75019c64c304baa0fb7117e7cb6f08c83"}, "closed": true, "closedAt": "2020-09-25T12:21:35Z", "author": {"login": "dennisoelkers"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLZQSQgFqTQ5MzUwMzg3NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMU18egFqTQ5NjM2ODY1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNTAzODc1", "url": "https://github.com/Graylog2/graylog2-server/pull/8985#pullrequestreview-493503875", "createdAt": "2020-09-22T14:12:09Z", "commit": {"oid": "8392ba543e1388023177e4e2ff6ea5b65f6f64b6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNDoxMjoxMFrOHV8ISA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNDo0NjowNVrOHV9z_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc2NzMwNA==", "bodyText": "widget={widget} can be removed", "url": "https://github.com/Graylog2/graylog2-server/pull/8985#discussion_r492767304", "createdAt": "2020-09-22T14:12:10Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/views/components/widgets/EditWidgetFrame.jsx", "diffHunk": "@@ -40,51 +44,69 @@ type Props = {\n   children: Array<React.Node>,\n };\n \n-export default class EditWidgetFrame extends React.Component<Props> {\n-  static propTypes = {\n-    children: PropTypes.node.isRequired,\n-  };\n+const onSubmit = (values, widget: Widget) => {\n+  const { timerange, streams, queryString } = values;\n+  const newWidget = widget.toBuilder()\n+    .timerange(timerange)\n+    .query(createElasticsearchQueryString(queryString))\n+    .streams(streams)\n+    .build();\n+\n+  return WidgetActions.update(widget.id, newWidget);\n+};\n \n-  // eslint-disable-next-line camelcase\n-  UNSAFE_componentWillMount() {\n+const EditWidgetFrame = ({ children }: Props) => {\n+  useEffect(() => {\n     globalStyles.use();\n-  }\n \n-  componentWillUnmount() {\n-    globalStyles.unuse();\n-  }\n+    return globalStyles.unuse;\n+  }, []);\n+\n+  const widget = useContext(WidgetContext);\n \n-  render() {\n-    const { children } = this.props;\n-\n-    return (\n-      <Modal show\n-             animation={false}\n-             dialogComponentClass={EditWidgetDialog}\n-             enforceFocus={false}>\n-        <IfDashboard>\n-          <Modal.Header className={styles.QueryControls}>\n-            <QueryEditModeContext.Provider value=\"widget\">\n-              <HeaderElements />\n-              <WidgetContext.Consumer>\n-                {(widget) => (\n-                  <WidgetQueryControls widget={widget} />\n-                )}\n-              </WidgetContext.Consumer>\n-            </QueryEditModeContext.Provider>\n-          </Modal.Header>\n-        </IfDashboard>\n-        <Modal.Body className={styles.Visualization}>\n-          <div role=\"presentation\" style={{ height: '100%' }}>\n-            <WidgetOverrideElements>\n-              {children[0]}\n-            </WidgetOverrideElements>\n-          </div>\n-        </Modal.Body>\n-        <Modal.Footer className={styles.Footer}>\n-          {children[1]}\n-        </Modal.Footer>\n-      </Modal>\n-    );\n+  if (!widget) {\n+    return <Spinner text=\"Loading widget ...\" />;\n   }\n-}\n+\n+  const { streams } = widget;\n+  const timerange = widget.timerange ?? DEFAULT_TIMERANGE;\n+  const { query_string: queryString } = widget.query ?? createElasticsearchQueryString('');\n+  const _onSubmit = useCallback((values) => onSubmit(values, widget), [widget]);\n+\n+  return (\n+    <Modal show\n+           animation={false}\n+           dialogComponentClass={EditWidgetDialog}\n+           enforceFocus={false}>\n+      <SearchBarForm initialValues={{ timerange, streams, queryString }}\n+                     onSubmit={_onSubmit}>\n+        <div className={styles.gridContainer}>\n+          <IfDashboard>\n+            <Modal.Header className={styles.QueryControls}>\n+              <QueryEditModeContext.Provider value=\"widget\">\n+                <HeaderElements />\n+                <WidgetQueryControls widget={widget} />", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8392ba543e1388023177e4e2ff6ea5b65f6f64b6"}, "originalPosition": 126}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc2OTA0MA==", "bodyText": "The widget prop can also be removed in WidgetQueryControls.test.jsx", "url": "https://github.com/Graylog2/graylog2-server/pull/8985#discussion_r492769040", "createdAt": "2020-09-22T14:14:23Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/views/components/WidgetQueryControls.jsx", "diffHunk": "@@ -11,29 +10,22 @@ import DocumentationLink from 'components/support/DocumentationLink';\n import DocsHelper from 'util/DocsHelper';\n import Button from 'components/graylog/Button';\n import TopRow from 'views/components/searchbar/TopRow';\n-import Widget from 'views/logic/widgets/Widget';\n import { StreamsStore } from 'views/stores/StreamsStore';\n import { SearchConfigStore } from 'views/stores/SearchConfigStore';\n-import { WidgetActions } from 'views/stores/WidgetStore';\n import { GlobalOverrideActions, GlobalOverrideStore } from 'views/stores/GlobalOverrideStore';\n import GlobalOverride from 'views/logic/search/GlobalOverride';\n import SearchActions from 'views/actions/SearchActions';\n-import { createElasticsearchQueryString } from 'views/logic/queries/Query';\n \n import TimeRangeTypeSelector from './searchbar/TimeRangeTypeSelector';\n import TimeRangeInput from './searchbar/TimeRangeInput';\n import StreamsFilter from './searchbar/StreamsFilter';\n import SearchButton from './searchbar/SearchButton';\n import QueryInput from './searchbar/AsyncQueryInput';\n-import SearchBarForm from './searchbar/SearchBarForm';\n-\n-import { DEFAULT_TIMERANGE } from '../Constants';\n \n type Props = {\n   availableStreams: Array<any>,\n   config: any,\n   globalOverride: ?GlobalOverride,\n-  widget: Widget,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8392ba543e1388023177e4e2ff6ea5b65f6f64b6"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc4MDEzOQ==", "bodyText": "The current implementation does not work as expected (the behaviour on save did not changed), looks the reason is that dirty is missing in this array.", "url": "https://github.com/Graylog2/graylog2-server/pull/8985#discussion_r492780139", "createdAt": "2020-09-22T14:28:07Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/views/components/widgets/SaveOrCancelButtons.jsx", "diffHunk": "@@ -8,11 +10,22 @@ type Props = {\n   onFinish: () => void,\n };\n \n-const SaveOrCancelButtons = ({ onFinish, onCancel }: Props) => (\n-  <>\n-    <Button onClick={onFinish} bsStyle=\"primary\">Save</Button>\n-    <Button onClick={onCancel}>Cancel</Button>\n-  </>\n-);\n+const SaveOrCancelButtons = ({ onFinish, onCancel }: Props) => {\n+  const { handleSubmit, dirty } = useFormikContext();\n+  const _onFinish = useCallback((...args) => {\n+    if (handleSubmit && dirty) {\n+      handleSubmit();\n+    }\n+\n+    return onFinish(...args);\n+  }, [onFinish, handleSubmit]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8392ba543e1388023177e4e2ff6ea5b65f6f64b6"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc5NDg3Nw==", "bodyText": "You can use DEFAULT_TIMERANGE from views/Contsants here.", "url": "https://github.com/Graylog2/graylog2-server/pull/8985#discussion_r492794877", "createdAt": "2020-09-22T14:46:05Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/views/components/WidgetQueryControls.test.jsx", "diffHunk": "@@ -58,11 +56,19 @@ describe('WidgetQueryControls', () => {\n   const emptyGlobalOverride = {};\n   const globalOverrideWithQuery = { query: { type: 'elasticsearch', query_string: 'source:foo' } };\n \n-  const renderSUT = (props = {}) => render(\n+  const Wrapper = ({ children }: { children: React.Node }) => (\n     <WrappingContainer>\n+      <SearchBarForm initialValues={{ timerange: { type: 'relative', range: 300 }, queryString: '', streams: [] }} onSubmit={() => {}}>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8392ba543e1388023177e4e2ff6ea5b65f6f64b6"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edd52ce7bdcbda37b2e755a6e8f5e2ffb18f64ef", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/edd52ce7bdcbda37b2e755a6e8f5e2ffb18f64ef", "committedDate": "2020-09-25T08:53:41Z", "message": "Submit widget query form before saving edit widget modal.\n\nBefore this change, a successful change to the timerange/stream\nselection/query of a widget on a dashboard required submitting the\nwidget's search after the change and before clicking \"Save\". This was\nunintuitive and unnecessarily complicated.\n\nThis change is now submitting the widget's query form when the user\nclicks \"Save\" and the form is dirty, not requiring the user to have\nsubmitted the form manually before.\n\nFixes #7922."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fdead44cb94dea33f4a65b30cf223cd7ca7ab54", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/4fdead44cb94dea33f4a65b30cf223cd7ca7ab54", "committedDate": "2020-09-25T08:53:42Z", "message": "Submit only if dirty."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2b91f421c292094e9b962931b24d70600ac005c", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/e2b91f421c292094e9b962931b24d70600ac005c", "committedDate": "2020-09-25T08:53:42Z", "message": "Removing unnecessary form element around events checkbox."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d14bc5b431608e52a82ebf050e008d60a1c7a764", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/d14bc5b431608e52a82ebf050e008d60a1c7a764", "committedDate": "2020-09-25T08:53:42Z", "message": "Updating snapshots."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "941759783a36571d492846280844c2734442539b", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/941759783a36571d492846280844c2734442539b", "committedDate": "2020-09-25T08:55:54Z", "message": "Removing usages of `widget` prop for `WidgetQueryControls`."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ea29606a1ec1fc997638de1acd4717cfbf49600", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/4ea29606a1ec1fc997638de1acd4717cfbf49600", "committedDate": "2020-09-25T09:00:45Z", "message": "Reusing `DEFAULT_TIMERANGE`."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e31f90e7f7d8bf0495c3ab1c978e2f03d0e8e49", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/7e31f90e7f7d8bf0495c3ab1c978e2f03d0e8e49", "committedDate": "2020-09-25T09:06:02Z", "message": "Include `dirty` in `useCallback` dependencies."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8392ba543e1388023177e4e2ff6ea5b65f6f64b6", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/8392ba543e1388023177e4e2ff6ea5b65f6f64b6", "committedDate": "2020-09-21T08:03:41Z", "message": "Updating snapshots."}, "afterCommit": {"oid": "7e31f90e7f7d8bf0495c3ab1c978e2f03d0e8e49", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/7e31f90e7f7d8bf0495c3ab1c978e2f03d0e8e49", "committedDate": "2020-09-25T09:06:02Z", "message": "Include `dirty` in `useCallback` dependencies."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2MzY4NjU4", "url": "https://github.com/Graylog2/graylog2-server/pull/8985#pullrequestreview-496368658", "createdAt": "2020-09-25T12:21:21Z", "commit": {"oid": "7e31f90e7f7d8bf0495c3ab1c978e2f03d0e8e49"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3543, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}