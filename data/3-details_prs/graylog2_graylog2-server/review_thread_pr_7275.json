{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2ODc2Mjc4", "number": 7275, "reviewThreads": {"totalCount": 32, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxNDoyODo1MFrODgaLVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNDoxNzoyOVrODmsr6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1MzA5OTEwOnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/configurations/URLWhitelistFormModal.jsx", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxNDoyODo1MFrOFqmVxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxNToxOTo0M1rOFqoClg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIxMjY3Nw==", "bodyText": "Should we use createRef here?", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r380212677", "createdAt": "2020-02-17T14:28:50Z", "author": {"login": "kyleknighted"}, "path": "graylog2-web-interface/src/components/configurations/URLWhitelistFormModal.jsx", "diffHunk": "@@ -0,0 +1,157 @@\n+// @flow\n+import React from 'react';\n+import PropTypes from 'prop-types';\n+import uuid from 'uuid/v4';\n+import connect from 'stores/connect';\n+import { IfPermitted } from 'components/common';\n+import { Button } from 'components/graylog';\n+import BootstrapModalForm from 'components/bootstrap/BootstrapModalForm';\n+import UrlWhiteListForm from 'components/configurations/UrlWhiteListForm';\n+import CombinedProvider from 'injection/CombinedProvider';\n+import PermissionsMixin from 'util/PermissionsMixin';\n+import type { WhiteListConfig } from 'stores/configurations/ConfigurationsStore';\n+\n+const { CurrentUserStore } = CombinedProvider.get('CurrentUser');\n+const { ConfigurationsActions, ConfigurationsStore } = CombinedProvider.get('Configurations');\n+\n+const URL_WHITELIST_CONFIG = 'org.graylog2.system.urlwhitelist.UrlWhitelist';\n+\n+type State = {\n+  config: WhiteListConfig,\n+  isValid: boolean\n+};\n+\n+type Props = {\n+  newUrlEntry: string,\n+  onUpdate: () => void,\n+  configuration: {},\n+  currentUser: {permissions: Array<string>},\n+  formType: string,\n+};\n+\n+\n+class URLWhitelistFormModal extends React.Component<Props, State> {\n+    configModal: ?BootstrapModalForm;\n+\n+    inputs = {};\n+\n+    static defaultProps = {\n+      newUrlEntry: '',\n+      onUpdate: () => {},\n+      configuration: {},\n+      formType: '',\n+    }\n+\n+    constructor(props) {\n+      super(props);\n+      this.state = {\n+        config: { entries: [], disabled: false },\n+        isValid: false,\n+      };\n+    }\n+\n+    componentDidMount() {\n+      const { currentUser: { permissions } } = this.props;\n+      if (PermissionsMixin.isPermitted(permissions, ['urlwhitelist:read'])) {\n+        ConfigurationsActions.listWhiteListConfig(URL_WHITELIST_CONFIG);\n+      }\n+    }\n+\n+\n+  _getConfig = (configType: string) => {\n+    const { configuration } = this.props;\n+    if (configuration && configuration[configType]) {\n+      return configuration[configType];\n+    }\n+    return null;\n+  }\n+\n+  _openModal = () => {\n+    if (this.configModal) {\n+      this.configModal.open();\n+    }\n+  }\n+\n+  _closeModal = () => {\n+    if (this.configModal) {\n+      this.configModal.close();\n+    }\n+  }\n+\n+  _saveConfig = (event) => {\n+    if (event) {\n+      event.preventDefault();\n+      event.stopPropagation();\n+    }\n+    const { onUpdate } = this.props;\n+    const { config, isValid } = this.state;\n+    if (isValid) {\n+      this._updateConfig(URL_WHITELIST_CONFIG, config).then(() => {\n+        onUpdate();\n+        this._closeModal();\n+      });\n+    }\n+  }\n+\n+  _update = (config, isValid) => {\n+    const updatedState = { config, isValid };\n+    this.setState(updatedState);\n+  }\n+\n+\n+  _resetConfig = () => {\n+\n+  }\n+\n+  _updateConfig = (configType, config) => {\n+    switch (configType) {\n+      case URL_WHITELIST_CONFIG:\n+        return ConfigurationsActions.updateWhitelist(configType, config);\n+      default:\n+        return ConfigurationsActions.update(configType, config);\n+    }\n+  };\n+\n+\n+  render() {\n+    const urlwhitelistConfig = this._getConfig(URL_WHITELIST_CONFIG);\n+    if (urlwhitelistConfig) {\n+      const { newUrlEntry, formType } = this.props;\n+      const initialConfig = { entries: [...urlwhitelistConfig.entries, { id: uuid(), title: '', value: newUrlEntry, type: formType || 'literal' }], disabled: urlwhitelistConfig.disabled };\n+      const { entries, disabled } = initialConfig;\n+      const { isValid } = this.state;\n+      return (\n+        <>\n+          <IfPermitted permissions=\"urlwhitelist:write\">\n+            <Button bsStyle=\"info\" bsSize=\"xs\" onClick={this._openModal}>Add to URL Whitelist</Button>\n+          </IfPermitted>\n+          <BootstrapModalForm ref={(configModal) => { this.configModal = configModal; }}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67ff2ecb909b6937cab45897d4c167f41feddcdb"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI0MDUzNA==", "bodyText": "I agree with that. will change that.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r380240534", "createdAt": "2020-02-17T15:19:43Z", "author": {"login": "ousmaneo"}, "path": "graylog2-web-interface/src/components/configurations/URLWhitelistFormModal.jsx", "diffHunk": "@@ -0,0 +1,157 @@\n+// @flow\n+import React from 'react';\n+import PropTypes from 'prop-types';\n+import uuid from 'uuid/v4';\n+import connect from 'stores/connect';\n+import { IfPermitted } from 'components/common';\n+import { Button } from 'components/graylog';\n+import BootstrapModalForm from 'components/bootstrap/BootstrapModalForm';\n+import UrlWhiteListForm from 'components/configurations/UrlWhiteListForm';\n+import CombinedProvider from 'injection/CombinedProvider';\n+import PermissionsMixin from 'util/PermissionsMixin';\n+import type { WhiteListConfig } from 'stores/configurations/ConfigurationsStore';\n+\n+const { CurrentUserStore } = CombinedProvider.get('CurrentUser');\n+const { ConfigurationsActions, ConfigurationsStore } = CombinedProvider.get('Configurations');\n+\n+const URL_WHITELIST_CONFIG = 'org.graylog2.system.urlwhitelist.UrlWhitelist';\n+\n+type State = {\n+  config: WhiteListConfig,\n+  isValid: boolean\n+};\n+\n+type Props = {\n+  newUrlEntry: string,\n+  onUpdate: () => void,\n+  configuration: {},\n+  currentUser: {permissions: Array<string>},\n+  formType: string,\n+};\n+\n+\n+class URLWhitelistFormModal extends React.Component<Props, State> {\n+    configModal: ?BootstrapModalForm;\n+\n+    inputs = {};\n+\n+    static defaultProps = {\n+      newUrlEntry: '',\n+      onUpdate: () => {},\n+      configuration: {},\n+      formType: '',\n+    }\n+\n+    constructor(props) {\n+      super(props);\n+      this.state = {\n+        config: { entries: [], disabled: false },\n+        isValid: false,\n+      };\n+    }\n+\n+    componentDidMount() {\n+      const { currentUser: { permissions } } = this.props;\n+      if (PermissionsMixin.isPermitted(permissions, ['urlwhitelist:read'])) {\n+        ConfigurationsActions.listWhiteListConfig(URL_WHITELIST_CONFIG);\n+      }\n+    }\n+\n+\n+  _getConfig = (configType: string) => {\n+    const { configuration } = this.props;\n+    if (configuration && configuration[configType]) {\n+      return configuration[configType];\n+    }\n+    return null;\n+  }\n+\n+  _openModal = () => {\n+    if (this.configModal) {\n+      this.configModal.open();\n+    }\n+  }\n+\n+  _closeModal = () => {\n+    if (this.configModal) {\n+      this.configModal.close();\n+    }\n+  }\n+\n+  _saveConfig = (event) => {\n+    if (event) {\n+      event.preventDefault();\n+      event.stopPropagation();\n+    }\n+    const { onUpdate } = this.props;\n+    const { config, isValid } = this.state;\n+    if (isValid) {\n+      this._updateConfig(URL_WHITELIST_CONFIG, config).then(() => {\n+        onUpdate();\n+        this._closeModal();\n+      });\n+    }\n+  }\n+\n+  _update = (config, isValid) => {\n+    const updatedState = { config, isValid };\n+    this.setState(updatedState);\n+  }\n+\n+\n+  _resetConfig = () => {\n+\n+  }\n+\n+  _updateConfig = (configType, config) => {\n+    switch (configType) {\n+      case URL_WHITELIST_CONFIG:\n+        return ConfigurationsActions.updateWhitelist(configType, config);\n+      default:\n+        return ConfigurationsActions.update(configType, config);\n+    }\n+  };\n+\n+\n+  render() {\n+    const urlwhitelistConfig = this._getConfig(URL_WHITELIST_CONFIG);\n+    if (urlwhitelistConfig) {\n+      const { newUrlEntry, formType } = this.props;\n+      const initialConfig = { entries: [...urlwhitelistConfig.entries, { id: uuid(), title: '', value: newUrlEntry, type: formType || 'literal' }], disabled: urlwhitelistConfig.disabled };\n+      const { entries, disabled } = initialConfig;\n+      const { isValid } = this.state;\n+      return (\n+        <>\n+          <IfPermitted permissions=\"urlwhitelist:write\">\n+            <Button bsStyle=\"info\" bsSize=\"xs\" onClick={this._openModal}>Add to URL Whitelist</Button>\n+          </IfPermitted>\n+          <BootstrapModalForm ref={(configModal) => { this.configModal = configModal; }}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIxMjY3Nw=="}, "originalCommit": {"oid": "67ff2ecb909b6937cab45897d4c167f41feddcdb"}, "originalPosition": 128}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1MzEyNDkzOnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/event-notifications/event-notification-types/HttpNotificationForm.jsx", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxNDozNjowN1rOFqmk8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxNToxOTo1M1rOFqoC5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIxNjU2MQ==", "bodyText": "Appears to be a floating semicolon", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r380216561", "createdAt": "2020-02-17T14:36:07Z", "author": {"login": "kyleknighted"}, "path": "graylog2-web-interface/src/components/event-notifications/event-notification-types/HttpNotificationForm.jsx", "diffHunk": "@@ -12,9 +11,7 @@ class HttpNotificationForm extends React.Component {\n     onChange: PropTypes.func.isRequired,\n   };\n \n-  static defaultConfig = {\n-    url: '',\n-  };\n+  ;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67ff2ecb909b6937cab45897d4c167f41feddcdb"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI0MDYxMg==", "bodyText": "fixed", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r380240612", "createdAt": "2020-02-17T15:19:53Z", "author": {"login": "ousmaneo"}, "path": "graylog2-web-interface/src/components/event-notifications/event-notification-types/HttpNotificationForm.jsx", "diffHunk": "@@ -12,9 +11,7 @@ class HttpNotificationForm extends React.Component {\n     onChange: PropTypes.func.isRequired,\n   };\n \n-  static defaultConfig = {\n-    url: '',\n-  };\n+  ;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIxNjU2MQ=="}, "originalCommit": {"oid": "67ff2ecb909b6937cab45897d4c167f41feddcdb"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NjYwOTA2OnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/util/URLUtils.js", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNTozOTo1M1rOFrHU-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMDoxNDoxNFrOFsNkKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc1MzE0Ng==", "bodyText": "Since we don't use the result of new URL(), I guess we can remove the const.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r380753146", "createdAt": "2020-02-18T15:39:53Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/util/URLUtils.js", "diffHunk": "@@ -41,17 +41,29 @@ const URLUtils = {\n   },\n   concatURLPath(...allArgs) {\n     const args = Array(allArgs.length);\n+    // eslint-disable-next-line no-plusplus\n     for (let i = 0; i < allArgs.length; i++) {\n       args[i] = allArgs[i];\n     }\n \n     const joinedPath = `/${args.join('/')}`;\n+    // eslint-disable-next-line no-useless-escape\n     return joinedPath.replace(/[\\/]+/g, '/');\n   },\n   areCredentialsInURLSupported() {\n     const browser = this.parser.getBrowser();\n     return browser.name !== 'IE' && browser.name !== 'Edge';\n   },\n-};\n+  isValidURL(str) {\n+    let isValid = true;\n+    try {\n+      // eslint-disable-next-line no-unused-vars\n+      const test = new URL(str);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "707ed48ac346c0d6d5e085dffa30c9f2f5e5e00f"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTkwMzkxMg==", "bodyText": "ok", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r381903912", "createdAt": "2020-02-20T10:14:14Z", "author": {"login": "ousmaneo"}, "path": "graylog2-web-interface/src/util/URLUtils.js", "diffHunk": "@@ -41,17 +41,29 @@ const URLUtils = {\n   },\n   concatURLPath(...allArgs) {\n     const args = Array(allArgs.length);\n+    // eslint-disable-next-line no-plusplus\n     for (let i = 0; i < allArgs.length; i++) {\n       args[i] = allArgs[i];\n     }\n \n     const joinedPath = `/${args.join('/')}`;\n+    // eslint-disable-next-line no-useless-escape\n     return joinedPath.replace(/[\\/]+/g, '/');\n   },\n   areCredentialsInURLSupported() {\n     const browser = this.parser.getBrowser();\n     return browser.name !== 'IE' && browser.name !== 'Edge';\n   },\n-};\n+  isValidURL(str) {\n+    let isValid = true;\n+    try {\n+      // eslint-disable-next-line no-unused-vars\n+      const test = new URL(str);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc1MzE0Ng=="}, "originalCommit": {"oid": "707ed48ac346c0d6d5e085dffa30c9f2f5e5e00f"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NjYyNTE5OnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/routing/ApiRoutes.js", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNTo0MzozN1rOFrHe9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNTo0MzozN1rOFrHe9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc1NTcwMw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                UrlWhitelistCheck: () => { return { url: '/system/urlwhitelist/check' }; },\n          \n          \n            \n                urlWhitelistCheck: () => { return { url: '/system/urlwhitelist/check' }; },", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r380755703", "createdAt": "2020-02-18T15:43:37Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/routing/ApiRoutes.js", "diffHunk": "@@ -227,6 +227,8 @@ const ApiRoutes = {\n     substringTest: () => { return { url: '/tools/substring_tester' }; },\n     containsStringTest: () => { return { url: '/tools/contains_string_tester' }; },\n     lookupTableTest: () => { return { url: '/tools/lookup_table_tester' }; },\n+    UrlWhitelistCheck: () => { return { url: '/system/urlwhitelist/check' }; },", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "707ed48ac346c0d6d5e085dffa30c9f2f5e5e00f"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NjY0Mzc3OnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/configurations/URLWhitelistInput.jsx", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNTo0Nzo0MVrOFrHqjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNTo0Nzo0MVrOFrHqjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc1ODY3MQ==", "bodyText": "We should use flow strict in the header\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            // @flow\n          \n          \n            \n            // @flow strict", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r380758671", "createdAt": "2020-02-18T15:47:41Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/configurations/URLWhitelistInput.jsx", "diffHunk": "@@ -0,0 +1,122 @@\n+// @flow", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "707ed48ac346c0d6d5e085dffa30c9f2f5e5e00f"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NjY0NDgzOnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/configurations/URLWhitelistFormModal.jsx", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNTo0Nzo1NFrOFrHrLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNTo0Nzo1NFrOFrHrLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc1ODgyOQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            // @flow\n          \n          \n            \n            // @flow strict", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r380758829", "createdAt": "2020-02-18T15:47:54Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/configurations/URLWhitelistFormModal.jsx", "diffHunk": "@@ -0,0 +1,158 @@\n+// @flow", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "707ed48ac346c0d6d5e085dffa30c9f2f5e5e00f"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1Njc1MDE1OnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/configurations/URLWhitelistInput.jsx", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNjoxMToyNlrOFrIrHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwODoyMzo0OFrOFsJ8PA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc3NTE5Ng==", "bodyText": "As far as I can see this method is not needed, we could use handleFormEvent directly.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r380775196", "createdAt": "2020-02-18T16:11:26Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/configurations/URLWhitelistInput.jsx", "diffHunk": "@@ -0,0 +1,122 @@\n+// @flow\n+import React, { useRef, useState, useEffect } from 'react';\n+import PropTypes from 'prop-types';\n+import { Input } from 'components/bootstrap';\n+import URLWhitelistFormModal from 'components/configurations/URLWhitelistFormModal';\n+import StoreProvider from 'injection/StoreProvider';\n+import URLUtils from 'util/URLUtils';\n+import UIUtils from 'util/UIUtils';\n+\n+const ToolsStore = StoreProvider.getStore('Tools');\n+type Props = {\n+  label: string,\n+  handleFormEvent: (event: SyntheticInputEvent<EventTarget>) => void,\n+  validationMessage: string,\n+  validationState: string,\n+  url: string,\n+  labelClassName: string,\n+  wrapperClassName: string,\n+  formType: string\n+}\n+const URLWhitelistInput = ({ label, handleFormEvent, validationMessage, validationState, url, labelClassName, wrapperClassName, formType }: Props) => {\n+  const [isWhitelisted, setIsWhitelisted] = useState(false);\n+  const [currentValidationState, setCurrentValidationState] = useState(validationState);\n+  const [ownValidationMessage, setOwnValidationMessage] = useState(validationMessage);\n+\n+  const suggestRegexWhitelistUrl = (typedUrl: string, type: string): string | Promise<any> => {\n+    // eslint-disable-next-line no-template-curly-in-string\n+    const keyWildcard = '${key}';\n+    return type && type === 'regex' && URLUtils.isValidURL(typedUrl) ? ToolsStore.urlWhiteListGenerateRegex(typedUrl, keyWildcard) : typedUrl;\n+  };\n+\n+  const [suggestedUrl, setSuggestedUrl] = useState(url);\n+  const isError = () => currentValidationState === 'error';\n+  const ref = useRef();\n+\n+  const handleCheckIsWhitelisted = () => {\n+    const promise = ToolsStore.urlWhiteListCheck(url);\n+    promise.then((result) => {\n+      if (!result.is_whitelisted && validationState === null) {\n+        setCurrentValidationState('error');\n+        setOwnValidationMessage(`URL ${suggestedUrl} is not whitelisted or not valid URL.`);\n+      } else {\n+        setOwnValidationMessage(validationMessage);\n+        setCurrentValidationState(validationState);\n+      }\n+      setIsWhitelisted(result.is_whitelisted);\n+    });\n+  };\n+\n+  const checkIsWhitelisted = () => {\n+    if (url) {\n+      const suggestion = suggestRegexWhitelistUrl(url, formType);\n+      if (typeof suggestion === 'object') {\n+        suggestion.then((result) => {\n+          setSuggestedUrl(result.regex);\n+          handleCheckIsWhitelisted();\n+        });\n+      } else {\n+        setSuggestedUrl(url);\n+        handleCheckIsWhitelisted();\n+      }\n+    }\n+  };\n+\n+\n+  const onUpdate = () => {\n+    UIUtils.triggerInput(ref.current);\n+    checkIsWhitelisted();\n+  };\n+\n+  const handleChange = (event: SyntheticInputEvent<EventTarget>) => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "707ed48ac346c0d6d5e085dffa30c9f2f5e5e00f"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg0NDU0MA==", "bodyText": "Agree, this is some code from the previous version where I was doing another thing in the handleChange. Fixed!", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r381844540", "createdAt": "2020-02-20T08:23:48Z", "author": {"login": "ousmaneo"}, "path": "graylog2-web-interface/src/components/configurations/URLWhitelistInput.jsx", "diffHunk": "@@ -0,0 +1,122 @@\n+// @flow\n+import React, { useRef, useState, useEffect } from 'react';\n+import PropTypes from 'prop-types';\n+import { Input } from 'components/bootstrap';\n+import URLWhitelistFormModal from 'components/configurations/URLWhitelistFormModal';\n+import StoreProvider from 'injection/StoreProvider';\n+import URLUtils from 'util/URLUtils';\n+import UIUtils from 'util/UIUtils';\n+\n+const ToolsStore = StoreProvider.getStore('Tools');\n+type Props = {\n+  label: string,\n+  handleFormEvent: (event: SyntheticInputEvent<EventTarget>) => void,\n+  validationMessage: string,\n+  validationState: string,\n+  url: string,\n+  labelClassName: string,\n+  wrapperClassName: string,\n+  formType: string\n+}\n+const URLWhitelistInput = ({ label, handleFormEvent, validationMessage, validationState, url, labelClassName, wrapperClassName, formType }: Props) => {\n+  const [isWhitelisted, setIsWhitelisted] = useState(false);\n+  const [currentValidationState, setCurrentValidationState] = useState(validationState);\n+  const [ownValidationMessage, setOwnValidationMessage] = useState(validationMessage);\n+\n+  const suggestRegexWhitelistUrl = (typedUrl: string, type: string): string | Promise<any> => {\n+    // eslint-disable-next-line no-template-curly-in-string\n+    const keyWildcard = '${key}';\n+    return type && type === 'regex' && URLUtils.isValidURL(typedUrl) ? ToolsStore.urlWhiteListGenerateRegex(typedUrl, keyWildcard) : typedUrl;\n+  };\n+\n+  const [suggestedUrl, setSuggestedUrl] = useState(url);\n+  const isError = () => currentValidationState === 'error';\n+  const ref = useRef();\n+\n+  const handleCheckIsWhitelisted = () => {\n+    const promise = ToolsStore.urlWhiteListCheck(url);\n+    promise.then((result) => {\n+      if (!result.is_whitelisted && validationState === null) {\n+        setCurrentValidationState('error');\n+        setOwnValidationMessage(`URL ${suggestedUrl} is not whitelisted or not valid URL.`);\n+      } else {\n+        setOwnValidationMessage(validationMessage);\n+        setCurrentValidationState(validationState);\n+      }\n+      setIsWhitelisted(result.is_whitelisted);\n+    });\n+  };\n+\n+  const checkIsWhitelisted = () => {\n+    if (url) {\n+      const suggestion = suggestRegexWhitelistUrl(url, formType);\n+      if (typeof suggestion === 'object') {\n+        suggestion.then((result) => {\n+          setSuggestedUrl(result.regex);\n+          handleCheckIsWhitelisted();\n+        });\n+      } else {\n+        setSuggestedUrl(url);\n+        handleCheckIsWhitelisted();\n+      }\n+    }\n+  };\n+\n+\n+  const onUpdate = () => {\n+    UIUtils.triggerInput(ref.current);\n+    checkIsWhitelisted();\n+  };\n+\n+  const handleChange = (event: SyntheticInputEvent<EventTarget>) => {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc3NTE5Ng=="}, "originalCommit": {"oid": "707ed48ac346c0d6d5e085dffa30c9f2f5e5e00f"}, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1Njc1NzAxOnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/configurations/URLWhitelistInput.jsx", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNjoxMzowM1rOFrIvMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwOTo1NTowMVrOFsM6pQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc3NjI0Mw==", "bodyText": "I think handleFormEvent is not descriptive of what the prop does. Since other inputs use onChange for this, I think it would be better to also use that name.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r380776243", "createdAt": "2020-02-18T16:13:03Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/configurations/URLWhitelistInput.jsx", "diffHunk": "@@ -0,0 +1,122 @@\n+// @flow\n+import React, { useRef, useState, useEffect } from 'react';\n+import PropTypes from 'prop-types';\n+import { Input } from 'components/bootstrap';\n+import URLWhitelistFormModal from 'components/configurations/URLWhitelistFormModal';\n+import StoreProvider from 'injection/StoreProvider';\n+import URLUtils from 'util/URLUtils';\n+import UIUtils from 'util/UIUtils';\n+\n+const ToolsStore = StoreProvider.getStore('Tools');\n+type Props = {\n+  label: string,\n+  handleFormEvent: (event: SyntheticInputEvent<EventTarget>) => void,\n+  validationMessage: string,\n+  validationState: string,\n+  url: string,\n+  labelClassName: string,\n+  wrapperClassName: string,\n+  formType: string\n+}\n+const URLWhitelistInput = ({ label, handleFormEvent, validationMessage, validationState, url, labelClassName, wrapperClassName, formType }: Props) => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "707ed48ac346c0d6d5e085dffa30c9f2f5e5e00f"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg5MzI4NQ==", "bodyText": "Changed !", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r381893285", "createdAt": "2020-02-20T09:55:01Z", "author": {"login": "ousmaneo"}, "path": "graylog2-web-interface/src/components/configurations/URLWhitelistInput.jsx", "diffHunk": "@@ -0,0 +1,122 @@\n+// @flow\n+import React, { useRef, useState, useEffect } from 'react';\n+import PropTypes from 'prop-types';\n+import { Input } from 'components/bootstrap';\n+import URLWhitelistFormModal from 'components/configurations/URLWhitelistFormModal';\n+import StoreProvider from 'injection/StoreProvider';\n+import URLUtils from 'util/URLUtils';\n+import UIUtils from 'util/UIUtils';\n+\n+const ToolsStore = StoreProvider.getStore('Tools');\n+type Props = {\n+  label: string,\n+  handleFormEvent: (event: SyntheticInputEvent<EventTarget>) => void,\n+  validationMessage: string,\n+  validationState: string,\n+  url: string,\n+  labelClassName: string,\n+  wrapperClassName: string,\n+  formType: string\n+}\n+const URLWhitelistInput = ({ label, handleFormEvent, validationMessage, validationState, url, labelClassName, wrapperClassName, formType }: Props) => {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc3NjI0Mw=="}, "originalCommit": {"oid": "707ed48ac346c0d6d5e085dffa30c9f2f5e5e00f"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1Njg3MzQ2OnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/util/UIUtils.js", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNjo0MDo0OFrOFrJ23g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNjo0MDo0OFrOFrJ23g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc5NDU5MA==", "bodyText": "I have some troubles understanding parts of this code. I think we should try to use the callback directly with a fake event or make the callback support non-event values.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r380794590", "createdAt": "2020-02-18T16:40:48Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/util/UIUtils.js", "diffHunk": "@@ -22,6 +22,16 @@ const UIUtils = {\n \n     return rect.top > 0 && rect.bottom > 0;\n   },\n+  triggerInput(urlInput) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "707ed48ac346c0d6d5e085dffa30c9f2f5e5e00f"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1Njg4NDM1OnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/configurations/URLWhitelistInput.jsx", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNjo0MzozOFrOFrJ94w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwOToxNjo0M1rOFsLlGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc5NjM4Nw==", "bodyText": "This message is using an old URL when I'm editing the input:", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r380796387", "createdAt": "2020-02-18T16:43:38Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/configurations/URLWhitelistInput.jsx", "diffHunk": "@@ -0,0 +1,122 @@\n+// @flow\n+import React, { useRef, useState, useEffect } from 'react';\n+import PropTypes from 'prop-types';\n+import { Input } from 'components/bootstrap';\n+import URLWhitelistFormModal from 'components/configurations/URLWhitelistFormModal';\n+import StoreProvider from 'injection/StoreProvider';\n+import URLUtils from 'util/URLUtils';\n+import UIUtils from 'util/UIUtils';\n+\n+const ToolsStore = StoreProvider.getStore('Tools');\n+type Props = {\n+  label: string,\n+  handleFormEvent: (event: SyntheticInputEvent<EventTarget>) => void,\n+  validationMessage: string,\n+  validationState: string,\n+  url: string,\n+  labelClassName: string,\n+  wrapperClassName: string,\n+  formType: string\n+}\n+const URLWhitelistInput = ({ label, handleFormEvent, validationMessage, validationState, url, labelClassName, wrapperClassName, formType }: Props) => {\n+  const [isWhitelisted, setIsWhitelisted] = useState(false);\n+  const [currentValidationState, setCurrentValidationState] = useState(validationState);\n+  const [ownValidationMessage, setOwnValidationMessage] = useState(validationMessage);\n+\n+  const suggestRegexWhitelistUrl = (typedUrl: string, type: string): string | Promise<any> => {\n+    // eslint-disable-next-line no-template-curly-in-string\n+    const keyWildcard = '${key}';\n+    return type && type === 'regex' && URLUtils.isValidURL(typedUrl) ? ToolsStore.urlWhiteListGenerateRegex(typedUrl, keyWildcard) : typedUrl;\n+  };\n+\n+  const [suggestedUrl, setSuggestedUrl] = useState(url);\n+  const isError = () => currentValidationState === 'error';\n+  const ref = useRef();\n+\n+  const handleCheckIsWhitelisted = () => {\n+    const promise = ToolsStore.urlWhiteListCheck(url);\n+    promise.then((result) => {\n+      if (!result.is_whitelisted && validationState === null) {\n+        setCurrentValidationState('error');\n+        setOwnValidationMessage(`URL ${suggestedUrl} is not whitelisted or not valid URL.`);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "707ed48ac346c0d6d5e085dffa30c9f2f5e5e00f"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg3MTM4Nw==", "bodyText": "Fixed", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r381871387", "createdAt": "2020-02-20T09:16:43Z", "author": {"login": "ousmaneo"}, "path": "graylog2-web-interface/src/components/configurations/URLWhitelistInput.jsx", "diffHunk": "@@ -0,0 +1,122 @@\n+// @flow\n+import React, { useRef, useState, useEffect } from 'react';\n+import PropTypes from 'prop-types';\n+import { Input } from 'components/bootstrap';\n+import URLWhitelistFormModal from 'components/configurations/URLWhitelistFormModal';\n+import StoreProvider from 'injection/StoreProvider';\n+import URLUtils from 'util/URLUtils';\n+import UIUtils from 'util/UIUtils';\n+\n+const ToolsStore = StoreProvider.getStore('Tools');\n+type Props = {\n+  label: string,\n+  handleFormEvent: (event: SyntheticInputEvent<EventTarget>) => void,\n+  validationMessage: string,\n+  validationState: string,\n+  url: string,\n+  labelClassName: string,\n+  wrapperClassName: string,\n+  formType: string\n+}\n+const URLWhitelistInput = ({ label, handleFormEvent, validationMessage, validationState, url, labelClassName, wrapperClassName, formType }: Props) => {\n+  const [isWhitelisted, setIsWhitelisted] = useState(false);\n+  const [currentValidationState, setCurrentValidationState] = useState(validationState);\n+  const [ownValidationMessage, setOwnValidationMessage] = useState(validationMessage);\n+\n+  const suggestRegexWhitelistUrl = (typedUrl: string, type: string): string | Promise<any> => {\n+    // eslint-disable-next-line no-template-curly-in-string\n+    const keyWildcard = '${key}';\n+    return type && type === 'regex' && URLUtils.isValidURL(typedUrl) ? ToolsStore.urlWhiteListGenerateRegex(typedUrl, keyWildcard) : typedUrl;\n+  };\n+\n+  const [suggestedUrl, setSuggestedUrl] = useState(url);\n+  const isError = () => currentValidationState === 'error';\n+  const ref = useRef();\n+\n+  const handleCheckIsWhitelisted = () => {\n+    const promise = ToolsStore.urlWhiteListCheck(url);\n+    promise.then((result) => {\n+      if (!result.is_whitelisted && validationState === null) {\n+        setCurrentValidationState('error');\n+        setOwnValidationMessage(`URL ${suggestedUrl} is not whitelisted or not valid URL.`);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc5NjM4Nw=="}, "originalCommit": {"oid": "707ed48ac346c0d6d5e085dffa30c9f2f5e5e00f"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1OTM4MzM2OnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/configurations/URLWhitelistInput.jsx", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMDowMDozNVrOFrh6kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMDowMDozNVrOFrh6kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE4ODc1NA==", "bodyText": "I think we should restrict the actual values that are accepted for this prop. I also think that the name could be more descriptive, something like urlType is clearer to me than formType.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r381188754", "createdAt": "2020-02-19T10:00:35Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/configurations/URLWhitelistInput.jsx", "diffHunk": "@@ -0,0 +1,122 @@\n+// @flow\n+import React, { useRef, useState, useEffect } from 'react';\n+import PropTypes from 'prop-types';\n+import { Input } from 'components/bootstrap';\n+import URLWhitelistFormModal from 'components/configurations/URLWhitelistFormModal';\n+import StoreProvider from 'injection/StoreProvider';\n+import URLUtils from 'util/URLUtils';\n+import UIUtils from 'util/UIUtils';\n+\n+const ToolsStore = StoreProvider.getStore('Tools');\n+type Props = {\n+  label: string,\n+  handleFormEvent: (event: SyntheticInputEvent<EventTarget>) => void,\n+  validationMessage: string,\n+  validationState: string,\n+  url: string,\n+  labelClassName: string,\n+  wrapperClassName: string,\n+  formType: string\n+}\n+const URLWhitelistInput = ({ label, handleFormEvent, validationMessage, validationState, url, labelClassName, wrapperClassName, formType }: Props) => {\n+  const [isWhitelisted, setIsWhitelisted] = useState(false);\n+  const [currentValidationState, setCurrentValidationState] = useState(validationState);\n+  const [ownValidationMessage, setOwnValidationMessage] = useState(validationMessage);\n+\n+  const suggestRegexWhitelistUrl = (typedUrl: string, type: string): string | Promise<any> => {\n+    // eslint-disable-next-line no-template-curly-in-string\n+    const keyWildcard = '${key}';\n+    return type && type === 'regex' && URLUtils.isValidURL(typedUrl) ? ToolsStore.urlWhiteListGenerateRegex(typedUrl, keyWildcard) : typedUrl;\n+  };\n+\n+  const [suggestedUrl, setSuggestedUrl] = useState(url);\n+  const isError = () => currentValidationState === 'error';\n+  const ref = useRef();\n+\n+  const handleCheckIsWhitelisted = () => {\n+    const promise = ToolsStore.urlWhiteListCheck(url);\n+    promise.then((result) => {\n+      if (!result.is_whitelisted && validationState === null) {\n+        setCurrentValidationState('error');\n+        setOwnValidationMessage(`URL ${suggestedUrl} is not whitelisted or not valid URL.`);\n+      } else {\n+        setOwnValidationMessage(validationMessage);\n+        setCurrentValidationState(validationState);\n+      }\n+      setIsWhitelisted(result.is_whitelisted);\n+    });\n+  };\n+\n+  const checkIsWhitelisted = () => {\n+    if (url) {\n+      const suggestion = suggestRegexWhitelistUrl(url, formType);\n+      if (typeof suggestion === 'object') {\n+        suggestion.then((result) => {\n+          setSuggestedUrl(result.regex);\n+          handleCheckIsWhitelisted();\n+        });\n+      } else {\n+        setSuggestedUrl(url);\n+        handleCheckIsWhitelisted();\n+      }\n+    }\n+  };\n+\n+\n+  const onUpdate = () => {\n+    UIUtils.triggerInput(ref.current);\n+    checkIsWhitelisted();\n+  };\n+\n+  const handleChange = (event: SyntheticInputEvent<EventTarget>) => {\n+    handleFormEvent(event);\n+  };\n+\n+  useEffect(() => {\n+    checkIsWhitelisted();\n+  }, [url, validationState]);\n+\n+\n+  const addButton = isError() && !isWhitelisted ? <URLWhitelistFormModal newUrlEntry={suggestedUrl} onUpdate={onUpdate} formType={formType} /> : '';\n+  const helpMessage = <>{ownValidationMessage} {addButton}</>;\n+  return (\n+    <Input type=\"text\"\n+           id=\"url\"\n+           name=\"url\"\n+           label={label}\n+           ref={ref}\n+           autoFocus\n+           required\n+           onChange={handleChange}\n+           help={helpMessage}\n+           bsStyle={currentValidationState}\n+           value={url}\n+           labelClassName={labelClassName}\n+           wrapperClassName={wrapperClassName} />\n+  );\n+};\n+\n+URLWhitelistInput.propTypes = {\n+  label: PropTypes.string.isRequired,\n+  handleFormEvent: PropTypes.func.isRequired,\n+  validationState: PropTypes.string,\n+  validationMessage: PropTypes.oneOfType([\n+    PropTypes.object,\n+    PropTypes.string,\n+  ]),\n+  url: PropTypes.string,\n+  labelClassName: PropTypes.string,\n+  wrapperClassName: PropTypes.string,\n+  formType: PropTypes.string,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "707ed48ac346c0d6d5e085dffa30c9f2f5e5e00f"}, "originalPosition": 110}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1OTM5MzU4OnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/configurations/URLWhitelistInput.jsx", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMDowMzoyM1rOFriA0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwOTo0OTo0N1rOFt_W-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE5MDM1NA==", "bodyText": "The inline button there looks odd to me, maybe @kyleknighted has an idea to improve that a bit? Also I think we should treat differently the case when a URL is not in the whitelist, and when the URL is not valid.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r381190354", "createdAt": "2020-02-19T10:03:23Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/configurations/URLWhitelistInput.jsx", "diffHunk": "@@ -0,0 +1,122 @@\n+// @flow\n+import React, { useRef, useState, useEffect } from 'react';\n+import PropTypes from 'prop-types';\n+import { Input } from 'components/bootstrap';\n+import URLWhitelistFormModal from 'components/configurations/URLWhitelistFormModal';\n+import StoreProvider from 'injection/StoreProvider';\n+import URLUtils from 'util/URLUtils';\n+import UIUtils from 'util/UIUtils';\n+\n+const ToolsStore = StoreProvider.getStore('Tools');\n+type Props = {\n+  label: string,\n+  handleFormEvent: (event: SyntheticInputEvent<EventTarget>) => void,\n+  validationMessage: string,\n+  validationState: string,\n+  url: string,\n+  labelClassName: string,\n+  wrapperClassName: string,\n+  formType: string\n+}\n+const URLWhitelistInput = ({ label, handleFormEvent, validationMessage, validationState, url, labelClassName, wrapperClassName, formType }: Props) => {\n+  const [isWhitelisted, setIsWhitelisted] = useState(false);\n+  const [currentValidationState, setCurrentValidationState] = useState(validationState);\n+  const [ownValidationMessage, setOwnValidationMessage] = useState(validationMessage);\n+\n+  const suggestRegexWhitelistUrl = (typedUrl: string, type: string): string | Promise<any> => {\n+    // eslint-disable-next-line no-template-curly-in-string\n+    const keyWildcard = '${key}';\n+    return type && type === 'regex' && URLUtils.isValidURL(typedUrl) ? ToolsStore.urlWhiteListGenerateRegex(typedUrl, keyWildcard) : typedUrl;\n+  };\n+\n+  const [suggestedUrl, setSuggestedUrl] = useState(url);\n+  const isError = () => currentValidationState === 'error';\n+  const ref = useRef();\n+\n+  const handleCheckIsWhitelisted = () => {\n+    const promise = ToolsStore.urlWhiteListCheck(url);\n+    promise.then((result) => {\n+      if (!result.is_whitelisted && validationState === null) {\n+        setCurrentValidationState('error');\n+        setOwnValidationMessage(`URL ${suggestedUrl} is not whitelisted or not valid URL.`);\n+      } else {\n+        setOwnValidationMessage(validationMessage);\n+        setCurrentValidationState(validationState);\n+      }\n+      setIsWhitelisted(result.is_whitelisted);\n+    });\n+  };\n+\n+  const checkIsWhitelisted = () => {\n+    if (url) {\n+      const suggestion = suggestRegexWhitelistUrl(url, formType);\n+      if (typeof suggestion === 'object') {\n+        suggestion.then((result) => {\n+          setSuggestedUrl(result.regex);\n+          handleCheckIsWhitelisted();\n+        });\n+      } else {\n+        setSuggestedUrl(url);\n+        handleCheckIsWhitelisted();\n+      }\n+    }\n+  };\n+\n+\n+  const onUpdate = () => {\n+    UIUtils.triggerInput(ref.current);\n+    checkIsWhitelisted();\n+  };\n+\n+  const handleChange = (event: SyntheticInputEvent<EventTarget>) => {\n+    handleFormEvent(event);\n+  };\n+\n+  useEffect(() => {\n+    checkIsWhitelisted();\n+  }, [url, validationState]);\n+\n+\n+  const addButton = isError() && !isWhitelisted ? <URLWhitelistFormModal newUrlEntry={suggestedUrl} onUpdate={onUpdate} formType={formType} /> : '';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "707ed48ac346c0d6d5e085dffa30c9f2f5e5e00f"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAwNDM2OA==", "bodyText": "@edmundoa What is the recommended way for validating a URL?\nIn my server host file I can add 127.0.0.1 foobar and then this is a valid URL, even though there is no dot com.\nwikipedi\u0430.org and wikipedia.org are both different thanks to Cyrillic and Latin homographs. So we can't really strip away everything that isn't a Latin letter.\nI'm not sure if we have any specific way to validate what a \"real\" URL is.\nAs for the button placement, I would probably need more insight on the entire flow & design of this feature to provide much feedback there.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r382004368", "createdAt": "2020-02-20T13:41:54Z", "author": {"login": "kyleknighted"}, "path": "graylog2-web-interface/src/components/configurations/URLWhitelistInput.jsx", "diffHunk": "@@ -0,0 +1,122 @@\n+// @flow\n+import React, { useRef, useState, useEffect } from 'react';\n+import PropTypes from 'prop-types';\n+import { Input } from 'components/bootstrap';\n+import URLWhitelistFormModal from 'components/configurations/URLWhitelistFormModal';\n+import StoreProvider from 'injection/StoreProvider';\n+import URLUtils from 'util/URLUtils';\n+import UIUtils from 'util/UIUtils';\n+\n+const ToolsStore = StoreProvider.getStore('Tools');\n+type Props = {\n+  label: string,\n+  handleFormEvent: (event: SyntheticInputEvent<EventTarget>) => void,\n+  validationMessage: string,\n+  validationState: string,\n+  url: string,\n+  labelClassName: string,\n+  wrapperClassName: string,\n+  formType: string\n+}\n+const URLWhitelistInput = ({ label, handleFormEvent, validationMessage, validationState, url, labelClassName, wrapperClassName, formType }: Props) => {\n+  const [isWhitelisted, setIsWhitelisted] = useState(false);\n+  const [currentValidationState, setCurrentValidationState] = useState(validationState);\n+  const [ownValidationMessage, setOwnValidationMessage] = useState(validationMessage);\n+\n+  const suggestRegexWhitelistUrl = (typedUrl: string, type: string): string | Promise<any> => {\n+    // eslint-disable-next-line no-template-curly-in-string\n+    const keyWildcard = '${key}';\n+    return type && type === 'regex' && URLUtils.isValidURL(typedUrl) ? ToolsStore.urlWhiteListGenerateRegex(typedUrl, keyWildcard) : typedUrl;\n+  };\n+\n+  const [suggestedUrl, setSuggestedUrl] = useState(url);\n+  const isError = () => currentValidationState === 'error';\n+  const ref = useRef();\n+\n+  const handleCheckIsWhitelisted = () => {\n+    const promise = ToolsStore.urlWhiteListCheck(url);\n+    promise.then((result) => {\n+      if (!result.is_whitelisted && validationState === null) {\n+        setCurrentValidationState('error');\n+        setOwnValidationMessage(`URL ${suggestedUrl} is not whitelisted or not valid URL.`);\n+      } else {\n+        setOwnValidationMessage(validationMessage);\n+        setCurrentValidationState(validationState);\n+      }\n+      setIsWhitelisted(result.is_whitelisted);\n+    });\n+  };\n+\n+  const checkIsWhitelisted = () => {\n+    if (url) {\n+      const suggestion = suggestRegexWhitelistUrl(url, formType);\n+      if (typeof suggestion === 'object') {\n+        suggestion.then((result) => {\n+          setSuggestedUrl(result.regex);\n+          handleCheckIsWhitelisted();\n+        });\n+      } else {\n+        setSuggestedUrl(url);\n+        handleCheckIsWhitelisted();\n+      }\n+    }\n+  };\n+\n+\n+  const onUpdate = () => {\n+    UIUtils.triggerInput(ref.current);\n+    checkIsWhitelisted();\n+  };\n+\n+  const handleChange = (event: SyntheticInputEvent<EventTarget>) => {\n+    handleFormEvent(event);\n+  };\n+\n+  useEffect(() => {\n+    checkIsWhitelisted();\n+  }, [url, validationState]);\n+\n+\n+  const addButton = isError() && !isWhitelisted ? <URLWhitelistFormModal newUrlEntry={suggestedUrl} onUpdate={onUpdate} formType={formType} /> : '';", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE5MDM1NA=="}, "originalCommit": {"oid": "707ed48ac346c0d6d5e085dffa30c9f2f5e5e00f"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcwMTgzMg==", "bodyText": "@kyleknighted this is not about ensuring a given URL is \"real\" or not, for what I have seen in the code, we consider a URL valid if new URL() does not throw an exception. So, for instance, a missing or wrong schema in the URL would do that.\nThe biggest concern I have is that users will see the message and try to put the URL in the whitelist. Then the form will complain that is not a valid URL, so it is kind of misleading when we could do that check in first place.\nRegarding the button, I think the alignment and spacing doesn't look right, and also the colours look kind of odd to me. Other than that I think it's fine.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r382701832", "createdAt": "2020-02-21T17:11:10Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/configurations/URLWhitelistInput.jsx", "diffHunk": "@@ -0,0 +1,122 @@\n+// @flow\n+import React, { useRef, useState, useEffect } from 'react';\n+import PropTypes from 'prop-types';\n+import { Input } from 'components/bootstrap';\n+import URLWhitelistFormModal from 'components/configurations/URLWhitelistFormModal';\n+import StoreProvider from 'injection/StoreProvider';\n+import URLUtils from 'util/URLUtils';\n+import UIUtils from 'util/UIUtils';\n+\n+const ToolsStore = StoreProvider.getStore('Tools');\n+type Props = {\n+  label: string,\n+  handleFormEvent: (event: SyntheticInputEvent<EventTarget>) => void,\n+  validationMessage: string,\n+  validationState: string,\n+  url: string,\n+  labelClassName: string,\n+  wrapperClassName: string,\n+  formType: string\n+}\n+const URLWhitelistInput = ({ label, handleFormEvent, validationMessage, validationState, url, labelClassName, wrapperClassName, formType }: Props) => {\n+  const [isWhitelisted, setIsWhitelisted] = useState(false);\n+  const [currentValidationState, setCurrentValidationState] = useState(validationState);\n+  const [ownValidationMessage, setOwnValidationMessage] = useState(validationMessage);\n+\n+  const suggestRegexWhitelistUrl = (typedUrl: string, type: string): string | Promise<any> => {\n+    // eslint-disable-next-line no-template-curly-in-string\n+    const keyWildcard = '${key}';\n+    return type && type === 'regex' && URLUtils.isValidURL(typedUrl) ? ToolsStore.urlWhiteListGenerateRegex(typedUrl, keyWildcard) : typedUrl;\n+  };\n+\n+  const [suggestedUrl, setSuggestedUrl] = useState(url);\n+  const isError = () => currentValidationState === 'error';\n+  const ref = useRef();\n+\n+  const handleCheckIsWhitelisted = () => {\n+    const promise = ToolsStore.urlWhiteListCheck(url);\n+    promise.then((result) => {\n+      if (!result.is_whitelisted && validationState === null) {\n+        setCurrentValidationState('error');\n+        setOwnValidationMessage(`URL ${suggestedUrl} is not whitelisted or not valid URL.`);\n+      } else {\n+        setOwnValidationMessage(validationMessage);\n+        setCurrentValidationState(validationState);\n+      }\n+      setIsWhitelisted(result.is_whitelisted);\n+    });\n+  };\n+\n+  const checkIsWhitelisted = () => {\n+    if (url) {\n+      const suggestion = suggestRegexWhitelistUrl(url, formType);\n+      if (typeof suggestion === 'object') {\n+        suggestion.then((result) => {\n+          setSuggestedUrl(result.regex);\n+          handleCheckIsWhitelisted();\n+        });\n+      } else {\n+        setSuggestedUrl(url);\n+        handleCheckIsWhitelisted();\n+      }\n+    }\n+  };\n+\n+\n+  const onUpdate = () => {\n+    UIUtils.triggerInput(ref.current);\n+    checkIsWhitelisted();\n+  };\n+\n+  const handleChange = (event: SyntheticInputEvent<EventTarget>) => {\n+    handleFormEvent(event);\n+  };\n+\n+  useEffect(() => {\n+    checkIsWhitelisted();\n+  }, [url, validationState]);\n+\n+\n+  const addButton = isError() && !isWhitelisted ? <URLWhitelistFormModal newUrlEntry={suggestedUrl} onUpdate={onUpdate} formType={formType} /> : '';", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE5MDM1NA=="}, "originalCommit": {"oid": "707ed48ac346c0d6d5e085dffa30c9f2f5e5e00f"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzc2ODMxMg==", "bodyText": "Hi @edmundoa I added a fix to separate Url and Whitelist validation.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r383768312", "createdAt": "2020-02-25T09:49:47Z", "author": {"login": "ousmaneo"}, "path": "graylog2-web-interface/src/components/configurations/URLWhitelistInput.jsx", "diffHunk": "@@ -0,0 +1,122 @@\n+// @flow\n+import React, { useRef, useState, useEffect } from 'react';\n+import PropTypes from 'prop-types';\n+import { Input } from 'components/bootstrap';\n+import URLWhitelistFormModal from 'components/configurations/URLWhitelistFormModal';\n+import StoreProvider from 'injection/StoreProvider';\n+import URLUtils from 'util/URLUtils';\n+import UIUtils from 'util/UIUtils';\n+\n+const ToolsStore = StoreProvider.getStore('Tools');\n+type Props = {\n+  label: string,\n+  handleFormEvent: (event: SyntheticInputEvent<EventTarget>) => void,\n+  validationMessage: string,\n+  validationState: string,\n+  url: string,\n+  labelClassName: string,\n+  wrapperClassName: string,\n+  formType: string\n+}\n+const URLWhitelistInput = ({ label, handleFormEvent, validationMessage, validationState, url, labelClassName, wrapperClassName, formType }: Props) => {\n+  const [isWhitelisted, setIsWhitelisted] = useState(false);\n+  const [currentValidationState, setCurrentValidationState] = useState(validationState);\n+  const [ownValidationMessage, setOwnValidationMessage] = useState(validationMessage);\n+\n+  const suggestRegexWhitelistUrl = (typedUrl: string, type: string): string | Promise<any> => {\n+    // eslint-disable-next-line no-template-curly-in-string\n+    const keyWildcard = '${key}';\n+    return type && type === 'regex' && URLUtils.isValidURL(typedUrl) ? ToolsStore.urlWhiteListGenerateRegex(typedUrl, keyWildcard) : typedUrl;\n+  };\n+\n+  const [suggestedUrl, setSuggestedUrl] = useState(url);\n+  const isError = () => currentValidationState === 'error';\n+  const ref = useRef();\n+\n+  const handleCheckIsWhitelisted = () => {\n+    const promise = ToolsStore.urlWhiteListCheck(url);\n+    promise.then((result) => {\n+      if (!result.is_whitelisted && validationState === null) {\n+        setCurrentValidationState('error');\n+        setOwnValidationMessage(`URL ${suggestedUrl} is not whitelisted or not valid URL.`);\n+      } else {\n+        setOwnValidationMessage(validationMessage);\n+        setCurrentValidationState(validationState);\n+      }\n+      setIsWhitelisted(result.is_whitelisted);\n+    });\n+  };\n+\n+  const checkIsWhitelisted = () => {\n+    if (url) {\n+      const suggestion = suggestRegexWhitelistUrl(url, formType);\n+      if (typeof suggestion === 'object') {\n+        suggestion.then((result) => {\n+          setSuggestedUrl(result.regex);\n+          handleCheckIsWhitelisted();\n+        });\n+      } else {\n+        setSuggestedUrl(url);\n+        handleCheckIsWhitelisted();\n+      }\n+    }\n+  };\n+\n+\n+  const onUpdate = () => {\n+    UIUtils.triggerInput(ref.current);\n+    checkIsWhitelisted();\n+  };\n+\n+  const handleChange = (event: SyntheticInputEvent<EventTarget>) => {\n+    handleFormEvent(event);\n+  };\n+\n+  useEffect(() => {\n+    checkIsWhitelisted();\n+  }, [url, validationState]);\n+\n+\n+  const addButton = isError() && !isWhitelisted ? <URLWhitelistFormModal newUrlEntry={suggestedUrl} onUpdate={onUpdate} formType={formType} /> : '';", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE5MDM1NA=="}, "originalCommit": {"oid": "707ed48ac346c0d6d5e085dffa30c9f2f5e5e00f"}, "originalPosition": 80}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1OTQyMDUxOnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/configurations/URLWhitelistInput.jsx", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMDoxMDozOVrOFriRKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMDoxMDozOVrOFriRKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE5NDUzNw==", "bodyText": "Since the URLWhitelistInput will be used in many different forms across the product, I think it should live somewhere else. Since some shared inputs are already in components/common, I would suggest moving it there.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r381194537", "createdAt": "2020-02-19T10:10:39Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/configurations/URLWhitelistInput.jsx", "diffHunk": "@@ -0,0 +1,122 @@\n+// @flow\n+import React, { useRef, useState, useEffect } from 'react';\n+import PropTypes from 'prop-types';\n+import { Input } from 'components/bootstrap';\n+import URLWhitelistFormModal from 'components/configurations/URLWhitelistFormModal';\n+import StoreProvider from 'injection/StoreProvider';\n+import URLUtils from 'util/URLUtils';\n+import UIUtils from 'util/UIUtils';\n+\n+const ToolsStore = StoreProvider.getStore('Tools');\n+type Props = {\n+  label: string,\n+  handleFormEvent: (event: SyntheticInputEvent<EventTarget>) => void,\n+  validationMessage: string,\n+  validationState: string,\n+  url: string,\n+  labelClassName: string,\n+  wrapperClassName: string,\n+  formType: string\n+}\n+const URLWhitelistInput = ({ label, handleFormEvent, validationMessage, validationState, url, labelClassName, wrapperClassName, formType }: Props) => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "707ed48ac346c0d6d5e085dffa30c9f2f5e5e00f"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1OTQzMDMyOnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/configurations/UrlWhiteListForm.jsx", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMDoxMzoyNVrOFriXNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNDo0NzowMlrOFsWKqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE5NjA4NQ==", "bodyText": "I'm not sure why we need to return true in here, could you please explain it? :)", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r381196085", "createdAt": "2020-02-19T10:13:25Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/configurations/UrlWhiteListForm.jsx", "diffHunk": "@@ -132,7 +134,7 @@ const UrlWhiteListForm = ({ urls, onUpdate, disabled }: Props) => {\n           <td>\n             <Input type=\"text\"\n                    id={`title-input${idx}`}\n-                   ref={(elem) => { inputs[`title${idx}`] = elem; }}\n+                   ref={(elem) => { inputs[`title${idx}`] = elem; return true; }}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "707ed48ac346c0d6d5e085dffa30c9f2f5e5e00f"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAwNDg2Mw==", "bodyText": "And is it possible to use the createRef that I had mentioned in a previous comment?", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r382004863", "createdAt": "2020-02-20T13:42:45Z", "author": {"login": "kyleknighted"}, "path": "graylog2-web-interface/src/components/configurations/UrlWhiteListForm.jsx", "diffHunk": "@@ -132,7 +134,7 @@ const UrlWhiteListForm = ({ urls, onUpdate, disabled }: Props) => {\n           <td>\n             <Input type=\"text\"\n                    id={`title-input${idx}`}\n-                   ref={(elem) => { inputs[`title${idx}`] = elem; }}\n+                   ref={(elem) => { inputs[`title${idx}`] = elem; return true; }}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE5NjA4NQ=="}, "originalCommit": {"oid": "707ed48ac346c0d6d5e085dffa30c9f2f5e5e00f"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA0NDg0MQ==", "bodyText": "Hi @kyleknighted , these are dynamically created refs for the url whitelist from that's why I use callback ref.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r382044841", "createdAt": "2020-02-20T14:47:02Z", "author": {"login": "ousmaneo"}, "path": "graylog2-web-interface/src/components/configurations/UrlWhiteListForm.jsx", "diffHunk": "@@ -132,7 +134,7 @@ const UrlWhiteListForm = ({ urls, onUpdate, disabled }: Props) => {\n           <td>\n             <Input type=\"text\"\n                    id={`title-input${idx}`}\n-                   ref={(elem) => { inputs[`title${idx}`] = elem; }}\n+                   ref={(elem) => { inputs[`title${idx}`] = elem; return true; }}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE5NjA4NQ=="}, "originalCommit": {"oid": "707ed48ac346c0d6d5e085dffa30c9f2f5e5e00f"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1OTQzMDkxOnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/configurations/UrlWhiteListForm.jsx", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMDoxMzozM1rOFriXkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMDoxMzozM1rOFriXkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE5NjE3OA==", "bodyText": "Same as above.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r381196178", "createdAt": "2020-02-19T10:13:33Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/configurations/UrlWhiteListForm.jsx", "diffHunk": "@@ -143,7 +145,7 @@ const UrlWhiteListForm = ({ urls, onUpdate, disabled }: Props) => {\n           <td>\n             <Input type=\"text\"\n                    id={`value-input${idx}`}\n-                   ref={(elem) => { inputs[`value${idx}`] = elem; }}\n+                   ref={(elem) => { inputs[`value${idx}`] = elem; return true; }}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "707ed48ac346c0d6d5e085dffa30c9f2f5e5e00f"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1OTQ1NDA4OnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/configurations/URLWhitelistFormModal.jsx", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMDoyMDowOVrOFrilvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMDoyMDowOVrOFrilvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE5OTgwNQ==", "bodyText": "Most of the code in this component should be very similar to parts of what we have in UrlWhiteListConfig.jsx, I think we should try and make a single component doing this, so we can reuse it better whenever is needed.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r381199805", "createdAt": "2020-02-19T10:20:09Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/configurations/URLWhitelistFormModal.jsx", "diffHunk": "@@ -0,0 +1,158 @@\n+// @flow\n+import React from 'react';\n+import PropTypes from 'prop-types';\n+import uuid from 'uuid/v4';\n+import connect from 'stores/connect';\n+import { IfPermitted } from 'components/common';\n+import { Button } from 'components/graylog';\n+import BootstrapModalForm from 'components/bootstrap/BootstrapModalForm';\n+import UrlWhiteListForm from 'components/configurations/UrlWhiteListForm';\n+import CombinedProvider from 'injection/CombinedProvider';\n+import PermissionsMixin from 'util/PermissionsMixin';\n+import type { WhiteListConfig } from 'stores/configurations/ConfigurationsStore';\n+\n+const { CurrentUserStore } = CombinedProvider.get('CurrentUser');\n+const { ConfigurationsActions, ConfigurationsStore } = CombinedProvider.get('Configurations');\n+\n+const URL_WHITELIST_CONFIG = 'org.graylog2.system.urlwhitelist.UrlWhitelist';\n+\n+type State = {\n+  config: WhiteListConfig,\n+  isValid: boolean\n+};\n+\n+type Props = {\n+  newUrlEntry: string,\n+  onUpdate: () => void,\n+  configuration: {},\n+  currentUser: {permissions: Array<string>},\n+  formType: string,\n+};\n+\n+\n+class URLWhitelistFormModal extends React.Component<Props, State> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "707ed48ac346c0d6d5e085dffa30c9f2f5e5e00f"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1OTQ1Nzg3OnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/lookup-tables/adapters/DSVHTTPAdapterFieldSet.jsx", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMDoyMToxN1rOFrioRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMDowMjowNlrOFsNKPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIwMDQ1NQ==", "bodyText": "This prop is marked as unused, do we really use it in the component or can we delete it?", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r381200455", "createdAt": "2020-02-19T10:21:17Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/lookup-tables/adapters/DSVHTTPAdapterFieldSet.jsx", "diffHunk": "@@ -107,4 +103,13 @@ const DSVHTTPAdapterFieldSet = ({ handleFormEvent, validationState, validationMe\n   );\n };\n \n+DSVHTTPAdapterFieldSet.propTypes = {\n+  config: PropTypes.object.isRequired,\n+  // eslint-disable-next-line react/no-unused-prop-types\n+  updateConfig: PropTypes.func.isRequired,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "707ed48ac346c0d6d5e085dffa30c9f2f5e5e00f"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg5NzI3OQ==", "bodyText": "Fixed", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r381897279", "createdAt": "2020-02-20T10:02:06Z", "author": {"login": "ousmaneo"}, "path": "graylog2-web-interface/src/components/lookup-tables/adapters/DSVHTTPAdapterFieldSet.jsx", "diffHunk": "@@ -107,4 +103,13 @@ const DSVHTTPAdapterFieldSet = ({ handleFormEvent, validationState, validationMe\n   );\n };\n \n+DSVHTTPAdapterFieldSet.propTypes = {\n+  config: PropTypes.object.isRequired,\n+  // eslint-disable-next-line react/no-unused-prop-types\n+  updateConfig: PropTypes.func.isRequired,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIwMDQ1NQ=="}, "originalCommit": {"oid": "707ed48ac346c0d6d5e085dffa30c9f2f5e5e00f"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1OTQ4MjEzOnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/lookup-tables/adapters/HTTPJSONPathAdapterFieldSet.jsx", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMDoyODoxOVrOFri3gA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMDowMjoyM1rOFsNK0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIwNDM1Mg==", "bodyText": "When creating a new Data Adapter the whitelist check is returning errors before the field is set, but I think that should not happen.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r381204352", "createdAt": "2020-02-19T10:28:19Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/lookup-tables/adapters/HTTPJSONPathAdapterFieldSet.jsx", "diffHunk": "@@ -17,46 +18,43 @@ class HTTPJSONPathAdapterFieldSet extends React.Component {\n   state = {};\n \n   onHTTPHeaderUpdate = (headers) => {\n-    const config = ObjectUtils.clone(this.props.config);\n-    config.headers = headers;\n-    this.props.updateConfig(config);\n+    const { config, updateConfig } = this.props;\n+    const configChange = ObjectUtils.clone(config);\n+    configChange.headers = headers;\n+    updateConfig(config);\n   };\n \n   render() {\n-    const { config } = this.props;\n+    const { config, handleFormEvent, validationMessage, validationState } = this.props;\n \n     return (\n       <fieldset>\n-        <Input type=\"text\"\n-               id=\"url\"\n-               name=\"url\"\n-               label=\"Lookup URL\"\n-               autoFocus\n-               required\n-               onChange={this.props.handleFormEvent}\n-               help={this.props.validationMessage('url', 'The URL for the lookup. (this is a template - see documentation)')}\n-               bsStyle={this.props.validationState('url')}\n-               value={config.url}\n-               labelClassName=\"col-sm-3\"\n-               wrapperClassName=\"col-sm-9\" />\n+        <URLWhitelistInput label=\"Lookup URL\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "707ed48ac346c0d6d5e085dffa30c9f2f5e5e00f"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM2NjUyNw==", "bodyText": "This is caused by the normal data adapters form validation not the whitelist check.\nData adapter validation happen on OnChange, on any of the field that need to be sent to the backend. Sending the data without any value in the other fields result in some params missing in the data that are sent causing this.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r381366527", "createdAt": "2020-02-19T15:57:03Z", "author": {"login": "ousmaneo"}, "path": "graylog2-web-interface/src/components/lookup-tables/adapters/HTTPJSONPathAdapterFieldSet.jsx", "diffHunk": "@@ -17,46 +18,43 @@ class HTTPJSONPathAdapterFieldSet extends React.Component {\n   state = {};\n \n   onHTTPHeaderUpdate = (headers) => {\n-    const config = ObjectUtils.clone(this.props.config);\n-    config.headers = headers;\n-    this.props.updateConfig(config);\n+    const { config, updateConfig } = this.props;\n+    const configChange = ObjectUtils.clone(config);\n+    configChange.headers = headers;\n+    updateConfig(config);\n   };\n \n   render() {\n-    const { config } = this.props;\n+    const { config, handleFormEvent, validationMessage, validationState } = this.props;\n \n     return (\n       <fieldset>\n-        <Input type=\"text\"\n-               id=\"url\"\n-               name=\"url\"\n-               label=\"Lookup URL\"\n-               autoFocus\n-               required\n-               onChange={this.props.handleFormEvent}\n-               help={this.props.validationMessage('url', 'The URL for the lookup. (this is a template - see documentation)')}\n-               bsStyle={this.props.validationState('url')}\n-               value={config.url}\n-               labelClassName=\"col-sm-3\"\n-               wrapperClassName=\"col-sm-9\" />\n+        <URLWhitelistInput label=\"Lookup URL\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIwNDM1Mg=="}, "originalCommit": {"oid": "707ed48ac346c0d6d5e085dffa30c9f2f5e5e00f"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg5NzQyNw==", "bodyText": "I will create an issue for this", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r381897427", "createdAt": "2020-02-20T10:02:23Z", "author": {"login": "ousmaneo"}, "path": "graylog2-web-interface/src/components/lookup-tables/adapters/HTTPJSONPathAdapterFieldSet.jsx", "diffHunk": "@@ -17,46 +18,43 @@ class HTTPJSONPathAdapterFieldSet extends React.Component {\n   state = {};\n \n   onHTTPHeaderUpdate = (headers) => {\n-    const config = ObjectUtils.clone(this.props.config);\n-    config.headers = headers;\n-    this.props.updateConfig(config);\n+    const { config, updateConfig } = this.props;\n+    const configChange = ObjectUtils.clone(config);\n+    configChange.headers = headers;\n+    updateConfig(config);\n   };\n \n   render() {\n-    const { config } = this.props;\n+    const { config, handleFormEvent, validationMessage, validationState } = this.props;\n \n     return (\n       <fieldset>\n-        <Input type=\"text\"\n-               id=\"url\"\n-               name=\"url\"\n-               label=\"Lookup URL\"\n-               autoFocus\n-               required\n-               onChange={this.props.handleFormEvent}\n-               help={this.props.validationMessage('url', 'The URL for the lookup. (this is a template - see documentation)')}\n-               bsStyle={this.props.validationState('url')}\n-               value={config.url}\n-               labelClassName=\"col-sm-3\"\n-               wrapperClassName=\"col-sm-9\" />\n+        <URLWhitelistInput label=\"Lookup URL\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIwNDM1Mg=="}, "originalCommit": {"oid": "707ed48ac346c0d6d5e085dffa30c9f2f5e5e00f"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MDUyODE4OnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/common/URLWhitelistInput.jsx", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMDozNzoyOVrOFumbNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMDozNjozNlrOFvNKjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQwODM3NQ==", "bodyText": "We should add this component into components/common/index.jsx, so we can import it using the package, like other common components.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r384408375", "createdAt": "2020-02-26T10:37:29Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/common/URLWhitelistInput.jsx", "diffHunk": "@@ -0,0 +1,118 @@\n+// @flow strict\n+import React, { useRef, useState, useEffect } from 'react';\n+import PropTypes from 'prop-types';\n+import { Input } from 'components/bootstrap';\n+import URLWhitelistFormModal from 'components/common/URLWhitelistFormModal';\n+import StoreProvider from 'injection/StoreProvider';\n+import URLUtils from 'util/URLUtils';\n+import FormsUtils from 'util/FormsUtils';\n+\n+const ToolsStore = StoreProvider.getStore('Tools');\n+type Props = {\n+  label: string,\n+  onChange: (event: SyntheticInputEvent<EventTarget>) => void,\n+  validationMessage: string,\n+  validationState: string,\n+  url: string,\n+  labelClassName: string,\n+  wrapperClassName: string,\n+  urlType: string\n+}\n+const URLWhitelistInput = ({ label, onChange, validationMessage, validationState, url, labelClassName, wrapperClassName, urlType }: Props) => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "906ff88951652cfd84ddef6ef72975ffb82267ad"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA0MzA4Nw==", "bodyText": "Done !", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r385043087", "createdAt": "2020-02-27T10:36:36Z", "author": {"login": "ousmaneo"}, "path": "graylog2-web-interface/src/components/common/URLWhitelistInput.jsx", "diffHunk": "@@ -0,0 +1,118 @@\n+// @flow strict\n+import React, { useRef, useState, useEffect } from 'react';\n+import PropTypes from 'prop-types';\n+import { Input } from 'components/bootstrap';\n+import URLWhitelistFormModal from 'components/common/URLWhitelistFormModal';\n+import StoreProvider from 'injection/StoreProvider';\n+import URLUtils from 'util/URLUtils';\n+import FormsUtils from 'util/FormsUtils';\n+\n+const ToolsStore = StoreProvider.getStore('Tools');\n+type Props = {\n+  label: string,\n+  onChange: (event: SyntheticInputEvent<EventTarget>) => void,\n+  validationMessage: string,\n+  validationState: string,\n+  url: string,\n+  labelClassName: string,\n+  wrapperClassName: string,\n+  urlType: string\n+}\n+const URLWhitelistInput = ({ label, onChange, validationMessage, validationState, url, labelClassName, wrapperClassName, urlType }: Props) => {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQwODM3NQ=="}, "originalCommit": {"oid": "906ff88951652cfd84ddef6ef72975ffb82267ad"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MDU2NzA3OnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/common/URLWhitelistInput.jsx", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMDo0ODozMVrOFumzHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMDo0ODozMVrOFumzHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQxNDQ5NQ==", "bodyText": "I think this should not allow any string but list some options. I suggest using probably regex and literal.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r384414495", "createdAt": "2020-02-26T10:48:31Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/common/URLWhitelistInput.jsx", "diffHunk": "@@ -0,0 +1,118 @@\n+// @flow strict\n+import React, { useRef, useState, useEffect } from 'react';\n+import PropTypes from 'prop-types';\n+import { Input } from 'components/bootstrap';\n+import URLWhitelistFormModal from 'components/common/URLWhitelistFormModal';\n+import StoreProvider from 'injection/StoreProvider';\n+import URLUtils from 'util/URLUtils';\n+import FormsUtils from 'util/FormsUtils';\n+\n+const ToolsStore = StoreProvider.getStore('Tools');\n+type Props = {\n+  label: string,\n+  onChange: (event: SyntheticInputEvent<EventTarget>) => void,\n+  validationMessage: string,\n+  validationState: string,\n+  url: string,\n+  labelClassName: string,\n+  wrapperClassName: string,\n+  urlType: string\n+}\n+const URLWhitelistInput = ({ label, onChange, validationMessage, validationState, url, labelClassName, wrapperClassName, urlType }: Props) => {\n+  const [isWhitelisted, setIsWhitelisted] = useState(false);\n+  const [currentValidationState, setCurrentValidationState] = useState(validationState);\n+  const [ownValidationMessage, setOwnValidationMessage] = useState(validationMessage);\n+\n+  const suggestRegexWhitelistUrl = (typedUrl: string, type: string): string | Promise<any> => {\n+    // eslint-disable-next-line no-template-curly-in-string\n+    const keyWildcard = '${key}';\n+    return type && type === 'regex' && URLUtils.isValidURL(typedUrl) ? ToolsStore.urlWhiteListGenerateRegex(typedUrl, keyWildcard) : typedUrl;\n+  };\n+\n+  const [suggestedUrl, setSuggestedUrl] = useState(url);\n+  const isWhitelistError = () => currentValidationState === 'error' && URLUtils.isValidURL(url);\n+  const ref = useRef();\n+\n+  const handleCheckIsWhitelisted = () => {\n+    const promise = ToolsStore.urlWhiteListCheck(url);\n+    promise.then((result) => {\n+      if (!result.is_whitelisted && validationState === null) {\n+        setCurrentValidationState('error');\n+        const message = URLUtils.isValidURL(url) ? `URL ${url} is not whitelisted` : `URL ${url} is not valid URL.`;\n+        setOwnValidationMessage(message);\n+      } else {\n+        setOwnValidationMessage(validationMessage);\n+        setCurrentValidationState(validationState);\n+      }\n+      setIsWhitelisted(result.is_whitelisted);\n+    });\n+  };\n+\n+  const checkIsWhitelisted = () => {\n+    if (url) {\n+      const suggestion = suggestRegexWhitelistUrl(url, urlType);\n+      if (typeof suggestion === 'object') {\n+        suggestion.then((result) => {\n+          setSuggestedUrl(result.regex);\n+          handleCheckIsWhitelisted();\n+        });\n+      } else {\n+        setSuggestedUrl(url);\n+        handleCheckIsWhitelisted();\n+      }\n+    }\n+  };\n+\n+  const onUpdate = () => {\n+    FormsUtils.triggerInput(ref.current);\n+    checkIsWhitelisted();\n+  };\n+\n+  useEffect(() => {\n+    checkIsWhitelisted();\n+  }, [url, validationState]);\n+\n+\n+  const addButton = isWhitelistError() && !isWhitelisted ? <URLWhitelistFormModal newUrlEntry={suggestedUrl} onUpdate={onUpdate} urlType={urlType} /> : '';\n+  const helpMessage = <>{validationState === null ? ownValidationMessage : validationMessage} {addButton}</>;\n+  return (\n+    <Input type=\"text\"\n+           id=\"url\"\n+           name=\"url\"\n+           label={label}\n+           ref={ref}\n+           autoFocus\n+           required\n+           onChange={onChange}\n+           help={helpMessage}\n+           bsStyle={currentValidationState}\n+           value={url}\n+           labelClassName={labelClassName}\n+           wrapperClassName={wrapperClassName} />\n+  );\n+};\n+\n+URLWhitelistInput.propTypes = {\n+  label: PropTypes.string.isRequired,\n+  onChange: PropTypes.func.isRequired,\n+  validationState: PropTypes.string,\n+  validationMessage: PropTypes.oneOfType([\n+    PropTypes.object,\n+    PropTypes.string,\n+  ]),\n+  url: PropTypes.string,\n+  labelClassName: PropTypes.string,\n+  wrapperClassName: PropTypes.string,\n+  urlType: PropTypes.string,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "906ff88951652cfd84ddef6ef72975ffb82267ad"}, "originalPosition": 106}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MDY1MzYxOnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/common/URLWhitelistInput.jsx", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMzoxNzowNFrOFurFMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMzoxNzowNFrOFurFMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ4NDY1OQ==", "bodyText": "After looking at this effect again, I think it should actually be split into two different effects: one computing the suggestedUrl, one doing the whitelist check.\nThat way I think it will be clearer what each effect does, and will also let us do the whitelist check before the suggested URL is computed, since right now it doesn't seem to depend on its result.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r384484659", "createdAt": "2020-02-26T13:17:04Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/common/URLWhitelistInput.jsx", "diffHunk": "@@ -0,0 +1,118 @@\n+// @flow strict\n+import React, { useRef, useState, useEffect } from 'react';\n+import PropTypes from 'prop-types';\n+import { Input } from 'components/bootstrap';\n+import URLWhitelistFormModal from 'components/common/URLWhitelistFormModal';\n+import StoreProvider from 'injection/StoreProvider';\n+import URLUtils from 'util/URLUtils';\n+import FormsUtils from 'util/FormsUtils';\n+\n+const ToolsStore = StoreProvider.getStore('Tools');\n+type Props = {\n+  label: string,\n+  onChange: (event: SyntheticInputEvent<EventTarget>) => void,\n+  validationMessage: string,\n+  validationState: string,\n+  url: string,\n+  labelClassName: string,\n+  wrapperClassName: string,\n+  urlType: string\n+}\n+const URLWhitelistInput = ({ label, onChange, validationMessage, validationState, url, labelClassName, wrapperClassName, urlType }: Props) => {\n+  const [isWhitelisted, setIsWhitelisted] = useState(false);\n+  const [currentValidationState, setCurrentValidationState] = useState(validationState);\n+  const [ownValidationMessage, setOwnValidationMessage] = useState(validationMessage);\n+\n+  const suggestRegexWhitelistUrl = (typedUrl: string, type: string): string | Promise<any> => {\n+    // eslint-disable-next-line no-template-curly-in-string\n+    const keyWildcard = '${key}';\n+    return type && type === 'regex' && URLUtils.isValidURL(typedUrl) ? ToolsStore.urlWhiteListGenerateRegex(typedUrl, keyWildcard) : typedUrl;\n+  };\n+\n+  const [suggestedUrl, setSuggestedUrl] = useState(url);\n+  const isWhitelistError = () => currentValidationState === 'error' && URLUtils.isValidURL(url);\n+  const ref = useRef();\n+\n+  const handleCheckIsWhitelisted = () => {\n+    const promise = ToolsStore.urlWhiteListCheck(url);\n+    promise.then((result) => {\n+      if (!result.is_whitelisted && validationState === null) {\n+        setCurrentValidationState('error');\n+        const message = URLUtils.isValidURL(url) ? `URL ${url} is not whitelisted` : `URL ${url} is not valid URL.`;\n+        setOwnValidationMessage(message);\n+      } else {\n+        setOwnValidationMessage(validationMessage);\n+        setCurrentValidationState(validationState);\n+      }\n+      setIsWhitelisted(result.is_whitelisted);\n+    });\n+  };\n+\n+  const checkIsWhitelisted = () => {\n+    if (url) {\n+      const suggestion = suggestRegexWhitelistUrl(url, urlType);\n+      if (typeof suggestion === 'object') {\n+        suggestion.then((result) => {\n+          setSuggestedUrl(result.regex);\n+          handleCheckIsWhitelisted();\n+        });\n+      } else {\n+        setSuggestedUrl(url);\n+        handleCheckIsWhitelisted();\n+      }\n+    }\n+  };\n+\n+  const onUpdate = () => {\n+    FormsUtils.triggerInput(ref.current);\n+    checkIsWhitelisted();\n+  };\n+\n+  useEffect(() => {\n+    checkIsWhitelisted();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "906ff88951652cfd84ddef6ef72975ffb82267ad"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MTA5NjEzOnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/common/URLWhitelistInput.jsx", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMzozOToyOFrOFurz7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMzozOToyOFrOFurz7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ5NjYyMg==", "bodyText": "I think the checkIsWhitelisted function should be added as dependency of the effect: https://reactjs.org/docs/hooks-faq.html#is-it-safe-to-omit-functions-from-the-list-of-dependencies", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r384496622", "createdAt": "2020-02-26T13:39:28Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/common/URLWhitelistInput.jsx", "diffHunk": "@@ -0,0 +1,118 @@\n+// @flow strict\n+import React, { useRef, useState, useEffect } from 'react';\n+import PropTypes from 'prop-types';\n+import { Input } from 'components/bootstrap';\n+import URLWhitelistFormModal from 'components/common/URLWhitelistFormModal';\n+import StoreProvider from 'injection/StoreProvider';\n+import URLUtils from 'util/URLUtils';\n+import FormsUtils from 'util/FormsUtils';\n+\n+const ToolsStore = StoreProvider.getStore('Tools');\n+type Props = {\n+  label: string,\n+  onChange: (event: SyntheticInputEvent<EventTarget>) => void,\n+  validationMessage: string,\n+  validationState: string,\n+  url: string,\n+  labelClassName: string,\n+  wrapperClassName: string,\n+  urlType: string\n+}\n+const URLWhitelistInput = ({ label, onChange, validationMessage, validationState, url, labelClassName, wrapperClassName, urlType }: Props) => {\n+  const [isWhitelisted, setIsWhitelisted] = useState(false);\n+  const [currentValidationState, setCurrentValidationState] = useState(validationState);\n+  const [ownValidationMessage, setOwnValidationMessage] = useState(validationMessage);\n+\n+  const suggestRegexWhitelistUrl = (typedUrl: string, type: string): string | Promise<any> => {\n+    // eslint-disable-next-line no-template-curly-in-string\n+    const keyWildcard = '${key}';\n+    return type && type === 'regex' && URLUtils.isValidURL(typedUrl) ? ToolsStore.urlWhiteListGenerateRegex(typedUrl, keyWildcard) : typedUrl;\n+  };\n+\n+  const [suggestedUrl, setSuggestedUrl] = useState(url);\n+  const isWhitelistError = () => currentValidationState === 'error' && URLUtils.isValidURL(url);\n+  const ref = useRef();\n+\n+  const handleCheckIsWhitelisted = () => {\n+    const promise = ToolsStore.urlWhiteListCheck(url);\n+    promise.then((result) => {\n+      if (!result.is_whitelisted && validationState === null) {\n+        setCurrentValidationState('error');\n+        const message = URLUtils.isValidURL(url) ? `URL ${url} is not whitelisted` : `URL ${url} is not valid URL.`;\n+        setOwnValidationMessage(message);\n+      } else {\n+        setOwnValidationMessage(validationMessage);\n+        setCurrentValidationState(validationState);\n+      }\n+      setIsWhitelisted(result.is_whitelisted);\n+    });\n+  };\n+\n+  const checkIsWhitelisted = () => {\n+    if (url) {\n+      const suggestion = suggestRegexWhitelistUrl(url, urlType);\n+      if (typeof suggestion === 'object') {\n+        suggestion.then((result) => {\n+          setSuggestedUrl(result.regex);\n+          handleCheckIsWhitelisted();\n+        });\n+      } else {\n+        setSuggestedUrl(url);\n+        handleCheckIsWhitelisted();\n+      }\n+    }\n+  };\n+\n+  const onUpdate = () => {\n+    FormsUtils.triggerInput(ref.current);\n+    checkIsWhitelisted();\n+  };\n+\n+  useEffect(() => {\n+    checkIsWhitelisted();\n+  }, [url, validationState]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "906ff88951652cfd84ddef6ef72975ffb82267ad"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MTQ1MzE4OnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/common/URLWhitelistFormModal.jsx", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNTowODowNFrOFuvPaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNTowODowNFrOFuvPaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU1MjgwOQ==", "bodyText": "I guess we can remove this empty method.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r384552809", "createdAt": "2020-02-26T15:08:04Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/common/URLWhitelistFormModal.jsx", "diffHunk": "@@ -0,0 +1,158 @@\n+// @flow strict\n+import React from 'react';\n+import PropTypes from 'prop-types';\n+import uuid from 'uuid/v4';\n+import connect from 'stores/connect';\n+import { IfPermitted } from 'components/common';\n+import { Button } from 'components/graylog';\n+import BootstrapModalForm from 'components/bootstrap/BootstrapModalForm';\n+import UrlWhiteListForm from 'components/configurations/UrlWhiteListForm';\n+import CombinedProvider from 'injection/CombinedProvider';\n+import PermissionsMixin from 'util/PermissionsMixin';\n+import type { WhiteListConfig } from 'stores/configurations/ConfigurationsStore';\n+\n+const { CurrentUserStore } = CombinedProvider.get('CurrentUser');\n+const { ConfigurationsActions, ConfigurationsStore } = CombinedProvider.get('Configurations');\n+\n+const URL_WHITELIST_CONFIG = 'org.graylog2.system.urlwhitelist.UrlWhitelist';\n+\n+type State = {\n+  config: WhiteListConfig,\n+  isValid: boolean\n+};\n+\n+type Props = {\n+  newUrlEntry: string,\n+  onUpdate: () => void,\n+  configuration: {},\n+  currentUser: {permissions: Array<string>},\n+  urlType: string,\n+};\n+\n+\n+class URLWhitelistFormModal extends React.Component<Props, State> {\n+    configModal: ?BootstrapModalForm = React.createRef();\n+\n+    inputs = {};\n+\n+    static defaultProps = {\n+      newUrlEntry: '',\n+      onUpdate: () => {},\n+      configuration: {},\n+      urlType: '',\n+    }\n+\n+    constructor(props) {\n+      super(props);\n+      this.state = {\n+        config: { entries: [], disabled: false },\n+        isValid: false,\n+      };\n+      this.configModal = React.createRef();\n+    }\n+\n+    componentDidMount() {\n+      const { currentUser: { permissions } } = this.props;\n+      if (PermissionsMixin.isPermitted(permissions, ['urlwhitelist:read'])) {\n+        ConfigurationsActions.listWhiteListConfig(URL_WHITELIST_CONFIG);\n+      }\n+    }\n+\n+\n+  _getConfig = (configType: string) => {\n+    const { configuration } = this.props;\n+    if (configuration && configuration[configType]) {\n+      return configuration[configType];\n+    }\n+    return null;\n+  }\n+\n+  _openModal = () => {\n+    if (this.configModal) {\n+      this.configModal.current.open();\n+    }\n+  }\n+\n+  _closeModal = () => {\n+    if (this.configModal) {\n+      this.configModal.current.close();\n+    }\n+  }\n+\n+  _saveConfig = (event) => {\n+    if (event) {\n+      event.preventDefault();\n+      event.stopPropagation();\n+    }\n+    const { onUpdate } = this.props;\n+    const { config, isValid } = this.state;\n+    if (isValid) {\n+      this._updateConfig(URL_WHITELIST_CONFIG, config).then(() => {\n+        onUpdate();\n+        this._closeModal();\n+      });\n+    }\n+  }\n+\n+  _update = (config, isValid) => {\n+    const updatedState = { config, isValid };\n+    this.setState(updatedState);\n+  }\n+\n+\n+  _resetConfig = () => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "906ff88951652cfd84ddef6ef72975ffb82267ad"}, "originalPosition": 103}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MTUyNzc1OnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/common/URLWhitelistFormModal.jsx", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNToyNDo0NVrOFuv9XQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNToyNDo0NVrOFuv9XQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU2NDU3Mw==", "bodyText": "For what I could understand about this component, URLWhitelistFormModal is holding the current state of the whitelist entries, but those are generated from props on render time and they only come into the state when URLWhitelistForm's onUpdate is called.\nThat works, but I think it goes against the React way of using a one-way data flow in your component hierarchy. I think initializing and keeping an up-to-date config state here would help us not relying on a child component updating to get the right state in this component.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r384564573", "createdAt": "2020-02-26T15:24:45Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/common/URLWhitelistFormModal.jsx", "diffHunk": "@@ -0,0 +1,158 @@\n+// @flow strict\n+import React from 'react';\n+import PropTypes from 'prop-types';\n+import uuid from 'uuid/v4';\n+import connect from 'stores/connect';\n+import { IfPermitted } from 'components/common';\n+import { Button } from 'components/graylog';\n+import BootstrapModalForm from 'components/bootstrap/BootstrapModalForm';\n+import UrlWhiteListForm from 'components/configurations/UrlWhiteListForm';\n+import CombinedProvider from 'injection/CombinedProvider';\n+import PermissionsMixin from 'util/PermissionsMixin';\n+import type { WhiteListConfig } from 'stores/configurations/ConfigurationsStore';\n+\n+const { CurrentUserStore } = CombinedProvider.get('CurrentUser');\n+const { ConfigurationsActions, ConfigurationsStore } = CombinedProvider.get('Configurations');\n+\n+const URL_WHITELIST_CONFIG = 'org.graylog2.system.urlwhitelist.UrlWhitelist';\n+\n+type State = {\n+  config: WhiteListConfig,\n+  isValid: boolean\n+};\n+\n+type Props = {\n+  newUrlEntry: string,\n+  onUpdate: () => void,\n+  configuration: {},\n+  currentUser: {permissions: Array<string>},\n+  urlType: string,\n+};\n+\n+\n+class URLWhitelistFormModal extends React.Component<Props, State> {\n+    configModal: ?BootstrapModalForm = React.createRef();\n+\n+    inputs = {};\n+\n+    static defaultProps = {\n+      newUrlEntry: '',\n+      onUpdate: () => {},\n+      configuration: {},\n+      urlType: '',\n+    }\n+\n+    constructor(props) {\n+      super(props);\n+      this.state = {\n+        config: { entries: [], disabled: false },", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "906ff88951652cfd84ddef6ef72975ffb82267ad"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMTA0Nzg4OnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/common/URLWhiteListFormModal.jsx", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMDowNToxNlrOFxm_Gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMDowNToxNlrOFxm_Gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU2MzI5MQ==", "bodyText": "This should also reflect the more strict values for urlType.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              urlType: string,\n          \n          \n            \n              urlType: 'regex' | 'literal',", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r387563291", "createdAt": "2020-03-04T10:05:16Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/common/URLWhiteListFormModal.jsx", "diffHunk": "@@ -0,0 +1,172 @@\n+// @flow strict\n+import React from 'react';\n+import PropTypes from 'prop-types';\n+import uuid from 'uuid/v4';\n+import connect from 'stores/connect';\n+import { Button } from 'components/graylog';\n+import BootstrapModalForm from 'components/bootstrap/BootstrapModalForm';\n+import UrlWhiteListForm from 'components/configurations/UrlWhiteListForm';\n+import CombinedProvider from 'injection/CombinedProvider';\n+import PermissionsMixin from 'util/PermissionsMixin';\n+import type { WhiteListConfig } from 'stores/configurations/ConfigurationsStore';\n+import IfPermitted from 'components/common/IfPermitted';\n+\n+const { CurrentUserStore } = CombinedProvider.get('CurrentUser');\n+const { ConfigurationsActions, ConfigurationsStore } = CombinedProvider.get('Configurations');\n+\n+const URL_WHITELIST_CONFIG = 'org.graylog2.system.urlwhitelist.UrlWhitelist';\n+\n+type State = {\n+  config: WhiteListConfig,\n+  isValid: boolean\n+};\n+\n+type Props = {\n+  newUrlEntry: string,\n+  onUpdate: () => void,\n+  configuration: {},\n+  currentUser: {permissions: Array<string>},\n+  urlType: string,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be9c5553ba3682b76158c891d40e6f223e129bbc"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMTExOTc1OnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/common/URLWhiteListInput.jsx", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMDoyNTo0MlrOFxnseQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwOTozMzo1NlrOFyMQKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3NDkwNQ==", "bodyText": "I would personally use lodash' debounce function to make clearer what we do here (and also removes the need for a clean-up function). This is a personal preference, though, so feel free to ignore it.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r387574905", "createdAt": "2020-03-04T10:25:42Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/common/URLWhiteListInput.jsx", "diffHunk": "@@ -0,0 +1,124 @@\n+// @flow strict\n+import React, { useRef, useState, useEffect } from 'react';\n+import PropTypes from 'prop-types';\n+import { Input } from 'components/bootstrap';\n+import StoreProvider from 'injection/StoreProvider';\n+import URLUtils from 'util/URLUtils';\n+import FormsUtils from 'util/FormsUtils';\n+import URLWhiteListFormModal from 'components/common/URLWhiteListFormModal';\n+\n+const ToolsStore = StoreProvider.getStore('Tools');\n+type Props = {\n+  label: string,\n+  onChange: (event: SyntheticInputEvent<EventTarget>) => void,\n+  validationMessage: string,\n+  validationState: string,\n+  url: string,\n+  labelClassName: string,\n+  wrapperClassName: string,\n+  urlType: string\n+}\n+const URLWhiteListInput = ({ label, onChange, validationMessage, validationState, url, labelClassName, wrapperClassName, urlType }: Props) => {\n+  const [isWhitelisted, setIsWhitelisted] = useState(false);\n+  const [currentValidationState, setCurrentValidationState] = useState(validationState);\n+  const [ownValidationMessage, setOwnValidationMessage] = useState(validationMessage);\n+\n+  const suggestRegexWhitelistUrl = (typedUrl: string, type: string): string | Promise<any> => {\n+    // eslint-disable-next-line no-template-curly-in-string\n+    const keyWildcard = '${key}';\n+    return type && type === 'regex' && URLUtils.isValidURL(typedUrl) ? ToolsStore.urlWhiteListGenerateRegex(typedUrl, keyWildcard) : typedUrl;\n+  };\n+\n+  const [suggestedUrl, setSuggestedUrl] = useState(url);\n+  const isWhitelistError = () => currentValidationState === 'error' && URLUtils.isValidURL(url);\n+  const ref = useRef();\n+\n+  const checkIsWhitelisted = () => {\n+    if (url) {\n+      const promise = ToolsStore.urlWhiteListCheck(url);\n+      promise.then((result) => {\n+        if (!result.is_whitelisted && validationState === null) {\n+          setCurrentValidationState('error');\n+          const message = URLUtils.isValidURL(url) ? `URL ${url} is not whitelisted` : `URL ${url} is not valid URL.`;\n+          setOwnValidationMessage(message);\n+        } else {\n+          setOwnValidationMessage(validationMessage);\n+          setCurrentValidationState(validationState);\n+        }\n+        setIsWhitelisted(result.is_whitelisted);\n+      });\n+    }\n+  };\n+\n+\n+  const onUpdate = () => {\n+    FormsUtils.triggerInput(ref.current);\n+    checkIsWhitelisted();\n+  };\n+\n+  useEffect(() => {\n+    const checkSuggestion = () => {\n+      if (url) {\n+        const suggestion = suggestRegexWhitelistUrl(url, urlType);\n+        if (typeof suggestion === 'object') {\n+          suggestion.then((result) => {\n+            setSuggestedUrl(result.regex);\n+          });\n+        } else {\n+          setSuggestedUrl(url);\n+        }\n+      }\n+    };\n+    const timer = setTimeout(() => checkSuggestion(), 500);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be9c5553ba3682b76158c891d40e6f223e129bbc"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3NDk1Ng==", "bodyText": "I think we should make the timeout a bit shorter, in other places we set it to 200 or 250 milliseconds, so the results appear a bit faster and we still don't fire on every change.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r387574956", "createdAt": "2020-03-04T10:25:47Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/common/URLWhiteListInput.jsx", "diffHunk": "@@ -0,0 +1,124 @@\n+// @flow strict\n+import React, { useRef, useState, useEffect } from 'react';\n+import PropTypes from 'prop-types';\n+import { Input } from 'components/bootstrap';\n+import StoreProvider from 'injection/StoreProvider';\n+import URLUtils from 'util/URLUtils';\n+import FormsUtils from 'util/FormsUtils';\n+import URLWhiteListFormModal from 'components/common/URLWhiteListFormModal';\n+\n+const ToolsStore = StoreProvider.getStore('Tools');\n+type Props = {\n+  label: string,\n+  onChange: (event: SyntheticInputEvent<EventTarget>) => void,\n+  validationMessage: string,\n+  validationState: string,\n+  url: string,\n+  labelClassName: string,\n+  wrapperClassName: string,\n+  urlType: string\n+}\n+const URLWhiteListInput = ({ label, onChange, validationMessage, validationState, url, labelClassName, wrapperClassName, urlType }: Props) => {\n+  const [isWhitelisted, setIsWhitelisted] = useState(false);\n+  const [currentValidationState, setCurrentValidationState] = useState(validationState);\n+  const [ownValidationMessage, setOwnValidationMessage] = useState(validationMessage);\n+\n+  const suggestRegexWhitelistUrl = (typedUrl: string, type: string): string | Promise<any> => {\n+    // eslint-disable-next-line no-template-curly-in-string\n+    const keyWildcard = '${key}';\n+    return type && type === 'regex' && URLUtils.isValidURL(typedUrl) ? ToolsStore.urlWhiteListGenerateRegex(typedUrl, keyWildcard) : typedUrl;\n+  };\n+\n+  const [suggestedUrl, setSuggestedUrl] = useState(url);\n+  const isWhitelistError = () => currentValidationState === 'error' && URLUtils.isValidURL(url);\n+  const ref = useRef();\n+\n+  const checkIsWhitelisted = () => {\n+    if (url) {\n+      const promise = ToolsStore.urlWhiteListCheck(url);\n+      promise.then((result) => {\n+        if (!result.is_whitelisted && validationState === null) {\n+          setCurrentValidationState('error');\n+          const message = URLUtils.isValidURL(url) ? `URL ${url} is not whitelisted` : `URL ${url} is not valid URL.`;\n+          setOwnValidationMessage(message);\n+        } else {\n+          setOwnValidationMessage(validationMessage);\n+          setCurrentValidationState(validationState);\n+        }\n+        setIsWhitelisted(result.is_whitelisted);\n+      });\n+    }\n+  };\n+\n+\n+  const onUpdate = () => {\n+    FormsUtils.triggerInput(ref.current);\n+    checkIsWhitelisted();\n+  };\n+\n+  useEffect(() => {\n+    const checkSuggestion = () => {\n+      if (url) {\n+        const suggestion = suggestRegexWhitelistUrl(url, urlType);\n+        if (typeof suggestion === 'object') {\n+          suggestion.then((result) => {\n+            setSuggestedUrl(result.regex);\n+          });\n+        } else {\n+          setSuggestedUrl(url);\n+        }\n+      }\n+    };\n+    const timer = setTimeout(() => checkSuggestion(), 500);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3NDkwNQ=="}, "originalCommit": {"oid": "be9c5553ba3682b76158c891d40e6f223e129bbc"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE3Mzg2NQ==", "bodyText": "I changed the timeout to 250 milliseconds, But as for the lodash debounce it was my first choice but it does not seems to work in React functional component, wrapping it with useCallback hook also does not help too.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r388173865", "createdAt": "2020-03-05T09:33:56Z", "author": {"login": "ousmaneo"}, "path": "graylog2-web-interface/src/components/common/URLWhiteListInput.jsx", "diffHunk": "@@ -0,0 +1,124 @@\n+// @flow strict\n+import React, { useRef, useState, useEffect } from 'react';\n+import PropTypes from 'prop-types';\n+import { Input } from 'components/bootstrap';\n+import StoreProvider from 'injection/StoreProvider';\n+import URLUtils from 'util/URLUtils';\n+import FormsUtils from 'util/FormsUtils';\n+import URLWhiteListFormModal from 'components/common/URLWhiteListFormModal';\n+\n+const ToolsStore = StoreProvider.getStore('Tools');\n+type Props = {\n+  label: string,\n+  onChange: (event: SyntheticInputEvent<EventTarget>) => void,\n+  validationMessage: string,\n+  validationState: string,\n+  url: string,\n+  labelClassName: string,\n+  wrapperClassName: string,\n+  urlType: string\n+}\n+const URLWhiteListInput = ({ label, onChange, validationMessage, validationState, url, labelClassName, wrapperClassName, urlType }: Props) => {\n+  const [isWhitelisted, setIsWhitelisted] = useState(false);\n+  const [currentValidationState, setCurrentValidationState] = useState(validationState);\n+  const [ownValidationMessage, setOwnValidationMessage] = useState(validationMessage);\n+\n+  const suggestRegexWhitelistUrl = (typedUrl: string, type: string): string | Promise<any> => {\n+    // eslint-disable-next-line no-template-curly-in-string\n+    const keyWildcard = '${key}';\n+    return type && type === 'regex' && URLUtils.isValidURL(typedUrl) ? ToolsStore.urlWhiteListGenerateRegex(typedUrl, keyWildcard) : typedUrl;\n+  };\n+\n+  const [suggestedUrl, setSuggestedUrl] = useState(url);\n+  const isWhitelistError = () => currentValidationState === 'error' && URLUtils.isValidURL(url);\n+  const ref = useRef();\n+\n+  const checkIsWhitelisted = () => {\n+    if (url) {\n+      const promise = ToolsStore.urlWhiteListCheck(url);\n+      promise.then((result) => {\n+        if (!result.is_whitelisted && validationState === null) {\n+          setCurrentValidationState('error');\n+          const message = URLUtils.isValidURL(url) ? `URL ${url} is not whitelisted` : `URL ${url} is not valid URL.`;\n+          setOwnValidationMessage(message);\n+        } else {\n+          setOwnValidationMessage(validationMessage);\n+          setCurrentValidationState(validationState);\n+        }\n+        setIsWhitelisted(result.is_whitelisted);\n+      });\n+    }\n+  };\n+\n+\n+  const onUpdate = () => {\n+    FormsUtils.triggerInput(ref.current);\n+    checkIsWhitelisted();\n+  };\n+\n+  useEffect(() => {\n+    const checkSuggestion = () => {\n+      if (url) {\n+        const suggestion = suggestRegexWhitelistUrl(url, urlType);\n+        if (typeof suggestion === 'object') {\n+          suggestion.then((result) => {\n+            setSuggestedUrl(result.regex);\n+          });\n+        } else {\n+          setSuggestedUrl(url);\n+        }\n+      }\n+    };\n+    const timer = setTimeout(() => checkSuggestion(), 500);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3NDkwNQ=="}, "originalCommit": {"oid": "be9c5553ba3682b76158c891d40e6f223e129bbc"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMTEyMDU5OnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/common/URLWhiteListInput.jsx", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMDoyNTo1NFrOFxntAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMDoyNTo1NFrOFxntAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3NTA0Mg==", "bodyText": "Same as above", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r387575042", "createdAt": "2020-03-04T10:25:54Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/common/URLWhiteListInput.jsx", "diffHunk": "@@ -0,0 +1,124 @@\n+// @flow strict\n+import React, { useRef, useState, useEffect } from 'react';\n+import PropTypes from 'prop-types';\n+import { Input } from 'components/bootstrap';\n+import StoreProvider from 'injection/StoreProvider';\n+import URLUtils from 'util/URLUtils';\n+import FormsUtils from 'util/FormsUtils';\n+import URLWhiteListFormModal from 'components/common/URLWhiteListFormModal';\n+\n+const ToolsStore = StoreProvider.getStore('Tools');\n+type Props = {\n+  label: string,\n+  onChange: (event: SyntheticInputEvent<EventTarget>) => void,\n+  validationMessage: string,\n+  validationState: string,\n+  url: string,\n+  labelClassName: string,\n+  wrapperClassName: string,\n+  urlType: string\n+}\n+const URLWhiteListInput = ({ label, onChange, validationMessage, validationState, url, labelClassName, wrapperClassName, urlType }: Props) => {\n+  const [isWhitelisted, setIsWhitelisted] = useState(false);\n+  const [currentValidationState, setCurrentValidationState] = useState(validationState);\n+  const [ownValidationMessage, setOwnValidationMessage] = useState(validationMessage);\n+\n+  const suggestRegexWhitelistUrl = (typedUrl: string, type: string): string | Promise<any> => {\n+    // eslint-disable-next-line no-template-curly-in-string\n+    const keyWildcard = '${key}';\n+    return type && type === 'regex' && URLUtils.isValidURL(typedUrl) ? ToolsStore.urlWhiteListGenerateRegex(typedUrl, keyWildcard) : typedUrl;\n+  };\n+\n+  const [suggestedUrl, setSuggestedUrl] = useState(url);\n+  const isWhitelistError = () => currentValidationState === 'error' && URLUtils.isValidURL(url);\n+  const ref = useRef();\n+\n+  const checkIsWhitelisted = () => {\n+    if (url) {\n+      const promise = ToolsStore.urlWhiteListCheck(url);\n+      promise.then((result) => {\n+        if (!result.is_whitelisted && validationState === null) {\n+          setCurrentValidationState('error');\n+          const message = URLUtils.isValidURL(url) ? `URL ${url} is not whitelisted` : `URL ${url} is not valid URL.`;\n+          setOwnValidationMessage(message);\n+        } else {\n+          setOwnValidationMessage(validationMessage);\n+          setCurrentValidationState(validationState);\n+        }\n+        setIsWhitelisted(result.is_whitelisted);\n+      });\n+    }\n+  };\n+\n+\n+  const onUpdate = () => {\n+    FormsUtils.triggerInput(ref.current);\n+    checkIsWhitelisted();\n+  };\n+\n+  useEffect(() => {\n+    const checkSuggestion = () => {\n+      if (url) {\n+        const suggestion = suggestRegexWhitelistUrl(url, urlType);\n+        if (typeof suggestion === 'object') {\n+          suggestion.then((result) => {\n+            setSuggestedUrl(result.regex);\n+          });\n+        } else {\n+          setSuggestedUrl(url);\n+        }\n+      }\n+    };\n+    const timer = setTimeout(() => checkSuggestion(), 500);\n+    return () => clearTimeout(timer);\n+  }, [url]);\n+\n+  useEffect(() => {\n+    const timer = setTimeout(() => checkIsWhitelisted(), 500);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be9c5553ba3682b76158c891d40e6f223e129bbc"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMTEzMjE0OnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/common/URLWhiteListFormModal.jsx", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMDoyOTowOFrOFxn0JQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMzowODoyNVrOFy4GYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3Njg2OQ==", "bodyText": "We usually do module imports from components/common, so I would prefer\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import IfPermitted from 'components/common/IfPermitted';\n          \n          \n            \n            import { IfPermitted } from 'components/common';", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r387576869", "createdAt": "2020-03-04T10:29:08Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/common/URLWhiteListFormModal.jsx", "diffHunk": "@@ -0,0 +1,172 @@\n+// @flow strict\n+import React from 'react';\n+import PropTypes from 'prop-types';\n+import uuid from 'uuid/v4';\n+import connect from 'stores/connect';\n+import { Button } from 'components/graylog';\n+import BootstrapModalForm from 'components/bootstrap/BootstrapModalForm';\n+import UrlWhiteListForm from 'components/configurations/UrlWhiteListForm';\n+import CombinedProvider from 'injection/CombinedProvider';\n+import PermissionsMixin from 'util/PermissionsMixin';\n+import type { WhiteListConfig } from 'stores/configurations/ConfigurationsStore';\n+import IfPermitted from 'components/common/IfPermitted';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be9c5553ba3682b76158c891d40e6f223e129bbc"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg5MjI1OQ==", "bodyText": "As in UrlWhiteListForm, let's add a comment about the import style.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r388892259", "createdAt": "2020-03-06T13:08:25Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/common/URLWhiteListFormModal.jsx", "diffHunk": "@@ -0,0 +1,172 @@\n+// @flow strict\n+import React from 'react';\n+import PropTypes from 'prop-types';\n+import uuid from 'uuid/v4';\n+import connect from 'stores/connect';\n+import { Button } from 'components/graylog';\n+import BootstrapModalForm from 'components/bootstrap/BootstrapModalForm';\n+import UrlWhiteListForm from 'components/configurations/UrlWhiteListForm';\n+import CombinedProvider from 'injection/CombinedProvider';\n+import PermissionsMixin from 'util/PermissionsMixin';\n+import type { WhiteListConfig } from 'stores/configurations/ConfigurationsStore';\n+import IfPermitted from 'components/common/IfPermitted';", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3Njg2OQ=="}, "originalCommit": {"oid": "be9c5553ba3682b76158c891d40e6f223e129bbc"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMTE0NTE0OnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/common/URLWhiteListFormModal.jsx", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMDozMjo1OVrOFxn8Zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwOTozNToyOVrOFyMTlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3ODk4Mw==", "bodyText": "There's an extra empty line here :)", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r387578983", "createdAt": "2020-03-04T10:32:59Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/common/URLWhiteListFormModal.jsx", "diffHunk": "@@ -0,0 +1,172 @@\n+// @flow strict\n+import React from 'react';\n+import PropTypes from 'prop-types';\n+import uuid from 'uuid/v4';\n+import connect from 'stores/connect';\n+import { Button } from 'components/graylog';\n+import BootstrapModalForm from 'components/bootstrap/BootstrapModalForm';\n+import UrlWhiteListForm from 'components/configurations/UrlWhiteListForm';\n+import CombinedProvider from 'injection/CombinedProvider';\n+import PermissionsMixin from 'util/PermissionsMixin';\n+import type { WhiteListConfig } from 'stores/configurations/ConfigurationsStore';\n+import IfPermitted from 'components/common/IfPermitted';\n+\n+const { CurrentUserStore } = CombinedProvider.get('CurrentUser');\n+const { ConfigurationsActions, ConfigurationsStore } = CombinedProvider.get('Configurations');\n+\n+const URL_WHITELIST_CONFIG = 'org.graylog2.system.urlwhitelist.UrlWhitelist';\n+\n+type State = {\n+  config: WhiteListConfig,\n+  isValid: boolean\n+};\n+\n+type Props = {\n+  newUrlEntry: string,\n+  onUpdate: () => void,\n+  configuration: {},\n+  currentUser: {permissions: Array<string>},\n+  urlType: string,\n+};\n+\n+\n+class URLWhiteListFormModal extends React.Component<Props, State> {\n+    configModal: ?BootstrapModalForm = React.createRef();\n+\n+    inputs = {};\n+\n+    static defaultProps = {\n+      newUrlEntry: '',\n+      onUpdate: () => {},\n+      configuration: {},\n+      urlType: '',\n+    }\n+\n+    constructor(props) {\n+      super(props);\n+      this.state = {\n+        config: { entries: [], disabled: false },\n+        isValid: false,\n+      };\n+      this.configModal = React.createRef();\n+    }\n+\n+    componentDidMount() {\n+      const { currentUser: { permissions } } = this.props;\n+      if (PermissionsMixin.isPermitted(permissions, ['urlwhitelist:read'])) {\n+        ConfigurationsActions.listWhiteListConfig(URL_WHITELIST_CONFIG);\n+      }\n+    }\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be9c5553ba3682b76158c891d40e6f223e129bbc"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE3NDc0MA==", "bodyText": "+1", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r388174740", "createdAt": "2020-03-05T09:35:29Z", "author": {"login": "ousmaneo"}, "path": "graylog2-web-interface/src/components/common/URLWhiteListFormModal.jsx", "diffHunk": "@@ -0,0 +1,172 @@\n+// @flow strict\n+import React from 'react';\n+import PropTypes from 'prop-types';\n+import uuid from 'uuid/v4';\n+import connect from 'stores/connect';\n+import { Button } from 'components/graylog';\n+import BootstrapModalForm from 'components/bootstrap/BootstrapModalForm';\n+import UrlWhiteListForm from 'components/configurations/UrlWhiteListForm';\n+import CombinedProvider from 'injection/CombinedProvider';\n+import PermissionsMixin from 'util/PermissionsMixin';\n+import type { WhiteListConfig } from 'stores/configurations/ConfigurationsStore';\n+import IfPermitted from 'components/common/IfPermitted';\n+\n+const { CurrentUserStore } = CombinedProvider.get('CurrentUser');\n+const { ConfigurationsActions, ConfigurationsStore } = CombinedProvider.get('Configurations');\n+\n+const URL_WHITELIST_CONFIG = 'org.graylog2.system.urlwhitelist.UrlWhitelist';\n+\n+type State = {\n+  config: WhiteListConfig,\n+  isValid: boolean\n+};\n+\n+type Props = {\n+  newUrlEntry: string,\n+  onUpdate: () => void,\n+  configuration: {},\n+  currentUser: {permissions: Array<string>},\n+  urlType: string,\n+};\n+\n+\n+class URLWhiteListFormModal extends React.Component<Props, State> {\n+    configModal: ?BootstrapModalForm = React.createRef();\n+\n+    inputs = {};\n+\n+    static defaultProps = {\n+      newUrlEntry: '',\n+      onUpdate: () => {},\n+      configuration: {},\n+      urlType: '',\n+    }\n+\n+    constructor(props) {\n+      super(props);\n+      this.state = {\n+        config: { entries: [], disabled: false },\n+        isValid: false,\n+      };\n+      this.configModal = React.createRef();\n+    }\n+\n+    componentDidMount() {\n+      const { currentUser: { permissions } } = this.props;\n+      if (PermissionsMixin.isPermitted(permissions, ['urlwhitelist:read'])) {\n+        ConfigurationsActions.listWhiteListConfig(URL_WHITELIST_CONFIG);\n+      }\n+    }\n+\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3ODk4Mw=="}, "originalCommit": {"oid": "be9c5553ba3682b76158c891d40e6f223e129bbc"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMTIyNzkwOnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/configurations/UrlWhiteListForm.jsx", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMDo1NzozNFrOFxov6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMzowNzo1NlrOFy4FkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU5MjE3MQ==", "bodyText": "We usually do module imports from components/common, which would let us write these two imports in a more concise way.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r387592171", "createdAt": "2020-03-04T10:57:34Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/configurations/UrlWhiteListForm.jsx", "diffHunk": "@@ -4,7 +4,8 @@ import PropTypes from 'prop-types';\n import uuid from 'uuid/v4';\n import { cloneDeep, debounce } from 'lodash';\n import Input from 'components/bootstrap/Input';\n-import { Select, Icon } from 'components/common';\n+import Select from 'components/common/Select';\n+import Icon from 'components/common/Icon';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be9c5553ba3682b76158c891d40e6f223e129bbc"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE4MDEyNA==", "bodyText": "That's what I was using but it resulted into eslint no circular dependency and I fixed it by having these self references explicit.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r388180124", "createdAt": "2020-03-05T09:44:56Z", "author": {"login": "ousmaneo"}, "path": "graylog2-web-interface/src/components/configurations/UrlWhiteListForm.jsx", "diffHunk": "@@ -4,7 +4,8 @@ import PropTypes from 'prop-types';\n import uuid from 'uuid/v4';\n import { cloneDeep, debounce } from 'lodash';\n import Input from 'components/bootstrap/Input';\n-import { Select, Icon } from 'components/common';\n+import Select from 'components/common/Select';\n+import Icon from 'components/common/Icon';", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU5MjE3MQ=="}, "originalCommit": {"oid": "be9c5553ba3682b76158c891d40e6f223e129bbc"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg5MjA0OQ==", "bodyText": "Alright, let's add a comment before them to clarify that.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r388892049", "createdAt": "2020-03-06T13:07:56Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/configurations/UrlWhiteListForm.jsx", "diffHunk": "@@ -4,7 +4,8 @@ import PropTypes from 'prop-types';\n import uuid from 'uuid/v4';\n import { cloneDeep, debounce } from 'lodash';\n import Input from 'components/bootstrap/Input';\n-import { Select, Icon } from 'components/common';\n+import Select from 'components/common/Select';\n+import Icon from 'components/common/Icon';", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU5MjE3MQ=="}, "originalCommit": {"oid": "be9c5553ba3682b76158c891d40e6f223e129bbc"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMTI2MTQxOnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/common/URLWhitelistFormModal.jsx", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMTowODozN1rOFxpFUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMzoxMDoxOFrOFy4Jlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU5NzY0OA==", "bodyText": "I still think this function (or a strip down version of it) should be called from the constructor, so the initial state comes from the given props and it's not empty.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r387597648", "createdAt": "2020-03-04T11:08:37Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/common/URLWhitelistFormModal.jsx", "diffHunk": "@@ -59,7 +59,22 @@ class URLWhiteListFormModal extends React.Component<Props, State> {\n     }\n \n \n-  _getConfig = (configType: string) => {\n+    componentDidUpdate() {\n+      const { config: { entries } } = this.state;\n+      const urlwhitelistConfig = this._getConfig(URL_WHITELIST_CONFIG);\n+      if (urlwhitelistConfig && entries.length === 0) {\n+        this._setDefaultWhiteListState(urlwhitelistConfig);\n+      }\n+    }\n+\n+  _setDefaultWhiteListState =(urlwhitelistConfig) => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afa81c140e4302a47c37c605be4509bc0c019e4d"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg5MzA3OQ==", "bodyText": "As we discussed, the data is fetched in componentDidMount() and setting a default state until then is fine.", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r388893079", "createdAt": "2020-03-06T13:10:18Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/common/URLWhitelistFormModal.jsx", "diffHunk": "@@ -59,7 +59,22 @@ class URLWhiteListFormModal extends React.Component<Props, State> {\n     }\n \n \n-  _getConfig = (configType: string) => {\n+    componentDidUpdate() {\n+      const { config: { entries } } = this.state;\n+      const urlwhitelistConfig = this._getConfig(URL_WHITELIST_CONFIG);\n+      if (urlwhitelistConfig && entries.length === 0) {\n+        this._setDefaultWhiteListState(urlwhitelistConfig);\n+      }\n+    }\n+\n+  _setDefaultWhiteListState =(urlwhitelistConfig) => {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU5NzY0OA=="}, "originalCommit": {"oid": "afa81c140e4302a47c37c605be4509bc0c019e4d"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxOTA0NjE4OnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/common/URLWhiteListInput.jsx", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNDoxNzoyOVrOF0Qzfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNDoxNzoyOVrOF0Qzfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM0NTU5OQ==", "bodyText": "Nitpick:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      const message = isValidURL(url) ? `URL ${url} is not whitelisted` : `URL ${url} is not valid URL.`;\n          \n          \n            \n                      const message = isValidURL(url) ? `URL ${url} is not whitelisted` : `URL ${url} is not a valid URL.`;", "url": "https://github.com/Graylog2/graylog2-server/pull/7275#discussion_r390345599", "createdAt": "2020-03-10T14:17:29Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/common/URLWhiteListInput.jsx", "diffHunk": "@@ -0,0 +1,125 @@\n+// @flow strict\n+import React, { useRef, useState, useEffect } from 'react';\n+import PropTypes from 'prop-types';\n+import { Input } from 'components/bootstrap';\n+import StoreProvider from 'injection/StoreProvider';\n+import { isValidURL } from 'util/URLUtils';\n+import FormsUtils from 'util/FormsUtils';\n+// Explicit import to fix eslint import/no-cycle\n+import URLWhiteListFormModal from 'components/common/URLWhiteListFormModal';\n+\n+const ToolsStore = StoreProvider.getStore('Tools');\n+type Props = {\n+  label: string,\n+  onChange: (event: SyntheticInputEvent<EventTarget>) => void,\n+  validationMessage: string,\n+  validationState: string,\n+  url: string,\n+  labelClassName: string,\n+  wrapperClassName: string,\n+  urlType: string\n+}\n+const URLWhiteListInput = ({ label, onChange, validationMessage, validationState, url, labelClassName, wrapperClassName, urlType }: Props) => {\n+  const [isWhitelisted, setIsWhitelisted] = useState(false);\n+  const [currentValidationState, setCurrentValidationState] = useState(validationState);\n+  const [ownValidationMessage, setOwnValidationMessage] = useState(validationMessage);\n+\n+  const suggestRegexWhitelistUrl = (typedUrl: string, type: string): string | Promise<any> => {\n+    // eslint-disable-next-line no-template-curly-in-string\n+    const keyWildcard = '${key}';\n+    return type && type === 'regex' && isValidURL(typedUrl) ? ToolsStore.urlWhiteListGenerateRegex(typedUrl, keyWildcard) : typedUrl;\n+  };\n+\n+  const [suggestedUrl, setSuggestedUrl] = useState(url);\n+  const isWhitelistError = () => currentValidationState === 'error' && isValidURL(url);\n+  const ref = useRef();\n+\n+  const checkIsWhitelisted = () => {\n+    if (url) {\n+      const promise = ToolsStore.urlWhiteListCheck(url);\n+      promise.then((result) => {\n+        if (!result.is_whitelisted && validationState === null) {\n+          setCurrentValidationState('error');\n+          const message = isValidURL(url) ? `URL ${url} is not whitelisted` : `URL ${url} is not valid URL.`;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd0038de776c60a049d778092210f97f463c2045"}, "originalPosition": 43}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3941, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}