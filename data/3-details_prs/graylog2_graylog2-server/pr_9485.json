{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwNjIxMTkz", "number": 9485, "title": "Finish support for multiple LDAP / AD servers", "bodyText": "Add support to verify against multiple hosts in DefaultX509TrustManager\n\n\nmodify connection test to support and test multiple servers\n\n\nremove validation for single server\n\n\nFixes #1046", "createdAt": "2020-11-13T14:42:55Z", "url": "https://github.com/Graylog2/graylog2-server/pull/9485", "merged": true, "mergeCommit": {"oid": "aef875ff49342b37bdabd5a81cd16b954429b980"}, "closed": true, "closedAt": "2020-12-02T14:15:00Z", "author": {"login": "mpfz0r"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdcIDE9gH2gAyNTIwNjIxMTkzOjZkYzlkODFkMDNiNjZiMDFhOWM1N2I4ODViNzA4Y2YwNDI3ODk2OWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiMq17gFqTU0MjczNDMyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6dc9d81d03b66b01a9c57b885b708cf04278969b", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/6dc9d81d03b66b01a9c57b885b708cf04278969b", "committedDate": "2020-11-13T14:29:43Z", "message": "Finish support for multiple ldap / AD servers\n\n - Add support to verify against multiple hosts in DefaultX509TrustManager\n\n - modify connection test to support and test multiple servers\n\n - remove validation for single server\n\nFixes #1046"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78bd4fbe53cd9dbf704c8ef66f5e645f8b636441", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/78bd4fbe53cd9dbf704c8ef66f5e645f8b636441", "committedDate": "2020-11-13T14:56:34Z", "message": "Remove yet another validation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxMTI4MDcz", "url": "https://github.com/Graylog2/graylog2-server/pull/9485#pullrequestreview-531128073", "createdAt": "2020-11-16T09:05:30Z", "commit": {"oid": "78bd4fbe53cd9dbf704c8ef66f5e645f8b636441"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMTU4MDQy", "url": "https://github.com/Graylog2/graylog2-server/pull/9485#pullrequestreview-542158042", "createdAt": "2020-12-01T17:57:53Z", "commit": {"oid": "78bd4fbe53cd9dbf704c8ef66f5e645f8b636441"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxNzo1Nzo1M1rOH85EHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxODozMDo1MFrOH86UFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzYxMTU1MA==", "bodyText": "How about validating that the servers list is not empty? That way we can prevent errors later on.", "url": "https://github.com/Graylog2/graylog2-server/pull/9485#discussion_r533611550", "createdAt": "2020-12-01T17:57:53Z", "author": {"login": "bernd"}, "path": "graylog2-server/src/main/java/org/graylog/security/authservice/backend/ADAuthServiceBackendConfig.java", "diffHunk": "@@ -80,9 +80,6 @@\n \n     @Override\n     public void validate(ValidationResult result) {\n-        if (servers().size() > 1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78bd4fbe53cd9dbf704c8ef66f5e645f8b636441"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzYyMTE0OQ==", "bodyText": "Can we remove this comment?", "url": "https://github.com/Graylog2/graylog2-server/pull/9485#discussion_r533621149", "createdAt": "2020-12-01T18:13:33Z", "author": {"login": "bernd"}, "path": "graylog2-server/src/main/java/org/graylog/security/authservice/backend/ADAuthServiceBackend.java", "diffHunk": "@@ -191,14 +195,42 @@ public AuthServiceBackendDTO prepareConfigUpdate(AuthServiceBackendDTO existingB\n     public AuthServiceBackendTestResult testConnection(@Nullable AuthServiceBackendDTO existingBackendConfig) {\n         final ADAuthServiceBackendConfig testConfig = buildTestConfig(existingBackendConfig);\n \n-        try (final LDAPConnection connection = ldapConnector.connect(testConfig.getLDAPConnectorConfig())) {\n+        final LDAPConnectorConfig config = testConfig.getLDAPConnectorConfig();\n+\n+        if (config.serverList().size() == 1) {\n+            return testSingleConnection(config, config.serverList().get(0));\n+        }\n+\n+        // Test each server separately, so we can see the result for each\n+        final List<AuthServiceBackendTestResult> testResults = config.serverList().stream().map(server -> testSingleConnection(config, server)).collect(Collectors.toList());\n+\n+        if (testResults.stream().anyMatch(res -> !res.isSuccess())) {\n+            return AuthServiceBackendTestResult\n+                    .createFailure(\"Test failure\",\n+                            //testResults.stream().map(AuthServiceBackendTestResult::errors).flatMap(Collection::stream).collect(Collectors.toList()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78bd4fbe53cd9dbf704c8ef66f5e645f8b636441"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzYyMTI0OA==", "bodyText": "Can we remove this comment?", "url": "https://github.com/Graylog2/graylog2-server/pull/9485#discussion_r533621248", "createdAt": "2020-12-01T18:13:43Z", "author": {"login": "bernd"}, "path": "graylog2-server/src/main/java/org/graylog/security/authservice/backend/LDAPAuthServiceBackend.java", "diffHunk": "@@ -171,14 +175,42 @@ public AuthServiceBackendDTO prepareConfigUpdate(AuthServiceBackendDTO existingB\n     public AuthServiceBackendTestResult testConnection(@Nullable AuthServiceBackendDTO existingBackendConfig) {\n         final LDAPAuthServiceBackendConfig testConfig = buildTestConfig(existingBackendConfig);\n \n-        try (final LDAPConnection connection = ldapConnector.connect(testConfig.getLDAPConnectorConfig())) {\n+        final LDAPConnectorConfig config = testConfig.getLDAPConnectorConfig();\n+\n+        if (config.serverList().size() == 1) {\n+            return testSingleConnection(config, config.serverList().get(0));\n+        }\n+\n+        // Test each server separately, so we can see the result for each\n+        final List<AuthServiceBackendTestResult> testResults = config.serverList().stream().map(server -> testSingleConnection(config, server)).collect(Collectors.toList());\n+\n+        if (testResults.stream().anyMatch(res -> !res.isSuccess())) {\n+            return AuthServiceBackendTestResult\n+                    .createFailure(\"Test failure\",\n+                            //testResults.stream().map(AuthServiceBackendTestResult::errors).flatMap(Collection::stream).collect(Collectors.toList()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78bd4fbe53cd9dbf704c8ef66f5e645f8b636441"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzYyMTU3NQ==", "bodyText": "Same as for the AD config, how about checking if the list is not empty?", "url": "https://github.com/Graylog2/graylog2-server/pull/9485#discussion_r533621575", "createdAt": "2020-12-01T18:14:13Z", "author": {"login": "bernd"}, "path": "graylog2-server/src/main/java/org/graylog/security/authservice/backend/LDAPAuthServiceBackendConfig.java", "diffHunk": "@@ -84,9 +84,6 @@\n \n     @Override\n     public void validate(ValidationResult result) {\n-        if (servers().size() > 1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78bd4fbe53cd9dbf704c8ef66f5e645f8b636441"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzYzMjAyMQ==", "bodyText": "Is it actually okay to just check if the certificate matches any host in our list? I was wondering if this can be an issue because we don't know which host is giving us the certificate. So a host could give us the certificate of another host from our list.", "url": "https://github.com/Graylog2/graylog2-server/pull/9485#discussion_r533632021", "createdAt": "2020-12-01T18:30:50Z", "author": {"login": "bernd"}, "path": "graylog2-server/src/main/java/org/graylog2/security/DefaultX509TrustManager.java", "diffHunk": "@@ -107,10 +119,12 @@ private void validateHostnames(X509Certificate[] x509Certificates, String s) thr\n     }\n \n     private boolean certificateMatchesHostname(X509Certificate x509Certificate) {\n-        try {\n-            return this.authorizer.verify(this.host, x509Certificate);\n-        } catch (IOException e) {\n-            return false;\n-        }\n+        return this.hosts.stream().anyMatch(host -> {\n+            try {\n+                return this.authorizer.verify(host, x509Certificate);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78bd4fbe53cd9dbf704c8ef66f5e645f8b636441"}, "originalPosition": 66}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6f2bd84503e8281ae98a96c58a8c15c49fc1279", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/a6f2bd84503e8281ae98a96c58a8c15c49fc1279", "committedDate": "2020-12-02T08:55:26Z", "message": "Merge remote-tracking branch 'origin/master' into support-multiple-ldap-servers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5a9b68db6d4a262ccb63227225a828b92ff84f7", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/b5a9b68db6d4a262ccb63227225a828b92ff84f7", "committedDate": "2020-12-02T09:39:59Z", "message": "Fix review comments\n\n - remove dead code\n - keep server list validation\n - add javadoc for X509ExtendedTrustManager"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyNzM0MzI3", "url": "https://github.com/Graylog2/graylog2-server/pull/9485#pullrequestreview-542734327", "createdAt": "2020-12-02T11:16:19Z", "commit": {"oid": "b5a9b68db6d4a262ccb63227225a828b92ff84f7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3321, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}