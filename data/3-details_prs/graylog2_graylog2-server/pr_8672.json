{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYwMjY0Njcz", "number": 8672, "title": "Enable Search After for ES7 exports by adding a field alias for gl2_message_id in event indices", "bodyText": "Description\nThis PR enables Search After for exports using the Elasticsearch 7 storage driver. The Scroll implementation of the RequestStrategy interface was completely removed.\nA migration was added, which adds this field alias to all event indices. In addition the alias was added to EventsIndexMapping7, so that all newly created event indices will get it.\nFixes #7986\nMotivation and Context\nWe only had both, because we initially wanted to always use Search After, but then realized that our event indices were lacking the gl2_message_id field, meaning there was no common tie breaker field between event and message indices.\nIn 6.4 Elasticsearch introduced field aliases, which we can now leverage to add gl2_message_id to event indices without duplicating data.\nThis was only done for the ES7 driver, because field aliases are not supported for all minor versions of ES 6. I think that keeping things simple for the ES6 driver is more valuable than implementing it there only for versions >= 6.4. If we really want, we could add that in a follow-up PR.\nHow Has This Been Tested?\n\nAdded unit and integration tests\nManual testing on local machine\n\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Refactoring (non-breaking change)\n Breaking change (fix or feature that would cause existing functionality to change)", "createdAt": "2020-07-31T15:47:38Z", "url": "https://github.com/Graylog2/graylog2-server/pull/8672", "merged": true, "mergeCommit": {"oid": "692910af7d7bc13d3f9e104c41d09842af950a1b"}, "closed": true, "closedAt": "2020-08-05T08:03:08Z", "author": {"login": "alex-konn"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7NcN4AH2gAyNDYwMjY0NjczOmJkM2JmZDZmZjlmOTZjYjZmMDdkYmJmYzZmNTc0MzEzYzRhZWUwYTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7ncsPgFqTQ2MDg2NTE2NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bd3bfd6ff9f96cb6f07dbbfc6f574313c4aee0a6", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/bd3bfd6ff9f96cb6f07dbbfc6f574313c4aee0a6", "committedDate": "2020-08-03T08:07:12Z", "message": "Remove tie breaker workarounds for ES7 SearchAfter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "902176f14c5727867fcd67df22bca0b0c9d76e8b", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/902176f14c5727867fcd67df22bca0b0c9d76e8b", "committedDate": "2020-08-03T08:07:12Z", "message": "Use SearchAfter for ES7 export"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0dfe76e2156af97127653981def701451eb704a", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/a0dfe76e2156af97127653981def701451eb704a", "committedDate": "2020-08-03T08:07:12Z", "message": "Remove ES7 export scrolling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2e05fe69ce74e6a79e62d9fe1729e20a9964e7d", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/d2e05fe69ce74e6a79e62d9fe1729e20a9964e7d", "committedDate": "2020-08-03T08:07:12Z", "message": "Added new migration for adding the field alias\n\n- Created migration class with basic functionality\n- Created tests for basic functionality"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5dd0bf86d6f996dc795c77d78a3c8a0d99d94666", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/5dd0bf86d6f996dc795c77d78a3c8a0d99d94666", "committedDate": "2020-08-03T08:07:12Z", "message": "Implement Elasticsearch adapter for new migration\n\nOnly an ES7 adapter was added. Since field aliases were introduced for 6.4, adding in ES6 support would be too complicated to be worth it.\n\n- Created ES7 adapter for new migration\n- Created integration test for new adapter\n- Allow accessing the RestHighLevelClient from ElasticsearchInstanceES7"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa34654ea1f83571ed107c6075d095098224d6bb", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/aa34654ea1f83571ed107c6075d095098224d6bb", "committedDate": "2020-08-03T08:07:12Z", "message": "Skip migration for ES versions < 7\n\nSince field aliases were only introduced for 6.4, we will only use them for version 7 and above. Otherwise we would have to differentiate between different minor versions for 6, which would make things considerably more complicated."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "799c602220c90c87254c59f2ba807947f1a63592", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/799c602220c90c87254c59f2ba807947f1a63592", "committedDate": "2020-08-03T08:07:12Z", "message": "Wire up Guice bindings for migration\n\nAlso added an ES6 implementation for the adapter. It should never be called and will throw an exception otherwise. This makes sure that:\n - We don't accidentally add field aliases for ES versions < 6.4 where they are not supported\n - The migration doesn't mark itself as completed without actually adding field aliases.\n\n When a customer runs Graylog 4.0 on ES6, field aliases will not be added, but the migration will try again on subsequent server restarts. So if they upgrade to ES7 at a later point and restart the server, the migration will run and add the field aliases."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ece5af5191438cd3151c3018d7be5c9de4afef0", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/6ece5af5191438cd3151c3018d7be5c9de4afef0", "committedDate": "2020-08-03T08:07:12Z", "message": "Added field alias to EventsIndexMapping7"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "974d55c3983dc7115739bad138cf03d34e84d406", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/974d55c3983dc7115739bad138cf03d34e84d406", "committedDate": "2020-08-03T08:07:12Z", "message": "Use test client instead of IndicesAdapterES7\n\n...for creating test indices in V20200730000000_AddGl2MessageIdFieldAliasForEventsES7IT"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b9549115799d291ba0455dc577e6b1c475cd674d", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/b9549115799d291ba0455dc577e6b1c475cd674d", "committedDate": "2020-07-31T14:39:36Z", "message": "Use test client instead of IndicesAdapterES7\n\n...for creating test indices in V20200730000000_AddGl2MessageIdFieldAliasForEventsES7IT"}, "afterCommit": {"oid": "974d55c3983dc7115739bad138cf03d34e84d406", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/974d55c3983dc7115739bad138cf03d34e84d406", "committedDate": "2020-08-03T08:07:12Z", "message": "Use test client instead of IndicesAdapterES7\n\n...for creating test indices in V20200730000000_AddGl2MessageIdFieldAliasForEventsES7IT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ac5cddf1e3984bd3a912c37844d90af8adf28a1", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/2ac5cddf1e3984bd3a912c37844d90af8adf28a1", "committedDate": "2020-08-03T14:39:57Z", "message": "Fix formatting in VersionAwareStorageModule"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15b06413ed092ef28f2964894aa3dfb117bb392d", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/15b06413ed092ef28f2964894aa3dfb117bb392d", "committedDate": "2020-08-03T15:12:30Z", "message": "Remove completed marker, if present after ES downgrade\n\nIn case a customer goes back to pre-7 Elasticsearch version after the migration has been run, we remove the completed marker. This makes sure that the migration would run again once the customer goes back to a version >= 7.\nAlso added an integration test to make sure that adding the field aliases is idempotent."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwODUyMzU1", "url": "https://github.com/Graylog2/graylog2-server/pull/8672#pullrequestreview-460852355", "createdAt": "2020-08-04T14:12:57Z", "commit": {"oid": "15b06413ed092ef28f2964894aa3dfb117bb392d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxNDoxMjo1N1rOG7iR3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxNDoxMzowNlrOG7iSVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA4MDc5OA==", "bodyText": "Please do not use wildcard imports.", "url": "https://github.com/Graylog2/graylog2-server/pull/8672#discussion_r465080798", "createdAt": "2020-08-04T14:12:57Z", "author": {"login": "dennisoelkers"}, "path": "graylog2-server/src/main/java/org/graylog2/storage/VersionAwareStorageModule.java", "diffHunk": "@@ -31,18 +31,7 @@\n import org.graylog2.indexer.messages.MessagesAdapter;\n import org.graylog2.indexer.searches.SearchesAdapter;\n import org.graylog2.migrations.V20170607164210_MigrateReopenedIndicesToAliases;\n-import org.graylog2.storage.providers.ClusterAdapterProvider;\n-import org.graylog2.storage.providers.CountsAdapterProvider;\n-import org.graylog2.storage.providers.ElasticsearchBackendProvider;\n-import org.graylog2.storage.providers.IndexFieldTypePollerAdapterProvider;\n-import org.graylog2.storage.providers.IndexToolsAdapterProvider;\n-import org.graylog2.storage.providers.IndicesAdapterProvider;\n-import org.graylog2.storage.providers.MessagesAdapterProvider;\n-import org.graylog2.storage.providers.MoreSearchAdapterProvider;\n-import org.graylog2.storage.providers.NodeAdapterProvider;\n-import org.graylog2.storage.providers.SearchesAdapterProvider;\n-import org.graylog2.storage.providers.V20170607164210_MigrateReopenedIndicesToAliasesClusterStateAdapterProvider;\n-import org.graylog2.storage.providers.V20200730000000_AddGl2MessageIdFieldAliasForEventsElasticsearchAdapterProvider;\n+import org.graylog2.storage.providers.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15b06413ed092ef28f2964894aa3dfb117bb392d"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA4MDkxOQ==", "bodyText": "Please do not use wildcard imports.", "url": "https://github.com/Graylog2/graylog2-server/pull/8672#discussion_r465080919", "createdAt": "2020-08-04T14:13:06Z", "author": {"login": "dennisoelkers"}, "path": "graylog2-server/src/test/java/org/graylog/plugins/views/migrations/V20200730000000_AddGl2MessageIdFieldAliasForEventsTest.java", "diffHunk": "@@ -27,10 +27,7 @@\n \n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.ArgumentMatchers.any;\n-import static org.mockito.Mockito.mock;\n-import static org.mockito.Mockito.never;\n-import static org.mockito.Mockito.verify;\n-import static org.mockito.Mockito.when;\n+import static org.mockito.Mockito.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15b06413ed092ef28f2964894aa3dfb117bb392d"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8327e0e6d959a5eaf77f031fe6e0556656e876b5", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/8327e0e6d959a5eaf77f031fe6e0556656e876b5", "committedDate": "2020-08-04T14:22:55Z", "message": "Fixed accidentally introduced star imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwODY1MTY0", "url": "https://github.com/Graylog2/graylog2-server/pull/8672#pullrequestreview-460865164", "createdAt": "2020-08-04T14:25:15Z", "commit": {"oid": "8327e0e6d959a5eaf77f031fe6e0556656e876b5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2917, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}