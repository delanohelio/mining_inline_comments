{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyNjI3NzMx", "number": 7177, "title": "Synchronize timerange & query with URL on search page.", "bodyText": "Description\n\nMotivation and Context\n\n\nThe current search has a feature, where the current time range and query\nstring is synchronized with the URL in the browser. This means that:\n\ncurrent time range and query string are part of the URL and copying\nand replaying the URL allows restoring the state for these\na change to time range or query string creates a new state in the\nhistory stack, allowing the user to go back and forward between\ndifferent states\ngoing back or forward in the browser history restores the time range\n& query string of this specific state\n\nThis PR is recreating this functionality for the new search.\nFixes #7144.\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Refactoring (non-breaking change)\n Breaking change (fix or feature that would cause existing functionality to change)\n\nChecklist:\n\n\n\n My code follows the code style of this project.\n My change requires a change to the documentation.\n I have updated the documentation accordingly.\n I have read the CONTRIBUTING document.\n I have added tests to cover my changes.", "createdAt": "2020-01-14T13:13:09Z", "url": "https://github.com/Graylog2/graylog2-server/pull/7177", "merged": true, "mergeCommit": {"oid": "a270a8ef553e3a7153841ab3e5ac7b805b845049"}, "closed": true, "closedAt": "2020-01-17T10:55:16Z", "author": {"login": "dennisoelkers"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6SkrAgFqTM0MjYxMjM4NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb7MkY0AFqTM0NDUwMjU4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyNjEyMzg0", "url": "https://github.com/Graylog2/graylog2-server/pull/7177#pullrequestreview-342612384", "createdAt": "2020-01-14T15:20:53Z", "commit": {"oid": "a1b3ca88006f5f4eed196ec07c808b71c5be4957"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNToyMDo1M1rOFdbPKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNToyMDo1M1rOFdbPKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM5OTI3Mg==", "bodyText": "Out of interest, is there a reason you are checking for the first query here, but take it for granted in BindSearchParamsFromQuery.js?", "url": "https://github.com/Graylog2/graylog2-server/pull/7177#discussion_r366399272", "createdAt": "2020-01-14T15:20:53Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/views/hooks/SyncWithQueryParameters.js", "diffHunk": "@@ -0,0 +1,53 @@\n+// @flow strict\n+import { useEffect } from 'react';\n+import URI from 'urijs';\n+import history from 'util/History';\n+\n+import { ViewStore } from 'views/stores/ViewStore';\n+import View from 'views/logic/views/View';\n+import { QueriesActions } from 'views/actions/QueriesActions';\n+\n+const useActionListeners = (actions, callback, dependencies) => {\n+  useEffect(() => {\n+    const unsubscribes = actions.map(action => action.listen(callback));\n+    return () => unsubscribes.forEach(unsubscribe => unsubscribe());\n+  }, dependencies);\n+};\n+\n+const extractTimerangeParams = (timerange) => {\n+  const { type } = timerange;\n+  const result = { rangetype: type };\n+\n+  switch (type) {\n+    case 'relative': return Object.entries({ ...result, relative: timerange.range });\n+    case 'keyword': return Object.entries({ ...result, keyword: timerange.keyword });\n+    case 'absolute': return Object.entries({ ...result, from: timerange.from, to: timerange.to });\n+    default: return Object.entries(result);\n+  }\n+};\n+\n+export const syncWithQueryParameters = (query: string) => {\n+  const { view } = ViewStore.getInitialState() || {};\n+  if (view && view.type === View.Type.Search) {\n+    const firstQuery = view.search.queries.first();\n+    if (firstQuery) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1b3ca88006f5f4eed196ec07c808b71c5be4957"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyNjQ5MzE5", "url": "https://github.com/Graylog2/graylog2-server/pull/7177#pullrequestreview-342649319", "createdAt": "2020-01-14T16:06:36Z", "commit": {"oid": "a1b3ca88006f5f4eed196ec07c808b71c5be4957"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNjowNjozNlrOFdc8Iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNjowNjozNlrOFdc8Iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQyNzE3MQ==", "bodyText": "One thing I realised while testing these changes:\nChanging e.g. the relative time range, results in a new URL due to useSyncWithQueryParameters. because of the new URL, the query variable is different and bindSearchParamsFromQuery  gets called again.\nbindSearchParamsFromQuery will unnecessarily update the current query and also trigger another, but unnecessary search execution.", "url": "https://github.com/Graylog2/graylog2-server/pull/7177#discussion_r366427171", "createdAt": "2020-01-14T16:06:36Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/views/pages/ExtendedSearchPage.jsx", "diffHunk": "@@ -112,14 +122,30 @@ const DashboardSearchBarWithStatus = WithSearchStatus(DashboardSearchBar);\n \n const ViewAdditionalContextProvider = connect(AdditionalContext.Provider, { view: ViewStore }, ({ view }) => ({ value: { view: view.view } }));\n \n-const ExtendedSearchPage = ({ route, searchRefreshHooks }: Props) => {\n+const useStyle = () => {\n+  useEffect(() => {\n+    style.use();\n+    return () => style.unuse();\n+  }, []);\n+};\n+\n+const ExtendedSearchPage = ({ route, location = { query: {} }, router, searchRefreshHooks }: Props) => {\n+  const { pathname, search } = router.getCurrentLocation();\n+  const query = `${pathname}${search}`;\n   const refreshIfNotUndeclared = () => _refreshIfNotUndeclared(searchRefreshHooks, SearchExecutionStateStore.getInitialState());\n \n   useEffect(() => {\n-    style.use();\n+    const { view } = ViewStore.getInitialState();\n \n+    bindSearchParamsFromQuery({ view, query: location.query, retry: () => Promise.resolve() });\n+  }, [query]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1b3ca88006f5f4eed196ec07c808b71c5be4957"}, "originalPosition": 71}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "962ccf8b76763ed107c617e60d6703682b67aba7", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/962ccf8b76763ed107c617e60d6703682b67aba7", "committedDate": "2020-01-15T08:35:17Z", "message": "Passing router as default prop for tests."}, "afterCommit": {"oid": "347092dd4c24dee29349fda41cb95071a8e697a6", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/347092dd4c24dee29349fda41cb95071a8e697a6", "committedDate": "2020-01-15T09:19:39Z", "message": "Passing router as default prop for tests."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "53d11b72517081a91c838f0e259d7be0fc98d1ac", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/53d11b72517081a91c838f0e259d7be0fc98d1ac", "committedDate": "2020-01-15T11:27:30Z", "message": "Do not show `Empty Value` for deduplicated values."}, "afterCommit": {"oid": "b539a41705b1794206250f3d864291924cd31f57", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/b539a41705b1794206250f3d864291924cd31f57", "committedDate": "2020-01-15T09:41:11Z", "message": "Doing initial URI sync upon mount."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2711130007b91299f11a45c554605afa8fc9f7b9", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/2711130007b91299f11a45c554605afa8fc9f7b9", "committedDate": "2020-01-15T15:10:26Z", "message": "Synchronize timerange & query with URL on search page.\n\nThe current search has a feature, where the current time range and query\nstring is synchronized with the URL in the browser. This means that:\n\n  - current time range and query string are part of the URL and copying\nand replaying the URL allows restoring the state for these\n  - a change to time range or query string creates a new state in the\nhistory stack, allowing the user to go back and forward between\ndifferent states\n  - going back or forward in the browser history restores the time range\n& query string of this specific state\n\nThis PR is recreating this functionality for the new search.\n\nFixes #7144."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "345780d412cafb6c87dd571e3630cbcd23cc4058", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/345780d412cafb6c87dd571e3630cbcd23cc4058", "committedDate": "2020-01-15T15:10:27Z", "message": "Fixing linter hints."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e77b404bbd1988896948a183299b72f750bd2e7", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/6e77b404bbd1988896948a183299b72f750bd2e7", "committedDate": "2020-01-15T15:10:27Z", "message": "Do not fail if no view is loaded."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a07d72ec58ba589adb10654f2978424c96a9f549", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/a07d72ec58ba589adb10654f2978424c96a9f549", "committedDate": "2020-01-15T15:10:27Z", "message": "Adding tests for `SyncWithQueryParameters`."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7afa53659a001366bbf43414d19a1b4dc637e022", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/7afa53659a001366bbf43414d19a1b4dc637e022", "committedDate": "2020-01-15T15:10:28Z", "message": "Passing router as default prop for tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "715d1524d40962650f94cdefdcef024cbb223c14", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/715d1524d40962650f94cdefdcef024cbb223c14", "committedDate": "2020-01-15T15:10:28Z", "message": "Doing initial URI sync upon mount."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f7c7d2800868c13231214aa8e4b80666c94761c", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/3f7c7d2800868c13231214aa8e4b80666c94761c", "committedDate": "2020-01-15T15:11:36Z", "message": "Adding assertion that searches should only have a single query."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b539a41705b1794206250f3d864291924cd31f57", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/b539a41705b1794206250f3d864291924cd31f57", "committedDate": "2020-01-15T09:41:11Z", "message": "Doing initial URI sync upon mount."}, "afterCommit": {"oid": "3f7c7d2800868c13231214aa8e4b80666c94761c", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/3f7c7d2800868c13231214aa8e4b80666c94761c", "committedDate": "2020-01-15T15:11:36Z", "message": "Adding assertion that searches should only have a single query."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a4ac10a3f250b2ff0cfad34e196cf648627d8cc", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/5a4ac10a3f250b2ff0cfad34e196cf648627d8cc", "committedDate": "2020-01-15T15:47:36Z", "message": "Only update timerange/query & reexecute search if it has actually changed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4fc047fdb37343bca7a5e858191e08fce0b11d6", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/f4fc047fdb37343bca7a5e858191e08fce0b11d6", "committedDate": "2020-01-16T09:04:31Z", "message": "Considering string parsing in test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "267caf4027bf2dccf988f7768f390113add7b3e0", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/267caf4027bf2dccf988f7768f390113add7b3e0", "committedDate": "2020-01-16T14:40:42Z", "message": "Actually returning promise from store method."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MDU2MDIx", "url": "https://github.com/Graylog2/graylog2-server/pull/7177#pullrequestreview-344056021", "createdAt": "2020-01-16T16:41:08Z", "commit": {"oid": "267caf4027bf2dccf988f7768f390113add7b3e0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "846e83660515af147b1b8c407b90dc2e87ede8bc", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/846e83660515af147b1b8c407b90dc2e87ede8bc", "committedDate": "2020-01-16T16:55:03Z", "message": "Fixing faulty tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MDcwMjUx", "url": "https://github.com/Graylog2/graylog2-server/pull/7177#pullrequestreview-344070251", "createdAt": "2020-01-16T17:00:11Z", "commit": {"oid": "846e83660515af147b1b8c407b90dc2e87ede8bc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NDc4MzM4", "url": "https://github.com/Graylog2/graylog2-server/pull/7177#pullrequestreview-344478338", "createdAt": "2020-01-17T10:11:10Z", "commit": {"oid": "846e83660515af147b1b8c407b90dc2e87ede8bc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NTAyNTg0", "url": "https://github.com/Graylog2/graylog2-server/pull/7177#pullrequestreview-344502584", "createdAt": "2020-01-17T10:55:04Z", "commit": {"oid": "846e83660515af147b1b8c407b90dc2e87ede8bc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2666, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}