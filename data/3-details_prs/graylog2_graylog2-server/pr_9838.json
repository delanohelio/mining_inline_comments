{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQzNTM1OTEx", "number": 9838, "title": "Save focused widget id in url", "bodyText": "Motivation\nPrior to this change, we did not save the state\nof the focused widget in the url.\nDescription\nThis change will sync the focused widget id with the\nurl so a user can copy and past the state to another\nuser.\nHow Has This Been Tested?\n\nFocus a widget\nCopy url\nopen a new tab\npaste url\n\nFixes #9728\nTypes of changes\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Refactoring (non-breaking change)\n Breaking change (fix or feature that would cause existing functionality to change)", "createdAt": "2020-12-21T15:05:00Z", "url": "https://github.com/Graylog2/graylog2-server/pull/9838", "merged": true, "mergeCommit": {"oid": "deea6d63d83a854d7e667e87d505c8e8fc386c99"}, "closed": true, "closedAt": "2021-01-08T08:35:37Z", "author": {"login": "kmerz"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdoW37EAH2gAyNTQzNTM1OTExOmQ3MjcwZTU2Y2U3NmI0ZTAzNDk4NGI1ZjA4MDc0ODYwMmU3ZjZiZmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABduEi7DgFqTU2NDA4MjY3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d7270e56ce76b4e034984b5f080748602e7f6bff", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/d7270e56ce76b4e034984b5f080748602e7f6bff", "committedDate": "2020-12-21T14:33:12Z", "message": "Save focused widget id in url\n\n## Motivation\nPrior to this change, we did not save the state\nof the focused widget in the url.\n\n## Description\nThis change will sync the focused widget id with the\nurl so a user can copy and past the state to another\nuser."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwMDM4NjEw", "url": "https://github.com/Graylog2/graylog2-server/pull/9838#pullrequestreview-560038610", "createdAt": "2020-12-30T13:00:19Z", "commit": {"oid": "d7270e56ce76b4e034984b5f080748602e7f6bff"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQxMzowMDoyMFrOIMswQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQxMzoxMzoyNFrOIMs-Hw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE4NzA3NQ==", "bodyText": "You can use this instead:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              const { search, pathname } = useLocation();\n          \n          \n            \n              const { focused } = useQuery();\n          \n      \n    \n    \n  \n\nuseQuery should be imported from routing/useQuery.\nThis already does the query string parsing and returns an object containing the query parameters.", "url": "https://github.com/Graylog2/graylog2-server/pull/9838#discussion_r550187075", "createdAt": "2020-12-30T13:00:20Z", "author": {"login": "dennisoelkers"}, "path": "graylog2-web-interface/src/views/components/contexts/WidgetFocusProvider.tsx", "diffHunk": "@@ -15,27 +15,63 @@\n  * <http://www.mongodb.com/licensing/server-side-public-license>.\n  */\n import * as React from 'react';\n-import { useState, useEffect } from 'react';\n+import { useState, useEffect, useCallback } from 'react';\n+import { useLocation, useHistory } from 'react-router-dom';\n import PropTypes from 'prop-types';\n+import URI from 'urijs';\n \n import { useStore } from 'stores/connect';\n import { WidgetStore } from 'views/stores/WidgetStore';\n import WidgetFocusContext from 'views/components/contexts/WidgetFocusContext';\n \n+const _syncWithQuery = (query: string, focusedWidget: string) => {\n+  const baseUri = new URI(query)\n+    .removeSearch('focused');\n+\n+  if (focusedWidget) {\n+    return baseUri.setSearch('focused', focusedWidget).toString();\n+  }\n+\n+  return baseUri.toString();\n+};\n+\n+const getFocusedWidgetFromSearch = (search: string) => {\n+  const uri = new URI(search);\n+  const { focused } = uri.search(true);\n+\n+  return focused;\n+};\n+\n const WidgetFocusProvider = ({ children }: { children: React.ReactNode }): React.ReactElement => {\n-  const [focusedWidget, setFocusedWidget] = useState(undefined);\n+  const { search, pathname } = useLocation();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7270e56ce76b4e034984b5f080748602e7f6bff"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE4NzM3OQ==", "bodyText": "We could extract this into a useFocusedWidgetIdFromURL() hook to improve readability.", "url": "https://github.com/Graylog2/graylog2-server/pull/9838#discussion_r550187379", "createdAt": "2020-12-30T13:01:41Z", "author": {"login": "dennisoelkers"}, "path": "graylog2-web-interface/src/views/components/contexts/WidgetFocusProvider.tsx", "diffHunk": "@@ -15,27 +15,63 @@\n  * <http://www.mongodb.com/licensing/server-side-public-license>.\n  */\n import * as React from 'react';\n-import { useState, useEffect } from 'react';\n+import { useState, useEffect, useCallback } from 'react';\n+import { useLocation, useHistory } from 'react-router-dom';\n import PropTypes from 'prop-types';\n+import URI from 'urijs';\n \n import { useStore } from 'stores/connect';\n import { WidgetStore } from 'views/stores/WidgetStore';\n import WidgetFocusContext from 'views/components/contexts/WidgetFocusContext';\n \n+const _syncWithQuery = (query: string, focusedWidget: string) => {\n+  const baseUri = new URI(query)\n+    .removeSearch('focused');\n+\n+  if (focusedWidget) {\n+    return baseUri.setSearch('focused', focusedWidget).toString();\n+  }\n+\n+  return baseUri.toString();\n+};\n+\n+const getFocusedWidgetFromSearch = (search: string) => {\n+  const uri = new URI(search);\n+  const { focused } = uri.search(true);\n+\n+  return focused;\n+};\n+\n const WidgetFocusProvider = ({ children }: { children: React.ReactNode }): React.ReactElement => {\n-  const [focusedWidget, setFocusedWidget] = useState(undefined);\n+  const { search, pathname } = useLocation();\n+  const query = pathname + search;\n+  const history = useHistory();\n+  const [focusedWidget, setFocusedWidget] = useState<string | undefined>();\n   const widgets = useStore(WidgetStore);\n \n+  useEffect(() => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7270e56ce76b4e034984b5f080748602e7f6bff"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE5MDYyMw==", "bodyText": "I do not understand this part. If the updateFocus function is called with the widget id of the currently focused widget, _syncWithQuery would be called with undefined and would remove the focused query parameter. Or am I misreading something?\nMaybe we should simplify the functionality of the updateFocus function. We could let it set:\n\nthe URL only (which would then be synced with the state in WidgetContextProvider)\nthe state only (through setFocusedWidget) and synchronize with the URL in WidgetContextProvider", "url": "https://github.com/Graylog2/graylog2-server/pull/9838#discussion_r550190623", "createdAt": "2020-12-30T13:13:24Z", "author": {"login": "dennisoelkers"}, "path": "graylog2-web-interface/src/views/components/contexts/WidgetFocusProvider.tsx", "diffHunk": "@@ -15,27 +15,63 @@\n  * <http://www.mongodb.com/licensing/server-side-public-license>.\n  */\n import * as React from 'react';\n-import { useState, useEffect } from 'react';\n+import { useState, useEffect, useCallback } from 'react';\n+import { useLocation, useHistory } from 'react-router-dom';\n import PropTypes from 'prop-types';\n+import URI from 'urijs';\n \n import { useStore } from 'stores/connect';\n import { WidgetStore } from 'views/stores/WidgetStore';\n import WidgetFocusContext from 'views/components/contexts/WidgetFocusContext';\n \n+const _syncWithQuery = (query: string, focusedWidget: string) => {\n+  const baseUri = new URI(query)\n+    .removeSearch('focused');\n+\n+  if (focusedWidget) {\n+    return baseUri.setSearch('focused', focusedWidget).toString();\n+  }\n+\n+  return baseUri.toString();\n+};\n+\n+const getFocusedWidgetFromSearch = (search: string) => {\n+  const uri = new URI(search);\n+  const { focused } = uri.search(true);\n+\n+  return focused;\n+};\n+\n const WidgetFocusProvider = ({ children }: { children: React.ReactNode }): React.ReactElement => {\n-  const [focusedWidget, setFocusedWidget] = useState(undefined);\n+  const { search, pathname } = useLocation();\n+  const query = pathname + search;\n+  const history = useHistory();\n+  const [focusedWidget, setFocusedWidget] = useState<string | undefined>();\n   const widgets = useStore(WidgetStore);\n \n+  useEffect(() => {\n+    const paramFocusedWidget = getFocusedWidgetFromSearch(search);\n+\n+    if (paramFocusedWidget && focusedWidget !== paramFocusedWidget) {\n+      setFocusedWidget(paramFocusedWidget);\n+    }\n+  }, [focusedWidget, search]);\n+\n   useEffect(() => {\n     if (focusedWidget && !widgets.has(focusedWidget)) {\n       setFocusedWidget(undefined);\n     }\n   }, [focusedWidget, widgets]);\n \n-  const updateFocus = (widgetId: string | undefined | null) => (\n-    widgetId === focusedWidget\n-      ? setFocusedWidget(undefined)\n-      : setFocusedWidget(widgetId));\n+  const updateFocus = useCallback((widgetId: string | undefined | null) => {\n+    const newFocus = widgetId === focusedWidget", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7270e56ce76b4e034984b5f080748602e7f6bff"}, "originalPosition": 59}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85409ae751468bf0dfd1403f8b22a7d3bb42ef0b", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/85409ae751468bf0dfd1403f8b22a7d3bb42ef0b", "committedDate": "2021-01-04T09:16:37Z", "message": "Add recommendations and fixes from @dennisoelkers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc5f4ace55cd902a792bdb9483597ade8b0f37bb", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/dc5f4ace55cd902a792bdb9483597ade8b0f37bb", "committedDate": "2021-01-05T16:22:51Z", "message": "Add a minimal test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c09eeb45e1050d9404aaa08ec3368dbcde54b7e3", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/c09eeb45e1050d9404aaa08ec3368dbcde54b7e3", "committedDate": "2021-01-07T10:05:24Z", "message": "Add a test for setting a focused widget found in the url"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1dc4412a162c4798546b7f75e0b30d3fb84ae72e", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/1dc4412a162c4798546b7f75e0b30d3fb84ae72e", "committedDate": "2021-01-07T10:15:04Z", "message": "Fix now failing test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f22da909a2232e83af1ffbabe9d0465b7a6f948f", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/f22da909a2232e83af1ffbabe9d0465b7a6f948f", "committedDate": "2021-01-07T11:00:13Z", "message": "Isolate use of mocking search to depending test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5b2d9182a27594c3c513ed0ff7cfe6529d90f52", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/b5b2d9182a27594c3c513ed0ff7cfe6529d90f52", "committedDate": "2021-01-07T14:48:50Z", "message": "Use async test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY0MDgyNjcy", "url": "https://github.com/Graylog2/graylog2-server/pull/9838#pullrequestreview-564082672", "createdAt": "2021-01-08T08:35:32Z", "commit": {"oid": "b5b2d9182a27594c3c513ed0ff7cfe6529d90f52"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3254, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}