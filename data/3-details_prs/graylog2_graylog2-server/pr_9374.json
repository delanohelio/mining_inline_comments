{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2MTgxNDky", "number": 9374, "title": "Implement and enforce user account status", "bodyText": "Fixes #9077", "createdAt": "2020-11-05T16:22:15Z", "url": "https://github.com/Graylog2/graylog2-server/pull/9374", "merged": true, "mergeCommit": {"oid": "ae427f1c7be8dc1f5835155057212ca18c47ee29"}, "closed": true, "closedAt": "2020-11-09T10:13:54Z", "author": {"login": "mpfz0r"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZkCzPgH2gAyNTE2MTgxNDkyOjliMmUxZmQxODAyYWNiODViNWRiYzlmMWM2NDI4NzExOTc0YTI4MmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdax-SdgFqTUyNjEwMjQzNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9b2e1fd1802acb85b5dbc9f1c6428711974a282d", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/9b2e1fd1802acb85b5dbc9f1c6428711974a282d", "committedDate": "2020-11-05T15:24:59Z", "message": "Add AccountStatus field to User"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fee5799aee02356386d73ee76473400046caf7d4", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/fee5799aee02356386d73ee76473400046caf7d4", "committedDate": "2020-11-05T15:24:59Z", "message": "Add UserAccountControl and status to LdapEntry and UserDetails"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92e37f8b3a8290d35f8847b86c28a6d71cd7c0e8", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/92e37f8b3a8290d35f8847b86c28a6d71cd7c0e8", "committedDate": "2020-11-05T15:24:59Z", "message": "Try to cope with incomplete LDAP user entries.\n\n - If we can't get the userNameAttribute, simply use the username\n - Fill in dummy email address if none can't be found"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "317a9be9c3167aa3252700365d2dac1915b735be", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/317a9be9c3167aa3252700365d2dac1915b735be", "committedDate": "2020-11-05T15:24:59Z", "message": "Also provision accounts that failed to login\n\nReverse the order: First provision, then try to login.\nThis is needed, because we otherwise can't update the disabled status\nflag for accounts."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74d53f713d617be3fcb44ca538061576d96177e4", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/74d53f713d617be3fcb44ca538061576d96177e4", "committedDate": "2020-11-05T15:25:00Z", "message": "Prevent user logins for disabled accounts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92dfa0e9d9695192d67071798f6fe3c96c4c700b", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/92dfa0e9d9695192d67071798f6fe3c96c4c700b", "committedDate": "2020-11-05T15:25:00Z", "message": "Add account_status to UserSummary"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b45e210a07290ad39559298a943813488589985", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/5b45e210a07290ad39559298a943813488589985", "committedDate": "2020-11-05T16:19:23Z", "message": "Add endpoint to modify user acount status"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71425e8349ab1a35349124229861a06d02c375fb", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/71425e8349ab1a35349124229861a06d02c375fb", "committedDate": "2020-11-05T16:33:20Z", "message": "Add auditevent"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NDkyMTQ1", "url": "https://github.com/Graylog2/graylog2-server/pull/9374#pullrequestreview-524492145", "createdAt": "2020-11-05T17:23:03Z", "commit": {"oid": "71425e8349ab1a35349124229861a06d02c375fb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNzoyMzowM1rOHuN6KA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNzo0Nzo1NVrOHuPGYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODIyNDQyNA==", "bodyText": "See comment in LDAPUser.", "url": "https://github.com/Graylog2/graylog2-server/pull/9374#discussion_r518224424", "createdAt": "2020-11-05T17:23:03Z", "author": {"login": "bernd"}, "path": "graylog2-server/src/main/java/org/graylog/security/authservice/ldap/LDAPEntry.java", "diffHunk": "@@ -35,6 +35,8 @@\n \n     public abstract String base64UniqueId();\n \n+    public abstract ADUserAccountControl userAccountControl();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71425e8349ab1a35349124229861a06d02c375fb"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODIyNTc3Mw==", "bodyText": "I don't think we should put AD specific code into the LDAPEntry and LDAPUser objects. How about using the AccountStatus instead? That makes it independent from AD. We could extract the AccountStatus into a separate enum out of the User interface to make it a bit more generic.\nWhat do you think?\nI also think we should only have an accountStatus() method in LDAPUser instead of also putting it into the LDAPEntry object. The LDAPEntry object is supposed to be generic. We can move the userAccountControl parsing into the createLDAPUser() method in UnboundLDAPConnector.", "url": "https://github.com/Graylog2/graylog2-server/pull/9374#discussion_r518225773", "createdAt": "2020-11-05T17:25:03Z", "author": {"login": "bernd"}, "path": "graylog2-server/src/main/java/org/graylog/security/authservice/ldap/LDAPUser.java", "diffHunk": "@@ -22,6 +22,8 @@\n public abstract class LDAPUser {\n     public abstract String base64UniqueId();\n \n+    public abstract ADUserAccountControl userAccountControl();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71425e8349ab1a35349124229861a06d02c375fb"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI0MjUyMQ==", "bodyText": "How about only putting in the userAccountControl attribute as key and then all values as named flags?\n\"userAccountControl\": \"ACCOUNTDISABLED|NORMAL_ACCOUNT|PASSWORD_EXPIRED\"\n\nI think that would make it a bit clearer to AD admins. account_disabled, normal_user_account and password_expired are not really AD attributes.", "url": "https://github.com/Graylog2/graylog2-server/pull/9374#discussion_r518242521", "createdAt": "2020-11-05T17:45:52Z", "author": {"login": "bernd"}, "path": "graylog2-server/src/main/java/org/graylog/security/authservice/backend/ADAuthServiceBackend.java", "diffHunk": "@@ -257,13 +258,17 @@ private ADAuthServiceBackendConfig buildTestConfig(@Nullable AuthServiceBackendD\n                 .put(\"login_success\", loginSuccess);\n \n         if (user != null) {\n-            userDetails.put(\"user_details\", ImmutableMap.of(\n-                    \"dn\", user.dn(),\n-                    AD_OBJECT_GUID, user.base64UniqueId(),\n-                    config.userNameAttribute(), user.username(),\n-                    config.userFullNameAttribute(), user.fullName(),\n-                    \"email\", user.email()\n-            ));\n+            userDetails.put(\"user_details\", ImmutableMap.<String, String>builder()\n+                    .put(\"dn\", user.dn())\n+                    .put(\"account_disabled\", String.valueOf(user.userAccountControl().accountIsDisabled()))\n+                    .put(\"normal_user_account\", String.valueOf(user.userAccountControl().isUserAccount()))\n+                    .put(\"password_expired\", String.valueOf(user.userAccountControl().passwordExpired()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71425e8349ab1a35349124229861a06d02c375fb"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI0MzkzNg==", "bodyText": "Can you please add a comment about why we first provision and then authenticate?", "url": "https://github.com/Graylog2/graylog2-server/pull/9374#discussion_r518243936", "createdAt": "2020-11-05T17:47:55Z", "author": {"login": "bernd"}, "path": "graylog2-server/src/main/java/org/graylog/security/authservice/backend/LDAPAuthServiceBackend.java", "diffHunk": "@@ -77,23 +77,24 @@ public LDAPAuthServiceBackend(UnboundLDAPConnector ldapConnector,\n \n             final LDAPUser userEntry = optionalUser.get();\n \n-            if (!authCredentials.isAuthenticated()) {\n-                if (!isAuthenticated(connection, userEntry, authCredentials)) {\n-                    LOG.debug(\"Invalid credentials for user <{}> (DN: {})\", authCredentials.username(), userEntry.dn());\n-                    return Optional.empty();\n-                }\n-            }\n-\n             final UserDetails userDetails = provisionerService.provision(provisionerService.newDetails(this)\n                     .authServiceType(backendType())\n                     .authServiceId(backendId())\n+                    .accountIsEnabled(true)\n                     .base64AuthServiceUid(userEntry.base64UniqueId())\n                     .username(userEntry.username())\n                     .fullName(userEntry.fullName())\n                     .email(userEntry.email())\n                     .defaultRoles(backend.defaultRoles())\n                     .build());\n \n+            if (!authCredentials.isAuthenticated()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71425e8349ab1a35349124229861a06d02c375fb"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "016b21e5a0dd517d182bed4778561589379ab605", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/016b21e5a0dd517d182bed4778561589379ab605", "committedDate": "2020-11-06T09:46:45Z", "message": "Print userAccountControl as flags"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6927c63711fd221c813d9279be14cf123d2e2042", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/6927c63711fd221c813d9279be14cf123d2e2042", "committedDate": "2020-11-06T10:50:58Z", "message": "Remove ADUserAccountControl from LDAPUser and LDAPEntry.\n\nThis means the test result can only show whether an account is\nenabled/disabled."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca3d16472c92abd5b5e66b53ff48417f2dae1ae9", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/ca3d16472c92abd5b5e66b53ff48417f2dae1ae9", "committedDate": "2020-11-06T11:16:05Z", "message": "Restore original authenticateAndProvision order"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9adb2b849a8553115d9918c7ba56c12f7c19bb27", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/9adb2b849a8553115d9918c7ba56c12f7c19bb27", "committedDate": "2020-11-06T12:08:19Z", "message": "Double check that an account is enabled in AD\n\nThis deliberately ignores the pre-auth flag set by the\nHTTPHeaderAuthRealm."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c8448581cf7fb291c812841461a24ecbd729d58", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/7c8448581cf7fb291c812841461a24ecbd729d58", "committedDate": "2020-11-06T12:39:53Z", "message": "Merge remote-tracking branch 'origin/master' into issue-9077"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1MzY5NzUw", "url": "https://github.com/Graylog2/graylog2-server/pull/9374#pullrequestreview-525369750", "createdAt": "2020-11-06T17:50:30Z", "commit": {"oid": "7c8448581cf7fb291c812841461a24ecbd729d58"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNzo1MDozMFrOHu3u8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxODoxMzo1MVrOHu4elw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkwOTY4Mg==", "bodyText": "Let's add a @NonBlank annotation here to make sure we always have a non-empty string.", "url": "https://github.com/Graylog2/graylog2-server/pull/9374#discussion_r518909682", "createdAt": "2020-11-06T17:50:30Z", "author": {"login": "bernd"}, "path": "graylog2-server/src/main/java/org/graylog2/rest/resources/users/UsersResource.java", "diffHunk": "@@ -546,6 +547,28 @@ public void changePassword(\n         }\n     }\n \n+    @PUT\n+    @Path(\"{userId}/status/{newStatus}\")\n+    @Consumes(MediaType.WILDCARD)\n+    @ApiOperation(\"Update the account status for a user\")\n+    @AuditEvent(type = AuditEventTypes.USER_UPDATE)\n+    public Response updateAccountStatus(\n+            @ApiParam(name = \"userId\", value = \"The id of the user whose status to change.\", required = true) @PathParam(\"userId\") String userId,\n+            @ApiParam(name = \"newStatus\", value = \"The account status to be set\", required = true,\n+                    defaultValue = \"enabled\", allowableValues = \"enabled,disabled,deleted\")\n+            @PathParam(\"newStatus\") String newStatus) throws ValidationException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c8448581cf7fb291c812841461a24ecbd729d58"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkxMDQwNw==", "bodyText": "How about moving the save() here? That way to don't touch the database object if nothing would change. (and prevent potential race conditions)", "url": "https://github.com/Graylog2/graylog2-server/pull/9374#discussion_r518910407", "createdAt": "2020-11-06T17:51:46Z", "author": {"login": "bernd"}, "path": "graylog2-server/src/main/java/org/graylog2/rest/resources/users/UsersResource.java", "diffHunk": "@@ -546,6 +547,28 @@ public void changePassword(\n         }\n     }\n \n+    @PUT\n+    @Path(\"{userId}/status/{newStatus}\")\n+    @Consumes(MediaType.WILDCARD)\n+    @ApiOperation(\"Update the account status for a user\")\n+    @AuditEvent(type = AuditEventTypes.USER_UPDATE)\n+    public Response updateAccountStatus(\n+            @ApiParam(name = \"userId\", value = \"The id of the user whose status to change.\", required = true) @PathParam(\"userId\") String userId,\n+            @ApiParam(name = \"newStatus\", value = \"The account status to be set\", required = true,\n+                    defaultValue = \"enabled\", allowableValues = \"enabled,disabled,deleted\")\n+            @PathParam(\"newStatus\") String newStatus) throws ValidationException {\n+\n+        final User user = loadUserById(userId);\n+        final User.AccountStatus oldStatus = user.getAccountStatus();\n+        user.setAccountStatus(User.AccountStatus.valueOf(newStatus.toUpperCase(Locale.US)));\n+        userService.save(user);\n+\n+        if (oldStatus.equals(user.getAccountStatus())) {\n+            return Response.notModified().build();\n+        }\n+        return Response.ok().build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c8448581cf7fb291c812841461a24ecbd729d58"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkyMTg3OQ==", "bodyText": "How about moving this up in front of the if (!authCredentials.isAuthenticated()) { line? That way we get the warning when a disabled user tries to log in. Otherwise we will never see the warning because the authentication doesn't work.\ndiff --git graylog2-server/src/main/java/org/graylog/security/authservice/backend/ADAuthServiceBackend.java graylog2-server/src/main/java/org/graylog/security/authservice/backend/ADAuthServiceBackend.java\nindex 17ac8a96a0..71a44266c5 100644\n--- graylog2-server/src/main/java/org/graylog/security/authservice/backend/ADAuthServiceBackend.java\n+++ graylog2-server/src/main/java/org/graylog/security/authservice/backend/ADAuthServiceBackend.java\n@@ -92,16 +92,16 @@ public class ADAuthServiceBackend implements AuthServiceBackend {\n \n             final LDAPUser userEntry = optionalUser.get();\n \n+            if (!userEntry.accountIsEnabled()) {\n+                LOG.warn(\"Account disabled within Active Directory for user <{}> (DN: {})\", authCredentials.username(), userEntry.dn());\n+                return Optional.empty();\n+            }\n             if (!authCredentials.isAuthenticated()) {\n                 if (!isAuthenticated(connection, userEntry, authCredentials)) {\n                     LOG.debug(\"Invalid credentials for user <{}> (DN: {})\", authCredentials.username(), userEntry.dn());\n                     return Optional.empty();\n                 }\n             }\n-            if (!userEntry.accountIsEnabled()) {\n-                LOG.warn(\"Account disabled within Active Directory for user <{}> (DN: {})\", authCredentials.username(), userEntry.dn());\n-                return Optional.empty();\n-            }\n \n             final UserDetails userDetails = provisionerService.provision(provisionerService.newDetails(this)\n                     .authServiceType(backendType())", "url": "https://github.com/Graylog2/graylog2-server/pull/9374#discussion_r518921879", "createdAt": "2020-11-06T18:13:51Z", "author": {"login": "bernd"}, "path": "graylog2-server/src/main/java/org/graylog/security/authservice/backend/ADAuthServiceBackend.java", "diffHunk": "@@ -98,12 +98,17 @@ public ADAuthServiceBackend(UnboundLDAPConnector ldapConnector,\n                     return Optional.empty();\n                 }\n             }\n+            if (!userEntry.accountIsEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c8448581cf7fb291c812841461a24ecbd729d58"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa57c4c787ea6eb2684807236f58c021d70e6223", "author": {"user": {"login": "mpfz0r", "name": "Marco Pfatschbacher"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/fa57c4c787ea6eb2684807236f58c021d70e6223", "committedDate": "2020-11-09T09:37:52Z", "message": "Fix review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MTAyNDM3", "url": "https://github.com/Graylog2/graylog2-server/pull/9374#pullrequestreview-526102437", "createdAt": "2020-11-09T10:12:39Z", "commit": {"oid": "fa57c4c787ea6eb2684807236f58c021d70e6223"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3396, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}