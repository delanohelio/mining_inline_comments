{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3ODkzODA4", "number": 7952, "title": "Post events from export to be used for audit logging", "bodyText": "This PR adds audit log events for the CSV export. It should be rebased after the main export PR is merged #7709.", "createdAt": "2020-04-23T12:48:24Z", "url": "https://github.com/Graylog2/graylog2-server/pull/7952", "merged": true, "mergeCommit": {"oid": "d0c929680c5ee5455c8ea9da6b3d04ed0bd1c1a9"}, "closed": true, "closedAt": "2020-05-12T15:52:20Z", "author": {"login": "alex-konn"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcatMYhABqjMyNjgzODI0NDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgmDGLAFqTQxMDE2NDMxMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "05c65a69bd09d53ea35335840a99ab93d81f3f15", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/05c65a69bd09d53ea35335840a99ab93d81f3f15", "committedDate": "2020-04-23T13:29:20Z", "message": "Fix MessagesResourceTest\n\nAdded MessagesTestResource with mocked user"}, "afterCommit": {"oid": "67f9d806a908308e471b9f46818ea15eb7828b8f", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/67f9d806a908308e471b9f46818ea15eb7828b8f", "committedDate": "2020-04-24T08:26:48Z", "message": "Fix MessagesResourceTest\n\nAdded MessagesTestResource with mocked user"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "67f9d806a908308e471b9f46818ea15eb7828b8f", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/67f9d806a908308e471b9f46818ea15eb7828b8f", "committedDate": "2020-04-24T08:26:48Z", "message": "Fix MessagesResourceTest\n\nAdded MessagesTestResource with mocked user"}, "afterCommit": {"oid": "d10750d36395b6e71eba9abc4b91308c8f101553", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/d10750d36395b6e71eba9abc4b91308c8f101553", "committedDate": "2020-05-08T12:37:06Z", "message": "Use same event with type for requested and succeeded\n\nSince the events were identical, adding a type field makes things a bit simpler."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5MTQxMzkz", "url": "https://github.com/Graylog2/graylog2-server/pull/7952#pullrequestreview-409141393", "createdAt": "2020-05-11T12:51:50Z", "commit": {"oid": "d10750d36395b6e71eba9abc4b91308c8f101553"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxMjo1MTo1MFrOGTa20A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxMjo1MTo1MFrOGTa20A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzAxNjE0NA==", "bodyText": "I would add the limit for a rough estimation how many messages were exported. Or perhaps the total message count in the succeed case?", "url": "https://github.com/Graylog2/graylog2-server/pull/7952#discussion_r423016144", "createdAt": "2020-05-11T12:51:50Z", "author": {"login": "kmerz"}, "path": "graylog2-server/src/main/java/org/graylog/plugins/views/search/events/MessagesExportEvent.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.plugins.views.search.events;\n+\n+import com.fasterxml.jackson.annotation.JsonAutoDetect;\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.google.auto.value.AutoValue;\n+import com.google.common.collect.ImmutableMap;\n+import org.graylog.plugins.views.search.export.ExportMessagesCommand;\n+import org.graylog2.plugin.indexer.searches.timeranges.AbsoluteRange;\n+import org.joda.time.DateTime;\n+\n+import java.util.LinkedHashSet;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import static org.graylog.plugins.views.audit.ViewsAuditEventTypes.MESSAGES_EXPORT_REQUESTED;\n+import static org.graylog.plugins.views.audit.ViewsAuditEventTypes.MESSAGES_EXPORT_SUCCEEDED;\n+\n+@AutoValue\n+@JsonAutoDetect\n+public abstract class MessagesExportEvent {\n+\n+    public static MessagesExportEvent requested(DateTime startTime, String userName, ExportMessagesCommand command) {\n+        return from(startTime, userName, command, MESSAGES_EXPORT_REQUESTED);\n+    }\n+\n+    public static MessagesExportEvent succeeded(DateTime startTime, String userName, ExportMessagesCommand command) {\n+        return from(startTime, userName, command, MESSAGES_EXPORT_SUCCEEDED);\n+    }\n+\n+    private static MessagesExportEvent from(DateTime startTime, String userName, ExportMessagesCommand command, String auditType) {\n+        return Builder.create()\n+                .userName(userName)\n+                .auditType(auditType)\n+                .timestamp(startTime)\n+                .timeRange(command.timeRange())\n+                .queryString(command.queryString().queryString())\n+                .streams(command.streams())\n+                .fieldsInOrder(command.fieldsInOrder())\n+                .build();\n+    }\n+\n+    public abstract String userName();\n+\n+    public abstract String auditType();\n+\n+    public abstract DateTime timestamp();\n+\n+    public abstract AbsoluteRange timeRange();\n+\n+    public abstract String queryString();\n+\n+    public abstract Set<String> streams();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d10750d36395b6e71eba9abc4b91308c8f101553"}, "originalPosition": 68}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1176ee032a7c71285aa57d2ec412b5051d1bf7ce", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/1176ee032a7c71285aa57d2ec412b5051d1bf7ce", "committedDate": "2020-05-12T13:16:50Z", "message": "Send MessagesExportEvent for audit for all export variants"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77bf80b9b458346c3315f990d0a0913653b183ae", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/77bf80b9b458346c3315f990d0a0913653b183ae", "committedDate": "2020-05-12T13:16:50Z", "message": "Add user name to export audit event\n\nNo better idea than lamely passing it from the resource"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ac5bb58ca2bbbd27cc15814dfda2ef47c9b8fd4", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/0ac5bb58ca2bbbd27cc15814dfda2ef47c9b8fd4", "committedDate": "2020-05-12T13:16:51Z", "message": "Fix MessagesResourceTest\n\nAdded MessagesTestResource with mocked user"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b82e8eb10888372bd2a48ea0a85c8792c32faed", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/6b82e8eb10888372bd2a48ea0a85c8792c32faed", "committedDate": "2020-05-12T13:16:51Z", "message": "Added separate audit event for requested export\n\nThis allows auditing cases where exports where an export was requested, but never reached the point of logging the success. Some data could still have been retrieved."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5e00eb222314c5c2308089e1b5c0f77074c3f05", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/e5e00eb222314c5c2308089e1b5c0f77074c3f05", "committedDate": "2020-05-12T13:16:51Z", "message": "Use same event with type for requested and succeeded\n\nSince the events were identical, adding a type field makes things a bit simpler."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "920f60c992d56d2211a499a3d1ebc5b6a43a7a7d", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/920f60c992d56d2211a499a3d1ebc5b6a43a7a7d", "committedDate": "2020-05-12T13:16:52Z", "message": "Add limit to audit events"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "804268968ab5b732eebfa29a09c606c7702a20c0", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/804268968ab5b732eebfa29a09c606c7702a20c0", "committedDate": "2020-05-12T13:16:52Z", "message": "Extract audit event creation to separate class\n\n- Added MessagesExporter interface\n- Added AuditingMessagesExporter implementation\n- Extracted command creation from DecoratingMessagesExporter to allow AuditingMessagesExporter to implement the same interface\n\nCommandFactory has gotten a bit big, but a big advantage is that now all the weird mappings from Search, Query etc. are encapsulated there."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "191326ed3186af87c04d3eb9d80b9cb012f4851f", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/191326ed3186af87c04d3eb9d80b9cb012f4851f", "committedDate": "2020-05-12T11:27:09Z", "message": "Extract audit event creation to separate class\n\n- Added MessagesExporter interface\n- Added AuditingMessagesExporter implementation\n- Extracted command creation from DecoratingMessagesExporter to allow AuditingMessagesExporter to implement the same interface\n\nCommandFactory has gotten a bit big, but a big advantage is that now all the weird mappings from Search, Query etc. are encapsulated there."}, "afterCommit": {"oid": "804268968ab5b732eebfa29a09c606c7702a20c0", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/804268968ab5b732eebfa29a09c606c7702a20c0", "committedDate": "2020-05-12T13:16:52Z", "message": "Extract audit event creation to separate class\n\n- Added MessagesExporter interface\n- Added AuditingMessagesExporter implementation\n- Extracted command creation from DecoratingMessagesExporter to allow AuditingMessagesExporter to implement the same interface\n\nCommandFactory has gotten a bit big, but a big advantage is that now all the weird mappings from Search, Query etc. are encapsulated there."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33e7a4487ba40bd13f6c2c05d5047f6c7d048dec", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/33e7a4487ba40bd13f6c2c05d5047f6c7d048dec", "committedDate": "2020-05-12T15:00:59Z", "message": "Add search id and search type id to audit event, if present"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cdd95f351e7b69b64bd26daabd65d072a5bc278", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/4cdd95f351e7b69b64bd26daabd65d072a5bc278", "committedDate": "2020-05-12T15:06:44Z", "message": "Fixed getter naming in AuditContext"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cd9536f21a9b4d7a9995f9f06b2bd45aac530dc", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/8cd9536f21a9b4d7a9995f9f06b2bd45aac530dc", "committedDate": "2020-05-12T15:26:21Z", "message": "Fix map generation in MessagesExportEvent\n\nAccidentally included searchId for searchTypeId before.\nUsing Optional#ifPresent now."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMTY0MzEz", "url": "https://github.com/Graylog2/graylog2-server/pull/7952#pullrequestreview-410164313", "createdAt": "2020-05-12T15:31:26Z", "commit": {"oid": "8cd9536f21a9b4d7a9995f9f06b2bd45aac530dc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2427, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}