{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwMzgwNDM1", "number": 7108, "title": "Add current function to value path.", "bodyText": "Description\n\nMotivation and Context\n\n\nPrior to this change, only field:value pairs were added to the value path of a value in a data table. This led to empty/incomplete queries being generated from the \"Show documents for value\" action.\nThis change is now adding functions to the value path as well if they refer to a field. A function like this generates a _exists_:<field> clause, so all documents containing this field match.\nFixes #7103.\nFixes #7104.\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Refactoring (non-breaking change)\n Breaking change (fix or feature that would cause existing functionality to change)\n\nChecklist:\n\n\n\n My code follows the code style of this project.\n My change requires a change to the documentation.\n I have updated the documentation accordingly.\n I have read the CONTRIBUTING document.\n I have added tests to cover my changes.", "createdAt": "2020-01-08T10:15:09Z", "url": "https://github.com/Graylog2/graylog2-server/pull/7108", "merged": true, "mergeCommit": {"oid": "1b65cc240dcd4ceffd575cf7ac2b400ed0e7c6c8"}, "closed": true, "closedAt": "2020-01-10T14:05:11Z", "author": {"login": "dennisoelkers"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4n4WUAFqTM0MDQwODM4MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4_FaQgFqTM0MTE4MDk0NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwNDA4Mzgw", "url": "https://github.com/Graylog2/graylog2-server/pull/7108#pullrequestreview-340408380", "createdAt": "2020-01-09T10:04:46Z", "commit": {"oid": "183069f9dcba0932466f9406e41ad8510131aff9"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxMDowNDo0NlrOFbwmvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxMDo0ODoxNVrOFbx3yA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY1MjIyMg==", "bodyText": "What is the purpose of !value !== undefined, should it be value !== undefined?", "url": "https://github.com/Graylog2/graylog2-server/pull/7108#discussion_r364652222", "createdAt": "2020-01-09T10:04:46Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/views/components/datatable/DataTableEntry.jsx", "diffHunk": "@@ -31,25 +32,34 @@ const _column = (field: string, value: *, selectedQuery: string, idx: number, ty\n   <td key={`${selectedQuery}-${field}=${value}-${idx}`}>\n     <AdditionalContext.Provider value={{ valuePath }}>\n       <CustomHighlighting field={field} value={value}>\n-        {value && <Value field={field} type={type} value={value} queryId={selectedQuery} render={DecoratedValue} />}\n+        {value !== null && !value !== undefined ? <Value field={field} type={type} value={value} queryId={selectedQuery} render={DecoratedValue} /> : <EmptyValue />}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "183069f9dcba0932466f9406e41ad8510131aff9"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY3Mjk2OA==", "bodyText": "While testing these changes, I found another bug. When using the \"Show documents for value\" action, within a data table with the fields source and timestamp, the newly created widget will have these fields twice. Implementing something like this will fix the issue:\nconst newWidgetFields = uniq([...DEFAULT_MESSAGE_FIELDS, ...valuePathFields])\n...\n.fields(newWidgetFields)\n\nShould we fix the issue inside this PR or should I create an Issue, because the problem also exists in the master branch?", "url": "https://github.com/Graylog2/graylog2-server/pull/7108#discussion_r364672968", "createdAt": "2020-01-09T10:48:15Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/views/logic/valueactions/ShowDocumentsHandler.js", "diffHunk": "@@ -22,24 +22,35 @@ type Arguments = {\n   contexts: Contexts;\n };\n \n+const extractFieldsFromValuePath = (valuePath: ValuePath): Array<string> => {\n+  return valuePath.map(item => Object.entries(item)\n+    // $FlowFixMe: We know that values are strings\n+    .map(([key, value]: [string, string]) => (\n+      key === '_exists_' ? value : key)))\n+    .reduce((prev, cur) => [...prev, ...cur], [])\n+    .reduce((prev, cur) => (prev.includes(cur) ? prev : [...prev, cur]), []);\n+};\n+\n const ShowDocumentsHandler: ValueActionHandler = ({ contexts: { valuePath, widget, view } }: Arguments) => {\n   const mergedObject = valuePath.reduce((elem, acc) => ({ ...acc, ...elem }), {});\n   const widgetQuery = widget && widget.query ? widget.query.query_string : '';\n   const valuePathQuery = Object.entries(mergedObject)\n     .map(([k, v]) => `${k}:${escape(String(v))}`)\n     .reduce((prev: string, next: string) => addToQuery(prev, next), '');\n   const query = addToQuery(widgetQuery, valuePathQuery);\n+  const valuePathFields = extractFieldsFromValuePath(valuePath);\n   const newWidgetBuilder = MessagesWidget.builder()\n     .query(createElasticsearchQueryString(query))\n     .newId()\n     .config(new MessagesWidgetConfig.builder()\n-      .fields([...DEFAULT_MESSAGE_FIELDS, ...(Object.keys(mergedObject))])\n+      .fields([...DEFAULT_MESSAGE_FIELDS, ...valuePathFields])", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "183069f9dcba0932466f9406e41ad8510131aff9"}, "originalPosition": 26}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "183069f9dcba0932466f9406e41ad8510131aff9", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/183069f9dcba0932466f9406e41ad8510131aff9", "committedDate": "2020-01-08T10:10:39Z", "message": "Add current function to value path.\n\nPrior to this change, only field:value pairs were added to the value\npath of a value in a data table. This led to empty/incomplete queries\nbeing generated from the \"Show documents for value\" action.\n\nThis change is now adding functions to the value path as well if they\nrefer to a field. A function like this generates a `_exists_:<field>`\nclause, so all documents containing this field match.\n\nFixes #7103.\nFixes #7104."}, "afterCommit": {"oid": "02ce4cad199db07ba3157d98a211f61e60571d3e", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/02ce4cad199db07ba3157d98a211f61e60571d3e", "committedDate": "2020-01-10T13:25:03Z", "message": "Correcting conditional."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a31d58729d0a97c009ddc967077c7176d741ca16", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/a31d58729d0a97c009ddc967077c7176d741ca16", "committedDate": "2020-01-10T14:02:34Z", "message": "Return original term if new term is empty."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee1b37a088391d29306480858fee357e8a21e4be", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/ee1b37a088391d29306480858fee357e8a21e4be", "committedDate": "2020-01-10T14:02:34Z", "message": "Adjust flow types for helper function."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b43aaf71a3a04caa52348d0a1c3e7ae35ecfb51e", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/b43aaf71a3a04caa52348d0a1c3e7ae35ecfb51e", "committedDate": "2020-01-10T14:02:34Z", "message": "Extract field from value instead of key if value path segment is `_exists_` clause."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4397eda4f9bca7414c1be898b2b04a7280031d0", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/d4397eda4f9bca7414c1be898b2b04a7280031d0", "committedDate": "2020-01-10T14:02:34Z", "message": "Fix conditional rendering of `Value`/`EmptyValue`.\n\nFixes #7104."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14a2b548ac41e03ac0b0953f5fa3d3f3f79368d3", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/14a2b548ac41e03ac0b0953f5fa3d3f3f79368d3", "committedDate": "2020-01-10T14:02:51Z", "message": "Add current function to value path.\n\nPrior to this change, only field:value pairs were added to the value\npath of a value in a data table. This led to empty/incomplete queries\nbeing generated from the \"Show documents for value\" action.\n\nThis change is now adding functions to the value path as well if they\nrefer to a field. A function like this generates a `_exists_:<field>`\nclause, so all documents containing this field match.\n\nFixes #7103.\nFixes #7104."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9e5ce1edc0dcc77a42621b333421bb18d752bee", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/e9e5ce1edc0dcc77a42621b333421bb18d752bee", "committedDate": "2020-01-10T14:02:51Z", "message": "Correcting conditional."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbf9080e662d55d527e878755d78062def4302ee", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/fbf9080e662d55d527e878755d78062def4302ee", "committedDate": "2020-01-10T14:02:51Z", "message": "Do not include source/timestamp fields twice in resulting widget."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8cdc50bff0a53b47433bd50cbc5a80168a6bce47", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/8cdc50bff0a53b47433bd50cbc5a80168a6bce47", "committedDate": "2020-01-10T13:39:52Z", "message": "Do not include source/timestamp fields twice in resulting widget."}, "afterCommit": {"oid": "fbf9080e662d55d527e878755d78062def4302ee", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/fbf9080e662d55d527e878755d78062def4302ee", "committedDate": "2020-01-10T14:02:51Z", "message": "Do not include source/timestamp fields twice in resulting widget."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMTgwOTQ1", "url": "https://github.com/Graylog2/graylog2-server/pull/7108#pullrequestreview-341180945", "createdAt": "2020-01-10T14:04:37Z", "commit": {"oid": "fbf9080e662d55d527e878755d78062def4302ee"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2780, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}