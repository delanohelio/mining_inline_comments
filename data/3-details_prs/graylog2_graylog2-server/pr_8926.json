{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgxMTE3NDc1", "number": 8926, "title": "Add is_cloud flag and disable \"No input running\" warning", "bodyText": "Description\nAdd an is_cloud configuration flag. When enabled, certain in functionality/behavior in Graylog can be disabled or altered as appropriate for running in the Cloud environment.\nThis PR also skips checks in the ClusterHeathCheckThread, which currently only raise a System Notification when no inputs are running on a node. This notification is not appropriate for Cloud, since Forwarders/Forwarder Inputs are used instead of Inputs. So, a node in Graylog Cloud can be healthy when no inputs are running on it.\nHow Has This Been Tested?\nEnabled the is_cloud flag and observed that the system notification is not raised.\nDisabled the is_cloud flag, and observed that the notification is raised.\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Refactoring (non-breaking change)\n Breaking change (fix or feature that would cause existing functionality to change)\n\nCloses Graylog2/graylog-plugin-cloud#359", "createdAt": "2020-09-07T07:12:32Z", "url": "https://github.com/Graylog2/graylog2-server/pull/8926", "merged": true, "mergeCommit": {"oid": "1197b66e9768157cdfeccf0cc6202053518c912e"}, "closed": true, "closedAt": "2020-09-07T10:10:08Z", "author": {"login": "danotorrey"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdGdjc4gH2gAyNDgxMTE3NDc1OmE3NTBmMjBjMGZhNWNmMGI1NGYyNzZkMWU0YjhlNjYyN2JhNWJhMDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdGf0vtgFqTQ4MzQxNDQxNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a750f20c0fa5cf0b54f276d1e4b8e6627ba5ba01", "author": {"user": {"login": "danotorrey", "name": "Dan Torrey"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/a750f20c0fa5cf0b54f276d1e4b8e6627ba5ba01", "committedDate": "2020-09-07T07:06:45Z", "message": "Add is_cloud flag, and suppress input not running warning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b7e35eb380c4690e9a9a31cd202c081f5773e98", "author": {"user": {"login": "danotorrey", "name": "Dan Torrey"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/1b7e35eb380c4690e9a9a31cd202c081f5773e98", "committedDate": "2020-09-07T07:22:34Z", "message": "Fix check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87e3beb73c633745e68e9afd0e1705afa6b1dbd2", "author": {"user": {"login": "danotorrey", "name": "Dan Torrey"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/87e3beb73c633745e68e9afd0e1705afa6b1dbd2", "committedDate": "2020-09-07T07:23:19Z", "message": "Remove unneeded log message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMzU0NjE0", "url": "https://github.com/Graylog2/graylog2-server/pull/8926#pullrequestreview-483354614", "createdAt": "2020-09-07T08:27:01Z", "commit": {"oid": "87e3beb73c633745e68e9afd0e1705afa6b1dbd2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwODoyNzowMVrOHN1r3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwODoyNzoxNFrOHN1sWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI3MzExNg==", "bodyText": "I think we don't need to log this to info. If we do this in every place we use the flag, we will have a lot of messages at some point. \ud83d\ude09", "url": "https://github.com/Graylog2/graylog2-server/pull/8926#discussion_r484273116", "createdAt": "2020-09-07T08:27:01Z", "author": {"login": "bernd"}, "path": "graylog2-server/src/main/java/org/graylog2/periodical/ClusterHealthCheckThread.java", "diffHunk": "@@ -35,18 +36,25 @@\n     private NotificationService notificationService;\n     private final InputRegistry inputRegistry;\n     private final NodeId nodeId;\n+    private boolean isCloud;\n \n     @Inject\n     public ClusterHealthCheckThread(NotificationService notificationService,\n                                     InputRegistry inputRegistry,\n-                                    NodeId nodeId) {\n+                                    NodeId nodeId,\n+                                    @Named(\"is_cloud\") boolean isCloud) {\n         this.notificationService = notificationService;\n         this.inputRegistry = inputRegistry;\n         this.nodeId = nodeId;\n+        this.isCloud = isCloud;\n     }\n \n     @Override\n     public void doRun() {\n+        if (isCloud) {\n+            LOG.info(\"Skipping run of ClusterHealthCheckThread, since contained checks are not applicable for Cloud.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87e3beb73c633745e68e9afd0e1705afa6b1dbd2"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI3MzI0MA==", "bodyText": "Why did you reduce this to 1?", "url": "https://github.com/Graylog2/graylog2-server/pull/8926#discussion_r484273240", "createdAt": "2020-09-07T08:27:14Z", "author": {"login": "bernd"}, "path": "graylog2-server/src/main/java/org/graylog2/periodical/ClusterHealthCheckThread.java", "diffHunk": "@@ -103,7 +111,7 @@ public boolean startOnThisNode() {\n     public int getInitialDelaySeconds() {\n         // Wait some time until all inputs have been started otherwise this will trigger a notification on every\n         // startup of the server.\n-        return 120;\n+        return 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87e3beb73c633745e68e9afd0e1705afa6b1dbd2"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "640ce1146870eb90b6c6c1e8ed5413dcedeea1a2", "author": {"user": {"login": "danotorrey", "name": "Dan Torrey"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/640ce1146870eb90b6c6c1e8ed5413dcedeea1a2", "committedDate": "2020-09-07T08:42:51Z", "message": "Remove unneeded log message and unintended rate change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMzcxNjY1", "url": "https://github.com/Graylog2/graylog2-server/pull/8926#pullrequestreview-483371665", "createdAt": "2020-09-07T08:48:14Z", "commit": {"oid": "640ce1146870eb90b6c6c1e8ed5413dcedeea1a2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwODo0ODoxNVrOHN2c0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwODo0ODoxNVrOHN2c0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI4NTY1MA==", "bodyText": "I meant moving the log statement to debug. Now there is no explanation why we do this. \ud83d\ude09", "url": "https://github.com/Graylog2/graylog2-server/pull/8926#discussion_r484285650", "createdAt": "2020-09-07T08:48:15Z", "author": {"login": "bernd"}, "path": "graylog2-server/src/main/java/org/graylog2/periodical/ClusterHealthCheckThread.java", "diffHunk": "@@ -35,18 +36,24 @@\n     private NotificationService notificationService;\n     private final InputRegistry inputRegistry;\n     private final NodeId nodeId;\n+    private boolean isCloud;\n \n     @Inject\n     public ClusterHealthCheckThread(NotificationService notificationService,\n                                     InputRegistry inputRegistry,\n-                                    NodeId nodeId) {\n+                                    NodeId nodeId,\n+                                    @Named(\"is_cloud\") boolean isCloud) {\n         this.notificationService = notificationService;\n         this.inputRegistry = inputRegistry;\n         this.nodeId = nodeId;\n+        this.isCloud = isCloud;\n     }\n \n     @Override\n     public void doRun() {\n+        if (isCloud) {\n+            return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "640ce1146870eb90b6c6c1e8ed5413dcedeea1a2"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb9726dcbce041df0aa89b615e43e777defb5725", "author": {"user": {"login": "danotorrey", "name": "Dan Torrey"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/cb9726dcbce041df0aa89b615e43e777defb5725", "committedDate": "2020-09-07T09:23:21Z", "message": "Change log statement to debug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNDE0NDE2", "url": "https://github.com/Graylog2/graylog2-server/pull/8926#pullrequestreview-483414416", "createdAt": "2020-09-07T09:45:27Z", "commit": {"oid": "cb9726dcbce041df0aa89b615e43e777defb5725"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2896, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}