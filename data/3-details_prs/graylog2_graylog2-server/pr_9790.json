{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM4OTY1ODIw", "number": 9790, "title": "Add HTML emails compatibility for alerts notifications", "bodyText": "Description\nAdded a new html body field in email notification form so users can send html emails.\n\nIf html body is set the emails will be multi-part emails with both plaintext and html parts (if plaintext body is left empty it will use default template).\nIf only plaintext body is set, it will behave like before (only plaintext email)\nIf both are empty a form validation error will appear to at least fill one of them.\n\nMotivation and Context\nImplements #4569\nHow Has This Been Tested?\nI configured an event definition and a new email notification with html body and forced the event to trigger\nScreenshots (if appropriate):\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Refactoring (non-breaking change)\n Breaking change (fix or feature that would cause existing functionality to change)\n\nChecklist:\n\n\n\n My code follows the code style of this project.\n My change requires a change to the documentation.\n I have updated the documentation accordingly.\n I have read the CONTRIBUTING document.\n I have added tests to cover my changes.", "createdAt": "2020-12-13T15:05:26Z", "url": "https://github.com/Graylog2/graylog2-server/pull/9790", "merged": true, "mergeCommit": {"oid": "3f2570588cf100c823689fd47829cbc88e989b7b"}, "closed": true, "closedAt": "2021-01-05T16:12:12Z", "author": {"login": "radykal-com"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdlzSZQgH2gAyNTM4OTY1ODIwOjE1MDdmYzE0ZTIzMzgwZmU2ZjA3YWRhMGQ5NDlkZjhmZTljOTQ5OWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdtNRsPgFqTU2MTkyNDI0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1507fc14e23380fe6f07ada0d949df8fe9c9499f", "author": {"user": {"login": "radykal-com", "name": "Marc Ruiz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/1507fc14e23380fe6f07ada0d949df8fe9c9499f", "committedDate": "2020-12-13T15:57:41Z", "message": "Add HTML emails compatibility for alerts notifications"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "46cbc7a7054afa104119a9389519340d7840a4e0", "author": {"user": {"login": "radykal-com", "name": "Marc Ruiz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/46cbc7a7054afa104119a9389519340d7840a4e0", "committedDate": "2020-12-13T14:59:21Z", "message": "Add HTML emails compatibility for alerts notifications"}, "afterCommit": {"oid": "1507fc14e23380fe6f07ada0d949df8fe9c9499f", "author": {"user": {"login": "radykal-com", "name": "Marc Ruiz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/1507fc14e23380fe6f07ada0d949df8fe9c9499f", "committedDate": "2020-12-13T15:57:41Z", "message": "Add HTML emails compatibility for alerts notifications"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxNjMzOTAw", "url": "https://github.com/Graylog2/graylog2-server/pull/9790#pullrequestreview-561633900", "createdAt": "2021-01-05T09:28:23Z", "commit": {"oid": "1507fc14e23380fe6f07ada0d949df8fe9c9499f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQwOToyODoyM1rOIOP-rQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQwOTozNzo0MFrOIOQSLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgxMjc4MQ==", "bodyText": "We need to make sure that older content packs (without this field) are still installable.\nI suggest you initialize the htmlBodyTemplate in the Builder.create()\nhttps://github.com/Graylog2/graylog2-server/pull/9790/files#diff-455b0c407c9c4eac48cf30ae314d1e2222e29fb27954534f291d6a84b3facf87L70\n.htmlBodyTemplate(ValueReference.of(\"\"))", "url": "https://github.com/Graylog2/graylog2-server/pull/9790#discussion_r551812781", "createdAt": "2021-01-05T09:28:23Z", "author": {"login": "mpfz0r"}, "path": "graylog2-server/src/main/java/org/graylog/events/contentpack/entities/EmailEventNotificationConfigEntity.java", "diffHunk": "@@ -50,6 +51,9 @@\n     @JsonProperty(FIELD_BODY_TEMPLATE)\n     public abstract ValueReference bodyTemplate();\n \n+    @JsonProperty(FIELD_HTML_BODY_TEMPLATE)\n+    public abstract ValueReference htmlBodyTemplate();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1507fc14e23380fe6f07ada0d949df8fe9c9499f"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgxNDYwNg==", "bodyText": "This should be an empty String by default. We don't want to automatically upgrade existing notifications to HTML.", "url": "https://github.com/Graylog2/graylog2-server/pull/9790#discussion_r551814606", "createdAt": "2021-01-05T09:31:46Z", "author": {"login": "mpfz0r"}, "path": "graylog2-server/src/main/java/org/graylog/events/notifications/types/EmailEventNotificationConfig.java", "diffHunk": "@@ -134,7 +166,8 @@ public static Builder create() {\n                     .subject(DEFAULT_SUBJECT)\n                     .emailRecipients(ImmutableSet.of())\n                     .userRecipients(ImmutableSet.of())\n-                    .bodyTemplate(DEFAULT_BODY_TEMPLATE);\n+                    .bodyTemplate(DEFAULT_BODY_TEMPLATE)\n+                    .htmlBodyTemplate(DEFAULT_HTML_BODY_TEMPLATE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1507fc14e23380fe6f07ada0d949df8fe9c9499f"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgxNDgwMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                .htmlBodyTemplate(DEFAULT_HTML_BODY_TEMPLATE);\n          \n          \n            \n                                .htmlBodyTemplate(\"\");", "url": "https://github.com/Graylog2/graylog2-server/pull/9790#discussion_r551814800", "createdAt": "2021-01-05T09:32:09Z", "author": {"login": "mpfz0r"}, "path": "graylog2-server/src/main/java/org/graylog/events/notifications/types/EmailEventNotificationConfig.java", "diffHunk": "@@ -134,7 +166,8 @@ public static Builder create() {\n                     .subject(DEFAULT_SUBJECT)\n                     .emailRecipients(ImmutableSet.of())\n                     .userRecipients(ImmutableSet.of())\n-                    .bodyTemplate(DEFAULT_BODY_TEMPLATE);\n+                    .bodyTemplate(DEFAULT_BODY_TEMPLATE)\n+                    .htmlBodyTemplate(DEFAULT_HTML_BODY_TEMPLATE);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgxNDYwNg=="}, "originalCommit": {"oid": "1507fc14e23380fe6f07ada0d949df8fe9c9499f"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgxNjA3OQ==", "bodyText": "I think we should respect that user's wish and not fill in the default body if that is left empty.\n(see next comment on how I would handle this)", "url": "https://github.com/Graylog2/graylog2-server/pull/9790#discussion_r551816079", "createdAt": "2021-01-05T09:34:31Z", "author": {"login": "mpfz0r"}, "path": "graylog2-server/src/main/java/org/graylog/events/notifications/types/EmailSender.java", "diffHunk": "@@ -104,6 +103,21 @@ private String buildBody(EmailEventNotificationConfig config, Map<String, Object\n         return this.templateEngine.transform(template, model);\n     }\n \n+    @VisibleForTesting\n+    private String buildHtmlBody(EmailEventNotificationConfig config, Map<String, Object> model) {\n+        final String template;\n+        if (isNullOrEmpty(config.htmlBodyTemplate())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1507fc14e23380fe6f07ada0d949df8fe9c9499f"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgxNjQxOA==", "bodyText": "How about we keep using SimpleEmail if the html body is empty?", "url": "https://github.com/Graylog2/graylog2-server/pull/9790#discussion_r551816418", "createdAt": "2021-01-05T09:35:07Z", "author": {"login": "mpfz0r"}, "path": "graylog2-server/src/main/java/org/graylog/events/notifications/types/EmailSender.java", "diffHunk": "@@ -115,7 +129,7 @@ private void sendEmail(EmailEventNotificationConfig config, String emailAddress,\n             throw new TransportConfigurationException(\"Email transport is not enabled in server configuration file!\");\n         }\n \n-        final Email email = new SimpleEmail();\n+        final HtmlEmail email = new HtmlEmail();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1507fc14e23380fe6f07ada0d949df8fe9c9499f"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgxNzY0OA==", "bodyText": "Since we are now defaulting to an empty html body on the server side, we can actually remove that TODO,\nand also remove the DEFAULT_HTML_BODY_TEMPLATE from EmailEventNotificationConfig", "url": "https://github.com/Graylog2/graylog2-server/pull/9790#discussion_r551817648", "createdAt": "2021-01-05T09:37:21Z", "author": {"login": "mpfz0r"}, "path": "graylog2-web-interface/src/components/event-notifications/event-notification-types/EmailNotificationForm.jsx", "diffHunk": "@@ -50,6 +50,37 @@ Last messages accounting for this alert:\n \\${end}\n `;\n \n+// TODO: Default html body template should come from the server\n+const DEFAULT_HTML_BODY_TEMPLATE = `<table width=\"100%\" border=\"0\" cellpadding=\"10\" cellspacing=\"0\" style=\"background-color:#f9f9f9;border:none;line-height:1.2\"><tbody>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1507fc14e23380fe6f07ada0d949df8fe9c9499f"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgxNzc3Mg==", "bodyText": "same", "url": "https://github.com/Graylog2/graylog2-server/pull/9790#discussion_r551817772", "createdAt": "2021-01-05T09:37:40Z", "author": {"login": "mpfz0r"}, "path": "graylog2-web-interface/src/components/event-notifications/event-notification-types/EmailNotificationForm.jsx", "diffHunk": "@@ -63,6 +94,7 @@ class EmailNotificationForm extends React.Component {\n     // eslint-disable-next-line no-template-curly-in-string\n     subject: 'Graylog event notification: ${event_definition_title}', // TODO: Default subject should come from the server\n     body_template: DEFAULT_BODY_TEMPLATE, // TODO: Default body template should come from the server\n+    html_body_template: DEFAULT_HTML_BODY_TEMPLATE, // TODO: Default html body template should come from the server", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1507fc14e23380fe6f07ada0d949df8fe9c9499f"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd59eddfa5b9e0e152fb5f717e121d880c39e344", "author": {"user": {"login": "radykal-com", "name": "Marc Ruiz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/cd59eddfa5b9e0e152fb5f717e121d880c39e344", "committedDate": "2021-01-05T10:59:53Z", "message": "Default html body as empty string"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3d20f6daa1acfdb10dc8aaf58d0c71d54feb51c", "author": {"user": {"login": "radykal-com", "name": "Marc Ruiz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/a3d20f6daa1acfdb10dc8aaf58d0c71d54feb51c", "committedDate": "2021-01-05T10:59:53Z", "message": "Send only HtmlEmail when needed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxNzM5MzQ0", "url": "https://github.com/Graylog2/graylog2-server/pull/9790#pullrequestreview-561739344", "createdAt": "2021-01-05T12:11:31Z", "commit": {"oid": "cd59eddfa5b9e0e152fb5f717e121d880c39e344"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxMjoxMTozMlrOIOU8QA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxMjoxMTozMlrOIOU8QA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTg5NDA4MA==", "bodyText": "I've meant to keep this one, actually.\nHaving a nice default template is great. I just didn't want to force it on the users for existing notifications.\nBut it should be filled in when creating a new notification.", "url": "https://github.com/Graylog2/graylog2-server/pull/9790#discussion_r551894080", "createdAt": "2021-01-05T12:11:32Z", "author": {"login": "mpfz0r"}, "path": "graylog2-web-interface/src/components/event-notifications/event-notification-types/EmailNotificationForm.jsx", "diffHunk": "@@ -50,37 +50,6 @@ Last messages accounting for this alert:\n \\${end}\n `;\n \n-// TODO: Default html body template should come from the server", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd59eddfa5b9e0e152fb5f717e121d880c39e344"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b4bff27b56998bb508246cae25f33f5ba7cdc4b", "author": {"user": {"login": "radykal-com", "name": "Marc Ruiz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/3b4bff27b56998bb508246cae25f33f5ba7cdc4b", "committedDate": "2021-01-05T13:35:59Z", "message": "Restore default html body for new notifications"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxOTI0MjQ3", "url": "https://github.com/Graylog2/graylog2-server/pull/9790#pullrequestreview-561924247", "createdAt": "2021-01-05T16:11:55Z", "commit": {"oid": "3b4bff27b56998bb508246cae25f33f5ba7cdc4b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3239, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}