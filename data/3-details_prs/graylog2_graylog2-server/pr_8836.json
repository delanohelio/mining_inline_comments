{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwODY5ODUw", "number": 8836, "title": "Display confirm dialog on entity share modal save if grantees select is not empty", "bodyText": "When you assign a new grantee in the entity share modal it is easy to forget if you clicked on the \"Assign grantee\" button. With this PR we've implement a confirm dialog which appears if the grantees assignment select is not empty on save.\nFixes #8835\n/jenkins-pr-deps Graylog2/graylog-plugin-enterprise#1569", "createdAt": "2020-08-20T12:18:13Z", "url": "https://github.com/Graylog2/graylog2-server/pull/8836", "merged": true, "mergeCommit": {"oid": "92be5a7e15909bc3856fabc780b03e88125f24bc"}, "closed": true, "closedAt": "2020-08-21T12:05:11Z", "author": {"login": "linuspahl"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAvQUiABqjM2NzQ5NzgzODg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdBDoXhAFqTQ3MjQxODIyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c00d9312bf7e72fe304879403ca90b157974d55f", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/c00d9312bf7e72fe304879403ca90b157974d55f", "committedDate": "2020-08-20T12:13:43Z", "message": "Display confirm dialog on entity share modal save if grantees select is not empty"}, "afterCommit": {"oid": "42a1661ce3551d7fb7f6288ebedcc06d5d01c440", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/42a1661ce3551d7fb7f6288ebedcc06d5d01c440", "committedDate": "2020-08-20T12:20:27Z", "message": "Display confirm dialog on entity share modal save if grantees select is not empty"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ca7044aaf5e49fec473cc82e7c1598fadbf24a8c", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/ca7044aaf5e49fec473cc82e7c1598fadbf24a8c", "committedDate": "2020-08-20T15:23:28Z", "message": "Reset grantees selector after form submit"}, "afterCommit": {"oid": "0e248401c1bd7f0fa5f8ebee6a6a05c2118dedeb", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/0e248401c1bd7f0fa5f8ebee6a6a05c2118dedeb", "committedDate": "2020-08-20T15:25:20Z", "message": "Reset grantees selector after form submit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8179bf9955ab8f653093790a6c7a8be4344dc148", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/8179bf9955ab8f653093790a6c7a8be4344dc148", "committedDate": "2020-08-20T15:40:39Z", "message": "Display confirm dialog on entity share modal save if grantees select is not empty"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b45529f6e687677bee3d301ffb763d39ba59da1e", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/b45529f6e687677bee3d301ffb763d39ba59da1e", "committedDate": "2020-08-20T15:40:39Z", "message": "Reset grantees selector after form submit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0e248401c1bd7f0fa5f8ebee6a6a05c2118dedeb", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/0e248401c1bd7f0fa5f8ebee6a6a05c2118dedeb", "committedDate": "2020-08-20T15:25:20Z", "message": "Reset grantees selector after form submit"}, "afterCommit": {"oid": "b45529f6e687677bee3d301ffb763d39ba59da1e", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/b45529f6e687677bee3d301ffb763d39ba59da1e", "committedDate": "2020-08-20T15:40:39Z", "message": "Reset grantees selector after form submit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "151b256a2aedfe26c852a35edcdf9a6679c2ccbc", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/151b256a2aedfe26c852a35edcdf9a6679c2ccbc", "committedDate": "2020-08-21T08:03:37Z", "message": "Enable submit button after save is finished"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyMzE1OTU5", "url": "https://github.com/Graylog2/graylog2-server/pull/8836#pullrequestreview-472315959", "createdAt": "2020-08-21T08:49:36Z", "commit": {"oid": "151b256a2aedfe26c852a35edcdf9a6679c2ccbc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQwODo0OTozNlrOHEjiHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQwODo0OTozNlrOHEjiHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDUzODUyNQ==", "bodyText": "I tried to add a more complex test but this is not possible with due to the mocking and usage of the EntityShareStore. We will be able to handle the mocking better when we use the return value of our actions inside the EntityShareModal instead of the state from the EntityShareState", "url": "https://github.com/Graylog2/graylog2-server/pull/8836#discussion_r474538525", "createdAt": "2020-08-21T08:49:36Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/components/permissions/EntityShareModal.jsx", "diffHunk": "@@ -25,18 +25,40 @@ const EntityShareModal = ({ description, entityId, entityType, entityTitle, onCl\n   const { state: entityShareState } = useStore(EntityShareStore);\n   const [disableSubmit, setDisableSubmit] = useState(false);\n   const entityGRN = createGRN(entityType, entityId);\n+  const granteesSelectRef = useRef();\n \n   useEffect(() => {\n     EntityShareActions.prepare(entityGRN);\n   }, [entityGRN]);\n \n   const _handleSave = () => {\n     setDisableSubmit(true);\n+    const granteesSelect = granteesSelectRef?.current;\n+    const garnteesSelectValue = granteesSelect?.state?.value;\n+    const granteesSelectOptions = granteesSelect?.props?.options;\n     const payload: EntitySharePayload = {\n       selected_grantee_capabilities: entityShareState.selectedGranteeCapabilities,\n     };\n \n-    return EntityShareActions.update(entityGRN, payload).then(onClose);\n+    if (garnteesSelectValue) {\n+      const selectedOption = granteesSelectOptions?.find((option) => option.value === garnteesSelectValue);\n+\n+      if (!selectedOption) {\n+        throw Error(`Can't find ${garnteesSelectValue} in grantees select options on save`);\n+      }\n+\n+      // eslint-disable-next-line no-alert\n+      if (!window.confirm(`\"${selectedOption.label}\" got selected but was never added as a collaborator. Do you want to continue anyway?`)) {\n+        setDisableSubmit(false);\n+\n+        return;\n+      }\n+    }\n+\n+    EntityShareActions.update(entityGRN, payload).then(() => {\n+      setDisableSubmit(true);\n+      onClose();\n+    });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "151b256a2aedfe26c852a35edcdf9a6679c2ccbc"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyNDE4MjI3", "url": "https://github.com/Graylog2/graylog2-server/pull/8836#pullrequestreview-472418227", "createdAt": "2020-08-21T11:37:11Z", "commit": {"oid": "151b256a2aedfe26c852a35edcdf9a6679c2ccbc"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQxMTozNzoxMVrOHEp36A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQxMTozNzoxMVrOHEp36A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDY0MjQwOA==", "bodyText": "What about we do throw an error if we are running in development and ignore it if we are in production?", "url": "https://github.com/Graylog2/graylog2-server/pull/8836#discussion_r474642408", "createdAt": "2020-08-21T11:37:11Z", "author": {"login": "kmerz"}, "path": "graylog2-web-interface/src/components/permissions/EntityShareModal.jsx", "diffHunk": "@@ -25,18 +25,40 @@ const EntityShareModal = ({ description, entityId, entityType, entityTitle, onCl\n   const { state: entityShareState } = useStore(EntityShareStore);\n   const [disableSubmit, setDisableSubmit] = useState(false);\n   const entityGRN = createGRN(entityType, entityId);\n+  const granteesSelectRef = useRef();\n \n   useEffect(() => {\n     EntityShareActions.prepare(entityGRN);\n   }, [entityGRN]);\n \n   const _handleSave = () => {\n     setDisableSubmit(true);\n+    const granteesSelect = granteesSelectRef?.current;\n+    const garnteesSelectValue = granteesSelect?.state?.value;\n+    const granteesSelectOptions = granteesSelect?.props?.options;\n     const payload: EntitySharePayload = {\n       selected_grantee_capabilities: entityShareState.selectedGranteeCapabilities,\n     };\n \n-    return EntityShareActions.update(entityGRN, payload).then(onClose);\n+    if (garnteesSelectValue) {\n+      const selectedOption = granteesSelectOptions?.find((option) => option.value === garnteesSelectValue);\n+\n+      if (!selectedOption) {\n+        throw Error(`Can't find ${garnteesSelectValue} in grantees select options on save`);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "151b256a2aedfe26c852a35edcdf9a6679c2ccbc"}, "originalPosition": 32}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2847, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}