{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0NjgyMTY3", "number": 8488, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMDoxMzo0NFrOEOnpeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNTowNDo0NlrOEOunyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzNzY1MTE0OnYy", "diffSide": "RIGHT", "path": "graylog-storage-elasticsearch6/src/main/java/org/graylog/storage/elasticsearch6/SearchesAdapterES6.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMDoxMzo0NFrOGx3klQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMzo1NzowNlrOGx_YqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk0Mzg5Mw==", "bodyText": "I think we should use a constant somewhere instead of the magic number -1", "url": "https://github.com/Graylog2/graylog2-server/pull/8488#discussion_r454943893", "createdAt": "2020-07-15T10:13:44Z", "author": {"login": "alex-konn"}, "path": "graylog-storage-elasticsearch6/src/main/java/org/graylog/storage/elasticsearch6/SearchesAdapterES6.java", "diffHunk": "@@ -100,7 +100,8 @@ public ScrollResult scroll(ScrollCommand scrollCommand) {\n                 () -> \"Unable to perform scroll search\",\n                 searchQuery,\n                 DEFAULT_SCROLLTIME,\n-                scrollCommand.fields()\n+                scrollCommand.fields(),\n+                scrollCommand.limit().orElse(-1)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a78a5ed5cc6a7f907c9af9fcd1e39d65e14a9925"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA3MTkxMw==", "bodyText": "\u2714\ufe0f", "url": "https://github.com/Graylog2/graylog2-server/pull/8488#discussion_r455071913", "createdAt": "2020-07-15T13:57:06Z", "author": {"login": "dennisoelkers"}, "path": "graylog-storage-elasticsearch6/src/main/java/org/graylog/storage/elasticsearch6/SearchesAdapterES6.java", "diffHunk": "@@ -100,7 +100,8 @@ public ScrollResult scroll(ScrollCommand scrollCommand) {\n                 () -> \"Unable to perform scroll search\",\n                 searchQuery,\n                 DEFAULT_SCROLLTIME,\n-                scrollCommand.fields()\n+                scrollCommand.fields(),\n+                scrollCommand.limit().orElse(-1)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk0Mzg5Mw=="}, "originalCommit": {"oid": "a78a5ed5cc6a7f907c9af9fcd1e39d65e14a9925"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzODE2NjUyOnYy", "diffSide": "RIGHT", "path": "graylog-storage-elasticsearch7/src/main/java/org/graylog/storage/elasticsearch7/SearchesAdapterES7.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMjo0NzozMFrOGx8d7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMzo1OToyMFrOGx_e_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAyNDEwOQ==", "bodyText": "AGG_FILTER is unused. On purpose?", "url": "https://github.com/Graylog2/graylog2-server/pull/8488#discussion_r455024109", "createdAt": "2020-07-15T12:47:30Z", "author": {"login": "alex-konn"}, "path": "graylog-storage-elasticsearch7/src/main/java/org/graylog/storage/elasticsearch7/SearchesAdapterES7.java", "diffHunk": "@@ -0,0 +1,213 @@\n+package org.graylog.storage.elasticsearch7;\n+\n+import com.google.common.collect.Streams;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.action.search.SearchRequest;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.action.search.SearchResponse;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.aggregations.AggregationBuilders;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.aggregations.metrics.Cardinality;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.aggregations.metrics.ExtendedStats;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.aggregations.metrics.ValueCount;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.builder.SearchSourceBuilder;\n+import org.graylog2.indexer.ranges.IndexRange;\n+import org.graylog2.indexer.results.CountResult;\n+import org.graylog2.indexer.results.FieldStatsResult;\n+import org.graylog2.indexer.results.ResultMessage;\n+import org.graylog2.indexer.results.ScrollResult;\n+import org.graylog2.indexer.results.SearchResult;\n+import org.graylog2.indexer.searches.ScrollCommand;\n+import org.graylog2.indexer.searches.SearchesAdapter;\n+import org.graylog2.indexer.searches.SearchesConfig;\n+import org.graylog2.indexer.searches.Sorting;\n+import org.graylog2.plugin.indexer.searches.timeranges.TimeRange;\n+\n+import javax.inject.Inject;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import static com.google.common.base.MoreObjects.firstNonNull;\n+\n+public class SearchesAdapterES7 implements SearchesAdapter {\n+    private static final String AGG_CARDINALITY = \"gl2_field_cardinality\";\n+    private static final String AGG_EXTENDED_STATS = \"gl2_extended_stats\";\n+    private static final String AGG_FILTER = \"gl2_filter\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a78a5ed5cc6a7f907c9af9fcd1e39d65e14a9925"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA3MzUzNQ==", "bodyText": "\u2714\ufe0f", "url": "https://github.com/Graylog2/graylog2-server/pull/8488#discussion_r455073535", "createdAt": "2020-07-15T13:59:20Z", "author": {"login": "dennisoelkers"}, "path": "graylog-storage-elasticsearch7/src/main/java/org/graylog/storage/elasticsearch7/SearchesAdapterES7.java", "diffHunk": "@@ -0,0 +1,213 @@\n+package org.graylog.storage.elasticsearch7;\n+\n+import com.google.common.collect.Streams;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.action.search.SearchRequest;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.action.search.SearchResponse;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.aggregations.AggregationBuilders;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.aggregations.metrics.Cardinality;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.aggregations.metrics.ExtendedStats;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.aggregations.metrics.ValueCount;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.builder.SearchSourceBuilder;\n+import org.graylog2.indexer.ranges.IndexRange;\n+import org.graylog2.indexer.results.CountResult;\n+import org.graylog2.indexer.results.FieldStatsResult;\n+import org.graylog2.indexer.results.ResultMessage;\n+import org.graylog2.indexer.results.ScrollResult;\n+import org.graylog2.indexer.results.SearchResult;\n+import org.graylog2.indexer.searches.ScrollCommand;\n+import org.graylog2.indexer.searches.SearchesAdapter;\n+import org.graylog2.indexer.searches.SearchesConfig;\n+import org.graylog2.indexer.searches.Sorting;\n+import org.graylog2.plugin.indexer.searches.timeranges.TimeRange;\n+\n+import javax.inject.Inject;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import static com.google.common.base.MoreObjects.firstNonNull;\n+\n+public class SearchesAdapterES7 implements SearchesAdapter {\n+    private static final String AGG_CARDINALITY = \"gl2_field_cardinality\";\n+    private static final String AGG_EXTENDED_STATS = \"gl2_extended_stats\";\n+    private static final String AGG_FILTER = \"gl2_filter\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAyNDEwOQ=="}, "originalCommit": {"oid": "a78a5ed5cc6a7f907c9af9fcd1e39d65e14a9925"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzODE4NzY3OnYy", "diffSide": "RIGHT", "path": "graylog-storage-elasticsearch7/src/main/java/org/graylog/storage/elasticsearch7/Search.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMjo1Mjo1NFrOGx8qvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDowMzozOFrOGx_raw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAyNzM4OQ==", "bodyText": "I find the name Search a bit too broad here. I think this class deserves an abomination of a name like SearchRequestFactory or something to communicate more precisely what its role is in performing a search.", "url": "https://github.com/Graylog2/graylog2-server/pull/8488#discussion_r455027389", "createdAt": "2020-07-15T12:52:54Z", "author": {"login": "alex-konn"}, "path": "graylog-storage-elasticsearch7/src/main/java/org/graylog/storage/elasticsearch7/Search.java", "diffHunk": "@@ -0,0 +1,99 @@\n+package org.graylog.storage.elasticsearch7;\n+\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.index.query.BoolQueryBuilder;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.index.query.QueryBuilder;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.index.query.QueryBuilders;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.builder.SearchSourceBuilder;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.fetch.subphase.highlight.HighlightBuilder;\n+import org.graylog2.indexer.searches.SearchesConfig;\n+import org.graylog2.indexer.searches.Sorting;\n+import org.graylog2.plugin.indexer.searches.timeranges.TimeRange;\n+\n+import javax.annotation.Nullable;\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import static com.google.common.base.Strings.isNullOrEmpty;\n+import static org.graylog.shaded.elasticsearch7.org.elasticsearch.index.query.QueryBuilders.matchAllQuery;\n+import static org.graylog.shaded.elasticsearch7.org.elasticsearch.index.query.QueryBuilders.queryStringQuery;\n+\n+public class Search {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a78a5ed5cc6a7f907c9af9fcd1e39d65e14a9925"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA3NjcxNQ==", "bodyText": "\u2714\ufe0f", "url": "https://github.com/Graylog2/graylog2-server/pull/8488#discussion_r455076715", "createdAt": "2020-07-15T14:03:38Z", "author": {"login": "dennisoelkers"}, "path": "graylog-storage-elasticsearch7/src/main/java/org/graylog/storage/elasticsearch7/Search.java", "diffHunk": "@@ -0,0 +1,99 @@\n+package org.graylog.storage.elasticsearch7;\n+\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.index.query.BoolQueryBuilder;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.index.query.QueryBuilder;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.index.query.QueryBuilders;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.builder.SearchSourceBuilder;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.fetch.subphase.highlight.HighlightBuilder;\n+import org.graylog2.indexer.searches.SearchesConfig;\n+import org.graylog2.indexer.searches.Sorting;\n+import org.graylog2.plugin.indexer.searches.timeranges.TimeRange;\n+\n+import javax.annotation.Nullable;\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import static com.google.common.base.Strings.isNullOrEmpty;\n+import static org.graylog.shaded.elasticsearch7.org.elasticsearch.index.query.QueryBuilders.matchAllQuery;\n+import static org.graylog.shaded.elasticsearch7.org.elasticsearch.index.query.QueryBuilders.queryStringQuery;\n+\n+public class Search {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAyNzM4OQ=="}, "originalCommit": {"oid": "a78a5ed5cc6a7f907c9af9fcd1e39d65e14a9925"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzODM3MTc1OnYy", "diffSide": "RIGHT", "path": "graylog-storage-elasticsearch7/src/main/java/org/graylog/storage/elasticsearch7/ElasticsearchClient.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMzozNjoyMlrOGx-cmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDowNjoxMlrOGx_yyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA1NjUzOA==", "bodyText": "As discussed with @dennisoelkers, this method should get a more precise name (and possibly an explanatory comment - maybe even be marked as @Deprecated) to indicate that it's only necessary to be compatible with existing handling of IOExceptions in scrolling-related code.", "url": "https://github.com/Graylog2/graylog2-server/pull/8488#discussion_r455056538", "createdAt": "2020-07-15T13:36:22Z", "author": {"login": "alex-konn"}, "path": "graylog-storage-elasticsearch7/src/main/java/org/graylog/storage/elasticsearch7/ElasticsearchClient.java", "diffHunk": "@@ -86,6 +90,16 @@ private SearchResponse firstResponseFrom(MultiSearchResponse result, String erro\n         }\n     }\n \n+    public <R> R executeUnsafe(ThrowingBiFunction<RestHighLevelClient, RequestOptions, R, IOException> fn, String errorMessage) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a78a5ed5cc6a7f907c9af9fcd1e39d65e14a9925"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA3ODYwMQ==", "bodyText": "\u2714\ufe0f", "url": "https://github.com/Graylog2/graylog2-server/pull/8488#discussion_r455078601", "createdAt": "2020-07-15T14:06:12Z", "author": {"login": "dennisoelkers"}, "path": "graylog-storage-elasticsearch7/src/main/java/org/graylog/storage/elasticsearch7/ElasticsearchClient.java", "diffHunk": "@@ -86,6 +90,16 @@ private SearchResponse firstResponseFrom(MultiSearchResponse result, String erro\n         }\n     }\n \n+    public <R> R executeUnsafe(ThrowingBiFunction<RestHighLevelClient, RequestOptions, R, IOException> fn, String errorMessage) throws IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA1NjUzOA=="}, "originalCommit": {"oid": "a78a5ed5cc6a7f907c9af9fcd1e39d65e14a9925"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzODc5MzcxOnYy", "diffSide": "RIGHT", "path": "graylog2-server/src/main/java/org/graylog2/indexer/searches/ScrollCommand.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNTowNDo0NlrOGyClgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNTowNDo0NlrOGyClgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEyNDM1NA==", "bodyText": "NO_BATCHSIZE, NO_LIMIT, NO_GOD. I like it.", "url": "https://github.com/Graylog2/graylog2-server/pull/8488#discussion_r455124354", "createdAt": "2020-07-15T15:04:46Z", "author": {"login": "alex-konn"}, "path": "graylog2-server/src/main/java/org/graylog2/indexer/searches/ScrollCommand.java", "diffHunk": "@@ -31,6 +31,9 @@\n @AutoValue\n @JsonAutoDetect\n public abstract class ScrollCommand {\n+    public static final int NO_BATCHSIZE = -1;\n+    public static final int NO_LIMIT = -1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01cb4c19a2db3cf26e022dce10788d522f26da64"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4110, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}