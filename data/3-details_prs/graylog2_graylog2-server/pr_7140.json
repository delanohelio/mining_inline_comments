{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxMzgxMjY3", "number": 7140, "title": "Convert week/month bucket interval to days if value is bigger than 1.", "bodyText": "Description\n\nMotivation and Context\n\n\nDue to limitations in Elasticsearch, it does not support time unit\nbucket intervals with values bigger than 1 for units bigger than days.\nTherefore, this PR transparently converts these to days (with multiples\nof 7 resp. 30) if the value is bigger than 1, leaving the original unit\notherwise.\nIn contrast to the initial attempt in #7055, this PR is performing the\nchange in the backend, transparent to the caller and relieving the\ncaller from having to do the conversion before.\nFixes #7022.\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Refactoring (non-breaking change)\n Breaking change (fix or feature that would cause existing functionality to change)\n\nChecklist:\n\n\n\n My code follows the code style of this project.\n My change requires a change to the documentation.\n I have updated the documentation accordingly.\n I have read the CONTRIBUTING document.\n I have added tests to cover my changes.", "createdAt": "2020-01-10T10:25:26Z", "url": "https://github.com/Graylog2/graylog2-server/pull/7140", "merged": true, "mergeCommit": {"oid": "815c1a8a25dbb2e63d0d53d48a163e2bd1328737"}, "closed": true, "closedAt": "2020-01-10T13:34:13Z", "author": {"login": "dennisoelkers"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb475nSgH2gAyMzYxMzgxMjY3OjJmYjBmNTAzN2ZiMjJlMzc4ZjY1MzYyYzY4NzFhY2U5ZTk1MjQzNGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4-pXVgFqTM0MTE2MzU3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2fb0f5037fb22e378f65362c6871ace9e952434c", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/2fb0f5037fb22e378f65362c6871ace9e952434c", "committedDate": "2020-01-10T10:22:01Z", "message": "Convert week/month bucket interval to days if value is bigger than 1.\n\nDue to limitations in Elasticsearch, it does not support time unit\nbucket intervals with values bigger than 1 for units bigger than days.\nTherefore, this PR transparently converts these to days (with multiples\nof 7 resp. 30) if the value is bigger than 1, leaving the original unit\notherwise.\n\nIn contrast to the initial attempt in #7055, this PR is performing the\nchange in the backend, transparent to the caller and relieving the\ncaller from having to do the conversion before.\n\nFixes #7022."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44f38fa4433cd5e12145c820f4b6db819fa3a09d", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/44f38fa4433cd5e12145c820f4b6db819fa3a09d", "committedDate": "2020-01-10T10:26:51Z", "message": "Adding license header."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMTAwNjQ4", "url": "https://github.com/Graylog2/graylog2-server/pull/7140#pullrequestreview-341100648", "createdAt": "2020-01-10T11:18:06Z", "commit": {"oid": "44f38fa4433cd5e12145c820f4b6db819fa3a09d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxMToxODowNlrOFcRSNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxMTozMzoyNFrOFcRoUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE4NzYzNg==", "bodyText": "What's the benefit of specifying a radix of 10 here explicitly? I would find it clearer, if we omitted it.", "url": "https://github.com/Graylog2/graylog2-server/pull/7140#discussion_r365187636", "createdAt": "2020-01-10T11:18:06Z", "author": {"login": "alex-konn"}, "path": "graylog2-server/src/main/java/org/graylog/plugins/views/search/searchtypes/pivot/buckets/TimeUnitInterval.java", "diffHunk": "@@ -24,21 +24,45 @@\n import org.elasticsearch.search.aggregations.bucket.histogram.DateHistogramInterval;\n import org.graylog2.plugin.indexer.searches.timeranges.TimeRange;\n \n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+\n @AutoValue\n @JsonTypeName(TimeUnitInterval.type)\n @JsonDeserialize(builder = TimeUnitInterval.Builder.class)\n public abstract class TimeUnitInterval implements Interval {\n     public static final String type = \"timeunit\";\n+    public static final Pattern TIMEUNIT_PATTERN = Pattern.compile(\"(?<quantity>\\\\d+)(?<unit>[smhdwM])\");\n \n     @JsonProperty\n     public abstract String type();\n \n     @JsonProperty\n     public abstract String timeunit();\n \n+    private String adjustUnitsLongerThanDays(String timeunit) {\n+        final Matcher matcher = TIMEUNIT_PATTERN.matcher(timeunit());\n+        checkArgument(matcher.matches(),\n+                \"Time unit must be {quantity}{unit}, where quantity is a positive number and unit [smhdwM].\");\n+        final int quantity = Integer.parseInt(matcher.group(\"quantity\"), 10);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44f38fa4433cd5e12145c820f4b6db819fa3a09d"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE4OTM5MQ==", "bodyText": "Can we move the method below toDateHistogramInterval where it's first used?", "url": "https://github.com/Graylog2/graylog2-server/pull/7140#discussion_r365189391", "createdAt": "2020-01-10T11:23:08Z", "author": {"login": "alex-konn"}, "path": "graylog2-server/src/main/java/org/graylog/plugins/views/search/searchtypes/pivot/buckets/TimeUnitInterval.java", "diffHunk": "@@ -24,21 +24,45 @@\n import org.elasticsearch.search.aggregations.bucket.histogram.DateHistogramInterval;\n import org.graylog2.plugin.indexer.searches.timeranges.TimeRange;\n \n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+\n @AutoValue\n @JsonTypeName(TimeUnitInterval.type)\n @JsonDeserialize(builder = TimeUnitInterval.Builder.class)\n public abstract class TimeUnitInterval implements Interval {\n     public static final String type = \"timeunit\";\n+    public static final Pattern TIMEUNIT_PATTERN = Pattern.compile(\"(?<quantity>\\\\d+)(?<unit>[smhdwM])\");\n \n     @JsonProperty\n     public abstract String type();\n \n     @JsonProperty\n     public abstract String timeunit();\n \n+    private String adjustUnitsLongerThanDays(String timeunit) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44f38fa4433cd5e12145c820f4b6db819fa3a09d"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE5MjA0Mw==", "bodyText": "\ud83d\udc4d for validating the exception message! I usually put the message in a static field on the class and reference it in the test to avoid having it to change it in two places when the time comes.", "url": "https://github.com/Graylog2/graylog2-server/pull/7140#discussion_r365192043", "createdAt": "2020-01-10T11:30:00Z", "author": {"login": "alex-konn"}, "path": "graylog2-server/src/test/java/org/graylog/plugins/views/search/searchtypes/pivot/buckets/TimeUnitIntervalTest.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.plugins.views.search.searchtypes.pivot.buckets;\n+\n+import org.elasticsearch.search.aggregations.bucket.histogram.DateHistogramInterval;\n+import org.graylog2.plugin.indexer.searches.timeranges.InvalidRangeParametersException;\n+import org.graylog2.plugin.indexer.searches.timeranges.RelativeRange;\n+import org.junit.Test;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatExceptionOfType;\n+\n+public class TimeUnitIntervalTest {\n+    private TimeUnitInterval.Builder builder() {\n+        return TimeUnitInterval.Builder.builder();\n+    }\n+\n+    @Test\n+    public void doesNotAllowInvalidTimeUnit() {\n+        assertThatExceptionOfType(RuntimeException.class)\n+                .isThrownBy(() -> builder().timeunit(\"foobar\").build())\n+                .withMessage(\"Time unit must be {quantity}{unit}, where quantity is a positive number and unit [smhdwM].\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44f38fa4433cd5e12145c820f4b6db819fa3a09d"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE5MzI5OQ==", "bodyText": "Nice and clean tests! I think they could be further improved by using parameterized tests. That would make them even more compact and facilitate adding more cases. Totally optional though. The tests are fine as they are now.", "url": "https://github.com/Graylog2/graylog2-server/pull/7140#discussion_r365193299", "createdAt": "2020-01-10T11:33:24Z", "author": {"login": "alex-konn"}, "path": "graylog2-server/src/test/java/org/graylog/plugins/views/search/searchtypes/pivot/buckets/TimeUnitIntervalTest.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.plugins.views.search.searchtypes.pivot.buckets;\n+\n+import org.elasticsearch.search.aggregations.bucket.histogram.DateHistogramInterval;\n+import org.graylog2.plugin.indexer.searches.timeranges.InvalidRangeParametersException;\n+import org.graylog2.plugin.indexer.searches.timeranges.RelativeRange;\n+import org.junit.Test;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatExceptionOfType;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44f38fa4433cd5e12145c820f4b6db819fa3a09d"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "710685b574b2a1cc78de6c5e8eb293c8c42c6107", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/710685b574b2a1cc78de6c5e8eb293c8c42c6107", "committedDate": "2020-01-10T12:10:24Z", "message": "Moving private method below its consumer."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c3bdaadbdbed24df2a3a59ce9e5840f32345a93", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/5c3bdaadbdbed24df2a3a59ce9e5840f32345a93", "committedDate": "2020-01-10T12:10:52Z", "message": "Removing optional radix parameter for clarity."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52907def91e359d72a00cf79fd93b28d15bcc171", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/52907def91e359d72a00cf79fd93b28d15bcc171", "committedDate": "2020-01-10T12:33:45Z", "message": "Parameterizing tests, extracting message constant."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c899fab0b2669b8b506a9066a47a99b149cd4d49", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/c899fab0b2669b8b506a9066a47a99b149cd4d49", "committedDate": "2020-01-10T12:46:16Z", "message": "Fixing license header."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMTYzNTcx", "url": "https://github.com/Graylog2/graylog2-server/pull/7140#pullrequestreview-341163571", "createdAt": "2020-01-10T13:33:59Z", "commit": {"oid": "c899fab0b2669b8b506a9066a47a99b149cd4d49"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2802, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}