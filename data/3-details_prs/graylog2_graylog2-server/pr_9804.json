{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwMjU1NDQ0", "number": 9804, "title": "Unblock JobSchedulerService on shutdown", "bodyText": "Description\n\nThis change adds an interruptible implementation to wait for the server\nreaching the RUNNING state. The new method is then used in the\nJobSchedulerService. Upon shutdown, the execution thread of the\nJobSchedulerService is interrupted so that the service can\nproperly terminate.\nMotivation and Context\n\n\nThe JobSchedulerService blocks in its run method until the server\nreaches the running state. It cannot be unblocked even when interrupting\nthe execution thread. So if one of the other services fails during\nstartup, the service manager is unable to shutdown the\nJobSchedulerService.\nFixes #8742\nHow Has This Been Tested?\n\n\n\nManually tested with the following steps:\n\nMake the JerseyService fail on startup by setting the following graylog.conf:\n\nhttp_bind_address = 255.255.255.255:9999\n\n\nStart the Graylog server. Without the fix, the server will enter the shutdown sequence but the process will never terminate. With the fix, the server will terminate.\n\nScreenshots (if appropriate):\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Refactoring (non-breaking change)\n Breaking change (fix or feature that would cause existing functionality to change)\n\nChecklist:\n\n\n\n My code follows the code style of this project.\n My change requires a change to the documentation.\n I have updated the documentation accordingly.\n I have read the CONTRIBUTING document.\n I have added tests to cover my changes.", "createdAt": "2020-12-15T13:34:17Z", "url": "https://github.com/Graylog2/graylog2-server/pull/9804", "merged": true, "mergeCommit": {"oid": "e6a5a3f505d1a336ad2683191b905661e64450b8"}, "closed": true, "closedAt": "2020-12-16T09:53:45Z", "author": {"login": "thll"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmaT9AgH2gAyNTQwMjU1NDQ0OjI3MmZmOWQ5Y2MwYmFhMzVmZTZlZWY0Y2RlNzQwMzM0MzY5MjE2YWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmreOEgFqTU1MzQ5NzM0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "272ff9d9cc0baa35fe6eef4cde740334369216ac", "author": {"user": {"login": "thll", "name": "Othello Maurer"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/272ff9d9cc0baa35fe6eef4cde740334369216ac", "committedDate": "2020-12-15T13:25:41Z", "message": "Unblock JobSchedulerService on shutdown\n\nThe JobSchedulerService blocks in its run method until the server\nreaches the running state. It cannot be unblocked even when interrupting\nthe execution thread. So if one of the other services fails during\nstartup, the service manager is unable to shutdown the\nJobSchedulerService.\n\nThis change adds an interruptible implementation to wait for the server\nreaching the RUNNING state. The new method is then used in the\nJobSchedulerService. Upon shutdown, the execution thread of the\nJobSchedulerService is interrupted so that the service can\nproperly terminate."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNzE2NzIw", "url": "https://github.com/Graylog2/graylog2-server/pull/9804#pullrequestreview-552716720", "createdAt": "2020-12-15T17:50:17Z", "commit": {"oid": "272ff9d9cc0baa35fe6eef4cde740334369216ac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNDY1MDUz", "url": "https://github.com/Graylog2/graylog2-server/pull/9804#pullrequestreview-553465053", "createdAt": "2020-12-16T08:44:46Z", "commit": {"oid": "272ff9d9cc0baa35fe6eef4cde740334369216ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwODo0NDo0NlrOIG6C0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwODo0NDo0NlrOIG6C0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDExMzM2MA==", "bodyText": "Hmm,  why do we need this?\nThe thread is already interrupted. Or am I missing something?", "url": "https://github.com/Graylog2/graylog2-server/pull/9804#discussion_r544113360", "createdAt": "2020-12-16T08:44:46Z", "author": {"login": "mpfz0r"}, "path": "graylog2-server/src/main/java/org/graylog/scheduler/JobSchedulerService.java", "diffHunk": "@@ -69,14 +70,21 @@ public JobSchedulerService(JobExecutionEngine.Factory engineFactory,\n     @Override\n     protected void startUp() throws Exception {\n         schedulerEventBus.register(this);\n+        this.executionThread = Thread.currentThread();\n     }\n \n     @Override\n     protected void run() throws Exception {\n         // Safety measure to make sure everything is started before we start job scheduling.\n         LOG.debug(\"Waiting for server to enter RUNNING status before starting the scheduler loop\");\n-        serverStatus.awaitRunning(() -> LOG.debug(\"Server entered RUNNING state, starting scheduler loop\"));\n-\n+        try {\n+            serverStatus.awaitRunning();\n+        } catch (InterruptedException e) {\n+            Thread.currentThread().interrupt();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "272ff9d9cc0baa35fe6eef4cde740334369216ac"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNDY1OTkx", "url": "https://github.com/Graylog2/graylog2-server/pull/9804#pullrequestreview-553465991", "createdAt": "2020-12-16T08:46:00Z", "commit": {"oid": "272ff9d9cc0baa35fe6eef4cde740334369216ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwODo0NjowMFrOIG6F0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwODo0NjowMFrOIG6F0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDExNDEyOQ==", "bodyText": "We could still mark this one @Deprecated\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void awaitRunning(final Runnable runnable) {\n          \n          \n            \n                @Deprecated\n          \n          \n            \n                public void awaitRunning(final Runnable runnable) {", "url": "https://github.com/Graylog2/graylog2-server/pull/9804#discussion_r544114129", "createdAt": "2020-12-16T08:46:00Z", "author": {"login": "mpfz0r"}, "path": "graylog2-server/src/main/java/org/graylog2/plugin/ServerStatus.java", "diffHunk": "@@ -149,6 +149,11 @@ public void overrideLoadBalancerThrottled() {\n         publishLifecycle(Lifecycle.OVERRIDE_LB_THROTTLED);\n     }\n \n+    /**\n+     * Blocks until the server enters the RUNNING state and then executes the given Runnable.\n+     * <p>\n+     * <b>This method is not interruptible while waiting for the server to enter the RUNNING state.</b>\n+     */\n     public void awaitRunning(final Runnable runnable) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "272ff9d9cc0baa35fe6eef4cde740334369216ac"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNDY2NzQx", "url": "https://github.com/Graylog2/graylog2-server/pull/9804#pullrequestreview-553466741", "createdAt": "2020-12-16T08:46:59Z", "commit": {"oid": "272ff9d9cc0baa35fe6eef4cde740334369216ac"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a6045c4280454403cfb2c266e606d10c8f553eb", "author": {"user": {"login": "thll", "name": "Othello Maurer"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/2a6045c4280454403cfb2c266e606d10c8f553eb", "committedDate": "2020-12-16T09:04:54Z", "message": "Deprecate #awaitRunning(Runnable runnable)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNDk3MzQ0", "url": "https://github.com/Graylog2/graylog2-server/pull/9804#pullrequestreview-553497344", "createdAt": "2020-12-16T09:25:17Z", "commit": {"oid": "2a6045c4280454403cfb2c266e606d10c8f553eb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3243, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}