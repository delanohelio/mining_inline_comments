{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyOTM5NDc4", "number": 9316, "title": "Fail graciously when cannot get node metrics", "bodyText": "Ensure we can load the node metrics page, also when it was not possible getting node metrics.\nThis was tested with the patch included in the issue description:\n--- a/graylog2-server/src/main/java/org/graylog2/rest/resources/cluster/ClusterNodeMetricsResource.java\n+++ b/graylog2-server/src/main/java/org/graylog2/rest/resources/cluster/ClusterNodeMetricsResource.java\n@@ -120,6 +120,9 @@ public class ClusterNodeMetricsResource extends ProxiedResource {\n                                               @ApiParam(name = \"namespace\", required = true)\n                                               @PathParam(\"namespace\") String namespace) throws IOException, NodeNotFoundException {\n         final Response<MetricsSummaryResponse> result = getResourceForNode(nodeId).byNamespace(namespace).execute();\n+        if (Math.random() > 0.25) {\n+            throw new RuntimeException(\"YOLO\");\n+        }\n         if (result.isSuccessful()) {\n             return result.body();\n         } else {\n\nThis also needs to be backported into 3.3.\nFixes #9315", "createdAt": "2020-10-30T11:42:44Z", "url": "https://github.com/Graylog2/graylog2-server/pull/9316", "merged": true, "mergeCommit": {"oid": "db7c6572f44c336d33547110a19e8f3258c51454"}, "closed": true, "closedAt": "2020-11-04T14:14:09Z", "author": {"login": "edmundoa"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdY1hEDAH2gAyNTEyOTM5NDc4OmU5ZDc1ODIxMGI1ODFmN2ZjZTNkZjc0NzgwMDgyZGZmODkzYjVhZWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZOQApAFqTUyMzM4Njc2Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e9d758210b581f7fce3df74780082dff893b5aee", "author": {"user": {"login": "edmundoa", "name": "Edmundo Alvarez"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/e9d758210b581f7fce3df74780082dff893b5aee", "committedDate": "2020-11-03T09:12:30Z", "message": "Fail graciously when cannot get node metrics\n\nEnsure we can load the node metrics page, also when it was not possible\ngetting node metrics.\n\nFixes #9315"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "efe6986bab183b3ed8e68595c78062d1b7ece6b3", "author": {"user": {"login": "edmundoa", "name": "Edmundo Alvarez"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/efe6986bab183b3ed8e68595c78062d1b7ece6b3", "committedDate": "2020-10-30T11:37:45Z", "message": "Fail graciously when cannot get node metrics\n\nEnsure we can load the node metrics page, also when it was not possible\ngetting node metrics.\n\nFixes #9315"}, "afterCommit": {"oid": "e9d758210b581f7fce3df74780082dff893b5aee", "author": {"user": {"login": "edmundoa", "name": "Edmundo Alvarez"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/e9d758210b581f7fce3df74780082dff893b5aee", "committedDate": "2020-11-03T09:12:30Z", "message": "Fail graciously when cannot get node metrics\n\nEnsure we can load the node metrics page, also when it was not possible\ngetting node metrics.\n\nFixes #9315"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNDg1ODE4", "url": "https://github.com/Graylog2/graylog2-server/pull/9316#pullrequestreview-522485818", "createdAt": "2020-11-03T13:20:06Z", "commit": {"oid": "e9d758210b581f7fce3df74780082dff893b5aee"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxMzoyMDowNlrOHsuaZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxMzoyMDowNlrOHsuaZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY1OTgxMg==", "bodyText": "We are returning error from the promise handler there. Do we want to make use of that in the error handling part of the ShowMetricsPage and show the error there?", "url": "https://github.com/Graylog2/graylog2-server/pull/9316#discussion_r516659812", "createdAt": "2020-11-03T13:20:06Z", "author": {"login": "dennisoelkers"}, "path": "graylog2-web-interface/src/stores/metrics/MetricsStore.js", "diffHunk": "@@ -169,6 +170,11 @@ const MetricsStore = Reflux.createStore({\n \n       return fetch('GET', url).then((response) => {\n         return { nodeId: nodeId, names: response.metrics };\n+      }, (error) => {\n+        UserNotification.error(`Fetching metrics for node [${nodeId}] failed with: ${error}.`,\n+          'Could not fetch node metrics');\n+        // When fetching metrics fails, keep previous available metrics around, letting user see them\n+        return { nodeId: nodeId, names: this.metricsNames[nodeId], error: error };", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9d758210b581f7fce3df74780082dff893b5aee"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "348346cd989b903c0b1a8bb2d98073ba47877d80", "author": {"user": {"login": "edmundoa", "name": "Edmundo Alvarez"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/348346cd989b903c0b1a8bb2d98073ba47877d80", "committedDate": "2020-11-04T11:46:51Z", "message": "Improve feedback when cannot fetch metrics\n\nWhen the web interface cannot get node metrics, avoid using excessive\ntoastr notifications, and replace them with something more useful. Also\nensure the contents don't jump, avoiding users to lose track of metrics\nthey may be observing."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMzA4MzQ0", "url": "https://github.com/Graylog2/graylog2-server/pull/9316#pullrequestreview-523308344", "createdAt": "2020-11-04T12:19:10Z", "commit": {"oid": "348346cd989b903c0b1a8bb2d98073ba47877d80"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMzEzNzA4", "url": "https://github.com/Graylog2/graylog2-server/pull/9316#pullrequestreview-523313708", "createdAt": "2020-11-04T12:27:00Z", "commit": {"oid": "348346cd989b903c0b1a8bb2d98073ba47877d80"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjoyNzowMFrOHtV89w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjoyNzowMFrOHtV89w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMwNzYzOQ==", "bodyText": "When I am going to the node metrics page with your patch applied, I end up here (ShowMetricsPage.jsx:66), which does not show the error message of the error that occurred. Maybe we should centralize error handling in one of the two components (ShowMetricsPage vs. MetricsComponent) instead of doing it in both?", "url": "https://github.com/Graylog2/graylog2-server/pull/9316#discussion_r517307639", "createdAt": "2020-11-04T12:27:00Z", "author": {"login": "dennisoelkers"}, "path": "graylog2-web-interface/src/stores/metrics/MetricsStore.js", "diffHunk": "@@ -169,6 +170,11 @@ const MetricsStore = Reflux.createStore({\n \n       return fetch('GET', url).then((response) => {\n         return { nodeId: nodeId, names: response.metrics };\n+      }, (error) => {\n+        UserNotification.error(`Fetching metrics for node [${nodeId}] failed with: ${error}.`,\n+          'Could not fetch node metrics');\n+        // When fetching metrics fails, keep previous available metrics around, letting user see them\n+        return { nodeId: nodeId, names: this.metricsNames[nodeId], error: error };", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY1OTgxMg=="}, "originalCommit": {"oid": "e9d758210b581f7fce3df74780082dff893b5aee"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe6128749d26b50dc3b9e224f818efdec251500d", "author": {"user": {"login": "edmundoa", "name": "Edmundo Alvarez"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/fe6128749d26b50dc3b9e224f818efdec251500d", "committedDate": "2020-11-04T13:21:20Z", "message": "Use right property to get colors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2be51283075c55f85453b73fd0dcbde182afc33d", "author": {"user": {"login": "edmundoa", "name": "Edmundo Alvarez"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/2be51283075c55f85453b73fd0dcbde182afc33d", "committedDate": "2020-11-04T13:21:34Z", "message": "Display error and make text clearer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "938a679b9bcf0446cdce6d2fc78a17dbfd26d9bf", "author": {"user": {"login": "edmundoa", "name": "Edmundo Alvarez"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/938a679b9bcf0446cdce6d2fc78a17dbfd26d9bf", "committedDate": "2020-11-04T13:28:35Z", "message": "Remove error handling from ShowMetricsPage"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMzg2NzY3", "url": "https://github.com/Graylog2/graylog2-server/pull/9316#pullrequestreview-523386767", "createdAt": "2020-11-04T14:01:30Z", "commit": {"oid": "938a679b9bcf0446cdce6d2fc78a17dbfd26d9bf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3473, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}