{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyMjAxNDYz", "number": 8682, "title": "Making LDAP TLS/SSL tests faster and more reliable.", "bodyText": "Description\n\nMotivation and Context\n\n\nThis change is doing two things for the LDAP authenticator SSL/TLS tests:\n\n\nMaking them more reliable\nBefore this change, running the complete test class worked, but running individual tests could result in test failures. This is related to different exception classes being thrown, depending on if a connection was attempted before or not. The real root cause for this is unknown. The exceptions are thrown in two different places:\n\nWhen writing the initial packet (InvalidConnectionException), or\nWhen parsing the response (LdapProtocolErrorException)\n\nAs I was unable to find out the underlying cause, the assertions for failed connections were relaxed. Instead of checking for the exact exception class, we are now checking if an exception was thrown at all.  Together with the positive cases (connection works -> no exception is thrown), this should still provide a reliable test coverage.\n\n\nMaking them faster\nBefore this change, the container was started/stopped for each test (method). This change is now starting the container once for the complete class, reducing runtime significantly (on my machine from 14.895s down to 1.114s).\n\n\nHow Has This Been Tested?\n\n\n\nScreenshots (if appropriate):\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Refactoring (non-breaking change)\n Breaking change (fix or feature that would cause existing functionality to change)\n\nChecklist:\n\n\n\n My code follows the code style of this project.\n My change requires a change to the documentation.\n I have updated the documentation accordingly.\n I have read the CONTRIBUTING document.\n I have added tests to cover my changes.", "createdAt": "2020-08-03T14:11:20Z", "url": "https://github.com/Graylog2/graylog2-server/pull/8682", "merged": true, "mergeCommit": {"oid": "710112d03f169d44669442dbb4f520f849697e2f"}, "closed": true, "closedAt": "2020-08-04T08:29:52Z", "author": {"login": "dennisoelkers"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7Sn7XgH2gAyNDYyMjAxNDYzOjExYzJmYzE3ZjA5NWY2YzIyMzY1MmJmOWI5ZTEyNjk4N2Q1NDVhYzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7iLhJAFqTQ2MDU5NDg5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "11c2fc17f095f6c223652bf9b9e126987d545ac6", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/11c2fc17f095f6c223652bf9b9e126987d545ac6", "committedDate": "2020-08-03T14:09:31Z", "message": "Making LDAP TLS/SSL tests faster and more reliable.\n\nThis change is doing two things for the LDAP authenticator SSL/TLS tests:\n\n1.) Making them more reliable\n  Before this change, running the complete test class worked, but\n  running individual tests could result in test failures. This is related\n  to different exception classes being thrown, depending on if a\n  connection was attempted before or not. The real root cause for this is\n  unknown. The exceptions are thrown in two different places:\n    - When writing the initial packet (`InvalidConnectionException`), or\n    - When parsing the response (`LdapProtocolErrorException`)\n\n  As I was unable to find out the underlying cause, the assertions for\n  failed connections were relaxed. Instead of checking for the exact\n  exception class, we are now checking if an exception was thrown at all.\n  Together with the positive cases (connection works -> no exception is\n  thrown), this should still provide a reliable test coverage.\n\n2.) Making them faster\n  Before this change, the container was started/stopped for each test\n  (method). This change is now starting the container once for the\n  complete class, reducing runtime significantly (on my machine from 14.895s\n  down to 1.114s)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMDk1MDg4", "url": "https://github.com/Graylog2/graylog2-server/pull/8682#pullrequestreview-460095088", "createdAt": "2020-08-03T14:54:09Z", "commit": {"oid": "11c2fc17f095f6c223652bf9b9e126987d545ac6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNDo1NDoxMFrOG68xSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNDo1NDoxMFrOG68xSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ2NjI0OQ==", "bodyText": "How about doing this as a try-with-resource?\nThat ensures cleanup even if we hit an exception\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    final LdapNetworkConnection connection = ldapConnector.connect(request);\n          \n          \n            \n                    assertThat(connection.isAuthenticated()).isTrue();\n          \n          \n            \n                    assertThat(connection.isConnected()).isTrue();\n          \n          \n            \n                    assertThat(connection.isSecured()).isTrue();\n          \n          \n            \n            \n          \n          \n            \n                    connection.close();\n          \n          \n            \n                    try (final LdapNetworkConnection connection = ldapConnector.connect(request)) {\n          \n          \n            \n                        assertThat(connection.isAuthenticated()).isTrue();\n          \n          \n            \n                        assertThat(connection.isConnected()).isTrue();\n          \n          \n            \n                        assertThat(connection.isSecured()).isTrue();\n          \n          \n            \n                    }", "url": "https://github.com/Graylog2/graylog2-server/pull/8682#discussion_r464466249", "createdAt": "2020-08-03T14:54:10Z", "author": {"login": "mpfz0r"}, "path": "graylog2-server/src/test/java/org/graylog2/security/ldap/LdapConnectorSSLTLSIT.java", "diffHunk": "@@ -194,11 +188,17 @@ private LdapTestConfigRequest createRequest(URI uri, boolean startTls, boolean t\n         );\n     }\n \n-    private void assertConnectionSuccess(LdapTestConfigRequest request) throws KeyStoreException, LdapException, NoSuchAlgorithmException {\n+    private void assertConnectionFailure(LdapTestConfigRequest request) {\n+        Assertions.assertThatThrownBy(() -> ldapConnector.connect(request)).isNotNull();\n+    }\n+\n+    private void assertConnectionSuccess(LdapTestConfigRequest request) throws KeyStoreException, LdapException, NoSuchAlgorithmException, IOException {\n         final LdapNetworkConnection connection = ldapConnector.connect(request);\n         assertThat(connection.isAuthenticated()).isTrue();\n         assertThat(connection.isConnected()).isTrue();\n         assertThat(connection.isSecured()).isTrue();\n+\n+        connection.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11c2fc17f095f6c223652bf9b9e126987d545ac6"}, "originalPosition": 126}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMDk1NjY3", "url": "https://github.com/Graylog2/graylog2-server/pull/8682#pullrequestreview-460095667", "createdAt": "2020-08-03T14:54:51Z", "commit": {"oid": "11c2fc17f095f6c223652bf9b9e126987d545ac6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2899be486adcbabd96e08d4db766ca5e8bead59", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/f2899be486adcbabd96e08d4db766ca5e8bead59", "committedDate": "2020-08-04T08:00:09Z", "message": "Using try-with-resource for connection handling.\n\nCo-authored-by: Marco Pfatschbacher <marco@graylog.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNTk0ODk4", "url": "https://github.com/Graylog2/graylog2-server/pull/8682#pullrequestreview-460594898", "createdAt": "2020-08-04T08:16:58Z", "commit": {"oid": "f2899be486adcbabd96e08d4db766ca5e8bead59"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2924, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}