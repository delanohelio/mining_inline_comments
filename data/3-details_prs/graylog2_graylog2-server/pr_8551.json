{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5NDUyNDQz", "number": 8551, "title": "Adding ES7 adapter for reopened indices migration.", "bodyText": "Description\n\nMotivation and Context\n\n\nIn one of our migrations, we are using ES-specific code to determine reopened indices which need migration. We have extracted the ES-specifics into an interface that needs to be implemented by each storage driver module. This PR is adding it for the ES7 module.\nHow Has This Been Tested?\n\n\n\nScreenshots (if appropriate):\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Refactoring (non-breaking change)\n Breaking change (fix or feature that would cause existing functionality to change)\n\nChecklist:\n\n\n\n My code follows the code style of this project.\n My change requires a change to the documentation.\n I have updated the documentation accordingly.\n I have read the CONTRIBUTING document.\n I have added tests to cover my changes.", "createdAt": "2020-07-15T12:35:06Z", "url": "https://github.com/Graylog2/graylog2-server/pull/8551", "merged": true, "mergeCommit": {"oid": "a35223a234209f1deb9e3772a5b5d8dc23e16620"}, "closed": true, "closedAt": "2020-07-16T13:14:20Z", "author": {"login": "dennisoelkers"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1bETGABqjM1NTIwNTc3MzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1fCyNAFqTQ0OTgzMzg4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "05ba93e3f83093279bc424c9957659af0700a05f", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/05ba93e3f83093279bc424c9957659af0700a05f", "committedDate": "2020-07-15T12:33:33Z", "message": "Adding ES7 adapter for migration."}, "afterCommit": {"oid": "11219f74547425a0eab1813007b9e6a0a4210052", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/11219f74547425a0eab1813007b9e6a0a4210052", "committedDate": "2020-07-16T08:36:04Z", "message": "Adding ES7 adapter for migration."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NzMzMjk0", "url": "https://github.com/Graylog2/graylog2-server/pull/8551#pullrequestreview-449733294", "createdAt": "2020-07-16T10:48:18Z", "commit": {"oid": "0d6fd3f12dd64b77218086b16e05ea53b28cbd94"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxMDo0ODoxOFrOGylioQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxMDo0ODoxOFrOGylioQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY5NzA1Nw==", "bodyText": "I think it would make sense to reuse ClusterStateApi here. ClusterStateApi#request is the exact same and I find the risk of unexpectedly breaking the migration low enough, because that stuff does so little besides calling the API. That shouldn't really change within the scope of the ES7 driver.", "url": "https://github.com/Graylog2/graylog2-server/pull/8551#discussion_r455697057", "createdAt": "2020-07-16T10:48:18Z", "author": {"login": "alex-konn"}, "path": "graylog-storage-elasticsearch7/src/main/java/org/graylog/storage/elasticsearch7/migrations/V20170607164210_MigrateReopenedIndicesToAliasesClusterStateES7.java", "diffHunk": "@@ -0,0 +1,35 @@\n+package org.graylog.storage.elasticsearch7.migrations;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.client.Request;\n+import org.graylog.storage.elasticsearch7.PlainJsonApi;\n+import org.graylog2.migrations.V20170607164210_MigrateReopenedIndicesToAliases;\n+\n+import javax.inject.Inject;\n+import java.util.Collection;\n+\n+public class V20170607164210_MigrateReopenedIndicesToAliasesClusterStateES7 implements V20170607164210_MigrateReopenedIndicesToAliases.ClusterState {\n+    private final PlainJsonApi plainJsonApi;\n+\n+    @Inject\n+    public V20170607164210_MigrateReopenedIndicesToAliasesClusterStateES7(PlainJsonApi plainJsonApi) {\n+        this.plainJsonApi = plainJsonApi;\n+    }\n+\n+    @Override\n+    public JsonNode getForIndices(Collection<String> indices) {\n+        return plainJsonApi.perform(request(indices),\n+                \"Couldn't read cluster state for reopened indices \" + indices);\n+    }\n+\n+    private Request request(Collection<String> indices) {\n+        final StringBuilder apiEndpoint = new StringBuilder(\"/_cluster/state/metadata\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d6fd3f12dd64b77218086b16e05ea53b28cbd94"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bd6022df188018fb217eb4bce8fa0481e200731", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/4bd6022df188018fb217eb4bce8fa0481e200731", "committedDate": "2020-07-16T12:17:59Z", "message": "Adding ES7 adapter for migration."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "200232d2bc8aaaf05272d076a46684e26579e372", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/200232d2bc8aaaf05272d076a46684e26579e372", "committedDate": "2020-07-16T12:18:01Z", "message": "Allow v7 for migration."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0d6fd3f12dd64b77218086b16e05ea53b28cbd94", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/0d6fd3f12dd64b77218086b16e05ea53b28cbd94", "committedDate": "2020-07-16T08:38:17Z", "message": "Allow v7 for migration."}, "afterCommit": {"oid": "200232d2bc8aaaf05272d076a46684e26579e372", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/200232d2bc8aaaf05272d076a46684e26579e372", "committedDate": "2020-07-16T12:18:01Z", "message": "Allow v7 for migration."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5ODMzODgx", "url": "https://github.com/Graylog2/graylog2-server/pull/8551#pullrequestreview-449833881", "createdAt": "2020-07-16T13:14:10Z", "commit": {"oid": "200232d2bc8aaaf05272d076a46684e26579e372"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3019, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}