{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2ODE4OTIx", "number": 8514, "title": "Implementing `IndexToolsAdapter` for ES7.", "bodyText": "Description\n\nMotivation and Context\n\n\nThis PR is implementing the IndexToolsAdapter for ES7.\nHow Has This Been Tested?\n\n\n\nScreenshots (if appropriate):\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Refactoring (non-breaking change)\n Breaking change (fix or feature that would cause existing functionality to change)\n\nChecklist:\n\n\n\n My code follows the code style of this project.\n My change requires a change to the documentation.\n I have updated the documentation accordingly.\n I have read the CONTRIBUTING document.\n I have added tests to cover my changes.", "createdAt": "2020-07-09T12:09:26Z", "url": "https://github.com/Graylog2/graylog2-server/pull/8514", "merged": true, "mergeCommit": {"oid": "d01002c5eb195b60058d6b268049e80d3e53f402"}, "closed": true, "closedAt": "2020-07-16T13:12:43Z", "author": {"login": "dennisoelkers"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1bBWngH2gAyNDQ2ODE4OTIxOmMyOTkwODA2NzcyOWY2MmQ5MWI3MjhjMDhlZjhlOWFkNjkxNDMwOTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1fBRhgFqTQ0OTgzMjQ0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c29908067729f62d91b728c08ef8e9ad69143092", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/c29908067729f62d91b728c08ef8e9ad69143092", "committedDate": "2020-07-16T08:32:59Z", "message": "Streamlining and reusing search creation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a455f5a16b321ae03b221fa3b109dda4d3d6b748", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/a455f5a16b321ae03b221fa3b109dda4d3d6b748", "committedDate": "2020-07-16T08:33:01Z", "message": "Adding `IndexToolsAdapter` for ES7."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "daff881b50db323a3120e116fef2e3a3a7b0a205", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/daff881b50db323a3120e116fef2e3a3a7b0a205", "committedDate": "2020-07-16T08:33:01Z", "message": "Do not set limit on scroll command if it is `-1` (disabled)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "556f7fe3c629ddc4249ab56f585b330d0c5f9634", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/556f7fe3c629ddc4249ab56f585b330d0c5f9634", "committedDate": "2020-07-16T08:34:57Z", "message": "Adjusting to class renaming."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cac4e148979bec258a5442c0390e8d0df66fd00c", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/cac4e148979bec258a5442c0390e8d0df66fd00c", "committedDate": "2020-07-09T12:14:13Z", "message": "Do not set limit on scroll command if it is `-1` (disabled)."}, "afterCommit": {"oid": "556f7fe3c629ddc4249ab56f585b330d0c5f9634", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/556f7fe3c629ddc4249ab56f585b330d0c5f9634", "committedDate": "2020-07-16T08:34:57Z", "message": "Adjusting to class renaming."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49d362a81920a3d08e7ec0128608cd7655fd4106", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/49d362a81920a3d08e7ec0128608cd7655fd4106", "committedDate": "2020-07-16T09:27:58Z", "message": "Reusing constants for disabling limit/batch size."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc219cddfd218a9875df2ef2ab30d97ddfe42fad", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/bc219cddfd218a9875df2ef2ab30d97ddfe42fad", "committedDate": "2020-07-16T09:30:31Z", "message": "Removing unused method."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2777cbdba6430c6ba3c53933e8ea4070f8d19228", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/2777cbdba6430c6ba3c53933e8ea4070f8d19228", "committedDate": "2020-07-16T09:32:13Z", "message": "Pulling inner class out."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5Njk3Mzg5", "url": "https://github.com/Graylog2/graylog2-server/pull/8514#pullrequestreview-449697389", "createdAt": "2020-07-16T09:55:32Z", "commit": {"oid": "2777cbdba6430c6ba3c53933e8ea4070f8d19228"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwOTo1NTozM1rOGyjx6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxMDoyNToxMFrOGykyUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2ODIwMg==", "bodyText": "DateHistogramAggregationBuilder#interval is deprecated. I think we should use fixedInterval instead.", "url": "https://github.com/Graylog2/graylog2-server/pull/8514#discussion_r455668202", "createdAt": "2020-07-16T09:55:33Z", "author": {"login": "alex-konn"}, "path": "graylog-storage-elasticsearch7/src/main/java/org/graylog/storage/elasticsearch7/IndexToolsAdapterES7.java", "diffHunk": "@@ -0,0 +1,130 @@\n+package org.graylog.storage.elasticsearch7;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.Maps;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.action.search.SearchRequest;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.action.search.SearchResponse;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.action.support.IndicesOptions;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.client.core.CountRequest;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.client.core.CountResponse;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.index.query.BoolQueryBuilder;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.index.query.QueryBuilders;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.aggregations.AggregationBuilders;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.aggregations.bucket.filter.Filter;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.aggregations.bucket.filter.FilterAggregationBuilder;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.aggregations.bucket.histogram.ParsedDateHistogram;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.aggregations.bucket.terms.Terms;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.builder.SearchSourceBuilder;\n+import org.graylog2.indexer.IndexToolsAdapter;\n+import org.graylog2.plugin.Message;\n+import org.graylog2.plugin.streams.Stream;\n+import org.joda.time.DateTime;\n+import org.joda.time.DateTimeZone;\n+\n+import javax.inject.Inject;\n+import java.time.ZonedDateTime;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+import static org.graylog.shaded.elasticsearch7.org.elasticsearch.index.query.QueryBuilders.boolQuery;\n+import static org.graylog.shaded.elasticsearch7.org.elasticsearch.index.query.QueryBuilders.existsQuery;\n+import static org.graylog.shaded.elasticsearch7.org.elasticsearch.index.query.QueryBuilders.matchAllQuery;\n+import static org.graylog.shaded.elasticsearch7.org.elasticsearch.index.query.QueryBuilders.termsQuery;\n+\n+public class IndexToolsAdapterES7 implements IndexToolsAdapter {\n+    private static final String AGG_DATE_HISTOGRAM = \"source_date_histogram\";\n+    private static final String AGG_MESSAGE_FIELD = \"message_field\";\n+    private static final String AGG_FILTER = \"message_filter\";\n+    private final ElasticsearchClient client;\n+\n+    @Inject\n+    public IndexToolsAdapterES7(ElasticsearchClient client) {\n+        this.client = client;\n+    }\n+\n+    @Override\n+    public Map<DateTime, Map<String, Long>> fieldHistogram(String fieldName, Set<String> indices, Optional<Set<String>> includedStreams, long interval) {\n+        final BoolQueryBuilder queryBuilder = buildStreamIdFilter(includedStreams);\n+\n+        final FilterAggregationBuilder the_filter = AggregationBuilders.filter(AGG_FILTER, queryBuilder)\n+                .subAggregation(AggregationBuilders.dateHistogram(AGG_DATE_HISTOGRAM)\n+                        .field(\"timestamp\")\n+                        .subAggregation(AggregationBuilders.terms(AGG_MESSAGE_FIELD).field(fieldName))\n+                        .interval(interval)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2777cbdba6430c6ba3c53933e8ea4070f8d19228"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY4NDY5MA==", "bodyText": "I think we should centralize this logic somewhere. Equivalent methods are also contained in IndexToolsAdapterES6, indexToolsAdapterES7, and SearchesAdapterES6.", "url": "https://github.com/Graylog2/graylog2-server/pull/8514#discussion_r455684690", "createdAt": "2020-07-16T10:25:10Z", "author": {"login": "alex-konn"}, "path": "graylog-storage-elasticsearch7/src/main/java/org/graylog/storage/elasticsearch7/SearchRequestFactory.java", "diffHunk": "@@ -73,27 +88,51 @@ public SearchSourceBuilder create(SearchesConfig config) {\n                     .numOfFragments(0);\n             searchSourceBuilder.highlighter(highlightBuilder);\n         }\n+    }\n \n-        return searchSourceBuilder;\n+    private void applyPaginationIfPresent(SearchSourceBuilder searchSourceBuilder, SearchCommand command) {\n+        command.offset().ifPresent(searchSourceBuilder::from);\n+        command.limit().ifPresent(searchSourceBuilder::size);\n     }\n \n-    @Nullable\n-    private QueryBuilder standardFilters(TimeRange range, String filter) {\n-        BoolQueryBuilder bfb = null;\n \n-        if (range != null) {\n-            bfb = QueryBuilders.boolQuery()\n-                    .must(TimeRangeQueryFactory.create(range));\n-        }\n+    private void applyStreamsFilter(BoolQueryBuilder filteredQueryBuilder, SearchCommand command) {\n+        command.streams()\n+                .map(this::buildStreamIdFilter)\n+                .ifPresent(filteredQueryBuilder::filter);\n+    }\n+\n+    private BoolQueryBuilder buildStreamIdFilter(Set<String> streams) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2777cbdba6430c6ba3c53933e8ea4070f8d19228"}, "originalPosition": 129}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b6eabdc2fec900e8f8bcd615acbd485fa4b0b2f", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/4b6eabdc2fec900e8f8bcd615acbd485fa4b0b2f", "committedDate": "2020-07-16T12:16:27Z", "message": "Replacing deprecated `interval` with `fixedInterval`."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5ODMyNDQ0", "url": "https://github.com/Graylog2/graylog2-server/pull/8514#pullrequestreview-449832444", "createdAt": "2020-07-16T13:12:31Z", "commit": {"oid": "4b6eabdc2fec900e8f8bcd615acbd485fa4b0b2f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2978, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}