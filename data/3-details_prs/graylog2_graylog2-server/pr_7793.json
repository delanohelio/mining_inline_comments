{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2MjQwMzAz", "number": 7793, "title": "Only show dashboard delete button for users with correct permissions", "bodyText": "We need to merge #7817 first, it changes the backend permissions for view deletions. Otherwise the frontend permission check will not match.\nAs described in #7730 a user without the permissions to delete a dashboard still sees the Delete action in the dashboard action menu.\nFixes: #7730\nScreenshots (if appropriate):\nTypes of changes\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Refactoring (non-breaking change)\n Breaking change (fix or feature that would cause existing functionality to change)\n\nChecklist:\n\n My code follows the code style of this project.\n My change requires a change to the documentation.\n I have updated the documentation accordingly.\n I have read the CONTRIBUTING document.\n I have added tests to cover my changes.", "createdAt": "2020-03-31T10:43:35Z", "url": "https://github.com/Graylog2/graylog2-server/pull/7793", "merged": true, "mergeCommit": {"oid": "858209a36d6a284ee1a4cd5af544425288193e20"}, "closed": true, "closedAt": "2020-04-06T12:26:31Z", "author": {"login": "linuspahl"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTBHxLAFqTM4NDYyNzgyNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcU90okAFqTM4ODE5ODQwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NjI3ODI3", "url": "https://github.com/Graylog2/graylog2-server/pull/7793#pullrequestreview-384627827", "createdAt": "2020-03-31T11:09:02Z", "commit": {"oid": "b6e01476a250ca3fc2c4784c9d7e22f4c4de7e28"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMTowOTowMlrOF-QmeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMTowOTowMlrOF-QmeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgyODAyNQ==", "bodyText": "We need to execute the search, when page, perPage or query changes, this works perfectly in combination with useEffect, except for this case (deleting a view). As you can see in the diff, we are running execSearch  after setState.  With the current implementation, setPage(1) will not trigger executeSearch, when the current page is 1.\nThe above  execSearch(); in line 55 has no effect. also setPage(1).then() is not a possible solution.\nDo you have any idea how to deal with this case?", "url": "https://github.com/Graylog2/graylog2-server/pull/7793#discussion_r400828025", "createdAt": "2020-03-31T11:09:02Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/views/components/views/ViewList.jsx", "diffHunk": "@@ -1,126 +1,110 @@\n-import React from 'react';\n+import React, { useEffect, useState } from 'react';\n import PropTypes from 'prop-types';\n-import createReactClass from 'create-react-class';\n import { ButtonToolbar, DropdownButton, MenuItem } from 'components/graylog';\n import IfPermitted from 'components/common/IfPermitted';\n \n import { PaginatedList, SearchForm, Spinner, EntityList } from 'components/common';\n import View from './View';\n \n-const ViewList = createReactClass({\n-  propTypes: {\n-    views: PropTypes.arrayOf(PropTypes.object),\n-    pagination: PropTypes.shape({\n-      total: PropTypes.number.isRequired,\n-      page: PropTypes.number.isRequired,\n-      perPage: PropTypes.number.isRequired,\n-    }).isRequired,\n-    handleSearch: PropTypes.func.isRequired,\n-    handleViewDelete: PropTypes.func.isRequired,\n-  },\n-\n-  getDefaultProps() {\n-    return {\n-      views: undefined,\n-    };\n-  },\n-\n-  getInitialState() {\n-    return {\n-      query: '',\n-      page: 1,\n-      perPage: 10,\n-    };\n-  },\n-\n-  componentDidMount() {\n-    this.execSearch();\n-  },\n-\n-  execSearch(resetLoadingState = () => {\n-  }) {\n-    const { query, page, perPage } = this.state;\n-    this.props.handleSearch(query, page, perPage).then(resetLoadingState).catch(resetLoadingState);\n-  },\n-\n-  handleSearch(query, resetLoadingState) {\n-    this.setState({ query: query, page: 1 }, () => {\n-      this.execSearch(resetLoadingState);\n-    });\n-  },\n-\n-  handleSearchReset() {\n-    this.setState({ query: '', page: 1 }, () => {\n-      this.execSearch();\n-    });\n-  },\n-\n-  handlePageChange(page, perPage) {\n-    this.setState({ page: page, perPage: perPage }, () => {\n-      this.execSearch();\n-    });\n-  },\n-\n-  handleViewDelete(view) {\n+const itemActionsFactory = (view, onViewDelete) => {\n+  return (\n+    <IfPermitted permissions={['*']}>\n+      <ButtonToolbar>\n+        <DropdownButton title=\"Actions\" id={`view-actions-dropdown-${view.id}`} bsSize=\"small\" pullRight>\n+          <MenuItem onSelect={onViewDelete(view)}>Delete</MenuItem>\n+        </DropdownButton>\n+      </ButtonToolbar>\n+    </IfPermitted>\n+  );\n+};\n+\n+const ViewList = ({ pagination, handleSearch, handleViewDelete, views }) => {\n+  const [query, setQuery] = useState('');\n+  const [page, setPage] = useState(1);\n+  const [perPage, setPerPage] = useState(10);\n+\n+  const execSearch = (resetLoadingState = () => {}) => {\n+    handleSearch(query, page, perPage).then(resetLoadingState).catch(resetLoadingState);\n+  };\n+\n+  useEffect(() => {\n+    execSearch();\n+  }, [query, page, setPage]);\n+\n+\n+  const onSearch = (newQuery, resetLoadingState) => {\n+    setQuery(newQuery);\n+    setPage(1);\n+    resetLoadingState();\n+  };\n+\n+  const onSearchReset = () => {\n+    setQuery('');\n+    setPage(1);\n+  };\n+\n+  const onPageChange = (newPage, newPerPage) => {\n+    setPage(newPage);\n+    setPerPage(newPerPage);\n+  };\n+\n+  const onViewDelete = (view) => {\n     return () => {\n-      this.props.handleViewDelete(view).then(() => {\n-        this.setState({ page: 1 }, () => {\n-          this.execSearch();\n-        });\n+      handleViewDelete(view).then(() => {\n+        setPage(1);\n+        execSearch();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6e01476a250ca3fc2c4784c9d7e22f4c4de7e28"}, "originalPosition": 116}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ce4022c42c461b45217d2415dcd3da1ed63bc48d", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/ce4022c42c461b45217d2415dcd3da1ed63bc48d", "committedDate": "2020-03-31T15:06:29Z", "message": "Add more specific permissions check when displaying dashboard delete button"}, "afterCommit": {"oid": "716fd4ecd0648f52c5065ff571bd31b74cc2bcdd", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/716fd4ecd0648f52c5065ff571bd31b74cc2bcdd", "committedDate": "2020-04-02T09:22:28Z", "message": "Add more specific permissions check when displaying dashboard delete button"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f05823c3361b73d11aecfc8c5debb72bca0fd86b", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/f05823c3361b73d11aecfc8c5debb72bca0fd86b", "committedDate": "2020-04-02T11:43:21Z", "message": "Reset view deletion permissions change"}, "afterCommit": {"oid": "ed96d9bcbd8142bc6276e89d8260f99588b3bf4f", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/ed96d9bcbd8142bc6276e89d8260f99588b3bf4f", "committedDate": "2020-04-02T11:44:37Z", "message": "Reset view deletion permissions change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef1fe95c1e856a80ffe98c2ac80fa7f9d03c3140", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/ef1fe95c1e856a80ffe98c2ac80fa7f9d03c3140", "committedDate": "2020-04-03T11:14:03Z", "message": "Only show dashboard actions menu for admins"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "245e0870d5525ed3786d17563a33ac8d16780a22", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/245e0870d5525ed3786d17563a33ac8d16780a22", "committedDate": "2020-04-03T11:15:44Z", "message": "Use hooks instead of class for ViewList"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0434f474d8e29f785005cbd3460fbef0e1fc02c7", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/0434f474d8e29f785005cbd3460fbef0e1fc02c7", "committedDate": "2020-04-03T11:16:36Z", "message": "Remove not needed resetLoadingState calls"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97f7e88f66f0cdf990b3f8c3d0b73f3b7110435d", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/97f7e88f66f0cdf990b3f8c3d0b73f3b7110435d", "committedDate": "2020-04-03T11:16:36Z", "message": "Reset view deletion permissions change"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ed96d9bcbd8142bc6276e89d8260f99588b3bf4f", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/ed96d9bcbd8142bc6276e89d8260f99588b3bf4f", "committedDate": "2020-04-02T11:44:37Z", "message": "Reset view deletion permissions change"}, "afterCommit": {"oid": "97f7e88f66f0cdf990b3f8c3d0b73f3b7110435d", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/97f7e88f66f0cdf990b3f8c3d0b73f3b7110435d", "committedDate": "2020-04-03T11:16:36Z", "message": "Reset view deletion permissions change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4MTk4NDA2", "url": "https://github.com/Graylog2/graylog2-server/pull/7793#pullrequestreview-388198406", "createdAt": "2020-04-06T12:26:16Z", "commit": {"oid": "97f7e88f66f0cdf990b3f8c3d0b73f3b7110435d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2487, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}