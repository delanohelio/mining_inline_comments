{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyMDgwNDA4", "number": 8451, "title": "Implement `MessagesAdapter` for ES7.", "bodyText": "Description\n\nMotivation and Context\n\n\nThis PR is implementing the MessagesAdapter for ES7. It also performs quite extensive refactoring of the Messages <-> MessagesAdapter relationship.\nBefore this PR, retrying logic was buried in the MessagesAdapter#bulkIndex call. This change is pulling it upwards into the Messages class, which is now retrying bulkIndex calls for thrown IOExceptions as well as indexing errors (e.g. index blocks due to target indices being read-only or the node being in flood stage). This is implemented by adding an abstraction for indexing errors (Messages.IndexingError) which is instantiated by the adapters but evaluated by the Messages class which decides how to proceed based on the error type.\nChunk splitting due to excessive payload sizes is still considered to be a concern of the adapter implementation, as it is related to the way of transport (HTTP). Nevertheless, parts of it are extracted into a shared class (ChunkedBulkIndexer) which can be employed by any adapter implementation to provide a strategy that splits chunks into halves until bulk indexing does not fail because of a 413 anymore.\nHow Has This Been Tested?\n\n\n\nScreenshots (if appropriate):\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Refactoring (non-breaking change)\n Breaking change (fix or feature that would cause existing functionality to change)\n\nChecklist:\n\n\n\n My code follows the code style of this project.\n My change requires a change to the documentation.\n I have updated the documentation accordingly.\n I have read the CONTRIBUTING document.\n I have added tests to cover my changes.", "createdAt": "2020-06-30T14:43:39Z", "url": "https://github.com/Graylog2/graylog2-server/pull/8451", "merged": true, "mergeCommit": {"oid": "707c1e36924d28678e45e9e688e9700f80618e6a"}, "closed": true, "closedAt": "2020-07-09T09:05:32Z", "author": {"login": "dennisoelkers"}, "timelineItems": {"totalCount": 42, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwrv3lgBqjM1MDI5NDUyNDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczLSbLAFqTQ0NTQyNjYzNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2b7e39fb07b03d2e1455d00041508f0ad1b954d5", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/2b7e39fb07b03d2e1455d00041508f0ad1b954d5", "committedDate": "2020-07-01T07:44:34Z", "message": "Binding `MessagesAdapter` for ES7."}, "afterCommit": {"oid": "745fa45881256caaf3fcadfe345223d3170b0930", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/745fa45881256caaf3fcadfe345223d3170b0930", "committedDate": "2020-07-01T15:12:32Z", "message": "Binding `MessagesAdapter` for ES7."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "745fa45881256caaf3fcadfe345223d3170b0930", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/745fa45881256caaf3fcadfe345223d3170b0930", "committedDate": "2020-07-01T15:12:32Z", "message": "Binding `MessagesAdapter` for ES7."}, "afterCommit": {"oid": "b179ddd60e594dc054587440116f17a4f4e9b8de", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/b179ddd60e594dc054587440116f17a4f4e9b8de", "committedDate": "2020-07-02T07:33:25Z", "message": "Binding `MessagesAdapter` for ES7."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b179ddd60e594dc054587440116f17a4f4e9b8de", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/b179ddd60e594dc054587440116f17a4f4e9b8de", "committedDate": "2020-07-02T07:33:25Z", "message": "Binding `MessagesAdapter` for ES7."}, "afterCommit": {"oid": "0693adc086ec41ed74a4a615e649c59bb73c9040", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/0693adc086ec41ed74a4a615e649c59bb73c9040", "committedDate": "2020-07-06T11:51:59Z", "message": "Binding `MessagesAdapter` for ES7."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0693adc086ec41ed74a4a615e649c59bb73c9040", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/0693adc086ec41ed74a4a615e649c59bb73c9040", "committedDate": "2020-07-06T11:51:59Z", "message": "Binding `MessagesAdapter` for ES7."}, "afterCommit": {"oid": "89e4eeebf5d456541cf811ebd85883b40a473a4d", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/89e4eeebf5d456541cf811ebd85883b40a473a4d", "committedDate": "2020-07-07T11:43:49Z", "message": "Binding `MessagesAdapter` for ES7."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b249bec6132033b28fc3318b488c13a48704c9de", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/b249bec6132033b28fc3318b488c13a48704c9de", "committedDate": "2020-07-08T08:57:37Z", "message": "Extract helper method, use custom thread factory."}, "afterCommit": {"oid": "7035e063d37c4e17b760825478759f94bb02ec58", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/7035e063d37c4e17b760825478759f94bb02ec58", "committedDate": "2020-07-08T09:33:43Z", "message": "Extract helper method, use custom thread factory."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7035e063d37c4e17b760825478759f94bb02ec58", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/7035e063d37c4e17b760825478759f94bb02ec58", "committedDate": "2020-07-08T09:33:43Z", "message": "Extract helper method, use custom thread factory."}, "afterCommit": {"oid": "00b03df08567134ffd37886508e8c329c67536bf", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/00b03df08567134ffd37886508e8c329c67536bf", "committedDate": "2020-07-08T10:34:05Z", "message": "Extract helper method, use custom thread factory."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdd6380498335f49e633210e672b1cd69401e87b", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/fdd6380498335f49e633210e672b1cd69401e87b", "committedDate": "2020-07-08T10:58:41Z", "message": "Starting naive implementation for `MessagesAdapterES7`."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4639460357bfdd015c530362d4cc7455444b00f7", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/4639460357bfdd015c530362d4cc7455444b00f7", "committedDate": "2020-07-08T10:58:41Z", "message": "Extracting chunking strategy."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "067b4d10210a61b79aeda4320405015b684d14a6", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/067b4d10210a61b79aeda4320405015b684d14a6", "committedDate": "2020-07-08T10:58:41Z", "message": "Adding test case, handling payload being large for ES7."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "325269042ecdce2e8b89d3ac0e2dc3d922763a59", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/325269042ecdce2e8b89d3ac0e2dc3d922763a59", "committedDate": "2020-07-08T10:58:41Z", "message": "Adding `analyze` and test case for it."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "823af546e7263e535c1dd5f4962b09868fd6b301", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/823af546e7263e535c1dd5f4962b09868fd6b301", "committedDate": "2020-07-08T10:58:41Z", "message": "Introducing `Messages.IndexingError` to abstract indexing errors."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73458fa232cecda8f00dfe5b6632a556cc326333", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/73458fa232cecda8f00dfe5b6632a556cc326333", "committedDate": "2020-07-08T10:58:41Z", "message": "Pulling retrying on `IOException` into `Messages` class."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f1ae8884dc81e9a582295a305e1d8c6d2153f17", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/1f1ae8884dc81e9a582295a305e1d8c6d2153f17", "committedDate": "2020-07-08T10:58:41Z", "message": "Adding slf4j/log4j dependencies to ES6 driver module."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37cd1e601472fe758f621d49a6f5d18c8521a98c", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/37cd1e601472fe758f621d49a6f5d18c8521a98c", "committedDate": "2020-07-08T10:58:41Z", "message": "Adding slf4j/log4j dependencies to ES7 driver module."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36c2f2ed249009cadf5d2632ef78d87fa325f669", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/36c2f2ed249009cadf5d2632ef78d87fa325f669", "committedDate": "2020-07-08T10:58:41Z", "message": "Propagating `IOException`."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "942790e82c5479b47cc80f752e8e277f578f9051", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/942790e82c5479b47cc80f752e8e277f578f9051", "committedDate": "2020-07-08T10:58:41Z", "message": "Using string value of error type for index failure."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1461f08396c407ad580a3cf5b19a2ff139210a94", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/1461f08396c407ad580a3cf5b19a2ff139210a94", "committedDate": "2020-07-08T10:58:41Z", "message": "Moving index failure creation to `IndexingError#toIndexFailure`."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7608edca8d4c2d925b4d0d752ebaa17b4106e088", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/7608edca8d4c2d925b4d0d752ebaa17b4106e088", "committedDate": "2020-07-08T10:58:41Z", "message": "Pulling index block retrying out to `Messages` class."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f1816123123a710b37332813c0dba41e1ac4283", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/0f1816123123a710b37332813c0dba41e1ac4283", "committedDate": "2020-07-08T10:58:41Z", "message": "Adding logging of errors to ES7."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7eb0a43aafabe997c03d202aca99278b512aa48b", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/7eb0a43aafabe997c03d202aca99278b512aa48b", "committedDate": "2020-07-08T10:58:42Z", "message": "Moving over relevant tests from adapter to `MessagesBulkIndexRetryingTest`."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2eb310fcd96956b3a8535b0a62c187f60272bf0", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/e2eb310fcd96956b3a8535b0a62c187f60272bf0", "committedDate": "2020-07-08T10:58:42Z", "message": "Adjusting `MessagesAdapterES6Test` to new concerns of class."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75200ab5dbf5ad72f218acd9154508cab0b88009", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/75200ab5dbf5ad72f218acd9154508cab0b88009", "committedDate": "2020-07-08T10:58:42Z", "message": "Using `DateTime.now` with timezone."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fe88463e557b59be3e2f5a023902f206c7dab14", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/6fe88463e557b59be3e2f5a023902f206c7dab14", "committedDate": "2020-07-08T10:58:42Z", "message": "Binding `MessagesAdapter` for ES7."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f01329badb38753a270803bab3868566dc296414", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/f01329badb38753a270803bab3868566dc296414", "committedDate": "2020-07-08T10:58:42Z", "message": "Adding test case for index mapping type conflicts."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05e3e59b86d10d55b60a5ca768bac5c36204db91", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/05e3e59b86d10d55b60a5ca768bac5c36204db91", "committedDate": "2020-07-08T10:58:42Z", "message": "Parsing exception type returned by ES."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56445c520b3bc4ac1a87d17c92a94458dbc483fc", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/56445c520b3bc4ac1a87d17c92a94458dbc483fc", "committedDate": "2020-07-08T10:58:42Z", "message": "Adding tests for ES exception parser."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42ac1fcdb5ecdb05d21d73723d8fb988d10265bf", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/42ac1fcdb5ecdb05d21d73723d8fb988d10265bf", "committedDate": "2020-07-08T10:58:42Z", "message": "Adjusting pattern, adding test case."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6ba05b06e4cfc684216a6d4aa060eb8d1b6f272", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/b6ba05b06e4cfc684216a6d4aa060eb8d1b6f272", "committedDate": "2020-07-08T10:58:42Z", "message": "Adding test for ES Flood Stage handling."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb405037341a37cd0720123dcd10b2f1ba42ff68", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/fb405037341a37cd0720123dcd10b2f1ba42ff68", "committedDate": "2020-07-08T10:58:42Z", "message": "Removing sleep."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c50ea2fd1106e4d32f28321149f2c343f508f134", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/c50ea2fd1106e4d32f28321149f2c343f508f134", "committedDate": "2020-07-08T10:58:42Z", "message": "Using constant from test class for index name."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c95477a544429dbbc865587b7f1bffa003c0f5c", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/8c95477a544429dbbc865587b7f1bffa003c0f5c", "committedDate": "2020-07-08T10:58:42Z", "message": "Lowering cluster update interval for tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a89efda09ccf7d0b4d643fb48ba28f7a603cf9c5", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/a89efda09ccf7d0b4d643fb48ba28f7a603cf9c5", "committedDate": "2020-07-08T10:58:42Z", "message": "Extracting helper methods from bulk indexing method."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c60f9a939a505c461242929ebe3a919a868c2b3", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/0c60f9a939a505c461242929ebe3a919a868c2b3", "committedDate": "2020-07-08T10:58:42Z", "message": "Extract helper method, use custom thread factory."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85963ab630c71f1899878ddb5aca9a6ea29ffa9a", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/85963ab630c71f1899878ddb5aca9a6ea29ffa9a", "committedDate": "2020-07-08T10:58:42Z", "message": "Bumping ES version used in integration tests."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb2660ad990179f1a2a0230bf89f58cd83f7967d", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/fb2660ad990179f1a2a0230bf89f58cd83f7967d", "committedDate": "2020-07-08T10:54:33Z", "message": "Bumping ES version used in integration tests."}, "afterCommit": {"oid": "85963ab630c71f1899878ddb5aca9a6ea29ffa9a", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/85963ab630c71f1899878ddb5aca9a6ea29ffa9a", "committedDate": "2020-07-08T10:58:42Z", "message": "Bumping ES version used in integration tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e20a6c3f5229f806e44aa97814e7e8814fcc0b0", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/1e20a6c3f5229f806e44aa97814e7e8814fcc0b0", "committedDate": "2020-07-08T13:38:42Z", "message": "Explicitly create indices before bulk indexing fixtures."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e81bfc3523da8c3ed0521e4bf876f72af5306db4", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/e81bfc3523da8c3ed0521e4bf876f72af5306db4", "committedDate": "2020-07-08T15:03:19Z", "message": "Do not create index from fixtures if it already exists."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0ODMyMjY5", "url": "https://github.com/Graylog2/graylog2-server/pull/8451#pullrequestreview-444832269", "createdAt": "2020-07-08T14:37:28Z", "commit": {"oid": "1e20a6c3f5229f806e44aa97814e7e8814fcc0b0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNDozNzoyOFrOGurOWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNTozOTozMVrOGut-Pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU5NTg2NQ==", "bodyText": "IOException is never thrown here", "url": "https://github.com/Graylog2/graylog2-server/pull/8451#discussion_r451595865", "createdAt": "2020-07-08T14:37:28Z", "author": {"login": "alex-konn"}, "path": "graylog-storage-elasticsearch7/src/main/java/org/graylog/storage/elasticsearch7/MessagesAdapterES7.java", "diffHunk": "@@ -0,0 +1,214 @@\n+package org.graylog.storage.elasticsearch7;\n+\n+import com.codahale.metrics.Meter;\n+import com.codahale.metrics.MetricRegistry;\n+import com.google.common.collect.Iterables;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.ElasticsearchException;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.action.bulk.BulkItemResponse;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.action.bulk.BulkRequest;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.action.bulk.BulkResponse;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.action.get.GetRequest;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.action.get.GetResponse;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.action.index.IndexRequest;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.client.indices.AnalyzeRequest;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.client.indices.AnalyzeResponse;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.rest.RestStatus;\n+import org.graylog2.indexer.messages.ChunkedBulkIndexer;\n+import org.graylog2.indexer.messages.DocumentNotFoundException;\n+import org.graylog2.indexer.messages.IndexingRequest;\n+import org.graylog2.indexer.messages.Messages;\n+import org.graylog2.indexer.messages.MessagesAdapter;\n+import org.graylog2.indexer.results.ResultMessage;\n+import org.graylog2.plugin.Message;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.inject.Inject;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+\n+import static com.codahale.metrics.MetricRegistry.name;\n+\n+public class MessagesAdapterES7 implements MessagesAdapter {\n+    private static final Logger LOG = LoggerFactory.getLogger(MessagesAdapterES7.class);\n+    static final String INDEX_BLOCK_ERROR = \"cluster_block_exception\";\n+    static final String MAPPER_PARSING_EXCEPTION = \"mapper_parsing_exception\";\n+    static final String INDEX_BLOCK_REASON = \"blocked by: [TOO_MANY_REQUESTS/12/index read-only / allow delete (api)\";\n+\n+    private final ElasticsearchClient client;\n+    private final Meter invalidTimestampMeter;\n+    private final ChunkedBulkIndexer chunkedBulkIndexer;\n+\n+    @Inject\n+    public MessagesAdapterES7(ElasticsearchClient elasticsearchClient, MetricRegistry metricRegistry, ChunkedBulkIndexer chunkedBulkIndexer) {\n+        this.client = elasticsearchClient;\n+        this.invalidTimestampMeter = metricRegistry.meter(name(Messages.class, \"invalid-timestamps\"));\n+        this.chunkedBulkIndexer = chunkedBulkIndexer;\n+    }\n+\n+    @Override\n+    public ResultMessage get(String messageId, String index) throws IOException, DocumentNotFoundException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e20a6c3f5229f806e44aa97814e7e8814fcc0b0"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU5NjA1Nw==", "bodyText": "IOException is never thrown here", "url": "https://github.com/Graylog2/graylog2-server/pull/8451#discussion_r451596057", "createdAt": "2020-07-08T14:37:44Z", "author": {"login": "alex-konn"}, "path": "graylog-storage-elasticsearch7/src/main/java/org/graylog/storage/elasticsearch7/MessagesAdapterES7.java", "diffHunk": "@@ -0,0 +1,214 @@\n+package org.graylog.storage.elasticsearch7;\n+\n+import com.codahale.metrics.Meter;\n+import com.codahale.metrics.MetricRegistry;\n+import com.google.common.collect.Iterables;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.ElasticsearchException;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.action.bulk.BulkItemResponse;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.action.bulk.BulkRequest;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.action.bulk.BulkResponse;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.action.get.GetRequest;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.action.get.GetResponse;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.action.index.IndexRequest;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.client.indices.AnalyzeRequest;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.client.indices.AnalyzeResponse;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.rest.RestStatus;\n+import org.graylog2.indexer.messages.ChunkedBulkIndexer;\n+import org.graylog2.indexer.messages.DocumentNotFoundException;\n+import org.graylog2.indexer.messages.IndexingRequest;\n+import org.graylog2.indexer.messages.Messages;\n+import org.graylog2.indexer.messages.MessagesAdapter;\n+import org.graylog2.indexer.results.ResultMessage;\n+import org.graylog2.plugin.Message;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.inject.Inject;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+\n+import static com.codahale.metrics.MetricRegistry.name;\n+\n+public class MessagesAdapterES7 implements MessagesAdapter {\n+    private static final Logger LOG = LoggerFactory.getLogger(MessagesAdapterES7.class);\n+    static final String INDEX_BLOCK_ERROR = \"cluster_block_exception\";\n+    static final String MAPPER_PARSING_EXCEPTION = \"mapper_parsing_exception\";\n+    static final String INDEX_BLOCK_REASON = \"blocked by: [TOO_MANY_REQUESTS/12/index read-only / allow delete (api)\";\n+\n+    private final ElasticsearchClient client;\n+    private final Meter invalidTimestampMeter;\n+    private final ChunkedBulkIndexer chunkedBulkIndexer;\n+\n+    @Inject\n+    public MessagesAdapterES7(ElasticsearchClient elasticsearchClient, MetricRegistry metricRegistry, ChunkedBulkIndexer chunkedBulkIndexer) {\n+        this.client = elasticsearchClient;\n+        this.invalidTimestampMeter = metricRegistry.meter(name(Messages.class, \"invalid-timestamps\"));\n+        this.chunkedBulkIndexer = chunkedBulkIndexer;\n+    }\n+\n+    @Override\n+    public ResultMessage get(String messageId, String index) throws IOException, DocumentNotFoundException {\n+        final GetRequest getRequest = new GetRequest(index, messageId);\n+\n+        final GetResponse result = this.client.execute((c, requestOptions) -> c.get(getRequest, requestOptions));\n+\n+        if (!result.isExists()) {\n+            throw new DocumentNotFoundException(index, messageId);\n+        }\n+\n+        return ResultMessage.parseFromSource(messageId, index, result.getSource());\n+    }\n+\n+    @Override\n+    public List<String> analyze(String toAnalyze, String index, String analyzer) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e20a6c3f5229f806e44aa97814e7e8814fcc0b0"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYwNjU2Nw==", "bodyText": "Let's rename the variable to indexingErrors too.", "url": "https://github.com/Graylog2/graylog2-server/pull/8451#discussion_r451606567", "createdAt": "2020-07-08T14:52:00Z", "author": {"login": "alex-konn"}, "path": "graylog2-server/src/main/java/org/graylog2/indexer/messages/Messages.java", "diffHunk": "@@ -77,17 +122,87 @@ public ResultMessage get(String messageId, String index) throws DocumentNotFound\n                 .map(entry -> IndexingRequest.create(entry.getKey(), entry.getValue()))\n                 .collect(Collectors.toList());\n \n-        final List<IndexFailure> indexFailures = messagesAdapter.bulkIndex(indexingRequestList);\n+        final List<IndexingError> indexFailures = runBulkRequest(indexingRequestList, messageList.size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e20a6c3f5229f806e44aa97814e7e8814fcc0b0"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY0MDg5NA==", "bodyText": "JestUtils#execute will always throw an exception, if result.isSucceeded() == false\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    final JestResult result = JestUtils.execute(jestClient, request.build(), () -> \"Unable to check if index exists: \" + indexName);\n          \n          \n            \n            \n          \n          \n            \n                    return result.isSucceeded();\n          \n          \n            \n                     try {\n          \n          \n            \n                        final JestResult result = jestClient.execute(request.build());\n          \n          \n            \n                        return result.isSucceeded();\n          \n          \n            \n                    } catch (IOException e) {\n          \n          \n            \n                        throw new RuntimeException(\"Unable to check if index exists: \" + indexName, e);\n          \n          \n            \n                    }", "url": "https://github.com/Graylog2/graylog2-server/pull/8451#discussion_r451640894", "createdAt": "2020-07-08T15:39:31Z", "author": {"login": "alex-konn"}, "path": "graylog-storage-elasticsearch6/src/test/java/org/graylog/storage/elasticsearch6/testing/FixtureImporterES6.java", "diffHunk": "@@ -144,4 +159,16 @@ private void importNode(JsonNode root) throws IOException {\n             throw new IllegalStateException(sb.toString());\n         }\n     }\n+\n+    private boolean indexExists(String indexName) {\n+        final IndicesExists.Builder request = new IndicesExists.Builder(indexName);\n+        final JestResult result = JestUtils.execute(jestClient, request.build(), () -> \"Unable to check if index exists: \" + indexName);\n+\n+        return result.isSucceeded();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e81bfc3523da8c3ed0521e4bf876f72af5306db4"}, "originalPosition": 66}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f028f8ddc8c9887039d94356e2776f12e358223a", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/f028f8ddc8c9887039d94356e2776f12e358223a", "committedDate": "2020-07-09T07:44:29Z", "message": "Fixing index existence check."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "367b1f8ef2249fb8f12cd1c07f4b8fd3e7290373", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/367b1f8ef2249fb8f12cd1c07f4b8fd3e7290373", "committedDate": "2020-07-09T08:11:31Z", "message": "Removing exceptions from `throws`-clause which are not actually thrown."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a5015a3b0e36331930007bce5a16a94c2faf81b", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/9a5015a3b0e36331930007bce5a16a94c2faf81b", "committedDate": "2020-07-09T08:11:59Z", "message": "Giving variable a better name."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NDI2NjM0", "url": "https://github.com/Graylog2/graylog2-server/pull/8451#pullrequestreview-445426634", "createdAt": "2020-07-09T09:05:18Z", "commit": {"oid": "9a5015a3b0e36331930007bce5a16a94c2faf81b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3109, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}