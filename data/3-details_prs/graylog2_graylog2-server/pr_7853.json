{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxMDcyOTU1", "number": 7853, "title": "Show notifications when disk in the Elasticsearch nodes fills up", "bodyText": "Description\nAdded a disk usage check of the elasticsearch nodes. If cluster allocation thresholds are enabled, it will monitor those settings against all the elasticsearch nodes of the cluster and send notifications visible in graylog UI.\n3 different types (one per threshold available) of notifications have been created:\n\nLow\nHigh\nFlood Stage (available from ES 6.x)\n\nIf disk usage goes back to normal values, all triggered notifications will be cleared.\nMotivation and Context\nImplements #7810\nHow Has This Been Tested?\n\nBring up an Elasticsearch.\nAdjust the disk allocator thresholds to trigger based on the Elasticsearch nodes disk usage.\nCheck notifications are created in the UI\n\nScreenshots (if appropriate):\n\n\n\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Refactoring (non-breaking change)\n Breaking change (fix or feature that would cause existing functionality to change)\n\nChecklist:\n\n\n\n My code follows the code style of this project.\n My change requires a change to the documentation.\n I have updated the documentation accordingly.\n I have read the CONTRIBUTING document.\n I have added tests to cover my changes.", "createdAt": "2020-04-08T20:48:42Z", "url": "https://github.com/Graylog2/graylog2-server/pull/7853", "merged": true, "mergeCommit": {"oid": "f387236018db21f3ca1f7ed2217a21c214db99ed"}, "closed": true, "closedAt": "2020-04-17T09:32:01Z", "author": {"login": "radykal-com"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcWQ8UhgBqjMyMjE4MjEzMzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYd6pPAFqTM5NTMwMzQ0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2ecddb359bfbfae22e929cdb2367810cdcb22918", "author": {"user": {"login": "radykal-com", "name": "Marc Ruiz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/2ecddb359bfbfae22e929cdb2367810cdcb22918", "committedDate": "2020-04-08T20:46:42Z", "message": "Show notifications when disk in the Elasticsearch nodes fills up based on the disk allocation settings."}, "afterCommit": {"oid": "fa619894a12c16969959aba2067f9fc1b160b646", "author": {"user": {"login": "radykal-com", "name": "Marc Ruiz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/fa619894a12c16969959aba2067f9fc1b160b646", "committedDate": "2020-04-10T13:16:21Z", "message": "Show notifications when disk in the Elasticsearch nodes fills up based on the disk allocation settings."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3583809841aa267d7e8a7aa85e684793470cf06", "author": {"user": {"login": "radykal-com", "name": "Marc Ruiz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/f3583809841aa267d7e8a7aa85e684793470cf06", "committedDate": "2020-04-11T12:45:17Z", "message": "Show notifications when disk in the Elasticsearch nodes fills up based on the disk allocation settings."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4f1266fafd8365d8624fda919955f60d64d767e", "author": {"user": {"login": "radykal-com", "name": "Marc Ruiz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/a4f1266fafd8365d8624fda919955f60d64d767e", "committedDate": "2020-04-11T12:45:17Z", "message": "FloodStage should be optional due to be a new watermark in Elasticsearch 6 not present in Elasticsearch 5"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1a25fbdd0e53495d496a764460279b000a9db83", "author": {"user": {"login": "radykal-com", "name": "Marc Ruiz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/a1a25fbdd0e53495d496a764460279b000a9db83", "committedDate": "2020-04-11T12:45:17Z", "message": "Add more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92d16f7d31bfd54e04553ce7a65c596edd04fb30", "author": {"user": {"login": "radykal-com", "name": "Marc Ruiz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/92d16f7d31bfd54e04553ce7a65c596edd04fb30", "committedDate": "2020-04-11T12:45:17Z", "message": "Add logging when notifications are created"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a2398ddfdd1f027a76b0e03a7008329f1ce0802", "author": {"user": {"login": "radykal-com", "name": "Marc Ruiz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/0a2398ddfdd1f027a76b0e03a7008329f1ce0802", "committedDate": "2020-04-11T13:27:38Z", "message": "Add missing license header"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cb409a4a48c553d09eb133a0818a69c51140c2db", "author": {"user": {"login": "radykal-com", "name": "Marc Ruiz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/cb409a4a48c553d09eb133a0818a69c51140c2db", "committedDate": "2020-04-11T12:32:59Z", "message": "Add logging when notifications are created"}, "afterCommit": {"oid": "0a2398ddfdd1f027a76b0e03a7008329f1ce0802", "author": {"user": {"login": "radykal-com", "name": "Marc Ruiz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/0a2398ddfdd1f027a76b0e03a7008329f1ce0802", "committedDate": "2020-04-11T13:27:38Z", "message": "Add missing license header"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NjMzMDYx", "url": "https://github.com/Graylog2/graylog2-server/pull/7853#pullrequestreview-394633061", "createdAt": "2020-04-16T13:29:59Z", "commit": {"oid": "0a2398ddfdd1f027a76b0e03a7008329f1ce0802"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxMzoyOTo1OVrOGGlV0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxMzozNjo0NVrOGGlpGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU1NjQzMw==", "bodyText": "We avoid using wildcard imports to guard against conflicts due to classes being added to a remote package (rare in java.util but still).\nNoted this in other places as well.\nIf you use IntelliJ, you can increase the threshold for wildcard imports:", "url": "https://github.com/Graylog2/graylog2-server/pull/7853#discussion_r409556433", "createdAt": "2020-04-16T13:29:59Z", "author": {"login": "kroepke"}, "path": "graylog2-server/src/main/java/org/graylog2/indexer/cluster/Cluster.java", "diffHunk": "@@ -29,17 +29,19 @@\n import io.searchbox.core.CatResult;\n import org.graylog2.indexer.ElasticsearchException;\n import org.graylog2.indexer.IndexSetRegistry;\n+import org.graylog2.indexer.cluster.jest.GetAllocationDiskSettings;\n import org.graylog2.indexer.cluster.jest.JestUtils;\n+import org.graylog2.indexer.cluster.health.ClusterAllocationDiskSettings;\n+import org.graylog2.indexer.cluster.health.ClusterAllocationDiskSettingsFactory;\n+import org.graylog2.indexer.cluster.health.NodeDiskUsageStats;\n+import org.graylog2.indexer.cluster.health.NodeFileDescriptorStats;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n import javax.inject.Inject;\n import javax.inject.Named;\n import javax.inject.Singleton;\n-import java.util.Arrays;\n-import java.util.Collection;\n-import java.util.Optional;\n-import java.util.Set;\n+import java.util.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a2398ddfdd1f027a76b0e03a7008329f1ce0802"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU1NzAwMA==", "bodyText": "wildcard imports", "url": "https://github.com/Graylog2/graylog2-server/pull/7853#discussion_r409557000", "createdAt": "2020-04-16T13:30:47Z", "author": {"login": "kroepke"}, "path": "graylog2-server/src/main/java/org/graylog2/periodical/IndexerClusterCheckerThread.java", "diffHunk": "@@ -16,16 +16,17 @@\n  */\n package org.graylog2.periodical;\n \n-import org.graylog2.indexer.cluster.Cluster;\n-import org.graylog2.indexer.cluster.NodeFileDescriptorStats;\n+import com.google.common.annotations.VisibleForTesting;\n+import org.graylog2.indexer.cluster.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a2398ddfdd1f027a76b0e03a7008329f1ce0802"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU1NzA1Ng==", "bodyText": "wildcard imports", "url": "https://github.com/Graylog2/graylog2-server/pull/7853#discussion_r409557056", "createdAt": "2020-04-16T13:30:52Z", "author": {"login": "kroepke"}, "path": "graylog2-server/src/main/java/org/graylog2/periodical/IndexerClusterCheckerThread.java", "diffHunk": "@@ -16,16 +16,17 @@\n  */\n package org.graylog2.periodical;\n \n-import org.graylog2.indexer.cluster.Cluster;\n-import org.graylog2.indexer.cluster.NodeFileDescriptorStats;\n+import com.google.common.annotations.VisibleForTesting;\n+import org.graylog2.indexer.cluster.*;\n+import org.graylog2.indexer.cluster.health.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a2398ddfdd1f027a76b0e03a7008329f1ce0802"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU1NzA5Nw==", "bodyText": "wildcard imports", "url": "https://github.com/Graylog2/graylog2-server/pull/7853#discussion_r409557097", "createdAt": "2020-04-16T13:30:57Z", "author": {"login": "kroepke"}, "path": "graylog2-server/src/main/java/org/graylog2/periodical/IndexerClusterCheckerThread.java", "diffHunk": "@@ -16,16 +16,17 @@\n  */\n package org.graylog2.periodical;\n \n-import org.graylog2.indexer.cluster.Cluster;\n-import org.graylog2.indexer.cluster.NodeFileDescriptorStats;\n+import com.google.common.annotations.VisibleForTesting;\n+import org.graylog2.indexer.cluster.*;\n+import org.graylog2.indexer.cluster.health.*;\n import org.graylog2.notifications.Notification;\n import org.graylog2.notifications.NotificationService;\n import org.graylog2.plugin.periodical.Periodical;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n import javax.inject.Inject;\n-import java.util.Set;\n+import java.util.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a2398ddfdd1f027a76b0e03a7008329f1ce0802"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU1NzQ1Ng==", "bodyText": "wildcard imports", "url": "https://github.com/Graylog2/graylog2-server/pull/7853#discussion_r409557456", "createdAt": "2020-04-16T13:31:28Z", "author": {"login": "kroepke"}, "path": "graylog2-server/src/test/java/org/graylog2/periodical/IndexerClusterCheckerThreadTest.java", "diffHunk": "@@ -0,0 +1,249 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog2.periodical;\n+\n+import org.elasticsearch.common.unit.ByteSizeUnit;\n+import org.elasticsearch.common.unit.ByteSizeValue;\n+import org.graylog2.indexer.cluster.Cluster;\n+import org.graylog2.indexer.cluster.health.*;\n+import org.graylog2.notifications.Notification;\n+import org.graylog2.notifications.NotificationImpl;\n+import org.graylog2.notifications.NotificationService;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Mock;\n+import org.mockito.junit.MockitoJUnit;\n+import org.mockito.junit.MockitoRule;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a2398ddfdd1f027a76b0e03a7008329f1ce0802"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU2MDk5Nw==", "bodyText": "Could this also be an auto-value class?", "url": "https://github.com/Graylog2/graylog2-server/pull/7853#discussion_r409560997", "createdAt": "2020-04-16T13:36:19Z", "author": {"login": "kroepke"}, "path": "graylog2-server/src/main/java/org/graylog2/indexer/cluster/health/AbsoluteValueWatermarkSettings.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog2.indexer.cluster.health;\n+\n+import org.elasticsearch.common.unit.ByteSizeValue;\n+\n+import javax.annotation.Nullable;\n+\n+public class AbsoluteValueWatermarkSettings implements WatermarkSettings<ByteSizeValue> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a2398ddfdd1f027a76b0e03a7008329f1ce0802"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU2MTM2OA==", "bodyText": "Could this also be an auto-value class?", "url": "https://github.com/Graylog2/graylog2-server/pull/7853#discussion_r409561368", "createdAt": "2020-04-16T13:36:45Z", "author": {"login": "kroepke"}, "path": "graylog2-server/src/main/java/org/graylog2/indexer/cluster/health/PercentageWatermarkSettings.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog2.indexer.cluster.health;\n+\n+import javax.annotation.Nullable;\n+\n+public class PercentageWatermarkSettings implements WatermarkSettings<Double> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a2398ddfdd1f027a76b0e03a7008329f1ce0802"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a105a056c44820f0f4ff1212f5bbeab45c95ba0f", "author": {"user": {"login": "radykal-com", "name": "Marc Ruiz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/a105a056c44820f0f4ff1212f5bbeab45c95ba0f", "committedDate": "2020-04-16T16:25:56Z", "message": "Remove wildcard imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c6e6989f5fd8ebdf92ce756e95408e3601da3b0", "author": {"user": {"login": "radykal-com", "name": "Marc Ruiz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/4c6e6989f5fd8ebdf92ce756e95408e3601da3b0", "committedDate": "2020-04-16T16:36:47Z", "message": "Use AutoValue classes in WatermarkSettings implementations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MzAzNDQ2", "url": "https://github.com/Graylog2/graylog2-server/pull/7853#pullrequestreview-395303446", "createdAt": "2020-04-17T09:31:34Z", "commit": {"oid": "4c6e6989f5fd8ebdf92ce756e95408e3601da3b0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2513, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}