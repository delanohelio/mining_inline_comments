{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU4Njg3NzMw", "number": 7073, "title": "Fix issue when clicking on Roles menu after clicking \"Create role\" button", "bodyText": "Description\n\nBefore this change clicking on the roles menu on the Authentication page after initially loading the create role from resulted in Errorpage \"Cannot read property 'name' of null\".\nNow we use default state to ensure role object is always set.\nMotivation and Context\n\n\n#5908\nHow Has This Been Tested?\n\n\n\nScreenshots (if appropriate):\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Refactoring (non-breaking change)\n Breaking change (fix or feature that would cause existing functionality to change)\n\nChecklist:\n\n\n\n My code follows the code style of this project.\n My change requires a change to the documentation.\n I have updated the documentation accordingly.\n I have read the CONTRIBUTING document.\n I have added tests to cover my changes.", "createdAt": "2020-01-02T15:02:18Z", "url": "https://github.com/Graylog2/graylog2-server/pull/7073", "merged": true, "mergeCommit": {"oid": "ee3c87cadfca6f41a39e03631e76e87eaba78a62"}, "closed": true, "closedAt": "2020-01-21T13:54:59Z", "author": {"login": "ousmaneo"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb2atBkgH2gAyMzU4Njg3NzMwOjBhODgzYWM2MDIxMTc0NWVhMDNiYzg0M2JiMzVmZmE3YjU0OTI1Nzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8hiAoAFqTM0NTg5MjExMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0a883ac60211745ea03bc843bb35ffa7b5492579", "author": {"user": {"login": "ousmaneo", "name": "Ousmane SAMBA"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/0a883ac60211745ea03bc843bb35ffa7b5492579", "committedDate": "2020-01-02T14:33:33Z", "message": "Use default state on EditRole when using role menu\n\n* Refactore Component to use class instead of createReactClass\n* use getDerivedStateFromProps instead of componentWillReceiveProps\n* set default state if any is provided"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1db62019be425b125a5b72afa3f2f32135b86d94", "author": {"user": {"login": "ousmaneo", "name": "Ousmane SAMBA"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/1db62019be425b125a5b72afa3f2f32135b86d94", "committedDate": "2020-01-20T11:03:57Z", "message": "Merge branch 'master' into issue-5908"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc8e58d5afcaa94157ea6935205e05756517077d", "author": {"user": {"login": "ousmaneo", "name": "Ousmane SAMBA"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/dc8e58d5afcaa94157ea6935205e05756517077d", "committedDate": "2020-01-20T11:15:59Z", "message": "Initialize state"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1MzE3NzY3", "url": "https://github.com/Graylog2/graylog2-server/pull/7073#pullrequestreview-345317767", "createdAt": "2020-01-20T13:46:51Z", "commit": {"oid": "dc8e58d5afcaa94157ea6935205e05756517077d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxMzo0Njo1MlrOFfe1Iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxMzo0Njo1MlrOFfe1Iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU1NTI5OQ==", "bodyText": "Since we use getDerivedStateFromProps to initialize an \"empty\" role, and getDerivedStateFromProps is called before the first render and before any subsequent update is rendered, I think the constructor can be simplified and doesn't need to handle the default case.\nSo I think we can simplify this logic doing the following:\n\nIn the constructor, we set the role to the initialRole, since we are also using that to get the initialName\nIn getDerivedStateFromProps we check if prevState.role is set, and if it is not set we initialize it to the \"empty\" role", "url": "https://github.com/Graylog2/graylog2-server/pull/7073#discussion_r368555299", "createdAt": "2020-01-20T13:46:52Z", "author": {"login": "edmundoa"}, "path": "graylog2-web-interface/src/components/users/EditRole.jsx", "diffHunk": "@@ -1,85 +1,77 @@\n import PropTypes from 'prop-types';\n import React from 'react';\n-import createReactClass from 'create-react-class';\n import Immutable from 'immutable';\n \n import { Button, Alert, Col, ControlLabel, FormGroup, HelpBlock, Row } from 'components/graylog';\n import { Input } from 'components/bootstrap';\n import PermissionSelector from 'components/users/PermissionSelector';\n-import PermissionsMixin from 'util/PermissionsMixin';\n \n-const EditRole = createReactClass({\n-  displayName: 'EditRole',\n-\n-  propTypes: {\n-    initialRole: PropTypes.object.isRequired,\n-    onSave: PropTypes.func.isRequired,\n-    cancelEdit: PropTypes.func.isRequired,\n-    streams: PropTypes.object.isRequired,\n-    dashboards: PropTypes.object.isRequired,\n-  },\n-\n-  mixins: [PermissionsMixin],\n-\n-  getInitialState() {\n+class EditRole extends React.Component {\n+  constructor(props) {\n+    super(props);\n     const { initialRole } = this.props;\n-\n     let role = initialRole;\n-    if (role === null) {\n-      // for the create dialog\n+    if (!role) {\n       role = {\n         name: null,\n         description: null,\n         permissions: [],\n       };\n     }\n-    return {\n+    this.state = {\n       role,\n       initialName: this._safeRoleName(initialRole),\n     };\n-  },\n+  }\n \n-  componentWillReceiveProps(newProps) {\n-    this.setState({ role: newProps.initialRole, initialName: this._safeRoleName(newProps.initialRole) });\n-  },\n+  static getDerivedStateFromProps(nextProps, prevState) {\n+    const {\n+      role = {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc8e58d5afcaa94157ea6935205e05756517077d"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32ddfbce3f5265faf1333515be216b8aaed7fa33", "author": {"user": {"login": "ousmaneo", "name": "Ousmane SAMBA"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/32ddfbce3f5265faf1333515be216b8aaed7fa33", "committedDate": "2020-01-20T15:04:21Z", "message": "Refactoring"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1ODkyMTEz", "url": "https://github.com/Graylog2/graylog2-server/pull/7073#pullrequestreview-345892113", "createdAt": "2020-01-21T13:54:24Z", "commit": {"oid": "32ddfbce3f5265faf1333515be216b8aaed7fa33"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2766, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}