{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2NzAyMTM2", "number": 9385, "title": "Display synced users section on every authentication service details page", "bodyText": "Previously the synced users section was only available on the details page of an active authentication service.\nWith this PR we are refactoring the endpoint to get users for an auth service. It's now possible to get users for every authentication backend instead of only the active one. This way we can display the section on every authentication service details page.\nFixes Graylog2/graylog-plugin-enterprise#1912", "createdAt": "2020-11-06T12:05:08Z", "url": "https://github.com/Graylog2/graylog2-server/pull/9385", "merged": true, "mergeCommit": {"oid": "25bdf89a983aa16e6dab9c2e4c0ac6536e076660"}, "closed": true, "closedAt": "2020-11-09T17:07:25Z", "author": {"login": "bernd"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdafZ16gH2gAyNTE2NzAyMTM2OjYyNTE2ZmI0MmNmY2I2YTJhZjY5OWVkYzUwMDliMTg0ZDIyNTkwODg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABda3b0lAFqTUyNjQzNjI5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "62516fb42cfcb6a2af699edc5009b184d2259088", "author": {"user": {"login": "bernd", "name": "Bernd Ahlers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/62516fb42cfcb6a2af699edc5009b184d2259088", "committedDate": "2020-11-08T12:34:33Z", "message": "Refactor endpoint to get users for an auth service\n\nIt's now possible to get users for every authentication backend instead\nof only the active one.\n\nRefs Graylog2/graylog-plugin-enterprise#1912"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "676e67a15889f075a703e541799d6353571fd86c", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/676e67a15889f075a703e541799d6353571fd86c", "committedDate": "2020-11-08T12:49:28Z", "message": "Load synced users on auth backend details page by backend id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8f4551abcc70c32f76a520e861c61580f61568b", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/c8f4551abcc70c32f76a520e861c61580f61568b", "committedDate": "2020-11-08T13:09:45Z", "message": "Load synced teams on auth backend details page by backend id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd2af512eb32713597312a9217771c3a4ea838a5", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/cd2af512eb32713597312a9217771c3a4ea838a5", "committedDate": "2020-11-08T13:18:18Z", "message": "Display synced teams section and synced users section on details page of disabled authentication backends"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cd0cb72bd4c651ebcb15d3d4b79f411062c88a0d", "author": {"user": {"login": "bernd", "name": "Bernd Ahlers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/cd0cb72bd4c651ebcb15d3d4b79f411062c88a0d", "committedDate": "2020-11-06T12:02:09Z", "message": "Refactor endpoint to get users for an auth service\n\nIt's now possible to get users for every authentication backend instead\nof only the active one.\n\nRefs Graylog2/graylog-plugin-enterprise#1912"}, "afterCommit": {"oid": "cd2af512eb32713597312a9217771c3a4ea838a5", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/cd2af512eb32713597312a9217771c3a4ea838a5", "committedDate": "2020-11-08T13:18:18Z", "message": "Display synced teams section and synced users section on details page of disabled authentication backends"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ed1e604050cf00ac3b8ea78434830e190d1d2ee", "author": {"user": {"login": "linuspahl", "name": "Linus Pahl"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/4ed1e604050cf00ac3b8ea78434830e190d1d2ee", "committedDate": "2020-11-09T08:32:17Z", "message": "Fix user edit link in synced users overview"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MjY4NDUw", "url": "https://github.com/Graylog2/graylog2-server/pull/9385#pullrequestreview-526268450", "createdAt": "2020-11-09T13:43:52Z", "commit": {"oid": "4ed1e604050cf00ac3b8ea78434830e190d1d2ee"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMzo0Mzo1MlrOHvvgAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMzo1MjoxNVrOHvv1zA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTgyMzM2Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @ApiOperation(\"Get paginated users for active authentication service backend\")\n          \n          \n            \n                @ApiOperation(\"Get paginated users for an authentication service backend\")", "url": "https://github.com/Graylog2/graylog2-server/pull/9385#discussion_r519823362", "createdAt": "2020-11-09T13:43:52Z", "author": {"login": "mpfz0r"}, "path": "graylog2-server/src/main/java/org/graylog/security/authservice/rest/AuthServiceBackendsResource.java", "diffHunk": "@@ -138,6 +166,55 @@ public void delete(@ApiParam(name = \"backendId\", required = true) @PathParam(\"ba\n         dbService.delete(config.id());\n     }\n \n+    @GET\n+    @Path(\"{backendId}/users\")\n+    @ApiOperation(\"Get paginated users for active authentication service backend\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ed1e604050cf00ac3b8ea78434830e190d1d2ee"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTgyODUxNg==", "bodyText": "I'd prefer it if we used USERS_READ.\nOr even GranteeService.getVisibleUsers()", "url": "https://github.com/Graylog2/graylog2-server/pull/9385#discussion_r519828516", "createdAt": "2020-11-09T13:51:38Z", "author": {"login": "mpfz0r"}, "path": "graylog2-server/src/main/java/org/graylog/security/authservice/rest/AuthServiceBackendsResource.java", "diffHunk": "@@ -138,6 +166,55 @@ public void delete(@ApiParam(name = \"backendId\", required = true) @PathParam(\"ba\n         dbService.delete(config.id());\n     }\n \n+    @GET\n+    @Path(\"{backendId}/users\")\n+    @ApiOperation(\"Get paginated users for active authentication service backend\")\n+    @RequiresPermissions({RestPermissions.AUTH_SERVICE_GLOBAL_CONFIG_READ, RestPermissions.USERS_LIST})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ed1e604050cf00ac3b8ea78434830e190d1d2ee"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTgyODk0MA==", "bodyText": "should be checking roles:read", "url": "https://github.com/Graylog2/graylog2-server/pull/9385#discussion_r519828940", "createdAt": "2020-11-09T13:52:15Z", "author": {"login": "mpfz0r"}, "path": "graylog2-server/src/main/java/org/graylog/security/authservice/rest/AuthServiceBackendsResource.java", "diffHunk": "@@ -138,6 +166,55 @@ public void delete(@ApiParam(name = \"backendId\", required = true) @PathParam(\"ba\n         dbService.delete(config.id());\n     }\n \n+    @GET\n+    @Path(\"{backendId}/users\")\n+    @ApiOperation(\"Get paginated users for active authentication service backend\")\n+    @RequiresPermissions({RestPermissions.AUTH_SERVICE_GLOBAL_CONFIG_READ, RestPermissions.USERS_LIST})\n+    public PaginatedResponse<UserOverviewDTO> getUsers(\n+            @ApiParam(name = \"page\") @QueryParam(\"page\") @DefaultValue(\"1\") int page,\n+            @ApiParam(name = \"per_page\") @QueryParam(\"per_page\") @DefaultValue(\"50\") int perPage,\n+            @ApiParam(name = \"query\") @QueryParam(\"query\") @DefaultValue(\"\") String query,\n+            @ApiParam(name = \"sort\", value = \"The field to sort the result on\", required = true, allowableValues = \"username,full_name,email\")\n+            @DefaultValue(UserOverviewDTO.FIELD_FULL_NAME) @QueryParam(\"sort\") String sort,\n+            @ApiParam(name = \"order\", value = \"The sort direction\", allowableValues = \"asc, desc\")\n+            @DefaultValue(\"asc\") @QueryParam(\"order\") String order,\n+            @ApiParam(name = \"backendId\", required = true) @PathParam(\"backendId\") @NotBlank String backendId\n+    ) {\n+        final AuthServiceBackendDTO activeConfig = loadConfig(backendId);\n+\n+        final PaginatedList<UserOverviewDTO> userList = userService.findPaginatedByAuthServiceBackend(\n+                parseSearchQuery(query), page, perPage, sort, order, activeConfig.id());\n+\n+        return PaginatedResponse.create(\n+                \"users\",\n+                userList,\n+                query,\n+                Collections.singletonMap(\"roles\", createRoleContext(userList.delegate()))\n+        );\n+    }\n+\n+    private Map<String, Object> createRoleContext(List<UserOverviewDTO> userList) {\n+        final Set<String> roleIds = userList.stream()\n+                .flatMap(user -> user.roles().stream())\n+                .collect(Collectors.toSet());\n+        try {\n+            return roleService.findIdMap(roleIds).values()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ed1e604050cf00ac3b8ea78434830e190d1d2ee"}, "originalPosition": 115}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2Mjc2NTk0", "url": "https://github.com/Graylog2/graylog2-server/pull/9385#pullrequestreview-526276594", "createdAt": "2020-11-09T13:53:07Z", "commit": {"oid": "4ed1e604050cf00ac3b8ea78434830e190d1d2ee"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33f13fd6242a592001bbe0757d3fff41fa242b6f", "author": {"user": {"login": "bernd", "name": "Bernd Ahlers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/33f13fd6242a592001bbe0757d3fff41fa242b6f", "committedDate": "2020-11-09T15:58:59Z", "message": "Merge remote-tracking branch 'origin/master' into fix/enterprise-issue-1912"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1db5bf0075e30758be69b5dbace7c9dbe5fc5a8", "author": {"user": {"login": "bernd", "name": "Bernd Ahlers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/f1db5bf0075e30758be69b5dbace7c9dbe5fc5a8", "committedDate": "2020-11-09T16:12:39Z", "message": "Fix permissions and API description"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NDM2Mjkz", "url": "https://github.com/Graylog2/graylog2-server/pull/9385#pullrequestreview-526436293", "createdAt": "2020-11-09T16:34:26Z", "commit": {"oid": "f1db5bf0075e30758be69b5dbace7c9dbe5fc5a8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3404, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}