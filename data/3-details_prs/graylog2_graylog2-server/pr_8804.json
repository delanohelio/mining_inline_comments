{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3OTkxNDQ4", "number": 8804, "title": "Implement HasOwnership which checks for sharing", "bodyText": "Motivation\nPrior to this change, we always show the entity sharing modal button\neven if you were not allowed to see it which would lead into a error\nscreen.\nDescription\nThis change will implement a switching component which decides if a\nchild will be rendered depending on if the user has ownership over the\nentity passed on.\n/jenkins-pr-deps Graylog2/graylog-plugin-enterprise#1569", "createdAt": "2020-08-14T13:41:52Z", "url": "https://github.com/Graylog2/graylog2-server/pull/8804", "merged": true, "mergeCommit": {"oid": "bb20f89e466cb6a3e38ff751c7e291ac7a98a92b"}, "closed": true, "closedAt": "2020-08-19T10:28:08Z", "author": {"login": "kmerz"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc_wc8TAFqTQ2ODM0MzQ1OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAZC34AFqTQ3MDMyNjQ0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MzQzNDU4", "url": "https://github.com/Graylog2/graylog2-server/pull/8804#pullrequestreview-468343458", "createdAt": "2020-08-17T10:23:13Z", "commit": {"oid": "bc2ac192085d09e737b2f574d92714556c8616f6"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxMDoyMzoxM1rOHBjApg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxMDo0NjoyNVrOHBjvsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM4NDIzMA==", "bodyText": "Do you mean something like user has ownership of entity? And let's remove the space before children.", "url": "https://github.com/Graylog2/graylog2-server/pull/8804#discussion_r471384230", "createdAt": "2020-08-17T10:23:13Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/components/common/HasOwnership.jsx", "diffHunk": "@@ -0,0 +1,42 @@\n+// @flow strict\n+import * as React from 'react';\n+import { useContext } from 'react';\n+import PropTypes from 'prop-types';\n+\n+import CurrentUserContext from 'contexts/CurrentUserContext';\n+import { createGRN } from 'logic/permissions/GRN';\n+\n+type Props = {\n+  children: React.Node,\n+  id: string,\n+  type: string,\n+};\n+\n+const HasOwnership = ({ children, id, type }: Props) => {\n+  const currentUser = useContext(CurrentUserContext);\n+  const entity = createGRN(id, type);\n+  const ownership = `entity:own:${entity}`;\n+  const adminPermission = '*';\n+\n+  if (currentUser) {\n+    const { grn_permissions: grnPermissions = [], permissions } = currentUser;\n+    const isAdmin = permissions.includes(adminPermission);\n+\n+    if (grnPermissions.includes(ownership) || isAdmin) {\n+      return children;\n+    }\n+  }\n+\n+  return null;\n+};\n+\n+HasOwnership.propTypes = {\n+  /**  Children to render if user has entity of entity */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc2ac192085d09e737b2f574d92714556c8616f6"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM4ODMxNA==", "bodyText": "I know we do it like this in other places as well, but could you extract this value to a separate file? It would be great if we get to a point where we can define in one place what the admin permissions look like. Even though it is not likely that this will change soon.", "url": "https://github.com/Graylog2/graylog2-server/pull/8804#discussion_r471388314", "createdAt": "2020-08-17T10:30:51Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/components/common/HasOwnership.jsx", "diffHunk": "@@ -0,0 +1,42 @@\n+// @flow strict\n+import * as React from 'react';\n+import { useContext } from 'react';\n+import PropTypes from 'prop-types';\n+\n+import CurrentUserContext from 'contexts/CurrentUserContext';\n+import { createGRN } from 'logic/permissions/GRN';\n+\n+type Props = {\n+  children: React.Node,\n+  id: string,\n+  type: string,\n+};\n+\n+const HasOwnership = ({ children, id, type }: Props) => {\n+  const currentUser = useContext(CurrentUserContext);\n+  const entity = createGRN(id, type);\n+  const ownership = `entity:own:${entity}`;\n+  const adminPermission = '*';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc2ac192085d09e737b2f574d92714556c8616f6"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM5MTQ5MA==", "bodyText": "You could move this logic to util/PermissionsMixin, so it can also be used as a function e.g. in cases where we need this information before the render part.", "url": "https://github.com/Graylog2/graylog2-server/pull/8804#discussion_r471391490", "createdAt": "2020-08-17T10:37:17Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/components/common/HasOwnership.jsx", "diffHunk": "@@ -0,0 +1,42 @@\n+// @flow strict\n+import * as React from 'react';\n+import { useContext } from 'react';\n+import PropTypes from 'prop-types';\n+\n+import CurrentUserContext from 'contexts/CurrentUserContext';\n+import { createGRN } from 'logic/permissions/GRN';\n+\n+type Props = {\n+  children: React.Node,\n+  id: string,\n+  type: string,\n+};\n+\n+const HasOwnership = ({ children, id, type }: Props) => {\n+  const currentUser = useContext(CurrentUserContext);\n+  const entity = createGRN(id, type);\n+  const ownership = `entity:own:${entity}`;\n+  const adminPermission = '*';\n+\n+  if (currentUser) {\n+    const { grn_permissions: grnPermissions = [], permissions } = currentUser;\n+    const isAdmin = permissions.includes(adminPermission);\n+\n+    if (grnPermissions.includes(ownership) || isAdmin) {\n+      return children;\n+    }\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc2ac192085d09e737b2f574d92714556c8616f6"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM5NjI3NQ==", "bodyText": "We are disabling the button, when the current user does not have the right permissions, but hide it when he is not an owner. Thinking about the rule you've taught me, regarding when to disable a button and when to hide it, I am wondering if it makes sense to just disable the button in this case (has no ownership) as well or if we should also hide it if the user is not allowed to edit.", "url": "https://github.com/Graylog2/graylog2-server/pull/8804#discussion_r471396275", "createdAt": "2020-08-17T10:46:25Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/views/components/ViewActionsMenu.jsx", "diffHunk": "@@ -67,9 +67,11 @@ const ViewActionsMenu = ({ view, isNewView, metadata, router }) => {\n         <MenuItem onSelect={() => setEditViewOpen(true)} disabled={isNewView || !allowedToEdit}>\n           <Icon name=\"edit\" /> Edit metadata\n         </MenuItem>\n-        <MenuItem onSelect={() => setShareViewOpen(true)} disabled={isNewView || !allowedToEdit}>\n-          <Icon name=\"share-alt\" /> Share\n-        </MenuItem>\n+        <HasOwnership id={view.id} type=\"dashboard\">\n+          <MenuItem onSelect={() => setShareViewOpen(true)} disabled={isNewView || !allowedToEdit}>\n+            <Icon name=\"share-alt\" /> Share\n+          </MenuItem>\n+        </HasOwnership>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc2ac192085d09e737b2f574d92714556c8616f6"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec210b488b0db2c81d2b236d9ac54cf50d6a0c01", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/ec210b488b0db2c81d2b236d9ac54cf50d6a0c01", "committedDate": "2020-08-18T13:15:18Z", "message": "Implement HasOwnership which checks for sharing\n\n## Motivation\nPrior to this change, we always show the entity sharing modal button\neven if you were not allowed to see it which would lead into a error\nscreen.\n\n## Description\nThis change will implement a switching component which decides if a\nchild will be rendered depending on if the user has ownership over the\nentity passed on."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9535885d33ab9237e6b55a553ace7b6cd1dea334", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/9535885d33ab9237e6b55a553ace7b6cd1dea334", "committedDate": "2020-08-18T13:15:19Z", "message": "Fix failing tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "272539f0aa49f3d6d0d7b8333506af12f6da77d9", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/272539f0aa49f3d6d0d7b8333506af12f6da77d9", "committedDate": "2020-08-18T13:15:19Z", "message": "Fix flow and annotation from @linuspahl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a60e7ed34a102d2edc0a582b28d569cf4d82c6e", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/7a60e7ed34a102d2edc0a582b28d569cf4d82c6e", "committedDate": "2020-08-18T13:15:19Z", "message": "Make it possible to disable the child component"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1de1927ddd4f243338cd081ba984dd676d2ac3a", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/d1de1927ddd4f243338cd081ba984dd676d2ac3a", "committedDate": "2020-08-18T13:15:20Z", "message": "Disable instead of hiding children"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bc2ac192085d09e737b2f574d92714556c8616f6", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/bc2ac192085d09e737b2f574d92714556c8616f6", "committedDate": "2020-08-14T14:39:21Z", "message": "Fix failing tests"}, "afterCommit": {"oid": "d1de1927ddd4f243338cd081ba984dd676d2ac3a", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/d1de1927ddd4f243338cd081ba984dd676d2ac3a", "committedDate": "2020-08-18T13:15:20Z", "message": "Disable instead of hiding children"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d772421263b3cf2863eeba03445308f18d820f5", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/5d772421263b3cf2863eeba03445308f18d820f5", "committedDate": "2020-08-19T07:49:44Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc78a21ea417cbc4aa4c71b137ccac7e8e020c84", "author": {"user": {"login": "kmerz", "name": "Konrad Merz"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/dc78a21ea417cbc4aa4c71b137ccac7e8e020c84", "committedDate": "2020-08-19T08:07:38Z", "message": "Fix flow errors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMzI2NDQy", "url": "https://github.com/Graylog2/graylog2-server/pull/8804#pullrequestreview-470326442", "createdAt": "2020-08-19T10:28:00Z", "commit": {"oid": "dc78a21ea417cbc4aa4c71b137ccac7e8e020c84"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2835, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}