{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2NTg5Mjk3", "number": 8774, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDozMDowOFrOEXp0vA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwODoyMjozNFrOEaZkWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzMjM3OTQ4OnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/logic/permissions/GRN.js", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDozMDowOFrOG_j-uQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDozMDo0OVrOG_kAig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwMjk2OQ==", "bodyText": "I would rather suggest a regex for this. Because if we ever fill the other colons of the GRN no one will remember this. Let's make it future proof. I can help you with that if you need help", "url": "https://github.com/Graylog2/graylog2-server/pull/8774#discussion_r469302969", "createdAt": "2020-08-12T14:30:08Z", "author": {"login": "kmerz"}, "path": "graylog2-web-interface/src/logic/permissions/GRN.js", "diffHunk": "@@ -2,3 +2,9 @@\n \n // eslint-disable-next-line import/prefer-default-export\n export const createGRN = (id: string, type: string) => `grn::::${type}:${id}`;\n+\n+export const getIdFromGRN = (grn: string, type: string) => {\n+  const grnStart = `grn::::${type}:`;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5efdf14ec28ea4052f3dfa702135e227462a8b44"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwMzQzNA==", "bodyText": "And we should now definitely write some minimal tests for this.", "url": "https://github.com/Graylog2/graylog2-server/pull/8774#discussion_r469303434", "createdAt": "2020-08-12T14:30:49Z", "author": {"login": "kmerz"}, "path": "graylog2-web-interface/src/logic/permissions/GRN.js", "diffHunk": "@@ -2,3 +2,9 @@\n \n // eslint-disable-next-line import/prefer-default-export\n export const createGRN = (id: string, type: string) => `grn::::${type}:${id}`;\n+\n+export const getIdFromGRN = (grn: string, type: string) => {\n+  const grnStart = `grn::::${type}:`;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwMjk2OQ=="}, "originalCommit": {"oid": "5efdf14ec28ea4052f3dfa702135e227462a8b44"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0MDA2NjY3OnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/components/permissions/SharedEntitiesOverview/SharedEntitiesOverviewItem/TitleCell.jsx", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwODozODo0MVrOHAscYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwODozODo0MVrOHAscYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ5MDIwOQ==", "bodyText": "We might need this in the future. So I would advise to to move this to the GRN lib and call it getRouteFromGRN(grn: GRN) what do you think? And does the id not already contain the type?", "url": "https://github.com/Graylog2/graylog2-server/pull/8774#discussion_r470490209", "createdAt": "2020-08-14T08:38:41Z", "author": {"login": "kmerz"}, "path": "graylog2-web-interface/src/components/permissions/SharedEntitiesOverview/SharedEntitiesOverviewItem/TitleCell.jsx", "diffHunk": "@@ -0,0 +1,40 @@\n+// @flow strict\n+import * as React from 'react';\n+import { Link } from 'react-router';\n+\n+import { getIdFromGRN } from 'logic/permissions/GRN';\n+import Routes from 'routing/Routes';\n+import SharedEntity from 'logic/permissions/SharedEntity';\n+\n+type Props = {\n+  title: $PropertyType<SharedEntity, 'title'>,\n+  type: $PropertyType<SharedEntity, 'type'>,\n+  id: $PropertyType<SharedEntity, 'id'>,\n+};\n+\n+const _getTitleLink = (id, type) => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f8d4d40733eea4b610ac0742621c341ec490e00"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0MDA5MDgxOnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/stores/permissions/EntityShareStore.js", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwODo0NDo1NFrOHAsp5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwODo0NDo1NFrOHAsp5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ5MzY3MQ==", "bodyText": "I just saw, I forgot to remove this line. If there is nothing else that needs to be adjusted, I will remove it in feature/permissions", "url": "https://github.com/Graylog2/graylog2-server/pull/8774#discussion_r470493671", "createdAt": "2020-08-14T08:44:54Z", "author": {"login": "linuspahl"}, "path": "graylog2-web-interface/src/stores/permissions/EntityShareStore.js", "diffHunk": "@@ -53,24 +52,25 @@ const EntityShareStore: EntityShareStoreType = singletonStore(\n     },\n \n     searchPaginatedUserShares(username: string, page: number, perPage: number, query: string, additionalQueries?: AdditionalQueries): Promise<PaginatedEnititySharesType> {\n-      // const url = PaginationURL(ApiRoutes.EntityShareController.userSharesPaginated(username).url, page, perPage, query, additionalQueries);\n-      // const promise = fetch('GET', qualifyUrl(url)).then((response: PaginatedUserSharesResponse) => {\n-      //   return {\n-      //     list: Immutable.List(response.entities.map((se) => SharedEntity.fromJSON(se))),\n-      //     context: {\n-      //       userCapabilities: response.context.user_capabilities,\n-      //     },\n-      //     pagination: {\n-      //       count: response.count,\n-      //       total: response.total,\n-      //       page: response.page,\n-      //       perPage: response.per_page,\n-      //       query: response.query,\n-      //     },\n-      //   };\n-      // });\n-\n-      const promise = permissionsMock.searchPaginatedEntitySharesResponse(page, perPage, query, additionalQueries);\n+      const url = PaginationURL(ApiRoutes.EntityShareController.userSharesPaginated(username).url, page, perPage, query, additionalQueries);\n+      const promise = fetch('GET', qualifyUrl(url)).then((response) => {\n+        return {\n+          list: Immutable.List(response.entities.map((se) => SharedEntity.fromJSON(se))),\n+          context: {\n+            granteeCapabilities: response.context.grantee_capabilities,\n+          },\n+          pagination: {\n+            additionalQueries: response.additional_queries,\n+            count: response.count,\n+            total: response.total,\n+            page: response.page,\n+            perPage: response.per_page,\n+            query: response.query,\n+          },\n+        };\n+      });\n+\n+      // const promise = permissionsMock.searchPaginatedEntitySharesResponse(page, perPage, query, additionalQueries);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f8d4d40733eea4b610ac0742621c341ec490e00"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk2MTE2NjkyOnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/logic/permissions/GRN.js", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwODoyMToyMFrOHDzjhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwODoyMToyMFrOHDzjhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzc1MjQ1NQ==", "bodyText": "Routes.getPluginRoute\nis what you want to use here. Otherwise it thorws an error if enterprise is not installed", "url": "https://github.com/Graylog2/graylog2-server/pull/8774#discussion_r473752455", "createdAt": "2020-08-20T08:21:20Z", "author": {"login": "kmerz"}, "path": "graylog2-web-interface/src/logic/permissions/GRN.js", "diffHunk": "@@ -1,4 +1,33 @@\n // @flow strict\n-\n // eslint-disable-next-line import/prefer-default-export\n-export const createGRN = (id: string, type: string) => `grn::::${type}:${id}`;\n+import Routes from 'routing/Routes';\n+\n+const _convertEmptyString = (value: string) => (value === '' ? undefined : value);\n+\n+export const createGRN = (type: string, id: string) => `grn::::${type}:${id}`;\n+\n+export const getValuesFromGRN = (grn: string) => {\n+  const grnValues = grn.split(':');\n+  const [resourceNameType, cluster, tenent, scope, type, id] = grnValues.map(_convertEmptyString);\n+\n+  return { resourceNameType, cluster, tenent, scope, type, id };\n+};\n+\n+export const getShowRouteFromGRN = (grn: string) => {\n+  const { id, type } = getValuesFromGRN(grn);\n+\n+  switch (type) {\n+    case 'user':\n+      return Routes.SYSTEM.USERS.show(id);\n+    case 'team':\n+      return Routes.pluginRoute('SYSTEM_TEAMS_TEAMID')(id);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb15dabaae6e1c45cad981e5aafd4f3ce00c437c"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk2MTE3MDU5OnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/logic/permissions/GRN.test.js", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwODoyMjowMlrOHDzl4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwODoyMjowMlrOHDzl4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzc1MzA1Nw==", "bodyText": "Either you mock Routes.getPluginRoute for teams or you do not test it at all.\nSince you can't ensure that enterprise plugin is checked out. Especially for open source users.", "url": "https://github.com/Graylog2/graylog2-server/pull/8774#discussion_r473753057", "createdAt": "2020-08-20T08:22:02Z", "author": {"login": "kmerz"}, "path": "graylog2-web-interface/src/logic/permissions/GRN.test.js", "diffHunk": "@@ -0,0 +1,38 @@\n+// @flow strict\n+import Routes from 'routing/Routes';\n+\n+import { createGRN, getValuesFromGRN, getShowRouteFromGRN } from './GRN';\n+\n+describe('GRN', () => {\n+  it('createGRN should generate GRN with correct format', () => {\n+    expect(createGRN('dashboard', 'dashboard-id')).toBe('grn::::dashboard:dashboard-id');\n+  });\n+\n+  it('getValuesFromGRN should extract correct values from GRN', () => {\n+    expect(getValuesFromGRN('grn::::stream:stream-id')).toStrictEqual({\n+      resourceNameType: 'grn',\n+      cluster: undefined,\n+      tenent: undefined,\n+      scope: undefined,\n+      type: 'stream',\n+      id: 'stream-id',\n+    });\n+  });\n+\n+  describe('getShowRouteFromGRN should return correct route for', () => {\n+    const createsCorrectShowEntityURL = ({ grn, entityShowURL }) => {\n+      expect(getShowRouteFromGRN(grn)).toBe(entityShowURL);\n+    };\n+\n+    it.each`\n+      type            | grn                                 | entityShowURL\n+      ${'user'}       | ${'grn::::user:user-id'}            | ${Routes.SYSTEM.USERS.show('user-id')}\n+      ${'stream'}     | ${'grn::::stream:stream-id'}        | ${Routes.stream_search('stream-id')}\n+    `('type $type with grn $grn', createsCorrectShowEntityURL);\n+\n+    // We can test the following cases after we've adjusted the pluginRoute behaviour\n+    // ${'team'}       | ${'grn::::team:team-id'}            | ${Routes.pluginRoute('SYSTEM_TEAMS_TEAMID')('team-id')}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb15dabaae6e1c45cad981e5aafd4f3ce00c437c"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk2MTE3MzM3OnYy", "diffSide": "RIGHT", "path": "graylog2-web-interface/src/logic/permissions/GRN.test.js", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwODoyMjozNFrOHDznxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwODoyMjozNFrOHDznxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzc1MzU0MA==", "bodyText": "\"Routes.pluginRoute('DASHBOARDS_VIEWID')('dashboard-id')\"\nI would not do that ;)", "url": "https://github.com/Graylog2/graylog2-server/pull/8774#discussion_r473753540", "createdAt": "2020-08-20T08:22:34Z", "author": {"login": "kmerz"}, "path": "graylog2-web-interface/src/logic/permissions/GRN.test.js", "diffHunk": "@@ -0,0 +1,38 @@\n+// @flow strict\n+import Routes from 'routing/Routes';\n+\n+import { createGRN, getValuesFromGRN, getShowRouteFromGRN } from './GRN';\n+\n+describe('GRN', () => {\n+  it('createGRN should generate GRN with correct format', () => {\n+    expect(createGRN('dashboard', 'dashboard-id')).toBe('grn::::dashboard:dashboard-id');\n+  });\n+\n+  it('getValuesFromGRN should extract correct values from GRN', () => {\n+    expect(getValuesFromGRN('grn::::stream:stream-id')).toStrictEqual({\n+      resourceNameType: 'grn',\n+      cluster: undefined,\n+      tenent: undefined,\n+      scope: undefined,\n+      type: 'stream',\n+      id: 'stream-id',\n+    });\n+  });\n+\n+  describe('getShowRouteFromGRN should return correct route for', () => {\n+    const createsCorrectShowEntityURL = ({ grn, entityShowURL }) => {\n+      expect(getShowRouteFromGRN(grn)).toBe(entityShowURL);\n+    };\n+\n+    it.each`\n+      type            | grn                                 | entityShowURL\n+      ${'user'}       | ${'grn::::user:user-id'}            | ${Routes.SYSTEM.USERS.show('user-id')}\n+      ${'stream'}     | ${'grn::::stream:stream-id'}        | ${Routes.stream_search('stream-id')}\n+    `('type $type with grn $grn', createsCorrectShowEntityURL);\n+\n+    // We can test the following cases after we've adjusted the pluginRoute behaviour\n+    // ${'team'}       | ${'grn::::team:team-id'}            | ${Routes.pluginRoute('SYSTEM_TEAMS_TEAMID')('team-id')}\n+    // ${'dashboard'}  | ${'grn::::dashboard:dashboard-id'}  | ${Routes.pluginRoute('DASHBOARDS_VIEWID')('dashboard-id')}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb15dabaae6e1c45cad981e5aafd4f3ce00c437c"}, "originalPosition": 35}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4015, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}