{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxMTQyMDcx", "number": 7725, "title": "Extract IndexLookup from ElasticsearchBackend", "bodyText": "Previously the lookup of indices for streams and time range was done\nin ElasticsearchBackend by loading indices, streams, and then finding\nmatches. It was impossible to reuse this logic elsewhere.\nFurthermore this made ElasticsearchBackend harder to test, because\na lot of setup was required to make sure that proper index ranges and\nstreams are loaded during the test.\nThe corresponding change in the enterprise plugin can be found here: https://github.com/Graylog2/graylog-plugin-enterprise/pull/1498\nNote that the Jenkins builds for both PRs will be red, because of this dependency. Both PRs should be merged at the same time.\nDescription\n\nExtracts that logic into a separate class IndexLookup\nSimplifies tests for ElasticsearchBackend accordingly\nAdds tests for IndexLookup\n\nMotivation and Context\n\nreuse the index lookup logic for #7709\nimprove testability of ElasticsearchBackend\n\nHow Has This Been Tested?\nLocal unit and integration tests\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Refactoring (non-breaking change)\n Breaking change (fix or feature that would cause existing functionality to change)", "createdAt": "2020-03-19T17:35:12Z", "url": "https://github.com/Graylog2/graylog2-server/pull/7725", "merged": true, "mergeCommit": {"oid": "d7665100e7c7abc13fd54c8417d394d8bcf7cf52"}, "closed": true, "closedAt": "2020-03-20T09:20:40Z", "author": {"login": "alex-konn"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPPUs4AH2gAyMzkxMTQyMDcxOjU0ODhkMTc0MjgzNjU2Zjg2OTRiYjlhYWJmMmY4YzFmMWEyYzgzZjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPc9cWAFqTM3ODMyNjEzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5488d174283656f8694bb9aabf2f8c1f1a2c83f8", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/5488d174283656f8694bb9aabf2f8c1f1a2c83f8", "committedDate": "2020-03-19T17:26:08Z", "message": "Extract IndexLookup from ElasticsearchBackend\n\nPreviously the lookup of indices for streams and time range was done\nin ElasticsearchBackend by loading indices, streams, and then finding\nmatches. It was impossible to reuse this logic elsewhere.\nFurthermore this made ElasticsearchBackend harder to test, because\na lot of setup was required to make sure that proper inddex ranges and\nstreams are loaded during the test.\n\nThis commit:\n- Extracts that logic into a separate class `IndexLookup`\n- Simplifies tests for ElasticsearchBackend accordingly\n- Adds tests for `IndexLookup`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4MzExMzY1", "url": "https://github.com/Graylog2/graylog2-server/pull/7725#pullrequestreview-378311365", "createdAt": "2020-03-20T08:54:29Z", "commit": {"oid": "5488d174283656f8694bb9aabf2f8c1f1a2c83f8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwODo1NDoyOVrOF5LoWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwODo1NDoyOVrOF5LoWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUwMzcwNA==", "bodyText": "just a nitpick, but wouldn't it be more readable if the private function comes after the test?", "url": "https://github.com/Graylog2/graylog2-server/pull/7725#discussion_r395503704", "createdAt": "2020-03-20T08:54:29Z", "author": {"login": "kmerz"}, "path": "graylog2-server/src/test/java/org/graylog/plugins/views/search/elasticsearch/IndexLookupTest.java", "diffHunk": "@@ -0,0 +1,140 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.plugins.views.search.elasticsearch;\n+\n+import org.graylog2.indexer.ranges.IndexRange;\n+import org.graylog2.indexer.ranges.IndexRangeService;\n+import org.graylog2.plugin.database.Persisted;\n+import org.graylog2.plugin.indexer.searches.timeranges.InvalidRangeParametersException;\n+import org.graylog2.plugin.indexer.searches.timeranges.RelativeRange;\n+import org.graylog2.plugin.streams.Stream;\n+import org.graylog2.streams.StreamService;\n+import org.joda.time.DateTime;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Comparator;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.SortedSet;\n+import java.util.TreeSet;\n+import java.util.stream.Collectors;\n+\n+import static java.util.Collections.emptySet;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.RETURNS_DEEP_STUBS;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+class IndexLookupTest {\n+\n+    private IndexRangeService indexRangeService;\n+    private StreamService streamService;\n+    private IndexLookup sut;\n+\n+    @BeforeEach\n+    void setUp() {\n+        indexRangeService = mock(IndexRangeService.class);\n+        streamService = mock(StreamService.class);\n+        sut = new IndexLookup(indexRangeService, streamService);\n+    }\n+\n+    @Test\n+    void findsIndicesBelongingToStreamsInTimeRange() {\n+\n+        Set<String> streamIds = mockStreams(\"s-1\", \"s-2\");\n+\n+        List<IndexRange> indexRanges = mockSomeIndexRanges();\n+\n+        IndexRange matchingIndexRange = indexRanges.get(0);\n+\n+        sut.indexRangeContainsOneOfStreams = (i, s) -> i.equals(matchingIndexRange);\n+\n+        Set<String> result = sut.indexNamesForStreamsInTimeRange(streamIds, someTimeRange());\n+\n+        assertThat(result).containsExactly(matchingIndexRange.indexName());\n+    }\n+\n+    private RelativeRange someTimeRange() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5488d174283656f8694bb9aabf2f8c1f1a2c83f8"}, "originalPosition": 75}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbb176334500984619d80b75dc4bb7ea404bb83d", "author": {"user": {"login": "alex-konn", "name": "Alex Konn"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/cbb176334500984619d80b75dc4bb7ea404bb83d", "committedDate": "2020-03-20T09:02:16Z", "message": "Moved private mehod in test after test methods"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4MzI2MTMy", "url": "https://github.com/Graylog2/graylog2-server/pull/7725#pullrequestreview-378326132", "createdAt": "2020-03-20T09:19:24Z", "commit": {"oid": "cbb176334500984619d80b75dc4bb7ea404bb83d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2604, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}