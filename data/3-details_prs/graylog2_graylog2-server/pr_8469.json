{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzMzg4NTc5", "number": 8469, "title": "Reuse `Messages#bulkIndex` for event indexing.", "bodyText": "Description\n\nMotivation and Context\n\n\nNote: Requires #8451 to be merged before.\nThis change was targeted to reimplement the EventIndexAdapter for ES7.  It was noticed early on that the event indexing code did not implement retrying on IOExceptions or for read-only indices/cluster blocks yet, also it does not handle indexing errors as well as the regular bulk indexing code does. The reason for its existence was a different preparation of event timestamps compared to indexing regular messages.\nInstead of reimplementing the event indexing code, this change does now target at reusing the existing bulk indexing code by implementing a Indexable interface that both Message and Event are supposed to implement/extend. It collects all required methods to index a message or event. This allows us to reuse Messages#bulkIndex(*) for both indexing cases, making retrying and error handling logic consistent.\nHow Has This Been Tested?\n\n\n\nScreenshots (if appropriate):\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Refactoring (non-breaking change)\n Breaking change (fix or feature that would cause existing functionality to change)\n\nChecklist:\n\n\n\n My code follows the code style of this project.\n My change requires a change to the documentation.\n I have updated the documentation accordingly.\n I have read the CONTRIBUTING document.\n I have added tests to cover my changes.", "createdAt": "2020-07-02T09:18:32Z", "url": "https://github.com/Graylog2/graylog2-server/pull/8469", "merged": true, "mergeCommit": {"oid": "35e06e2573ee08a72f391f68d6959bdfd285018d"}, "closed": true, "closedAt": "2020-07-14T10:57:57Z", "author": {"login": "dennisoelkers"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyP46TABqjM1MTU1NTQwMzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc0z5KEAFqTQ0ODAwMTk3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4959007b35fde16a69a0e79d0bb6126cc83f6b6c", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/4959007b35fde16a69a0e79d0bb6126cc83f6b6c", "committedDate": "2020-07-02T09:21:13Z", "message": "Removing `EventIndexerAdapter` interface."}, "afterCommit": {"oid": "05936d9b80e3bc0065fb885556ca42927347b091", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/05936d9b80e3bc0065fb885556ca42927347b091", "committedDate": "2020-07-06T11:52:54Z", "message": "Removing `EventIndexerAdapter` interface."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "05936d9b80e3bc0065fb885556ca42927347b091", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/05936d9b80e3bc0065fb885556ca42927347b091", "committedDate": "2020-07-06T11:52:54Z", "message": "Removing `EventIndexerAdapter` interface."}, "afterCommit": {"oid": "4a2b9727e9943238763e51a655c406f7ac4c5adf", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/4a2b9727e9943238763e51a655c406f7ac4c5adf", "committedDate": "2020-07-08T09:02:40Z", "message": "Removing `EventIndexerAdapter` interface."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4a2b9727e9943238763e51a655c406f7ac4c5adf", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/4a2b9727e9943238763e51a655c406f7ac4c5adf", "committedDate": "2020-07-08T09:02:40Z", "message": "Removing `EventIndexerAdapter` interface."}, "afterCommit": {"oid": "827d91fce817a1c76fac2066ed5f450a0d15ced9", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/827d91fce817a1c76fac2066ed5f450a0d15ced9", "committedDate": "2020-07-08T13:41:55Z", "message": "Removing `EventIndexerAdapter` interface."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "827d91fce817a1c76fac2066ed5f450a0d15ced9", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/827d91fce817a1c76fac2066ed5f450a0d15ced9", "committedDate": "2020-07-08T13:41:55Z", "message": "Removing `EventIndexerAdapter` interface."}, "afterCommit": {"oid": "d660fc8ca9686284f19f614c57f053e5aef8256e", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/d660fc8ca9686284f19f614c57f053e5aef8256e", "committedDate": "2020-07-08T15:04:04Z", "message": "Removing `EventIndexerAdapter` interface."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d660fc8ca9686284f19f614c57f053e5aef8256e", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/d660fc8ca9686284f19f614c57f053e5aef8256e", "committedDate": "2020-07-08T15:04:04Z", "message": "Removing `EventIndexerAdapter` interface."}, "afterCommit": {"oid": "d45a61c62a00670bc774ac403d430dec35e2fff7", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/d45a61c62a00670bc774ac403d430dec35e2fff7", "committedDate": "2020-07-09T07:59:08Z", "message": "Removing `EventIndexerAdapter` interface."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d45a61c62a00670bc774ac403d430dec35e2fff7", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/d45a61c62a00670bc774ac403d430dec35e2fff7", "committedDate": "2020-07-09T07:59:08Z", "message": "Removing `EventIndexerAdapter` interface."}, "afterCommit": {"oid": "5ac6d85a080536fc5b8d03c0e709f8490308008f", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/5ac6d85a080536fc5b8d03c0e709f8490308008f", "committedDate": "2020-07-09T08:12:56Z", "message": "Removing `EventIndexerAdapter` interface."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5ac6d85a080536fc5b8d03c0e709f8490308008f", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/5ac6d85a080536fc5b8d03c0e709f8490308008f", "committedDate": "2020-07-09T08:12:56Z", "message": "Removing `EventIndexerAdapter` interface."}, "afterCommit": {"oid": "6f2072f65cf7df27f1f7b29761daf2621fd413fe", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/6f2072f65cf7df27f1f7b29761daf2621fd413fe", "committedDate": "2020-07-09T10:59:10Z", "message": "Removing `EventIndexerAdapter` interface."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NzUxMDEw", "url": "https://github.com/Graylog2/graylog2-server/pull/8469#pullrequestreview-445751010", "createdAt": "2020-07-09T15:53:08Z", "commit": {"oid": "6f2072f65cf7df27f1f7b29761daf2621fd413fe"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNTo1MzowOFrOGvXcVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNTo1Nzo0M1rOGvXoMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjMyMDM0Mg==", "bodyText": "Passing ObjectMapper here is certainly not ideal, because it becomes part of the Indexable interface although it's only needed for this implementation, but I don't have a straightforward alternative and am certainly fine with improving the mapping in a later PR.", "url": "https://github.com/Graylog2/graylog2-server/pull/8469#discussion_r452320342", "createdAt": "2020-07-09T15:53:08Z", "author": {"login": "alex-konn"}, "path": "graylog2-server/src/main/java/org/graylog/events/event/EventImpl.java", "diffHunk": "@@ -272,6 +290,29 @@ public EventDto toDto() {\n                 .build();\n     }\n \n+    @Override\n+    public Map<String, Object> toElasticSearchObject(ObjectMapper objectMapper, @Nonnull Meter invalidTimestampMeter) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f2072f65cf7df27f1f7b29761daf2621fd413fe"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjMyMzM3OA==", "bodyText": "The method should be renamed to indexSetsForStreams", "url": "https://github.com/Graylog2/graylog2-server/pull/8469#discussion_r452323378", "createdAt": "2020-07-09T15:57:43Z", "author": {"login": "alex-konn"}, "path": "graylog2-server/src/main/java/org/graylog/events/indices/EventIndexer.java", "diffHunk": "@@ -56,19 +59,20 @@ public void write(List<EventWithContext> eventsWithContext) {\n \n         // Pre-load all write index targets of all events to avoid looking them up for every event when building the bulk request\n         final Set<String> streamIds = streamIdsForEvents(eventsWithContext);\n-        final Map<String, String> streamIndices = indexAliasesForStreams(streamIds);\n-        final List<Map.Entry<String, Event>> requests = eventsWithContext.stream()\n+        final Map<String, IndexSet> streamIndices = indexAliasesForStreams(streamIds);\n+        final List<IndexingRequest> requests = eventsWithContext.stream()\n                 .map(EventWithContext::event)\n                 // Collect a set of indices for the event to avoid writing to the same index set twice if\n                 // multiple streams use the same index set.\n                 .flatMap(event -> assignEventsToTargetIndices(event, streamIndices))\n+                .map(event -> IndexingRequest.create(event.getKey(), event.getValue()))\n                 .collect(Collectors.toList());\n-        eventIndexerAdapter.write(requests);\n+        messages.bulkIndexRequests(requests, true);\n     }\n \n-    private Map<String, String> indexAliasesForStreams(Set<String> streamIds) {\n+    private Map<String, IndexSet> indexAliasesForStreams(Set<String> streamIds) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f2072f65cf7df27f1f7b29761daf2621fd413fe"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f418a5be39eaf83882ea66c5cc0953b742918c3f", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/f418a5be39eaf83882ea66c5cc0953b742918c3f", "committedDate": "2020-07-13T13:20:29Z", "message": "Reuse `Messages#bulkIndex` for event indexing.\n\nThis change was targeted to reimplement the `EventIndexAdapter` for ES7.  It was noticed early on that the event indexing code did not implement retrying on IOExceptions or for read-only indices/cluster blocks yet, also it does not handle indexing errors as well as the regular bulk indexing code does. The reason for its existence was a different preparation of event timestamps compared to indexing regular messages.\n\nInstead of reimplementing the event indexing code, this change does now target at reusing the existing bulk indexing code by implementing a `Indexable` interface that both `Message` and `Event` are supposed to implement/extend. It collects all required methods to index a message or event. This allows us to reuse `Messages#bulkIndex(*)` for both indexing cases, making retrying and error handling logic consistent."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eeb866388ec25a0d7fabff572e4dd7be72768c89", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/eeb866388ec25a0d7fabff572e4dd7be72768c89", "committedDate": "2020-07-13T13:20:29Z", "message": "Removing `EventIndexerAdapter` interface."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c488f5a3d3e41c63815a38a1dd2c609b55e0cb5", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/7c488f5a3d3e41c63815a38a1dd2c609b55e0cb5", "committedDate": "2020-07-13T13:21:23Z", "message": "Renaming method for precision."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6f2072f65cf7df27f1f7b29761daf2621fd413fe", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/6f2072f65cf7df27f1f7b29761daf2621fd413fe", "committedDate": "2020-07-09T10:59:10Z", "message": "Removing `EventIndexerAdapter` interface."}, "afterCommit": {"oid": "7c488f5a3d3e41c63815a38a1dd2c609b55e0cb5", "author": {"user": {"login": "dennisoelkers", "name": "Dennis Oelkers"}}, "url": "https://github.com/Graylog2/graylog2-server/commit/7c488f5a3d3e41c63815a38a1dd2c609b55e0cb5", "committedDate": "2020-07-13T13:21:23Z", "message": "Renaming method for precision."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4MDAxOTcw", "url": "https://github.com/Graylog2/graylog2-server/pull/8469#pullrequestreview-448001970", "createdAt": "2020-07-14T10:57:44Z", "commit": {"oid": "7c488f5a3d3e41c63815a38a1dd2c609b55e0cb5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2949, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}