{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1MzIxNDEy", "number": 3283, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwNzo0OToyNlrOFDVbbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwNzo1NjoxM1rOFDVlfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5MDQxMTM1OnYy", "diffSide": "RIGHT", "path": "drools-model/drools-model-compiler/src/test/java/org/drools/modelcompiler/MvelDialectTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwNzo0OToyNlrOIC7t0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwNzo0OToyNlrOIC7t0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk0NjQ0OQ==", "bodyText": "Neither this test nor the one above are using the Person and Address objects in a strongly typed way inside the consequence, e.g. printing p.getName() instead of p. Also it would be better to put that string into a global and asserting on its content after the firing instead of just printing it out.", "url": "https://github.com/kiegroup/drools/pull/3283#discussion_r539946449", "createdAt": "2020-12-10T07:49:26Z", "author": {"login": "mariofusco"}, "path": "drools-model/drools-model-compiler/src/test/java/org/drools/modelcompiler/MvelDialectTest.java", "diffHunk": "@@ -479,4 +481,65 @@ public void testSetOnInteger() throws Exception {\n         assertEquals(1, ksession.fireAllRules());\n         assertEquals(50000, (int) john.getSalary());\n     }\n+\n+    @Test\n+    public void testCollectSubtypeInConsequence() {\n+        // DROOLS-5887\n+        String drl =\n+                \"import \" + Person.class.getCanonicalName() + \"\\n\" +\n+                \"import \" + ArrayList.class.getCanonicalName() + \"\\n\" +\n+                \"dialect \\\"mvel\\\"\\n\" +\n+                \"rule \\\"bus1\\\"\\n\" +\n+                \"when\\n\" +\n+                \"    $people : ArrayList() from collect ( Person() )\\n\" +\n+                \"then\\n\" +\n+                \"    for (Person p : $people ) {\\n\" +\n+                \"        System.out.println(\\\"Person: \\\" + p);\\n\" +\n+                \"    }\\n\" +\n+                \"end\";\n+\n+        KieSession ksession = getKieSession(drl);\n+\n+        Person mario = new Person(\"Mario\", 46);\n+        Person luca = new Person(\"Luca\", 36);\n+        Person leonardo = new Person(\"Leonardo\", 3);\n+\n+        Arrays.asList(mario, luca, leonardo).forEach(ksession::insert);\n+\n+        assertEquals(1, ksession.fireAllRules());\n+    }\n+\n+    @Test\n+    public void testCollectSubtypeInConsequenceNested() {\n+        // DROOLS-5887\n+        String drl =\n+                \"import \" + Person.class.getCanonicalName() + \"\\n\" +\n+                \"import \" + Address.class.getCanonicalName() + \"\\n\" +\n+                \"import \" + ArrayList.class.getCanonicalName() + \"\\n\" +\n+                \"dialect \\\"mvel\\\"\\n\" +\n+                \"rule \\\"bus1\\\"\\n\" +\n+                \"when\\n\" +\n+                \"    $people : ArrayList() from collect ( Person() )\\n\" +\n+                \"    $addresses : ArrayList() from collect ( Address() )\\n\" +\n+                \"then\\n\" +\n+                \"    for (Person p : $people ) {\\n\" +\n+                \"       for (Address a : $addresses ) {\\n\" +\n+                \"           System.out.println(\\\"Person: \\\" + p + \\\" address: \\\" + a);\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c6ba9f2c237549893928b5eb4ce530ab2d0c5d2"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5MDQzNzA4OnYy", "diffSide": "RIGHT", "path": "drools-model/drools-mvel-parser/src/main/java/org/drools/mvel/parser/ast/visitor/DrlCloneVisitor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwNzo1NjoxM1rOIC78DQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwODowMToyNVrOIC8H3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk1MDA5Mw==", "bodyText": "Sorry, I don't get what this class is for. Also I don't see where this is used, can you please clarify?", "url": "https://github.com/kiegroup/drools/pull/3283#discussion_r539950093", "createdAt": "2020-12-10T07:56:13Z", "author": {"login": "mariofusco"}, "path": "drools-model/drools-mvel-parser/src/main/java/org/drools/mvel/parser/ast/visitor/DrlCloneVisitor.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.drools.mvel.parser.ast.visitor;\n+\n+import com.github.javaparser.ast.visitor.CloneVisitor;\n+import com.github.javaparser.ast.visitor.Visitable;\n+import org.drools.mvel.parser.ast.expr.BigDecimalLiteralExpr;\n+import org.drools.mvel.parser.ast.expr.BigIntegerLiteralExpr;\n+import org.drools.mvel.parser.ast.expr.DrlNameExpr;\n+import org.drools.mvel.parser.ast.expr.DrlxExpression;\n+import org.drools.mvel.parser.ast.expr.HalfBinaryExpr;\n+import org.drools.mvel.parser.ast.expr.HalfPointFreeExpr;\n+import org.drools.mvel.parser.ast.expr.InlineCastExpr;\n+import org.drools.mvel.parser.ast.expr.MapCreationLiteralExpression;\n+import org.drools.mvel.parser.ast.expr.MapCreationLiteralExpressionKeyValuePair;\n+import org.drools.mvel.parser.ast.expr.ModifyStatement;\n+import org.drools.mvel.parser.ast.expr.NullSafeFieldAccessExpr;\n+import org.drools.mvel.parser.ast.expr.NullSafeMethodCallExpr;\n+import org.drools.mvel.parser.ast.expr.OOPathChunk;\n+import org.drools.mvel.parser.ast.expr.OOPathExpr;\n+import org.drools.mvel.parser.ast.expr.PointFreeExpr;\n+import org.drools.mvel.parser.ast.expr.RuleBody;\n+import org.drools.mvel.parser.ast.expr.RuleConsequence;\n+import org.drools.mvel.parser.ast.expr.RuleDeclaration;\n+import org.drools.mvel.parser.ast.expr.RulePattern;\n+import org.drools.mvel.parser.ast.expr.TemporalLiteralChunkExpr;\n+import org.drools.mvel.parser.ast.expr.TemporalLiteralExpr;\n+import org.drools.mvel.parser.ast.expr.TemporalLiteralInfiniteChunkExpr;\n+import org.drools.mvel.parser.ast.expr.WithStatement;\n+\n+/**\n+ * Should be used instead of .clone() when cloning DRL AST\n+ * drlExpr.accept(new DrlCloneVisitor(), null);\n+ */\n+public class DrlCloneVisitor extends CloneVisitor implements DrlGenericVisitor<Visitable, Object> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c6ba9f2c237549893928b5eb4ce530ab2d0c5d2"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk1MzExNw==", "bodyText": "You're right it was used in a first draft of the implementation but then I decided not to use it anymo\ufffdre.\nStill it took me so much time to get the types right that I wanted to include it in anyway as it will be useful in the future.", "url": "https://github.com/kiegroup/drools/pull/3283#discussion_r539953117", "createdAt": "2020-12-10T08:01:25Z", "author": {"login": "lucamolteni"}, "path": "drools-model/drools-mvel-parser/src/main/java/org/drools/mvel/parser/ast/visitor/DrlCloneVisitor.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.drools.mvel.parser.ast.visitor;\n+\n+import com.github.javaparser.ast.visitor.CloneVisitor;\n+import com.github.javaparser.ast.visitor.Visitable;\n+import org.drools.mvel.parser.ast.expr.BigDecimalLiteralExpr;\n+import org.drools.mvel.parser.ast.expr.BigIntegerLiteralExpr;\n+import org.drools.mvel.parser.ast.expr.DrlNameExpr;\n+import org.drools.mvel.parser.ast.expr.DrlxExpression;\n+import org.drools.mvel.parser.ast.expr.HalfBinaryExpr;\n+import org.drools.mvel.parser.ast.expr.HalfPointFreeExpr;\n+import org.drools.mvel.parser.ast.expr.InlineCastExpr;\n+import org.drools.mvel.parser.ast.expr.MapCreationLiteralExpression;\n+import org.drools.mvel.parser.ast.expr.MapCreationLiteralExpressionKeyValuePair;\n+import org.drools.mvel.parser.ast.expr.ModifyStatement;\n+import org.drools.mvel.parser.ast.expr.NullSafeFieldAccessExpr;\n+import org.drools.mvel.parser.ast.expr.NullSafeMethodCallExpr;\n+import org.drools.mvel.parser.ast.expr.OOPathChunk;\n+import org.drools.mvel.parser.ast.expr.OOPathExpr;\n+import org.drools.mvel.parser.ast.expr.PointFreeExpr;\n+import org.drools.mvel.parser.ast.expr.RuleBody;\n+import org.drools.mvel.parser.ast.expr.RuleConsequence;\n+import org.drools.mvel.parser.ast.expr.RuleDeclaration;\n+import org.drools.mvel.parser.ast.expr.RulePattern;\n+import org.drools.mvel.parser.ast.expr.TemporalLiteralChunkExpr;\n+import org.drools.mvel.parser.ast.expr.TemporalLiteralExpr;\n+import org.drools.mvel.parser.ast.expr.TemporalLiteralInfiniteChunkExpr;\n+import org.drools.mvel.parser.ast.expr.WithStatement;\n+\n+/**\n+ * Should be used instead of .clone() when cloning DRL AST\n+ * drlExpr.accept(new DrlCloneVisitor(), null);\n+ */\n+public class DrlCloneVisitor extends CloneVisitor implements DrlGenericVisitor<Visitable, Object> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk1MDA5Mw=="}, "originalCommit": {"oid": "6c6ba9f2c237549893928b5eb4ce530ab2d0c5d2"}, "originalPosition": 49}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2218, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}