{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyNjkyNTYy", "number": 3280, "title": "DROOLS-5879 Optional newline handling in MVEL parser", "bodyText": "https://issues.redhat.com/browse/DROOLS-5762\nThis is an alternative IMO cleaner version of #3275.\nInstead of a new lexer state, we take inspiration for this antlr JavaScript grammar\nThe change is even more minimal that the other PR, plus it makes IMO cleaner the grammar, by getting rid of EOL().\n\nit makes all whitespace, including new lines, SPECIAL_TOKENs -- so they are processed by the lexer, but not emitted directly to the parser\nit introduces a new rule in the parser EOS() -- End Of Statement\nEOS() is either a semicolon or EOF or a semantic lookahead (i.e. a predicate)\nin the semantic lookahead -- if semicolons are optional -- we look for either:\n(1) a newline on the \"special\" channel before the next token;\n(2) a closing brace '}';\n(3) an identifier (this is probably a special case)\n(4) if it's a with or modify statement, a comma may also terminate the statement\n\n(4) uses a minor hack which assumes that modify and with cannot nest; i.e. I am using a boolean when we descend into a with or modify statement (I think the grammar may still allow for nesting but I think that probably we can safely disallow it).\nFinally, a flag is exposed in MvelParser via a boolean field. We may consider forking ParserConfiguration and add it there (currently we are reusing the same class in JavaParser's library, so that can't be customized).\nenabling the special behavior is as easy as setting the flag with mvelParser.setOptionalSemicolon(false) (see the test)\nwe may consider flipping the default (i.e. default to nonsignificant whitespace) but I wanted to keep the change minimal for now.", "createdAt": "2020-12-04T17:56:56Z", "url": "https://github.com/kiegroup/drools/pull/3280", "merged": true, "mergeCommit": {"oid": "e37605f2b77b0714ea3018684eef85934ba2e5de"}, "closed": true, "closedAt": "2020-12-17T07:59:42Z", "author": {"login": "evacchi"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdigJKlAH2gAyNTMyNjkyNTYyOmJjMjMwNjM5ZTY0NGEwNTcwMWMyNTg1NjBlMzE0YTJiNWVmOTJhMTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmYpgggH2gAyNTMyNjkyNTYyOjQ0NDdjZjlhNGE2NzgxMGQ0OTYzNDFjNmRkZGUxMjVkYTFjMWFmOWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bc230639e644a05701c258560e314a2b5ef92a12", "author": {"user": {"login": "evacchi", "name": "Edoardo Vacchi"}}, "url": "https://github.com/kiegroup/drools/commit/bc230639e644a05701c258560e314a2b5ef92a12", "committedDate": "2020-12-03T09:57:38Z", "message": "DROOLS-5879 Optional newline handling in MVEL parser"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1add45b6120a86b77a2cecd8eeefcddefd06e7c3", "author": {"user": {"login": "evacchi", "name": "Edoardo Vacchi"}}, "url": "https://github.com/kiegroup/drools/commit/1add45b6120a86b77a2cecd8eeefcddefd06e7c3", "committedDate": "2020-12-04T13:55:35Z", "message": "Enable operator+newline test, use overloaded constructor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e78433fd5c36202b7884aee88a037fd9f4d5203", "author": {"user": {"login": "evacchi", "name": "Edoardo Vacchi"}}, "url": "https://github.com/kiegroup/drools/commit/6e78433fd5c36202b7884aee88a037fd9f4d5203", "committedDate": "2020-12-04T16:31:20Z", "message": "wip"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1def6bdeed3b833f301bc9f2105dd377a57ff66a", "author": {"user": {"login": "evacchi", "name": "Edoardo Vacchi"}}, "url": "https://github.com/kiegroup/drools/commit/1def6bdeed3b833f301bc9f2105dd377a57ff66a", "committedDate": "2020-12-04T17:03:16Z", "message": "alternative approach"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "159cd106662417f812896c90aa5463a4fbec2d09", "author": {"user": {"login": "evacchi", "name": "Edoardo Vacchi"}}, "url": "https://github.com/kiegroup/drools/commit/159cd106662417f812896c90aa5463a4fbec2d09", "committedDate": "2020-12-04T17:56:00Z", "message": "fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4a4179b43e6d8c08984c324741462fc50630991", "author": {"user": {"login": "evacchi", "name": "Edoardo Vacchi"}}, "url": "https://github.com/kiegroup/drools/commit/f4a4179b43e6d8c08984c324741462fc50630991", "committedDate": "2020-12-04T17:58:45Z", "message": "empty statements collapse to one statement for some reason"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8e3e84feec3293137edecd7febff63e4fcad442", "author": {"user": {"login": "evacchi", "name": "Edoardo Vacchi"}}, "url": "https://github.com/kiegroup/drools/commit/e8e3e84feec3293137edecd7febff63e4fcad442", "committedDate": "2020-12-04T18:27:52Z", "message": "fix all other cases"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MjA1NDky", "url": "https://github.com/kiegroup/drools/pull/3280#pullrequestreview-545205492", "createdAt": "2020-12-04T18:37:53Z", "commit": {"oid": "e8e3e84feec3293137edecd7febff63e4fcad442"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxODozNzo1NFrOH_dKgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxODozNzo1NFrOH_dKgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwMDE2Mw==", "bodyText": "I updated this test because I don't think this parses in a regular java grammar. Field/variable accesses are not statements and this was failing IIRC", "url": "https://github.com/kiegroup/drools/pull/3280#discussion_r536300163", "createdAt": "2020-12-04T18:37:54Z", "author": {"login": "evacchi"}, "path": "drools-model/drools-mvel-parser/src/test/java/org/drools/mvel/parser/DroolsMvelParserTest.java", "diffHunk": "@@ -716,14 +722,14 @@ public void testWithConstructor() {\n     @Test\n     public void testWithoutSemicolon() {\n         String expr = \"{             \" +\n-                        \"a\" + newLine() +\n-                        \"b\" + newLine() +\n+                        \"a()\" + newLine() +\n+                        \"b()\" + newLine() +\n                         \"}\";\n \n         BlockStmt expression = MvelParser.parseBlock(expr);\n         assertEquals(\"{\" + newLine() +\n-                             \"    a;\" + newLine() +\n-                             \"    b;\" + newLine() +\n+                             \"    a();\" + newLine() +\n+                             \"    b();\" + newLine() +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8e3e84feec3293137edecd7febff63e4fcad442"}, "originalPosition": 74}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MjA1ODg2", "url": "https://github.com/kiegroup/drools/pull/3280#pullrequestreview-545205886", "createdAt": "2020-12-04T18:38:31Z", "commit": {"oid": "e8e3e84feec3293137edecd7febff63e4fcad442"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxODozODozMVrOH_dLxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxODozODozMVrOH_dLxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwMDQ4Ng==", "bodyText": "I removed these newlines because they are now treated as whitespace and not empty statements. I think this a good behavior.", "url": "https://github.com/kiegroup/drools/pull/3280#discussion_r536300486", "createdAt": "2020-12-04T18:38:31Z", "author": {"login": "evacchi"}, "path": "drools-model/drools-mvel-parser/src/test/java/org/drools/mvel/parser/DroolsMvelParserTest.java", "diffHunk": "@@ -815,8 +821,6 @@ public void commentsWithEmptyStatements() {\n \n         BlockStmt expression = MvelParser.parseBlock(expr);\n         assertEquals(\"{\" + newLine() +\n-                             \"    ;\" + newLine() +\n-                             \"    ;\" + newLine() +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8e3e84feec3293137edecd7febff63e4fcad442"}, "originalPosition": 83}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a5562d3dde639c8e0ad54b7900554e305cf04a0", "author": {"user": {"login": "evacchi", "name": "Edoardo Vacchi"}}, "url": "https://github.com/kiegroup/drools/commit/3a5562d3dde639c8e0ad54b7900554e305cf04a0", "committedDate": "2020-12-10T08:10:58Z", "message": "fixes, refactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxMjE4NjQy", "url": "https://github.com/kiegroup/drools/pull/3280#pullrequestreview-551218642", "createdAt": "2020-12-14T10:09:31Z", "commit": {"oid": "3a5562d3dde639c8e0ad54b7900554e305cf04a0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxMDowOTozMVrOIFJDVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxMDowOTozMVrOIFJDVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjI2MjEwMQ==", "bodyText": "Nitpick: you could make this constructor to simply call the other, passing true as 2nd argument.", "url": "https://github.com/kiegroup/drools/pull/3280#discussion_r542262101", "createdAt": "2020-12-14T10:09:31Z", "author": {"login": "mariofusco"}, "path": "drools-model/drools-mvel-parser/src/main/java/org/drools/mvel/parser/MvelParser.java", "diffHunk": "@@ -91,6 +92,13 @@ public MvelParser() {\n     public MvelParser(ParserConfiguration configuration) {\n         this.configuration = configuration;\n         configuration.getPostProcessors().clear();\n+        this.optionalSemicolon = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a5562d3dde639c8e0ad54b7900554e305cf04a0"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxMjIwMjY5", "url": "https://github.com/kiegroup/drools/pull/3280#pullrequestreview-551220269", "createdAt": "2020-12-14T10:11:29Z", "commit": {"oid": "3a5562d3dde639c8e0ad54b7900554e305cf04a0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxMzM4MzY3", "url": "https://github.com/kiegroup/drools/pull/3280#pullrequestreview-551338367", "createdAt": "2020-12-14T12:56:09Z", "commit": {"oid": "3a5562d3dde639c8e0ad54b7900554e305cf04a0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bcc094e4a1b265b0b9109bef65df09b5d747972", "author": {"user": {"login": "evacchi", "name": "Edoardo Vacchi"}}, "url": "https://github.com/kiegroup/drools/commit/6bcc094e4a1b265b0b9109bef65df09b5d747972", "committedDate": "2020-12-14T13:17:48Z", "message": "be more consistent with SEMICOLON named token usage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4447cf9a4a67810d496341c6ddde125da1c1af9d", "author": {"user": {"login": "evacchi", "name": "Edoardo Vacchi"}}, "url": "https://github.com/kiegroup/drools/commit/4447cf9a4a67810d496341c6ddde125da1c1af9d", "committedDate": "2020-12-15T11:29:25Z", "message": "use only one constructor in MvelParser"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1688, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}