{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5OTEzMDk0", "number": 2706, "title": "[DROOLS-4870] Materialize consequences using Drools", "bodyText": "This is a draft PR to share my idea. Please let me know your thoughts.\nBasically, it writes BitMask variables into the materialized LambdaConsequence as \"private final\" fields so execute() method can access them.\nIt passed all drools-model unit tests but I found that it fails with IncrementalCompilationCepTest#testIncrementalCompilationWithNewEvent in drools-test-coverage/test-compiler-integration. The failure is caused by duplication of LambdaConsequence class name during incremental compilation. I will look into it further.\nOne more point from code design aspect, I added \"List bitMaskVariables\" to MaterializedLambda. Actually, \"bitMaskVariables\" is required only by MaterializedLambdaConsequence. But if I add \"List bitMaskVariables\" to MaterializedLambdaConsequence, I would need more refactoring (e.g. MaterializedLambda.create() and ExecModelLambdaPostProcessor.extractLambdaFromMethodCall()). If you think it's worth refactoring, please let me know.\nThanks!", "createdAt": "2020-01-07T10:00:23Z", "url": "https://github.com/kiegroup/drools/pull/2706", "merged": true, "mergeCommit": {"oid": "7b6e5be6d4dcca61db16d028d5a16b855182843a"}, "closed": true, "closedAt": "2020-02-17T16:51:19Z", "author": {"login": "tkobayas"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4CfewgFqTMzOTMwNjkzMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBokx9gBqjMwMTM0MTQ4NTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MzA2OTMz", "url": "https://github.com/kiegroup/drools/pull/2706#pullrequestreview-339306933", "createdAt": "2020-01-07T15:25:06Z", "commit": {"oid": "ef99c4aa364699c1c17ffa5468ee9f57ab241177"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNToyNTowN1rOFa8qfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNToyNzo0MVrOFa8v6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgwMTIxNA==", "bodyText": "Let's not use JP types as input for the model compiler, only for output.\nThis is because in the future we'd like to emit JP code at the very end, therefore during the processing we should only use types owned by us.", "url": "https://github.com/kiegroup/drools/pull/2706#discussion_r363801214", "createdAt": "2020-01-07T15:25:07Z", "author": {"login": "lucamolteni"}, "path": "drools-model/drools-model-compiler/src/main/java/org/drools/modelcompiler/util/lambdareplace/ExecModelLambdaPostProcessor.java", "diffHunk": "@@ -114,12 +120,21 @@ private Expression lambdaInstance(ClassOrInterfaceType type) {\n     }\n \n     private void extractLambdaFromMethodCall(MethodCallExpr methodCallExpr, Supplier<MaterializedLambda> lambdaExtractor) {\n+        List<VariableDeclarator> bitMaskVariables = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef99c4aa364699c1c17ffa5468ee9f57ab241177"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgwMTQ1NA==", "bodyText": "I moved this parsing outside in the patch to avoid the instanceof", "url": "https://github.com/kiegroup/drools/pull/2706#discussion_r363801454", "createdAt": "2020-01-07T15:25:32Z", "author": {"login": "lucamolteni"}, "path": "drools-model/drools-model-compiler/src/main/java/org/drools/modelcompiler/util/lambdareplace/ExecModelLambdaPostProcessor.java", "diffHunk": "@@ -114,12 +120,21 @@ private Expression lambdaInstance(ClassOrInterfaceType type) {\n     }\n \n     private void extractLambdaFromMethodCall(MethodCallExpr methodCallExpr, Supplier<MaterializedLambda> lambdaExtractor) {\n+        List<VariableDeclarator> bitMaskVariables = new ArrayList<>();\n+        if (lambdaExtractor.get() instanceof MaterializedLambdaConsequence) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef99c4aa364699c1c17ffa5468ee9f57ab241177"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgwMTY3Mg==", "bodyText": "Superclass shouldn't be aware of implementation details of Consequences", "url": "https://github.com/kiegroup/drools/pull/2706#discussion_r363801672", "createdAt": "2020-01-07T15:25:57Z", "author": {"login": "lucamolteni"}, "path": "drools-model/drools-model-compiler/src/main/java/org/drools/modelcompiler/util/lambdareplace/MaterializedLambda.java", "diffHunk": "@@ -38,6 +39,7 @@\n abstract class MaterializedLambda {\n \n     final List<LambdaParameter> lambdaParameters = new ArrayList<>();\n+    final List<VariableDeclarator> bitMaskVariables = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef99c4aa364699c1c17ffa5468ee9f57ab241177"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgwMjEyMQ==", "bodyText": "In the refactor patch I changed a logic reconstructing the original initialization method here, to avoid depending on JP data on input.", "url": "https://github.com/kiegroup/drools/pull/2706#discussion_r363802121", "createdAt": "2020-01-07T15:26:45Z", "author": {"login": "lucamolteni"}, "path": "drools-model/drools-model-compiler/src/main/java/org/drools/modelcompiler/util/lambdareplace/MaterializedLambdaConsequence.java", "diffHunk": "@@ -65,6 +65,23 @@ void createMethodDeclaration(EnumDeclaration classDeclaration) {\n         }\n     }\n \n+    @Override\n+    protected EnumDeclaration create(CompilationUnit compilationUnit) {\n+        EnumDeclaration lambdaClass = super.create(compilationUnit);\n+\n+        boolean hasDroolsParameter = lambdaParameters.stream().anyMatch(this::isDroolsParameter);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef99c4aa364699c1c17ffa5468ee9f57ab241177"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgwMjYwMA==", "bodyText": "This test has too much Java code in text to be readable.\nIn the patch I modified the signature of the create method so that it can be tested in an easier way. Please take a look at it", "url": "https://github.com/kiegroup/drools/pull/2706#discussion_r363802600", "createdAt": "2020-01-07T15:27:41Z", "author": {"login": "lucamolteni"}, "path": "drools-model/drools-model-compiler/src/test/java/org/drools/modelcompiler/util/lambdareplace/MaterializedLambdaConsequenceTest.java", "diffHunk": "@@ -32,4 +38,188 @@ public void createConsequence() {\n         assertThat(aClass.getCompilationUnitAsString(), equalToIgnoringWhiteSpace(expectedResult));\n \n     }\n+\n+    @Test\n+    public void createConsequenceWithDrools() {\n+        String originalJavaSource = \"package defaultpkg;\\n\" +\n+                \"\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef99c4aa364699c1c17ffa5468ee9f57ab241177"}, "originalPosition": 31}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ef99c4aa364699c1c17ffa5468ee9f57ab241177", "author": {"user": {"login": "tkobayas", "name": "Toshiya Kobayashi"}}, "url": "https://github.com/kiegroup/drools/commit/ef99c4aa364699c1c17ffa5468ee9f57ab241177", "committedDate": "2020-01-07T09:36:55Z", "message": "[DROOLS-4870] Materialize consequences using Drools"}, "afterCommit": {"oid": "740f3fb479195c984023013cca022e88946c2a42", "author": {"user": {"login": "tkobayas", "name": "Toshiya Kobayashi"}}, "url": "https://github.com/kiegroup/drools/commit/740f3fb479195c984023013cca022e88946c2a42", "committedDate": "2020-01-08T08:17:20Z", "message": "[DROOLS-4870] Materialize consequences using Drools"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NzA0MjM5", "url": "https://github.com/kiegroup/drools/pull/2706#pullrequestreview-339704239", "createdAt": "2020-01-08T08:24:13Z", "commit": {"oid": "740f3fb479195c984023013cca022e88946c2a42"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQwODoyNDoxM1rOFbPdzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQwODoyNDoxM1rOFbPdzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDEwOTI2MA==", "bodyText": "Originally, it picks only one field but BitMask may take multiple fields so I changed it to a List.", "url": "https://github.com/kiegroup/drools/pull/2706#discussion_r364109260", "createdAt": "2020-01-08T08:24:13Z", "author": {"login": "tkobayas"}, "path": "drools-model/drools-model-compiler/src/main/java/org/drools/modelcompiler/util/lambdareplace/ExecModelLambdaPostProcessor.java", "diffHunk": "@@ -113,6 +124,40 @@ private Expression lambdaInstance(ClassOrInterfaceType type) {\n         return new FieldAccessExpr(new NameExpr(type.asString()), \"INSTANCE\");\n     }\n \n+    private List<MaterializedLambda.BitMaskVariable> findBitMaskFields(MethodCallExpr methodCallExpr) {\n+        List<MaterializedLambda.BitMaskVariable> bitMaskVariables = new ArrayList<>();\n+        methodCallExpr.findAncestor(MethodDeclaration.class).ifPresent(node -> {\n+\n+            List<MaterializedLambda.BitMaskVariable> collect =\n+                    node.findAll(VariableDeclarator.class)\n+                            .stream()\n+                            .filter(vd -> vd.getType().asString().equals(BitMask.class.getCanonicalName()))\n+                            .flatMap(vd -> {\n+                                ArrayList<AssignExpr> result = new ArrayList<>();\n+                                vd.findAncestor(AssignExpr.class)\n+                                        .ifPresent(result::add);\n+                                return result.stream();\n+                            })\n+                            .map(ae -> {\n+                                String maskName = ae.getTarget().asVariableDeclarationExpr().getVariables().iterator().next().getNameAsString();\n+                                MethodCallExpr maskInit = ae.getValue().asMethodCallExpr();\n+                                if(maskInit.getArguments().isEmpty()) {\n+                                    return new MaterializedLambda.AllSetButLastBitMask(maskName);\n+                                } else {\n+                                    NodeList<Expression> arguments = maskInit.getArguments();\n+                                    String domainClassMetadata = arguments.get(0).toString();\n+                                    List<String> fields = arguments.subList(1, arguments.size()).stream().map(Expression::toString).collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "740f3fb479195c984023013cca022e88946c2a42"}, "originalPosition": 67}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NzA2NDQ4", "url": "https://github.com/kiegroup/drools/pull/2706#pullrequestreview-339706448", "createdAt": "2020-01-08T08:29:08Z", "commit": {"oid": "740f3fb479195c984023013cca022e88946c2a42"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQwODoyOTowOFrOFbPknw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQwODoyOTowOFrOFbPknw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDExMTAwNw==", "bodyText": "Originally, the argument NodeWithMembers was not parameterized so i see compiler warns. It's fine to have <EnumDeclaration> here?", "url": "https://github.com/kiegroup/drools/pull/2706#discussion_r364111007", "createdAt": "2020-01-08T08:29:08Z", "author": {"login": "tkobayas"}, "path": "drools-model/drools-model-compiler/src/main/java/org/drools/modelcompiler/util/lambdareplace/MaterializedLambda.java", "diffHunk": "@@ -146,4 +154,53 @@ private EnumDeclaration create(CompilationUnit compilationUnit) {\n             this.type = type;\n         }\n     }\n+\n+    interface BitMaskVariable {\n+\n+        void generateBitMaskField(NodeWithMembers<EnumDeclaration> clazz);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "740f3fb479195c984023013cca022e88946c2a42"}, "originalPosition": 73}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "740f3fb479195c984023013cca022e88946c2a42", "author": {"user": {"login": "tkobayas", "name": "Toshiya Kobayashi"}}, "url": "https://github.com/kiegroup/drools/commit/740f3fb479195c984023013cca022e88946c2a42", "committedDate": "2020-01-08T08:17:20Z", "message": "[DROOLS-4870] Materialize consequences using Drools"}, "afterCommit": {"oid": "108e80ac13bb0d746fc8d49d29c0ef4158b116c2", "author": {"user": {"login": "tkobayas", "name": "Toshiya Kobayashi"}}, "url": "https://github.com/kiegroup/drools/commit/108e80ac13bb0d746fc8d49d29c0ef4158b116c2", "committedDate": "2020-01-08T09:34:05Z", "message": "[DROOLS-4870] Materialize consequences using Drools"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "108e80ac13bb0d746fc8d49d29c0ef4158b116c2", "author": {"user": {"login": "tkobayas", "name": "Toshiya Kobayashi"}}, "url": "https://github.com/kiegroup/drools/commit/108e80ac13bb0d746fc8d49d29c0ef4158b116c2", "committedDate": "2020-01-08T09:34:05Z", "message": "[DROOLS-4870] Materialize consequences using Drools"}, "afterCommit": {"oid": "2bda482029f733fe395a4a436b3d26b92d128519", "author": {"user": {"login": "tkobayas", "name": "Toshiya Kobayashi"}}, "url": "https://github.com/kiegroup/drools/commit/2bda482029f733fe395a4a436b3d26b92d128519", "committedDate": "2020-01-09T04:21:03Z", "message": "[DROOLS-4870] Materialize consequences using Drools"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwNDQwMzg0", "url": "https://github.com/kiegroup/drools/pull/2706#pullrequestreview-340440384", "createdAt": "2020-01-09T10:59:13Z", "commit": {"oid": "2bda482029f733fe395a4a436b3d26b92d128519"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2bda482029f733fe395a4a436b3d26b92d128519", "author": {"user": {"login": "tkobayas", "name": "Toshiya Kobayashi"}}, "url": "https://github.com/kiegroup/drools/commit/2bda482029f733fe395a4a436b3d26b92d128519", "committedDate": "2020-01-09T04:21:03Z", "message": "[DROOLS-4870] Materialize consequences using Drools"}, "afterCommit": {"oid": "d4d959b29c611d7e8aa338a667c2d55af13fb5f3", "author": {"user": {"login": "tkobayas", "name": "Toshiya Kobayashi"}}, "url": "https://github.com/kiegroup/drools/commit/d4d959b29c611d7e8aa338a667c2d55af13fb5f3", "committedDate": "2020-02-05T02:56:11Z", "message": "[DROOLS-4870] Materialize consequences using Drools"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "474b460a94c313352fe2508f2550f3221626f7d6", "author": {"user": {"login": "tkobayas", "name": "Toshiya Kobayashi"}}, "url": "https://github.com/kiegroup/drools/commit/474b460a94c313352fe2508f2550f3221626f7d6", "committedDate": "2020-02-06T09:53:08Z", "message": "[DROOLS-4870] Materialize consequences using Drools"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d4d959b29c611d7e8aa338a667c2d55af13fb5f3", "author": {"user": {"login": "tkobayas", "name": "Toshiya Kobayashi"}}, "url": "https://github.com/kiegroup/drools/commit/d4d959b29c611d7e8aa338a667c2d55af13fb5f3", "committedDate": "2020-02-05T02:56:11Z", "message": "[DROOLS-4870] Materialize consequences using Drools"}, "afterCommit": {"oid": "474b460a94c313352fe2508f2550f3221626f7d6", "author": {"user": {"login": "tkobayas", "name": "Toshiya Kobayashi"}}, "url": "https://github.com/kiegroup/drools/commit/474b460a94c313352fe2508f2550f3221626f7d6", "committedDate": "2020-02-06T09:53:08Z", "message": "[DROOLS-4870] Materialize consequences using Drools"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1639, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}