{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2NDc3OTQy", "number": 3222, "title": "[DROOLS-5799] Second accumulate produces a wrong result", "bodyText": "JIRA:\nhttps://issues.redhat.com/browse/DROOLS-5799\nDROOLS-5786 solved the NPE but the second accumulate (in AccumulateTest.testDoubleAccumulateNPE()) produces a wrong result (= 0 instead of 2). 2 points to be fixed:\n\n\nRuleNetworkEvaluator.doUpdatesReorderLeftMemory() causes wrong LeftTupleMemory size when calling TupleList.remove() for a tuple which doesn't exist in the list. (When removed, size becomes -1. Then added, size becomes 0. so the leftTuple is not evaluated in doRightInserts() : https://github.com/kiegroup/drools/blob/master/drools-core/src/main/java/org/drools/core/phreak/PhreakAccumulateNode.java#L215 )\n\n\nCreating AccumulateContext right before evaluateResultConstraints() is too late. It is used by addMatch() so it needs to be created earlier (e.g. in doLeftUpdates())\n\n\n\n\nHow to retest this PR or trigger a specific build:\n\n\n\na pull request please add comment: Jenkins retest this\n\n\na full downstream build please add comment: Jenkins run fdb\n\n\na compile downstream build please  add comment: Jenkins run cdb\n\n\na full production downstream build please add comment: Jenkins execute product fdb\n\n\nan upstream build please add comment: Jenkins run upstream", "createdAt": "2020-11-06T03:58:21Z", "url": "https://github.com/kiegroup/drools/pull/3222", "merged": true, "mergeCommit": {"oid": "eb0171c4540deef89af2755c2615843ff3fb7c59"}, "closed": true, "closedAt": "2020-11-06T09:44:27Z", "author": {"login": "tkobayas"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZusMngH2gAyNTE2NDc3OTQyOjdhNmMwMGM0YTliYzc5NWE5M2ViMjBkYzdjN2JjZjI2MmE4ZmRhYTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZzH60gFqTUyNDk2Mzg2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7a6c00c4a9bc795a93eb20dc7c7bcf262a8fdaa8", "author": {"user": {"login": "tkobayas", "name": "Toshiya Kobayashi"}}, "url": "https://github.com/kiegroup/drools/commit/7a6c00c4a9bc795a93eb20dc7c7bcf262a8fdaa8", "committedDate": "2020-11-06T03:49:15Z", "message": "[DROOLS-5799] Second accumulate produces a wrong result"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0ODY4MjY5", "url": "https://github.com/kiegroup/drools/pull/3222#pullrequestreview-524868269", "createdAt": "2020-11-06T05:36:45Z", "commit": {"oid": "7a6c00c4a9bc795a93eb20dc7c7bcf262a8fdaa8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwNTozNjo0NVrOHugweg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwNTozNjo0NVrOHugweg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUzMzI0Mg==", "bodyText": "if (leftTuple.getMemory() == ltm) {  may look more accurate but I followed the same approach as other methods in RuleNetworkEvaluator.", "url": "https://github.com/kiegroup/drools/pull/3222#discussion_r518533242", "createdAt": "2020-11-06T05:36:45Z", "author": {"login": "tkobayas"}, "path": "drools-core/src/main/java/org/drools/core/phreak/RuleNetworkEvaluator.java", "diffHunk": "@@ -804,7 +804,9 @@ public static void doUpdatesReorderLeftMemory(BetaMemory bm,\n \n         // sides must first be re-ordered, to ensure iteration integrity\n         for (LeftTuple leftTuple = srcLeftTuples.getUpdateFirst(); leftTuple != null; leftTuple = leftTuple.getStagedNext()) {\n-            ltm.remove(leftTuple);\n+            if (leftTuple.getMemory() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a6c00c4a9bc795a93eb20dc7c7bcf262a8fdaa8"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0OTEzMTA0", "url": "https://github.com/kiegroup/drools/pull/3222#pullrequestreview-524913104", "createdAt": "2020-11-06T07:36:27Z", "commit": {"oid": "7a6c00c4a9bc795a93eb20dc7c7bcf262a8fdaa8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwNzozNjoyN1rOHui-_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwNzozNjoyN1rOHui-_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU2OTcyNA==", "bodyText": "Minor: the method initAccumulateContextOnLeftTuple already sets the contextObject on the leftTuple, I believe you can remove this statement.", "url": "https://github.com/kiegroup/drools/pull/3222#discussion_r518569724", "createdAt": "2020-11-06T07:36:27Z", "author": {"login": "mariofusco"}, "path": "drools-core/src/main/java/org/drools/core/phreak/PhreakAccumulateNode.java", "diffHunk": "@@ -255,7 +252,11 @@ public void doLeftUpdates(AccumulateNode accNode,\n \n         for (LeftTuple leftTuple = srcLeftTuples.getUpdateFirst(); leftTuple != null; ) {\n             LeftTuple next = leftTuple.getStagedNext();\n-            final AccumulateContext accctx = (AccumulateContext) leftTuple.getContextObject();\n+            AccumulateContext accctx = (AccumulateContext) leftTuple.getContextObject();\n+            if (accctx == null) {\n+                accctx = initAccumulateContextOnLeftTuple( am, wm, accumulate, leftTuple );\n+                leftTuple.setContextObject(accctx);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a6c00c4a9bc795a93eb20dc7c7bcf262a8fdaa8"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a689f7d88106d208f0916f1cf03413114ab41a3a", "author": {"user": {"login": "tkobayas", "name": "Toshiya Kobayashi"}}, "url": "https://github.com/kiegroup/drools/commit/a689f7d88106d208f0916f1cf03413114ab41a3a", "committedDate": "2020-11-06T07:47:35Z", "message": "- Removed redundant set"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0OTIzNzg2", "url": "https://github.com/kiegroup/drools/pull/3222#pullrequestreview-524923786", "createdAt": "2020-11-06T07:57:03Z", "commit": {"oid": "a689f7d88106d208f0916f1cf03413114ab41a3a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0OTYzODYz", "url": "https://github.com/kiegroup/drools/pull/3222#pullrequestreview-524963863", "createdAt": "2020-11-06T08:59:09Z", "commit": {"oid": "a689f7d88106d208f0916f1cf03413114ab41a3a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1742, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}