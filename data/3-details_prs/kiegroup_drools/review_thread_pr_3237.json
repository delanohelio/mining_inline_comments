{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwMDczMjMx", "number": 3237, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNTo0Mzo1NFrOE4t2Lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMDo0NzozNVrOE5Za5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3OTA2ODYzOnYy", "diffSide": "RIGHT", "path": "drools-compiler/src/main/java/org/drools/compiler/commons/jci/compilers/NativeJavaCompiler.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNTo0Mzo1NFrOHyzbRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwOToyOTowMlrOHzvw6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzAzMzQxNQ==", "bodyText": "Does this work in Java11/Native image?", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r523033415", "createdAt": "2020-11-13T15:43:54Z", "author": {"login": "lucamolteni"}, "path": "drools-compiler/src/main/java/org/drools/compiler/commons/jci/compilers/NativeJavaCompiler.java", "diffHunk": "@@ -347,12 +357,52 @@ public boolean hasLocation(Location location) {\n                         }\n                     }\n                 }\n-                return result == null ? Collections.<JavaFileObject>emptyList() : result;\n+                return result == null ? Collections.emptyList() : result;\n             } catch (IOException e) {\n                 return Collections.emptyList();\n             }\n         }\n \n+        private List<JavaFileObject> findClassesIndexed(String packageName) {\n+            List<JavaFileObject> result = new ArrayList<JavaFileObject>();\n+            for (String className : indexedClasses.getOrDefault( packageName, Collections.emptySet() )) {\n+                String binaryName = packageName + \".\" + className;\n+                URL classUrl = classLoader.getResource(binaryName.replace('.', '/') + \".class\");\n+                if (classUrl != null) {\n+                    try {\n+                        result.add(new CustomJavaFileObject(binaryName, classUrl.toURI()));\n+                    } catch (URISyntaxException e) {\n+                        throw new RuntimeException( e );\n+                    }\n+                }\n+            }\n+            return result;\n+        }\n+\n+        private Map<String, Set<String>> indexClassesByPackage() {\n+            Map<String, Set<String>> indexedClasses = new HashMap<>();\n+            for (ClassLoader cl = classLoader; cl != null; cl = cl.getParent()) {\n+                indexClassesByPackage(indexedClasses, cl);\n+            }\n+            return indexedClasses;\n+        }\n+\n+        private void indexClassesByPackage(Map<String, Set<String>> indexedClasses, ClassLoader classLoader) {\n+            if (classLoader instanceof ProjectClassLoader || classLoader == NativeJavaCompiler.class.getClassLoader()) {\n+                return;\n+            }\n+            try {\n+                Field classesField = ClassLoader.class.getDeclaredField( \"classes\" );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13c3ba9c9deeb2080d2d0a8330ac3c146a758e5f"}, "originalPosition": 151}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAyMTk5NQ==", "bodyText": "This happens only at compile time, so I believe there shouldn't be any problem with the native image.", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524021995", "createdAt": "2020-11-16T09:29:02Z", "author": {"login": "mariofusco"}, "path": "drools-compiler/src/main/java/org/drools/compiler/commons/jci/compilers/NativeJavaCompiler.java", "diffHunk": "@@ -347,12 +357,52 @@ public boolean hasLocation(Location location) {\n                         }\n                     }\n                 }\n-                return result == null ? Collections.<JavaFileObject>emptyList() : result;\n+                return result == null ? Collections.emptyList() : result;\n             } catch (IOException e) {\n                 return Collections.emptyList();\n             }\n         }\n \n+        private List<JavaFileObject> findClassesIndexed(String packageName) {\n+            List<JavaFileObject> result = new ArrayList<JavaFileObject>();\n+            for (String className : indexedClasses.getOrDefault( packageName, Collections.emptySet() )) {\n+                String binaryName = packageName + \".\" + className;\n+                URL classUrl = classLoader.getResource(binaryName.replace('.', '/') + \".class\");\n+                if (classUrl != null) {\n+                    try {\n+                        result.add(new CustomJavaFileObject(binaryName, classUrl.toURI()));\n+                    } catch (URISyntaxException e) {\n+                        throw new RuntimeException( e );\n+                    }\n+                }\n+            }\n+            return result;\n+        }\n+\n+        private Map<String, Set<String>> indexClassesByPackage() {\n+            Map<String, Set<String>> indexedClasses = new HashMap<>();\n+            for (ClassLoader cl = classLoader; cl != null; cl = cl.getParent()) {\n+                indexClassesByPackage(indexedClasses, cl);\n+            }\n+            return indexedClasses;\n+        }\n+\n+        private void indexClassesByPackage(Map<String, Set<String>> indexedClasses, ClassLoader classLoader) {\n+            if (classLoader instanceof ProjectClassLoader || classLoader == NativeJavaCompiler.class.getClassLoader()) {\n+                return;\n+            }\n+            try {\n+                Field classesField = ClassLoader.class.getDeclaredField( \"classes\" );", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzAzMzQxNQ=="}, "originalCommit": {"oid": "13c3ba9c9deeb2080d2d0a8330ac3c146a758e5f"}, "originalPosition": 151}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NTc5MjYxOnYy", "diffSide": "RIGHT", "path": "drools-compiler/src/main/java/org/drools/compiler/commons/jci/compilers/JavaCompilerFactory.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwOTo0NToyN1rOHzw4mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwOTo0NToyN1rOHzw4mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA0MDM0Nw==", "bodyText": "It is a bit unrelated but why don't return Optional<JavaCompiler> if it can silently fail?", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524040347", "createdAt": "2020-11-16T09:45:27Z", "author": {"login": "danielezonca"}, "path": "drools-compiler/src/main/java/org/drools/compiler/commons/jci/compilers/JavaCompilerFactory.java", "diffHunk": "@@ -70,7 +52,7 @@ public JavaCompiler createCompiler(final String pHint) {\n         }\n         \n         try {\n-            return (JavaCompiler) clazz.newInstance();\n+            return (JavaCompiler) clazz.getConstructor().newInstance();\n         } catch (Throwable t) {\n             return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13c3ba9c9deeb2080d2d0a8330ac3c146a758e5f"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NTkzMjc2OnYy", "diffSide": "RIGHT", "path": "drools-compiler/src/main/java/org/drools/compiler/commons/jci/compilers/JavaCompilerFactory.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMDowNTo0N1rOHzyTWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMToxMzo1NlrOHz24hA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA2MzU3OQ==", "bodyText": "What is the differences between loadCompiler and createCompiler? Both create it so it seems to be just an overload", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524063579", "createdAt": "2020-11-16T10:05:47Z", "author": {"login": "danielezonca"}, "path": "drools-compiler/src/main/java/org/drools/compiler/commons/jci/compilers/JavaCompilerFactory.java", "diffHunk": "@@ -81,34 +63,20 @@ public JavaCompiler loadCompiler( JavaConfiguration configuration) {\n     }\n \n     public JavaCompiler loadCompiler( JavaConfiguration.CompilerType compilerType, String lngLevel ) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13c3ba9c9deeb2080d2d0a8330ac3c146a758e5f"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDEzODYyOA==", "bodyText": "createCompiler is just an internal impl, I made it private.", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524138628", "createdAt": "2020-11-16T11:13:56Z", "author": {"login": "mariofusco"}, "path": "drools-compiler/src/main/java/org/drools/compiler/commons/jci/compilers/JavaCompilerFactory.java", "diffHunk": "@@ -81,34 +63,20 @@ public JavaCompiler loadCompiler( JavaConfiguration configuration) {\n     }\n \n     public JavaCompiler loadCompiler( JavaConfiguration.CompilerType compilerType, String lngLevel ) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA2MzU3OQ=="}, "originalCommit": {"oid": "13c3ba9c9deeb2080d2d0a8330ac3c146a758e5f"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NTkzOTMzOnYy", "diffSide": "RIGHT", "path": "drools-compiler/src/main/java/org/drools/compiler/commons/jci/compilers/JavaCompilerFactory.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMDowNjo0OFrOHzyXgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxODoyNTowN1rOH0LzfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA2NDY0Mw==", "bodyText": "Why this hack?", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524064643", "createdAt": "2020-11-16T10:06:48Z", "author": {"login": "danielezonca"}, "path": "drools-compiler/src/main/java/org/drools/compiler/commons/jci/compilers/JavaCompilerFactory.java", "diffHunk": "@@ -81,34 +63,20 @@ public JavaCompiler loadCompiler( JavaConfiguration configuration) {\n     }\n \n     public JavaCompiler loadCompiler( JavaConfiguration.CompilerType compilerType, String lngLevel ) {\n-        JavaCompiler compiler;\n-        switch ( compilerType ) {\n-            case NATIVE : {\n-                compiler = createCompiler( \"native\" );\n-                if (compiler == null) {\n-                    throw new RuntimeException(\"Instance of native compiler cannot be created!\");\n-                } else {\n-                    updateSettings( compiler.createDefaultSettings(), lngLevel );\n-                }\n-                break;\n-            }\n-            case ECLIPSE :\n-            default : {\n-                compiler = createCompiler( \"eclipse\" );\n-                if (compiler == null) {\n-                    throw new RuntimeException(\"Instance of eclipse compiler cannot be created!\");\n-                } else {\n-                    updateSettings( compiler.createDefaultSettings(), lngLevel );\n-                }\n-                break;\n-            }\n+        JavaCompiler compiler = createCompiler( compilerType );\n+        if (compiler == null) {\n+            throw new RuntimeException(\"Instance of \" + compilerType + \" compiler cannot be created!\");\n+        } else {\n+            compiler.setJavaCompilerSettings( updateSettings( compiler.createDefaultSettings(), lngLevel ) );\n         }\n         return compiler;\n     }\n \n     private JavaCompilerSettings updateSettings( JavaCompilerSettings settings, String lngLevel ) {\n         settings.setTargetVersion( lngLevel );\n-        settings.setSourceVersion( lngLevel );\n+        if (lngLevel.startsWith( \"1.\" )) { // avoid in memory compilation with JPMS", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13c3ba9c9deeb2080d2d0a8330ac3c146a758e5f"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE3NTg2Mw==", "bodyText": "This is to force the native java compiler to work with a 1.8 source level (or less). If I make it run with 9+ (i.e. with JPMS) I get weird compilation errors like the following\nUNKNOWN (-1:-1) : module jdk.accessibility reads package  from both java.base and java.naming\nI spent quite a lot of time trying to figure out what's going on here but I'm clueless so far. I understand that this a ugly hack and something that I should fix asap. Also it is quite surprising that ecj seems not suffer of the same problem, but still I haven't been able yet to figure out why.", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524175863", "createdAt": "2020-11-16T11:47:54Z", "author": {"login": "mariofusco"}, "path": "drools-compiler/src/main/java/org/drools/compiler/commons/jci/compilers/JavaCompilerFactory.java", "diffHunk": "@@ -81,34 +63,20 @@ public JavaCompiler loadCompiler( JavaConfiguration configuration) {\n     }\n \n     public JavaCompiler loadCompiler( JavaConfiguration.CompilerType compilerType, String lngLevel ) {\n-        JavaCompiler compiler;\n-        switch ( compilerType ) {\n-            case NATIVE : {\n-                compiler = createCompiler( \"native\" );\n-                if (compiler == null) {\n-                    throw new RuntimeException(\"Instance of native compiler cannot be created!\");\n-                } else {\n-                    updateSettings( compiler.createDefaultSettings(), lngLevel );\n-                }\n-                break;\n-            }\n-            case ECLIPSE :\n-            default : {\n-                compiler = createCompiler( \"eclipse\" );\n-                if (compiler == null) {\n-                    throw new RuntimeException(\"Instance of eclipse compiler cannot be created!\");\n-                } else {\n-                    updateSettings( compiler.createDefaultSettings(), lngLevel );\n-                }\n-                break;\n-            }\n+        JavaCompiler compiler = createCompiler( compilerType );\n+        if (compiler == null) {\n+            throw new RuntimeException(\"Instance of \" + compilerType + \" compiler cannot be created!\");\n+        } else {\n+            compiler.setJavaCompilerSettings( updateSettings( compiler.createDefaultSettings(), lngLevel ) );\n         }\n         return compiler;\n     }\n \n     private JavaCompilerSettings updateSettings( JavaCompilerSettings settings, String lngLevel ) {\n         settings.setTargetVersion( lngLevel );\n-        settings.setSourceVersion( lngLevel );\n+        if (lngLevel.startsWith( \"1.\" )) { // avoid in memory compilation with JPMS", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA2NDY0Mw=="}, "originalCommit": {"oid": "13c3ba9c9deeb2080d2d0a8330ac3c146a758e5f"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ2NzAxOQ==", "bodyText": "Does it mean that user will not be able to use >1.8 code in DRL until this is fixed?", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524467019", "createdAt": "2020-11-16T18:01:10Z", "author": {"login": "danielezonca"}, "path": "drools-compiler/src/main/java/org/drools/compiler/commons/jci/compilers/JavaCompilerFactory.java", "diffHunk": "@@ -81,34 +63,20 @@ public JavaCompiler loadCompiler( JavaConfiguration configuration) {\n     }\n \n     public JavaCompiler loadCompiler( JavaConfiguration.CompilerType compilerType, String lngLevel ) {\n-        JavaCompiler compiler;\n-        switch ( compilerType ) {\n-            case NATIVE : {\n-                compiler = createCompiler( \"native\" );\n-                if (compiler == null) {\n-                    throw new RuntimeException(\"Instance of native compiler cannot be created!\");\n-                } else {\n-                    updateSettings( compiler.createDefaultSettings(), lngLevel );\n-                }\n-                break;\n-            }\n-            case ECLIPSE :\n-            default : {\n-                compiler = createCompiler( \"eclipse\" );\n-                if (compiler == null) {\n-                    throw new RuntimeException(\"Instance of eclipse compiler cannot be created!\");\n-                } else {\n-                    updateSettings( compiler.createDefaultSettings(), lngLevel );\n-                }\n-                break;\n-            }\n+        JavaCompiler compiler = createCompiler( compilerType );\n+        if (compiler == null) {\n+            throw new RuntimeException(\"Instance of \" + compilerType + \" compiler cannot be created!\");\n+        } else {\n+            compiler.setJavaCompilerSettings( updateSettings( compiler.createDefaultSettings(), lngLevel ) );\n         }\n         return compiler;\n     }\n \n     private JavaCompilerSettings updateSettings( JavaCompilerSettings settings, String lngLevel ) {\n         settings.setTargetVersion( lngLevel );\n-        settings.setSourceVersion( lngLevel );\n+        if (lngLevel.startsWith( \"1.\" )) { // avoid in memory compilation with JPMS", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA2NDY0Mw=="}, "originalCommit": {"oid": "13c3ba9c9deeb2080d2d0a8330ac3c146a758e5f"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ4MTQwNQ==", "bodyText": "For now yes, I will avoid this for ecj.", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524481405", "createdAt": "2020-11-16T18:25:07Z", "author": {"login": "mariofusco"}, "path": "drools-compiler/src/main/java/org/drools/compiler/commons/jci/compilers/JavaCompilerFactory.java", "diffHunk": "@@ -81,34 +63,20 @@ public JavaCompiler loadCompiler( JavaConfiguration configuration) {\n     }\n \n     public JavaCompiler loadCompiler( JavaConfiguration.CompilerType compilerType, String lngLevel ) {\n-        JavaCompiler compiler;\n-        switch ( compilerType ) {\n-            case NATIVE : {\n-                compiler = createCompiler( \"native\" );\n-                if (compiler == null) {\n-                    throw new RuntimeException(\"Instance of native compiler cannot be created!\");\n-                } else {\n-                    updateSettings( compiler.createDefaultSettings(), lngLevel );\n-                }\n-                break;\n-            }\n-            case ECLIPSE :\n-            default : {\n-                compiler = createCompiler( \"eclipse\" );\n-                if (compiler == null) {\n-                    throw new RuntimeException(\"Instance of eclipse compiler cannot be created!\");\n-                } else {\n-                    updateSettings( compiler.createDefaultSettings(), lngLevel );\n-                }\n-                break;\n-            }\n+        JavaCompiler compiler = createCompiler( compilerType );\n+        if (compiler == null) {\n+            throw new RuntimeException(\"Instance of \" + compilerType + \" compiler cannot be created!\");\n+        } else {\n+            compiler.setJavaCompilerSettings( updateSettings( compiler.createDefaultSettings(), lngLevel ) );\n         }\n         return compiler;\n     }\n \n     private JavaCompilerSettings updateSettings( JavaCompilerSettings settings, String lngLevel ) {\n         settings.setTargetVersion( lngLevel );\n-        settings.setSourceVersion( lngLevel );\n+        if (lngLevel.startsWith( \"1.\" )) { // avoid in memory compilation with JPMS", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA2NDY0Mw=="}, "originalCommit": {"oid": "13c3ba9c9deeb2080d2d0a8330ac3c146a758e5f"}, "originalPosition": 88}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NjAxMzIxOnYy", "diffSide": "RIGHT", "path": "drools-ecj/pom.xml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMDoxODowOFrOHzzIcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMTo1MzozMVrOHz5hEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA3NzE2OQ==", "bodyText": "Do you think it makes sense to keep the shading of ecj in this pom? The original problem was to avoid clashing with GWT ecj version and this could still happen. Now with the descoping I think the shading should be preserved: if you want to avoid ECJ you can while if you explicitly add this dependency having it shaded or not should be the same. Wdyt?", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524077169", "createdAt": "2020-11-16T10:18:08Z", "author": {"login": "danielezonca"}, "path": "drools-ecj/pom.xml", "diffHunk": "@@ -0,0 +1,70 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+  ~ Copyright (c) 2020. Red Hat, Inc. and/or its affiliates.\n+  ~ Licensed under the Apache License, Version 2.0 (the \"License\");\n+  ~ you may not use this file except in compliance with the License.\n+  ~\n+  ~       http://www.apache.org/licenses/LICENSE-2.0\n+  ~\n+  ~ Unless required by applicable law or agreed to in writing, software\n+  ~ distributed under the License is distributed on an \"AS IS\" BASIS,\n+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+  ~ See the License for the specific language governing permissions and\n+  ~ limitations under the License.\n+  -->\n+\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <parent>\n+        <artifactId>drools</artifactId>\n+        <groupId>org.drools</groupId>\n+        <version>7.47.0-SNAPSHOT</version>\n+    </parent>\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <name>Drools :: ECJ</name>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13c3ba9c9deeb2080d2d0a8330ac3c146a758e5f"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE4MTc3Nw==", "bodyText": "I was hoping that making ecj optional would also make that shading no longer useful, which is also one of the main reason for this descoping, see also what's reported in original ticket https://issues.redhat.com/browse/DROOLS-5780\nIn essence the best way to overcome the problem is not using ecj at all, but yes, I agree that if a user brings the drools-ecj module in and wants to use it with GWT we should do the shading anyway. Let's discuss this.", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524181777", "createdAt": "2020-11-16T11:53:31Z", "author": {"login": "mariofusco"}, "path": "drools-ecj/pom.xml", "diffHunk": "@@ -0,0 +1,70 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+  ~ Copyright (c) 2020. Red Hat, Inc. and/or its affiliates.\n+  ~ Licensed under the Apache License, Version 2.0 (the \"License\");\n+  ~ you may not use this file except in compliance with the License.\n+  ~\n+  ~       http://www.apache.org/licenses/LICENSE-2.0\n+  ~\n+  ~ Unless required by applicable law or agreed to in writing, software\n+  ~ distributed under the License is distributed on an \"AS IS\" BASIS,\n+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+  ~ See the License for the specific language governing permissions and\n+  ~ limitations under the License.\n+  -->\n+\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <parent>\n+        <artifactId>drools</artifactId>\n+        <groupId>org.drools</groupId>\n+        <version>7.47.0-SNAPSHOT</version>\n+    </parent>\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <name>Drools :: ECJ</name>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA3NzE2OQ=="}, "originalCommit": {"oid": "13c3ba9c9deeb2080d2d0a8330ac3c146a758e5f"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NjAzMTcyOnYy", "diffSide": "RIGHT", "path": "drools-ecj/pom.xml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMDoyMDo1NFrOHzzUXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMDoyMDo1NFrOHzzUXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA4MDIyMw==", "bodyText": "What about drools-engine-classic? Do we want to keep ecj in that \"bundle\"? As default?", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524080223", "createdAt": "2020-11-16T10:20:54Z", "author": {"login": "danielezonca"}, "path": "drools-ecj/pom.xml", "diffHunk": "@@ -0,0 +1,70 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+  ~ Copyright (c) 2020. Red Hat, Inc. and/or its affiliates.\n+  ~ Licensed under the Apache License, Version 2.0 (the \"License\");\n+  ~ you may not use this file except in compliance with the License.\n+  ~\n+  ~       http://www.apache.org/licenses/LICENSE-2.0\n+  ~\n+  ~ Unless required by applicable law or agreed to in writing, software\n+  ~ distributed under the License is distributed on an \"AS IS\" BASIS,\n+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+  ~ See the License for the specific language governing permissions and\n+  ~ limitations under the License.\n+  -->\n+\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <parent>\n+        <artifactId>drools</artifactId>\n+        <groupId>org.drools</groupId>\n+        <version>7.47.0-SNAPSHOT</version>\n+    </parent>\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <name>Drools :: ECJ</name>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13c3ba9c9deeb2080d2d0a8330ac3c146a758e5f"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NjA0OTUwOnYy", "diffSide": "RIGHT", "path": "drools-ecj/pom.xml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMDoyMzo0NFrOHzzgLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxODoyMzo0MlrOH0LwDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA4MzI0NA==", "bodyText": "I'm worried that now we will not test ecj anymore at all because it is not the default and it is not explicitly declared/used anywhere as far as I can see.\nDo you think it make sense to add ecj tests as parametrized junit? only some tests? the whole test suite?\nI'm not sure we want to deprecate ecj or we just want to make it optional but we want to be sure everything still works\nWe can improve with other tickets, now I would like to understand the direction", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524083244", "createdAt": "2020-11-16T10:23:44Z", "author": {"login": "danielezonca"}, "path": "drools-ecj/pom.xml", "diffHunk": "@@ -0,0 +1,70 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+  ~ Copyright (c) 2020. Red Hat, Inc. and/or its affiliates.\n+  ~ Licensed under the Apache License, Version 2.0 (the \"License\");\n+  ~ you may not use this file except in compliance with the License.\n+  ~\n+  ~       http://www.apache.org/licenses/LICENSE-2.0\n+  ~\n+  ~ Unless required by applicable law or agreed to in writing, software\n+  ~ distributed under the License is distributed on an \"AS IS\" BASIS,\n+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+  ~ See the License for the specific language governing permissions and\n+  ~ limitations under the License.\n+  -->\n+\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <parent>\n+        <artifactId>drools</artifactId>\n+        <groupId>org.drools</groupId>\n+        <version>7.47.0-SNAPSHOT</version>\n+    </parent>\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <name>Drools :: ECJ</name>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13c3ba9c9deeb2080d2d0a8330ac3c146a758e5f"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ4MDUyNw==", "bodyText": "I will add a profile to test ecj.", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524480527", "createdAt": "2020-11-16T18:23:42Z", "author": {"login": "mariofusco"}, "path": "drools-ecj/pom.xml", "diffHunk": "@@ -0,0 +1,70 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+  ~ Copyright (c) 2020. Red Hat, Inc. and/or its affiliates.\n+  ~ Licensed under the Apache License, Version 2.0 (the \"License\");\n+  ~ you may not use this file except in compliance with the License.\n+  ~\n+  ~       http://www.apache.org/licenses/LICENSE-2.0\n+  ~\n+  ~ Unless required by applicable law or agreed to in writing, software\n+  ~ distributed under the License is distributed on an \"AS IS\" BASIS,\n+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+  ~ See the License for the specific language governing permissions and\n+  ~ limitations under the License.\n+  -->\n+\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <parent>\n+        <artifactId>drools</artifactId>\n+        <groupId>org.drools</groupId>\n+        <version>7.47.0-SNAPSHOT</version>\n+    </parent>\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <name>Drools :: ECJ</name>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA4MzI0NA=="}, "originalCommit": {"oid": "13c3ba9c9deeb2080d2d0a8330ac3c146a758e5f"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NjExMDU0OnYy", "diffSide": "RIGHT", "path": "drools-compiler/src/main/java/org/drools/compiler/compiler/JavaConfiguration.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMDozMjo1NlrOHz0H-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMTozMzoxM1rOHz4LaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA5MzQzMg==", "bodyText": "We should document this behavior, personally I don't like a \"dynamic\" default based on classpath.\nIs it for backward compatibility?\nIn any case, can you please add a log.debug with the selected value to make it easier to debug?\nSomething like\nlog.debug(\"Selected compiler \" + prop + \" [drools.dialect.java.compiler:\" + this.conf.getChainedProperties().getProperty( JAVA_COMPILER_PROPERTY, null) + \", hasEclipseCompiler:\" + hasEclipseCompiler() + \"]\");", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524093432", "createdAt": "2020-11-16T10:32:56Z", "author": {"login": "danielezonca"}, "path": "drools-compiler/src/main/java/org/drools/compiler/compiler/JavaConfiguration.java", "diffHunk": "@@ -192,11 +195,10 @@ public CompilerType getCompiler() {\n      */\n     private CompilerType getDefaultCompiler() {\n         try {\n-            final String prop = this.conf.getChainedProperties().getProperty( JAVA_COMPILER_PROPERTY,\n-                                                                              \"ECLIPSE\" );\n-            if ( prop.equals( \"NATIVE\" ) ) {\n+            final String prop = this.conf.getChainedProperties().getProperty( JAVA_COMPILER_PROPERTY, hasEclipseCompiler() ? \"ECLIPSE\" : \"NATIVE\" );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13c3ba9c9deeb2080d2d0a8330ac3c146a758e5f"}, "originalPosition": 141}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE1OTg0OQ==", "bodyText": "The idea is that if you brought ecj in your classpath it is because you want to use it and then it makes it the default choice without the need of any further settings. I understand this behaviour is questionable and I'm open to discuss it.", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524159849", "createdAt": "2020-11-16T11:33:13Z", "author": {"login": "mariofusco"}, "path": "drools-compiler/src/main/java/org/drools/compiler/compiler/JavaConfiguration.java", "diffHunk": "@@ -192,11 +195,10 @@ public CompilerType getCompiler() {\n      */\n     private CompilerType getDefaultCompiler() {\n         try {\n-            final String prop = this.conf.getChainedProperties().getProperty( JAVA_COMPILER_PROPERTY,\n-                                                                              \"ECLIPSE\" );\n-            if ( prop.equals( \"NATIVE\" ) ) {\n+            final String prop = this.conf.getChainedProperties().getProperty( JAVA_COMPILER_PROPERTY, hasEclipseCompiler() ? \"ECLIPSE\" : \"NATIVE\" );", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA5MzQzMg=="}, "originalCommit": {"oid": "13c3ba9c9deeb2080d2d0a8330ac3c146a758e5f"}, "originalPosition": 141}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NjE0MTgyOnYy", "diffSide": "RIGHT", "path": "drools-compiler/src/main/java/org/drools/compiler/compiler/JavaConfiguration.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMDozNzo0OVrOHz0ctg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMDozNzo0OVrOHz0ctg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA5ODc0Mg==", "bodyText": "Is it possible to move this configuration as part of DEFAULT_JAVA_CONFIGURATION?", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524098742", "createdAt": "2020-11-16T10:37:49Z", "author": {"login": "danielezonca"}, "path": "drools-compiler/src/main/java/org/drools/compiler/compiler/JavaConfiguration.java", "diffHunk": "@@ -77,25 +79,48 @@\n     implements\n     DialectConfiguration {\n \n+    // This should be in alphabetic order to search with BinarySearch\n+    protected static final String[]  LANGUAGE_LEVELS = new String[]{\"1.5\", \"1.6\", \"1.7\", \"1.8\", \"10\", \"11\", \"12\", \"13\", \"14\", \"15\", \"9\"};\n+\n+    private static final JavaConfiguration DEFAULT_JAVA_CONFIGURATION = new JavaConfiguration(new KnowledgeBuilderConfigurationImpl(JavaConfiguration.class.getClassLoader()));\n+    private static final String DEFAULT_JAVA_VERSION = findJavaVersion(DEFAULT_JAVA_CONFIGURATION.conf.getChainedProperties());\n+\n     protected static final transient Logger logger = LoggerFactory.getLogger( JavaConfiguration.class);\n \n     public static final String JAVA_COMPILER_PROPERTY = \"drools.dialect.java.compiler\";\n     public static final String JAVA_LANG_LEVEL_PROPERTY = \"drools.dialect.java.compiler.lnglevel\";\n \n     public enum CompilerType {\n-        ECLIPSE, NATIVE\n+        ECLIPSE(\"org.drools.ecj.EclipseJavaCompiler\"),\n+        NATIVE(\"org.drools.compiler.commons.jci.compilers.NativeJavaCompiler\");\n+\n+        private final String implClassName;\n+\n+        CompilerType( String implClassName ) {\n+            this.implClassName = implClassName;\n+        }\n+\n+        public String getImplClassName() {\n+            return implClassName;\n+        }\n     }\n \n-    // This should be in alphabetic order to search with BinarySearch\n-    protected static final String[]  LANGUAGE_LEVELS = new String[]{\"1.5\", \"1.6\", \"1.7\", \"1.8\", \"10\", \"11\", \"12\", \"9\"};\n+    public static JavaCompiler createDefaultCompiler() {\n+        JavaCompiler javaCompiler = JavaCompilerFactory.INSTANCE.loadCompiler(DEFAULT_JAVA_CONFIGURATION.getCompiler(), DEFAULT_JAVA_VERSION);\n+        javaCompiler.setSourceFolder(\"src/main/java/\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13c3ba9c9deeb2080d2d0a8330ac3c146a758e5f"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NjIwNzcyOnYy", "diffSide": "RIGHT", "path": "drools-compiler/src/main/java/org/drools/compiler/commons/jci/compilers/NativeJavaCompiler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMDo0NzozNVrOHz1G6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxODozMDo0M1rOH0MBPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDEwOTU0Nw==", "bodyText": "What do you mean with \"Indexed\"?", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524109547", "createdAt": "2020-11-16T10:47:35Z", "author": {"login": "danielezonca"}, "path": "drools-compiler/src/main/java/org/drools/compiler/commons/jci/compilers/NativeJavaCompiler.java", "diffHunk": "@@ -347,12 +357,52 @@ public boolean hasLocation(Location location) {\n                         }\n                     }\n                 }\n-                return result == null ? Collections.<JavaFileObject>emptyList() : result;\n+                return result == null ? Collections.emptyList() : result;\n             } catch (IOException e) {\n                 return Collections.emptyList();\n             }\n         }\n \n+        private List<JavaFileObject> findClassesIndexed(String packageName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13c3ba9c9deeb2080d2d0a8330ac3c146a758e5f"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ4NDkyNw==", "bodyText": "What about findClassesFromPackage?", "url": "https://github.com/kiegroup/drools/pull/3237#discussion_r524484927", "createdAt": "2020-11-16T18:30:43Z", "author": {"login": "danielezonca"}, "path": "drools-compiler/src/main/java/org/drools/compiler/commons/jci/compilers/NativeJavaCompiler.java", "diffHunk": "@@ -347,12 +357,52 @@ public boolean hasLocation(Location location) {\n                         }\n                     }\n                 }\n-                return result == null ? Collections.<JavaFileObject>emptyList() : result;\n+                return result == null ? Collections.emptyList() : result;\n             } catch (IOException e) {\n                 return Collections.emptyList();\n             }\n         }\n \n+        private List<JavaFileObject> findClassesIndexed(String packageName) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDEwOTU0Nw=="}, "originalCommit": {"oid": "13c3ba9c9deeb2080d2d0a8330ac3c146a758e5f"}, "originalPosition": 122}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2276, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}