{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1MzIxNDEy", "number": 3283, "title": "[DROOLS-5887] The enhanced \"for\" (foreach) statement causes compilation error in executable models.", "bodyText": "Thank you for submitting this pull request\nJIRA: (please edit the JIRA link if it exists)\nhttps://issues.redhat.com/browse/DROOLS-5887\n\n\nHow to retest this PR or trigger a specific build:\n\n\n\na pull request please add comment: Jenkins retest this\n\n\na full downstream build please add comment: Jenkins run fdb\n\n\na compile downstream build please  add comment: Jenkins run cdb\n\n\na full production downstream build please add comment: Jenkins execute product fdb\n\n\nan upstream build please add comment: Jenkins run upstream", "createdAt": "2020-12-09T16:56:47Z", "url": "https://github.com/kiegroup/drools/pull/3283", "merged": true, "mergeCommit": {"oid": "e9be57da2755108afe96d213ba3c503cef835b1b"}, "closed": true, "closedAt": "2020-12-10T11:18:46Z", "author": {"login": "lucamolteni"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkqWRfgFqTU0ODc4MjM5MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkvdUKAFqTU0ODk3MzU0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NzgyMzkw", "url": "https://github.com/kiegroup/drools/pull/3283#pullrequestreview-548782390", "createdAt": "2020-12-10T02:58:51Z", "commit": {"oid": "6c6ba9f2c237549893928b5eb4ce530ab2d0c5d2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4OTI3MTAw", "url": "https://github.com/kiegroup/drools/pull/3283#pullrequestreview-548927100", "createdAt": "2020-12-10T07:49:26Z", "commit": {"oid": "6c6ba9f2c237549893928b5eb4ce530ab2d0c5d2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwNzo0OToyNlrOIC7t0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwNzo0OToyNlrOIC7t0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk0NjQ0OQ==", "bodyText": "Neither this test nor the one above are using the Person and Address objects in a strongly typed way inside the consequence, e.g. printing p.getName() instead of p. Also it would be better to put that string into a global and asserting on its content after the firing instead of just printing it out.", "url": "https://github.com/kiegroup/drools/pull/3283#discussion_r539946449", "createdAt": "2020-12-10T07:49:26Z", "author": {"login": "mariofusco"}, "path": "drools-model/drools-model-compiler/src/test/java/org/drools/modelcompiler/MvelDialectTest.java", "diffHunk": "@@ -479,4 +481,65 @@ public void testSetOnInteger() throws Exception {\n         assertEquals(1, ksession.fireAllRules());\n         assertEquals(50000, (int) john.getSalary());\n     }\n+\n+    @Test\n+    public void testCollectSubtypeInConsequence() {\n+        // DROOLS-5887\n+        String drl =\n+                \"import \" + Person.class.getCanonicalName() + \"\\n\" +\n+                \"import \" + ArrayList.class.getCanonicalName() + \"\\n\" +\n+                \"dialect \\\"mvel\\\"\\n\" +\n+                \"rule \\\"bus1\\\"\\n\" +\n+                \"when\\n\" +\n+                \"    $people : ArrayList() from collect ( Person() )\\n\" +\n+                \"then\\n\" +\n+                \"    for (Person p : $people ) {\\n\" +\n+                \"        System.out.println(\\\"Person: \\\" + p);\\n\" +\n+                \"    }\\n\" +\n+                \"end\";\n+\n+        KieSession ksession = getKieSession(drl);\n+\n+        Person mario = new Person(\"Mario\", 46);\n+        Person luca = new Person(\"Luca\", 36);\n+        Person leonardo = new Person(\"Leonardo\", 3);\n+\n+        Arrays.asList(mario, luca, leonardo).forEach(ksession::insert);\n+\n+        assertEquals(1, ksession.fireAllRules());\n+    }\n+\n+    @Test\n+    public void testCollectSubtypeInConsequenceNested() {\n+        // DROOLS-5887\n+        String drl =\n+                \"import \" + Person.class.getCanonicalName() + \"\\n\" +\n+                \"import \" + Address.class.getCanonicalName() + \"\\n\" +\n+                \"import \" + ArrayList.class.getCanonicalName() + \"\\n\" +\n+                \"dialect \\\"mvel\\\"\\n\" +\n+                \"rule \\\"bus1\\\"\\n\" +\n+                \"when\\n\" +\n+                \"    $people : ArrayList() from collect ( Person() )\\n\" +\n+                \"    $addresses : ArrayList() from collect ( Address() )\\n\" +\n+                \"then\\n\" +\n+                \"    for (Person p : $people ) {\\n\" +\n+                \"       for (Address a : $addresses ) {\\n\" +\n+                \"           System.out.println(\\\"Person: \\\" + p + \\\" address: \\\" + a);\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c6ba9f2c237549893928b5eb4ce530ab2d0c5d2"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4OTMxMTA3", "url": "https://github.com/kiegroup/drools/pull/3283#pullrequestreview-548931107", "createdAt": "2020-12-10T07:56:13Z", "commit": {"oid": "6c6ba9f2c237549893928b5eb4ce530ab2d0c5d2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwNzo1NjoxM1rOIC78DQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwNzo1NjoxM1rOIC78DQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk1MDA5Mw==", "bodyText": "Sorry, I don't get what this class is for. Also I don't see where this is used, can you please clarify?", "url": "https://github.com/kiegroup/drools/pull/3283#discussion_r539950093", "createdAt": "2020-12-10T07:56:13Z", "author": {"login": "mariofusco"}, "path": "drools-model/drools-mvel-parser/src/main/java/org/drools/mvel/parser/ast/visitor/DrlCloneVisitor.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.drools.mvel.parser.ast.visitor;\n+\n+import com.github.javaparser.ast.visitor.CloneVisitor;\n+import com.github.javaparser.ast.visitor.Visitable;\n+import org.drools.mvel.parser.ast.expr.BigDecimalLiteralExpr;\n+import org.drools.mvel.parser.ast.expr.BigIntegerLiteralExpr;\n+import org.drools.mvel.parser.ast.expr.DrlNameExpr;\n+import org.drools.mvel.parser.ast.expr.DrlxExpression;\n+import org.drools.mvel.parser.ast.expr.HalfBinaryExpr;\n+import org.drools.mvel.parser.ast.expr.HalfPointFreeExpr;\n+import org.drools.mvel.parser.ast.expr.InlineCastExpr;\n+import org.drools.mvel.parser.ast.expr.MapCreationLiteralExpression;\n+import org.drools.mvel.parser.ast.expr.MapCreationLiteralExpressionKeyValuePair;\n+import org.drools.mvel.parser.ast.expr.ModifyStatement;\n+import org.drools.mvel.parser.ast.expr.NullSafeFieldAccessExpr;\n+import org.drools.mvel.parser.ast.expr.NullSafeMethodCallExpr;\n+import org.drools.mvel.parser.ast.expr.OOPathChunk;\n+import org.drools.mvel.parser.ast.expr.OOPathExpr;\n+import org.drools.mvel.parser.ast.expr.PointFreeExpr;\n+import org.drools.mvel.parser.ast.expr.RuleBody;\n+import org.drools.mvel.parser.ast.expr.RuleConsequence;\n+import org.drools.mvel.parser.ast.expr.RuleDeclaration;\n+import org.drools.mvel.parser.ast.expr.RulePattern;\n+import org.drools.mvel.parser.ast.expr.TemporalLiteralChunkExpr;\n+import org.drools.mvel.parser.ast.expr.TemporalLiteralExpr;\n+import org.drools.mvel.parser.ast.expr.TemporalLiteralInfiniteChunkExpr;\n+import org.drools.mvel.parser.ast.expr.WithStatement;\n+\n+/**\n+ * Should be used instead of .clone() when cloning DRL AST\n+ * drlExpr.accept(new DrlCloneVisitor(), null);\n+ */\n+public class DrlCloneVisitor extends CloneVisitor implements DrlGenericVisitor<Visitable, Object> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c6ba9f2c237549893928b5eb4ce530ab2d0c5d2"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aaf0b98a6031bb0517de1ea9eaac6e609560ea2e", "author": {"user": {"login": "lucamolteni", "name": "Luca Molteni"}}, "url": "https://github.com/kiegroup/drools/commit/aaf0b98a6031bb0517de1ea9eaac6e609560ea2e", "committedDate": "2020-12-10T08:19:03Z", "message": "Reproducer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a71025c5f7672bb90fa7bc3c888769f11051527b", "author": {"user": {"login": "lucamolteni", "name": "Luca Molteni"}}, "url": "https://github.com/kiegroup/drools/commit/a71025c5f7672bb90fa7bc3c888769f11051527b", "committedDate": "2020-12-10T08:19:03Z", "message": "new ForEachDowncastStmtT Node"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38f1b44fe1559cd44b60b25dc86e06f68a6cc1e1", "author": {"user": {"login": "lucamolteni", "name": "Luca Molteni"}}, "url": "https://github.com/kiegroup/drools/commit/38f1b44fe1559cd44b60b25dc86e06f68a6cc1e1", "committedDate": "2020-12-10T08:19:03Z", "message": "Support basic case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48c7a84354ca6de57ddef0165e94220544bbe402", "author": {"user": {"login": "lucamolteni", "name": "Luca Molteni"}}, "url": "https://github.com/kiegroup/drools/commit/48c7a84354ca6de57ddef0165e94220544bbe402", "committedDate": "2020-12-10T08:19:03Z", "message": "Nested for reproducer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd22113984b31114d605d1f0a5bd23b2658ca981", "author": {"user": {"login": "lucamolteni", "name": "Luca Molteni"}}, "url": "https://github.com/kiegroup/drools/commit/dd22113984b31114d605d1f0a5bd23b2658ca981", "committedDate": "2020-12-10T08:19:03Z", "message": "Support MVEL compiling of nested conditions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cec8c9107c872f4d34af215d31fc1bc3dc7a973a", "author": {"user": {"login": "lucamolteni", "name": "Luca Molteni"}}, "url": "https://github.com/kiegroup/drools/commit/cec8c9107c872f4d34af215d31fc1bc3dc7a973a", "committedDate": "2020-12-10T08:19:03Z", "message": "Removed test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d02cefcf119005dc3bc56e8ba13083a04516ec87", "author": {"user": {"login": "lucamolteni", "name": "Luca Molteni"}}, "url": "https://github.com/kiegroup/drools/commit/d02cefcf119005dc3bc56e8ba13083a04516ec87", "committedDate": "2020-12-10T08:19:03Z", "message": "Copyright"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25c92d11506cfb3bfa8e2a8de9dfc1fdfce3fa8d", "author": {"user": {"login": "lucamolteni", "name": "Luca Molteni"}}, "url": "https://github.com/kiegroup/drools/commit/25c92d11506cfb3bfa8e2a8de9dfc1fdfce3fa8d", "committedDate": "2020-12-10T08:19:03Z", "message": "Use subtypes in consequence"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f64e27bf7d46cd2c7270bda941f4cfaf9d807214", "author": {"user": {"login": "lucamolteni", "name": "Luca Molteni"}}, "url": "https://github.com/kiegroup/drools/commit/f64e27bf7d46cd2c7270bda941f4cfaf9d807214", "committedDate": "2020-12-10T08:18:35Z", "message": "Use subtypes in consequence"}, "afterCommit": {"oid": "25c92d11506cfb3bfa8e2a8de9dfc1fdfce3fa8d", "author": {"user": {"login": "lucamolteni", "name": "Luca Molteni"}}, "url": "https://github.com/kiegroup/drools/commit/25c92d11506cfb3bfa8e2a8de9dfc1fdfce3fa8d", "committedDate": "2020-12-10T08:19:03Z", "message": "Use subtypes in consequence"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4OTYyNTYy", "url": "https://github.com/kiegroup/drools/pull/3283#pullrequestreview-548962562", "createdAt": "2020-12-10T08:42:32Z", "commit": {"oid": "25c92d11506cfb3bfa8e2a8de9dfc1fdfce3fa8d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4OTczNTQ3", "url": "https://github.com/kiegroup/drools/pull/3283#pullrequestreview-548973547", "createdAt": "2020-12-10T08:56:04Z", "commit": {"oid": "25c92d11506cfb3bfa8e2a8de9dfc1fdfce3fa8d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1690, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}