{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNDY4NTA1", "number": 1057, "title": "DPC-731: Basic performance test setup for /Key endpoints", "bodyText": "Fixes DPC-731\nDPC is in the process of adding a basic performance test suite.\nProposed Changes\nThis PR adds the API /Key endpoints to the performance test suite.\nChange Details\n\nPOST /Key\nGET /Key\nGET /Key/{id}\nDELETE /Key/{id}\n\nThere is a follow-up ticket to address a rare public key and signature mismatch in these tests. The tests will proceed if this occurs, and the 400 response will be in the metrics written to stdout.\nSecurity Implications\nThis contains only testing code. No security impacts.\n\n\n new software dependencies\n\n\n security controls or supporting software altered\n\n\n new data stored or transmitted\n\n\n security checklist is completed for this change\n\n\n requires more information or team discussion to evaluate security implications\n\n\n no PHI/PII is affected by this change\n\n\nAcceptance Validation\n\nFeedback Requested\nAny", "createdAt": "2020-09-21T18:03:05Z", "url": "https://github.com/CMSgov/dpc-app/pull/1057", "merged": true, "mergeCommit": {"oid": "8d2adefc7e1cc17e686790a806bd011f4da252e0"}, "closed": true, "closedAt": "2020-09-23T18:25:00Z", "author": {"login": "em1"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJ0QYzgH2gAyNDkwNDY4NTA1OmJkZjAxZmE4YWEzMTRjZGFmNWVkNzU1ZGMyOWZmZTk4ZTlkYzU5MmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLwBRVAFqTQ5NDg4NzEzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bdf01fa8aa314cdaf5ed755dc29ffe98e9dc592e", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/bdf01fa8aa314cdaf5ed755dc29ffe98e9dc592e", "committedDate": "2020-09-17T17:15:31Z", "message": "Key tests in progress"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8ba77af32885d5b8bfb5ad104ad59206ea38f81", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/d8ba77af32885d5b8bfb5ad104ad59206ea38f81", "committedDate": "2020-09-17T21:08:35Z", "message": "Response bodies from test requests; custom targeters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96e113c73d95f162a3a02b4e66d3c1a820c6968c", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/96e113c73d95f162a3a02b4e66d3c1a820c6968c", "committedDate": "2020-09-21T12:03:40Z", "message": "Rename key/sig function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01e44128e3ab70ffba968e104b851d629e3ddaec", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/01e44128e3ab70ffba968e104b851d629e3ddaec", "committedDate": "2020-09-21T18:00:53Z", "message": "Remove panic on non-200 response (errors are logged in metrics JSON)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a326d83e68da3c8a9fc64daea6c1ef3781553d00", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/a326d83e68da3c8a9fc64daea6c1ef3781553d00", "committedDate": "2020-09-21T18:28:32Z", "message": "Merge branch 'master' into emily/dpc-731-perf-test-key"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0ODUxNjU2", "url": "https://github.com/CMSgov/dpc-app/pull/1057#pullrequestreview-494851656", "createdAt": "2020-09-23T16:42:12Z", "commit": {"oid": "a326d83e68da3c8a9fc64daea6c1ef3781553d00"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNjo0MjoxM1rOHW3WjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNjo0ODoxOVrOHW3kyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzczNzYxMg==", "bodyText": "I like the nextKeyID func!", "url": "https://github.com/CMSgov/dpc-app/pull/1057#discussion_r493737612", "createdAt": "2020-09-23T16:42:13Z", "author": {"login": "dhgreene"}, "path": "dpc-testing/performance/main.go", "diffHunk": "@@ -46,6 +49,71 @@ func testMetadata() {\n \trunTest(getMetadataTarget, 5, 5)\n }\n \n+func testKeyEndpoints(accessToken string) {\n+\n+\tresps := runTestWithTargeter(fmt.Sprintf(\"POST %s/Key\", apiURL), newPOSTKeyTargeter(accessToken), 5, 5)\n+\tfor _, resp := range resps {\n+\t\tvar result Resource\n+\t\tjson.Unmarshal(resp, &result)\n+\t\tkeyIDs = append(keyIDs, result.ID)\n+\t}\n+\n+\tgetKeysTarget := vegeta.Target{\n+\t\tMethod: \"GET\",\n+\t\tURL:    fmt.Sprintf(\"%s%s\", apiURL, \"/Key\"),\n+\t\tHeader: map[string][]string{\n+\t\t\t\"Accept\":        {\"application/json\"},\n+\t\t\t\"Authorization\": {fmt.Sprintf(\"Bearer %s\", accessToken)},\n+\t\t},\n+\t}\n+\trunTest(getKeysTarget, 5, 5)\n+\n+\tgetKeyTarget := vegeta.Target{\n+\t\tMethod: \"GET\",\n+\t\tURL:    fmt.Sprintf(\"%s%s%s\", apiURL, \"/Key/\", keyIDs[0]),\n+\t\tHeader: map[string][]string{\n+\t\t\t\"Accept\":        {\"application/json\"},\n+\t\t\t\"Authorization\": {fmt.Sprintf(\"Bearer %s\", accessToken)},\n+\t\t},\n+\t}\n+\trunTest(getKeyTarget, 5, 5)\n+\n+\tdeleteKeyTargeter := newDELETEKeyTargeter(accessToken, func() string {\n+\t\tkeyID := keyIDs[0]\n+\t\tkeyIDs = keyIDs[1:]\n+\t\treturn keyID\n+\t})\n+\trunTestWithTargeter(fmt.Sprintf(\"DELETE %s/Key/{id}\", apiURL), deleteKeyTargeter, 5, 5)\n+}\n+\n+func newPOSTKeyTargeter(accessToken string) vegeta.Targeter {\n+\treturn func(t *vegeta.Target) error {\n+\t\tt.Method = \"POST\"\n+\t\tt.URL = fmt.Sprintf(\"%s/Key\", apiURL)\n+\t\tt.Header = map[string][]string{\n+\t\t\t\"Content-Type\":  {\"application/json\"},\n+\t\t\t\"Authorization\": {fmt.Sprintf(\"Bearer %s\", accessToken)},\n+\t\t}\n+\n+\t\tpubKeyStr, _, signature := generateKeyPairAndSignature()\n+\t\tbody := fmt.Sprintf(\"{ \\\"key\\\": \\\"%s\\\", \\\"signature\\\": \\\"%s\\\"}\", pubKeyStr, signature)\n+\t\tt.Body = []byte(body)\n+\n+\t\treturn nil\n+\t}\n+}\n+\n+func newDELETEKeyTargeter(accessToken string, nextKeyID func() string) vegeta.Targeter {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a326d83e68da3c8a9fc64daea6c1ef3781553d00"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc0MTI1OA==", "bodyText": "Is this change an artifact from troubleshooting the intermittent signature bug, or is it helpful in another way?", "url": "https://github.com/CMSgov/dpc-app/pull/1057#discussion_r493741258", "createdAt": "2020-09-23T16:48:19Z", "author": {"login": "dhgreene"}, "path": "dpc-testing/performance/setup.go", "diffHunk": "@@ -91,7 +91,7 @@ func getKeyPairAndSignature() (string, *rsa.PrivateKey, string) {\n \t\tcleanAndPanic(err)\n \t}\n \n-\tsignature, err := privKey.Sign(rand.Reader, snippetHash.Sum(nil), crypto.SHA256)\n+\tsignature, err := rsa.SignPKCS1v15(rand.Reader, privKey, crypto.SHA256, snippetHash.Sum(nil))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a326d83e68da3c8a9fc64daea6c1ef3781553d00"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fe221c0aaab6dfa497122c34cca5672771565fc", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/9fe221c0aaab6dfa497122c34cca5672771565fc", "committedDate": "2020-09-23T17:19:45Z", "message": "Merge branch 'master' into emily/dpc-731-perf-test-key"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0ODg3MTMy", "url": "https://github.com/CMSgov/dpc-app/pull/1057#pullrequestreview-494887132", "createdAt": "2020-09-23T17:27:14Z", "commit": {"oid": "9fe221c0aaab6dfa497122c34cca5672771565fc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 387, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}