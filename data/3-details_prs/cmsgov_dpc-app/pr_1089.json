{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0MjA1OTA1", "number": 1089, "title": "DPC 726 bypass lookback for predefined organizations", "bodyText": "Fixes DPC-726\n\nFacts\n\nCurrently in DEV, TEST, and SBX we have lookback disabled for all organizations (lookbackMonths = -1) and are able to retrieve data for our smoke test patients.\nCurrently in PROD we have lookback enabled for all organizations(lookbackMonths = 18) and this caused smoke tests to fail since there are lookback failures and operationOutcome files are generated.\n\nOriginal Solution:\nThe original intention behind DPC-725 and related tickets was to allow organizations with administrative privileges to disable lookback at a request level. Orgs with administrative privileges would pass a custom header (flag) that would be forwarded to aggregation and lookback would be disabled .\nIssues encountered during implementation:\nDPC-API does not send an export request directly to Aggregation, instead a job is added to the queu and picked up by aggregation. This would have required us to keep track of skipLookback flag for each job (new col in JOB_BATCH, or new table)\nProposed Changes\nInstead of passing flags around and adding flags to orgs we decided to simply disable lookback for pre-determined organizations.\nAggregation will have a list of lookback exempt organizations and would skip lookback completely during an export or patientEverything request.\nThis PR only covers adding the mechanism to specify exempt orgs and disable lookback, it does not cover fixing and updating the smoke-test to use this ability. No orgs will be skipped until the smoke-tests start using the 3 predetermined org UUIDs, that is covered in DPC-570\nChange Details\n\n\nIntroduced new config for aggregation (3 orgs that can skip lookback)\n\n`lookBackExemptOrgs = [\"0ab352f1-2bf1-44c4-aa7a-3004a1ffef12\",\"69c0d4d4-9c07-4fa8-9053-e10fb1608b48\",\"c7f5247b-4c41-478c-84eb-a6e801bdb145\"]\nlookbackExemptOrgs = ${?LOOK_BACK_EXEMPT_ORGS}`\n\nUpdated JobBatchProcessor to skip lookback for exempt orgs\n\nSecurity Implications\n\n\n new software dependencies\n\n\n\n security controls or supporting software altered\n\n\n\n new data stored or transmitted\n\n\n\n security checklist is completed for this change\n\n\n\n[] requires more information or team discussion to evaluate security implications\n\n\n\n no PHI/PII is affected by this change\n\n\nAcceptance Validation\n\n-No, acceptance criteria changed, need to test on dev.\n\nFeedback Requested", "createdAt": "2020-10-15T15:51:05Z", "url": "https://github.com/CMSgov/dpc-app/pull/1089", "merged": true, "mergeCommit": {"oid": "53c28378c3ff8170c3900c25ed3003ac22427f85"}, "closed": true, "closedAt": "2020-10-23T04:38:22Z", "author": {"login": "MrMorie"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdRuZTSgH2gAyNTA0MjA1OTA1OjY1OGY5NTAzMDEzMGE3ZjkzYTY2YWU1NTliNGU5OWEwNDYxMTllZTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVN4enAH2gAyNTA0MjA1OTA1OjgwOGU4OWQ1MTBhMmY5Nzk2MjY3ODZhM2YxYTQ0OTM3ZGFkNzFjZTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "658f95030130a7f93a66ae559b4e99a046119ee2", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/658f95030130a7f93a66ae559b4e99a046119ee2", "committedDate": "2020-10-12T06:57:13Z", "message": "Disabled lookback for smoketest orgs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cb52f29b686dba931633f5f5e4756407a0035df", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/0cb52f29b686dba931633f5f5e4756407a0035df", "committedDate": "2020-10-12T20:01:35Z", "message": "Fixed app configs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "154ded0543662586e2b391560dc55feb2cde77c1", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/154ded0543662586e2b391560dc55feb2cde77c1", "committedDate": "2020-10-12T20:12:08Z", "message": "Merge branch 'master' into sg/DPC-725-bypass-lookback-during-smoke-testing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NTI4MTY4", "url": "https://github.com/CMSgov/dpc-app/pull/1089#pullrequestreview-509528168", "createdAt": "2020-10-15T15:52:11Z", "commit": {"oid": "154ded0543662586e2b391560dc55feb2cde77c1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNTo1MjoxMVrOHiOpvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNTo1MjoxMVrOHiOpvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY1MzY5NA==", "bodyText": "Method runAndMonitorExportJob has 6 arguments (exceeds 4 allowed). Consider refactoring.", "url": "https://github.com/CMSgov/dpc-app/pull/1089#discussion_r505653694", "createdAt": "2020-10-15T15:52:11Z", "author": {"login": "codeclimate"}, "path": "dpc-smoketest/src/main/java/gov/cms/dpc/testing/smoketests/SmokeTest.java", "diffHunk": "@@ -221,18 +204,20 @@ public SampleResult runTest(JavaSamplerContext javaSamplerContext) {\n             patientSample.sampleEnd();\n             smokeTestResult.addSubResult(patientSample);\n         }\n+        return patientReferences;\n+    }\n \n \n-        // Upload the roster bundle\n+    private void uploadRosterBundle(JavaSamplerContext samplerContext, Bundle providerBundle, IGenericClient exportClient, Map<String,Reference> patientReferences){\n         logger.debug(\"Uploading roster\");\n         try {\n-            ClientUtils.createAndUploadRosters(javaSamplerContext.getParameter(\"seed-file\"), providerBundle, exportClient, UUID.fromString(organizationID), patientReferences);\n+            ClientUtils.createAndUploadRosters(samplerContext.getParameter(\"seed-file\"), providerBundle, exportClient, UUID.fromString(organizationID), patientReferences);\n         } catch (Exception e) {\n             throw new IllegalStateException(\"Cannot upload roster\", e);\n         }\n+    }\n \n-        // Run the job\n-        // Create a custom http client to use for monitoring the non-FHIR export request\n+    private void runAndMonitorExportJob(SampleResult smokeTestResult, String hostParam, String clientToken, Pair<UUID, PrivateKey> keyTuple, IGenericClient exportClient, List<String> providerNPIs){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "154ded0543662586e2b391560dc55feb2cde77c1"}, "originalPosition": 223}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76ec6cf32f8b91213b1b3bef9fb1f2ffe3fdec0e", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/76ec6cf32f8b91213b1b3bef9fb1f2ffe3fdec0e", "committedDate": "2020-10-15T16:08:44Z", "message": "Fixed NPE in mock blueButton Client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdb58c5d1287cd9212740929ad94dcc6fa4218e4", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/bdb58c5d1287cd9212740929ad94dcc6fa4218e4", "committedDate": "2020-10-15T17:13:48Z", "message": "Reverted smoke test changes."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMDI2NDQy", "url": "https://github.com/CMSgov/dpc-app/pull/1089#pullrequestreview-512026442", "createdAt": "2020-10-19T18:02:19Z", "commit": {"oid": "bdb58c5d1287cd9212740929ad94dcc6fa4218e4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxODowMjoyMFrOHkbQsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxODowMjoyMFrOHkbQsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk1NzQyNw==", "bodyText": "are we guaranteed to always have an org ID on the job?", "url": "https://github.com/CMSgov/dpc-app/pull/1089#discussion_r507957427", "createdAt": "2020-10-19T18:02:20Z", "author": {"login": "jonfulk"}, "path": "dpc-aggregation/src/main/java/gov/cms/dpc/aggregation/engine/JobBatchProcessor.java", "diffHunk": "@@ -59,15 +59,22 @@ public JobBatchProcessor(BlueButtonClient bbclient, FhirContext fhirContext, Met\n      * @return A list of batch files {@link JobQueueBatchFile}\n      */\n     public List<JobQueueBatchFile> processJobBatchPartial(UUID aggregatorID, IJobQueue queue, JobQueueBatch job, String patientID) {\n-        List<LookBackAnswer> answers = getAnswers(job, patientID);\n+    Flowable<Resource> flowable;\n+    if(isLookBackExempt(job.getOrgID())){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdb58c5d1287cd9212740929ad94dcc6fa4218e4"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f9c32d15f2655da00b3f42c94ae73c4c8a02e23", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/4f9c32d15f2655da00b3f42c94ae73c4c8a02e23", "committedDate": "2020-10-19T23:28:19Z", "message": "Merge branch 'master' into sg/DPC-726-bypass-lookback-during-smoke-testing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMTQwMzgz", "url": "https://github.com/CMSgov/dpc-app/pull/1089#pullrequestreview-513140383", "createdAt": "2020-10-20T21:16:30Z", "commit": {"oid": "4f9c32d15f2655da00b3f42c94ae73c4c8a02e23"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMToxNjozMFrOHlRa4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMToxNjozMFrOHlRa4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg0NDc2OQ==", "bodyText": "Just checking but aren't the UUIDs for the orgs in the smoke test generated randomly?  I might be missing where you are hard coding these values.", "url": "https://github.com/CMSgov/dpc-app/pull/1089#discussion_r508844769", "createdAt": "2020-10-20T21:16:30Z", "author": {"login": "MrBilnon"}, "path": "dpc-aggregation/src/main/resources/application.conf", "diffHunk": "@@ -29,6 +29,8 @@ dpc.aggregation {\n   # The number of months to look back for a claim\n   lookBackMonths = 18\n   lookBackMonths = ${?LOOK_BACK_MONTHS}\n+  lookBackExemptOrgs = [\"0ab352f1-2bf1-44c4-aa7a-3004a1ffef12\",\"69c0d4d4-9c07-4fa8-9053-e10fb1608b48\",\"c7f5247b-4c41-478c-84eb-a6e801bdb145\"]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f9c32d15f2655da00b3f42c94ae73c4c8a02e23"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMjk4NDA5", "url": "https://github.com/CMSgov/dpc-app/pull/1089#pullrequestreview-513298409", "createdAt": "2020-10-21T04:30:30Z", "commit": {"oid": "4f9c32d15f2655da00b3f42c94ae73c4c8a02e23"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "349d3a2301334497d1323e1ae6e5273d47ed9fa2", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/349d3a2301334497d1323e1ae6e5273d47ed9fa2", "committedDate": "2020-10-21T14:46:17Z", "message": "Merge branch 'master' into sg/DPC-726-bypass-lookback-during-smoke-testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "856cd570559a3e17ef9c9061fd221e63266047e5", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/856cd570559a3e17ef9c9061fd221e63266047e5", "committedDate": "2020-10-21T17:43:33Z", "message": "Merge branch 'master' into sg/DPC-726-bypass-lookback-during-smoke-testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "808e89d510a2f979626786a3f1a44937dad71ce3", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/808e89d510a2f979626786a3f1a44937dad71ce3", "committedDate": "2020-10-23T03:20:06Z", "message": "Merge branch 'master' into sg/DPC-726-bypass-lookback-during-smoke-testing"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 291, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}