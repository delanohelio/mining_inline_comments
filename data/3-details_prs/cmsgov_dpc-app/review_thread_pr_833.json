{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4NDUzNDYz", "number": 833, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNTo0MzoyNlrOEDAXkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNjo0MDowNFrOEDBgYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNTg3MjE2OnYy", "diffSide": "RIGHT", "path": "dpc-common/src/main/java/gov/cms/dpc/fhir/converters/entities/ConsentEntityConverter.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNTo0MzoyNlrOGfzu6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNTo0MzoyNlrOGfzu6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAwNjYzNQ==", "bodyText": "Method fromFhir has 35 lines of code (exceeds 25 allowed). Consider refactoring.", "url": "https://github.com/CMSgov/dpc-app/pull/833#discussion_r436006635", "createdAt": "2020-06-05T15:43:26Z", "author": {"login": "codeclimate"}, "path": "dpc-common/src/main/java/gov/cms/dpc/fhir/converters/entities/ConsentEntityConverter.java", "diffHunk": "@@ -70,14 +79,101 @@ private static String policyRule(String value) {\n         return code;\n     }\n \n+    private static String policyUriToCode(String uri) {\n+        if (OPT_IN_MAGIC.equals(uri)) {\n+            return OPT_IN;\n+        } else if (OPT_OUT_MAGIC.equals(uri)) {\n+            return OPT_OUT;\n+        }\n+        throw new WebApplicationException(String.format(\"Policy rule must be %s or %s.\", OPT_IN_MAGIC, OPT_OUT_MAGIC), Response.Status.BAD_REQUEST);\n+    }\n+\n     private static List<CodeableConcept> category(String loincCode) {\n         // there must code to look up the code systems used in these CodeableConcept values. What is it?\n         CodeableConcept category = new CodeableConcept();\n-        category.addCoding().setSystem(\"http://loinc.org\").setCode(loincCode).setDisplay(ConsentEntity.CATEGORY_DISPLAY);\n+        category.addCoding().setSystem(SYSTEM_LOINC).setCode(loincCode).setDisplay(ConsentEntity.CATEGORY_DISPLAY);\n         return List.of(category);\n     }\n \n-    public static Consent convert(ConsentEntity consentEntity, String orgURL, String fhirURL) {\n+    private static String categoriesToLoincCode(List<CodeableConcept> categories) {\n+        if (categories == null || categories.size() != 1) {\n+            throw new WebApplicationException(\"Must include one category\", HttpStatus.UNPROCESSABLE_ENTITY_422);\n+        }\n+\n+        CodeableConcept category = categories.get(0);\n+        List<Coding> codings = category.getCoding();\n+        if (codings == null || codings.size() != 1) {\n+            throw new WebApplicationException(\"Category must have one coding\", HttpStatus.UNPROCESSABLE_ENTITY_422);\n+        }\n+\n+        Coding coding = category.getCodingFirstRep();\n+        if (!SYSTEM_LOINC.equals(coding.getSystem()) || !CATEGORY_LOINC_CODE.equals(coding.getCode())) {\n+            throw new WebApplicationException(String.format(\"Category coding must have system %s and code %s\", SYSTEM_LOINC, CATEGORY_LOINC_CODE), HttpStatus.UNPROCESSABLE_ENTITY_422);\n+        }\n+\n+        return coding.getCode();\n+    }\n+\n+    private static UUID organizationsToCustodianUUID(List<Reference> orgRefs) {\n+        if (orgRefs == null || orgRefs.size() != 1) {\n+            throw new WebApplicationException(\"Must include one organization\", HttpStatus.UNPROCESSABLE_ENTITY_422);\n+        }\n+\n+        Reference orgRef = orgRefs.get(0);\n+        if (StringUtils.isBlank(orgRef.getReference())) {\n+            throw new WebApplicationException(\"Organization must include reference\", HttpStatus.UNPROCESSABLE_ENTITY_422);\n+        }\n+        return FHIRExtractors.getEntityUUID(orgRef.getReference());\n+    }\n+\n+    public static ConsentEntity fromFhir(Consent consent) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 88}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNjA1ODU4OnYy", "diffSide": "RIGHT", "path": "dpc-common/src/main/java/gov/cms/dpc/fhir/converters/entities/ConsentEntityConverter.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNjo0MDowNFrOGf1m1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNjo0MDowNFrOGf1m1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAzNzMzNQ==", "bodyText": "Method fromFhir has 27 lines of code (exceeds 25 allowed). Consider refactoring.", "url": "https://github.com/CMSgov/dpc-app/pull/833#discussion_r436037335", "createdAt": "2020-06-05T16:40:04Z", "author": {"login": "codeclimate"}, "path": "dpc-common/src/main/java/gov/cms/dpc/fhir/converters/entities/ConsentEntityConverter.java", "diffHunk": "@@ -70,14 +79,102 @@ private static String policyRule(String value) {\n         return code;\n     }\n \n+    private static String policyUriToCode(String uri) {\n+        if (OPT_IN_MAGIC.equals(uri)) {\n+            return OPT_IN;\n+        } else if (OPT_OUT_MAGIC.equals(uri)) {\n+            return OPT_OUT;\n+        }\n+        throw new WebApplicationException(String.format(\"Policy rule must be %s or %s.\", OPT_IN_MAGIC, OPT_OUT_MAGIC), Response.Status.BAD_REQUEST);\n+    }\n+\n     private static List<CodeableConcept> category(String loincCode) {\n         // there must code to look up the code systems used in these CodeableConcept values. What is it?\n         CodeableConcept category = new CodeableConcept();\n-        category.addCoding().setSystem(\"http://loinc.org\").setCode(loincCode).setDisplay(ConsentEntity.CATEGORY_DISPLAY);\n+        category.addCoding().setSystem(SYSTEM_LOINC).setCode(loincCode).setDisplay(ConsentEntity.CATEGORY_DISPLAY);\n         return List.of(category);\n     }\n \n-    public static Consent convert(ConsentEntity consentEntity, String orgURL, String fhirURL) {\n+    private static String categoriesToLoincCode(List<CodeableConcept> categories) {\n+        if (categories == null || categories.size() != 1) {\n+            throw new WebApplicationException(\"Must include one category\", HttpStatus.UNPROCESSABLE_ENTITY_422);\n+        }\n+\n+        CodeableConcept category = categories.get(0);\n+        List<Coding> codings = category.getCoding();\n+        if (codings == null || codings.size() != 1) {\n+            throw new WebApplicationException(\"Category must have one coding\", HttpStatus.UNPROCESSABLE_ENTITY_422);\n+        }\n+\n+        Coding coding = category.getCodingFirstRep();\n+        if (!SYSTEM_LOINC.equals(coding.getSystem()) || !CATEGORY_LOINC_CODE.equals(coding.getCode())) {\n+            throw new WebApplicationException(String.format(\"Category coding must have system %s and code %s\", SYSTEM_LOINC, CATEGORY_LOINC_CODE), HttpStatus.UNPROCESSABLE_ENTITY_422);\n+        }\n+\n+        return coding.getCode();\n+    }\n+\n+    private static UUID organizationsToCustodianUUID(List<Reference> orgRefs) {\n+        if (orgRefs == null || orgRefs.size() != 1) {\n+            throw new WebApplicationException(\"Must include one organization\", HttpStatus.UNPROCESSABLE_ENTITY_422);\n+        }\n+\n+        Reference orgRef = orgRefs.get(0);\n+        if (StringUtils.isBlank(orgRef.getReference())) {\n+            throw new WebApplicationException(\"Organization must include reference\", HttpStatus.UNPROCESSABLE_ENTITY_422);\n+        }\n+        return FHIRExtractors.getEntityUUID(orgRef.getReference());\n+    }\n+\n+    private static String mbiFromPatientReference(String patientRefStr) {\n+        String mbi = \"\";\n+        Pattern patientIdPattern = Pattern.compile(\"/Patient\\\\?identity=\\\\|(?<mbi>\\\\d[a-zA-Z][a-zA-Z0-9]\\\\d[a-zA-Z][a-zA-Z0-9]\\\\d[a-zA-Z]{2}\\\\d{2})\");\n+        Matcher matcher = patientIdPattern.matcher(patientRefStr);\n+        if (matcher.find()) {\n+            mbi = matcher.group(\"mbi\");\n+        }\n+        return mbi;\n+    }\n+\n+    public static ConsentEntity fromFhir(Consent consent) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 98}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 153, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}