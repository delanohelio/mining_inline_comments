{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2MDc3NzE0", "number": 1092, "reviewThreads": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNjowMjoyMlrOEvY7bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMjo1MTozMlrOEyVgvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4MTI2OTU5OnYy", "diffSide": "RIGHT", "path": "dpc-testing/performance/organization.go", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNjowMjoyMlrOHkWB5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNjowMjoyMlrOHkWB5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg3MTcxOA==", "bodyText": "Method orgTargeter.genReqs has a Cognitive Complexity of 17 (exceeds 9 allowed). Consider refactoring.", "url": "https://github.com/CMSgov/dpc-app/pull/1092#discussion_r507871718", "createdAt": "2020-10-19T16:02:22Z", "author": {"login": "codeclimate"}, "path": "dpc-testing/performance/organization.go", "diffHunk": "@@ -0,0 +1,150 @@\n+package main\n+\n+import (\n+\t\"encoding/json\"\n+\t\"fmt\"\n+\t\"io/ioutil\"\n+\t\"path/filepath\"\n+\n+\tvegeta \"github.com/tsenart/vegeta/lib\"\n+)\n+\n+type orgTargetConfig struct {\n+\tMethod      string\n+\tBaseURL     string\n+\tPath        string\n+\tAccessToken string\n+\tFilePattern string   // Optional file pattern location(s)\n+\tIDs         []string // Optional list of ids to append url\n+}\n+\n+type orgTargeter struct {\n+\treqs chan Req\n+\torgTargetConfig\n+}\n+\n+type Req struct {\n+\tid   *string\n+\tbody []byte\n+}\n+\n+func NewOrgTargeter(config orgTargetConfig) *orgTargeter {\n+\ttargeter := &orgTargeter{\n+\t\treqs:            make(chan Req),\n+\t\torgTargetConfig: config,\n+\t}\n+\n+\ttargeter.genReqs()\n+\n+\treturn targeter\n+}\n+\n+func (o *orgTargeter) genReqs() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7ee0d7595ebed999cbf7e98deb09b574920a743"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NzUyMjEyOnYy", "diffSide": "RIGHT", "path": "dpc-testing/performance/organization.go", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMTozMzowN1rOHlR8UQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMTozMzowN1rOHlR8UQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg1MzMyOQ==", "bodyText": "Method orgTargeter.genReqs has a Cognitive Complexity of 13 (exceeds 9 allowed). Consider refactoring.", "url": "https://github.com/CMSgov/dpc-app/pull/1092#discussion_r508853329", "createdAt": "2020-10-20T21:33:07Z", "author": {"login": "codeclimate"}, "path": "dpc-testing/performance/organization.go", "diffHunk": "@@ -0,0 +1,175 @@\n+package main\n+\n+import (\n+\t\"encoding/json\"\n+\t\"fmt\"\n+\t\"io/ioutil\"\n+\t\"path/filepath\"\n+\n+\tvegeta \"github.com/tsenart/vegeta/lib\"\n+)\n+\n+type orgTargetConfig struct {\n+\tMethod      string\n+\tBaseURL     string\n+\tPath        string\n+\tAccessToken string\n+\tFilePattern string // Optional file pattern location(s)\n+\tID          string // Optional id to append to url\n+}\n+\n+type orgTargeter struct {\n+\tbodies chan []byte // channel for generating new request bodies\n+\torgTargetConfig\n+}\n+\n+// NewOrgTargeter constructs a new orgTargeter using provided config\n+func NewOrgTargeter(config orgTargetConfig) *orgTargeter {\n+\ttargeter := &orgTargeter{\n+\t\tbodies:          make(chan []byte),\n+\t\torgTargetConfig: config,\n+\t}\n+\n+\ttargeter.genReqs()\n+\n+\treturn targeter\n+}\n+\n+// genReqs setups the go routine necessary to generate new request bodies\n+// used by the vegeta test runner\n+func (o *orgTargeter) genReqs() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aff422f5e221abf4b90b72262f6331a2b8e04137"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MDE4ODQxOnYy", "diffSide": "RIGHT", "path": "dpc-testing/performance/organization.go", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzoxMzowNVrOHlrH2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzoxMzowNVrOHlrH2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI2NTg4Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            // builtTarget is the function passed to the vegeta test runner. It expects a\n          \n          \n            \n            // buildTarget is the function passed to the vegeta test runner. It expects a", "url": "https://github.com/CMSgov/dpc-app/pull/1092#discussion_r509265883", "createdAt": "2020-10-21T13:13:05Z", "author": {"login": "em1"}, "path": "dpc-testing/performance/organization.go", "diffHunk": "@@ -0,0 +1,175 @@\n+package main\n+\n+import (\n+\t\"encoding/json\"\n+\t\"fmt\"\n+\t\"io/ioutil\"\n+\t\"path/filepath\"\n+\n+\tvegeta \"github.com/tsenart/vegeta/lib\"\n+)\n+\n+type orgTargetConfig struct {\n+\tMethod      string\n+\tBaseURL     string\n+\tPath        string\n+\tAccessToken string\n+\tFilePattern string // Optional file pattern location(s)\n+\tID          string // Optional id to append to url\n+}\n+\n+type orgTargeter struct {\n+\tbodies chan []byte // channel for generating new request bodies\n+\torgTargetConfig\n+}\n+\n+// NewOrgTargeter constructs a new orgTargeter using provided config\n+func NewOrgTargeter(config orgTargetConfig) *orgTargeter {\n+\ttargeter := &orgTargeter{\n+\t\tbodies:          make(chan []byte),\n+\t\torgTargetConfig: config,\n+\t}\n+\n+\ttargeter.genReqs()\n+\n+\treturn targeter\n+}\n+\n+// genReqs setups the go routine necessary to generate new request bodies\n+// used by the vegeta test runner\n+func (o *orgTargeter) genReqs() {\n+\tbodies := make([][]byte, 0)\n+\n+\tif o.FilePattern != \"\" {\n+\t\tfileNames, err := filepath.Glob(o.FilePattern)\n+\t\tif err != nil {\n+\t\t\tpanic(err)\n+\t\t}\n+\n+\t\tfor _, f := range fileNames {\n+\t\t\tbody, err := ioutil.ReadFile(f)\n+\t\t\tif err != nil {\n+\t\t\t\tpanic(err)\n+\t\t\t}\n+\t\t\tbodies = append(bodies, body)\n+\t\t}\n+\t}\n+\n+\t// kicks off generator to pull a new body from the request files that\n+\t// were loaded previously\n+\tgo func() {\n+\t\tfor {\n+\t\t\tfor _, body := range bodies {\n+\t\t\t\to.bodies <- body\n+\t\t\t}\n+\t\t}\n+\t}()\n+}\n+\n+// builtTarget is the function passed to the vegeta test runner. It expects a", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4dbd4a7f31d011cf96543d4e4e5472fac330134f"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MTYyMzk3OnYy", "diffSide": "RIGHT", "path": "src/main/resources/organizations/organization-1.json", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNzo0ODoyNFrOHl5aXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNzo0ODoyNFrOHl5aXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ5OTk5OQ==", "bodyText": "Will it matter now or in the future that we're reusing the same NPI for multiple orgs?  This is the same as the base org, and all the others use 2906714268.", "url": "https://github.com/CMSgov/dpc-app/pull/1092#discussion_r509499999", "createdAt": "2020-10-21T17:48:24Z", "author": {"login": "dhgreene"}, "path": "src/main/resources/organizations/organization-1.json", "diffHunk": "@@ -0,0 +1,57 @@\n+{\n+  \"resourceType\": \"Organization\",\n+  \"identifier\": [\n+    {\n+      \"system\": \"http://hl7.org/fhir/sid/us-npi\",\n+      \"value\": \"1111112110\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "accae897724256185d882beb64b51c50d3b56fce"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMDE3ODg4OnYy", "diffSide": "RIGHT", "path": "dpc-testing/performance/pkg/dpc/test_patient.go", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMToyMjowNlrOHooBKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMToyMjowNlrOHooBKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM2MDc0Nw==", "bodyText": "Similar blocks of code found in 2 locations. Consider refactoring.", "url": "https://github.com/CMSgov/dpc-app/pull/1092#discussion_r512360747", "createdAt": "2020-10-27T01:22:06Z", "author": {"login": "codeclimate"}, "path": "dpc-testing/performance/pkg/dpc/test_patient.go", "diffHunk": "@@ -0,0 +1,65 @@\n+package dpc", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e03ac4f0775d1a14af72746e8651b0ca7880c33"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMDE3ODg5OnYy", "diffSide": "RIGHT", "path": "dpc-testing/performance/pkg/dpc/test_practitioner.go", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMToyMjowN1rOHooBLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMToyMjowN1rOHooBLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM2MDc0OA==", "bodyText": "Similar blocks of code found in 2 locations. Consider refactoring.", "url": "https://github.com/CMSgov/dpc-app/pull/1092#discussion_r512360748", "createdAt": "2020-10-27T01:22:07Z", "author": {"login": "codeclimate"}, "path": "dpc-testing/performance/pkg/dpc/test_practitioner.go", "diffHunk": "@@ -0,0 +1,65 @@\n+package dpc", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e03ac4f0775d1a14af72746e8651b0ca7880c33"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMDE3ODkwOnYy", "diffSide": "RIGHT", "path": "dpc-testing/performance/pkg/dpc/test_token.go", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMToyMjowN1rOHooBLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMToyMjowN1rOHooBLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM2MDc0OQ==", "bodyText": "Method API.RunTokenTests has 51 lines of code (exceeds 50 allowed). Consider refactoring.", "url": "https://github.com/CMSgov/dpc-app/pull/1092#discussion_r512360749", "createdAt": "2020-10-27T01:22:07Z", "author": {"login": "codeclimate"}, "path": "dpc-testing/performance/pkg/dpc/test_token.go", "diffHunk": "@@ -0,0 +1,94 @@\n+package dpc\n+\n+import (\n+\t\"net/url\"\n+\n+\t\"github.com/CMSgov/dpc-app/dpc-testing/performance/pkg/dpc/targeter\"\n+\tdpcclient \"github.com/CMSgov/dpc-app/dpcclient/lib\"\n+)\n+\n+func (api *API) RunTokenTests() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e03ac4f0775d1a14af72746e8651b0ca7880c33"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMjEwODA0OnYy", "diffSide": "RIGHT", "path": "dpc-testing/performance/main.go", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMjozNjoyMFrOHo6BEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNTozNDo0NFrOHpCnTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY1NTYzNA==", "bodyText": "I think there's a risk of confusion here because the golden macaroon comes from an admin endpoint rather than an API endpoint. Maybe better in dpc or an admin package?", "url": "https://github.com/CMSgov/dpc-app/pull/1092#discussion_r512655634", "createdAt": "2020-10-27T12:36:20Z", "author": {"login": "em1"}, "path": "dpc-testing/performance/main.go", "diffHunk": "@@ -1,99 +1,27 @@\n package main\n \n import (\n-\t\"crypto/rsa\"\n-\t\"fmt\"\n-\t\"os\"\n-\t\"time\"\n+\t\"flag\"\n \n-\tdpcclient \"github.com/CMSgov/dpc-app/dpcclient/lib\"\n-\tvegeta \"github.com/tsenart/vegeta/lib\"\n+\t\"github.com/CMSgov/dpc-app/dpc-testing/performance/pkg/dpc\"\n )\n \n-var (\n-\tapiURL, adminURL string\n-\tgoldenMacaroon   []byte\n-)\n-\n-func init() {\n-\tinitFlags()\n-\tcreateDirs()\n-\tgoldenMacaroon = getClientToken(\"\")\n-}\n-\n func main() {\n-\ttestMetadata()\n-\n-\torgID := createOrg()\n-\tpubKeyStr, privateKey, signature := generateKeyPairAndSignature()\n-\tkeyID := uploadKey(pubKeyStr, signature, orgID)\n-\tclientToken := getClientToken(orgID)\n-\n-\taccessToken := refreshAccessToken(privateKey, keyID, clientToken)\n-\ttestKeyEndpoints(accessToken)\n-\n-\taccessToken = refreshAccessToken(privateKey, keyID, clientToken)\n-\ttestTokenEndpoints(accessToken, privateKey, keyID, clientToken)\n-\n-\taccessToken = refreshAccessToken(privateKey, keyID, clientToken)\n-\ttestPatientEndpoints(accessToken)\n-\n-\tcleanUp(orgID)\n-}\n-\n-func testMetadata() {\n-\tgetMetadataTarget := vegeta.Target{\n-\t\tMethod: \"GET\",\n-\t\tURL:    fmt.Sprintf(\"%s%s\", apiURL, \"/metadata\"),\n-\t\tHeader: map[string][]string{\n-\t\t\t\"Accept\": {\"application/fhir+json\"},\n-\t\t},\n-\t}\n-\n-\trunTest(getMetadataTarget, 5, 5)\n-}\n-\n-func refreshAccessToken(privateKey *rsa.PrivateKey, keyID string, clientToken []byte) string {\n-\tauthToken, err := dpcclient.GenerateAuthToken(privateKey, keyID, clientToken, apiURL)\n-\tif err != nil {\n-\t\tcleanAndPanic(err)\n-\t}\n-\n-\taccessToken, err := dpcclient.GetAccessToken(authToken, apiURL)\n-\tif err != nil {\n-\t\tcleanAndPanic(err)\n-\t}\n-\n-\treturn accessToken\n-}\n-\n-func runTest(target vegeta.Target, duration, frequency int) [][]byte {\n-\treturn runTestWithTargeter(fmt.Sprintf(\"%s %s\", target.Method, target.URL), vegeta.NewStaticTargeter(target), duration, frequency)\n-}\n-\n-func runTestWithTargeter(name string, targeter vegeta.Targeter, duration, frequency int) [][]byte {\n-\n-\tfmt.Printf(\"\\nRunning performance test on %s...\\n\", name)\n-\n-\td := time.Second * time.Duration(duration)\n-\tr := vegeta.Rate{Freq: frequency, Per: time.Second}\n-\n-\tattacker := vegeta.NewAttacker()\n-\tvar metrics vegeta.Metrics\n-\tvar respBodies [][]byte\n-\tfor results := range attacker.Attack(targeter, r, d, fmt.Sprintf(\"%dps:\", r.Freq)) {\n-\t\tmetrics.Add(results)\n-\t\trespBodies = append(respBodies, results.Body)\n-\t}\n-\tmetrics.Close()\n-\n-\treporter := vegeta.NewJSONReporter(&metrics)\n-\treporter.Report(os.Stdout)\n-\n-\treturn respBodies\n-}\n-\n-func cleanAndPanic(err error) {\n-\tcleanUp()\n-\tpanic(err)\n+\tvar api dpc.API\n+\n+\tflag.StringVar(&api.URL, \"api_url\", \"http://localhost:3002/v1\", \"Base URL of API\")\n+\tflag.StringVar(&api.AdminURL, \"admin_url\", \"http://localhost:9903/tasks\", \"Base URL of admin tasks\")\n+\tflag.Parse()\n+\n+\tapi.CreateGoldenMacaroon()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e03ac4f0775d1a14af72746e8651b0ca7880c33"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjc5NjQ5NQ==", "bodyText": "I see what you mean. I kept it that way since the GetClientToken func was pulled directly from your code and combines both calls. But I can break them out.", "url": "https://github.com/CMSgov/dpc-app/pull/1092#discussion_r512796495", "createdAt": "2020-10-27T15:34:44Z", "author": {"login": "SMLuthi"}, "path": "dpc-testing/performance/main.go", "diffHunk": "@@ -1,99 +1,27 @@\n package main\n \n import (\n-\t\"crypto/rsa\"\n-\t\"fmt\"\n-\t\"os\"\n-\t\"time\"\n+\t\"flag\"\n \n-\tdpcclient \"github.com/CMSgov/dpc-app/dpcclient/lib\"\n-\tvegeta \"github.com/tsenart/vegeta/lib\"\n+\t\"github.com/CMSgov/dpc-app/dpc-testing/performance/pkg/dpc\"\n )\n \n-var (\n-\tapiURL, adminURL string\n-\tgoldenMacaroon   []byte\n-)\n-\n-func init() {\n-\tinitFlags()\n-\tcreateDirs()\n-\tgoldenMacaroon = getClientToken(\"\")\n-}\n-\n func main() {\n-\ttestMetadata()\n-\n-\torgID := createOrg()\n-\tpubKeyStr, privateKey, signature := generateKeyPairAndSignature()\n-\tkeyID := uploadKey(pubKeyStr, signature, orgID)\n-\tclientToken := getClientToken(orgID)\n-\n-\taccessToken := refreshAccessToken(privateKey, keyID, clientToken)\n-\ttestKeyEndpoints(accessToken)\n-\n-\taccessToken = refreshAccessToken(privateKey, keyID, clientToken)\n-\ttestTokenEndpoints(accessToken, privateKey, keyID, clientToken)\n-\n-\taccessToken = refreshAccessToken(privateKey, keyID, clientToken)\n-\ttestPatientEndpoints(accessToken)\n-\n-\tcleanUp(orgID)\n-}\n-\n-func testMetadata() {\n-\tgetMetadataTarget := vegeta.Target{\n-\t\tMethod: \"GET\",\n-\t\tURL:    fmt.Sprintf(\"%s%s\", apiURL, \"/metadata\"),\n-\t\tHeader: map[string][]string{\n-\t\t\t\"Accept\": {\"application/fhir+json\"},\n-\t\t},\n-\t}\n-\n-\trunTest(getMetadataTarget, 5, 5)\n-}\n-\n-func refreshAccessToken(privateKey *rsa.PrivateKey, keyID string, clientToken []byte) string {\n-\tauthToken, err := dpcclient.GenerateAuthToken(privateKey, keyID, clientToken, apiURL)\n-\tif err != nil {\n-\t\tcleanAndPanic(err)\n-\t}\n-\n-\taccessToken, err := dpcclient.GetAccessToken(authToken, apiURL)\n-\tif err != nil {\n-\t\tcleanAndPanic(err)\n-\t}\n-\n-\treturn accessToken\n-}\n-\n-func runTest(target vegeta.Target, duration, frequency int) [][]byte {\n-\treturn runTestWithTargeter(fmt.Sprintf(\"%s %s\", target.Method, target.URL), vegeta.NewStaticTargeter(target), duration, frequency)\n-}\n-\n-func runTestWithTargeter(name string, targeter vegeta.Targeter, duration, frequency int) [][]byte {\n-\n-\tfmt.Printf(\"\\nRunning performance test on %s...\\n\", name)\n-\n-\td := time.Second * time.Duration(duration)\n-\tr := vegeta.Rate{Freq: frequency, Per: time.Second}\n-\n-\tattacker := vegeta.NewAttacker()\n-\tvar metrics vegeta.Metrics\n-\tvar respBodies [][]byte\n-\tfor results := range attacker.Attack(targeter, r, d, fmt.Sprintf(\"%dps:\", r.Freq)) {\n-\t\tmetrics.Add(results)\n-\t\trespBodies = append(respBodies, results.Body)\n-\t}\n-\tmetrics.Close()\n-\n-\treporter := vegeta.NewJSONReporter(&metrics)\n-\treporter.Report(os.Stdout)\n-\n-\treturn respBodies\n-}\n-\n-func cleanAndPanic(err error) {\n-\tcleanUp()\n-\tpanic(err)\n+\tvar api dpc.API\n+\n+\tflag.StringVar(&api.URL, \"api_url\", \"http://localhost:3002/v1\", \"Base URL of API\")\n+\tflag.StringVar(&api.AdminURL, \"admin_url\", \"http://localhost:9903/tasks\", \"Base URL of admin tasks\")\n+\tflag.Parse()\n+\n+\tapi.CreateGoldenMacaroon()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY1NTYzNA=="}, "originalCommit": {"oid": "7e03ac4f0775d1a14af72746e8651b0ca7880c33"}, "originalPosition": 107}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMjEyODUxOnYy", "diffSide": "RIGHT", "path": "dpc-testing/performance/pkg/dpc/api.go", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMjo0MTo0MVrOHo6NxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMjo0MTo0MVrOHo6NxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY1ODg4NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            func (api *API) SetupOrgAuth(orgIDs ...string) orgAuth {\n          \n          \n            \n            func (api *API) SetUpOrgAuth(orgIDs ...string) orgAuth {", "url": "https://github.com/CMSgov/dpc-app/pull/1092#discussion_r512658884", "createdAt": "2020-10-27T12:41:41Z", "author": {"login": "em1"}, "path": "dpc-testing/performance/pkg/dpc/api.go", "diffHunk": "@@ -121,34 +121,42 @@ func uploadKey(key, sig, orgID string) string {\n \treturn result.ID\n }\n \n-func cleanUp(orgIDs ...string) {\n-\tfor _, orgID := range orgIDs {\n-\t\tdeleteOrg(orgID)\n-\t}\n-\tdeleteDirs()\n-}\n-\n-func deleteOrg(orgID string) {\n-\treq, err := http.NewRequest(\"DELETE\", fmt.Sprintf(\"%s/Organization/%s\", apiURL, orgID), nil)\n+func (api *API) DeleteOrg(orgID string) {\n+\treq, err := http.NewRequest(\"DELETE\", fmt.Sprintf(\"%s/Organization/%s\", api.URL, orgID), nil)\n \tif err != nil {\n \t\tfmt.Println(\"Organization could not be deleted\", err)\n \t}\n-\treq.Header.Add(\"Authorization\", fmt.Sprintf(\"Bearer %s\", goldenMacaroon))\n+\treq.Header.Add(\"Authorization\", fmt.Sprintf(\"Bearer %s\", api.goldenMacaroon))\n \t_, err = http.DefaultClient.Do(req)\n \tif err != nil {\n \t\tfmt.Println(\"Organization could not be deleted\", err)\n \t}\n \n }\n \n-func deleteDirs() {\n-\terr := os.RemoveAll(\"keys\")\n-\tif err != nil {\n-\t\tfmt.Println(\"keys directory could not be deleted\", err)\n-\t}\n+type orgAuth struct {\n+\torgID       string\n+\taccessToken string\n+\tkeyID       string\n+\tprivateKey  *rsa.PrivateKey\n+}\n \n-\terr = os.RemoveAll(\"tokens\")\n-\tif err != nil {\n-\t\tfmt.Println(\"tokens directory could not be deleted\", err)\n+func (api *API) SetupOrgAuth(orgIDs ...string) orgAuth {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e03ac4f0775d1a14af72746e8651b0ca7880c33"}, "originalPosition": 139}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMjE0OTU4OnYy", "diffSide": "RIGHT", "path": "dpc-testing/performance/pkg/dpc/dpc.go", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMjo0NzoxMVrOHo6asQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNTozMDowOFrOHpCYPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY2MjE5Mw==", "bodyText": "https://github.com/golang/go/wiki/CodeReviewComments#mixed-caps", "url": "https://github.com/CMSgov/dpc-app/pull/1092#discussion_r512662193", "createdAt": "2020-10-27T12:47:11Z", "author": {"login": "em1"}, "path": "dpc-testing/performance/pkg/dpc/dpc.go", "diffHunk": "@@ -0,0 +1,125 @@\n+// Package dpc contains all test methods, the api test runner, and common functionalities\n+package dpc\n+\n+import (\n+\t\"crypto/rsa\"\n+\t\"encoding/json\"\n+\t\"fmt\"\n+\t\"io/ioutil\"\n+\t\"os\"\n+\t\"path/filepath\"\n+\n+\t\"github.com/CMSgov/dpc-app/dpc-testing/performance/pkg/dpc/targeter\"\n+)\n+\n+type Resource struct {\n+\tID          string `json:\"id\"`\n+\tClientToken []byte `json:\"token\"`\n+\tAccessToken string `json:\"access_token\"`\n+}\n+\n+// Pull `ids` out of a set of response bodies\n+func unmarshalIDs(resps [][]byte) []string {\n+\tvar IDs []string\n+\tfor _, resp := range resps {\n+\t\tvar result Resource\n+\t\tjson.Unmarshal(resp, &result)\n+\t\tIDs = append(IDs, result.ID)\n+\t}\n+\n+\treturn IDs\n+}\n+\n+// Pull `clientTokens` out of a set of response bodies\n+func unmarshalClientTokens(resps [][]byte) [][]byte {\n+\tvar clientTokens [][]byte\n+\tfor _, resp := range resps {\n+\t\tvar result Resource\n+\t\tjson.Unmarshal(resp, &result)\n+\t\tclientTokens = append(clientTokens, result.ClientToken)\n+\t}\n+\n+\treturn clientTokens\n+}\n+\n+// Pull `accessTokens` out of a set of response bodies\n+func unmarshalAccessTokens(resps [][]byte) []string {\n+\tvar accessTokens []string\n+\tfor _, resp := range resps {\n+\t\tvar result Resource\n+\t\tjson.Unmarshal(resp, &result)\n+\t\taccessTokens = append(accessTokens, result.AccessToken)\n+\t}\n+\n+\treturn accessTokens\n+}\n+\n+var FHIR = \"application/fhir+json\"\n+var JSON = \"application/json\"\n+var PLAIN = \"text/plain\"\n+var FORM = \"application/x-www-form-urlencoded\"\n+var UNSET = \"\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e03ac4f0775d1a14af72746e8651b0ca7880c33"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjc5MjYzOA==", "bodyText": "Had no idea, will rename!", "url": "https://github.com/CMSgov/dpc-app/pull/1092#discussion_r512792638", "createdAt": "2020-10-27T15:30:08Z", "author": {"login": "SMLuthi"}, "path": "dpc-testing/performance/pkg/dpc/dpc.go", "diffHunk": "@@ -0,0 +1,125 @@\n+// Package dpc contains all test methods, the api test runner, and common functionalities\n+package dpc\n+\n+import (\n+\t\"crypto/rsa\"\n+\t\"encoding/json\"\n+\t\"fmt\"\n+\t\"io/ioutil\"\n+\t\"os\"\n+\t\"path/filepath\"\n+\n+\t\"github.com/CMSgov/dpc-app/dpc-testing/performance/pkg/dpc/targeter\"\n+)\n+\n+type Resource struct {\n+\tID          string `json:\"id\"`\n+\tClientToken []byte `json:\"token\"`\n+\tAccessToken string `json:\"access_token\"`\n+}\n+\n+// Pull `ids` out of a set of response bodies\n+func unmarshalIDs(resps [][]byte) []string {\n+\tvar IDs []string\n+\tfor _, resp := range resps {\n+\t\tvar result Resource\n+\t\tjson.Unmarshal(resp, &result)\n+\t\tIDs = append(IDs, result.ID)\n+\t}\n+\n+\treturn IDs\n+}\n+\n+// Pull `clientTokens` out of a set of response bodies\n+func unmarshalClientTokens(resps [][]byte) [][]byte {\n+\tvar clientTokens [][]byte\n+\tfor _, resp := range resps {\n+\t\tvar result Resource\n+\t\tjson.Unmarshal(resp, &result)\n+\t\tclientTokens = append(clientTokens, result.ClientToken)\n+\t}\n+\n+\treturn clientTokens\n+}\n+\n+// Pull `accessTokens` out of a set of response bodies\n+func unmarshalAccessTokens(resps [][]byte) []string {\n+\tvar accessTokens []string\n+\tfor _, resp := range resps {\n+\t\tvar result Resource\n+\t\tjson.Unmarshal(resp, &result)\n+\t\taccessTokens = append(accessTokens, result.AccessToken)\n+\t}\n+\n+\treturn accessTokens\n+}\n+\n+var FHIR = \"application/fhir+json\"\n+var JSON = \"application/json\"\n+var PLAIN = \"text/plain\"\n+var FORM = \"application/x-www-form-urlencoded\"\n+var UNSET = \"\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY2MjE5Mw=="}, "originalCommit": {"oid": "7e03ac4f0775d1a14af72746e8651b0ca7880c33"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMjE2NzAyOnYy", "diffSide": "RIGHT", "path": "dpc-testing/performance/pkg/dpc/test_key.go", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMjo1MTozMlrOHo6lkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNToyOTo1OVrOHpCX4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY2NDk3OA==", "bodyText": "Could Headers() be changed to take a variable number of parameters so an unset one isn't required?", "url": "https://github.com/CMSgov/dpc-app/pull/1092#discussion_r512664978", "createdAt": "2020-10-27T12:51:32Z", "author": {"login": "em1"}, "path": "dpc-testing/performance/pkg/dpc/test_key.go", "diffHunk": "@@ -0,0 +1,54 @@\n+package dpc\n+\n+import (\n+\t\"github.com/CMSgov/dpc-app/dpc-testing/performance/pkg/dpc/targeter\"\n+)\n+\n+func (api *API) RunKeyTests() {\n+\tconst ENDPOINT = \"Key\"\n+\n+\t// Create organization (and delete at the end) and setup accesstoken\n+\tauth := api.SetupOrgAuth()\n+\tdefer api.DeleteOrg(auth.orgID)\n+\n+\t// POST /Key\n+\tresps := targeter.New(targeter.Config{\n+\t\tMethod:      \"POST\",\n+\t\tBaseURL:     api.URL,\n+\t\tEndpoint:    ENDPOINT,\n+\t\tAccessToken: auth.accessToken,\n+\t\tBodies:      generateKeyBodies(25, api.GenerateKeyPairAndSignature),\n+\t\tHeaders:     Headers(JSON, UNSET),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e03ac4f0775d1a14af72746e8651b0ca7880c33"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjc5MjU0NQ==", "bodyText": "Good question. The reason I settled on this is because, currently, most of the tests settle on default values of fhir json. This way resulted in the least amount of clutter in this field. I think, if/when more tests are included with more header parameters this will probably get reworked a bit into something thats not as minimal but more expandable... if that makes sense.", "url": "https://github.com/CMSgov/dpc-app/pull/1092#discussion_r512792545", "createdAt": "2020-10-27T15:29:59Z", "author": {"login": "SMLuthi"}, "path": "dpc-testing/performance/pkg/dpc/test_key.go", "diffHunk": "@@ -0,0 +1,54 @@\n+package dpc\n+\n+import (\n+\t\"github.com/CMSgov/dpc-app/dpc-testing/performance/pkg/dpc/targeter\"\n+)\n+\n+func (api *API) RunKeyTests() {\n+\tconst ENDPOINT = \"Key\"\n+\n+\t// Create organization (and delete at the end) and setup accesstoken\n+\tauth := api.SetupOrgAuth()\n+\tdefer api.DeleteOrg(auth.orgID)\n+\n+\t// POST /Key\n+\tresps := targeter.New(targeter.Config{\n+\t\tMethod:      \"POST\",\n+\t\tBaseURL:     api.URL,\n+\t\tEndpoint:    ENDPOINT,\n+\t\tAccessToken: auth.accessToken,\n+\t\tBodies:      generateKeyBodies(25, api.GenerateKeyPairAndSignature),\n+\t\tHeaders:     Headers(JSON, UNSET),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY2NDk3OA=="}, "originalCommit": {"oid": "7e03ac4f0775d1a14af72746e8651b0ca7880c33"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 6, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}