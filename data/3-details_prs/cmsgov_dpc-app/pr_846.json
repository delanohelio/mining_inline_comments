{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyNjg0MTMw", "number": 846, "title": "Dpc 361 move sidekiq to container service", "bodyText": "Why\nThe Sidekiq service should be containerized along the web app.\nWhat Changed\nThe Entrypoint script was updated to either run the web app OR the sidekiq server (not both). This can be declared by providing an argument for which one to the script. The Dockerfile has been updated to provide an ENTRYPOINT instead of just a CMD. The dockercompose file has been updated to include building a redis container and a sidekiq container.\nChoices Made\nChose to keep the business logic in the entrypoint file rather than manipulate the dockerfile via ARGs. Also, instead of opting for separate dockerfiles and separate entrypoints, opted for the current approach that decides via the CMD flag what to run.\nTickets closed:\nDoes not fully close the ticket (accompanying work in ops needs to be done for this to take affect)\nDPC-361\nFuture Work\nOnce the sidekiq server has been properly containerized and is deploying along side dpc-web, we can start the process of running it on systemd.\nChecklist\n\n All tests are passing via make ci-app (app change) and make ci-web (website change)\n Swagger documentation has been updated\n FHIR documentation has been updated\n Any required dpc-ops changes have a PR submitted and mentioned in this ticket\n Any manual migration steps are documented, scripts written (where applicable), and tested\n Before merging, any required dpc-ops changes have been approved and merged into master of the dpc-ops repo", "createdAt": "2020-06-10T20:31:14Z", "url": "https://github.com/CMSgov/dpc-app/pull/846", "merged": true, "mergeCommit": {"oid": "5368db6617ed0b786f79abf39ec1ee17da0acd2f"}, "closed": true, "closedAt": "2020-06-24T22:58:49Z", "author": {"login": "SMLuthi"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcp_YR7gH2gAyNDMyNjg0MTMwOjMxODEyNDUyOWY0ZjUzYmZmN2U5ZmE0YWNlYjQ4OWE4ZGMwYjRiM2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuhqolAH2gAyNDMyNjg0MTMwOjcwYTZkYTNkMmE1MDZjNzgyNmVlMWY4ZjA2YmE1OGYxMDM5MDRiZjM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "318124529f4f53bff7e9fa4aceb489a8dc0b4b3e", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/318124529f4f53bff7e9fa4aceb489a8dc0b4b3e", "committedDate": "2020-06-10T20:07:31Z", "message": "Replace default CMD in Dockerfike to ENTRYPOINT and replace CMD with default arg"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfc85aa1d2a7e1c132782d3615213e1e8d1853a0", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/dfc85aa1d2a7e1c132782d3615213e1e8d1853a0", "committedDate": "2020-06-10T20:08:17Z", "message": "Allow entrypoint to either run the web app or the sidekiq server depending on an argument flag"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2363df7d024d830ccd79afaa5fa8b96aede708fe", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/2363df7d024d830ccd79afaa5fa8b96aede708fe", "committedDate": "2020-06-10T20:09:06Z", "message": "Update docker compose file to allow for a sidekiq container and a redis container"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "501b129b0a0d865c0bd3a699fde87ca5c3911b59", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/501b129b0a0d865c0bd3a699fde87ca5c3911b59", "committedDate": "2020-06-10T20:37:43Z", "message": "Merge branch 'master' into dpc-361-move-sidekiq-to-container-service"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NDI3NjQy", "url": "https://github.com/CMSgov/dpc-app/pull/846#pullrequestreview-428427642", "createdAt": "2020-06-10T21:05:22Z", "commit": {"oid": "2363df7d024d830ccd79afaa5fa8b96aede708fe"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQyMTowNToyMlrOGiGTRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQyMTowODowMFrOGiGYDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQwODAwNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              # TODO: We should avoid using the dameonize flag in production and, instead, pursue a deployment\n          \n          \n            \n              # like provided here https://github.com/mperham/sidekiq/wiki/Deployment", "url": "https://github.com/CMSgov/dpc-app/pull/846#discussion_r438408004", "createdAt": "2020-06-10T21:05:22Z", "author": {"login": "dhgreene"}, "path": "dpc-web/docker/entrypoint.sh", "diffHunk": "@@ -7,22 +7,26 @@ if [ -f tmp/pids/server.pid ]; then\n   rm tmp/pids/server.pid\n fi\n \n-# Run the database migrations\n-echo \"Migrating the database...\"\n-bundle exec rails db:migrate\n+if [ \"$1\" == \"web\" ]; then\n+  # Run the database migrations\n+  echo \"Migrating the database...\"\n+  bundle exec rails db:migrate\n \n-# Seed the database\n-# This step is not needed, as there is no database seed data yet\n+  # Seed the database\n+  # This step is not needed, as there is no database seed data yet\n \n-# Start background job processing\n-# TODO: We should avoid using the dameonize flag in production and, instead, pursue a deployment\n-# like provided here https://github.com/mperham/sidekiq/wiki/Deployment\n-bundle exec sidekiq -q default -q mailers 2>&1 | tee -a /var/log/dpc-web-$(hostname)-sidekiq.log &\n+  # Start the database service (and make accessible outside the Docker container)\n+  echo \"Starting Rails server...\"\n+  if [[ -n \"$JACOCO\" ]]; then\n+    bundle exec rails server -b 0.0.0.0 -p 3000\n+  else\n+    bundle exec rails server -b 0.0.0.0 -p 3000 2>&1 | tee -a /var/log/dpc-web-$(hostname).log\n+  fi\n+fi\n \n-# Start the database service (and make accessible outside the Docker container)\n-echo \"Starting Rails server...\"\n-if [ -n \"$JACOCO\" ]; then\n-  bundle exec rails server -b 0.0.0.0 -p 3000\n-else\n-  bundle exec rails server -b 0.0.0.0 -p 3000 2>&1 | tee -a /var/log/dpc-web-$(hostname).log\n+if [ \"$1\" == \"sidekiq\" ]; then\n+  # Start Sidekiq job processing\n+  # TODO: We should avoid using the dameonize flag in production and, instead, pursue a deployment\n+  # like provided here https://github.com/mperham/sidekiq/wiki/Deployment", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2363df7d024d830ccd79afaa5fa8b96aede708fe"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQwOTIyOA==", "bodyText": "To account for local envs should we do something like:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              bundle exec sidekiq -q default -q mailers 2>&1 | tee -a /var/log/dpc-web-$(hostname)-sidekiq.log\n          \n          \n            \n              if [[ -n \"$JACOCO\" ]]; then\n          \n          \n            \n                bundle exec sidekiq -q default -q mailers\n          \n          \n            \n              else\n          \n          \n            \n                bundle exec sidekiq -q default -q mailers 2>&1 | tee -a /var/log/dpc-web-$(hostname)-sidekiq.log\n          \n          \n            \n              fi", "url": "https://github.com/CMSgov/dpc-app/pull/846#discussion_r438409228", "createdAt": "2020-06-10T21:08:00Z", "author": {"login": "dhgreene"}, "path": "dpc-web/docker/entrypoint.sh", "diffHunk": "@@ -7,22 +7,26 @@ if [ -f tmp/pids/server.pid ]; then\n   rm tmp/pids/server.pid\n fi\n \n-# Run the database migrations\n-echo \"Migrating the database...\"\n-bundle exec rails db:migrate\n+if [ \"$1\" == \"web\" ]; then\n+  # Run the database migrations\n+  echo \"Migrating the database...\"\n+  bundle exec rails db:migrate\n \n-# Seed the database\n-# This step is not needed, as there is no database seed data yet\n+  # Seed the database\n+  # This step is not needed, as there is no database seed data yet\n \n-# Start background job processing\n-# TODO: We should avoid using the dameonize flag in production and, instead, pursue a deployment\n-# like provided here https://github.com/mperham/sidekiq/wiki/Deployment\n-bundle exec sidekiq -q default -q mailers 2>&1 | tee -a /var/log/dpc-web-$(hostname)-sidekiq.log &\n+  # Start the database service (and make accessible outside the Docker container)\n+  echo \"Starting Rails server...\"\n+  if [[ -n \"$JACOCO\" ]]; then\n+    bundle exec rails server -b 0.0.0.0 -p 3000\n+  else\n+    bundle exec rails server -b 0.0.0.0 -p 3000 2>&1 | tee -a /var/log/dpc-web-$(hostname).log\n+  fi\n+fi\n \n-# Start the database service (and make accessible outside the Docker container)\n-echo \"Starting Rails server...\"\n-if [ -n \"$JACOCO\" ]; then\n-  bundle exec rails server -b 0.0.0.0 -p 3000\n-else\n-  bundle exec rails server -b 0.0.0.0 -p 3000 2>&1 | tee -a /var/log/dpc-web-$(hostname).log\n+if [ \"$1\" == \"sidekiq\" ]; then\n+  # Start Sidekiq job processing\n+  # TODO: We should avoid using the dameonize flag in production and, instead, pursue a deployment\n+  # like provided here https://github.com/mperham/sidekiq/wiki/Deployment\n+  bundle exec sidekiq -q default -q mailers 2>&1 | tee -a /var/log/dpc-web-$(hostname)-sidekiq.log", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2363df7d024d830ccd79afaa5fa8b96aede708fe"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f74c52466796fe5b67fdd7a0d4690db3d7127bd8", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/f74c52466796fe5b67fdd7a0d4690db3d7127bd8", "committedDate": "2020-06-15T23:39:25Z", "message": "Update dpc-web/docker/entrypoint.sh\n\nCo-authored-by: dhgreene <dhgreene@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18f5aca7285e4743ab213e7cf2e01d6a562032df", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/18f5aca7285e4743ab213e7cf2e01d6a562032df", "committedDate": "2020-06-15T23:39:40Z", "message": "Update dpc-web/docker/entrypoint.sh\n\nCo-authored-by: dhgreene <dhgreene@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "530df161e38a073404cb564aba06b097180fd7af", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/530df161e38a073404cb564aba06b097180fd7af", "committedDate": "2020-06-15T23:39:46Z", "message": "Merge branch 'master' into dpc-361-move-sidekiq-to-container-service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b41fab6d4af8e4cb107dc669b04040d44319b492", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/b41fab6d4af8e4cb107dc669b04040d44319b492", "committedDate": "2020-06-16T15:52:46Z", "message": "Merge branch 'master' into dpc-361-move-sidekiq-to-container-service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3990b24dc51a33e0ff804165effa6e4d215db68a", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/3990b24dc51a33e0ff804165effa6e4d215db68a", "committedDate": "2020-06-16T19:23:57Z", "message": "Merge branch 'master' into dpc-361-move-sidekiq-to-container-service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55783bf00e49ff720a1d3b4cd12993be493253ab", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/55783bf00e49ff720a1d3b4cd12993be493253ab", "committedDate": "2020-06-17T16:09:19Z", "message": "Merge branch 'master' into dpc-361-move-sidekiq-to-container-service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90e09a3a65e35fbfd20fda49b1ac8fec280e8551", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/90e09a3a65e35fbfd20fda49b1ac8fec280e8551", "committedDate": "2020-06-17T20:33:59Z", "message": "Merge branch 'master' into dpc-361-move-sidekiq-to-container-service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f24a0d631dfff90ffd8e701f1785def9ba1036c8", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/f24a0d631dfff90ffd8e701f1785def9ba1036c8", "committedDate": "2020-06-18T19:54:21Z", "message": "Add sidekiq_alive for monitoring sidekiq health"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ad9b55bffa89ddb575abc1d421332ec58bac55f", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/1ad9b55bffa89ddb575abc1d421332ec58bac55f", "committedDate": "2020-06-18T20:04:10Z", "message": "Added the sidekiq web ui monitoring service for development"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b893f70565ad4f8cf894d05fa3b08462ad92ad94", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/b893f70565ad4f8cf894d05fa3b08462ad92ad94", "committedDate": "2020-06-18T20:07:36Z", "message": "Merge branch 'master' into dpc-361-move-sidekiq-to-container-service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d91094ad36adcfe2f01f62b483bffb709b08a81b", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/d91094ad36adcfe2f01f62b483bffb709b08a81b", "committedDate": "2020-06-22T16:27:47Z", "message": "suppress warning for redis"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MDk0NDIw", "url": "https://github.com/CMSgov/dpc-app/pull/846#pullrequestreview-435094420", "createdAt": "2020-06-22T16:35:33Z", "commit": {"oid": "d91094ad36adcfe2f01f62b483bffb709b08a81b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MjIwNzAw", "url": "https://github.com/CMSgov/dpc-app/pull/846#pullrequestreview-435220700", "createdAt": "2020-06-22T19:42:46Z", "commit": {"oid": "d91094ad36adcfe2f01f62b483bffb709b08a81b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bf4fe848419aed6e45017a1e2303f8ba609090f", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/4bf4fe848419aed6e45017a1e2303f8ba609090f", "committedDate": "2020-06-22T20:45:54Z", "message": "Merge branch 'master' into dpc-361-move-sidekiq-to-container-service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a4f225f194de035b00d1d64a4fa835369136d5f", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/8a4f225f194de035b00d1d64a4fa835369136d5f", "committedDate": "2020-06-23T15:15:27Z", "message": "Merge branch 'master' into dpc-361-move-sidekiq-to-container-service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b1017f8ae54a90fd0fd2e5c8021482c377d0997", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/8b1017f8ae54a90fd0fd2e5c8021482c377d0997", "committedDate": "2020-06-24T21:46:06Z", "message": "Merge branch 'master' into dpc-361-move-sidekiq-to-container-service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70a6da3d2a506c7826ee1f8f06ba58f103904bf3", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/70a6da3d2a506c7826ee1f8f06ba58f103904bf3", "committedDate": "2020-06-24T22:20:02Z", "message": "Merge branch 'master' into dpc-361-move-sidekiq-to-container-service"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 483, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}