{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1NDk0OTI2", "number": 553, "title": "DPC-937: Add MBI hashing support", "bodyText": "Why\nIn order to request Patient resources from BFD by MBI, the MBIs must be hashed.\nWhat Changed\n\nCreated hashMbi() in BlueButtonClient\nUpdated attribution patients table to add mbi_hash column\n\nTickets closed:\nDPC-937\nFuture Work\nWork is continuing on adding MBIs (Patient profile, retrieving bene ID by MBI before EOB and Coverage requests).\nChecklist\n\n All tests are passing via make ci-app (app change) and make ci-web (website change)\n Swagger documentation has been updated\n FHIR documentation has been updated\n Any required dpc-ops changes have a PR submitted and mentioned in this ticket\n Any manual migration steps are documented, scripts written (where applicable), and tested\n Before merging, any required dpc-ops changes have been approved and merged into master of the dpc-ops repo", "createdAt": "2020-01-21T20:24:50Z", "url": "https://github.com/CMSgov/dpc-app/pull/553", "merged": true, "mergeCommit": {"oid": "9881b9e41767778de9a8d8d2dd6813290e421f19"}, "closed": true, "closedAt": "2020-01-22T21:06:20Z", "author": {"login": "em1"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8nz-NgH2gAyMzY1NDk0OTI2OjkzMDhkZWEzNGMwMmI3NzViZWMzYjQ1YWFjZTUyNWI0MjE1OTJmNDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb88DLxAFqTM0Njg5MTM0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9308dea34c02b775bec3b45aace525b421592f47", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/9308dea34c02b775bec3b45aace525b421592f47", "committedDate": "2020-01-21T21:13:27Z", "message": "Add method for hashing MBI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "065171e73f1dc3a9e22598cf7a616868960a2e17", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/065171e73f1dc3a9e22598cf7a616868960a2e17", "committedDate": "2020-01-22T14:20:42Z", "message": "Add mbi_hash column to attribution patients table"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "065171e73f1dc3a9e22598cf7a616868960a2e17", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/065171e73f1dc3a9e22598cf7a616868960a2e17", "committedDate": "2020-01-22T14:20:42Z", "message": "Add mbi_hash column to attribution patients table"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NzAyNDQ3", "url": "https://github.com/CMSgov/dpc-app/pull/553#pullrequestreview-346702447", "createdAt": "2020-01-22T15:59:52Z", "commit": {"oid": "065171e73f1dc3a9e22598cf7a616868960a2e17"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNTo1OTo1MlrOFghiHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNjowMTo1MFrOFghmxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY0ODE1Nw==", "bodyText": "Do the hashes have a fixed length? If so, we might want to shrink this column a bit.", "url": "https://github.com/CMSgov/dpc-app/pull/553#discussion_r369648157", "createdAt": "2020-01-22T15:59:52Z", "author": {"login": "nickrobison-usds"}, "path": "dpc-attribution/src/main/resources/migrations.xml", "diffHunk": "@@ -422,4 +422,10 @@\n                 columnName=\"gender\"\n                 defaultNullValue=\"3\"/>\n     </changeSet>\n+\n+    <changeSet id=\"add-mbi-hash\" author=\"embh\">\n+        <addColumn tableName=\"PATIENTS\">\n+            <column name=\"mbi_hash\" type=\"VARCHAR\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "065171e73f1dc3a9e22598cf7a616868960a2e17"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY0ODczOA==", "bodyText": "Is there any portion of this that can be pulled out as class variables?", "url": "https://github.com/CMSgov/dpc-app/pull/553#discussion_r369648738", "createdAt": "2020-01-22T16:00:50Z", "author": {"login": "nickrobison-usds"}, "path": "dpc-bluebutton/src/main/java/gov/cms/dpc/bluebutton/client/BlueButtonClientImpl.java", "diffHunk": "@@ -150,6 +156,16 @@ public CapabilityStatement requestCapabilityStatement() throws ResourceNotFoundE\n                         .execute());\n     }\n \n+    @Override\n+    public String hashMbi(String mbi) throws GeneralSecurityException {\n+        String pepper = config.getBfdHashPepper();\n+        int iterations = config.getBfdHashIter();\n+        KeySpec keySpec = new PBEKeySpec(mbi.toCharArray(), Hex.decode(pepper), iterations, 256);\n+        SecretKeyFactory skf = SecretKeyFactory.getInstance(\"PBKDF2WithHmacSHA256\");\n+        SecretKey secretKey = skf.generateSecret(keySpec);\n+        return Hex.toHexString(secretKey.getEncoded());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "065171e73f1dc3a9e22598cf7a616868960a2e17"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY0OTM1MA==", "bodyText": "Do we have a failure case? Such as an empty or null string?", "url": "https://github.com/CMSgov/dpc-app/pull/553#discussion_r369649350", "createdAt": "2020-01-22T16:01:50Z", "author": {"login": "nickrobison-usds"}, "path": "dpc-bluebutton/src/test/java/gov/cms/dpc/bluebutton/client/BlueButtonClientTest.java", "diffHunk": "@@ -222,6 +223,16 @@ void shouldThrowExceptionWhenResourceNotFound() {\n         );\n     }\n \n+    @Test\n+    void shouldHashMbi() throws GeneralSecurityException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "065171e73f1dc3a9e22598cf7a616868960a2e17"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2ODMwODQ4", "url": "https://github.com/CMSgov/dpc-app/pull/553#pullrequestreview-346830848", "createdAt": "2020-01-22T19:06:54Z", "commit": {"oid": "065171e73f1dc3a9e22598cf7a616868960a2e17"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOTowNjo1NVrOFgnmDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToxNzoxMFrOFgn6KQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc0NzQ2OQ==", "bodyText": "64 characters", "url": "https://github.com/CMSgov/dpc-app/pull/553#discussion_r369747469", "createdAt": "2020-01-22T19:06:55Z", "author": {"login": "RickHawesUSDS"}, "path": "dpc-attribution/src/main/resources/migrations.xml", "diffHunk": "@@ -422,4 +422,10 @@\n                 columnName=\"gender\"\n                 defaultNullValue=\"3\"/>\n     </changeSet>\n+\n+    <changeSet id=\"add-mbi-hash\" author=\"embh\">\n+        <addColumn tableName=\"PATIENTS\">\n+            <column name=\"mbi_hash\" type=\"VARCHAR\"/>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY0ODE1Nw=="}, "originalCommit": {"oid": "065171e73f1dc3a9e22598cf7a616868960a2e17"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1MDMyOQ==", "bodyText": "Is the comment saying that the source of this pepper is bluebutton?", "url": "https://github.com/CMSgov/dpc-app/pull/553#discussion_r369750329", "createdAt": "2020-01-22T19:12:31Z", "author": {"login": "RickHawesUSDS"}, "path": "dpc-bluebutton/src/test/resources/test.application.conf", "diffHunk": "@@ -13,6 +13,8 @@ bbclient {\n \n   serverBaseUrl = \"http://localhost:8083/v1/fhir/\"\n   resourcesCount = 10\n+  bfdHashPepper=6E6F747468657265616C706570706572 // https://github.com/CMSgov/bluebutton-ansible-playbooks-data-sandbox/blob/master/etl_server_redeploy.yml#L151", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "065171e73f1dc3a9e22598cf7a616868960a2e17"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1MjYxNw==", "bodyText": "What happens if mbi is empty or null? The table's column can be null.", "url": "https://github.com/CMSgov/dpc-app/pull/553#discussion_r369752617", "createdAt": "2020-01-22T19:17:10Z", "author": {"login": "RickHawesUSDS"}, "path": "dpc-bluebutton/src/main/java/gov/cms/dpc/bluebutton/client/BlueButtonClientImpl.java", "diffHunk": "@@ -150,6 +156,16 @@ public CapabilityStatement requestCapabilityStatement() throws ResourceNotFoundE\n                         .execute());\n     }\n \n+    @Override\n+    public String hashMbi(String mbi) throws GeneralSecurityException {\n+        String pepper = config.getBfdHashPepper();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "065171e73f1dc3a9e22598cf7a616868960a2e17"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9746c122694d10898c1f28a86a08087fea0a13c", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/b9746c122694d10898c1f28a86a08087fea0a13c", "committedDate": "2020-01-22T19:45:47Z", "message": "Address PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2ODkxMzQ0", "url": "https://github.com/CMSgov/dpc-app/pull/553#pullrequestreview-346891344", "createdAt": "2020-01-22T20:48:10Z", "commit": {"oid": "b9746c122694d10898c1f28a86a08087fea0a13c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 216, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}