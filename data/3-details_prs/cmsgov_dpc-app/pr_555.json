{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1ODU3MjA0", "number": 555, "title": "DPC-942: Update organization in API from web app", "bodyText": "Why\nWhen a user changes information about an organization in the web app, we should update the organization's record in the API.\nWhat Changed\n\nMakes 2 requests to the API when updated: one to update the org and the second to update the org's FHIR Endpoint.\nAdds payloadType to Endpoint in the Organization$submit bundle (required field)\nUpdated tests and mocked requests\n\nChoices Made\nThis PR adds the Ruby FHIR client and we use it for the new update functionality. We want to use the FHIR client as much as possible to ensure our API is compatible with community tools and to test community tools ourselves.\nTickets closed:\nDPC-942\nFuture Work\n\nDPC-954 - We want to update the FHIR Endpoint model and its associations with Organization and RegisteredOrganization so that each registered organization has its own FHIR endpoint record. This will make it possible to have multiple endpoints per org and to also keep track of which endpoint belongs to which environment.\nDPC-958 - update docs to say the payloadType is required for Endpoint\nDPC-957 - implement destroy_organization in API Client\n\nChecklist\n\n All tests are passing via make ci-app (app change) and make ci-web (website change)\n Swagger documentation has been updated\n FHIR documentation has been updated\n Any required dpc-ops changes have a PR submitted and mentioned in this ticket\n Any manual migration steps are documented, scripts written (where applicable), and tested\n Before merging, any required dpc-ops changes have been approved and merged into master of the dpc-ops repo", "createdAt": "2020-01-22T13:35:22Z", "url": "https://github.com/CMSgov/dpc-app/pull/555", "merged": true, "mergeCommit": {"oid": "dbee8d8ff821a2803d3aeb5392d3a8def86e79cb"}, "closed": true, "closedAt": "2020-01-23T14:48:24Z", "author": {"login": "switzersc-usds"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb82Fi9gFqTM0NjU5OTY5MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb9LGNjgBqjI5NzM4OTg2ODg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NTk5Njkw", "url": "https://github.com/CMSgov/dpc-app/pull/555#pullrequestreview-346599690", "createdAt": "2020-01-22T13:51:17Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMzo1MToxOFrOFgcufQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMzo1MToxOVrOFgcuhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2OTQwNQ==", "bodyText": "Method OrganizationRegistrar#existing_registered_orgs is defined at both dpc-web/app/services/organization_registrar.rb:4 and dpc-web/app/services/organization_registrar.rb:39.", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369569405", "createdAt": "2020-01-22T13:51:18Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/services/organization_registrar.rb", "diffHunk": "@@ -26,18 +25,28 @@ def register_organization(api_env)\n     api_client = APIClient.new(api_env).create_organization(organization)\n     api_org = api_client.response_body\n \n-    create_registered_org(api_env, api_org) if api_client.response_successful?\n+    create_registered_organization(api_env, api_org) if api_client.response_successful?\n+  end\n+\n+  def update_existing_registered_orgs\n+    existing_registered_orgs.each do |registered_org|\n+      APIClient.new(registered_org.api_env).update_organization(registered_org)\n+    end\n   end\n \n   private\n \n-  def no_change?\n+  def existing_registered_orgs", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2OTQwNg==", "bodyText": "Space inside { missing.", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369569406", "createdAt": "2020-01-22T13:51:18Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -1,23 +1,42 @@\n # frozen_string_literal: true\n \n class APIClient\n-  attr_reader :api_env, :response_body, :response_status\n+  attr_reader :api_env, :base_url, :response_body, :response_status\n \n   def initialize(api_env)\n     @api_env = api_env\n+    @base_url = base_urls[api_env]\n   end\n \n   def create_organization(org)\n-    uri_string = base_urls[api_env] + '/Organization/$submit'\n+    uri_string = base_url + '/Organization/$submit'\n     json = OrganizationSubmitSerializer.new(org).to_json\n     post_request(uri_string, json, fhir_headers(golden_macaroon))\n     self\n   end\n \n+  def update_organization(reg_org)\n+    org = reg_org.organization\n+    fhir_org = FHIR::Organization.new(id: reg_org.api_id, name: org.name, identifier: [{system: 'http://hl7.org/fhir/sid/us-npi', value: org.npi}])", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2OTQwNw==", "bodyText": "Space inside } missing.", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369569407", "createdAt": "2020-01-22T13:51:18Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -1,23 +1,42 @@\n # frozen_string_literal: true\n \n class APIClient\n-  attr_reader :api_env, :response_body, :response_status\n+  attr_reader :api_env, :base_url, :response_body, :response_status\n \n   def initialize(api_env)\n     @api_env = api_env\n+    @base_url = base_urls[api_env]\n   end\n \n   def create_organization(org)\n-    uri_string = base_urls[api_env] + '/Organization/$submit'\n+    uri_string = base_url + '/Organization/$submit'\n     json = OrganizationSubmitSerializer.new(org).to_json\n     post_request(uri_string, json, fhir_headers(golden_macaroon))\n     self\n   end\n \n+  def update_organization(reg_org)\n+    org = reg_org.organization\n+    fhir_org = FHIR::Organization.new(id: reg_org.api_id, name: org.name, identifier: [{system: 'http://hl7.org/fhir/sid/us-npi', value: org.npi}])", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2OTQwOQ==", "bodyText": "Line is too long. [147/120]", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369569409", "createdAt": "2020-01-22T13:51:18Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -1,23 +1,42 @@\n # frozen_string_literal: true\n \n class APIClient\n-  attr_reader :api_env, :response_body, :response_status\n+  attr_reader :api_env, :base_url, :response_body, :response_status\n \n   def initialize(api_env)\n     @api_env = api_env\n+    @base_url = base_urls[api_env]\n   end\n \n   def create_organization(org)\n-    uri_string = base_urls[api_env] + '/Organization/$submit'\n+    uri_string = base_url + '/Organization/$submit'\n     json = OrganizationSubmitSerializer.new(org).to_json\n     post_request(uri_string, json, fhir_headers(golden_macaroon))\n     self\n   end\n \n+  def update_organization(reg_org)\n+    org = reg_org.organization\n+    fhir_org = FHIR::Organization.new(id: reg_org.api_id, name: org.name, identifier: [{system: 'http://hl7.org/fhir/sid/us-npi', value: org.npi}])", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2OTQxMg==", "bodyText": "Annotation keywords like TODO should be all upper case, followed by a colon, and a space, then a note describing the problem.", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369569412", "createdAt": "2020-01-22T13:51:19Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -1,23 +1,42 @@\n # frozen_string_literal: true\n \n class APIClient\n-  attr_reader :api_env, :response_body, :response_status\n+  attr_reader :api_env, :base_url, :response_body, :response_status\n \n   def initialize(api_env)\n     @api_env = api_env\n+    @base_url = base_urls[api_env]\n   end\n \n   def create_organization(org)\n-    uri_string = base_urls[api_env] + '/Organization/$submit'\n+    uri_string = base_url + '/Organization/$submit'\n     json = OrganizationSubmitSerializer.new(org).to_json\n     post_request(uri_string, json, fhir_headers(golden_macaroon))\n     self\n   end\n \n+  def update_organization(reg_org)\n+    org = reg_org.organization\n+    fhir_org = FHIR::Organization.new(id: reg_org.api_id, name: org.name, identifier: [{system: 'http://hl7.org/fhir/sid/us-npi', value: org.npi}])\n+\n+    client = FHIR::Client.new(base_url)\n+    client.additional_headers = auth_header(delegated_macaroon(reg_org.api_id))\n+    response = client.update(fhir_org, reg_org.api_id)\n+    if response.response[:code] == '200'\n+      true\n+    else\n+      Rails.logger.warn 'Unsuccessulful request to API'\n+      @response_status = response.response[:code]\n+      @response_body = { 'issue' => [{ 'details' => { 'text' => 'Request error' } }] }\n+      false\n+    end\n+    # TODO update fhir endpoint from reg_org.api_endpoint_ref", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NzUzMDI5", "url": "https://github.com/CMSgov/dpc-app/pull/555#pullrequestreview-346753029", "createdAt": "2020-01-22T17:04:19Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNzowNDoxOVrOFgj4BA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNzowNDoyMFrOFgj4Dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY4NjUzMg==", "bodyText": "Extra empty line detected before the rescue.", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369686532", "createdAt": "2020-01-22T17:04:19Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -118,6 +192,7 @@ def http_request(request, uri)\n     response = http.request(request)\n     @response_status = response.code.to_i\n     @response_body = parsed_response(response)\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 130}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY4NjUzNw==", "bodyText": "Space inside { missing.", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369686537", "createdAt": "2020-01-22T17:04:19Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -1,23 +1,97 @@\n # frozen_string_literal: true\n \n class APIClient\n-  attr_reader :api_env, :response_body, :response_status\n+  attr_reader :api_env, :base_url, :response_body, :response_status\n \n   def initialize(api_env)\n     @api_env = api_env\n+    @base_url = base_urls[api_env]\n   end\n \n   def create_organization(org)\n-    uri_string = base_urls[api_env] + '/Organization/$submit'\n+    uri_string = base_url + '/Organization/$submit'\n     json = OrganizationSubmitSerializer.new(org).to_json\n     post_request(uri_string, json, fhir_headers(golden_macaroon))\n     self\n   end\n \n-  def delete_organization(org); end\n+  def get_organization(reg_org)\n+    client = FHIR::Client.new(base_url)\n+    client.additional_headers = auth_header(delegated_macaroon(reg_org.api_id))\n+    response = client.read(FHIR::Organization, reg_org.api_id)\n+    binding.pry\n+  end\n+\n+  def update_organization(reg_org)\n+    # build the FHIR::Organization with latest attributes\n+    # build the FHIR::Endpoint with latest attributes\n+    # instantiate the FHIR::Client\n+    # add auth heads to client\n+    # client makes org update request\n+    # client makes endpoint update request\n+    # return true or false\n+\n+    fhir_org = build_fhir_org(reg_org)\n+    fhir_endpoint = build_fhir_endpoint(reg_org)\n+\n+    client = FHIR::Client.new(base_url)\n+    client.additional_headers = auth_header(delegated_macaroon(reg_org.api_id))\n+\n+    org_response = client.update(fhir_org, reg_org.api_id)\n+    endpoint_response = client.update(fhir_endpoint, fhir_endpoint.id)\n+\n+    if org_response.response[:code] == '200' && endpoint_response.response[:code] == '200'\n+      true\n+    else\n+      Rails.logger.warn 'Unsuccessulful request to API'\n+      @response_status = org_response.response[:code]\n+      @response_body = { 'issue' => [{ 'details' => { 'text' => 'Request error' } }] }\n+      false\n+    end\n+  end\n+\n+  def build_fhir_org(reg_org)\n+    org = reg_org.organization\n+    fhir_org = FHIR::Organization.new(\n+      id: reg_org.api_id,\n+      name: org.name,\n+      identifier: [{system: 'http://hl7.org/fhir/sid/us-npi', value: org.npi}]", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY4NjUzOA==", "bodyText": "Space inside } missing.", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369686538", "createdAt": "2020-01-22T17:04:20Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -1,23 +1,97 @@\n # frozen_string_literal: true\n \n class APIClient\n-  attr_reader :api_env, :response_body, :response_status\n+  attr_reader :api_env, :base_url, :response_body, :response_status\n \n   def initialize(api_env)\n     @api_env = api_env\n+    @base_url = base_urls[api_env]\n   end\n \n   def create_organization(org)\n-    uri_string = base_urls[api_env] + '/Organization/$submit'\n+    uri_string = base_url + '/Organization/$submit'\n     json = OrganizationSubmitSerializer.new(org).to_json\n     post_request(uri_string, json, fhir_headers(golden_macaroon))\n     self\n   end\n \n-  def delete_organization(org); end\n+  def get_organization(reg_org)\n+    client = FHIR::Client.new(base_url)\n+    client.additional_headers = auth_header(delegated_macaroon(reg_org.api_id))\n+    response = client.read(FHIR::Organization, reg_org.api_id)\n+    binding.pry\n+  end\n+\n+  def update_organization(reg_org)\n+    # build the FHIR::Organization with latest attributes\n+    # build the FHIR::Endpoint with latest attributes\n+    # instantiate the FHIR::Client\n+    # add auth heads to client\n+    # client makes org update request\n+    # client makes endpoint update request\n+    # return true or false\n+\n+    fhir_org = build_fhir_org(reg_org)\n+    fhir_endpoint = build_fhir_endpoint(reg_org)\n+\n+    client = FHIR::Client.new(base_url)\n+    client.additional_headers = auth_header(delegated_macaroon(reg_org.api_id))\n+\n+    org_response = client.update(fhir_org, reg_org.api_id)\n+    endpoint_response = client.update(fhir_endpoint, fhir_endpoint.id)\n+\n+    if org_response.response[:code] == '200' && endpoint_response.response[:code] == '200'\n+      true\n+    else\n+      Rails.logger.warn 'Unsuccessulful request to API'\n+      @response_status = org_response.response[:code]\n+      @response_body = { 'issue' => [{ 'details' => { 'text' => 'Request error' } }] }\n+      false\n+    end\n+  end\n+\n+  def build_fhir_org(reg_org)\n+    org = reg_org.organization\n+    fhir_org = FHIR::Organization.new(\n+      id: reg_org.api_id,\n+      name: org.name,\n+      identifier: [{system: 'http://hl7.org/fhir/sid/us-npi', value: org.npi}]", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY4NjU0MA==", "bodyText": "Remove debugger entry point binding.pry.", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369686540", "createdAt": "2020-01-22T17:04:20Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -1,23 +1,97 @@\n # frozen_string_literal: true\n \n class APIClient\n-  attr_reader :api_env, :response_body, :response_status\n+  attr_reader :api_env, :base_url, :response_body, :response_status\n \n   def initialize(api_env)\n     @api_env = api_env\n+    @base_url = base_urls[api_env]\n   end\n \n   def create_organization(org)\n-    uri_string = base_urls[api_env] + '/Organization/$submit'\n+    uri_string = base_url + '/Organization/$submit'\n     json = OrganizationSubmitSerializer.new(org).to_json\n     post_request(uri_string, json, fhir_headers(golden_macaroon))\n     self\n   end\n \n-  def delete_organization(org); end\n+  def get_organization(reg_org)\n+    client = FHIR::Client.new(base_url)\n+    client.additional_headers = auth_header(delegated_macaroon(reg_org.api_id))\n+    response = client.read(FHIR::Organization, reg_org.api_id)\n+    binding.pry", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY4NjU0Mg==", "bodyText": "Method has too many lines. [18/15]", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369686542", "createdAt": "2020-01-22T17:04:20Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -1,23 +1,97 @@\n # frozen_string_literal: true\n \n class APIClient\n-  attr_reader :api_env, :response_body, :response_status\n+  attr_reader :api_env, :base_url, :response_body, :response_status\n \n   def initialize(api_env)\n     @api_env = api_env\n+    @base_url = base_urls[api_env]\n   end\n \n   def create_organization(org)\n-    uri_string = base_urls[api_env] + '/Organization/$submit'\n+    uri_string = base_url + '/Organization/$submit'\n     json = OrganizationSubmitSerializer.new(org).to_json\n     post_request(uri_string, json, fhir_headers(golden_macaroon))\n     self\n   end\n \n-  def delete_organization(org); end\n+  def get_organization(reg_org)\n+    client = FHIR::Client.new(base_url)\n+    client.additional_headers = auth_header(delegated_macaroon(reg_org.api_id))\n+    response = client.read(FHIR::Organization, reg_org.api_id)\n+    binding.pry\n+  end\n+\n+  def update_organization(reg_org)\n+    # build the FHIR::Organization with latest attributes\n+    # build the FHIR::Endpoint with latest attributes\n+    # instantiate the FHIR::Client\n+    # add auth heads to client\n+    # client makes org update request\n+    # client makes endpoint update request\n+    # return true or false\n+\n+    fhir_org = build_fhir_org(reg_org)\n+    fhir_endpoint = build_fhir_endpoint(reg_org)\n+\n+    client = FHIR::Client.new(base_url)\n+    client.additional_headers = auth_header(delegated_macaroon(reg_org.api_id))\n+\n+    org_response = client.update(fhir_org, reg_org.api_id)\n+    endpoint_response = client.update(fhir_endpoint, fhir_endpoint.id)\n+\n+    if org_response.response[:code] == '200' && endpoint_response.response[:code] == '200'\n+      true\n+    else\n+      Rails.logger.warn 'Unsuccessulful request to API'\n+      @response_status = org_response.response[:code]\n+      @response_body = { 'issue' => [{ 'details' => { 'text' => 'Request error' } }] }\n+      false\n+    end\n+  end\n+\n+  def build_fhir_org(reg_org)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2ODkyMjI4", "url": "https://github.com/CMSgov/dpc-app/pull/555#pullrequestreview-346892228", "createdAt": "2020-01-22T20:49:47Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMDo0OTo0N1rOFgqgLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMDo0OTo0N1rOFgqgLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc5NTExNw==", "bodyText": "We aren't using this method in the app code but it was super helpful when messing around in console and testing with the live API.", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369795117", "createdAt": "2020-01-22T20:49:47Z", "author": {"login": "switzersc-usds"}, "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -1,23 +1,53 @@\n # frozen_string_literal: true\n \n class APIClient\n-  attr_reader :api_env, :response_body, :response_status\n+  attr_reader :api_env, :base_url, :response_body, :response_status\n \n   def initialize(api_env)\n     @api_env = api_env\n+    @base_url = base_urls[api_env]\n   end\n \n   def create_organization(org)\n-    uri_string = base_urls[api_env] + '/Organization/$submit'\n+    uri_string = base_url + '/Organization/$submit'\n     json = OrganizationSubmitSerializer.new(org).to_json\n     post_request(uri_string, json, fhir_headers(golden_macaroon))\n     self\n   end\n \n-  def delete_organization(org); end\n+  def get_organization(reg_org)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2ODkzNDcx", "url": "https://github.com/CMSgov/dpc-app/pull/555#pullrequestreview-346893471", "createdAt": "2020-01-22T20:51:53Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMDo1MTo1M1rOFgqj-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMDo1MTo1M1rOFgqj-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc5NjA4OA==", "bodyText": "Would've included the whole body but ran into an issue where I couldn't replicate the whitespace in the JSON request the FHIR Client makes, and webmock doesn't ignore whitespace. So instead I'm just making sure the body has something in it that is unique to this request.", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369796088", "createdAt": "2020-01-22T20:51:53Z", "author": {"login": "switzersc-usds"}, "path": "dpc-web/spec/services/api_client_spec.rb", "diffHunk": "@@ -166,6 +186,71 @@\n     end\n   end\n \n+  describe '#update_organization' do\n+    context 'successful request' do\n+      it 'uses fhir_client to send org data to API' do\n+        org = create(:organization, api_environments: [0])\n+        create(:fhir_endpoint, organization: org)\n+        reg_org = create(:registered_organization, organization: org, api_env: 'sandbox', api_endpoint_ref: 'Endpoint/12345')\n+\n+        stub_request(:put, \"http://dpc.example.com/Organization/#{reg_org.api_id}\").\n+          with(\n+            body: /#{reg_org.api_id}/,", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2ODk0MzEw", "url": "https://github.com/CMSgov/dpc-app/pull/555#pullrequestreview-346894310", "createdAt": "2020-01-22T20:53:18Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMDo1MzoxOFrOFgqmiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMDo1MzoxOFrOFgqmiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc5Njc0NA==", "bodyText": "This is a workaround for now. We are going to refactor this model structure soon so that we can fully support multiple FHIR endpoints for an org, rather than sort of supporting it in theory but in practicality only supporting a single one.", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369796744", "createdAt": "2020-01-22T20:53:18Z", "author": {"login": "switzersc-usds"}, "path": "dpc-web/app/services/fhir_resource_builder.rb", "diffHunk": "@@ -0,0 +1,65 @@\n+# frozen_string_literal: true\n+\n+class FhirResourceBuilder\n+  def fhir_org(reg_org)\n+    org = reg_org.organization\n+    fhir_org = FHIR::Organization.new(\n+      id: reg_org.api_id,\n+      name: org.name,\n+      identifier: [{ system: 'http://hl7.org/fhir/sid/us-npi', value: org.npi }]\n+    )\n+    fhir_org.endpoint = { reference: reg_org.api_endpoint_ref }\n+\n+    fhir_org.address = fhir_address(org)\n+    fhir_org\n+  end\n+\n+  def fhir_address(org)\n+    FHIR::Address.new(\n+      line: org.address_street,\n+      city: org.address_city,\n+      postalCode: org.address_zip,\n+      state: org.address_state,\n+      country: 'US',\n+      use: org.address_use,\n+      type: org.address_type\n+    )\n+  end\n+\n+  def fhir_endpoint(reg_org)\n+    org = reg_org.organization\n+    org_endpoint = org.fhir_endpoints.first", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2ODk1OTYz", "url": "https://github.com/CMSgov/dpc-app/pull/555#pullrequestreview-346895963", "createdAt": "2020-01-22T20:56:01Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMDo1NjowMlrOFgqrtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMDo1NjowMlrOFgqrtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc5ODA3MA==", "bodyText": "Will be implemented with DPC-957", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369798070", "createdAt": "2020-01-22T20:56:02Z", "author": {"login": "switzersc-usds"}, "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -1,23 +1,53 @@\n # frozen_string_literal: true\n \n class APIClient\n-  attr_reader :api_env, :response_body, :response_status\n+  attr_reader :api_env, :base_url, :response_body, :response_status\n \n   def initialize(api_env)\n     @api_env = api_env\n+    @base_url = base_urls[api_env]\n   end\n \n   def create_organization(org)\n-    uri_string = base_urls[api_env] + '/Organization/$submit'\n+    uri_string = base_url + '/Organization/$submit'\n     json = OrganizationSubmitSerializer.new(org).to_json\n     post_request(uri_string, json, fhir_headers(golden_macaroon))\n     self\n   end\n \n-  def delete_organization(org); end\n+  def get_organization(reg_org)\n+    client = FHIR::Client.new(base_url)\n+    client.additional_headers = auth_header(delegated_macaroon(reg_org.api_id))\n+    client.read(FHIR::Organization, reg_org.api_id).resource\n+  end\n+\n+  def update_organization(reg_org)\n+    fhir_org = FhirResourceBuilder.new.fhir_org(reg_org)\n+    fhir_endpoint = FhirResourceBuilder.new.fhir_endpoint(reg_org)\n+\n+    client = FHIR::Client.new(base_url)\n+    client.additional_headers = auth_header(delegated_macaroon(reg_org.api_id))\n+\n+    org_response = client.update(fhir_org, reg_org.api_id)\n+    endpoint_response = client.update(fhir_endpoint, fhir_endpoint.id)\n+\n+    if org_response.response[:code] == '200' && endpoint_response.response[:code] == '200'\n+      true\n+    else\n+      Rails.logger.warn 'Unsuccessulful request to API'\n+      @response_status = org_response.response[:code]\n+      @response_body = { 'issue' => [{ 'details' => { 'text' => 'Request error' } }] }\n+      false\n+    end\n+  end\n+\n+  def delete_organization(org)\n+    # DELETE\n+    # client.destroy(FHIR::Organization, org.id)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2OTAyOTQx", "url": "https://github.com/CMSgov/dpc-app/pull/555#pullrequestreview-346902941", "createdAt": "2020-01-22T21:07:16Z", "commit": null, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMTowNzoxNlrOFgrAzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMTowODo0NFrOFgrDcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgwMzQ2OQ==", "bodyText": "Should we also check the endpoint_response code?", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369803469", "createdAt": "2020-01-22T21:07:16Z", "author": {"login": "nickrobison-usds"}, "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -1,23 +1,53 @@\n # frozen_string_literal: true\n \n class APIClient\n-  attr_reader :api_env, :response_body, :response_status\n+  attr_reader :api_env, :base_url, :response_body, :response_status\n \n   def initialize(api_env)\n     @api_env = api_env\n+    @base_url = base_urls[api_env]\n   end\n \n   def create_organization(org)\n-    uri_string = base_urls[api_env] + '/Organization/$submit'\n+    uri_string = base_url + '/Organization/$submit'\n     json = OrganizationSubmitSerializer.new(org).to_json\n     post_request(uri_string, json, fhir_headers(golden_macaroon))\n     self\n   end\n \n-  def delete_organization(org); end\n+  def get_organization(reg_org)\n+    client = FHIR::Client.new(base_url)\n+    client.additional_headers = auth_header(delegated_macaroon(reg_org.api_id))\n+    client.read(FHIR::Organization, reg_org.api_id).resource\n+  end\n+\n+  def update_organization(reg_org)\n+    fhir_org = FhirResourceBuilder.new.fhir_org(reg_org)\n+    fhir_endpoint = FhirResourceBuilder.new.fhir_endpoint(reg_org)\n+\n+    client = FHIR::Client.new(base_url)\n+    client.additional_headers = auth_header(delegated_macaroon(reg_org.api_id))\n+\n+    org_response = client.update(fhir_org, reg_org.api_id)\n+    endpoint_response = client.update(fhir_endpoint, fhir_endpoint.id)\n+\n+    if org_response.response[:code] == '200' && endpoint_response.response[:code] == '200'\n+      true\n+    else\n+      Rails.logger.warn 'Unsuccessulful request to API'\n+      @response_status = org_response.response[:code]", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgwMzg4Ng==", "bodyText": "How difficult would it be to avoid bringing in the DSTU2 models? Not a huge deal, but might be a nice way to reduce the deployment size.", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369803886", "createdAt": "2020-01-22T21:08:12Z", "author": {"login": "nickrobison-usds"}, "path": "dpc-web/Gemfile.lock", "diffHunk": "@@ -113,12 +118,41 @@ GEM\n     faraday (0.15.4)\n       multipart-post (>= 1.2, < 3)\n     ffi (1.11.3)\n+    fhir_client (4.0.3)\n+      activesupport (>= 3)\n+      addressable (>= 2.3)\n+      fhir_dstu2_models (>= 1.0.10)\n+      fhir_models (>= 4.0.2)\n+      fhir_stu3_models (>= 3.0.1)\n+      nokogiri (>= 1.10.4)\n+      oauth2 (~> 1.1)\n+      rack (>= 1.5)\n+      rest-client (~> 2.0)\n+      tilt (>= 1.1)\n+    fhir_dstu2_models (1.0.10)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgwNDE0NA==", "bodyText": "Do we have a ticket for this?", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369804144", "createdAt": "2020-01-22T21:08:44Z", "author": {"login": "nickrobison-usds"}, "path": "dpc-web/app/services/fhir_resource_builder.rb", "diffHunk": "@@ -0,0 +1,65 @@\n+# frozen_string_literal: true\n+\n+class FhirResourceBuilder\n+  def fhir_org(reg_org)\n+    org = reg_org.organization\n+    fhir_org = FHIR::Organization.new(\n+      id: reg_org.api_id,\n+      name: org.name,\n+      identifier: [{ system: 'http://hl7.org/fhir/sid/us-npi', value: org.npi }]\n+    )\n+    fhir_org.endpoint = { reference: reg_org.api_endpoint_ref }\n+\n+    fhir_org.address = fhir_address(org)\n+    fhir_org\n+  end\n+\n+  def fhir_address(org)\n+    FHIR::Address.new(\n+      line: org.address_street,\n+      city: org.address_city,\n+      postalCode: org.address_zip,\n+      state: org.address_state,\n+      country: 'US',\n+      use: org.address_use,\n+      type: org.address_type\n+    )\n+  end\n+\n+  def fhir_endpoint(reg_org)\n+    org = reg_org.organization\n+    org_endpoint = org.fhir_endpoints.first", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc5Njc0NA=="}, "originalCommit": null, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2OTMxNDQy", "url": "https://github.com/CMSgov/dpc-app/pull/555#pullrequestreview-346931442", "createdAt": "2020-01-22T21:56:12Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMTo1NjoxM1rOFgsXzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMTo1NjoxM1rOFgsXzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgyNTc0MA==", "bodyText": "Do not prefix writer method names with set_.", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369825740", "createdAt": "2020-01-22T21:56:13Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -124,6 +150,25 @@ def http_request(request, uri)\n     @response_body = { 'issue' => [{ 'details' => { 'text' => 'Connection error' } }] }\n   end\n \n+  def fhir_client_update_request(reg_org_id, resource, resource_id)\n+    set_fhir_client_auth(reg_org_id)\n+\n+    response = fhir_client.update(resource, resource_id)\n+\n+    if response.response[:code] == '200'\n+      true\n+    else\n+      Rails.logger.warn 'Unsuccessulful request to API'\n+      @response_status = response.response[:code]\n+      @response_body = { 'issue' => [{ 'details' => { 'text' => 'Request error' } }] }\n+      false\n+    end\n+  end\n+\n+  def set_fhir_client_auth(reg_org_id)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 104}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MjgzNDYw", "url": "https://github.com/CMSgov/dpc-app/pull/555#pullrequestreview-347283460", "createdAt": "2020-01-23T13:12:02Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d9ed96cd003604997c11472ed552ca8432eadb5", "author": {"user": null}, "url": "https://github.com/CMSgov/dpc-app/commit/1d9ed96cd003604997c11472ed552ca8432eadb5", "committedDate": "2020-01-23T14:19:25Z", "message": "Update organization from web app to API\n\nUse FHIR client to update registered organizations in API\n\nAlso some cleanup from manual testing; remove delay in org creation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45f2e3c4044ced771b355f584523ab07ab86bedb", "author": {"user": null}, "url": "https://github.com/CMSgov/dpc-app/commit/45f2e3c4044ced771b355f584523ab07ab86bedb", "committedDate": "2020-01-23T14:19:40Z", "message": "Add fhir endpoint updating"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c967b52d25127a1f9a78e27f15e33b8566ad3030", "author": {"user": null}, "url": "https://github.com/CMSgov/dpc-app/commit/c967b52d25127a1f9a78e27f15e33b8566ad3030", "committedDate": "2020-01-23T14:19:40Z", "message": "Add payloadType to endpoint update request"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5231bfe9c0143c212c731c667522242ce9ff09e", "author": {"user": null}, "url": "https://github.com/CMSgov/dpc-app/commit/b5231bfe9c0143c212c731c667522242ce9ff09e", "committedDate": "2020-01-23T14:19:40Z", "message": "Add Endpoint.payloadType to Organization$submit\n\nThis field is required by FHIR but currently our API has a bug that\nskips validation of this field when creating an Endpoint. This commit\nadds the field and updates the test stubs.\n\nSee:\nhttps://hl7.org/fhir/STU3/endpoint-example.json.html\nhttps://dpc.cms.gov/ig/StructureDefinition-dpc-profile-endpoint-definitions.html"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a9744b191e21d995cba81049531309bd12cfa3e", "author": {"user": null}, "url": "https://github.com/CMSgov/dpc-app/commit/4a9744b191e21d995cba81049531309bd12cfa3e", "committedDate": "2020-01-23T14:19:40Z", "message": "Cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02dcf41aecfdf81b2b6a69625c7e22bd8e21679e", "author": {"user": null}, "url": "https://github.com/CMSgov/dpc-app/commit/02dcf41aecfdf81b2b6a69625c7e22bd8e21679e", "committedDate": "2020-01-23T14:19:41Z", "message": "Refactor for smaller APIClient class\n\nPull out FHIR resource building into a separate class.\n\nOne other cleanup fix in attribute method in organization_registrar\n\nMore cleanup from codeclimate recs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "074ac7d056f05e09757cf14d27592337f9154a91", "author": {"user": null}, "url": "https://github.com/CMSgov/dpc-app/commit/074ac7d056f05e09757cf14d27592337f9154a91", "committedDate": "2020-01-23T14:19:45Z", "message": "Refactor APIClient to separate org and endpoint\n\nOrg and endpint update requests should be separate methods because\nthey are separate interactions with the API."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "074ac7d056f05e09757cf14d27592337f9154a91", "author": {"user": null}, "url": "https://github.com/CMSgov/dpc-app/commit/074ac7d056f05e09757cf14d27592337f9154a91", "committedDate": "2020-01-23T14:19:45Z", "message": "Refactor APIClient to separate org and endpoint\n\nOrg and endpint update requests should be separate methods because\nthey are separate interactions with the API."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 220, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}