{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1MzI4MDUx", "number": 860, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNjozOTo1NlrOEGBYAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxODo0NzozMVrOEG3wXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NzQ5NDQyOnYy", "diffSide": "RIGHT", "path": "dpc-web/app/services/organization_search.rb", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNjozOTo1NlrOGkkCAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNjozOTo1NlrOGkkCAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk5MjI1Ng==", "bodyText": "Similar blocks of code found in 2 locations. Consider refactoring.", "url": "https://github.com/CMSgov/dpc-app/pull/860#discussion_r440992256", "createdAt": "2020-06-16T16:39:56Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/services/organization_search.rb", "diffHunk": "@@ -0,0 +1,80 @@\n+# frozen_string_literal: true\n+\n+class OrganizationSearch\n+  ALLOWED_SCOPES = %w[all provider vendor].freeze\n+\n+  attr_reader :params, :initial_scope\n+\n+  def initialize(params: {}, scope: 'all')\n+    scope = 'all'\n+\n+    @params = params\n+    @initial_scope = scope\n+  end\n+\n+  def results\n+    @results ||= query\n+  end\n+\n+  private\n+\n+  def query\n+    scope = Organization\n+\n+    scope = apply_org_queries(scope)\n+    scope = apply_date_queries(scope)\n+    scope = apply_keyword_search(scope)\n+\n+    scope\n+  end\n+\n+  def apply_org_queries(scope)\n+    # Check if registered org\n+    if params[:registered_org]\n+      radio = params[:registered_org]\n+\n+      if radio == 'registered'\n+        scope = scope.where('id IN(SELECT DISTINCT(organization_id) FROM registered_organizations)')\n+      elsif radio == 'unregistered'\n+        scope = scope.where('id NOT IN(SELECT DISTINCT(organization_id) FROM registered_organizations)')\n+      else\n+        scope = Organization\n+      end\n+    end\n+\n+    # Check if provider or vender\n+    if params[:org_type] == 'vendor'\n+      scope = scope.vendor\n+    elsif params[:org_type] == 'provider'\n+      scope = scope.provider\n+    end\n+\n+    # Check org type\n+    if params[:organization_type].present?\n+      scope = scope.where(organization_type: params[:organization_type])\n+    end\n+\n+    scope\n+  end\n+\n+  def apply_date_queries(scope)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4258e1c1ad412520b5d51a9513ba7383ff0e962d"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NzQ5NDQ1OnYy", "diffSide": "RIGHT", "path": "dpc-web/app/services/organization_search.rb", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNjozOTo1NlrOGkkCBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNjozOTo1NlrOGkkCBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk5MjI2MA==", "bodyText": "Argument scope was shadowed by a local variable before it was used.", "url": "https://github.com/CMSgov/dpc-app/pull/860#discussion_r440992260", "createdAt": "2020-06-16T16:39:56Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/services/organization_search.rb", "diffHunk": "@@ -0,0 +1,80 @@\n+# frozen_string_literal: true\n+\n+class OrganizationSearch\n+  ALLOWED_SCOPES = %w[all provider vendor].freeze\n+\n+  attr_reader :params, :initial_scope\n+\n+  def initialize(params: {}, scope: 'all')\n+    scope = 'all'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4258e1c1ad412520b5d51a9513ba7383ff0e962d"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NzQ5NDQ4OnYy", "diffSide": "RIGHT", "path": "dpc-web/app/services/organization_search.rb", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNjozOTo1NlrOGkkCBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNjozOTo1NlrOGkkCBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk5MjI2Mw==", "bodyText": "Cyclomatic complexity for apply_org_queries is too high. [7/6]", "url": "https://github.com/CMSgov/dpc-app/pull/860#discussion_r440992263", "createdAt": "2020-06-16T16:39:56Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/services/organization_search.rb", "diffHunk": "@@ -0,0 +1,80 @@\n+# frozen_string_literal: true\n+\n+class OrganizationSearch\n+  ALLOWED_SCOPES = %w[all provider vendor].freeze\n+\n+  attr_reader :params, :initial_scope\n+\n+  def initialize(params: {}, scope: 'all')\n+    scope = 'all'\n+\n+    @params = params\n+    @initial_scope = scope\n+  end\n+\n+  def results\n+    @results ||= query\n+  end\n+\n+  private\n+\n+  def query\n+    scope = Organization\n+\n+    scope = apply_org_queries(scope)\n+    scope = apply_date_queries(scope)\n+    scope = apply_keyword_search(scope)\n+\n+    scope\n+  end\n+\n+  def apply_org_queries(scope)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4258e1c1ad412520b5d51a9513ba7383ff0e962d"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NzQ5NDUwOnYy", "diffSide": "RIGHT", "path": "dpc-web/app/services/organization_search.rb", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNjozOTo1NlrOGkkCCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNjozOTo1NlrOGkkCCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk5MjI2NQ==", "bodyText": "Method has too many lines. [19/15]", "url": "https://github.com/CMSgov/dpc-app/pull/860#discussion_r440992265", "createdAt": "2020-06-16T16:39:56Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/services/organization_search.rb", "diffHunk": "@@ -0,0 +1,80 @@\n+# frozen_string_literal: true\n+\n+class OrganizationSearch\n+  ALLOWED_SCOPES = %w[all provider vendor].freeze\n+\n+  attr_reader :params, :initial_scope\n+\n+  def initialize(params: {}, scope: 'all')\n+    scope = 'all'\n+\n+    @params = params\n+    @initial_scope = scope\n+  end\n+\n+  def results\n+    @results ||= query\n+  end\n+\n+  private\n+\n+  def query\n+    scope = Organization\n+\n+    scope = apply_org_queries(scope)\n+    scope = apply_date_queries(scope)\n+    scope = apply_keyword_search(scope)\n+\n+    scope\n+  end\n+\n+  def apply_org_queries(scope)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4258e1c1ad412520b5d51a9513ba7383ff0e962d"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NzQ5NDUxOnYy", "diffSide": "RIGHT", "path": "dpc-web/app/services/organization_search.rb", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNjozOTo1NlrOGkkCDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNjozOTo1NlrOGkkCDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk5MjI2OA==", "bodyText": "Perceived complexity for apply_org_queries is too high. [9/7]", "url": "https://github.com/CMSgov/dpc-app/pull/860#discussion_r440992268", "createdAt": "2020-06-16T16:39:56Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/services/organization_search.rb", "diffHunk": "@@ -0,0 +1,80 @@\n+# frozen_string_literal: true\n+\n+class OrganizationSearch\n+  ALLOWED_SCOPES = %w[all provider vendor].freeze\n+\n+  attr_reader :params, :initial_scope\n+\n+  def initialize(params: {}, scope: 'all')\n+    scope = 'all'\n+\n+    @params = params\n+    @initial_scope = scope\n+  end\n+\n+  def results\n+    @results ||= query\n+  end\n+\n+  private\n+\n+  def query\n+    scope = Organization\n+\n+    scope = apply_org_queries(scope)\n+    scope = apply_date_queries(scope)\n+    scope = apply_keyword_search(scope)\n+\n+    scope\n+  end\n+\n+  def apply_org_queries(scope)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4258e1c1ad412520b5d51a9513ba7383ff0e962d"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NzY2Mjc1OnYy", "diffSide": "RIGHT", "path": "dpc-web/app/services/organization_search.rb", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNzoyNjo0NlrOGklvwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNzoyNjo0NlrOGklvwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAyMDM1NA==", "bodyText": "Use the return of the conditional for variable assignment and comparison.", "url": "https://github.com/CMSgov/dpc-app/pull/860#discussion_r441020354", "createdAt": "2020-06-16T17:26:46Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/services/organization_search.rb", "diffHunk": "@@ -0,0 +1,90 @@\n+# frozen_string_literal: true\n+\n+class OrganizationSearch\n+  ALLOWED_SCOPES = %w[all provider vendor].freeze\n+\n+  attr_reader :params, :initial_scope\n+\n+  def initialize(params: {}, scope: 'all')\n+    scope = 'all'\n+\n+    @params = params\n+    @initial_scope = scope\n+  end\n+\n+  def results\n+    @results ||= query\n+  end\n+\n+  private\n+\n+  def query\n+    scope = Organization\n+\n+    scope = apply_org_queries(scope)\n+    scope = apply_date_queries(scope)\n+    scope = apply_keyword_search(scope)\n+    scope = apply_search_word(scope)\n+\n+    scope\n+  end\n+\n+  def apply_org_queries(scope)\n+    # Check if registered org\n+    if params[:registered_org]\n+      radio = params[:registered_org]\n+\n+      if radio == 'registered'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d31e233a3034bed72f59ca01f37251a4255749a2"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0ODQ4NTI3OnYy", "diffSide": "RIGHT", "path": "dpc-web/app/services/organization_search.rb", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQyMTozMTo1OVrOGkt7Rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQyMTozMTo1OVrOGkt7Rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE1NDM3NQ==", "bodyText": "Method has too many lines. [16/15]", "url": "https://github.com/CMSgov/dpc-app/pull/860#discussion_r441154375", "createdAt": "2020-06-16T21:31:59Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/services/organization_search.rb", "diffHunk": "@@ -0,0 +1,73 @@\n+# frozen_string_literal: true\n+\n+class OrganizationSearch\n+  ALLOWED_SCOPES = %w[all provider vendor].freeze\n+\n+  attr_reader :params, :initial_scope\n+\n+  def initialize(params: {}, scope: 'all')\n+    scope = 'all' unless ALLOWED_SCOPES.include? scope\n+\n+    @params = params\n+    @initial_scope = scope\n+  end\n+\n+  def results\n+    @results ||= query\n+  end\n+\n+  private\n+\n+  def query\n+    scope = Organization.send(initial_scope)\n+\n+    scope = apply_org_queries(scope)\n+    scope = apply_date_queries(scope)\n+    scope = apply_keyword_search(scope)\n+\n+    scope\n+  end\n+\n+  def apply_org_queries(scope)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "917973c6b24911c101c07d39346ea1043f8c168e"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1NjQwNDEzOnYy", "diffSide": "RIGHT", "path": "dpc-web/app/controllers/internal/organizations_controller.rb", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxODo0NzozMVrOGl749g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxOToyMzoyOVrOGl9ByQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzMTczNA==", "bodyText": "Do we need to filter here which parameters we accept, to be consistent with #843 ?", "url": "https://github.com/CMSgov/dpc-app/pull/860#discussion_r442431734", "createdAt": "2020-06-18T18:47:31Z", "author": {"login": "dhgreene"}, "path": "dpc-web/app/controllers/internal/organizations_controller.rb", "diffHunk": "@@ -5,22 +5,9 @@ class OrganizationsController < ApplicationController\n     before_action :authenticate_internal_user!\n \n     def index\n-      scope = if params[:org_type] == 'vendor'\n-                Organization.vendor\n-              elsif params[:org_type] == 'provider'\n-                Organization.provider\n-              else\n-                Organization.all\n-              end\n-\n-      if keyword_param[:keyword].present?\n-        keyword = \"%#{keyword_param[:keyword].downcase}%\"\n-        scope = scope.where(\n-          'LOWER(name) LIKE :keyword', keyword: keyword\n-        )\n-      end\n+      results = BaseSearch.new(params: params, scope: params[:org_type]).results\n \n-      @organizations = scope.page params[:page]\n+      @organizations = results.page params[:page]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5c1f049b11edab154666c40a719f2ae4043ef23"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ0NTg4Mw==", "bodyText": "What do you think @SMLuthi ?", "url": "https://github.com/CMSgov/dpc-app/pull/860#discussion_r442445883", "createdAt": "2020-06-18T19:14:19Z", "author": {"login": "Sun-Mountain"}, "path": "dpc-web/app/controllers/internal/organizations_controller.rb", "diffHunk": "@@ -5,22 +5,9 @@ class OrganizationsController < ApplicationController\n     before_action :authenticate_internal_user!\n \n     def index\n-      scope = if params[:org_type] == 'vendor'\n-                Organization.vendor\n-              elsif params[:org_type] == 'provider'\n-                Organization.provider\n-              else\n-                Organization.all\n-              end\n-\n-      if keyword_param[:keyword].present?\n-        keyword = \"%#{keyword_param[:keyword].downcase}%\"\n-        scope = scope.where(\n-          'LOWER(name) LIKE :keyword', keyword: keyword\n-        )\n-      end\n+      results = BaseSearch.new(params: params, scope: params[:org_type]).results\n \n-      @organizations = scope.page params[:page]\n+      @organizations = results.page params[:page]", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzMTczNA=="}, "originalCommit": {"oid": "f5c1f049b11edab154666c40a719f2ae4043ef23"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ0NzA4OQ==", "bodyText": "I could put results.page page[:params] in a private method like org_page_params(results)", "url": "https://github.com/CMSgov/dpc-app/pull/860#discussion_r442447089", "createdAt": "2020-06-18T19:16:49Z", "author": {"login": "Sun-Mountain"}, "path": "dpc-web/app/controllers/internal/organizations_controller.rb", "diffHunk": "@@ -5,22 +5,9 @@ class OrganizationsController < ApplicationController\n     before_action :authenticate_internal_user!\n \n     def index\n-      scope = if params[:org_type] == 'vendor'\n-                Organization.vendor\n-              elsif params[:org_type] == 'provider'\n-                Organization.provider\n-              else\n-                Organization.all\n-              end\n-\n-      if keyword_param[:keyword].present?\n-        keyword = \"%#{keyword_param[:keyword].downcase}%\"\n-        scope = scope.where(\n-          'LOWER(name) LIKE :keyword', keyword: keyword\n-        )\n-      end\n+      results = BaseSearch.new(params: params, scope: params[:org_type]).results\n \n-      @organizations = scope.page params[:page]\n+      @organizations = results.page params[:page]", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzMTczNA=="}, "originalCommit": {"oid": "f5c1f049b11edab154666c40a719f2ae4043ef23"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ1MDM3Nw==", "bodyText": "I just did it :)", "url": "https://github.com/CMSgov/dpc-app/pull/860#discussion_r442450377", "createdAt": "2020-06-18T19:23:29Z", "author": {"login": "Sun-Mountain"}, "path": "dpc-web/app/controllers/internal/organizations_controller.rb", "diffHunk": "@@ -5,22 +5,9 @@ class OrganizationsController < ApplicationController\n     before_action :authenticate_internal_user!\n \n     def index\n-      scope = if params[:org_type] == 'vendor'\n-                Organization.vendor\n-              elsif params[:org_type] == 'provider'\n-                Organization.provider\n-              else\n-                Organization.all\n-              end\n-\n-      if keyword_param[:keyword].present?\n-        keyword = \"%#{keyword_param[:keyword].downcase}%\"\n-        scope = scope.where(\n-          'LOWER(name) LIKE :keyword', keyword: keyword\n-        )\n-      end\n+      results = BaseSearch.new(params: params, scope: params[:org_type]).results\n \n-      @organizations = scope.page params[:page]\n+      @organizations = results.page params[:page]", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzMTczNA=="}, "originalCommit": {"oid": "f5c1f049b11edab154666c40a719f2ae4043ef23"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 171, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}