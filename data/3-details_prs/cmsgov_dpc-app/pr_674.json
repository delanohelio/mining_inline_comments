{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1NjcyOTI5", "number": 674, "title": "Fix: Stuck jobs are unable to be restarted due to SQL constraint exception", "bodyText": "Why\nStuck jobs are failing with the exception:\nCaused by: org.postgresql.util.PSQLException: ERROR: null value in column \"batch_id\" violates not-null constraint\n\nWhat Changed\n\nAdds a unit test to reproduce this issue\nAdds additional flags on the Hibernate relationship to instruct Hibernate how to delete the object during a cascade (https://stackoverflow.com/questions/25455280/hibernate-cascade-delete-for-one-to-many-call-sql-update-instead-of-delete)\n\nChoices Made\nTickets closed:\nDPC-1171: One of many fixes related to this issue\nFuture Work\nChecklist\n\n All tests are passing via make ci-app (app change) and make ci-web (website change)\n Swagger documentation has been updated\n FHIR documentation has been updated\n Any required dpc-ops changes have a PR submitted and mentioned in this ticket\n Any manual migration steps are documented, scripts written (where applicable), and tested\n Before merging, any required dpc-ops changes have been approved and merged into master of the dpc-ops repo", "createdAt": "2020-03-09T15:59:17Z", "url": "https://github.com/CMSgov/dpc-app/pull/674", "merged": true, "mergeCommit": {"oid": "72e9eb0ab1a98d4963f70c89bb83bb394eae26c2"}, "closed": true, "closedAt": "2020-03-09T20:42:04Z", "author": {"login": "ronaldheft-usds"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMAEX4gH2gAyMzg1NjcyOTI5OmQwMjBhYzdlOTZhNzA2MWI3MGQ5ZmI2NzU0ZjllMDRhNjJhNzRjMDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMD_fLAFqTM3MTUwNjA0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d020ac7e96a7061b70d9fb6754f9e04a62a74c08", "author": {"user": {"login": "ronaldheft-usds", "name": "Ron Heft"}}, "url": "https://github.com/CMSgov/dpc-app/commit/d020ac7e96a7061b70d9fb6754f9e04a62a74c08", "committedDate": "2020-03-09T15:57:57Z", "message": "Reproduce stuck job issue as a unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "644b0a7b967830c922a6a65ddf75eae3d2e69c9b", "author": {"user": {"login": "ronaldheft-usds", "name": "Ron Heft"}}, "url": "https://github.com/CMSgov/dpc-app/commit/644b0a7b967830c922a6a65ddf75eae3d2e69c9b", "committedDate": "2020-03-09T16:33:52Z", "message": "Update unit test to match reality for how jobs are re-claimed after being stuck"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d249a823274cc6db187fae1e12302d923bf8fb09", "author": {"user": {"login": "ronaldheft-usds", "name": "Ron Heft"}}, "url": "https://github.com/CMSgov/dpc-app/commit/d249a823274cc6db187fae1e12302d923bf8fb09", "committedDate": "2020-03-09T16:34:53Z", "message": "Add flags onto @JoinColumn to fix Hibernate's delete and update behavior"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNTA2MDQ0", "url": "https://github.com/CMSgov/dpc-app/pull/674#pullrequestreview-371506044", "createdAt": "2020-03-09T20:29:58Z", "commit": {"oid": "d249a823274cc6db187fae1e12302d923bf8fb09"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMDoyOTo1OFrOFz4QNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMDoyOTo1OFrOFz4QNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk0MzM0OA==", "bodyText": "Would it be possible to use a public constant from the distributed queue module instead of a hardcoded 15 minutes?", "url": "https://github.com/CMSgov/dpc-app/pull/674#discussion_r389943348", "createdAt": "2020-03-09T20:29:58Z", "author": {"login": "RickHawesUSDS"}, "path": "dpc-queue/src/test/java/gov/cms/dpc/queue/DistributedBatchQueueTest.java", "diffHunk": "@@ -0,0 +1,110 @@\n+package gov.cms.dpc.queue;\n+\n+import com.codahale.metrics.MetricRegistry;\n+import gov.cms.dpc.common.hibernate.queue.DPCQueueManagedSessionFactory;\n+import gov.cms.dpc.queue.models.JobQueueBatch;\n+import gov.cms.dpc.testing.BufferedLoggerHandler;\n+import org.hibernate.Session;\n+import org.hibernate.SessionFactory;\n+import org.hibernate.Transaction;\n+import org.hibernate.cfg.Configuration;\n+import org.hl7.fhir.dstu3.model.ResourceType;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import java.time.OffsetDateTime;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.UUID;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+@ExtendWith(BufferedLoggerHandler.class)\n+public class DistributedBatchQueueTest {\n+\n+    private final UUID aggregatorID = UUID.randomUUID();\n+    private SessionFactory sessionFactory;\n+    private DistributedBatchQueue queue;\n+\n+    @BeforeEach\n+    void setUp() {\n+        final Configuration conf = new Configuration();\n+        sessionFactory = conf.configure().buildSessionFactory();\n+        queue = new DistributedBatchQueue(new DPCQueueManagedSessionFactory(sessionFactory), 100, new MetricRegistry());\n+    }\n+\n+    @AfterEach\n+    void shutdown() {\n+        try (final Session session = sessionFactory.openSession()) {\n+            final Transaction tx = session.beginTransaction();\n+            try {\n+                session.createQuery(\"delete from job_queue_batch_file\").executeUpdate();\n+                session.createQuery(\"delete from job_queue_batch\").executeUpdate();\n+            } finally {\n+                tx.commit();\n+            }\n+        }\n+        sessionFactory.close();\n+    }\n+\n+    @Test\n+    void handleStuckBatchWithClaim() {\n+        // One organization id for both jobs\n+        final UUID orgID = UUID.randomUUID();\n+\n+        // Add a job\n+        var jobID = queue.createJob(orgID, \"test-provider-1\", List.of(\"test-patient-1\", \"test-patient-2\"), Collections.singletonList(ResourceType.Patient));\n+\n+        // Work the job\n+        Optional<JobQueueBatch> workBatch = queue.claimBatch(aggregatorID);\n+        assertTrue(workBatch.isPresent(), \"Should have a job to work\");\n+        final UUID firstBatchID = workBatch.orElseThrow().getBatchID();\n+\n+        // Add a file on the batch\n+        workBatch.get().addJobQueueFile(ResourceType.Patient, 0, 1);\n+        queue.completePartialBatch(workBatch.get(), aggregatorID);\n+\n+        // Check that the persisted job is RUNNING\n+        final Optional<JobQueueBatch> runningJobOptional = queue.getBatch(firstBatchID);\n+        assertTrue(runningJobOptional.isPresent(), \"Should have a running job\");\n+        runningJobOptional.ifPresent(runningJob -> {\n+            assertEquals(JobStatus.RUNNING, runningJob.getStatus(), \"Should be in the RUNNING state\");\n+            assertEquals(1, runningJob.getJobQueueBatchFiles().size(), \"Should have 1 file on the running job\");\n+            assertTrue(runningJob.getJobQueueFile(ResourceType.Patient).isPresent(), \"Should have a patient job file\");\n+        });\n+\n+        // Simulate a stuck job by modifying the update_time\n+        try (final Session session = sessionFactory.openSession()) {\n+            final Transaction tx = session.beginTransaction();\n+            try {\n+                session.createQuery(\"update job_queue_batch set updateTime = :updateTime where jobID = :jobID\")\n+                        .setParameter(\"jobID\", jobID)\n+                        .setParameter(\"updateTime\", OffsetDateTime.now().minusMinutes(15))\n+                        .executeUpdate();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d249a823274cc6db187fae1e12302d923bf8fb09"}, "originalPosition": 86}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 180, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}