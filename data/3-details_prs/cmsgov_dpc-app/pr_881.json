{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwMTM2MjY5", "number": 881, "title": "DPC-148 & 362: Simplify web app for one environment", "bodyText": "Fixes DPC-148 & DPC-362\n\nProposed Changes\nRemove code specific to one single environment from the codebase.\nChange Details\nAt one point the web-app was to be designed to be run in multiple environments (and be able to switch between them at runtime). This idea was scrapped but legacy code endures that supports this implementation. This code needs to be ripped out and streamlined so that the web-app functions only within one environment at run time.\nSecurity Implications\nNone\nAcceptance Validation\n\n\nFeedback Requested", "createdAt": "2020-06-25T16:38:21Z", "url": "https://github.com/CMSgov/dpc-app/pull/881", "merged": true, "mergeCommit": {"oid": "0071cd358fa82bae95533f204affe78940538a79"}, "closed": true, "closedAt": "2020-07-01T16:52:03Z", "author": {"login": "SMLuthi"}, "timelineItems": {"totalCount": 47, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuejnRgH2gAyNDQwMTM2MjY5OjFmMDcxZjUxMDM4NmFmYTgwZmRlNjNmNjZhYjJlZThmYTFiMjQ2MDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwsxa5gFqTQ0MTAyMTU0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1f071f510386afa80fde63f66ab2ee8fa1b24607", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/1f071f510386afa80fde63f66ab2ee8fa1b24607", "committedDate": "2020-06-24T18:42:39Z", "message": "Remove api_env column from registered_organization table"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00453faa3b9f93e81e77e54f926c39f794ec084e", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/00453faa3b9f93e81e77e54f926c39f794ec084e", "committedDate": "2020-06-24T18:55:46Z", "message": "Remove mention of api_env from client token controller"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef5fa989b27faa54e69ba159864996286635d572", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/ef5fa989b27faa54e69ba159864996286635d572", "committedDate": "2020-06-24T18:56:34Z", "message": "Remove mention of api_env from internal organization controller"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9da63c1312d861c36c19a3e016f158f7f938655c", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/9da63c1312d861c36c19a3e016f158f7f938655c", "committedDate": "2020-06-24T18:58:50Z", "message": "Remove mention of api_env from internal registered org controller and update new/create endpoints to build a singular reg org entry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25cffb5cc902ee14fcc1d79218ea0167d1b08fbb", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/25cffb5cc902ee14fcc1d79218ea0167d1b08fbb", "committedDate": "2020-06-24T18:59:54Z", "message": "Remove mention of api_env from public keys controller"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa46fb1b1b7793c8d01bfe56129082b7ab56590c", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/fa46fb1b1b7793c8d01bfe56129082b7ab56590c", "committedDate": "2020-06-24T19:01:26Z", "message": "Update organization model to have has_one instead of has_many registered orgs. Remove env specific logic and remove usage of api_env."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f3453f08505aeff361bf2ebaa8db88de8434c4a", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/4f3453f08505aeff361bf2ebaa8db88de8434c4a", "committedDate": "2020-06-24T19:05:51Z", "message": "Update sandbox check for org user assignment model to use new method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "876c1aebe620badae3583f5fe4129b43277a98a9", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/876c1aebe620badae3583f5fe4129b43277a98a9", "committedDate": "2020-06-24T19:07:13Z", "message": "Update registerd organization model to remove usage of api_env. Dry out APIClient service creation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ac1723ae701c2ddad8a9fcecfb90a596b3e82a1", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/7ac1723ae701c2ddad8a9fcecfb90a596b3e82a1", "committedDate": "2020-06-24T19:08:33Z", "message": "Update apiclient to remove usage of api_env."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92e81b74d3db4e5539a1b3a0b8e94a164581fe3d", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/92e81b74d3db4e5539a1b3a0b8e94a164581fe3d", "committedDate": "2020-06-24T19:09:01Z", "message": "Update client token manager service to remove usage of api_env"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da8954d6ee064bedfabd217b35b014fe489e2cb4", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/da8954d6ee064bedfabd217b35b014fe489e2cb4", "committedDate": "2020-06-24T19:09:28Z", "message": "Update public key manager service to remove usage of api_env"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36a23c095ccbae650faa454d5d6d53d92685527a", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/36a23c095ccbae650faa454d5d6d53d92685527a", "committedDate": "2020-06-24T19:10:11Z", "message": "Update show.thml.erb in organizations to use new prod_sbx check than old sandbox_enabled check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afe56a882047f880728c0fe7596754d0e14790c7", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/afe56a882047f880728c0fe7596754d0e14790c7", "committedDate": "2020-06-24T20:47:08Z", "message": "Init view work\n\nChange external user views."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17cb762aab29a7ccb5f0908dd525003cf0cc94d5", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/17cb762aab29a7ccb5f0908dd525003cf0cc94d5", "committedDate": "2020-06-24T21:28:48Z", "message": "Progress"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "117c44b7cc14b5c167128bb695dde315b608abdc", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/117c44b7cc14b5c167128bb695dde315b608abdc", "committedDate": "2020-06-24T22:49:34Z", "message": "View progress"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c11dacad42a13bd2f2d21ddbb7e307f567640f2b", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/c11dacad42a13bd2f2d21ddbb7e307f567640f2b", "committedDate": "2020-06-24T22:54:20Z", "message": "Enabled in API label added"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db32e2cb392541ac67f114acbc566be6e8c2bd43", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/db32e2cb392541ac67f114acbc566be6e8c2bd43", "committedDate": "2020-06-25T13:07:47Z", "message": "Public key manager spec"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a120fa4e806f60766977387e03b9039496e49838", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/a120fa4e806f60766977387e03b9039496e49838", "committedDate": "2020-06-25T14:17:44Z", "message": "Organization model spec"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b179f6d3b5c59aafbf78b52be1985a79f198e7c", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/0b179f6d3b5c59aafbf78b52be1985a79f198e7c", "committedDate": "2020-06-25T14:30:28Z", "message": "Registered organization spec progress"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NjcxODc0", "url": "https://github.com/CMSgov/dpc-app/pull/881#pullrequestreview-437671874", "createdAt": "2020-06-25T16:40:45Z", "commit": {"oid": "0b179f6d3b5c59aafbf78b52be1985a79f198e7c"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNjo0MDo0NVrOGpC93w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNjo0MDo0NlrOGpC95w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY5MzQwNw==", "bodyText": "Useless assignment to variable - reg_org.", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445693407", "createdAt": "2020-06-25T16:40:45Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/models/organization.rb", "diffHunk": "@@ -71,34 +63,20 @@ def prod_sbx?\n     ENV['ENV'] == 'prod-sbx'\n   end\n \n-  def update_registered_organizations\n+  def update_registered_organization\n     return unless npi.present? || sandbox_id.present?\n \n-    registered_organizations.each(&:update_api_organization)\n-  end\n-\n-  def sandbox_enabled?\n-    sandbox_registered_organization.present?\n-  end\n-\n-  def sandbox_registered_organization\n-    registered_organizations.find_by(api_env: 'sandbox')\n-  end\n-\n-  def sandbox_fhir_endpoint\n-    sandbox_registered_organization.fhir_endpoint\n-  end\n-\n-  def production_enabled?\n-    production_registered_organization.present?\n+    registered_organization.update_api_organization\n   end\n \n-  def production_registered_organization\n-    registered_organizations.find_by(api_env: 'production')\n+  def reg_org\n+    if registered_organization.present?\n+      return reg_org = registered_organization", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b179f6d3b5c59aafbf78b52be1985a79f198e7c"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY5MzQwOQ==", "bodyText": "Use a guard clause instead of wrapping the code inside a conditional expression.", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445693409", "createdAt": "2020-06-25T16:40:46Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/models/organization.rb", "diffHunk": "@@ -71,34 +63,20 @@ def prod_sbx?\n     ENV['ENV'] == 'prod-sbx'\n   end\n \n-  def update_registered_organizations\n+  def update_registered_organization\n     return unless npi.present? || sandbox_id.present?\n \n-    registered_organizations.each(&:update_api_organization)\n-  end\n-\n-  def sandbox_enabled?\n-    sandbox_registered_organization.present?\n-  end\n-\n-  def sandbox_registered_organization\n-    registered_organizations.find_by(api_env: 'sandbox')\n-  end\n-\n-  def sandbox_fhir_endpoint\n-    sandbox_registered_organization.fhir_endpoint\n-  end\n-\n-  def production_enabled?\n-    production_registered_organization.present?\n+    registered_organization.update_api_organization\n   end\n \n-  def production_registered_organization\n-    registered_organizations.find_by(api_env: 'production')\n+  def reg_org\n+    if registered_organization.present?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b179f6d3b5c59aafbf78b52be1985a79f198e7c"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY5MzQxMQ==", "bodyText": "Redundant return detected.", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445693411", "createdAt": "2020-06-25T16:40:46Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/models/organization.rb", "diffHunk": "@@ -71,34 +63,20 @@ def prod_sbx?\n     ENV['ENV'] == 'prod-sbx'\n   end\n \n-  def update_registered_organizations\n+  def update_registered_organization\n     return unless npi.present? || sandbox_id.present?\n \n-    registered_organizations.each(&:update_api_organization)\n-  end\n-\n-  def sandbox_enabled?\n-    sandbox_registered_organization.present?\n-  end\n-\n-  def sandbox_registered_organization\n-    registered_organizations.find_by(api_env: 'sandbox')\n-  end\n-\n-  def sandbox_fhir_endpoint\n-    sandbox_registered_organization.fhir_endpoint\n-  end\n-\n-  def production_enabled?\n-    production_registered_organization.present?\n+    registered_organization.update_api_organization\n   end\n \n-  def production_registered_organization\n-    registered_organizations.find_by(api_env: 'production')\n+  def reg_org\n+    if registered_organization.present?\n+      return reg_org = registered_organization", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b179f6d3b5c59aafbf78b52be1985a79f198e7c"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY5MzQxMw==", "bodyText": "Prefer single-quoted strings when you don't need string interpolation or special symbols.", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445693413", "createdAt": "2020-06-25T16:40:46Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/controllers/internal/registered_organizations_controller.rb", "diffHunk": "@@ -17,49 +16,45 @@ def new\n \n     def create\n       @organization = Organization.find(org_id_param)\n-      @registered_organization = @organization.registered_organizations\n-                                              .build(registered_organization_params)\n-      @api_env = params[:api_env] || @registered_organization.api_env\n+      @registered_organization = @organization.build_registered_organization(registered_organization_params)\n \n       if @registered_organization.save\n-        flash[:notice] = \"Access to #{@registered_organization.api_env} enabled.\"\n+        flash[:notice] = \"Organization has been enabled.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b179f6d3b5c59aafbf78b52be1985a79f198e7c"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY5MzQxNQ==", "bodyText": "Prefer single-quoted strings when you don't need string interpolation or special symbols.", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445693415", "createdAt": "2020-06-25T16:40:46Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/controllers/internal/registered_organizations_controller.rb", "diffHunk": "@@ -17,49 +16,45 @@ def new\n \n     def create\n       @organization = Organization.find(org_id_param)\n-      @registered_organization = @organization.registered_organizations\n-                                              .build(registered_organization_params)\n-      @api_env = params[:api_env] || @registered_organization.api_env\n+      @registered_organization = @organization.build_registered_organization(registered_organization_params)\n \n       if @registered_organization.save\n-        flash[:notice] = \"Access to #{@registered_organization.api_env} enabled.\"\n+        flash[:notice] = \"Organization has been enabled.\"\n         redirect_to internal_organization_path(@organization)\n       else\n-        flash[:alert] = \"Access to #{@registered_organization.api_env} could not be enabled:\n+        flash[:alert] = \"Organization could not be enabled:\n                         #{model_error_string(@registered_organization)}.\"\n         render :new\n       end\n     end\n \n     def edit\n-      @api_env = params[:api_env]\n       @organization = Organization.find(org_id_param)\n-      @registered_organization = @organization.registered_organizations.find(params[:id])\n+      @registered_organization = @organization.registered_organization\n     end\n \n     def update\n       @organization = Organization.find(org_id_param)\n-      @registered_organization = @organization.registered_organizations.find(params[:id])\n-      @api_env = @registered_organization.api_env\n+      @registered_organization = @organization.registered_organization\n \n       if @registered_organization.update(registered_organization_params)\n-        flash[:notice] = \"#{@registered_organization.api_env.capitalize} access updated.\"\n+        flash[:notice] = \"Organization access updated.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b179f6d3b5c59aafbf78b52be1985a79f198e7c"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NjcyMjYy", "url": "https://github.com/CMSgov/dpc-app/pull/881#pullrequestreview-437672262", "createdAt": "2020-06-25T16:41:14Z", "commit": {"oid": "0b179f6d3b5c59aafbf78b52be1985a79f198e7c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNjo0MToxNFrOGpC_BA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNjo0MToxNVrOGpC_Cw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY5MzcwMA==", "bodyText": "Prefer single-quoted strings when you don't need string interpolation or special symbols.", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445693700", "createdAt": "2020-06-25T16:41:14Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/controllers/internal/registered_organizations_controller.rb", "diffHunk": "@@ -17,49 +16,45 @@ def new\n \n     def create\n       @organization = Organization.find(org_id_param)\n-      @registered_organization = @organization.registered_organizations\n-                                              .build(registered_organization_params)\n-      @api_env = params[:api_env] || @registered_organization.api_env\n+      @registered_organization = @organization.build_registered_organization(registered_organization_params)\n \n       if @registered_organization.save\n-        flash[:notice] = \"Access to #{@registered_organization.api_env} enabled.\"\n+        flash[:notice] = \"Organization has been enabled.\"\n         redirect_to internal_organization_path(@organization)\n       else\n-        flash[:alert] = \"Access to #{@registered_organization.api_env} could not be enabled:\n+        flash[:alert] = \"Organization could not be enabled:\n                         #{model_error_string(@registered_organization)}.\"\n         render :new\n       end\n     end\n \n     def edit\n-      @api_env = params[:api_env]\n       @organization = Organization.find(org_id_param)\n-      @registered_organization = @organization.registered_organizations.find(params[:id])\n+      @registered_organization = @organization.registered_organization\n     end\n \n     def update\n       @organization = Organization.find(org_id_param)\n-      @registered_organization = @organization.registered_organizations.find(params[:id])\n-      @api_env = @registered_organization.api_env\n+      @registered_organization = @organization.registered_organization\n \n       if @registered_organization.update(registered_organization_params)\n-        flash[:notice] = \"#{@registered_organization.api_env.capitalize} access updated.\"\n+        flash[:notice] = \"Organization access updated.\"\n         redirect_to internal_organization_path(@organization)\n       else\n-        flash[:alert] = \"#{@registered_organization.api_env.capitalize} access could not be\n+        flash[:alert] = \"Organization access could not be\n                         updated: #{model_error_string(@registered_organization)}.\"\n         render :edit\n       end\n     end\n \n     def destroy\n       @organization = Organization.find(org_id_param)\n-      @registered_organization = @organization.registered_organizations.find(params[:id])\n+      @registered_organization = @organization.registered_organization\n \n       if @registered_organization.destroy\n-        flash[:notice] = \"#{@registered_organization.api_env.capitalize} access disabled.\"\n+        flash[:notice] = \"Organization access disabled.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b179f6d3b5c59aafbf78b52be1985a79f198e7c"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY5MzcwNw==", "bodyText": "Prefer single-quoted strings when you don't need string interpolation or special symbols.", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445693707", "createdAt": "2020-06-25T16:41:15Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -110,7 +103,7 @@ def delegated_macaroon(reg_org_api_id)\n   end\n \n   def golden_macaroon\n-    @golden_macaroon ||= ENV.fetch(\"GOLDEN_MACAROON_#{api_env.upcase}\")\n+    @golden_macaroon ||= ENV.fetch(\"GOLDEN_MACAROON_SANDBOX\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b179f6d3b5c59aafbf78b52be1985a79f198e7c"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc64b89fa3930aad371f3d55fd205294664fa095", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/cc64b89fa3930aad371f3d55fd205294664fa095", "committedDate": "2020-06-25T16:43:50Z", "message": "Fix broken tests for registerd org controller"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb22bc95eded1b3fec12a4424b898c028c13d656", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/fb22bc95eded1b3fec12a4424b898c028c13d656", "committedDate": "2020-06-25T17:02:25Z", "message": "Updated organization update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d129ef7e6e88e1c543d306d67214733ad3b3ec0", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/2d129ef7e6e88e1c543d306d67214733ad3b3ec0", "committedDate": "2020-06-25T17:02:35Z", "message": "Merge branch 'DPC-148-simplify-web-app-for-one-env' of github.com:CMSgov/dpc-app into DPC-148-simplify-web-app-for-one-env"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05443cdd012611d315c84b743062f199822a0baf", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/05443cdd012611d315c84b743062f199822a0baf", "committedDate": "2020-06-25T17:05:38Z", "message": "Updating user org send sandbox email"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4675f7a0d8cb3a63288bcc9a1095c01f8795c465", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/4675f7a0d8cb3a63288bcc9a1095c01f8795c465", "committedDate": "2020-06-25T19:26:42Z", "message": "Organization_User_Assignment Spec"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b617151d135f085665b58e8dc9240bf8ba1dcc81", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/b617151d135f085665b58e8dc9240bf8ba1dcc81", "committedDate": "2020-06-25T19:36:06Z", "message": "Make reg_org short circuit call in org model"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf590f28a17f29ae694d5421353291fdc6bb5b91", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/cf590f28a17f29ae694d5421353291fdc6bb5b91", "committedDate": "2020-06-25T19:36:32Z", "message": "Update tests for registered org specs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c74bb76f93ac6e35aab8637fc2c3d35c677938b3", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/c74bb76f93ac6e35aab8637fc2c3d35c677938b3", "committedDate": "2020-06-25T19:49:39Z", "message": "Fix cloudwatch issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "649cac55cda40c51a44143f0123b40bc8d3dce67", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/649cac55cda40c51a44143f0123b40bc8d3dce67", "committedDate": "2020-06-25T20:04:07Z", "message": "Fix tests in client token controller spec"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ff893793c693c49eed8d0dfdc2c1538f997b4e7", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/9ff893793c693c49eed8d0dfdc2c1538f997b4e7", "committedDate": "2020-06-25T20:05:34Z", "message": "Creating & Updating Organizations Spec"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62d36d13ef312b1bfbbf7c4a862203028abd64da", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/62d36d13ef312b1bfbbf7c4a862203028abd64da", "committedDate": "2020-06-25T20:05:43Z", "message": "Merge branch 'DPC-148-simplify-web-app-for-one-env' of github.com:CMSgov/dpc-app into DPC-148-simplify-web-app-for-one-env"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fcceaeaa0ce09e797d54376a0769c24907c5e25", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/9fcceaeaa0ce09e797d54376a0769c24907c5e25", "committedDate": "2020-06-25T20:12:03Z", "message": "Client token manager spec"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75d843fcb78fd3d789fbea39adb3ecacfee92002", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/75d843fcb78fd3d789fbea39adb3ecacfee92002", "committedDate": "2020-06-25T20:15:32Z", "message": "Managing API credentials spec"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a5e31e5f7c33bd732c304e724a3004f6983a9bd", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/6a5e31e5f7c33bd732c304e724a3004f6983a9bd", "committedDate": "2020-06-25T20:33:39Z", "message": "Update api client spec tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a46687a9df6a1e11c7a7766f3b5730676814c42", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/4a46687a9df6a1e11c7a7766f3b5730676814c42", "committedDate": "2020-06-25T20:36:53Z", "message": "Merge branch 'master' into DPC-148-simplify-web-app-for-one-env"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3ODU0Mzc0", "url": "https://github.com/CMSgov/dpc-app/pull/881#pullrequestreview-437854374", "createdAt": "2020-06-25T20:59:31Z", "commit": {"oid": "4a46687a9df6a1e11c7a7766f3b5730676814c42"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQyMDo1OTozMVrOGpLmUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQyMToyMjoyMlrOGpMQQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTgzNDgzNQ==", "bodyText": "Names with \"sandbox\" in them retain the old view of the app--in this case, that we need to differentiate sandbox-related emails from, say, prod-related emails.  How hard is it to rename this method and the tests that call it?", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445834835", "createdAt": "2020-06-25T20:59:31Z", "author": {"login": "dhgreene"}, "path": "dpc-web/spec/models/organization_user_assignment_spec.rb", "diffHunk": "@@ -3,13 +3,18 @@\n require 'rails_helper'\n \n RSpec.describe OrganizationUserAssignment, type: :model do\n+  include APIClientSupport\n+\n   describe 'callbacks' do\n     describe '#send_organization_sandbox_email' do", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a46687a9df6a1e11c7a7766f3b5730676814c42"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTgzNTY3NQ==", "bodyText": "Do we still need this property (and a test for it), since we're now automatically allowing all new sandbox users?  I see references to :sandbox_enabled? being replaced with :api_enabled?.", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445835675", "createdAt": "2020-06-25T21:01:09Z", "author": {"login": "dhgreene"}, "path": "dpc-web/spec/models/organization_user_assignment_spec.rb", "diffHunk": "@@ -3,13 +3,18 @@\n require 'rails_helper'\n \n RSpec.describe OrganizationUserAssignment, type: :model do\n+  include APIClientSupport\n+\n   describe 'callbacks' do\n     describe '#send_organization_sandbox_email' do\n       it 'sends email if org is sandbox_enabled' do", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a46687a9df6a1e11c7a7766f3b5730676814c42"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTgzOTU5Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  Enable PI access for <%= @organization.name %>\n          \n          \n            \n                  Enable API access for <%= @organization.name %>", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445839596", "createdAt": "2020-06-25T21:09:25Z", "author": {"login": "dhgreene"}, "path": "dpc-web/app/views/internal/registered_organizations/new.html.erb", "diffHunk": "@@ -3,8 +3,8 @@\n <div class=\"ds-l-container ds-u-padding-x--0\">\n   <section class=\"ds-u-display--flex ds-u-justify-content--between ds-u-align-items--center\">\n \n-    <h1 class=\"ds-u-font-size--title ds-u-font-weight--normal ds-u-margin--0\" data-test=\"new-reg-org-<%= @registered_organization.api_env %>\">\n-      Enable <%= @api_env.capitalize %> API access for <%= @organization.name %>\n+    <h1 class=\"ds-u-font-size--title ds-u-font-weight--normal ds-u-margin--0\" data-test=\"new-reg-org\" >\n+      Enable PI access for <%= @organization.name %>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a46687a9df6a1e11c7a7766f3b5730676814c42"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg0MTUwNA==", "bodyText": "We don't have a web app for pilot", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445841504", "createdAt": "2020-06-25T21:13:32Z", "author": {"login": "dhgreene"}, "path": "dpc-web/app/views/dashboard/_assigned_content.html.erb", "diffHunk": "@@ -1,4 +1,11 @@\n-<p class=\"ds-text--lead ds-u-measure--wide ds-u-margin-top--2\">Welcome to the Data at the Point of Care Pilot. You have been assigned to the organizations below to start using the APIs in a synthetic, or test, sandbox. <strong>Remember</strong>, do NOT add any real patient information to the sandbox environment. </p>\n+<p class=\"ds-text--lead ds-u-measure--wide ds-u-margin-top--2\">\n+  <% if prod_sbx? %>\n+    Welcome to the Data at the Point of Care Sandbox. You have been assigned to the organizations below to start using the APIs in a synthetic, or test, sandbox. <strong>Remember</strong>, do NOT add any real patient information to the sandbox environment.\n+  <% else %>\n+    <%# Need to speak with Product/H Team about welcome for pilot %>\n+    Welcome to the Data at the Point of Care Pilot.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a46687a9df6a1e11c7a7766f3b5730676814c42"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg0MTk5Ng==", "bodyText": "Is it worth renaming this to GOLDEN_MACAROON?  It would require an associated ops PR, but decrease cognitive dissonance in dev and test to see GOLDEN_MACAROON_SANDBOX.", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445841996", "createdAt": "2020-06-25T21:14:37Z", "author": {"login": "dhgreene"}, "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -110,7 +103,7 @@ def delegated_macaroon(reg_org_api_id)\n   end\n \n   def golden_macaroon\n-    @golden_macaroon ||= ENV.fetch(\"GOLDEN_MACAROON_#{api_env.upcase}\")\n+    @golden_macaroon ||= ENV.fetch('GOLDEN_MACAROON_SANDBOX')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a46687a9df6a1e11c7a7766f3b5730676814c42"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg0NDY4NQ==", "bodyText": "Should \"Organization\" be \"API\" in this and the following alerts?", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445844685", "createdAt": "2020-06-25T21:20:28Z", "author": {"login": "dhgreene"}, "path": "dpc-web/app/controllers/internal/registered_organizations_controller.rb", "diffHunk": "@@ -17,49 +16,45 @@ def new\n \n     def create\n       @organization = Organization.find(org_id_param)\n-      @registered_organization = @organization.registered_organizations\n-                                              .build(registered_organization_params)\n-      @api_env = params[:api_env] || @registered_organization.api_env\n+      @registered_organization = @organization.build_registered_organization(registered_organization_params)\n \n       if @registered_organization.save\n-        flash[:notice] = \"Access to #{@registered_organization.api_env} enabled.\"\n+        flash[:notice] = 'Organization has been enabled.'\n         redirect_to internal_organization_path(@organization)\n       else\n-        flash[:alert] = \"Access to #{@registered_organization.api_env} could not be enabled:\n+        flash[:alert] = \"Organization could not be enabled:\n                         #{model_error_string(@registered_organization)}.\"\n         render :new\n       end\n     end\n \n     def edit\n-      @api_env = params[:api_env]\n       @organization = Organization.find(org_id_param)\n-      @registered_organization = @organization.registered_organizations.find(params[:id])\n+      @registered_organization = @organization.registered_organization\n     end\n \n     def update\n       @organization = Organization.find(org_id_param)\n-      @registered_organization = @organization.registered_organizations.find(params[:id])\n-      @api_env = @registered_organization.api_env\n+      @registered_organization = @organization.registered_organization\n \n       if @registered_organization.update(registered_organization_params)\n-        flash[:notice] = \"#{@registered_organization.api_env.capitalize} access updated.\"\n+        flash[:notice] = 'Organization access updated.'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a46687a9df6a1e11c7a7766f3b5730676814c42"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg0NTU2OQ==", "bodyText": "Does it still make sense to have two separate models/tables?", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445845569", "createdAt": "2020-06-25T21:22:22Z", "author": {"login": "dhgreene"}, "path": "dpc-web/app/models/organization.rb", "diffHunk": "@@ -6,7 +6,7 @@ class Organization < ApplicationRecord\n   has_one :address, as: :addressable, dependent: :destroy\n   has_many :organization_user_assignments, dependent: :destroy\n   has_many :users, through: :organization_user_assignments\n-  has_many :registered_organizations, dependent: :destroy\n+  has_one :registered_organization, dependent: :destroy", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a46687a9df6a1e11c7a7766f3b5730676814c42"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81ebefd8509e087be8c4cc55f0be58cce9d0b523", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/81ebefd8509e087be8c4cc55f0be58cce9d0b523", "committedDate": "2020-06-25T21:24:10Z", "message": "Update dpc-web/app/views/internal/registered_organizations/new.html.erb\n\nCo-authored-by: dhgreene <dhgreene@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0117fd1d129570fa505ba2657ef82260c454b6bb", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/0117fd1d129570fa505ba2657ef82260c454b6bb", "committedDate": "2020-06-26T14:33:12Z", "message": "registered organization controller alerts & notices updated"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3fa21089c8df497a32462f9626585f63fcdcdb6", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/a3fa21089c8df497a32462f9626585f63fcdcdb6", "committedDate": "2020-06-26T14:42:15Z", "message": "Remove prod_sbx conditional view from assigned content"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2daecde365217bc9dc8309fe804bde8a8b449c15", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/2daecde365217bc9dc8309fe804bde8a8b449c15", "committedDate": "2020-06-26T15:05:21Z", "message": "Change names of organization user assigment spec tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab415c8c64b0c8f9b93be6a4153816c28df3721e", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/ab415c8c64b0c8f9b93be6a4153816c28df3721e", "committedDate": "2020-06-26T15:16:28Z", "message": "Internal org dashboard update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "015fca72ab7a870ae29ed259196de9d347311520", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/015fca72ab7a870ae29ed259196de9d347311520", "committedDate": "2020-06-26T16:27:37Z", "message": "Merge branch 'master' into DPC-148-simplify-web-app-for-one-env"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "332ff182b54fc6bc30702a4f9c07fcde670127f1", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/332ff182b54fc6bc30702a4f9c07fcde670127f1", "committedDate": "2020-06-30T19:17:04Z", "message": "Merge branch 'master' into DPC-148-simplify-web-app-for-one-env"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b5f0c626d84da76b6b4e8a5f3624ed405a35569", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/4b5f0c626d84da76b6b4e8a5f3624ed405a35569", "committedDate": "2020-06-30T20:38:55Z", "message": "Merge branch 'master' into DPC-148-simplify-web-app-for-one-env"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afd7328b7fbb8e275b0d90e1d67827863ac30158", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/afd7328b7fbb8e275b0d90e1d67827863ac30158", "committedDate": "2020-07-01T16:20:19Z", "message": "Merge branch 'master' into DPC-148-simplify-web-app-for-one-env"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMDIxNTQ0", "url": "https://github.com/CMSgov/dpc-app/pull/881#pullrequestreview-441021544", "createdAt": "2020-07-01T16:24:15Z", "commit": {"oid": "afd7328b7fbb8e275b0d90e1d67827863ac30158"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 403, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}