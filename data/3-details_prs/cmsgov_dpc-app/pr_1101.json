{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA5MDQxODYz", "number": 1101, "title": "DPC 570 fix silently failing smoke tests", "bodyText": "Fixes DPC-570\nSince the lookback was failing when using synthetic data we were receiving errors during export requests. As a temporary fix we had disabled checking for errors during exports, the following was commented out.\n                .peek(jobResponse -> {\n                    if (jobResponse.getError().size() > 0)\n                        throw new IllegalStateException(\"Export job completed, but with errors\");\n                })\n\nNow that we are capable of bypassing lookback at an org level we need to bypass lookback during smoke tests and check if there are any errors during export. (specifically checking that we are receiving bfd data.)\n\nProposed Changes\n\nUse ids that are exempt from lookback during smoke tests (instead of randomly generating new UUIDs)\nUncomment previously mentioned code that checks for errors.\n\n\nChange Details\n\nUsed the same exempt orgs ids specified in aggregation config to create test organizations.\nChecked job response for errors. If errors are found tests is failed.\nUpdated outdated MBIs found in patient bundle.\nUpdate docker-compose file and make start-app command so that the real BFD client is used during local testing.\nRemoved ability to specify pre-existing org and keys. (I do not see a use case for this.)\n\n\nSecurity Implications\n\n\n new software dependencies\n\n\n\n security controls or supporting software altered\n\n\n\n new data stored or transmitted\n\n\n\n security checklist is completed for this change\n\n\n\n requires more information or team discussion to evaluate security implications\n\n\n\n no PHI/PII is affected by this change\n\n\nAcceptance Validation\n\nTested locally, dev, test, sbx, and prod.\n                .peek(jobResponse -> {\n                    if (jobResponse.getError().size() > 0)\n                        throw new IllegalStateException(\"Export job completed, but with errors\");\n                })\n\n\nFeedback Requested\nReview logic in error checking.\nReview changes related to make start-app (Enable the use of the real BFD client during local smoke testing).\nIs there a use case for specifying a pre existing org and its credentials during a smoke tests?", "createdAt": "2020-10-23T15:25:08Z", "url": "https://github.com/CMSgov/dpc-app/pull/1101", "merged": true, "mergeCommit": {"oid": "d0e800a0d258a370a68afcfd9678057bcb6f1fec"}, "closed": true, "closedAt": "2020-11-11T17:41:46Z", "author": {"login": "MrMorie"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdRuZTSgH2gAyNTA5MDQxODYzOjY1OGY5NTAzMDEzMGE3ZjkzYTY2YWU1NTliNGU5OWEwNDYxMTllZTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbf5DhAFqTUyODI4OTQ0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "658f95030130a7f93a66ae559b4e99a046119ee2", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/658f95030130a7f93a66ae559b4e99a046119ee2", "committedDate": "2020-10-12T06:57:13Z", "message": "Disabled lookback for smoketest orgs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cb52f29b686dba931633f5f5e4756407a0035df", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/0cb52f29b686dba931633f5f5e4756407a0035df", "committedDate": "2020-10-12T20:01:35Z", "message": "Fixed app configs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "154ded0543662586e2b391560dc55feb2cde77c1", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/154ded0543662586e2b391560dc55feb2cde77c1", "committedDate": "2020-10-12T20:12:08Z", "message": "Merge branch 'master' into sg/DPC-725-bypass-lookback-during-smoke-testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76ec6cf32f8b91213b1b3bef9fb1f2ffe3fdec0e", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/76ec6cf32f8b91213b1b3bef9fb1f2ffe3fdec0e", "committedDate": "2020-10-15T16:08:44Z", "message": "Fixed NPE in mock blueButton Client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdb58c5d1287cd9212740929ad94dcc6fa4218e4", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/bdb58c5d1287cd9212740929ad94dcc6fa4218e4", "committedDate": "2020-10-15T17:13:48Z", "message": "Reverted smoke test changes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "440a848b6233370b7af9ab71acf4aedfe12f4912", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/440a848b6233370b7af9ab71acf4aedfe12f4912", "committedDate": "2020-10-15T17:54:53Z", "message": "Enabled checking of data contents during smoke tests. Refactored smoke tests. Fixed failing smoke tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1Nzc2NjA5", "url": "https://github.com/CMSgov/dpc-app/pull/1101#pullrequestreview-515776609", "createdAt": "2020-10-23T15:26:11Z", "commit": {"oid": "440a848b6233370b7af9ab71acf4aedfe12f4912"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNToyNjoxMVrOHnSrfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNToyNjoxMVrOHnSrfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk2MjU1OA==", "bodyText": "Method runAndMonitorExportJob has 6 arguments (exceeds 4 allowed). Consider refactoring.", "url": "https://github.com/CMSgov/dpc-app/pull/1101#discussion_r510962558", "createdAt": "2020-10-23T15:26:11Z", "author": {"login": "codeclimate"}, "path": "dpc-smoketest/src/main/java/gov/cms/dpc/testing/smoketests/SmokeTest.java", "diffHunk": "@@ -221,18 +204,20 @@ public SampleResult runTest(JavaSamplerContext javaSamplerContext) {\n             patientSample.sampleEnd();\n             smokeTestResult.addSubResult(patientSample);\n         }\n+        return patientReferences;\n+    }\n \n \n-        // Upload the roster bundle\n+    private void uploadRosterBundle(JavaSamplerContext samplerContext, Bundle providerBundle, IGenericClient exportClient, Map<String,Reference> patientReferences){\n         logger.debug(\"Uploading roster\");\n         try {\n-            ClientUtils.createAndUploadRosters(javaSamplerContext.getParameter(\"seed-file\"), providerBundle, exportClient, UUID.fromString(organizationID), patientReferences);\n+            ClientUtils.createAndUploadRosters(samplerContext.getParameter(\"seed-file\"), providerBundle, exportClient, UUID.fromString(organizationID), patientReferences);\n         } catch (Exception e) {\n             throw new IllegalStateException(\"Cannot upload roster\", e);\n         }\n+    }\n \n-        // Run the job\n-        // Create a custom http client to use for monitoring the non-FHIR export request\n+    private void runAndMonitorExportJob(SampleResult smokeTestResult, String hostParam, String clientToken, Pair<UUID, PrivateKey> keyTuple, IGenericClient exportClient, List<String> providerNPIs){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "440a848b6233370b7af9ab71acf4aedfe12f4912"}, "originalPosition": 223}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0119681253fb04ac0b639b5c0778357c19f7952", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/e0119681253fb04ac0b639b5c0778357c19f7952", "committedDate": "2020-10-23T15:52:01Z", "message": "Resolved Merge Conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d3096c13126ec651be1adac005a46674fae0460", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/1d3096c13126ec651be1adac005a46674fae0460", "committedDate": "2020-10-28T23:44:01Z", "message": "Merge branch 'master' into sg/DPC-570-Fix-Failing-Smoke-Tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9828b22b2b9b1c58d63922b2703b6cbf996d5657", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/9828b22b2b9b1c58d63922b2703b6cbf996d5657", "committedDate": "2020-10-29T04:59:02Z", "message": "Fixed make ci-app issues. Added extra check when deleting an org during smoke tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59f70fcf5c3e5c069fe457f636b018d58277081c", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/59f70fcf5c3e5c069fe457f636b018d58277081c", "committedDate": "2020-10-29T04:59:17Z", "message": "Merge branch 'sg/DPC-570-Fix-Failing-Smoke-Tests' of https://github.com/CMSgov/dpc-app into sg/DPC-570-Fix-Failing-Smoke-Tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "559bd4cffcbaeabd841a439bd552d3d8955d61e7", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/559bd4cffcbaeabd841a439bd552d3d8955d61e7", "committedDate": "2020-10-29T06:39:10Z", "message": "Smoke Test: added checks for errors withing operation outcomes, checking for empty data files."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf580b3286798c8d887eaed1cae8d2192503367a", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/cf580b3286798c8d887eaed1cae8d2192503367a", "committedDate": "2020-10-29T14:05:16Z", "message": "Smoke tests: checked data file contents"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5NzUxNzQ4", "url": "https://github.com/CMSgov/dpc-app/pull/1101#pullrequestreview-519751748", "createdAt": "2020-10-29T14:53:21Z", "commit": {"oid": "cf580b3286798c8d887eaed1cae8d2192503367a"}, "state": "DISMISSED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNDo1MzoyMlrOHqftfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNTowNTo1NlrOHqgVZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMyMTc4OA==", "bodyText": "would it be possible to log the error here so that we know what is going on?", "url": "https://github.com/CMSgov/dpc-app/pull/1101#discussion_r514321788", "createdAt": "2020-10-29T14:53:22Z", "author": {"login": "jonfulk"}, "path": "dpc-smoketest/src/main/java/gov/cms/dpc/testing/smoketests/ClientUtils.java", "diffHunk": "@@ -61,11 +66,10 @@ static void handleExportJob(IGenericClient exportClient, List<String> providerNP\n                 .map(npi -> exportRequestDispatcher(exportClient, npi))\n                 .map(search -> (Group) search.getEntryFirstRep().getResource())\n                 .map(group -> jobCompletionLambda(exportClient, httpClient, group, overrideURL))\n-                //TODO: ignore until we can skip lookback per request and switch over to use real bfd client\n-//                .peek(jobResponse -> {\n-//                    if (jobResponse.getError().size() > 0)\n-//                        throw new IllegalStateException(\"Export job completed, but with errors\");\n-//                })\n+                .peek(jobResponse -> {\n+                    if (jobResponse.getError().size() > 0)\n+                        throw new IllegalStateException(\"Export job completed, but with errors\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf580b3286798c8d887eaed1cae8d2192503367a"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMyMzUxNA==", "bodyText": "should this check be case insensitive?", "url": "https://github.com/CMSgov/dpc-app/pull/1101#discussion_r514323514", "createdAt": "2020-10-29T14:55:22Z", "author": {"login": "jonfulk"}, "path": "dpc-smoketest/src/main/java/gov/cms/dpc/testing/smoketests/ClientUtils.java", "diffHunk": "@@ -242,11 +246,36 @@ private static void jobResponseHandler(CloseableHttpClient client, JobCompletion\n         try {\n             final File file = fetchExportedFiles(entry.getUrl(), client);\n             System.out.println(String.format(\"Downloaded file to: %s\", file.getPath()));\n+            if(file.length() == 0){\n+                throw new IllegalStateException(String.format(\"Downloaded file was empty. file path:  %s\", file.getPath()));\n+            }\n+            if(ResourceType.OperationOutcome.equals(entry.getType())){\n+                verifyOperationOutcomeContents(file);\n+            }\n         } catch (IOException e) {\n             throw new RuntimeException(\"Cannot output file\", e);\n         }\n     }\n \n+    private static void verifyOperationOutcomeContents(File outcomeFile){\n+        try (BufferedReader reader = Files.newBufferedReader(outcomeFile.toPath(), Charset.defaultCharset())){\n+            String line = reader.readLine();\n+            while (line != null) {\n+                JsonObject outcomeEntry = new JsonParser().parse(line).getAsJsonObject();\n+                JsonArray outcomeIssues = outcomeEntry.getAsJsonArray(\"issue\");\n+                String finalLine = line;\n+                outcomeIssues.forEach(issue-> {\n+                    if(\"error\".equals(issue.getAsJsonObject().get(\"severity\").getAsString())){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf580b3286798c8d887eaed1cae8d2192503367a"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMyNzgyOQ==", "bodyText": "Seems like we should check that the created org is what we expect before confirming that it was created, but maybe you do that in createOrganization", "url": "https://github.com/CMSgov/dpc-app/pull/1101#discussion_r514327829", "createdAt": "2020-10-29T15:00:26Z", "author": {"login": "jonfulk"}, "path": "dpc-smoketest/src/main/java/gov/cms/dpc/testing/smoketests/SmokeTest.java", "diffHunk": "@@ -102,85 +95,77 @@ public void teardownTest(JavaSamplerContext context) {\n \n     @Override\n     public SampleResult runTest(JavaSamplerContext javaSamplerContext) {\n-        // Create things\n-        final String hostParam = javaSamplerContext.getParameter(\"host\");\n+        final String apiURL = javaSamplerContext.getParameter(\"host\");\n         final String adminURL = javaSamplerContext.getParameter(\"admin-url\");\n-        logger.info(\"Running against {}\", hostParam);\n+        logger.info(\"Running against {}\", apiURL);\n         logger.info(\"Admin URL: {}\", adminURL);\n         logger.info(\"Running with {} threads\", JMeterContextService.getNumberOfThreads());\n \n-        this.organizationID = javaSamplerContext.getParameter(\"organization-id\");\n-        String clientToken = javaSamplerContext.getParameter(\"client-token\");\n-        String privateKeyPath = javaSamplerContext.getParameter(\"private-key\");\n-        final String keyID = javaSamplerContext.getParameter(\"key-id\");\n+        this.organizationID = getTestOrganizationId(javaSamplerContext);\n \n         final SampleResult smokeTestResult = new SampleResult();\n         smokeTestResult.setSampleLabel(\"Smoke Test\");\n-        // False, unless proven otherwise\n         smokeTestResult.setSuccessful(false);\n         smokeTestResult.sampleStart();\n \n         // Disable validation against Attribution service\n         this.ctx = FhirContext.forDstu3();\n \n-        // If we're not supplied all the init parameters, create a new org\n-        Pair<UUID, PrivateKey> keyTuple;\n-        if (organizationID.equals(\"\") || clientToken.equals(\"\") || privateKeyPath.equals(\"\") || keyID.equals(\"\")) {\n-            this.organizationID = UUID.randomUUID().toString();\n+        try {\n+            this.goldenMacaroon = APIAuthHelpers.createGoldenMacaroon(adminURL);\n+        } catch (Exception e) {\n+            throw new IllegalStateException(\"Failed creating Macaroon\", e);\n+        }\n \n-            logger.info(String.format(\"Creating organization %s\", organizationID));\n+        final IGenericClient adminClient = APIAuthHelpers.buildAdminClient(ctx, apiURL, goldenMacaroon, true, true);\n \n-            try {\n-                this.goldenMacaroon = APIAuthHelpers.createGoldenMacaroon(adminURL);\n-            } catch (Exception e) {\n-                throw new IllegalStateException(\"Failed creating Macaroon\", e);\n-            }\n-            // Create admin client for registering organization\n-            final IGenericClient adminClient = APIAuthHelpers.buildAdminClient(ctx, hostParam, goldenMacaroon, true, true);\n-\n-            final SampleResult orgRegistrationResult = new SampleResult();\n-            smokeTestResult.addSubResult(orgRegistrationResult);\n-\n-            orgRegistrationResult.sampleStart();\n-            try {\n-                String npi = NPIUtil.generateNPI();\n-                clientToken = FHIRHelpers.registerOrganization(adminClient, ctx.newJsonParser(), organizationID, npi, adminURL);\n-                orgRegistrationResult.setSuccessful(true);\n-            } catch (Exception e) {\n-                orgRegistrationResult.setSuccessful(false);\n-                throw new IllegalStateException(\"Cannot register org\", e);\n-            } finally {\n-                orgRegistrationResult.sampleEnd();\n-            }\n+        String clientToken = createOrganization(smokeTestResult, adminClient, adminURL);\n+        orgWasCreated = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf580b3286798c8d887eaed1cae8d2192503367a"}, "originalPosition": 144}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMyOTAxMQ==", "bodyText": "it's long, but i would call this practitionerSubmitResults for clarity.", "url": "https://github.com/CMSgov/dpc-app/pull/1101#discussion_r514329011", "createdAt": "2020-10-29T15:01:58Z", "author": {"login": "jonfulk"}, "path": "dpc-smoketest/src/main/java/gov/cms/dpc/testing/smoketests/SmokeTest.java", "diffHunk": "@@ -102,85 +95,77 @@ public void teardownTest(JavaSamplerContext context) {\n \n     @Override\n     public SampleResult runTest(JavaSamplerContext javaSamplerContext) {\n-        // Create things\n-        final String hostParam = javaSamplerContext.getParameter(\"host\");\n+        final String apiURL = javaSamplerContext.getParameter(\"host\");\n         final String adminURL = javaSamplerContext.getParameter(\"admin-url\");\n-        logger.info(\"Running against {}\", hostParam);\n+        logger.info(\"Running against {}\", apiURL);\n         logger.info(\"Admin URL: {}\", adminURL);\n         logger.info(\"Running with {} threads\", JMeterContextService.getNumberOfThreads());\n \n-        this.organizationID = javaSamplerContext.getParameter(\"organization-id\");\n-        String clientToken = javaSamplerContext.getParameter(\"client-token\");\n-        String privateKeyPath = javaSamplerContext.getParameter(\"private-key\");\n-        final String keyID = javaSamplerContext.getParameter(\"key-id\");\n+        this.organizationID = getTestOrganizationId(javaSamplerContext);\n \n         final SampleResult smokeTestResult = new SampleResult();\n         smokeTestResult.setSampleLabel(\"Smoke Test\");\n-        // False, unless proven otherwise\n         smokeTestResult.setSuccessful(false);\n         smokeTestResult.sampleStart();\n \n         // Disable validation against Attribution service\n         this.ctx = FhirContext.forDstu3();\n \n-        // If we're not supplied all the init parameters, create a new org\n-        Pair<UUID, PrivateKey> keyTuple;\n-        if (organizationID.equals(\"\") || clientToken.equals(\"\") || privateKeyPath.equals(\"\") || keyID.equals(\"\")) {\n-            this.organizationID = UUID.randomUUID().toString();\n+        try {\n+            this.goldenMacaroon = APIAuthHelpers.createGoldenMacaroon(adminURL);\n+        } catch (Exception e) {\n+            throw new IllegalStateException(\"Failed creating Macaroon\", e);\n+        }\n \n-            logger.info(String.format(\"Creating organization %s\", organizationID));\n+        final IGenericClient adminClient = APIAuthHelpers.buildAdminClient(ctx, apiURL, goldenMacaroon, true, true);\n \n-            try {\n-                this.goldenMacaroon = APIAuthHelpers.createGoldenMacaroon(adminURL);\n-            } catch (Exception e) {\n-                throw new IllegalStateException(\"Failed creating Macaroon\", e);\n-            }\n-            // Create admin client for registering organization\n-            final IGenericClient adminClient = APIAuthHelpers.buildAdminClient(ctx, hostParam, goldenMacaroon, true, true);\n-\n-            final SampleResult orgRegistrationResult = new SampleResult();\n-            smokeTestResult.addSubResult(orgRegistrationResult);\n-\n-            orgRegistrationResult.sampleStart();\n-            try {\n-                String npi = NPIUtil.generateNPI();\n-                clientToken = FHIRHelpers.registerOrganization(adminClient, ctx.newJsonParser(), organizationID, npi, adminURL);\n-                orgRegistrationResult.setSuccessful(true);\n-            } catch (Exception e) {\n-                orgRegistrationResult.setSuccessful(false);\n-                throw new IllegalStateException(\"Cannot register org\", e);\n-            } finally {\n-                orgRegistrationResult.sampleEnd();\n-            }\n+        String clientToken = createOrganization(smokeTestResult, adminClient, adminURL);\n+        orgWasCreated = true;\n+\n+        Pair<UUID, PrivateKey> keyTuple = createPublicKey(apiURL);\n \n-            // Create a new public key\n-            try {\n-                keyTuple = APIAuthHelpers.generateAndUploadKey(KEY_ID, organizationID, goldenMacaroon, hostParam);\n-            } catch (IOException | URISyntaxException | GeneralSecurityException e) {\n-                throw new IllegalStateException(\"Failed uploading public key\", e);\n-            }\n-        } else {\n-            // Parse the private key and create a new ID/PrivateKey tuple\n-            final Path path = Paths.get(privateKeyPath);\n-            try (final PEMParser pemParser = new PEMParser(Files.newBufferedReader(path, StandardCharsets.UTF_8))) {\n-                JcaPEMKeyConverter converter = new JcaPEMKeyConverter().setProvider(\"BC\");\n-                Object object = pemParser.readObject();\n-                KeyPair kp = converter.getKeyPair((PEMKeyPair) object);\n-                PrivateKey privateKey = kp.getPrivate();\n-                if (privateKey == null) {\n-                    throw new IllegalStateException(\"Key cannot be null\");\n-                }\n-                keyTuple = Pair.of(UUID.fromString(keyID), privateKey);\n-            } catch (IOException e) {\n-                throw new IllegalArgumentException(String.format(\"Cannot read private key from: %s\", privateKeyPath));\n-            }\n-        }\n         // Create an authenticated and async client (the async part is ignored by other endpoints)\n-        final IGenericClient exportClient;\n+        final IGenericClient exportClient = APIAuthHelpers.buildAuthenticatedClient(ctx, apiURL, clientToken, keyTuple.getLeft(), keyTuple.getRight(), true, true);\n+\n+        Pair<Bundle, List<String>> practSubmitResults = submitPractitioners(javaSamplerContext, smokeTestResult, exportClient);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf580b3286798c8d887eaed1cae8d2192503367a"}, "originalPosition": 174}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMzMTQwNg==", "bodyText": "you removed String.format() before and used {} for interpolation instead. we should that here too.", "url": "https://github.com/CMSgov/dpc-app/pull/1101#discussion_r514331406", "createdAt": "2020-10-29T15:05:08Z", "author": {"login": "jonfulk"}, "path": "dpc-smoketest/src/main/java/gov/cms/dpc/testing/smoketests/SmokeTest.java", "diffHunk": "@@ -102,85 +95,77 @@ public void teardownTest(JavaSamplerContext context) {\n \n     @Override\n     public SampleResult runTest(JavaSamplerContext javaSamplerContext) {\n-        // Create things\n-        final String hostParam = javaSamplerContext.getParameter(\"host\");\n+        final String apiURL = javaSamplerContext.getParameter(\"host\");\n         final String adminURL = javaSamplerContext.getParameter(\"admin-url\");\n-        logger.info(\"Running against {}\", hostParam);\n+        logger.info(\"Running against {}\", apiURL);\n         logger.info(\"Admin URL: {}\", adminURL);\n         logger.info(\"Running with {} threads\", JMeterContextService.getNumberOfThreads());\n \n-        this.organizationID = javaSamplerContext.getParameter(\"organization-id\");\n-        String clientToken = javaSamplerContext.getParameter(\"client-token\");\n-        String privateKeyPath = javaSamplerContext.getParameter(\"private-key\");\n-        final String keyID = javaSamplerContext.getParameter(\"key-id\");\n+        this.organizationID = getTestOrganizationId(javaSamplerContext);\n \n         final SampleResult smokeTestResult = new SampleResult();\n         smokeTestResult.setSampleLabel(\"Smoke Test\");\n-        // False, unless proven otherwise\n         smokeTestResult.setSuccessful(false);\n         smokeTestResult.sampleStart();\n \n         // Disable validation against Attribution service\n         this.ctx = FhirContext.forDstu3();\n \n-        // If we're not supplied all the init parameters, create a new org\n-        Pair<UUID, PrivateKey> keyTuple;\n-        if (organizationID.equals(\"\") || clientToken.equals(\"\") || privateKeyPath.equals(\"\") || keyID.equals(\"\")) {\n-            this.organizationID = UUID.randomUUID().toString();\n+        try {\n+            this.goldenMacaroon = APIAuthHelpers.createGoldenMacaroon(adminURL);\n+        } catch (Exception e) {\n+            throw new IllegalStateException(\"Failed creating Macaroon\", e);\n+        }\n \n-            logger.info(String.format(\"Creating organization %s\", organizationID));\n+        final IGenericClient adminClient = APIAuthHelpers.buildAdminClient(ctx, apiURL, goldenMacaroon, true, true);\n \n-            try {\n-                this.goldenMacaroon = APIAuthHelpers.createGoldenMacaroon(adminURL);\n-            } catch (Exception e) {\n-                throw new IllegalStateException(\"Failed creating Macaroon\", e);\n-            }\n-            // Create admin client for registering organization\n-            final IGenericClient adminClient = APIAuthHelpers.buildAdminClient(ctx, hostParam, goldenMacaroon, true, true);\n-\n-            final SampleResult orgRegistrationResult = new SampleResult();\n-            smokeTestResult.addSubResult(orgRegistrationResult);\n-\n-            orgRegistrationResult.sampleStart();\n-            try {\n-                String npi = NPIUtil.generateNPI();\n-                clientToken = FHIRHelpers.registerOrganization(adminClient, ctx.newJsonParser(), organizationID, npi, adminURL);\n-                orgRegistrationResult.setSuccessful(true);\n-            } catch (Exception e) {\n-                orgRegistrationResult.setSuccessful(false);\n-                throw new IllegalStateException(\"Cannot register org\", e);\n-            } finally {\n-                orgRegistrationResult.sampleEnd();\n-            }\n+        String clientToken = createOrganization(smokeTestResult, adminClient, adminURL);\n+        orgWasCreated = true;\n+\n+        Pair<UUID, PrivateKey> keyTuple = createPublicKey(apiURL);\n \n-            // Create a new public key\n-            try {\n-                keyTuple = APIAuthHelpers.generateAndUploadKey(KEY_ID, organizationID, goldenMacaroon, hostParam);\n-            } catch (IOException | URISyntaxException | GeneralSecurityException e) {\n-                throw new IllegalStateException(\"Failed uploading public key\", e);\n-            }\n-        } else {\n-            // Parse the private key and create a new ID/PrivateKey tuple\n-            final Path path = Paths.get(privateKeyPath);\n-            try (final PEMParser pemParser = new PEMParser(Files.newBufferedReader(path, StandardCharsets.UTF_8))) {\n-                JcaPEMKeyConverter converter = new JcaPEMKeyConverter().setProvider(\"BC\");\n-                Object object = pemParser.readObject();\n-                KeyPair kp = converter.getKeyPair((PEMKeyPair) object);\n-                PrivateKey privateKey = kp.getPrivate();\n-                if (privateKey == null) {\n-                    throw new IllegalStateException(\"Key cannot be null\");\n-                }\n-                keyTuple = Pair.of(UUID.fromString(keyID), privateKey);\n-            } catch (IOException e) {\n-                throw new IllegalArgumentException(String.format(\"Cannot read private key from: %s\", privateKeyPath));\n-            }\n-        }\n         // Create an authenticated and async client (the async part is ignored by other endpoints)\n-        final IGenericClient exportClient;\n+        final IGenericClient exportClient = APIAuthHelpers.buildAuthenticatedClient(ctx, apiURL, clientToken, keyTuple.getLeft(), keyTuple.getRight(), true, true);\n+\n+        Pair<Bundle, List<String>> practSubmitResults = submitPractitioners(javaSamplerContext, smokeTestResult, exportClient);\n+\n+        final Map<String, Reference> patientReferences = submitPatients(javaSamplerContext, smokeTestResult, exportClient);\n+\n+        uploadRosterBundle(javaSamplerContext, practSubmitResults.getLeft(), exportClient, patientReferences);\n \n-        exportClient = APIAuthHelpers.buildAuthenticatedClient(ctx, hostParam, clientToken, keyTuple.getLeft(), keyTuple.getRight(), true, true);\n+        runAndMonitorExportJob(smokeTestResult, apiURL, clientToken, keyTuple, exportClient, practSubmitResults.getRight());\n \n-        // Upload a batch of patients and a batch of providers\n+        return smokeTestResult;\n+    }\n+\n+    private Pair<UUID, PrivateKey> createPublicKey(String hostParam){\n+        try {\n+            return APIAuthHelpers.generateAndUploadKey(KEY_ID, organizationID, goldenMacaroon, hostParam);\n+        } catch (IOException | URISyntaxException | GeneralSecurityException e) {\n+            throw new IllegalStateException(\"Failed uploading public key\", e);\n+        }\n+    }\n+\n+    private String createOrganization(SampleResult smokeTestResult, IGenericClient adminClient, String adminURL){\n+        logger.info(String.format(\"Creating organization %s\", organizationID));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf580b3286798c8d887eaed1cae8d2192503367a"}, "originalPosition": 196}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMzMjAwNA==", "bodyText": "we use practitioner in some places and provider in other places. Are they the same?", "url": "https://github.com/CMSgov/dpc-app/pull/1101#discussion_r514332004", "createdAt": "2020-10-29T15:05:56Z", "author": {"login": "jonfulk"}, "path": "dpc-smoketest/src/main/java/gov/cms/dpc/testing/smoketests/SmokeTest.java", "diffHunk": "@@ -203,14 +188,16 @@ public SampleResult runTest(JavaSamplerContext javaSamplerContext) {\n         } finally {\n             practitionerSample.sampleEnd();\n         }\n-\n         smokeTestResult.addSubResult(practitionerSample);\n+        return Pair.of(providerBundle, providerNPIs);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf580b3286798c8d887eaed1cae8d2192503367a"}, "originalPosition": 224}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5ODE4NTY0", "url": "https://github.com/CMSgov/dpc-app/pull/1101#pullrequestreview-519818564", "createdAt": "2020-10-29T15:54:17Z", "commit": {"oid": "cf580b3286798c8d887eaed1cae8d2192503367a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNTo1NDoxN1rOHqis3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNTo1NDoxN1rOHqis3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDM3MDc4MQ==", "bodyText": "Define and throw a dedicated exception instead of using a generic one.", "url": "https://github.com/CMSgov/dpc-app/pull/1101#discussion_r514370781", "createdAt": "2020-10-29T15:54:17Z", "author": {"login": "codeclimate"}, "path": "dpc-smoketest/src/main/java/gov/cms/dpc/testing/smoketests/ClientUtils.java", "diffHunk": "@@ -242,11 +246,36 @@ private static void jobResponseHandler(CloseableHttpClient client, JobCompletion\n         try {\n             final File file = fetchExportedFiles(entry.getUrl(), client);\n             System.out.println(String.format(\"Downloaded file to: %s\", file.getPath()));\n+            if(file.length() == 0){\n+                throw new IllegalStateException(String.format(\"Downloaded file was empty. file path:  %s\", file.getPath()));\n+            }\n+            if(ResourceType.OperationOutcome.equals(entry.getType())){\n+                verifyOperationOutcomeContents(file);\n+            }\n         } catch (IOException e) {\n             throw new RuntimeException(\"Cannot output file\", e);\n         }\n     }\n \n+    private static void verifyOperationOutcomeContents(File outcomeFile){\n+        try (BufferedReader reader = Files.newBufferedReader(outcomeFile.toPath(), Charset.defaultCharset())){\n+            String line = reader.readLine();\n+            while (line != null) {\n+                JsonObject outcomeEntry = new JsonParser().parse(line).getAsJsonObject();\n+                JsonArray outcomeIssues = outcomeEntry.getAsJsonArray(\"issue\");\n+                String finalLine = line;\n+                outcomeIssues.forEach(issue-> {\n+                    if(\"error\".equals(issue.getAsJsonObject().get(\"severity\").getAsString())){\n+                        throw new IllegalStateException(String.format(\"Operation outcome contains an error: File path:  %s, Error line: %s\", outcomeFile.getPath(), finalLine));\n+                    }\n+                });\n+                line = reader.readLine();\n+            }\n+        } catch (IOException e) {\n+            throw new RuntimeException(\"Cannot read operation outcome file.\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf580b3286798c8d887eaed1cae8d2192503367a"}, "originalPosition": 66}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29daf2a1e3d7fafd94e25231fd4a9350ff25a006", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/29daf2a1e3d7fafd94e25231fd4a9350ff25a006", "committedDate": "2020-10-29T16:25:34Z", "message": "Merge branch 'master' into sg/DPC-570-Fix-Failing-Smoke-Tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3403fbb9dba19216ef89fbef40776a4326d68f4", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/a3403fbb9dba19216ef89fbef40776a4326d68f4", "committedDate": "2020-10-30T15:32:19Z", "message": "Merge branch 'master' into sg/DPC-570-Fix-Failing-Smoke-Tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxODE3MDIy", "url": "https://github.com/CMSgov/dpc-app/pull/1101#pullrequestreview-521817022", "createdAt": "2020-11-02T16:54:53Z", "commit": {"oid": "a3403fbb9dba19216ef89fbef40776a4326d68f4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNjo1NDo1M1rOHsNGLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNjo1NDo1M1rOHsNGLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjExMzk2Nw==", "bodyText": "You can use the fhircontext to get a json parser that will parse it directly to an OperationOutcome object", "url": "https://github.com/CMSgov/dpc-app/pull/1101#discussion_r516113967", "createdAt": "2020-11-02T16:54:53Z", "author": {"login": "MrBilnon"}, "path": "dpc-smoketest/src/main/java/gov/cms/dpc/testing/smoketests/ClientUtils.java", "diffHunk": "@@ -242,11 +246,36 @@ private static void jobResponseHandler(CloseableHttpClient client, JobCompletion\n         try {\n             final File file = fetchExportedFiles(entry.getUrl(), client);\n             System.out.println(String.format(\"Downloaded file to: %s\", file.getPath()));\n+            if(file.length() == 0){\n+                throw new IllegalStateException(String.format(\"Downloaded file was empty. file path:  %s\", file.getPath()));\n+            }\n+            if(ResourceType.OperationOutcome.equals(entry.getType())){\n+                verifyOperationOutcomeContents(file);\n+            }\n         } catch (IOException e) {\n             throw new RuntimeException(\"Cannot output file\", e);\n         }\n     }\n \n+    private static void verifyOperationOutcomeContents(File outcomeFile){\n+        try (BufferedReader reader = Files.newBufferedReader(outcomeFile.toPath(), Charset.defaultCharset())){\n+            String line = reader.readLine();\n+            while (line != null) {\n+                JsonObject outcomeEntry = new JsonParser().parse(line).getAsJsonObject();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3403fbb9dba19216ef89fbef40776a4326d68f4"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxOTU1NTQy", "url": "https://github.com/CMSgov/dpc-app/pull/1101#pullrequestreview-521955542", "createdAt": "2020-11-02T20:05:58Z", "commit": {"oid": "a3403fbb9dba19216ef89fbef40776a4326d68f4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMDowNTo1OFrOHsT2CA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMDowNTo1OFrOHsT2CA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIyNDUyMA==", "bodyText": "I don't think this will ever get called because you already throw an exception if there are errors", "url": "https://github.com/CMSgov/dpc-app/pull/1101#discussion_r516224520", "createdAt": "2020-11-02T20:05:58Z", "author": {"login": "MrBilnon"}, "path": "dpc-smoketest/src/main/java/gov/cms/dpc/testing/smoketests/ClientUtils.java", "diffHunk": "@@ -242,11 +246,36 @@ private static void jobResponseHandler(CloseableHttpClient client, JobCompletion\n         try {\n             final File file = fetchExportedFiles(entry.getUrl(), client);\n             System.out.println(String.format(\"Downloaded file to: %s\", file.getPath()));\n+            if(file.length() == 0){\n+                throw new IllegalStateException(String.format(\"Downloaded file was empty. file path:  %s\", file.getPath()));\n+            }\n+            if(ResourceType.OperationOutcome.equals(entry.getType())){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3403fbb9dba19216ef89fbef40776a4326d68f4"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0695742da68a9a88094aaa70c0ec8497d20637b5", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/0695742da68a9a88094aaa70c0ec8497d20637b5", "committedDate": "2020-11-03T20:26:40Z", "message": "Merge branch 'master' into sg/DPC-570-Fix-Failing-Smoke-Tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48f9b01e8e8a968105df7462592aec07d0b77f6c", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/48f9b01e8e8a968105df7462592aec07d0b77f6c", "committedDate": "2020-11-09T20:37:17Z", "message": "Resolved PR requests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c6a8f0c352a1576d4f4b7e8e2f3da11ef93383c", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/0c6a8f0c352a1576d4f4b7e8e2f3da11ef93383c", "committedDate": "2020-11-10T22:36:10Z", "message": "Merge branch 'master' into sg/DPC-570-Fix-Failing-Smoke-Tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22fc3334ed261453ddcc8d9696eff5eb1ade8749", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/22fc3334ed261453ddcc8d9696eff5eb1ade8749", "committedDate": "2020-11-11T03:33:47Z", "message": "Fixed PR issues. Reverted refactoring changes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24604c0b912ab9fc18eeba834d6dea0f5797d1d4", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/24604c0b912ab9fc18eeba834d6dea0f5797d1d4", "committedDate": "2020-11-11T03:34:14Z", "message": "Merge branch 'sg/DPC-570-Fix-Failing-Smoke-Tests' of https://github.com/CMSgov/dpc-app into sg/DPC-570-Fix-Failing-Smoke-Tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c96ce8132a1c863121611f203669262a54cf1564", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/c96ce8132a1c863121611f203669262a54cf1564", "committedDate": "2020-11-11T15:06:01Z", "message": "Fixed logging bug pointed out by Sonar"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4Mjg5NDQy", "url": "https://github.com/CMSgov/dpc-app/pull/1101#pullrequestreview-528289442", "createdAt": "2020-11-11T15:42:34Z", "commit": {"oid": "c96ce8132a1c863121611f203669262a54cf1564"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 304, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}