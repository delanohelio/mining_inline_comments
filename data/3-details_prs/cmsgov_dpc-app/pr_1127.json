{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5ODAzNjM1", "number": 1127, "title": "DPC-829: Update CSV file download on website to reflect filtering and tags", "bodyText": "Fixes DPC-829\n\nThe CSV file in the admin is a complete download of all users in the sandbox environment. We should be able to download a subset of users based on the filtering view. Additionally, tags are not currently a field in the CSV file.\nAC:\n\nThe CSV download from the website should be based on the filtered view at the time of download\nThe CSV file includes a column for \"tags\"\n\nProposed Changes\n\n\nOnly pass in the users that have been filtered\nIf no users available, a CSV file cannot be created & an error is thrown\nAdd tags column to CSV file\nAdjust tests\n\nChange Details\n\n\nAdding the tags to the CSV file created:\n\n\nif k == 'tags'\n   v.gsub!('&quot;', '')\n   v.delete!('[')\n   v.delete!(']')\nend\n\n\nSecurity Implications\n\n\n new software dependencies\n\n\n\n security controls or supporting software altered\n\n\n\n new data stored or transmitted\n\n\n\n security checklist is completed for this change\n\n\n\n requires more information or team discussion to evaluate security implications\n\n\n\n no PHI/PII is affected by this change\n\n\nAcceptance Validation\n\n\n\nFeedback Requested\n\nThe one code climate error left is that it thinks the following method is too long:\n  def self.to_csv(user_ids)\n    users = User.find(user_ids)\n    CSV.generate(headers: true) do |csv|\n      csv << ATTRS\n      users.each do |user|\n        attributes = user.attributes\n        attributes['tags'] = user.tags.map(&:name)\n        escaped_attributes = attributes.map do |k, v|\n          if ESCAPED_ATTRS.include? k\n            v = ERB::Util.html_escape(v)\n\n            if k == 'tags'\n              v.gsub!('&quot;', '')\n              v.delete!('[')\n              v.delete!(']')\n            end\n          end\n\n          [k, v]\n        end.to_h\n        csv << escaped_attributes.values_at(*ATTRS)\n      end\n    end\n  end\n\nHowever, I cannot think of a nice way to refactor this. Thoughts?", "createdAt": "2020-11-30T20:51:16Z", "url": "https://github.com/CMSgov/dpc-app/pull/1127", "merged": true, "mergeCommit": {"oid": "89a1c82ec2a818976a0c257315ac8ef660a354af"}, "closed": true, "closedAt": "2020-12-03T19:32:06Z", "author": {"login": "Sun-Mountain"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdho5OxgH2gAyNTI5ODAzNjM1OmNmY2M4OGM1ZTM1N2IwODhjNjFkMDc2NDFjY2NmNzEzOWE4ZjkyNzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdioENwAH2gAyNTI5ODAzNjM1OjkxMTVmZjM5NzNjNDJiNmNlMzIzMmY5ODcyZWNiMzI3OTA5MTUyZWY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cfcc88c5e357b088c61d07641cccf7139a8f9276", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/cfcc88c5e357b088c61d07641cccf7139a8f9276", "committedDate": "2020-11-30T17:35:27Z", "message": "CSV filter enabled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4339f971e8d2f3f1c55376facac177c08fcdbcde", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/4339f971e8d2f3f1c55376facac177c08fcdbcde", "committedDate": "2020-11-30T19:47:16Z", "message": "Move CsvGenerator into concern for future refactoring"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMjg0NzY1", "url": "https://github.com/CMSgov/dpc-app/pull/1127#pullrequestreview-541284765", "createdAt": "2020-11-30T20:52:12Z", "commit": {"oid": "4339f971e8d2f3f1c55376facac177c08fcdbcde"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMDo1MjoxMlrOH8NX4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMDo1MjoxM1rOH8NX6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg5NTcxMg==", "bodyText": "Align the elements of an array literal if they span more than one line.", "url": "https://github.com/CMSgov/dpc-app/pull/1127#discussion_r532895712", "createdAt": "2020-11-30T20:52:12Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/controllers/concerns/csv_generator.rb", "diffHunk": "@@ -0,0 +1,28 @@\n+# frozen_string_literal: true\n+\n+module CsvGenerator\n+\n+  ATTRS = %w[id first_name last_name email requested_organization requested_organization_type\n+    address_1 address_2 city state zip agree_to_terms requested_num_providers created_at updated_at].freeze", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4339f971e8d2f3f1c55376facac177c08fcdbcde"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg5NTcxOA==", "bodyText": "Extra empty line detected at module body beginning.", "url": "https://github.com/CMSgov/dpc-app/pull/1127#discussion_r532895718", "createdAt": "2020-11-30T20:52:13Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/controllers/concerns/csv_generator.rb", "diffHunk": "@@ -0,0 +1,28 @@\n+# frozen_string_literal: true\n+\n+module CsvGenerator\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4339f971e8d2f3f1c55376facac177c08fcdbcde"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg5NTcyMQ==", "bodyText": "Extra empty line detected at module body end.", "url": "https://github.com/CMSgov/dpc-app/pull/1127#discussion_r532895721", "createdAt": "2020-11-30T20:52:13Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/controllers/concerns/csv_generator.rb", "diffHunk": "@@ -0,0 +1,28 @@\n+# frozen_string_literal: true\n+\n+module CsvGenerator\n+\n+  ATTRS = %w[id first_name last_name email requested_organization requested_organization_type\n+    address_1 address_2 city state zip agree_to_terms requested_num_providers created_at updated_at].freeze\n+\n+  # html escape these fields for XSS protection\n+  ESCAPED_ATTRS = %w[first_name last_name requested_organization address_1 address_2 city].freeze\n+\n+  def cvs_convert(users)\n+    CSV.generate(headers:true) do |csv|\n+      csv << ATTRS\n+      users.each do |user|\n+        attributes = user.attributes\n+        escaped_attributes = attributes.map do |k, v|\n+          if ESCAPED_ATTRS.include? k\n+            v = ERB::Util.html_escape(v)\n+          end\n+\n+          [k, v]\n+        end.to_h\n+        csv << escaped_attributes.values_at(*ATTRS)\n+      end\n+    end\n+  end\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4339f971e8d2f3f1c55376facac177c08fcdbcde"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg5NTcyMw==", "bodyText": "Space missing after colon.", "url": "https://github.com/CMSgov/dpc-app/pull/1127#discussion_r532895723", "createdAt": "2020-11-30T20:52:13Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/controllers/concerns/csv_generator.rb", "diffHunk": "@@ -0,0 +1,28 @@\n+# frozen_string_literal: true\n+\n+module CsvGenerator\n+\n+  ATTRS = %w[id first_name last_name email requested_organization requested_organization_type\n+    address_1 address_2 city state zip agree_to_terms requested_num_providers created_at updated_at].freeze\n+\n+  # html escape these fields for XSS protection\n+  ESCAPED_ATTRS = %w[first_name last_name requested_organization address_1 address_2 city].freeze\n+\n+  def cvs_convert(users)\n+    CSV.generate(headers:true) do |csv|", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4339f971e8d2f3f1c55376facac177c08fcdbcde"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df7f69045d10ad27919979c3c89c02684869af3e", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/df7f69045d10ad27919979c3c89c02684869af3e", "committedDate": "2020-12-01T19:08:45Z", "message": "Working on tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9698d4523b41d1923e6d946de16cfe449ff9d32b", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/9698d4523b41d1923e6d946de16cfe449ff9d32b", "committedDate": "2020-12-01T20:55:22Z", "message": "Tests passing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c04801f7d400fe2277c246e4e7f1a387265e1ba", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/9c04801f7d400fe2277c246e4e7f1a387265e1ba", "committedDate": "2020-12-01T21:15:51Z", "message": "Climate code fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a399025cbc63c8f6f4388144fe23d95b37c35a8", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/1a399025cbc63c8f6f4388144fe23d95b37c35a8", "committedDate": "2020-12-01T21:26:56Z", "message": "Code climate fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9969b294d76da6d8f15fee5b27ba406172d73c17", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/9969b294d76da6d8f15fee5b27ba406172d73c17", "committedDate": "2020-12-02T15:38:16Z", "message": "Test fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7b837584f5e48a2e81548abff7e24908a72d441", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/b7b837584f5e48a2e81548abff7e24908a72d441", "committedDate": "2020-12-02T19:14:17Z", "message": "Add tags to csv file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79f2ae3df482b7a5134e7189de6dcd94dd86a226", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/79f2ae3df482b7a5134e7189de6dcd94dd86a226", "committedDate": "2020-12-02T19:22:43Z", "message": "Code climate fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMTc4NDM3", "url": "https://github.com/CMSgov/dpc-app/pull/1127#pullrequestreview-543178437", "createdAt": "2020-12-02T19:42:28Z", "commit": {"oid": "79f2ae3df482b7a5134e7189de6dcd94dd86a226"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxOTo0MjoyOVrOH9rSDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxOTo0MjoyOVrOH9rSFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQzNDMxOQ==", "bodyText": "Method has too many lines. [20/15]", "url": "https://github.com/CMSgov/dpc-app/pull/1127#discussion_r534434319", "createdAt": "2020-12-02T19:42:29Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/models/user.rb", "diffHunk": "@@ -83,19 +83,28 @@ class User < ApplicationRecord\n   end\n \n   ATTRS = %w[id first_name last_name email requested_organization requested_organization_type\n-             address_1 address_2 city state zip agree_to_terms requested_num_providers created_at updated_at].freeze\n+             address_1 address_2 city state zip agree_to_terms requested_num_providers created_at\n+             updated_at tags].freeze\n \n   # html escape these fields for XSS protection\n-  ESCAPED_ATTRS = %w[first_name last_name requested_organization address_1 address_2 city].freeze\n+  ESCAPED_ATTRS = %w[first_name last_name requested_organization address_1 address_2 city tags].freeze\n \n-  def self.to_csv\n+  def self.to_csv(user_ids)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79f2ae3df482b7a5134e7189de6dcd94dd86a226"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQzNDMyMg==", "bodyText": "Use delete! instead of gsub!.", "url": "https://github.com/CMSgov/dpc-app/pull/1127#discussion_r534434322", "createdAt": "2020-12-02T19:42:29Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/models/user.rb", "diffHunk": "@@ -83,19 +83,28 @@ class User < ApplicationRecord\n   end\n \n   ATTRS = %w[id first_name last_name email requested_organization requested_organization_type\n-             address_1 address_2 city state zip agree_to_terms requested_num_providers created_at updated_at].freeze\n+             address_1 address_2 city state zip agree_to_terms requested_num_providers created_at\n+             updated_at tags].freeze\n \n   # html escape these fields for XSS protection\n-  ESCAPED_ATTRS = %w[first_name last_name requested_organization address_1 address_2 city].freeze\n+  ESCAPED_ATTRS = %w[first_name last_name requested_organization address_1 address_2 city tags].freeze\n \n-  def self.to_csv\n+  def self.to_csv(user_ids)\n+    users = User.find(user_ids)\n     CSV.generate(headers: true) do |csv|\n       csv << ATTRS\n-      all.each do |user|\n+      users.each do |user|\n         attributes = user.attributes\n+        attributes['tags'] = user.tags.map(&:name)\n         escaped_attributes = attributes.map do |k, v|\n           if ESCAPED_ATTRS.include? k\n             v = ERB::Util.html_escape(v)\n+\n+            if k == 'tags'\n+              v.gsub!('&quot;', '')\n+              v.gsub!('[', '')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79f2ae3df482b7a5134e7189de6dcd94dd86a226"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQzNDMyNA==", "bodyText": "Use delete! instead of gsub!.", "url": "https://github.com/CMSgov/dpc-app/pull/1127#discussion_r534434324", "createdAt": "2020-12-02T19:42:29Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/models/user.rb", "diffHunk": "@@ -83,19 +83,28 @@ class User < ApplicationRecord\n   end\n \n   ATTRS = %w[id first_name last_name email requested_organization requested_organization_type\n-             address_1 address_2 city state zip agree_to_terms requested_num_providers created_at updated_at].freeze\n+             address_1 address_2 city state zip agree_to_terms requested_num_providers created_at\n+             updated_at tags].freeze\n \n   # html escape these fields for XSS protection\n-  ESCAPED_ATTRS = %w[first_name last_name requested_organization address_1 address_2 city].freeze\n+  ESCAPED_ATTRS = %w[first_name last_name requested_organization address_1 address_2 city tags].freeze\n \n-  def self.to_csv\n+  def self.to_csv(user_ids)\n+    users = User.find(user_ids)\n     CSV.generate(headers: true) do |csv|\n       csv << ATTRS\n-      all.each do |user|\n+      users.each do |user|\n         attributes = user.attributes\n+        attributes['tags'] = user.tags.map(&:name)\n         escaped_attributes = attributes.map do |k, v|\n           if ESCAPED_ATTRS.include? k\n             v = ERB::Util.html_escape(v)\n+\n+            if k == 'tags'\n+              v.gsub!('&quot;', '')\n+              v.gsub!('[', '')\n+              v.gsub!(']', '')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79f2ae3df482b7a5134e7189de6dcd94dd86a226"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3cafadc58f6a360b5cb3b28c2a17b927973c6bfc", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/3cafadc58f6a360b5cb3b28c2a17b927973c6bfc", "committedDate": "2020-12-02T20:30:10Z", "message": "Code climate and spec fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "806188d790beaaaae02d9b816ec85968728d1375", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/806188d790beaaaae02d9b816ec85968728d1375", "committedDate": "2020-12-02T20:35:00Z", "message": "Remove whitespace to appease code climate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11e663961fe6ac5483dc2d14c4cf791bf63280f0", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/11e663961fe6ac5483dc2d14c4cf791bf63280f0", "committedDate": "2020-12-02T21:09:11Z", "message": "Merge branch 'master' into nz/dpc-829-csv-filter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1bfb2a00a93ca92bce6b64a7ac22db68d6c1b33", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/d1bfb2a00a93ca92bce6b64a7ac22db68d6c1b33", "committedDate": "2020-12-02T21:12:46Z", "message": "Remove 'all users' from CSV button"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e924d7110528a3eba20f63afa50f89571760f63", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/3e924d7110528a3eba20f63afa50f89571760f63", "committedDate": "2020-12-02T21:12:52Z", "message": "Merge branch 'nz/dpc-829-csv-filter' of github.com:CMSgov/dpc-app into nz/dpc-829-csv-filter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0Mjc1MjM3", "url": "https://github.com/CMSgov/dpc-app/pull/1127#pullrequestreview-544275237", "createdAt": "2020-12-03T18:52:53Z", "commit": {"oid": "3e924d7110528a3eba20f63afa50f89571760f63"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0Mjc2NjQ4", "url": "https://github.com/CMSgov/dpc-app/pull/1127#pullrequestreview-544276648", "createdAt": "2020-12-03T18:54:51Z", "commit": {"oid": "3e924d7110528a3eba20f63afa50f89571760f63"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9115ff3973c42b6ce3232f9872ecb327909152ef", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/9115ff3973c42b6ce3232f9872ecb327909152ef", "committedDate": "2020-12-03T19:11:28Z", "message": "Merge branch 'master' into nz/dpc-829-csv-filter"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 328, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}