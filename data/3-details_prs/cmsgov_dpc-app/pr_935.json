{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4NTM0MzMx", "number": 935, "title": "DPC-557 - add check to make sure _since parameter is not a future date", "bodyText": "Fixes DPC-557\n\n_since parameter accepts a future date\nProposed Changes\nreject request if since_parameter is a date in the future\n\nChange Details\nchanged  function that checks /Group/$export request to enforce check on _since parameter\n\nno further detail\nSecurity Implications\nNone\n\n\n new software dependencies\n\n\n\n security controls or supporting software altered\n\n\n\n new data stored or transmitted\n\n\n\n security checklist is completed for this change\n\n\n\n requires more information or team discussion to evaluate security implications\n\n\n\n[X ] no PHI/PII is affected by this change\n\n\nAcceptance Validation\n\nYes, with postman\n\nFeedback Requested\n\nGeneral", "createdAt": "2020-07-29T16:02:15Z", "url": "https://github.com/CMSgov/dpc-app/pull/935", "merged": true, "mergeCommit": {"oid": "e23f9d205f290a8aabf867e3ca27d8cef56a5315"}, "closed": true, "closedAt": "2020-10-30T05:40:11Z", "author": {"login": "richbraman"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3LrJYAH2gAyNDU4NTM0MzMxOmRiODlmODkyNzMxNTA1NjkxOWViMWE0MTc2YzBiZjM0NjE4ZmIyMzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXUn97gH2gAyNDU4NTM0MzMxOmZiZjlhYjQ3ZDhhYTYwMTdmYTA1Yzc3MWE3ZTE5ZTExYzliZmJjMzk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "db89f8927315056919eb1a4176c0bf34618fb236", "author": {"user": {"login": "richbraman", "name": "Richard Braman"}}, "url": "https://github.com/CMSgov/dpc-app/commit/db89f8927315056919eb1a4176c0bf34618fb236", "committedDate": "2020-07-21T19:48:00Z", "message": "add check to make sure _since parameter is not a future date"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3Njg5ODkw", "url": "https://github.com/CMSgov/dpc-app/pull/935#pullrequestreview-457689890", "createdAt": "2020-07-29T16:27:13Z", "commit": {"oid": "db89f8927315056919eb1a4176c0bf34618fb236"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNjoyNzoxM1rOG5Abpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNjoyNzoxM1rOG5Abpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQyOTA5NA==", "bodyText": "Doesn't _since allow much more precision?  Only considering the day wouldn't allow _since to be set to a time earlier in the day of the query.  There might be cases where this is useful (such as a known data dump, unit tests, etc.).", "url": "https://github.com/CMSgov/dpc-app/pull/935#discussion_r462429094", "createdAt": "2020-07-29T16:27:13Z", "author": {"login": "dhgreene"}, "path": "dpc-api/src/main/java/gov/cms/dpc/api/resources/v1/GroupResource.java", "diffHunk": "@@ -337,6 +339,10 @@ private OffsetDateTime handleSinceQueryParam(String since) {\n         try {\n             var dt = new DateTimeDt();\n             dt.setValueAsString(since);\n+            LocalDate today = LocalDate.now( ZoneOffset.UTC );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db89f8927315056919eb1a4176c0bf34618fb236"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7f52d99fee2e8ef34616569a53c9b071a7ab8ca", "author": {"user": {"login": "richbraman", "name": "Richard Braman"}}, "url": "https://github.com/CMSgov/dpc-app/commit/a7f52d99fee2e8ef34616569a53c9b071a7ab8ca", "committedDate": "2020-07-29T20:59:09Z", "message": "changed since to use more precise data type for comparison"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7a575480e2c37eb620f3a7a926bf0bf9124ce26", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/e7a575480e2c37eb620f3a7a926bf0bf9124ce26", "committedDate": "2020-10-16T16:38:53Z", "message": "Merge branch 'master' into rb/DPC-557"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a649640e5b264ea6733eaaf22c87a1eecf3fdbd", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/6a649640e5b264ea6733eaaf22c87a1eecf3fdbd", "committedDate": "2020-10-20T21:34:19Z", "message": "Updated _since to use OffsetDateTime, added unit tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMTc4ODAw", "url": "https://github.com/CMSgov/dpc-app/pull/935#pullrequestreview-513178800", "createdAt": "2020-10-20T22:23:34Z", "commit": {"oid": "6a649640e5b264ea6733eaaf22c87a1eecf3fdbd"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMjoyMzozNVrOHlTTqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMjoyMzozNVrOHlTTrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg3NTY4OQ==", "bodyText": "Refactor this method to not always return the same value.", "url": "https://github.com/CMSgov/dpc-app/pull/935#discussion_r508875689", "createdAt": "2020-10-20T22:23:35Z", "author": {"login": "codeclimate"}, "path": "dpc-api/src/main/java/gov/cms/dpc/api/resources/v1/GroupResource.java", "diffHunk": "@@ -331,24 +330,15 @@ private Group executeGroupOperation(UUID rosterID, Group groupUpdate, String ope\n         return resources;\n     }\n \n-    /**\n-     * Convert the '_since' {@link QueryParam} to a Date\n-     *\n-     * @param since - {@link String} an instant\n-     * @return - A {@link OffsetDateTime} for this since.\n-     */\n-    private OffsetDateTime handleSinceQueryParam(String since) {\n-        if (StringUtils.isEmpty(since)) {\n+    private OffsetDateTime handleSinceQueryParam(Optional<OffsetDateTimeParam> sinceParam) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a649640e5b264ea6733eaaf22c87a1eecf3fdbd"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg3NTY5Mw==", "bodyText": "Call \"sinceParam.isPresent()\" before accessing the value.", "url": "https://github.com/CMSgov/dpc-app/pull/935#discussion_r508875693", "createdAt": "2020-10-20T22:23:35Z", "author": {"login": "codeclimate"}, "path": "dpc-api/src/main/java/gov/cms/dpc/api/resources/v1/GroupResource.java", "diffHunk": "@@ -331,24 +330,15 @@ private Group executeGroupOperation(UUID rosterID, Group groupUpdate, String ope\n         return resources;\n     }\n \n-    /**\n-     * Convert the '_since' {@link QueryParam} to a Date\n-     *\n-     * @param since - {@link String} an instant\n-     * @return - A {@link OffsetDateTime} for this since.\n-     */\n-    private OffsetDateTime handleSinceQueryParam(String since) {\n-        if (StringUtils.isEmpty(since)) {\n+    private OffsetDateTime handleSinceQueryParam(Optional<OffsetDateTimeParam> sinceParam) {\n+        if (sinceParam.isEmpty()) {\n             return null;\n         }\n-        // check that _since is a valid time\n-        try {\n-            var dt = new DateTimeDt();\n-            dt.setValueAsString(since);\n-            return dt.getValue().toInstant().atOffset(ZoneOffset.UTC);\n-        } catch (DataFormatException ex) {\n-            throw new BadRequestException(\"'_since' query parameter must be a valid date time value\");\n+        OffsetDateTime now = OffsetDateTime.now(ZoneId.systemDefault());\n+        if (sinceParam.get().get().isAfter(now)){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a649640e5b264ea6733eaaf22c87a1eecf3fdbd"}, "originalPosition": 89}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a111aac76180a846c85b48c8261eae6662ef7c13", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/a111aac76180a846c85b48c8261eae6662ef7c13", "committedDate": "2020-10-20T23:01:40Z", "message": "Fixed code climate issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee1d02054dea55e6889d2ef4f7180ac3e6534dcd", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/ee1d02054dea55e6889d2ef4f7180ac3e6534dcd", "committedDate": "2020-10-20T23:37:25Z", "message": "Resolved merged conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e8a3b0222767d44fc1306e8580137b382ffc451", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/8e8a3b0222767d44fc1306e8580137b382ffc451", "committedDate": "2020-10-21T14:32:30Z", "message": "Fixed _since parse error message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fa27943fa33dad929d7627491ebb0ac7320b581", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/6fa27943fa33dad929d7627491ebb0ac7320b581", "committedDate": "2020-10-22T07:27:33Z", "message": "Merge branch 'master' into rb/DPC-557"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f086a14fce9f8be60906933c6bc8a7a8b4c0eed", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/2f086a14fce9f8be60906933c6bc8a7a8b4c0eed", "committedDate": "2020-10-23T03:27:02Z", "message": "Merge branch 'master' into rb/DPC-557"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eee93c63a40ac669e8855421e8049fa88a360f8e", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/eee93c63a40ac669e8855421e8049fa88a360f8e", "committedDate": "2020-10-23T03:33:16Z", "message": "Fixed merge issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1ODAyNjQ3", "url": "https://github.com/CMSgov/dpc-app/pull/935#pullrequestreview-515802647", "createdAt": "2020-10-23T15:57:56Z", "commit": {"oid": "eee93c63a40ac669e8855421e8049fa88a360f8e"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNTo1Nzo1NlrOHnT-Bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNjowODowM1rOHnUVpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk4MzY4Nw==", "bodyText": "did you mean to delete the doc string?", "url": "https://github.com/CMSgov/dpc-app/pull/935#discussion_r510983687", "createdAt": "2020-10-23T15:57:56Z", "author": {"login": "jonfulk"}, "path": "dpc-api/src/main/java/gov/cms/dpc/api/resources/v1/GroupResource.java", "diffHunk": "@@ -331,24 +331,19 @@ private Group executeGroupOperation(UUID rosterID, Group groupUpdate, String ope\n         return resources;\n     }\n \n-    /**\n-     * Convert the '_since' {@link QueryParam} to a Date\n-     *\n-     * @param since - {@link String} an instant\n-     * @return - A {@link OffsetDateTime} for this since.\n-     */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eee93c63a40ac669e8855421e8049fa88a360f8e"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk4OTczMw==", "bodyText": "When Will's related PR gets merged, we might want to move this stuff into the setUp method.", "url": "https://github.com/CMSgov/dpc-app/pull/935#discussion_r510989733", "createdAt": "2020-10-23T16:08:03Z", "author": {"login": "jonfulk"}, "path": "dpc-api/src/test/java/gov/cms/dpc/api/resources/v1/GroupResourceUnitTest.java", "diffHunk": "@@ -157,4 +171,112 @@ public void testCreateRosterProviderNotFound() {\n         Assertions.assertThrows(WebApplicationException.class, () -> resource.createRoster(organizationPrincipal, provenance, group));\n     }\n \n+    @Test\n+    public void testExportWithValidSinceParam(){\n+        UUID orgId = UUID.randomUUID();\n+        Organization organization = new Organization();\n+        organization.setId(orgId.toString());\n+        OrganizationPrincipal organizationPrincipal = new OrganizationPrincipal(organization);\n+\n+        String groupId = \"123456789\";\n+\n+        //Mock Group\n+        Group group = new Group();\n+        group.setId(groupId);\n+        group.addMember();\n+\n+        IReadExecutable<Group> readExec = Mockito.mock(IReadExecutable.class);\n+        Mockito.when(attributionClient.read().resource(Group.class).withId(new IdType(\"Group\", groupId)).encodedJson()).thenReturn(readExec);\n+        Mockito.when(readExec.execute()).thenReturn(group);\n+\n+        //Mock get bundle\n+        IOperationUntypedWithInput<Bundle> bundleOperation = Mockito.mock(IOperationUntypedWithInput.class);\n+        Mockito.when(attributionClient\n+                .operation()\n+                .onInstance(new IdType(groupId))\n+\n+                .named(\"patients\")\n+                .withParameters(Mockito.any(Parameters.class))\n+                .returnResourceType(Bundle.class)\n+                .useHttpGet()\n+                .encodedJson()).thenReturn(bundleOperation);\n+\n+        Mockito.when(bundleOperation.execute()).thenReturn(new Bundle());\n+        Meta bfdTransactionMeta = new Meta();\n+        Mockito.when(mockBfdClient.requestPatientFromServer(SYNTHETIC_BENE_ID, null).getMeta()).thenReturn(bfdTransactionMeta);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eee93c63a40ac669e8855421e8049fa88a360f8e"}, "originalPosition": 89}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc0aa2ef745547ffd6d54f575b11e87a385dc9de", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/cc0aa2ef745547ffd6d54f575b11e87a385dc9de", "committedDate": "2020-10-26T15:32:27Z", "message": "Merge branch 'master' into rb/DPC-557"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bfb24ded79d3542e3302fa50b029213171d7c1a", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/8bfb24ded79d3542e3302fa50b029213171d7c1a", "committedDate": "2020-10-28T23:43:37Z", "message": "Merge branch 'master' into rb/DPC-557"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5NzIwNzc3", "url": "https://github.com/CMSgov/dpc-app/pull/935#pullrequestreview-519720777", "createdAt": "2020-10-29T14:25:11Z", "commit": {"oid": "8bfb24ded79d3542e3302fa50b029213171d7c1a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbf9ab47d8aa6017fa05c771a7e19e11c9bfbc39", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/fbf9ab47d8aa6017fa05c771a7e19e11c9bfbc39", "committedDate": "2020-10-29T16:19:15Z", "message": "Merge branch 'master' into rb/DPC-557"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 445, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}