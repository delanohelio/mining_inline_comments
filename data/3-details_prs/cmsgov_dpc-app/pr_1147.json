{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyMjE1NjMz", "number": 1147, "title": "Added suport for id filter in Endpoint resource search", "bodyText": "Fixes DPC-974\n\nDuring the audit/risk assessment of DPC API it was discovered that path authorization for the /Endpoint resource was not functioning correctly.\nA fully authenticated client could have access to another organization's Endpoint resource and its operations (get,update,delete).\nAffected endpoints:\nGET /Endpoint\nPUT /Endpoint\nDelete /Endpoint\nCause:\nMacaroonsAuthenticator was attempting to authorize requests to Endpoint resource by using DPC-attribution's Endpoint search API. The MacaroonsAuthenticator attempted to search for an EndpointResource filtering by \"_id\" (id of the resource specified in the path by the client) and \"organization\" (Extracted from authenticated principal/token).\nIf the search returned a result it meant there was a resource with that specified id and belonging to the organization, so the request would pass the path filter and allow access to the resource.\nSince dpc-attribution did not support the \"_id\" filter param the actual search was only using \"organization\", therefore all resources for the organization were being returned from dpc-attribution to the filter, and the request was allowed to proceed.\nProposed Changes\n\nUpdate the Endpoint search in DPC-Attribution to support the filtering by resource id (_id query parameter).\nWrite integration tests to verify that the MacaroonsAuthenticator filter is working as intended.\n\n\nChange Details\n\nAdded optional _id filter parameter in EndpointResource search API\nAdded integration tests and updated existing tests.\n\nCurrently if a client attempts to retrieve, modify, or delete an Endpoint resource that does not exist the client is presented with a 404 Not Found response. After this patch the client will return a 401 Not Authorized regardless due to the filter's inability to distinguish between a resource not existing with the specified UUID or the resource existing but not belonging to the organization making the request.\nReturning a 401 for a resource not found is consistent with the rest of the resources using the PathAuthorizer, but we would need to discuss whether or not it's considered a breaking change.\n\nSecurity Implications\n\n\n new software dependencies\n\n\n\n security controls or supporting software altered\n\n\n\n new data stored or transmitted\n\n\n\n security checklist is completed for this change\n\n\n\n requires more information or team discussion to evaluate security implications\n\n\n\n no PHI/PII is affected by this change\n\n\nAcceptance Validation\n\n\nTested locally using integration tests\nmake ci-app and smoke-tests were successful locally\n\n\nFeedback Requested\n\nMostly on the integration tests, missing any? Changes? Holes?\nIs returning a 401 instead of a 404 considered a breaking change? If so, how should we communicate this?", "createdAt": "2020-12-18T00:32:11Z", "url": "https://github.com/CMSgov/dpc-app/pull/1147", "merged": true, "mergeCommit": {"oid": "2748eb5eea9c5ee72a12193605c61093e53e48d2"}, "closed": true, "closedAt": "2020-12-18T23:10:45Z", "author": {"login": "MrMorie"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdnNB0XAH2gAyNTQyMjE1NjMzOjdkNjUyMjJmY2NkOWQ1Y2Y4ZGFjYzg3OTNhNGU4MDNlNzU3MDY3Mzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdngO0nAFqTU1NTg2NjU0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7d65222fccd9d5cf8dacc8793a4e803e75706737", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/7d65222fccd9d5cf8dacc8793a4e803e75706737", "committedDate": "2020-12-18T00:31:02Z", "message": "Added suport for id filter in Endpoint resource search"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1NzE0OTY5", "url": "https://github.com/CMSgov/dpc-app/pull/1147#pullrequestreview-555714969", "createdAt": "2020-12-18T18:24:21Z", "commit": {"oid": "7d65222fccd9d5cf8dacc8793a4e803e75706737"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxODoyNDoyMVrOIIt1lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxOTowNTozNlrOIIvOjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjAxMDUxOA==", "bodyText": "Is this name consistent with other search or fetch methods in other DAOs? I like the shorter name, but maybe it could be more descriptive?", "url": "https://github.com/CMSgov/dpc-app/pull/1147#discussion_r546010518", "createdAt": "2020-12-18T18:24:21Z", "author": {"login": "jonfulk"}, "path": "dpc-attribution/src/main/java/gov/cms/dpc/attribution/jdbi/EndpointDAO.java", "diffHunk": "@@ -27,15 +29,22 @@ public EndpointEntity persistEndpoint(EndpointEntity endpointEntity) {\n         return Optional.ofNullable(get(endpointID));\n     }\n \n-    public List<EndpointEntity> findByOrganization(UUID organizationID) {\n+    public List<EndpointEntity> search(UUID organizationID, UUID endpointId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d65222fccd9d5cf8dacc8793a4e803e75706737"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjAzMzI5NQ==", "bodyText": "in the case where the organizationID and/or the endpointID is/are null, do we want to throw some sort of error? Otherwise, wouldn't we end up just not filtering the results by those predicates?", "url": "https://github.com/CMSgov/dpc-app/pull/1147#discussion_r546033295", "createdAt": "2020-12-18T19:05:36Z", "author": {"login": "jonfulk"}, "path": "dpc-attribution/src/main/java/gov/cms/dpc/attribution/jdbi/EndpointDAO.java", "diffHunk": "@@ -27,15 +29,22 @@ public EndpointEntity persistEndpoint(EndpointEntity endpointEntity) {\n         return Optional.ofNullable(get(endpointID));\n     }\n \n-    public List<EndpointEntity> findByOrganization(UUID organizationID) {\n+    public List<EndpointEntity> search(UUID organizationID, UUID endpointId) {\n         // Build a selection query to get records from the database\n         final CriteriaBuilder builder = currentSession().getCriteriaBuilder();\n         final CriteriaQuery<EndpointEntity> query = builder.createQuery(EndpointEntity.class);\n         final Root<EndpointEntity> root = query.from(EndpointEntity.class);\n         query.select(root);\n \n+        final List<Predicate> predicates = Lists.newArrayList();\n \n-        query.where(builder.equal(root.get(\"organization\").get(\"id\"), organizationID));\n+        if(organizationID!=null){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d65222fccd9d5cf8dacc8793a4e803e75706737"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1472024d3d94a8c9f5cfdc39bd1f38113c2f19b9", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/1472024d3d94a8c9f5cfdc39bd1f38113c2f19b9", "committedDate": "2020-12-18T21:05:25Z", "message": "Merge branch 'master' into sg/DPC-974-add-id-fiter-to-endpoint-search"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da5934f11c6e7ece73be348c06144abc1c6001d5", "author": {"user": {"login": "MrMorie", "name": "Salvador"}}, "url": "https://github.com/CMSgov/dpc-app/commit/da5934f11c6e7ece73be348c06144abc1c6001d5", "committedDate": "2020-12-18T22:37:51Z", "message": "Applied PR change requests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1ODY2NTQ4", "url": "https://github.com/CMSgov/dpc-app/pull/1147#pullrequestreview-555866548", "createdAt": "2020-12-18T22:53:26Z", "commit": {"oid": "da5934f11c6e7ece73be348c06144abc1c6001d5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 348, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}