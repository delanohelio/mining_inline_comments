{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIyMTMzNjU2", "number": 814, "title": "DPC-335: Verify public key with snippet signature", "bodyText": "Why\nValidation needs to be improved on public keys submitted by users.\nWhat Changed\nCreating a public key in the API now requires a signature. The signature is generated with the public key's corresponding private key, by signing a predefined text snippet. This applies to both the API /Key endpoint POST operation and the CLI key upload command. The endpoint now expects a JSON request body containing key and signature. The CLI command now must include a path to a file containing the signature.\nTickets closed:\nDPC-335\nDPC-336\nFuture Work\nThere is web app work in progress to go with these changes.\nChecklist\n\n All tests are passing via make ci-app (app change) and make ci-web (website change)\n Swagger documentation has been updated\n FHIR documentation has been updated\n Any required dpc-ops changes have a PR submitted and mentioned in this ticket\n Any manual migration steps are documented, scripts written (where applicable), and tested\n Before merging, any required dpc-ops changes have been approved and merged into master of the dpc-ops repo", "createdAt": "2020-05-22T20:52:17Z", "url": "https://github.com/CMSgov/dpc-app/pull/814", "merged": true, "mergeCommit": {"oid": "9abe563da8c64da428ace1069544bfbc06d676f6"}, "closed": true, "closedAt": "2020-06-04T13:29:16Z", "author": {"login": "em1"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcj448ngFqTQxNzE4NDMzOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcn9wpCAH2gAyNDIyMTMzNjU2OmQxYzhkMTNmZWYyN2EzNjg2ZTRjOTUyNjRiZTk3NTU3Y2E5ZTZkZTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MTg0MzM5", "url": "https://github.com/CMSgov/dpc-app/pull/814#pullrequestreview-417184339", "createdAt": "2020-05-22T21:10:19Z", "commit": {"oid": "e4cd0c7e7b343b7bab1a4663f30feae9401d4d15"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQyMToxMDoxOVrOGZjsog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQyMToxMDoxOVrOGZjsog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ1MjQ1MA==", "bodyText": "Method uploadKey has 5 arguments (exceeds 4 allowed). Consider refactoring.", "url": "https://github.com/CMSgov/dpc-app/pull/814#discussion_r429452450", "createdAt": "2020-05-22T21:10:19Z", "author": {"login": "codeclimate"}, "path": "dpc-api/src/main/java/gov/cms/dpc/api/cli/keys/KeyUpload.java", "diffHunk": "@@ -59,25 +70,31 @@ public void run(Bootstrap<?> bootstrap, Namespace namespace) throws Exception {\n         System.out.println(String.format(\"Connecting to API service at: %s\", apiService));\n \n         // Read the file and parse it\n-        final Path filePath = FileSystems.getDefault().getPath(namespace.getString(KEY_FILE));\n-        final String pemFile = Files.readString(filePath);\n+        final Path keyFilePath = FileSystems.getDefault().getPath(namespace.getString(KEY_FILE));\n+        final String publicKey = Files.readString(keyFilePath);\n+\n+        final Path signaturePath = FileSystems.getDefault().getPath(namespace.getString(SIGNATURE_FILE));\n+        final String signature = Files.readString(signaturePath);\n \n         final Optional<String> label = Optional.ofNullable(namespace.getString(\"key-label\"));\n-        uploadKey(apiService, orgID.getIdPart(), label, pemFile);\n+        uploadKey(apiService, orgID.getIdPart(), label, publicKey, signature);\n     }\n \n     @SuppressWarnings(\"OptionalUsedAsFieldOrParameterType\")\n-    private void uploadKey(String apiService, String orgID, Optional<String> label, String pem) throws IOException, URISyntaxException {\n+    private void uploadKey(String apiService, String orgID, Optional<String> label, String pem, String signature) throws IOException, URISyntaxException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4cd0c7e7b343b7bab1a4663f30feae9401d4d15"}, "originalPosition": 57}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e4cd0c7e7b343b7bab1a4663f30feae9401d4d15", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/e4cd0c7e7b343b7bab1a4663f30feae9401d4d15", "committedDate": "2020-05-22T20:51:18Z", "message": "CLI test fixes"}, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4MzczNzk3", "url": "https://github.com/CMSgov/dpc-app/pull/814#pullrequestreview-418373797", "createdAt": "2020-05-26T14:47:01Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxNDo0NzowMVrOGahy9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxNDo0NzowMVrOGahy9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ2OTg3OA==", "bodyText": "Are we certain at this point in the code that we're not dealing with an ECC signature?", "url": "https://github.com/CMSgov/dpc-app/pull/814#discussion_r430469878", "createdAt": "2020-05-26T14:47:01Z", "author": {"login": "dhgreene"}, "path": "dpc-api/src/main/java/gov/cms/dpc/api/auth/jwt/PublicKeyHandler.java", "diffHunk": "@@ -91,6 +90,30 @@ public static void validatePublicKey(SubjectPublicKeyInfo value) {\n \n     }\n \n+    public static boolean verifySignature(String publicKeyPem, String snippet, String sigStr) {\n+        String keyStr = publicKeyPem\n+                .replace(\"-----BEGIN PUBLIC KEY-----\", \"\")\n+                .replace(\"-----END PUBLIC KEY-----\", \"\")\n+                .replaceAll(\"[\\n\\r]+\", \"\");\n+        sigStr = sigStr.replaceAll(\"[\\n\\r]+\", \"\");\n+\n+        try {\n+            byte[] keyBytes = Base64.getDecoder().decode(keyStr);\n+            X509EncodedKeySpec keySpec = new X509EncodedKeySpec(keyBytes);\n+            KeyFactory keyFactory = KeyFactory.getInstance(\"RSA\");\n+            PublicKey publicKey = keyFactory.generatePublic(keySpec);\n+\n+            Signature signature = Signature.getInstance(\"SHA256withRSA\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 31}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "3ee0ca4312f0cbaaa8000815849af64805ad6f92", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/3ee0ca4312f0cbaaa8000815849af64805ad6f92", "committedDate": "2020-05-26T17:44:38Z", "message": "Reject ECC keys (temporarily); testing cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "892f4a88e97d399ac3f713ee07de91c345cfe9ab", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/892f4a88e97d399ac3f713ee07de91c345cfe9ab", "committedDate": "2020-05-28T12:46:03Z", "message": "Public key/signature verification in progress"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26da4a0e20dd3c03607e4acbcce127e8593f6f18", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/26da4a0e20dd3c03607e4acbcce127e8593f6f18", "committedDate": "2020-05-28T12:46:06Z", "message": "Accept key and signature as JSON"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d5a033bcdef7e18a7ea8f5c6fed0eb73bb323b2", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/9d5a033bcdef7e18a7ea8f5c6fed0eb73bb323b2", "committedDate": "2020-05-28T12:46:06Z", "message": "Accept signature with CLI key creation; skip ECC tests temporarily"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3b9016b04448554c3edb2786b547193f05bd2ac", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/f3b9016b04448554c3edb2786b547193f05bd2ac", "committedDate": "2020-05-28T12:46:06Z", "message": "CLI test fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7ac73fc59ddc9dca74a86c1c20885b0365a9ac8", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/d7ac73fc59ddc9dca74a86c1c20885b0365a9ac8", "committedDate": "2020-05-28T12:46:07Z", "message": "Address Code Climate exception message issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe2f4699a26feed6bad99bd213421d9a76614f5f", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/fe2f4699a26feed6bad99bd213421d9a76614f5f", "committedDate": "2020-05-28T12:46:07Z", "message": "Reject ECC keys (temporarily); testing cleanup"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3ee0ca4312f0cbaaa8000815849af64805ad6f92", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/3ee0ca4312f0cbaaa8000815849af64805ad6f92", "committedDate": "2020-05-26T17:44:38Z", "message": "Reject ECC keys (temporarily); testing cleanup"}, "afterCommit": {"oid": "fe2f4699a26feed6bad99bd213421d9a76614f5f", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/fe2f4699a26feed6bad99bd213421d9a76614f5f", "committedDate": "2020-05-28T12:46:07Z", "message": "Reject ECC keys (temporarily); testing cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38de5015e141068b31f1bf5987eb5af14da7ff15", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/38de5015e141068b31f1bf5987eb5af14da7ff15", "committedDate": "2020-05-28T15:16:06Z", "message": "Adjustment for Code Climate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "930541c5d941bb8a34b0cbc537925db3a5f8b031", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/930541c5d941bb8a34b0cbc537925db3a5f8b031", "committedDate": "2020-05-28T21:32:43Z", "message": "Change verifySignature() to throw an exception rather than returning false, to be consistent with other methods"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMTI0MDg0", "url": "https://github.com/CMSgov/dpc-app/pull/814#pullrequestreview-422124084", "createdAt": "2020-06-01T19:35:39Z", "commit": {"oid": "930541c5d941bb8a34b0cbc537925db3a5f8b031"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMTQ3NjEx", "url": "https://github.com/CMSgov/dpc-app/pull/814#pullrequestreview-422147611", "createdAt": "2020-06-01T20:12:39Z", "commit": {"oid": "930541c5d941bb8a34b0cbc537925db3a5f8b031"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1c8d13fef27a3686e4c95264be97557ca9e6de0", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/d1c8d13fef27a3686e4c95264be97557ca9e6de0", "committedDate": "2020-06-04T13:06:28Z", "message": "Merge branch 'master' into emily/dpc-335-verify-signature"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 143, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}