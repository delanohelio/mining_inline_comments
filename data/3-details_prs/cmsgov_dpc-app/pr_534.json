{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyMzI4MjM4", "number": 534, "title": "DPC-760: Add support for ECC keys", "bodyText": "Why\nIn order to help push folks towards a better security posture, we'd like to add support for ECC signing keys for JWTs. This would be in addition to our existing support for RSA keys.\nWhat Changed\nUpdated the PublicKeyHandler class to support both RSA and ECC key types.\nAll of the unit tests have been updated to parametrize over both key types, to ensure we don't break anything.\nThe primary change is to verify the OID parameters for the key types to determine whether it's an RSA key or an ECC key and route to the appropriate validation logic. The core of the class hasn't been touched as Java pretty much does the right thing out of the box.\nNote: This PR does NOT implement the ECC crypto functions, Java handles all that for us, and the main OID/ASN parsing is done by BouncyCastle. This PR is merely about ensuring the ECC keys have the correct curves and get serialized/deserialized correctly.\nAs part of DPC-759, I've added some sanity checks to the handler, to verify that the keys are the appropriate type and length, which is the main use for the OID verification.\nWe're now generating ECC keys by default for our integration tests, though we may want to change this in the future.\nChoices Made\nAt this point, we're only supporting two ECC curves:\nsecp256r1 and secp384r1, this is because we have to manually check the OIDs and it seemed simpler to only support the two most common curves.\nThe Smart Backend Spec says we should only support secp384, but Apple's secure enclave only supports secp256, so we're doing both. I've notified the SMART on FHIR team of our deviation from the spec, and the reasons for doing so.\nTickets closed:\nDPC-760\nDPC-759: Add sanity checking to RSA keys\nFuture Work\nList any additional tickets that have either been created due to work in this PR, or existing tickets that expand upon the feature or provide additional fixes.\nChecklist\n\n All tests are passing via make ci-app (app change) and make ci-web (website change)\n Swagger documentation has been updated\n FHIR documentation has been updated\n Any required dpc-ops changes have a PR submitted and mentioned in this ticket\n Any manual migration steps are documented, scripts written (where applicable), and tested\n Before merging, any required dpc-ops changes have been approved and merged into master of the dpc-ops repo", "createdAt": "2020-01-13T21:23:02Z", "url": "https://github.com/CMSgov/dpc-app/pull/534", "merged": true, "mergeCommit": {"oid": "0a13720dd435a0790fcaea9ac2e1065646caa8e7"}, "closed": true, "closedAt": "2020-02-28T15:48:44Z", "author": {"login": "nickrobison-usds"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBKVcogFqTM1MzM4MTI1MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIxMRrAH2gAyMzYyMzI4MjM4Ojc2MGI5NjgwODEwM2U1OWI5ZjFjMTkzODNkOGYyMjRjZTgwMTliYmU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMzgxMjUw", "url": "https://github.com/CMSgov/dpc-app/pull/534#pullrequestreview-353381250", "createdAt": "2020-02-04T23:42:29Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMzo0MjoyOVrOFlnZdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMzo0MjoyOVrOFlnZdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk4NzEyNg==", "bodyText": "Could these use the identifiers in BouncyCastle? For example SECObjectIdentifiers.secp384r1 for 1.3.132.0.34.", "url": "https://github.com/CMSgov/dpc-app/pull/534#discussion_r374987126", "createdAt": "2020-02-04T23:42:29Z", "author": {"login": "em1"}, "path": "dpc-api/src/main/java/gov/cms/dpc/api/auth/jwt/PublicKeyHandler.java", "diffHunk": "@@ -18,6 +20,13 @@\n \n public class PublicKeyHandler {\n \n+    static final ASN1ObjectIdentifier RSA_PARENT = new ASN1ObjectIdentifier(\"1.2.840.113549\");\n+    static final ASN1ObjectIdentifier ECC_KEY = new ASN1ObjectIdentifier(\"1.2.840.10045.2.1\");\n+    // ECC Curve names are defined here: https://tools.ietf.org/search/rfc4492#section-5.1.1\n+    // They're in two separate namespaces, certicom and ansi-x962\n+    static final ASN1ObjectIdentifier SECP256_KEY = new ASN1ObjectIdentifier(\"1.2.840.10045.3.1.7\");\n+    static final ASN1ObjectIdentifier SECP384_KEY = new ASN1ObjectIdentifier(\"1.3.132.0.34\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e20e50f28699c97d32d3b747220118df3862db33", "author": {"user": {"login": "nickrobison-usds", "name": "Nick Robison"}}, "url": "https://github.com/CMSgov/dpc-app/commit/e20e50f28699c97d32d3b747220118df3862db33", "committedDate": "2020-02-05T15:23:02Z", "message": "DPC-759: Add initial compliance checks for public keys\n\nWe now check that a given RSA key is at least 4096 bits long."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99b5f934224cc45c8a2461ee73a5d1634a8478ce", "author": {"user": {"login": "nickrobison-usds", "name": "Nick Robison"}}, "url": "https://github.com/CMSgov/dpc-app/commit/99b5f934224cc45c8a2461ee73a5d1634a8478ce", "committedDate": "2020-02-05T15:23:02Z", "message": "DPC-760: Initial support for flowing ECC keys through the auth handler tests.\n\nUpdated hardcoded RSA values to check the algorithm OID before dispatching to either RSA or ECC key handling."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "815923488d3a087a23c71398926e181e3314fe46", "author": {"user": {"login": "nickrobison-usds", "name": "Nick Robison"}}, "url": "https://github.com/CMSgov/dpc-app/commit/815923488d3a087a23c71398926e181e3314fe46", "committedDate": "2020-02-05T15:23:02Z", "message": "DPC-759: Added checks to ECC keys\n\nWe now look at the Parameter OID to ensure we have one of two ECC curves that we currently support."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b8aea53707a105f803d765668a0ff361bfb9f31", "author": {"user": {"login": "nickrobison-usds", "name": "Nick Robison"}}, "url": "https://github.com/CMSgov/dpc-app/commit/5b8aea53707a105f803d765668a0ff361bfb9f31", "committedDate": "2020-02-05T15:27:44Z", "message": "DPC-759: JWT Unit tests are now parameterized across key types\n\nWe test every operation with both RSA and ECC keys."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd6d721833ed1e51201b16eafa0c5df8cf4bca90", "author": {"user": {"login": "nickrobison-usds", "name": "Nick Robison"}}, "url": "https://github.com/CMSgov/dpc-app/commit/cd6d721833ed1e51201b16eafa0c5df8cf4bca90", "committedDate": "2020-02-05T15:27:44Z", "message": "squash"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44e7317a3d46f95188503a56c0a004c6c89a45c8", "author": {"user": {"login": "nickrobison-usds", "name": "Nick Robison"}}, "url": "https://github.com/CMSgov/dpc-app/commit/44e7317a3d46f95188503a56c0a004c6c89a45c8", "committedDate": "2020-02-05T15:28:38Z", "message": "DPC-760: Updated secure test helper to use the correct signing algorithm for ECC keys"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "495515177e39c37f437255de3d8e5f71e5f612f8", "author": {"user": {"login": "nickrobison-usds", "name": "Nick Robison"}}, "url": "https://github.com/CMSgov/dpc-app/commit/495515177e39c37f437255de3d8e5f71e5f612f8", "committedDate": "2020-02-05T15:28:38Z", "message": "DPC-760: Update failing integration tests\n\nMissed a few places where the tests weren't passing.\nMoved the signing algorithm helper into the APITestHelpers class."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef100d191b74091c1792c429d39b849069a1099a", "author": {"user": {"login": "nickrobison-usds", "name": "Nick Robison"}}, "url": "https://github.com/CMSgov/dpc-app/commit/ef100d191b74091c1792c429d39b849069a1099a", "committedDate": "2020-02-05T15:28:38Z", "message": "DPC-760: Update documentation with new key requirements.\n\nClarify that we now support ECC keys and give the required curves."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "003d3fed7b8bc04d8156cf419147c21803cd4564", "author": {"user": {"login": "nickrobison-usds", "name": "Nick Robison"}}, "url": "https://github.com/CMSgov/dpc-app/commit/003d3fed7b8bc04d8156cf419147c21803cd4564", "committedDate": "2020-02-05T15:28:38Z", "message": "DPC-760: Address code review comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6baddfaea9355d15fed85ade4426c8faf41c97c", "author": {"user": {"login": "nickrobison-usds", "name": "Nick Robison"}}, "url": "https://github.com/CMSgov/dpc-app/commit/a6baddfaea9355d15fed85ade4426c8faf41c97c", "committedDate": "2020-02-05T15:28:38Z", "message": "DPC-760: Migrate to BouncyCastle SEC identifiers\n\nRather than creating our own OID values, we should use the ones provided by BounceyCastle, which is a great find!"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "a6baddfaea9355d15fed85ade4426c8faf41c97c", "author": {"user": {"login": "nickrobison-usds", "name": "Nick Robison"}}, "url": "https://github.com/CMSgov/dpc-app/commit/a6baddfaea9355d15fed85ade4426c8faf41c97c", "committedDate": "2020-02-05T15:28:38Z", "message": "DPC-760: Migrate to BouncyCastle SEC identifiers\n\nRather than creating our own OID values, we should use the ones provided by BounceyCastle, which is a great find!"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9b73f3eff3b401ae7581e838bfa6504c0ef7bef", "author": {"user": {"login": "nickrobison-usds", "name": "Nick Robison"}}, "url": "https://github.com/CMSgov/dpc-app/commit/e9b73f3eff3b401ae7581e838bfa6504c0ef7bef", "committedDate": "2020-02-05T17:11:00Z", "message": "DPC-760: Updated JWTUnit tests after merge.\n\nUpdated the JWTUnitTests file to account for changes that happened after the PR was opened.\n\nFixed an issue where the tests were always using an ECC key for checking the signing, we now generate a fresh one on each test invocation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e354eba5feedabe00023c4b0cb06a762b9877e2a", "author": {"user": {"login": "nickrobison-usds", "name": "Nick Robison"}}, "url": "https://github.com/CMSgov/dpc-app/commit/e354eba5feedabe00023c4b0cb06a762b9877e2a", "committedDate": "2020-02-05T19:11:30Z", "message": "DPC-760: Use the correct enum value for the ECC curve OID."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNTcwNjYz", "url": "https://github.com/CMSgov/dpc-app/pull/534#pullrequestreview-363570663", "createdAt": "2020-02-24T17:32:41Z", "commit": {"oid": "e354eba5feedabe00023c4b0cb06a762b9877e2a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MDcxMzcw", "url": "https://github.com/CMSgov/dpc-app/pull/534#pullrequestreview-365071370", "createdAt": "2020-02-26T16:54:24Z", "commit": {"oid": "e354eba5feedabe00023c4b0cb06a762b9877e2a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NDM4Nzgw", "url": "https://github.com/CMSgov/dpc-app/pull/534#pullrequestreview-366438780", "createdAt": "2020-02-28T14:33:13Z", "commit": {"oid": "e354eba5feedabe00023c4b0cb06a762b9877e2a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "760b96808103e59b9f1c19383d8f224ce8019bbe", "author": {"user": {"login": "nickrobison-usds", "name": "Nick Robison"}}, "url": "https://github.com/CMSgov/dpc-app/commit/760b96808103e59b9f1c19383d8f224ce8019bbe", "committedDate": "2020-02-28T14:56:14Z", "message": "Merge branch 'master' into nickrobison/DPC-760-ecc-keys"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 205, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}