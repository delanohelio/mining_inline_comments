{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcxODYwMzky", "number": 996, "title": "DPC 641 match org or provider to any fields", "bodyText": "Fixes DPC-641\n\nWant to match the job's organization NPI to any NPIs found in the EoB or the job's provider NPI to any NPIs found in the EoB\nProposed Changes\n\nChange Details\n\nMove the different combinations of matches to LookBackAnswer object\n\nSecurity Implications\n\n\n new software dependencies\n\n\n\n security controls or supporting software altered\n\n\n\n new data stored or transmitted\n\n\n\n security checklist is completed for this change\n\n\n\n requires more information or team discussion to evaluate security implications\n\n\n\n no PHI/PII is affected by this change\n\n\nAcceptance Validation\n\n\nFeedback Requested", "createdAt": "2020-08-21T21:21:53Z", "url": "https://github.com/CMSgov/dpc-app/pull/996", "merged": true, "mergeCommit": {"oid": "9a3b96c01e9c0d7fdefbbd4046774e1d1f02e645"}, "closed": true, "closedAt": "2020-08-31T21:40:04Z", "author": {"login": "MrBilnon"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAnGqygH2gAyNDcxODYwMzkyOjMyMWM0MjU1ZGU3ZjIyOGY3NDM2YjJkYzJlYmU0MGY4ODNkYzkzMTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEZhxlgFqTQ3ODk2MTYxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "321c4255de7f228f7436b2dc2ebe40f883dc9310", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/321c4255de7f228f7436b2dc2ebe40f883dc9310", "committedDate": "2020-08-20T02:50:49Z", "message": "tweak logging to one line"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6489d6ed5ab811dd022438c3efd04b79d2cb2399", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/6489d6ed5ab811dd022438c3efd04b79d2cb2399", "committedDate": "2020-08-20T14:53:26Z", "message": "change log variables, fix a code climate complaint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c28e3c4df8afe31acaa4a573a46a161f7284e4ac", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/c28e3c4df8afe31acaa4a573a46a161f7284e4ac", "committedDate": "2020-08-20T14:54:10Z", "message": "Merge branch 'master' into DPC-389-tweak-logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "caf358053072069b55358b8b46eee4f9e88b8ee4", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/caf358053072069b55358b8b46eee4f9e88b8ee4", "committedDate": "2020-08-20T22:30:24Z", "message": "log more"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cab2a2dd7f66eea8b364243f4a97ccc053dbede5", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/cab2a2dd7f66eea8b364243f4a97ccc053dbede5", "committedDate": "2020-08-20T22:30:32Z", "message": "Merge remote-tracking branch 'origin/DPC-389-tweak-logging' into DPC-389-tweak-logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "971d467f8b025dcf40efca332c3d53e3913d6b0e", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/971d467f8b025dcf40efca332c3d53e3913d6b0e", "committedDate": "2020-08-20T22:53:44Z", "message": "fix missing comma"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7580a9f7156de0d35ef88bae2382dc76d1e9a608", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/7580a9f7156de0d35ef88bae2382dc76d1e9a608", "committedDate": "2020-08-21T15:29:38Z", "message": "Merge branch 'master' into DPC-389-tweak-logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd55e41deb9ea550abb7a6624f693e1eab983cbf", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/bd55e41deb9ea550abb7a6624f693e1eab983cbf", "committedDate": "2020-08-21T17:50:30Z", "message": "Merge branch 'master' into DPC-389-tweak-logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df6c9264904066ccbae8cc3b242e7ed783de39da", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/df6c9264904066ccbae8cc3b242e7ed783de39da", "committedDate": "2020-08-21T21:18:21Z", "message": "match the org or provider npi to any npi fields in the eob"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b85a1c6477c5155f2594e6a3890c7670b2943d2f", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/b85a1c6477c5155f2594e6a3890c7670b2943d2f", "committedDate": "2020-08-28T15:49:48Z", "message": "change list to string joine by semi colon for dpc json parsing to be successful"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "322e970b0c43f32e9cd0678dda94630f98a7fdf5", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/322e970b0c43f32e9cd0678dda94630f98a7fdf5", "committedDate": "2020-08-28T17:52:34Z", "message": "Merge branch 'master' of https://github.com/CMSgov/dpc-app"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a2f280ee70e06a63cdc69eca2c455cb76a22833", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/9a2f280ee70e06a63cdc69eca2c455cb76a22833", "committedDate": "2020-08-31T20:05:49Z", "message": "Merge branch 'master' into wh/DPC-641-match-org-or-provider-to-any-fields\n\n# Conflicts:\n#\tdpc-aggregation/src/main/java/gov/cms/dpc/aggregation/service/LookBackAnswer.java\n#\tdpc-aggregation/src/main/java/gov/cms/dpc/aggregation/service/LookBackServiceImpl.java\n#\tdpc-aggregation/src/test/java/gov/cms/dpc/aggregation/service/LookBackServiceImplTest.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4OTI2NzM4", "url": "https://github.com/CMSgov/dpc-app/pull/996#pullrequestreview-478926738", "createdAt": "2020-08-31T20:21:51Z", "commit": {"oid": "df6c9264904066ccbae8cc3b242e7ed783de39da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMDoyMTo1MVrOHKH6rQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMDoyMTo1MVrOHKH6rQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDM3NzUxNw==", "bodyText": "Do we want to null check the providerOrRosterID before getting UUID?", "url": "https://github.com/CMSgov/dpc-app/pull/996#discussion_r480377517", "createdAt": "2020-08-31T20:21:51Z", "author": {"login": "MrMorie"}, "path": "dpc-aggregation/src/main/java/gov/cms/dpc/aggregation/service/LookBackServiceImpl.java", "diffHunk": "@@ -39,94 +39,64 @@ public LookBackServiceImpl(RosterDAO rosterDAO, OrganizationDAO organizationDAO,\n     @UnitOfWork(readOnly = true)\n     public String getProviderNPIFromRoster(UUID orgUUID, String providerOrRosterID, String patientMBI) {\n         //Expect only one roster for the parameters, otherwise return null\n-        String npi = rosterDAO.retrieveProviderNPIFromRoster(orgUUID, UUID.fromString(providerOrRosterID), patientMBI).orElse(null);\n-        LOGGER.info(\"jobProviderNPI={}\", npi);\n-        return npi;\n+        return rosterDAO.retrieveProviderNPIFromRoster(orgUUID, UUID.fromString(providerOrRosterID), patientMBI).orElse(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df6c9264904066ccbae8cc3b242e7ed783de39da"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4OTMwMDYz", "url": "https://github.com/CMSgov/dpc-app/pull/996#pullrequestreview-478930063", "createdAt": "2020-08-31T20:26:58Z", "commit": {"oid": "df6c9264904066ccbae8cc3b242e7ed783de39da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMDoyNjo1OFrOHKIE1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMDoyNjo1OFrOHKIE1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDM4MDExNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private Pair<String, Set<String>> extractPractionerNPIs(ExplanationOfBenefit explanationOfBenefit) {\n          \n          \n            \n                private Pair<String, Set<String>> extractPractitionerNPIs(ExplanationOfBenefit explanationOfBenefit) {", "url": "https://github.com/CMSgov/dpc-app/pull/996#discussion_r480380116", "createdAt": "2020-08-31T20:26:58Z", "author": {"login": "em1"}, "path": "dpc-aggregation/src/main/java/gov/cms/dpc/aggregation/service/LookBackServiceImpl.java", "diffHunk": "@@ -39,94 +39,64 @@ public LookBackServiceImpl(RosterDAO rosterDAO, OrganizationDAO organizationDAO,\n     @UnitOfWork(readOnly = true)\n     public String getProviderNPIFromRoster(UUID orgUUID, String providerOrRosterID, String patientMBI) {\n         //Expect only one roster for the parameters, otherwise return null\n-        String npi = rosterDAO.retrieveProviderNPIFromRoster(orgUUID, UUID.fromString(providerOrRosterID), patientMBI).orElse(null);\n-        LOGGER.info(\"jobProviderNPI={}\", npi);\n-        return npi;\n+        return rosterDAO.retrieveProviderNPIFromRoster(orgUUID, UUID.fromString(providerOrRosterID), patientMBI).orElse(null);\n     }\n \n     @Override\n     @UnitOfWork(readOnly = true)\n-    public boolean hasClaimWithin(ExplanationOfBenefit explanationOfBenefit, UUID organizationUUID, String providerUUID, long withinMonth) {\n-        Optional<Date> billingPeriod = Optional.ofNullable(explanationOfBenefit)\n+    public boolean hasClaimWithin(ExplanationOfBenefit explanationOfBenefit, UUID organizationUUID, String providerNPI, long withinMonth) {\n+        MDC.put(EOB_ID, explanationOfBenefit.getId());\n+        Date billingPeriod = Optional.of(explanationOfBenefit)\n                 .map(ExplanationOfBenefit::getBillablePeriod)\n-                .map(Period::getEnd);\n-\n-        Optional<String> providerID = Optional.ofNullable(providerUUID);\n+                .map(Period::getEnd)\n+                .orElse(null);\n \n-        Optional<String> organizationID = organizationDAO.fetchOrganizationNPI(organizationUUID);\n+        String organizationID = organizationDAO.fetchOrganizationNPI(organizationUUID).orElse(null);\n \n-        Optional<String> eobOrganizationID = Optional.ofNullable(explanationOfBenefit)\n+        String eobOrganizationID = Optional.of(explanationOfBenefit)\n                 .map(ExplanationOfBenefit::getOrganization)\n                 .map(Reference::getIdentifier)\n                 .filter(i -> DPCIdentifierSystem.NPPES.getSystem().equals(i.getSystem()))\n-                .map(Identifier::getValue);\n-\n-        Set<String> eobProviderNPIs = extractPractionerNPIs(explanationOfBenefit);\n-\n-        LOGGER.info(\"billingPeriod={}\", billingPeriod.orElse(null));\n-        LOGGER.info(\"eobOrganizationID={}\", eobOrganizationID.orElse(null));\n-        LOGGER.info(\"jobOrganizationID={}\", organizationID.orElse(null));\n-\n-        if (billingPeriod.isEmpty() || providerID.isEmpty() || organizationID.isEmpty() || eobOrganizationID.isEmpty()) {\n-            LOGGER.info(\"eob BillingPeriod or job providerID or job organizationID or eob OrganizationID are null\");\n-            return false;\n-        }\n-\n-        long lookBackMonthsDifference = getMonthsDifference(billingPeriod.get(), operationsConfig.getLookBackDate());\n-        boolean eobContainsProvider = eobProviderNPIs.contains(providerID.get());\n-        boolean eobRelatedToOrganization = organizationID.get().equals(eobOrganizationID.get());\n-        boolean eobWithinLookBackLimit = lookBackMonthsDifference < withinMonth;\n-\n-        boolean hasClaim = eobWithinLookBackLimit\n-                && eobContainsProvider\n-                && eobRelatedToOrganization;\n-\n-        LOGGER.info(\"LookBack stats eobWithinLookBackLimit={}, eobContainsProvider={}, eobRelatedToOrganization={}, eobMonthsDifference={}, hasClaim={}\",\n-                eobWithinLookBackLimit, eobContainsProvider, eobRelatedToOrganization, lookBackMonthsDifference, hasClaim);\n-\n-        return hasClaim;\n+                .map(Identifier::getValue)\n+                .orElse(null);\n+\n+        Pair<String, Set<String>> npis = extractPractionerNPIs(explanationOfBenefit);\n+        Set<String> allNPIs = new HashSet<>(npis.getRight());\n+        allNPIs.add(npis.getLeft());\n+\n+        LookBackAnswer lookBackAnswer = new LookBackAnswer(providerNPI, organizationID, withinMonth, operationsConfig.getLookBackDate())\n+                .addEobBillingPeriod(billingPeriod)\n+                .addEobOrganization(eobOrganizationID)\n+                .addEobProviders(allNPIs);\n+        LOGGER.info(\"billingPeriodDate={}, lookBackDate={}, monthsDifference={}, eobProvider={}, eobCareTeamProviders={}, jobProvider={}, eobOrganization={}, jobOrganization={}, withinLimit={}, eobProviderMatch={}, eobOrganizationMatch={}\",\n+                billingPeriod, operationsConfig.getLookBackDate(), lookBackAnswer.calculatedMonthDifference(), npis.getLeft(), npis.getRight(), providerNPI, eobOrganizationID,\n+                organizationID, lookBackAnswer.matchDateCriteria(), lookBackAnswer.providerMatchEob(), lookBackAnswer.orgMatchEob());\n+\n+        MDC.remove(EOB_ID);\n+        return lookBackAnswer.matchDateCriteria() && (lookBackAnswer.orgNPIMatchAnyEobNPIs() || lookBackAnswer.providerNPIMatchAnyEobNPIs());\n     }\n \n-    private Set<String> extractPractionerNPIs(ExplanationOfBenefit explanationOfBenefit) {\n-        Set<String> eobProviderNPIs = new HashSet<>();\n-        Optional<String> providerNPI = Optional.ofNullable(explanationOfBenefit)\n+    private Pair<String, Set<String>> extractPractionerNPIs(ExplanationOfBenefit explanationOfBenefit) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df6c9264904066ccbae8cc3b242e7ed783de39da"}, "originalPosition": 104}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe4cbd60220174542c318c880a20dd291b9aeac5", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/fe4cbd60220174542c318c880a20dd291b9aeac5", "committedDate": "2020-08-31T20:41:43Z", "message": "change variable names"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4OTQwNTA5", "url": "https://github.com/CMSgov/dpc-app/pull/996#pullrequestreview-478940509", "createdAt": "2020-08-31T20:43:24Z", "commit": {"oid": "df6c9264904066ccbae8cc3b242e7ed783de39da"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9504d3030aca4d789c2ef8610887a0d88b47af14", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/9504d3030aca4d789c2ef8610887a0d88b47af14", "committedDate": "2020-08-31T20:54:00Z", "message": "Merge branch 'master' into wh/DPC-641-match-org-or-provider-to-any-fields"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4OTQ4NDc3", "url": "https://github.com/CMSgov/dpc-app/pull/996#pullrequestreview-478948477", "createdAt": "2020-08-31T20:56:06Z", "commit": {"oid": "9504d3030aca4d789c2ef8610887a0d88b47af14"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4OTUxNTQ1", "url": "https://github.com/CMSgov/dpc-app/pull/996#pullrequestreview-478951545", "createdAt": "2020-08-31T21:00:37Z", "commit": {"oid": "9504d3030aca4d789c2ef8610887a0d88b47af14"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4OTYxNjE4", "url": "https://github.com/CMSgov/dpc-app/pull/996#pullrequestreview-478961618", "createdAt": "2020-08-31T21:17:27Z", "commit": {"oid": "9504d3030aca4d789c2ef8610887a0d88b47af14"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMToxNzoyN1rOHKJjNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMToxNzoyN1rOHKJjNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQwNDI3Nw==", "bodyText": "Similar blocks of code found in 5 locations. Consider refactoring.", "url": "https://github.com/CMSgov/dpc-app/pull/996#discussion_r480404277", "createdAt": "2020-08-31T21:17:27Z", "author": {"login": "codeclimate"}, "path": "dpc-aggregation/src/main/java/gov/cms/dpc/aggregation/service/LookBackAnswer.java", "diffHunk": "@@ -1,45 +1,84 @@\n package gov.cms.dpc.aggregation.service;\n \n+import org.apache.commons.lang3.StringUtils;\n+\n+import java.time.YearMonth;\n+import java.time.ZoneOffset;\n+import java.time.temporal.ChronoUnit;\n+import java.util.Collection;\n+import java.util.Date;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n public class LookBackAnswer {\n \n-    private boolean matchLookBackLimitCriteria;\n-    private boolean matchProvidersCriteria;\n-    private boolean matchOrganizationCriteria;\n-    private long billingDateMonthsFromNow;\n+    private final String practitionerNPI;\n+    private final String organizationNPI;\n+    private final long withinMonths;\n+    private final Date lookBackMonth;\n+\n+    private final Set<String> eobProviderNPIs = new HashSet<>();\n+    private String eobOrganizationNPI;\n+    private Date billingPeriodEndDate;\n+\n+    public LookBackAnswer(String practitionerNPI, String organizationNPI, long withinMonths, Date lookBackMonth) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9504d3030aca4d789c2ef8610887a0d88b47af14"}, "originalPosition": 28}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 369, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}