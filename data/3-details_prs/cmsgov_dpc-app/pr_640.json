{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc5MTY5NDky", "number": 640, "title": "Switch to MBIs and use BFD prod sandbox environment", "bodyText": "Why\nDPC needs to accept MBIs from users when Patients are added, and use MBIs for retrieving BFD data.\nWhat Changed\n\nBFD server configurable with BFD_URL environment variable. Prod sandbox is used in local.env, along with the correct hashing pepper and iterations\nRequests to BFD for Coverage and EOB now preceded by requests for Patient by MBI, to get bene ID\nTest data updated to use MBIs and bene IDs from BFD prod-sbx\nMBI added to IG Patient profile\n\nTickets closed:\nDPC-962 - Get bene ID from BFD by MBI before EOB and Coverage requests\nDPC-963 - BFD MBI hash pepper and iterations variables\nDPC-938 - MBIs in Patient profile\nDPC-993 - Secrets management in repository (partly completed in another PR - this portion is for the BFD JKS)\nChecklist\n\n All tests are passing via make ci-app (app change) and make ci-web (website change)\n Swagger documentation has been updated\n FHIR documentation has been updated\n Any required dpc-ops changes have a PR submitted and mentioned in this ticket\n Any manual migration steps are documented, scripts written (where applicable), and tested\n Before merging, any required dpc-ops changes have been approved and merged into master of the dpc-ops repo", "createdAt": "2020-02-24T19:18:43Z", "url": "https://github.com/CMSgov/dpc-app/pull/640", "merged": true, "mergeCommit": {"oid": "1bd9e089b3c13b0473578ca7bdd150f69989537e"}, "closed": true, "closedAt": "2020-02-26T16:48:43Z", "author": {"login": "em1"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGT7OlgH2gAyMzc5MTY5NDkyOjFkNDE4YTM1YmFkMjk5NzQ0OGVkNGNkZWRlYWY0YzhiNjJlMzEyZTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIIc4oAH2gAyMzc5MTY5NDkyOmMwOTljOWRjMzcwNjQ2OTg3MDgzZjhhNDNjYzVhNWIxOWIyMmZkODA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1d418a35bad2997448ed4cdedeaf4c8b62e312e4", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/1d418a35bad2997448ed4cdedeaf4c8b62e312e4", "committedDate": "2020-02-20T23:42:31Z", "message": "Adding BFD keystore to Vault"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbef7befbc477f2220223d0bb948813c4ef30a48", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/fbef7befbc477f2220223d0bb948813c4ef30a48", "committedDate": "2020-02-21T14:50:54Z", "message": "Change export command"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53cae6b306141d6d88cd95436adb91e7d84fef5c", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/53cae6b306141d6d88cd95436adb91e7d84fef5c", "committedDate": "2020-02-21T18:19:30Z", "message": "Set env vars"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ad4f331c2a1b9a5848a305ec2dfa522b740d6d0", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/3ad4f331c2a1b9a5848a305ec2dfa522b740d6d0", "committedDate": "2020-02-21T20:10:45Z", "message": "Starting bene ID -> MBI transition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbdf50074a944c6d19d05e97aaee3100be0f7764", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/fbdf50074a944c6d19d05e97aaee3100be0f7764", "committedDate": "2020-02-21T20:11:36Z", "message": "Bene ID -> MBI conversion continuing..."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8322e8bc13f9fd22c96340fbe4a061f257b6e0b9", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/8322e8bc13f9fd22c96340fbe4a061f257b6e0b9", "committedDate": "2020-02-21T20:12:09Z", "message": "Apply Postman patch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9dac30ff4046c801617532eaa9008355a744418c", "author": {"user": {"login": "ronaldheft-usds", "name": "Ron Heft"}}, "url": "https://github.com/CMSgov/dpc-app/commit/9dac30ff4046c801617532eaa9008355a744418c", "committedDate": "2020-02-21T20:16:08Z", "message": "DPC-993: Output secure-env files to file system for env file usage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6ab6cb7e6fa74f83fcd878d2094d462622148c0", "author": {"user": {"login": "ronaldheft-usds", "name": "Ron Heft"}}, "url": "https://github.com/CMSgov/dpc-app/commit/a6ab6cb7e6fa74f83fcd878d2094d462622148c0", "committedDate": "2020-02-24T15:43:20Z", "message": "DPC-993: Fix env path to be absolute"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf7a30b52112304757d583f8f371cb9be825c605", "author": {"user": {"login": "ronaldheft-usds", "name": "Ron Heft"}}, "url": "https://github.com/CMSgov/dpc-app/commit/cf7a30b52112304757d583f8f371cb9be825c605", "committedDate": "2020-02-24T16:10:53Z", "message": "DPC-992: Use DPR environment for local and dev smoke tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c132f67990aba63f025eeaffa2d0fe286cbc0939", "author": {"user": {"login": "ronaldheft-usds", "name": "Ron Heft"}}, "url": "https://github.com/CMSgov/dpc-app/commit/c132f67990aba63f025eeaffa2d0fe286cbc0939", "committedDate": "2020-02-24T17:16:03Z", "message": "DPC-993: Include secure-envs for travis"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d6cbc677dd013a3bc4778e9588028aae8865c71", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/5d6cbc677dd013a3bc4778e9588028aae8865c71", "committedDate": "2020-02-24T18:56:11Z", "message": "Merge branch 'emily/dpc-993-keystore-vault' into emily/dpc-938-patient-profile-mbi"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e51218e1cdbc5aa8dcd44daabef5d6edcc5c057", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/4e51218e1cdbc5aa8dcd44daabef5d6edcc5c057", "committedDate": "2020-02-24T22:21:28Z", "message": "Merge branch 'master' into emily/dpc-938-patient-profile-mbi"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30a4e697b17384fdbc4ff546a9f88a31a9ba1691", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/30a4e697b17384fdbc4ff546a9f88a31a9ba1691", "committedDate": "2020-02-25T14:01:04Z", "message": "Merge branch 'master' into emily/dpc-938-patient-profile-mbi"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e37d6cd04d3cb313c99f35e6f08cdec902609d79", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/e37d6cd04d3cb313c99f35e6f08cdec902609d79", "committedDate": "2020-02-25T14:32:54Z", "message": "Merge branch 'master' into emily/dpc-938-patient-profile-mbi"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c15d97c034961428318af2aeb6ebf153e8513155", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/c15d97c034961428318af2aeb6ebf153e8513155", "committedDate": "2020-02-25T15:40:26Z", "message": "Merge branch 'master' into emily/dpc-938-patient-profile-mbi"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0MzYyMDk5", "url": "https://github.com/CMSgov/dpc-app/pull/640#pullrequestreview-364362099", "createdAt": "2020-02-25T18:50:49Z", "commit": {"oid": "c15d97c034961428318af2aeb6ebf153e8513155"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0MzgxNjA3", "url": "https://github.com/CMSgov/dpc-app/pull/640#pullrequestreview-364381607", "createdAt": "2020-02-25T19:19:48Z", "commit": {"oid": "c15d97c034961428318af2aeb6ebf153e8513155"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxOToxOTo0OVrOFuR68A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxOToyNDoxNFrOFuSERQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3MjQzMg==", "bodyText": "Is there a reason for declaring this outside of the switch statement? If possible, I'd prefer to do a local allocation to a final, rather than have an uninitialized variable at the top.", "url": "https://github.com/CMSgov/dpc-app/pull/640#discussion_r384072432", "createdAt": "2020-02-25T19:19:49Z", "author": {"login": "nickrobison-usds"}, "path": "dpc-aggregation/src/main/java/gov/cms/dpc/aggregation/engine/ResourceFetcher.java", "diffHunk": "@@ -55,87 +57,114 @@\n      * Fetch all the resources for a specific patient. If errors are encountered from BlueButton,\n      * a OperationalOutcome resource is used.\n      *\n-     * @param patientID to use\n+     * @param mbi to use\n      * @return a flow with all the resources for specific patient\n      */\n-    Flowable<Resource> fetchResources(String patientID) {\n+    Flowable<Resource> fetchResources(String mbi) {\n         Retry retry = Retry.of(\"bb-resource-fetcher\", this.retryConfig);\n         return Flowable.fromCallable(() -> {\n-            logger.debug(\"Fetching first {} from BlueButton for {}\", resourceType.toString(), patientID);\n-            final Resource firstFetched = fetchFirst(patientID);\n+            String fetchId = UUID.randomUUID().toString();\n+            logger.debug(\"Fetching first {} from BlueButton for {}\", resourceType.toString(), fetchId);\n+            final Resource firstFetched = fetchFirst(mbi);\n             if (ResourceType.Coverage.equals(resourceType) || ResourceType.ExplanationOfBenefit.equals(resourceType)) {\n-                return fetchAllBundles(patientID, (Bundle)firstFetched);\n+                return fetchAllBundles((Bundle)firstFetched, fetchId);\n             } else {\n-                logger.debug(\"Done fetching {} for {}\", resourceType.toString(), patientID);\n+                logger.debug(\"Done fetching {} for {}\", resourceType.toString(), fetchId);\n                 return List.of(firstFetched);\n             }\n         })\n                 .compose(RetryTransformer.of(retry))\n-                .onErrorResumeNext((Throwable error) -> handleError(patientID, error))\n+                .onErrorResumeNext((Throwable error) -> handleError(mbi, error))\n                 .flatMap(Flowable::fromIterable);\n     }\n \n     /**\n      * Given a bundle, return a list of resources in the passed in bundle and all\n      * the resources from the next bundles.\n      *\n-     * @param patientID to fetch for\n      * @param firstBundle of resources. Included in the result list\n      * @return a list of all the resources in the first bundle and all next bundles\n      */\n-    private List<Resource> fetchAllBundles(String patientID, Bundle firstBundle) {\n+    private List<Resource> fetchAllBundles(Bundle firstBundle, String fetchId) {\n         final var resources = new ArrayList<Resource>();\n         addResources(resources, firstBundle);\n \n         // Loop until no more next bundles\n         var bundle = firstBundle;\n         while (bundle.getLink(Bundle.LINK_NEXT) != null) {\n-            logger.debug(\"Fetching next bundle {} from BlueButton for {}\", resourceType.toString(), patientID);\n+            logger.debug(\"Fetching next bundle {} from BlueButton for {}\", resourceType.toString(), fetchId);\n             bundle = blueButtonClient.requestNextBundleFromServer(bundle);\n             addResources(resources, bundle);\n         }\n \n-        logger.debug(\"Done fetching bundles {} for {}\", resourceType.toString(), patientID);\n+        logger.debug(\"Done fetching bundles {} for {}\", resourceType.toString(), fetchId);\n         return resources;\n     }\n \n     /**\n      * Turn an error into a flow.\n-     * @param patientID the flow\n+     * @param mbi MBI\n      * @param error the error\n      * @return a Flowable of list of resources\n      */\n-    private Publisher<List<Resource>> handleError(String patientID, Throwable error) {\n+    private Publisher<List<Resource>> handleError(String mbi, Throwable error) {\n         if (error instanceof JobQueueFailure) {\n             // JobQueueFailure is an internal error. Just pass it along as an error.\n             return Flowable.error(error);\n         }\n \n         // Other errors should be turned into OperationalOutcome and just recorded.\n         logger.error(\"Turning error into OperationalOutcome. Error is: \", error);\n-        final var operationOutcome = formOperationOutcome(patientID, error);\n+        final var operationOutcome = formOperationOutcome(mbi, error);\n         return Flowable.just(List.of(operationOutcome));\n     }\n \n     /**\n      * Based on resourceType, fetch a resource or a bundle of resources.\n      *\n-     * @param patientID of the resource to fetch\n+     * @param mbi of the resource to fetch\n      * @return either a single resource or the first bundle of resources\n      */\n-    private Resource fetchFirst(String patientID) {\n+    private Resource fetchFirst(String mbi) {\n+        Patient patient = fetchPatient(mbi);\n+        String beneId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c15d97c034961428318af2aeb6ebf153e8513155"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3NDgyMQ==", "bodyText": "I believe I ran into an issue with the secret key factory not being thread safe, were you able to determine that as well? I believe there was a commit addressing that in my original branch.", "url": "https://github.com/CMSgov/dpc-app/pull/640#discussion_r384074821", "createdAt": "2020-02-25T19:24:14Z", "author": {"login": "nickrobison-usds"}, "path": "dpc-bluebutton/src/main/java/gov/cms/dpc/bluebutton/client/BlueButtonClientImpl.java", "diffHunk": "@@ -89,6 +89,18 @@ public Patient requestPatientFromServer(String patientID) throws ResourceNotFoun\n                 .execute());\n     }\n \n+    /**\n+     * Hashes MBI and queries Blue Button server for patient data.\n+     *\n+     * @param mbi The MBI\n+     * @return {@link Bundle} A FHIR Bundle of Patient resources\n+     */\n+    @Override\n+    public Bundle requestPatientFromServerByMbi(String mbi) throws ResourceNotFoundException, GeneralSecurityException {\n+        String mbiHash = hashMbi(mbi);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c15d97c034961428318af2aeb6ebf153e8513155"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0NDA4NjYw", "url": "https://github.com/CMSgov/dpc-app/pull/640#pullrequestreview-364408660", "createdAt": "2020-02-25T20:00:13Z", "commit": {"oid": "c15d97c034961428318af2aeb6ebf153e8513155"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQyMDowMDoxNFrOFuTQqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQyMDowMDoxNFrOFuTQqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA5NDM3Ng==", "bodyText": "This change to this system value doesn't look right. BTW: BFD is removing this identifier in its latest response, so the best way to fix this may be to just remove the whole HICN identifier clause.", "url": "https://github.com/CMSgov/dpc-app/pull/640#discussion_r384094376", "createdAt": "2020-02-25T20:00:14Z", "author": {"login": "RickHawesUSDS"}, "path": "src/test/resources/bb-test-data/patient/-20140000009893.xml", "diffHunk": "@@ -9,12 +9,16 @@\n    </extension>\n    <identifier>\n       <system value=\"https://bluebutton.cms.gov/resources/variables/bene_id\"/>\n-      <value value=\"20140000009893\"/>\n+      <value value=\"-20140000009893\"/>\n    </identifier>\n    <identifier>\n-      <system value=\"https://bluebutton.cms.gov/resources/identifier/hicn-hash\"/>\n+      <system value=\"http://bluebutton.cms.hhs.gov/identifier#hicnHash\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c15d97c034961428318af2aeb6ebf153e8513155"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd9e133781fbe4a7d6dfa5cd3fc9a32842522490", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/bd9e133781fbe4a7d6dfa5cd3fc9a32842522490", "committedDate": "2020-02-25T20:34:37Z", "message": "Move beneId declaration; fix HICN hash identifier URL"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19d3b6301fb6d39af89dcccdbf09c0b9ed81bf50", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/19d3b6301fb6d39af89dcccdbf09c0b9ed81bf50", "committedDate": "2020-02-25T20:42:41Z", "message": "Merge branch 'master' into emily/dpc-938-patient-profile-mbi"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8020dc2d5362fc17be08a602982b0092c001c188", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/8020dc2d5362fc17be08a602982b0092c001c188", "committedDate": "2020-02-25T22:10:43Z", "message": "SecretKeyFactory thread safety fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b25c4ad408ca0cb28fd108cff996e045650f2951", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/b25c4ad408ca0cb28fd108cff996e045650f2951", "committedDate": "2020-02-25T22:10:52Z", "message": "Merge branch 'emily/dpc-938-patient-profile-mbi' of github.com:CMSgov/dpc-app into emily/dpc-938-patient-profile-mbi"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0OTg5NTkz", "url": "https://github.com/CMSgov/dpc-app/pull/640#pullrequestreview-364989593", "createdAt": "2020-02-26T15:22:30Z", "commit": {"oid": "b25c4ad408ca0cb28fd108cff996e045650f2951"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c099c9dc370646987083f8a43cc5a5b19b22fd80", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/c099c9dc370646987083f8a43cc5a5b19b22fd80", "committedDate": "2020-02-26T15:28:16Z", "message": "Merge branch 'master' into emily/dpc-938-patient-profile-mbi"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 158, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}