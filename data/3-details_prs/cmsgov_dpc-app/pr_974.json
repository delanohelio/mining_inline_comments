{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3MzYxNzkx", "number": 974, "title": "DPC-582: Return HTTP 410 for jobs older than 24 hours", "bodyText": "Fixes DPC-582\nTo minimize the amount of time DPC stores patient data, export jobs should expire after some period of time.\nProposed Changes\nExpire export jobs after 24 hours, making them and their data inaccessible.\nChange Details\n\nWhen a job is completed, its status endpoint will include an Expires header to indicate when the job will no longer be available\n24 hours after the last batch of a job completes:\n\nJob status will return 410 Gone\nData file requests will return 410 Gone\n\n\n\nDocumentation updates to reflect these changes will be coordinated with our human-centered team.\nSecurity Implications\nThis change aims to improve our security posture by limiting access to data.\n\n\n new software dependencies\n\n\n security controls or supporting software altered\n\n\n new data stored or transmitted\n\n\n security checklist is completed for this change\n\n\n requires more information or team discussion to evaluate security implications\n\n\n no PHI/PII is affected by this change\nExport job data files, which contain PII and PHI, will now have time-limited access.\n\n\nAcceptance Validation\nTests added for job status and data file requests.\nExpires header in dev:\n\nResponse in dev when all batches in job have a complete_time of > 24 hours ago:\n\nFeedback Requested\nAny", "createdAt": "2020-08-13T12:45:43Z", "url": "https://github.com/CMSgov/dpc-app/pull/974", "merged": true, "mergeCommit": {"oid": "7ee51c4a679bf50ddef951fb736c6439e21d899e"}, "closed": true, "closedAt": "2020-09-09T18:44:13Z", "author": {"login": "em1"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-fcU3gBqjM2NTE4OTQ3MTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHP9LLAH2gAyNDY3MzYxNzkxOjE4N2EyYTg2MmM0M2VhYzgyYjZhNmRkNmY0MDNhMjQ3ZGUxZmNmMmQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "96bedd06430f83a41566548d9d4f02c6dfa7e3fc", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/96bedd06430f83a41566548d9d4f02c6dfa7e3fc", "committedDate": "2020-08-13T14:14:51Z", "message": "Add 410 job and data responses to Swagger annotations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MDYwODMx", "url": "https://github.com/CMSgov/dpc-app/pull/974#pullrequestreview-467060831", "createdAt": "2020-08-13T19:18:21Z", "commit": {"oid": "96bedd06430f83a41566548d9d4f02c6dfa7e3fc"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NDc5OTAw", "url": "https://github.com/CMSgov/dpc-app/pull/974#pullrequestreview-474479900", "createdAt": "2020-08-25T13:28:03Z", "commit": null, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMzoyODowNFrOHGYDUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMzo0MTozMVrOHGYpKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ0NzU3MA==", "bodyText": "Does this mean that we will NOT return a 410 on a job if the batches are not all completed, even if expired? That sounds fine because all batches should be completed within 24 hours, but I just wanted to ask the question to be sure that there isn't a missed edge case here.", "url": "https://github.com/CMSgov/dpc-app/pull/974#discussion_r476447570", "createdAt": "2020-08-25T13:28:04Z", "author": {"login": "jonfulk"}, "path": "dpc-api/src/main/java/gov/cms/dpc/api/resources/v1/DataResource.java", "diffHunk": "@@ -130,6 +139,17 @@ public Response downloadExportFile(@ApiParam(hidden = true) @Auth OrganizationPr\n \n         final FileManager.FilePointer filePointer = this.manager.getFile(organizationPrincipal.getID(), fileID);\n \n+        // If job is expired, the files should no longer be accessible\n+        List<JobQueueBatch> batches = queue.getJobBatches(filePointer.getJobID());\n+        Set<JobStatus> jobStatusSet = batches.stream().map(JobQueueBatch::getStatus).collect(Collectors.toSet());\n+        if (jobStatusSet.size() == 1 && jobStatusSet.contains(JobStatus.COMPLETED)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ1NzI1OA==", "bodyText": "why do you need both of these assertions? if the second is true, the first is as well.", "url": "https://github.com/CMSgov/dpc-app/pull/974#discussion_r476457258", "createdAt": "2020-08-25T13:41:31Z", "author": {"login": "jonfulk"}, "path": "dpc-api/src/test/java/gov/cms/dpc/api/resources/v1/JobResourceTest.java", "diffHunk": "@@ -129,6 +132,10 @@ public void testSuccessfulJob() {\n         final Response response = resource.checkJobStatus(organizationPrincipal, jobID.toString());\n         assertAll(() -> assertEquals(HttpStatus.OK_200, response.getStatus()));\n \n+        var expires = ZonedDateTime.parse(response.getHeaderString(\"Expires\"), JobResource.HTTP_DATE_FORMAT);\n+        assertAll(() -> expires.isAfter(ZonedDateTime.now().plusHours(23)),\n+                () -> expires.isAfter(ZonedDateTime.now().plusHours(25)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 24}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "d089b6378375a8632a80f13c41c50d4ded45fcdd", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/d089b6378375a8632a80f13c41c50d4ded45fcdd", "committedDate": "2020-08-25T14:11:20Z", "message": "Return 410 Gone when latest job batch completion was more than 24 hours ago"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8d75138684ee32757f61d55ce7ce1106d68bd4c", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/e8d75138684ee32757f61d55ce7ce1106d68bd4c", "committedDate": "2020-08-25T14:11:20Z", "message": "Add Expires header to completed jobs; confirm that a job is not yet expired at 23 hours"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c58a25c1f87706da595e770b56c6ab9c9ca7546", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/0c58a25c1f87706da595e770b56c6ab9c9ca7546", "committedDate": "2020-08-25T14:11:20Z", "message": "Return 410 Gone on data files when job is expired"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e3ebf299a4864e8e3e7b32c2039c0b2aa6d5a2e", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/5e3ebf299a4864e8e3e7b32c2039c0b2aa6d5a2e", "committedDate": "2020-08-25T14:11:20Z", "message": "Add 410 job and data responses to Swagger annotations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77aa44dfd064895c6c64c6ab73f41a03710599dd", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/77aa44dfd064895c6c64c6ab73f41a03710599dd", "committedDate": "2020-08-25T14:11:20Z", "message": "Unit test correction"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "77aa44dfd064895c6c64c6ab73f41a03710599dd", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/77aa44dfd064895c6c64c6ab73f41a03710599dd", "committedDate": "2020-08-25T14:11:20Z", "message": "Unit test correction"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NjE2OTg5", "url": "https://github.com/CMSgov/dpc-app/pull/974#pullrequestreview-474616989", "createdAt": "2020-08-25T15:49:12Z", "commit": {"oid": "77aa44dfd064895c6c64c6ab73f41a03710599dd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "670705c000b484b3196980c96d2b0a5518020e64", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/670705c000b484b3196980c96d2b0a5518020e64", "committedDate": "2020-08-26T14:40:48Z", "message": "Merge branch 'master' into emily/dpc-582-job-expiration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4867d2a70136bd678d3e5fc5add1bf24cccd6c26", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/4867d2a70136bd678d3e5fc5add1bf24cccd6c26", "committedDate": "2020-09-01T15:35:03Z", "message": "Merge branch 'master' into emily/dpc-582-job-expiration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bced4a0a9090c569ba1aa79e8e8eb463125b0181", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/bced4a0a9090c569ba1aa79e8e8eb463125b0181", "committedDate": "2020-09-04T18:28:49Z", "message": "Merge branch 'master' into emily/dpc-582-job-expiration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "187a2a862c43eac82b6a6dd6f403a247de1fcf2d", "author": {"user": {"login": "em1", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/187a2a862c43eac82b6a6dd6f403a247de1fcf2d", "committedDate": "2020-09-09T17:50:06Z", "message": "Merge branch 'master' into emily/dpc-582-job-expiration"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 476, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}