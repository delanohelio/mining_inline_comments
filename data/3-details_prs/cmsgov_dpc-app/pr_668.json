{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1MDMzOTI5", "number": 668, "title": "DPC-1074: Password Required to Delete Account", "bodyText": "Why\nTo improve security, external users will now be required to enter their password to delete their account.\nWhat Changed\nI used devise's destroy_with_password method to require users to input their password before they can delete their account.\nChoices Made\nI added a password field required to delete an account.\n\n\n\n\nI also added a test for the a user deleting their account.\nTickets closed:\nDPC-1074\nFuture Work\nN/A\nChecklist\n\n All tests are passing via make ci-app (app change) and make ci-web (website change)\n Swagger documentation has been updated\n FHIR documentation has been updated\n Any required dpc-ops changes have a PR submitted and mentioned in this ticket\n Any manual migration steps are documented, scripts written (where applicable), and tested\n Before merging, any required dpc-ops changes have been approved and merged into master of the dpc-ops repo", "createdAt": "2020-03-06T21:42:09Z", "url": "https://github.com/CMSgov/dpc-app/pull/668", "merged": true, "mergeCommit": {"oid": "cdd6a8aa0db0ed72b5dade6900ace1c393a0d8ae"}, "closed": true, "closedAt": "2020-03-16T23:49:36Z", "author": {"login": "Sun-Mountain"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcI1mD2gH2gAyMzg1MDMzOTI5OjI5NDhkMmJlZWM5MTY5OWU3YTg1YmJiNDJmNzFiZjIwYTUxOTFkMmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOWqISgH2gAyMzg1MDMzOTI5OmQwNjc1YWFjNThhY2NkZjM3MmY3ZjEyOTZhOWM5ZjcwNGQ0OWZkOTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2948d2beec91699e7a85bbb42f71bf20a5191d2f", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/2948d2beec91699e7a85bbb42f71bf20a5191d2f", "committedDate": "2020-02-28T20:04:01Z", "message": "delete with password"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd77b1f51fc5495aad42a2f5ff683b9fecec1bb8", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/dd77b1f51fc5495aad42a2f5ff683b9fecec1bb8", "committedDate": "2020-02-28T20:09:11Z", "message": "added devise notifications to edit view"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3dd425381a5f0b444c888384a416ea9b4cc693c4", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/3dd425381a5f0b444c888384a416ea9b4cc693c4", "committedDate": "2020-03-06T13:35:49Z", "message": "Merge remote-tracking branch 'origin/master' into nzonnenberg/dpc-1074-delete-with-password"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "604cd86c59eacb1694e21c99f74ef4b4506778a5", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/604cd86c59eacb1694e21c99f74ef4b4506778a5", "committedDate": "2020-03-06T16:30:49Z", "message": "successful test progress"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de93acf5927b37f2f0133bfd60b2a84873c97ccb", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/de93acf5927b37f2f0133bfd60b2a84873c97ccb", "committedDate": "2020-03-06T19:15:26Z", "message": "tests complete and verified"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNjQ0ODY5", "url": "https://github.com/CMSgov/dpc-app/pull/668#pullrequestreview-370644869", "createdAt": "2020-03-06T21:43:07Z", "commit": {"oid": "de93acf5927b37f2f0133bfd60b2a84873c97ccb"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMTo0MzowN1rOFzIXxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMTo0MzowOFrOFzIXxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE1ODg1Mg==", "bodyText": "Use 2 (not 4) spaces for indentation.", "url": "https://github.com/CMSgov/dpc-app/pull/668#discussion_r389158852", "createdAt": "2020-03-06T21:43:07Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/controllers/users/registrations_controller.rb", "diffHunk": "@@ -4,6 +4,20 @@ module Users\n   class RegistrationsController < Devise::RegistrationsController\n     include MultiModelLoginHelper\n     skip_before_action :check_user, except: %i[new create]\n+\n+    def destroy\n+      @user = User.find(current_user.id)\n+      if @user.destroy_with_password(user_params[:password_to_delete])\n+          redirect_to root_url, notice: \"User deleted.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de93acf5927b37f2f0133bfd60b2a84873c97ccb"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE1ODg1NA==", "bodyText": "Space inside parentheses detected.", "url": "https://github.com/CMSgov/dpc-app/pull/668#discussion_r389158854", "createdAt": "2020-03-06T21:43:07Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/controllers/users/registrations_controller.rb", "diffHunk": "@@ -4,6 +4,20 @@ module Users\n   class RegistrationsController < Devise::RegistrationsController\n     include MultiModelLoginHelper\n     skip_before_action :check_user, except: %i[new create]\n+\n+    def destroy\n+      @user = User.find(current_user.id)\n+      if @user.destroy_with_password(user_params[:password_to_delete])\n+          redirect_to root_url, notice: \"User deleted.\"\n+      else\n+        redirect_to edit_user_registration_url\n+        flash[:notice] = \"Couldn't delete\"\n+      end\n+    end\n+\n+    def user_params\n+      params.require(:user).permit(:password_to_delete )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de93acf5927b37f2f0133bfd60b2a84873c97ccb"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE1ODg1NQ==", "bodyText": "Prefer single-quoted strings when you don't need string interpolation or special symbols.", "url": "https://github.com/CMSgov/dpc-app/pull/668#discussion_r389158855", "createdAt": "2020-03-06T21:43:08Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/controllers/users/registrations_controller.rb", "diffHunk": "@@ -4,6 +4,20 @@ module Users\n   class RegistrationsController < Devise::RegistrationsController\n     include MultiModelLoginHelper\n     skip_before_action :check_user, except: %i[new create]\n+\n+    def destroy\n+      @user = User.find(current_user.id)\n+      if @user.destroy_with_password(user_params[:password_to_delete])\n+          redirect_to root_url, notice: \"User deleted.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de93acf5927b37f2f0133bfd60b2a84873c97ccb"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56b9d1f77491b77db222788d075c2efa396fa946", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/56b9d1f77491b77db222788d075c2efa396fa946", "committedDate": "2020-03-06T21:44:17Z", "message": "Remove whitespace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af3cf596acdb186817d997afd38f801c18910ca7", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/af3cf596acdb186817d997afd38f801c18910ca7", "committedDate": "2020-03-06T21:47:25Z", "message": "Code climate fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35a7b095c1e54bcd82b293c5424473ce53cb343b", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/35a7b095c1e54bcd82b293c5424473ce53cb343b", "committedDate": "2020-03-09T13:26:58Z", "message": "fix error messages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1df37352783cb0dd59979b3dc588224bf89f5bb", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/e1df37352783cb0dd59979b3dc588224bf89f5bb", "committedDate": "2020-03-09T13:27:39Z", "message": "Correct error messages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "820a76a8aeb011727285061539a5f12a30992306", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/820a76a8aeb011727285061539a5f12a30992306", "committedDate": "2020-03-09T13:27:57Z", "message": "Correct error messages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04b2c23d090103fff29fe773964efb877bc8db42", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/04b2c23d090103fff29fe773964efb877bc8db42", "committedDate": "2020-03-09T13:30:07Z", "message": "Update registrations_controller.rb"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNDQ3OTc5", "url": "https://github.com/CMSgov/dpc-app/pull/668#pullrequestreview-371447979", "createdAt": "2020-03-09T18:58:50Z", "commit": {"oid": "04b2c23d090103fff29fe773964efb877bc8db42"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxODo1ODo1MVrOFz1bNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxOTozMzoxMlrOFz2fDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg5NzAxMg==", "bodyText": "This should be after the protected below", "url": "https://github.com/CMSgov/dpc-app/pull/668#discussion_r389897012", "createdAt": "2020-03-09T18:58:51Z", "author": {"login": "switzersc-usds"}, "path": "dpc-web/app/controllers/users/registrations_controller.rb", "diffHunk": "@@ -4,6 +4,20 @@ module Users\n   class RegistrationsController < Devise::RegistrationsController\n     include MultiModelLoginHelper\n     skip_before_action :check_user, except: %i[new create]\n+\n+    def destroy\n+      @user = User.find(current_user.id)\n+      if @user.destroy_with_password(user_params[:password_to_delete])\n+        redirect_to root_url, notice: 'User account deleted.'\n+      else\n+        redirect_to edit_user_registration_url\n+        flash[:notice] = 'Could not delete account. Please enter the correct password.'\n+      end\n+    end\n+\n+    def user_params", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04b2c23d090103fff29fe773964efb877bc8db42"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkwMjYwNQ==", "bodyText": "We use flash[:alert] for error messages (:notice being for success messages). Also, this needs to either be implemented in the same way as line 11 above, or needs to come before the redirect; otherwise I don't think it'll take effect (the redirect will be called and the block exited). I'd probably vote the former for consistency within this method.", "url": "https://github.com/CMSgov/dpc-app/pull/668#discussion_r389902605", "createdAt": "2020-03-09T19:09:35Z", "author": {"login": "switzersc-usds"}, "path": "dpc-web/app/controllers/users/registrations_controller.rb", "diffHunk": "@@ -4,6 +4,20 @@ module Users\n   class RegistrationsController < Devise::RegistrationsController\n     include MultiModelLoginHelper\n     skip_before_action :check_user, except: %i[new create]\n+\n+    def destroy\n+      @user = User.find(current_user.id)\n+      if @user.destroy_with_password(user_params[:password_to_delete])\n+        redirect_to root_url, notice: 'User account deleted.'\n+      else\n+        redirect_to edit_user_registration_url\n+        flash[:notice] = 'Could not delete account. Please enter the correct password.'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04b2c23d090103fff29fe773964efb877bc8db42"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkwMzUzNA==", "bodyText": "Let's use the modern hash with symbol key syntax rather than hash rockets -- so class:  instead of :class =>", "url": "https://github.com/CMSgov/dpc-app/pull/668#discussion_r389903534", "createdAt": "2020-03-09T19:11:20Z", "author": {"login": "switzersc-usds"}, "path": "dpc-web/app/views/devise/registrations/edit.html.erb", "diffHunk": "@@ -132,7 +132,11 @@\n   <div class=\"ds-l-col--12 ds-l-md-col--6 ds-u-margin-bottom--1 ds-u-margin-x--auto\">\n     <div class=\"card card--border-top--red \">\n       <h2 class=\"ds-u-color--error-dark ds-u-margin-top--0\">Delete my account</h2>\n-      <p><%= button_to \"Delete my account\", registration_path(resource_name), data: { confirm: \"Are you sure you want to delete your account?\" }, method: :delete, :class => \"ds-c-button ds-c-button--danger\" %></p>\n+      <%= form_for(resource, as: resource_name, url: registration_path(resource_name), html: { method: :delete }) do |f| %>\n+        <%= f.label :password, :class => \"ds-c-label\" %> <i>Enter your password to delete your account.</i><br />", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04b2c23d090103fff29fe773964efb877bc8db42"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkwMzYyMg==", "bodyText": "Ditto", "url": "https://github.com/CMSgov/dpc-app/pull/668#discussion_r389903622", "createdAt": "2020-03-09T19:11:31Z", "author": {"login": "switzersc-usds"}, "path": "dpc-web/app/views/devise/registrations/edit.html.erb", "diffHunk": "@@ -132,7 +132,11 @@\n   <div class=\"ds-l-col--12 ds-l-md-col--6 ds-u-margin-bottom--1 ds-u-margin-x--auto\">\n     <div class=\"card card--border-top--red \">\n       <h2 class=\"ds-u-color--error-dark ds-u-margin-top--0\">Delete my account</h2>\n-      <p><%= button_to \"Delete my account\", registration_path(resource_name), data: { confirm: \"Are you sure you want to delete your account?\" }, method: :delete, :class => \"ds-c-button ds-c-button--danger\" %></p>\n+      <%= form_for(resource, as: resource_name, url: registration_path(resource_name), html: { method: :delete }) do |f| %>\n+        <%= f.label :password, :class => \"ds-c-label\" %> <i>Enter your password to delete your account.</i><br />\n+        <%= f.password_field :password_to_delete, autocomplete: \"off\", :class => \"ds-c-field\" %><br />", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04b2c23d090103fff29fe773964efb877bc8db42"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkwNDE4Mg==", "bodyText": "Because this is a feature spec, let's try to assert on the behavior we expect to see as a user in this scenario rather than on the internals of the application. What page are we on? Do we see a message?", "url": "https://github.com/CMSgov/dpc-app/pull/668#discussion_r389904182", "createdAt": "2020-03-09T19:12:39Z", "author": {"login": "switzersc-usds"}, "path": "dpc-web/spec/features/authentication/user_deletes_account_spec.rb", "diffHunk": "@@ -0,0 +1,44 @@\n+require 'rails_helper'\n+\n+RSpec.feature 'user deletes account' do\n+  let(:user) { create :user }\n+\n+  def user_sign_in\n+    visit new_user_session_path\n+    fill_in 'user_email', with: user.email\n+    fill_in 'user_password', with: '123456'\n+    find('[data-test=\"submit\"]').click\n+    visit edit_user_registration_path\n+  end\n+\n+  context 'when successful' do\n+    scenario 'user inputs correct password' do\n+      user_sign_in\n+      fill_in 'user_password_to_delete', with: '123456'\n+\n+      find('[data-test=\"delete-user-account\"]').click\n+\n+      expect(User.last).not_to be_present", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04b2c23d090103fff29fe773964efb877bc8db42"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkwNDI1Mg==", "bodyText": "Ditto", "url": "https://github.com/CMSgov/dpc-app/pull/668#discussion_r389904252", "createdAt": "2020-03-09T19:12:47Z", "author": {"login": "switzersc-usds"}, "path": "dpc-web/spec/features/authentication/user_deletes_account_spec.rb", "diffHunk": "@@ -0,0 +1,44 @@\n+require 'rails_helper'\n+\n+RSpec.feature 'user deletes account' do\n+  let(:user) { create :user }\n+\n+  def user_sign_in\n+    visit new_user_session_path\n+    fill_in 'user_email', with: user.email\n+    fill_in 'user_password', with: '123456'\n+    find('[data-test=\"submit\"]').click\n+    visit edit_user_registration_path\n+  end\n+\n+  context 'when successful' do\n+    scenario 'user inputs correct password' do\n+      user_sign_in\n+      fill_in 'user_password_to_delete', with: '123456'\n+\n+      find('[data-test=\"delete-user-account\"]').click\n+\n+      expect(User.last).not_to be_present\n+    end\n+  end\n+\n+  context 'when unsuccessful' do\n+    scenario 'user inputs incorrect password' do\n+      user_sign_in\n+      fill_in 'user_password_to_delete', with: '3v3ryDayPotato'\n+\n+      find('[data-test=\"delete-user-account\"]').click\n+\n+      expect(User.last).to be_present", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04b2c23d090103fff29fe773964efb877bc8db42"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkwNDMxMw==", "bodyText": "Ditto", "url": "https://github.com/CMSgov/dpc-app/pull/668#discussion_r389904313", "createdAt": "2020-03-09T19:12:54Z", "author": {"login": "switzersc-usds"}, "path": "dpc-web/spec/features/authentication/user_deletes_account_spec.rb", "diffHunk": "@@ -0,0 +1,44 @@\n+require 'rails_helper'\n+\n+RSpec.feature 'user deletes account' do\n+  let(:user) { create :user }\n+\n+  def user_sign_in\n+    visit new_user_session_path\n+    fill_in 'user_email', with: user.email\n+    fill_in 'user_password', with: '123456'\n+    find('[data-test=\"submit\"]').click\n+    visit edit_user_registration_path\n+  end\n+\n+  context 'when successful' do\n+    scenario 'user inputs correct password' do\n+      user_sign_in\n+      fill_in 'user_password_to_delete', with: '123456'\n+\n+      find('[data-test=\"delete-user-account\"]').click\n+\n+      expect(User.last).not_to be_present\n+    end\n+  end\n+\n+  context 'when unsuccessful' do\n+    scenario 'user inputs incorrect password' do\n+      user_sign_in\n+      fill_in 'user_password_to_delete', with: '3v3ryDayPotato'\n+\n+      find('[data-test=\"delete-user-account\"]').click\n+\n+      expect(User.last).to be_present\n+    end\n+\n+    scenario 'user inputs no password' do\n+      user_sign_in\n+      fill_in 'user_password_to_delete', with: nil\n+\n+      find('[data-test=\"delete-user-account\"]').click\n+\n+      expect(User.last).to be_present", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04b2c23d090103fff29fe773964efb877bc8db42"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkwNTQ3Nw==", "bodyText": "Because we're in a devise controller, let's use the semantics and behavior the Devise uses to implement the behavior we want. Devise's standard registrations#destroy behavior looks like this:\ndef destroy\n  resource.destroy\n  Devise.sign_out_all_scopes ? sign_out : sign_out(resource_name)\n  set_flash_message! :notice, :destroyed\n  yield resource if block_given?\n  respond_with_navigational(resource){ redirect_to after_sign_out_path_for(resource_name) }\nend\n\nIf we don't follow the logic and semantics used here, we risk missing something important about Devise's default implementation or creating a gotcha that trips us up later.  So let's try something like:\ndef destroy\n  if resource.destroy_with_password(user_params[:password_to_delete])\n    Devise.sign_out_all_scopes ? sign_out : sign_out(resource_name)\n    set_flash_message! :notice, :destroyed\n    yield resource if block_given?\n    respond_with_navigational(resource){ redirect_to after_sign_out_path_for(resource_name) }\n  else\n    respond_with resource # this might take care of the redirect and flash message for us - should test\n  end\nend", "url": "https://github.com/CMSgov/dpc-app/pull/668#discussion_r389905477", "createdAt": "2020-03-09T19:15:23Z", "author": {"login": "switzersc-usds"}, "path": "dpc-web/app/controllers/users/registrations_controller.rb", "diffHunk": "@@ -4,6 +4,20 @@ module Users\n   class RegistrationsController < Devise::RegistrationsController\n     include MultiModelLoginHelper\n     skip_before_action :check_user, except: %i[new create]\n+\n+    def destroy\n+      @user = User.find(current_user.id)\n+      if @user.destroy_with_password(user_params[:password_to_delete])", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04b2c23d090103fff29fe773964efb877bc8db42"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkxMjg4Nw==", "bodyText": "(this  comment  may not be relevant if respond_with resource takes care of this in my proposed refactoring)", "url": "https://github.com/CMSgov/dpc-app/pull/668#discussion_r389912887", "createdAt": "2020-03-09T19:30:14Z", "author": {"login": "switzersc-usds"}, "path": "dpc-web/app/controllers/users/registrations_controller.rb", "diffHunk": "@@ -4,6 +4,20 @@ module Users\n   class RegistrationsController < Devise::RegistrationsController\n     include MultiModelLoginHelper\n     skip_before_action :check_user, except: %i[new create]\n+\n+    def destroy\n+      @user = User.find(current_user.id)\n+      if @user.destroy_with_password(user_params[:password_to_delete])\n+        redirect_to root_url, notice: 'User account deleted.'\n+      else\n+        redirect_to edit_user_registration_url\n+        flash[:notice] = 'Could not delete account. Please enter the correct password.'", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkwMjYwNQ=="}, "originalCommit": {"oid": "04b2c23d090103fff29fe773964efb877bc8db42"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkxNDM4Mg==", "bodyText": "I believe we already have a sign in helper available, so you don't need to define another one here. Instead of this, how about a before block that utilizes the existing method:\nbefore(:each) do\n  sign_in user, scope: :user\n  visit edit_user_registration_path\nend", "url": "https://github.com/CMSgov/dpc-app/pull/668#discussion_r389914382", "createdAt": "2020-03-09T19:33:12Z", "author": {"login": "switzersc-usds"}, "path": "dpc-web/spec/features/authentication/user_deletes_account_spec.rb", "diffHunk": "@@ -0,0 +1,44 @@\n+require 'rails_helper'\n+\n+RSpec.feature 'user deletes account' do\n+  let(:user) { create :user }\n+\n+  def user_sign_in", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04b2c23d090103fff29fe773964efb877bc8db42"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06e767116032506a7a08d64395eea78fec23b1fd", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/06e767116032506a7a08d64395eea78fec23b1fd", "committedDate": "2020-03-10T17:01:22Z", "message": "shelby's feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fb47da806a37ab9ede1e16eff0637016e80b6f8", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/9fb47da806a37ab9ede1e16eff0637016e80b6f8", "committedDate": "2020-03-11T13:15:14Z", "message": "code climate fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyOTEzMDI5", "url": "https://github.com/CMSgov/dpc-app/pull/668#pullrequestreview-372913029", "createdAt": "2020-03-11T16:15:15Z", "commit": {"oid": "9fb47da806a37ab9ede1e16eff0637016e80b6f8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNjoxNToxNVrOF0-Ueg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNjoyODowNlrOF0-3Ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTA5MTMyMg==", "bodyText": "Haha. Just curious where this text came from? Not sure if it's in the DPC voice but I could be wrong!", "url": "https://github.com/CMSgov/dpc-app/pull/668#discussion_r391091322", "createdAt": "2020-03-11T16:15:15Z", "author": {"login": "switzersc-usds"}, "path": "dpc-web/app/controllers/users/registrations_controller.rb", "diffHunk": "@@ -4,6 +4,26 @@ module Users\n   class RegistrationsController < Devise::RegistrationsController\n     include MultiModelLoginHelper\n     skip_before_action :check_user, except: %i[new create]\n+\n+    def destroy\n+      @user = User.find(current_user.id)\n+      if resource.destroy_with_password(user_params[:password_to_delete])\n+        Devise.sign_out_all_scopes ? sign_out : sign_out(resource_name)\n+        flash[:notice] = 'Bye! Your account has been successfully cancelled. We hope to see you again soon.'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fb47da806a37ab9ede1e16eff0637016e80b6f8"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTA5MTQ1NA==", "bodyText": "No longer needed", "url": "https://github.com/CMSgov/dpc-app/pull/668#discussion_r391091454", "createdAt": "2020-03-11T16:15:29Z", "author": {"login": "switzersc-usds"}, "path": "dpc-web/app/controllers/users/registrations_controller.rb", "diffHunk": "@@ -4,6 +4,26 @@ module Users\n   class RegistrationsController < Devise::RegistrationsController\n     include MultiModelLoginHelper\n     skip_before_action :check_user, except: %i[new create]\n+\n+    def destroy\n+      @user = User.find(current_user.id)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fb47da806a37ab9ede1e16eff0637016e80b6f8"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTA5NzkyMA==", "bodyText": "Can we give a more informative error message? Also, did respond_with resource not work here as an alternative to lines 16-7 (setting the flash and doing the redirect explicitly)? Just curious -- if it does work then let's use that, but if it doesn't it'd be useful to know.", "url": "https://github.com/CMSgov/dpc-app/pull/668#discussion_r391097920", "createdAt": "2020-03-11T16:24:49Z", "author": {"login": "switzersc-usds"}, "path": "dpc-web/app/controllers/users/registrations_controller.rb", "diffHunk": "@@ -4,6 +4,26 @@ module Users\n   class RegistrationsController < Devise::RegistrationsController\n     include MultiModelLoginHelper\n     skip_before_action :check_user, except: %i[new create]\n+\n+    def destroy\n+      @user = User.find(current_user.id)\n+      if resource.destroy_with_password(user_params[:password_to_delete])\n+        Devise.sign_out_all_scopes ? sign_out : sign_out(resource_name)\n+        flash[:notice] = 'Bye! Your account has been successfully cancelled. We hope to see you again soon.'\n+        yield resource if block_given?\n+        respond_with_navigational(resource) { redirect_to after_sign_out_path_for(resource_name) }\n+      else\n+        flash[:alert] = 'Account could not be deleted.'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fb47da806a37ab9ede1e16eff0637016e80b6f8"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEwMDE3OQ==", "bodyText": "This text isn't what's being set in the controller (Account could not be deleted.). Why is there a difference?", "url": "https://github.com/CMSgov/dpc-app/pull/668#discussion_r391100179", "createdAt": "2020-03-11T16:28:06Z", "author": {"login": "switzersc-usds"}, "path": "dpc-web/spec/features/authentication/user_deletes_account_spec.rb", "diffHunk": "@@ -0,0 +1,39 @@\n+require 'rails_helper'\n+\n+RSpec.feature 'user deletes account' do\n+  let(:user) { create :user }\n+\n+  before(:each) do\n+    sign_in user, scope: :user\n+    visit edit_user_registration_path\n+  end\n+\n+  context 'when successful' do\n+    scenario 'user inputs correct password' do\n+      fill_in 'user_password_to_delete', with: '123456'\n+\n+      find('[data-test=\"delete-user-account\"]').click\n+\n+      visit new_user_session_path\n+      expect(page.body).to include('Bye! Your account has been successfully cancelled. We hope to see you again soon.')\n+    end\n+  end\n+\n+  context 'when unsuccessful' do\n+    scenario 'user inputs incorrect password' do\n+      fill_in 'user_password_to_delete', with: '3v3ryDayPotato'\n+\n+      find('[data-test=\"delete-user-account\"]').click\n+\n+      expect(page.body).to include('Your email or password is incorrect')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fb47da806a37ab9ede1e16eff0637016e80b6f8"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMDQ2MTIz", "url": "https://github.com/CMSgov/dpc-app/pull/668#pullrequestreview-373046123", "createdAt": "2020-03-11T19:06:02Z", "commit": {"oid": "9fb47da806a37ab9ede1e16eff0637016e80b6f8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxOTowNjowMlrOF1E5IA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxOTowNjowMlrOF1E5IA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE5OTAwOA==", "bodyText": "Can you explain this change?", "url": "https://github.com/CMSgov/dpc-app/pull/668#discussion_r391199008", "createdAt": "2020-03-11T19:06:02Z", "author": {"login": "switzersc-usds"}, "path": "dpc-web/app/views/devise/registrations/edit.html.erb", "diffHunk": "@@ -7,7 +7,7 @@\n       <h1>Edit your info</h1>\n \n       <%= form_for(resource, as: resource_name, url: registration_path(resource_name), html: { method: :put }) do |f| %>\n-        <%= render \"devise/shared/error_messages\", resource: resource %>\n+        <%= devise_error_messages! %>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fb47da806a37ab9ede1e16eff0637016e80b6f8"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07989404d47abf553be2f52b86080eac7b9a9cf3", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/07989404d47abf553be2f52b86080eac7b9a9cf3", "committedDate": "2020-03-11T20:11:59Z", "message": "Removed redundant '@user = User.find(..)'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa4b66517d840bdcb0d41149fa403df14feb81a2", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/aa4b66517d840bdcb0d41149fa403df14feb81a2", "committedDate": "2020-03-12T19:00:49Z", "message": "Changed script for delete account button"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d15e78ead2602b9ee428f0f40b8aa843b68f4ee2", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/d15e78ead2602b9ee428f0f40b8aa843b68f4ee2", "committedDate": "2020-03-13T13:33:30Z", "message": "Resolved delete account errors\n\nChanged redirect_to to render the edit page. Users will now see 'Current password can't be blank' if left blank or 'Current password is invalid' if they input the wrong password."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MzE2MDk2", "url": "https://github.com/CMSgov/dpc-app/pull/668#pullrequestreview-374316096", "createdAt": "2020-03-13T13:53:07Z", "commit": {"oid": "d15e78ead2602b9ee428f0f40b8aa843b68f4ee2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxMzo1MzowN1rOF2EeEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxMzo1MzowN1rOF2EeEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI0MDY1Ng==", "bodyText": "For some reason, the test wouldn't acknowledge \"Current password is blank\" as being present, even though that is what's being shown in addition to 1 error prohibited this user from being saved.", "url": "https://github.com/CMSgov/dpc-app/pull/668#discussion_r392240656", "createdAt": "2020-03-13T13:53:07Z", "author": {"login": "Sun-Mountain"}, "path": "dpc-web/spec/features/authentication/user_deletes_account_spec.rb", "diffHunk": "@@ -0,0 +1,39 @@\n+require 'rails_helper'\n+\n+RSpec.feature 'user deletes account' do\n+  let(:user) { create :user }\n+\n+  before(:each) do\n+    sign_in user, scope: :user\n+    visit edit_user_registration_path\n+  end\n+\n+  context 'when successful' do\n+    scenario 'user inputs correct password' do\n+      fill_in 'user_password_to_delete', with: '123456'\n+\n+      find('[data-test=\"delete-user-account\"]').click\n+\n+      visit new_user_session_path\n+      expect(page.body).to include('Bye! Your account has been successfully cancelled. We hope to see you again soon.')\n+    end\n+  end\n+\n+  context 'when unsuccessful' do\n+    scenario 'user inputs incorrect password' do\n+      fill_in 'user_password_to_delete', with: '3v3ryDayPotato'\n+\n+      find('[data-test=\"delete-user-account\"]').click\n+\n+      expect(page.body).to include('Current password is invalid')\n+    end\n+\n+    scenario 'user inputs no password' do\n+      fill_in 'user_password_to_delete', with: ''\n+\n+      find('[data-test=\"delete-user-account\"]').click\n+\n+      expect(page.body).to include('1 error prohibited this user from being saved')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d15e78ead2602b9ee428f0f40b8aa843b68f4ee2"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NTk4ODcy", "url": "https://github.com/CMSgov/dpc-app/pull/668#pullrequestreview-375598872", "createdAt": "2020-03-16T21:35:46Z", "commit": {"oid": "d15e78ead2602b9ee428f0f40b8aa843b68f4ee2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65a419b00456bff41859fe7fe6e568e4f3ad2cd6", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/65a419b00456bff41859fe7fe6e568e4f3ad2cd6", "committedDate": "2020-03-16T21:37:21Z", "message": "Merge branch 'master' into nzonnenberg/dpc-1074-delete-with-password"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0675aac58accdf372f7f1296a9c9f704d49fd91", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/d0675aac58accdf372f7f1296a9c9f704d49fd91", "committedDate": "2020-03-16T23:24:57Z", "message": "Merge branch 'master' into nzonnenberg/dpc-1074-delete-with-password"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 176, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}