{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2MTcyMjI0", "number": 676, "title": "aggregation engine health check", "bodyText": "Why\nA Health check on the engine itself is important to give insight into knowing if the worker is actually distressed or in some other state. In combination with the queue health check, we can know if the engine is just stuck running.\nWhat Changed\nAdded a health check based off the isRunning status. If isRunning is false, then health check will return unhealthy and if true, it'll return healthy.  IsRunning is false only when some unknown error breaks the loop\nChoices Made\nJustify changes made and any reasons for why a given path was taken, as opposed to an alternative option.\nTickets closed:\nGive a list of tickets closed in this PR.\nFuture Work\nList any additional tickets that have either been created due to work in this PR, or existing tickets that expand upon the feature or provide additional fixes.\nChecklist\n\n All tests are passing via make ci-app (app change) and make ci-web (website change)\n Swagger documentation has been updated\n FHIR documentation has been updated\n Any required dpc-ops changes have a PR submitted and mentioned in this ticket\n Any manual migration steps are documented, scripts written (where applicable), and tested\n Before merging, any required dpc-ops changes have been approved and merged into master of the dpc-ops repo", "createdAt": "2020-03-10T14:37:33Z", "url": "https://github.com/CMSgov/dpc-app/pull/676", "merged": true, "mergeCommit": {"oid": "6c7aa408ad90031207a9db69e8458757adbe9b74"}, "closed": true, "closedAt": "2020-03-13T16:13:29Z", "author": {"login": "MrBilnon"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMTgg4gH2gAyMzg2MTcyMjI0OjY1OGViM2ZlNjI4MjY0OTdhN2QwZTRjZGQwMjc5MDY0YjE1NTUwYmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNSNEmAH2gAyMzg2MTcyMjI0OjEzODlkODZjYTAwYjcyMzU0MjE5ZjU5YzJjODcwNmU0ZGM4YWY0M2E=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "658eb3fe62826497a7d0e4cdd0279064b15550bf", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/658eb3fe62826497a7d0e4cdd0279064b15550bf", "committedDate": "2020-03-10T14:36:53Z", "message": "aggregation engine health check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ca60734e2d8012bcad570c3c2b18a5b9490176c", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/2ca60734e2d8012bcad570c3c2b18a5b9490176c", "committedDate": "2020-03-10T14:38:33Z", "message": "revert changing method to public"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "112fed5e9badb5c2e2fb006be74bd20122eced94", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/112fed5e9badb5c2e2fb006be74bd20122eced94", "committedDate": "2020-03-10T14:45:13Z", "message": "add another test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc4dd4df246369f0f6ee88c6846695bc8a2c5904", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/fc4dd4df246369f0f6ee88c6846695bc8a2c5904", "committedDate": "2020-03-10T15:11:40Z", "message": "when calling stop, engine should be healthy again"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMTIzMjM4", "url": "https://github.com/CMSgov/dpc-app/pull/676#pullrequestreview-372123238", "createdAt": "2020-03-10T16:33:27Z", "commit": {"oid": "fc4dd4df246369f0f6ee88c6846695bc8a2c5904"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNjozMzoyN1rOF0XISA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNjo0NjoxOVrOF0Xq0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ0OTIyNA==", "bodyText": "Marking a batch as failed is a recoverable state. How would the aggregator return to a healthy state after marking a batch as inError?", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r390449224", "createdAt": "2020-03-10T16:33:27Z", "author": {"login": "ronaldheft-usds"}, "path": "dpc-aggregation/src/main/java/gov/cms/dpc/aggregation/engine/AggregationEngine.java", "diffHunk": "@@ -179,6 +186,7 @@ protected void processJobBatch(JobQueueBatch job) {\n         } catch (Exception error) {\n             logger.error(\"FAILED job {} batch {}\", job.getJobID(), job.getBatchID(), error);\n             this.queue.failBatch(job, aggregatorID);\n+            inError.set(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc4dd4df246369f0f6ee88c6846695bc8a2c5904"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1NDkwMA==", "bodyText": "I'm thinking we either need to set inError on line 188, and then set it back to false in a finally block (so if the batch is marked correctly as failed and processing resumes, the aggregator is no longer inError), or we don't count this scenario as an error scenario.", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r390454900", "createdAt": "2020-03-10T16:41:47Z", "author": {"login": "ronaldheft-usds"}, "path": "dpc-aggregation/src/main/java/gov/cms/dpc/aggregation/engine/AggregationEngine.java", "diffHunk": "@@ -179,6 +186,7 @@ protected void processJobBatch(JobQueueBatch job) {\n         } catch (Exception error) {\n             logger.error(\"FAILED job {} batch {}\", job.getJobID(), job.getBatchID(), error);\n             this.queue.failBatch(job, aggregatorID);\n+            inError.set(true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ0OTIyNA=="}, "originalCommit": {"oid": "fc4dd4df246369f0f6ee88c6846695bc8a2c5904"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1ODA2Nw==", "bodyText": "Is this test starting the aggregator for 5 seconds, then running assertions, and stopping the aggregator?\nDo we need to test the behind-the-scenes action of the AggregationEngine, or is a mock more sufficient (simulating isRunning and inError states)?\nWe do have an existing test suite called AggregationEngineTest that may be better suited to handle the verifying the inError state is set correct.", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r390458067", "createdAt": "2020-03-10T16:46:19Z", "author": {"login": "ronaldheft-usds"}, "path": "dpc-aggregation/src/test/java/gov/cms/dpc/aggregation/health/AggregationEngineHealthCheckTest.java", "diffHunk": "@@ -0,0 +1,159 @@\n+package gov.cms.dpc.aggregation.health;\n+\n+import ca.uhn.fhir.context.FhirContext;\n+import com.codahale.metrics.MetricRegistry;\n+import com.typesafe.config.ConfigFactory;\n+import gov.cms.dpc.aggregation.engine.AggregationEngine;\n+import gov.cms.dpc.aggregation.engine.OperationsConfig;\n+import gov.cms.dpc.bluebutton.client.BlueButtonClient;\n+import gov.cms.dpc.bluebutton.client.MockBlueButtonClient;\n+import gov.cms.dpc.fhir.hapi.ContextUtils;\n+import gov.cms.dpc.queue.IJobQueue;\n+import gov.cms.dpc.queue.MemoryBatchQueue;\n+import gov.cms.dpc.queue.models.JobQueueBatch;\n+import gov.cms.dpc.testing.BufferedLoggerHandler;\n+import org.hl7.fhir.dstu3.model.ResourceType;\n+import org.junit.Assert;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.Mockito;\n+\n+import java.util.Collections;\n+import java.util.UUID;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+\n+@ExtendWith(BufferedLoggerHandler.class)\n+public class AggregationEngineHealthCheckTest {\n+    private static final String TEST_PROVIDER_ID = \"1\";\n+    private static final UUID aggregatorID = UUID.randomUUID();\n+\n+    private IJobQueue queue;\n+    private BlueButtonClient bbclient;\n+    private AggregationEngine engine;\n+\n+    static private FhirContext fhirContext = FhirContext.forDstu3();\n+    static private MetricRegistry metricRegistry = new MetricRegistry();\n+    static private String exportPath;\n+\n+\n+    @BeforeAll\n+    static void setupAll() {\n+        final var config = ConfigFactory.load(\"testing.conf\").getConfig(\"dpc.aggregation\");\n+        exportPath = config.getString(\"exportPath\");\n+        AggregationEngine.setGlobalErrorHandler();\n+        ContextUtils.prefetchResourceModels(fhirContext, JobQueueBatch.validResourceTypes);\n+    }\n+\n+    @BeforeEach\n+    void setupEach() {\n+        queue = Mockito.spy(new MemoryBatchQueue(10));\n+        bbclient = Mockito.spy(new MockBlueButtonClient(fhirContext));\n+        var operationalConfig = new OperationsConfig(1000, exportPath, 500);\n+        engine = new AggregationEngine(aggregatorID, bbclient, queue, fhirContext, metricRegistry, operationalConfig);\n+        AggregationEngine.setGlobalErrorHandler();\n+    }\n+\n+    @Test\n+    public void testHealthyEngine() throws InterruptedException {\n+\n+        final var orgID = UUID.randomUUID();\n+\n+        queue.createJob(\n+                orgID,\n+                TEST_PROVIDER_ID,\n+                Collections.singletonList(\"1\"),\n+                Collections.singletonList(ResourceType.Patient)\n+        );\n+\n+        AggregationEngineHealthCheck healthCheck = new AggregationEngineHealthCheck(aggregatorID, engine);\n+        Assert.assertTrue(healthCheck.check().isHealthy());\n+\n+        ExecutorService executor = Executors.newCachedThreadPool();\n+        executor.execute(engine);\n+        executor.awaitTermination(5, TimeUnit.SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc4dd4df246369f0f6ee88c6846695bc8a2c5904"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c25f6870135ca9d1bc43e96032cad9c77061d395", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/c25f6870135ca9d1bc43e96032cad9c77061d395", "committedDate": "2020-03-11T17:55:30Z", "message": "remove call to set inError in places where the job is recoverable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3676ff60b4a617564efdf17a68161c2eff2a0feb", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/3676ff60b4a617564efdf17a68161c2eff2a0feb", "committedDate": "2020-03-11T18:28:38Z", "message": "use accessor for aggregatorId"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMTIyODIw", "url": "https://github.com/CMSgov/dpc-app/pull/676#pullrequestreview-373122820", "createdAt": "2020-03-11T21:02:10Z", "commit": {"oid": "3676ff60b4a617564efdf17a68161c2eff2a0feb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQyMTowMjoxMFrOF1I-ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQyMToxMjoyMFrOF1JR5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI2NTk1NQ==", "bodyText": "Should anything outside of the engine ever call the onError? In other words, why is this method public? I don't quite follow the logic here. It seems to be saying if engine.onError is called then engine.inError is true. Not sure if that is what you wanted to test.", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r391265955", "createdAt": "2020-03-11T21:02:10Z", "author": {"login": "RickHawesUSDS"}, "path": "dpc-aggregation/src/test/java/gov/cms/dpc/aggregation/engine/AggregationEngineTest.java", "diffHunk": "@@ -157,6 +158,26 @@ void simpleJobTest() {\n         assertTrue(Files.exists(Path.of(outputFilePath)));\n         final var errorFilePath = ResourceWriter.formOutputFilePath(exportPath, completeJob.getBatchID(), ResourceType.OperationOutcome, 0);\n         assertFalse(Files.exists(Path.of(errorFilePath)), \"expect no error file\");\n+        assertFalse(engine.inError());\n+    }\n+\n+    @Test\n+    void simpleJobExceptionTest() {\n+        final var orgID = UUID.randomUUID();\n+\n+        // Make a simple job with one resource type\n+        final var jobID = queue.createJob(\n+                orgID,\n+                TEST_PROVIDER_ID,\n+                Collections.singletonList(MockBlueButtonClient.TEST_PATIENT_MBIS.get(0)),\n+                Collections.singletonList(ResourceType.Patient)\n+        );\n+\n+        // Work the batch\n+        queue.claimBatch(engine.getAggregatorID())\n+                .ifPresent(t -> engine.onError(new RuntimeException(\"error\")));\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3676ff60b4a617564efdf17a68161c2eff2a0feb"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI2Nzg0Mg==", "bodyText": "Unless I'm missing something, I'm don't see a negative (eg. Assert.assertFalse(healthCheck.check().isHealth())) test. Should there be one?", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r391267842", "createdAt": "2020-03-11T21:06:10Z", "author": {"login": "RickHawesUSDS"}, "path": "dpc-aggregation/src/test/java/gov/cms/dpc/aggregation/health/AggregationEngineHealthCheckTest.java", "diffHunk": "@@ -0,0 +1,155 @@\n+package gov.cms.dpc.aggregation.health;\n+\n+import ca.uhn.fhir.context.FhirContext;\n+import com.codahale.metrics.MetricRegistry;\n+import com.typesafe.config.ConfigFactory;\n+import gov.cms.dpc.aggregation.engine.AggregationEngine;\n+import gov.cms.dpc.aggregation.engine.OperationsConfig;\n+import gov.cms.dpc.bluebutton.client.BlueButtonClient;\n+import gov.cms.dpc.bluebutton.client.MockBlueButtonClient;\n+import gov.cms.dpc.fhir.hapi.ContextUtils;\n+import gov.cms.dpc.queue.IJobQueue;\n+import gov.cms.dpc.queue.MemoryBatchQueue;\n+import gov.cms.dpc.queue.models.JobQueueBatch;\n+import gov.cms.dpc.testing.BufferedLoggerHandler;\n+import org.hl7.fhir.dstu3.model.ResourceType;\n+import org.junit.Assert;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.Mockito;\n+\n+import java.util.Collections;\n+import java.util.UUID;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+\n+@ExtendWith(BufferedLoggerHandler.class)\n+public class AggregationEngineHealthCheckTest {\n+    private static final String TEST_PROVIDER_ID = \"1\";\n+    private static final UUID aggregatorID = UUID.randomUUID();\n+\n+    private IJobQueue queue;\n+    private BlueButtonClient bbclient;\n+    private AggregationEngine engine;\n+\n+    static private FhirContext fhirContext = FhirContext.forDstu3();\n+    static private MetricRegistry metricRegistry = new MetricRegistry();\n+    static private String exportPath;\n+\n+\n+    @BeforeAll\n+    static void setupAll() {\n+        final var config = ConfigFactory.load(\"testing.conf\").getConfig(\"dpc.aggregation\");\n+        exportPath = config.getString(\"exportPath\");\n+        AggregationEngine.setGlobalErrorHandler();\n+        ContextUtils.prefetchResourceModels(fhirContext, JobQueueBatch.validResourceTypes);\n+    }\n+\n+    @BeforeEach\n+    void setupEach() {\n+        queue = Mockito.spy(new MemoryBatchQueue(10));\n+        bbclient = Mockito.spy(new MockBlueButtonClient(fhirContext));\n+        var operationalConfig = new OperationsConfig(1000, exportPath, 500);\n+        engine = Mockito.spy(new AggregationEngine(aggregatorID, bbclient, queue, fhirContext, metricRegistry, operationalConfig));\n+        AggregationEngine.setGlobalErrorHandler();\n+    }\n+\n+    @Test\n+    public void testHealthyEngine() throws InterruptedException {\n+\n+        final var orgID = UUID.randomUUID();\n+\n+        queue.createJob(\n+                orgID,\n+                TEST_PROVIDER_ID,\n+                Collections.singletonList(\"1\"),\n+                Collections.singletonList(ResourceType.Patient)\n+        );\n+\n+        AggregationEngineHealthCheck healthCheck = new AggregationEngineHealthCheck(engine);\n+        Assert.assertTrue(healthCheck.check().isHealthy());\n+\n+        ExecutorService executor = Executors.newCachedThreadPool();\n+        executor.execute(engine);\n+        executor.awaitTermination(5, TimeUnit.SECONDS);\n+\n+        Assert.assertTrue(healthCheck.check().isHealthy());\n+\n+    }\n+\n+    @Test\n+    public void testHealthyEngineWhenJobBatchErrors() throws InterruptedException {\n+\n+        Mockito.doThrow(new RuntimeException(\"Error\")).when(bbclient).requestPatientFromServer(Mockito.anyString());\n+\n+        final var orgID = UUID.randomUUID();\n+\n+        queue.createJob(\n+                orgID,\n+                TEST_PROVIDER_ID,\n+                Collections.singletonList(\"1\"),\n+                Collections.singletonList(ResourceType.Patient)\n+        );\n+\n+        AggregationEngineHealthCheck healthCheck = new AggregationEngineHealthCheck(engine);\n+        Assert.assertTrue(healthCheck.check().isHealthy());\n+\n+        ExecutorService executor = Executors.newCachedThreadPool();\n+        executor.execute(engine);\n+        executor.awaitTermination(5, TimeUnit.SECONDS);\n+\n+        Assert.assertTrue(healthCheck.check().isHealthy());\n+\n+    }\n+\n+    @Test\n+    public void testHealthyEngineWhenClaimBatchErrors() throws InterruptedException {\n+\n+        final var orgID = UUID.randomUUID();\n+\n+        queue.createJob(\n+                orgID,\n+                TEST_PROVIDER_ID,\n+                Collections.singletonList(\"1\"),\n+                Collections.singletonList(ResourceType.Patient)\n+        );\n+\n+        Mockito.doThrow(new RuntimeException(\"Error\")).when(queue).claimBatch(Mockito.any(UUID.class));\n+\n+        AggregationEngineHealthCheck healthCheck = new AggregationEngineHealthCheck(engine);\n+        Assert.assertTrue(healthCheck.check().isHealthy());\n+\n+        ExecutorService executor = Executors.newCachedThreadPool();\n+        executor.execute(engine);\n+        executor.awaitTermination(5, TimeUnit.SECONDS);\n+\n+        Assert.assertTrue(healthCheck.check().isHealthy());\n+\n+    }\n+\n+    @Test\n+    public void testHealthyEngineWhenQueueOperationsError() throws InterruptedException {\n+        Mockito.doThrow(new RuntimeException(\"Error\")).when(queue).completePartialBatch(Mockito.any(JobQueueBatch.class), Mockito.any(UUID.class));\n+\n+        final var orgID = UUID.randomUUID();\n+\n+        queue.createJob(\n+                orgID,\n+                TEST_PROVIDER_ID,\n+                Collections.singletonList(\"1\"),\n+                Collections.singletonList(ResourceType.Patient)\n+        );\n+\n+        AggregationEngineHealthCheck healthCheck = new AggregationEngineHealthCheck(engine);\n+        Assert.assertTrue(healthCheck.check().isHealthy());\n+\n+        ExecutorService executor = Executors.newCachedThreadPool();\n+        executor.execute(engine);\n+        executor.awaitTermination(5, TimeUnit.SECONDS);\n+\n+        Assert.assertTrue(healthCheck.check().isHealthy());\n+    }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3676ff60b4a617564efdf17a68161c2eff2a0feb"}, "originalPosition": 155}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI3MDg4Ng==", "bodyText": "I'm wondering how a stuck job will make the aggregator unhealthy? Or is the intent to only make the aggregator unhealthy when an exception is thrown?", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r391270886", "createdAt": "2020-03-11T21:12:20Z", "author": {"login": "RickHawesUSDS"}, "path": "dpc-aggregation/src/main/java/gov/cms/dpc/aggregation/engine/AggregationEngine.java", "diffHunk": "@@ -123,17 +129,23 @@ protected void pollQueue() {\n                 .map(Optional::get)\n                 .subscribe(\n                         this::processJobBatch,\n-                        error -> {\n-                            logger.error(\"Error processing queue. Exiting...\", error);\n-                            queueRunning.set(false);\n-                        },\n-                        () -> {\n-                            logger.info(\"Finished processing queue. Exiting...\");\n-                            queueRunning.set(false);\n-                        }\n+                        this::onError,\n+                        this::onCompleted\n                 );\n     }\n \n+    public void onError(Throwable error) {\n+        logger.error(\"Error processing queue. Exiting...\", error);\n+        queueRunning.set(false);\n+        inError.set(true);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3676ff60b4a617564efdf17a68161c2eff2a0feb"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc15ffbaf8ef3b15fc6941d7d4ce77a46559bd0f", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/cc15ffbaf8ef3b15fc6941d7d4ce77a46559bd0f", "committedDate": "2020-03-12T15:49:39Z", "message": "base health check on isRunning instead. This will indicate if broke out of the loop and in combination with the queue health check, this will also help determine if something is stuck"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94324b651e3e078934e3b674ac77a8448183d5ed", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/94324b651e3e078934e3b674ac77a8448183d5ed", "committedDate": "2020-03-12T16:28:45Z", "message": "oops, fix mocking"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65538a965dfabf2dbfd493a491fcb48849304565", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/65538a965dfabf2dbfd493a491fcb48849304565", "committedDate": "2020-03-12T17:11:42Z", "message": "Merge branch 'master' into willh/aggregation-engine-health-check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MzI2NDg2", "url": "https://github.com/CMSgov/dpc-app/pull/676#pullrequestreview-374326486", "createdAt": "2020-03-13T14:06:19Z", "commit": {"oid": "65538a965dfabf2dbfd493a491fcb48849304565"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNDowNjoyMFrOF2E8-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNDoyODo0OVrOF2FyAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI0ODU3MA==", "bodyText": "Suggest that you add a comment for the reason to initialize to running. There was a discussion on this and it would be helpful to capture.", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r392248570", "createdAt": "2020-03-13T14:06:20Z", "author": {"login": "RickHawesUSDS"}, "path": "dpc-aggregation/src/main/java/gov/cms/dpc/aggregation/engine/AggregationEngine.java", "diffHunk": "@@ -54,7 +54,7 @@\n     private final Meter resourceMeter;\n     private final Meter operationalOutcomeMeter;\n     private Disposable subscribe;\n-    protected AtomicBoolean queueRunning = new AtomicBoolean(false);\n+    protected AtomicBoolean queueRunning = new AtomicBoolean(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65538a965dfabf2dbfd493a491fcb48849304565"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2MjE0Ng==", "bodyText": "Isn't it important to assert while the engine is running? Suggest that you check isHealthy() here.", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r392262146", "createdAt": "2020-03-13T14:28:49Z", "author": {"login": "RickHawesUSDS"}, "path": "dpc-aggregation/src/test/java/gov/cms/dpc/aggregation/health/AggregationEngineHealthCheckTest.java", "diffHunk": "@@ -0,0 +1,160 @@\n+package gov.cms.dpc.aggregation.health;\n+\n+import ca.uhn.fhir.context.FhirContext;\n+import com.codahale.metrics.MetricRegistry;\n+import com.typesafe.config.ConfigFactory;\n+import gov.cms.dpc.aggregation.engine.AggregationEngine;\n+import gov.cms.dpc.aggregation.engine.OperationsConfig;\n+import gov.cms.dpc.bluebutton.client.BlueButtonClient;\n+import gov.cms.dpc.bluebutton.client.MockBlueButtonClient;\n+import gov.cms.dpc.fhir.hapi.ContextUtils;\n+import gov.cms.dpc.queue.IJobQueue;\n+import gov.cms.dpc.queue.MemoryBatchQueue;\n+import gov.cms.dpc.queue.models.JobQueueBatch;\n+import gov.cms.dpc.testing.BufferedLoggerHandler;\n+import org.hl7.fhir.dstu3.model.ResourceType;\n+import org.junit.Assert;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.Mockito;\n+\n+import java.util.Collections;\n+import java.util.UUID;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * These tests are here to make sure the engine is still running/polling in situations where errors are recoverable.\n+ * A test to check if the engine exits out of the loop correctly when an error occurs\n+ * in AggregationEngineTest#testUnhealthyIfProcessJobBatchThrowsException\n+ */\n+@ExtendWith(BufferedLoggerHandler.class)\n+public class AggregationEngineHealthCheckTest {\n+    private static final String TEST_PROVIDER_ID = \"1\";\n+    private static final UUID aggregatorID = UUID.randomUUID();\n+\n+    private IJobQueue queue;\n+    private BlueButtonClient bbclient;\n+    private AggregationEngine engine;\n+\n+    static private FhirContext fhirContext = FhirContext.forDstu3();\n+    static private MetricRegistry metricRegistry = new MetricRegistry();\n+    static private String exportPath;\n+\n+\n+    @BeforeAll\n+    static void setupAll() {\n+        final var config = ConfigFactory.load(\"testing.conf\").getConfig(\"dpc.aggregation\");\n+        exportPath = config.getString(\"exportPath\");\n+        AggregationEngine.setGlobalErrorHandler();\n+        ContextUtils.prefetchResourceModels(fhirContext, JobQueueBatch.validResourceTypes);\n+    }\n+\n+    @BeforeEach\n+    void setupEach() {\n+        queue = Mockito.spy(new MemoryBatchQueue(10));\n+        bbclient = Mockito.spy(new MockBlueButtonClient(fhirContext));\n+        var operationalConfig = new OperationsConfig(1000, exportPath, 500);\n+        engine = Mockito.spy(new AggregationEngine(aggregatorID, bbclient, queue, fhirContext, metricRegistry, operationalConfig));\n+        AggregationEngine.setGlobalErrorHandler();\n+    }\n+\n+    @Test\n+    public void testHealthyEngine() throws InterruptedException {\n+\n+        final var orgID = UUID.randomUUID();\n+\n+        queue.createJob(\n+                orgID,\n+                TEST_PROVIDER_ID,\n+                Collections.singletonList(\"1\"),\n+                Collections.singletonList(ResourceType.Patient)\n+        );\n+\n+        AggregationEngineHealthCheck healthCheck = new AggregationEngineHealthCheck(engine);\n+        Assert.assertTrue(healthCheck.check().isHealthy());\n+\n+        ExecutorService executor = Executors.newCachedThreadPool();\n+        executor.execute(engine);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65538a965dfabf2dbfd493a491fcb48849304565"}, "originalPosition": 81}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MzQ1MTE2", "url": "https://github.com/CMSgov/dpc-app/pull/676#pullrequestreview-374345116", "createdAt": "2020-03-13T14:29:36Z", "commit": {"oid": "65538a965dfabf2dbfd493a491fcb48849304565"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNDoyOTozNlrOF2Fz6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNDozNjowNVrOF2GDRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2MjYzMg==", "bodyText": "Great change! Covers us in that window during startup.", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r392262632", "createdAt": "2020-03-13T14:29:36Z", "author": {"login": "ronaldheft-usds"}, "path": "dpc-aggregation/src/main/java/gov/cms/dpc/aggregation/engine/AggregationEngine.java", "diffHunk": "@@ -54,7 +54,7 @@\n     private final Meter resourceMeter;\n     private final Meter operationalOutcomeMeter;\n     private Disposable subscribe;\n-    protected AtomicBoolean queueRunning = new AtomicBoolean(false);\n+    protected AtomicBoolean queueRunning = new AtomicBoolean(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65538a965dfabf2dbfd493a491fcb48849304565"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2MzA2OA==", "bodyText": "Nice breaking out the methods into their own callbacks. Makes the code easier to read and easier to test.", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r392263068", "createdAt": "2020-03-13T14:30:16Z", "author": {"login": "ronaldheft-usds"}, "path": "dpc-aggregation/src/main/java/gov/cms/dpc/aggregation/engine/AggregationEngine.java", "diffHunk": "@@ -123,17 +123,21 @@ protected void pollQueue() {\n                 .map(Optional::get)\n                 .subscribe(\n                         this::processJobBatch,\n-                        error -> {\n-                            logger.error(\"Error processing queue. Exiting...\", error);\n-                            queueRunning.set(false);\n-                        },\n-                        () -> {\n-                            logger.info(\"Finished processing queue. Exiting...\");\n-                            queueRunning.set(false);\n-                        }\n+                        this::onError,\n+                        this::onCompleted", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65538a965dfabf2dbfd493a491fcb48849304565"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2Mzc1Ng==", "bodyText": "Switching up aggregationID to public was a good move. Ensures we are consistent with the IDs.", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r392263756", "createdAt": "2020-03-13T14:31:22Z", "author": {"login": "ronaldheft-usds"}, "path": "dpc-aggregation/src/main/java/gov/cms/dpc/aggregation/health/AggregationEngineHealthCheck.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package gov.cms.dpc.aggregation.health;\n+\n+import com.codahale.metrics.health.HealthCheck;\n+import gov.cms.dpc.aggregation.engine.AggregationEngine;\n+\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+@Singleton\n+public class AggregationEngineHealthCheck extends HealthCheck {\n+\n+    private AggregationEngine aggregationEngine;\n+\n+    @Inject\n+    public AggregationEngineHealthCheck(AggregationEngine aggregationEngine) {\n+        this.aggregationEngine = aggregationEngine;\n+    }\n+\n+    @Override\n+    public Result check() {\n+        Result result = Result.healthy();\n+        if (!aggregationEngine.isRunning()) {\n+            result = Result.unhealthy(\"Aggregation Engine instance: \" + aggregationEngine.getAggregatorID() + \" in error state\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65538a965dfabf2dbfd493a491fcb48849304565"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2NDUzNA==", "bodyText": "Great work covering this scenario. This scenario is exactly why we want this health check.", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r392264534", "createdAt": "2020-03-13T14:32:42Z", "author": {"login": "ronaldheft-usds"}, "path": "dpc-aggregation/src/test/java/gov/cms/dpc/aggregation/engine/AggregationEngineTest.java", "diffHunk": "@@ -388,6 +392,31 @@ void testBlueButtonException() throws GeneralSecurityException {\n \n     }\n \n+    @Test\n+    public void testUnhealthyIfProcessJobBatchThrowsException() throws InterruptedException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65538a965dfabf2dbfd493a491fcb48849304565"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2NjU2NA==", "bodyText": "I really like this test quite. You covered all the issues that have tripped up on the incident.\nMy only concern is the 5 second requirement per test. This adds 20+ seconds to our test suite. I don't want to hold up closing out the incident over this, but I think we should keep this tech debt in mind, that we may have to optimize our unit tests in the future to run quicker.", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r392266564", "createdAt": "2020-03-13T14:36:05Z", "author": {"login": "ronaldheft-usds"}, "path": "dpc-aggregation/src/test/java/gov/cms/dpc/aggregation/health/AggregationEngineHealthCheckTest.java", "diffHunk": "@@ -0,0 +1,160 @@\n+package gov.cms.dpc.aggregation.health;\n+\n+import ca.uhn.fhir.context.FhirContext;\n+import com.codahale.metrics.MetricRegistry;\n+import com.typesafe.config.ConfigFactory;\n+import gov.cms.dpc.aggregation.engine.AggregationEngine;\n+import gov.cms.dpc.aggregation.engine.OperationsConfig;\n+import gov.cms.dpc.bluebutton.client.BlueButtonClient;\n+import gov.cms.dpc.bluebutton.client.MockBlueButtonClient;\n+import gov.cms.dpc.fhir.hapi.ContextUtils;\n+import gov.cms.dpc.queue.IJobQueue;\n+import gov.cms.dpc.queue.MemoryBatchQueue;\n+import gov.cms.dpc.queue.models.JobQueueBatch;\n+import gov.cms.dpc.testing.BufferedLoggerHandler;\n+import org.hl7.fhir.dstu3.model.ResourceType;\n+import org.junit.Assert;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.Mockito;\n+\n+import java.util.Collections;\n+import java.util.UUID;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * These tests are here to make sure the engine is still running/polling in situations where errors are recoverable.\n+ * A test to check if the engine exits out of the loop correctly when an error occurs\n+ * in AggregationEngineTest#testUnhealthyIfProcessJobBatchThrowsException\n+ */\n+@ExtendWith(BufferedLoggerHandler.class)\n+public class AggregationEngineHealthCheckTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65538a965dfabf2dbfd493a491fcb48849304565"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "605c1e04d4f47de6a78dbf4c2b0108c7765abf29", "author": {"user": {"login": "ronaldheft-usds", "name": "Ron Heft"}}, "url": "https://github.com/CMSgov/dpc-app/commit/605c1e04d4f47de6a78dbf4c2b0108c7765abf29", "committedDate": "2020-03-13T14:36:21Z", "message": "Merge branch 'master' into willh/aggregation-engine-health-check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0Mzk3OTAz", "url": "https://github.com/CMSgov/dpc-app/pull/676#pullrequestreview-374397903", "createdAt": "2020-03-13T15:33:02Z", "commit": {"oid": "605c1e04d4f47de6a78dbf4c2b0108c7765abf29"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da0dc1c362421de200336795e97e576d4bb80be3", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/da0dc1c362421de200336795e97e576d4bb80be3", "committedDate": "2020-03-13T15:38:06Z", "message": "add comment on why queueRunning initial value is true and cut down on executor wait time"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aec8ad5d5f7f589a0aeef8b5a4799cf8c15f1b7f", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/aec8ad5d5f7f589a0aeef8b5a4799cf8c15f1b7f", "committedDate": "2020-03-13T15:38:27Z", "message": "Merge remote-tracking branch 'origin/willh/aggregation-engine-health-check' into willh/aggregation-engine-health-check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1389d86ca00b72354219f59c2c8706e4dc8af43a", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/1389d86ca00b72354219f59c2c8706e4dc8af43a", "committedDate": "2020-03-13T15:39:40Z", "message": "Merge branch 'master' into willh/aggregation-engine-health-check"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 182, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}