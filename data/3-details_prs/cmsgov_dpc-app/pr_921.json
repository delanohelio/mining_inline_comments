{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0NzUwNzAx", "number": 921, "title": "DPC-445 check provider in provenence header and group match", "bodyText": "Fixes DPC-445\n\nIt was never required that the practitioner defined in provenance matches the provider in group\nProposed Changes\n\n\nextract the practitioner uuid from provenance header and get the practitioner from attribution\ncompare the practitioner NPI with the group practitioner NPI\n\nChange Details\n\nExtract the UUID of the practitioner from provenance header and get the NPI by calling attribution service and then compare it with the NPI in the group.\nSecurity Implications\n\n\n new software dependencies\n\n\n\n security controls or supporting software altered\n\n\n\n new data stored or transmitted\n\n\n\n security checklist is completed for this change\n\n\n\n requires more information or team discussion to evaluate security implications\n\n\n\n no PHI/PII is affected by this change\n\n\nAcceptance Validation\n\n\nFeedback Requested", "createdAt": "2020-07-21T21:16:06Z", "url": "https://github.com/CMSgov/dpc-app/pull/921", "merged": true, "mergeCommit": {"oid": "0b679557c61f8491999903dbe030b787cfbab14d"}, "closed": true, "closedAt": "2020-08-12T18:01:47Z", "author": {"login": "MrBilnon"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3MswmAH2gAyNDU0NzUwNzAxOmU4ZGMzYjc0MGYwMWFhNjI1NzFiNjFlZTdhMjQwZDY3YjU1MjUyNzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-OxELgH2gAyNDU0NzUwNzAxOjAyYjYyNTA2MTZjZDhmYzk2YTdmZGQ3ZDBkZWQ2ZDI4ZTc1YTNlNjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e8dc3b740f01aa62571b61ee7a240d67b5525275", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/e8dc3b740f01aa62571b61ee7a240d67b5525275", "committedDate": "2020-07-21T20:59:40Z", "message": "check provider in provenence header and group match"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99b553fef276e25f6fa3ed7fdac482622d582297", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/99b553fef276e25f6fa3ed7fdac482622d582297", "committedDate": "2020-07-22T04:57:26Z", "message": "add test when provenance practitioner doesn't match group practitioner"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92f8c7f4da5510b41437faa64060067e5c127f62", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/92f8c7f4da5510b41437faa64060067e5c127f62", "committedDate": "2020-07-22T05:00:47Z", "message": "Merge branch 'master' into wh/DPC-445-check-provenence-and-group-providers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d98f3f4d884b8c54e90f82e38cb5025f55ecc62", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/1d98f3f4d884b8c54e90f82e38cb5025f55ecc62", "committedDate": "2020-07-27T15:25:56Z", "message": "Merge branch 'master' into wh/DPC-445-check-provenence-and-group-providers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b70654a71666a67c25c4d9da553d3f747218419", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/0b70654a71666a67c25c4d9da553d3f747218419", "committedDate": "2020-07-29T15:46:11Z", "message": "Merge branch 'master' into wh/DPC-445-check-provenence-and-group-providers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NjY5MzUx", "url": "https://github.com/CMSgov/dpc-app/pull/921#pullrequestreview-457669351", "createdAt": "2020-07-29T16:02:49Z", "commit": {"oid": "0b70654a71666a67c25c4d9da553d3f747218419"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNjowMjo0OVrOG4_dEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNjowMjo0OVrOG4_dEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQxMzA3Mg==", "bodyText": "Should we set a status code on these two exceptions so it doesn't use the default of 500? My initial thought was 401 Unauthorized, but maybe 422 Unprocessable Entity is more accurate because it's the attestation that's a problem, not their authentication. \ud83e\udd14", "url": "https://github.com/CMSgov/dpc-app/pull/921#discussion_r462413072", "createdAt": "2020-07-29T16:02:49Z", "author": {"login": "em1"}, "path": "dpc-api/src/main/java/gov/cms/dpc/api/resources/v1/GroupResource.java", "diffHunk": "@@ -431,7 +433,29 @@ private void logAttestation(Provenance provenance, UUID rosterID, Group attribut\n \n         logger.info(\"Organization {} is attesting a {} purpose between provider {} and patient(s) {}{}\", performer.getWhoReference().getReference(),\n                 reason.getCode(),\n-                performer.getOnBehalfOfReference().getReference(), attributedPatients, groupIDLog);\n+                practitionerUUID, attributedPatients, groupIDLog);\n+\n+        verifyHeader(practitionerUUID, attributionRoster);\n+    }\n+\n+    private void verifyHeader(String practitionerUUID, Group attributionRoster) {\n+        try {\n+            Practitioner practitioner = client.read()\n+                    .resource(Practitioner.class)\n+                    .withId(FHIRExtractors.getEntityUUID(practitionerUUID).toString())\n+                    .encodedJson()\n+                    .execute();\n+\n+            Identifier provenancePractitionerNPI = FHIRExtractors.findMatchingIdentifier(practitioner.getIdentifier(), DPCIdentifierSystem.NPPES);\n+            String groupPractitionerNPI = FHIRExtractors.getAttributedNPI(attributionRoster);\n+\n+            if (!provenancePractitionerNPI.getValue().equals(groupPractitionerNPI)) {\n+                throw new WebApplicationException(\"Provenance header's provider does not match group provider\");\n+            }\n+        } catch(ResourceNotFoundException e) {\n+            throw new WebApplicationException(\"Could not find provider defined in provenance header\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b70654a71666a67c25c4d9da553d3f747218419"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9db55a9a6e784e8f6fc5ce2b6eee39475a1978f3", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/9db55a9a6e784e8f6fc5ce2b6eee39475a1978f3", "committedDate": "2020-08-02T04:54:09Z", "message": "change status code to 422"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3ff9b77985b011359652d425d09d9e0abf91796", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/d3ff9b77985b011359652d425d09d9e0abf91796", "committedDate": "2020-08-02T04:54:19Z", "message": "Merge remote-tracking branch 'origin/wh/DPC-445-check-provenence-and-group-providers' into wh/DPC-445-check-provenence-and-group-providers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbe5b31d5eb8a43873c40b132d6000b5d19fc471", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/fbe5b31d5eb8a43873c40b132d6000b5d19fc471", "committedDate": "2020-08-02T04:54:44Z", "message": "Merge branch 'master' into wh/DPC-445-check-provenence-and-group-providers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5OTkwMDE4", "url": "https://github.com/CMSgov/dpc-app/pull/921#pullrequestreview-459990018", "createdAt": "2020-08-03T12:37:15Z", "commit": {"oid": "fbe5b31d5eb8a43873c40b132d6000b5d19fc471"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMjozNzoxNVrOG631Og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMjozNzoxNVrOG631Og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM4NTMzOA==", "bodyText": "It looks like we've established a pattern of using constants for response codes, either from Response.Status or HttpStatus, so it may make sense to do that here (e.g., HttpStatus.UNPROCESSABLE_ENTITY_422).", "url": "https://github.com/CMSgov/dpc-app/pull/921#discussion_r464385338", "createdAt": "2020-08-03T12:37:15Z", "author": {"login": "em1"}, "path": "dpc-api/src/main/java/gov/cms/dpc/api/resources/v1/GroupResource.java", "diffHunk": "@@ -431,7 +437,29 @@ private void logAttestation(Provenance provenance, UUID rosterID, Group attribut\n \n         logger.info(\"Organization {} is attesting a {} purpose between provider {} and patient(s) {}{}\", performer.getWhoReference().getReference(),\n                 reason.getCode(),\n-                performer.getOnBehalfOfReference().getReference(), attributedPatients, groupIDLog);\n+                practitionerUUID, attributedPatients, groupIDLog);\n+\n+        verifyHeader(practitionerUUID, attributionRoster);\n+    }\n+\n+    private void verifyHeader(String practitionerUUID, Group attributionRoster) {\n+        try {\n+            Practitioner practitioner = client.read()\n+                    .resource(Practitioner.class)\n+                    .withId(FHIRExtractors.getEntityUUID(practitionerUUID).toString())\n+                    .encodedJson()\n+                    .execute();\n+\n+            Identifier provenancePractitionerNPI = FHIRExtractors.findMatchingIdentifier(practitioner.getIdentifier(), DPCIdentifierSystem.NPPES);\n+            String groupPractitionerNPI = FHIRExtractors.getAttributedNPI(attributionRoster);\n+\n+            if (!provenancePractitionerNPI.getValue().equals(groupPractitionerNPI)) {\n+                throw new WebApplicationException(\"Provenance header's provider does not match group provider\", Response.status(422).build());\n+            }\n+        } catch(ResourceNotFoundException e) {\n+            throw new WebApplicationException(\"Could not find provider defined in provenance header\", Response.status(422).build());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbe5b31d5eb8a43873c40b132d6000b5d19fc471"}, "originalPosition": 95}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3200e8723870e4a93dbd5b9d544df602d90c3032", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/3200e8723870e4a93dbd5b9d544df602d90c3032", "committedDate": "2020-08-03T15:34:51Z", "message": "change to constant"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f69190aaa458100dc73981296b705124e4eaeb4", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/5f69190aaa458100dc73981296b705124e4eaeb4", "committedDate": "2020-08-06T14:00:27Z", "message": "Merge branch 'master' into wh/DPC-445-check-provenence-and-group-providers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNjM3ODgz", "url": "https://github.com/CMSgov/dpc-app/pull/921#pullrequestreview-462637883", "createdAt": "2020-08-06T15:36:58Z", "commit": {"oid": "5f69190aaa458100dc73981296b705124e4eaeb4"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d70aa704429a22db877ecaf7c8fb6ae40102785", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/6d70aa704429a22db877ecaf7c8fb6ae40102785", "committedDate": "2020-08-06T15:51:18Z", "message": "Merge branch 'master' into wh/DPC-445-check-provenence-and-group-providers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12de3a48de9b7150e2b4802ecdc169e5f168cdd3", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/12de3a48de9b7150e2b4802ecdc169e5f168cdd3", "committedDate": "2020-08-12T02:14:24Z", "message": "Merge branch 'master' into wh/DPC-445-check-provenence-and-group-providers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5db4c3ecf1e1a9dc80a0a2092d4a126ec8bc1ea6", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/5db4c3ecf1e1a9dc80a0a2092d4a126ec8bc1ea6", "committedDate": "2020-08-12T17:19:31Z", "message": "fix unit tests for creating roster with header matching"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02b6250616cd8fc96a7fdd7d0ded6d28e75a3e66", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/02b6250616cd8fc96a7fdd7d0ded6d28e75a3e66", "committedDate": "2020-08-12T17:21:39Z", "message": "Merge branch 'master' into wh/DPC-445-check-provenence-and-group-providers"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 422, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}