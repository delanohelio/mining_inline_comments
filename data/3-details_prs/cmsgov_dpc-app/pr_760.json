{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2MjUxNzUx", "number": 760, "title": "Web app logging: JSON and log level", "bodyText": "Why\nWhile refining our Splunk logs, we discovered that we would like more information from the Rails logs in our AWS environments, in a format that's easier to parse and correlate.  This PR takes two approaches:\n\nLower the log level\nChange the logging to JSON format\n\nWhat Changed\n\nChange the log level from warn to info\nChange the log format to JSON using the lograge gem.  This has the side effect of matching the expectations of the Splunk log forwarder, which has been configured to look for JSON-formatted logs.  Notice the beginning of log ingestion after deployment to dev:\n\n\nChoices Made\n\nChanging the log level to debug  (the next lower--and lowest--level) would capture more information than we need in AWS for most requests.  This PR increases the amount of logging for errors.\nUsing a well-tested gem to change the log formatting decreases the chance of mistakes.\nChoosing to explicitly log query parameters may require future tweaking to avoid logging PII.\n\nTickets closed:\nN/A\nFuture Work\nN/A\nChecklist\n\n All tests are passing via make ci-app (app change) and make ci-web (website change)\n[N/A] Swagger documentation has been updated\n[N/A] FHIR documentation has been updated\n[N/A] Any required dpc-ops changes have a PR submitted and mentioned in this ticket\n[N/A] Any manual migration steps are documented, scripts written (where applicable), and tested\n[N/A] Before merging, any required dpc-ops changes have been approved and merged into master of the dpc-ops repo", "createdAt": "2020-04-20T19:19:36Z", "url": "https://github.com/CMSgov/dpc-app/pull/760", "merged": true, "mergeCommit": {"oid": "424fc35679a665ac59bd944c497710b95745d9bd"}, "closed": true, "closedAt": "2020-04-21T17:15:53Z", "author": {"login": "dhgreene"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZjr4oAH2gAyNDA2MjUxNzUxOjRkZTJiMTdkZmZiYWUwZGNkZTg3ZDdhMDhmZmU3YWNmOTQ0NDE2Zjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZ2wxWAFqTM5NzQ5OTUwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4de2b17dffbae0dcde87d7a08ffe7acf944416f9", "author": {"user": {"login": "dhgreene", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/4de2b17dffbae0dcde87d7a08ffe7acf944416f9", "committedDate": "2020-04-20T18:48:48Z", "message": "Change log level to info"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d94a72569d0255f03f5768046472ee2f325cec2e", "author": {"user": {"login": "dhgreene", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/d94a72569d0255f03f5768046472ee2f325cec2e", "committedDate": "2020-04-21T02:14:28Z", "message": "JSON logging in production"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91ef6eac938d5392bfd4ffbfe40cd47248c3c512", "author": {"user": {"login": "dhgreene", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/91ef6eac938d5392bfd4ffbfe40cd47248c3c512", "committedDate": "2020-04-21T02:42:35Z", "message": "Dynamically escalating log levels"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2OTU0MzM3", "url": "https://github.com/CMSgov/dpc-app/pull/760#pullrequestreview-396954337", "createdAt": "2020-04-21T03:00:15Z", "commit": {"oid": "91ef6eac938d5392bfd4ffbfe40cd47248c3c512"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwMzowMDoxNlrOGIwRJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwMzowMDoxNlrOGIwRLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTgzMjYxMg==", "bodyText": "Indent when as deep as case.", "url": "https://github.com/CMSgov/dpc-app/pull/760#discussion_r411832612", "createdAt": "2020-04-21T03:00:16Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/controllers/application_controller.rb", "diffHunk": "@@ -21,8 +21,21 @@ def configure_permitted_parameters\n       )\n     end\n   end\n-\n+  \n   def model_error_string(resource)\n     resource.errors.full_messages.join(', ')\n   end\n+\n+  # For increased logging on errors\n+  def append_info_to_payload(payload)\n+    super\n+    payload[:level] = case\n+    when payload[:status] == 200", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91ef6eac938d5392bfd4ffbfe40cd47248c3c512"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTgzMjYxNg==", "bodyText": "Indent when as deep as case.", "url": "https://github.com/CMSgov/dpc-app/pull/760#discussion_r411832616", "createdAt": "2020-04-21T03:00:16Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/controllers/application_controller.rb", "diffHunk": "@@ -21,8 +21,21 @@ def configure_permitted_parameters\n       )\n     end\n   end\n-\n+  \n   def model_error_string(resource)\n     resource.errors.full_messages.join(', ')\n   end\n+\n+  # For increased logging on errors\n+  def append_info_to_payload(payload)\n+    super\n+    payload[:level] = case\n+    when payload[:status] == 200\n+      \"INFO\"\n+    when payload[:status] == 302", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91ef6eac938d5392bfd4ffbfe40cd47248c3c512"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTgzMjYyMA==", "bodyText": "end at 39, 4 is not aligned with case at 32, 22.", "url": "https://github.com/CMSgov/dpc-app/pull/760#discussion_r411832620", "createdAt": "2020-04-21T03:00:16Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/controllers/application_controller.rb", "diffHunk": "@@ -21,8 +21,21 @@ def configure_permitted_parameters\n       )\n     end\n   end\n-\n+  \n   def model_error_string(resource)\n     resource.errors.full_messages.join(', ')\n   end\n+\n+  # For increased logging on errors\n+  def append_info_to_payload(payload)\n+    super\n+    payload[:level] = case\n+    when payload[:status] == 200\n+      \"INFO\"\n+    when payload[:status] == 302\n+      \"WARN\"\n+    else\n+      \"ERROR\"\n+    end", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91ef6eac938d5392bfd4ffbfe40cd47248c3c512"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTgzMjYyMQ==", "bodyText": "Trailing whitespace detected.", "url": "https://github.com/CMSgov/dpc-app/pull/760#discussion_r411832621", "createdAt": "2020-04-21T03:00:16Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/controllers/application_controller.rb", "diffHunk": "@@ -21,8 +21,21 @@ def configure_permitted_parameters\n       )\n     end\n   end\n-\n+  ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91ef6eac938d5392bfd4ffbfe40cd47248c3c512"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTgzMjYyMw==", "bodyText": "Do not use empty case condition, instead use an if expression.", "url": "https://github.com/CMSgov/dpc-app/pull/760#discussion_r411832623", "createdAt": "2020-04-21T03:00:16Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/controllers/application_controller.rb", "diffHunk": "@@ -21,8 +21,21 @@ def configure_permitted_parameters\n       )\n     end\n   end\n-\n+  \n   def model_error_string(resource)\n     resource.errors.full_messages.join(', ')\n   end\n+\n+  # For increased logging on errors\n+  def append_info_to_payload(payload)\n+    super\n+    payload[:level] = case", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91ef6eac938d5392bfd4ffbfe40cd47248c3c512"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "765c9977d3b8d332260cad812e65984b472483c9", "author": {"user": {"login": "dhgreene", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/765c9977d3b8d332260cad812e65984b472483c9", "committedDate": "2020-04-21T04:16:39Z", "message": "Resolve intermittent NR config error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd1beab6c5836199a801028121e2f5a627c7d83d", "author": {"user": {"login": "dhgreene", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/cd1beab6c5836199a801028121e2f5a627c7d83d", "committedDate": "2020-04-21T04:17:24Z", "message": "Lograge initializer correction"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2OTgwMzA0", "url": "https://github.com/CMSgov/dpc-app/pull/760#pullrequestreview-396980304", "createdAt": "2020-04-21T04:35:11Z", "commit": {"oid": "cd1beab6c5836199a801028121e2f5a627c7d83d"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwNDozNToxMVrOGIyDUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwNDozNToxMVrOGIyDVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTg2MTg0MQ==", "bodyText": "Prefer single-quoted strings when you don't need string interpolation or special symbols.", "url": "https://github.com/CMSgov/dpc-app/pull/760#discussion_r411861841", "createdAt": "2020-04-21T04:35:11Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/controllers/application_controller.rb", "diffHunk": "@@ -21,8 +21,21 @@ def configure_permitted_parameters\n       )\n     end\n   end\n-\n+  \n   def model_error_string(resource)\n     resource.errors.full_messages.join(', ')\n   end\n+\n+  # For increased logging on errors\n+  def append_info_to_payload(payload)\n+    super\n+    payload[:level] = case\n+    when payload[:status] == 200\n+      \"INFO\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd1beab6c5836199a801028121e2f5a627c7d83d"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTg2MTg0Mw==", "bodyText": "Prefer single-quoted strings when you don't need string interpolation or special symbols.", "url": "https://github.com/CMSgov/dpc-app/pull/760#discussion_r411861843", "createdAt": "2020-04-21T04:35:11Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/controllers/application_controller.rb", "diffHunk": "@@ -21,8 +21,21 @@ def configure_permitted_parameters\n       )\n     end\n   end\n-\n+  \n   def model_error_string(resource)\n     resource.errors.full_messages.join(', ')\n   end\n+\n+  # For increased logging on errors\n+  def append_info_to_payload(payload)\n+    super\n+    payload[:level] = case\n+    when payload[:status] == 200\n+      \"INFO\"\n+    when payload[:status] == 302\n+      \"WARN\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd1beab6c5836199a801028121e2f5a627c7d83d"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTg2MTg0NQ==", "bodyText": "Prefer single-quoted strings when you don't need string interpolation or special symbols.", "url": "https://github.com/CMSgov/dpc-app/pull/760#discussion_r411861845", "createdAt": "2020-04-21T04:35:11Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/controllers/application_controller.rb", "diffHunk": "@@ -21,8 +21,21 @@ def configure_permitted_parameters\n       )\n     end\n   end\n-\n+  \n   def model_error_string(resource)\n     resource.errors.full_messages.join(', ')\n   end\n+\n+  # For increased logging on errors\n+  def append_info_to_payload(payload)\n+    super\n+    payload[:level] = case\n+    when payload[:status] == 200\n+      \"INFO\"\n+    when payload[:status] == 302\n+      \"WARN\"\n+    else\n+      \"ERROR\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd1beab6c5836199a801028121e2f5a627c7d83d"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffde2f470b2f2f2e81d4a3d13983d65ce30876ea", "author": {"user": {"login": "dhgreene", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/ffde2f470b2f2f2e81d4a3d13983d65ce30876ea", "committedDate": "2020-04-21T05:14:15Z", "message": "Code climate suggestions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d806efabb1a300be5d331f0aab77180e1caccfb", "author": {"user": {"login": "dhgreene", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/4d806efabb1a300be5d331f0aab77180e1caccfb", "committedDate": "2020-04-21T05:15:43Z", "message": "Merge branch 'master' into dhg/web-log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "697ae12bd7cfd5438b5ac81e7bfe1f03bb6cf206", "author": {"user": {"login": "dhgreene", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/697ae12bd7cfd5438b5ac81e7bfe1f03bb6cf206", "committedDate": "2020-04-21T13:31:29Z", "message": "Merge branch 'master' into dhg/web-log"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NDY2NTA2", "url": "https://github.com/CMSgov/dpc-app/pull/760#pullrequestreview-397466506", "createdAt": "2020-04-21T16:21:51Z", "commit": {"oid": "697ae12bd7cfd5438b5ac81e7bfe1f03bb6cf206"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NDk5NTA1", "url": "https://github.com/CMSgov/dpc-app/pull/760#pullrequestreview-397499505", "createdAt": "2020-04-21T17:02:20Z", "commit": {"oid": "697ae12bd7cfd5438b5ac81e7bfe1f03bb6cf206"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 106, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}