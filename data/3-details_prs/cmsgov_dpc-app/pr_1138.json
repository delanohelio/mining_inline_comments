{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1NDc4NzQw", "number": 1138, "title": "DPC-916 fix: Remove requirement for Patient to be in a group for Patient/$everything", "bodyText": "Fixes DPC-916\nThe Patient/$everything endpoint was unnecessarily requiring both a Provenance header (attesting to the provider/patient relationship) and a Roster for the given patient and provider. This was redundant and confusing for users.\nProposed Changes\nIt was decided to remove the requirement for a Roster when using Patient/$everything\n\nRemove Roster check from the PatientResource\nUpdate tests for this change\n\nChange Details\n\nThe PatientResourceTest is relying heavily on existing test data and the tests are dependent on one another. As part of this PR, I refactored some of this in order to aid in readability and adjust for the change to the PatientResource\nSince there was no longer a Roster, LookBackServiceImpl. getPractitionerNPIFromRoster was failing to return a Practitioner NPI. To fix this, I added a ProviderDAO and fallback to checking for the provider when there is not a Roster found.\nWe no longer need to limit the RosterDAO search by the provider now that we are checking for it in the LookBackServiceImpl\n\nSecurity Implications\n\n\n new software dependencies\n\n\n\n security controls or supporting software altered\n\n\n\n new data stored or transmitted\n\n\n\n security checklist is completed for this change\n\n\n\n requires more information or team discussion to evaluate security implications\n\n\n\n no PHI/PII is affected by this change\n\nLookBackService continues to check for Practitioner NPIs and Organization NPIs on the EoBs as before.\nAcceptance Validation\n\nall tests pass when running make ci-app locally\nsmoke tests pass locally\n\n\nFeedback Requested\nAny", "createdAt": "2020-12-09T21:34:11Z", "url": "https://github.com/CMSgov/dpc-app/pull/1138", "merged": true, "mergeCommit": {"oid": "c00ba9164b5f59e84f82f02d8240a5f3c096db08"}, "closed": true, "closedAt": "2020-12-11T16:49:21Z", "author": {"login": "jonfulk"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdklQb-gH2gAyNTM1NDc4NzQwOjE3MDBlOTRhYzM1ZmRhY2QzMDdmZDRiN2EyYmRjMzNiODdlMjMwNTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdlKp1tgFqTU1MDI1NzQ5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1700e94ac35fdacd307fd4b7a2bdc33b87e23056", "author": {"user": {"login": "jonfulk", "name": "M.Zola"}}, "url": "https://github.com/CMSgov/dpc-app/commit/1700e94ac35fdacd307fd4b7a2bdc33b87e23056", "committedDate": "2020-12-09T21:02:57Z", "message": "refactor: clean up `PatientResourceTest` and add new test\nTo improve readability, move duplicate code into shared private methods\n- split up `Patient/$everything` test\n- add new test for patients without groups"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d27af0bc53d5b06590b7609942bfacfe1bb5ad77", "author": {"user": {"login": "jonfulk", "name": "M.Zola"}}, "url": "https://github.com/CMSgov/dpc-app/commit/d27af0bc53d5b06590b7609942bfacfe1bb5ad77", "committedDate": "2020-12-09T21:13:20Z", "message": "refactor: rename `patientIDs` to `patientMBIs` for clarity"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "923e462cd4c43ae293c6cdaf32349129bff6d42c", "author": {"user": {"login": "jonfulk", "name": "M.Zola"}}, "url": "https://github.com/CMSgov/dpc-app/commit/923e462cd4c43ae293c6cdaf32349129bff6d42c", "committedDate": "2020-12-09T21:17:30Z", "message": "feat: Add `ProviderDAO` and enable retrieving Provider NPI from `LookBackServiceImpl` when no Roster."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f1f082fadbb2bac85b7f4f94c3d9545cae50122", "author": {"user": {"login": "jonfulk", "name": "M.Zola"}}, "url": "https://github.com/CMSgov/dpc-app/commit/9f1f082fadbb2bac85b7f4f94c3d9545cae50122", "committedDate": "2020-12-09T21:18:53Z", "message": "fix: no longer need to limit Roster check by Provider as we are checking this in the `LookBackServiceImpl`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79e3a9ddc1aad2f7171e7993254099efab4fc3be", "author": {"user": {"login": "jonfulk", "name": "M.Zola"}}, "url": "https://github.com/CMSgov/dpc-app/commit/79e3a9ddc1aad2f7171e7993254099efab4fc3be", "committedDate": "2020-12-09T21:20:08Z", "message": "fix: remove requirement for Patient to be in a Roster for `$everything` request and catch OperationOutcome from LookBack"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8513a0274b8255575c62c6be8956629bb26e393e", "author": {"user": {"login": "jonfulk", "name": "M.Zola"}}, "url": "https://github.com/CMSgov/dpc-app/commit/8513a0274b8255575c62c6be8956629bb26e393e", "committedDate": "2020-12-09T21:34:47Z", "message": "Merge branch 'master' into jkf/dpc-916-fix-patient-everything"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NjQxMDY3", "url": "https://github.com/CMSgov/dpc-app/pull/1138#pullrequestreview-548641067", "createdAt": "2020-12-09T21:52:24Z", "commit": {"oid": "8513a0274b8255575c62c6be8956629bb26e393e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMTo1MjoyNFrOICrMFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMTo1MjoyNFrOICrMFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY3NTY2OA==", "bodyText": "Method provideLookBackService has 5 arguments (exceeds 4 allowed). Consider refactoring.", "url": "https://github.com/CMSgov/dpc-app/pull/1138#discussion_r539675668", "createdAt": "2020-12-09T21:52:24Z", "author": {"login": "codeclimate"}, "path": "dpc-aggregation/src/main/java/gov/cms/dpc/aggregation/AggregationAppModule.java", "diffHunk": "@@ -94,13 +96,13 @@ public int provideJobTimeoutInSeconds() {\n     }\n \n     @Provides\n-    LookBackService provideLookBackService(DPCManagedSessionFactory sessionFactory, RosterDAO rosterDAO, OrganizationDAO organizationDAO, OperationsConfig operationsConfig) {\n+    LookBackService provideLookBackService(DPCManagedSessionFactory sessionFactory, ProviderDAO providerDAO, RosterDAO rosterDAO, OrganizationDAO organizationDAO, OperationsConfig operationsConfig) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8513a0274b8255575c62c6be8956629bb26e393e"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5MzA5NzE2", "url": "https://github.com/CMSgov/dpc-app/pull/1138#pullrequestreview-549309716", "createdAt": "2020-12-10T15:24:26Z", "commit": {"oid": "8513a0274b8255575c62c6be8956629bb26e393e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxNToyNDoyNlrOIDOuqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxNToyNDoyNlrOIDOuqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI1Nzk2Mw==", "bodyText": "could you change the description too?  Something like List of patient MBIs", "url": "https://github.com/CMSgov/dpc-app/pull/1138#discussion_r540257963", "createdAt": "2020-12-10T15:24:26Z", "author": {"login": "MrBilnon"}, "path": "dpc-queue/src/main/java/gov/cms/dpc/queue/service/DataService.java", "diffHunk": "@@ -53,17 +53,17 @@ public Resource retrieveData(UUID organizationId, UUID providerId, List<String>\n      * Retrieves data from BFD\n      * @param organizationID UUID of organization\n      * @param providerID UUID of provider\n-     * @param patientIDs List of patient String UUIDs\n+     * @param patientMBIs List of patient String UUIDs", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8513a0274b8255575c62c6be8956629bb26e393e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5MzEyNDk5", "url": "https://github.com/CMSgov/dpc-app/pull/1138#pullrequestreview-549312499", "createdAt": "2020-12-10T15:27:04Z", "commit": {"oid": "8513a0274b8255575c62c6be8956629bb26e393e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxNToyNzowNFrOIDO3aA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxNToyNzowNFrOIDO3aA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI2MDIwMA==", "bodyText": "not sure about the name of this exception as an operation outcome could be returned due to BFD being down or the MBI was in a bad format or something else.", "url": "https://github.com/CMSgov/dpc-app/pull/1138#discussion_r540260200", "createdAt": "2020-12-10T15:27:04Z", "author": {"login": "MrBilnon"}, "path": "dpc-api/src/main/java/gov/cms/dpc/api/resources/v1/PatientResource.java", "diffHunk": "@@ -198,16 +197,16 @@ public Bundle everything(@ApiParam(hidden = true) @Auth OrganizationPrincipal or\n         final String patientMbi = FHIRExtractors.getPatientMBI(patient);\n         final UUID orgId = organization.getID();\n \n-        if (!isPatientInRoster(patientId, FHIRExtractors.getProviderNPI(practitioner), orgId)) {\n-            throw new WebApplicationException(HttpStatus.UNAUTHORIZED_401);\n-        }\n-\n         final String requestingIP = APIHelpers.fetchRequestingIP(request);\n         Resource result = dataService.retrieveData(orgId, practitionerId, List.of(patientMbi), APIHelpers.fetchTransactionTime(bfdClient),\n                 requestingIP, ResourceType.Patient, ResourceType.ExplanationOfBenefit, ResourceType.Coverage);\n         if (ResourceType.Bundle.equals(result.getResourceType())) {\n             return (Bundle) result;\n         }\n+        if (ResourceType.OperationOutcome.equals(result.getResourceType())) {\n+            OperationOutcome resultOp = (OperationOutcome) result;\n+            throw new NotAuthorizedException(resultOp.getIssueFirstRep().getDetails().getText());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8513a0274b8255575c62c6be8956629bb26e393e"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f33e0b73e529c824c53c30965f7424f8019083bb", "author": {"user": {"login": "jonfulk", "name": "M.Zola"}}, "url": "https://github.com/CMSgov/dpc-app/commit/f33e0b73e529c824c53c30965f7424f8019083bb", "committedDate": "2020-12-11T15:36:37Z", "message": "fix: update argument description to match name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7d8935538bc3d69d6f055fd1a5591001281efe9", "author": {"user": {"login": "jonfulk", "name": "M.Zola"}}, "url": "https://github.com/CMSgov/dpc-app/commit/f7d8935538bc3d69d6f055fd1a5591001281efe9", "committedDate": "2020-12-11T15:37:03Z", "message": "fix: since exceptions from BFD could vary, return a 500"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e96deaefb338c46f6a9e00f5bb16c8cdc87b1bb1", "author": {"user": {"login": "jonfulk", "name": "M.Zola"}}, "url": "https://github.com/CMSgov/dpc-app/commit/e96deaefb338c46f6a9e00f5bb16c8cdc87b1bb1", "committedDate": "2020-12-11T15:44:13Z", "message": "fix: update test for different exception type"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwMjU1NzYx", "url": "https://github.com/CMSgov/dpc-app/pull/1138#pullrequestreview-550255761", "createdAt": "2020-12-11T16:35:10Z", "commit": {"oid": "e96deaefb338c46f6a9e00f5bb16c8cdc87b1bb1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwMjU3NDk3", "url": "https://github.com/CMSgov/dpc-app/pull/1138#pullrequestreview-550257497", "createdAt": "2020-12-11T16:37:11Z", "commit": {"oid": "e96deaefb338c46f6a9e00f5bb16c8cdc87b1bb1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 333, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}