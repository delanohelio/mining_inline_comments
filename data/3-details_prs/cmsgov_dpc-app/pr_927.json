{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1Nzg0NTc1", "number": 927, "title": "DPC-561 - Responses with 401 Unauthorized should return JSON Operation Outcome", "bodyText": "Fixes DPC-561\n\nIf a server returns a 401, it should return JSON instead of a regular text string, ie:\n{\n    \"resourceType\": \"OperationOutcome\",\n    \"issue\": [\n        {\n            \"severity\": \"error\",\n            \"code\": \"exception\",\n            \"details\": {\n                \"coding\": [\n                    \n{                         \"system\": \"http://hl7.org/fhir/ValueSet/operation-outcome\",                         \n\"code\": \"Credentials are required to access this resource.\"                     }\n                ]\n            }\n        }\n    ]\n}\n\n\nwith a content type of\napplication/fhir+json \n\ninstead of the current return:\nCredentials are required to access this resource.\n\nwith a content type of\ntext/plain\n\nProposed Changes\nThis required a new implementation of the DropWizard unauthorized Handler customized for DPC.\n\n\nCreated new implementation class DPCUnauthorizedHandler, which implements Dropwizard UnauthorizedHandler\nAdd binding in AuthModule for DPCUnauthorizedHandler\nUpdate DPCAuthFilter and extension classes (PathAuthorizationFilter and PrincipalInjectionAuthFilter) to use DPCUnauthorizedHandler\nUpdate DPCAuthFactory to use DPCUnauthorizedHandler\nUpdate JWTUnitTests and AuthHandlerTest to use DPCUnauthorizedHandler\n\nChange Details\n\nno further details\nSecurity Implications\n\nNo\n\n new software dependencies\nNo\n\n\n\n security controls or supporting software altered\nNo\n\n\n\n new data stored or transmitted\nNo\n\n\n\n security checklist is completed for this change\nN/A\n\n\n\n requires more information or team discussion to evaluate security implications\nNo\n\n\n\n[X ] no PHI/PII is affected by this change\n\n\nAcceptance Validation\n\nYes, via unit test and Postman tests\n\n\nFeedback Requested\n\nfeedback on scope of class and guice bindings", "createdAt": "2020-07-23T15:16:54Z", "url": "https://github.com/CMSgov/dpc-app/pull/927", "merged": true, "mergeCommit": {"oid": "bed6e9d1bf7e7c527c57cee9d61a7de06dbdaaf5"}, "closed": true, "closedAt": "2020-07-29T16:05:11Z", "author": {"login": "richbraman"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3iuu4AH2gAyNDU1Nzg0NTc1OmEwNGQ4YzFkM2MwZWUxYjRlNzc3MTQxYjIxMzdjOGUwYzM5MzYzMTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5tDTVAFqTQ1NzY1NjcyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a04d8c1d3c0ee1b4e777141b2137c8e0c3936315", "author": {"user": {"login": "richbraman", "name": "Richard Braman"}}, "url": "https://github.com/CMSgov/dpc-app/commit/a04d8c1d3c0ee1b4e777141b2137c8e0c3936315", "committedDate": "2020-07-22T22:39:44Z", "message": "added custom 401 unauthorized handler that returns a FHIR operation outcome"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a78c5e80eaf0ac0495daca1a36dd1f3b30528e0", "author": {"user": {"login": "richbraman", "name": "Richard Braman"}}, "url": "https://github.com/CMSgov/dpc-app/commit/7a78c5e80eaf0ac0495daca1a36dd1f3b30528e0", "committedDate": "2020-07-23T14:07:26Z", "message": "remove unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "339659c86e424576d6d3cd78bd851d70fc7a9c45", "author": {"user": {"login": "richbraman", "name": "Richard Braman"}}, "url": "https://github.com/CMSgov/dpc-app/commit/339659c86e424576d6d3cd78bd851d70fc7a9c45", "committedDate": "2020-07-23T14:10:35Z", "message": "Merge remote-tracking branch 'origin/master' into DPC-561"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MjYyMDc1", "url": "https://github.com/CMSgov/dpc-app/pull/927#pullrequestreview-454262075", "createdAt": "2020-07-23T15:39:51Z", "commit": {"oid": "339659c86e424576d6d3cd78bd851d70fc7a9c45"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNTozOTo1MVrOG2QYUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNTozOTo1MVrOG2QYVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU0NDY1OA==", "bodyText": "Add a nested comment explaining why this method is empty, throw an UnsupportedOperationException or complete the implementation.", "url": "https://github.com/CMSgov/dpc-app/pull/927#discussion_r459544658", "createdAt": "2020-07-23T15:39:51Z", "author": {"login": "codeclimate"}, "path": "dpc-api/src/main/java/gov/cms/dpc/api/auth/DPCUnauthorizedHandler.java", "diffHunk": "@@ -0,0 +1,35 @@\n+package gov.cms.dpc.api.auth;\n+\n+import io.dropwizard.auth.UnauthorizedHandler;\n+import org.hl7.fhir.dstu3.model.CodeableConcept;\n+import org.hl7.fhir.dstu3.model.Coding;\n+import org.hl7.fhir.dstu3.model.OperationOutcome;\n+import javax.inject.Inject;\n+import javax.ws.rs.core.Response;\n+import javax.ws.rs.core.Response.Status;\n+import static gov.cms.dpc.fhir.FHIRMediaTypes.FHIR_JSON;\n+\n+public class DPCUnauthorizedHandler implements UnauthorizedHandler {\n+\n+    @Inject\n+    public DPCUnauthorizedHandler() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "339659c86e424576d6d3cd78bd851d70fc7a9c45"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU0NDY2MA==", "bodyText": "Similar blocks of code found in 4 locations. Consider refactoring.", "url": "https://github.com/CMSgov/dpc-app/pull/927#discussion_r459544660", "createdAt": "2020-07-23T15:39:51Z", "author": {"login": "codeclimate"}, "path": "dpc-api/src/main/java/gov/cms/dpc/api/auth/DPCAuthFilter.java", "diffHunk": "@@ -34,12 +33,14 @@\n \n     private final TokenDAO dao;\n     private final MacaroonBakery bakery;\n+    private final DPCUnauthorizedHandler dpc401handler;\n \n \n-    protected DPCAuthFilter(MacaroonBakery bakery, Authenticator<DPCAuthCredentials, OrganizationPrincipal> auth, TokenDAO dao) {\n+    protected DPCAuthFilter(MacaroonBakery bakery, Authenticator<DPCAuthCredentials, OrganizationPrincipal> auth, TokenDAO dao, DPCUnauthorizedHandler dpc401handler ) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "339659c86e424576d6d3cd78bd851d70fc7a9c45"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NjU2NzI0", "url": "https://github.com/CMSgov/dpc-app/pull/927#pullrequestreview-457656724", "createdAt": "2020-07-29T15:49:06Z", "commit": {"oid": "339659c86e424576d6d3cd78bd851d70fc7a9c45"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 431, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}