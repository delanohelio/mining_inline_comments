{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1NTYzNjcx", "number": 611, "title": "DPC 1011: Unique auto number generator for vendor id", "bodyText": "Why\nOn the creation of a vendor organization, the rails app will auto-generate a vendor id to be used in place of an npi for the sandbox api.\nWhat Changed\n\nWhen an org is created, if organization_type == 'health_it_vendor' the rails app will auto-generate a vendor id.\nWhen an org is updated, if organization_type == 'health_it_vendor and the vendor id is blank, the rails app will auto-generate a vendor id.\nWhen a vendor org is registered for sandbox api, OrganizationSubmitSerializer and FhirResourceBuilder will use the vendor_id instead of npi as an identifier.\n\nChoices Made\nVendor ids will start with \"V_\" for easy querying.\nTickets closed:\nDPC 1011\nFuture Work\nContinue with DPC 997 ticket sub tickets\nChecklist\n\n All tests are passing via make ci-app (app change) and make ci-web (website change)\n Swagger documentation has been updated\n FHIR documentation has been updated\n Any required dpc-ops changes have a PR submitted and mentioned in this ticket\n Any manual migration steps are documented, scripts written (where applicable), and tested\n Before merging, any required dpc-ops changes have been approved and merged into master of the dpc-ops repo", "createdAt": "2020-02-14T20:36:58Z", "url": "https://github.com/CMSgov/dpc-app/pull/611", "merged": true, "mergeCommit": {"oid": "416cb34d0aded1b1d36f2402b142cc423cf923b2"}, "closed": true, "closedAt": "2020-02-24T12:39:59Z", "author": {"login": "Sun-Mountain"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcEVgnwgH2gAyMzc1NTYzNjcxOmVkMTJlN2ZhMmI1ZGRmM2MwOTU3MTg2ZWQ3NjM2YjQ1MTk1MGM0NTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGmwCAgH2gAyMzc1NTYzNjcxOjNkNGZmMmQwMTRlMmFjMmNiNjY1MThmNzgwYTBhMDRiZWIzZjFjODQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ed12e7fa2b5ddf3c0957186ed7636b451950c458", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/ed12e7fa2b5ddf3c0957186ed7636b451950c458", "committedDate": "2020-02-14T20:25:25Z", "message": "generate vendor id on org creation and org update (if vendor id is blank)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86e3497bf435fad4374cf4615e4ac37d48fa5b96", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/86e3497bf435fad4374cf4615e4ac37d48fa5b96", "committedDate": "2020-02-14T20:26:54Z", "message": "organization serializer uses vendor id instead of npi if org type is 'health_it_vendor' in sandbox api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f5ddef3d8052391dd4b87e97595325c7be8151f", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/5f5ddef3d8052391dd4b87e97595325c7be8151f", "committedDate": "2020-02-14T20:28:03Z", "message": "on org update in api, if org type is 'health_it_vendor' will use vendor id instead of npi"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxMTc1NjE3", "url": "https://github.com/CMSgov/dpc-app/pull/611#pullrequestreview-361175617", "createdAt": "2020-02-19T14:51:02Z", "commit": {"oid": "5f5ddef3d8052391dd4b87e97595325c7be8151f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNDo1MTowMlrOFrrKVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNDo1NjoyMlrOFrraCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM0MDI0Ng==", "bodyText": "This is actually already a method that's available because of the organization_type enum. Rails enum gives you a few helper methods -- including a boolean response method for every option in the enum. We have #primary_care_clinic?, #speciality_clinic?, #health_it_vendor?, etc. Can we utilize that instead of writing a new method? (Or, if a new method is necessary, let's call it something else so that the enum method isn't overwritten.)", "url": "https://github.com/CMSgov/dpc-app/pull/611#discussion_r381340246", "createdAt": "2020-02-19T14:51:02Z", "author": {"login": "switzersc-usds"}, "path": "dpc-web/app/models/organization.rb", "diffHunk": "@@ -39,6 +42,16 @@ def api_credentialable?\n     registered_organizations.count.positive? && npi.present?\n   end\n \n+  def assign_vendor_id\n+    current_org = Organization.find(id)\n+    current_org.vendor_id = \"V_#{SecureRandom.alphanumeric(10)}\"\n+    current_org.save!\n+  end\n+\n+  def health_it_vendor?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f5ddef3d8052391dd4b87e97595325c7be8151f"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM0Mjc2Mg==", "bodyText": "We should do something like the loop demonstrated in the top example here to ensure that the vendor_id generated doesn't already exist.", "url": "https://github.com/CMSgov/dpc-app/pull/611#discussion_r381342762", "createdAt": "2020-02-19T14:54:24Z", "author": {"login": "switzersc-usds"}, "path": "dpc-web/app/models/organization.rb", "diffHunk": "@@ -39,6 +42,16 @@ def api_credentialable?\n     registered_organizations.count.positive? && npi.present?\n   end\n \n+  def assign_vendor_id\n+    current_org = Organization.find(id)\n+    current_org.vendor_id = \"V_#{SecureRandom.alphanumeric(10)}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f5ddef3d8052391dd4b87e97595325c7be8151f"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM0MzI2Mg==", "bodyText": "If we use before_create and before_update callbacks instead, then the save! isn't necessary. Let's do that to minimize database writes. On that note -- can we use just before_save (which gets called during create and update) instead of two callbacks?", "url": "https://github.com/CMSgov/dpc-app/pull/611#discussion_r381343262", "createdAt": "2020-02-19T14:55:03Z", "author": {"login": "switzersc-usds"}, "path": "dpc-web/app/models/organization.rb", "diffHunk": "@@ -39,6 +42,16 @@ def api_credentialable?\n     registered_organizations.count.positive? && npi.present?\n   end\n \n+  def assign_vendor_id\n+    current_org = Organization.find(id)\n+    current_org.vendor_id = \"V_#{SecureRandom.alphanumeric(10)}\"\n+    current_org.save!", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f5ddef3d8052391dd4b87e97595325c7be8151f"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM0NDEzMQ==", "bodyText": "We can use the enum method provided by Rails here (if the custom method is removed/changed):\n            value: object.health_it_vendor? ? object.vendor_id : object.npi", "url": "https://github.com/CMSgov/dpc-app/pull/611#discussion_r381344131", "createdAt": "2020-02-19T14:56:11Z", "author": {"login": "switzersc-usds"}, "path": "dpc-web/app/serializers/organization_submit_serializer.rb", "diffHunk": "@@ -26,7 +26,7 @@ def organization_resource\n         identifier: [\n           {\n             system: 'http://hl7.org/fhir/sid/us-npi',\n-            value: object.npi\n+            value: object.organization_type == 'health_it_vendor' ? object.vendor_id : object.npi", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f5ddef3d8052391dd4b87e97595325c7be8151f"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM0NDI2NA==", "bodyText": "Ditto", "url": "https://github.com/CMSgov/dpc-app/pull/611#discussion_r381344264", "createdAt": "2020-02-19T14:56:22Z", "author": {"login": "switzersc-usds"}, "path": "dpc-web/app/services/fhir_resource_builder.rb", "diffHunk": "@@ -6,7 +6,12 @@ def fhir_org(reg_org)\n     fhir_org = FHIR::Organization.new(\n       id: reg_org.api_id,\n       name: org.name,\n-      identifier: [{ system: 'http://hl7.org/fhir/sid/us-npi', value: org.npi }]\n+      identifier: [\n+        {\n+          system: 'http://hl7.org/fhir/sid/us-npi',\n+          value: org.organization_type == 'health_it_vendor' ? org.vendor_id : org.npi", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f5ddef3d8052391dd4b87e97595325c7be8151f"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abd204ee6bf492595fd9a24e713ee662961d2c1a", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/abd204ee6bf492595fd9a24e713ee662961d2c1a", "committedDate": "2020-02-20T14:42:11Z", "message": "use enum instead of new method to check org type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d55c0036e033ecfc66c0478c3b11c2b3d41ded4", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/4d55c0036e033ecfc66c0478c3b11c2b3d41ded4", "committedDate": "2020-02-20T14:57:18Z", "message": "Merge branch 'master' into nzonnenberg/DPC-1011-generate-vendor-id"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxOTk4NjAx", "url": "https://github.com/CMSgov/dpc-app/pull/611#pullrequestreview-361998601", "createdAt": "2020-02-20T15:30:43Z", "commit": {"oid": "4d55c0036e033ecfc66c0478c3b11c2b3d41ded4"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNTozMDo0M1rOFsX_BA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNTozMDo0M1rOFsX_CQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA3NDYyOA==", "bodyText": "Remove debugger entry point binding.pry.", "url": "https://github.com/CMSgov/dpc-app/pull/611#discussion_r382074628", "createdAt": "2020-02-20T15:30:43Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/models/organization.rb", "diffHunk": "@@ -39,6 +41,13 @@ def api_credentialable?\n     registered_organizations.count.positive? && npi.present?\n   end\n \n+  def assign_vendor_id\n+    if vendor_id.blank?\n+      self.vendor_id = \"V_#{SecureRandom.alphanumeric(10)}\"\n+      binding.pry", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d55c0036e033ecfc66c0478c3b11c2b3d41ded4"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA3NDYzMw==", "bodyText": "Use a guard clause instead of wrapping the code inside a conditional expression.", "url": "https://github.com/CMSgov/dpc-app/pull/611#discussion_r382074633", "createdAt": "2020-02-20T15:30:43Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/models/organization.rb", "diffHunk": "@@ -39,6 +41,13 @@ def api_credentialable?\n     registered_organizations.count.positive? && npi.present?\n   end\n \n+  def assign_vendor_id\n+    if vendor_id.blank?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d55c0036e033ecfc66c0478c3b11c2b3d41ded4"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6dc6c0c3d191cef9c87e5ad47b40cc341b1d438", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/c6dc6c0c3d191cef9c87e5ad47b40cc341b1d438", "committedDate": "2020-02-20T21:08:39Z", "message": "upadted for more efficient code from notes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fa39fe0c9e653e77fa5e71108472f317c34cc32", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/8fa39fe0c9e653e77fa5e71108472f317c34cc32", "committedDate": "2020-02-20T21:09:15Z", "message": "Merge branch 'master' into nzonnenberg/DPC-1011-generate-vendor-id"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMjYxNjQ4", "url": "https://github.com/CMSgov/dpc-app/pull/611#pullrequestreview-362261648", "createdAt": "2020-02-20T21:54:24Z", "commit": {"oid": "8fa39fe0c9e653e77fa5e71108472f317c34cc32"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMTo1NDoyNFrOFskd5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMTo1NDoyNFrOFskd5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI3OTE0MQ==", "bodyText": "Add empty line after guard clause.", "url": "https://github.com/CMSgov/dpc-app/pull/611#discussion_r382279141", "createdAt": "2020-02-20T21:54:24Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/models/organization.rb", "diffHunk": "@@ -39,6 +41,18 @@ def api_credentialable?\n     registered_organizations.count.positive? && npi.present?\n   end\n \n+  def assign_vendor_id\n+    return true if vendor_id.present?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fa39fe0c9e653e77fa5e71108472f317c34cc32"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4849198edd83650e55179045b02791ecd3d19b0", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/c4849198edd83650e55179045b02791ecd3d19b0", "committedDate": "2020-02-21T16:46:54Z", "message": "Merge branch 'master' of github.com:CMSgov/dpc-app into nzonnenberg/DPC-1011-generate-vendor-id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb40e0736fed3e47dafffc64b97906d022a55906", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/fb40e0736fed3e47dafffc64b97906d022a55906", "committedDate": "2020-02-21T20:33:57Z", "message": "testing vendor_id generator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "130942d3ceed0889edff73b5b6e6a560d2f27c13", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/130942d3ceed0889edff73b5b6e6a560d2f27c13", "committedDate": "2020-02-21T20:43:48Z", "message": "more efficient code for serializers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "989087f9ba03a3d37aa7d22ec4d2feb73f0948b6", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/989087f9ba03a3d37aa7d22ec4d2feb73f0948b6", "committedDate": "2020-02-21T20:44:44Z", "message": "Update organization.rb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c44070995bbff86fb7813f687e2055858b1d824", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/2c44070995bbff86fb7813f687e2055858b1d824", "committedDate": "2020-02-21T21:01:11Z", "message": "Update organization.rb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "466d4c6d4487b2cd8bb00a77f24cf8585808a058", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/466d4c6d4487b2cd8bb00a77f24cf8585808a058", "committedDate": "2020-02-21T21:01:20Z", "message": "Merge branch 'master' into nzonnenberg/DPC-1011-generate-vendor-id"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyOTE1MTg2", "url": "https://github.com/CMSgov/dpc-app/pull/611#pullrequestreview-362915186", "createdAt": "2020-02-21T21:03:21Z", "commit": {"oid": "466d4c6d4487b2cd8bb00a77f24cf8585808a058"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0769a8a3236cf577e1ef86ae4f7372650c86150d", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/0769a8a3236cf577e1ef86ae4f7372650c86150d", "committedDate": "2020-02-21T21:18:53Z", "message": "Update organization.rb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d4ff2d014e2ac2cb66518f780a0a04beb3f1c84", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/3d4ff2d014e2ac2cb66518f780a0a04beb3f1c84", "committedDate": "2020-02-21T21:38:29Z", "message": "Merge branch 'master' into nzonnenberg/DPC-1011-generate-vendor-id"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 257, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}