{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwNTExMDE0", "number": 992, "title": "Silvio/dpc 156 rate limit emails", "bodyText": "Fixes DPC-156\n\nCurrently, a user can spam emails via the reset password request, the confirmation email request as well as the sandbox organization email request. This needs to be throttled to avoid a potential attack.\nProposed Changes\n\nEnable email throttling by allowing a user to only make a certain amount of email requests in a given time.\nChange Details\n\nUse Redis to create a key value based throttling system. Increment a key (using the email) every time an email request is made and set it to expire in a given time. If the user hits an established threshold within that time with the amount of email requests they have made it will silently not queue anymore emails (as per given instructions of the ticket). Once the key has expired the user will be free to start sending emails again if need be.\nCurrently, the configuration for the email limit and the expiration time has been set to 5 emails and 300 seconds. This can be changed within the application.rb file.\nSecurity Implications\n\n\n\n new software dependencies\n\n\nredis-namespace\n\n\nfakeredis\n\n\nredis-namespace is a small gem that couples with our redis gem. It provides an interface to a namespaced subset of the redis keyspace. It keeps key management from getting long and cluttered.\nfakeredis is a gem that provides an in-memory drier for our tests. It allows testing with out having an actual instance of redis running for our test suite.\n\n\n security controls or supporting software altered\n\n\n\n new data stored or transmitted\n\n\n\n security checklist is completed for this change\n\n\n\n requires more information or team discussion to evaluate security implications\n\n\n\n no PHI/PII is affected by this change\n\n\nAcceptance Validation\n\n\nFeedback Requested", "createdAt": "2020-08-19T23:23:23Z", "url": "https://github.com/CMSgov/dpc-app/pull/992", "merged": true, "mergeCommit": {"oid": "c536fd43233dc61b51c471516bedf389019c5751"}, "closed": true, "closedAt": "2020-08-21T17:00:44Z", "author": {"login": "SMLuthi"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAPHEeAH2gAyNDcwNTExMDE0OmJmZDUxNTcyMzBhNzQyYjE1Yjg0OGUzOTJhMzNjMGYzYWFiYzg4Nzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdBGjMjAH2gAyNDcwNTExMDE0OmQ5MGZmYTk1NDA0ZmNjMzdjOTFjY2IwMTQ2NzA1ZDI5Zjc5MzRlYzk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bfd5157230a742b15b848e392a33c0f3aabc8877", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/bfd5157230a742b15b848e392a33c0f3aabc8877", "committedDate": "2020-08-18T22:53:32Z", "message": "Add redis-namespace gem"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8feae86b0aafd0d2e4602033f64fa3a73c177443", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/8feae86b0aafd0d2e4602033f64fa3a73c177443", "committedDate": "2020-08-18T22:54:52Z", "message": "create redis store mail throttle class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ab754503b7003c0bf93d85785b830d7786ebeab", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/9ab754503b7003c0bf93d85785b830d7786ebeab", "committedDate": "2020-08-19T21:56:00Z", "message": "Add fake redis for test runs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78cfc807245f51d952a1b33b3343a7511e0c48c5", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/78cfc807245f51d952a1b33b3343a7511e0c48c5", "committedDate": "2020-08-19T21:57:05Z", "message": "Add mail throttle store tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8edf08525b610cbc8bbab252ff4e45258cc17c5f", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/8edf08525b610cbc8bbab252ff4e45258cc17c5f", "committedDate": "2020-08-19T21:57:24Z", "message": "Add application configs for mail throttler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c091bb436aa31847b5b3822e5ff9ff30fa3bef7b", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/c091bb436aa31847b5b3822e5ff9ff30fa3bef7b", "committedDate": "2020-08-19T22:16:43Z", "message": "Add mail throttling to the organization email for sandbox"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e5c8033d64c013e31792983aed5e633dc62bc2f", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/9e5c8033d64c013e31792983aed5e633dc62bc2f", "committedDate": "2020-08-19T22:17:06Z", "message": "Add tests for org mail throttling email"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27dcc05df9ffa060ec02106d1188fd461588c131", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/27dcc05df9ffa060ec02106d1188fd461588c131", "committedDate": "2020-08-19T22:27:15Z", "message": "add mail throttling to password reset requests by users"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2cead259c72ccf13afbea16474fabc02e6a7707", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/e2cead259c72ccf13afbea16474fabc02e6a7707", "committedDate": "2020-08-19T22:27:55Z", "message": "Add reset user password rate limit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "423e1ba9992869f33e336c9596b755b5a5bd0929", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/423e1ba9992869f33e336c9596b755b5a5bd0929", "committedDate": "2020-08-19T23:14:35Z", "message": "Add email throttling for confirmation emails"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d063b9757028a4520de4840bc0c71f978f26598", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/4d063b9757028a4520de4840bc0c71f978f26598", "committedDate": "2020-08-19T23:39:01Z", "message": "Add after clause to spec tests to reset rails config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f005669b285571678cd8c4ebd23f39647a58c6d", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/0f005669b285571678cd8c4ebd23f39647a58c6d", "committedDate": "2020-08-19T23:39:35Z", "message": "Merge branch 'master' into silvio/dpc-156-rate-limit-emails"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a817ae8e16e8ce0fc76d6ef03c97b9f6ba0f5cf5", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/a817ae8e16e8ce0fc76d6ef03c97b9f6ba0f5cf5", "committedDate": "2020-08-19T23:43:53Z", "message": "codeclimate fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMDQ0MDc4", "url": "https://github.com/CMSgov/dpc-app/pull/992#pullrequestreview-471044078", "createdAt": "2020-08-20T00:09:21Z", "commit": {"oid": "a817ae8e16e8ce0fc76d6ef03c97b9f6ba0f5cf5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMDowOToyMVrOHDhsVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMDowOToyMVrOHDhsVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ1OTc5Ng==", "bodyText": "Use a guard clause instead of wrapping the code inside a conditional expression.", "url": "https://github.com/CMSgov/dpc-app/pull/992#discussion_r473459796", "createdAt": "2020-08-20T00:09:21Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/models/organization_user_assignment.rb", "diffHunk": "@@ -12,9 +14,13 @@ class OrganizationUserAssignment < ApplicationRecord\n   def send_organization_sandbox_email\n     return unless organization.prod_sbx? && organization.registered_organization.present?\n \n-    UserMailer\n-      .with(user: user, vendor: organization.health_it_vendor?)\n-      .organization_sandbox_email\n-      .deliver_later\n+    mail_throttle_store = RedisStore::MailThrottleStore.new\n+\n+    if mail_throttle_store.can_email? user.email", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a817ae8e16e8ce0fc76d6ef03c97b9f6ba0f5cf5"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxNjY2MzQ5", "url": "https://github.com/CMSgov/dpc-app/pull/992#pullrequestreview-471666349", "createdAt": "2020-08-20T14:23:31Z", "commit": {"oid": "a817ae8e16e8ce0fc76d6ef03c97b9f6ba0f5cf5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNDoyMzozMVrOHEEB9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNDoyMzozMVrOHEEB9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAyMjM5MA==", "bodyText": "Is this worth allowing an env var to override, in case we want to dial this back during an event?\nAlso, is 10 too high for a default?  Allowing for 1 email confirmation, 1 password reset, 1 email for future purposes, multiplied by a 2x \"oops\" factor still only gives 6 emails--and that sequence might take more than 5 minutes.", "url": "https://github.com/CMSgov/dpc-app/pull/992#discussion_r474022390", "createdAt": "2020-08-20T14:23:31Z", "author": {"login": "dhgreene"}, "path": "dpc-web/config/application.rb", "diffHunk": "@@ -53,5 +53,9 @@ class Application < Rails::Application\n     config.action_mailer.delivery_job = \"ActionMailer::MailDeliveryJob\"\n \n     config.to_prepare { Devise::Mailer.layout \"mailer\" }\n+\n+    # Mail throttling\n+    config.x.mail_throttle.limit = 10 # Limit to 10 emails before hard stop", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a817ae8e16e8ce0fc76d6ef03c97b9f6ba0f5cf5"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxNjcwNDEw", "url": "https://github.com/CMSgov/dpc-app/pull/992#pullrequestreview-471670410", "createdAt": "2020-08-20T14:27:26Z", "commit": {"oid": "a817ae8e16e8ce0fc76d6ef03c97b9f6ba0f5cf5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNDoyNzoyNlrOHEENqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNDoyNzoyNlrOHEENqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAyNTM4NA==", "bodyText": "Can you mention the new dependencies in the PR description, with some thoughts about selection criteria?", "url": "https://github.com/CMSgov/dpc-app/pull/992#discussion_r474025384", "createdAt": "2020-08-20T14:27:26Z", "author": {"login": "dhgreene"}, "path": "dpc-web/Gemfile", "diffHunk": "@@ -35,6 +35,7 @@ gem 'kaminari'\n gem 'active_model_serializers'\n gem 'macaroons'\n gem 'lograge'\n+gem 'redis-namespace'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a817ae8e16e8ce0fc76d6ef03c97b9f6ba0f5cf5"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96b8e36e8e299a62cfc4677153db7ee28b3300a7", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/96b8e36e8e299a62cfc4677153db7ee28b3300a7", "committedDate": "2020-08-20T15:22:38Z", "message": "Merge branch 'master' into silvio/dpc-156-rate-limit-emails"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b705aea9d11f9369820074e216b155cf2eca25f", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/0b705aea9d11f9369820074e216b155cf2eca25f", "committedDate": "2020-08-20T19:01:40Z", "message": "Add tests for password confirmation page"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f18219f650c2f667eadc6a767d3e44cf212737f", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/7f18219f650c2f667eadc6a767d3e44cf212737f", "committedDate": "2020-08-20T19:02:00Z", "message": "Merge branch 'silvio/dpc-156-rate-limit-emails' of github.com:CMSgov/dpc-app into silvio/dpc-156-rate-limit-emails"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbadf20d7004343cebeb65e3ff46bcd518caf2ca", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/dbadf20d7004343cebeb65e3ff46bcd518caf2ca", "committedDate": "2020-08-20T19:05:26Z", "message": "change mail throttle limit to be fetched through an ENV var (or default)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxOTA0NDc2", "url": "https://github.com/CMSgov/dpc-app/pull/992#pullrequestreview-471904476", "createdAt": "2020-08-20T19:09:08Z", "commit": {"oid": "dbadf20d7004343cebeb65e3ff46bcd518caf2ca"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxOTowOTowOFrOHEPcVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxOTowOTowOFrOHEPcVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDIwOTM2NA==", "bodyText": "Should this be setting it back to its original value, rather than 10?", "url": "https://github.com/CMSgov/dpc-app/pull/992#discussion_r474209364", "createdAt": "2020-08-20T19:09:08Z", "author": {"login": "dhgreene"}, "path": "dpc-web/spec/features/confirmation/user_confirmation_email_spec.rb", "diffHunk": "@@ -0,0 +1,78 @@\n+# frozen_string_literal: true\n+\n+require 'rails_helper'\n+\n+RSpec.feature 'user resends confirmation instructions' do\n+  let(:user) { create :user, confirmed_at: nil }\n+\n+  context 'when successful' do\n+    scenario 'user resends confirmation instructions' do\n+      visit new_user_confirmation_path\n+\n+      fill_in 'user_email', with: user.email\n+\n+      expect do\n+        find('input[data-test=\"submit\"]').click\n+        Sidekiq::Worker.drain_all\n+      end.to change(ActionMailer::Base.deliveries, :count).by(2)\n+\n+      last_delivery = ActionMailer::Base.deliveries.last\n+      email = last_delivery.body\n+\n+      expect(email).to include('Confirm my account')\n+\n+      confirmation_link = last_delivery.body.raw_source.match(%r{href=\"http:\\/\\/localhost:3000(?<path>.+?)\">})[:path]\n+\n+      visit confirmation_link\n+\n+      expect(page.body).to include(\"Welcome, #{user.first_name}!\")\n+    end\n+  end\n+\n+  context 'when incorrect email' do\n+    scenario 'user does not send confirmation instructions' do\n+      visit new_user_confirmation_path\n+\n+      fill_in 'user_email', with: 'not_a_real@email.com'\n+\n+      expect do\n+        find('input[data-test=\"submit\"]').click\n+        Sidekiq::Worker.drain_all\n+      end.to change(ActionMailer::Base.deliveries, :count).by(0)\n+\n+      expect(page.body).to include('Resend confirmation instructions')\n+    end\n+  end\n+\n+  context 'with too many emails' do\n+    before do\n+      Rails.configuration.x.mail_throttle.limit = 1\n+    end\n+\n+    after do\n+      Rails.configuration.x.mail_throttle.limit = 10", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dbadf20d7004343cebeb65e3ff46bcd518caf2ca"}, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxOTA0NzAw", "url": "https://github.com/CMSgov/dpc-app/pull/992#pullrequestreview-471904700", "createdAt": "2020-08-20T19:09:29Z", "commit": {"oid": "dbadf20d7004343cebeb65e3ff46bcd518caf2ca"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxOTowOToyOVrOHEPdCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxOTowOToyOVrOHEPdCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDIwOTU0NA==", "bodyText": ". . . same as above", "url": "https://github.com/CMSgov/dpc-app/pull/992#discussion_r474209544", "createdAt": "2020-08-20T19:09:29Z", "author": {"login": "dhgreene"}, "path": "dpc-web/spec/lib/redis_store/mail_throttle_store_spec.rb", "diffHunk": "@@ -0,0 +1,54 @@\n+# frozen_string_literal: true\n+\n+require 'rails_helper'\n+require './lib/redis_store/mail_throttle_store'\n+\n+describe RedisStore::MailThrottleStore do\n+  let(:mail_throttler) { described_class.new }\n+  let(:limit) { 2 }\n+  let(:expiration) { 5 }\n+\n+  before do\n+    Rails.configuration.x.mail_throttle.limit = limit\n+    Rails.configuration.x.mail_throttle.expiration = expiration\n+  end\n+\n+  after do\n+    Rails.configuration.x.mail_throttle.limit = 10", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dbadf20d7004343cebeb65e3ff46bcd518caf2ca"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxOTA0ODE3", "url": "https://github.com/CMSgov/dpc-app/pull/992#pullrequestreview-471904817", "createdAt": "2020-08-20T19:09:41Z", "commit": {"oid": "dbadf20d7004343cebeb65e3ff46bcd518caf2ca"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxOTowOTo0MVrOHEPdaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxOTowOTo0MVrOHEPdaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDIwOTY0MQ==", "bodyText": ". . . and again", "url": "https://github.com/CMSgov/dpc-app/pull/992#discussion_r474209641", "createdAt": "2020-08-20T19:09:41Z", "author": {"login": "dhgreene"}, "path": "dpc-web/spec/models/organization_user_assignment_spec.rb", "diffHunk": "@@ -36,6 +37,33 @@\n \n         expect(UserMailer).not_to have_received(:with)\n       end\n+\n+      context 'when mail rate limit has been reached' do\n+        before do\n+          Rails.configuration.x.mail_throttle.limit = 0\n+        end\n+\n+        after do\n+          Rails.configuration.x.mail_throttle.limit = 10", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dbadf20d7004343cebeb65e3ff46bcd518caf2ca"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bd4f3b2d79a0d20e52d64fecf988b0b80798085", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/1bd4f3b2d79a0d20e52d64fecf988b0b80798085", "committedDate": "2020-08-20T21:47:11Z", "message": "Chamnge before/after blocks to be around blocks and reset default config values instead of arbitrary ints"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyNDU2NDA5", "url": "https://github.com/CMSgov/dpc-app/pull/992#pullrequestreview-472456409", "createdAt": "2020-08-21T12:44:28Z", "commit": {"oid": "1bd4f3b2d79a0d20e52d64fecf988b0b80798085"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d90ffa95404fcc37c91ccb0146705d29f7934ec9", "author": {"user": {"login": "SMLuthi", "name": null}}, "url": "https://github.com/CMSgov/dpc-app/commit/d90ffa95404fcc37c91ccb0146705d29f7934ec9", "committedDate": "2020-08-21T15:29:02Z", "message": "Merge branch 'master' into silvio/dpc-156-rate-limit-emails"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 359, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}