{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2Mzg0NzA5", "number": 680, "title": "DPC-1158: Cannot delete Thomas Jefferson University or Webster organization records in the admin portal", "bodyText": "Why\nIf an organization is deleted directly in the API, the app returns an error when an internal user tries to disable or delete an organization.\nWhat Changed\nWhen the API returns the error 'Cannot find organization', the app will still disable the organization from the API. The user will also be able to delete the enabled organization.\nChoices Made\nN/A\nTickets closed:\nDPC-1158\nFuture Work\nN/A\nChecklist\n\n All tests are passing via make ci-app (app change) and make ci-web (website change)\n Swagger documentation has been updated\n FHIR documentation has been updated\n Any required dpc-ops changes have a PR submitted and mentioned in this ticket\n Any manual migration steps are documented, scripts written (where applicable), and tested\n Before merging, any required dpc-ops changes have been approved and merged into master of the dpc-ops repo", "createdAt": "2020-03-10T21:59:06Z", "url": "https://github.com/CMSgov/dpc-app/pull/680", "merged": true, "mergeCommit": {"oid": "ecef61ac62eb9bdc273612fbc1ac0234f964230d"}, "closed": true, "closedAt": "2020-03-18T15:19:15Z", "author": {"login": "Sun-Mountain"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKr-ANAH2gAyMzg2Mzg0NzA5OjM2ZTg3NjkxMjgyNzUwMWY5MWY4YWQ0NTAyNWU4ZDE4ZjYwZTdkOTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcO4o_sgH2gAyMzg2Mzg0NzA5OmJmOTRiZDRiYzA0NzMxMjViZjFjNDY4Yjc4NzIwMTdiYmQxOWMxNWM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "36e876912827501f91f8ad45025e8d18f60e7d91", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/36e876912827501f91f8ad45025e8d18f60e7d91", "committedDate": "2020-03-05T13:58:58Z", "message": "switched delegated_macaroon with golden_macaroon to delete_organization function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c34bf44fe95c5f18c81d19e7db6c9f99930a6c18", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/c34bf44fe95c5f18c81d19e7db6c9f99930a6c18", "committedDate": "2020-03-10T21:27:18Z", "message": "delete_api_org exception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMzU4OTU2", "url": "https://github.com/CMSgov/dpc-app/pull/680#pullrequestreview-372358956", "createdAt": "2020-03-10T22:15:14Z", "commit": {"oid": "c34bf44fe95c5f18c81d19e7db6c9f99930a6c18"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMjoxNToxNFrOF0i9Iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMjoxNToxNVrOF0i9JQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY0Mjk3OQ==", "bodyText": "Use a guard clause instead of wrapping the code inside a conditional expression.", "url": "https://github.com/CMSgov/dpc-app/pull/680#discussion_r390642979", "createdAt": "2020-03-10T22:15:14Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/models/registered_organization.rb", "diffHunk": "@@ -76,10 +76,15 @@ def update_api_endpoint\n   def delete_api_organization\n     api_request = APIClient.new(api_env).delete_organization(self)\n     api_response = api_request.response_body\n-    return if api_request.response_successful?\n \n-    errors.add(:base, \"couldn't be deleted from #{api_env} API: #{api_response}\")\n-    throw(:abort)\n+    if api_request.response_successful?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c34bf44fe95c5f18c81d19e7db6c9f99930a6c18"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY0Mjk4MQ==", "bodyText": "Prefer single-quoted strings when you don't need string interpolation or special symbols.", "url": "https://github.com/CMSgov/dpc-app/pull/680#discussion_r390642981", "createdAt": "2020-03-10T22:15:15Z", "author": {"login": "codeclimate"}, "path": "dpc-web/app/models/registered_organization.rb", "diffHunk": "@@ -76,10 +76,15 @@ def update_api_endpoint\n   def delete_api_organization\n     api_request = APIClient.new(api_env).delete_organization(self)\n     api_response = api_request.response_body\n-    return if api_request.response_successful?\n \n-    errors.add(:base, \"couldn't be deleted from #{api_env} API: #{api_response}\")\n-    throw(:abort)\n+    if api_request.response_successful?\n+      return\n+    elsif api_response.include? \"Cannot find organization\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c34bf44fe95c5f18c81d19e7db6c9f99930a6c18"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6e19431fbd037f2bd6fc7f1377e7a350df08983", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/a6e19431fbd037f2bd6fc7f1377e7a350df08983", "committedDate": "2020-03-11T13:52:47Z", "message": "climate code reqs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f2ebafd86847304b6d22b62caa58c513604a090", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/2f2ebafd86847304b6d22b62caa58c513604a090", "committedDate": "2020-03-11T23:09:25Z", "message": "Registered organization spec test start"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "614bd4a31e380c1fd10cbe6d833d2ed73cde8f1f", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/614bd4a31e380c1fd10cbe6d833d2ed73cde8f1f", "committedDate": "2020-03-12T14:58:02Z", "message": "Test for deleting an organization missing in API complete\n\nChecked for false positives and can confirm test works."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfdd64633cbf9f1ed8fe78e196190107d2cbcaea", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/dfdd64633cbf9f1ed8fe78e196190107d2cbcaea", "committedDate": "2020-03-12T15:03:42Z", "message": "Merge branch 'master' into nzonnenberg/DPC-1158-delete-org-from-api-bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NjAwNzM1", "url": "https://github.com/CMSgov/dpc-app/pull/680#pullrequestreview-375600735", "createdAt": "2020-03-16T21:39:33Z", "commit": {"oid": "dfdd64633cbf9f1ed8fe78e196190107d2cbcaea"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMTozOTozM1rOF3GpeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMTozOTozM1rOF3GpeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMyNDkyMA==", "bodyText": "In specs, it's conventional to assign variables used across examples with let outside of the before block. Instead of creating an instance variable here, before line 187 add this let block:\nlet(:registered_organization) { create(:registered_organization } \n\nAnd then you'll be able to use registered_organization in the examples instead of @reg_org", "url": "https://github.com/CMSgov/dpc-app/pull/680#discussion_r393324920", "createdAt": "2020-03-16T21:39:33Z", "author": {"login": "switzersc-usds"}, "path": "dpc-web/spec/models/registered_organization_spec.rb", "diffHunk": "@@ -184,18 +184,29 @@\n       end\n \n       context 'failed API request' do\n-        it 'adds to errors and does not destroy object' do\n+        before(:each) do\n           stub_api_client(message: :create_organization, success: true, response: default_org_creation_response)\n-          reg_org = create(:registered_organization)\n+          @reg_org = create(:registered_organization)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfdd64633cbf9f1ed8fe78e196190107d2cbcaea"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NjAxNjE2", "url": "https://github.com/CMSgov/dpc-app/pull/680#pullrequestreview-375601616", "createdAt": "2020-03-16T21:41:22Z", "commit": {"oid": "dfdd64633cbf9f1ed8fe78e196190107d2cbcaea"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMTo0MToyM1rOF3GsOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMTo0MToyM1rOF3GsOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMyNTYyNQ==", "bodyText": "What do you think about logging that the org wasn't found in the API? I'm inclined to suggest it in case we have to trace a transaction later; logging that there was an unexpected consistency in the transaction chain might be helpful.", "url": "https://github.com/CMSgov/dpc-app/pull/680#discussion_r393325625", "createdAt": "2020-03-16T21:41:23Z", "author": {"login": "switzersc-usds"}, "path": "dpc-web/app/models/registered_organization.rb", "diffHunk": "@@ -76,8 +76,11 @@ def update_api_endpoint\n   def delete_api_organization\n     api_request = APIClient.new(api_env).delete_organization(self)\n     api_response = api_request.response_body\n+\n     return if api_request.response_successful?\n \n+    return if api_response.include? 'Cannot find organization'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfdd64633cbf9f1ed8fe78e196190107d2cbcaea"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "174a6f7e72fc14fb7fcc62edde3c95d9463ec23a", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/174a6f7e72fc14fb7fcc62edde3c95d9463ec23a", "committedDate": "2020-03-18T13:42:02Z", "message": "Added rails logger for 'Cannot find organization'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "039eadcfb41870e3b96dcaa5227cb865db4eda86", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/039eadcfb41870e3b96dcaa5227cb865db4eda86", "committedDate": "2020-03-18T13:43:30Z", "message": "Merge branch 'nzonnenberg/DPC-1158-delete-org-from-api-bug' of github.com:CMSgov/dpc-app into nzonnenberg/DPC-1158-delete-org-from-api-bug\n\nFixing out of sync branches."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2OTI5NzE0", "url": "https://github.com/CMSgov/dpc-app/pull/680#pullrequestreview-376929714", "createdAt": "2020-03-18T14:41:20Z", "commit": {"oid": "039eadcfb41870e3b96dcaa5227cb865db4eda86"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf94bd4bc0473125bf1c468b7872017bbd19c15c", "author": {"user": {"login": "Sun-Mountain", "name": "Nicole Zonnenberg"}}, "url": "https://github.com/CMSgov/dpc-app/commit/bf94bd4bc0473125bf1c468b7872017bbd19c15c", "committedDate": "2020-03-18T15:00:29Z", "message": "Merge branch 'master' into nzonnenberg/DPC-1158-delete-org-from-api-bug"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 183, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}