{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwMzM2ODYz", "number": 652, "title": "add ability to configure practitioner limit per environment", "bodyText": "Why\nFor our early pilot partners, we need to have the ability to limit the number of providers they can associate with a given organization. This will need to be configurable on a per-environment level as we only want to put in restrictions in production.\nWhat Changed\nAdded a configuration variable in the aggregation configuration that sets a limit to determine when submitting should create a provider or not\nChoices Made\nJustify changes made and any reasons for why a given path was taken, as opposed to an alternative option.\nTickets closed:\nhttps://jiraent.cms.gov/browse/DPC-1083\nFuture Work\nList any additional tickets that have either been created due to work in this PR, or existing tickets that expand upon the feature or provide additional fixes.\nChecklist\n\n All tests are passing via make ci-app (app change) and make ci-web (website change)\n Swagger documentation has been updated\n FHIR documentation has been updated\n Any required dpc-ops changes have a PR submitted and mentioned in this ticket\n Any manual migration steps are documented, scripts written (where applicable), and tested\n Before merging, any required dpc-ops changes have been approved and merged into master of the dpc-ops repo", "createdAt": "2020-02-26T15:08:49Z", "url": "https://github.com/CMSgov/dpc-app/pull/652", "merged": true, "mergeCommit": {"oid": "b0eebe8bab3743166571e942743b661d3c1c9c4e"}, "closed": true, "closedAt": "2020-03-16T21:57:48Z", "author": {"login": "MrBilnon"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIE4iXgH2gAyMzgwMzM2ODYzOjEwNzMwNmU4YWQxZDRkMzkxM2NjZDljNGRlMmQ1MjcxNTQ5NGYxNDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOU61PgH2gAyMzgwMzM2ODYzOjE5NDdiMGE0MDRmZTA3YjVlZjg5YjUwOTIzZTlhMTZjMTIzYTUxNmM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "107306e8ad1d4d3913ccd9c4de2d52715494f145", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/107306e8ad1d4d3913ccd9c4de2d52715494f145", "committedDate": "2020-02-26T11:18:51Z", "message": "add ability to configure practitioner limit per environment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "245832461f44bb52e5afa0df181d6ed7e229a0fe", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/245832461f44bb52e5afa0df181d6ed7e229a0fe", "committedDate": "2020-02-26T15:05:08Z", "message": "update swagger annotations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "196e392c9de781b1a48dbf2daba0bce45a3a0075", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/196e392c9de781b1a48dbf2daba0bce45a3a0075", "committedDate": "2020-02-26T15:09:56Z", "message": "Merge branch 'master' into willh/DPC-1083-add-practitioner-limit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MDI0MDE5", "url": "https://github.com/CMSgov/dpc-app/pull/652#pullrequestreview-365024019", "createdAt": "2020-02-26T15:59:54Z", "commit": {"oid": "196e392c9de781b1a48dbf2daba0bce45a3a0075"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNTo1OTo1NFrOFuxgpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNzoxMzozM1rOFu0hFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU4OTk4OQ==", "bodyText": "Can we put a javax validation on this property? Add the null check at startup rather than on each resource call?", "url": "https://github.com/CMSgov/dpc-app/pull/652#discussion_r384589989", "createdAt": "2020-02-26T15:59:54Z", "author": {"login": "nickrobison-usds"}, "path": "dpc-attribution/src/main/java/gov/cms/dpc/attribution/DPCAttributionConfiguration.java", "diffHunk": "@@ -43,6 +43,8 @@\n     @JsonProperty(\"swagger\")\n     private SwaggerBundleConfiguration swaggerBundleConfiguration;\n \n+    private Integer providerLimit;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "196e392c9de781b1a48dbf2daba0bce45a3a0075"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDYzODQ4OQ==", "bodyText": "I'm thinking more about the 304 return code, I'm wondering if it would more sense to return a 429 or a 422 error, not sure 304 is very informative. Thoughts @DeirdreHolub @EmBh?", "url": "https://github.com/CMSgov/dpc-app/pull/652#discussion_r384638489", "createdAt": "2020-02-26T17:12:20Z", "author": {"login": "nickrobison-usds"}, "path": "dpc-attribution/src/main/java/gov/cms/dpc/attribution/resources/v1/PractitionerResource.java", "diffHunk": "@@ -70,20 +73,30 @@\n     @ApiOperation(value = \"Register provider\", notes = \"FHIR endpoint to register a provider with the system.\" +\n             \"<p>Each provider must have a metadata Tag with the responsible Organization ID included.\" +\n             \"If not, we'll reject it.\" +\n-            \"<p> If a provider is already registered with the Organization, an errorr is thrown.\")\n+            \"<p> If a provider is already registered with the Organization, an error is thrown.\" +\n+            \"<p> If a provider has already registered providers past the provider limit, then return 304\")\n     @ApiResponses(value = {\n             @ApiResponse(code = 201, message = \"New resource was created\"),\n+            @ApiResponse(code = 304, message = \"Resource was not created\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "196e392c9de781b1a48dbf2daba0bce45a3a0075"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDYzOTAzNg==", "bodyText": "This list could get really large in the future, I wonder if it would make sense to add a new method to the DAO to return a count, rather than all the resources themselves?", "url": "https://github.com/CMSgov/dpc-app/pull/652#discussion_r384639036", "createdAt": "2020-02-26T17:13:12Z", "author": {"login": "nickrobison-usds"}, "path": "dpc-attribution/src/main/java/gov/cms/dpc/attribution/resources/v1/PractitionerResource.java", "diffHunk": "@@ -70,20 +73,30 @@\n     @ApiOperation(value = \"Register provider\", notes = \"FHIR endpoint to register a provider with the system.\" +\n             \"<p>Each provider must have a metadata Tag with the responsible Organization ID included.\" +\n             \"If not, we'll reject it.\" +\n-            \"<p> If a provider is already registered with the Organization, an errorr is thrown.\")\n+            \"<p> If a provider is already registered with the Organization, an error is thrown.\" +\n+            \"<p> If a provider has already registered providers past the provider limit, then return 304\")\n     @ApiResponses(value = {\n             @ApiResponse(code = 201, message = \"New resource was created\"),\n+            @ApiResponse(code = 304, message = \"Resource was not created\")\n     })\n     public Response submitProvider(Practitioner provider) {\n \n         final ProviderEntity entity = this.converter.fromFHIR(ProviderEntity.class, provider);\n-        final List<ProviderEntity> existingProviders = this.dao.getProviders(null, entity.getProviderNPI(), entity.getOrganization().getId());\n-        if (existingProviders.isEmpty()) {\n+        final List<ProviderEntity> existingProvidersByOrganization = this.dao.getProviders(null, null, entity.getOrganization().getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "196e392c9de781b1a48dbf2daba0bce45a3a0075"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDYzOTI1NQ==", "bodyText": "If we add the NonNull annotation to the config object, we can avoid the null check here.", "url": "https://github.com/CMSgov/dpc-app/pull/652#discussion_r384639255", "createdAt": "2020-02-26T17:13:33Z", "author": {"login": "nickrobison-usds"}, "path": "dpc-attribution/src/main/java/gov/cms/dpc/attribution/resources/v1/PractitionerResource.java", "diffHunk": "@@ -70,20 +73,30 @@\n     @ApiOperation(value = \"Register provider\", notes = \"FHIR endpoint to register a provider with the system.\" +\n             \"<p>Each provider must have a metadata Tag with the responsible Organization ID included.\" +\n             \"If not, we'll reject it.\" +\n-            \"<p> If a provider is already registered with the Organization, an errorr is thrown.\")\n+            \"<p> If a provider is already registered with the Organization, an error is thrown.\" +\n+            \"<p> If a provider has already registered providers past the provider limit, then return 304\")\n     @ApiResponses(value = {\n             @ApiResponse(code = 201, message = \"New resource was created\"),\n+            @ApiResponse(code = 304, message = \"Resource was not created\")\n     })\n     public Response submitProvider(Practitioner provider) {\n \n         final ProviderEntity entity = this.converter.fromFHIR(ProviderEntity.class, provider);\n-        final List<ProviderEntity> existingProviders = this.dao.getProviders(null, entity.getProviderNPI(), entity.getOrganization().getId());\n-        if (existingProviders.isEmpty()) {\n+        final List<ProviderEntity> existingProvidersByOrganization = this.dao.getProviders(null, null, entity.getOrganization().getId());\n+        final List<ProviderEntity> existingProvidersByNPI = existingProvidersByOrganization.stream()\n+                .filter(providerEntity -> providerEntity.getProviderNPI().equals(entity.getProviderNPI()))\n+                .collect(Collectors.toList());\n+\n+        if (providerLimit != null && existingProvidersByOrganization.size() >= providerLimit) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "196e392c9de781b1a48dbf2daba0bce45a3a0075"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6427be44304cfebd1b186a7ffbd2655cb630106", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/d6427be44304cfebd1b186a7ffbd2655cb630106", "committedDate": "2020-02-26T19:43:43Z", "message": "add a count method to dao and use it for determining provider limit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f64bf11de9b335c774146a8227722cc241646434", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/f64bf11de9b335c774146a8227722cc241646434", "committedDate": "2020-02-28T16:48:46Z", "message": "Merge remote-tracking branch 'origin/willh/DPC-1083-add-practitioner-limit' into willh/DPC-1083-add-practitioner-limit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NTQ4NzUz", "url": "https://github.com/CMSgov/dpc-app/pull/652#pullrequestreview-366548753", "createdAt": "2020-02-28T17:03:08Z", "commit": {"oid": "f64bf11de9b335c774146a8227722cc241646434"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNzowMzowOVrOFv8Gyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNzowMzowOVrOFv8Gyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgxMjE3MQ==", "bodyText": "Ok, I think 422 would work. Thoughts, @EmBh @DeirdreHolub", "url": "https://github.com/CMSgov/dpc-app/pull/652#discussion_r385812171", "createdAt": "2020-02-28T17:03:09Z", "author": {"login": "nickrobison-usds"}, "path": "dpc-attribution/src/main/java/gov/cms/dpc/attribution/resources/v1/PractitionerResource.java", "diffHunk": "@@ -70,20 +73,30 @@\n     @ApiOperation(value = \"Register provider\", notes = \"FHIR endpoint to register a provider with the system.\" +\n             \"<p>Each provider must have a metadata Tag with the responsible Organization ID included.\" +\n             \"If not, we'll reject it.\" +\n-            \"<p> If a provider is already registered with the Organization, an errorr is thrown.\")\n+            \"<p> If a provider is already registered with the Organization, an error is thrown.\" +\n+            \"<p> If a provider has already registered providers past the provider limit, then return 304\")\n     @ApiResponses(value = {\n             @ApiResponse(code = 201, message = \"New resource was created\"),\n+            @ApiResponse(code = 304, message = \"Resource was not created\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDYzODQ4OQ=="}, "originalCommit": {"oid": "196e392c9de781b1a48dbf2daba0bce45a3a0075"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "815868b5ac5eab2cfb4691d71ef1bc0cb1641a16", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/815868b5ac5eab2cfb4691d71ef1bc0cb1641a16", "committedDate": "2020-02-28T19:38:21Z", "message": "change status code when provider limit is reached"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd9bb9a90de953693fa56e4ffd9c5905b326c4a4", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/fd9bb9a90de953693fa56e4ffd9c5905b326c4a4", "committedDate": "2020-02-28T19:57:58Z", "message": "Merge branch 'master' into willh/DPC-1083-add-practitioner-limit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9dc97c4c94d0f66aaf8080dcdcc2438e7d31bd54", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/9dc97c4c94d0f66aaf8080dcdcc2438e7d31bd54", "committedDate": "2020-03-02T15:08:56Z", "message": "Update PractitionerResource.java\n\nchange swagger doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc4142fb022d4ae53dd43e5bd1778888cd6a6812", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/bc4142fb022d4ae53dd43e5bd1778888cd6a6812", "committedDate": "2020-03-03T15:19:42Z", "message": "Merge branch 'master' into willh/DPC-1083-add-practitioner-limit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4ODE1NDE0", "url": "https://github.com/CMSgov/dpc-app/pull/652#pullrequestreview-368815414", "createdAt": "2020-03-04T14:20:39Z", "commit": {"oid": "bc4142fb022d4ae53dd43e5bd1778888cd6a6812"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e98811935087e1e870e48496b915782885d96121", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/e98811935087e1e870e48496b915782885d96121", "committedDate": "2020-03-05T17:17:41Z", "message": "Merge branch 'master' into willh/DPC-1083-add-practitioner-limit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5ODcwMTM5", "url": "https://github.com/CMSgov/dpc-app/pull/652#pullrequestreview-369870139", "createdAt": "2020-03-05T19:56:27Z", "commit": {"oid": "e98811935087e1e870e48496b915782885d96121"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxOTo1NjoyN1rOFyh6pg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxOTo1NjoyN1rOFyh6pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUyODgwNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        \"<p> If a provider has already registered providers past the provider limit, then an error is thrown\")\n          \n          \n            \n                        \"<p> If an organization has already reached the provider limit, then an error is thrown\")\n          \n      \n    \n    \n  \n\nThis might be a little clearer, since the number should never exceed the limit.", "url": "https://github.com/CMSgov/dpc-app/pull/652#discussion_r388528806", "createdAt": "2020-03-05T19:56:27Z", "author": {"login": "em1"}, "path": "dpc-attribution/src/main/java/gov/cms/dpc/attribution/resources/v1/PractitionerResource.java", "diffHunk": "@@ -70,20 +73,28 @@\n     @ApiOperation(value = \"Register provider\", notes = \"FHIR endpoint to register a provider with the system.\" +\n             \"<p>Each provider must have a metadata Tag with the responsible Organization ID included.\" +\n             \"If not, we'll reject it.\" +\n-            \"<p> If a provider is already registered with the Organization, an errorr is thrown.\")\n+            \"<p> If a provider is already registered with the Organization, an error is thrown.\" +\n+            \"<p> If a provider has already registered providers past the provider limit, then an error is thrown\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e98811935087e1e870e48496b915782885d96121"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba6a341725ae6ef38e0f9c930fc79ce6b7bfafea", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/ba6a341725ae6ef38e0f9c930fc79ce6b7bfafea", "committedDate": "2020-03-06T15:10:25Z", "message": "Update dpc-attribution/src/main/java/gov/cms/dpc/attribution/resources/v1/PractitionerResource.java\n\nCo-Authored-By: Emily Hart <1923441+embh@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59a3e914fd8a4eb088ce1f4cec49dd97fa3e4262", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/59a3e914fd8a4eb088ce1f4cec49dd97fa3e4262", "committedDate": "2020-03-06T15:10:57Z", "message": "Merge branch 'master' into willh/DPC-1083-add-practitioner-limit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NTQxNTIw", "url": "https://github.com/CMSgov/dpc-app/pull/652#pullrequestreview-375541520", "createdAt": "2020-03-16T19:57:53Z", "commit": {"oid": "59a3e914fd8a4eb088ce1f4cec49dd97fa3e4262"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1947b0a404fe07b5ef89b50923e9a16c123a516c", "author": {"user": {"login": "MrBilnon", "name": "Will H"}}, "url": "https://github.com/CMSgov/dpc-app/commit/1947b0a404fe07b5ef89b50923e9a16c123a516c", "committedDate": "2020-03-16T21:23:23Z", "message": "Merge branch 'master' into willh/DPC-1083-add-practitioner-limit"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 159, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}