{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI3NTc1ODc3", "number": 5562, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxNDoyMjo0NlrOE-A3tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxNDoyMjo0NlrOE-A3tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzNDYxNDMxOnYy", "diffSide": "RIGHT", "path": "main/plugins/org.talend.repository/src/main/java/org/talend/repository/model/migration/spark/SetDatasetCheckBoxGlobalOption.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxNDoyMjo0NlrOH7AGyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxNDozOTowN1rOH7Amnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTYyOTc2OA==", "bodyText": "Can't we have something like talendStudioVersion.compareTo(\"7.3.1\") < 0 so that this is compatible with future versions also ?", "url": "https://github.com/Talend/tdi-studio-se/pull/5562#discussion_r531629768", "createdAt": "2020-11-27T14:22:46Z", "author": {"login": "lbourgeois"}, "path": "main/plugins/org.talend.repository/src/main/java/org/talend/repository/model/migration/spark/SetDatasetCheckBoxGlobalOption.java", "diffHunk": "@@ -0,0 +1,90 @@\n+// ============================================================================\n+//\n+// Copyright (C) 2006-2019 Talend Inc. - www.talend.com\n+//\n+// This source code is available under agreement available at\n+// %InstallDIR%\\features\\org.talend.rcp.branding.%PRODUCTNAME%\\%PRODUCTNAME%license.txt\n+//\n+// You should have received a copy of the agreement\n+// along with this program; if not, write to Talend SA\n+// 9 rue Pages 92150 Suresnes, France\n+//\n+// ============================================================================\n+package org.talend.repository.model.migration.spark;\n+\n+import java.util.Arrays;\n+import java.util.Date;\n+import java.util.GregorianCalendar;\n+import java.util.List;\n+\n+import org.talend.commons.exception.ExceptionHandler;\n+import org.talend.commons.exception.PersistenceException;\n+import org.talend.core.model.migration.AbstractJobMigrationTask;\n+import org.talend.core.model.properties.Item;\n+import org.talend.core.model.properties.impl.AdditionalInfoMapImpl;\n+import org.talend.core.model.repository.ERepositoryObjectType;\n+import org.talend.core.repository.model.ProxyRepositoryFactory;\n+import org.talend.designer.core.model.utils.emf.talendfile.ElementParameterType;\n+import org.talend.designer.core.model.utils.emf.talendfile.ProcessType;\n+import org.talend.designer.core.model.utils.emf.talendfile.TalendFileFactory;\n+import org.talend.designer.core.model.utils.emf.talendfile.impl.ElementParameterTypeImpl;\n+\n+/**\n+ *\n+ * @author ametivier\n+ *\n+ * to keep retro compatibility with some components that used specific RDD implementation that don't behave the same with\n+ * dataset API in spark, migrated job from previous versions will by default use RDD implementation instead of dataset\n+ * according to spark version value.\n+ *\n+ */\n+public class SetDatasetCheckBoxGlobalOption extends AbstractJobMigrationTask {\n+    \n+    private String CHECKBOX_DATASET = \"USE_DATASET_API\"; //$NON-NLS-1$\n+    \n+    @Override\n+    public Date getOrder() {\n+        GregorianCalendar gc = new GregorianCalendar(2020, 11, 25, 10, 0, 0);\n+        return gc.getTime();\n+    }\n+    \n+    @Override\n+    public List<ERepositoryObjectType> getTypes() {\n+        return Arrays.asList(ERepositoryObjectType.PROCESS_MR);\n+    }\n+\n+    @Override\n+    public ExecutionResult execute(Item item) {\n+        ProcessType processType = getProcessType(item);\n+        if (processType == null) {\n+            return ExecutionResult.NOTHING_TO_DO;\n+        }\n+        List<AdditionalInfoMapImpl> properties = item.getProperty().getAdditionalProperties();\n+        String talendVersionUsedToCreateJob = null;\n+        for (AdditionalInfoMapImpl property : properties) {\n+        \tif (\"created_product_version\".equals(property.getKey().toString())) {\n+        \t\ttalendVersionUsedToCreateJob = property.getValue().toString();\n+        \t}\n+        }\n+        try {\n+    \t\tsetGlobalOption(processType, item, talendVersionUsedToCreateJob);\n+            return ExecutionResult.SUCCESS_NO_ALERT;\n+        } catch (Exception e) {\n+            ExceptionHandler.process(e);\n+            return ExecutionResult.FAILURE;\n+        }\n+    }\n+    \n+    private void setGlobalOption(ProcessType processType, Item item, String talendStudioVersion) throws PersistenceException {\n+    \tElementParameterType property = TalendFileFactory.eINSTANCE.createElementParameterType();\n+        property.setName(CHECKBOX_DATASET); //$NON-NLS-1$\n+        property.setField(\"CHECK\"); //$NON-NLS-1$\n+        property.setValue(\"false\"); //$NON-NLS-1$\n+        boolean isParameterAlreadyAdded = processType.getParameters().getElementParameter().stream().anyMatch(x -> \"USE_DATASET_API\".equals(((ElementParameterTypeImpl) x).getName()));\n+        if (!isParameterAlreadyAdded && !talendStudioVersion.startsWith(\"7.3.1\") && !talendStudioVersion.startsWith(\"7.4.1\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b6aaf944fa819f0a7a68d5aed941f06547a94d5"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTYzNzg0Ng==", "bodyText": "I actually was wondering if someone would say that, I don't think that condition will either be true for 7.5.1 for example, but I'm ready to take the bet with you :D", "url": "https://github.com/Talend/tdi-studio-se/pull/5562#discussion_r531637846", "createdAt": "2020-11-27T14:38:57Z", "author": {"login": "AlixMetivier"}, "path": "main/plugins/org.talend.repository/src/main/java/org/talend/repository/model/migration/spark/SetDatasetCheckBoxGlobalOption.java", "diffHunk": "@@ -0,0 +1,90 @@\n+// ============================================================================\n+//\n+// Copyright (C) 2006-2019 Talend Inc. - www.talend.com\n+//\n+// This source code is available under agreement available at\n+// %InstallDIR%\\features\\org.talend.rcp.branding.%PRODUCTNAME%\\%PRODUCTNAME%license.txt\n+//\n+// You should have received a copy of the agreement\n+// along with this program; if not, write to Talend SA\n+// 9 rue Pages 92150 Suresnes, France\n+//\n+// ============================================================================\n+package org.talend.repository.model.migration.spark;\n+\n+import java.util.Arrays;\n+import java.util.Date;\n+import java.util.GregorianCalendar;\n+import java.util.List;\n+\n+import org.talend.commons.exception.ExceptionHandler;\n+import org.talend.commons.exception.PersistenceException;\n+import org.talend.core.model.migration.AbstractJobMigrationTask;\n+import org.talend.core.model.properties.Item;\n+import org.talend.core.model.properties.impl.AdditionalInfoMapImpl;\n+import org.talend.core.model.repository.ERepositoryObjectType;\n+import org.talend.core.repository.model.ProxyRepositoryFactory;\n+import org.talend.designer.core.model.utils.emf.talendfile.ElementParameterType;\n+import org.talend.designer.core.model.utils.emf.talendfile.ProcessType;\n+import org.talend.designer.core.model.utils.emf.talendfile.TalendFileFactory;\n+import org.talend.designer.core.model.utils.emf.talendfile.impl.ElementParameterTypeImpl;\n+\n+/**\n+ *\n+ * @author ametivier\n+ *\n+ * to keep retro compatibility with some components that used specific RDD implementation that don't behave the same with\n+ * dataset API in spark, migrated job from previous versions will by default use RDD implementation instead of dataset\n+ * according to spark version value.\n+ *\n+ */\n+public class SetDatasetCheckBoxGlobalOption extends AbstractJobMigrationTask {\n+    \n+    private String CHECKBOX_DATASET = \"USE_DATASET_API\"; //$NON-NLS-1$\n+    \n+    @Override\n+    public Date getOrder() {\n+        GregorianCalendar gc = new GregorianCalendar(2020, 11, 25, 10, 0, 0);\n+        return gc.getTime();\n+    }\n+    \n+    @Override\n+    public List<ERepositoryObjectType> getTypes() {\n+        return Arrays.asList(ERepositoryObjectType.PROCESS_MR);\n+    }\n+\n+    @Override\n+    public ExecutionResult execute(Item item) {\n+        ProcessType processType = getProcessType(item);\n+        if (processType == null) {\n+            return ExecutionResult.NOTHING_TO_DO;\n+        }\n+        List<AdditionalInfoMapImpl> properties = item.getProperty().getAdditionalProperties();\n+        String talendVersionUsedToCreateJob = null;\n+        for (AdditionalInfoMapImpl property : properties) {\n+        \tif (\"created_product_version\".equals(property.getKey().toString())) {\n+        \t\ttalendVersionUsedToCreateJob = property.getValue().toString();\n+        \t}\n+        }\n+        try {\n+    \t\tsetGlobalOption(processType, item, talendVersionUsedToCreateJob);\n+            return ExecutionResult.SUCCESS_NO_ALERT;\n+        } catch (Exception e) {\n+            ExceptionHandler.process(e);\n+            return ExecutionResult.FAILURE;\n+        }\n+    }\n+    \n+    private void setGlobalOption(ProcessType processType, Item item, String talendStudioVersion) throws PersistenceException {\n+    \tElementParameterType property = TalendFileFactory.eINSTANCE.createElementParameterType();\n+        property.setName(CHECKBOX_DATASET); //$NON-NLS-1$\n+        property.setField(\"CHECK\"); //$NON-NLS-1$\n+        property.setValue(\"false\"); //$NON-NLS-1$\n+        boolean isParameterAlreadyAdded = processType.getParameters().getElementParameter().stream().anyMatch(x -> \"USE_DATASET_API\".equals(((ElementParameterTypeImpl) x).getName()));\n+        if (!isParameterAlreadyAdded && !talendStudioVersion.startsWith(\"7.3.1\") && !talendStudioVersion.startsWith(\"7.4.1\")) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTYyOTc2OA=="}, "originalCommit": {"oid": "9b6aaf944fa819f0a7a68d5aed941f06547a94d5"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTYzNzkxOQ==", "bodyText": "(ill change it, that said ;))", "url": "https://github.com/Talend/tdi-studio-se/pull/5562#discussion_r531637919", "createdAt": "2020-11-27T14:39:07Z", "author": {"login": "AlixMetivier"}, "path": "main/plugins/org.talend.repository/src/main/java/org/talend/repository/model/migration/spark/SetDatasetCheckBoxGlobalOption.java", "diffHunk": "@@ -0,0 +1,90 @@\n+// ============================================================================\n+//\n+// Copyright (C) 2006-2019 Talend Inc. - www.talend.com\n+//\n+// This source code is available under agreement available at\n+// %InstallDIR%\\features\\org.talend.rcp.branding.%PRODUCTNAME%\\%PRODUCTNAME%license.txt\n+//\n+// You should have received a copy of the agreement\n+// along with this program; if not, write to Talend SA\n+// 9 rue Pages 92150 Suresnes, France\n+//\n+// ============================================================================\n+package org.talend.repository.model.migration.spark;\n+\n+import java.util.Arrays;\n+import java.util.Date;\n+import java.util.GregorianCalendar;\n+import java.util.List;\n+\n+import org.talend.commons.exception.ExceptionHandler;\n+import org.talend.commons.exception.PersistenceException;\n+import org.talend.core.model.migration.AbstractJobMigrationTask;\n+import org.talend.core.model.properties.Item;\n+import org.talend.core.model.properties.impl.AdditionalInfoMapImpl;\n+import org.talend.core.model.repository.ERepositoryObjectType;\n+import org.talend.core.repository.model.ProxyRepositoryFactory;\n+import org.talend.designer.core.model.utils.emf.talendfile.ElementParameterType;\n+import org.talend.designer.core.model.utils.emf.talendfile.ProcessType;\n+import org.talend.designer.core.model.utils.emf.talendfile.TalendFileFactory;\n+import org.talend.designer.core.model.utils.emf.talendfile.impl.ElementParameterTypeImpl;\n+\n+/**\n+ *\n+ * @author ametivier\n+ *\n+ * to keep retro compatibility with some components that used specific RDD implementation that don't behave the same with\n+ * dataset API in spark, migrated job from previous versions will by default use RDD implementation instead of dataset\n+ * according to spark version value.\n+ *\n+ */\n+public class SetDatasetCheckBoxGlobalOption extends AbstractJobMigrationTask {\n+    \n+    private String CHECKBOX_DATASET = \"USE_DATASET_API\"; //$NON-NLS-1$\n+    \n+    @Override\n+    public Date getOrder() {\n+        GregorianCalendar gc = new GregorianCalendar(2020, 11, 25, 10, 0, 0);\n+        return gc.getTime();\n+    }\n+    \n+    @Override\n+    public List<ERepositoryObjectType> getTypes() {\n+        return Arrays.asList(ERepositoryObjectType.PROCESS_MR);\n+    }\n+\n+    @Override\n+    public ExecutionResult execute(Item item) {\n+        ProcessType processType = getProcessType(item);\n+        if (processType == null) {\n+            return ExecutionResult.NOTHING_TO_DO;\n+        }\n+        List<AdditionalInfoMapImpl> properties = item.getProperty().getAdditionalProperties();\n+        String talendVersionUsedToCreateJob = null;\n+        for (AdditionalInfoMapImpl property : properties) {\n+        \tif (\"created_product_version\".equals(property.getKey().toString())) {\n+        \t\ttalendVersionUsedToCreateJob = property.getValue().toString();\n+        \t}\n+        }\n+        try {\n+    \t\tsetGlobalOption(processType, item, talendVersionUsedToCreateJob);\n+            return ExecutionResult.SUCCESS_NO_ALERT;\n+        } catch (Exception e) {\n+            ExceptionHandler.process(e);\n+            return ExecutionResult.FAILURE;\n+        }\n+    }\n+    \n+    private void setGlobalOption(ProcessType processType, Item item, String talendStudioVersion) throws PersistenceException {\n+    \tElementParameterType property = TalendFileFactory.eINSTANCE.createElementParameterType();\n+        property.setName(CHECKBOX_DATASET); //$NON-NLS-1$\n+        property.setField(\"CHECK\"); //$NON-NLS-1$\n+        property.setValue(\"false\"); //$NON-NLS-1$\n+        boolean isParameterAlreadyAdded = processType.getParameters().getElementParameter().stream().anyMatch(x -> \"USE_DATASET_API\".equals(((ElementParameterTypeImpl) x).getName()));\n+        if (!isParameterAlreadyAdded && !talendStudioVersion.startsWith(\"7.3.1\") && !talendStudioVersion.startsWith(\"7.4.1\")) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTYyOTc2OA=="}, "originalCommit": {"oid": "9b6aaf944fa819f0a7a68d5aed941f06547a94d5"}, "originalPosition": 84}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4622, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}