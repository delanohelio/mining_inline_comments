{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI3NTc1ODc3", "number": 5562, "title": "fix(TBD-11616): parameterize dataset API utilization", "bodyText": "What is the current behavior? (You can also link to an open issue here)\nWhat is the new behavior?\nPlease check if the PR fulfills these requirements\n\n The commit message follows Talend standard\n Tests for the changes have been added (for bug fixes / features)\n Docs have been added / updated (for bug fixes / features) ?\n The code coverage on new code >75%\n The new code does not introduce new technical issues (sonar / eslint)\n\nWhat kind of change does this PR introduce?\n\n Bugfix\n Feature\n Code style update (formatting, local variables)\n Refactoring (no functional changes, no api changes)\n Build / CI related changes\n Other... Please describe:\n\nDoes this PR introduce a breaking change?\n\n Yes\n No\n\nIf this PR contains a breaking change, please describe the impact and migration path for existing applications: ...\nOther information:", "createdAt": "2020-11-25T16:48:57Z", "url": "https://github.com/Talend/tdi-studio-se/pull/5562", "merged": true, "mergeCommit": {"oid": "e96d2af073ca51cee5981f185f1f87b826f9e65c"}, "closed": true, "closedAt": "2020-12-10T08:57:35Z", "author": {"login": "AlixMetivier"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgBI3YAH2gAyNTI3NTc1ODc3OjNmYjMwMDNhNDZlNjcxMzc5ZWU2ZDUyYzBiZjNhNDJkMGRjYjBkMWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkutNDgH2gAyNTI3NTc1ODc3Ojk5ZTkyODNmN2M1ZTAyMzcxZmExNDA5YWZmOGNlMjQzNWM4OTUxMTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3fb3003a46e671379ee6d52c0bf3a42d0dcb0d1c", "author": {"user": {"login": "AlixMetivier", "name": null}}, "url": "https://github.com/Talend/tdi-studio-se/commit/3fb3003a46e671379ee6d52c0bf3a42d0dcb0d1c", "committedDate": "2020-11-25T16:42:24Z", "message": "fix(TBD-11616): parameterize dataset API utilization"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NzE4MjQ5", "url": "https://github.com/Talend/tdi-studio-se/pull/5562#pullrequestreview-538718249", "createdAt": "2020-11-25T17:29:52Z", "commit": {"oid": "3fb3003a46e671379ee6d52c0bf3a42d0dcb0d1c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b6aaf944fa819f0a7a68d5aed941f06547a94d5", "author": {"user": {"login": "AlixMetivier", "name": null}}, "url": "https://github.com/Talend/tdi-studio-se/commit/9b6aaf944fa819f0a7a68d5aed941f06547a94d5", "committedDate": "2020-11-26T14:38:02Z", "message": "apply migration to only 7.3 and 7.4 studios"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwMDE1MjM5", "url": "https://github.com/Talend/tdi-studio-se/pull/5562#pullrequestreview-540015239", "createdAt": "2020-11-27T14:22:46Z", "commit": {"oid": "9b6aaf944fa819f0a7a68d5aed941f06547a94d5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxNDoyMjo0NlrOH7AGyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxNDoyMjo0NlrOH7AGyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTYyOTc2OA==", "bodyText": "Can't we have something like talendStudioVersion.compareTo(\"7.3.1\") < 0 so that this is compatible with future versions also ?", "url": "https://github.com/Talend/tdi-studio-se/pull/5562#discussion_r531629768", "createdAt": "2020-11-27T14:22:46Z", "author": {"login": "lbourgeois"}, "path": "main/plugins/org.talend.repository/src/main/java/org/talend/repository/model/migration/spark/SetDatasetCheckBoxGlobalOption.java", "diffHunk": "@@ -0,0 +1,90 @@\n+// ============================================================================\n+//\n+// Copyright (C) 2006-2019 Talend Inc. - www.talend.com\n+//\n+// This source code is available under agreement available at\n+// %InstallDIR%\\features\\org.talend.rcp.branding.%PRODUCTNAME%\\%PRODUCTNAME%license.txt\n+//\n+// You should have received a copy of the agreement\n+// along with this program; if not, write to Talend SA\n+// 9 rue Pages 92150 Suresnes, France\n+//\n+// ============================================================================\n+package org.talend.repository.model.migration.spark;\n+\n+import java.util.Arrays;\n+import java.util.Date;\n+import java.util.GregorianCalendar;\n+import java.util.List;\n+\n+import org.talend.commons.exception.ExceptionHandler;\n+import org.talend.commons.exception.PersistenceException;\n+import org.talend.core.model.migration.AbstractJobMigrationTask;\n+import org.talend.core.model.properties.Item;\n+import org.talend.core.model.properties.impl.AdditionalInfoMapImpl;\n+import org.talend.core.model.repository.ERepositoryObjectType;\n+import org.talend.core.repository.model.ProxyRepositoryFactory;\n+import org.talend.designer.core.model.utils.emf.talendfile.ElementParameterType;\n+import org.talend.designer.core.model.utils.emf.talendfile.ProcessType;\n+import org.talend.designer.core.model.utils.emf.talendfile.TalendFileFactory;\n+import org.talend.designer.core.model.utils.emf.talendfile.impl.ElementParameterTypeImpl;\n+\n+/**\n+ *\n+ * @author ametivier\n+ *\n+ * to keep retro compatibility with some components that used specific RDD implementation that don't behave the same with\n+ * dataset API in spark, migrated job from previous versions will by default use RDD implementation instead of dataset\n+ * according to spark version value.\n+ *\n+ */\n+public class SetDatasetCheckBoxGlobalOption extends AbstractJobMigrationTask {\n+    \n+    private String CHECKBOX_DATASET = \"USE_DATASET_API\"; //$NON-NLS-1$\n+    \n+    @Override\n+    public Date getOrder() {\n+        GregorianCalendar gc = new GregorianCalendar(2020, 11, 25, 10, 0, 0);\n+        return gc.getTime();\n+    }\n+    \n+    @Override\n+    public List<ERepositoryObjectType> getTypes() {\n+        return Arrays.asList(ERepositoryObjectType.PROCESS_MR);\n+    }\n+\n+    @Override\n+    public ExecutionResult execute(Item item) {\n+        ProcessType processType = getProcessType(item);\n+        if (processType == null) {\n+            return ExecutionResult.NOTHING_TO_DO;\n+        }\n+        List<AdditionalInfoMapImpl> properties = item.getProperty().getAdditionalProperties();\n+        String talendVersionUsedToCreateJob = null;\n+        for (AdditionalInfoMapImpl property : properties) {\n+        \tif (\"created_product_version\".equals(property.getKey().toString())) {\n+        \t\ttalendVersionUsedToCreateJob = property.getValue().toString();\n+        \t}\n+        }\n+        try {\n+    \t\tsetGlobalOption(processType, item, talendVersionUsedToCreateJob);\n+            return ExecutionResult.SUCCESS_NO_ALERT;\n+        } catch (Exception e) {\n+            ExceptionHandler.process(e);\n+            return ExecutionResult.FAILURE;\n+        }\n+    }\n+    \n+    private void setGlobalOption(ProcessType processType, Item item, String talendStudioVersion) throws PersistenceException {\n+    \tElementParameterType property = TalendFileFactory.eINSTANCE.createElementParameterType();\n+        property.setName(CHECKBOX_DATASET); //$NON-NLS-1$\n+        property.setField(\"CHECK\"); //$NON-NLS-1$\n+        property.setValue(\"false\"); //$NON-NLS-1$\n+        boolean isParameterAlreadyAdded = processType.getParameters().getElementParameter().stream().anyMatch(x -> \"USE_DATASET_API\".equals(((ElementParameterTypeImpl) x).getName()));\n+        if (!isParameterAlreadyAdded && !talendStudioVersion.startsWith(\"7.3.1\") && !talendStudioVersion.startsWith(\"7.4.1\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b6aaf944fa819f0a7a68d5aed941f06547a94d5"}, "originalPosition": 84}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "031fa0f5b3de20085187ef8acb15f0c863b0df86", "author": {"user": {"login": "AlixMetivier", "name": null}}, "url": "https://github.com/Talend/tdi-studio-se/commit/031fa0f5b3de20085187ef8acb15f0c863b0df86", "committedDate": "2020-11-27T14:39:42Z", "message": "Merge branch 'maintenance/7.3' into fix/TBD-11616"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45b40856928dcf629891a7720f96ce43b84b0fb4", "author": {"user": {"login": "AlixMetivier", "name": null}}, "url": "https://github.com/Talend/tdi-studio-se/commit/45b40856928dcf629891a7720f96ce43b84b0fb4", "committedDate": "2020-11-27T14:41:43Z", "message": "fix for future studio versions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwMDYzNjEz", "url": "https://github.com/Talend/tdi-studio-se/pull/5562#pullrequestreview-540063613", "createdAt": "2020-11-27T15:39:54Z", "commit": {"oid": "45b40856928dcf629891a7720f96ce43b84b0fb4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10e329d45655c144b3f65da60a660a9084ab2df5", "author": {"user": {"login": "AlixMetivier", "name": null}}, "url": "https://github.com/Talend/tdi-studio-se/commit/10e329d45655c144b3f65da60a660a9084ab2df5", "committedDate": "2020-12-02T09:25:26Z", "message": "Merge branch 'maintenance/7.3' of https://github.com/Talend/tdi-studio-se into fix/TBD-11616"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "650d46dc9197880fd7d563a2454774b0071ebbab", "author": {"user": {"login": "AlixMetivier", "name": null}}, "url": "https://github.com/Talend/tdi-studio-se/commit/650d46dc9197880fd7d563a2454774b0071ebbab", "committedDate": "2020-12-02T11:32:33Z", "message": "fix bad merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bcb6b0e88a03299dfb66d116d3f731dc56e17756", "author": {"user": {"login": "AlixMetivier", "name": null}}, "url": "https://github.com/Talend/tdi-studio-se/commit/bcb6b0e88a03299dfb66d116d3f731dc56e17756", "committedDate": "2020-12-07T09:39:15Z", "message": "Merge branch 'maintenance/7.3' of https://github.com/Talend/tdi-studio-se into fix/TBD-11616"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99e9283f7c5e02371fa1409aff8ce2435c895113", "author": {"user": {"login": "AlixMetivier", "name": null}}, "url": "https://github.com/Talend/tdi-studio-se/commit/99e9283f7c5e02371fa1409aff8ce2435c895113", "committedDate": "2020-12-10T08:03:31Z", "message": "Merge branch 'maintenance/7.3' of https://github.com/Talend/tdi-studio-se into fix/TBD-11616"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4707, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}