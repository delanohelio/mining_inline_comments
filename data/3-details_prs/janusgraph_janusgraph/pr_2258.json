{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4Mjc5NTQw", "number": 2258, "title": "Fixes #2255: leaked transactions in ConsistentKeyLocker", "bodyText": "#2225: Fixed transaction leaks in ConsistentKeyLocker. Updated unit tests to detect leaked transaction.\n(cherry picked from commit 1271847)\n(cherry picked from commit 3e16a8f)", "createdAt": "2020-11-26T22:01:54Z", "url": "https://github.com/JanusGraph/janusgraph/pull/2258", "merged": true, "mergeCommit": {"oid": "6a483bf87024fe87f1ba3fac4216fba8f21fbf9e"}, "closed": true, "closedAt": "2020-12-03T21:37:12Z", "author": {"login": "mneethiraj"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgl5V-AFqTUzOTkxMDI4Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiYu8-AFqTU0MzM2ODM2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5OTEwMjgz", "url": "https://github.com/JanusGraph/janusgraph/pull/2258#pullrequestreview-539910283", "createdAt": "2020-11-27T11:31:57Z", "commit": {"oid": "7978b1268356b333d380dc6ba5c226e6557d712b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMDA5MTk5", "url": "https://github.com/JanusGraph/janusgraph/pull/2258#pullrequestreview-543009199", "createdAt": "2020-12-02T16:22:56Z", "commit": {"oid": "7978b1268356b333d380dc6ba5c226e6557d712b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxNjoyMjo1N1rOH9jJDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxNjo0Njo1OVrOH9kSJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDMwMDk0MA==", "bodyText": "Why do we adding new Throwable() to the log? I guess, it isn't useful because it doesn't have any information. Instead, I would log toString() of the transaction, which may have more useful information. I.e. something like:\nif (log.isDebugEnabled()) {\n    log.debug(\"Transaction is still open. Rolling back the transaction: \"+tx.toString());\n}", "url": "https://github.com/JanusGraph/janusgraph/pull/2258#discussion_r534300940", "createdAt": "2020-12-02T16:22:57Z", "author": {"login": "porunov"}, "path": "janusgraph-core/src/main/java/org/janusgraph/diskstorage/locking/consistentkey/ConsistentKeyLocker.java", "diffHunk": "@@ -382,13 +382,30 @@ private WriteResult tryWriteLockOnce(StaticBuffer key, StaticBuffer del, StoreTr\n         final Timer writeTimer = times.getTimer().start();\n         StaticBuffer newLockCol = serializer.toLockCol(writeTimer.getStartTime(), rid, times);\n         Entry newLockEntry = StaticArrayEntry.of(newLockCol, zeroBuf);\n+        StoreTransaction newTx = null;\n         try {\n-            final StoreTransaction newTx = overrideTimestamp(txh, writeTimer.getStartTime());\n+            newTx = overrideTimestamp(txh, writeTimer.getStartTime());\n+\n             store.mutate(key, Collections.singletonList(newLockEntry),\n                 null == del ? KeyColumnValueStore.NO_DELETIONS : Collections.singletonList(del), newTx);\n+\n+            newTx.commit();\n+            newTx = null;\n         } catch (BackendException e) {\n             log.debug(\"Lock write attempt failed with exception\", e);\n             t = e;\n+        } finally {\n+            if (newTx != null) {\n+                try {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(\"Transaction is still open! Rolling back\", new Throwable());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7978b1268356b333d380dc6ba5c226e6557d712b"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDMxMTk4NQ==", "bodyText": "In this situation the transaction will leak. I think we should log here error with the explanation that the above transaction is leaked. Of course it is better to somehow track it and let the logic somehow handle the transaction but I guess it makes the implementation slightly harder, so I'm totally fine to just log an error here and add a TODO message to actually resolve it later.\nSomething like:\n//TODO: We need to handle the transaction newTx which potentially may leak into memory\nlog.error(\"Failed to rollback the transaction \"+newTx.toString()+\". The transaction now may be leaked into memory.\", e);", "url": "https://github.com/JanusGraph/janusgraph/pull/2258#discussion_r534311985", "createdAt": "2020-12-02T16:36:51Z", "author": {"login": "porunov"}, "path": "janusgraph-core/src/main/java/org/janusgraph/diskstorage/locking/consistentkey/ConsistentKeyLocker.java", "diffHunk": "@@ -382,13 +382,30 @@ private WriteResult tryWriteLockOnce(StaticBuffer key, StaticBuffer del, StoreTr\n         final Timer writeTimer = times.getTimer().start();\n         StaticBuffer newLockCol = serializer.toLockCol(writeTimer.getStartTime(), rid, times);\n         Entry newLockEntry = StaticArrayEntry.of(newLockCol, zeroBuf);\n+        StoreTransaction newTx = null;\n         try {\n-            final StoreTransaction newTx = overrideTimestamp(txh, writeTimer.getStartTime());\n+            newTx = overrideTimestamp(txh, writeTimer.getStartTime());\n+\n             store.mutate(key, Collections.singletonList(newLockEntry),\n                 null == del ? KeyColumnValueStore.NO_DELETIONS : Collections.singletonList(del), newTx);\n+\n+            newTx.commit();\n+            newTx = null;\n         } catch (BackendException e) {\n             log.debug(\"Lock write attempt failed with exception\", e);\n             t = e;\n+        } finally {\n+            if (newTx != null) {\n+                try {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(\"Transaction is still open! Rolling back\", new Throwable());\n+                    }\n+\n+                    newTx.rollback();\n+                } catch (Throwable excp) {\n+                    log.debug(\"Transaction rollback failed\", excp);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7978b1268356b333d380dc6ba5c226e6557d712b"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDMxOTY1Mg==", "bodyText": "We have multiple same finally blocks. I propose to move the same code into a separate method. I.e.:\nprivate void rollbackIfNotNull(BaseTransaction tx){\n    if (tx != null) {\n        try {\n            if (log.isDebugEnabled()) {\n                log.debug(\"Transaction is still open. Rolling back the transaction: \"+tx.toString());\n            }\n            tx.rollback();\n        } catch (Throwable e) {\n            //TODO: We need to handle the transaction newTx which potentially may leak into memory\n            log.error(\"Failed to rollback the transaction \"+tx.toString()+\". The transaction now may be leaked into memory.\", e);\n        }\n    }\n}\n\nAfter that we can change all places where you added finally like the next:\nfinally {\n  rollbackIfNotNull(newTx);\n}", "url": "https://github.com/JanusGraph/janusgraph/pull/2258#discussion_r534319652", "createdAt": "2020-12-02T16:46:59Z", "author": {"login": "porunov"}, "path": "janusgraph-core/src/main/java/org/janusgraph/diskstorage/locking/consistentkey/ConsistentKeyLocker.java", "diffHunk": "@@ -398,11 +415,28 @@ private WriteResult tryWriteLockOnce(StaticBuffer key, StaticBuffer del, StoreTr\n     private WriteResult tryDeleteLockOnce(StaticBuffer key, StaticBuffer col, StoreTransaction txh) {\n         Throwable t = null;\n         final Timer delTimer = times.getTimer().start();\n+        StoreTransaction newTx = null;\n         try {\n-            final StoreTransaction newTx = overrideTimestamp(txh, delTimer.getStartTime());\n+            newTx = overrideTimestamp(txh, delTimer.getStartTime());\n+\n             store.mutate(key, ImmutableList.of(), Collections.singletonList(col), newTx);\n+\n+            newTx.commit();\n+            newTx = null;\n         } catch (BackendException e) {\n             t = e;\n+        } finally {\n+            if (newTx != null) {\n+                try {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(\"Transaction is still open! Rolling back\", new Throwable());\n+                    }\n+\n+                    newTx.rollback();\n+                } catch (Throwable excp) {\n+                    log.debug(\"Transaction rollback failed\", excp);\n+                }\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7978b1268356b333d380dc6ba5c226e6557d712b"}, "originalPosition": 58}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d52d27d19b9dbdf59735a855fa907b797dfbb944", "author": {"user": {"login": "mneethiraj", "name": "Madhan Neethiraj"}}, "url": "https://github.com/JanusGraph/janusgraph/commit/d52d27d19b9dbdf59735a855fa907b797dfbb944", "committedDate": "2020-12-03T00:11:08Z", "message": "Fixes #2255: leaked transactions in ConsistentKeyLocker - addressed review comments"}, "afterCommit": {"oid": "d63ad297a4d4ad979b9654d0dddd7cecb1a1102d", "author": {"user": {"login": "mneethiraj", "name": "Madhan Neethiraj"}}, "url": "https://github.com/JanusGraph/janusgraph/commit/d63ad297a4d4ad979b9654d0dddd7cecb1a1102d", "committedDate": "2020-12-03T00:17:47Z", "message": "Fixes #2255: leaked transactions in ConsistentKeyLocker - addressed review comments\n\nSigned-off-by: Madhan Neethiraj <madhan@apache.org>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMzU2MTE0", "url": "https://github.com/JanusGraph/janusgraph/pull/2258#pullrequestreview-543356114", "createdAt": "2020-12-03T00:48:58Z", "commit": {"oid": "d63ad297a4d4ad979b9654d0dddd7cecb1a1102d"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f868e905e7bb738a621d30c912fa3f0a2ac71ea4", "author": {"user": {"login": "mneethiraj", "name": "Madhan Neethiraj"}}, "url": "https://github.com/JanusGraph/janusgraph/commit/f868e905e7bb738a621d30c912fa3f0a2ac71ea4", "committedDate": "2020-12-03T01:14:50Z", "message": "Fixes #2255: leaked transactions in ConsistentKeyLocker\n\nSigned-off-by: Madhan Neethiraj <madhan@apache.org>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d63ad297a4d4ad979b9654d0dddd7cecb1a1102d", "author": {"user": {"login": "mneethiraj", "name": "Madhan Neethiraj"}}, "url": "https://github.com/JanusGraph/janusgraph/commit/d63ad297a4d4ad979b9654d0dddd7cecb1a1102d", "committedDate": "2020-12-03T00:17:47Z", "message": "Fixes #2255: leaked transactions in ConsistentKeyLocker - addressed review comments\n\nSigned-off-by: Madhan Neethiraj <madhan@apache.org>"}, "afterCommit": {"oid": "f868e905e7bb738a621d30c912fa3f0a2ac71ea4", "author": {"user": {"login": "mneethiraj", "name": "Madhan Neethiraj"}}, "url": "https://github.com/JanusGraph/janusgraph/commit/f868e905e7bb738a621d30c912fa3f0a2ac71ea4", "committedDate": "2020-12-03T01:14:50Z", "message": "Fixes #2255: leaked transactions in ConsistentKeyLocker\n\nSigned-off-by: Madhan Neethiraj <madhan@apache.org>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMzY4MzY1", "url": "https://github.com/JanusGraph/janusgraph/pull/2258#pullrequestreview-543368365", "createdAt": "2020-12-03T01:19:40Z", "commit": {"oid": "f868e905e7bb738a621d30c912fa3f0a2ac71ea4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4680, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}