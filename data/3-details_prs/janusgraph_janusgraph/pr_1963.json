{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2MDE0NTA0", "number": 1963, "title": "Improve lucene tokenizer", "bodyText": "Resolve Issue #1962\nFor all changes:\n\n Is there an issue associated with this PR? Is it referenced in the commit message?\n Does your PR body contain #xyz  where xyz is the issue number you are trying to resolve?\n Has your PR been rebased against the latest commit within the target branch (typically master)?\n Is your initial contribution a single, squashed commit?", "createdAt": "2020-02-17T08:53:53Z", "url": "https://github.com/JanusGraph/janusgraph/pull/1963", "merged": true, "mergeCommit": {"oid": "d0e5eff1de4e0dcdc95b6292ebe64a3baa357646"}, "closed": true, "closedAt": "2020-02-22T00:39:59Z", "author": {"login": "VladimirBogomolov"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFJraYABqjMwNDI4Njg1NzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGLTo1AFqTM2MTkwNjMyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "35bf04cf11e6218fec6c30b65b11c8bcda087d20", "author": {"user": {"login": "VladimirBogomolov", "name": "Vladimir Bogomolov"}}, "url": "https://github.com/JanusGraph/janusgraph/commit/35bf04cf11e6218fec6c30b65b11c8bcda087d20", "committedDate": "2020-02-17T08:51:51Z", "message": "Improve lucene tokenizer\n\nIf tokenizer returns more than one token for one word then query builder combine that such tokens with \"should\" occurrence"}, "afterCommit": {"oid": "656edcc947fbd24c1ca7391547fb336119a9effc", "author": {"user": {"login": "VladimirBogomolov", "name": "Vladimir Bogomolov"}}, "url": "https://github.com/JanusGraph/janusgraph/commit/656edcc947fbd24c1ca7391547fb336119a9effc", "committedDate": "2020-02-17T09:10:41Z", "message": "Improve lucene tokenizer\n\nIf tokenizer returns more than one token for one word then query builder combine that such tokens with \"should\" occurrence\n\nSigned-off-by: Vladimir Bogomolov <vladimir.bogomoloff@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5OTM4MDYz", "url": "https://github.com/JanusGraph/janusgraph/pull/1963#pullrequestreview-359938063", "createdAt": "2020-02-17T19:43:08Z", "commit": {"oid": "656edcc947fbd24c1ca7391547fb336119a9effc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxOTo0MzowOFrOFquWWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxOTo0MzowOFrOFquWWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM0Mzg5OQ==", "bodyText": "(nitpick)\nSo we are executing new ArrayList<>() even if it isn't absent. Generally it isn't a big deal because GC handles those objects easily but I am not sure if compilator is able to optimize that (I think it isn't).\nYou can either create a static function which returns a new array list (i.e. it is executed only if it is absent) or your can just return your list and create a new one if it is empty.\nSomething like:\nList<String> stemList = stemsByOffset.get(offset);\nif(stemList == null){\n  stemList = new ArrayList<>();\n  stemsByOffset.put(offset, stemList);\n}\nstemList.add(stem);", "url": "https://github.com/JanusGraph/janusgraph/pull/1963#discussion_r380343899", "createdAt": "2020-02-17T19:43:08Z", "author": {"login": "porunov"}, "path": "janusgraph-lucene/src/main/java/org/janusgraph/diskstorage/lucene/LuceneIndex.java", "diffHunk": "@@ -603,23 +605,27 @@ private static Query numericQuery(String key, Cmp relation, Number value) {\n     }\n \n     // adapted from SolrIndex\n-    private List<String> customTokenize(Analyzer analyzer, String fieldName, String value) {\n-        final List<String> terms = new ArrayList<>();\n+    private List<List<String>> customTokenize(Analyzer analyzer, String fieldName, String value) {\n+        Map<Integer, List<String>> stemsByOffset = new HashMap<>();\n         try (CachingTokenFilter stream = new CachingTokenFilter(analyzer.tokenStream(fieldName, value))) {\n+            final OffsetAttribute offsetAtt = stream.getAttribute(OffsetAttribute.class);\n             final TermToBytesRefAttribute termAtt = stream.getAttribute(TermToBytesRefAttribute.class);\n             stream.reset();\n             while (stream.incrementToken()) {\n-                terms.add(termAtt.getBytesRef().utf8ToString());\n+                int offset = offsetAtt.startOffset();\n+                String stem = termAtt.getBytesRef().utf8ToString();\n+                stemsByOffset.putIfAbsent(offset, new ArrayList<>());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "656edcc947fbd24c1ca7391547fb336119a9effc"}, "originalPosition": 32}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "549f28de612c1a5d81f098f6dcc9d2c34bb9b3bf", "author": {"user": {"login": "VladimirBogomolov", "name": "Vladimir Bogomolov"}}, "url": "https://github.com/JanusGraph/janusgraph/commit/549f28de612c1a5d81f098f6dcc9d2c34bb9b3bf", "committedDate": "2020-02-18T07:48:46Z", "message": "Delete unnecessary list creation"}, "afterCommit": {"oid": "2d2c38d4e8304b69cd0a70f86603d282f04669d8", "author": {"user": {"login": "VladimirBogomolov", "name": "Vladimir Bogomolov"}}, "url": "https://github.com/JanusGraph/janusgraph/commit/2d2c38d4e8304b69cd0a70f86603d282f04669d8", "committedDate": "2020-02-18T07:49:43Z", "message": "Delete unnecessary list creation\n\nSigned-off-by: Vladimir Bogomolov <vladimir.bogomoloff@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNTQ3NjI5", "url": "https://github.com/JanusGraph/janusgraph/pull/1963#pullrequestreview-360547629", "createdAt": "2020-02-18T17:51:54Z", "commit": {"oid": "2d2c38d4e8304b69cd0a70f86603d282f04669d8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51996a5dfdc73a59ac5f262dafeb044d2518b95f", "author": {"user": {"login": "VladimirBogomolov", "name": "Vladimir Bogomolov"}}, "url": "https://github.com/JanusGraph/janusgraph/commit/51996a5dfdc73a59ac5f262dafeb044d2518b95f", "committedDate": "2020-02-20T13:26:26Z", "message": "Improve lucene tokenizer\n\nIf tokenizer returns more than one token for one word then query builder combine that such tokens with \"should\" occurrence\n\nSigned-off-by: Vladimir Bogomolov <vladimir.bogomoloff@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d2c38d4e8304b69cd0a70f86603d282f04669d8", "author": {"user": {"login": "VladimirBogomolov", "name": "Vladimir Bogomolov"}}, "url": "https://github.com/JanusGraph/janusgraph/commit/2d2c38d4e8304b69cd0a70f86603d282f04669d8", "committedDate": "2020-02-18T07:49:43Z", "message": "Delete unnecessary list creation\n\nSigned-off-by: Vladimir Bogomolov <vladimir.bogomoloff@gmail.com>"}, "afterCommit": {"oid": "51996a5dfdc73a59ac5f262dafeb044d2518b95f", "author": {"user": {"login": "VladimirBogomolov", "name": "Vladimir Bogomolov"}}, "url": "https://github.com/JanusGraph/janusgraph/commit/51996a5dfdc73a59ac5f262dafeb044d2518b95f", "committedDate": "2020-02-20T13:26:26Z", "message": "Improve lucene tokenizer\n\nIf tokenizer returns more than one token for one word then query builder combine that such tokens with \"should\" occurrence\n\nSigned-off-by: Vladimir Bogomolov <vladimir.bogomoloff@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxOTA2MzI3", "url": "https://github.com/JanusGraph/janusgraph/pull/1963#pullrequestreview-361906327", "createdAt": "2020-02-20T13:40:02Z", "commit": {"oid": "51996a5dfdc73a59ac5f262dafeb044d2518b95f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4820, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}