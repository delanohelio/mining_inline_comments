{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1MTAyNzA2", "number": 2182, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwNTowMDoyOVrOEbaCig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwNTowMjozMVrOEbaD2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3MTczNjQyOnYy", "diffSide": "RIGHT", "path": "janusgraph-backend-testutils/src/main/java/org/janusgraph/graphdb/JanusGraphIndexTest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwNTowMDoyOVrOHFUq1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMjozMzowMFrOHFiMWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM0MzU3Mg==", "bodyText": "What if there are valid non-ghost vertices within the Iterable that just have no neighbors?\nI think they are considered \"removed\" here, right? Should they?", "url": "https://github.com/JanusGraph/janusgraph/pull/2182#discussion_r475343572", "createdAt": "2020-08-24T05:00:29Z", "author": {"login": "rngcntr"}, "path": "janusgraph-backend-testutils/src/main/java/org/janusgraph/graphdb/JanusGraphIndexTest.java", "diffHunk": "@@ -1809,14 +1810,39 @@ private void testNestedWrites(String initialValue, String updatedValue, TestInfo\n         propDeleter.commit();\n \n         // The vertex must not exist after deletion\n+        // See https://github.com/JanusGraph/janusgraph/issues/2176. The vertex is deleted from storage backend, but\n+        // may not be deleted from index backend\n         graph.tx().rollback();\n         assertNull(getV(graph, id));\n-        assertEmpty(graph.query().has(propName).vertices());\n+        assertTrue(verticesRemoved(graph.query().has(propName).vertices()));\n         if (null != updatedValue)\n-            assertEmpty(graph.query().has(propName, updatedValue).vertices());\n+            assertTrue(verticesRemoved(graph.query().has(propName, updatedValue).vertices()));\n         graph.tx().rollback();\n     }\n \n+    /**\n+     * Check whether given iterable does not contain any valid vertex\n+     * This function returns true if either of the following conditions holds:\n+     * 1) the iterable is empty\n+     * 2) all vertices in the iterable are phantom vertices\n+     * @param vertices An iterable of vertices\n+     * @return boolean indicating if given vertices do not exist\n+     */\n+    private boolean verticesRemoved(Iterable<JanusGraphVertex> vertices) {\n+        if (Iterables.isEmpty(vertices)) {\n+            return true;\n+        }\n+        StandardJanusGraphTx queryTx = (StandardJanusGraphTx) graph.newTransaction();\n+        for (JanusGraphVertex v : vertices) {\n+            if (!graph.edgeQuery(v.longId(), graph.vertexExistenceQuery, queryTx.getTxHandle()).isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d32db08b5c4322c49887faf245a0b4848a9e906e"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU2MzE3NQ==", "bodyText": "I guess you are misguided by the method name, \"edgeQuery\". It does not check neighbors, the method name is \"edgeQuery\" because almost everything is an edge in JanusGraph to my understanding. The method queries \"edgeStore\", which stores all vertices, properties, and edges.", "url": "https://github.com/JanusGraph/janusgraph/pull/2182#discussion_r475563175", "createdAt": "2020-08-24T12:29:21Z", "author": {"login": "li-boxuan"}, "path": "janusgraph-backend-testutils/src/main/java/org/janusgraph/graphdb/JanusGraphIndexTest.java", "diffHunk": "@@ -1809,14 +1810,39 @@ private void testNestedWrites(String initialValue, String updatedValue, TestInfo\n         propDeleter.commit();\n \n         // The vertex must not exist after deletion\n+        // See https://github.com/JanusGraph/janusgraph/issues/2176. The vertex is deleted from storage backend, but\n+        // may not be deleted from index backend\n         graph.tx().rollback();\n         assertNull(getV(graph, id));\n-        assertEmpty(graph.query().has(propName).vertices());\n+        assertTrue(verticesRemoved(graph.query().has(propName).vertices()));\n         if (null != updatedValue)\n-            assertEmpty(graph.query().has(propName, updatedValue).vertices());\n+            assertTrue(verticesRemoved(graph.query().has(propName, updatedValue).vertices()));\n         graph.tx().rollback();\n     }\n \n+    /**\n+     * Check whether given iterable does not contain any valid vertex\n+     * This function returns true if either of the following conditions holds:\n+     * 1) the iterable is empty\n+     * 2) all vertices in the iterable are phantom vertices\n+     * @param vertices An iterable of vertices\n+     * @return boolean indicating if given vertices do not exist\n+     */\n+    private boolean verticesRemoved(Iterable<JanusGraphVertex> vertices) {\n+        if (Iterables.isEmpty(vertices)) {\n+            return true;\n+        }\n+        StandardJanusGraphTx queryTx = (StandardJanusGraphTx) graph.newTransaction();\n+        for (JanusGraphVertex v : vertices) {\n+            if (!graph.edgeQuery(v.longId(), graph.vertexExistenceQuery, queryTx.getTxHandle()).isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM0MzU3Mg=="}, "originalCommit": {"oid": "d32db08b5c4322c49887faf245a0b4848a9e906e"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU2NTE0NQ==", "bodyText": "Thanks for pointing that out! You are completely right, I misunderstood edgeQuery.", "url": "https://github.com/JanusGraph/janusgraph/pull/2182#discussion_r475565145", "createdAt": "2020-08-24T12:33:00Z", "author": {"login": "rngcntr"}, "path": "janusgraph-backend-testutils/src/main/java/org/janusgraph/graphdb/JanusGraphIndexTest.java", "diffHunk": "@@ -1809,14 +1810,39 @@ private void testNestedWrites(String initialValue, String updatedValue, TestInfo\n         propDeleter.commit();\n \n         // The vertex must not exist after deletion\n+        // See https://github.com/JanusGraph/janusgraph/issues/2176. The vertex is deleted from storage backend, but\n+        // may not be deleted from index backend\n         graph.tx().rollback();\n         assertNull(getV(graph, id));\n-        assertEmpty(graph.query().has(propName).vertices());\n+        assertTrue(verticesRemoved(graph.query().has(propName).vertices()));\n         if (null != updatedValue)\n-            assertEmpty(graph.query().has(propName, updatedValue).vertices());\n+            assertTrue(verticesRemoved(graph.query().has(propName, updatedValue).vertices()));\n         graph.tx().rollback();\n     }\n \n+    /**\n+     * Check whether given iterable does not contain any valid vertex\n+     * This function returns true if either of the following conditions holds:\n+     * 1) the iterable is empty\n+     * 2) all vertices in the iterable are phantom vertices\n+     * @param vertices An iterable of vertices\n+     * @return boolean indicating if given vertices do not exist\n+     */\n+    private boolean verticesRemoved(Iterable<JanusGraphVertex> vertices) {\n+        if (Iterables.isEmpty(vertices)) {\n+            return true;\n+        }\n+        StandardJanusGraphTx queryTx = (StandardJanusGraphTx) graph.newTransaction();\n+        for (JanusGraphVertex v : vertices) {\n+            if (!graph.edgeQuery(v.longId(), graph.vertexExistenceQuery, queryTx.getTxHandle()).isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM0MzU3Mg=="}, "originalCommit": {"oid": "d32db08b5c4322c49887faf245a0b4848a9e906e"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3MTczOTc4OnYy", "diffSide": "RIGHT", "path": "janusgraph-backend-testutils/src/main/java/org/janusgraph/graphdb/JanusGraphIndexTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwNTowMjozMVrOHFUsyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMjoyNjoxM1rOHFh9-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM0NDA3Mw==", "bodyText": "What's the logical difference between this line and the original one?", "url": "https://github.com/JanusGraph/janusgraph/pull/2182#discussion_r475344073", "createdAt": "2020-08-24T05:02:31Z", "author": {"login": "rngcntr"}, "path": "janusgraph-backend-testutils/src/main/java/org/janusgraph/graphdb/JanusGraphIndexTest.java", "diffHunk": "@@ -1785,7 +1786,7 @@ private void testNestedWrites(String initialValue, String updatedValue, TestInfo\n \n         // Write schema and one vertex\n         final PropertyKey prop = makeKey(propName, String.class);\n-        createExternalVertexIndex(prop, INDEX);\n+        mgmt.buildIndex(\"mixed\", Vertex.class).addKey(prop, Mapping.STRING.asParameter()).buildMixedIndex(INDEX);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d32db08b5c4322c49887faf245a0b4848a9e906e"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU2MTQ2Ng==", "bodyText": "The original one builds a mixed index backed by TEXT, which supports full-text search but not equality check. Therefore, original line 1816\nassertEmpty(graph.query().has(propName, updatedValue).vertices());\ndoes a full scan without using mixed index.", "url": "https://github.com/JanusGraph/janusgraph/pull/2182#discussion_r475561466", "createdAt": "2020-08-24T12:26:13Z", "author": {"login": "li-boxuan"}, "path": "janusgraph-backend-testutils/src/main/java/org/janusgraph/graphdb/JanusGraphIndexTest.java", "diffHunk": "@@ -1785,7 +1786,7 @@ private void testNestedWrites(String initialValue, String updatedValue, TestInfo\n \n         // Write schema and one vertex\n         final PropertyKey prop = makeKey(propName, String.class);\n-        createExternalVertexIndex(prop, INDEX);\n+        mgmt.buildIndex(\"mixed\", Vertex.class).addKey(prop, Mapping.STRING.asParameter()).buildMixedIndex(INDEX);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM0NDA3Mw=="}, "originalCommit": {"oid": "d32db08b5c4322c49887faf245a0b4848a9e906e"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1340, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}