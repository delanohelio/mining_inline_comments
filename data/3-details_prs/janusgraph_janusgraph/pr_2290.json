{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQzMTI0MDk0", "number": 2290, "title": "Use available page size for CQL result set instead of forced page size [full build]", "bodyText": "Changes in this PR will be ignored in master branch because this potential bug is fixed in master branch.\nIn the issue I described why it is hard to confirm and test this bug. This PR either fixes a potential bug or does nothing (lets say just refactors the code).\nFixes #2254\nSigned-off-by: Oleksandr Porunov alexandr.porunov@gmail.com\n\nThank you for contributing to JanusGraph!\nIn order to streamline the review of the contribution we ask you\nto ensure the following steps have been taken:\nFor all changes:\n\n Is there an issue associated with this PR? Is it referenced in the commit message?\n Does your PR body contain #xyz where xyz is the issue number you are trying to resolve?\n Has your PR been rebased against the latest commit within the target branch (typically master)?\n Is your initial contribution a single, squashed commit?\n\nFor code changes:\n\n Have you written and/or updated unit tests to verify your changes?\n If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under ASF 2.0?\n If applicable, have you updated the LICENSE.txt file, including the main LICENSE.txt file in the root of this repository?\n If applicable, have you updated the NOTICE.txt file, including the main NOTICE.txt file found in the root of this repository?\n\nFor documentation related changes:\n\n Have you ensured that format looks appropriate for the output in which it is rendered?\n If this PR is a documentation-only change, have you added a [doc only]\ntag to the first line of your commit message to avoid spending CPU cycles in\nTravis CI when no code, tests, or build configuration are modified?\n\nNote:\nPlease ensure that once the PR is submitted, you check Travis CI for build issues and submit an update to your PR as soon as possible.", "createdAt": "2020-12-20T20:00:22Z", "url": "https://github.com/JanusGraph/janusgraph/pull/2290", "merged": true, "mergeCommit": {"oid": "855681621a628e18c68ddc6417daeb982e235ac1"}, "closed": true, "closedAt": "2020-12-23T14:09:37Z", "author": {"login": "porunov"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdoG-3RABqjQxMzM2MzI1NTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdo1E5BgFqTU1NzQ2MjIyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b2cbf40803552d9a90a3ff09326a8c4037e76e2b", "author": {"user": {"login": "porunov", "name": "Oleksandr Porunov"}}, "url": "https://github.com/JanusGraph/janusgraph/commit/b2cbf40803552d9a90a3ff09326a8c4037e76e2b", "committedDate": "2020-12-20T19:58:10Z", "message": "Use available page size for CQL result set instead of forced page size [full build]\n\nFixes #2254\n\nSigned-off-by: Oleksandr Porunov <alexandr.porunov@gmail.com>"}, "afterCommit": {"oid": "4aaf15a8815e3c2c4f393f6d679fb084ebd209eb", "author": {"user": {"login": "porunov", "name": "Oleksandr Porunov"}}, "url": "https://github.com/JanusGraph/janusgraph/commit/4aaf15a8815e3c2c4f393f6d679fb084ebd209eb", "committedDate": "2020-12-20T20:02:10Z", "message": "Use available page size for CQL result set instead of forced page size [full build]\n\nFixes #2254\n\nSigned-off-by: Oleksandr Porunov <alexandr.porunov@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2NDU1ODAz", "url": "https://github.com/JanusGraph/janusgraph/pull/2290#pullrequestreview-556455803", "createdAt": "2020-12-21T15:20:07Z", "commit": {"oid": "4aaf15a8815e3c2c4f393f6d679fb084ebd209eb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "855681621a628e18c68ddc6417daeb982e235ac1", "author": {"user": {"login": "porunov", "name": "Oleksandr Porunov"}}, "url": "https://github.com/JanusGraph/janusgraph/commit/855681621a628e18c68ddc6417daeb982e235ac1", "committedDate": "2020-12-22T10:18:59Z", "message": "Use available page size for CQL result set instead of forced page size [full build]\n\nFixes #2254\n\nSigned-off-by: Oleksandr Porunov <alexandr.porunov@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4aaf15a8815e3c2c4f393f6d679fb084ebd209eb", "author": {"user": {"login": "porunov", "name": "Oleksandr Porunov"}}, "url": "https://github.com/JanusGraph/janusgraph/commit/4aaf15a8815e3c2c4f393f6d679fb084ebd209eb", "committedDate": "2020-12-20T20:02:10Z", "message": "Use available page size for CQL result set instead of forced page size [full build]\n\nFixes #2254\n\nSigned-off-by: Oleksandr Porunov <alexandr.porunov@gmail.com>"}, "afterCommit": {"oid": "855681621a628e18c68ddc6417daeb982e235ac1", "author": {"user": {"login": "porunov", "name": "Oleksandr Porunov"}}, "url": "https://github.com/JanusGraph/janusgraph/commit/855681621a628e18c68ddc6417daeb982e235ac1", "committedDate": "2020-12-22T10:18:59Z", "message": "Use available page size for CQL result set instead of forced page size [full build]\n\nFixes #2254\n\nSigned-off-by: Oleksandr Porunov <alexandr.porunov@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3MjAyMDI5", "url": "https://github.com/JanusGraph/janusgraph/pull/2290#pullrequestreview-557202029", "createdAt": "2020-12-22T16:23:13Z", "commit": {"oid": "855681621a628e18c68ddc6417daeb982e235ac1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxNjoyMzoxM1rOIKA7FQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxNjoyMzoxM1rOIKA7FQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM3MTc5Nw==", "bodyText": "LGTM \ud83d\udc4d  I tested locally using the following code which creates and reads 100 thousand vertices. The test passed. I could also see fetchResultSet() is called in hasNext() method.\n   @Test\n    public void testHugeGraph() {\n        int maxK = 100, maxI = 1000;\n        for (int k = 0; k < maxK; k++) {\n            for (int i = 0; i < maxI; i++) {\n                tx.addVertex(\"prop\", k * maxI + i);\n                newTx();\n            }\n        }\n\n        List<Object> props = graph.traversal().V().values(\"prop\").toList();\n        assertEquals(maxK * maxI, new HashSet<>(props).size());\n    }\nThat being said, I also observed something weird: when I ran this locally, I put a debug point (in Intellij) on this line (line 456) to check if this line is reachable. Once I saw the debug point reached, I immediately removed the debug point and resumed the application. Then the test case failed because graph.traversal().V().values(\"prop\").toList() returned fewer results than expected. I could always reproduce it; even when I set maxI = 10 (that is, one thousand vertices in total). However, the same test case always passes as long as I don't set a debug point. I tried letting the thread sleep for 1 or more seconds here, but the test case still passes. Do you have any thoughts?", "url": "https://github.com/JanusGraph/janusgraph/pull/2290#discussion_r547371797", "createdAt": "2020-12-22T16:23:13Z", "author": {"login": "li-boxuan"}, "path": "janusgraph-cql/src/main/java/org/janusgraph/diskstorage/cql/CQLKeyColumnValueStore.java", "diffHunk": "@@ -441,43 +439,43 @@ public KeyIterator getKeys(final SliceQuery query, final StoreTransaction txh) t\n     private class CQLPagingIterator implements Iterator<Row> {\n \n         private ResultSet currentResultSet;\n-\n-        private int index;\n-        private int paginatedResultSize;\n+        private int availableWithoutFetching;\n         private final Supplier<Statement> statementSupplier;\n \n-        private byte[] lastPagingState = null;\n-\n-        public CQLPagingIterator(final int pageSize, Supplier<Statement> statementSupplier) {\n-            this.index = 0;\n-            this.paginatedResultSize = pageSize;\n+        public CQLPagingIterator(Supplier<Statement> statementSupplier) {\n             this.statementSupplier = statementSupplier;\n-            this.currentResultSet = getResultSet();\n+            fetchResultSet();\n         }\n \n         @Override\n         public boolean hasNext() {\n-            return !currentResultSet.isExhausted();\n+            if(availableWithoutFetching<=0){\n+                if(currentResultSet.isFullyFetched()){\n+                    return false;\n+                }\n+                fetchResultSet();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "855681621a628e18c68ddc6417daeb982e235ac1"}, "originalPosition": 68}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3NDYyMjIz", "url": "https://github.com/JanusGraph/janusgraph/pull/2290#pullrequestreview-557462223", "createdAt": "2020-12-23T01:44:31Z", "commit": {"oid": "855681621a628e18c68ddc6417daeb982e235ac1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4704, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}