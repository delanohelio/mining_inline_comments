{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1Mjk1MzU0", "number": 1961, "title": "Apply optimizations to queries to make use of adjacent ids", "bodyText": "This feature was originally part of #1937 which was splitted to decrease per-PR-complexity.\nThis PR introduces two new OptimizerStrategies, which further improve the existing optimizations based on adjacent vertex ids. In the current state, these queries will be optimized to check the adjacency on the edge before iterating to the vertex itself:\n\ng.V(left).outE('label').where(_.inV().is(right))\ng.V(left).outE('label').filter(_.inV().is(right))\n\nThe optimization of these queries is within the scope of #1960:\n\ng.V(left).outE('label').where(__.inV().hasId(right))\ng.V(left).outE('label').filter(__.inV().hasId(right))\n\nWith the new optimizer, these queries will also profit of optimization:\n\ng.V(left).outE('label').inV().is(right)\ng.V(left).outE('label').inV().hasId(right.id())\ng.V(left).out('label').is(right)\ng.V(left).out('label').hasId(right.id())\ng.V(left).out('label').filter(is(right))\ng.V(left).out('label').where(is(right))\ng.V(left).out('label').filter(hasId(right.id()))\ng.V(left).out('label').where(hasId(right.id()))\n\nAll of this also applies to all other valid variations of in()/out()/both().\nFor all changes:\n\n Is there an issue associated with this PR? Is it referenced in the commit message?\n Does your PR body contain #xyz where xyz is the issue number you are trying to resolve?\n Has your PR been rebased against the latest commit within the target branch (typically master)?\n Is your initial contribution a single, squashed commit?\n\nFor code changes:\n\n Have you written and/or updated unit tests to verify your changes?\n If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under ASF 2.0?\n If applicable, have you updated the LICENSE.txt file, including the main LICENSE.txt file in the root of this repository?\n If applicable, have you updated the NOTICE.txt file, including the main NOTICE.txt file found in the root of this repository?", "createdAt": "2020-02-14T09:38:28Z", "url": "https://github.com/JanusGraph/janusgraph/pull/1961", "merged": true, "mergeCommit": {"oid": "7297adb3bcfa25fac82d772dbafb68fe4babacab"}, "closed": true, "closedAt": "2020-03-03T14:24:01Z", "author": {"login": "rngcntr"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcEMeDcABqjMwMzgxMTkzNDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcJ-YsMgFqTM2Nzc5NDE1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de39e9c0e8c67c8d2e82c2f98e568defdbe80549", "author": {"user": {"login": "rngcntr", "name": null}}, "url": "https://github.com/JanusGraph/janusgraph/commit/de39e9c0e8c67c8d2e82c2f98e568defdbe80549", "committedDate": "2020-02-14T09:30:17Z", "message": "Apply optimizations to queries to make use of adjacent ids\n\nSigned-off-by: Florian Grieskamp <florian.grieskamp@gdata.de>"}, "afterCommit": {"oid": "a9c91c52e62b8c2287e52ee1cb8bdac4ce20b5b4", "author": {"user": {"login": "rngcntr", "name": null}}, "url": "https://github.com/JanusGraph/janusgraph/commit/a9c91c52e62b8c2287e52ee1cb8bdac4ce20b5b4", "committedDate": "2020-02-14T09:53:19Z", "message": "Apply optimizations to queries to make use of adjacent ids\n\nSigned-off-by: Florian Grieskamp <florian.grieskamp@gdata.de>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a9c91c52e62b8c2287e52ee1cb8bdac4ce20b5b4", "author": {"user": {"login": "rngcntr", "name": null}}, "url": "https://github.com/JanusGraph/janusgraph/commit/a9c91c52e62b8c2287e52ee1cb8bdac4ce20b5b4", "committedDate": "2020-02-14T09:53:19Z", "message": "Apply optimizations to queries to make use of adjacent ids\n\nSigned-off-by: Florian Grieskamp <florian.grieskamp@gdata.de>"}, "afterCommit": {"oid": "fd0e7772446cd7d30058ffe544cb5caeecfa9cae", "author": {"user": {"login": "rngcntr", "name": null}}, "url": "https://github.com/JanusGraph/janusgraph/commit/fd0e7772446cd7d30058ffe544cb5caeecfa9cae", "committedDate": "2020-02-17T09:28:12Z", "message": "Apply optimizations to queries to make use of adjacent ids\n\nSigned-off-by: Florian Grieskamp <florian.grieskamp@gdata.de>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd0e7772446cd7d30058ffe544cb5caeecfa9cae", "author": {"user": {"login": "rngcntr", "name": null}}, "url": "https://github.com/JanusGraph/janusgraph/commit/fd0e7772446cd7d30058ffe544cb5caeecfa9cae", "committedDate": "2020-02-17T09:28:12Z", "message": "Apply optimizations to queries to make use of adjacent ids\n\nSigned-off-by: Florian Grieskamp <florian.grieskamp@gdata.de>"}, "afterCommit": {"oid": "c963c0f9b5b02bcdf5db77bdc25dfa5cb09c46cd", "author": {"user": {"login": "rngcntr", "name": null}}, "url": "https://github.com/JanusGraph/janusgraph/commit/c963c0f9b5b02bcdf5db77bdc25dfa5cb09c46cd", "committedDate": "2020-02-20T14:35:48Z", "message": "Apply optimizations to queries to make use of adjacent ids\n\nSigned-off-by: Florian Grieskamp <florian.grieskamp@gdata.de>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c963c0f9b5b02bcdf5db77bdc25dfa5cb09c46cd", "author": {"user": {"login": "rngcntr", "name": null}}, "url": "https://github.com/JanusGraph/janusgraph/commit/c963c0f9b5b02bcdf5db77bdc25dfa5cb09c46cd", "committedDate": "2020-02-20T14:35:48Z", "message": "Apply optimizations to queries to make use of adjacent ids\n\nSigned-off-by: Florian Grieskamp <florian.grieskamp@gdata.de>"}, "afterCommit": {"oid": "aa674d8a506be800bb621cbe3d4aecfcda538af7", "author": {"user": {"login": "rngcntr", "name": null}}, "url": "https://github.com/JanusGraph/janusgraph/commit/aa674d8a506be800bb621cbe3d4aecfcda538af7", "committedDate": "2020-02-21T07:50:39Z", "message": "Apply optimizations to queries to make use of adjacent ids\n\nSigned-off-by: Florian Grieskamp <florian.grieskamp@gdata.de>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aa674d8a506be800bb621cbe3d4aecfcda538af7", "author": {"user": {"login": "rngcntr", "name": null}}, "url": "https://github.com/JanusGraph/janusgraph/commit/aa674d8a506be800bb621cbe3d4aecfcda538af7", "committedDate": "2020-02-21T07:50:39Z", "message": "Apply optimizations to queries to make use of adjacent ids\n\nSigned-off-by: Florian Grieskamp <florian.grieskamp@gdata.de>"}, "afterCommit": {"oid": "910410f99a2c2b2c0f3b65b9c557ba65dd0b443e", "author": {"user": {"login": "rngcntr", "name": null}}, "url": "https://github.com/JanusGraph/janusgraph/commit/910410f99a2c2b2c0f3b65b9c557ba65dd0b443e", "committedDate": "2020-02-24T12:27:02Z", "message": "Apply optimizations to queries to make use of adjacent ids\n\nSigned-off-by: Florian Grieskamp <florian.grieskamp@gdata.de>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "910410f99a2c2b2c0f3b65b9c557ba65dd0b443e", "author": {"user": {"login": "rngcntr", "name": null}}, "url": "https://github.com/JanusGraph/janusgraph/commit/910410f99a2c2b2c0f3b65b9c557ba65dd0b443e", "committedDate": "2020-02-24T12:27:02Z", "message": "Apply optimizations to queries to make use of adjacent ids\n\nSigned-off-by: Florian Grieskamp <florian.grieskamp@gdata.de>"}, "afterCommit": {"oid": "0c63a36af2696d60ec00c6f4e46afb98d0100a56", "author": {"user": {"login": "rngcntr", "name": null}}, "url": "https://github.com/JanusGraph/janusgraph/commit/0c63a36af2696d60ec00c6f4e46afb98d0100a56", "committedDate": "2020-02-24T12:55:29Z", "message": "Apply optimizations to queries to make use of adjacent ids\n\nSigned-off-by: Florian Grieskamp <florian.grieskamp@gdata.de>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0c63a36af2696d60ec00c6f4e46afb98d0100a56", "author": {"user": {"login": "rngcntr", "name": null}}, "url": "https://github.com/JanusGraph/janusgraph/commit/0c63a36af2696d60ec00c6f4e46afb98d0100a56", "committedDate": "2020-02-24T12:55:29Z", "message": "Apply optimizations to queries to make use of adjacent ids\n\nSigned-off-by: Florian Grieskamp <florian.grieskamp@gdata.de>"}, "afterCommit": {"oid": "8d5093e20c9948f926d1185e5a41d189155c6694", "author": {"user": {"login": "rngcntr", "name": null}}, "url": "https://github.com/JanusGraph/janusgraph/commit/8d5093e20c9948f926d1185e5a41d189155c6694", "committedDate": "2020-02-24T14:19:23Z", "message": "Apply optimizations to queries to make use of adjacent ids\n\nSigned-off-by: Florian Grieskamp <florian.grieskamp@gdata.de>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzODEwNjkz", "url": "https://github.com/JanusGraph/janusgraph/pull/1961#pullrequestreview-363810693", "createdAt": "2020-02-25T01:10:00Z", "commit": {"oid": "8d5093e20c9948f926d1185e5a41d189155c6694"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwMToxMDowMFrOFt1ejQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwMjozMToyN1rOFt2v1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYwNjQxMw==", "bodyText": "This value is never used", "url": "https://github.com/JanusGraph/janusgraph/pull/1961#discussion_r383606413", "createdAt": "2020-02-25T01:10:00Z", "author": {"login": "porunov"}, "path": "janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/AdjacentVertexOptimizerStrategy.java", "diffHunk": "@@ -0,0 +1,166 @@\n+// Copyright 2019 JanusGraph Authors\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package org.janusgraph.graphdb.tinkerpop.optimize;\n+\n+import static org.janusgraph.graphdb.types.system.ImplicitKey.ADJACENT_ID;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import org.apache.tinkerpop.gremlin.process.traversal.P;\n+import org.apache.tinkerpop.gremlin.process.traversal.Step;\n+import org.apache.tinkerpop.gremlin.process.traversal.Traversal;\n+import org.apache.tinkerpop.gremlin.process.traversal.TraversalStrategy;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.filter.FilterStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.filter.HasStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.map.EdgeOtherVertexStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.map.EdgeVertexStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.map.VertexStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.util.HasContainer;\n+import org.apache.tinkerpop.gremlin.process.traversal.strategy.AbstractTraversalStrategy;\n+import org.apache.tinkerpop.gremlin.process.traversal.util.TraversalHelper;\n+import org.apache.tinkerpop.gremlin.structure.Direction;\n+import org.apache.tinkerpop.gremlin.structure.Edge;\n+import org.apache.tinkerpop.gremlin.structure.Vertex;\n+\n+/**\n+ * @author Florian Grieskamp (Florian.Grieskamp@gdata.de)\n+ */\n+public abstract class AdjacentVertexOptimizerStrategy<T extends FilterStep<?>>\n+    extends AbstractTraversalStrategy<TraversalStrategy.ProviderOptimizationStrategy>\n+    implements TraversalStrategy.ProviderOptimizationStrategy {\n+\n+    T stepType;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d5093e20c9948f926d1185e5a41d189155c6694"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYwNzU3Ng==", "bodyText": "Can be simplified:\nP<?> predicate = parsePredicate(step);\nif (isValidPredicate(predicate)) {\n    OptimizablePosition pos = isOptimizableByPosition(step);\n    replaceSequence(step, pos, predicate);\n}\n\nThe method isOptimizableByPredicate is unnecessary.", "url": "https://github.com/JanusGraph/janusgraph/pull/1961#discussion_r383607576", "createdAt": "2020-02-25T01:14:21Z", "author": {"login": "porunov"}, "path": "janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/AdjacentVertexOptimizerStrategy.java", "diffHunk": "@@ -0,0 +1,166 @@\n+// Copyright 2019 JanusGraph Authors\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package org.janusgraph.graphdb.tinkerpop.optimize;\n+\n+import static org.janusgraph.graphdb.types.system.ImplicitKey.ADJACENT_ID;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import org.apache.tinkerpop.gremlin.process.traversal.P;\n+import org.apache.tinkerpop.gremlin.process.traversal.Step;\n+import org.apache.tinkerpop.gremlin.process.traversal.Traversal;\n+import org.apache.tinkerpop.gremlin.process.traversal.TraversalStrategy;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.filter.FilterStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.filter.HasStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.map.EdgeOtherVertexStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.map.EdgeVertexStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.map.VertexStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.util.HasContainer;\n+import org.apache.tinkerpop.gremlin.process.traversal.strategy.AbstractTraversalStrategy;\n+import org.apache.tinkerpop.gremlin.process.traversal.util.TraversalHelper;\n+import org.apache.tinkerpop.gremlin.structure.Direction;\n+import org.apache.tinkerpop.gremlin.structure.Edge;\n+import org.apache.tinkerpop.gremlin.structure.Vertex;\n+\n+/**\n+ * @author Florian Grieskamp (Florian.Grieskamp@gdata.de)\n+ */\n+public abstract class AdjacentVertexOptimizerStrategy<T extends FilterStep<?>>\n+    extends AbstractTraversalStrategy<TraversalStrategy.ProviderOptimizationStrategy>\n+    implements TraversalStrategy.ProviderOptimizationStrategy {\n+\n+    T stepType;\n+\n+    protected enum OptimizablePosition {\n+        NONE,\n+        V2V_ID,    // vertex-to-vertex step with following filter on id\n+        V2E_E2V_ID // vertex-to-edge step with following edge-to-vertex-step and filter on id\n+    }\n+\n+    @Override\n+    public Set<Class<? extends ProviderOptimizationStrategy>> applyPost() {\n+        Set<Class<? extends ProviderOptimizationStrategy>> postStrategies = new HashSet<Class<? extends ProviderOptimizationStrategy>>();\n+        postStrategies.add(JanusGraphLocalQueryOptimizerStrategy.class);\n+        return postStrategies;\n+    }\n+\n+    protected void optimizeStep(T step) {\n+        if (isOptimizableByPredicate(step)) {\n+            OptimizablePosition pos = isOptimizableByPosition(step);\n+            P<?> predicate = parsePredicate(step);\n+            replaceSequence(step, pos, predicate);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d5093e20c9948f926d1185e5a41d189155c6694"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYwNzkzMw==", "bodyText": "Should be called getOptimizablePosition", "url": "https://github.com/JanusGraph/janusgraph/pull/1961#discussion_r383607933", "createdAt": "2020-02-25T01:15:37Z", "author": {"login": "porunov"}, "path": "janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/AdjacentVertexOptimizerStrategy.java", "diffHunk": "@@ -0,0 +1,166 @@\n+// Copyright 2019 JanusGraph Authors\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package org.janusgraph.graphdb.tinkerpop.optimize;\n+\n+import static org.janusgraph.graphdb.types.system.ImplicitKey.ADJACENT_ID;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import org.apache.tinkerpop.gremlin.process.traversal.P;\n+import org.apache.tinkerpop.gremlin.process.traversal.Step;\n+import org.apache.tinkerpop.gremlin.process.traversal.Traversal;\n+import org.apache.tinkerpop.gremlin.process.traversal.TraversalStrategy;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.filter.FilterStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.filter.HasStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.map.EdgeOtherVertexStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.map.EdgeVertexStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.map.VertexStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.util.HasContainer;\n+import org.apache.tinkerpop.gremlin.process.traversal.strategy.AbstractTraversalStrategy;\n+import org.apache.tinkerpop.gremlin.process.traversal.util.TraversalHelper;\n+import org.apache.tinkerpop.gremlin.structure.Direction;\n+import org.apache.tinkerpop.gremlin.structure.Edge;\n+import org.apache.tinkerpop.gremlin.structure.Vertex;\n+\n+/**\n+ * @author Florian Grieskamp (Florian.Grieskamp@gdata.de)\n+ */\n+public abstract class AdjacentVertexOptimizerStrategy<T extends FilterStep<?>>\n+    extends AbstractTraversalStrategy<TraversalStrategy.ProviderOptimizationStrategy>\n+    implements TraversalStrategy.ProviderOptimizationStrategy {\n+\n+    T stepType;\n+\n+    protected enum OptimizablePosition {\n+        NONE,\n+        V2V_ID,    // vertex-to-vertex step with following filter on id\n+        V2E_E2V_ID // vertex-to-edge step with following edge-to-vertex-step and filter on id\n+    }\n+\n+    @Override\n+    public Set<Class<? extends ProviderOptimizationStrategy>> applyPost() {\n+        Set<Class<? extends ProviderOptimizationStrategy>> postStrategies = new HashSet<Class<? extends ProviderOptimizationStrategy>>();\n+        postStrategies.add(JanusGraphLocalQueryOptimizerStrategy.class);\n+        return postStrategies;\n+    }\n+\n+    protected void optimizeStep(T step) {\n+        if (isOptimizableByPredicate(step)) {\n+            OptimizablePosition pos = isOptimizableByPosition(step);\n+            P<?> predicate = parsePredicate(step);\n+            replaceSequence(step, pos, predicate);\n+        }\n+    }\n+\n+    private boolean isOptimizableByPredicate(T step) {\n+        return isValidPredicate(parsePredicate(step));\n+    }\n+\n+    protected abstract P<?> parsePredicate(T step);\n+\n+    protected abstract boolean isValidPredicate(P<?> predicate);\n+\n+    private OptimizablePosition isOptimizableByPosition(T originalStep) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d5093e20c9948f926d1185e5a41d189155c6694"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYwOTE3NQ==", "bodyText": "Move prePredecessor after the first if because it isn't necessary if the predecessor is instance of VertexStep", "url": "https://github.com/JanusGraph/janusgraph/pull/1961#discussion_r383609175", "createdAt": "2020-02-25T01:20:15Z", "author": {"login": "porunov"}, "path": "janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/AdjacentVertexOptimizerStrategy.java", "diffHunk": "@@ -0,0 +1,166 @@\n+// Copyright 2019 JanusGraph Authors\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package org.janusgraph.graphdb.tinkerpop.optimize;\n+\n+import static org.janusgraph.graphdb.types.system.ImplicitKey.ADJACENT_ID;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import org.apache.tinkerpop.gremlin.process.traversal.P;\n+import org.apache.tinkerpop.gremlin.process.traversal.Step;\n+import org.apache.tinkerpop.gremlin.process.traversal.Traversal;\n+import org.apache.tinkerpop.gremlin.process.traversal.TraversalStrategy;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.filter.FilterStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.filter.HasStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.map.EdgeOtherVertexStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.map.EdgeVertexStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.map.VertexStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.util.HasContainer;\n+import org.apache.tinkerpop.gremlin.process.traversal.strategy.AbstractTraversalStrategy;\n+import org.apache.tinkerpop.gremlin.process.traversal.util.TraversalHelper;\n+import org.apache.tinkerpop.gremlin.structure.Direction;\n+import org.apache.tinkerpop.gremlin.structure.Edge;\n+import org.apache.tinkerpop.gremlin.structure.Vertex;\n+\n+/**\n+ * @author Florian Grieskamp (Florian.Grieskamp@gdata.de)\n+ */\n+public abstract class AdjacentVertexOptimizerStrategy<T extends FilterStep<?>>\n+    extends AbstractTraversalStrategy<TraversalStrategy.ProviderOptimizationStrategy>\n+    implements TraversalStrategy.ProviderOptimizationStrategy {\n+\n+    T stepType;\n+\n+    protected enum OptimizablePosition {\n+        NONE,\n+        V2V_ID,    // vertex-to-vertex step with following filter on id\n+        V2E_E2V_ID // vertex-to-edge step with following edge-to-vertex-step and filter on id\n+    }\n+\n+    @Override\n+    public Set<Class<? extends ProviderOptimizationStrategy>> applyPost() {\n+        Set<Class<? extends ProviderOptimizationStrategy>> postStrategies = new HashSet<Class<? extends ProviderOptimizationStrategy>>();\n+        postStrategies.add(JanusGraphLocalQueryOptimizerStrategy.class);\n+        return postStrategies;\n+    }\n+\n+    protected void optimizeStep(T step) {\n+        if (isOptimizableByPredicate(step)) {\n+            OptimizablePosition pos = isOptimizableByPosition(step);\n+            P<?> predicate = parsePredicate(step);\n+            replaceSequence(step, pos, predicate);\n+        }\n+    }\n+\n+    private boolean isOptimizableByPredicate(T step) {\n+        return isValidPredicate(parsePredicate(step));\n+    }\n+\n+    protected abstract P<?> parsePredicate(T step);\n+\n+    protected abstract boolean isValidPredicate(P<?> predicate);\n+\n+    private OptimizablePosition isOptimizableByPosition(T originalStep) {\n+        Step<?, ?> predecessor = originalStep.getPreviousStep();\n+        Step<?, ?> prePredecessor = predecessor.getPreviousStep();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d5093e20c9948f926d1185e5a41d189155c6694"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYxMTUzNw==", "bodyText": "As I understand this if won't be executed because we call this method only if the above checks are passed already (see isOptimizableByPosition method).\nIf so, can't we just remove all this if else if else else and write the next line?\nStep<Edge,Vertex> e2vStep = (Step<Edge,Vertex>) originalStep.getPreviousStep();", "url": "https://github.com/JanusGraph/janusgraph/pull/1961#discussion_r383611537", "createdAt": "2020-02-25T01:29:08Z", "author": {"login": "porunov"}, "path": "janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/AdjacentVertexOptimizerStrategy.java", "diffHunk": "@@ -0,0 +1,166 @@\n+// Copyright 2019 JanusGraph Authors\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package org.janusgraph.graphdb.tinkerpop.optimize;\n+\n+import static org.janusgraph.graphdb.types.system.ImplicitKey.ADJACENT_ID;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import org.apache.tinkerpop.gremlin.process.traversal.P;\n+import org.apache.tinkerpop.gremlin.process.traversal.Step;\n+import org.apache.tinkerpop.gremlin.process.traversal.Traversal;\n+import org.apache.tinkerpop.gremlin.process.traversal.TraversalStrategy;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.filter.FilterStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.filter.HasStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.map.EdgeOtherVertexStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.map.EdgeVertexStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.map.VertexStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.util.HasContainer;\n+import org.apache.tinkerpop.gremlin.process.traversal.strategy.AbstractTraversalStrategy;\n+import org.apache.tinkerpop.gremlin.process.traversal.util.TraversalHelper;\n+import org.apache.tinkerpop.gremlin.structure.Direction;\n+import org.apache.tinkerpop.gremlin.structure.Edge;\n+import org.apache.tinkerpop.gremlin.structure.Vertex;\n+\n+/**\n+ * @author Florian Grieskamp (Florian.Grieskamp@gdata.de)\n+ */\n+public abstract class AdjacentVertexOptimizerStrategy<T extends FilterStep<?>>\n+    extends AbstractTraversalStrategy<TraversalStrategy.ProviderOptimizationStrategy>\n+    implements TraversalStrategy.ProviderOptimizationStrategy {\n+\n+    T stepType;\n+\n+    protected enum OptimizablePosition {\n+        NONE,\n+        V2V_ID,    // vertex-to-vertex step with following filter on id\n+        V2E_E2V_ID // vertex-to-edge step with following edge-to-vertex-step and filter on id\n+    }\n+\n+    @Override\n+    public Set<Class<? extends ProviderOptimizationStrategy>> applyPost() {\n+        Set<Class<? extends ProviderOptimizationStrategy>> postStrategies = new HashSet<Class<? extends ProviderOptimizationStrategy>>();\n+        postStrategies.add(JanusGraphLocalQueryOptimizerStrategy.class);\n+        return postStrategies;\n+    }\n+\n+    protected void optimizeStep(T step) {\n+        if (isOptimizableByPredicate(step)) {\n+            OptimizablePosition pos = isOptimizableByPosition(step);\n+            P<?> predicate = parsePredicate(step);\n+            replaceSequence(step, pos, predicate);\n+        }\n+    }\n+\n+    private boolean isOptimizableByPredicate(T step) {\n+        return isValidPredicate(parsePredicate(step));\n+    }\n+\n+    protected abstract P<?> parsePredicate(T step);\n+\n+    protected abstract boolean isValidPredicate(P<?> predicate);\n+\n+    private OptimizablePosition isOptimizableByPosition(T originalStep) {\n+        Step<?, ?> predecessor = originalStep.getPreviousStep();\n+        Step<?, ?> prePredecessor = predecessor.getPreviousStep();\n+\n+        // match predecessing out(), in() or both() steps\n+        if (predecessor instanceof VertexStep<?>) {\n+            if (((VertexStep<?>) predecessor).returnsVertex()) {\n+                return OptimizablePosition.V2V_ID;\n+            }\n+            return OptimizablePosition.NONE;\n+        }\n+\n+        // match predecessing inV(), outV() or otherV() steps\n+        // predecessor has to operate on an edge type\n+        if ((predecessor instanceof EdgeVertexStep || predecessor instanceof EdgeOtherVertexStep) &&\n+            (prePredecessor instanceof VertexStep) && ((VertexStep<?>) prePredecessor).returnsEdge()) {\n+            return OptimizablePosition.V2E_E2V_ID;\n+        }\n+\n+        return OptimizablePosition.NONE;\n+    }\n+\n+    private void replaceSequence(T originalStep, OptimizablePosition pos,\n+                                   P<?> predicate) {\n+        switch (pos) {\n+        case V2E_E2V_ID:\n+            replaceSequenceV2EthenE2VthenID(originalStep, predicate);\n+            break;\n+        case V2V_ID:\n+            replaceSequenceV2VthenID(originalStep, predicate);\n+            break;\n+        default:\n+            break;\n+        }\n+    }\n+\n+    private void replaceSequenceV2EthenE2VthenID(T originalStep, P<?> predicate) {\n+        Traversal.Admin<?,?> traversal = originalStep.getTraversal();\n+\n+        Step<Edge,Vertex> e2vStep;\n+        if (originalStep.getPreviousStep() instanceof EdgeVertexStep) {\n+            e2vStep = (EdgeVertexStep) originalStep.getPreviousStep();\n+        } else if (originalStep.getPreviousStep() instanceof EdgeOtherVertexStep) {\n+            e2vStep = (EdgeOtherVertexStep) originalStep.getPreviousStep();\n+        } else {\n+            return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d5093e20c9948f926d1185e5a41d189155c6694"}, "originalPosition": 120}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYxMjY1OQ==", "bodyText": "Duplicate code can be moved to a separate method like:\nprivate HasStep<Edge> makeHasAdjacentIdStep(Traversal.Admin<?,?> traversal, P<?> predicate){\n    HasContainer hc = new HasContainer(ADJACENT_ID.name(), P.eq(predicate.getValue()));\n    return new HasStep<>(traversal, hc);\n}", "url": "https://github.com/JanusGraph/janusgraph/pull/1961#discussion_r383612659", "createdAt": "2020-02-25T01:33:21Z", "author": {"login": "porunov"}, "path": "janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/AdjacentVertexOptimizerStrategy.java", "diffHunk": "@@ -0,0 +1,166 @@\n+// Copyright 2019 JanusGraph Authors\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package org.janusgraph.graphdb.tinkerpop.optimize;\n+\n+import static org.janusgraph.graphdb.types.system.ImplicitKey.ADJACENT_ID;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import org.apache.tinkerpop.gremlin.process.traversal.P;\n+import org.apache.tinkerpop.gremlin.process.traversal.Step;\n+import org.apache.tinkerpop.gremlin.process.traversal.Traversal;\n+import org.apache.tinkerpop.gremlin.process.traversal.TraversalStrategy;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.filter.FilterStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.filter.HasStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.map.EdgeOtherVertexStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.map.EdgeVertexStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.map.VertexStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.util.HasContainer;\n+import org.apache.tinkerpop.gremlin.process.traversal.strategy.AbstractTraversalStrategy;\n+import org.apache.tinkerpop.gremlin.process.traversal.util.TraversalHelper;\n+import org.apache.tinkerpop.gremlin.structure.Direction;\n+import org.apache.tinkerpop.gremlin.structure.Edge;\n+import org.apache.tinkerpop.gremlin.structure.Vertex;\n+\n+/**\n+ * @author Florian Grieskamp (Florian.Grieskamp@gdata.de)\n+ */\n+public abstract class AdjacentVertexOptimizerStrategy<T extends FilterStep<?>>\n+    extends AbstractTraversalStrategy<TraversalStrategy.ProviderOptimizationStrategy>\n+    implements TraversalStrategy.ProviderOptimizationStrategy {\n+\n+    T stepType;\n+\n+    protected enum OptimizablePosition {\n+        NONE,\n+        V2V_ID,    // vertex-to-vertex step with following filter on id\n+        V2E_E2V_ID // vertex-to-edge step with following edge-to-vertex-step and filter on id\n+    }\n+\n+    @Override\n+    public Set<Class<? extends ProviderOptimizationStrategy>> applyPost() {\n+        Set<Class<? extends ProviderOptimizationStrategy>> postStrategies = new HashSet<Class<? extends ProviderOptimizationStrategy>>();\n+        postStrategies.add(JanusGraphLocalQueryOptimizerStrategy.class);\n+        return postStrategies;\n+    }\n+\n+    protected void optimizeStep(T step) {\n+        if (isOptimizableByPredicate(step)) {\n+            OptimizablePosition pos = isOptimizableByPosition(step);\n+            P<?> predicate = parsePredicate(step);\n+            replaceSequence(step, pos, predicate);\n+        }\n+    }\n+\n+    private boolean isOptimizableByPredicate(T step) {\n+        return isValidPredicate(parsePredicate(step));\n+    }\n+\n+    protected abstract P<?> parsePredicate(T step);\n+\n+    protected abstract boolean isValidPredicate(P<?> predicate);\n+\n+    private OptimizablePosition isOptimizableByPosition(T originalStep) {\n+        Step<?, ?> predecessor = originalStep.getPreviousStep();\n+        Step<?, ?> prePredecessor = predecessor.getPreviousStep();\n+\n+        // match predecessing out(), in() or both() steps\n+        if (predecessor instanceof VertexStep<?>) {\n+            if (((VertexStep<?>) predecessor).returnsVertex()) {\n+                return OptimizablePosition.V2V_ID;\n+            }\n+            return OptimizablePosition.NONE;\n+        }\n+\n+        // match predecessing inV(), outV() or otherV() steps\n+        // predecessor has to operate on an edge type\n+        if ((predecessor instanceof EdgeVertexStep || predecessor instanceof EdgeOtherVertexStep) &&\n+            (prePredecessor instanceof VertexStep) && ((VertexStep<?>) prePredecessor).returnsEdge()) {\n+            return OptimizablePosition.V2E_E2V_ID;\n+        }\n+\n+        return OptimizablePosition.NONE;\n+    }\n+\n+    private void replaceSequence(T originalStep, OptimizablePosition pos,\n+                                   P<?> predicate) {\n+        switch (pos) {\n+        case V2E_E2V_ID:\n+            replaceSequenceV2EthenE2VthenID(originalStep, predicate);\n+            break;\n+        case V2V_ID:\n+            replaceSequenceV2VthenID(originalStep, predicate);\n+            break;\n+        default:\n+            break;\n+        }\n+    }\n+\n+    private void replaceSequenceV2EthenE2VthenID(T originalStep, P<?> predicate) {\n+        Traversal.Admin<?,?> traversal = originalStep.getTraversal();\n+\n+        Step<Edge,Vertex> e2vStep;\n+        if (originalStep.getPreviousStep() instanceof EdgeVertexStep) {\n+            e2vStep = (EdgeVertexStep) originalStep.getPreviousStep();\n+        } else if (originalStep.getPreviousStep() instanceof EdgeOtherVertexStep) {\n+            e2vStep = (EdgeOtherVertexStep) originalStep.getPreviousStep();\n+        } else {\n+            return;\n+        }\n+\n+        // create new has(\"~adjacent\", id_value) step before e2v step\n+        HasContainer hc = new HasContainer(ADJACENT_ID.name(), P.eq(predicate.getValue()));\n+        HasStep<Edge> hasAdjacentIdStep = new HasStep<Edge>(traversal, hc);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d5093e20c9948f926d1185e5a41d189155c6694"}, "originalPosition": 125}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYxNDc2NQ==", "bodyText": "Redundant type cast", "url": "https://github.com/JanusGraph/janusgraph/pull/1961#discussion_r383614765", "createdAt": "2020-02-25T01:42:05Z", "author": {"login": "porunov"}, "path": "janusgraph-core/src/main/java/org/janusgraph/graphdb/tinkerpop/optimize/AdjacentVertexHasIdOptimizerStrategy.java", "diffHunk": "@@ -0,0 +1,76 @@\n+// Copyright 2019 JanusGraph Authors\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package org.janusgraph.graphdb.tinkerpop.optimize;\n+\n+import java.util.List;\n+import org.apache.tinkerpop.gremlin.process.traversal.Compare;\n+import org.apache.tinkerpop.gremlin.process.traversal.P;\n+import org.apache.tinkerpop.gremlin.process.traversal.Traversal;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.filter.HasStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.util.HasContainer;\n+import org.apache.tinkerpop.gremlin.process.traversal.util.TraversalHelper;\n+import org.apache.tinkerpop.gremlin.structure.T;\n+import org.apache.tinkerpop.gremlin.structure.Vertex;\n+\n+/**\n+ * @author Florian Grieskamp (Florian.Grieskamp@gdata.de)\n+ */\n+public class AdjacentVertexHasIdOptimizerStrategy\n+    extends AdjacentVertexOptimizerStrategy<HasStep<?>> {\n+\n+    private static final AdjacentVertexHasIdOptimizerStrategy INSTANCE =\n+        new AdjacentVertexHasIdOptimizerStrategy();\n+\n+    private AdjacentVertexHasIdOptimizerStrategy() {}\n+\n+    public static AdjacentVertexHasIdOptimizerStrategy instance() { return INSTANCE; }\n+\n+    @Override\n+    public void apply(final Traversal.Admin<?, ?> traversal) {\n+        TraversalHelper.getStepsOfClass(HasStep.class, traversal)\n+            .forEach(step -> optimizeStep(step));\n+    }\n+\n+    @Override\n+    protected P<?> parsePredicate(HasStep<?> hasStep) {\n+        List<HasContainer> hasContainers = hasStep.getHasContainers();\n+\n+        if (hasContainers.size() != 1) {\n+            return null; // TODO does it make sense to allow steps with >1 containers here?\n+        }\n+\n+        HasContainer hc = (HasContainer) hasStep.getHasContainers().get(0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d5093e20c9948f926d1185e5a41d189155c6694"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYyNzIyMw==", "bodyText": "Why don't you use ImplicitKey.ADJACENT_ID here but use ~adjacent?", "url": "https://github.com/JanusGraph/janusgraph/pull/1961#discussion_r383627223", "createdAt": "2020-02-25T02:31:27Z", "author": {"login": "porunov"}, "path": "janusgraph-backend-testutils/src/main/java/org/janusgraph/graphdb/JanusGraphTest.java", "diffHunk": "@@ -4110,6 +4121,80 @@ public void testTinkerPopOptimizationStrategies() {\n         assertNumStep(1, 1, gts.V(sv[0]).bothE(\"knows\").filter(__.otherV().hasId(vs[50].id())), JanusGraphVertexStep.class, TraversalFilterStep.class);\n         assertNumStep(1, 2, gts.V(sv[0]).bothE(\"knows\").filter(__.inV().hasId(vs[50].id())), JanusGraphVertexStep.class, TraversalFilterStep.class);\n \n+        // AdjacentVertexIsOptimizer outE/inE/bothE\n+        assertOptimization(gts.V(sv[0]).outE(\"knows\").has(ImplicitKey.ADJACENT_ID.name(), vs[50]).inV(),\n+                           gts.V(sv[0]).outE(\"knows\").inV().is(vs[50]),\n+                           AdjacentVertexIsOptimizerStrategy.instance());\n+        assertOptimization(gts.V(sv[0]).inE(\"knows\").has(ImplicitKey.ADJACENT_ID.name(), vs[50]).outV(),\n+                           gts.V(sv[0]).inE(\"knows\").outV().is(vs[50]),\n+                           AdjacentVertexIsOptimizerStrategy.instance());\n+        assertOptimization(gts.V(sv[0]).bothE(\"knows\").has(ImplicitKey.ADJACENT_ID.name(), vs[50]).otherV(),\n+                           gts.V(sv[0]).bothE(\"knows\").otherV().is(vs[50]),\n+                           AdjacentVertexIsOptimizerStrategy.instance());\n+\n+        // AdjacentVertexIsOptimizer out/in/both\n+        assertOptimization(gts.V(sv[0]).outE(\"knows\").has(ImplicitKey.ADJACENT_ID.name(), vs[50]).inV(),\n+                           gts.V(sv[0]).out(\"knows\").is(vs[50]),\n+                           AdjacentVertexIsOptimizerStrategy.instance());\n+        assertOptimization(gts.V(sv[0]).inE(\"knows\").has(ImplicitKey.ADJACENT_ID.name(), vs[50]).outV(),\n+                           gts.V(sv[0]).in(\"knows\").is(vs[50]),\n+                           AdjacentVertexIsOptimizerStrategy.instance());\n+        assertOptimization(gts.V(sv[0]).bothE(\"knows\").has(ImplicitKey.ADJACENT_ID.name(), vs[50]).otherV(),\n+                           gts.V(sv[0]).both(\"knows\").is(vs[50]),\n+                           AdjacentVertexIsOptimizerStrategy.instance());\n+\n+        // AdjacentVertexHasIdOptimizer outE/inE/bothE\n+        assertOptimization(gts.V(sv[0]).outE(\"knows\").has(ImplicitKey.ADJACENT_ID.name(), vs[50]).inV(),\n+                           gts.V(sv[0]).outE(\"knows\").inV().hasId(vs[50]),\n+                           AdjacentVertexHasIdOptimizerStrategy.instance());\n+        assertOptimization(gts.V(sv[0]).inE(\"knows\").has(ImplicitKey.ADJACENT_ID.name(), vs[50]).outV(),\n+                           gts.V(sv[0]).inE(\"knows\").outV().hasId(vs[50]),\n+                           AdjacentVertexHasIdOptimizerStrategy.instance());\n+        assertOptimization(gts.V(sv[0]).bothE(\"knows\").has(ImplicitKey.ADJACENT_ID.name(), vs[50]).otherV(),\n+                           gts.V(sv[0]).bothE(\"knows\").otherV().hasId(vs[50]),\n+                           AdjacentVertexHasIdOptimizerStrategy.instance());\n+\n+        // AdjacentVertexHasIdOptimizer out/in/both\n+        assertOptimization(gts.V(sv[0]).outE(\"knows\").has(ImplicitKey.ADJACENT_ID.name(), vs[50]).inV(),\n+                           gts.V(sv[0]).out(\"knows\").hasId(vs[50]),\n+                           AdjacentVertexHasIdOptimizerStrategy.instance());\n+        assertOptimization(gts.V(sv[0]).inE(\"knows\").has(ImplicitKey.ADJACENT_ID.name(), vs[50]).outV(),\n+                           gts.V(sv[0]).in(\"knows\").hasId(vs[50]),\n+                           AdjacentVertexHasIdOptimizerStrategy.instance());\n+        assertOptimization(gts.V(sv[0]).bothE(\"knows\").has(ImplicitKey.ADJACENT_ID.name(), vs[50]).otherV(),\n+                           gts.V(sv[0]).both(\"knows\").hasId(vs[50]),\n+                           AdjacentVertexHasIdOptimizerStrategy.instance());\n+\n+        // neq should not be optimized\n+        assertOptimization(gts.V(sv[0]).in().hasId(P.neq(vs[50])),\n+                           gts.V(sv[0]).in().hasId(P.neq(vs[50])),\n+                           AdjacentVertexHasIdOptimizerStrategy.instance());\n+\n+        int[] loop1 = {0}; // repeat starts from vertex with id 0 and goes in to the sv[0] vertex then loops back out to the vertex with the next id\n+        int[] loop2 = {0};\n+        GraphTraversal t1 = gts.V(vs[0], vs[1], vs[2])\n+                           .repeat(__.inE(\"knows\")\n+                                       .has(\"~adjacent\", sv[0].id())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d5093e20c9948f926d1185e5a41d189155c6694"}, "originalPosition": 260}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8d5093e20c9948f926d1185e5a41d189155c6694", "author": {"user": {"login": "rngcntr", "name": null}}, "url": "https://github.com/JanusGraph/janusgraph/commit/8d5093e20c9948f926d1185e5a41d189155c6694", "committedDate": "2020-02-24T14:19:23Z", "message": "Apply optimizations to queries to make use of adjacent ids\n\nSigned-off-by: Florian Grieskamp <florian.grieskamp@gdata.de>"}, "afterCommit": {"oid": "422a8409a5820747584c8186aea38feb5642c544", "author": {"user": {"login": "rngcntr", "name": null}}, "url": "https://github.com/JanusGraph/janusgraph/commit/422a8409a5820747584c8186aea38feb5642c544", "committedDate": "2020-02-25T06:14:39Z", "message": "Apply optimizations to queries to make use of adjacent ids\n\nSigned-off-by: Florian Grieskamp <florian.grieskamp@gdata.de>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f7af8db0cfa9923fc45eeddbc01a8aa89c6f5f8", "author": {"user": {"login": "rngcntr", "name": null}}, "url": "https://github.com/JanusGraph/janusgraph/commit/0f7af8db0cfa9923fc45eeddbc01a8aa89c6f5f8", "committedDate": "2020-02-25T13:38:10Z", "message": "Apply optimizations to queries to make use of adjacent ids\n\nSigned-off-by: Florian Grieskamp <florian.grieskamp@gdata.de>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "422a8409a5820747584c8186aea38feb5642c544", "author": {"user": {"login": "rngcntr", "name": null}}, "url": "https://github.com/JanusGraph/janusgraph/commit/422a8409a5820747584c8186aea38feb5642c544", "committedDate": "2020-02-25T06:14:39Z", "message": "Apply optimizations to queries to make use of adjacent ids\n\nSigned-off-by: Florian Grieskamp <florian.grieskamp@gdata.de>"}, "afterCommit": {"oid": "0f7af8db0cfa9923fc45eeddbc01a8aa89c6f5f8", "author": {"user": {"login": "rngcntr", "name": null}}, "url": "https://github.com/JanusGraph/janusgraph/commit/0f7af8db0cfa9923fc45eeddbc01a8aa89c6f5f8", "committedDate": "2020-02-25T13:38:10Z", "message": "Apply optimizations to queries to make use of adjacent ids\n\nSigned-off-by: Florian Grieskamp <florian.grieskamp@gdata.de>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0MjUzOTE5", "url": "https://github.com/JanusGraph/janusgraph/pull/1961#pullrequestreview-364253919", "createdAt": "2020-02-25T15:52:05Z", "commit": {"oid": "0f7af8db0cfa9923fc45eeddbc01a8aa89c6f5f8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3Nzk0MTU1", "url": "https://github.com/JanusGraph/janusgraph/pull/1961#pullrequestreview-367794155", "createdAt": "2020-03-03T08:52:29Z", "commit": {"oid": "0f7af8db0cfa9923fc45eeddbc01a8aa89c6f5f8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4817, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}