{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzNTkzMjY1", "number": 2244, "title": "Bug fixes: relations cannot be removed after update", "bodyText": "This commit includes fixes for three bugs:\n\n\nCaused by the optimization in StandardJanusGraphTx::addProperty, which saves a database\nread (and delete) operation for vertex property upsert. If a vertex property (or the vertex\nas a whole) is removed after the property is modified in the same transaction, then the old\nvalue in database will not be deleted after the transaction commits. Reported by #1981.\n\n\nCaused by CacheVertexProperty::remove method which does nothing if it finds the given\nvertex property is already in the deletedRelations map. If the user deletes a vertex property\nafter they update a nested property of that vertex property in the same transaction, then\nthe old value will be removed from database but the new value will be saved into database\nafter the transaction commits.\n\n\nCaused by CacheEdge::remove method which does nothing if it finds the given edge is\nalready in the deletedRelations map. If the user deletes an edge after they update a property\nof that edge in the same transaction, then the old value will be removed from database but the\nnew value will be saved into database after the transaction commits.\n\n\n\nThank you for contributing to JanusGraph!\nIn order to streamline the review of the contribution we ask you\nto ensure the following steps have been taken:\nFor all changes:\n\n Is there an issue associated with this PR? Is it referenced in the commit message?\n Does your PR body contain #xyz where xyz is the issue number you are trying to resolve?\n Has your PR been rebased against the latest commit within the target branch (typically master)?\n Is your initial contribution a single, squashed commit?\n\nFor code changes:\n\n Have you written and/or updated unit tests to verify your changes?\n If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under ASF 2.0?\n If applicable, have you updated the LICENSE.txt file, including the main LICENSE.txt file in the root of this repository?\n If applicable, have you updated the NOTICE.txt file, including the main NOTICE.txt file found in the root of this repository?\n\nFor documentation related changes:\n\n Have you ensured that format looks appropriate for the output in which it is rendered?\n If this PR is a documentation-only change, have you added a [doc only]\ntag to the first line of your commit message to avoid spending CPU cycles in\nTravis CI when no code, tests, or build configuration are modified?\n\nNote:\nPlease ensure that once the PR is submitted, you check Travis CI for build issues and submit an update to your PR as soon as possible.", "createdAt": "2020-11-01T10:13:30Z", "url": "https://github.com/JanusGraph/janusgraph/pull/2244", "merged": true, "mergeCommit": {"oid": "a22a62e01271d1e3bdeeb6f698a3a3fed641a7c1"}, "closed": true, "closedAt": "2020-11-13T12:04:31Z", "author": {"login": "li-boxuan"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdagaHMgBqjM5NzA3NjM2Nzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdb0Wr7AFqTUyOTIwNzc4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "90da3d93f721565235ad5cb0838ce6db4a19b4ab", "author": {"user": {"login": "li-boxuan", "name": "Boxuan Li"}}, "url": "https://github.com/JanusGraph/janusgraph/commit/90da3d93f721565235ad5cb0838ce6db4a19b4ab", "committedDate": "2020-11-01T04:07:26Z", "message": "Fix property removal after update bug\n\nFixes #1981\n\nSigned-off-by: Boxuan Li <liboxuan@connect.hku.hk>"}, "afterCommit": {"oid": "d786c0c3ec0c0e8f138d0f62ff0d4a27efb15c7a", "author": {"user": {"login": "li-boxuan", "name": "Boxuan Li"}}, "url": "https://github.com/JanusGraph/janusgraph/commit/d786c0c3ec0c0e8f138d0f62ff0d4a27efb15c7a", "committedDate": "2020-11-08T13:44:34Z", "message": "Bug fixes: relations cannot be removed after update\n\nThis commit includes fixes for three bugs:\n\n1) Caused by the optimization in StandardJanusGraphTx::addProperty, which saves a database\nread (and delete) operation for vertex property upsert. If a vertex property (or the vertex\nas a whole) is removed after the property is modified in the same transaction, then the old\nvalue in database will not be deleted after the transaction commits. Reported by #1981.\n\n2) Caused by CacheVertexProperty::remove method which does nothing if it finds the given\nvertex property is already in the deletedRelations map. If the user deletes a vertex property\nafter they update a nested property of that vertex property in the same transaction, then\nthe old value will be removed from database but the new value will be saved into database\nafter the transaction commits.\n\n3) Caused by CacheEdge::remove method which does nothing if it finds the given edge is\nalready in the deletedRelations map. If the user deletes an edge after they update a property\nof that edge in the same transaction, then the old value will be removed from database but the\nnew value will be saved into database after the transaction commits.\n\nSigned-off-by: Boxuan Li <liboxuan@connect.hku.hk>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1ODA5Mzg0", "url": "https://github.com/JanusGraph/janusgraph/pull/2244#pullrequestreview-525809384", "createdAt": "2020-11-08T13:46:15Z", "commit": {"oid": "d786c0c3ec0c0e8f138d0f62ff0d4a27efb15c7a"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQxMzo0NjoxNVrOHvV44A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQxMzo1NjowMFrOHvWC6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQwMzc0NA==", "bodyText": "This is just a variable renaming as the old name does not make much sense.", "url": "https://github.com/JanusGraph/janusgraph/pull/2244#discussion_r519403744", "createdAt": "2020-11-08T13:46:15Z", "author": {"login": "li-boxuan"}, "path": "janusgraph-core/src/main/java/org/janusgraph/graphdb/relations/CacheEdge.java", "diffHunk": "@@ -62,10 +62,10 @@ public InternalRelation it() {\n         if (startVertex.hasAddedRelations() && startVertex.hasRemovedRelations()) {\n             //Test whether this relation has been replaced\n             final long id = super.longId();\n-            final Iterable<InternalRelation> previous = startVertex.getAddedRelations(\n+            final Iterable<InternalRelation> added = startVertex.getAddedRelations(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d786c0c3ec0c0e8f138d0f62ff0d4a27efb15c7a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQwNTIzNw==", "bodyText": "This is bug fix (3):\n\nIf the user deletes an edge after they update a property of that edge in the same transaction, then the old value will be removed from database but the new value will be saved into database after the transaction commits.\n\nThis is because after they update the property, the old edge will be marked as deleted in the deletedRelations map. Afterward, when they trigger an edge delete operation, JanusGraph wrongly finds the edge was already marked as \"deleted\" and simply ignores.\nCorresponding tests:\n\ntestUpdateEdgePropertyThenRemoveEdge\ntestUpdateForkEdgePropertyThenRemoveEdge", "url": "https://github.com/JanusGraph/janusgraph/pull/2244#discussion_r519405237", "createdAt": "2020-11-08T13:51:48Z", "author": {"login": "li-boxuan"}, "path": "janusgraph-core/src/main/java/org/janusgraph/graphdb/relations/CacheEdge.java", "diffHunk": "@@ -139,7 +138,7 @@ public byte getLifeCycle() {\n \n     @Override\n     public void remove() {\n-        if (!tx().isRemovedRelation(super.longId())) {\n+        if (!isRemoved()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d786c0c3ec0c0e8f138d0f62ff0d4a27efb15c7a"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQwNTU5Nw==", "bodyText": "This is bug fix (2):\n\nIf the user deletes a vertex property after they update a nested property of that vertex property in the same transaction, then the old value will be removed from database but the new value will be saved into database after the transaction commits.\n\nThis is because after they update the nested property (property of a property), the old vertex property will be marked as deleted in the deletedRelations map. Afterward, when they trigger a vertex property delete operation, JanusGraph wrongly finds the vertex property was already marked as \"deleted\" and simply ignores.\nCorresponding test:\n\ntestUpdatePropertyPropThenRemovePropertyProp\ntestUpdatePropertyPropThenRemoveProperty", "url": "https://github.com/JanusGraph/janusgraph/pull/2244#discussion_r519405597", "createdAt": "2020-11-08T13:53:10Z", "author": {"login": "li-boxuan"}, "path": "janusgraph-core/src/main/java/org/janusgraph/graphdb/relations/CacheVertexProperty.java", "diffHunk": "@@ -121,7 +121,7 @@ public byte getLifeCycle() {\n \n     @Override\n     public void remove() {\n-        if (!tx().isRemovedRelation(longId())) {\n+        if (!isRemoved()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d786c0c3ec0c0e8f138d0f62ff0d4a27efb15c7a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQwNjMxNA==", "bodyText": "This, together with changes in StandardJanusGraphTx.java, is to fix bug (1):\n\nCaused by the optimization in StandardJanusGraphTx::addProperty, which saves a database read (and delete) operation for vertex property upsert. If a vertex property (or the vertex as a whole) is removed after the property is modified in the same transaction, then the old value in database will not be deleted after the transaction commits. Reported by #1981.\n\nThe idea is to defer the delete operation until an explicit removal operation is fired. To achieve so, we mark the new vertex property as \"upsert\" so that we know we haven't removed the old value yet.\nCorresponding test cases:\n\ntestUpdateVertexPropThenRemoveProp\ntestUpdateVertexPropThenRemoveVertex", "url": "https://github.com/JanusGraph/janusgraph/pull/2244#discussion_r519406314", "createdAt": "2020-11-08T13:56:00Z", "author": {"login": "li-boxuan"}, "path": "janusgraph-core/src/main/java/org/janusgraph/graphdb/relations/StandardVertexProperty.java", "diffHunk": "@@ -101,6 +114,11 @@ public synchronized void remove() {\n         if (!ElementLifeCycle.isRemoved(lifecycle)) {\n             tx().removeRelation(this);\n             lifecycle = ElementLifeCycle.update(lifecycle, ElementLifeCycle.Event.REMOVED);\n+            if (isUpsert) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d786c0c3ec0c0e8f138d0f62ff0d4a27efb15c7a"}, "originalPosition": 48}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d786c0c3ec0c0e8f138d0f62ff0d4a27efb15c7a", "author": {"user": {"login": "li-boxuan", "name": "Boxuan Li"}}, "url": "https://github.com/JanusGraph/janusgraph/commit/d786c0c3ec0c0e8f138d0f62ff0d4a27efb15c7a", "committedDate": "2020-11-08T13:44:34Z", "message": "Bug fixes: relations cannot be removed after update\n\nThis commit includes fixes for three bugs:\n\n1) Caused by the optimization in StandardJanusGraphTx::addProperty, which saves a database\nread (and delete) operation for vertex property upsert. If a vertex property (or the vertex\nas a whole) is removed after the property is modified in the same transaction, then the old\nvalue in database will not be deleted after the transaction commits. Reported by #1981.\n\n2) Caused by CacheVertexProperty::remove method which does nothing if it finds the given\nvertex property is already in the deletedRelations map. If the user deletes a vertex property\nafter they update a nested property of that vertex property in the same transaction, then\nthe old value will be removed from database but the new value will be saved into database\nafter the transaction commits.\n\n3) Caused by CacheEdge::remove method which does nothing if it finds the given edge is\nalready in the deletedRelations map. If the user deletes an edge after they update a property\nof that edge in the same transaction, then the old value will be removed from database but the\nnew value will be saved into database after the transaction commits.\n\nSigned-off-by: Boxuan Li <liboxuan@connect.hku.hk>"}, "afterCommit": {"oid": "eced709bef5ac83c6b9f10321202af2790d8a3f8", "author": {"user": {"login": "li-boxuan", "name": "Boxuan Li"}}, "url": "https://github.com/JanusGraph/janusgraph/commit/eced709bef5ac83c6b9f10321202af2790d8a3f8", "committedDate": "2020-11-09T15:44:42Z", "message": "Bug fixes: relations cannot be removed after update\n\nThis commit includes fixes for three bugs:\n\n1) Caused by the optimization in StandardJanusGraphTx::addProperty, which saves a database\nread (and delete) operation for vertex property upsert. If a vertex property (or the vertex\nas a whole) is removed after the property is modified in the same transaction, then the old\nvalue in database will not be deleted after the transaction commits. Reported by #1981.\n\n2) Caused by CacheVertexProperty::remove method which does nothing if it finds the given\nvertex property is already in the deletedRelations map. If the user deletes a vertex property\nafter they update a nested property of that vertex property in the same transaction, then\nthe old value will be removed from database but the new value will be saved into database\nafter the transaction commits.\n\n3) Caused by CacheEdge::remove method which does nothing if it finds the given edge is\nalready in the deletedRelations map. If the user deletes an edge after they update a property\nof that edge in the same transaction, then the old value will be removed from database but the\nnew value will be saved into database after the transaction commits.\n\nSigned-off-by: Boxuan Li <liboxuan@connect.hku.hk>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NTIyNDY5", "url": "https://github.com/JanusGraph/janusgraph/pull/2244#pullrequestreview-526522469", "createdAt": "2020-11-09T18:11:35Z", "commit": {"oid": "eced709bef5ac83c6b9f10321202af2790d8a3f8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxODoxMTozNVrOHv7UOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxODoxMTozNVrOHv7UOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAxNjk1NA==", "bodyText": "I don't know much about how lambda are compiled but if it is changed to new Consumer<JanusGraphVertexProperty> {....} shouldn't this consumer be static? I don't think we need to create a new instance of this consumer because it doesn't reuse any other parameters.\nI.e., I think it would be better to create a static consumer like:\nprivate static final Consumer<JanusGraphVertexProperty> SINGLE_PROPERTY_REMOVER_CONSUMER = JanusGraphElement::remove; \n\nand reuse SINGLE_PROPERTY_REMOVER_CONSUMER here. That said, if you know that JanusGraphElement::remove will be compiled to static consumer, I'm totally good with it.", "url": "https://github.com/JanusGraph/janusgraph/pull/2244#discussion_r520016954", "createdAt": "2020-11-09T18:11:35Z", "author": {"login": "porunov"}, "path": "janusgraph-core/src/main/java/org/janusgraph/core/JanusGraphVertexProperty.java", "diffHunk": "@@ -45,4 +47,16 @@ default PropertyKey propertyKey() {\n         return (PropertyKey)getType();\n     }\n \n+    static Consumer<JanusGraphVertexProperty> getRemover(VertexProperty.Cardinality cardinality, Object value) {\n+        if (cardinality == VertexProperty.Cardinality.single) {\n+            return JanusGraphElement::remove;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eced709bef5ac83c6b9f10321202af2790d8a3f8"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NDgyMTMx", "url": "https://github.com/JanusGraph/janusgraph/pull/2244#pullrequestreview-528482131", "createdAt": "2020-11-11T19:44:17Z", "commit": {"oid": "eced709bef5ac83c6b9f10321202af2790d8a3f8"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxOTo0NDoxN1rOHxbv6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMDoxNzoyOFrOHxcyFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU5NjkwNw==", "bodyText": "Just thinking. Do you know if we need to set upsert to true when a property is new? I.e. ElementLifeCycle.isNew(prop.getLifeCycle())?\nI guess, in case we don't set upsert to true when the property is New we may have a problem when we are adding the property in Transaction-1, adding the property in Transaction-2, committing Transaction-1, removing the property in Transaction-2, committing Transaction-2. In such case, I guess we will not check the property from Database in Transaction-2 and thus, we will not remove the property which was committed in Transaction-1.\nThat said, I'm not sure about it and not sure if we need to worry about this use-case at all, so I decided to ask your thoughts.", "url": "https://github.com/JanusGraph/janusgraph/pull/2244#discussion_r521596907", "createdAt": "2020-11-11T19:44:17Z", "author": {"login": "porunov"}, "path": "janusgraph-core/src/main/java/org/janusgraph/graphdb/transaction/StandardJanusGraphTx.java", "diffHunk": "@@ -816,7 +815,10 @@ public JanusGraphVertexProperty addProperty(VertexProperty.Cardinality cardinali\n                 if ( (!config.hasVerifyUniqueness() || ((InternalRelationType)key).getConsistencyModifier()!=ConsistencyModifier.LOCK) &&\n                         !TypeUtil.hasAnyIndex(key) && cardinality==keyCardinality.convert()) {\n                     //Only delete in-memory so as to not trigger a read from the database which isn't necessary because we will overwrite blindly\n-                    ((InternalVertex) vertex).getAddedRelations(p -> p.getType().equals(key)).forEach(propertyRemover);\n+                    //We need to label the new property as \"upsert\", so that in case property deletion happens, we not only delete this new\n+                    //in-memory property, but also read from database to delete the old value (if exists)\n+                    ((InternalVertex) vertex).getAddedRelations(p -> p.getType().equals(key)).forEach(p -> propertyRemover.accept((JanusGraphVertexProperty) p));\n+                    prop.setUpsert(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eced709bef5ac83c6b9f10321202af2790d8a3f8"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTYwNTE2Mw==", "bodyText": "Why did you move this logic from bottom to up?", "url": "https://github.com/JanusGraph/janusgraph/pull/2244#discussion_r521605163", "createdAt": "2020-11-11T20:00:18Z", "author": {"login": "porunov"}, "path": "janusgraph-core/src/main/java/org/janusgraph/graphdb/transaction/StandardJanusGraphTx.java", "diffHunk": "@@ -798,14 +798,13 @@ public JanusGraphVertexProperty addProperty(VertexProperty.Cardinality cardinali\n //                }\n //            }\n \n+            long propId = id == null ? IDManager.getTemporaryRelationID(temporaryIds.nextID()) : id;\n+            StandardVertexProperty prop = new StandardVertexProperty(propId, key, (InternalVertex) vertex, normalizedValue, ElementLifeCycle.New);\n+            if (config.hasAssignIDsImmediately() && id == null) graph.assignID(prop);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eced709bef5ac83c6b9f10321202af2790d8a3f8"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTYxMzg0NQ==", "bodyText": "I'm good with getVertex(0) but maybe it's better to use element()?", "url": "https://github.com/JanusGraph/janusgraph/pull/2244#discussion_r521613845", "createdAt": "2020-11-11T20:17:28Z", "author": {"login": "porunov"}, "path": "janusgraph-core/src/main/java/org/janusgraph/graphdb/relations/StandardVertexProperty.java", "diffHunk": "@@ -101,6 +114,11 @@ public synchronized void remove() {\n         if (!ElementLifeCycle.isRemoved(lifecycle)) {\n             tx().removeRelation(this);\n             lifecycle = ElementLifeCycle.update(lifecycle, ElementLifeCycle.Event.REMOVED);\n+            if (isUpsert) {\n+                VertexProperty.Cardinality cardinality = ((PropertyKey) type).cardinality().convert();\n+                Consumer<JanusGraphVertexProperty> propertyRemover = JanusGraphVertexProperty.getRemover(cardinality, value());\n+                getVertex(0).query().types(type.name()).properties().forEach(propertyRemover);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eced709bef5ac83c6b9f10321202af2790d8a3f8"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96bdde59bd4cbadd79c085685036b72097f3fe44", "author": {"user": {"login": "li-boxuan", "name": "Boxuan Li"}}, "url": "https://github.com/JanusGraph/janusgraph/commit/96bdde59bd4cbadd79c085685036b72097f3fe44", "committedDate": "2020-11-12T15:17:23Z", "message": "Bug fixes: relations cannot be removed after update\n\nThis commit includes fixes for three bugs:\n\n1) Caused by the optimization in StandardJanusGraphTx::addProperty, which saves a database\nread (and delete) operation for vertex property upsert. If a vertex property (or the vertex\nas a whole) is removed after the property is modified in the same transaction, then the old\nvalue in database will not be deleted after the transaction commits. Reported by #1981.\n\n2) Caused by CacheVertexProperty::remove method which does nothing if it finds the given\nvertex property is already in the deletedRelations map. If the user deletes a vertex property\nafter they update a nested property of that vertex property in the same transaction, then\nthe old value will be removed from database but the new value will be saved into database\nafter the transaction commits.\n\n3) Caused by CacheEdge::remove method which does nothing if it finds the given edge is\nalready in the deletedRelations map. If the user deletes an edge after they update a property\nof that edge in the same transaction, then the old value will be removed from database but the\nnew value will be saved into database after the transaction commits.\n\nSigned-off-by: Boxuan Li <liboxuan@connect.hku.hk>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eced709bef5ac83c6b9f10321202af2790d8a3f8", "author": {"user": {"login": "li-boxuan", "name": "Boxuan Li"}}, "url": "https://github.com/JanusGraph/janusgraph/commit/eced709bef5ac83c6b9f10321202af2790d8a3f8", "committedDate": "2020-11-09T15:44:42Z", "message": "Bug fixes: relations cannot be removed after update\n\nThis commit includes fixes for three bugs:\n\n1) Caused by the optimization in StandardJanusGraphTx::addProperty, which saves a database\nread (and delete) operation for vertex property upsert. If a vertex property (or the vertex\nas a whole) is removed after the property is modified in the same transaction, then the old\nvalue in database will not be deleted after the transaction commits. Reported by #1981.\n\n2) Caused by CacheVertexProperty::remove method which does nothing if it finds the given\nvertex property is already in the deletedRelations map. If the user deletes a vertex property\nafter they update a nested property of that vertex property in the same transaction, then\nthe old value will be removed from database but the new value will be saved into database\nafter the transaction commits.\n\n3) Caused by CacheEdge::remove method which does nothing if it finds the given edge is\nalready in the deletedRelations map. If the user deletes an edge after they update a property\nof that edge in the same transaction, then the old value will be removed from database but the\nnew value will be saved into database after the transaction commits.\n\nSigned-off-by: Boxuan Li <liboxuan@connect.hku.hk>"}, "afterCommit": {"oid": "96bdde59bd4cbadd79c085685036b72097f3fe44", "author": {"user": {"login": "li-boxuan", "name": "Boxuan Li"}}, "url": "https://github.com/JanusGraph/janusgraph/commit/96bdde59bd4cbadd79c085685036b72097f3fe44", "committedDate": "2020-11-12T15:17:23Z", "message": "Bug fixes: relations cannot be removed after update\n\nThis commit includes fixes for three bugs:\n\n1) Caused by the optimization in StandardJanusGraphTx::addProperty, which saves a database\nread (and delete) operation for vertex property upsert. If a vertex property (or the vertex\nas a whole) is removed after the property is modified in the same transaction, then the old\nvalue in database will not be deleted after the transaction commits. Reported by #1981.\n\n2) Caused by CacheVertexProperty::remove method which does nothing if it finds the given\nvertex property is already in the deletedRelations map. If the user deletes a vertex property\nafter they update a nested property of that vertex property in the same transaction, then\nthe old value will be removed from database but the new value will be saved into database\nafter the transaction commits.\n\n3) Caused by CacheEdge::remove method which does nothing if it finds the given edge is\nalready in the deletedRelations map. If the user deletes an edge after they update a property\nof that edge in the same transaction, then the old value will be removed from database but the\nnew value will be saved into database after the transaction commits.\n\nSigned-off-by: Boxuan Li <liboxuan@connect.hku.hk>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5MjA3Nzg3", "url": "https://github.com/JanusGraph/janusgraph/pull/2244#pullrequestreview-529207787", "createdAt": "2020-11-12T15:33:02Z", "commit": {"oid": "96bdde59bd4cbadd79c085685036b72097f3fe44"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4658, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}