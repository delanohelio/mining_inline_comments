{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3Nzg4MzU5", "number": 1119, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMzowMDowOVrOESzLMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMDowMjo0N1rOETL0rQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MTQ4MjcyOnYy", "diffSide": "RIGHT", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/StandardHugeGraph.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMzowMDowOVrOG4LXkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMzowMDowOVrOG4LXkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU1OTY5Ng==", "bodyText": "improve", "url": "https://github.com/hugegraph/hugegraph/pull/1119#discussion_r461559696", "createdAt": "2020-07-28T13:00:09Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/StandardHugeGraph.java", "diffHunk": "@@ -366,7 +367,15 @@ private GraphTransaction graphTransaction() {\n     }\n \n     private BackendStoreProvider loadStoreProvider() {\n-        return BackendProviderFactory.open(this.configuration);\n+        BackendStoreProvider provider;\n+        provider = BackendProviderFactory.open(this.configuration);\n+        if (provider instanceof RaftBackendStoreProvider) {\n+            RaftBackendStoreProvider raftProvider =\n+                    (RaftBackendStoreProvider) provider;\n+            raftProvider.injectEventHub(this.params.schemaEventHub(),\n+                                        this.params.graphEventHub());\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1dbaffe86b5b8d975d0dd47870116cce74190aea"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MTc5OTI3OnYy", "diffSide": "RIGHT", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftNode.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNDowOTo1OVrOG4OcCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNDowOTo1OVrOG4OcCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYwOTk5Mg==", "bodyText": "set protected", "url": "https://github.com/hugegraph/hugegraph/pull/1119#discussion_r461609992", "createdAt": "2020-07-28T14:09:59Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftNode.java", "diffHunk": "@@ -199,7 +138,7 @@ public Object submitAndWait(StoreCommand command, StoreClosure closure) {\n         }\n     }\n \n-    private void waitLeaderElected() {\n+    public void waitLeaderElected() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2312d93677e8982cf625129df139c7373e822ef8"}, "originalPosition": 124}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MTgwOTQwOnYy", "diffSide": "RIGHT", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftSharedContext.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNDoxMjowNlrOG4OiRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNDoxMjowNlrOG4OiRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYxMTU5MA==", "bodyText": "rename", "url": "https://github.com/hugegraph/hugegraph/pull/1119#discussion_r461611590", "createdAt": "2020-07-28T14:12:06Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftSharedContext.java", "diffHunk": "@@ -95,6 +105,82 @@ public void addNode(String group, BackendStore store) {\n         }\n     }\n \n+    public NodeOptions nodeOptions(String storePath) throws IOException {\n+        HugeConfig config = this.config();\n+        PeerId selfId = new PeerId();\n+        selfId.parse(config.get(CoreOptions.RAFT_ENDPOINT));\n+\n+        NodeOptions nodeOptions = new NodeOptions();\n+        int electionTimeout = config.get(CoreOptions.RAFT_ELECTION_TIMEOUT);\n+        nodeOptions.setElectionTimeoutMs(electionTimeout);\n+        nodeOptions.setDisableCli(false);\n+\n+        int snapshotInterval = config.get(CoreOptions.RAFT_SNAPSHOT_INTERVAL);\n+        nodeOptions.setSnapshotIntervalSecs(snapshotInterval);\n+\n+        Configuration initConf = new Configuration();\n+        String initConfStr = config.get(CoreOptions.RAFT_GROUP_PEERS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2312d93677e8982cf625129df139c7373e822ef8"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MTgxNTA1OnYy", "diffSide": "RIGHT", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/StoreStateMachine.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNDoxMjo0OFrOG4OlYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNDoxMjo0OFrOG4OlYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYxMjM4NQ==", "bodyText": "!type.isSchema()", "url": "https://github.com/hugegraph/hugegraph/pull/1119#discussion_r461612385", "createdAt": "2020-07-28T14:12:48Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/StoreStateMachine.java", "diffHunk": "@@ -92,6 +97,24 @@ private void registerCommands() {\n         });\n     }\n \n+    private void updateCacheIfNeeded(BackendMutation mutation) {\n+        // Only follower need to update cache from store to tx\n+        if (this.isLeader()) {\n+            return;\n+        }\n+        for (HugeType type : mutation.types()) {\n+            if (!type.isGraph() && type.isSchema()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2312d93677e8982cf625129df139c7373e822ef8"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MTgzODgyOnYy", "diffSide": "RIGHT", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/StoreStateMachine.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNDoxNjowMFrOG4OylQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNDoxNjowMFrOG4OylQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYxNTc2NQ==", "bodyText": "remove the define", "url": "https://github.com/hugegraph/hugegraph/pull/1119#discussion_r461615765", "createdAt": "2020-07-28T14:16:00Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/StoreStateMachine.java", "diffHunk": "@@ -92,6 +97,24 @@ private void registerCommands() {\n         });\n     }\n \n+    private void updateCacheIfNeeded(BackendMutation mutation) {\n+        // Only follower need to update cache from store to tx\n+        if (this.isLeader()) {\n+            return;\n+        }\n+        for (HugeType type : mutation.types()) {\n+            if (!type.isGraph() && type.isSchema()) {\n+                continue;\n+            }\n+            for (java.util.Iterator<BackendAction> it = mutation.mutation(type);\n+                 it.hasNext();) {\n+                BackendAction item = it.next();\n+                BackendEntry entry = item.entry();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2312d93677e8982cf625129df139c7373e822ef8"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NDUzMDI2OnYy", "diffSide": "RIGHT", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/cache/CachedGraphTransaction.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNDozNDoyMlrOG4oNXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNDozNDoyMlrOG4oNXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAzMjIyMQ==", "bodyText": "clear edgesCache first", "url": "https://github.com/hugegraph/hugegraph/pull/1119#discussion_r462032221", "createdAt": "2020-07-29T04:34:22Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/cache/CachedGraphTransaction.java", "diffHunk": "@@ -135,14 +135,16 @@ private void listenChanges() {\n         this.cacheEventListener = event -> {\n             LOG.debug(\"Graph {} received graph cache event: {}\",\n                       this.graph(), event);\n-            event.checkArgs(String.class, Id.class);\n+            event.checkArgs(String.class, HugeType.class, Id.class);\n             Object[] args = event.args();\n             if (\"invalid\".equals(args[0])) {\n-                Id id = (Id) args[1];\n-                if (this.verticesCache.get(id) != null) {\n+                HugeType type = (HugeType) args[1];\n+                Id id = (Id) args[2];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e6cc424da564e690eed335eceeffd13234db7a5"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NDUzMzcwOnYy", "diffSide": "RIGHT", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/cache/CachedGraphTransaction.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNDozNjoxN1rOG4oPTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNDozNjoxN1rOG4oPTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAzMjcxOQ==", "bodyText": "QueryId is just for query, id of edge-update don't need to wrap QueryId", "url": "https://github.com/hugegraph/hugegraph/pull/1119#discussion_r462032719", "createdAt": "2020-07-29T04:36:17Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/cache/CachedGraphTransaction.java", "diffHunk": "@@ -135,14 +135,16 @@ private void listenChanges() {\n         this.cacheEventListener = event -> {\n             LOG.debug(\"Graph {} received graph cache event: {}\",\n                       this.graph(), event);\n-            event.checkArgs(String.class, Id.class);\n+            event.checkArgs(String.class, HugeType.class, Id.class);\n             Object[] args = event.args();\n             if (\"invalid\".equals(args[0])) {\n-                Id id = (Id) args[1];\n-                if (this.verticesCache.get(id) != null) {\n+                HugeType type = (HugeType) args[1];\n+                Id id = (Id) args[2];\n+                if (type.isVertex()) {\n                     // Invalidate vertex cache\n                     this.verticesCache.invalidate(id);\n-                } else if (this.edgesCache.get(id) != null) {\n+                } else if (type.isEdge()) {\n+                    id = new QueryId(new IdQuery(type, id));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e6cc424da564e690eed335eceeffd13234db7a5"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NTUyMDQ1OnYy", "diffSide": "RIGHT", "path": "hugegraph-test/src/main/java/com/baidu/hugegraph/core/EdgeLabelCoreTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMDowMjozOVrOG4xi5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMDowMjozOVrOG4xi5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE4NTE5MQ==", "bodyText": "add get", "url": "https://github.com/hugegraph/hugegraph/pull/1119#discussion_r462185191", "createdAt": "2020-07-29T10:02:39Z", "author": {"login": "javeme"}, "path": "hugegraph-test/src/main/java/com/baidu/hugegraph/core/EdgeLabelCoreTest.java", "diffHunk": "@@ -1215,7 +1215,7 @@ public void testListEdgeLabels() {\n         Assert.assertTrue(edgeLabels.contains(write));\n \n         // clear cache\n-        params().schemaEventHub().call(Events.CACHE, \"clear\", null);\n+        params().schemaEventHub().call(Events.CACHE, \"clear\", null, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85c71665c9a60cfd2ed00c556055d0952f4a4631"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NTUyMTA5OnYy", "diffSide": "RIGHT", "path": "hugegraph-test/src/main/java/com/baidu/hugegraph/core/VertexLabelCoreTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMDowMjo0N1rOG4xjRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMDowNDo1NFrOG4xn5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE4NTI4NQ==", "bodyText": "ditto", "url": "https://github.com/hugegraph/hugegraph/pull/1119#discussion_r462185285", "createdAt": "2020-07-29T10:02:47Z", "author": {"login": "javeme"}, "path": "hugegraph-test/src/main/java/com/baidu/hugegraph/core/VertexLabelCoreTest.java", "diffHunk": "@@ -1097,7 +1097,7 @@ public void testListVertexLabels() {\n         Assert.assertTrue(vertexLabels.contains(book));\n \n         // clear cache\n-        params().schemaEventHub().call(Events.CACHE, \"clear\", null);\n+        params().schemaEventHub().call(Events.CACHE, \"clear\", null, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85c71665c9a60cfd2ed00c556055d0952f4a4631"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE4NjQ2OA==", "bodyText": "use call instead of notify", "url": "https://github.com/hugegraph/hugegraph/pull/1119#discussion_r462186468", "createdAt": "2020-07-29T10:04:54Z", "author": {"login": "Linary"}, "path": "hugegraph-test/src/main/java/com/baidu/hugegraph/core/VertexLabelCoreTest.java", "diffHunk": "@@ -1097,7 +1097,7 @@ public void testListVertexLabels() {\n         Assert.assertTrue(vertexLabels.contains(book));\n \n         // clear cache\n-        params().schemaEventHub().call(Events.CACHE, \"clear\", null);\n+        params().schemaEventHub().call(Events.CACHE, \"clear\", null, null);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE4NTI4NQ=="}, "originalCommit": {"oid": "85c71665c9a60cfd2ed00c556055d0952f4a4631"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1464, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}