{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUwMTk5NDky", "number": 1098, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMzozMDoyMFrOEPYe2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNzo1MToyNVrOEQgaBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0NTY1MjEwOnYy", "diffSide": "RIGHT", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/StandardHugeGraph.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMzozMDoyMFrOGzEJAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMzozMDoyMFrOGzEJAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE5ODQwMg==", "bodyText": "move to line 258", "url": "https://github.com/hugegraph/hugegraph/pull/1098#discussion_r456198402", "createdAt": "2020-07-17T03:30:20Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/StandardHugeGraph.java", "diffHunk": "@@ -250,11 +252,13 @@ public void clearBackend() {\n         this.loadSystemStore().open(this.configuration);\n         this.loadGraphStore().open(this.configuration);\n         try {\n+            LockUtil.lock(this.name, TaskManager.HEARTBEAT);\n             this.storeProvider.clear();\n         } finally {\n             this.loadGraphStore().close();\n             this.loadSystemStore().close();\n             this.loadSchemaStore().close();\n+            LockUtil.unlock(this.name, TaskManager.HEARTBEAT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2d0075c9e4e9d5a71ff3626cfbc383971eb692e"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0NTY1MjcyOnYy", "diffSide": "RIGHT", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/StandardHugeGraph.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMzozMDozOFrOGzEJUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMzozMDozOFrOGzEJUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE5ODQ4MA==", "bodyText": "move out of try", "url": "https://github.com/hugegraph/hugegraph/pull/1098#discussion_r456198480", "createdAt": "2020-07-17T03:30:38Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/StandardHugeGraph.java", "diffHunk": "@@ -250,11 +252,13 @@ public void clearBackend() {\n         this.loadSystemStore().open(this.configuration);\n         this.loadGraphStore().open(this.configuration);\n         try {\n+            LockUtil.lock(this.name, TaskManager.HEARTBEAT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2d0075c9e4e9d5a71ff3626cfbc383971eb692e"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0NTY1NzA4OnYy", "diffSide": "RIGHT", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/StandardHugeGraph.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMzozMzoyM1rOGzEL3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMzozMzoyM1rOGzEL3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE5OTEzMw==", "bodyText": "rename to a common name like GRAPH_LOCK", "url": "https://github.com/hugegraph/hugegraph/pull/1098#discussion_r456199133", "createdAt": "2020-07-17T03:33:23Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/StandardHugeGraph.java", "diffHunk": "@@ -231,12 +231,14 @@ public void initBackend() {\n         this.loadSystemStore().open(this.configuration);\n         this.loadGraphStore().open(this.configuration);\n         try {\n+            LockUtil.lock(this.name, TaskManager.HEARTBEAT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2d0075c9e4e9d5a71ff3626cfbc383971eb692e"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0NjEwMTAxOnYy", "diffSide": "RIGHT", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/StandardHugeGraph.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwNzoyMjo0NVrOGzINkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwNzoyMjo0NVrOGzINkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI2NTEwNg==", "bodyText": "remove empty line", "url": "https://github.com/hugegraph/hugegraph/pull/1098#discussion_r456265106", "createdAt": "2020-07-17T07:22:45Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/StandardHugeGraph.java", "diffHunk": "@@ -268,14 +272,15 @@ public void clearBackend() {\n     public void truncateBackend() {\n         this.waitUntilAllTasksCompleted();\n \n+        LockUtil.lock(this.name, TaskManager.GRAPH_LOCK);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4300877401040b6ad9ef39cf574e986efe39d2f"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0NjExNDA5OnYy", "diffSide": "RIGHT", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/task/TaskManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwNzoyNzowNFrOGzIVTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwNzoyNzowNFrOGzIVTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI2NzA4NQ==", "bodyText": "move to LockUtil", "url": "https://github.com/hugegraph/hugegraph/pull/1098#discussion_r456267085", "createdAt": "2020-07-17T07:27:04Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/task/TaskManager.java", "diffHunk": "@@ -45,7 +45,7 @@\n \n     private static final Logger LOG = Log.logger(TaskManager.class);\n \n-    public static final String HEARTBEAT = \"heartbeat\";\n+    public static final String GRAPH_LOCK = \"graph_lock\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4300877401040b6ad9ef39cf574e986efe39d2f"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0OTI5NDgyOnYy", "diffSide": "RIGHT", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/task/TaskManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQwNTozMToxM1rOGzl8ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQwNTozMToxM1rOGzl8ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc1MjI1MQ==", "bodyText": "only do executeTasksOnWorker and cancelTasksOnWorker when !server.master() or server.onlySingleNode(), and rename server to serverManager", "url": "https://github.com/hugegraph/hugegraph/pull/1098#discussion_r456752251", "createdAt": "2020-07-18T05:31:13Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/task/TaskManager.java", "diffHunk": "@@ -276,6 +288,11 @@ private void scheduleOrExecuteJob() {\n             }\n         } catch (Throwable e) {\n             LOG.error(\"Exception occurred when schedule job\", e);\n+        } finally {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94672c0407aa1ba9fa26e9582ee42605963c544b"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1NjgzOTc2OnYy", "diffSide": "RIGHT", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/task/TaskManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwMzozMDoxN1rOG0mzLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwMzozMDoxN1rOG0mzLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgxNDgzMA==", "bodyText": "add graphName() to call graphparams.name() to avoid auth issue", "url": "https://github.com/hugegraph/hugegraph/pull/1098#discussion_r457814830", "createdAt": "2020-07-21T03:30:17Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/task/TaskManager.java", "diffHunk": "@@ -252,30 +254,48 @@ protected void notifyNewTask(HugeTask<?> task) {\n     }\n \n     private void scheduleOrExecuteJob() {\n+        List<String> graphs = new ArrayList<>();\n         try {\n             for (TaskScheduler entry : this.schedulers.values()) {\n                 StandardTaskScheduler scheduler = (StandardTaskScheduler) entry;\n-                ServerInfoManager server = scheduler.serverManager();\n+                ServerInfoManager serverManager = scheduler.serverManager();\n+\n+                String graph = scheduler.graph().name();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98d8fe007305532fe15a33d5bceb2faccec31567"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1NzQzNjIzOnYy", "diffSide": "RIGHT", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/task/TaskManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNzo1MToyNVrOG0sTDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNzo1MToyNVrOG0sTDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzkwNDkxMA==", "bodyText": "add some comments", "url": "https://github.com/hugegraph/hugegraph/pull/1098#discussion_r457904910", "createdAt": "2020-07-21T07:51:25Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/task/TaskManager.java", "diffHunk": "@@ -94,7 +94,7 @@ public void addScheduler(HugeGraphParams graph) {\n         this.schedulers.put(graph, scheduler);\n     }\n \n-    public void closeScheduler(HugeGraphParams graph) {\n+    public synchronized void closeScheduler(HugeGraphParams graph) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8977fa350e6c88f2ea8bd90734412ea946cd37fc"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1454, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}