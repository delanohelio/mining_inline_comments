{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwNDQ0NDM0", "number": 1226, "title": "set indexlabel invalid if create or rebuild failed", "bodyText": "also check if indexlabel invalid when query by index\nChange-Id: If890b3bd8c441b63642a2006479cf4ccca9ddf67", "createdAt": "2020-10-27T03:42:19Z", "url": "https://github.com/hugegraph/hugegraph/pull/1226", "merged": true, "mergeCommit": {"oid": "406cfe014b1b8f72eb85189c98764c00a8c3ed9b"}, "closed": true, "closedAt": "2020-10-29T03:12:56Z", "author": {"login": "zhoney"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWgk2hgH2gAyNTEwNDQ0NDM0OmU4ZmI5ZjA4ZDQyN2VhMDFlNTg4YjE1OWY5ZGQ4MWI0ZDI2OTdjYjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdW6WnfAFqTUxODQ3OTAxNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e8fb9f08d427ea01e588b159f9dd81b4d2697cb5", "author": {"user": {"login": "zhoney", "name": null}}, "url": "https://github.com/hugegraph/hugegraph/commit/e8fb9f08d427ea01e588b159f9dd81b4d2697cb5", "committedDate": "2020-10-27T03:40:47Z", "message": "set indexlabel invalid if create or rebuild failed\n\nalso check if indexlabel invalid when query by index\n\nChange-Id: If890b3bd8c441b63642a2006479cf4ccca9ddf67"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3Mzg4OTc5", "url": "https://github.com/hugegraph/hugegraph/pull/1226#pullrequestreview-517388979", "createdAt": "2020-10-27T06:49:04Z", "commit": {"oid": "e8fb9f08d427ea01e588b159f9dd81b4d2697cb5"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNjo0OTowNFrOHoteGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNzowMDo1OVrOHotu6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ1MDA3Mw==", "bodyText": "validate", "url": "https://github.com/hugegraph/hugegraph/pull/1226#discussion_r512450073", "createdAt": "2020-10-27T06:49:04Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/tx/GraphIndexTransaction.java", "diffHunk": "@@ -1349,6 +1354,13 @@ private static NoIndexException noIndexException(HugeGraph graph,\n                                     name, String.join(\"/\", mismatched));\n     }\n \n+    private static void validIndexLabel(IndexLabel indexLabel) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8fb9f08d427ea01e588b159f9dd81b4d2697cb5"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ1MTc5Mw==", "bodyText": "Can't query by label index '%s' due to it is in invalid status", "url": "https://github.com/hugegraph/hugegraph/pull/1226#discussion_r512451793", "createdAt": "2020-10-27T06:53:50Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/tx/GraphIndexTransaction.java", "diffHunk": "@@ -1349,6 +1354,13 @@ private static NoIndexException noIndexException(HugeGraph graph,\n                                     name, String.join(\"/\", mismatched));\n     }\n \n+    private static void validIndexLabel(IndexLabel indexLabel) {\n+        if (indexLabel.status() == SchemaStatus.INVALID) {\n+            throw new HugeException(\"The label index %s is invalid\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8fb9f08d427ea01e588b159f9dd81b4d2697cb5"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ1Mzg1Mg==", "bodyText": "does save to backend store? seems need to call schemaTx.updateSchemaStatus()", "url": "https://github.com/hugegraph/hugegraph/pull/1226#discussion_r512453852", "createdAt": "2020-10-27T06:59:27Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/job/schema/RebuildIndexCallable.java", "diffHunk": "@@ -158,6 +166,9 @@ private void removeIndex(Collection<Id> indexLabelIds) {\n             try {\n                 locks.lockWrites(LockUtil.INDEX_LABEL_DELETE, indexLabelIds);\n                 graphTx.removeIndex(il);\n+            } catch (Throwable t) {\n+                il.status(SchemaStatus.INVALID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8fb9f08d427ea01e588b159f9dd81b4d2697cb5"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ1Mzg4Ng==", "bodyText": "ditto", "url": "https://github.com/hugegraph/hugegraph/pull/1226#discussion_r512453886", "createdAt": "2020-10-27T06:59:32Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/schema/builder/IndexLabelBuilder.java", "diffHunk": "@@ -222,13 +222,19 @@ private boolean hasSameProperties(IndexLabel existedIndexLabel) {\n \n             // Create index label (just schema)\n             indexLabel.status(SchemaStatus.CREATING);\n-            this.graph().addIndexLabel(schemaLabel, indexLabel);\n+            try {\n+                this.graph().addIndexLabel(schemaLabel, indexLabel);\n \n-            // Async rebuild index\n-            Id rebuildTask = this.rebuildIndex(indexLabel, removeTasks);\n-            E.checkNotNull(rebuildTask, \"rebuild-index task\");\n+                // Async rebuild index\n+                Id rebuildTask = this.rebuildIndex(indexLabel, removeTasks);\n+                E.checkNotNull(rebuildTask, \"rebuild-index task\");\n \n-            return new IndexLabel.CreatedIndexLabel(indexLabel, rebuildTask);\n+                return new IndexLabel.CreatedIndexLabel(indexLabel,\n+                                                        rebuildTask);\n+            } catch (Throwable t) {\n+                indexLabel.status(SchemaStatus.INVALID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8fb9f08d427ea01e588b159f9dd81b4d2697cb5"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ1NDM3OQ==", "bodyText": "rename t to e", "url": "https://github.com/hugegraph/hugegraph/pull/1226#discussion_r512454379", "createdAt": "2020-10-27T07:00:59Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/schema/builder/IndexLabelBuilder.java", "diffHunk": "@@ -222,13 +222,19 @@ private boolean hasSameProperties(IndexLabel existedIndexLabel) {\n \n             // Create index label (just schema)\n             indexLabel.status(SchemaStatus.CREATING);\n-            this.graph().addIndexLabel(schemaLabel, indexLabel);\n+            try {\n+                this.graph().addIndexLabel(schemaLabel, indexLabel);\n \n-            // Async rebuild index\n-            Id rebuildTask = this.rebuildIndex(indexLabel, removeTasks);\n-            E.checkNotNull(rebuildTask, \"rebuild-index task\");\n+                // Async rebuild index\n+                Id rebuildTask = this.rebuildIndex(indexLabel, removeTasks);\n+                E.checkNotNull(rebuildTask, \"rebuild-index task\");\n \n-            return new IndexLabel.CreatedIndexLabel(indexLabel, rebuildTask);\n+                return new IndexLabel.CreatedIndexLabel(indexLabel,\n+                                                        rebuildTask);\n+            } catch (Throwable t) {\n+                indexLabel.status(SchemaStatus.INVALID);\n+                throw t;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8fb9f08d427ea01e588b159f9dd81b4d2697cb5"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e81ea8842d2352e043900514f5f6ecea80c62f27", "author": {"user": {"login": "zhoney", "name": null}}, "url": "https://github.com/hugegraph/hugegraph/commit/e81ea8842d2352e043900514f5f6ecea80c62f27", "committedDate": "2020-10-27T11:03:08Z", "message": "improve\n\nChange-Id: Ib8ee461872a463480fdc03faf3240a4254cc66f9"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NjUwMzU0", "url": "https://github.com/hugegraph/hugegraph/pull/1226#pullrequestreview-517650354", "createdAt": "2020-10-27T12:31:40Z", "commit": {"oid": "e81ea8842d2352e043900514f5f6ecea80c62f27"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NjcwMjIx", "url": "https://github.com/hugegraph/hugegraph/pull/1226#pullrequestreview-517670221", "createdAt": "2020-10-27T12:56:04Z", "commit": {"oid": "e81ea8842d2352e043900514f5f6ecea80c62f27"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMjo1NjowNFrOHo6xKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMjo1NjowNFrOHo6xKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY2Nzk0NA==", "bodyText": "schemaTx.updateSchemaStatus(indexLabel, SchemaStatus.INVALID);", "url": "https://github.com/hugegraph/hugegraph/pull/1226#discussion_r512667944", "createdAt": "2020-10-27T12:56:04Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/schema/builder/IndexLabelBuilder.java", "diffHunk": "@@ -222,18 +222,18 @@ private boolean hasSameProperties(IndexLabel existedIndexLabel) {\n \n             // Create index label (just schema)\n             indexLabel.status(SchemaStatus.CREATING);\n+            this.graph().addIndexLabel(schemaLabel, indexLabel);\n             try {\n-                this.graph().addIndexLabel(schemaLabel, indexLabel);\n-\n                 // Async rebuild index\n                 Id rebuildTask = this.rebuildIndex(indexLabel, removeTasks);\n                 E.checkNotNull(rebuildTask, \"rebuild-index task\");\n \n                 return new IndexLabel.CreatedIndexLabel(indexLabel,\n                                                         rebuildTask);\n-            } catch (Throwable t) {\n+            } catch (Throwable e) {\n                 indexLabel.status(SchemaStatus.INVALID);\n-                throw t;\n+                this.graph().addIndexLabel(schemaLabel, indexLabel);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e81ea8842d2352e043900514f5f6ecea80c62f27"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "381aefe5ad7db83be300a4ddf58cb77e43167c23", "author": {"user": {"login": "zhoney", "name": null}}, "url": "https://github.com/hugegraph/hugegraph/commit/381aefe5ad7db83be300a4ddf58cb77e43167c23", "committedDate": "2020-10-27T13:11:21Z", "message": "improve\n\nChange-Id: I57331425089e18582f5938536c5026e703ce34c6"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MzAxNjc1", "url": "https://github.com/hugegraph/hugegraph/pull/1226#pullrequestreview-518301675", "createdAt": "2020-10-28T03:37:09Z", "commit": {"oid": "381aefe5ad7db83be300a4ddf58cb77e43167c23"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MzQxOTcz", "url": "https://github.com/hugegraph/hugegraph/pull/1226#pullrequestreview-518341973", "createdAt": "2020-10-28T05:53:02Z", "commit": {"oid": "381aefe5ad7db83be300a4ddf58cb77e43167c23"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwNTo1MzowMlrOHpa_-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwNTo1MzowMlrOHpa_-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE5NjAyNA==", "bodyText": "also consider removeSubIndex() at line 207", "url": "https://github.com/hugegraph/hugegraph/pull/1226#discussion_r513196024", "createdAt": "2020-10-28T05:53:02Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/schema/builder/IndexLabelBuilder.java", "diffHunk": "@@ -231,8 +231,7 @@ private boolean hasSameProperties(IndexLabel existedIndexLabel) {\n                 return new IndexLabel.CreatedIndexLabel(indexLabel,\n                                                         rebuildTask);\n             } catch (Throwable e) {\n-                indexLabel.status(SchemaStatus.INVALID);\n-                this.graph().addIndexLabel(schemaLabel, indexLabel);\n+                this.updateSchemaStatus(indexLabel, SchemaStatus.INVALID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "381aefe5ad7db83be300a4ddf58cb77e43167c23"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "077fa8500a97936f23b8fb8ad4779d4b8224654a", "author": {"user": {"login": "zhoney", "name": null}}, "url": "https://github.com/hugegraph/hugegraph/commit/077fa8500a97936f23b8fb8ad4779d4b8224654a", "committedDate": "2020-10-28T06:55:28Z", "message": "improve\n\nChange-Id: I6aeaabe6325c336e947fa0d09a824a4138473fa4"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MzczMDgx", "url": "https://github.com/hugegraph/hugegraph/pull/1226#pullrequestreview-518373081", "createdAt": "2020-10-28T07:10:44Z", "commit": {"oid": "077fa8500a97936f23b8fb8ad4779d4b8224654a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwNzoxMDo0NFrOHpcidA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwNzoxMTowNFrOHpcjAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIyMTIzNg==", "bodyText": "should update status to INVALID  when failure to remove vertex/edge label?", "url": "https://github.com/hugegraph/hugegraph/pull/1226#discussion_r513221236", "createdAt": "2020-10-28T07:10:44Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/job/schema/IndexLabelRemoveCallable.java", "diffHunk": "@@ -54,14 +54,20 @@ protected static void removeIndexLabel(HugeGraphParams graph, Id id) {\n             // TODO add update lock\n             // Set index label to \"deleting\" status\n             schemaTx.updateSchemaStatus(indexLabel, SchemaStatus.DELETING);\n-            // Remove index data\n-            // TODO: use event to replace direct call\n-            graphTx.removeIndex(indexLabel);\n-            // Remove label from indexLabels of vertex or edge label\n-            removeIndexLabelFromBaseLabel(schemaTx, indexLabel);\n-            removeSchema(schemaTx, indexLabel);\n-            // Should commit changes to backend store before release delete lock\n-            graph.graph().tx().commit();\n+            try {\n+                // Remove index data\n+                // TODO: use event to replace direct call\n+                graphTx.removeIndex(indexLabel);\n+                // Remove label from indexLabels of vertex or edge label\n+                removeIndexLabelFromBaseLabel(schemaTx, indexLabel);\n+                removeSchema(schemaTx, indexLabel);\n+                // Should commit changes to backend store\n+                // before release delete lock\n+                graph.graph().tx().commit();\n+            } catch (Throwable e) {\n+                schemaTx.updateSchemaStatus(indexLabel, SchemaStatus.INVALID);\n+                throw e;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "077fa8500a97936f23b8fb8ad4779d4b8224654a"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIyMTM3Nw==", "bodyText": "use \"/*\"", "url": "https://github.com/hugegraph/hugegraph/pull/1226#discussion_r513221377", "createdAt": "2020-10-28T07:11:04Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/job/schema/IndexLabelRemoveCallable.java", "diffHunk": "@@ -54,14 +54,20 @@ protected static void removeIndexLabel(HugeGraphParams graph, Id id) {\n             // TODO add update lock\n             // Set index label to \"deleting\" status\n             schemaTx.updateSchemaStatus(indexLabel, SchemaStatus.DELETING);\n-            // Remove index data\n-            // TODO: use event to replace direct call\n-            graphTx.removeIndex(indexLabel);\n-            // Remove label from indexLabels of vertex or edge label\n-            removeIndexLabelFromBaseLabel(schemaTx, indexLabel);\n-            removeSchema(schemaTx, indexLabel);\n-            // Should commit changes to backend store before release delete lock\n-            graph.graph().tx().commit();\n+            try {\n+                // Remove index data\n+                // TODO: use event to replace direct call\n+                graphTx.removeIndex(indexLabel);\n+                // Remove label from indexLabels of vertex or edge label\n+                removeIndexLabelFromBaseLabel(schemaTx, indexLabel);\n+                removeSchema(schemaTx, indexLabel);\n+                // Should commit changes to backend store\n+                // before release delete lock", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "077fa8500a97936f23b8fb8ad4779d4b8224654a"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b3742f47439d456c09f5e7a9130860448251c22", "author": {"user": {"login": "zhoney", "name": null}}, "url": "https://github.com/hugegraph/hugegraph/commit/0b3742f47439d456c09f5e7a9130860448251c22", "committedDate": "2020-10-28T07:14:56Z", "message": "improve\n\nChange-Id: I855e51feda284ba74522cd98f11b11975dcb80d9"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d20e5770f2d41ff95c3c853ce70cbf3f0f691000", "author": {"user": {"login": "zhoney", "name": null}}, "url": "https://github.com/hugegraph/hugegraph/commit/d20e5770f2d41ff95c3c853ce70cbf3f0f691000", "committedDate": "2020-10-28T08:06:57Z", "message": "set vl/el to UNDELETED if fail to delete\n\nChange-Id: I7537bd5aff2b43e8a3ba26c88f83761889386ff3"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4NDU3OTIy", "url": "https://github.com/hugegraph/hugegraph/pull/1226#pullrequestreview-518457922", "createdAt": "2020-10-28T09:17:52Z", "commit": {"oid": "d20e5770f2d41ff95c3c853ce70cbf3f0f691000"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4NDc5MDE0", "url": "https://github.com/hugegraph/hugegraph/pull/1226#pullrequestreview-518479014", "createdAt": "2020-10-28T09:42:46Z", "commit": {"oid": "d20e5770f2d41ff95c3c853ce70cbf3f0f691000"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2304, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}