{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0NDk3MTI2", "number": 1275, "title": "Write snapshot explicity after truncate backend", "bodyText": "Change-Id: Ifa11b36bebcd7e702327e79d51ec68fe1fd2eebb", "createdAt": "2020-11-20T07:16:10Z", "url": "https://github.com/hugegraph/hugegraph/pull/1275", "merged": true, "mergeCommit": {"oid": "9279bd721d71c4cb6305fd58c8b42ad2b20a36c8"}, "closed": true, "closedAt": "2020-11-23T06:02:46Z", "author": {"login": "Linary"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeSvd1AFqTUzNTE3OTIzMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfMin7AFqTUzNjE2MDI2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MTc5MjMy", "url": "https://github.com/hugegraph/hugegraph/pull/1275#pullrequestreview-535179232", "createdAt": "2020-11-20T07:46:03Z", "commit": {"oid": "8c01d645b7594e1e1c5fd3830d6fa454e8f012e9"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwNzo0NjowM1rOH3DyBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwODowNTowNVrOH3EZ4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ5NTY4Ng==", "bodyText": "at the same time, the store has been cleared(truncate) but init-store has not been completed", "url": "https://github.com/hugegraph/hugegraph/pull/1275#discussion_r527495686", "createdAt": "2020-11-20T07:46:03Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/StandardHugeGraph.java", "diffHunk": "@@ -307,6 +307,16 @@ public void truncateBackend() {\n             this.storeProvider.initSystemInfo(this);\n             this.serverStarted(this.serverInfoManager().selfServerId(),\n                                this.serverInfoManager().selfServerRole());\n+            /*\n+             * Take the initiative to generate a snapshot, it can avoid this\n+             * situation: when the server restart need to read the database\n+             * (such as checkBackendVersionInfo), it happens that raft replays\n+             * the truncate log, at this time, the library has been cleared,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c01d645b7594e1e1c5fd3830d6fa454e8f012e9"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUwNTg4OQ==", "bodyText": "set store=null if type == StoreType.ALL", "url": "https://github.com/hugegraph/hugegraph/pull/1275#discussion_r527505889", "createdAt": "2020-11-20T08:05:05Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/StoreStateMachine.java", "diffHunk": "@@ -182,9 +195,14 @@ public void onApply(Iterator iter) {\n \n     private Object applyCommand(StoreType type, StoreAction action,\n                                 BytesBuffer buffer) {\n-        BackendStore store = this.store(type);\n-        BiConsumer<BackendStore, BytesBuffer> func = this.funcs.get(action);\n-        func.accept(store, buffer);\n+        if (type != StoreType.ALL) {\n+            BackendStore store = this.store(type);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c01d645b7594e1e1c5fd3830d6fa454e8f012e9"}, "originalPosition": 75}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4268abde03a79aba7850bebfab464495000d70c5", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/4268abde03a79aba7850bebfab464495000d70c5", "committedDate": "2020-11-20T09:55:18Z", "message": "Write snapshot explicity after truncate backend\n\nChange-Id: Ifa11b36bebcd7e702327e79d51ec68fe1fd2eebb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5dd76e6270251cf2619f517948d680624a242e8d", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/5dd76e6270251cf2619f517948d680624a242e8d", "committedDate": "2020-11-20T09:55:18Z", "message": "tiny improve\n\nChange-Id: I68a5314859e4a933ce3e7247797decfe712b854f"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MjgyMzM3", "url": "https://github.com/hugegraph/hugegraph/pull/1275#pullrequestreview-535282337", "createdAt": "2020-11-20T09:56:51Z", "commit": {"oid": "a747f4602825c45787539d9903cf0cba0b2861e3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwOTo1Njo1MVrOH3I1GA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwOTo1Njo1MVrOH3I1GA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU3ODM5Mg==", "bodyText": "typo: genearet", "url": "https://github.com/hugegraph/hugegraph/pull/1275#discussion_r527578392", "createdAt": "2020-11-20T09:56:51Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftNode.java", "diffHunk": "@@ -98,6 +98,19 @@ public void shutdown() {\n         this.node.shutdown();\n     }\n \n+    public void snapshot() {\n+        if (!this.context.useSnapshot()) {\n+            return;\n+        }\n+        RaftClosure<?> future = new RaftClosure<>();\n+        try {\n+            this.node().snapshot(future);\n+            future.waitFinished();\n+        } catch (Throwable e) {\n+            throw new BackendException(\"Failed to genearet snapshot\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a747f4602825c45787539d9903cf0cba0b2861e3"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cefc52555d1e39c189f9301f37632e271efb7b88", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/cefc52555d1e39c189f9301f37632e271efb7b88", "committedDate": "2020-11-20T10:03:38Z", "message": "fix typo\n\nChange-Id: I43fde591d69274dfafe7f7e41792cdf7cd8d2715"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a747f4602825c45787539d9903cf0cba0b2861e3", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/a747f4602825c45787539d9903cf0cba0b2861e3", "committedDate": "2020-11-20T09:38:07Z", "message": "tiny improve\n\nChange-Id: I68a5314859e4a933ce3e7247797decfe712b854f"}, "afterCommit": {"oid": "cefc52555d1e39c189f9301f37632e271efb7b88", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/cefc52555d1e39c189f9301f37632e271efb7b88", "committedDate": "2020-11-20T10:03:38Z", "message": "fix typo\n\nChange-Id: I43fde591d69274dfafe7f7e41792cdf7cd8d2715"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1Mjg5NDg0", "url": "https://github.com/hugegraph/hugegraph/pull/1275#pullrequestreview-535289484", "createdAt": "2020-11-20T10:06:00Z", "commit": {"oid": "cefc52555d1e39c189f9301f37632e271efb7b88"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1Mjk2ODI0", "url": "https://github.com/hugegraph/hugegraph/pull/1275#pullrequestreview-535296824", "createdAt": "2020-11-20T10:15:57Z", "commit": {"oid": "cefc52555d1e39c189f9301f37632e271efb7b88"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMDoxNTo1OFrOH3JhqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMDoyMToxM1rOH3Jtgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU4OTgwMQ==", "bodyText": "set submitAndWait protected", "url": "https://github.com/hugegraph/hugegraph/pull/1275#discussion_r527589801", "createdAt": "2020-11-20T10:15:58Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftBackendStoreProvider.java", "diffHunk": "@@ -188,6 +189,20 @@ public void initSystemInfo(HugeGraph graph) {\n         LOG.debug(\"Graph '{}' system info has been initialized\", this.graph());\n     }\n \n+    @Override\n+    public void writeSnapshot() {\n+        StoreCommand command = new StoreCommand(StoreType.ALL,\n+                                                StoreAction.SNAPSHOT, null);\n+        StoreClosure closure = new StoreClosure(command);\n+        this.context.node().submitAndWait(command, closure);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cefc52555d1e39c189f9301f37632e271efb7b88"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU5MjU5MQ==", "bodyText": "keep func", "url": "https://github.com/hugegraph/hugegraph/pull/1275#discussion_r527592591", "createdAt": "2020-11-20T10:20:49Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/StoreStateMachine.java", "diffHunk": "@@ -123,8 +127,8 @@ private void updateCacheIfNeeded(BackendMutation mutation) {\n     }\n \n     private void register(StoreAction action,\n-                          BiConsumer<BackendStore, BytesBuffer> func) {\n-        this.funcs.put(action, func);\n+                          BiConsumer<BackendStore, BytesBuffer> biFunc) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cefc52555d1e39c189f9301f37632e271efb7b88"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU5MjgzNQ==", "bodyText": "keep @SuppressWarnings(\"unused\")", "url": "https://github.com/hugegraph/hugegraph/pull/1275#discussion_r527592835", "createdAt": "2020-11-20T10:21:13Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/rpc/RaftRequests.java", "diffHunk": "@@ -3,14 +3,13 @@\n \n package com.baidu.hugegraph.backend.store.raft.rpc;\n \n-@SuppressWarnings(\"unused\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cefc52555d1e39c189f9301f37632e271efb7b88"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67d9a452358ed7ef042150ce2fae2712f8997615", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/67d9a452358ed7ef042150ce2fae2712f8997615", "committedDate": "2020-11-20T11:03:17Z", "message": "tiny improve\n\nChange-Id: Idf3dad865c9baf181227ad063233bef2b548b2d8"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MzQ1MDcz", "url": "https://github.com/hugegraph/hugegraph/pull/1275#pullrequestreview-535345073", "createdAt": "2020-11-20T11:24:32Z", "commit": {"oid": "67d9a452358ed7ef042150ce2fae2712f8997615"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MTYwMjYw", "url": "https://github.com/hugegraph/hugegraph/pull/1275#pullrequestreview-536160260", "createdAt": "2020-11-23T03:25:34Z", "commit": {"oid": "67d9a452358ed7ef042150ce2fae2712f8997615"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2328, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}