{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3Nzg4MzU5", "number": 1119, "title": "Update cache from raft StateMachine", "bodyText": "Change-Id: I7b57ed687a9f12c00a6561f0c1590c27247d47c1", "createdAt": "2020-07-28T12:51:03Z", "url": "https://github.com/hugegraph/hugegraph/pull/1119", "merged": true, "mergeCommit": {"oid": "2df4f680d43a4ec84337583706fad6b49e8fd6c8"}, "closed": true, "closedAt": "2020-07-29T10:07:38Z", "author": {"login": "Linary"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5W7m1gH2gAyNDU3Nzg4MzU5OjIzMTJkOTM2NzdlODk4MmNmNjI1MTI5ZGYxMzljNzM3M2U4MjJlZjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5oI4SAFqTQ1NzM3NzkzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2312d93677e8982cf625129df139c7373e822ef8", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/2312d93677e8982cf625129df139c7373e822ef8", "committedDate": "2020-07-28T14:02:47Z", "message": "Update cache from raft StateMachine\n\nChange-Id: I7b57ed687a9f12c00a6561f0c1590c27247d47c1"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1dbaffe86b5b8d975d0dd47870116cce74190aea", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/1dbaffe86b5b8d975d0dd47870116cce74190aea", "committedDate": "2020-07-28T12:47:53Z", "message": "Update cache from raft StateMachine\n\nChange-Id: I7b57ed687a9f12c00a6561f0c1590c27247d47c1"}, "afterCommit": {"oid": "2312d93677e8982cf625129df139c7373e822ef8", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/2312d93677e8982cf625129df139c7373e822ef8", "committedDate": "2020-07-28T14:02:47Z", "message": "Update cache from raft StateMachine\n\nChange-Id: I7b57ed687a9f12c00a6561f0c1590c27247d47c1"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NjA0ODY5", "url": "https://github.com/hugegraph/hugegraph/pull/1119#pullrequestreview-456604869", "createdAt": "2020-07-28T13:00:09Z", "commit": {"oid": "1dbaffe86b5b8d975d0dd47870116cce74190aea"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMzowMDowOVrOG4LXkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNDoxMjo0OFrOG4OlYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU1OTY5Ng==", "bodyText": "improve", "url": "https://github.com/hugegraph/hugegraph/pull/1119#discussion_r461559696", "createdAt": "2020-07-28T13:00:09Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/StandardHugeGraph.java", "diffHunk": "@@ -366,7 +367,15 @@ private GraphTransaction graphTransaction() {\n     }\n \n     private BackendStoreProvider loadStoreProvider() {\n-        return BackendProviderFactory.open(this.configuration);\n+        BackendStoreProvider provider;\n+        provider = BackendProviderFactory.open(this.configuration);\n+        if (provider instanceof RaftBackendStoreProvider) {\n+            RaftBackendStoreProvider raftProvider =\n+                    (RaftBackendStoreProvider) provider;\n+            raftProvider.injectEventHub(this.params.schemaEventHub(),\n+                                        this.params.graphEventHub());\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1dbaffe86b5b8d975d0dd47870116cce74190aea"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYwOTk5Mg==", "bodyText": "set protected", "url": "https://github.com/hugegraph/hugegraph/pull/1119#discussion_r461609992", "createdAt": "2020-07-28T14:09:59Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftNode.java", "diffHunk": "@@ -199,7 +138,7 @@ public Object submitAndWait(StoreCommand command, StoreClosure closure) {\n         }\n     }\n \n-    private void waitLeaderElected() {\n+    public void waitLeaderElected() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2312d93677e8982cf625129df139c7373e822ef8"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYxMTU5MA==", "bodyText": "rename", "url": "https://github.com/hugegraph/hugegraph/pull/1119#discussion_r461611590", "createdAt": "2020-07-28T14:12:06Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftSharedContext.java", "diffHunk": "@@ -95,6 +105,82 @@ public void addNode(String group, BackendStore store) {\n         }\n     }\n \n+    public NodeOptions nodeOptions(String storePath) throws IOException {\n+        HugeConfig config = this.config();\n+        PeerId selfId = new PeerId();\n+        selfId.parse(config.get(CoreOptions.RAFT_ENDPOINT));\n+\n+        NodeOptions nodeOptions = new NodeOptions();\n+        int electionTimeout = config.get(CoreOptions.RAFT_ELECTION_TIMEOUT);\n+        nodeOptions.setElectionTimeoutMs(electionTimeout);\n+        nodeOptions.setDisableCli(false);\n+\n+        int snapshotInterval = config.get(CoreOptions.RAFT_SNAPSHOT_INTERVAL);\n+        nodeOptions.setSnapshotIntervalSecs(snapshotInterval);\n+\n+        Configuration initConf = new Configuration();\n+        String initConfStr = config.get(CoreOptions.RAFT_GROUP_PEERS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2312d93677e8982cf625129df139c7373e822ef8"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYxMjM4NQ==", "bodyText": "!type.isSchema()", "url": "https://github.com/hugegraph/hugegraph/pull/1119#discussion_r461612385", "createdAt": "2020-07-28T14:12:48Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/StoreStateMachine.java", "diffHunk": "@@ -92,6 +97,24 @@ private void registerCommands() {\n         });\n     }\n \n+    private void updateCacheIfNeeded(BackendMutation mutation) {\n+        // Only follower need to update cache from store to tx\n+        if (this.isLeader()) {\n+            return;\n+        }\n+        for (HugeType type : mutation.types()) {\n+            if (!type.isGraph() && type.isSchema()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2312d93677e8982cf625129df139c7373e822ef8"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2Njc5MDYy", "url": "https://github.com/hugegraph/hugegraph/pull/1119#pullrequestreview-456679062", "createdAt": "2020-07-28T14:16:00Z", "commit": {"oid": "2312d93677e8982cf625129df139c7373e822ef8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNDoxNjowMFrOG4OylQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNDoxNjowMFrOG4OylQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYxNTc2NQ==", "bodyText": "remove the define", "url": "https://github.com/hugegraph/hugegraph/pull/1119#discussion_r461615765", "createdAt": "2020-07-28T14:16:00Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/StoreStateMachine.java", "diffHunk": "@@ -92,6 +97,24 @@ private void registerCommands() {\n         });\n     }\n \n+    private void updateCacheIfNeeded(BackendMutation mutation) {\n+        // Only follower need to update cache from store to tx\n+        if (this.isLeader()) {\n+            return;\n+        }\n+        for (HugeType type : mutation.types()) {\n+            if (!type.isGraph() && type.isSchema()) {\n+                continue;\n+            }\n+            for (java.util.Iterator<BackendAction> it = mutation.mutation(type);\n+                 it.hasNext();) {\n+                BackendAction item = it.next();\n+                BackendEntry entry = item.entry();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2312d93677e8982cf625129df139c7373e822ef8"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c21ee0913350c6a781077fb06d93af6604a10423", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/c21ee0913350c6a781077fb06d93af6604a10423", "committedDate": "2020-07-28T14:29:41Z", "message": "tiny improve\n\nChange-Id: I5233ccef4b15c23ffc3ed386a569127c86609365"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec54cfac0e510b453d4359a7d68b912e9691bda0", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/ec54cfac0e510b453d4359a7d68b912e9691bda0", "committedDate": "2020-07-28T14:32:11Z", "message": "bump up pom version\n\nChange-Id: Idb069013fd117e8857dc5b1924e0922f6f31d68f"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NzEwMDE0", "url": "https://github.com/hugegraph/hugegraph/pull/1119#pullrequestreview-456710014", "createdAt": "2020-07-28T14:45:49Z", "commit": {"oid": "ec54cfac0e510b453d4359a7d68b912e9691bda0"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e6cc424da564e690eed335eceeffd13234db7a5", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/5e6cc424da564e690eed335eceeffd13234db7a5", "committedDate": "2020-07-29T03:46:15Z", "message": "imrove schema and edge cache handle logic\n\nChange-Id: I1e4140fb695e65ca2eb4285c6c02705ac518b2c0"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MTg3NDg1", "url": "https://github.com/hugegraph/hugegraph/pull/1119#pullrequestreview-457187485", "createdAt": "2020-07-29T04:34:21Z", "commit": {"oid": "5e6cc424da564e690eed335eceeffd13234db7a5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNDozNDoyMlrOG4oNXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNDozNDoyMlrOG4oNXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAzMjIyMQ==", "bodyText": "clear edgesCache first", "url": "https://github.com/hugegraph/hugegraph/pull/1119#discussion_r462032221", "createdAt": "2020-07-29T04:34:22Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/cache/CachedGraphTransaction.java", "diffHunk": "@@ -135,14 +135,16 @@ private void listenChanges() {\n         this.cacheEventListener = event -> {\n             LOG.debug(\"Graph {} received graph cache event: {}\",\n                       this.graph(), event);\n-            event.checkArgs(String.class, Id.class);\n+            event.checkArgs(String.class, HugeType.class, Id.class);\n             Object[] args = event.args();\n             if (\"invalid\".equals(args[0])) {\n-                Id id = (Id) args[1];\n-                if (this.verticesCache.get(id) != null) {\n+                HugeType type = (HugeType) args[1];\n+                Id id = (Id) args[2];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e6cc424da564e690eed335eceeffd13234db7a5"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MTg3OTk1", "url": "https://github.com/hugegraph/hugegraph/pull/1119#pullrequestreview-457187995", "createdAt": "2020-07-29T04:36:17Z", "commit": {"oid": "5e6cc424da564e690eed335eceeffd13234db7a5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNDozNjoxN1rOG4oPTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNDozNjoxN1rOG4oPTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAzMjcxOQ==", "bodyText": "QueryId is just for query, id of edge-update don't need to wrap QueryId", "url": "https://github.com/hugegraph/hugegraph/pull/1119#discussion_r462032719", "createdAt": "2020-07-29T04:36:17Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/cache/CachedGraphTransaction.java", "diffHunk": "@@ -135,14 +135,16 @@ private void listenChanges() {\n         this.cacheEventListener = event -> {\n             LOG.debug(\"Graph {} received graph cache event: {}\",\n                       this.graph(), event);\n-            event.checkArgs(String.class, Id.class);\n+            event.checkArgs(String.class, HugeType.class, Id.class);\n             Object[] args = event.args();\n             if (\"invalid\".equals(args[0])) {\n-                Id id = (Id) args[1];\n-                if (this.verticesCache.get(id) != null) {\n+                HugeType type = (HugeType) args[1];\n+                Id id = (Id) args[2];\n+                if (type.isVertex()) {\n                     // Invalidate vertex cache\n                     this.verticesCache.invalidate(id);\n-                } else if (this.edgesCache.get(id) != null) {\n+                } else if (type.isEdge()) {\n+                    id = new QueryId(new IdQuery(type, id));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e6cc424da564e690eed335eceeffd13234db7a5"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8643ac2170d171c15d220b2b5806e3fc129e7d73", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/8643ac2170d171c15d220b2b5806e3fc129e7d73", "committedDate": "2020-07-29T04:46:15Z", "message": "clear edge cache\n\nChange-Id: I5dc13b3b612accfa9af6c18f23ffcd34d4544745"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MjQyNDMw", "url": "https://github.com/hugegraph/hugegraph/pull/1119#pullrequestreview-457242430", "createdAt": "2020-07-29T06:56:54Z", "commit": {"oid": "8643ac2170d171c15d220b2b5806e3fc129e7d73"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cffb488826ac70270e16581cf8a43d8477cd4271", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/cffb488826ac70270e16581cf8a43d8477cd4271", "committedDate": "2020-07-29T07:19:02Z", "message": "tiny improve on test\n\nChange-Id: I743de35eb35409ebf4ff2507564cfe2c82c79fe9"}, "afterCommit": {"oid": "4b9ad8917e385127768e489fa735d2b6e864f112", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/4b9ad8917e385127768e489fa735d2b6e864f112", "committedDate": "2020-07-29T09:11:12Z", "message": "tiny improve on test\n\nChange-Id: I743de35eb35409ebf4ff2507564cfe2c82c79fe9"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85c71665c9a60cfd2ed00c556055d0952f4a4631", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/85c71665c9a60cfd2ed00c556055d0952f4a4631", "committedDate": "2020-07-29T09:28:18Z", "message": "tiny improve on test\n\nChange-Id: I743de35eb35409ebf4ff2507564cfe2c82c79fe9"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4b9ad8917e385127768e489fa735d2b6e864f112", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/4b9ad8917e385127768e489fa735d2b6e864f112", "committedDate": "2020-07-29T09:11:12Z", "message": "tiny improve on test\n\nChange-Id: I743de35eb35409ebf4ff2507564cfe2c82c79fe9"}, "afterCommit": {"oid": "85c71665c9a60cfd2ed00c556055d0952f4a4631", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/85c71665c9a60cfd2ed00c556055d0952f4a4631", "committedDate": "2020-07-29T09:28:18Z", "message": "tiny improve on test\n\nChange-Id: I743de35eb35409ebf4ff2507564cfe2c82c79fe9"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3Mzc1NzYx", "url": "https://github.com/hugegraph/hugegraph/pull/1119#pullrequestreview-457375761", "createdAt": "2020-07-29T10:02:38Z", "commit": {"oid": "85c71665c9a60cfd2ed00c556055d0952f4a4631"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMDowMjozOVrOG4xi5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMDowMjo0N1rOG4xjRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE4NTE5MQ==", "bodyText": "add get", "url": "https://github.com/hugegraph/hugegraph/pull/1119#discussion_r462185191", "createdAt": "2020-07-29T10:02:39Z", "author": {"login": "javeme"}, "path": "hugegraph-test/src/main/java/com/baidu/hugegraph/core/EdgeLabelCoreTest.java", "diffHunk": "@@ -1215,7 +1215,7 @@ public void testListEdgeLabels() {\n         Assert.assertTrue(edgeLabels.contains(write));\n \n         // clear cache\n-        params().schemaEventHub().call(Events.CACHE, \"clear\", null);\n+        params().schemaEventHub().call(Events.CACHE, \"clear\", null, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85c71665c9a60cfd2ed00c556055d0952f4a4631"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE4NTI4NQ==", "bodyText": "ditto", "url": "https://github.com/hugegraph/hugegraph/pull/1119#discussion_r462185285", "createdAt": "2020-07-29T10:02:47Z", "author": {"login": "javeme"}, "path": "hugegraph-test/src/main/java/com/baidu/hugegraph/core/VertexLabelCoreTest.java", "diffHunk": "@@ -1097,7 +1097,7 @@ public void testListVertexLabels() {\n         Assert.assertTrue(vertexLabels.contains(book));\n \n         // clear cache\n-        params().schemaEventHub().call(Events.CACHE, \"clear\", null);\n+        params().schemaEventHub().call(Events.CACHE, \"clear\", null, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85c71665c9a60cfd2ed00c556055d0952f4a4631"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3Mzc3NDUx", "url": "https://github.com/hugegraph/hugegraph/pull/1119#pullrequestreview-457377451", "createdAt": "2020-07-29T10:04:56Z", "commit": {"oid": "85c71665c9a60cfd2ed00c556055d0952f4a4631"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3Mzc3OTMy", "url": "https://github.com/hugegraph/hugegraph/pull/1119#pullrequestreview-457377932", "createdAt": "2020-07-29T10:05:40Z", "commit": {"oid": "85c71665c9a60cfd2ed00c556055d0952f4a4631"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2244, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}