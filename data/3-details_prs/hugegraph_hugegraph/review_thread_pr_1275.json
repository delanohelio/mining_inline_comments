{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0NDk3MTI2", "number": 1275, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwNzo0NjowM1rOE7a5mQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMDoyMToxM1rOE7etOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwNzQyMTY5OnYy", "diffSide": "RIGHT", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/StandardHugeGraph.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwNzo0NjowM1rOH3DyBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwNzo0NjowM1rOH3DyBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ5NTY4Ng==", "bodyText": "at the same time, the store has been cleared(truncate) but init-store has not been completed", "url": "https://github.com/hugegraph/hugegraph/pull/1275#discussion_r527495686", "createdAt": "2020-11-20T07:46:03Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/StandardHugeGraph.java", "diffHunk": "@@ -307,6 +307,16 @@ public void truncateBackend() {\n             this.storeProvider.initSystemInfo(this);\n             this.serverStarted(this.serverInfoManager().selfServerId(),\n                                this.serverInfoManager().selfServerRole());\n+            /*\n+             * Take the initiative to generate a snapshot, it can avoid this\n+             * situation: when the server restart need to read the database\n+             * (such as checkBackendVersionInfo), it happens that raft replays\n+             * the truncate log, at this time, the library has been cleared,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c01d645b7594e1e1c5fd3830d6fa454e8f012e9"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwNzQ4Nzk2OnYy", "diffSide": "RIGHT", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/StoreStateMachine.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwODowNTowNVrOH3EZ4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwODowNTowNVrOH3EZ4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUwNTg4OQ==", "bodyText": "set store=null if type == StoreType.ALL", "url": "https://github.com/hugegraph/hugegraph/pull/1275#discussion_r527505889", "createdAt": "2020-11-20T08:05:05Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/StoreStateMachine.java", "diffHunk": "@@ -182,9 +195,14 @@ public void onApply(Iterator iter) {\n \n     private Object applyCommand(StoreType type, StoreAction action,\n                                 BytesBuffer buffer) {\n-        BackendStore store = this.store(type);\n-        BiConsumer<BackendStore, BytesBuffer> func = this.funcs.get(action);\n-        func.accept(store, buffer);\n+        if (type != StoreType.ALL) {\n+            BackendStore store = this.store(type);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c01d645b7594e1e1c5fd3830d6fa454e8f012e9"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwNzk1MTA0OnYy", "diffSide": "RIGHT", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftNode.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwOTo1Njo1MVrOH3I1GA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwOTo1Njo1MVrOH3I1GA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU3ODM5Mg==", "bodyText": "typo: genearet", "url": "https://github.com/hugegraph/hugegraph/pull/1275#discussion_r527578392", "createdAt": "2020-11-20T09:56:51Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftNode.java", "diffHunk": "@@ -98,6 +98,19 @@ public void shutdown() {\n         this.node.shutdown();\n     }\n \n+    public void snapshot() {\n+        if (!this.context.useSnapshot()) {\n+            return;\n+        }\n+        RaftClosure<?> future = new RaftClosure<>();\n+        try {\n+            this.node().snapshot(future);\n+            future.waitFinished();\n+        } catch (Throwable e) {\n+            throw new BackendException(\"Failed to genearet snapshot\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a747f4602825c45787539d9903cf0cba0b2861e3"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwODAyNTI5OnYy", "diffSide": "RIGHT", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftBackendStoreProvider.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMDoxNTo1OFrOH3JhqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMTowMDoxNFrOH3LEXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU4OTgwMQ==", "bodyText": "set submitAndWait protected", "url": "https://github.com/hugegraph/hugegraph/pull/1275#discussion_r527589801", "createdAt": "2020-11-20T10:15:58Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftBackendStoreProvider.java", "diffHunk": "@@ -188,6 +189,20 @@ public void initSystemInfo(HugeGraph graph) {\n         LOG.debug(\"Graph '{}' system info has been initialized\", this.graph());\n     }\n \n+    @Override\n+    public void writeSnapshot() {\n+        StoreCommand command = new StoreCommand(StoreType.ALL,\n+                                                StoreAction.SNAPSHOT, null);\n+        StoreClosure closure = new StoreClosure(command);\n+        this.context.node().submitAndWait(command, closure);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cefc52555d1e39c189f9301f37632e271efb7b88"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYxNTA3MQ==", "bodyText": "StoreCommandProcessor used it", "url": "https://github.com/hugegraph/hugegraph/pull/1275#discussion_r527615071", "createdAt": "2020-11-20T11:00:14Z", "author": {"login": "Linary"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftBackendStoreProvider.java", "diffHunk": "@@ -188,6 +189,20 @@ public void initSystemInfo(HugeGraph graph) {\n         LOG.debug(\"Graph '{}' system info has been initialized\", this.graph());\n     }\n \n+    @Override\n+    public void writeSnapshot() {\n+        StoreCommand command = new StoreCommand(StoreType.ALL,\n+                                                StoreAction.SNAPSHOT, null);\n+        StoreClosure closure = new StoreClosure(command);\n+        this.context.node().submitAndWait(command, closure);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU4OTgwMQ=="}, "originalCommit": {"oid": "cefc52555d1e39c189f9301f37632e271efb7b88"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwODA0Mzg1OnYy", "diffSide": "RIGHT", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/StoreStateMachine.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMDoyMDo0OVrOH3Jsjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMDoyMDo0OVrOH3Jsjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU5MjU5MQ==", "bodyText": "keep func", "url": "https://github.com/hugegraph/hugegraph/pull/1275#discussion_r527592591", "createdAt": "2020-11-20T10:20:49Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/StoreStateMachine.java", "diffHunk": "@@ -123,8 +127,8 @@ private void updateCacheIfNeeded(BackendMutation mutation) {\n     }\n \n     private void register(StoreAction action,\n-                          BiConsumer<BackendStore, BytesBuffer> func) {\n-        this.funcs.put(action, func);\n+                          BiConsumer<BackendStore, BytesBuffer> biFunc) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cefc52555d1e39c189f9301f37632e271efb7b88"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwODA0NTM5OnYy", "diffSide": "LEFT", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/rpc/RaftRequests.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMDoyMToxM1rOH3Jtgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMDoyMToxM1rOH3Jtgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU5MjgzNQ==", "bodyText": "keep @SuppressWarnings(\"unused\")", "url": "https://github.com/hugegraph/hugegraph/pull/1275#discussion_r527592835", "createdAt": "2020-11-20T10:21:13Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/rpc/RaftRequests.java", "diffHunk": "@@ -3,14 +3,13 @@\n \n package com.baidu.hugegraph.backend.store.raft.rpc;\n \n-@SuppressWarnings(\"unused\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cefc52555d1e39c189f9301f37632e271efb7b88"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1535, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}