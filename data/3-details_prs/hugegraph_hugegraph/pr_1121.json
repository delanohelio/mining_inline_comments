{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4NDc3MDE0", "number": 1121, "title": "Fix queryByRaft readIndex failed", "bodyText": "ReadIndex request rejected because leader has not committed any log entry at its term\nChange-Id: I6f5c6fd3770da732caf0c6acd41f0441aa4acb55", "createdAt": "2020-07-29T14:28:10Z", "url": "https://github.com/hugegraph/hugegraph/pull/1121", "merged": true, "mergeCommit": {"oid": "52d2eacc81ec8cdc7f5601fb06d658dfaba25bb5"}, "closed": true, "closedAt": "2020-07-31T11:13:24Z", "author": {"login": "Linary"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5rzGhAH2gAyNDU4NDc3MDE0OjE3NjAwNTk3NjQ1M2E3N2Y2MTlmMjBjYzE0NTg4ZmQ2Y2IwYTI3NTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc6SRXegFqTQ1OTA5NjM4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "176005976453a77f619f20cc14588fd6cb0a2750", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/176005976453a77f619f20cc14588fd6cb0a2750", "committedDate": "2020-07-29T14:21:30Z", "message": "Fix queryByRaft readIndex failed\n\nReadIndex request rejected because leader has not committed any log entry at its term\n\nChange-Id: I6f5c6fd3770da732caf0c6acd41f0441aa4acb55"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MDU1MjA5", "url": "https://github.com/hugegraph/hugegraph/pull/1121#pullrequestreview-458055209", "createdAt": "2020-07-30T04:00:46Z", "commit": {"oid": "176005976453a77f619f20cc14588fd6cb0a2750"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwNDowMDo0N1rOG5SOmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwNDowNjo1MVrOG5SUcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcyMDY2Ng==", "bodyText": "rename StoreClosure closure to future", "url": "https://github.com/hugegraph/hugegraph/pull/1121#discussion_r462720666", "createdAt": "2020-07-30T04:00:47Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftBackendStore.java", "diffHunk": "@@ -229,12 +237,25 @@ public void run(Status status, long index, byte[] reqCtx) {\n                             query, status));\n                 }\n             }\n-        });\n-        try {\n-            return closure.waitFinished();\n-        } catch (Throwable t) {\n-            throw new BackendException(\"Failed to query\", t);\n+        };\n+        for (int i = 0; i < RaftSharedContext.QUERY_RETRY_TIMES; i++) {\n+            this.node().node().readIndex(BytesUtil.EMPTY_BYTES,\n+                                         readIndexClosure);\n+            try {\n+                return closure.waitFinished();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "176005976453a77f619f20cc14588fd6cb0a2750"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcyMTYxOA==", "bodyText": "move to \"status.getRaftError() == RaftError.EAGAIN\" block to line 247, just throw exception in else block", "url": "https://github.com/hugegraph/hugegraph/pull/1121#discussion_r462721618", "createdAt": "2020-07-30T04:04:43Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftBackendStore.java", "diffHunk": "@@ -215,12 +216,19 @@ private Object queryByRaft(Query query, Function<Object, Object> func) {\n         this.node().waitLeaderElected();\n         StoreCommand command = new StoreCommand(StoreAction.QUERY);\n         StoreClosure closure = new StoreClosure(command);\n-        RaftNode raftNode = this.node();\n-        raftNode.node().readIndex(BytesUtil.EMPTY_BYTES, new ReadIndexClosure() {\n+        ReadIndexClosure readIndexClosure = new ReadIndexClosure() {\n             @Override\n             public void run(Status status, long index, byte[] reqCtx) {\n                 if (status.isOk()) {\n                     closure.complete(status, () -> func.apply(query));\n+                } else if (status.getRaftError() == RaftError.EAGAIN) {\n+                    LOG.warn(\"Failed to execute query {} because of leader \" +\n+                             \"has not committed any log entry at its term\",\n+                             query);\n+                    closure.failure(status, new RaftException(\n+                            \"Failed to execute query '%s' because of leader \" +\n+                            \"has not committed any log entry at its term\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "176005976453a77f619f20cc14588fd6cb0a2750"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcyMjE2MA==", "bodyText": "collect last error message like \"retries times with error: %s\"", "url": "https://github.com/hugegraph/hugegraph/pull/1121#discussion_r462722160", "createdAt": "2020-07-30T04:06:51Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftBackendStore.java", "diffHunk": "@@ -229,12 +237,25 @@ public void run(Status status, long index, byte[] reqCtx) {\n                             query, status));\n                 }\n             }\n-        });\n-        try {\n-            return closure.waitFinished();\n-        } catch (Throwable t) {\n-            throw new BackendException(\"Failed to query\", t);\n+        };\n+        for (int i = 0; i < RaftSharedContext.QUERY_RETRY_TIMES; i++) {\n+            this.node().node().readIndex(BytesUtil.EMPTY_BYTES,\n+                                         readIndexClosure);\n+            try {\n+                return closure.waitFinished();\n+            } catch (RaftException e) {\n+                try {\n+                    Thread.sleep(RaftSharedContext.QUERY_RETRY_INTERVAL);\n+                } catch (InterruptedException ex) {\n+                    throw new BackendException(\"Try to sleep a while for \" +\n+                                               \"querying is interrupted\");\n+                }\n+            } catch (Throwable t) {\n+                throw new BackendException(\"Failed to execute query\", t);\n+            }\n         }\n+        throw new BackendException(\"Failed to query in the case of %s \" +\n+                                   \"retries times\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "176005976453a77f619f20cc14588fd6cb0a2750"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87e6ab658de8ac7b93bfdc098068069ca1a692ed", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/87e6ab658de8ac7b93bfdc098068069ca1a692ed", "committedDate": "2020-07-30T07:17:45Z", "message": "use heartbeat interval as retry interval\n\nChange-Id: Ic39d81623efa89b3f35b794f7d183201348ab871"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c859c0a65aa5053bbec15eeb54393e2e3dfd1fee", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/c859c0a65aa5053bbec15eeb54393e2e3dfd1fee", "committedDate": "2020-07-30T09:05:29Z", "message": "add listener on heartbeated\n\nChange-Id: Ied4194a6e20c3365dede4df922d4eade9b4f7477"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MjI0Njg1", "url": "https://github.com/hugegraph/hugegraph/pull/1121#pullrequestreview-458224685", "createdAt": "2020-07-30T09:11:20Z", "commit": {"oid": "c859c0a65aa5053bbec15eeb54393e2e3dfd1fee"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwOToxMToyMFrOG5ax_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwOTozNjo1NFrOG5bqtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg2MDc5OQ==", "bodyText": "move LOG.warn at line 231 here", "url": "https://github.com/hugegraph/hugegraph/pull/1121#discussion_r462860799", "createdAt": "2020-07-30T09:11:20Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftBackendStore.java", "diffHunk": "@@ -229,11 +235,12 @@ public void run(Status status, long index, byte[] reqCtx) {\n                             query, status));\n                 }\n             }\n-        });\n+        };\n+        this.node().node().readIndex(BytesUtil.EMPTY_BYTES, readIndexClosure);\n         try {\n             return closure.waitFinished();\n         } catch (Throwable t) {\n-            throw new BackendException(\"Failed to query\", t);\n+            throw new BackendException(\"Failed to execute query\", t);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c859c0a65aa5053bbec15eeb54393e2e3dfd1fee"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg2Mjg2OA==", "bodyText": "RaftNode.this.started", "url": "https://github.com/hugegraph/hugegraph/pull/1121#discussion_r462862868", "createdAt": "2020-07-30T09:15:00Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftNode.java", "diffHunk": "@@ -246,6 +274,12 @@ public void onCreated(PeerId peer) {\n             LOG.info(\"The node {} replicator has created\", peer);\n         }\n \n+        @Override\n+        public void onHeartbeated(PeerId peer) {\n+            LOG.info(\"The node {} replicator has heartbeated\", peer);\n+            started = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c859c0a65aa5053bbec15eeb54393e2e3dfd1fee"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg2MjkyOQ==", "bodyText": "ditto", "url": "https://github.com/hugegraph/hugegraph/pull/1121#discussion_r462862929", "createdAt": "2020-07-30T09:15:06Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftNode.java", "diffHunk": "@@ -266,6 +300,7 @@ private boolean isWriteBufferOverflow(Status status) {\n         @Override\n         public void onDestroyed(PeerId peer) {\n             LOG.warn(\"The node {} prepare to offline\", peer);\n+            started = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c859c0a65aa5053bbec15eeb54393e2e3dfd1fee"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg2Mzc1MA==", "bodyText": "rename waitStarted", "url": "https://github.com/hugegraph/hugegraph/pull/1121#discussion_r462863750", "createdAt": "2020-07-30T09:16:37Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftNode.java", "diffHunk": "@@ -165,6 +175,24 @@ protected void waitLeaderElected() {\n                   this.group(), WAIT_LEADER_TIMEOUT);\n     }\n \n+    protected boolean waitHeartbeated() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c859c0a65aa5053bbec15eeb54393e2e3dfd1fee"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg2NDgwNg==", "bodyText": "rename ex to e", "url": "https://github.com/hugegraph/hugegraph/pull/1121#discussion_r462864806", "createdAt": "2020-07-30T09:18:31Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftNode.java", "diffHunk": "@@ -165,6 +175,24 @@ protected void waitLeaderElected() {\n                   this.group(), WAIT_LEADER_TIMEOUT);\n     }\n \n+    protected boolean waitHeartbeated() {\n+        int electionTimeout = this.node.getOptions().getElectionTimeoutMs();\n+        // Raft election:heartbeat timeout factor\n+        int factor = this.node.getRaftOptions().getElectionHeartbeatFactor();\n+        int heartbeatInterval = electionTimeout / factor;\n+        for (int i = 0; i < RaftSharedContext.QUERY_RETRY_TIMES; i++) {\n+            if (this.started) {\n+                break;\n+            }\n+            try {\n+                Thread.sleep(heartbeatInterval);\n+            } catch (InterruptedException ex) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c859c0a65aa5053bbec15eeb54393e2e3dfd1fee"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg2NDgxOA==", "bodyText": "add cause param", "url": "https://github.com/hugegraph/hugegraph/pull/1121#discussion_r462864818", "createdAt": "2020-07-30T09:18:33Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftNode.java", "diffHunk": "@@ -165,6 +175,24 @@ protected void waitLeaderElected() {\n                   this.group(), WAIT_LEADER_TIMEOUT);\n     }\n \n+    protected boolean waitHeartbeated() {\n+        int electionTimeout = this.node.getOptions().getElectionTimeoutMs();\n+        // Raft election:heartbeat timeout factor\n+        int factor = this.node.getRaftOptions().getElectionHeartbeatFactor();\n+        int heartbeatInterval = electionTimeout / factor;\n+        for (int i = 0; i < RaftSharedContext.QUERY_RETRY_TIMES; i++) {\n+            if (this.started) {\n+                break;\n+            }\n+            try {\n+                Thread.sleep(heartbeatInterval);\n+            } catch (InterruptedException ex) {\n+                throw new BackendException(\"Waiting heartbeated is interrupted\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c859c0a65aa5053bbec15eeb54393e2e3dfd1fee"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg2NTUwOQ==", "bodyText": "rename StoreClosure closure to future", "url": "https://github.com/hugegraph/hugegraph/pull/1121#discussion_r462865509", "createdAt": "2020-07-30T09:19:45Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftBackendStore.java", "diffHunk": "@@ -212,11 +220,9 @@ private Object queryByRaft(Query query, Function<Object, Object> func) {\n             return func.apply(query);\n         }\n \n-        this.node().waitLeaderElected();\n         StoreCommand command = new StoreCommand(StoreAction.QUERY);\n         StoreClosure closure = new StoreClosure(command);\n-        RaftNode raftNode = this.node();\n-        raftNode.node().readIndex(BytesUtil.EMPTY_BYTES, new ReadIndexClosure() {\n+        ReadIndexClosure readIndexClosure = new ReadIndexClosure() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c859c0a65aa5053bbec15eeb54393e2e3dfd1fee"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg3NTMxNw==", "bodyText": "add a common waitFor(future, timeout) method", "url": "https://github.com/hugegraph/hugegraph/pull/1121#discussion_r462875317", "createdAt": "2020-07-30T09:36:54Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftBackendStore.java", "diffHunk": "@@ -86,6 +86,14 @@ public boolean isSchemaStore() {\n     public synchronized void open(HugeConfig config) {\n         this.store.open(config);\n         this.initRaftNodeIfNeeded();\n+\n+        RaftNode node = this.node();\n+        node.waitLeaderElected();\n+        if (node.node().isLeader()) {\n+            if (!node.waitHeartbeated()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c859c0a65aa5053bbec15eeb54393e2e3dfd1fee"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MjMxNjc2", "url": "https://github.com/hugegraph/hugegraph/pull/1121#pullrequestreview-458231676", "createdAt": "2020-07-30T09:20:47Z", "commit": {"oid": "c859c0a65aa5053bbec15eeb54393e2e3dfd1fee"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwOToyMDo0N1rOG5bGnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwOToyMDo0N1rOG5bGnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg2NjA3Ng==", "bodyText": "Failed to wait raft node heartbeat", "url": "https://github.com/hugegraph/hugegraph/pull/1121#discussion_r462866076", "createdAt": "2020-07-30T09:20:47Z", "author": {"login": "zhoney"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftBackendStore.java", "diffHunk": "@@ -86,6 +86,14 @@ public boolean isSchemaStore() {\n     public synchronized void open(HugeConfig config) {\n         this.store.open(config);\n         this.initRaftNodeIfNeeded();\n+\n+        RaftNode node = this.node();\n+        node.waitLeaderElected();\n+        if (node.node().isLeader()) {\n+            if (!node.waitHeartbeated()) {\n+                throw new BackendException(\"Wait raft node heartbeat failed\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c859c0a65aa5053bbec15eeb54393e2e3dfd1fee"}, "originalPosition": 9}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "73ca3f3c7543cf09d46c9a1fad0ceb1d0674fbb5", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/73ca3f3c7543cf09d46c9a1fad0ceb1d0674fbb5", "committedDate": "2020-07-30T15:02:30Z", "message": "Add wait started logic\n\nChange-Id: I689149d598ad902cc1ff5175d76557fd7b1491a0"}, "afterCommit": {"oid": "e55434bac7c5ef7ca43f70f64274fc6ad57773fd", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/e55434bac7c5ef7ca43f70f64274fc6ad57773fd", "committedDate": "2020-07-31T02:53:11Z", "message": "Add wait started logic\n\nChange-Id: I689149d598ad902cc1ff5175d76557fd7b1491a0"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e55434bac7c5ef7ca43f70f64274fc6ad57773fd", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/e55434bac7c5ef7ca43f70f64274fc6ad57773fd", "committedDate": "2020-07-31T02:53:11Z", "message": "Add wait started logic\n\nChange-Id: I689149d598ad902cc1ff5175d76557fd7b1491a0"}, "afterCommit": {"oid": "b42e21eedc6bd4e7290912cd631b1178e6b97e0e", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/b42e21eedc6bd4e7290912cd631b1178e6b97e0e", "committedDate": "2020-07-31T03:07:44Z", "message": "Add wait started logic\n\nChange-Id: I689149d598ad902cc1ff5175d76557fd7b1491a0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e81fadc8c492d3a5a4ce1745a1071265d92996ba", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/e81fadc8c492d3a5a4ce1745a1071265d92996ba", "committedDate": "2020-07-31T03:25:33Z", "message": "Add wait started logic\n\nChange-Id: I689149d598ad902cc1ff5175d76557fd7b1491a0"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b42e21eedc6bd4e7290912cd631b1178e6b97e0e", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/b42e21eedc6bd4e7290912cd631b1178e6b97e0e", "committedDate": "2020-07-31T03:07:44Z", "message": "Add wait started logic\n\nChange-Id: I689149d598ad902cc1ff5175d76557fd7b1491a0"}, "afterCommit": {"oid": "e81fadc8c492d3a5a4ce1745a1071265d92996ba", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/e81fadc8c492d3a5a4ce1745a1071265d92996ba", "committedDate": "2020-07-31T03:25:33Z", "message": "Add wait started logic\n\nChange-Id: I689149d598ad902cc1ff5175d76557fd7b1491a0"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4ODk2MzUy", "url": "https://github.com/hugegraph/hugegraph/pull/1121#pullrequestreview-458896352", "createdAt": "2020-07-31T03:33:01Z", "commit": {"oid": "e81fadc8c492d3a5a4ce1745a1071265d92996ba"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMzozMzowMVrOG567NA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMzozNTowOFrOG5683A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM4NzQ0NA==", "bodyText": "abdicated from follower", "url": "https://github.com/hugegraph/hugegraph/pull/1121#discussion_r463387444", "createdAt": "2020-07-31T03:33:01Z", "author": {"login": "zhoney"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/StoreStateMachine.java", "diffHunk": "@@ -199,30 +194,44 @@ public boolean onSnapshotLoad(SnapshotReader reader) {\n             LOG.warn(\"Leader is not supposed to load snapshot.\");\n             return false;\n         }\n-        LOG.debug(\"The node {} start snapshot load\", this.nodeId);\n+        LOG.debug(\"The node {} start snapshot load\", this.node.nodeId());\n         return this.snapshotFile.load(this.store, reader);\n     }\n \n     @Override\n     public void onLeaderStart(long term) {\n-        LOG.info(\"The node {} become to leader\", this.nodeId);\n-        this.leaderTerm.set(term);\n+        LOG.info(\"The node {} become to leader\", this.node.nodeId());\n+        this.node.onElected(true);\n         super.onLeaderStart(term);\n     }\n \n     @Override\n     public void onLeaderStop(Status status) {\n-        LOG.info(\"The node {} abdicated from leader\", this.nodeId);\n-        this.leaderTerm.set(-1);\n+        LOG.info(\"The node {} abdicated from leader\", this.node.nodeId());\n+        this.node.onElected(false);\n         super.onLeaderStop(status);\n     }\n \n+    @Override\n+    public void onStartFollowing(LeaderChangeContext ctx) {\n+        LOG.info(\"The node {} become to follower\", this.node.nodeId());\n+        this.node.onElected(true);\n+        super.onStartFollowing(ctx);\n+    }\n+\n+    @Override\n+    public void onStopFollowing(LeaderChangeContext ctx) {\n+        LOG.info(\"The node {} become to follower\", this.node.nodeId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e81fadc8c492d3a5a4ce1745a1071265d92996ba"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM4Nzg2OA==", "bodyText": "should use this.call() if graph.initlalized() will open tx (ensure graph tx closed when graph close)", "url": "https://github.com/hugegraph/hugegraph/pull/1121#discussion_r463387868", "createdAt": "2020-07-31T03:35:08Z", "author": {"login": "zhoney"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/task/ServerInfoManager.java", "diffHunk": "@@ -337,7 +335,7 @@ private HugeServerInfo serverInfo(Id server) {\n     }\n \n     private HugeServerInfo removeSelfServerInfo() {\n-        if (this.initialized()) {\n+        if (this.graph.initialized()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e81fadc8c492d3a5a4ce1745a1071265d92996ba"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4ODk0MjYw", "url": "https://github.com/hugegraph/hugegraph/pull/1121#pullrequestreview-458894260", "createdAt": "2020-07-31T03:23:42Z", "commit": {"oid": "b42e21eedc6bd4e7290912cd631b1178e6b97e0e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMzoyMzo0M1rOG56zvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMzoyNDowMlrOG56z9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM4NTUzMg==", "bodyText": "also define NO_TIMEOUT", "url": "https://github.com/hugegraph/hugegraph/pull/1121#discussion_r463385532", "createdAt": "2020-07-31T03:23:43Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftBackendStore.java", "diffHunk": "@@ -86,13 +86,13 @@ public boolean isSchemaStore() {\n     public synchronized void open(HugeConfig config) {\n         this.store.open(config);\n         this.initRaftNodeIfNeeded();\n+    }\n \n+    public void waitStoreStarted() {\n         RaftNode node = this.node();\n-        node.waitLeaderElected();\n+        node.waitLeaderElected(RaftSharedContext.WAIT_LEADER_TIMEOUT);\n         if (node.node().isLeader()) {\n-            if (!node.waitHeartbeated()) {\n-                throw new BackendException(\"Wait raft node heartbeat failed\");\n-            }\n+            node.waitHeartbeated(-1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b42e21eedc6bd4e7290912cd631b1178e6b97e0e"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM4NTU5MQ==", "bodyText": "check not null", "url": "https://github.com/hugegraph/hugegraph/pull/1121#discussion_r463385591", "createdAt": "2020-07-31T03:24:02Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftBackendStoreProvider.java", "diffHunk": "@@ -105,6 +105,13 @@ public void open(String name) {\n         this.provider.open(name);\n     }\n \n+    @Override\n+    public void waitStoreStarted() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b42e21eedc6bd4e7290912cd631b1178e6b97e0e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a3a5a51d2d1286879bf99e94fd6226417a50c51", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/3a3a5a51d2d1286879bf99e94fd6226417a50c51", "committedDate": "2020-07-31T07:28:54Z", "message": "use polling to wait heartbeat\n\nChange-Id: I1218ec628755434be909f520fe9655ff2b01af85"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8f53adb52fa31b8e12f6bcace7c5c3fccd61926c", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/8f53adb52fa31b8e12f6bcace7c5c3fccd61926c", "committedDate": "2020-07-31T06:53:28Z", "message": "use polling to wait heartbeat\n\nChange-Id: I1218ec628755434be909f520fe9655ff2b01af85"}, "afterCommit": {"oid": "3a3a5a51d2d1286879bf99e94fd6226417a50c51", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/3a3a5a51d2d1286879bf99e94fd6226417a50c51", "committedDate": "2020-07-31T07:28:54Z", "message": "use polling to wait heartbeat\n\nChange-Id: I1218ec628755434be909f520fe9655ff2b01af85"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fccc553c3cdcb3ee8ecaf1548c82104ddcd04fad", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/fccc553c3cdcb3ee8ecaf1548c82104ddcd04fad", "committedDate": "2020-07-31T10:16:53Z", "message": "use closed field as serverInfoManager flag\n\nChange-Id: I2a2e0cc6f0a2e65e23a1b9b2192dd50d8b28224c"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5MDc3Mjk5", "url": "https://github.com/hugegraph/hugegraph/pull/1121#pullrequestreview-459077299", "createdAt": "2020-07-31T10:33:46Z", "commit": {"oid": "fccc553c3cdcb3ee8ecaf1548c82104ddcd04fad"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxMDozMzo0NlrOG6D9Jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxMDozNTowN1rOG6D_fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUzNTM5OQ==", "bodyText": "define const interval", "url": "https://github.com/hugegraph/hugegraph/pull/1121#discussion_r463535399", "createdAt": "2020-07-31T10:33:46Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftNode.java", "diffHunk": "@@ -138,31 +153,73 @@ public Object submitAndWait(StoreCommand command, StoreClosure closure) {\n         }\n     }\n \n-    protected void waitLeaderElected() {\n+    public void onElected(boolean value) {\n+        synchronized(this.electedLock) {\n+            this.elected = value;\n+            this.electedLock.notify();\n+        }\n+    }\n+\n+    protected void waitLeaderElected(int timeout) {\n         if (this.node.getLeaderId() != null) {\n             return;\n         }\n-\n-        int consumeTime = WAIT_LEADER_TIMEOUT;\n-        int sleepInterval = 100;\n-        while (consumeTime > 0) {\n-            PeerId leaderId = this.node.getLeaderId();\n-            if (leaderId != null) {\n-                return;\n-            } else {\n+        long beginTime = System.currentTimeMillis();\n+        int internalTimeout = 3000;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fccc553c3cdcb3ee8ecaf1548c82104ddcd04fad"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUzNTg5Ng==", "bodyText": "define", "url": "https://github.com/hugegraph/hugegraph/pull/1121#discussion_r463535896", "createdAt": "2020-07-31T10:34:56Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftNode.java", "diffHunk": "@@ -138,31 +153,73 @@ public Object submitAndWait(StoreCommand command, StoreClosure closure) {\n         }\n     }\n \n-    protected void waitLeaderElected() {\n+    public void onElected(boolean value) {\n+        synchronized(this.electedLock) {\n+            this.elected = value;\n+            this.electedLock.notify();\n+        }\n+    }\n+\n+    protected void waitLeaderElected(int timeout) {\n         if (this.node.getLeaderId() != null) {\n             return;\n         }\n-\n-        int consumeTime = WAIT_LEADER_TIMEOUT;\n-        int sleepInterval = 100;\n-        while (consumeTime > 0) {\n-            PeerId leaderId = this.node.getLeaderId();\n-            if (leaderId != null) {\n-                return;\n-            } else {\n+        long beginTime = System.currentTimeMillis();\n+        int internalTimeout = 3000;\n+        synchronized(this.electedLock) {\n+            while (!this.elected) {\n                 try {\n-                    Thread.sleep(sleepInterval);\n+                    this.electedLock.wait(internalTimeout);\n                 } catch (InterruptedException e) {\n                     throw new BackendException(\n-                              \"Raft group '%s' doesn't elect leader in %s ms\",\n-                              this.group(), WAIT_LEADER_TIMEOUT - consumeTime);\n+                              \"Wait raft group '%s' election error\",\n+                              e, this.group(), \"election\");\n                 }\n-                consumeTime -= sleepInterval;\n+                long consumedTime = System.currentTimeMillis() - beginTime;\n+                if (timeout > 0 && consumedTime >= timeout) {\n+                    throw new BackendException(\n+                              \"Wait raft group '{}' election timeout({}ms)\",\n+                              this.group(), \"\", consumedTime);\n+                }\n+                LOG.warn(\"Waiting raft group '{}' election cost {}s\",\n+                         this.group(), consumedTime / 1000.0);\n+            }\n+        }\n+    }\n+\n+    protected void waitStarted(int timeout) {\n+        ReadIndexClosure readIndexClosure = new ReadIndexClosure() {\n+            @Override\n+            public void run(Status status, long index, byte[] reqCtx) {\n+                if (status.isOk()) {\n+                    RaftNode.this.started = true;\n+                } else {\n+                    RaftNode.this.started = false;\n+                }\n+            }\n+        };\n+        long beginTime = System.currentTimeMillis();\n+        int internalTimeout = 3000;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fccc553c3cdcb3ee8ecaf1548c82104ddcd04fad"}, "originalPosition": 149}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUzNTk5OA==", "bodyText": "address", "url": "https://github.com/hugegraph/hugegraph/pull/1121#discussion_r463535998", "createdAt": "2020-07-31T10:35:07Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftNode.java", "diffHunk": "@@ -165,6 +175,24 @@ protected void waitLeaderElected() {\n                   this.group(), WAIT_LEADER_TIMEOUT);\n     }\n \n+    protected boolean waitHeartbeated() {\n+        int electionTimeout = this.node.getOptions().getElectionTimeoutMs();\n+        // Raft election:heartbeat timeout factor\n+        int factor = this.node.getRaftOptions().getElectionHeartbeatFactor();\n+        int heartbeatInterval = electionTimeout / factor;\n+        for (int i = 0; i < RaftSharedContext.QUERY_RETRY_TIMES; i++) {\n+            if (this.started) {\n+                break;\n+            }\n+            try {\n+                Thread.sleep(heartbeatInterval);\n+            } catch (InterruptedException ex) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg2NDgwNg=="}, "originalCommit": {"oid": "c859c0a65aa5053bbec15eeb54393e2e3dfd1fee"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "338ca00aaa899173329c5d54e46ca61289374338", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/338ca00aaa899173329c5d54e46ca61289374338", "committedDate": "2020-07-31T10:41:40Z", "message": "tiny improve\n\nChange-Id: I1f191a261979a9ffe232827d0c639642547ba5b7"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5MDkwMzY5", "url": "https://github.com/hugegraph/hugegraph/pull/1121#pullrequestreview-459090369", "createdAt": "2020-07-31T10:58:25Z", "commit": {"oid": "338ca00aaa899173329c5d54e46ca61289374338"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5MDk2Mzg4", "url": "https://github.com/hugegraph/hugegraph/pull/1121#pullrequestreview-459096388", "createdAt": "2020-07-31T11:10:57Z", "commit": {"oid": "338ca00aaa899173329c5d54e46ca61289374338"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2251, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}