{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1MjU2MTA5", "number": 1202, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwOTozMTozM1rOEo8sqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwODoxMjoyMVrOEzsDwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExMzcyOTY4OnYy", "diffSide": "RIGHT", "path": "hugegraph-rocksdb/src/main/java/com/baidu/hugegraph/backend/store/rocksdb/RocksDBStdSessions.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwOTozMTozM1rOHaVNOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwOTozMTozM1rOHaVNOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM3MjQ3Mw==", "bodyText": "unneeded to reload rocksdb if not operate batch after CF is dropped.\nbut we can keep these code for future use (don't --amend)", "url": "https://github.com/hugegraph/hugegraph/pull/1202#discussion_r497372473", "createdAt": "2020-09-30T09:31:33Z", "author": {"login": "javeme"}, "path": "hugegraph-rocksdb/src/main/java/com/baidu/hugegraph/backend/store/rocksdb/RocksDBStdSessions.java", "diffHunk": "@@ -247,6 +251,36 @@ public synchronized void dropTable(String... tables)\n         }\n     }\n \n+    public void reload() throws RocksDBException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "436c691c02fef34ec2c015b52e9725dbf8918f70"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMTI1OTk3OnYy", "diffSide": "RIGHT", "path": "hugegraph-rocksdb/src/main/java/com/baidu/hugegraph/backend/store/rocksdb/RocksDBStdSessions.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwOTowMzoyOVrOHqSQkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwOTowMzoyOVrOHqSQkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEwMTM5NA==", "bodyText": "set final", "url": "https://github.com/hugegraph/hugegraph/pull/1202#discussion_r514101394", "createdAt": "2020-10-29T09:03:29Z", "author": {"login": "javeme"}, "path": "hugegraph-rocksdb/src/main/java/com/baidu/hugegraph/backend/store/rocksdb/RocksDBStdSessions.java", "diffHunk": "@@ -67,17 +67,18 @@\n import com.baidu.hugegraph.backend.store.BackendEntryIterator;\n import com.baidu.hugegraph.config.HugeConfig;\n import com.baidu.hugegraph.util.Bytes;\n-import com.baidu.hugegraph.util.GZipUtil;\n import com.baidu.hugegraph.util.E;\n+import com.baidu.hugegraph.util.GZipUtil;\n import com.baidu.hugegraph.util.StringEncoding;\n import com.google.common.collect.ImmutableList;\n \n public class RocksDBStdSessions extends RocksDBSessions {\n \n+    private final HugeConfig config;\n     private final String dataPath;\n     private final String walPath;\n \n-    private final RocksDB rocksdb;\n+    private volatile RocksDB rocksdb;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e460e0217b84d81d2d813c00d4322e33b04d04ad"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMTI2NzEwOnYy", "diffSide": "RIGHT", "path": "hugegraph-rocksdb/src/main/java/com/baidu/hugegraph/backend/store/rocksdb/RocksDBStore.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwOTowNToxNFrOHqSUsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwOTowNToxNFrOHqSUsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEwMjQ1MQ==", "bodyText": "rename to truncateLock", "url": "https://github.com/hugegraph/hugegraph/pull/1202#discussion_r514102451", "createdAt": "2020-10-29T09:05:14Z", "author": {"login": "javeme"}, "path": "hugegraph-rocksdb/src/main/java/com/baidu/hugegraph/backend/store/rocksdb/RocksDBStore.java", "diffHunk": "@@ -79,6 +83,8 @@\n     private RocksDBSessions sessions;\n     private final Map<HugeType, String> tableDiskMapping;\n \n+    private final ReadWriteLock lock;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e460e0217b84d81d2d813c00d4322e33b04d04ad"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMTI3MDY4OnYy", "diffSide": "RIGHT", "path": "hugegraph-rocksdb/src/main/java/com/baidu/hugegraph/backend/store/rocksdb/RocksDBStore.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwOTowNjowM1rOHqSWyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwOTowNjowM1rOHqSWyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEwMjk4NA==", "bodyText": "remove space", "url": "https://github.com/hugegraph/hugegraph/pull/1202#discussion_r514102984", "createdAt": "2020-10-29T09:06:03Z", "author": {"login": "javeme"}, "path": "hugegraph-rocksdb/src/main/java/com/baidu/hugegraph/backend/store/rocksdb/RocksDBStore.java", "diffHunk": "@@ -344,18 +351,24 @@ public boolean opened() {\n \n     @Override\n     public void mutate(BackendMutation mutation) {\n-        this.checkOpened();\n+        Lock readLock = this.lock.readLock();\n+        readLock.lock();\n+        try {\n+            this.checkOpened();\n \n-        if (LOG.isDebugEnabled()) {\n-            LOG.debug(\"Store {} mutation: {}\", this.store, mutation);\n-        }\n+            if (LOG.isDebugEnabled()) {\n+                LOG.debug(\"Store {} mutation: {}\", this.store, mutation);\n+            }\n \n-        for (HugeType type : mutation.types()) {\n-            Session session = this.session(type);\n-            for (Iterator<BackendAction> it = mutation.mutation(type);\n-                 it.hasNext();) {\n-                this.mutate(session, it.next());\n+            for (HugeType type : mutation.types()) {\n+                Session session = this.session(type);\n+                for (Iterator<BackendAction> it = mutation.mutation(type);\n+                     it.hasNext(); ) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e460e0217b84d81d2d813c00d4322e33b04d04ad"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyNjM0MTIwOnYy", "diffSide": "RIGHT", "path": "hugegraph-rocksdb/src/main/java/com/baidu/hugegraph/backend/store/rocksdb/RocksDBStdSessions.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwODoxMDoyNFrOHrEzQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwODoxMDoyNFrOHrEzQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkyOTQ3Mw==", "bodyText": "Config can be removed by making config protected in super class.", "url": "https://github.com/hugegraph/hugegraph/pull/1202#discussion_r514929473", "createdAt": "2020-10-30T08:10:24Z", "author": {"login": "houzhizhen"}, "path": "hugegraph-rocksdb/src/main/java/com/baidu/hugegraph/backend/store/rocksdb/RocksDBStdSessions.java", "diffHunk": "@@ -87,6 +88,7 @@ public RocksDBStdSessions(HugeConfig config, String database, String store,\n                               String dataPath, String walPath)\n                               throws RocksDBException {\n         super(config, database, store);\n+        this.config = config;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae545199a3a74758c19bf3a9df0fbddb51e1f979"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyNjM0Njg5OnYy", "diffSide": "RIGHT", "path": "hugegraph-rocksdb/src/main/java/com/baidu/hugegraph/backend/store/rocksdb/RocksDBStdSessions.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwODoxMjoyMVrOHrE2jQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwODoxMjoyMVrOHrE2jQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkzMDMxNw==", "bodyText": "using constructor chain by this(...) can reduce some duplicate codes.", "url": "https://github.com/hugegraph/hugegraph/pull/1202#discussion_r514930317", "createdAt": "2020-10-30T08:12:21Z", "author": {"login": "houzhizhen"}, "path": "hugegraph-rocksdb/src/main/java/com/baidu/hugegraph/backend/store/rocksdb/RocksDBStdSessions.java", "diffHunk": "@@ -112,6 +114,7 @@ public RocksDBStdSessions(HugeConfig config, String database, String store,\n                               String dataPath, String walPath,\n                               List<String> cfNames) throws RocksDBException {\n         super(config, database, store);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae545199a3a74758c19bf3a9df0fbddb51e1f979"}, "originalPosition": 27}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1506, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}