{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzNDQxNjk3", "number": 1004, "title": "fix auth: property of int or date type can't be filtered", "bodyText": "Change-Id: I794165b89b9d21f31938f09daa2041881ba2eb8d", "createdAt": "2020-05-26T20:17:55Z", "url": "https://github.com/hugegraph/hugegraph/pull/1004", "merged": true, "mergeCommit": {"oid": "073b070f8e59d52175c895ea5e73042efd770b82"}, "closed": true, "closedAt": "2020-06-04T09:59:00Z", "author": {"login": "javeme"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclKfSHAH2gAyNDIzNDQxNjk3OjkxZTIxM2U3ZWQ5YTFkZGJhNjkyMjM0NmQ5OWI3ODI3MDg3MGE1ZGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcn7EsJgFqTQyNDI4NzcwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "91e213e7ed9a1ddba6922346d99b78270870a5df", "author": {"user": {"login": "javeme", "name": "Jermy Li"}}, "url": "https://github.com/hugegraph/hugegraph/commit/91e213e7ed9a1ddba6922346d99b78270870a5df", "committedDate": "2020-05-26T20:14:30Z", "message": "fix auth: property of int or date type can't be filtered\n\nChange-Id: I794165b89b9d21f31938f09daa2041881ba2eb8d"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "23601652065bb37a270c6c4193125974fe6a0206", "author": {"user": {"login": "javeme", "name": "Jermy Li"}}, "url": "https://github.com/hugegraph/hugegraph/commit/23601652065bb37a270c6c4193125974fe6a0206", "committedDate": "2020-05-26T20:19:52Z", "message": "add WsAndHttpBasicAuthHandler to fix crosstalk users\n\nChange-Id: Id07a2f24b4625402250bd5e137f3db7eef3a8888"}, "afterCommit": {"oid": "8729de07f9b4c36641513d5d38bb50f4c2ba6e37", "author": {"user": {"login": "javeme", "name": "Jermy Li"}}, "url": "https://github.com/hugegraph/hugegraph/commit/8729de07f9b4c36641513d5d38bb50f4c2ba6e37", "committedDate": "2020-05-26T20:26:50Z", "message": "add WsAndHttpBasicAuthHandler to fix crosstalk users\n\nChange-Id: Id07a2f24b4625402250bd5e137f3db7eef3a8888"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c04377dcaa8e677522134e2389a13666a08a8467", "author": {"user": {"login": "javeme", "name": "Jermy Li"}}, "url": "https://github.com/hugegraph/hugegraph/commit/c04377dcaa8e677522134e2389a13666a08a8467", "committedDate": "2020-05-27T13:15:59Z", "message": "support P.contains() for list/set property\n\nChange-Id: I13678f1a28886c9592f8ea2ae51f953a5b4d6774"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e35a9db3bb52c0420e878844da24043e1f034c56", "author": {"user": {"login": "javeme", "name": "Jermy Li"}}, "url": "https://github.com/hugegraph/hugegraph/commit/e35a9db3bb52c0420e878844da24043e1f034c56", "committedDate": "2020-05-27T13:16:17Z", "message": "add WsAndHttpBasicAuthHandler to fix crosstalk users\n\nChange-Id: Id07a2f24b4625402250bd5e137f3db7eef3a8888"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8729de07f9b4c36641513d5d38bb50f4c2ba6e37", "author": {"user": {"login": "javeme", "name": "Jermy Li"}}, "url": "https://github.com/hugegraph/hugegraph/commit/8729de07f9b4c36641513d5d38bb50f4c2ba6e37", "committedDate": "2020-05-26T20:26:50Z", "message": "add WsAndHttpBasicAuthHandler to fix crosstalk users\n\nChange-Id: Id07a2f24b4625402250bd5e137f3db7eef3a8888"}, "afterCommit": {"oid": "e35a9db3bb52c0420e878844da24043e1f034c56", "author": {"user": {"login": "javeme", "name": "Jermy Li"}}, "url": "https://github.com/hugegraph/hugegraph/commit/e35a9db3bb52c0420e878844da24043e1f034c56", "committedDate": "2020-05-27T13:16:17Z", "message": "add WsAndHttpBasicAuthHandler to fix crosstalk users\n\nChange-Id: Id07a2f24b4625402250bd5e137f3db7eef3a8888"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb760e02d02f7579c18ad111314090309aaeb241", "author": {"user": {"login": "javeme", "name": "Jermy Li"}}, "url": "https://github.com/hugegraph/hugegraph/commit/eb760e02d02f7579c18ad111314090309aaeb241", "committedDate": "2020-05-28T22:26:35Z", "message": "fix blob property read/write/compare\n\nsupport construct blob from byte[],base64-string,hex-string,byte-list\n\nChange-Id: I47357c537dcdacae2913139fd55f3794f57f322a"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5e4c2d446ad690f20d613d4f6799b90c205d9091", "author": {"user": {"login": "javeme", "name": "Jermy Li"}}, "url": "https://github.com/hugegraph/hugegraph/commit/5e4c2d446ad690f20d613d4f6799b90c205d9091", "committedDate": "2020-05-28T21:28:18Z", "message": "fix blob property read/write/compare\n\nsupport construct blob from byte[],base64-string,hex-string,byte-list\n\nChange-Id: I47357c537dcdacae2913139fd55f3794f57f322a"}, "afterCommit": {"oid": "eb760e02d02f7579c18ad111314090309aaeb241", "author": {"user": {"login": "javeme", "name": "Jermy Li"}}, "url": "https://github.com/hugegraph/hugegraph/commit/eb760e02d02f7579c18ad111314090309aaeb241", "committedDate": "2020-05-28T22:26:35Z", "message": "fix blob property read/write/compare\n\nsupport construct blob from byte[],base64-string,hex-string,byte-list\n\nChange-Id: I47357c537dcdacae2913139fd55f3794f57f322a"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "531515368d6cb1c64f6752d6eaf113bb6d5be73b", "author": {"user": {"login": "javeme", "name": "Jermy Li"}}, "url": "https://github.com/hugegraph/hugegraph/commit/531515368d6cb1c64f6752d6eaf113bb6d5be73b", "committedDate": "2020-05-29T13:33:57Z", "message": "improve auth log for tasks\n\nChange-Id: I62bb87ac346813984c23038f27e24e5566bb3cac"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNjI5Mzc4", "url": "https://github.com/hugegraph/hugegraph/pull/1004#pullrequestreview-421629378", "createdAt": "2020-06-01T06:54:44Z", "commit": {"oid": "531515368d6cb1c64f6752d6eaf113bb6d5be73b"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e07b831fd7f07a94e8f346f59944cc45e6c1176", "author": {"user": {"login": "javeme", "name": "Jermy Li"}}, "url": "https://github.com/hugegraph/hugegraph/commit/2e07b831fd7f07a94e8f346f59944cc45e6c1176", "committedDate": "2020-06-01T08:47:46Z", "message": "fix validPropertyValue with blob and Cardinality.SINGLE\n\nChange-Id: Ic13c7a4bc8ebd591f3f8e5657fcc3cb1708706f9"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82afc2dc4e66047e7cbb540d40a85542083d9488", "author": {"user": {"login": "javeme", "name": "Jermy Li"}}, "url": "https://github.com/hugegraph/hugegraph/commit/82afc2dc4e66047e7cbb540d40a85542083d9488", "committedDate": "2020-06-02T13:12:23Z", "message": "fix validPropertyValue with list/set property and P.contains(value)\n\nChange-Id: Ice21c4493347d8ca02cce2d184648ef3824484e3"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMTU0NjU1", "url": "https://github.com/hugegraph/hugegraph/pull/1004#pullrequestreview-423154655", "createdAt": "2020-06-03T01:09:37Z", "commit": {"oid": "82afc2dc4e66047e7cbb540d40a85542083d9488"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwMTowOTozN1rOGeI3Tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwMToxNTo1MFrOGeI9bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI1NTY5NQ==", "bodyText": "rename to KEY_ADDRESS", "url": "https://github.com/hugegraph/hugegraph/pull/1004#discussion_r434255695", "createdAt": "2020-06-03T01:09:37Z", "author": {"login": "zhoney"}, "path": "hugegraph-api/src/main/java/com/baidu/hugegraph/auth/HugeAuthenticator.java", "diffHunk": "@@ -48,7 +48,7 @@\n     public static final String KEY_PASSWORD =\n                                CredentialGraphTokens.PROPERTY_PASSWORD;\n     public static final String KEY_ROLE = \"role\";\n-    public static final String KEY_CLIENT = \"client\";\n+    public static final String KEY_CLIENT = \"address\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82afc2dc4e66047e7cbb540d40a85542083d9488"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI1NjYxMQ==", "bodyText": "recheck to make sure it's expected", "url": "https://github.com/hugegraph/hugegraph/pull/1004#discussion_r434256611", "createdAt": "2020-06-03T01:13:11Z", "author": {"login": "zhoney"}, "path": "hugegraph-api/src/main/java/com/baidu/hugegraph/auth/WsAndHttpBasicAuthHandler.java", "diffHunk": "@@ -0,0 +1,162 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.baidu.hugegraph.auth;\n+\n+import static io.netty.handler.codec.http.HttpHeaderNames.CONNECTION;\n+import static io.netty.handler.codec.http.HttpHeaderNames.UPGRADE;\n+import static io.netty.handler.codec.http.HttpResponseStatus.UNAUTHORIZED;\n+import static io.netty.handler.codec.http.HttpVersion.HTTP_1_1;\n+import static org.apache.tinkerpop.gremlin.groovy.jsr223.dsl.credential.CredentialGraphTokens.PROPERTY_PASSWORD;\n+import static org.apache.tinkerpop.gremlin.groovy.jsr223.dsl.credential.CredentialGraphTokens.PROPERTY_USERNAME;\n+\n+import java.nio.charset.Charset;\n+import java.util.Base64;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.apache.tinkerpop.gremlin.server.Settings;\n+import org.apache.tinkerpop.gremlin.server.auth.AuthenticationException;\n+import org.apache.tinkerpop.gremlin.server.auth.Authenticator;\n+import org.apache.tinkerpop.gremlin.server.handler.AbstractAuthenticationHandler;\n+import org.apache.tinkerpop.gremlin.server.handler.SaslAuthenticationHandler;\n+\n+import io.netty.channel.ChannelFutureListener;\n+import io.netty.channel.ChannelHandler;\n+import io.netty.channel.ChannelHandlerContext;\n+import io.netty.channel.ChannelPipeline;\n+import io.netty.handler.codec.http.DefaultFullHttpResponse;\n+import io.netty.handler.codec.http.FullHttpMessage;\n+import io.netty.handler.codec.http.HttpMessage;\n+import io.netty.util.ReferenceCountUtil;\n+\n+/**\n+ * An Authentication Handler for doing WebSocket and Http Basic auth\n+ * TODO: remove this class after fixed TINKERPOP-2374\n+ */\n+@ChannelHandler.Sharable\n+public class WsAndHttpBasicAuthHandler extends SaslAuthenticationHandler {\n+\n+    private static final String AUTHENTICATOR = \"authenticator\";\n+    private static final String HTTP_AUTH = \"http-authentication\";\n+\n+    public WsAndHttpBasicAuthHandler(Authenticator authenticator,\n+                                     Settings.AuthenticationSettings settings) {\n+        super(authenticator, settings);\n+    }\n+\n+    @Override\n+    public void channelRead(final ChannelHandlerContext ctx, final Object obj)\n+                            throws Exception {\n+        if (obj instanceof HttpMessage && !isWebSocket((HttpMessage) obj)) {\n+            ChannelPipeline pipeline = ctx.pipeline();\n+            ChannelHandler authHandler = pipeline.get(HTTP_AUTH);\n+            if (authHandler != null) {\n+                authHandler = pipeline.remove(HTTP_AUTH);\n+            } else {\n+                authHandler = new HttpBasicAuthHandler(\n+                              this.authenticator,  this.authenticationSettings);\n+            }\n+            pipeline.addAfter(AUTHENTICATOR, HTTP_AUTH, authHandler);\n+            ctx.fireChannelRead(obj);\n+        } else {\n+            super.channelRead(ctx, obj);\n+        }\n+    }\n+\n+    public static boolean isWebSocket(final HttpMessage msg) {\n+        final String connectionHeader = msg.headers().get(CONNECTION);\n+        final String upgradeHeader = msg.headers().get(UPGRADE);\n+        return \"Upgrade\".equalsIgnoreCase(connectionHeader) ||", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82afc2dc4e66047e7cbb540d40a85542083d9488"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI1NzEzMQ==", "bodyText": "this. cardinality.single()", "url": "https://github.com/hugegraph/hugegraph/pull/1004#discussion_r434257131", "createdAt": "2020-06-03T01:15:24Z", "author": {"login": "zhoney"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/schema/PropertyKey.java", "diffHunk": "@@ -214,11 +181,43 @@ public String clazz() {\n         return valid;\n     }\n \n+    /**\n+     * Check type of the value valid\n+     * @param value the property value to be checked data type\n+     * @param <V>   the property value original data type\n+     * @return true if the value is or can convert to the data type,\n+     *         otherwise false\n+     */\n+    private <V> boolean checkDataType(V value) {\n+        return this.dataType().clazz().isInstance(value);\n+    }\n+\n+    /**\n+     * Check type of all the values(may be some of list properties) valid\n+     * @param values the property values to be checked data type\n+     * @param <V> the property value class\n+     * @return true if all the values are or can convert to the data type,\n+     *         otherwise false\n+     */\n+    private <V> boolean checkDataType(Collection<V> values) {\n+        boolean valid = true;\n+        for (Object o : values) {\n+            if (!this.checkDataType(o)) {\n+                valid = false;\n+                break;\n+            }\n+        }\n+        return valid;\n+    }\n+\n     public <V> Object serialValue(V value) {\n         V validValue = this.validValue(value);\n         E.checkArgument(validValue != null,\n                         \"Invalid property value '%s' for key '%s'\",\n                         value, this.name());\n+        E.checkArgument(this.cardinality == Cardinality.SINGLE,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82afc2dc4e66047e7cbb540d40a85542083d9488"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI1NzI2Mw==", "bodyText": "this.cardinality.single()", "url": "https://github.com/hugegraph/hugegraph/pull/1004#discussion_r434257263", "createdAt": "2020-06-03T01:15:50Z", "author": {"login": "zhoney"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/schema/PropertyKey.java", "diffHunk": "@@ -238,46 +237,61 @@ public String clazz() {\n     }\n \n     public <V> V validValue(V value) {\n-        return this.convValue(value, true);\n+        try {\n+            return this.convValue(value);\n+        } catch (RuntimeException e) {\n+            throw new IllegalArgumentException(String.format(\n+                      \"Invalid property value '%s' for key '%s': %s\",\n+                      value, this.name(), e.getMessage()));\n+        }\n     }\n \n     @SuppressWarnings(\"unchecked\")\n-    public <V, T> V convValue(V value, boolean checkValue) {\n+    private <V, T> V convValue(V value) {\n         if (value == null) {\n             return null;\n         }\n+        if (this.checkValueType(value)) {\n+            // Same as expected type, no conversion required\n+            return value;\n+        }\n \n-        V validValue;\n+        V validValue = null;\n         Collection<T> validValues;\n-        if (!(value instanceof Collection)) {\n+        if (this.cardinality == Cardinality.SINGLE) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82afc2dc4e66047e7cbb540d40a85542083d9488"}, "originalPosition": 138}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92d27d63cd9fce2fcfceec90d80b489652f35ee3", "author": {"user": {"login": "javeme", "name": "Jermy Li"}}, "url": "https://github.com/hugegraph/hugegraph/commit/92d27d63cd9fce2fcfceec90d80b489652f35ee3", "committedDate": "2020-06-04T07:15:00Z", "message": "tiny improve\n\nChange-Id: I9227897f9ddb00cb5cf0547e43fc8d06c150f191"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MjgwMzMz", "url": "https://github.com/hugegraph/hugegraph/pull/1004#pullrequestreview-424280333", "createdAt": "2020-06-04T09:48:59Z", "commit": {"oid": "92d27d63cd9fce2fcfceec90d80b489652f35ee3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0Mjg3NzA4", "url": "https://github.com/hugegraph/hugegraph/pull/1004#pullrequestreview-424287708", "createdAt": "2020-06-04T09:58:39Z", "commit": {"oid": "92d27d63cd9fce2fcfceec90d80b489652f35ee3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2432, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}