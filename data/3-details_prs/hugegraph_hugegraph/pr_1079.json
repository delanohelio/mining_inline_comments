{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0MTAwNzIx", "number": 1079, "title": "fix task scheduler bugs: dead lock and dup server-info", "bodyText": "fix dead lock when scheduler-worker hold scheduleTasks lock then\nquery tasks, tx() method synchronized(this) wait indefinitely.\ndelete server-info when graph close (when store is initialized)\nthrow exception if task if failed in syncWait (just for debug tinkerpop tests)\nsubmit task if there is only single node\nstandardize the status of tasks (add scheduling/scheduled)\ncancel-task don't remove task from memory if it's single-node server\nnotifyNewTask only notify when the queue is empty(size=1 means one timer task)\nread/write server-infos in bache duting one scheduling\n\nfix #1075\nChange-Id: Icb8d5073f024f0598d439d738d6c0e2caa6fd0cd", "createdAt": "2020-07-03T15:03:23Z", "url": "https://github.com/hugegraph/hugegraph/pull/1079", "merged": true, "mergeCommit": {"oid": "3c358f8687dae3a24dbd3fbecb6c06621f3b430e"}, "closed": true, "closedAt": "2020-07-10T09:14:41Z", "author": {"login": "javeme"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcym5oNAH2gAyNDQ0MTAwNzIxOjFjZDgwOWU1YjI5YzJiYzA5NGVhY2E4ODYxMmZlNTA3NDYyNTUwNjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczgARqgFqTQ0NjI0ODYxMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1cd809e5b29c2bc094eaca88612fe50746255065", "author": {"user": {"login": "javeme", "name": "Jermy Li"}}, "url": "https://github.com/hugegraph/hugegraph/commit/1cd809e5b29c2bc094eaca88612fe50746255065", "committedDate": "2020-07-07T14:41:38Z", "message": "fix task schedule 3 bugs\n\n1.fix dead lock when scheduler-worker hold scheduleTasks lock then\n  query tasks, tx() method synchronized(this) wait indefinitely.\n2.delete server-info when graph close\n3.throw exception if task if failed in syncWait\n\nfix #1075\nChange-Id: Icb8d5073f024f0598d439d738d6c0e2caa6fd0cd"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "600df25819d414956c78f5e879c356cdff8dc830", "author": {"user": {"login": "javeme", "name": "Jermy Li"}}, "url": "https://github.com/hugegraph/hugegraph/commit/600df25819d414956c78f5e879c356cdff8dc830", "committedDate": "2020-07-07T14:41:38Z", "message": "submit task if there is only single node\n\nChange-Id: I69efd7d48610619379975e7d284e5dab88e30776"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "795ef8923415fe938de02fc5d3cb5c5f4f7e7a3d", "author": {"user": {"login": "javeme", "name": "Jermy Li"}}, "url": "https://github.com/hugegraph/hugegraph/commit/795ef8923415fe938de02fc5d3cb5c5f4f7e7a3d", "committedDate": "2020-07-07T14:41:38Z", "message": "fix some bugs\n\n* standardize the status of tasks\n* remove server info only after storage is initialized\n* cancel(task) don't remove task from memory if it's single-node server\n* notifyNewTask only notify when the queue is empty\n\nChange-Id: I874724519e516f600ee8eb1b4760a607421a844a"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "84875cc81d68b1366df19025ae5d5f0af918c2cc", "author": {"user": {"login": "javeme", "name": "Jermy Li"}}, "url": "https://github.com/hugegraph/hugegraph/commit/84875cc81d68b1366df19025ae5d5f0af918c2cc", "committedDate": "2020-07-03T14:57:44Z", "message": "submit task if there is only single node\n\nChange-Id: I69efd7d48610619379975e7d284e5dab88e30776"}, "afterCommit": {"oid": "795ef8923415fe938de02fc5d3cb5c5f4f7e7a3d", "author": {"user": {"login": "javeme", "name": "Jermy Li"}}, "url": "https://github.com/hugegraph/hugegraph/commit/795ef8923415fe938de02fc5d3cb5c5f4f7e7a3d", "committedDate": "2020-07-07T14:41:38Z", "message": "fix some bugs\n\n* standardize the status of tasks\n* remove server info only after storage is initialized\n* cancel(task) don't remove task from memory if it's single-node server\n* notifyNewTask only notify when the queue is empty\n\nChange-Id: I874724519e516f600ee8eb1b4760a607421a844a"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MzQwNzgw", "url": "https://github.com/hugegraph/hugegraph/pull/1079#pullrequestreview-444340780", "createdAt": "2020-07-08T00:46:25Z", "commit": {"oid": "795ef8923415fe938de02fc5d3cb5c5f4f7e7a3d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMDo0NjoyNVrOGuUTcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMDo0NjoyNVrOGuUTcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyMDMzNg==", "bodyText": "Parameter task is not used.", "url": "https://github.com/hugegraph/hugegraph/pull/1079#discussion_r451220336", "createdAt": "2020-07-08T00:46:25Z", "author": {"login": "houzhizhen"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/task/TaskManager.java", "diffHunk": "@@ -242,17 +237,19 @@ public int pendingTasks() {\n     }\n \n     protected void notifyNewTask(HugeTask<?> task) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "795ef8923415fe938de02fc5d3cb5c5f4f7e7a3d"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MzQ3MTEy", "url": "https://github.com/hugegraph/hugegraph/pull/1079#pullrequestreview-444347112", "createdAt": "2020-07-08T01:08:42Z", "commit": {"oid": "795ef8923415fe938de02fc5d3cb5c5f4f7e7a3d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMTowODo0MlrOGuUprw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMTowODo0MlrOGuUprw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyNjAzMQ==", "bodyText": "It may schedule more tasks at the same time, and these tasks will not be processed.", "url": "https://github.com/hugegraph/hugegraph/pull/1079#discussion_r451226031", "createdAt": "2020-07-08T01:08:42Z", "author": {"login": "houzhizhen"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/task/TaskManager.java", "diffHunk": "@@ -242,17 +237,19 @@ public int pendingTasks() {\n     }\n \n     protected void notifyNewTask(HugeTask<?> task) {\n-        // Notify to schedule tasks initiatively when have new task\n-        this.schedulerExecutor.submit(this::scheduleOrExecuteJob);\n+        Queue<Runnable> queue = ((ThreadPoolExecutor) this.schedulerExecutor)\n+                                                          .getQueue();\n+        if (queue.size() <= 1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "795ef8923415fe938de02fc5d3cb5c5f4f7e7a3d"}, "originalPosition": 80}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0Mzc5ODQ0", "url": "https://github.com/hugegraph/hugegraph/pull/1079#pullrequestreview-444379844", "createdAt": "2020-07-08T03:00:23Z", "commit": {"oid": "795ef8923415fe938de02fc5d3cb5c5f4f7e7a3d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMzowMDoyM1rOGuWYZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMzo0MzozMVrOGuXCWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1NDM3Mw==", "bodyText": "queued => scheduling", "url": "https://github.com/hugegraph/hugegraph/pull/1079#discussion_r451254373", "createdAt": "2020-07-08T03:00:23Z", "author": {"login": "zhoney"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/task/StandardTaskScheduler.java", "diffHunk": "@@ -248,127 +272,128 @@ private void unlistenChanges() {\n     @Override\n     public synchronized <V> void cancel(HugeTask<V> task) {\n         E.checkArgumentNotNull(task, \"Task can't be null\");\n-        if (!this.serverManager().master()) {\n+        this.checkOnMasterNode(\"cancel\");\n+\n+        if (task.completed() || task.cancelling()) {\n             return;\n         }\n-        if (!task.completed()) {\n-            // The task scheduled to workers, waiting for worker cancel\n-            task.status(TaskStatus.CANCELLING);\n+\n+        LOG.info(\"Cancel task '{}' in status {}\", task.id(), task.status());\n+\n+        if (task.server() == null) {\n+            // The task not scheduled to workers, set canceled immediately\n+            assert task.status().code() < TaskStatus.QUEUED.code();\n+            if (task.status(TaskStatus.CANCELLED)) {\n+                this.save(task);\n+                return;\n+            }\n+        } else if (task.status(TaskStatus.CANCELLING)) {\n+            // The task scheduled to workers, let the worker node to cancel\n             this.save(task);\n-            this.remove(task.id());\n+            assert task.server() != null : task;\n+            assert this.serverManager().master();\n+            if (!task.server().equals(this.serverManager().selfServerId())) {\n+                /*\n+                 * Remove task from memory if it's running on worker node,\n+                 * but keep task in memory if it's running on master node.\n+                 * cancel-scheduling will read task from backend store, if\n+                 * removed this instance from memory, there will be two task\n+                 * instances with same id, and can't cancel the real task that\n+                 * is running but removed from memory.\n+                 */\n+                this.remove(task);\n+            }\n             // Notify master server to schedule and execute immediately\n             TaskManager.instance().notifyNewTask(task);\n+            return;\n         }\n+\n+        throw new HugeException(\"Can't cancel task '%s' in status %s\",\n+                                task.id(), task.status());\n+    }\n+\n+    protected ServerInfoManager serverManager() {\n+        return this.serverManager;\n     }\n \n-    protected synchronized <V> void scheduleTasks() {\n-        // Master schedule all queued tasks to suitable servers\n+    protected synchronized void scheduleTasks() {\n+        // Master server schedule all queued tasks to suitable worker servers", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "795ef8923415fe938de02fc5d3cb5c5f4f7e7a3d"}, "originalPosition": 200}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1NjgwNA==", "bodyText": "must save server info here. Otherwise all tasks will be scheduled to same worker\nImplement increaseLoad(int load) in class HugeServerInfo", "url": "https://github.com/hugegraph/hugegraph/pull/1079#discussion_r451256804", "createdAt": "2020-07-08T03:10:30Z", "author": {"login": "zhoney"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/task/StandardTaskScheduler.java", "diffHunk": "@@ -248,127 +272,128 @@ private void unlistenChanges() {\n     @Override\n     public synchronized <V> void cancel(HugeTask<V> task) {\n         E.checkArgumentNotNull(task, \"Task can't be null\");\n-        if (!this.serverManager().master()) {\n+        this.checkOnMasterNode(\"cancel\");\n+\n+        if (task.completed() || task.cancelling()) {\n             return;\n         }\n-        if (!task.completed()) {\n-            // The task scheduled to workers, waiting for worker cancel\n-            task.status(TaskStatus.CANCELLING);\n+\n+        LOG.info(\"Cancel task '{}' in status {}\", task.id(), task.status());\n+\n+        if (task.server() == null) {\n+            // The task not scheduled to workers, set canceled immediately\n+            assert task.status().code() < TaskStatus.QUEUED.code();\n+            if (task.status(TaskStatus.CANCELLED)) {\n+                this.save(task);\n+                return;\n+            }\n+        } else if (task.status(TaskStatus.CANCELLING)) {\n+            // The task scheduled to workers, let the worker node to cancel\n             this.save(task);\n-            this.remove(task.id());\n+            assert task.server() != null : task;\n+            assert this.serverManager().master();\n+            if (!task.server().equals(this.serverManager().selfServerId())) {\n+                /*\n+                 * Remove task from memory if it's running on worker node,\n+                 * but keep task in memory if it's running on master node.\n+                 * cancel-scheduling will read task from backend store, if\n+                 * removed this instance from memory, there will be two task\n+                 * instances with same id, and can't cancel the real task that\n+                 * is running but removed from memory.\n+                 */\n+                this.remove(task);\n+            }\n             // Notify master server to schedule and execute immediately\n             TaskManager.instance().notifyNewTask(task);\n+            return;\n         }\n+\n+        throw new HugeException(\"Can't cancel task '%s' in status %s\",\n+                                task.id(), task.status());\n+    }\n+\n+    protected ServerInfoManager serverManager() {\n+        return this.serverManager;\n     }\n \n-    protected synchronized <V> void scheduleTasks() {\n-        // Master schedule all queued tasks to suitable servers\n+    protected synchronized void scheduleTasks() {\n+        // Master server schedule all queued tasks to suitable worker servers\n+        Map<HugeServerInfo, MutableInt> scheduleInfos = new HashMap<>();\n+        ServerInfoManager serverManager = this.serverManager();\n         String page = this.supportsPaging() ? PageInfo.PAGE_NONE : null;\n         do {\n-            Iterator<HugeTask<V>> tasks = this.tasks(TaskStatus.QUEUED,\n-                                                     PAGE_SIZE, page);\n-            HugeTask<V> task;\n+            Iterator<HugeTask<Object>> tasks = this.tasks(TaskStatus.SCHEDULING,\n+                                                          PAGE_SIZE, page);\n             while (tasks.hasNext()) {\n-                task = tasks.next();\n+                HugeTask<?> task = tasks.next();\n                 if (task.server() != null) {\n                     // Skip if already scheduled\n                     continue;\n                 }\n-                HugeServerInfo server = this.pickWorker(task);\n+\n+                HugeServerInfo server = serverManager.pickWorker(task);\n                 if (server == null) {\n                     LOG.debug(\"The master can't find suitable servers to \" +\n-                              \"execute task: {}, wait for next schedule\",\n+                              \"execute task '{}', wait for next schedule\",\n                               task.id());\n-                    return;\n+                    continue;\n                 }\n \n                 // Found suitable server, update task server and server load\n                 assert server.id() != null;\n                 task.server(server.id());\n+                task.status(TaskStatus.SCHEDULED);\n                 this.save(task);\n+\n                 server.load(server.load() + task.load());\n-                this.serverManager().save(server);\n-                LOG.info(\"Schedule task {} to server {}\",\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "795ef8923415fe938de02fc5d3cb5c5f4f7e7a3d"}, "originalPosition": 238}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI2MTY1OA==", "bodyText": "move to line 397 and change to:\nId taskServer = task.server();\nassert taskServer != null;\nif (!taskServer.equals(server)) {\n    continue;\n}", "url": "https://github.com/hugegraph/hugegraph/pull/1079#discussion_r451261658", "createdAt": "2020-07-08T03:30:36Z", "author": {"login": "zhoney"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/task/StandardTaskScheduler.java", "diffHunk": "@@ -377,15 +402,14 @@ private void unlistenChanges() {\n                  * initialized when canceled.\n                  */\n                 this.initTaskCallable(task);\n-                @SuppressWarnings(\"unchecked\")\n-                HugeTask<V> memTask = (HugeTask<V>) this.tasks.get(task.id());\n+                HugeTask<?> memTask = this.tasks.get(task.id());\n                 if (memTask != null) {\n                     task = memTask;\n                 }\n                 Id taskServer = task.server();\n                 if (taskServer != null && taskServer.equals(server)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "795ef8923415fe938de02fc5d3cb5c5f4f7e7a3d"}, "originalPosition": 355}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI2NTExMw==", "bodyText": "remove line 218 due to system tx is auto commit", "url": "https://github.com/hugegraph/hugegraph/pull/1079#discussion_r451265113", "createdAt": "2020-07-08T03:43:31Z", "author": {"login": "zhoney"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/task/ServerInfoManager.java", "diffHunk": "@@ -212,8 +273,8 @@ protected Id save(HugeServerInfo server) {\n         });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "795ef8923415fe938de02fc5d3cb5c5f4f7e7a3d"}, "originalPosition": 194}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NDEwMTY1", "url": "https://github.com/hugegraph/hugegraph/pull/1079#pullrequestreview-444410165", "createdAt": "2020-07-08T04:48:14Z", "commit": {"oid": "795ef8923415fe938de02fc5d3cb5c5f4f7e7a3d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwNDo0ODoxNFrOGuX_Qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwNDo0ODoxNFrOGuX_Qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI4MDcwNg==", "bodyText": "as a monitor", "url": "https://github.com/hugegraph/hugegraph/pull/1079#discussion_r451280706", "createdAt": "2020-07-08T04:48:14Z", "author": {"login": "Linary"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/task/StandardTaskScheduler.java", "diffHunk": "@@ -132,7 +137,14 @@ public int taskResultSizeLimit() {\n     private TaskTransaction tx() {\n         // NOTE: only the owner thread can access task tx\n         if (this.taskTx == null) {\n-            synchronized (this) {\n+            /*\n+             * NOTE: don't synchronized(this) due to scheduler thread hold\n+             * this lock through scheduleTasks(), then query tasks and wait\n+             * for db-worker thread after call(), the tx may not be initialized\n+             * but can't catch this lock, then cause dead lock.\n+             * We just use this.eventListener ad a monitor here", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "795ef8923415fe938de02fc5d3cb5c5f4f7e7a3d"}, "originalPosition": 67}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "69ddc1f3a93f03bf9e18c69487669111497de364", "author": {"user": {"login": "javeme", "name": "Jermy Li"}}, "url": "https://github.com/hugegraph/hugegraph/commit/69ddc1f3a93f03bf9e18c69487669111497de364", "committedDate": "2020-07-08T08:35:34Z", "message": "read/write server-infos in bache duting one scheduling\n\nChange-Id: I23c845ee93c05ebec1fbea77fdc36a5cdb2614c2"}, "afterCommit": {"oid": "cad38cfe25444803583cd5bf350b1cf2f11d1459", "author": {"user": {"login": "javeme", "name": "Jermy Li"}}, "url": "https://github.com/hugegraph/hugegraph/commit/cad38cfe25444803583cd5bf350b1cf2f11d1459", "committedDate": "2020-07-08T08:46:48Z", "message": "read/write server-infos in bache duting one scheduling\n\nChange-Id: I23c845ee93c05ebec1fbea77fdc36a5cdb2614c2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "176c98863adf4918592e1e7d3f0a66c8814ef3cd", "author": {"user": {"login": "javeme", "name": "Jermy Li"}}, "url": "https://github.com/hugegraph/hugegraph/commit/176c98863adf4918592e1e7d3f0a66c8814ef3cd", "committedDate": "2020-07-08T08:48:42Z", "message": "read/write server-infos in bache duting one scheduling\n\nChange-Id: I23c845ee93c05ebec1fbea77fdc36a5cdb2614c2"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cad38cfe25444803583cd5bf350b1cf2f11d1459", "author": {"user": {"login": "javeme", "name": "Jermy Li"}}, "url": "https://github.com/hugegraph/hugegraph/commit/cad38cfe25444803583cd5bf350b1cf2f11d1459", "committedDate": "2020-07-08T08:46:48Z", "message": "read/write server-infos in bache duting one scheduling\n\nChange-Id: I23c845ee93c05ebec1fbea77fdc36a5cdb2614c2"}, "afterCommit": {"oid": "176c98863adf4918592e1e7d3f0a66c8814ef3cd", "author": {"user": {"login": "javeme", "name": "Jermy Li"}}, "url": "https://github.com/hugegraph/hugegraph/commit/176c98863adf4918592e1e7d3f0a66c8814ef3cd", "committedDate": "2020-07-08T08:48:42Z", "message": "read/write server-infos in bache duting one scheduling\n\nChange-Id: I23c845ee93c05ebec1fbea77fdc36a5cdb2614c2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NjA5OTM4", "url": "https://github.com/hugegraph/hugegraph/pull/1079#pullrequestreview-444609938", "createdAt": "2020-07-08T10:21:15Z", "commit": {"oid": "176c98863adf4918592e1e7d3f0a66c8814ef3cd"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MzYxODAy", "url": "https://github.com/hugegraph/hugegraph/pull/1079#pullrequestreview-445361802", "createdAt": "2020-07-09T07:38:10Z", "commit": {"oid": "176c98863adf4918592e1e7d3f0a66c8814ef3cd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNzozODoxMFrOGvFTPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwODoxMjo1NlrOGvGd0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAyMzEwMQ==", "bodyText": "move to line 234", "url": "https://github.com/hugegraph/hugegraph/pull/1079#discussion_r452023101", "createdAt": "2020-07-09T07:38:10Z", "author": {"login": "zhoney"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/task/StandardTaskScheduler.java", "diffHunk": "@@ -200,27 +211,38 @@ private void unlistenChanges() {\n \n     @Override\n     public <V> Future<?> schedule(HugeTask<V> task) {\n-        if (!this.serverManager().master()) {\n-            throw new HugeException(\"The worker can't schedule task\");\n-        }\n         E.checkArgumentNotNull(task, \"Task can't be null\");\n+        this.checkOnMasterNode(\"schedule\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "176c98863adf4918592e1e7d3f0a66c8814ef3cd"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA0MjE5NA==", "bodyText": "else means task is on master, cancel it directly seems more efficient", "url": "https://github.com/hugegraph/hugegraph/pull/1079#discussion_r452042194", "createdAt": "2020-07-09T08:12:56Z", "author": {"login": "zhoney"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/task/StandardTaskScheduler.java", "diffHunk": "@@ -248,65 +271,109 @@ private void unlistenChanges() {\n     @Override\n     public synchronized <V> void cancel(HugeTask<V> task) {\n         E.checkArgumentNotNull(task, \"Task can't be null\");\n-        if (!this.serverManager().master()) {\n+        this.checkOnMasterNode(\"cancel\");\n+\n+        if (task.completed() || task.cancelling()) {\n             return;\n         }\n-        if (!task.completed()) {\n-            // The task scheduled to workers, waiting for worker cancel\n-            task.status(TaskStatus.CANCELLING);\n+\n+        LOG.info(\"Cancel task '{}' in status {}\", task.id(), task.status());\n+\n+        if (task.server() == null) {\n+            // The task not scheduled to workers, set canceled immediately\n+            assert task.status().code() < TaskStatus.QUEUED.code();\n+            if (task.status(TaskStatus.CANCELLED)) {\n+                this.save(task);\n+                return;\n+            }\n+        } else if (task.status(TaskStatus.CANCELLING)) {\n+            // The task scheduled to workers, let the worker node to cancel\n             this.save(task);\n-            this.remove(task.id());\n+            assert task.server() != null : task;\n+            assert this.serverManager().master();\n+            if (!task.server().equals(this.serverManager().selfServerId())) {\n+                /*\n+                 * Remove task from memory if it's running on worker node,\n+                 * but keep task in memory if it's running on master node.\n+                 * cancel-scheduling will read task from backend store, if\n+                 * removed this instance from memory, there will be two task\n+                 * instances with same id, and can't cancel the real task that\n+                 * is running but removed from memory.\n+                 */\n+                this.remove(task);\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "176c98863adf4918592e1e7d3f0a66c8814ef3cd"}, "originalPosition": 184}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21cb8c1694cb7004c82eed6cdaf693b4a29a7364", "author": {"user": {"login": "javeme", "name": "Jermy Li"}}, "url": "https://github.com/hugegraph/hugegraph/commit/21cb8c1694cb7004c82eed6cdaf693b4a29a7364", "committedDate": "2020-07-09T12:35:00Z", "message": "fix not check master with EphemeralJob and fix onlySingleNode update\n\nChange-Id: I74a0164fd755bae885575a1770995502def6e88b"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MDcwOTk3", "url": "https://github.com/hugegraph/hugegraph/pull/1079#pullrequestreview-446070997", "createdAt": "2020-07-10T01:41:48Z", "commit": {"oid": "21cb8c1694cb7004c82eed6cdaf693b4a29a7364"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MjMxNTY5", "url": "https://github.com/hugegraph/hugegraph/pull/1079#pullrequestreview-446231569", "createdAt": "2020-07-10T08:49:16Z", "commit": {"oid": "21cb8c1694cb7004c82eed6cdaf693b4a29a7364"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MjQ4NjEw", "url": "https://github.com/hugegraph/hugegraph/pull/1079#pullrequestreview-446248610", "createdAt": "2020-07-10T09:13:29Z", "commit": {"oid": "21cb8c1694cb7004c82eed6cdaf693b4a29a7364"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2475, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}