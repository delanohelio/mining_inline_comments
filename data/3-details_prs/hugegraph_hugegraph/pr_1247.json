{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3NjQwNzA5", "number": 1247, "title": "Implement raft snapshot mechanism by rocksdb checkpoint", "bodyText": "Change-Id: I761c01da871aac6fe6e906f6150c66c7f5b8f67b", "createdAt": "2020-11-09T10:03:43Z", "url": "https://github.com/hugegraph/hugegraph/pull/1247", "merged": true, "mergeCommit": {"oid": "d3fc084062b74e0580eeeabdab4a9e99c4c364a7"}, "closed": true, "closedAt": "2020-11-18T08:09:54Z", "author": {"login": "Linary"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdax66pABqjM5NzI5MjEzMDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddpQ_HAFqTUzMzE3MjgxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2f1bdc1ab62c694a6455e26a85b222be2df0edbb", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/2f1bdc1ab62c694a6455e26a85b222be2df0edbb", "committedDate": "2020-11-09T10:00:10Z", "message": "Implement raft snapshot mechanism by rocksdb checkpoint\n\nChange-Id: I761c01da871aac6fe6e906f6150c66c7f5b8f67b"}, "afterCommit": {"oid": "f02717587c334074bf766e276b864a8c7f5241b3", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/f02717587c334074bf766e276b864a8c7f5241b3", "committedDate": "2020-11-09T10:08:38Z", "message": "Implement raft snapshot mechanism by rocksdb checkpoint\n\nChange-Id: I761c01da871aac6fe6e906f6150c66c7f5b8f67b"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f02717587c334074bf766e276b864a8c7f5241b3", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/f02717587c334074bf766e276b864a8c7f5241b3", "committedDate": "2020-11-09T10:08:38Z", "message": "Implement raft snapshot mechanism by rocksdb checkpoint\n\nChange-Id: I761c01da871aac6fe6e906f6150c66c7f5b8f67b"}, "afterCommit": {"oid": "84050365c34ed61c19e4ec63b630d3873ee4d634", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/84050365c34ed61c19e4ec63b630d3873ee4d634", "committedDate": "2020-11-09T10:12:58Z", "message": "Implement raft snapshot mechanism by rocksdb checkpoint\n\nChange-Id: I761c01da871aac6fe6e906f6150c66c7f5b8f67b"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MTUyNjk3", "url": "https://github.com/hugegraph/hugegraph/pull/1247#pullrequestreview-526152697", "createdAt": "2020-11-09T11:17:32Z", "commit": {"oid": "84050365c34ed61c19e4ec63b630d3873ee4d634"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMToxNzozMlrOHvp84Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMTozODo1N1rOHvqqtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTczMjQ0OQ==", "bodyText": "The raft node is initialized", "url": "https://github.com/hugegraph/hugegraph/pull/1247#discussion_r519732449", "createdAt": "2020-11-09T11:17:32Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftBackendStoreProvider.java", "diffHunk": "@@ -129,6 +129,7 @@ public void open(String name) {\n     @Override\n     public void waitStoreStarted() {\n         this.context.initRaftNode();\n+        LOG.info(\"The raft node was inited\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84050365c34ed61c19e4ec63b630d3873ee4d634"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTczODc1NQ==", "bodyText": "use %s", "url": "https://github.com/hugegraph/hugegraph/pull/1247#discussion_r519738755", "createdAt": "2020-11-09T11:28:53Z", "author": {"login": "javeme"}, "path": "hugegraph-rocksdb/src/main/java/com/baidu/hugegraph/backend/store/rocksdb/RocksDBStore.java", "diffHunk": "@@ -635,23 +635,28 @@ public void readSnapshot(String parentPath) {\n                                                e, snapshotFile, dataFile);\n                 }\n             }\n-\n-            // Reopen the db\n-            this.open(this.sessions.config());\n+            // Reload rocksdb instance\n+            for (RocksDBSessions sessions : this.dbs.values()) {\n+                sessions.reload();\n+            }\n+            LOG.info(\"The store {} load snapshot succeed\", this.store);\n+        } catch (RocksDBException e) {\n+            throw new BackendException(\"Failed to reload rocksdb: \" + e.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84050365c34ed61c19e4ec63b630d3873ee4d634"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTczOTgzNQ==", "bodyText": "rename to storeLock", "url": "https://github.com/hugegraph/hugegraph/pull/1247#discussion_r519739835", "createdAt": "2020-11-09T11:30:52Z", "author": {"login": "javeme"}, "path": "hugegraph-rocksdb/src/main/java/com/baidu/hugegraph/backend/store/rocksdb/RocksDBStore.java", "diffHunk": "@@ -586,21 +581,22 @@ protected Session session(HugeType tableType) {\n \n     @Override\n     public void writeSnapshot(String parentPath) {\n-        Lock readLock = this.truncateLock.readLock();\n-        readLock.lock();\n+        Lock writeLock = this.truncateLock.writeLock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84050365c34ed61c19e4ec63b630d3873ee4d634"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc0MDc5Mg==", "bodyText": "move forceCloseRocksDB to RocksDBSessions", "url": "https://github.com/hugegraph/hugegraph/pull/1247#discussion_r519740792", "createdAt": "2020-11-09T11:32:37Z", "author": {"login": "javeme"}, "path": "hugegraph-rocksdb/src/main/java/com/baidu/hugegraph/backend/store/rocksdb/RocksDBStore.java", "diffHunk": "@@ -614,12 +610,16 @@ public void readSnapshot(String parentPath) {\n                 File dataFile = new File(session.dataPath());\n                 fileRenamePairs.add(Pair.of(snapshotFile, dataFile));\n             }\n-            // Close old sessions, is that right?\n-            for (Session session : this.session()) {\n-                session.close();\n+            /*\n+             * NOTE: must close rocksdb instance before deleting file directory,\n+             * if close after copying the snapshot directory to origin position,\n+             * it may produce dirty data.\n+             */\n+            for (RocksDBSessions sessions : this.dbs.values()) {\n+                if (sessions instanceof RocksDBStdSessions) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84050365c34ed61c19e4ec63b630d3873ee4d634"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc0MTE1Ng==", "bodyText": "successfully", "url": "https://github.com/hugegraph/hugegraph/pull/1247#discussion_r519741156", "createdAt": "2020-11-09T11:33:17Z", "author": {"login": "javeme"}, "path": "hugegraph-rocksdb/src/main/java/com/baidu/hugegraph/backend/store/rocksdb/RocksDBStore.java", "diffHunk": "@@ -635,23 +635,28 @@ public void readSnapshot(String parentPath) {\n                                                e, snapshotFile, dataFile);\n                 }\n             }\n-\n-            // Reopen the db\n-            this.open(this.sessions.config());\n+            // Reload rocksdb instance\n+            for (RocksDBSessions sessions : this.dbs.values()) {\n+                sessions.reload();\n+            }\n+            LOG.info(\"The store {} load snapshot succeed\", this.store);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84050365c34ed61c19e4ec63b630d3873ee4d634"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc0MzQ0Mg==", "bodyText": "\"Failed to save snapshot, path={}, files={}\", the exception stack will be printed", "url": "https://github.com/hugegraph/hugegraph/pull/1247#discussion_r519743442", "createdAt": "2020-11-09T11:37:31Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/StoreSnapshotFile.java", "diffHunk": "@@ -49,22 +48,27 @@\n     private static final String SNAPSHOT_DIR = \"ss\";\n     private static final String SNAPSHOT_ARCHIVE = \"ss.zip\";\n \n-    public void save(BackendStore store, SnapshotWriter writer,\n-                     Closure done, ExecutorService executor) {\n+    private final RaftBackendStore[] stores;\n+\n+    public StoreSnapshotFile(RaftBackendStore[] stores) {\n+        this.stores = stores;\n+    }\n+\n+    public void save(SnapshotWriter writer, Closure done,\n+                     ExecutorService executor) {\n         String writerPath = writer.getPath();\n         String snapshotPath = Paths.get(writerPath, SNAPSHOT_DIR).toString();\n         try {\n-            this.doSnapshotSave(store, snapshotPath)\n-                .whenComplete((metaBuilder, throwable) -> {\n-                if (throwable == null) {\n+            this.doSnapshotSave(snapshotPath).whenComplete((metaBuilder, t) -> {\n+                if (t == null) {\n                     executor.execute(() -> compressSnapshot(writer, metaBuilder,\n                                                             done));\n                 } else {\n                     LOG.error(\"Failed to save snapshot, path={}, files={}, {}.\",\n-                              writerPath, writer.listFiles(), throwable);\n+                              writerPath, writer.listFiles(), t);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84050365c34ed61c19e4ec63b630d3873ee4d634"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc0NDAyNA==", "bodyText": "set private", "url": "https://github.com/hugegraph/hugegraph/pull/1247#discussion_r519744024", "createdAt": "2020-11-09T11:38:39Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/StoreSnapshotFile.java", "diffHunk": "@@ -105,14 +109,21 @@ public boolean load(BackendStore store, SnapshotReader reader) {\n     }\n \n     public CompletableFuture<LocalFileMeta.Builder> doSnapshotSave(\n-                                                    BackendStore store,\n                                                     String snapshotPath) {\n-        store.writeSnapshot(snapshotPath);\n+        for (RaftBackendStore store : this.stores) {\n+            String parentPath = Paths.get(snapshotPath, store.store())\n+                                     .toString();\n+            store.writeSnapshot(parentPath);\n+        }\n         return CompletableFuture.completedFuture(LocalFileMeta.newBuilder());\n     }\n \n-    public void doSnapshotLoad(BackendStore store, String snapshotPath) {\n-        store.readSnapshot(snapshotPath);\n+    public void doSnapshotLoad(String snapshotPath) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84050365c34ed61c19e4ec63b630d3873ee4d634"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc0NDE4Mg==", "bodyText": "set protected", "url": "https://github.com/hugegraph/hugegraph/pull/1247#discussion_r519744182", "createdAt": "2020-11-09T11:38:57Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftSharedContext.java", "diffHunk": "@@ -186,6 +186,10 @@ public StoreType storeType(String store) {\n         }\n     }\n \n+    public RaftBackendStore[] stores() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84050365c34ed61c19e4ec63b630d3873ee4d634"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MjM4NzIz", "url": "https://github.com/hugegraph/hugegraph/pull/1247#pullrequestreview-526238723", "createdAt": "2020-11-09T13:06:03Z", "commit": {"oid": "bc73b3cb84842c3ef9422cd4800d3e117466acbf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMzowNjowM1rOHvttlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMzowNjowM1rOHvttlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc5NDA3MA==", "bodyText": "\"the exception stack will be printed\" is just comment", "url": "https://github.com/hugegraph/hugegraph/pull/1247#discussion_r519794070", "createdAt": "2020-11-09T13:06:03Z", "author": {"login": "javeme"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/StoreSnapshotFile.java", "diffHunk": "@@ -64,7 +64,8 @@ public void save(SnapshotWriter writer, Closure done,\n                     executor.execute(() -> compressSnapshot(writer, metaBuilder,\n                                                             done));\n                 } else {\n-                    LOG.error(\"Failed to save snapshot, path={}, files={}, {}.\",\n+                    LOG.error(\"Failed to save snapshot, path={}, files={}, \" +\n+                              \"the exception stack will be printed.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc73b3cb84842c3ef9422cd4800d3e117466acbf"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3MDA1NTQ5", "url": "https://github.com/hugegraph/hugegraph/pull/1247#pullrequestreview-527005549", "createdAt": "2020-11-10T09:24:09Z", "commit": {"oid": "b11a2197aead8543def94769b13fb62336132354"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3MTEyMTY3", "url": "https://github.com/hugegraph/hugegraph/pull/1247#pullrequestreview-527112167", "createdAt": "2020-11-10T11:33:24Z", "commit": {"oid": "b11a2197aead8543def94769b13fb62336132354"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxMTozMzoyNFrOHwYcxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxMTozMzozMVrOHwYdLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQ5NDI3OQ==", "bodyText": "remove \"is\"", "url": "https://github.com/hugegraph/hugegraph/pull/1247#discussion_r520494279", "createdAt": "2020-11-10T11:33:24Z", "author": {"login": "houzhizhen"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftBackendStoreProvider.java", "diffHunk": "@@ -129,8 +129,9 @@ public void open(String name) {\n     @Override\n     public void waitStoreStarted() {\n         this.context.initRaftNode();\n+        LOG.info(\"The raft node is initialized\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b11a2197aead8543def94769b13fb62336132354"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQ5NDM4Mg==", "bodyText": "remove \"is\"", "url": "https://github.com/hugegraph/hugegraph/pull/1247#discussion_r520494382", "createdAt": "2020-11-10T11:33:31Z", "author": {"login": "houzhizhen"}, "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftBackendStoreProvider.java", "diffHunk": "@@ -129,8 +129,9 @@ public void open(String name) {\n     @Override\n     public void waitStoreStarted() {\n         this.context.initRaftNode();\n+        LOG.info(\"The raft node is initialized\");\n         this.context.waitRaftNodeStarted();\n-        LOG.info(\"The raft store was started\");\n+        LOG.info(\"The raft store is started\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b11a2197aead8543def94769b13fb62336132354"}, "originalPosition": 7}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b11a2197aead8543def94769b13fb62336132354", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/b11a2197aead8543def94769b13fb62336132354", "committedDate": "2020-11-10T07:06:11Z", "message": "tiny improve\n\nChange-Id: I27be0ad4bf78694e98855d77450a97f447832114"}, "afterCommit": {"oid": "c49a48d160741ba1862d6c30d4fc290401d57414", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/c49a48d160741ba1862d6c30d4fc290401d57414", "committedDate": "2020-11-16T07:06:17Z", "message": "adapt unit test\n\nChange-Id: I157a1c3b6f893083f507b99a22e717e2b89eb2ce"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMDczMjUz", "url": "https://github.com/hugegraph/hugegraph/pull/1247#pullrequestreview-532073253", "createdAt": "2020-11-17T07:14:47Z", "commit": {"oid": "c49a48d160741ba1862d6c30d4fc290401d57414"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5254d0c89d5df1de1d501f5f53591bc5ff7d9de1", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/5254d0c89d5df1de1d501f5f53591bc5ff7d9de1", "committedDate": "2020-11-17T07:40:52Z", "message": "Implement raft snapshot mechanism by rocksdb checkpoint\n\nChange-Id: I761c01da871aac6fe6e906f6150c66c7f5b8f67b"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09e4d29e3dc1a708fa260764cd90f856233867df", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/09e4d29e3dc1a708fa260764cd90f856233867df", "committedDate": "2020-11-17T07:40:52Z", "message": "tiny improve\n\nChange-Id: Ia423824791a1c6bd611e981facaf7a26c94fc5ca"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10aa24392e9ab12597ca5346df3e6a6bdf3790a0", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/10aa24392e9ab12597ca5346df3e6a6bdf3790a0", "committedDate": "2020-11-17T07:40:53Z", "message": "tiny improve\n\nChange-Id: Ib2c72eab8b91abbba55cca3b309ed91e35654083"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e57d3b1e4250e37e8e19b9353e8d376f3a104f3a", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/e57d3b1e4250e37e8e19b9353e8d376f3a104f3a", "committedDate": "2020-11-17T07:40:53Z", "message": "tiny improve\n\nChange-Id: I27be0ad4bf78694e98855d77450a97f447832114"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c3c49cfd99260e465120c823d040f50ba8e8a84", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/9c3c49cfd99260e465120c823d040f50ba8e8a84", "committedDate": "2020-11-17T07:40:53Z", "message": "adapt unit test\n\nChange-Id: I157a1c3b6f893083f507b99a22e717e2b89eb2ce"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e14b091d2d18394958d35ffa87050adaf4fe9713", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/e14b091d2d18394958d35ffa87050adaf4fe9713", "committedDate": "2020-11-17T07:49:36Z", "message": "adapt with dbs as member field\n\nChange-Id: I205329c07fc8bac0f9731e77ddc842f1366d21ec"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c49a48d160741ba1862d6c30d4fc290401d57414", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/c49a48d160741ba1862d6c30d4fc290401d57414", "committedDate": "2020-11-16T07:06:17Z", "message": "adapt unit test\n\nChange-Id: I157a1c3b6f893083f507b99a22e717e2b89eb2ce"}, "afterCommit": {"oid": "e14b091d2d18394958d35ffa87050adaf4fe9713", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/e14b091d2d18394958d35ffa87050adaf4fe9713", "committedDate": "2020-11-17T07:49:36Z", "message": "adapt with dbs as member field\n\nChange-Id: I205329c07fc8bac0f9731e77ddc842f1366d21ec"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9de3775d2949c875936f3086f666480c4f4105e", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/e9de3775d2949c875936f3086f666480c4f4105e", "committedDate": "2020-11-17T09:26:30Z", "message": "SuppressWarnings\n\nChange-Id: I37779caec0fdd50276f8597fa4540df39ad40942"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMTkxNzc3", "url": "https://github.com/hugegraph/hugegraph/pull/1247#pullrequestreview-532191777", "createdAt": "2020-11-17T09:52:06Z", "commit": {"oid": "e9de3775d2949c875936f3086f666480c4f4105e"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMTk2Njg4", "url": "https://github.com/hugegraph/hugegraph/pull/1247#pullrequestreview-532196688", "createdAt": "2020-11-17T09:57:37Z", "commit": {"oid": "e9de3775d2949c875936f3086f666480c4f4105e"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMjEzNjIz", "url": "https://github.com/hugegraph/hugegraph/pull/1247#pullrequestreview-532213623", "createdAt": "2020-11-17T10:17:50Z", "commit": {"oid": "e9de3775d2949c875936f3086f666480c4f4105e"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMzI5MTE1", "url": "https://github.com/hugegraph/hugegraph/pull/1247#pullrequestreview-532329115", "createdAt": "2020-11-17T12:52:10Z", "commit": {"oid": "e9de3775d2949c875936f3086f666480c4f4105e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMjo1MjoxMFrOH0zZXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMzowNDowNVrOH0zz9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTEzMDA3OQ==", "bodyText": "move line 259 to line 256", "url": "https://github.com/hugegraph/hugegraph/pull/1247#discussion_r525130079", "createdAt": "2020-11-17T12:52:10Z", "author": {"login": "javeme"}, "path": "hugegraph-rocksdb/src/main/java/com/baidu/hugegraph/backend/store/rocksdb/RocksDBStdSessions.java", "diffHunk": "@@ -251,9 +251,11 @@ public synchronized void dropTable(String... tables)\n         }\n     }\n \n-    @SuppressWarnings(\"unused\")\n-    private void reload() throws RocksDBException {\n-        this.rocksdb.close();\n+    @Override\n+    public void reload() throws RocksDBException {\n+        if (this.rocksdb.isOwningHandle()) {\n+            this.rocksdb.close();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9de3775d2949c875936f3086f666480c4f4105e"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTEzNjg4Ng==", "bodyText": "update comments:\nOpen twice, copy a RocksDBSessions reference, since from v0.11.2 release we don't support multi graphs share rocksdb instance (before v0.11.2 graphs with different CF-prefix share one rocksdb instance and data path), so each graph has its independent data paths, but multi CFs may share same optimized disk(or optimized disk path).", "url": "https://github.com/hugegraph/hugegraph/pull/1247#discussion_r525136886", "createdAt": "2020-11-17T13:04:05Z", "author": {"login": "javeme"}, "path": "hugegraph-rocksdb/src/main/java/com/baidu/hugegraph/backend/store/rocksdb/RocksDBStore.java", "diffHunk": "@@ -265,7 +260,7 @@ protected RocksDBSessions open(HugeConfig config, String dataPath,\n             sessions = this.openSessionPool(config, dataPath,\n                                             walPath, tableNames);\n         } catch (RocksDBException e) {\n-            RocksDBSessions origin = dbs.get(dataPath);\n+            RocksDBSessions origin = this.dbs.get(dataPath);\n             if (origin != null) {\n                 if (e.getMessage().contains(\"No locks available\")) {\n                     // Open twice, but we should support keyspace", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9de3775d2949c875936f3086f666480c4f4105e"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6aac8f938697fee484bdf4cb3ee3dd5ba8b8fe1", "author": {"user": {"login": "Linary", "name": "Linary"}}, "url": "https://github.com/hugegraph/hugegraph/commit/a6aac8f938697fee484bdf4cb3ee3dd5ba8b8fe1", "committedDate": "2020-11-18T06:48:34Z", "message": "Adapt MultiGraphTests\n\nChange-Id: I5faf30bc530a6ad21fee81fef22614d4e46123a9"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMTQ3MjA3", "url": "https://github.com/hugegraph/hugegraph/pull/1247#pullrequestreview-533147207", "createdAt": "2020-11-18T06:54:53Z", "commit": {"oid": "a6aac8f938697fee484bdf4cb3ee3dd5ba8b8fe1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMTcyODE5", "url": "https://github.com/hugegraph/hugegraph/pull/1247#pullrequestreview-533172819", "createdAt": "2020-11-18T07:45:42Z", "commit": {"oid": "a6aac8f938697fee484bdf4cb3ee3dd5ba8b8fe1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2314, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}