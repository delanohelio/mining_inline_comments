{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2OTMxNjI2", "number": 3267, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMTo1MDoyNFrOD71nuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxODoyMTo1OVrOD8mSWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0MDcxMDk2OnYy", "diffSide": "RIGHT", "path": "storm-server/src/main/java/org/apache/storm/daemon/supervisor/Supervisor.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMTo1MDoyNFrOGUaOwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxODo1NTo1OVrOGU_TjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1NDQ2Ng==", "bodyText": "Lately, we added NUMA support, so if getNumaPorts is configured and not empty, numaPorts should be used otherwise it can default to slots_ports. Since we are providing more than one place to configure ports, I think it is implied that NUMA one is newer and should win if configured. No need to stop supervisor daemon.", "url": "https://github.com/apache/storm/pull/3267#discussion_r424054466", "createdAt": "2020-05-12T21:50:24Z", "author": {"login": "kishorvpatil"}, "path": "storm-server/src/main/java/org/apache/storm/daemon/supervisor/Supervisor.java", "diffHunk": "@@ -327,6 +330,15 @@ public void launch() throws Exception {\n         LOG.info(\"Starting supervisor with id {} at host {}.\", getId(), getHostName());\n     }\n \n+    private void validateConf() {\n+        List<Number> ports = (List<Number>) conf.get(DaemonConfig.SUPERVISOR_SLOTS_PORTS);\n+        Set<Integer> numaPorts = SupervisorUtils.getNumaPorts(conf);\n+        numaPorts.removeAll(ports);\n+        if (numaPorts.size() > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31fa0361724906d686a1895f74c6ee19e98adc13"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1NTE0NA==", "bodyText": "To avoid user confusion, we should update Java Documentation on configuration suggesting that if numa_ports are configured they take precedence over slots.ports.", "url": "https://github.com/apache/storm/pull/3267#discussion_r424055144", "createdAt": "2020-05-12T21:51:57Z", "author": {"login": "kishorvpatil"}, "path": "storm-server/src/main/java/org/apache/storm/daemon/supervisor/Supervisor.java", "diffHunk": "@@ -327,6 +330,15 @@ public void launch() throws Exception {\n         LOG.info(\"Starting supervisor with id {} at host {}.\", getId(), getHostName());\n     }\n \n+    private void validateConf() {\n+        List<Number> ports = (List<Number>) conf.get(DaemonConfig.SUPERVISOR_SLOTS_PORTS);\n+        Set<Integer> numaPorts = SupervisorUtils.getNumaPorts(conf);\n+        numaPorts.removeAll(ports);\n+        if (numaPorts.size() > 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1NDQ2Ng=="}, "originalCommit": {"oid": "31fa0361724906d686a1895f74c6ee19e98adc13"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA2Mjc1OQ==", "bodyText": "That's also fine with me. But yes we need documentation on this, as long as it is clear to users/maintainers", "url": "https://github.com/apache/storm/pull/3267#discussion_r424062759", "createdAt": "2020-05-12T22:09:36Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/daemon/supervisor/Supervisor.java", "diffHunk": "@@ -327,6 +330,15 @@ public void launch() throws Exception {\n         LOG.info(\"Starting supervisor with id {} at host {}.\", getId(), getHostName());\n     }\n \n+    private void validateConf() {\n+        List<Number> ports = (List<Number>) conf.get(DaemonConfig.SUPERVISOR_SLOTS_PORTS);\n+        Set<Integer> numaPorts = SupervisorUtils.getNumaPorts(conf);\n+        numaPorts.removeAll(ports);\n+        if (numaPorts.size() > 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1NDQ2Ng=="}, "originalCommit": {"oid": "31fa0361724906d686a1895f74c6ee19e98adc13"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYzNzU0NA==", "bodyText": "Updated comment in https://issues.apache.org/jira/browse/STORM-3615 to address as part of the NUMA feature documentation.", "url": "https://github.com/apache/storm/pull/3267#discussion_r424637544", "createdAt": "2020-05-13T18:15:26Z", "author": {"login": "agresch"}, "path": "storm-server/src/main/java/org/apache/storm/daemon/supervisor/Supervisor.java", "diffHunk": "@@ -327,6 +330,15 @@ public void launch() throws Exception {\n         LOG.info(\"Starting supervisor with id {} at host {}.\", getId(), getHostName());\n     }\n \n+    private void validateConf() {\n+        List<Number> ports = (List<Number>) conf.get(DaemonConfig.SUPERVISOR_SLOTS_PORTS);\n+        Set<Integer> numaPorts = SupervisorUtils.getNumaPorts(conf);\n+        numaPorts.removeAll(ports);\n+        if (numaPorts.size() > 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1NDQ2Ng=="}, "originalCommit": {"oid": "31fa0361724906d686a1895f74c6ee19e98adc13"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY2MTkwMA==", "bodyText": "@kishorvpatil - updated to add numa ports to slots ports config.", "url": "https://github.com/apache/storm/pull/3267#discussion_r424661900", "createdAt": "2020-05-13T18:55:59Z", "author": {"login": "agresch"}, "path": "storm-server/src/main/java/org/apache/storm/daemon/supervisor/Supervisor.java", "diffHunk": "@@ -327,6 +330,15 @@ public void launch() throws Exception {\n         LOG.info(\"Starting supervisor with id {} at host {}.\", getId(), getHostName());\n     }\n \n+    private void validateConf() {\n+        List<Number> ports = (List<Number>) conf.get(DaemonConfig.SUPERVISOR_SLOTS_PORTS);\n+        Set<Integer> numaPorts = SupervisorUtils.getNumaPorts(conf);\n+        numaPorts.removeAll(ports);\n+        if (numaPorts.size() > 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1NDQ2Ng=="}, "originalCommit": {"oid": "31fa0361724906d686a1895f74c6ee19e98adc13"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0ODY4NDQwOnYy", "diffSide": "RIGHT", "path": "storm-server/src/main/java/org/apache/storm/daemon/supervisor/SupervisorUtils.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxODoyMTo1OVrOGVo3UQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxODoyMTo1OVrOGVo3UQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM0MjgwMQ==", "bodyText": "Should we make them match?\nIf there are ports in SUPERVISOR_SLOTS_PORTS not specified in numa.ports, will there be any issue?\nOne issue I can see is it will create ports that will possibly never be used.", "url": "https://github.com/apache/storm/pull/3267#discussion_r425342801", "createdAt": "2020-05-14T18:21:59Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/daemon/supervisor/SupervisorUtils.java", "diffHunk": "@@ -72,6 +75,33 @@ public static String getNumaIdForPort(Integer port, Map<String, Object> supervis\n         return null;\n     }\n \n+    /**\n+     * gets the set of all configured numa ports for a specific supervisor.\n+     * @param supervisorConf supervisorConf\n+     * @return set of all numa ports\n+     */\n+    public static Set<Integer> getNumaPorts(Map<String, Object> supervisorConf) {\n+        Set<Integer> numaPorts = new HashSet<>();\n+        Map<String, Object> validatedNumaMap = getNumaMap(supervisorConf);\n+        for (Map.Entry<String, Object> numaEntry : validatedNumaMap.entrySet()) {\n+            Map<String, Object> numaMap  = (Map<String, Object>) numaEntry.getValue();\n+            List<Integer> portList = (List<Integer>) numaMap.get(NUMA_PORTS);\n+            numaPorts.addAll(portList);\n+        }\n+        return numaPorts;\n+    }\n+\n+    public static List<Integer> getSlotsPorts(Map<String, Object> supervisorConf) {\n+        List<Integer> slotsPorts = (List<Integer>) supervisorConf.getOrDefault(DaemonConfig.SUPERVISOR_SLOTS_PORTS,\n+                new ArrayList<>());\n+        // It's possible we have numaPorts specified that weren't configured in SUPERVISOR_SLOTS_PORTS.  Make\n+        // sure we handle these ports as well.\n+        Set<Integer> numaPorts = SupervisorUtils.getNumaPorts(supervisorConf);\n+        numaPorts.removeAll(slotsPorts);\n+        slotsPorts.addAll(numaPorts);\n+        return slotsPorts;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b36eae9385616a26dd0f84c3071b8c4908d57d4"}, "originalPosition": 40}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4290, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}