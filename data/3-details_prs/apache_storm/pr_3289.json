{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3OTg3Nzc3", "number": 3289, "title": "[STORM-3654] remove executor id from JCQueue receive-queue name", "bodyText": "What is the purpose of the change\nThis name is mainly used in two places:\n\n\nJCQueue metric name: Add unique executor id to metric name could be bad if we want to aggregate metrics across multiple executors/components. Also, executor id is already present in metrics dimension info such as metricRegistry.gauge(queueName + \"-capacity\", cap, topologyId, componentId, taskId, port);.\n\n\nJCQueue name: queue name was only used in debug level log in back-pressure usecase. It would be useful to know which executor is experiencing back-pressure when tuning topologies.\nIn order to retain this info, we add a new field called owner of the JCQueue as we know it is only used in worker transfer queue or executor receive queue. Owner will just be the executor id or worker id.\n\n\nHow was the change tested\nTested with WordCount topology with LoggingMetricsConsumer. Executor id is removed from metric name.", "createdAt": "2020-06-22T14:38:48Z", "url": "https://github.com/apache/storm/pull/3289", "merged": true, "mergeCommit": {"oid": "450d5956bf8345d2b1dff9c60d8d50cb2431edb3"}, "closed": true, "closedAt": "2020-06-29T14:27:53Z", "author": {"login": "RuiLi8080"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABctyVu-ABqjM0Njg4NTIxOTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwB50FAFqTQzOTE5OTk4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "40a10a3d4d899c7c682feed00c3a91f4250e1d6c", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/40a10a3d4d899c7c682feed00c3a91f4250e1d6c", "committedDate": "2020-06-22T05:56:42Z", "message": "[STORM-3654] remove executor id from JCQueue receive-queue name"}, "afterCommit": {"oid": "1be1307ff5931c41057ea2a2ae7a8f8369bb0564", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/1be1307ff5931c41057ea2a2ae7a8f8369bb0564", "committedDate": "2020-06-22T15:11:26Z", "message": "[STORM-3654] remove executor id from JCQueue receive-queue name"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1be1307ff5931c41057ea2a2ae7a8f8369bb0564", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/1be1307ff5931c41057ea2a2ae7a8f8369bb0564", "committedDate": "2020-06-22T15:11:26Z", "message": "[STORM-3654] remove executor id from JCQueue receive-queue name"}, "afterCommit": {"oid": "9d73a8633757d2b8a021d4eb6080338bb281f8ec", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/9d73a8633757d2b8a021d4eb6080338bb281f8ec", "committedDate": "2020-06-22T15:12:01Z", "message": "[STORM-3654] remove executor id from JCQueue receive-queue name"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9d73a8633757d2b8a021d4eb6080338bb281f8ec", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/9d73a8633757d2b8a021d4eb6080338bb281f8ec", "committedDate": "2020-06-22T15:12:01Z", "message": "[STORM-3654] remove executor id from JCQueue receive-queue name"}, "afterCommit": {"oid": "4c2df9b605d2f2661bd9dab6c479bf6f096a8197", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/4c2df9b605d2f2661bd9dab6c479bf6f096a8197", "committedDate": "2020-06-22T15:12:38Z", "message": "[STORM-3654] remove executor id from JCQueue receive-queue name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36e3bb71a90230be326e6d8cb938ced94d3cb352", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/36e3bb71a90230be326e6d8cb938ced94d3cb352", "committedDate": "2020-06-22T15:33:27Z", "message": "[STORM-3654] remove executor id from JCQueue receive-queue name"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4c2df9b605d2f2661bd9dab6c479bf6f096a8197", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/4c2df9b605d2f2661bd9dab6c479bf6f096a8197", "committedDate": "2020-06-22T15:12:38Z", "message": "[STORM-3654] remove executor id from JCQueue receive-queue name"}, "afterCommit": {"oid": "36e3bb71a90230be326e6d8cb938ced94d3cb352", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/36e3bb71a90230be326e6d8cb938ced94d3cb352", "committedDate": "2020-06-22T15:33:27Z", "message": "[STORM-3654] remove executor id from JCQueue receive-queue name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MTc2NzY3", "url": "https://github.com/apache/storm/pull/3289#pullrequestreview-436176767", "createdAt": "2020-06-23T21:37:48Z", "commit": {"oid": "36e3bb71a90230be326e6d8cb938ced94d3cb352"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "edc7f984d113923485279dfbb8836b147a7bcdb4", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/edc7f984d113923485279dfbb8836b147a7bcdb4", "committedDate": "2020-06-24T18:40:51Z", "message": "use metricNamePrefix instead of owner to prevent adding more fields"}, "afterCommit": {"oid": "3af181c7402a0a1cf8a67bfc0525a12938b2a91c", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/3af181c7402a0a1cf8a67bfc0525a12938b2a91c", "committedDate": "2020-06-24T18:46:15Z", "message": "use metricNamePrefix instead of owner to prevent adding more fields"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2OTI1MjEz", "url": "https://github.com/apache/storm/pull/3289#pullrequestreview-436925213", "createdAt": "2020-06-24T19:01:50Z", "commit": {"oid": "3af181c7402a0a1cf8a67bfc0525a12938b2a91c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1dc2747867b7189db2b5f779acb82dd5c71ec495", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/1dc2747867b7189db2b5f779acb82dd5c71ec495", "committedDate": "2020-06-24T19:51:17Z", "message": "use metricNamePrefix instead of owner to prevent adding more fields"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3af181c7402a0a1cf8a67bfc0525a12938b2a91c", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/3af181c7402a0a1cf8a67bfc0525a12938b2a91c", "committedDate": "2020-06-24T18:46:15Z", "message": "use metricNamePrefix instead of owner to prevent adding more fields"}, "afterCommit": {"oid": "1dc2747867b7189db2b5f779acb82dd5c71ec495", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/1dc2747867b7189db2b5f779acb82dd5c71ec495", "committedDate": "2020-06-24T19:51:17Z", "message": "use metricNamePrefix instead of owner to prevent adding more fields"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NzExNTUx", "url": "https://github.com/apache/storm/pull/3289#pullrequestreview-437711551", "createdAt": "2020-06-25T17:32:14Z", "commit": {"oid": "1dc2747867b7189db2b5f779acb82dd5c71ec495"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNzozMjoxNFrOGpEztQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNzozOToyNFrOGpFDNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTcyMzU3Mw==", "bodyText": "why is this null (Although I guess it doesn't matter)", "url": "https://github.com/apache/storm/pull/3289#discussion_r445723573", "createdAt": "2020-06-25T17:32:14Z", "author": {"login": "Ethanlm"}, "path": "examples/storm-perf/src/main/java/org/apache/storm/perf/queuetest/JCQueuePerfTest.java", "diffHunk": "@@ -72,7 +72,7 @@ private static void producerFwdConsumer(int prodBatchSz) {\n \n \n     private static void oneProducer1Consumer(int prodBatchSz) {\n-        JCQueue q1 = new JCQueue(\"q1\", 50_000, 0, prodBatchSz, new WaitStrategyPark(100), \"test\", \"test\",\n+        JCQueue q1 = new JCQueue(\"q1\", null, 50_000, 0, prodBatchSz, new WaitStrategyPark(100), \"test\", \"test\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1dc2747867b7189db2b5f779acb82dd5c71ec495"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTcyNzAyNA==", "bodyText": "Since JCQueueMetrics takes metricNamePrefix now, I think it is better to change  the variable name in JCQueueMetrics from queueName to metricNamePrefix to avoid confusion.\nhttps://github.com/apache/storm/blob/master/storm-client/src/jvm/org/apache/storm/utils/JCQueueMetrics.java#L35", "url": "https://github.com/apache/storm/pull/3289#discussion_r445727024", "createdAt": "2020-06-25T17:38:27Z", "author": {"login": "Ethanlm"}, "path": "storm-client/src/jvm/org/apache/storm/utils/JCQueue.java", "diffHunk": "@@ -44,15 +44,16 @@\n     private final IWaitStrategy backPressureWaitStrategy;\n     private final String queueName;\n \n-    public JCQueue(String queueName, int size, int overflowLimit, int producerBatchSz, IWaitStrategy backPressureWaitStrategy,\n-                   String topologyId, String componentId, List<Integer> taskIds, int port, StormMetricRegistry metricRegistry) {\n+    public JCQueue(String queueName, String metricNamePrefix, int size, int overflowLimit, int producerBatchSz,\n+                   IWaitStrategy backPressureWaitStrategy, String topologyId, String componentId, List<Integer> taskIds,\n+                   int port, StormMetricRegistry metricRegistry) {\n         this.queueName = queueName;\n         this.overflowLimit = overflowLimit;\n         this.recvQueue = new MpscArrayQueue<>(size);\n         this.overflowQ = new MpscUnboundedArrayQueue<>(size);\n \n         for (Integer taskId : taskIds) {\n-            this.jcqMetrics.add(new JCQueueMetrics(queueName, topologyId, componentId, taskId, port,\n+            this.jcqMetrics.add(new JCQueueMetrics(metricNamePrefix, topologyId, componentId, taskId, port,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1dc2747867b7189db2b5f779acb82dd5c71ec495"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTcyNzQzNw==", "bodyText": "is it better to use name instead of null?", "url": "https://github.com/apache/storm/pull/3289#discussion_r445727437", "createdAt": "2020-06-25T17:39:14Z", "author": {"login": "Ethanlm"}, "path": "storm-client/test/jvm/org/apache/storm/utils/JCQueueBackpressureTest.java", "diffHunk": "@@ -22,7 +22,7 @@\n public class JCQueueBackpressureTest {\n     \n     private static JCQueue createQueue(String name, int queueSize) {\n-        return new JCQueue(name, queueSize, 0, 1, new WaitStrategyPark(0), \"test\", \"test\", Collections.singletonList(1000), 1000, new StormMetricRegistry());\n+        return new JCQueue(name, null, queueSize, 0, 1, new WaitStrategyPark(0), \"test\", \"test\", Collections.singletonList(1000), 1000, new StormMetricRegistry());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1dc2747867b7189db2b5f779acb82dd5c71ec495"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTcyNzU0MQ==", "bodyText": "is it better to use name instead of null?", "url": "https://github.com/apache/storm/pull/3289#discussion_r445727541", "createdAt": "2020-06-25T17:39:24Z", "author": {"login": "Ethanlm"}, "path": "storm-client/test/jvm/org/apache/storm/utils/JCQueueTest.java", "diffHunk": "@@ -157,7 +157,7 @@ private JCQueue createQueue(String name, int queueSize) {\n     }\n \n     private JCQueue createQueue(String name, int batchSize, int queueSize) {\n-        return new JCQueue(name, queueSize, 0, batchSize, waitStrategy, \"test\", \"test\", Collections.singletonList(1000), 1000, new StormMetricRegistry());\n+        return new JCQueue(name, null, queueSize, 0, batchSize, waitStrategy, \"test\", \"test\", Collections.singletonList(1000), 1000, new StormMetricRegistry());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1dc2747867b7189db2b5f779acb82dd5c71ec495"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "417d2c0a3d7abc7863ead95fc5c66181782fa4f1", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/417d2c0a3d7abc7863ead95fc5c66181782fa4f1", "committedDate": "2020-06-29T06:16:09Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MTk5OTgx", "url": "https://github.com/apache/storm/pull/3289#pullrequestreview-439199981", "createdAt": "2020-06-29T14:27:30Z", "commit": {"oid": "417d2c0a3d7abc7863ead95fc5c66181782fa4f1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4606, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}