{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyNDk2MTYy", "number": 3318, "title": "[STORM-3670] Separate configurations for daemon metric reporters and topology metrics reporters", "bodyText": "What is the purpose of the change\nThe configuration system on metrics reporters is messy. This PR cleans up configs and separate them as topology worker metrics vs daemon metrics.\nHow was the change tested\n\n\nAdd unit tests\n\n\nTested daemon metric reporters on nimbus with ConsolePreparableReporter and CsvPreparableReporter to make sure daemon metric reporters still work properly\n\n\nCsvPreparableReporter:\n-bash-4.2$ ls -ltrh /home/y/var/storm/csvmetrics/ |tail\n-rw-r--r-- 1 xx yy  494 Aug  4 02:01 nimbus:num-uploadChunk-calls.csv\n-rw-r--r-- 1 xx yy  494 Aug  4 02:01 nimbus:num-submitTopologyWithOpts-calls.csv\n...\n\nConsolePreparableReporter:\n8/4/20 1:49:01 AM ==============================================================\n-- Gauges ----------------------------------------------------------------------\nMetricsCleaner:purgeTimestamp\nvalue = 0\nnimbus:available-cpu-non-negative\nvalue = 400.0\n\n\nTested worker metric reporters, for example, with this configuration\n\ntopology.metrics.reporters:\n  - class: \"org.apache.storm.metrics2.reporters.ConsoleStormReporter\"\n    report.period: 10\n    report.period.units: \"SECONDS\"\n    rate.unit: \"SECONDS\"\n    locale: \"en-US\"\n  - class: \"org.apache.storm.metrics2.reporters.CsvStormReporter\"\n    report.period: 10\n    report.period.units: \"SECONDS\"\n    rate.unit: \"SECONDS\"\n    locale: \"en-US\"\n    csv.log.dir: \"./\"\n\nConsoleStormReporter:\n2020-08-04 02:33:17.738 c.c.m.ConsoleReporter metrics-console-reporter-1-thread-1 [INFO] -- Counters --------------------------------------------------------------------\n2020-08-04 02:33:17.738 c.c.m.ConsoleReporter metrics-console-reporter-1-thread-1 [INFO] storm.worker.wc13-4-1596508362.hostname.count.default.2.6701-acked\n2020-08-04 02:33:17.738 c.c.m.ConsoleReporter metrics-console-reporter-1-thread-1 [INFO]              count = 840\n\nCsvStormReporter:\n-bash-4.2$ sudo ls -l /home/y/var/storm/workers/4d6259dc-ea7c-4048-a44d-be69adceecdd |tail -f\n-rw-r----- 1 xx yy   143 Aug  4 02:34 storm.worker.wc13-4-1596508362.hostname.__system.3.6701-receive-queue-sojourn_time_ms.csv\n-rw-r----- 1 xx yy   175 Aug  4 02:34 storm.worker.wc13-4-1596508362.hostname.__system.4.6701-receive-queue-arrival_rate_secs.csv", "createdAt": "2020-08-04T02:51:56Z", "url": "https://github.com/apache/storm/pull/3318", "merged": true, "mergeCommit": {"oid": "bb3e7a195a1a97f4184a48bb4ad07a398194ed1a"}, "closed": true, "closedAt": "2020-08-06T14:47:51Z", "author": {"login": "Ethanlm"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7dXSlAH2gAyNDYyNDk2MTYyOmI3MjQxYzU1ZjY4YjhmYmYxOGYwODlhMWY0MzQ5Zjc5MTYzMTA5ZjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7_zj0gFqTQ2MTkzMjM4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b7241c55f68b8fbf18f089a1f4349f79163109f2", "author": {"user": {"login": "Ethanlm", "name": "Meng (Ethan) Li "}}, "url": "https://github.com/apache/storm/commit/b7241c55f68b8fbf18f089a1f4349f79163109f2", "committedDate": "2020-08-04T02:40:18Z", "message": "[STORM-3670] Separate configurations for daemon metric reporters and topology metrics reporters"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwODgxNDkz", "url": "https://github.com/apache/storm/pull/3318#pullrequestreview-460881493", "createdAt": "2020-08-04T14:41:52Z", "commit": {"oid": "b7241c55f68b8fbf18f089a1f4349f79163109f2"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxNDo0MTo1MlrOG7jp0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxNDo1NjoyMVrOG7kTBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTEwMzMxMw==", "bodyText": "I don't see the value in adding the version, I would just remove it.", "url": "https://github.com/apache/storm/pull/3318#discussion_r465103313", "createdAt": "2020-08-04T14:41:52Z", "author": {"login": "agresch"}, "path": "docs/metrics_v2.md", "diffHunk": "@@ -72,7 +72,7 @@ public class TupleCountingBolt extends BaseRichBolt {\n  For metrics to be useful they must be *reported*, in other words sent somewhere where they can be consumed and analyzed.\n  That can be as simple as writing them to a log file, sending them to a time series database, or exposing them via JMX.\n  \n- As of Storm 1.2.0 the following metric reporters are supported\n+Since Storm 1.2.0, the following metric reporters are supported", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7241c55f68b8fbf18f089a1f4349f79163109f2"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTEwNTE5MQ==", "bodyText": "Should these be deprecated if only for backwards compatibility?", "url": "https://github.com/apache/storm/pull/3318#discussion_r465105191", "createdAt": "2020-08-04T14:44:34Z", "author": {"login": "agresch"}, "path": "storm-client/src/jvm/org/apache/storm/Config.java", "diffHunk": "@@ -1731,21 +1744,28 @@\n     @IsInteger\n     @IsPositiveNumber\n     public static final String WORKER_BLOB_UPDATE_POLL_INTERVAL_SECS = \"worker.blob.update.poll.interval.secs\";\n+\n     /**\n-     * A specify Locale for daemon metrics reporter plugin. Use the specified IETF BCP 47 language tag string for a Locale.\n+     * Specify the Locale for daemon metrics reporter plugin. Use the specified IETF BCP 47 language tag string for a Locale.\n+     * This config should have been placed in the DaemonConfig class. Keeping it here only for backwards compatibility.\n      */\n     @IsString\n     public static final String STORM_DAEMON_METRICS_REPORTER_PLUGIN_LOCALE = \"storm.daemon.metrics.reporter.plugin.locale\";\n+\n     /**\n-     * A specify rate-unit in TimeUnit to specify reporting frequency for daemon metrics reporter plugin.\n+     * Specify the rate unit in TimeUnit for daemon metrics reporter plugin.\n+     * This config should have been placed in the DaemonConfig class. Keeping it here only for backwards compatibility.\n      */\n     @IsString\n     public static final String STORM_DAEMON_METRICS_REPORTER_PLUGIN_RATE_UNIT = \"storm.daemon.metrics.reporter.plugin.rate.unit\";\n+\n     /**\n-     * A specify duration-unit in TimeUnit to specify reporting window for daemon metrics reporter plugin.\n+     * Specify the duration unit in TimeUnit for daemon metrics reporter plugin.\n+     * This config should have been placed in the DaemonConfig class. Keeping it here only for backwards compatibility.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7241c55f68b8fbf18f089a1f4349f79163109f2"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTEwNzcxOA==", "bodyText": "Can you add a javadoc indicating why this is a conf vs the others being reporterConf?  Is this a backwards compatibility thing?", "url": "https://github.com/apache/storm/pull/3318#discussion_r465107718", "createdAt": "2020-08-04T14:47:52Z", "author": {"login": "agresch"}, "path": "storm-client/src/jvm/org/apache/storm/daemon/metrics/ClientMetricsUtils.java", "diffHunk": "@@ -20,26 +20,31 @@\n \n public class ClientMetricsUtils {\n \n-    public static TimeUnit getMetricsRateUnit(Map<String, Object> topoConf) {\n-        return getTimeUnitForCofig(topoConf, Config.STORM_DAEMON_METRICS_REPORTER_PLUGIN_RATE_UNIT);\n+    private static final String RATE_UNIT = \"rate.unit\";\n+    private static final String DURATION_UNIT = \"duration.unit\";\n+    // Use the specified IETF BCP 47 language tag string for a Locale\n+    private static final String LOCALE = \"locale\";\n+\n+    public static TimeUnit getMetricsRateUnit(Map<String, Object> reporterConf) {\n+        return getTimeUnitForConfig(reporterConf, RATE_UNIT);\n     }\n \n-    public static TimeUnit getMetricsDurationUnit(Map<String, Object> topoConf) {\n-        return getTimeUnitForCofig(topoConf, Config.STORM_DAEMON_METRICS_REPORTER_PLUGIN_DURATION_UNIT);\n+    public static TimeUnit getMetricsDurationUnit(Map<String, Object> reporterConf) {\n+        return getTimeUnitForConfig(reporterConf, DURATION_UNIT);\n     }\n \n-    public static Locale getMetricsReporterLocale(Map<String, Object> topoConf) {\n-        String languageTag = ObjectReader.getString(topoConf.get(Config.STORM_DAEMON_METRICS_REPORTER_PLUGIN_LOCALE), null);\n+    public static Locale getMetricsReporterLocale(Map<String, Object> reporterConf) {\n+        String languageTag = ObjectReader.getString(reporterConf.get(LOCALE), null);\n         if (languageTag != null) {\n             return Locale.forLanguageTag(languageTag);\n         }\n         return null;\n     }\n \n-    private static TimeUnit getTimeUnitForCofig(Map<String, Object> topoConf, String configName) {\n-        String rateUnitString = ObjectReader.getString(topoConf.get(configName), null);\n-        if (rateUnitString != null) {\n-            return TimeUnit.valueOf(rateUnitString);\n+    public static TimeUnit getTimeUnitForConfig(Map<String, Object> conf, String configName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7241c55f68b8fbf18f089a1f4349f79163109f2"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTExMzg2Mg==", "bodyText": "Unrelated to this PR, but it seems odd this is a metrics util thing rather than belonging to the CSV reporter class.", "url": "https://github.com/apache/storm/pull/3318#discussion_r465113862", "createdAt": "2020-08-04T14:56:21Z", "author": {"login": "agresch"}, "path": "storm-server/src/main/java/org/apache/storm/daemon/metrics/MetricsUtils.java", "diffHunk": "@@ -58,10 +61,11 @@ private static PreparableReporter getPreparableReporter(String clazz) {\n         return reporter;\n     }\n \n-    public static File getCsvLogDir(Map<String, Object> topoConf) {\n-        String csvMetricsLogDirectory = ObjectReader.getString(topoConf.get(DaemonConfig.STORM_DAEMON_METRICS_REPORTER_CSV_LOG_DIR), null);\n+    public static File getCsvLogDir(Map<String, Object> daemonConf) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7241c55f68b8fbf18f089a1f4349f79163109f2"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5c73726a19b22db9c2bd180ea06f3a5663c798a", "author": {"user": {"login": "Ethanlm", "name": "Meng (Ethan) Li "}}, "url": "https://github.com/apache/storm/commit/c5c73726a19b22db9c2bd180ea06f3a5663c798a", "committedDate": "2020-08-04T15:24:29Z", "message": "[STORM-3670] address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwOTU3MTc5", "url": "https://github.com/apache/storm/pull/3318#pullrequestreview-460957179", "createdAt": "2020-08-04T16:03:56Z", "commit": {"oid": "c5c73726a19b22db9c2bd180ea06f3a5663c798a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwOTk1ODQx", "url": "https://github.com/apache/storm/pull/3318#pullrequestreview-460995841", "createdAt": "2020-08-04T16:52:41Z", "commit": {"oid": "01049477ee7246b175e804a75301f394d23771f5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "01049477ee7246b175e804a75301f394d23771f5", "author": {"user": {"login": "Ethanlm", "name": "Meng (Ethan) Li "}}, "url": "https://github.com/apache/storm/commit/01049477ee7246b175e804a75301f394d23771f5", "committedDate": "2020-08-04T16:49:00Z", "message": "[STORM-3670] address review comments"}, "afterCommit": {"oid": "c5c73726a19b22db9c2bd180ea06f3a5663c798a", "author": {"user": {"login": "Ethanlm", "name": "Meng (Ethan) Li "}}, "url": "https://github.com/apache/storm/commit/c5c73726a19b22db9c2bd180ea06f3a5663c798a", "committedDate": "2020-08-04T15:24:29Z", "message": "[STORM-3670] address review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2345dba77d7721db63a283395518db4a4b15aa12", "author": {"user": {"login": "Ethanlm", "name": "Meng (Ethan) Li "}}, "url": "https://github.com/apache/storm/commit/2345dba77d7721db63a283395518db4a4b15aa12", "committedDate": "2020-08-04T19:29:15Z", "message": "[STORM-3670] more comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxOTMyMzg5", "url": "https://github.com/apache/storm/pull/3318#pullrequestreview-461932389", "createdAt": "2020-08-05T18:47:57Z", "commit": {"oid": "2345dba77d7721db63a283395518db4a4b15aa12"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4896, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}