{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyOTI4MzAx", "number": 3233, "title": "[STORM-1293] port storm.messaging.netty-integration-test to java", "bodyText": "", "createdAt": "2020-03-24T11:16:32Z", "url": "https://github.com/apache/storm/pull/3233", "merged": true, "mergeCommit": {"oid": "1a382d477b550723984e46acf24dd957fd043aa3"}, "closed": true, "closedAt": "2020-04-13T14:54:14Z", "author": {"login": "nd368"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQxBAVgH2gAyMzkyOTI4MzAxOjIxOWZiOWVlZWIwMGViMzg0MDQ0MWVkZDU4OTc2NDA4NTg1YjRiOWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcWuhvPAFqTM5MTgwODU5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "219fb9eeeb00eb3840441edd58976408585b4b9f", "author": {"user": {"login": "nd368", "name": null}}, "url": "https://github.com/apache/storm/commit/219fb9eeeb00eb3840441edd58976408585b4b9f", "committedDate": "2020-03-24T11:15:19Z", "message": "[STORM-1293] port storm.messaging.netty-integration-test to java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MTk4NzYx", "url": "https://github.com/apache/storm/pull/3233#pullrequestreview-389198761", "createdAt": "2020-04-07T14:54:06Z", "commit": {"oid": "219fb9eeeb00eb3840441edd58976408585b4b9f"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNDo1NDowNlrOGCHhyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNDo1Nzo0NVrOGCHtcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg3MzY3Mw==", "bodyText": "We can separate this to be\nBuilder builder = new Builder()\n.withSimulatedTime()\n.withSupervisors(4)\n.withSupervisorSlotPortMin(6710)\n.withDaemonConf(daemonConf);\n\ntry (LocalCluster cluster = builder.build()) {\nxxx\n}", "url": "https://github.com/apache/storm/pull/3233#discussion_r404873673", "createdAt": "2020-04-07T14:54:06Z", "author": {"login": "Ethanlm"}, "path": "storm-core/test/jvm/org/apache/storm/messaging/NettyIntegrationTest.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Copyright 2018 The Apache Software Foundation.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.storm.messaging;\n+\n+import org.apache.storm.Config;\n+import org.apache.storm.LocalCluster;\n+import org.apache.storm.Testing;\n+import org.apache.storm.generated.StormTopology;\n+import org.apache.storm.testing.CompleteTopologyParam;\n+import org.apache.storm.testing.FixedTuple;\n+import org.apache.storm.testing.IntegrationTest;\n+import org.apache.storm.testing.MockedSources;\n+import org.apache.storm.testing.TestGlobalCount;\n+import org.apache.storm.testing.TestWordSpout;\n+import org.apache.storm.topology.TopologyBuilder;\n+import org.apache.storm.tuple.Values;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.junit.Assert.assertThat;\n+\n+@IntegrationTest\n+public class NettyIntegrationTest {\n+\n+    @Test\n+    public void testIntegration() throws Exception {\n+        Map<String, Object> daemonConf = new HashMap<>();\n+        daemonConf.put(Config.STORM_LOCAL_MODE_ZMQ, true);\n+        daemonConf.put(Config.STORM_MESSAGING_TRANSPORT, \"org.apache.storm.messaging.netty.Context\");\n+        daemonConf.put(Config.STORM_MESSAGING_NETTY_AUTHENTICATION, false);\n+        daemonConf.put(Config.STORM_MESSAGING_NETTY_BUFFER_SIZE, 1024000);\n+        daemonConf.put(Config.STORM_MESSAGING_NETTY_MIN_SLEEP_MS, 1000);\n+        daemonConf.put(Config.STORM_MESSAGING_NETTY_MAX_SLEEP_MS, 5000);\n+        daemonConf.put(Config.STORM_MESSAGING_NETTY_CLIENT_WORKER_THREADS, 1);\n+        daemonConf.put(Config.STORM_MESSAGING_NETTY_SERVER_WORKER_THREADS, 1);\n+\n+        try (LocalCluster cluster = new LocalCluster.Builder().withSimulatedTime().withSupervisors(4)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "219fb9eeeb00eb3840441edd58976408585b4b9f"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg3NjY1Ng==", "bodyText": "Can we use assertEquals here?", "url": "https://github.com/apache/storm/pull/3233#discussion_r404876656", "createdAt": "2020-04-07T14:57:45Z", "author": {"login": "Ethanlm"}, "path": "storm-core/test/jvm/org/apache/storm/messaging/NettyIntegrationTest.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Copyright 2018 The Apache Software Foundation.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.storm.messaging;\n+\n+import org.apache.storm.Config;\n+import org.apache.storm.LocalCluster;\n+import org.apache.storm.Testing;\n+import org.apache.storm.generated.StormTopology;\n+import org.apache.storm.testing.CompleteTopologyParam;\n+import org.apache.storm.testing.FixedTuple;\n+import org.apache.storm.testing.IntegrationTest;\n+import org.apache.storm.testing.MockedSources;\n+import org.apache.storm.testing.TestGlobalCount;\n+import org.apache.storm.testing.TestWordSpout;\n+import org.apache.storm.topology.TopologyBuilder;\n+import org.apache.storm.tuple.Values;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.junit.Assert.assertThat;\n+\n+@IntegrationTest\n+public class NettyIntegrationTest {\n+\n+    @Test\n+    public void testIntegration() throws Exception {\n+        Map<String, Object> daemonConf = new HashMap<>();\n+        daemonConf.put(Config.STORM_LOCAL_MODE_ZMQ, true);\n+        daemonConf.put(Config.STORM_MESSAGING_TRANSPORT, \"org.apache.storm.messaging.netty.Context\");\n+        daemonConf.put(Config.STORM_MESSAGING_NETTY_AUTHENTICATION, false);\n+        daemonConf.put(Config.STORM_MESSAGING_NETTY_BUFFER_SIZE, 1024000);\n+        daemonConf.put(Config.STORM_MESSAGING_NETTY_MIN_SLEEP_MS, 1000);\n+        daemonConf.put(Config.STORM_MESSAGING_NETTY_MAX_SLEEP_MS, 5000);\n+        daemonConf.put(Config.STORM_MESSAGING_NETTY_CLIENT_WORKER_THREADS, 1);\n+        daemonConf.put(Config.STORM_MESSAGING_NETTY_SERVER_WORKER_THREADS, 1);\n+\n+        try (LocalCluster cluster = new LocalCluster.Builder().withSimulatedTime().withSupervisors(4)\n+                .withSupervisorSlotPortMin(6710).withDaemonConf(daemonConf).build()) {\n+\n+            TopologyBuilder builder = new TopologyBuilder();\n+            builder.setSpout(\"1\", new TestWordSpout(true), 4);\n+            builder.setBolt(\"2\", new TestGlobalCount(), 6).shuffleGrouping(\"1\");\n+            StormTopology topology = builder.createTopology();\n+\n+            // important for test that tuples = multiple of 4 and 6\n+            List<FixedTuple> testTuples = Stream.of(\"a\", \"b\",\n+                                                    \"a\", \"b\",\n+                                                    \"a\", \"b\",\n+                                                    \"a\", \"b\",\n+                                                    \"a\", \"b\",\n+                                                    \"a\", \"b\",\n+                                                    \"a\", \"b\",\n+                                                    \"a\", \"b\",\n+                                                    \"a\", \"b\",\n+                                                    \"a\", \"b\",\n+                                                    \"a\", \"b\",\n+                                                    \"a\", \"b\")\n+                    .map(value -> new FixedTuple(new Values(value)))\n+                    .collect(Collectors.toList());\n+\n+            MockedSources mockedSources = new MockedSources(Collections.singletonMap(\"1\", testTuples));\n+\n+            CompleteTopologyParam completeTopologyParams = new CompleteTopologyParam();\n+            completeTopologyParams.setStormConf(Collections.singletonMap(Config.TOPOLOGY_WORKERS, 3));\n+            completeTopologyParams.setMockedSources(mockedSources);\n+\n+            Map<String, List<FixedTuple>> results = Testing.completeTopology(cluster, topology, completeTopologyParams);\n+\n+            assertThat(Testing.readTuples(results, \"2\").size(), is(6 * 4));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "219fb9eeeb00eb3840441edd58976408585b4b9f"}, "originalPosition": 90}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05de8ae00e2d0d33334edee45903adfc3d509d09", "author": {"user": {"login": "nd368", "name": null}}, "url": "https://github.com/apache/storm/commit/05de8ae00e2d0d33334edee45903adfc3d509d09", "committedDate": "2020-04-11T09:00:44Z", "message": "[STORM-1293] port storm.messaging.netty-integration-test to java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxODA4NTk3", "url": "https://github.com/apache/storm/pull/3233#pullrequestreview-391808597", "createdAt": "2020-04-11T23:44:54Z", "commit": {"oid": "05de8ae00e2d0d33334edee45903adfc3d509d09"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4532, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}