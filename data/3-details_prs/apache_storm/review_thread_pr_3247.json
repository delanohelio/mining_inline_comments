{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxMDc3ODE4", "number": 3247, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMTowMTo1NFrODwKhpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMTowNjoyOFrODwKnCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxODMwNjk1OnYy", "diffSide": "RIGHT", "path": "storm-client/src/jvm/org/apache/storm/StormSubmitter.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMTowMTo1NFrOGDA17g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMTowMTo1NFrOGDA17g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxMjcxOA==", "bodyText": "Changing the name here because it calls client.getClient().isTopologyNameAllowed and it doesn't only check the existence of the topology name.", "url": "https://github.com/apache/storm/pull/3247#discussion_r405812718", "createdAt": "2020-04-08T21:01:54Z", "author": {"login": "Ethanlm"}, "path": "storm-client/src/jvm/org/apache/storm/StormSubmitter.java", "diffHunk": "@@ -435,7 +436,7 @@ public void onCompleted(String srcFile, String targetFile, long totalBytes) {\n         });\n     }\n \n-    private static boolean topologyNameExists(String name, NimbusClient client) {\n+    private static boolean isTopologyNameAllowed(String name, NimbusClient client) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be63269cc338078c4bfb3d88f2732dcae672aab8"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxODMxODk1OnYy", "diffSide": "RIGHT", "path": "storm-client/src/jvm/org/apache/storm/utils/Utils.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMTowNTo0OFrOGDA9fA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMTowNTo0OFrOGDA9fA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxNDY1Mg==", "bodyText": "Copied TOPOLOGY_NAME_REGEX from storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java. We should have a consistent check for topology name.\nTOPOLOGY_KEY_PATTERN was originally only used for blob key. See #2703", "url": "https://github.com/apache/storm/pull/3247#discussion_r405814652", "createdAt": "2020-04-08T21:05:48Z", "author": {"login": "Ethanlm"}, "path": "storm-client/src/jvm/org/apache/storm/utils/Utils.java", "diffHunk": "@@ -122,7 +122,9 @@\n     // tests by subclassing.\n     private static Utils _instance = new Utils();\n     private static String memoizedLocalHostnameString = null;\n-    public static final Pattern TOPOLOGY_KEY_PATTERN = Pattern.compile(\"^[\\\\w \\\\t\\\\._-]+$\", Pattern.UNICODE_CHARACTER_CLASS);\n+    public static final Pattern BLOB_KEY_PATTERN =\n+            Pattern.compile(\"^[\\\\w \\\\t\\\\._-]+$\", Pattern.UNICODE_CHARACTER_CLASS);\n+    private static final Pattern TOPOLOGY_NAME_REGEX = Pattern.compile(\"^[^/.:\\\\\\\\]+$\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be63269cc338078c4bfb3d88f2732dcae672aab8"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxODMyMDc1OnYy", "diffSide": "LEFT", "path": "storm-client/src/jvm/org/apache/storm/StormSubmitter.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMTowNjoyOFrOGDA-pw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMToxMDo1N1rOGDBHrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxNDk1MQ==", "bodyText": "why was this removed?", "url": "https://github.com/apache/storm/pull/3247#discussion_r405814951", "createdAt": "2020-04-08T21:06:28Z", "author": {"login": "agresch"}, "path": "storm-client/src/jvm/org/apache/storm/StormSubmitter.java", "diffHunk": "@@ -248,11 +252,8 @@ public static void submitTopologyAs(String name, Map<String, Object> topoConf, S\n         try {\n             String serConf = JSONValue.toJSONString(topoConf);\n             try (NimbusClient client = NimbusClient.getConfiguredClientAs(conf, asUser)) {\n-                if (topologyNameExists(name, client)) {\n-                    throw new RuntimeException(\"Topology with name `\" + name + \"` already exists on cluster\");\n-                }\n-                if (!Utils.isValidKey(name)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be63269cc338078c4bfb3d88f2732dcae672aab8"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxNzI2MQ==", "bodyText": "There are two reasons:\n\nMoved the name check to the very beginning of this submit function.\nReplace it with Utils.validateTopologyName(name); so we have the same check on client and server side.", "url": "https://github.com/apache/storm/pull/3247#discussion_r405817261", "createdAt": "2020-04-08T21:10:57Z", "author": {"login": "Ethanlm"}, "path": "storm-client/src/jvm/org/apache/storm/StormSubmitter.java", "diffHunk": "@@ -248,11 +252,8 @@ public static void submitTopologyAs(String name, Map<String, Object> topoConf, S\n         try {\n             String serConf = JSONValue.toJSONString(topoConf);\n             try (NimbusClient client = NimbusClient.getConfiguredClientAs(conf, asUser)) {\n-                if (topologyNameExists(name, client)) {\n-                    throw new RuntimeException(\"Topology with name `\" + name + \"` already exists on cluster\");\n-                }\n-                if (!Utils.isValidKey(name)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxNDk1MQ=="}, "originalCommit": {"oid": "be63269cc338078c4bfb3d88f2732dcae672aab8"}, "originalPosition": 18}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4271, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}