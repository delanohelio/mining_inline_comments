{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwNjc2MTUw", "number": 3297, "title": "STORM-3662: Use Pacemaker if cluster has set up uses it", "bodyText": "What is the purpose of the change\nCurrently, the storm version of the topology is used to determine the RPC heartbeats usage.  For  large clusters with beefier machines, each supervisor can have 100s of workers and multiple supervisor daemons going down can cause a lot of load on nimbus.\nCurrently,\n\nWhile using 2.x topologies, the RPC heartbeats ignore Pacemaker availability.\nThe call sendSupervisorWorkerHeartbeat is just checking supervisor is up.\nThe worker should kill itself if assignment has changed. ( regression)\nSupervisor timer threads are not named.\nNimbus should check if using Pacemaker and expecting heartbeat calls.\n\nWith this change, if Pacemaker is used, the behavior is :\n\nWorker does not call supervisor\nWorker sends heartbeat to pacemaker periodically\nSupervisor does not send worker heartbeats to nimbus.\nNimbus checks if heartbeats should be expected from RPC calls or not.\nIf supervisor is down, the worker kills itself on reassignment. So worker does hang around without checking the reassignments.\nWorker should restart itself if its assignments have changed. ( typically supervisor should notice the change in assignment and  restart worker.) But if supervisor is down, then this is a good backup.\n\nHow was the change tested\nSetup cluster with Pacemaker and validate that:\n\nWorker does sends heartbeat to Pacemaker instead of calling _sendSupervisorWorkerHeartbeat.\nStop Supervisor, re-balance topology- and worker dies (as assignments have changed - logs message about change in assignment worker.log)\nSupervisor does not send executor heartbeats to  nimbus.", "createdAt": "2020-06-26T16:26:07Z", "url": "https://github.com/apache/storm/pull/3297", "merged": true, "mergeCommit": {"oid": "e0ffb8d16097c1bb7545b1d1618a37a739793528"}, "closed": true, "closedAt": "2020-07-02T14:03:14Z", "author": {"login": "kishorvpatil"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcvFFQDgH2gAyNDQwNjc2MTUwOjE5ZjcwMzc0ZTNkYzU0ZTZmYWFkNDA1MTczMzZlNGNkNTAzYzExZWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcws06iAFqTQ0MTAyNDM0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "19f70374e3dc54e6faad40517336e4cd503c11ed", "author": {"user": {"login": "kishorvpatil", "name": "Kishor Patil"}}, "url": "https://github.com/apache/storm/commit/19f70374e3dc54e6faad40517336e4cd503c11ed", "committedDate": "2020-06-26T15:35:47Z", "message": "STORM-3662: Use Pacemaker if cluster has set up uses it"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MjUxNjQx", "url": "https://github.com/apache/storm/pull/3297#pullrequestreview-439251641", "createdAt": "2020-06-29T15:20:07Z", "commit": {"oid": "19f70374e3dc54e6faad40517336e4cd503c11ed"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNToyMDowN1rOGqV6_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNToyMzoxOVrOGqWDzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA1MjU0MQ==", "bodyText": "Do you mean backend store?", "url": "https://github.com/apache/storm/pull/3297#discussion_r447052541", "createdAt": "2020-06-29T15:20:07Z", "author": {"login": "Ethanlm"}, "path": "storm-client/src/jvm/org/apache/storm/cluster/IStormClusterState.java", "diffHunk": "@@ -74,6 +74,13 @@\n      */\n     boolean isAssignmentsBackendSynchronized();\n \n+    /**\n+     * Flag to indicate if the Pacameker is backup store.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19f70374e3dc54e6faad40517336e4cd503c11ed"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA1MzI4Mg==", "bodyText": "We should delete If. Since if this message is logged, it means pacemaker is not being used.", "url": "https://github.com/apache/storm/pull/3297#discussion_r447053282", "createdAt": "2020-06-29T15:21:11Z", "author": {"login": "Ethanlm"}, "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/Worker.java", "diffHunk": "@@ -361,7 +364,11 @@ public void doHeartBeat() throws IOException {\n         state.setWorkerHeartBeat(lsWorkerHeartbeat);\n         state.cleanup(60); // this is just in case supervisor is down so that disk doesn't fill up.\n         // it shouldn't take supervisor 120 seconds between listing dir and reading it\n-        heartbeatToMasterIfLocalbeatFail(lsWorkerHeartbeat);\n+\n+        if (!workerState.stormClusterState.isPacemakerStateStore()) {\n+            LOG.debug(\"If pacemaker is not used, send supervisor\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19f70374e3dc54e6faad40517336e4cd503c11ed"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA1NDMyNw==", "bodyText": "We might want to update the comment here https://github.com/apache/storm/blob/master/storm-client/src/jvm/org/apache/storm/Config.java#L1678-L1684\nsince this config is no longer deprecated. and it is used when Pacemaker is in use.", "url": "https://github.com/apache/storm/pull/3297#discussion_r447054327", "createdAt": "2020-06-29T15:22:35Z", "author": {"login": "Ethanlm"}, "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/Worker.java", "diffHunk": "@@ -215,8 +215,11 @@ private Object loadWorker(IStateStorage stateStorage, IStormClusterState stormCl\n                 }\n             });\n \n+        Integer execHeartBeatFreqSecs = workerState.stormClusterState.isPacemakerStateStore()\n+            ? (Integer) conf.get(Config.TASK_HEARTBEAT_FREQUENCY_SECS)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19f70374e3dc54e6faad40517336e4cd503c11ed"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA1NDc5Nw==", "bodyText": "We can remove this from this PR since it is being addressed in your other PR #3291", "url": "https://github.com/apache/storm/pull/3297#discussion_r447054797", "createdAt": "2020-06-29T15:23:19Z", "author": {"login": "Ethanlm"}, "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/WorkerState.java", "diffHunk": "@@ -377,15 +378,31 @@ public StormTimer getUserTimer() {\n     public SmartThread makeTransferThread() {\n         return workerTransfer.makeTransferThread();\n     }\n-    \n+\n+    public void suicideIfLocalAssignmentsChanged(Assignment assignment) {\n+        if (assignment != null) {\n+            Set<List<Long>> assignedExecutors = new HashSet<>(readWorkerExecutors(assignmentId, port, assignment));\n+            if (!localExecutors.equals(assignedExecutors)) {\n+                LOG.info(\"Found conflicting assignments. We shouldn't be alive!\"\n+                         + \" Assigned: \" + assignedExecutors + \", Current: \"\n+                         + localExecutors);\n+                if (!ConfigUtils.isLocalMode(conf)) {\n+                    suicideCallback.run();\n+                } else {\n+                    LOG.info(\"Local worker tried to commit suicide!\");\n+                }\n+            }\n+        }\n+    }\n+\n     public void refreshConnections() {\n         Assignment assignment = null;\n         try {\n             assignment = getLocalAssignment(stormClusterState, topologyId);\n         } catch (Exception e) {\n             LOG.warn(\"Failed to read assignment. This should only happen when topology is shutting down.\", e);\n         }\n-\n+        suicideIfLocalAssignmentsChanged(assignment);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19f70374e3dc54e6faad40517336e4cd503c11ed"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4152f735708189976d17d3e651b265f41d7e5e2c", "author": {"user": {"login": "kishorvpatil", "name": "Kishor Patil"}}, "url": "https://github.com/apache/storm/commit/4152f735708189976d17d3e651b265f41d7e5e2c", "committedDate": "2020-06-29T18:06:03Z", "message": "Merge branch 'master' of github.com:apache/storm into STORM-3662"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adc0a01e3d6c169a55428482c40f592f2a5d029b", "author": {"user": {"login": "kishorvpatil", "name": "Kishor Patil"}}, "url": "https://github.com/apache/storm/commit/adc0a01e3d6c169a55428482c40f592f2a5d029b", "committedDate": "2020-06-29T18:17:41Z", "message": "STORM-3662: Addressing review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MzkxMjM1", "url": "https://github.com/apache/storm/pull/3297#pullrequestreview-439391235", "createdAt": "2020-06-29T18:20:16Z", "commit": {"oid": "adc0a01e3d6c169a55428482c40f592f2a5d029b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7fc26fe784e33c8e990c170cdfe4ad66c165f36", "author": {"user": {"login": "kishorvpatil", "name": "Kishor Patil"}}, "url": "https://github.com/apache/storm/commit/b7fc26fe784e33c8e990c170cdfe4ad66c165f36", "committedDate": "2020-07-01T16:21:02Z", "message": "Merge branch 'master' of github.com:apache/storm into STORM-3662"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMDI0MzQw", "url": "https://github.com/apache/storm/pull/3297#pullrequestreview-441024340", "createdAt": "2020-07-01T16:28:04Z", "commit": {"oid": "b7fc26fe784e33c8e990c170cdfe4ad66c165f36"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4624, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}