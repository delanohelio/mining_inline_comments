{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4NDk0MTQ2", "number": 3213, "title": "[STORM-3588] add GenericResourceAwareSchedulingPriorityStrategy to accommodate generic resource in grading topologies", "bodyText": "Add GenericResourceAwareSchedulingPriorityStrategy by extending DefaultSchedulingPriorityStrategy to accommodate generic resources when sorting topologies.\nTestGenericResourceAwareSchedulingPriorityStrategy provides situations where DefaultSchedulingPriorityStrategy wrongfully pre-empted all other running topologies. This is prevented by GenericResourceAwareSchedulingPriorityStrategy.", "createdAt": "2020-02-21T22:10:39Z", "url": "https://github.com/apache/storm/pull/3213", "merged": true, "mergeCommit": {"oid": "973fda807a407b4fd764fcca14e30f5891ec30f2"}, "closed": true, "closedAt": "2020-04-16T13:57:11Z", "author": {"login": "RuiLi8080"}, "timelineItems": {"totalCount": 57, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGntglABqjMwNjIxNjI4MDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcX_Q6dAFqTM5NDE1OTQ5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f3ac62d6ce1e7ed81c2e1cfd93ce2b9d294fe5c0", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/f3ac62d6ce1e7ed81c2e1cfd93ce2b9d294fe5c0", "committedDate": "2020-02-21T22:06:29Z", "message": "[STORM-3588] add GenericResourceAwareSchedulingPriorityStrategy to accommodate generic resource in grading topologies"}, "afterCommit": {"oid": "d1062cc75301960393b8e43bb865b72630f4c2da", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/d1062cc75301960393b8e43bb865b72630f4c2da", "committedDate": "2020-02-21T22:45:23Z", "message": "[STORM-3588] add GenericResourceAwareSchedulingPriorityStrategy to accommodate generic resource in grading topologies"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d1062cc75301960393b8e43bb865b72630f4c2da", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/d1062cc75301960393b8e43bb865b72630f4c2da", "committedDate": "2020-02-21T22:45:23Z", "message": "[STORM-3588] add GenericResourceAwareSchedulingPriorityStrategy to accommodate generic resource in grading topologies"}, "afterCommit": {"oid": "0cbf4f6f866234dea4e2fd6388fb8237be60e73d", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/0cbf4f6f866234dea4e2fd6388fb8237be60e73d", "committedDate": "2020-02-23T21:57:17Z", "message": "[STORM-3588] add GenericResourceAwareSchedulingPriorityStrategy to accommodate generic resource in grading topologies"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0cbf4f6f866234dea4e2fd6388fb8237be60e73d", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/0cbf4f6f866234dea4e2fd6388fb8237be60e73d", "committedDate": "2020-02-23T21:57:17Z", "message": "[STORM-3588] add GenericResourceAwareSchedulingPriorityStrategy to accommodate generic resource in grading topologies"}, "afterCommit": {"oid": "ca91f28948a07259e81c944e76cb5b9e5e528101", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/ca91f28948a07259e81c944e76cb5b9e5e528101", "committedDate": "2020-02-23T21:59:06Z", "message": "[STORM-3588] add GenericResourceAwareSchedulingPriorityStrategy to accommodate generic resource in grading topologies"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ca91f28948a07259e81c944e76cb5b9e5e528101", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/ca91f28948a07259e81c944e76cb5b9e5e528101", "committedDate": "2020-02-23T21:59:06Z", "message": "[STORM-3588] add GenericResourceAwareSchedulingPriorityStrategy to accommodate generic resource in grading topologies"}, "afterCommit": {"oid": "5a332a53bfd816874dab12535047642b9b5e8a37", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/5a332a53bfd816874dab12535047642b9b5e8a37", "committedDate": "2020-02-23T23:31:29Z", "message": "[STORM-3588] add GenericResourceAwareSchedulingPriorityStrategy to accommodate generic resource in grading topologies"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5a332a53bfd816874dab12535047642b9b5e8a37", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/5a332a53bfd816874dab12535047642b9b5e8a37", "committedDate": "2020-02-23T23:31:29Z", "message": "[STORM-3588] add GenericResourceAwareSchedulingPriorityStrategy to accommodate generic resource in grading topologies"}, "afterCommit": {"oid": "d2b335b7dea6a6a73c7230a01ed5fede344b25df", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/d2b335b7dea6a6a73c7230a01ed5fede344b25df", "committedDate": "2020-02-23T23:44:10Z", "message": "[STORM-3588] add GenericResourceAwareSchedulingPriorityStrategy to accommodate generic resource in grading topologies"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d2b335b7dea6a6a73c7230a01ed5fede344b25df", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/d2b335b7dea6a6a73c7230a01ed5fede344b25df", "committedDate": "2020-02-23T23:44:10Z", "message": "[STORM-3588] add GenericResourceAwareSchedulingPriorityStrategy to accommodate generic resource in grading topologies"}, "afterCommit": {"oid": "12949406913962d54badc9052df2c26c60cbcd51", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/12949406913962d54badc9052df2c26c60cbcd51", "committedDate": "2020-02-23T23:51:45Z", "message": "[STORM-3588] add GenericResourceAwareSchedulingPriorityStrategy to accommodate generic resource in grading topologies"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "12949406913962d54badc9052df2c26c60cbcd51", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/12949406913962d54badc9052df2c26c60cbcd51", "committedDate": "2020-02-23T23:51:45Z", "message": "[STORM-3588] add GenericResourceAwareSchedulingPriorityStrategy to accommodate generic resource in grading topologies"}, "afterCommit": {"oid": "80f789640625afbd665d7739e78849409cc34cc6", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/80f789640625afbd665d7739e78849409cc34cc6", "committedDate": "2020-02-24T14:53:18Z", "message": "[STORM-3588] add GenericResourceAwareSchedulingPriorityStrategy to accommodate generic resource in grading topologies"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "80f789640625afbd665d7739e78849409cc34cc6", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/80f789640625afbd665d7739e78849409cc34cc6", "committedDate": "2020-02-24T14:53:18Z", "message": "[STORM-3588] add GenericResourceAwareSchedulingPriorityStrategy to accommodate generic resource in grading topologies"}, "afterCommit": {"oid": "4888e53718310453c4c0d4b2d4468f5447723137", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/4888e53718310453c4c0d4b2d4468f5447723137", "committedDate": "2020-02-25T17:18:06Z", "message": "[STORM-3588] add GenericResourceAwareSchedulingPriorityStrategy to accommodate generic resource in grading topologies"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4888e53718310453c4c0d4b2d4468f5447723137", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/4888e53718310453c4c0d4b2d4468f5447723137", "committedDate": "2020-02-25T17:18:06Z", "message": "[STORM-3588] add GenericResourceAwareSchedulingPriorityStrategy to accommodate generic resource in grading topologies"}, "afterCommit": {"oid": "851a4348b38a96945a8578929ab421cbdfa9bcbb", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/851a4348b38a96945a8578929ab421cbdfa9bcbb", "committedDate": "2020-02-25T17:19:56Z", "message": "[STORM-3588] add GenericResourceAwareSchedulingPriorityStrategy to accommodate generic resource in grading topologies"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "851a4348b38a96945a8578929ab421cbdfa9bcbb", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/851a4348b38a96945a8578929ab421cbdfa9bcbb", "committedDate": "2020-02-25T17:19:56Z", "message": "[STORM-3588] add GenericResourceAwareSchedulingPriorityStrategy to accommodate generic resource in grading topologies"}, "afterCommit": {"oid": "7e2e81c9339557f2e6fdbf879a3f54dad4177bca", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/7e2e81c9339557f2e6fdbf879a3f54dad4177bca", "committedDate": "2020-02-25T19:03:17Z", "message": "[STORM-3588] add GenericResourceAwareSchedulingPriorityStrategy to accommodate generic resource in grading topologies"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7e2e81c9339557f2e6fdbf879a3f54dad4177bca", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/7e2e81c9339557f2e6fdbf879a3f54dad4177bca", "committedDate": "2020-02-25T19:03:17Z", "message": "[STORM-3588] add GenericResourceAwareSchedulingPriorityStrategy to accommodate generic resource in grading topologies"}, "afterCommit": {"oid": "fc06aab3f015f62f0c39d5b6650bbcdf860e9154", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/fc06aab3f015f62f0c39d5b6650bbcdf860e9154", "committedDate": "2020-02-25T19:34:17Z", "message": "[STORM-3588] add GenericResourceAwareSchedulingPriorityStrategy to accommodate generic resource in grading topologies"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fc06aab3f015f62f0c39d5b6650bbcdf860e9154", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/fc06aab3f015f62f0c39d5b6650bbcdf860e9154", "committedDate": "2020-02-25T19:34:17Z", "message": "[STORM-3588] add GenericResourceAwareSchedulingPriorityStrategy to accommodate generic resource in grading topologies"}, "afterCommit": {"oid": "d8377f1df91d2f6a80ca235b10554a3644a140ab", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/d8377f1df91d2f6a80ca235b10554a3644a140ab", "committedDate": "2020-02-25T20:03:51Z", "message": "[STORM-3588] add GenericResourceAwareSchedulingPriorityStrategy to accommodate generic resource in grading topologies"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "008f2e6d54cdd0501723de82a3281b031e2846de", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/008f2e6d54cdd0501723de82a3281b031e2846de", "committedDate": "2020-02-25T20:13:48Z", "message": "[STORM-3588] add GenericResourceAwareSchedulingPriorityStrategy to accommodate generic resource in grading topologies"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d8377f1df91d2f6a80ca235b10554a3644a140ab", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/d8377f1df91d2f6a80ca235b10554a3644a140ab", "committedDate": "2020-02-25T20:03:51Z", "message": "[STORM-3588] add GenericResourceAwareSchedulingPriorityStrategy to accommodate generic resource in grading topologies"}, "afterCommit": {"oid": "008f2e6d54cdd0501723de82a3281b031e2846de", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/008f2e6d54cdd0501723de82a3281b031e2846de", "committedDate": "2020-02-25T20:13:48Z", "message": "[STORM-3588] add GenericResourceAwareSchedulingPriorityStrategy to accommodate generic resource in grading topologies"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MTc3ODcy", "url": "https://github.com/apache/storm/pull/3213#pullrequestreview-365177872", "createdAt": "2020-02-26T19:27:11Z", "commit": {"oid": "008f2e6d54cdd0501723de82a3281b031e2846de"}, "state": "COMMENTED", "comments": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxOToyNzoxMVrOFu4_WA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMjoyMjowMFrOFu-ifQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDcxMjUzNg==", "bodyText": "better to add VisibleForTesting and comments to make it clear that this is only used by unit test", "url": "https://github.com/apache/storm/pull/3213#discussion_r384712536", "createdAt": "2020-02-26T19:27:11Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/resource/ResourceAwareScheduler.java", "diffHunk": "@@ -239,6 +246,10 @@ private void scheduleTopology(TopologyDetails td, Cluster cluster, final User to\n         markFailedTopology(topologySubmitter, cluster, td, \"Failed to schedule within \" + maxSchedulingAttempts + \" attempts\");\n     }\n \n+    public Set<String> getEvictedTopologies() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "008f2e6d54cdd0501723de82a3281b031e2846de"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc3Njc5NA==", "bodyText": "We could pass Set<String> evictedTopologies instead of a scheduler since that's the only thing we really need from the scheduler", "url": "https://github.com/apache/storm/pull/3213#discussion_r384776794", "createdAt": "2020-02-26T21:28:11Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/test/java/org/apache/storm/scheduler/resource/TestUtilsForResourceAwareScheduler.java", "diffHunk": "@@ -451,6 +460,32 @@ public static void assertTopologiesFullyScheduled(Cluster cluster, String... top\n         }\n     }\n \n+    public static void assertTopologiesBeenEvicted(Cluster cluster, ResourceAwareScheduler scheduler, String... topoNames) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "008f2e6d54cdd0501723de82a3281b031e2846de"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc4MDU5OQ==", "bodyText": "This should be TestGenericResourceAwareSchedulingPriorityStrategy", "url": "https://github.com/apache/storm/pull/3213#discussion_r384780599", "createdAt": "2020-02-26T21:35:37Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/test/java/org/apache/storm/scheduler/resource/strategies/priority/TestGenericResourceAwareSchedulingPriorityStrategy.java", "diffHunk": "@@ -0,0 +1,216 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.storm.scheduler.resource.strategies.priority;\n+\n+import org.apache.storm.Config;\n+import org.apache.storm.DaemonConfig;\n+import org.apache.storm.metric.StormMetricsRegistry;\n+import org.apache.storm.scheduler.Cluster;\n+import org.apache.storm.scheduler.INimbus;\n+import org.apache.storm.scheduler.IScheduler;\n+import org.apache.storm.scheduler.SupervisorDetails;\n+import org.apache.storm.scheduler.Topologies;\n+import org.apache.storm.scheduler.resource.ResourceAwareScheduler;\n+import org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler;\n+import org.apache.storm.scheduler.resource.normalization.ResourceMetrics;\n+import org.apache.storm.scheduler.resource.strategies.eviction.TestDefaultEvictionStrategy;\n+import org.apache.storm.utils.Time;\n+import org.junit.After;\n+import org.junit.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.addTopologies;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.assertTopologiesBeenEvicted;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.assertTopologiesFullyScheduled;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.assertTopologiesNotBeenEvicted;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.assertTopologiesNotScheduled;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.createGrasClusterConfig;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.genSupervisors;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.genTopology;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.userRes;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.userResourcePool;\n+\n+public class TestGenericResourceAwareSchedulingPriorityStrategy {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(TestDefaultEvictionStrategy.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "008f2e6d54cdd0501723de82a3281b031e2846de"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc4MDk5OQ==", "bodyText": "heave -> heavy", "url": "https://github.com/apache/storm/pull/3213#discussion_r384780999", "createdAt": "2020-02-26T21:36:18Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/test/java/org/apache/storm/scheduler/resource/strategies/priority/TestGenericResourceAwareSchedulingPriorityStrategy.java", "diffHunk": "@@ -0,0 +1,216 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.storm.scheduler.resource.strategies.priority;\n+\n+import org.apache.storm.Config;\n+import org.apache.storm.DaemonConfig;\n+import org.apache.storm.metric.StormMetricsRegistry;\n+import org.apache.storm.scheduler.Cluster;\n+import org.apache.storm.scheduler.INimbus;\n+import org.apache.storm.scheduler.IScheduler;\n+import org.apache.storm.scheduler.SupervisorDetails;\n+import org.apache.storm.scheduler.Topologies;\n+import org.apache.storm.scheduler.resource.ResourceAwareScheduler;\n+import org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler;\n+import org.apache.storm.scheduler.resource.normalization.ResourceMetrics;\n+import org.apache.storm.scheduler.resource.strategies.eviction.TestDefaultEvictionStrategy;\n+import org.apache.storm.utils.Time;\n+import org.junit.After;\n+import org.junit.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.addTopologies;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.assertTopologiesBeenEvicted;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.assertTopologiesFullyScheduled;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.assertTopologiesNotBeenEvicted;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.assertTopologiesNotScheduled;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.createGrasClusterConfig;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.genSupervisors;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.genTopology;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.userRes;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.userResourcePool;\n+\n+public class TestGenericResourceAwareSchedulingPriorityStrategy {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(TestDefaultEvictionStrategy.class);\n+    private static int currentTime = Time.currentTimeSecs();\n+    private static IScheduler scheduler = null;\n+\n+    @After\n+    public void cleanup() {\n+        if (scheduler != null) {\n+            scheduler.cleanup();\n+            scheduler = null;\n+        }\n+    }\n+\n+    /*\n+     * DefaultSchedulingPriorityStrategy will not evict topo as long as the resources request can be met\n+     *\n+     *  Ethan asks for heavy cpu and memory while Rui asks for little cpu and memory but heave generic resource", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "008f2e6d54cdd0501723de82a3281b031e2846de"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc4MTE1Mw==", "bodyText": "happend -> 'happen`", "url": "https://github.com/apache/storm/pull/3213#discussion_r384781153", "createdAt": "2020-02-26T21:36:36Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/test/java/org/apache/storm/scheduler/resource/strategies/priority/TestGenericResourceAwareSchedulingPriorityStrategy.java", "diffHunk": "@@ -0,0 +1,216 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.storm.scheduler.resource.strategies.priority;\n+\n+import org.apache.storm.Config;\n+import org.apache.storm.DaemonConfig;\n+import org.apache.storm.metric.StormMetricsRegistry;\n+import org.apache.storm.scheduler.Cluster;\n+import org.apache.storm.scheduler.INimbus;\n+import org.apache.storm.scheduler.IScheduler;\n+import org.apache.storm.scheduler.SupervisorDetails;\n+import org.apache.storm.scheduler.Topologies;\n+import org.apache.storm.scheduler.resource.ResourceAwareScheduler;\n+import org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler;\n+import org.apache.storm.scheduler.resource.normalization.ResourceMetrics;\n+import org.apache.storm.scheduler.resource.strategies.eviction.TestDefaultEvictionStrategy;\n+import org.apache.storm.utils.Time;\n+import org.junit.After;\n+import org.junit.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.addTopologies;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.assertTopologiesBeenEvicted;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.assertTopologiesFullyScheduled;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.assertTopologiesNotBeenEvicted;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.assertTopologiesNotScheduled;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.createGrasClusterConfig;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.genSupervisors;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.genTopology;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.userRes;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.userResourcePool;\n+\n+public class TestGenericResourceAwareSchedulingPriorityStrategy {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(TestDefaultEvictionStrategy.class);\n+    private static int currentTime = Time.currentTimeSecs();\n+    private static IScheduler scheduler = null;\n+\n+    @After\n+    public void cleanup() {\n+        if (scheduler != null) {\n+            scheduler.cleanup();\n+            scheduler = null;\n+        }\n+    }\n+\n+    /*\n+     * DefaultSchedulingPriorityStrategy will not evict topo as long as the resources request can be met\n+     *\n+     *  Ethan asks for heavy cpu and memory while Rui asks for little cpu and memory but heave generic resource\n+     *  Since Rui's all types of resources request can be met, no eviction will happend", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "008f2e6d54cdd0501723de82a3281b031e2846de"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc4NDEwNg==", "bodyText": "heave -> heavy", "url": "https://github.com/apache/storm/pull/3213#discussion_r384784106", "createdAt": "2020-02-26T21:42:44Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/test/java/org/apache/storm/scheduler/resource/strategies/priority/TestGenericResourceAwareSchedulingPriorityStrategy.java", "diffHunk": "@@ -0,0 +1,216 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.storm.scheduler.resource.strategies.priority;\n+\n+import org.apache.storm.Config;\n+import org.apache.storm.DaemonConfig;\n+import org.apache.storm.metric.StormMetricsRegistry;\n+import org.apache.storm.scheduler.Cluster;\n+import org.apache.storm.scheduler.INimbus;\n+import org.apache.storm.scheduler.IScheduler;\n+import org.apache.storm.scheduler.SupervisorDetails;\n+import org.apache.storm.scheduler.Topologies;\n+import org.apache.storm.scheduler.resource.ResourceAwareScheduler;\n+import org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler;\n+import org.apache.storm.scheduler.resource.normalization.ResourceMetrics;\n+import org.apache.storm.scheduler.resource.strategies.eviction.TestDefaultEvictionStrategy;\n+import org.apache.storm.utils.Time;\n+import org.junit.After;\n+import org.junit.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.addTopologies;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.assertTopologiesBeenEvicted;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.assertTopologiesFullyScheduled;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.assertTopologiesNotBeenEvicted;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.assertTopologiesNotScheduled;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.createGrasClusterConfig;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.genSupervisors;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.genTopology;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.userRes;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.userResourcePool;\n+\n+public class TestGenericResourceAwareSchedulingPriorityStrategy {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(TestDefaultEvictionStrategy.class);\n+    private static int currentTime = Time.currentTimeSecs();\n+    private static IScheduler scheduler = null;\n+\n+    @After\n+    public void cleanup() {\n+        if (scheduler != null) {\n+            scheduler.cleanup();\n+            scheduler = null;\n+        }\n+    }\n+\n+    /*\n+     * DefaultSchedulingPriorityStrategy will not evict topo as long as the resources request can be met\n+     *\n+     *  Ethan asks for heavy cpu and memory while Rui asks for little cpu and memory but heave generic resource\n+     *  Since Rui's all types of resources request can be met, no eviction will happend\n+    */\n+    @Test\n+    public void testDefaultSchedulingPriorityStrategyNotEvicting() {\n+        Map<String, Double> requestedgenericResourcesMap = new HashMap<>();\n+        requestedgenericResourcesMap.put(\"generic.resource.1\", 40.0);\n+        // Use full memory and cpu of the cluster capacity\n+        Config ruiConf = createGrasClusterConfig(20, 50, 50, null, requestedgenericResourcesMap);\n+        Config ethanConf = createGrasClusterConfig(80, 400, 500, null, Collections.emptyMap());\n+        Topologies topologies = new Topologies(\n+            genTopology(\"ethan-topo-1\", ethanConf, 1, 0, 1, 0, currentTime - 2, 10, \"ethan\"),\n+            genTopology(\"ethan-topo-2\", ethanConf, 1, 0, 1, 0, currentTime - 2, 20, \"ethan\"),\n+            genTopology(\"ethan-topo-3\", ethanConf, 1, 0, 1, 0, currentTime - 2, 28, \"ethan\"),\n+            genTopology(\"ethan-topo-4\", ethanConf, 1, 0, 1, 0, currentTime - 2, 29, \"ethan\"));\n+\n+        Topologies withNewTopo = addTopologies(topologies,\n+            genTopology(\"rui-topo-1\", ruiConf, 1, 0, 4, 0, currentTime - 2, 10, \"rui\"));\n+\n+        Config config = mkClusterConfig(DefaultSchedulingPriorityStrategy.class.getName());\n+        Cluster cluster = mkTestCluster(topologies, config);\n+        scheduler = new ResourceAwareScheduler();\n+        scheduler.prepare(config);\n+        scheduler.schedule(topologies, cluster);\n+\n+        assertTopologiesFullyScheduled(cluster, \"ethan-topo-1\", \"ethan-topo-2\", \"ethan-topo-3\", \"ethan-topo-4\");\n+\n+\n+        cluster = new Cluster(cluster, withNewTopo);\n+        scheduler.schedule(withNewTopo, cluster);\n+\n+        assertTopologiesFullyScheduled(cluster, \"ethan-topo-1\", \"ethan-topo-2\", \"ethan-topo-3\", \"ethan-topo-4\");\n+        assertTopologiesNotBeenEvicted(cluster, (ResourceAwareScheduler) scheduler, \"ethan-topo-1\", \"ethan-topo-2\", \"ethan-topo-3\", \"ethan-topo-4\");\n+        assertTopologiesFullyScheduled(cluster, \"rui-topo-1\");\n+    }\n+\n+    /*\n+     * DefaultSchedulingPriorityStrategy does not take generic resources into account when calculating score\n+     * So even if a user is requesting a lot of generic resources other than CPU and memory, scheduler will still score it very low and kick out other topologies\n+     *\n+     *  Ethan asks for medium cpu and memory while Rui asks for little cpu and memory but heave generic resource", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "008f2e6d54cdd0501723de82a3281b031e2846de"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc4NTY3Mw==", "bodyText": "For as the above test , maybe it's better to refer to the test case directly. If anyone moves the order of these unit tests, this comment can be confusing", "url": "https://github.com/apache/storm/pull/3213#discussion_r384785673", "createdAt": "2020-02-26T21:45:42Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/test/java/org/apache/storm/scheduler/resource/strategies/priority/TestGenericResourceAwareSchedulingPriorityStrategy.java", "diffHunk": "@@ -0,0 +1,216 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.storm.scheduler.resource.strategies.priority;\n+\n+import org.apache.storm.Config;\n+import org.apache.storm.DaemonConfig;\n+import org.apache.storm.metric.StormMetricsRegistry;\n+import org.apache.storm.scheduler.Cluster;\n+import org.apache.storm.scheduler.INimbus;\n+import org.apache.storm.scheduler.IScheduler;\n+import org.apache.storm.scheduler.SupervisorDetails;\n+import org.apache.storm.scheduler.Topologies;\n+import org.apache.storm.scheduler.resource.ResourceAwareScheduler;\n+import org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler;\n+import org.apache.storm.scheduler.resource.normalization.ResourceMetrics;\n+import org.apache.storm.scheduler.resource.strategies.eviction.TestDefaultEvictionStrategy;\n+import org.apache.storm.utils.Time;\n+import org.junit.After;\n+import org.junit.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.addTopologies;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.assertTopologiesBeenEvicted;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.assertTopologiesFullyScheduled;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.assertTopologiesNotBeenEvicted;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.assertTopologiesNotScheduled;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.createGrasClusterConfig;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.genSupervisors;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.genTopology;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.userRes;\n+import static org.apache.storm.scheduler.resource.TestUtilsForResourceAwareScheduler.userResourcePool;\n+\n+public class TestGenericResourceAwareSchedulingPriorityStrategy {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(TestDefaultEvictionStrategy.class);\n+    private static int currentTime = Time.currentTimeSecs();\n+    private static IScheduler scheduler = null;\n+\n+    @After\n+    public void cleanup() {\n+        if (scheduler != null) {\n+            scheduler.cleanup();\n+            scheduler = null;\n+        }\n+    }\n+\n+    /*\n+     * DefaultSchedulingPriorityStrategy will not evict topo as long as the resources request can be met\n+     *\n+     *  Ethan asks for heavy cpu and memory while Rui asks for little cpu and memory but heave generic resource\n+     *  Since Rui's all types of resources request can be met, no eviction will happend\n+    */\n+    @Test\n+    public void testDefaultSchedulingPriorityStrategyNotEvicting() {\n+        Map<String, Double> requestedgenericResourcesMap = new HashMap<>();\n+        requestedgenericResourcesMap.put(\"generic.resource.1\", 40.0);\n+        // Use full memory and cpu of the cluster capacity\n+        Config ruiConf = createGrasClusterConfig(20, 50, 50, null, requestedgenericResourcesMap);\n+        Config ethanConf = createGrasClusterConfig(80, 400, 500, null, Collections.emptyMap());\n+        Topologies topologies = new Topologies(\n+            genTopology(\"ethan-topo-1\", ethanConf, 1, 0, 1, 0, currentTime - 2, 10, \"ethan\"),\n+            genTopology(\"ethan-topo-2\", ethanConf, 1, 0, 1, 0, currentTime - 2, 20, \"ethan\"),\n+            genTopology(\"ethan-topo-3\", ethanConf, 1, 0, 1, 0, currentTime - 2, 28, \"ethan\"),\n+            genTopology(\"ethan-topo-4\", ethanConf, 1, 0, 1, 0, currentTime - 2, 29, \"ethan\"));\n+\n+        Topologies withNewTopo = addTopologies(topologies,\n+            genTopology(\"rui-topo-1\", ruiConf, 1, 0, 4, 0, currentTime - 2, 10, \"rui\"));\n+\n+        Config config = mkClusterConfig(DefaultSchedulingPriorityStrategy.class.getName());\n+        Cluster cluster = mkTestCluster(topologies, config);\n+        scheduler = new ResourceAwareScheduler();\n+        scheduler.prepare(config);\n+        scheduler.schedule(topologies, cluster);\n+\n+        assertTopologiesFullyScheduled(cluster, \"ethan-topo-1\", \"ethan-topo-2\", \"ethan-topo-3\", \"ethan-topo-4\");\n+\n+\n+        cluster = new Cluster(cluster, withNewTopo);\n+        scheduler.schedule(withNewTopo, cluster);\n+\n+        assertTopologiesFullyScheduled(cluster, \"ethan-topo-1\", \"ethan-topo-2\", \"ethan-topo-3\", \"ethan-topo-4\");\n+        assertTopologiesNotBeenEvicted(cluster, (ResourceAwareScheduler) scheduler, \"ethan-topo-1\", \"ethan-topo-2\", \"ethan-topo-3\", \"ethan-topo-4\");\n+        assertTopologiesFullyScheduled(cluster, \"rui-topo-1\");\n+    }\n+\n+    /*\n+     * DefaultSchedulingPriorityStrategy does not take generic resources into account when calculating score\n+     * So even if a user is requesting a lot of generic resources other than CPU and memory, scheduler will still score it very low and kick out other topologies\n+     *\n+     *  Ethan asks for medium cpu and memory while Rui asks for little cpu and memory but heave generic resource\n+     *  However, Rui's generic request can not be met and default scoring system is not taking generic resources into account,\n+     *  so the score of Rui's new topo will be much lower than all Ethan's topos'.\n+     *  Then all Ethan's topo will be evicted in trying to make rooms for Rui.\n+     */\n+    @Test\n+    public void testDefaultSchedulingPriorityStrategyEvicting() {\n+        Map<String, Double> requestedgenericResourcesMap = new HashMap<>();\n+        requestedgenericResourcesMap.put(\"generic.resource.1\", 40.0);\n+        Config ruiConf = createGrasClusterConfig(10, 10, 10, null, requestedgenericResourcesMap);\n+        Config ethanConf = createGrasClusterConfig(60, 200, 300, null, Collections.emptyMap());\n+        Topologies topologies = new Topologies(\n+            genTopology(\"ethan-topo-1\", ethanConf, 1, 0, 1, 0, currentTime - 2, 10, \"ethan\"),\n+            genTopology(\"ethan-topo-2\", ethanConf, 1, 0, 1, 0, currentTime - 2, 20, \"ethan\"),\n+            genTopology(\"ethan-topo-3\", ethanConf, 1, 0, 1, 0, currentTime - 2, 28, \"ethan\"),\n+            genTopology(\"ethan-topo-4\", ethanConf, 1, 0, 1, 0, currentTime - 2, 29, \"ethan\"));\n+\n+        Topologies withNewTopo = addTopologies(topologies,\n+            genTopology(\"rui-topo-1\", ruiConf, 1, 0, 5, 0, currentTime - 2, 10, \"rui\"));\n+\n+        Config config = mkClusterConfig(DefaultSchedulingPriorityStrategy.class.getName());\n+        Cluster cluster = mkTestCluster(topologies, config);\n+        scheduler = new ResourceAwareScheduler();\n+        scheduler.prepare(config);\n+        scheduler.schedule(topologies, cluster);\n+\n+        assertTopologiesFullyScheduled(cluster, \"ethan-topo-1\", \"ethan-topo-2\", \"ethan-topo-3\", \"ethan-topo-4\");\n+\n+\n+        cluster = new Cluster(cluster, withNewTopo);\n+        scheduler.schedule(withNewTopo, cluster);\n+\n+        assertTopologiesFullyScheduled(cluster, \"ethan-topo-1\", \"ethan-topo-2\", \"ethan-topo-3\", \"ethan-topo-4\");\n+        assertTopologiesBeenEvicted(cluster, (ResourceAwareScheduler) scheduler, \"ethan-topo-1\", \"ethan-topo-2\", \"ethan-topo-3\", \"ethan-topo-4\");\n+        assertTopologiesNotScheduled(cluster, \"rui-topo-1\");\n+    }\n+\n+    /*\n+     * GenericResourceAwareSchedulingPriorityStrategy extend scoring formula to accommodate generic resources\n+     *\n+     *   Same setting as the above test, but this time, new scoring system is taking generic resources into account,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "008f2e6d54cdd0501723de82a3281b031e2846de"}, "originalPosition": 151}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc5MTczNA==", "bodyText": "nit: too many new lines", "url": "https://github.com/apache/storm/pull/3213#discussion_r384791734", "createdAt": "2020-02-26T21:57:16Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/resource/strategies/priority/GenericResourceAwareSchedulingPriorityStrategy.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.storm.scheduler.resource.strategies.priority;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.Comparator;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.storm.scheduler.ISchedulingState;\n+import org.apache.storm.scheduler.TopologyDetails;\n+import org.apache.storm.scheduler.resource.User;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class GenericResourceAwareSchedulingPriorityStrategy extends DefaultSchedulingPriorityStrategy {\n+    private static final Logger LOG = LoggerFactory.getLogger(DefaultSchedulingPriorityStrategy.class);\n+\n+    @Override\n+    protected GrasSimulatedUser getSimulatedUserFor(User u, ISchedulingState cluster) {\n+        return new GrasSimulatedUser(u, cluster);\n+    }\n+\n+    @Override\n+    public List<TopologyDetails> getOrderedTopologies(ISchedulingState cluster, Map<String, User> userMap) {\n+        double cpuAvail = cluster.getClusterTotalCpuResource();\n+        double memAvail = cluster.getClusterTotalMemoryResource();\n+        Map<String, Double> genericAvail = cluster.getClusterTotalGenericResource();\n+\n+        List<TopologyDetails> allUserTopologies = new ArrayList<>();\n+        List<GrasSimulatedUser> users = new ArrayList<>();\n+\n+        for (User u : userMap.values()) {\n+            users.add(getSimulatedUserFor(u, cluster));\n+        }\n+\n+        while (!users.isEmpty()) {\n+            Collections.sort(users, new GrasSimulatedUserComparator(cpuAvail, memAvail, genericAvail));\n+            GrasSimulatedUser u = users.get(0);\n+            TopologyDetails td = u.getNextHighest();\n+            if (td == null) {\n+                users.remove(0);\n+            } else {\n+                double score = u.getScore(cpuAvail, memAvail, genericAvail);\n+                td = u.simScheduleNextHighest();\n+                LOG.info(\"GRAS SIM Scheduling {} with score of {}\", td.getId(), score);\n+                cpuAvail -= td.getTotalRequestedCpu();\n+                memAvail -= (td.getTotalRequestedMemOffHeap() + td.getTotalRequestedMemOnHeap());\n+                for (Map.Entry<String, Double> entry : td.getTotalRequestedGenericResources().entrySet()) {\n+                    String resource = entry.getKey();\n+                    Double requestedAmount = entry.getValue();\n+                    if (!genericAvail.containsKey(resource)) {\n+                        LOG.warn(\"Resource: {} is not supported in this cluster. Ignoring this request.\", resource);\n+                    } else {\n+                        genericAvail.put(resource, genericAvail.get(resource) - requestedAmount);\n+                    }\n+                }\n+                allUserTopologies.add(td);\n+            }\n+        }\n+        return allUserTopologies;\n+    }\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "008f2e6d54cdd0501723de82a3281b031e2846de"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc5MjMzOA==", "bodyText": "should be GenericResourceAwareSchedulingPriorityStrategy", "url": "https://github.com/apache/storm/pull/3213#discussion_r384792338", "createdAt": "2020-02-26T21:58:24Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/resource/strategies/priority/GenericResourceAwareSchedulingPriorityStrategy.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.storm.scheduler.resource.strategies.priority;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.Comparator;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.storm.scheduler.ISchedulingState;\n+import org.apache.storm.scheduler.TopologyDetails;\n+import org.apache.storm.scheduler.resource.User;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class GenericResourceAwareSchedulingPriorityStrategy extends DefaultSchedulingPriorityStrategy {\n+    private static final Logger LOG = LoggerFactory.getLogger(DefaultSchedulingPriorityStrategy.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "008f2e6d54cdd0501723de82a3281b031e2846de"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc5MzM4Mg==", "bodyText": "This can be private since it's not used elsewhere ?", "url": "https://github.com/apache/storm/pull/3213#discussion_r384793382", "createdAt": "2020-02-26T22:00:30Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/resource/strategies/priority/DefaultSchedulingPriorityStrategy.java", "diffHunk": "@@ -140,7 +140,7 @@ public int compare(SimulatedUser o1, SimulatedUser o2) {\n      * Comparator that sorts topologies by priority and then by submission time.\n      * First sort by Topology Priority, if there is a tie for topology priority, topology uptime is used to sort.\n      */\n-    private static class TopologyByPriorityAndSubmissionTimeComparator implements Comparator<TopologyDetails> {\n+    protected static class TopologyByPriorityAndSubmissionTimeComparator implements Comparator<TopologyDetails> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "008f2e6d54cdd0501723de82a3281b031e2846de"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc5NzM2Nw==", "bodyText": "We could reply on super.simScheduleNextHighest(); so everything in GrasSimulatedUser is gras specific, like what you did elsewhere", "url": "https://github.com/apache/storm/pull/3213#discussion_r384797367", "createdAt": "2020-02-26T22:09:00Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/resource/strategies/priority/GenericResourceAwareSchedulingPriorityStrategy.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.storm.scheduler.resource.strategies.priority;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.Comparator;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.storm.scheduler.ISchedulingState;\n+import org.apache.storm.scheduler.TopologyDetails;\n+import org.apache.storm.scheduler.resource.User;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class GenericResourceAwareSchedulingPriorityStrategy extends DefaultSchedulingPriorityStrategy {\n+    private static final Logger LOG = LoggerFactory.getLogger(DefaultSchedulingPriorityStrategy.class);\n+\n+    @Override\n+    protected GrasSimulatedUser getSimulatedUserFor(User u, ISchedulingState cluster) {\n+        return new GrasSimulatedUser(u, cluster);\n+    }\n+\n+    @Override\n+    public List<TopologyDetails> getOrderedTopologies(ISchedulingState cluster, Map<String, User> userMap) {\n+        double cpuAvail = cluster.getClusterTotalCpuResource();\n+        double memAvail = cluster.getClusterTotalMemoryResource();\n+        Map<String, Double> genericAvail = cluster.getClusterTotalGenericResource();\n+\n+        List<TopologyDetails> allUserTopologies = new ArrayList<>();\n+        List<GrasSimulatedUser> users = new ArrayList<>();\n+\n+        for (User u : userMap.values()) {\n+            users.add(getSimulatedUserFor(u, cluster));\n+        }\n+\n+        while (!users.isEmpty()) {\n+            Collections.sort(users, new GrasSimulatedUserComparator(cpuAvail, memAvail, genericAvail));\n+            GrasSimulatedUser u = users.get(0);\n+            TopologyDetails td = u.getNextHighest();\n+            if (td == null) {\n+                users.remove(0);\n+            } else {\n+                double score = u.getScore(cpuAvail, memAvail, genericAvail);\n+                td = u.simScheduleNextHighest();\n+                LOG.info(\"GRAS SIM Scheduling {} with score of {}\", td.getId(), score);\n+                cpuAvail -= td.getTotalRequestedCpu();\n+                memAvail -= (td.getTotalRequestedMemOffHeap() + td.getTotalRequestedMemOnHeap());\n+                for (Map.Entry<String, Double> entry : td.getTotalRequestedGenericResources().entrySet()) {\n+                    String resource = entry.getKey();\n+                    Double requestedAmount = entry.getValue();\n+                    if (!genericAvail.containsKey(resource)) {\n+                        LOG.warn(\"Resource: {} is not supported in this cluster. Ignoring this request.\", resource);\n+                    } else {\n+                        genericAvail.put(resource, genericAvail.get(resource) - requestedAmount);\n+                    }\n+                }\n+                allUserTopologies.add(td);\n+            }\n+        }\n+        return allUserTopologies;\n+    }\n+\n+\n+\n+    protected static class GrasSimulatedUser extends SimulatedUser {\n+\n+        // Extend support for Generic Resources in addition to CPU and Memory\n+        public final Map<String, Double> guaranteedGenericResources;                // resource name : guaranteed amount\n+        private Map<String, Double> assignedGenericResources = new HashMap<>();     // resource name : assigned amount\n+\n+        public GrasSimulatedUser(User other, ISchedulingState cluster) {\n+            super(other, cluster);\n+\n+            Map<String, Double> guaranteedGenericResources = new HashMap<>();\n+            Map<String, Double> availGenericResources = cluster.getClusterTotalGenericResource();   // generic resources that are offered\n+            for (Map.Entry<String, Double> entry : availGenericResources.entrySet()) {\n+                String resource = entry.getKey();\n+                Double guaranteedAmount = other.getGenericGuaranteed().getOrDefault(resource, 0.0);\n+                guaranteedGenericResources.put(resource, guaranteedAmount);\n+            }\n+            this.guaranteedGenericResources = guaranteedGenericResources;\n+        }\n+\n+        @Override\n+        public TopologyDetails simScheduleNextHighest() {\n+            TopologyDetails td = tds.pop();\n+            assignedCpu += td.getTotalRequestedCpu();\n+            assignedMemory += td.getTotalRequestedMemOffHeap() + td.getTotalRequestedMemOnHeap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "008f2e6d54cdd0501723de82a3281b031e2846de"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwMDQ2MA==", "bodyText": "Nice javadoc!\nnit: Available -> clusterAvailable", "url": "https://github.com/apache/storm/pull/3213#discussion_r384800460", "createdAt": "2020-02-26T22:15:31Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/resource/strategies/priority/GenericResourceAwareSchedulingPriorityStrategy.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.storm.scheduler.resource.strategies.priority;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.Comparator;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.storm.scheduler.ISchedulingState;\n+import org.apache.storm.scheduler.TopologyDetails;\n+import org.apache.storm.scheduler.resource.User;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class GenericResourceAwareSchedulingPriorityStrategy extends DefaultSchedulingPriorityStrategy {\n+    private static final Logger LOG = LoggerFactory.getLogger(DefaultSchedulingPriorityStrategy.class);\n+\n+    @Override\n+    protected GrasSimulatedUser getSimulatedUserFor(User u, ISchedulingState cluster) {\n+        return new GrasSimulatedUser(u, cluster);\n+    }\n+\n+    @Override\n+    public List<TopologyDetails> getOrderedTopologies(ISchedulingState cluster, Map<String, User> userMap) {\n+        double cpuAvail = cluster.getClusterTotalCpuResource();\n+        double memAvail = cluster.getClusterTotalMemoryResource();\n+        Map<String, Double> genericAvail = cluster.getClusterTotalGenericResource();\n+\n+        List<TopologyDetails> allUserTopologies = new ArrayList<>();\n+        List<GrasSimulatedUser> users = new ArrayList<>();\n+\n+        for (User u : userMap.values()) {\n+            users.add(getSimulatedUserFor(u, cluster));\n+        }\n+\n+        while (!users.isEmpty()) {\n+            Collections.sort(users, new GrasSimulatedUserComparator(cpuAvail, memAvail, genericAvail));\n+            GrasSimulatedUser u = users.get(0);\n+            TopologyDetails td = u.getNextHighest();\n+            if (td == null) {\n+                users.remove(0);\n+            } else {\n+                double score = u.getScore(cpuAvail, memAvail, genericAvail);\n+                td = u.simScheduleNextHighest();\n+                LOG.info(\"GRAS SIM Scheduling {} with score of {}\", td.getId(), score);\n+                cpuAvail -= td.getTotalRequestedCpu();\n+                memAvail -= (td.getTotalRequestedMemOffHeap() + td.getTotalRequestedMemOnHeap());\n+                for (Map.Entry<String, Double> entry : td.getTotalRequestedGenericResources().entrySet()) {\n+                    String resource = entry.getKey();\n+                    Double requestedAmount = entry.getValue();\n+                    if (!genericAvail.containsKey(resource)) {\n+                        LOG.warn(\"Resource: {} is not supported in this cluster. Ignoring this request.\", resource);\n+                    } else {\n+                        genericAvail.put(resource, genericAvail.get(resource) - requestedAmount);\n+                    }\n+                }\n+                allUserTopologies.add(td);\n+            }\n+        }\n+        return allUserTopologies;\n+    }\n+\n+\n+\n+    protected static class GrasSimulatedUser extends SimulatedUser {\n+\n+        // Extend support for Generic Resources in addition to CPU and Memory\n+        public final Map<String, Double> guaranteedGenericResources;                // resource name : guaranteed amount\n+        private Map<String, Double> assignedGenericResources = new HashMap<>();     // resource name : assigned amount\n+\n+        public GrasSimulatedUser(User other, ISchedulingState cluster) {\n+            super(other, cluster);\n+\n+            Map<String, Double> guaranteedGenericResources = new HashMap<>();\n+            Map<String, Double> availGenericResources = cluster.getClusterTotalGenericResource();   // generic resources that are offered\n+            for (Map.Entry<String, Double> entry : availGenericResources.entrySet()) {\n+                String resource = entry.getKey();\n+                Double guaranteedAmount = other.getGenericGuaranteed().getOrDefault(resource, 0.0);\n+                guaranteedGenericResources.put(resource, guaranteedAmount);\n+            }\n+            this.guaranteedGenericResources = guaranteedGenericResources;\n+        }\n+\n+        @Override\n+        public TopologyDetails simScheduleNextHighest() {\n+            TopologyDetails td = tds.pop();\n+            assignedCpu += td.getTotalRequestedCpu();\n+            assignedMemory += td.getTotalRequestedMemOffHeap() + td.getTotalRequestedMemOnHeap();\n+            Map<String, Double> tdRequestedGenericResource = td.getTotalRequestedGenericResources();\n+            for (Map.Entry<String, Double> entry : tdRequestedGenericResource.entrySet()) {\n+                String resource = entry.getKey();\n+                Double requestedAmount = entry.getValue();\n+                assignedGenericResources.put(resource, assignedGenericResources.getOrDefault(resource, 0.0) + requestedAmount);\n+            }\n+            return td;\n+        }\n+\n+        /**\n+         * Get a score for the simulated user.  This is used to sort the users, by their highest priority topology.\n+         * Only give user guarantees that will not exceed cluster capacity.\n+         * Score of each resource type is calculated as: (Requested + Assigned - Guaranteed)/Available", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "008f2e6d54cdd0501723de82a3281b031e2846de"}, "originalPosition": 121}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwMzQ1Mw==", "bodyText": "This reminds me that we don't have a unit test to test the case where users have the generic resource guarantee. But this can be a follow up work", "url": "https://github.com/apache/storm/pull/3213#discussion_r384803453", "createdAt": "2020-02-26T22:22:00Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/test/java/org/apache/storm/scheduler/resource/TestUtilsForResourceAwareScheduler.java", "diffHunk": "@@ -83,6 +88,10 @@ public void addSelfTo(Map<String, Map<String, Number>> fullPool) {\n         }\n     }\n \n+    public static TestUserResources userRes(String name, Map<String, Double> resources) {\n+        return new TestUserResources(name, resources);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "008f2e6d54cdd0501723de82a3281b031e2846de"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09bc3b8e1a452a1b02b90aa876093b62e9d52133", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/09bc3b8e1a452a1b02b90aa876093b62e9d52133", "committedDate": "2020-02-27T03:47:02Z", "message": "Addressed comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NzMxNTgw", "url": "https://github.com/apache/storm/pull/3213#pullrequestreview-365731580", "createdAt": "2020-02-27T14:53:41Z", "commit": {"oid": "09bc3b8e1a452a1b02b90aa876093b62e9d52133"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNDo1Mzo0MlrOFvUr_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNDo1Mzo0MlrOFvUr_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE2NjMzMw==", "bodyText": "One last thing, we can have a boolean like forTests, which by default to false and we can set it to true from unit tests. This is to avoid unnecessary computation/operations. And make it clear that this is only for tests.\nAs for getEvictedTopologies, we can throw exceptions if forTests is false.", "url": "https://github.com/apache/storm/pull/3213#discussion_r385166333", "createdAt": "2020-02-27T14:53:42Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/resource/ResourceAwareScheduler.java", "diffHunk": "@@ -202,7 +210,7 @@ private void scheduleTopology(TopologyDetails td, Cluster cluster, final User to\n                             if (evictAssignemnt != null && !evictAssignemnt.getSlots().isEmpty()) {\n                                 Collection<WorkerSlot> workersToEvict = workingState.getUsedSlotsByTopologyId(topologyEvict.getId());\n                                 topologySchedulingResources.adjustResourcesForEvictedTopology(toSchedule, topologyEvict);\n-\n+                                evictedTopologies.add(topologyEvict.getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09bc3b8e1a452a1b02b90aa876093b62e9d52133"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30bbfd313340475a16a9ba45951999a33b55f4e1", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/30bbfd313340475a16a9ba45951999a33b55f4e1", "committedDate": "2020-02-28T21:12:29Z", "message": "address comments and add forTest boolean check"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b35ab2b15dcd1cdb359d1d1b51550d9e539d7396", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/b35ab2b15dcd1cdb359d1d1b51550d9e539d7396", "committedDate": "2020-02-28T19:46:42Z", "message": "address comments and add forTest boolean check"}, "afterCommit": {"oid": "30bbfd313340475a16a9ba45951999a33b55f4e1", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/30bbfd313340475a16a9ba45951999a33b55f4e1", "committedDate": "2020-02-28T21:12:29Z", "message": "address comments and add forTest boolean check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2ODA5MDUx", "url": "https://github.com/apache/storm/pull/3213#pullrequestreview-366809051", "createdAt": "2020-02-29T17:19:57Z", "commit": {"oid": "30bbfd313340475a16a9ba45951999a33b55f4e1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOVQxNzoxOTo1N1rOFwKIiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOVQxNzoxOTo1N1rOFwKIiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA0MTk5Mg==", "bodyText": "This can be UnsupportedOperationException", "url": "https://github.com/apache/storm/pull/3213#discussion_r386041992", "createdAt": "2020-02-29T17:19:57Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/resource/ResourceAwareScheduler.java", "diffHunk": "@@ -248,8 +252,17 @@ private void scheduleTopology(TopologyDetails td, Cluster cluster, final User to\n     }\n \n     @VisibleForTesting\n-    public Set<String> getEvictedTopologies() {\n-        return this.evictedTopologies;\n+    public Set<String> getEvictedTopologies() throws Exception {\n+        if (forTest) {\n+            return this.evictedTopologies;\n+        } else {\n+            throw new Exception(\"Topology eviction check is only provided for test purposes\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30bbfd313340475a16a9ba45951999a33b55f4e1"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0a06e74e824a81b4544c97dc7b85cdc7ed86c4c", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/d0a06e74e824a81b4544c97dc7b85cdc7ed86c4c", "committedDate": "2020-03-02T14:57:57Z", "message": "address comment and handle exceptions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3Mjc4Mjk3", "url": "https://github.com/apache/storm/pull/3213#pullrequestreview-367278297", "createdAt": "2020-03-02T15:16:29Z", "commit": {"oid": "d0a06e74e824a81b4544c97dc7b85cdc7ed86c4c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxNToxNjoyOVrOFwjQqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxNToxNjoyOVrOFwjQqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ1MzY3NA==", "bodyText": "UnsupportedOperationException is a runtime exception. throws Exception is not needed in the signature. So is in the unit tests like testDefaultSchedulingPriorityStrategyNotEvicting", "url": "https://github.com/apache/storm/pull/3213#discussion_r386453674", "createdAt": "2020-03-02T15:16:29Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/resource/ResourceAwareScheduler.java", "diffHunk": "@@ -256,7 +256,8 @@ private void scheduleTopology(TopologyDetails td, Cluster cluster, final User to\n         if (forTest) {\n             return this.evictedTopologies;\n         } else {\n-            throw new Exception(\"Topology eviction check is only provided for test purposes\");\n+            throw new UnsupportedOperationException(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0a06e74e824a81b4544c97dc7b85cdc7ed86c4c"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f76cc79cb0c28581259d5eb392ba8b8bdbae9d4", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/8f76cc79cb0c28581259d5eb392ba8b8bdbae9d4", "committedDate": "2020-03-02T15:42:33Z", "message": "addressed comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3Mzg1ODgz", "url": "https://github.com/apache/storm/pull/3213#pullrequestreview-367385883", "createdAt": "2020-03-02T17:28:52Z", "commit": {"oid": "8f76cc79cb0c28581259d5eb392ba8b8bdbae9d4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NzMwMTg4", "url": "https://github.com/apache/storm/pull/3213#pullrequestreview-368730188", "createdAt": "2020-03-04T12:18:15Z", "commit": {"oid": "8f76cc79cb0c28581259d5eb392ba8b8bdbae9d4"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMjoxODoxNlrOFxrBtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMjoyNTowNlrOFxrOAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYyOTQ5Mw==", "bodyText": "A stream API could make it simpler to represent aggregation of maps:.\nreturn supervisors.values().stream().flatMap(m -> m.getTotalGenericResources().entrySet().stream()).collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue, Double::sum));", "url": "https://github.com/apache/storm/pull/3213#discussion_r387629493", "createdAt": "2020-03-04T12:18:16Z", "author": {"login": "kishorvpatil"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/Cluster.java", "diffHunk": "@@ -889,6 +889,20 @@ public double getClusterTotalMemoryResource() {\n         return sum;\n     }\n \n+    @Override\n+    public Map<String, Double> getClusterTotalGenericResource() {\n+        Map<String, Double> ret = new HashMap<>();\n+        for (SupervisorDetails sup : supervisors.values()) {\n+            Map<String, Double> supGenericResources = sup.getTotalGenericResources();\n+            for (Map.Entry<String, Double> entry : supGenericResources.entrySet()) {\n+                String resourceName = entry.getKey();\n+                Double amount = entry.getValue();\n+                ret.put(resourceName, ret.getOrDefault(resourceName, 0.0) + amount);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f76cc79cb0c28581259d5eb392ba8b8bdbae9d4"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYzMDA2NA==", "bodyText": "Method name should probably be getClusterTotalGenericResources  with s", "url": "https://github.com/apache/storm/pull/3213#discussion_r387630064", "createdAt": "2020-03-04T12:19:31Z", "author": {"login": "kishorvpatil"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/ISchedulingState.java", "diffHunk": "@@ -271,6 +273,13 @@ boolean wouldFit(\n      */\n     double getClusterTotalMemoryResource();\n \n+    /**\n+     * Get the total amount of generic resources (excluding CPU and memory) in cluster.\n+     */\n+    default Map<String, Double> getClusterTotalGenericResource() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f76cc79cb0c28581259d5eb392ba8b8bdbae9d4"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYzMDIwNg==", "bodyText": "Method name should include s at the end.", "url": "https://github.com/apache/storm/pull/3213#discussion_r387630206", "createdAt": "2020-03-04T12:19:49Z", "author": {"login": "kishorvpatil"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/Cluster.java", "diffHunk": "@@ -889,6 +889,20 @@ public double getClusterTotalMemoryResource() {\n         return sum;\n     }\n \n+    @Override\n+    public Map<String, Double> getClusterTotalGenericResource() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f76cc79cb0c28581259d5eb392ba8b8bdbae9d4"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYzMTAwNw==", "bodyText": "Instead of using getClusterTotalGenericResource here, probably adding below getClusterTotalGenericResourceType to cluster would help avoid calculations..\nIt would looks something like:\n    public Set<String> getClusterGenericResourceTypes() {\n        Set<String> resourceTypes =\n            supervisors.values().parallelStream().map(sup -> sup.getTotalGenericResources().keySet()).flatMap(Set::stream).collect(Collectors.toSet());\n        return resourceTypes;\n    }```", "url": "https://github.com/apache/storm/pull/3213#discussion_r387631007", "createdAt": "2020-03-04T12:21:30Z", "author": {"login": "kishorvpatil"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/resource/strategies/priority/GenericResourceAwareSchedulingPriorityStrategy.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.storm.scheduler.resource.strategies.priority;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.Comparator;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.storm.scheduler.ISchedulingState;\n+import org.apache.storm.scheduler.TopologyDetails;\n+import org.apache.storm.scheduler.resource.User;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class GenericResourceAwareSchedulingPriorityStrategy extends DefaultSchedulingPriorityStrategy {\n+    private static final Logger LOG = LoggerFactory.getLogger(GenericResourceAwareSchedulingPriorityStrategy.class);\n+\n+    @Override\n+    protected GrasSimulatedUser getSimulatedUserFor(User u, ISchedulingState cluster) {\n+        return new GrasSimulatedUser(u, cluster);\n+    }\n+\n+    @Override\n+    public List<TopologyDetails> getOrderedTopologies(ISchedulingState cluster, Map<String, User> userMap) {\n+        double cpuAvail = cluster.getClusterTotalCpuResource();\n+        double memAvail = cluster.getClusterTotalMemoryResource();\n+        Map<String, Double> genericAvail = cluster.getClusterTotalGenericResource();\n+\n+        List<TopologyDetails> allUserTopologies = new ArrayList<>();\n+        List<GrasSimulatedUser> users = new ArrayList<>();\n+\n+        for (User u : userMap.values()) {\n+            users.add(getSimulatedUserFor(u, cluster));\n+        }\n+\n+        while (!users.isEmpty()) {\n+            Collections.sort(users, new GrasSimulatedUserComparator(cpuAvail, memAvail, genericAvail));\n+            GrasSimulatedUser u = users.get(0);\n+            TopologyDetails td = u.getNextHighest();\n+            if (td == null) {\n+                users.remove(0);\n+            } else {\n+                double score = u.getScore(cpuAvail, memAvail, genericAvail);\n+                td = u.simScheduleNextHighest();\n+                LOG.info(\"GRAS SIM Scheduling {} with score of {}\", td.getId(), score);\n+                cpuAvail -= td.getTotalRequestedCpu();\n+                memAvail -= (td.getTotalRequestedMemOffHeap() + td.getTotalRequestedMemOnHeap());\n+                for (Map.Entry<String, Double> entry : td.getTotalRequestedGenericResources().entrySet()) {\n+                    String resource = entry.getKey();\n+                    Double requestedAmount = entry.getValue();\n+                    if (!genericAvail.containsKey(resource)) {\n+                        LOG.warn(\"Resource: {} is not supported in this cluster. Ignoring this request.\", resource);\n+                    } else {\n+                        genericAvail.put(resource, genericAvail.get(resource) - requestedAmount);\n+                    }\n+                }\n+                allUserTopologies.add(td);\n+            }\n+        }\n+        return allUserTopologies;\n+    }\n+\n+    protected static class GrasSimulatedUser extends SimulatedUser {\n+\n+        // Extend support for Generic Resources in addition to CPU and Memory\n+        public final Map<String, Double> guaranteedGenericResources;                // resource name : guaranteed amount\n+        private Map<String, Double> assignedGenericResources = new HashMap<>();     // resource name : assigned amount\n+\n+        public GrasSimulatedUser(User other, ISchedulingState cluster) {\n+            super(other, cluster);\n+\n+            Map<String, Double> guaranteedGenericResources = new HashMap<>();\n+            Map<String, Double> availGenericResources = cluster.getClusterTotalGenericResource();   // generic resources that are offered", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f76cc79cb0c28581259d5eb392ba8b8bdbae9d4"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYzMjY0Mw==", "bodyText": "Cluster should have a private variable that avoids recalculating this often.\nSimilarly, it should have Set genericResourceTypes.\nAnd method getClusterGenericResourceTypes", "url": "https://github.com/apache/storm/pull/3213#discussion_r387632643", "createdAt": "2020-03-04T12:25:06Z", "author": {"login": "kishorvpatil"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/ISchedulingState.java", "diffHunk": "@@ -271,6 +273,13 @@ boolean wouldFit(\n      */\n     double getClusterTotalMemoryResource();\n \n+    /**\n+     * Get the total amount of generic resources (excluding CPU and memory) in cluster.\n+     */\n+    default Map<String, Double> getClusterTotalGenericResource() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYzMDA2NA=="}, "originalCommit": {"oid": "8f76cc79cb0c28581259d5eb392ba8b8bdbae9d4"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d7c073bb772d69b08701c654ec7cd454cdc682c", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/6d7c073bb772d69b08701c654ec7cd454cdc682c", "committedDate": "2020-03-04T17:31:41Z", "message": "address comments and use stream API"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0d684bf37b188070881cad503bdc70c9f3c820f7", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/0d684bf37b188070881cad503bdc70c9f3c820f7", "committedDate": "2020-03-04T17:21:58Z", "message": "address comments and use stream API"}, "afterCommit": {"oid": "6d7c073bb772d69b08701c654ec7cd454cdc682c", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/6d7c073bb772d69b08701c654ec7cd454cdc682c", "committedDate": "2020-03-04T17:31:41Z", "message": "address comments and use stream API"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5434928b92fce2b230fe4f10527c162cefb518d0", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/5434928b92fce2b230fe4f10527c162cefb518d0", "committedDate": "2020-03-04T20:13:26Z", "message": "cache all type of resources in cluster object"}, "afterCommit": {"oid": "752b7053807d7ce50367a9d5d936e83b2bc31948", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/752b7053807d7ce50367a9d5d936e83b2bc31948", "committedDate": "2020-03-04T20:35:44Z", "message": "cache all type of resources in cluster object"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d26f4054347cca6787362755210b8e634c55ad89", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/d26f4054347cca6787362755210b8e634c55ad89", "committedDate": "2020-03-05T17:19:31Z", "message": "cache all type of resources in cluster object"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "752b7053807d7ce50367a9d5d936e83b2bc31948", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/752b7053807d7ce50367a9d5d936e83b2bc31948", "committedDate": "2020-03-04T20:35:44Z", "message": "cache all type of resources in cluster object"}, "afterCommit": {"oid": "d26f4054347cca6787362755210b8e634c55ad89", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/d26f4054347cca6787362755210b8e634c55ad89", "committedDate": "2020-03-05T17:19:31Z", "message": "cache all type of resources in cluster object"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNzczOTI3", "url": "https://github.com/apache/storm/pull/3213#pullrequestreview-372773927", "createdAt": "2020-03-11T13:50:08Z", "commit": {"oid": "d26f4054347cca6787362755210b8e634c55ad89"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MzgxMzA2", "url": "https://github.com/apache/storm/pull/3213#pullrequestreview-375381306", "createdAt": "2020-03-16T16:29:09Z", "commit": {"oid": "d26f4054347cca6787362755210b8e634c55ad89"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNjoyOToxMFrOF28GZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNjoyOToxMFrOF28GZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE1MjEwMA==", "bodyText": "These three variables nee to be part if copying from src in copy constructor and  public Cluster(Cluster src, Topologies topologies)", "url": "https://github.com/apache/storm/pull/3213#discussion_r393152100", "createdAt": "2020-03-16T16:29:10Z", "author": {"login": "kishorvpatil"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/Cluster.java", "diffHunk": "@@ -80,6 +80,13 @@\n     private final Map<String, Map<String, Double>> nodeToScheduledOffHeapNodeMemoryCache;   // node -> topologyId -> double\n     private final Map<String, Set<WorkerSlot>> nodeToUsedSlotsCache;\n     private final Map<String, NormalizedResourceRequest> totalResourcesPerNodeCache = new HashMap<>();\n+    /**\n+     * Snapshot of cluster total resources (cpu, memory, generic).\n+     */\n+    private final double totalCpuResource;\n+    private final double totalMemoryResource;\n+    private final Map<String, Double> totalGenericResources;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d26f4054347cca6787362755210b8e634c55ad89"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NDIxNzE4", "url": "https://github.com/apache/storm/pull/3213#pullrequestreview-375421718", "createdAt": "2020-03-16T17:12:11Z", "commit": {"oid": "d26f4054347cca6787362755210b8e634c55ad89"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNzoxMjoxMVrOF2-Clw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNzoxMjoxMVrOF2-Clw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE4Mzg5NQ==", "bodyText": "should we not adjust cpu and memory as well? Very similar to how SimulatedUser.simScheduleNextHighest()\n                assignedMemory += td.getTotalRequestedMemOffHeap() + td.getTotalRequestedMemOnHeap();\n\nEven better would be generally refactor this whole class to minimize the duplicate code...", "url": "https://github.com/apache/storm/pull/3213#discussion_r393183895", "createdAt": "2020-03-16T17:12:11Z", "author": {"login": "kishorvpatil"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/resource/strategies/priority/GenericResourceAwareSchedulingPriorityStrategy.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.storm.scheduler.resource.strategies.priority;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.Comparator;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import org.apache.storm.scheduler.ISchedulingState;\n+import org.apache.storm.scheduler.TopologyDetails;\n+import org.apache.storm.scheduler.resource.User;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class GenericResourceAwareSchedulingPriorityStrategy extends DefaultSchedulingPriorityStrategy {\n+    private static final Logger LOG = LoggerFactory.getLogger(GenericResourceAwareSchedulingPriorityStrategy.class);\n+\n+    @Override\n+    protected GrasSimulatedUser getSimulatedUserFor(User u, ISchedulingState cluster) {\n+        return new GrasSimulatedUser(u, cluster);\n+    }\n+\n+    @Override\n+    public List<TopologyDetails> getOrderedTopologies(ISchedulingState cluster, Map<String, User> userMap) {\n+        double cpuAvail = cluster.getClusterTotalCpuResource();\n+        double memAvail = cluster.getClusterTotalMemoryResource();\n+        Map<String, Double> genericAvail = cluster.getClusterTotalGenericResources();\n+\n+        List<TopologyDetails> allUserTopologies = new ArrayList<>();\n+        List<GrasSimulatedUser> users = new ArrayList<>();\n+\n+        for (User u : userMap.values()) {\n+            users.add(getSimulatedUserFor(u, cluster));\n+        }\n+\n+        while (!users.isEmpty()) {\n+            Collections.sort(users, new GrasSimulatedUserComparator(cpuAvail, memAvail, genericAvail));\n+            GrasSimulatedUser u = users.get(0);\n+            TopologyDetails td = u.getNextHighest();\n+            if (td == null) {\n+                users.remove(0);\n+            } else {\n+                double score = u.getScore(cpuAvail, memAvail, genericAvail);\n+                td = u.simScheduleNextHighest();\n+                LOG.info(\"GRAS SIM Scheduling {} with score of {}\", td.getId(), score);\n+                cpuAvail -= td.getTotalRequestedCpu();\n+                memAvail -= (td.getTotalRequestedMemOffHeap() + td.getTotalRequestedMemOnHeap());\n+                for (Map.Entry<String, Double> entry : td.getTotalRequestedGenericResources().entrySet()) {\n+                    String resource = entry.getKey();\n+                    Double requestedAmount = entry.getValue();\n+                    if (!genericAvail.containsKey(resource)) {\n+                        LOG.warn(\"Resource: {} is not supported in this cluster. Ignoring this request.\", resource);\n+                    } else {\n+                        genericAvail.put(resource, genericAvail.get(resource) - requestedAmount);\n+                    }\n+                }\n+                allUserTopologies.add(td);\n+            }\n+        }\n+        return allUserTopologies;\n+    }\n+\n+    protected static class GrasSimulatedUser extends SimulatedUser {\n+\n+        // Extend support for Generic Resources in addition to CPU and Memory\n+        public final Map<String, Double> guaranteedGenericResources;                // resource name : guaranteed amount\n+        private Map<String, Double> assignedGenericResources = new HashMap<>();     // resource name : assigned amount\n+\n+        public GrasSimulatedUser(User other, ISchedulingState cluster) {\n+            super(other, cluster);\n+\n+            Map<String, Double> guaranteedGenericResources = new HashMap<>();\n+            // generic resource types that are offered\n+            Set<String> availGenericResourceTypes = cluster.getClusterTotalGenericResources().keySet();\n+            for (String resourceType : availGenericResourceTypes) {\n+                Double guaranteedAmount = other.getGenericGuaranteed().getOrDefault(resourceType, 0.0);\n+                guaranteedGenericResources.put(resourceType, guaranteedAmount);\n+            }\n+            this.guaranteedGenericResources = guaranteedGenericResources;\n+        }\n+\n+        @Override\n+        public TopologyDetails simScheduleNextHighest() {\n+            TopologyDetails td = super.simScheduleNextHighest();\n+            Map<String, Double> tdRequestedGenericResource = td.getTotalRequestedGenericResources();\n+            for (Map.Entry<String, Double> entry : tdRequestedGenericResource.entrySet()) {\n+                String resource = entry.getKey();\n+                Double requestedAmount = entry.getValue();\n+                assignedGenericResources.put(resource, assignedGenericResources.getOrDefault(resource, 0.0) + requestedAmount);\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d26f4054347cca6787362755210b8e634c55ad89"}, "originalPosition": 111}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ba7f9ea112c2733b2d45959b9000d66eba0c93d", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/0ba7f9ea112c2733b2d45959b9000d66eba0c93d", "committedDate": "2020-03-17T21:43:40Z", "message": "address comments fix Cluster constructor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3Mzk5ODUx", "url": "https://github.com/apache/storm/pull/3213#pullrequestreview-377399851", "createdAt": "2020-03-19T03:30:17Z", "commit": {"oid": "0ba7f9ea112c2733b2d45959b9000d66eba0c93d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwMzozMDoxN1rOF4e6Zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwMzozMDoxN1rOF4e6Zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDc3MTA0Nw==", "bodyText": "Is this comparator supposed to compare GrasSimulatedUser for use in a sort? Then it should compare o1 to o2. But it \"seems\" to be comparing  \"distance\" from some fixed point to o1 and o2. Is this intentional?", "url": "https://github.com/apache/storm/pull/3213#discussion_r394771047", "createdAt": "2020-03-19T03:30:17Z", "author": {"login": "bipinprasad"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/resource/strategies/priority/GenericResourceAwareSchedulingPriorityStrategy.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.storm.scheduler.resource.strategies.priority;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.Comparator;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import org.apache.storm.scheduler.ISchedulingState;\n+import org.apache.storm.scheduler.TopologyDetails;\n+import org.apache.storm.scheduler.resource.User;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class GenericResourceAwareSchedulingPriorityStrategy extends DefaultSchedulingPriorityStrategy {\n+    private static final Logger LOG = LoggerFactory.getLogger(GenericResourceAwareSchedulingPriorityStrategy.class);\n+\n+    @Override\n+    protected GrasSimulatedUser getSimulatedUserFor(User u, ISchedulingState cluster) {\n+        return new GrasSimulatedUser(u, cluster);\n+    }\n+\n+    @Override\n+    public List<TopologyDetails> getOrderedTopologies(ISchedulingState cluster, Map<String, User> userMap) {\n+        double cpuAvail = cluster.getClusterTotalCpuResource();\n+        double memAvail = cluster.getClusterTotalMemoryResource();\n+        Map<String, Double> genericAvail = cluster.getClusterTotalGenericResources();\n+\n+        List<TopologyDetails> allUserTopologies = new ArrayList<>();\n+        List<GrasSimulatedUser> users = new ArrayList<>();\n+\n+        for (User u : userMap.values()) {\n+            users.add(getSimulatedUserFor(u, cluster));\n+        }\n+\n+        while (!users.isEmpty()) {\n+            Collections.sort(users, new GrasSimulatedUserComparator(cpuAvail, memAvail, genericAvail));\n+            GrasSimulatedUser u = users.get(0);\n+            TopologyDetails td = u.getNextHighest();\n+            if (td == null) {\n+                users.remove(0);\n+            } else {\n+                double score = u.getScore(cpuAvail, memAvail, genericAvail);\n+                td = u.simScheduleNextHighest();\n+                LOG.info(\"GRAS SIM Scheduling {} with score of {}\", td.getId(), score);\n+                cpuAvail -= td.getTotalRequestedCpu();\n+                memAvail -= (td.getTotalRequestedMemOffHeap() + td.getTotalRequestedMemOnHeap());\n+                for (Map.Entry<String, Double> entry : td.getTotalRequestedGenericResources().entrySet()) {\n+                    String resource = entry.getKey();\n+                    Double requestedAmount = entry.getValue();\n+                    if (!genericAvail.containsKey(resource)) {\n+                        LOG.warn(\"Resource: {} is not supported in this cluster. Ignoring this request.\", resource);\n+                    } else {\n+                        genericAvail.put(resource, genericAvail.get(resource) - requestedAmount);\n+                    }\n+                }\n+                allUserTopologies.add(td);\n+            }\n+        }\n+        return allUserTopologies;\n+    }\n+\n+    protected static class GrasSimulatedUser extends SimulatedUser {\n+\n+        // Extend support for Generic Resources in addition to CPU and Memory\n+        public final Map<String, Double> guaranteedGenericResources;                // resource name : guaranteed amount\n+        private Map<String, Double> assignedGenericResources = new HashMap<>();     // resource name : assigned amount\n+\n+        public GrasSimulatedUser(User other, ISchedulingState cluster) {\n+            super(other, cluster);\n+\n+            Map<String, Double> guaranteedGenericResources = new HashMap<>();\n+            // generic resource types that are offered\n+            Set<String> availGenericResourceTypes = cluster.getClusterTotalGenericResources().keySet();\n+            for (String resourceType : availGenericResourceTypes) {\n+                Double guaranteedAmount = other.getGenericGuaranteed().getOrDefault(resourceType, 0.0);\n+                guaranteedGenericResources.put(resourceType, guaranteedAmount);\n+            }\n+            this.guaranteedGenericResources = guaranteedGenericResources;\n+        }\n+\n+        @Override\n+        public TopologyDetails simScheduleNextHighest() {\n+            TopologyDetails td = super.simScheduleNextHighest();\n+            Map<String, Double> tdRequestedGenericResource = td.getTotalRequestedGenericResources();\n+            for (Map.Entry<String, Double> entry : tdRequestedGenericResource.entrySet()) {\n+                String resource = entry.getKey();\n+                Double requestedAmount = entry.getValue();\n+                assignedGenericResources.put(resource, assignedGenericResources.getOrDefault(resource, 0.0) + requestedAmount);\n+            }\n+            return td;\n+        }\n+\n+        /**\n+         * Get a score for the simulated user.  This is used to sort the users, by their highest priority topology.\n+         * Only give user guarantees that will not exceed cluster capacity.\n+         * Score of each resource type is calculated as: (Requested + Assigned - Guaranteed)/clusterAvailable\n+         * The final score is a max over all resource types.\n+         * Topology score will fall into the following intervals if:\n+         *      User is under quota (guarantee):                    [(-guarantee)/available : 0]\n+         *      User is over quota:                                 (0, infinity)\n+         * Unfortunately, score below 0 does not guarantee that the topology will be scheduled due to resources fragmentation.\n+         * @param availableCpu available CPU on the cluster.\n+         * @param availableMemory available memory on the cluster.\n+         * @param availableGenericResources available generic resources (other that cpu and memory) in cluster\n+         * @param td the topology we are looking at.\n+         * @return the score.\n+         */\n+        protected double getScore(double availableCpu, double availableMemory,\n+                                  Map<String, Double> availableGenericResources, TopologyDetails td) {\n+            // calculate scores for cpu and memory first\n+            double ret = super.getScore(availableCpu, availableMemory, td);\n+            if (ret == Double.MAX_VALUE) {\n+                return ret;\n+            }\n+            Map<String, Double> tdTotalRequestedGeneric = td.getTotalRequestedGenericResources();\n+            if (tdTotalRequestedGeneric == null) {\n+                tdTotalRequestedGeneric = Collections.emptyMap();\n+            }\n+            for (Map.Entry<String, Double> entry : availableGenericResources.entrySet()) {\n+                String resource = entry.getKey();\n+                Double available = entry.getValue();\n+                if (available <= 0) {\n+                    return Double.MAX_VALUE;\n+                }\n+                Double wouldBeResource = assignedGenericResources.getOrDefault(resource, 0.0)\n+                    + tdTotalRequestedGeneric.getOrDefault(resource, 0.0);\n+                double thisScore = (wouldBeResource -  guaranteedGenericResources.getOrDefault(resource, 0.0)) / available;\n+                ret = Math.max(ret, thisScore);\n+            }\n+\n+            return ret;\n+        }\n+\n+        protected double getScore(double availableCpu, double availableMemory, Map<String, Double> availableGenericResources) {\n+            TopologyDetails td = getNextHighest();\n+            return getScore(availableCpu, availableMemory, availableGenericResources, td);\n+        }\n+    }\n+\n+    private static class GrasSimulatedUserComparator implements Comparator<GrasSimulatedUser> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ba7f9ea112c2733b2d45959b9000d66eba0c93d"}, "originalPosition": 162}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3NDEyMjky", "url": "https://github.com/apache/storm/pull/3213#pullrequestreview-377412292", "createdAt": "2020-03-19T04:11:55Z", "commit": {"oid": "0ba7f9ea112c2733b2d45959b9000d66eba0c93d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwNDoxMTo1NVrOF4fhxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwNDoxMTo1NVrOF4fhxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDc4MTEyNw==", "bodyText": "Can this be removed. Use TestUtilsForResourceAwareScheduler#assertTopologiesNotScheduled.", "url": "https://github.com/apache/storm/pull/3213#discussion_r394781127", "createdAt": "2020-03-19T04:11:55Z", "author": {"login": "bipinprasad"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/resource/ResourceAwareScheduler.java", "diffHunk": "@@ -56,6 +59,10 @@\n     private int schedulingTimeoutSeconds;\n     private ExecutorService backgroundScheduling;\n \n+    // record evicted topologies on each scheduling round, only used in test purpose now\n+    private boolean forTest = false;\n+    private Set<String> evictedTopologies = new HashSet<>();\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ba7f9ea112c2733b2d45959b9000d66eba0c93d"}, "originalPosition": 26}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cf98248366650d76239417f0832e7fdbe57be183", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/cf98248366650d76239417f0832e7fdbe57be183", "committedDate": "2020-03-19T18:22:43Z", "message": "record evicted topos only when testing or debugging"}, "afterCommit": {"oid": "a4440a7dd5013234530f413d149da4087148744e", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/a4440a7dd5013234530f413d149da4087148744e", "committedDate": "2020-03-19T20:43:02Z", "message": "record evicted topos only when testing or debugging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e2bf1c34ed54d0c2696a41744738e540d682abe", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/0e2bf1c34ed54d0c2696a41744738e540d682abe", "committedDate": "2020-03-23T00:57:43Z", "message": "record evicted topos only when testing or debugging"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a4440a7dd5013234530f413d149da4087148744e", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/a4440a7dd5013234530f413d149da4087148744e", "committedDate": "2020-03-19T20:43:02Z", "message": "record evicted topos only when testing or debugging"}, "afterCommit": {"oid": "0e2bf1c34ed54d0c2696a41744738e540d682abe", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/0e2bf1c34ed54d0c2696a41744738e540d682abe", "committedDate": "2020-03-23T00:57:43Z", "message": "record evicted topos only when testing or debugging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bd6f9ead88648499deb7a87146beb1b0185af2d", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/6bd6f9ead88648499deb7a87146beb1b0185af2d", "committedDate": "2020-04-03T18:24:50Z", "message": "Merge branch 'master' into STORM-3588"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec28f7a20dbfca7a175fdd7329230d2550a9ca5a", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/ec28f7a20dbfca7a175fdd7329230d2550a9ca5a", "committedDate": "2020-04-07T02:31:29Z", "message": "fix conflict with recent commits"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MTQzNTU0", "url": "https://github.com/apache/storm/pull/3213#pullrequestreview-389143554", "createdAt": "2020-04-07T13:58:40Z", "commit": {"oid": "ec28f7a20dbfca7a175fdd7329230d2550a9ca5a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzo1ODo0MFrOGCE5rg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzo1ODo0MFrOGCE5rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgzMDYzOA==", "bodyText": "evictedTopologies is cumulated during scheduling all the topologies since it only clears evictedTopologies at Line 111. So evictedTopologies here include all the evictedTopologies not only evicted by scheduling this topology td.getId()", "url": "https://github.com/apache/storm/pull/3213#discussion_r404830638", "createdAt": "2020-04-07T13:58:40Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/resource/ResourceAwareScheduler.java", "diffHunk": "@@ -113,6 +119,9 @@ public void schedule(Topologies topologies, Cluster cluster) {\n             } else {\n                 User submitter = userMap.get(td.getTopologySubmitter());\n                 scheduleTopology(td, cluster, submitter, orderedTopologies);\n+                if (!evictedTopologies.isEmpty()) {\n+                    LOG.warn(\"Evicted Topologies {} when scheduling topology: {}\", evictedTopologies, td.getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec28f7a20dbfca7a175fdd7329230d2550a9ca5a"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b3ac1972defc1296edcbc19a2b4c05d73d9456a", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/5b3ac1972defc1296edcbc19a2b4c05d73d9456a", "committedDate": "2020-04-07T18:15:25Z", "message": "fix evicted topologies log"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cd6620c416dfda1e4d69b274c61b1af1db19ef05", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/cd6620c416dfda1e4d69b274c61b1af1db19ef05", "committedDate": "2020-04-10T04:56:47Z", "message": "change evictedtopos to map and add snapshot"}, "afterCommit": {"oid": "8408202da7ffd0db920881e72f9ed6fc07c4875d", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/8408202da7ffd0db920881e72f9ed6fc07c4875d", "committedDate": "2020-04-10T14:27:10Z", "message": "change evictedtopos to map and add snapshot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95fdb64745865bf402d76aa84655a2ed23f94f1b", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/95fdb64745865bf402d76aa84655a2ed23f94f1b", "committedDate": "2020-04-10T14:33:08Z", "message": "change evictedtopos to map and add snapshot"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8408202da7ffd0db920881e72f9ed6fc07c4875d", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/8408202da7ffd0db920881e72f9ed6fc07c4875d", "committedDate": "2020-04-10T14:27:10Z", "message": "change evictedtopos to map and add snapshot"}, "afterCommit": {"oid": "95fdb64745865bf402d76aa84655a2ed23f94f1b", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/95fdb64745865bf402d76aa84655a2ed23f94f1b", "committedDate": "2020-04-10T14:33:08Z", "message": "change evictedtopos to map and add snapshot"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNTIwNTY2", "url": "https://github.com/apache/storm/pull/3213#pullrequestreview-391520566", "createdAt": "2020-04-10T16:02:14Z", "commit": {"oid": "95fdb64745865bf402d76aa84655a2ed23f94f1b"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNjowMjoxNVrOGD-ieQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNjoyMjoxOVrOGD_DVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgyMzU0NQ==", "bodyText": "This looks overly complicated.  Maybe\n        Set<String> set = new HashSet<>();\n        map.values().forEach((s) -> set.addAll(s));\n        return set;", "url": "https://github.com/apache/storm/pull/3213#discussion_r406823545", "createdAt": "2020-04-10T16:02:15Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/test/java/org/apache/storm/scheduler/resource/strategies/priority/TestGenericResourceAwareSchedulingPriorityStrategy.java", "diffHunk": "@@ -210,4 +216,11 @@ private Cluster mkTestCluster(Topologies topologies, Config config) {\n \n         return new Cluster(iNimbus, new ResourceMetrics(new StormMetricsRegistry()), supMap, new HashMap<>(), topologies, config);\n     }\n+\n+    private Set<String> collectMapValues(Map<String, Set<String>> map) {\n+        return map.values()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95fdb64745865bf402d76aa84655a2ed23f94f1b"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgyNzAwMQ==", "bodyText": "tmpEvictedTopos is a set of evictedTopologies in every attempt.\nIt might evict multiple topologies in maxSchedulingAttempts.\nSo the current evictedTopologiesMap is just a subset.", "url": "https://github.com/apache/storm/pull/3213#discussion_r406827001", "createdAt": "2020-04-10T16:10:24Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/resource/ResourceAwareScheduler.java", "diffHunk": "@@ -196,21 +204,18 @@ private void scheduleTopology(TopologyDetails td, Cluster cluster, final User to\n                     } else if (result.getStatus() == SchedulingStatus.FAIL_NOT_ENOUGH_RESOURCES) {\n                         LOG.debug(\"Not enough resources to schedule {}\", td.getName());\n                         List<TopologyDetails> reversedList = ImmutableList.copyOf(orderedTopologies).reverse();\n-                        boolean evictedSomething = false;\n-                        LOG.debug(\"attempting to make space for topo {} from user {}\", td.getName(), td.getTopologySubmitter());\n+                        LOG.debug(\"Attempting to make space for topo {} from user {}\", td.getName(), td.getTopologySubmitter());\n                         int tdIndex = reversedList.indexOf(td);\n                         topologySchedulingResources.setRemainingRequiredResources(toSchedule, td);\n \n+                        Set<String> tmpEvictedTopos = new HashSet<>();\n                         for (int index = 0; index < tdIndex; index++) {\n                             TopologyDetails topologyEvict = reversedList.get(index);\n                             SchedulerAssignment evictAssignemnt = workingState.getAssignmentById(topologyEvict.getId());\n                             if (evictAssignemnt != null && !evictAssignemnt.getSlots().isEmpty()) {\n-                                Collection<WorkerSlot> workersToEvict = workingState.getUsedSlotsByTopologyId(topologyEvict.getId());\n                                 topologySchedulingResources.adjustResourcesForEvictedTopology(toSchedule, topologyEvict);\n-\n-                                LOG.debug(\"Evicting Topology {} with workers: {} from user {}\", topologyEvict.getName(), workersToEvict,\n-                                    topologyEvict.getTopologySubmitter());\n-                                evictedSomething = true;\n+                                tmpEvictedTopos.add(topologyEvict.getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95fdb64745865bf402d76aa84655a2ed23f94f1b"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgyNzU3MA==", "bodyText": "The idea of making evictedTopologiesMap a result after a complete schedule round is a good idea.\nBut the code here makes evictedTopologiesMap and tmpEvictedTopologiesMap the same object.\nSo tmpEvictedTopologiesMap.clear == evictedTopologiesMap.clear. This won't achieve the goal here.", "url": "https://github.com/apache/storm/pull/3213#discussion_r406827570", "createdAt": "2020-04-10T16:11:51Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/resource/ResourceAwareScheduler.java", "diffHunk": "@@ -115,6 +122,7 @@ public void schedule(Topologies topologies, Cluster cluster) {\n                 scheduleTopology(td, cluster, submitter, orderedTopologies);\n             }\n         }\n+        evictedTopologiesMap = tmpEvictedTopologiesMap;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95fdb64745865bf402d76aa84655a2ed23f94f1b"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgzMTM5Ng==", "bodyText": "We can change this to WARN and add the current topologyId since this also includes the workers being evicted.\nThen delete Line228.", "url": "https://github.com/apache/storm/pull/3213#discussion_r406831396", "createdAt": "2020-04-10T16:20:56Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/resource/ResourceAwareScheduler.java", "diffHunk": "@@ -196,21 +204,18 @@ private void scheduleTopology(TopologyDetails td, Cluster cluster, final User to\n                     } else if (result.getStatus() == SchedulingStatus.FAIL_NOT_ENOUGH_RESOURCES) {\n                         LOG.debug(\"Not enough resources to schedule {}\", td.getName());\n                         List<TopologyDetails> reversedList = ImmutableList.copyOf(orderedTopologies).reverse();\n-                        boolean evictedSomething = false;\n-                        LOG.debug(\"attempting to make space for topo {} from user {}\", td.getName(), td.getTopologySubmitter());\n+                        LOG.debug(\"Attempting to make space for topo {} from user {}\", td.getName(), td.getTopologySubmitter());\n                         int tdIndex = reversedList.indexOf(td);\n                         topologySchedulingResources.setRemainingRequiredResources(toSchedule, td);\n \n+                        Set<String> tmpEvictedTopos = new HashSet<>();\n                         for (int index = 0; index < tdIndex; index++) {\n                             TopologyDetails topologyEvict = reversedList.get(index);\n                             SchedulerAssignment evictAssignemnt = workingState.getAssignmentById(topologyEvict.getId());\n                             if (evictAssignemnt != null && !evictAssignemnt.getSlots().isEmpty()) {\n-                                Collection<WorkerSlot> workersToEvict = workingState.getUsedSlotsByTopologyId(topologyEvict.getId());\n                                 topologySchedulingResources.adjustResourcesForEvictedTopology(toSchedule, topologyEvict);\n-\n-                                LOG.debug(\"Evicting Topology {} with workers: {} from user {}\", topologyEvict.getName(), workersToEvict,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95fdb64745865bf402d76aa84655a2ed23f94f1b"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgzMTk1OA==", "bodyText": "I would add a comment like This method is not stable. It's subject to change since we don't really use it elsewhere besides unit test currently. It might change depending on how we want to use the evictedTopologies information. As @bipinprasad  said, we might want to put the evictedTopologies information into the scheduleResult in the future.", "url": "https://github.com/apache/storm/pull/3213#discussion_r406831958", "createdAt": "2020-04-10T16:22:19Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/resource/ResourceAwareScheduler.java", "diffHunk": "@@ -248,6 +255,11 @@ private void scheduleTopology(TopologyDetails td, Cluster cluster, final User to\n                     + topologySchedulingResources.getRemainingRequiredResourcesMessage());\n     }\n \n+    public Map<String, Set<String>> getEvictedTopologiesMap() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95fdb64745865bf402d76aa84655a2ed23f94f1b"}, "originalPosition": 81}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db992e84a02bb3f2e8eb1684d1e9626f99b7e3b7", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/db992e84a02bb3f2e8eb1684d1e9626f99b7e3b7", "committedDate": "2020-04-10T17:40:18Z", "message": "addressed comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8ce0fd3095519973dbe6249808f15f4e1ea69b7f", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/8ce0fd3095519973dbe6249808f15f4e1ea69b7f", "committedDate": "2020-04-10T17:31:53Z", "message": "addressed comment"}, "afterCommit": {"oid": "db992e84a02bb3f2e8eb1684d1e9626f99b7e3b7", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/db992e84a02bb3f2e8eb1684d1e9626f99b7e3b7", "committedDate": "2020-04-10T17:40:18Z", "message": "addressed comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNjM1ODI4", "url": "https://github.com/apache/storm/pull/3213#pullrequestreview-391635828", "createdAt": "2020-04-10T20:07:13Z", "commit": {"oid": "db992e84a02bb3f2e8eb1684d1e9626f99b7e3b7"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQyMDowNzoxNFrOGEEfmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQyMDoxNDo0OVrOGEEpqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkyMTExNQ==", "bodyText": "Makes sense", "url": "https://github.com/apache/storm/pull/3213#discussion_r406921115", "createdAt": "2020-04-10T20:07:14Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/resource/ResourceAwareScheduler.java", "diffHunk": "@@ -196,21 +204,18 @@ private void scheduleTopology(TopologyDetails td, Cluster cluster, final User to\n                     } else if (result.getStatus() == SchedulingStatus.FAIL_NOT_ENOUGH_RESOURCES) {\n                         LOG.debug(\"Not enough resources to schedule {}\", td.getName());\n                         List<TopologyDetails> reversedList = ImmutableList.copyOf(orderedTopologies).reverse();\n-                        boolean evictedSomething = false;\n-                        LOG.debug(\"attempting to make space for topo {} from user {}\", td.getName(), td.getTopologySubmitter());\n+                        LOG.debug(\"Attempting to make space for topo {} from user {}\", td.getName(), td.getTopologySubmitter());\n                         int tdIndex = reversedList.indexOf(td);\n                         topologySchedulingResources.setRemainingRequiredResources(toSchedule, td);\n \n+                        Set<String> tmpEvictedTopos = new HashSet<>();\n                         for (int index = 0; index < tdIndex; index++) {\n                             TopologyDetails topologyEvict = reversedList.get(index);\n                             SchedulerAssignment evictAssignemnt = workingState.getAssignmentById(topologyEvict.getId());\n                             if (evictAssignemnt != null && !evictAssignemnt.getSlots().isEmpty()) {\n-                                Collection<WorkerSlot> workersToEvict = workingState.getUsedSlotsByTopologyId(topologyEvict.getId());\n                                 topologySchedulingResources.adjustResourcesForEvictedTopology(toSchedule, topologyEvict);\n-\n-                                LOG.debug(\"Evicting Topology {} with workers: {} from user {}\", topologyEvict.getName(), workersToEvict,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgzMTM5Ng=="}, "originalCommit": {"oid": "95fdb64745865bf402d76aa84655a2ed23f94f1b"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkyMTM2NA==", "bodyText": "This doesn't have to be a attribute since it's only used inside schedule method", "url": "https://github.com/apache/storm/pull/3213#discussion_r406921364", "createdAt": "2020-04-10T20:07:56Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/resource/ResourceAwareScheduler.java", "diffHunk": "@@ -57,6 +59,8 @@\n     private int maxSchedulingAttempts;\n     private int schedulingTimeoutSeconds;\n     private ExecutorService backgroundScheduling;\n+    private Map<String, Set<String>> evictedTopologiesMap = new HashMap<>();   // topoId : topoEvicted\n+    private Map<String, Set<String>> tmpEvictedTopologiesMap = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db992e84a02bb3f2e8eb1684d1e9626f99b7e3b7"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkyMzE1NA==", "bodyText": "Can simplify this with\ntmpEvictedTopologiesMap.computeIfAbsent(topoId, k -> new HashSet<>()).addAll(tmpEvictedTopos);", "url": "https://github.com/apache/storm/pull/3213#discussion_r406923154", "createdAt": "2020-04-10T20:13:19Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/resource/ResourceAwareScheduler.java", "diffHunk": "@@ -219,8 +224,14 @@ private void scheduleTopology(TopologyDetails td, Cluster cluster, final User to\n                                 }\n                             }\n                         }\n-\n-                        if (!evictedSomething) {\n+                        if (!tmpEvictedTopos.isEmpty()) {\n+                            LOG.warn(\"Evicted Topologies {} when scheduling topology: {}\", tmpEvictedTopos, td.getId());\n+                            String topoId = td.getId();\n+                            if (!tmpEvictedTopologiesMap.containsKey(topoId)) {\n+                                tmpEvictedTopologiesMap.put(topoId, new HashSet<>());\n+                            }\n+                            tmpEvictedTopologiesMap.get(topoId).addAll(tmpEvictedTopos);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db992e84a02bb3f2e8eb1684d1e9626f99b7e3b7"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkyMzY4OA==", "bodyText": "Good comment", "url": "https://github.com/apache/storm/pull/3213#discussion_r406923688", "createdAt": "2020-04-10T20:14:49Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/resource/ResourceAwareScheduler.java", "diffHunk": "@@ -248,6 +255,11 @@ private void scheduleTopology(TopologyDetails td, Cluster cluster, final User to\n                     + topologySchedulingResources.getRemainingRequiredResourcesMessage());\n     }\n \n+    public Map<String, Set<String>> getEvictedTopologiesMap() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgzMTk1OA=="}, "originalCommit": {"oid": "95fdb64745865bf402d76aa84655a2ed23f94f1b"}, "originalPosition": 81}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b300f1314f818bb283b1c6e33437689b8e1c8f65", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/b300f1314f818bb283b1c6e33437689b8e1c8f65", "committedDate": "2020-04-10T21:07:48Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMzAzNjIy", "url": "https://github.com/apache/storm/pull/3213#pullrequestreview-392303622", "createdAt": "2020-04-13T17:37:23Z", "commit": {"oid": "b300f1314f818bb283b1c6e33437689b8e1c8f65"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNDQ1ODYy", "url": "https://github.com/apache/storm/pull/3213#pullrequestreview-392445862", "createdAt": "2020-04-13T21:16:32Z", "commit": {"oid": "b300f1314f818bb283b1c6e33437689b8e1c8f65"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMjgxNjkz", "url": "https://github.com/apache/storm/pull/3213#pullrequestreview-392281693", "createdAt": "2020-04-13T17:04:21Z", "commit": {"oid": "b300f1314f818bb283b1c6e33437689b8e1c8f65"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNzowNDoyMVrOGEtW1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QyMToxODoxOVrOGE1sxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5MDYxMg==", "bodyText": "Nit: Possibly use https://www.baeldung.com/java-merge-maps#of to simplify this a little.", "url": "https://github.com/apache/storm/pull/3213#discussion_r407590612", "createdAt": "2020-04-13T17:04:21Z", "author": {"login": "govind-menon"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/Cluster.java", "diffHunk": "@@ -873,20 +897,38 @@ public NormalizedResourceOffer getNonBlacklistedClusterAvailableResources(Collec\n \n     @Override\n     public double getClusterTotalCpuResource() {\n-        double sum = 0.0;\n-        for (SupervisorDetails sup : supervisors.values()) {\n-            sum += sup.getTotalCpu();\n-        }\n-        return sum;\n+        return this.totalCpuResource;\n+    }\n+\n+    private double computeClusterCpuResource() {\n+        return supervisors.values().stream()\n+            .mapToDouble(SupervisorDetails::getTotalCpu)\n+            .sum();\n+\n     }\n \n     @Override\n     public double getClusterTotalMemoryResource() {\n-        double sum = 0.0;\n-        for (SupervisorDetails sup : supervisors.values()) {\n-            sum += sup.getTotalMemory();\n-        }\n-        return sum;\n+        return this.totalMemoryResource;\n+    }\n+\n+\n+    private double computeClusterMemoryResource() {\n+        return supervisors.values().stream()\n+            .mapToDouble(SupervisorDetails::getTotalMemory)\n+            .sum();\n+    }\n+\n+    @Override\n+    public Map<String, Double> getClusterTotalGenericResources() {\n+        return this.totalGenericResources;\n+    }\n+\n+    private Map<String, Double> computeClusterGenericResources() {\n+        return supervisors.values().stream()\n+            .map(sup -> sup.getTotalGenericResources().entrySet())\n+            .flatMap(Set::stream)\n+            .collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue, Double::sum));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b300f1314f818bb283b1c6e33437689b8e1c8f65"}, "originalPosition": 119}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5MzcwMg==", "bodyText": "Do we need to define a default?", "url": "https://github.com/apache/storm/pull/3213#discussion_r407593702", "createdAt": "2020-04-13T17:10:11Z", "author": {"login": "govind-menon"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/ISchedulingState.java", "diffHunk": "@@ -271,6 +273,13 @@ boolean wouldFit(\n      */\n     double getClusterTotalMemoryResource();\n \n+    /**\n+     * Get the total amount of generic resources (excluding CPU and memory) in cluster.\n+     */\n+    default Map<String, Double> getClusterTotalGenericResources() {\n+        return Collections.emptyMap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b300f1314f818bb283b1c6e33437689b8e1c8f65"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5OTU5Mg==", "bodyText": "I'm trying to clarify why we don't pass in evictedTopologiesMap - is it because there could be an exception in scheduleTopology and you want to be able to get the previously evicted topologies?", "url": "https://github.com/apache/storm/pull/3213#discussion_r407599592", "createdAt": "2020-04-13T17:20:58Z", "author": {"login": "govind-menon"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/resource/ResourceAwareScheduler.java", "diffHunk": "@@ -115,6 +122,7 @@ public void schedule(Topologies topologies, Cluster cluster) {\n                 scheduleTopology(td, cluster, submitter, orderedTopologies);\n             }\n         }\n+        evictedTopologiesMap = tmpEvictedTopologiesMap;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgyNzU3MA=="}, "originalCommit": {"oid": "95fdb64745865bf402d76aa84655a2ed23f94f1b"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYwMTM0Ng==", "bodyText": "Regarding my previous question - in this case it makes sense because there are multiple scheduling attempts and you need the final result to keep it consistent but that is not the case with evictedTopologiesMap  and tmpEvictedTopologiesMap  - unless I'm missing something about my previous question?", "url": "https://github.com/apache/storm/pull/3213#discussion_r407601346", "createdAt": "2020-04-13T17:24:05Z", "author": {"login": "govind-menon"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/resource/ResourceAwareScheduler.java", "diffHunk": "@@ -248,6 +255,11 @@ private void scheduleTopology(TopologyDetails td, Cluster cluster, final User to\n                     + topologySchedulingResources.getRemainingRequiredResourcesMessage());\n     }\n \n+    public Map<String, Set<String>> getEvictedTopologiesMap() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgzMTk1OA=="}, "originalCommit": {"oid": "95fdb64745865bf402d76aa84655a2ed23f94f1b"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzcyNzMwMA==", "bodyText": "Nit: could we inline this to avoid unnecessary object creation", "url": "https://github.com/apache/storm/pull/3213#discussion_r407727300", "createdAt": "2020-04-13T21:18:19Z", "author": {"login": "govind-menon"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/resource/strategies/priority/GenericResourceAwareSchedulingPriorityStrategy.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.storm.scheduler.resource.strategies.priority;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.Comparator;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import org.apache.storm.scheduler.ISchedulingState;\n+import org.apache.storm.scheduler.TopologyDetails;\n+import org.apache.storm.scheduler.resource.User;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class GenericResourceAwareSchedulingPriorityStrategy extends DefaultSchedulingPriorityStrategy {\n+    private static final Logger LOG = LoggerFactory.getLogger(GenericResourceAwareSchedulingPriorityStrategy.class);\n+\n+    @Override\n+    protected GrasSimulatedUser getSimulatedUserFor(User u, ISchedulingState cluster) {\n+        return new GrasSimulatedUser(u, cluster);\n+    }\n+\n+    @Override\n+    public List<TopologyDetails> getOrderedTopologies(ISchedulingState cluster, Map<String, User> userMap) {\n+        double cpuAvail = cluster.getClusterTotalCpuResource();\n+        double memAvail = cluster.getClusterTotalMemoryResource();\n+        Map<String, Double> genericAvail = cluster.getClusterTotalGenericResources();\n+\n+        List<TopologyDetails> allUserTopologies = new ArrayList<>();\n+        List<GrasSimulatedUser> users = new ArrayList<>();\n+\n+        for (User u : userMap.values()) {\n+            users.add(getSimulatedUserFor(u, cluster));\n+        }\n+\n+        while (!users.isEmpty()) {\n+            Collections.sort(users, new GrasSimulatedUserComparator(cpuAvail, memAvail, genericAvail));\n+            GrasSimulatedUser u = users.get(0);\n+            TopologyDetails td = u.getNextHighest();\n+            if (td == null) {\n+                users.remove(0);\n+            } else {\n+                double score = u.getScore(cpuAvail, memAvail, genericAvail);\n+                td = u.simScheduleNextHighest();\n+                LOG.info(\"GRAS SIM Scheduling {} with score of {}\", td.getId(), score);\n+                cpuAvail -= td.getTotalRequestedCpu();\n+                memAvail -= (td.getTotalRequestedMemOffHeap() + td.getTotalRequestedMemOnHeap());\n+                for (Map.Entry<String, Double> entry : td.getTotalRequestedGenericResources().entrySet()) {\n+                    String resource = entry.getKey();\n+                    Double requestedAmount = entry.getValue();\n+                    if (!genericAvail.containsKey(resource)) {\n+                        LOG.warn(\"Resource: {} is not supported in this cluster. Ignoring this request.\", resource);\n+                    } else {\n+                        genericAvail.put(resource, genericAvail.get(resource) - requestedAmount);\n+                    }\n+                }\n+                allUserTopologies.add(td);\n+            }\n+        }\n+        return allUserTopologies;\n+    }\n+\n+    protected static class GrasSimulatedUser extends SimulatedUser {\n+\n+        // Extend support for Generic Resources in addition to CPU and Memory\n+        public final Map<String, Double> guaranteedGenericResources;                // resource name : guaranteed amount\n+        private Map<String, Double> assignedGenericResources = new HashMap<>();     // resource name : assigned amount\n+\n+        public GrasSimulatedUser(User other, ISchedulingState cluster) {\n+            super(other, cluster);\n+\n+            Map<String, Double> guaranteedGenericResources = new HashMap<>();\n+            // generic resource types that are offered\n+            Set<String> availGenericResourceTypes = cluster.getClusterTotalGenericResources().keySet();\n+            for (String resourceType : availGenericResourceTypes) {\n+                Double guaranteedAmount = other.getGenericGuaranteed().getOrDefault(resourceType, 0.0);\n+                guaranteedGenericResources.put(resourceType, guaranteedAmount);\n+            }\n+            this.guaranteedGenericResources = guaranteedGenericResources;\n+        }\n+\n+        @Override\n+        public TopologyDetails simScheduleNextHighest() {\n+            TopologyDetails td = super.simScheduleNextHighest();\n+            Map<String, Double> tdRequestedGenericResource = td.getTotalRequestedGenericResources();\n+            for (Map.Entry<String, Double> entry : tdRequestedGenericResource.entrySet()) {\n+                String resource = entry.getKey();\n+                Double requestedAmount = entry.getValue();\n+                assignedGenericResources.put(resource, assignedGenericResources.getOrDefault(resource, 0.0) + requestedAmount);\n+            }\n+            return td;\n+        }\n+\n+        /**\n+         * Get a score for the simulated user.  This is used to sort the users, by their highest priority topology.\n+         * Only give user guarantees that will not exceed cluster capacity.\n+         * Score of each resource type is calculated as: (Requested + Assigned - Guaranteed)/clusterAvailable\n+         * The final score is a max over all resource types.\n+         * Topology score will fall into the following intervals if:\n+         *      User is under quota (guarantee):                    [(-guarantee)/available : 0]\n+         *      User is over quota:                                 (0, infinity)\n+         * Unfortunately, score below 0 does not guarantee that the topology will be scheduled due to resources fragmentation.\n+         * @param availableCpu available CPU on the cluster.\n+         * @param availableMemory available memory on the cluster.\n+         * @param availableGenericResources available generic resources (other that cpu and memory) in cluster\n+         * @param td the topology we are looking at.\n+         * @return the score.\n+         */\n+        protected double getScore(double availableCpu, double availableMemory,\n+                                  Map<String, Double> availableGenericResources, TopologyDetails td) {\n+            // calculate scores for cpu and memory first\n+            double ret = super.getScore(availableCpu, availableMemory, td);\n+            if (ret == Double.MAX_VALUE) {\n+                return ret;\n+            }\n+            Map<String, Double> tdTotalRequestedGeneric = td.getTotalRequestedGenericResources();\n+            if (tdTotalRequestedGeneric == null) {\n+                tdTotalRequestedGeneric = Collections.emptyMap();\n+            }\n+            for (Map.Entry<String, Double> entry : availableGenericResources.entrySet()) {\n+                String resource = entry.getKey();\n+                Double available = entry.getValue();\n+                if (available <= 0) {\n+                    return Double.MAX_VALUE;\n+                }\n+                Double wouldBeResource = assignedGenericResources.getOrDefault(resource, 0.0)\n+                    + tdTotalRequestedGeneric.getOrDefault(resource, 0.0);\n+                double thisScore = (wouldBeResource -  guaranteedGenericResources.getOrDefault(resource, 0.0)) / available;\n+                ret = Math.max(ret, thisScore);\n+            }\n+\n+            return ret;\n+        }\n+\n+        protected double getScore(double availableCpu, double availableMemory, Map<String, Double> availableGenericResources) {\n+            TopologyDetails td = getNextHighest();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b300f1314f818bb283b1c6e33437689b8e1c8f65"}, "originalPosition": 157}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "384f7c70816540a3a0086f7f6e317fd02ddb29ca", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/384f7c70816540a3a0086f7f6e317fd02ddb29ca", "committedDate": "2020-04-14T04:16:38Z", "message": "address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7901baafe82409c45e2247a0d8cf84f1a124ec60", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/7901baafe82409c45e2247a0d8cf84f1a124ec60", "committedDate": "2020-04-14T04:04:03Z", "message": "address comments"}, "afterCommit": {"oid": "384f7c70816540a3a0086f7f6e317fd02ddb29ca", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/384f7c70816540a3a0086f7f6e317fd02ddb29ca", "committedDate": "2020-04-14T04:16:38Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MTU5NDk0", "url": "https://github.com/apache/storm/pull/3213#pullrequestreview-394159494", "createdAt": "2020-04-15T21:48:50Z", "commit": {"oid": "384f7c70816540a3a0086f7f6e317fd02ddb29ca"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4670, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}