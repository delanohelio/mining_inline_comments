{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4MDgzNTA4", "number": 3336, "title": "[STORM-3701] clean-up topo directory with the check against latest topo blob cache", "bodyText": "What is the purpose of the change\nWhen AsyncLocalizer cleanup happens, make sure it check against the latest topology cache information.\nCurrently, the safeTopologyIds set might become stale due to delay at around https://github.com/apache/storm/blob/master/storm-server/src/main/java/org/apache/storm/localizer/AsyncLocalizer.java#L641\u00a0. Newly created topology entries might not appear here and clean-up will delete them by fault and cause further FNF issue.\nHow was the change tested\nReproduce the FNF issue with additional sleep. After the change, same delay won't cause the FNF anymore.", "createdAt": "2020-09-16T15:49:29Z", "url": "https://github.com/apache/storm/pull/3336", "merged": true, "mergeCommit": {"oid": "19e23ae4a44fcf8e74473a48d408a712cde45d64"}, "closed": true, "closedAt": "2020-09-21T18:38:55Z", "author": {"login": "RuiLi8080"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJeXHKgH2gAyNDg4MDgzNTA4OmQ1MGM0ZjkzNTA1Y2M3MmJjNTk2M2E0YTdmOTlkYmFmYzFjZTFmNmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLH2DtgFqTQ5Mjg4MjE5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d50c4f93505cc72bc5963a4a7f99dbafc1ce1f6e", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/d50c4f93505cc72bc5963a4a7f99dbafc1ce1f6e", "committedDate": "2020-09-16T15:44:57Z", "message": "[STORM-3701] clean-up topo directory with the check against latest topo blob cache"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NzczNjc5", "url": "https://github.com/apache/storm/pull/3336#pullrequestreview-489773679", "createdAt": "2020-09-16T15:57:57Z", "commit": {"oid": "d50c4f93505cc72bc5963a4a7f99dbafc1ce1f6e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5Nzc1NTUx", "url": "https://github.com/apache/storm/pull/3336#pullrequestreview-489775551", "createdAt": "2020-09-16T16:00:05Z", "commit": {"oid": "d50c4f93505cc72bc5963a4a7f99dbafc1ce1f6e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNjowMDowNlrOHS30pQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNjowMDowNlrOHS30pQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU1MTAxMw==", "bodyText": "It seems like it may be possible to still have a race condition here where a topology is added to topologyBlobs?\nIf so it seems like we should add synchronization to this code and the adding of a blob?", "url": "https://github.com/apache/storm/pull/3336#discussion_r489551013", "createdAt": "2020-09-16T16:00:06Z", "author": {"login": "agresch"}, "path": "storm-server/src/main/java/org/apache/storm/localizer/AsyncLocalizer.java", "diffHunk": "@@ -641,7 +642,12 @@ void cleanup() {\n \n             try {\n                 forEachTopologyDistDir((p, topologyId) -> {\n-                    if (!safeTopologyIds.contains(topologyId)) {\n+                    String topoJarKey = ConfigUtils.masterStormJarKey(topologyId);\n+                    String topoCodeKey = ConfigUtils.masterStormCodeKey(topologyId);\n+                    String topoConfKey = ConfigUtils.masterStormConfKey(topologyId);\n+                    if (!topologyBlobs.containsKey(topoJarKey)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d50c4f93505cc72bc5963a4a7f99dbafc1ce1f6e"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNTE1Mjkz", "url": "https://github.com/apache/storm/pull/3336#pullrequestreview-491515293", "createdAt": "2020-09-18T14:25:18Z", "commit": {"oid": "d50c4f93505cc72bc5963a4a7f99dbafc1ce1f6e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNDoyNToxOVrOHUPdaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNDoyNToxOVrOHUPdaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk4Njg1Nw==", "bodyText": "Please update comments at line 470-471 too", "url": "https://github.com/apache/storm/pull/3336#discussion_r490986857", "createdAt": "2020-09-18T14:25:19Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/localizer/AsyncLocalizer.java", "diffHunk": "@@ -474,7 +474,7 @@ public void releaseSlotFor(LocalAssignment assignment, int port) throws IOExcept\n             LOG.info(\"Port and assignment info: {}\", pna);\n             if (e instanceof FileNotFoundException) {\n                 localResourceFileNotFoundWhenReleasingSlot.mark();\n-                LOG.warn(\"Local base blobs have not been downloaded yet. \", e);\n+                LOG.warn(\"Local base blobs are not available. \", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d50c4f93505cc72bc5963a4a7f99dbafc1ce1f6e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c33fb257f4c120997a21a7c96cc76ec8234db6b", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/6c33fb257f4c120997a21a7c96cc76ec8234db6b", "committedDate": "2020-09-18T16:52:54Z", "message": "update comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNjk1ODcy", "url": "https://github.com/apache/storm/pull/3336#pullrequestreview-491695872", "createdAt": "2020-09-18T18:33:00Z", "commit": {"oid": "6c33fb257f4c120997a21a7c96cc76ec8234db6b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyODgyMTk5", "url": "https://github.com/apache/storm/pull/3336#pullrequestreview-492882199", "createdAt": "2020-09-21T18:38:47Z", "commit": {"oid": "6c33fb257f4c120997a21a7c96cc76ec8234db6b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4933, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}