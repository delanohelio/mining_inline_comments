{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2OTMxNjI2", "number": 3267, "title": "STORM-3634 validate numa ports contained in supervisor.slots.ports", "bodyText": "What is the purpose of the change\nIt's currently possible to have a numa port configured that is not in supervisor.slots.ports.  When a supervisor restarts, any worker running on numa ports not in supervisor.slots.ports will be killed.  We should consider this an invalid configuration.\nHow was the change tested\nTested starting up a supervisor with no numa ports and numa ports matching supervisor.slots.ports successfully.  Verified supervisor with numa ports not in supervisor.slots.ports fails to start.", "createdAt": "2020-05-12T19:44:00Z", "url": "https://github.com/apache/storm/pull/3267", "merged": true, "mergeCommit": {"oid": "d5256cecad2ab18489d0e20150a9adff286fc616"}, "closed": true, "closedAt": "2020-05-14T18:08:03Z", "author": {"login": "agresch"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgreDQAFqTQxMDQ0ODMxMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABchRr9VgFqTQxMjA3MTkwNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNDQ4MzEy", "url": "https://github.com/apache/storm/pull/3267#pullrequestreview-410448312", "createdAt": "2020-05-12T21:50:24Z", "commit": {"oid": "31fa0361724906d686a1895f74c6ee19e98adc13"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMTo1MDoyNFrOGUaOwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMTo1MDoyNFrOGUaOwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1NDQ2Ng==", "bodyText": "Lately, we added NUMA support, so if getNumaPorts is configured and not empty, numaPorts should be used otherwise it can default to slots_ports. Since we are providing more than one place to configure ports, I think it is implied that NUMA one is newer and should win if configured. No need to stop supervisor daemon.", "url": "https://github.com/apache/storm/pull/3267#discussion_r424054466", "createdAt": "2020-05-12T21:50:24Z", "author": {"login": "kishorvpatil"}, "path": "storm-server/src/main/java/org/apache/storm/daemon/supervisor/Supervisor.java", "diffHunk": "@@ -327,6 +330,15 @@ public void launch() throws Exception {\n         LOG.info(\"Starting supervisor with id {} at host {}.\", getId(), getHostName());\n     }\n \n+    private void validateConf() {\n+        List<Number> ports = (List<Number>) conf.get(DaemonConfig.SUPERVISOR_SLOTS_PORTS);\n+        Set<Integer> numaPorts = SupervisorUtils.getNumaPorts(conf);\n+        numaPorts.removeAll(ports);\n+        if (numaPorts.size() > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31fa0361724906d686a1895f74c6ee19e98adc13"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExOTIzNjIw", "url": "https://github.com/apache/storm/pull/3267#pullrequestreview-411923620", "createdAt": "2020-05-14T15:29:46Z", "commit": {"oid": "e673151665cdabd6956ec3f60195636ba80b118c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b36eae9385616a26dd0f84c3071b8c4908d57d4", "author": {"user": null}, "url": "https://github.com/apache/storm/commit/2b36eae9385616a26dd0f84c3071b8c4908d57d4", "committedDate": "2020-05-14T16:46:14Z", "message": "STORM-3634 add missing numa ports to supervisor.slots.ports"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e673151665cdabd6956ec3f60195636ba80b118c", "author": {"user": null}, "url": "https://github.com/apache/storm/commit/e673151665cdabd6956ec3f60195636ba80b118c", "committedDate": "2020-05-13T18:53:26Z", "message": "STORM-3634 add missing numa ports to supervisor.slots.ports"}, "afterCommit": {"oid": "2b36eae9385616a26dd0f84c3071b8c4908d57d4", "author": {"user": null}, "url": "https://github.com/apache/storm/commit/2b36eae9385616a26dd0f84c3071b8c4908d57d4", "committedDate": "2020-05-14T16:46:14Z", "message": "STORM-3634 add missing numa ports to supervisor.slots.ports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMDcxOTA0", "url": "https://github.com/apache/storm/pull/3267#pullrequestreview-412071904", "createdAt": "2020-05-14T18:21:59Z", "commit": {"oid": "2b36eae9385616a26dd0f84c3071b8c4908d57d4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxODoyMTo1OVrOGVo3UQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxODoyMTo1OVrOGVo3UQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM0MjgwMQ==", "bodyText": "Should we make them match?\nIf there are ports in SUPERVISOR_SLOTS_PORTS not specified in numa.ports, will there be any issue?\nOne issue I can see is it will create ports that will possibly never be used.", "url": "https://github.com/apache/storm/pull/3267#discussion_r425342801", "createdAt": "2020-05-14T18:21:59Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/daemon/supervisor/SupervisorUtils.java", "diffHunk": "@@ -72,6 +75,33 @@ public static String getNumaIdForPort(Integer port, Map<String, Object> supervis\n         return null;\n     }\n \n+    /**\n+     * gets the set of all configured numa ports for a specific supervisor.\n+     * @param supervisorConf supervisorConf\n+     * @return set of all numa ports\n+     */\n+    public static Set<Integer> getNumaPorts(Map<String, Object> supervisorConf) {\n+        Set<Integer> numaPorts = new HashSet<>();\n+        Map<String, Object> validatedNumaMap = getNumaMap(supervisorConf);\n+        for (Map.Entry<String, Object> numaEntry : validatedNumaMap.entrySet()) {\n+            Map<String, Object> numaMap  = (Map<String, Object>) numaEntry.getValue();\n+            List<Integer> portList = (List<Integer>) numaMap.get(NUMA_PORTS);\n+            numaPorts.addAll(portList);\n+        }\n+        return numaPorts;\n+    }\n+\n+    public static List<Integer> getSlotsPorts(Map<String, Object> supervisorConf) {\n+        List<Integer> slotsPorts = (List<Integer>) supervisorConf.getOrDefault(DaemonConfig.SUPERVISOR_SLOTS_PORTS,\n+                new ArrayList<>());\n+        // It's possible we have numaPorts specified that weren't configured in SUPERVISOR_SLOTS_PORTS.  Make\n+        // sure we handle these ports as well.\n+        Set<Integer> numaPorts = SupervisorUtils.getNumaPorts(supervisorConf);\n+        numaPorts.removeAll(slotsPorts);\n+        slotsPorts.addAll(numaPorts);\n+        return slotsPorts;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b36eae9385616a26dd0f84c3071b8c4908d57d4"}, "originalPosition": 40}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4574, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}