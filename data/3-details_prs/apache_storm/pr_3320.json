{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyOTY4NzIw", "number": 3320, "title": "[STORM-3684] use real compId instead of constant _system for receive-queue V2 metrics", "bodyText": "What is the purpose of the change\nWhen registering receive-queue V2 metrics for each executor, we should use the its correspondent component Id instead of constant system component Id.\nHow was the change tested\nLaunch a local cluster with a WordCount topology. Enable org.apache.storm.metrics2.reporters.ConsoleStormReporter to output metrics to worker log. We will see the long name as :\nstorm.worker.<topoName>.<hostname>.<compId>.<taskId>.<port>.<metric-name>\nThe compId part now reflects the correct component for the taskId.\n2020-08-04 14:22:44.911 c.c.m.ConsoleReporter metrics-console-reporter-1-thread-1 [INFO] storm.worker.wc1-1-1596568923.192_168_0_19.count.10.6700-receive-queue-pct_full\n2020-08-04 14:22:44.911 c.c.m.ConsoleReporter metrics-console-reporter-1-thread-1 [INFO]              value = 0.0\n2020-08-04 14:22:44.912 c.c.m.ConsoleReporter metrics-console-reporter-1-thread-1 [INFO] storm.worker.wc1-1-1596568923.192_168_0_19.count.10.6700-receive-queue-population\n2020-08-04 14:22:44.912 c.c.m.ConsoleReporter metrics-console-reporter-1-thread-1 [INFO]              value = 0\n2020-08-04 14:22:44.912 c.c.m.ConsoleReporter metrics-console-reporter-1-thread-1 [INFO] storm.worker.wc1-1-1596568923.192_168_0_19.count.10.6700-receive-queue-sojourn_time_ms\n2020-08-04 14:22:44.912 c.c.m.ConsoleReporter metrics-console-reporter-1-thread-1 [INFO]              value = 0.0", "createdAt": "2020-08-04T19:38:12Z", "url": "https://github.com/apache/storm/pull/3320", "merged": true, "mergeCommit": {"oid": "e82b9a707db38a814dbd2d8f85eeaac0fda0b75b"}, "closed": true, "closedAt": "2020-08-07T17:59:05Z", "author": {"login": "RuiLi8080"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7sXSCAFqTQ2MTEzNjI2Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8SDTLAFqTQ2MjY2MDc0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMTM2MjY2", "url": "https://github.com/apache/storm/pull/3320#pullrequestreview-461136266", "createdAt": "2020-08-04T20:08:52Z", "commit": {"oid": "8825ed5f881ad30473d6402866794e8b5765b054"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMDowODo1MlrOG7vu-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMDowODo1MlrOG7vu-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMwMTI0Mg==", "bodyText": "Is it possible to reuse this.taskToComponent?", "url": "https://github.com/apache/storm/pull/3320#discussion_r465301242", "createdAt": "2020-08-04T20:08:52Z", "author": {"login": "Ethanlm"}, "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/WorkerState.java", "diffHunk": "@@ -717,11 +718,20 @@ private Assignment getLocalAssignment(IStormClusterState stormClusterState, Stri\n \n         IWaitStrategy backPressureWaitStrategy = IWaitStrategy.createBackPressureWaitStrategy(topologyConf);\n         Map<List<Long>, JCQueue> receiveQueueMap = new HashMap<>();\n+\n+        Map<Integer, String> taskIdToCompId = StormCommon.stormTaskInfo(topology, topologyConf);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8825ed5f881ad30473d6402866794e8b5765b054"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMTM2NDc0", "url": "https://github.com/apache/storm/pull/3320#pullrequestreview-461136474", "createdAt": "2020-08-04T20:09:10Z", "commit": {"oid": "8825ed5f881ad30473d6402866794e8b5765b054"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMDowOToxMFrOG7vvpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMDowOToxMFrOG7vvpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMwMTQxNA==", "bodyText": "anything specific to this change?", "url": "https://github.com/apache/storm/pull/3320#discussion_r465301414", "createdAt": "2020-08-04T20:09:10Z", "author": {"login": "Ethanlm"}, "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/WorkerState.java", "diffHunk": "@@ -199,7 +200,6 @@ public WorkerState(Map<String, Object> conf,\n         }\n         Collections.sort(localTaskIds);\n         this.topologyConf = topologyConf;\n-        this.topology = ConfigUtils.readSupervisorTopology(conf, topologyId, AdvancedFSOps.make(conf));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8825ed5f881ad30473d6402866794e8b5765b054"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "036e9b37dadc7ca34f1844af6eb2d46742e1329a", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/036e9b37dadc7ca34f1844af6eb2d46742e1329a", "committedDate": "2020-08-05T05:52:46Z", "message": "[STORM-3684] use real compId instead of constant _system for receive-queue V2 metrics"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8825ed5f881ad30473d6402866794e8b5765b054", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/8825ed5f881ad30473d6402866794e8b5765b054", "committedDate": "2020-08-04T19:31:35Z", "message": "[STORM-3684] use real compId instead of constant _system for receive-queue V2 metrics"}, "afterCommit": {"oid": "036e9b37dadc7ca34f1844af6eb2d46742e1329a", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/036e9b37dadc7ca34f1844af6eb2d46742e1329a", "committedDate": "2020-08-05T05:52:46Z", "message": "[STORM-3684] use real compId instead of constant _system for receive-queue V2 metrics"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNzAyMTE4", "url": "https://github.com/apache/storm/pull/3320#pullrequestreview-461702118", "createdAt": "2020-08-05T14:10:13Z", "commit": {"oid": "036e9b37dadc7ca34f1844af6eb2d46742e1329a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNDoxMDoxM1rOG8LbZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNDoxMzowM1rOG8LjCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc1NDk4MQ==", "bodyText": "I would change mkReceiveQueueMap method to include taskToComponent parameter to make this relationship more obvious  (and then we can remove the comment)", "url": "https://github.com/apache/storm/pull/3320#discussion_r465754981", "createdAt": "2020-08-05T14:10:13Z", "author": {"login": "Ethanlm"}, "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/WorkerState.java", "diffHunk": "@@ -186,6 +186,9 @@ public WorkerState(Map<String, Object> conf,\n         this.isWorkerActive = new CountDownLatch(1);\n         this.isTopologyActive = new AtomicBoolean(false);\n         this.stormComponentToDebug = new AtomicReference<>();\n+        this.topology = ConfigUtils.readSupervisorTopology(conf, topologyId, AdvancedFSOps.make(conf));\n+        this.taskToComponent = StormCommon.stormTaskInfo(topology, topologyConf);\n+        // mkReceiveQueueMap relies on taskToComponent which relies on topology above", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "036e9b37dadc7ca34f1844af6eb2d46742e1329a"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc1NjkzOA==", "bodyText": "I would  use SYSTEM_TASK_ID instead of -1", "url": "https://github.com/apache/storm/pull/3320#discussion_r465756938", "createdAt": "2020-08-05T14:13:03Z", "author": {"login": "Ethanlm"}, "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/WorkerState.java", "diffHunk": "@@ -717,11 +719,19 @@ private Assignment getLocalAssignment(IStormClusterState stormClusterState, Stri\n \n         IWaitStrategy backPressureWaitStrategy = IWaitStrategy.createBackPressureWaitStrategy(topologyConf);\n         Map<List<Long>, JCQueue> receiveQueueMap = new HashMap<>();\n+\n         for (List<Long> executor : executors) {\n             List<Integer> taskIds = StormCommon.executorIdToTasks(executor);\n+            int taskId = taskIds.get(0);\n+            String compId;\n+            if (taskId == -1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "036e9b37dadc7ca34f1844af6eb2d46742e1329a"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf68fa20c95177ff8abe2af6444f6ef4c7777db3", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/bf68fa20c95177ff8abe2af6444f6ef4c7777db3", "committedDate": "2020-08-05T15:15:26Z", "message": "address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5abc62090741f50548a0625d3db7ef22a1a7b9cd", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/5abc62090741f50548a0625d3db7ef22a1a7b9cd", "committedDate": "2020-08-05T15:01:39Z", "message": "address comments"}, "afterCommit": {"oid": "bf68fa20c95177ff8abe2af6444f6ef4c7777db3", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/bf68fa20c95177ff8abe2af6444f6ef4c7777db3", "committedDate": "2020-08-05T15:15:26Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxODI5MzE2", "url": "https://github.com/apache/storm/pull/3320#pullrequestreview-461829316", "createdAt": "2020-08-05T16:28:14Z", "commit": {"oid": "bf68fa20c95177ff8abe2af6444f6ef4c7777db3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNjoyODoxNFrOG8RWOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNjoyODoxNFrOG8RWOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg1MTk2Mg==", "bodyText": "Should StormCommon.stormTaskInfo() be addressing this mapping?", "url": "https://github.com/apache/storm/pull/3320#discussion_r465851962", "createdAt": "2020-08-05T16:28:14Z", "author": {"login": "agresch"}, "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/WorkerState.java", "diffHunk": "@@ -717,11 +718,19 @@ private Assignment getLocalAssignment(IStormClusterState stormClusterState, Stri\n \n         IWaitStrategy backPressureWaitStrategy = IWaitStrategy.createBackPressureWaitStrategy(topologyConf);\n         Map<List<Long>, JCQueue> receiveQueueMap = new HashMap<>();\n+\n         for (List<Long> executor : executors) {\n             List<Integer> taskIds = StormCommon.executorIdToTasks(executor);\n+            int taskId = taskIds.get(0);\n+            String compId;\n+            if (taskId == Constants.SYSTEM_TASK_ID) {\n+                compId = Constants.SYSTEM_COMPONENT_ID;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf68fa20c95177ff8abe2af6444f6ef4c7777db3"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMDU5NjI5", "url": "https://github.com/apache/storm/pull/3320#pullrequestreview-462059629", "createdAt": "2020-08-05T22:11:56Z", "commit": {"oid": "bf68fa20c95177ff8abe2af6444f6ef4c7777db3"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQyMjoxMTo1NlrOG8caSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQyMjoxMTo1NlrOG8caSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAzMzIyNA==", "bodyText": "nit: space", "url": "https://github.com/apache/storm/pull/3320#discussion_r466033224", "createdAt": "2020-08-05T22:11:56Z", "author": {"login": "Ethanlm"}, "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/WorkerState.java", "diffHunk": "@@ -704,7 +704,8 @@ private Assignment getLocalAssignment(IStormClusterState stormClusterState, Stri\n         }\n     }\n \n-    private Map<List<Long>, JCQueue> mkReceiveQueueMap(Map<String, Object> topologyConf, Set<List<Long>> executors) {\n+    private Map<List<Long>, JCQueue> mkReceiveQueueMap(Map<String, Object> topologyConf,\n+                                                       Set<List<Long>> executors,  Map<Integer, String> taskToComponent) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf68fa20c95177ff8abe2af6444f6ef4c7777db3"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbe511a7dbd047524c23167fe8011412b2a9637d", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/dbe511a7dbd047524c23167fe8011412b2a9637d", "committedDate": "2020-08-06T15:15:12Z", "message": "fix space"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNjU1MjA2", "url": "https://github.com/apache/storm/pull/3320#pullrequestreview-462655206", "createdAt": "2020-08-06T15:56:53Z", "commit": {"oid": "dbe511a7dbd047524c23167fe8011412b2a9637d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNjYwNzQw", "url": "https://github.com/apache/storm/pull/3320#pullrequestreview-462660740", "createdAt": "2020-08-06T16:03:26Z", "commit": {"oid": "dbe511a7dbd047524c23167fe8011412b2a9637d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4903, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}