{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzODM2OTU5", "number": 3195, "title": "[STORM-3567] fix UI showing wrong resource info when topo is not scheduled", "bodyText": "Currently topology UI page is showing wrong resource request info if the topo is not scheduled.\nThis PR:\n\nFix the getTopologyPageInfo method to calculate the correct resource map even if they are not populated yet\nRename the component-level resource_map related keys in order to prevent name collision of mustache.render. Now even if the client failed to retrieve the data for resources, it will be left blank instead of getting same named value from topology level.\n\nExample: this wc2 topo is not scheduled and the assigned on-heap mem is 0. Now the components are showing the right requested value.", "createdAt": "2020-01-16T20:44:10Z", "url": "https://github.com/apache/storm/pull/3195", "merged": true, "mergeCommit": {"oid": "d415da5f6b6506030207f06c77f72833d6e53f0c"}, "closed": true, "closedAt": "2020-01-23T16:07:52Z", "author": {"login": "RuiLi8080"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb7VznrgFqTM0NDg0Nzk2MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb9MosSgFqTM0NzQxOTI4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0ODQ3OTYx", "url": "https://github.com/apache/storm/pull/3195#pullrequestreview-344847961", "createdAt": "2020-01-17T21:21:34Z", "commit": {"oid": "1f4dd374cb7a5ea5804d4d5a4fe1d95a70b0e1f4"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMToyMTozNFrOFfFkIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMToyMjowN1rOFfFkyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE0MTM0Ng==", "bodyText": "Nit: Java doc is missing @param topology topoConf", "url": "https://github.com/apache/storm/pull/3195#discussion_r368141346", "createdAt": "2020-01-17T21:21:34Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java", "diffHunk": "@@ -4242,20 +4231,30 @@ public TopologyPageInfo getTopologyPageInfo(String topoId, String window, boolea\n     }\n \n     /**\n-     * Add placeholder AggStats allowing topology page to show components before AggStats are populated.\n+     * If aggStats are not populated, compute common and component(spout) agg and create placeholder stat.\n+     * This allow the topology page to show component spec even the topo is not scheduled.\n+     * Otherwise, just fetch data from current topoPageInfo.\n      *\n      * @param topoPageInfo topology page info holding spout AggStats\n      * @param topology     storm topology used to get spout names\n      */\n-    private void maybeAddPlaceholderSpoutAggStats(TopologyPageInfo topoPageInfo, StormTopology topology) {\n+    private void addSpoutAggStats(TopologyPageInfo topoPageInfo, StormTopology topology, Map<String, Object> topoConf) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f4dd374cb7a5ea5804d4d5a4fe1d95a70b0e1f4"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE0MTUxNA==", "bodyText": "nit: missing javadoc @param topoConf", "url": "https://github.com/apache/storm/pull/3195#discussion_r368141514", "createdAt": "2020-01-17T21:22:07Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java", "diffHunk": "@@ -4264,23 +4263,35 @@ private void maybeAddPlaceholderSpoutAggStats(TopologyPageInfo topoPageInfo, Sto\n                 SpecificAggregateStats specificStats = new SpecificAggregateStats();\n                 specificStats.set_spout(spoutAggStats);\n                 placeholderComponentStats.set_specific_stats(specificStats);\n-\n-                topoPageInfo.get_id_to_spout_agg_stats().put(entry.getKey(), placeholderComponentStats);\n+                topoPageInfo.get_id_to_spout_agg_stats().put(spoutName, placeholderComponentStats);\n+            }\n+        } else {\n+            for (Entry<String, ComponentAggregateStats> entry : topoPageInfo.get_id_to_spout_agg_stats().entrySet()) {\n+                CommonAggregateStats commonStats = entry.getValue().get_common_stats();\n+                setResourcesDefaultIfNotSet(spoutResources, entry.getKey(), topoConf);\n+                commonStats.set_resources_map(spoutResources.get(entry.getKey()).toNormalizedMap());\n             }\n         }\n     }\n \n     /**\n-     * Add placeholder AggStats allowing topology page to show components before AggStats are populated.\n+     * If aggStats are not populated, compute common and component(bolt) agg and create placeholder stat.\n+     * This allow the topology page to show component spec even the topo is not scheduled.\n+     * Otherwise, just fetch data from current topoPageInfo.\n      *\n      * @param topoPageInfo  topology page info holding bolt AggStats\n      * @param topology      storm topology used to get bolt names\n      * @param includeSys    whether to show system bolts\n      */\n-    private void maybeAddPlaceholderBoltAggStats(TopologyPageInfo topoPageInfo, StormTopology topology, boolean includeSys) {\n+    private void addBoltAggStats(TopologyPageInfo topoPageInfo, StormTopology topology,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f4dd374cb7a5ea5804d4d5a4fe1d95a70b0e1f4"}, "originalPosition": 87}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc47a748948e0588cfbce2e9d5f20a3b682a27eb", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/bc47a748948e0588cfbce2e9d5f20a3b682a27eb", "committedDate": "2020-01-17T21:59:25Z", "message": "[STORM-3567] fix UI showing wrong resource info when topo is not scheduled"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1f4dd374cb7a5ea5804d4d5a4fe1d95a70b0e1f4", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/1f4dd374cb7a5ea5804d4d5a4fe1d95a70b0e1f4", "committedDate": "2020-01-16T20:35:17Z", "message": "[STORM-3567] fix UI showing wrong resource info when topo is not scheduled"}, "afterCommit": {"oid": "bc47a748948e0588cfbce2e9d5f20a3b682a27eb", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/bc47a748948e0588cfbce2e9d5f20a3b682a27eb", "committedDate": "2020-01-17T21:59:25Z", "message": "[STORM-3567] fix UI showing wrong resource info when topo is not scheduled"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0ODY1NDMz", "url": "https://github.com/apache/storm/pull/3195#pullrequestreview-344865433", "createdAt": "2020-01-17T22:02:00Z", "commit": {"oid": "bc47a748948e0588cfbce2e9d5f20a3b682a27eb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c43754f8e0b7851e994f1777a5af1478f2124aa0", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/c43754f8e0b7851e994f1777a5af1478f2124aa0", "committedDate": "2020-01-21T19:14:36Z", "message": "revert mustache fix since name collision wouldn't happen with the nimbus changes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "93ac57b7f14b84037723f3dc9fdd6824073c1e73", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/93ac57b7f14b84037723f3dc9fdd6824073c1e73", "committedDate": "2020-01-21T19:12:40Z", "message": "revert mustache fix since name collision wouldn't happen with the nimbus changes"}, "afterCommit": {"oid": "c43754f8e0b7851e994f1777a5af1478f2124aa0", "author": {"user": {"login": "RuiLi8080", "name": "Rui Li"}}, "url": "https://github.com/apache/storm/commit/c43754f8e0b7851e994f1777a5af1478f2124aa0", "committedDate": "2020-01-21T19:14:36Z", "message": "revert mustache fix since name collision wouldn't happen with the nimbus changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3NDE5Mjgw", "url": "https://github.com/apache/storm/pull/3195#pullrequestreview-347419280", "createdAt": "2020-01-23T16:07:37Z", "commit": {"oid": "c43754f8e0b7851e994f1777a5af1478f2124aa0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4651, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}