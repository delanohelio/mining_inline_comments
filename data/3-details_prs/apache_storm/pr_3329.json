{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4MDczODcw", "number": 3329, "title": "STORM-3694 allow reporting V2 metrics with dimensions and short names", "bodyText": "What is the purpose of the change\nAllow V2 metric reporters to report metrics with long names or with a short name and set of dimensions.  ConsoleStormReporter was modified to allow both options.\nLong metric names get stored in a metrics registry as previously.  Additionally, we create a map of Task/component/stream dimensions to a TaskMetricRepo that contains task specific metrics.\nIf a reporter supports and is configured for short metric names, it will receive the metrics one repo at a time, first setting the dimensions for the repo, and then reporting the metrics for that Task set.\nHow was the change tested\nRan a topology with ConsoleStormReporters set to report both long and short metrics.\n./bin/storm jar ~/storm/storm-starter.jar org.apache.storm.starter.WordCountTopology wc -c topology.metrics.consumer.register=\"[{\"argument\":null,\"class\":\"org.apache.storm.metric.LoggingMetricsConsumer\",\"parallelism.hint\":1}]\" -c topology.metrics.reporters=\"[{\"report.period\": 11,\"class\": \"org.apache.storm.metrics2.reporters.ConsoleStormReporter\", \"report.dimensions.enabled\": true }, { \"report.period\": 9, \"class\": \"org.apache.storm.metrics2.reporters.ConsoleStormReporter\", \"report.dimensions.enabled\": false } ]\"\nlong metric name logging:\n2020-09-02 13:10:01.280 c.c.m.ConsoleReporter metrics-console-reporter-3-thread-1 [INFO] storm.topology.wc-1-1599070178.worker_hostname.__system.-1.6701-memory.pools.PS-Old-Gen.committed\n2020-09-02 13:10:01.280 c.c.m.ConsoleReporter metrics-console-reporter-3-thread-1 [INFO]              value = 133693440\n2020-09-02 13:10:01.281 c.c.m.ConsoleReporter metrics-console-reporter-3-thread-1 [INFO] storm.topology.wc-1-1599070178.worker_hostname.__system.-1.6701-memory.pools.PS-Old-Gen.init\n2020-09-02 13:10:01.281 c.c.m.ConsoleReporter metrics-console-reporter-3-thread-1 [INFO]              value = 179306496\n2020-09-02 13:10:01.281 c.c.m.ConsoleReporter metrics-console-reporter-3-thread-1 [INFO] storm.topology.wc-1-1599070178.worker_hostname.__system.-1.6701-memory.pools.PS-Old-Gen.max\n2020-09-02 13:10:01.281 c.c.m.ConsoleReporter metrics-console-reporter-3-thread-1 [INFO]              value = 894959616\n\nShort metric names with dimensions:\n2020-09-02 13:10:03.259 o.a.s.m.r.ConsoleStormReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] Using dimensions: \n2020-09-02 13:10:03.260 o.a.s.m.r.ConsoleStormReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] hostname : worker_hostname\n2020-09-02 13:10:03.260 o.a.s.m.r.ConsoleStormReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] componentId : count\n2020-09-02 13:10:03.260 o.a.s.m.r.ConsoleStormReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] topologyName : wc\n2020-09-02 13:10:03.260 o.a.s.m.r.ConsoleStormReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] streamId : default\n2020-09-02 13:10:03.261 o.a.s.m.r.ConsoleStormReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] port : 6701\n2020-09-02 13:10:03.261 o.a.s.m.r.ConsoleStormReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] taskid : 11\n2020-09-02 13:10:03.261 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] 9/2/20 1:10:03 PM ==============================================================\n2020-09-02 13:10:03.261 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] \n2020-09-02 13:10:03.261 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] -- Counters --------------------------------------------------------------------\n2020-09-02 13:10:03.261 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] __ack-count-split:default\n2020-09-02 13:10:03.261 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO]              count = 200\n2020-09-02 13:10:03.261 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] __emit-count-default\n2020-09-02 13:10:03.262 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO]              count = 200\n2020-09-02 13:10:03.262 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] __execute-count-split:default\n2020-09-02 13:10:03.262 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO]              count = 180\n2020-09-02 13:10:03.262 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] __transfer-count-default\n2020-09-02 13:10:03.262 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO]              count = 0\n2020-09-02 13:10:03.262 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO]\n2020-09-02 13:10:03.262 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO]    \n2020-09-02 13:10:03.262 o.a.s.m.r.ConsoleStormReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] Using dimensions: \n2020-09-02 13:10:03.262 o.a.s.m.r.ConsoleStormReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] hostname : worker_hostname\n2020-09-02 13:10:03.262 o.a.s.m.r.ConsoleStormReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] componentId : spout\n2020-09-02 13:10:03.263 o.a.s.m.r.ConsoleStormReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] topologyName : wc\n2020-09-02 13:10:03.263 o.a.s.m.r.ConsoleStormReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] port : 6701\n2020-09-02 13:10:03.263 o.a.s.m.r.ConsoleStormReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] taskid : 26\n2020-09-02 13:10:03.263 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] 9/2/20 1:10:03 PM ==============================================================\n2020-09-02 13:10:03.263 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO]\n2020-09-02 13:10:03.263 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] -- Gauges ----------------------------------------------------------------------\n2020-09-02 13:10:03.263 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] receive-queue-arrival_rate_secs\n2020-09-02 13:10:03.263 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO]              value = 0.0\n2020-09-02 13:10:03.263 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] receive-queue-capacity\n2020-09-02 13:10:03.264 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO]              value = 32768\n2020-09-02 13:10:03.264 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] receive-queue-dropped_messages\n2020-09-02 13:10:03.264 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO]              value = 0\n2020-09-02 13:10:03.264 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] receive-queue-insert_failures\n2020-09-02 13:10:03.264 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO]              value = 0.0\n2020-09-02 13:10:03.264 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] receive-queue-overflow\n2020-09-02 13:10:03.264 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO]              value = 0\n2020-09-02 13:10:03.264 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] receive-queue-pct_full\n2020-09-02 13:10:03.264 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO]              value = 0.0\n2020-09-02 13:10:03.265 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] receive-queue-population\n2020-09-02 13:10:03.265 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO]              value = 0\n2020-09-02 13:10:03.265 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO] receive-queue-sojourn_time_ms\n2020-09-02 13:10:03.265 c.c.m.ConsoleReporter metrics-ConsoleDimensionalReporter-2-thread-1 [INFO]              value = 0.0", "createdAt": "2020-09-02T18:38:36Z", "url": "https://github.com/apache/storm/pull/3329", "merged": true, "mergeCommit": {"oid": "39a6fba632a70f1d4684489b5b4dc6cb98a34662"}, "closed": true, "closedAt": "2020-09-21T18:28:50Z", "author": {"login": "agresch"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJOjeDAFqTQ4OTA5NzI5Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdKJhl_gFqTQ5MTY3NTYzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5MDk3Mjky", "url": "https://github.com/apache/storm/pull/3329#pullrequestreview-489097292", "createdAt": "2020-09-15T21:19:58Z", "commit": {"oid": "4f9fa7d97e202bd042fc9f510ea53448e23facb3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwMTk2MTU1", "url": "https://github.com/apache/storm/pull/3329#pullrequestreview-490196155", "createdAt": "2020-09-17T02:13:23Z", "commit": {"oid": "4f9fa7d97e202bd042fc9f510ea53448e23facb3"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwMjoxMzoyM1rOHTMGpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwNTozNjoxMVrOHTSGbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg4MzMwMA==", "bodyText": "Why do we need synchronized?\nIf there are two threads trying to register the same metric,\nline198 gauge = registry.register(metricNames.getLongName(), gauge); will throw IllegalArgumentException. (what's interesting is if registry.gauge() or registry.meter() etc. method is invoked, it will check and return the existing object if possible)\nIt implies this registerGauge can only be invoked once for each long name.", "url": "https://github.com/apache/storm/pull/3329#discussion_r489883300", "createdAt": "2020-09-17T02:13:23Z", "author": {"login": "Ethanlm"}, "path": "storm-client/src/jvm/org/apache/storm/metrics2/StormMetricRegistry.java", "diffHunk": "@@ -171,6 +188,59 @@ public Histogram histogram(String name, TopologyContext context) {\n         metrics.put(names.getV2TickName(), metric);\n     }\n \n+    private <T> Gauge<T> registerGauge(String name, MetricNames metricNames, Gauge<T> gauge, int taskId,\n+                                       String componentId, String streamId) {\n+        TaskMetricDimensions taskMetricDimensions = new TaskMetricDimensions(taskId, componentId, streamId, this);\n+        synchronized (this) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f9fa7d97e202bd042fc9f510ea53448e23facb3"}, "originalPosition": 173}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg4NDE5MQ==", "bodyText": "Can we use metricNames.getV2TickName instead of name? It seems code duplication to pass this name parameter?\nI would also change metricNames.getV2TickName to metricNames.getShortName since it is not only about v2 tick anymore.\nAnd we need to update comments at https://github.com/apache/storm/blob/master/storm-client/src/jvm/org/apache/storm/metrics2/StormMetricRegistry.java#L316-L317", "url": "https://github.com/apache/storm/pull/3329#discussion_r489884191", "createdAt": "2020-09-17T02:14:46Z", "author": {"login": "Ethanlm"}, "path": "storm-client/src/jvm/org/apache/storm/metrics2/StormMetricRegistry.java", "diffHunk": "@@ -171,6 +188,59 @@ public Histogram histogram(String name, TopologyContext context) {\n         metrics.put(names.getV2TickName(), metric);\n     }\n \n+    private <T> Gauge<T> registerGauge(String name, MetricNames metricNames, Gauge<T> gauge, int taskId,\n+                                       String componentId, String streamId) {\n+        TaskMetricDimensions taskMetricDimensions = new TaskMetricDimensions(taskId, componentId, streamId, this);\n+        synchronized (this) {\n+            TaskMetricRepo repo = taskMetrics.computeIfAbsent(taskMetricDimensions, (k) -> new TaskMetricRepo());\n+            repo.addGauge(name, gauge);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f9fa7d97e202bd042fc9f510ea53448e23facb3"}, "originalPosition": 175}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTk2ODU1NA==", "bodyText": "The interface change is concerning. It breaks backwards compatibility.", "url": "https://github.com/apache/storm/pull/3329#discussion_r489968554", "createdAt": "2020-09-17T04:49:06Z", "author": {"login": "Ethanlm"}, "path": "storm-client/src/jvm/org/apache/storm/metrics2/reporters/StormReporter.java", "diffHunk": "@@ -15,12 +15,15 @@\n import com.codahale.metrics.MetricRegistry;\n import com.codahale.metrics.Reporter;\n import java.util.Map;\n+import org.apache.storm.metrics2.StormMetricRegistry;\n \n public interface StormReporter extends Reporter {\n     String REPORT_PERIOD = \"report.period\";\n     String REPORT_PERIOD_UNITS = \"report.period.units\";\n+    String REPORT_DIMENSIONS_ENABLED = \"report.dimensions.enabled\";\n \n-    void prepare(MetricRegistry metricsRegistry, Map<String, Object> topoConf, Map<String, Object> reporterConf);\n+    void prepare(MetricRegistry metricsRegistry, Map<String, Object> topoConf, Map<String, Object> reporterConf,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f9fa7d97e202bd042fc9f510ea53448e23facb3"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTk3NDEzMg==", "bodyText": "I would suggest to change this to getReportDimensionsEnabled or isReportDimensionsEnabled", "url": "https://github.com/apache/storm/pull/3329#discussion_r489974132", "createdAt": "2020-09-17T05:10:21Z", "author": {"login": "Ethanlm"}, "path": "storm-client/src/jvm/org/apache/storm/metrics2/reporters/ScheduledStormReporter.java", "diffHunk": "@@ -37,6 +37,10 @@ public static long getReportPeriod(Map<String, Object> reporterConf) {\n         return ObjectReader.getInt(reporterConf.get(REPORT_PERIOD), 10).longValue();\n     }\n \n+    public static boolean getReportDimensions(Map<String, Object> reporterConf) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f9fa7d97e202bd042fc9f510ea53448e23facb3"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTk4MTU1MA==", "bodyText": "should we use  topologyId since we use topologyId in the long name", "url": "https://github.com/apache/storm/pull/3329#discussion_r489981550", "createdAt": "2020-09-17T05:36:11Z", "author": {"login": "Ethanlm"}, "path": "storm-client/src/jvm/org/apache/storm/metrics2/StormMetricRegistry.java", "diffHunk": "@@ -198,14 +268,17 @@ public Histogram histogram(String name, TopologyContext context) {\n         return getMetricNameMap(taskId, taskIdTimers);\n     }\n \n-    public void start(Map<String, Object> topoConf) {\n+    public void start(Map<String, Object> topoConf, int port) {\n         try {\n             hostName = dotToUnderScore(Utils.localHostname());\n         } catch (UnknownHostException e) {\n             LOG.warn(\"Unable to determine hostname while starting the metrics system. Hostname will be reported\"\n                      + \" as 'localhost'.\");\n         }\n \n+        this.topologyName = (String) topoConf.get(Config.TOPOLOGY_NAME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f9fa7d97e202bd042fc9f510ea53448e23facb3"}, "originalPosition": 239}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwOTUyNTI5", "url": "https://github.com/apache/storm/pull/3329#pullrequestreview-490952529", "createdAt": "2020-09-17T20:11:38Z", "commit": {"oid": "9de9581b1198b60f4d69976f0a1becbd7fb84607"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMDoxNTozMFrOHTz6Zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMDoyNjoyNVrOHT0RPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUzNTUyNw==", "bodyText": "Looks like this can be removed too since if there is name collision, the code in registry.register  will throw IllegalArgumentException", "url": "https://github.com/apache/storm/pull/3329#discussion_r490535527", "createdAt": "2020-09-17T20:15:30Z", "author": {"login": "Ethanlm"}, "path": "storm-client/src/jvm/org/apache/storm/metrics2/StormMetricRegistry.java", "diffHunk": "@@ -181,62 +178,52 @@ public void metricSet(String prefix, MetricSet set, TopologyContext context) {\n     private static <T extends Metric> void saveMetricTaskIdMapping(Integer taskId, MetricNames names, T metric, Map<Integer,\n             Map<String, T>> taskIdMetrics) {\n         Map<String, T> metrics = taskIdMetrics.computeIfAbsent(taskId, (tid) -> new HashMap<>());\n-        if (metrics.get(names.getV2TickName()) != null) {\n+        if (metrics.get(names.getShortName()) != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9de9581b1198b60f4d69976f0a1becbd7fb84607"}, "originalPosition": 150}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU0MTM3Mw==", "bodyText": "looks like this line can be removed", "url": "https://github.com/apache/storm/pull/3329#discussion_r490541373", "createdAt": "2020-09-17T20:26:25Z", "author": {"login": "Ethanlm"}, "path": "storm-client/src/jvm/org/apache/storm/metrics2/StormMetricRegistry.java", "diffHunk": "@@ -50,125 +50,182 @@\n     private final ConcurrentMap<Integer, Map<String, Counter>> taskIdCounters = new ConcurrentHashMap<>();\n     private final ConcurrentMap<Integer, Map<String, Timer>> taskIdTimers = new ConcurrentHashMap<>();\n     private final ConcurrentMap<Integer, Map<String, Histogram>> taskIdHistograms = new ConcurrentHashMap<>();\n+    private final ConcurrentMap<TaskMetricDimensions, TaskMetricRepo> taskMetrics = new ConcurrentHashMap<>();\n     private String hostName = null;\n+    private int port = -1;\n+    private String topologyId = null;\n \n     public <T> SimpleGauge<T> gauge(\n         T initialValue, String name, String topologyId, String componentId, Integer taskId, Integer port) {\n+        Gauge gauge = new SimpleGauge<>(initialValue);\n         MetricNames metricNames = workerMetricName(name, topologyId, componentId, taskId, port);\n-        Gauge gauge = registry.gauge(metricNames.getLongName(), () -> new SimpleGauge<>(initialValue));\n+        gauge = registerGauge(metricNames, gauge, taskId, componentId, null);\n         saveMetricTaskIdMapping(taskId, metricNames, gauge, taskIdGauges);\n         return (SimpleGauge<T>) gauge;\n     }\n \n     public <T> Gauge<T> gauge(String name, Gauge<T> gauge, TopologyContext context) {\n         MetricNames metricNames = topologyMetricName(name, context);\n-        gauge = registry.register(metricNames.getLongName(), gauge);\n+        gauge = registerGauge(metricNames, gauge, context.getThisTaskId(), context.getThisComponentId(), null);\n         saveMetricTaskIdMapping(context.getThisTaskId(), metricNames, gauge, taskIdGauges);\n         return gauge;\n     }\n \n     public <T> Gauge<T> gauge(String name, Gauge<T> gauge, String topologyId, String componentId, Integer taskId, Integer port) {\n         MetricNames metricNames = workerMetricName(name, topologyId, componentId, taskId, port);\n-        gauge = registry.register(metricNames.getLongName(), gauge);\n+        gauge = registerGauge(metricNames, gauge, taskId, componentId, null);\n         saveMetricTaskIdMapping(taskId, metricNames, gauge, taskIdGauges);\n         return gauge;\n     }\n \n     public <T> Gauge<T> gauge(String name, Gauge<T> gauge, String topologyId, String componentId,\n                               String streamId, Integer taskId, Integer port) {\n         MetricNames metricNames = workerMetricName(name, topologyId, componentId, streamId, taskId, port);\n-        gauge = registry.register(metricNames.getLongName(), gauge);\n+        gauge = registerGauge(metricNames, gauge, taskId, componentId, streamId);\n         saveMetricTaskIdMapping(taskId, metricNames, gauge, taskIdGauges);\n         return gauge;\n     }\n \n     public Meter meter(String name, WorkerTopologyContext context, String componentId, Integer taskId, String streamId) {\n         MetricNames metricNames = workerMetricName(name, context.getStormId(), componentId, streamId, taskId, context.getThisWorkerPort());\n-        Meter meter = registry.meter(metricNames.getLongName());\n+        Meter meter = registerMeter(metricNames, new Meter(), taskId, componentId, streamId);\n         saveMetricTaskIdMapping(taskId, metricNames, meter, taskIdMeters);\n         return meter;\n     }\n \n     public Meter meter(String name, WorkerTopologyContext context, String componentId, Integer taskId) {\n         MetricNames metricNames = workerMetricName(name, context.getStormId(), componentId, taskId, context.getThisWorkerPort());\n-        Meter meter = registry.meter(metricNames.getLongName());\n+        Meter meter = registerMeter(metricNames, new Meter(), taskId, componentId, null);\n         saveMetricTaskIdMapping(taskId, metricNames, meter, taskIdMeters);\n         return meter;\n     }\n \n     public Meter meter(String name, TopologyContext context) {\n         MetricNames metricNames = topologyMetricName(name, context);\n-        Meter meter = registry.meter(metricNames.getLongName());\n+        Meter meter = registerMeter(metricNames, new Meter(), context.getThisTaskId(), context.getThisComponentId(), null);\n         saveMetricTaskIdMapping(context.getThisTaskId(), metricNames, meter, taskIdMeters);\n         return meter;\n     }\n \n     public Counter counter(String name, WorkerTopologyContext context, String componentId, Integer taskId, String streamId) {\n         MetricNames metricNames = workerMetricName(name, context.getStormId(), componentId, streamId, taskId, context.getThisWorkerPort());\n-        Counter counter = registry.counter(metricNames.getLongName());\n+        Counter counter = registerCounter(metricNames, new Counter(), taskId, componentId, streamId);\n         saveMetricTaskIdMapping(taskId, metricNames, counter, taskIdCounters);\n         return counter;\n     }\n \n     public Counter counter(String name, String topologyId, String componentId, Integer taskId, Integer workerPort, String streamId) {\n         MetricNames metricNames = workerMetricName(name, topologyId, componentId, streamId, taskId, workerPort);\n-        Counter counter = registry.counter(metricNames.getLongName());\n+        Counter counter = registerCounter(metricNames, new Counter(), taskId, componentId, streamId);\n         saveMetricTaskIdMapping(taskId, metricNames, counter, taskIdCounters);\n         return counter;\n     }\n \n     public Counter counter(String name, TopologyContext context) {\n         MetricNames metricNames = topologyMetricName(name, context);\n-        Counter counter = registry.counter(metricNames.getLongName());\n+        Counter counter = registerCounter(metricNames, new Counter(), context.getThisTaskId(), context.getThisComponentId(), null);\n         saveMetricTaskIdMapping(context.getThisTaskId(), metricNames, counter, taskIdCounters);\n         return counter;\n     }\n \n+    public Timer timer(String name, TopologyContext context) {\n+        MetricNames metricNames = topologyMetricName(name, context);\n+        Timer timer = registerTimer(metricNames, new Timer(), context.getThisTaskId(), context.getThisComponentId(), null);\n+        saveMetricTaskIdMapping(context.getThisTaskId(), metricNames, timer, taskIdTimers);\n+        return timer;\n+    }\n+\n+    public Histogram histogram(String name, TopologyContext context) {\n+        MetricNames metricNames = topologyMetricName(name, context);\n+        Histogram histogram = registerHistogram(metricNames, new Histogram(new ExponentiallyDecayingReservoir()),\n+                context.getThisTaskId(), context.getThisComponentId(), null);\n+        saveMetricTaskIdMapping(context.getThisTaskId(), metricNames, histogram, taskIdHistograms);\n+        return histogram;\n+    }\n+\n     public void metricSet(String prefix, MetricSet set, TopologyContext context) {\n         // Instead of registering the metrics as a set, register them individually.\n         // This allows fetching the individual metrics by type (getTaskGauges())\n         // to work as expected.\n+        TaskMetricDimensions taskMetricDimensions = new TaskMetricDimensions(context.getThisTaskId(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9de9581b1198b60f4d69976f0a1becbd7fb84607"}, "originalPosition": 127}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNjQ0Mzg0", "url": "https://github.com/apache/storm/pull/3329#pullrequestreview-491644384", "createdAt": "2020-09-18T17:13:17Z", "commit": {"oid": "57e4938c3c0fcb79b6d8a599f33e498ce55d895e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87f6b8796969488a1344bd9cd41264839e04afbe", "author": {"user": null}, "url": "https://github.com/apache/storm/commit/87f6b8796969488a1344bd9cd41264839e04afbe", "committedDate": "2020-09-18T17:38:01Z", "message": "STORM-3694 allow reporting V2 metrics with dimensions and short names"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "57e4938c3c0fcb79b6d8a599f33e498ce55d895e", "author": {"user": null}, "url": "https://github.com/apache/storm/commit/57e4938c3c0fcb79b6d8a599f33e498ce55d895e", "committedDate": "2020-09-18T16:54:00Z", "message": "STORM-3694 add MetricRegistryProvider to limit exposure to StormMetricRegistry"}, "afterCommit": {"oid": "87f6b8796969488a1344bd9cd41264839e04afbe", "author": {"user": null}, "url": "https://github.com/apache/storm/commit/87f6b8796969488a1344bd9cd41264839e04afbe", "committedDate": "2020-09-18T17:38:01Z", "message": "STORM-3694 allow reporting V2 metrics with dimensions and short names"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNjc1NjMw", "url": "https://github.com/apache/storm/pull/3329#pullrequestreview-491675630", "createdAt": "2020-09-18T18:02:19Z", "commit": {"oid": "87f6b8796969488a1344bd9cd41264839e04afbe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4922, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}