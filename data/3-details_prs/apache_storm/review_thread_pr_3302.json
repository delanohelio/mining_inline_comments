{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0MDA0OTk3", "number": 3302, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxODoyODowN1rOELzE8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxOTowNjoyMlrOENBTTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwODA2NjQyOnYy", "diffSide": "RIGHT", "path": "storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxODoyODowN1rOGtiiqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxOTowOTo1MFrOGtjzkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQwNTAzMg==", "bodyText": "This seems redundant", "url": "https://github.com/apache/storm/pull/3302#discussion_r450405032", "createdAt": "2020-07-06T18:28:07Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java", "diffHunk": "@@ -2676,6 +2676,14 @@ private void assertTopoActive(String topoName, boolean expectActive) throws NotA\n         return tryReadTopoConf(topoId, topoCache);\n     }\n \n+    private StormTopology tryReadTopologyFromName(final String topoName) throws NotAliveException,\n+            AuthorizationException, IOException {\n+        IStormClusterState state = stormClusterState;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9ddff4ebf06fbc1a77b325cdf0e4e738f3b02d7"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQyNTc0NQ==", "bodyText": "Indeed. But looks like this idiom is widely used in Nimbus.", "url": "https://github.com/apache/storm/pull/3302#discussion_r450425745", "createdAt": "2020-07-06T19:09:50Z", "author": {"login": "bipinprasad"}, "path": "storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java", "diffHunk": "@@ -2676,6 +2676,14 @@ private void assertTopoActive(String topoName, boolean expectActive) throws NotA\n         return tryReadTopoConf(topoId, topoCache);\n     }\n \n+    private StormTopology tryReadTopologyFromName(final String topoName) throws NotAliveException,\n+            AuthorizationException, IOException {\n+        IStormClusterState state = stormClusterState;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQwNTAzMg=="}, "originalCommit": {"oid": "c9ddff4ebf06fbc1a77b325cdf0e4e738f3b02d7"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwODA2ODU4OnYy", "diffSide": "RIGHT", "path": "storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxODoyODo1MFrOGtikBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxODoyOTo1OFrOGtimMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQwNTM4MA==", "bodyText": "This feels more like a IllegalArgumentException?", "url": "https://github.com/apache/storm/pull/3302#discussion_r450405380", "createdAt": "2020-07-06T18:28:50Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java", "diffHunk": "@@ -3370,8 +3378,18 @@ public void rebalance(String topoName, RebalanceOptions options)\n             checkAuthorization(topoName, topoConf, operation);\n             // Set principal in RebalanceOptions to nil because users are not suppose to set this\n             options.set_principal(null);\n+            // check if executor counts are correctly specified\n+            StormTopology stormTopology = tryReadTopologyFromName(topoName);\n+            Set<String> comps = new HashSet<>();\n+            comps.addAll(stormTopology.get_spouts().keySet());\n+            comps.addAll(stormTopology.get_bolts().keySet());\n             Map<String, Integer> execOverrides = options.is_set_num_executors() ? options.get_num_executors() : Collections.emptyMap();\n-            for (Integer value : execOverrides.values()) {\n+            for (Map.Entry<String, Integer> e: execOverrides.entrySet()) {\n+                String comp = e.getKey();\n+                Integer value = e.getValue();\n+                if (!comps.contains(comp)) {\n+                    throw new WrappedInvalidTopologyException(String.format(\"Component %s does not exist in topology %s\", comp, topoName));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9ddff4ebf06fbc1a77b325cdf0e4e738f3b02d7"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQwNTkzOQ==", "bodyText": "I noticed below is using WrappedInvalidTopologyException too. So that's fine.", "url": "https://github.com/apache/storm/pull/3302#discussion_r450405939", "createdAt": "2020-07-06T18:29:58Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java", "diffHunk": "@@ -3370,8 +3378,18 @@ public void rebalance(String topoName, RebalanceOptions options)\n             checkAuthorization(topoName, topoConf, operation);\n             // Set principal in RebalanceOptions to nil because users are not suppose to set this\n             options.set_principal(null);\n+            // check if executor counts are correctly specified\n+            StormTopology stormTopology = tryReadTopologyFromName(topoName);\n+            Set<String> comps = new HashSet<>();\n+            comps.addAll(stormTopology.get_spouts().keySet());\n+            comps.addAll(stormTopology.get_bolts().keySet());\n             Map<String, Integer> execOverrides = options.is_set_num_executors() ? options.get_num_executors() : Collections.emptyMap();\n-            for (Integer value : execOverrides.values()) {\n+            for (Map.Entry<String, Integer> e: execOverrides.entrySet()) {\n+                String comp = e.getKey();\n+                Integer value = e.getValue();\n+                if (!comps.contains(comp)) {\n+                    throw new WrappedInvalidTopologyException(String.format(\"Component %s does not exist in topology %s\", comp, topoName));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQwNTM4MA=="}, "originalCommit": {"oid": "c9ddff4ebf06fbc1a77b325cdf0e4e738f3b02d7"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwODA4MTcwOnYy", "diffSide": "RIGHT", "path": "storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxODozMjo1OFrOGtisNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxOTozMzo0MVrOGu2bUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQwNzQ3OA==", "bodyText": "What does rebalance do with system components like acker and metricConsumers?\nWill users be able to rebalance those?", "url": "https://github.com/apache/storm/pull/3302#discussion_r450407478", "createdAt": "2020-07-06T18:32:58Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java", "diffHunk": "@@ -3370,8 +3378,18 @@ public void rebalance(String topoName, RebalanceOptions options)\n             checkAuthorization(topoName, topoConf, operation);\n             // Set principal in RebalanceOptions to nil because users are not suppose to set this\n             options.set_principal(null);\n+            // check if executor counts are correctly specified\n+            StormTopology stormTopology = tryReadTopologyFromName(topoName);\n+            Set<String> comps = new HashSet<>();\n+            comps.addAll(stormTopology.get_spouts().keySet());\n+            comps.addAll(stormTopology.get_bolts().keySet());\n             Map<String, Integer> execOverrides = options.is_set_num_executors() ? options.get_num_executors() : Collections.emptyMap();\n-            for (Integer value : execOverrides.values()) {\n+            for (Map.Entry<String, Integer> e: execOverrides.entrySet()) {\n+                String comp = e.getKey();\n+                Integer value = e.getValue();\n+                if (!comps.contains(comp)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9ddff4ebf06fbc1a77b325cdf0e4e738f3b02d7"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQyODA4OQ==", "bodyText": "This check will preclude rebalancing system components.", "url": "https://github.com/apache/storm/pull/3302#discussion_r450428089", "createdAt": "2020-07-06T19:14:41Z", "author": {"login": "bipinprasad"}, "path": "storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java", "diffHunk": "@@ -3370,8 +3378,18 @@ public void rebalance(String topoName, RebalanceOptions options)\n             checkAuthorization(topoName, topoConf, operation);\n             // Set principal in RebalanceOptions to nil because users are not suppose to set this\n             options.set_principal(null);\n+            // check if executor counts are correctly specified\n+            StormTopology stormTopology = tryReadTopologyFromName(topoName);\n+            Set<String> comps = new HashSet<>();\n+            comps.addAll(stormTopology.get_spouts().keySet());\n+            comps.addAll(stormTopology.get_bolts().keySet());\n             Map<String, Integer> execOverrides = options.is_set_num_executors() ? options.get_num_executors() : Collections.emptyMap();\n-            for (Integer value : execOverrides.values()) {\n+            for (Map.Entry<String, Integer> e: execOverrides.entrySet()) {\n+                String comp = e.getKey();\n+                Integer value = e.getValue();\n+                if (!comps.contains(comp)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQwNzQ3OA=="}, "originalCommit": {"oid": "c9ddff4ebf06fbc1a77b325cdf0e4e738f3b02d7"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUwNjk4NA==", "bodyText": "We need to be able to rebalance system components.", "url": "https://github.com/apache/storm/pull/3302#discussion_r450506984", "createdAt": "2020-07-06T22:13:57Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java", "diffHunk": "@@ -3370,8 +3378,18 @@ public void rebalance(String topoName, RebalanceOptions options)\n             checkAuthorization(topoName, topoConf, operation);\n             // Set principal in RebalanceOptions to nil because users are not suppose to set this\n             options.set_principal(null);\n+            // check if executor counts are correctly specified\n+            StormTopology stormTopology = tryReadTopologyFromName(topoName);\n+            Set<String> comps = new HashSet<>();\n+            comps.addAll(stormTopology.get_spouts().keySet());\n+            comps.addAll(stormTopology.get_bolts().keySet());\n             Map<String, Integer> execOverrides = options.is_set_num_executors() ? options.get_num_executors() : Collections.emptyMap();\n-            for (Integer value : execOverrides.values()) {\n+            for (Map.Entry<String, Integer> e: execOverrides.entrySet()) {\n+                String comp = e.getKey();\n+                Integer value = e.getValue();\n+                if (!comps.contains(comp)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQwNzQ3OA=="}, "originalCommit": {"oid": "c9ddff4ebf06fbc1a77b325cdf0e4e738f3b02d7"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc3OTQwOQ==", "bodyText": "Changed to allow system components.", "url": "https://github.com/apache/storm/pull/3302#discussion_r451779409", "createdAt": "2020-07-08T19:33:41Z", "author": {"login": "bipinprasad"}, "path": "storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java", "diffHunk": "@@ -3370,8 +3378,18 @@ public void rebalance(String topoName, RebalanceOptions options)\n             checkAuthorization(topoName, topoConf, operation);\n             // Set principal in RebalanceOptions to nil because users are not suppose to set this\n             options.set_principal(null);\n+            // check if executor counts are correctly specified\n+            StormTopology stormTopology = tryReadTopologyFromName(topoName);\n+            Set<String> comps = new HashSet<>();\n+            comps.addAll(stormTopology.get_spouts().keySet());\n+            comps.addAll(stormTopology.get_bolts().keySet());\n             Map<String, Integer> execOverrides = options.is_set_num_executors() ? options.get_num_executors() : Collections.emptyMap();\n-            for (Integer value : execOverrides.values()) {\n+            for (Map.Entry<String, Integer> e: execOverrides.entrySet()) {\n+                String comp = e.getKey();\n+                Integer value = e.getValue();\n+                if (!comps.contains(comp)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQwNzQ3OA=="}, "originalCommit": {"oid": "c9ddff4ebf06fbc1a77b325cdf0e4e738f3b02d7"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyMDgyMzEyOnYy", "diffSide": "RIGHT", "path": "storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxODo0ODoxM1rOGvdkjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QyMToyNjozNlrOG9oXZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQyMDc0OQ==", "bodyText": "Maybe we can follow the code at https://github.com/apache/storm/blob/master/storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java#L2638-L2639 to get all the components?\nOr maybe use stormBase to avoid recomputation.\nhttps://github.com/apache/storm/blob/master/storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java#L1808\nNot sure if there is any concern with using it without testing. Maybe there are some corner cases that need to be taken care of.", "url": "https://github.com/apache/storm/pull/3302#discussion_r452420749", "createdAt": "2020-07-09T18:48:13Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java", "diffHunk": "@@ -3380,16 +3381,21 @@ public void rebalance(String topoName, RebalanceOptions options)\n             options.set_principal(null);\n             // check if executor counts are correctly specified\n             StormTopology stormTopology = tryReadTopologyFromName(topoName);\n-            Set<String> comps = new HashSet<>();\n+            Set<String> comps = new TreeSet<>();\n             comps.addAll(stormTopology.get_spouts().keySet());\n             comps.addAll(stormTopology.get_bolts().keySet());\n             Map<String, Integer> execOverrides = options.is_set_num_executors() ? options.get_num_executors() : Collections.emptyMap();\n             for (Map.Entry<String, Integer> e: execOverrides.entrySet()) {\n                 String comp = e.getKey();\n-                Integer value = e.getValue();\n-                if (!comps.contains(comp)) {\n-                    throw new WrappedInvalidTopologyException(String.format(\"Component %s does not exist in topology %s\", comp, topoName));\n+                // validate non-system component ids\n+                if (!Utils.isSystemId(comp) && !comps.contains(comp)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c551f819742e6abb432bd32a7e6af4ae3f94962"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI3NzY2OQ==", "bodyText": "Never mind. I think it is okay to not check system components for now.", "url": "https://github.com/apache/storm/pull/3302#discussion_r467277669", "createdAt": "2020-08-07T21:26:36Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java", "diffHunk": "@@ -3380,16 +3381,21 @@ public void rebalance(String topoName, RebalanceOptions options)\n             options.set_principal(null);\n             // check if executor counts are correctly specified\n             StormTopology stormTopology = tryReadTopologyFromName(topoName);\n-            Set<String> comps = new HashSet<>();\n+            Set<String> comps = new TreeSet<>();\n             comps.addAll(stormTopology.get_spouts().keySet());\n             comps.addAll(stormTopology.get_bolts().keySet());\n             Map<String, Integer> execOverrides = options.is_set_num_executors() ? options.get_num_executors() : Collections.emptyMap();\n             for (Map.Entry<String, Integer> e: execOverrides.entrySet()) {\n                 String comp = e.getKey();\n-                Integer value = e.getValue();\n-                if (!comps.contains(comp)) {\n-                    throw new WrappedInvalidTopologyException(String.format(\"Component %s does not exist in topology %s\", comp, topoName));\n+                // validate non-system component ids\n+                if (!Utils.isSystemId(comp) && !comps.contains(comp)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQyMDc0OQ=="}, "originalCommit": {"oid": "7c551f819742e6abb432bd32a7e6af4ae3f94962"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyMDg4MjY5OnYy", "diffSide": "RIGHT", "path": "storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxOTowNjoyMlrOGveKSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxODozNzoxN1rOHS92dA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQzMDQwOA==", "bodyText": "can be replaced by https://github.com/apache/storm/blob/master/storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java#L1793-L1796", "url": "https://github.com/apache/storm/pull/3302#discussion_r452430408", "createdAt": "2020-07-09T19:06:22Z", "author": {"login": "Ethanlm"}, "path": "storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java", "diffHunk": "@@ -2676,6 +2677,14 @@ private void assertTopoActive(String topoName, boolean expectActive) throws NotA\n         return tryReadTopoConf(topoId, topoCache);\n     }\n \n+    private StormTopology tryReadTopologyFromName(final String topoName) throws NotAliveException,\n+            AuthorizationException, IOException {\n+        IStormClusterState state = stormClusterState;\n+        String topoId = state.getTopoId(topoName)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c551f819742e6abb432bd32a7e6af4ae3f94962"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY0OTc4MA==", "bodyText": "Replaced.", "url": "https://github.com/apache/storm/pull/3302#discussion_r489649780", "createdAt": "2020-09-16T18:37:17Z", "author": {"login": "bipinprasad"}, "path": "storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java", "diffHunk": "@@ -2676,6 +2677,14 @@ private void assertTopoActive(String topoName, boolean expectActive) throws NotA\n         return tryReadTopoConf(topoId, topoCache);\n     }\n \n+    private StormTopology tryReadTopologyFromName(final String topoName) throws NotAliveException,\n+            AuthorizationException, IOException {\n+        IStormClusterState state = stormClusterState;\n+        String topoId = state.getTopoId(topoName)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQzMDQwOA=="}, "originalCommit": {"oid": "7c551f819742e6abb432bd32a7e6af4ae3f94962"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4336, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}