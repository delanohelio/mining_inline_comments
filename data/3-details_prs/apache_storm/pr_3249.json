{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0MDA1NjQ1", "number": 3249, "title": "[STORM-3624] Fix race condition when loading scheduler configs", "bodyText": "https://issues.apache.org/jira/browse/STORM-3624\nThis avoid race condition and makes the config loading logic cleaner.", "createdAt": "2020-04-15T21:46:54Z", "url": "https://github.com/apache/storm/pull/3249", "merged": true, "mergeCommit": {"oid": "af5021aa1911a89c8cee65b91f50fa8d00263d08"}, "closed": true, "closedAt": "2020-06-15T15:07:51Z", "author": {"login": "Ethanlm"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYJB6dAFqTM5NDQ0Mjg0Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqY1J-gFqTQyOTQxMDE4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NDQyODQy", "url": "https://github.com/apache/storm/pull/3249#pullrequestreview-394442842", "createdAt": "2020-04-16T09:11:30Z", "commit": {"oid": "4cfe6bfa2decd26d86f66fda377c0ac50bde02f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwOToxMTozMFrOGGb-1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwOToxMTozMFrOGGb-1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQwMzA5Mw==", "bodyText": "Will this terminate the currently running process?", "url": "https://github.com/apache/storm/pull/3249#discussion_r409403093", "createdAt": "2020-04-16T09:11:30Z", "author": {"login": "bipinprasad"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/utils/SchedulerConfigRefresher.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.  The ASF licenses this file to you under the Apache License, Version\n+ * 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions\n+ * and limitations under the License.\n+ */\n+\n+package org.apache.storm.scheduler.utils;\n+\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicReference;\n+import org.apache.storm.DaemonConfig;\n+import org.apache.storm.StormTimer;\n+import org.apache.storm.utils.ObjectReader;\n+import org.apache.storm.utils.Utils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class SchedulerConfigRefresher<T> {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(SchedulerConfigRefresher.class);\n+\n+    private final StormTimer configRefreshTimer;\n+    private AtomicReference<T> schedulerConfigAtomicReference;\n+    private final Reloadable<T> reloader;\n+    private final Map<String, Object> conf;\n+\n+    public SchedulerConfigRefresher(Map<String, Object> conf, Reloadable<T> reloader) {\n+        configRefreshTimer = new StormTimer(\"scheduler-config-refresher\", (t, e) -> {\n+            LOG.error(\"Error while refreshing scheduler config\", e);\n+            Utils.exitProcess(20, \"Error while refreshing scheduler config\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4cfe6bfa2decd26d86f66fda377c0ac50bde02f1"}, "originalPosition": 36}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4cfe6bfa2decd26d86f66fda377c0ac50bde02f1", "author": {"user": {"login": "Ethanlm", "name": "Meng (Ethan) Li "}}, "url": "https://github.com/apache/storm/commit/4cfe6bfa2decd26d86f66fda377c0ac50bde02f1", "committedDate": "2020-04-15T21:44:46Z", "message": "[STORM-3624] Spawn a SchedulerConfigRefresher thread to reload scheduler configs periodically"}, "afterCommit": {"oid": "c200be6ae3065a70d143aceefbdcb68a33e37038", "author": {"user": {"login": "Ethanlm", "name": "Meng (Ethan) Li "}}, "url": "https://github.com/apache/storm/commit/c200be6ae3065a70d143aceefbdcb68a33e37038", "committedDate": "2020-04-16T14:09:21Z", "message": "[STORM-3624] Spawn a SchedulerConfigRefresher thread to reload scheduler configs periodically"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f179cc549dbb8a81797ea4e2fbd0ee252bd29b5", "author": {"user": {"login": "Ethanlm", "name": "Meng (Ethan) Li "}}, "url": "https://github.com/apache/storm/commit/4f179cc549dbb8a81797ea4e2fbd0ee252bd29b5", "committedDate": "2020-04-16T18:00:57Z", "message": "[STORM-3624] Spawn a SchedulerConfigRefresher thread to reload scheduler configs periodically"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bd449bb8bdae3e01c2300860fbb18c6b8130ef3", "author": {"user": {"login": "Ethanlm", "name": "Meng (Ethan) Li "}}, "url": "https://github.com/apache/storm/commit/0bd449bb8bdae3e01c2300860fbb18c6b8130ef3", "committedDate": "2020-04-16T18:02:01Z", "message": "[STORM-3624] refresh the cache when schedule() is called instead of spawning a new thread"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c200be6ae3065a70d143aceefbdcb68a33e37038", "author": {"user": {"login": "Ethanlm", "name": "Meng (Ethan) Li "}}, "url": "https://github.com/apache/storm/commit/c200be6ae3065a70d143aceefbdcb68a33e37038", "committedDate": "2020-04-16T14:09:21Z", "message": "[STORM-3624] Spawn a SchedulerConfigRefresher thread to reload scheduler configs periodically"}, "afterCommit": {"oid": "0bd449bb8bdae3e01c2300860fbb18c6b8130ef3", "author": {"user": {"login": "Ethanlm", "name": "Meng (Ethan) Li "}}, "url": "https://github.com/apache/storm/commit/0bd449bb8bdae3e01c2300860fbb18c6b8130ef3", "committedDate": "2020-04-16T18:02:01Z", "message": "[STORM-3624] refresh the cache when schedule() is called instead of spawning a new thread"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3c279b069ad59246c09b3bf83cd9414f806352d4", "author": {"user": {"login": "Ethanlm", "name": "Meng (Ethan) Li "}}, "url": "https://github.com/apache/storm/commit/3c279b069ad59246c09b3bf83cd9414f806352d4", "committedDate": "2020-04-16T19:23:41Z", "message": "[STORM-3624] fix unit test because of SimulatedTime being used"}, "afterCommit": {"oid": "d8d3914585d2e1a634a4006da447dcb950434089", "author": {"user": {"login": "Ethanlm", "name": "Meng (Ethan) Li "}}, "url": "https://github.com/apache/storm/commit/d8d3914585d2e1a634a4006da447dcb950434089", "committedDate": "2020-04-16T19:41:13Z", "message": "[STORM-3624] fix unit test because of SimulatedTime being used"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0OTU2MjU0", "url": "https://github.com/apache/storm/pull/3249#pullrequestreview-394956254", "createdAt": "2020-04-16T19:59:15Z", "commit": {"oid": "d8d3914585d2e1a634a4006da447dcb950434089"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxOTo1OToxNlrOGG1DmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxOTo1OToxNlrOGG1DmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgxMzkxMw==", "bodyText": "Since SchedulerConfigCache is now just a wrapper around loadConfig() method, can the class be removed and loadConfig() be called directly at the beginning of schedule?", "url": "https://github.com/apache/storm/pull/3249#discussion_r409813913", "createdAt": "2020-04-16T19:59:16Z", "author": {"login": "bipinprasad"}, "path": "storm-server/src/main/java/org/apache/storm/scheduler/multitenant/MultitenantScheduler.java", "diffHunk": "@@ -30,20 +32,22 @@\n     private static final Logger LOG = LoggerFactory.getLogger(MultitenantScheduler.class);\n     protected IConfigLoader configLoader;\n     private Map<String, Object> conf;\n+    private SchedulerConfigCache<Map<String, Number>> schedulerConfigCache;\n \n     @Override\n     public void prepare(Map<String, Object> conf, StormMetricsRegistry metricsRegistry) {\n         this.conf = conf;\n         configLoader = ConfigLoaderFactoryService.createConfigLoader(conf);\n-\n+        schedulerConfigCache = new SchedulerConfigCache<>(conf, this::loadConfig);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8d3914585d2e1a634a4006da447dcb950434089"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a48e96c48624e6aa30b323c5423e35cec473ac2f", "author": {"user": {"login": "Ethanlm", "name": "Meng (Ethan) Li "}}, "url": "https://github.com/apache/storm/commit/a48e96c48624e6aa30b323c5423e35cec473ac2f", "committedDate": "2020-04-16T20:05:27Z", "message": "[STORM-3624] fix unit test because of SimulatedTime being used"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d8d3914585d2e1a634a4006da447dcb950434089", "author": {"user": {"login": "Ethanlm", "name": "Meng (Ethan) Li "}}, "url": "https://github.com/apache/storm/commit/d8d3914585d2e1a634a4006da447dcb950434089", "committedDate": "2020-04-16T19:41:13Z", "message": "[STORM-3624] fix unit test because of SimulatedTime being used"}, "afterCommit": {"oid": "a48e96c48624e6aa30b323c5423e35cec473ac2f", "author": {"user": {"login": "Ethanlm", "name": "Meng (Ethan) Li "}}, "url": "https://github.com/apache/storm/commit/a48e96c48624e6aa30b323c5423e35cec473ac2f", "committedDate": "2020-04-16T20:05:27Z", "message": "[STORM-3624] fix unit test because of SimulatedTime being used"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5NDEwMTgx", "url": "https://github.com/apache/storm/pull/3249#pullrequestreview-429410181", "createdAt": "2020-06-12T01:46:41Z", "commit": {"oid": "a48e96c48624e6aa30b323c5423e35cec473ac2f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4555, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}