{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwNjc2MTUw", "number": 3297, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNToyMDowN1rOEJtXJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNToyMzoxOVrOEJtcuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NjE1ODQ2OnYy", "diffSide": "RIGHT", "path": "storm-client/src/jvm/org/apache/storm/cluster/IStormClusterState.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNToyMDowN1rOGqV6_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxODoxODozMFrOGqcrMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA1MjU0MQ==", "bodyText": "Do you mean backend store?", "url": "https://github.com/apache/storm/pull/3297#discussion_r447052541", "createdAt": "2020-06-29T15:20:07Z", "author": {"login": "Ethanlm"}, "path": "storm-client/src/jvm/org/apache/storm/cluster/IStormClusterState.java", "diffHunk": "@@ -74,6 +74,13 @@\n      */\n     boolean isAssignmentsBackendSynchronized();\n \n+    /**\n+     * Flag to indicate if the Pacameker is backup store.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19f70374e3dc54e6faad40517336e4cd503c11ed"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2MzE4NA==", "bodyText": "Addressed", "url": "https://github.com/apache/storm/pull/3297#discussion_r447163184", "createdAt": "2020-06-29T18:18:30Z", "author": {"login": "kishorvpatil"}, "path": "storm-client/src/jvm/org/apache/storm/cluster/IStormClusterState.java", "diffHunk": "@@ -74,6 +74,13 @@\n      */\n     boolean isAssignmentsBackendSynchronized();\n \n+    /**\n+     * Flag to indicate if the Pacameker is backup store.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA1MjU0MQ=="}, "originalCommit": {"oid": "19f70374e3dc54e6faad40517336e4cd503c11ed"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NjE2MzA4OnYy", "diffSide": "RIGHT", "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/Worker.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNToyMToxMVrOGqV94g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxODoxODozOVrOGqcrdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA1MzI4Mg==", "bodyText": "We should delete If. Since if this message is logged, it means pacemaker is not being used.", "url": "https://github.com/apache/storm/pull/3297#discussion_r447053282", "createdAt": "2020-06-29T15:21:11Z", "author": {"login": "Ethanlm"}, "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/Worker.java", "diffHunk": "@@ -361,7 +364,11 @@ public void doHeartBeat() throws IOException {\n         state.setWorkerHeartBeat(lsWorkerHeartbeat);\n         state.cleanup(60); // this is just in case supervisor is down so that disk doesn't fill up.\n         // it shouldn't take supervisor 120 seconds between listing dir and reading it\n-        heartbeatToMasterIfLocalbeatFail(lsWorkerHeartbeat);\n+\n+        if (!workerState.stormClusterState.isPacemakerStateStore()) {\n+            LOG.debug(\"If pacemaker is not used, send supervisor\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19f70374e3dc54e6faad40517336e4cd503c11ed"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2MzI1Mg==", "bodyText": "Addressed", "url": "https://github.com/apache/storm/pull/3297#discussion_r447163252", "createdAt": "2020-06-29T18:18:39Z", "author": {"login": "kishorvpatil"}, "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/Worker.java", "diffHunk": "@@ -361,7 +364,11 @@ public void doHeartBeat() throws IOException {\n         state.setWorkerHeartBeat(lsWorkerHeartbeat);\n         state.cleanup(60); // this is just in case supervisor is down so that disk doesn't fill up.\n         // it shouldn't take supervisor 120 seconds between listing dir and reading it\n-        heartbeatToMasterIfLocalbeatFail(lsWorkerHeartbeat);\n+\n+        if (!workerState.stormClusterState.isPacemakerStateStore()) {\n+            LOG.debug(\"If pacemaker is not used, send supervisor\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA1MzI4Mg=="}, "originalCommit": {"oid": "19f70374e3dc54e6faad40517336e4cd503c11ed"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NjE2OTcxOnYy", "diffSide": "RIGHT", "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/Worker.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNToyMjozNVrOGqWB9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxODoxODo1M1rOGqcrzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA1NDMyNw==", "bodyText": "We might want to update the comment here https://github.com/apache/storm/blob/master/storm-client/src/jvm/org/apache/storm/Config.java#L1678-L1684\nsince this config is no longer deprecated. and it is used when Pacemaker is in use.", "url": "https://github.com/apache/storm/pull/3297#discussion_r447054327", "createdAt": "2020-06-29T15:22:35Z", "author": {"login": "Ethanlm"}, "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/Worker.java", "diffHunk": "@@ -215,8 +215,11 @@ private Object loadWorker(IStateStorage stateStorage, IStormClusterState stormCl\n                 }\n             });\n \n+        Integer execHeartBeatFreqSecs = workerState.stormClusterState.isPacemakerStateStore()\n+            ? (Integer) conf.get(Config.TASK_HEARTBEAT_FREQUENCY_SECS)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19f70374e3dc54e6faad40517336e4cd503c11ed"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2MzM0MQ==", "bodyText": "Modified Config.", "url": "https://github.com/apache/storm/pull/3297#discussion_r447163341", "createdAt": "2020-06-29T18:18:53Z", "author": {"login": "kishorvpatil"}, "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/Worker.java", "diffHunk": "@@ -215,8 +215,11 @@ private Object loadWorker(IStateStorage stateStorage, IStormClusterState stormCl\n                 }\n             });\n \n+        Integer execHeartBeatFreqSecs = workerState.stormClusterState.isPacemakerStateStore()\n+            ? (Integer) conf.get(Config.TASK_HEARTBEAT_FREQUENCY_SECS)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA1NDMyNw=="}, "originalCommit": {"oid": "19f70374e3dc54e6faad40517336e4cd503c11ed"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NjE3Mjc1OnYy", "diffSide": "RIGHT", "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/WorkerState.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNToyMzoxOVrOGqWDzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNToyMzoxOVrOGqWDzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA1NDc5Nw==", "bodyText": "We can remove this from this PR since it is being addressed in your other PR #3291", "url": "https://github.com/apache/storm/pull/3297#discussion_r447054797", "createdAt": "2020-06-29T15:23:19Z", "author": {"login": "Ethanlm"}, "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/WorkerState.java", "diffHunk": "@@ -377,15 +378,31 @@ public StormTimer getUserTimer() {\n     public SmartThread makeTransferThread() {\n         return workerTransfer.makeTransferThread();\n     }\n-    \n+\n+    public void suicideIfLocalAssignmentsChanged(Assignment assignment) {\n+        if (assignment != null) {\n+            Set<List<Long>> assignedExecutors = new HashSet<>(readWorkerExecutors(assignmentId, port, assignment));\n+            if (!localExecutors.equals(assignedExecutors)) {\n+                LOG.info(\"Found conflicting assignments. We shouldn't be alive!\"\n+                         + \" Assigned: \" + assignedExecutors + \", Current: \"\n+                         + localExecutors);\n+                if (!ConfigUtils.isLocalMode(conf)) {\n+                    suicideCallback.run();\n+                } else {\n+                    LOG.info(\"Local worker tried to commit suicide!\");\n+                }\n+            }\n+        }\n+    }\n+\n     public void refreshConnections() {\n         Assignment assignment = null;\n         try {\n             assignment = getLocalAssignment(stormClusterState, topologyId);\n         } catch (Exception e) {\n             LOG.warn(\"Failed to read assignment. This should only happen when topology is shutting down.\", e);\n         }\n-\n+        suicideIfLocalAssignmentsChanged(assignment);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19f70374e3dc54e6faad40517336e4cd503c11ed"}, "originalPosition": 47}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4333, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}