{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3OTMxOTY0", "number": 8331, "title": "Integration tests for OAuth Metadata endpoint", "bodyText": "Description\nAdd Integration tests for the OAuth Metadata endpoint for legacy super tenant mode and legacy tenant mode.\nResolves: #8524", "createdAt": "2020-05-14T11:26:30Z", "url": "https://github.com/wso2/product-is/pull/8331", "merged": true, "mergeCommit": {"oid": "68367961683c953cbc109adb7ed2d16e5877d154"}, "closed": true, "closedAt": "2020-05-15T18:57:21Z", "author": {"login": "GANGANI"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchK_fdgH2gAyNDE3OTMxOTY0OjI1YzI3OTA3MjNlNzM2MjIyNmNiYWIyMTczNzA0YTk2YjQ3YTZjNjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdH0IQNgFqTQ4Njc0MjAyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "25c2790723e7362226cbab2173704a96b47a6c65", "author": {"user": {"login": "GANGANI", "name": "Gangani Chamika"}}, "url": "https://github.com/wso2/product-is/commit/25c2790723e7362226cbab2173704a96b47a6c65", "committedDate": "2020-05-14T10:33:59Z", "message": "Integration tests for OAuth Metadata endpoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6de3a7b453b8aa5b1d9d3c000d5938b359d0e3ac", "author": {"user": {"login": "GANGANI", "name": "Gangani Chamika"}}, "url": "https://github.com/wso2/product-is/commit/6de3a7b453b8aa5b1d9d3c000d5938b359d0e3ac", "committedDate": "2020-05-14T11:25:34Z", "message": "Correct license"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExODU1OTg5", "url": "https://github.com/wso2/product-is/pull/8331#pullrequestreview-411855989", "createdAt": "2020-05-14T14:22:33Z", "commit": {"oid": "6de3a7b453b8aa5b1d9d3c000d5938b359d0e3ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNDoyMjozM1rOGVes1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNDoyMjozM1rOGVes1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE3NjI3OQ==", "bodyText": "OAuthMetadataTestCase -> OIDCMetadataTest or something similar would give the actual purpose of the TestCase", "url": "https://github.com/wso2/product-is/pull/8331#discussion_r425176279", "createdAt": "2020-05-14T14:22:33Z", "author": {"login": "mefarazath"}, "path": "modules/integration/tests-integration/tests-backend/src/test/java/org/wso2/identity/integration/test/oauth2/OAuthMetadataTestCase.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.identity.integration.test.oauth2;\n+\n+import org.apache.http.HttpResponse;\n+import org.apache.http.client.HttpClient;\n+import org.apache.http.client.methods.HttpGet;\n+import org.apache.http.impl.client.HttpClientBuilder;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+import org.wso2.identity.integration.common.utils.ISIntegrationTest;\n+import org.wso2.identity.integration.test.utils.DataExtractUtil;\n+\n+import java.io.IOException;\n+\n+public class OAuthMetadataTestCase extends ISIntegrationTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6de3a7b453b8aa5b1d9d3c000d5938b359d0e3ac"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b471590aff7777b2d2ec30d21e5d03df071379f1", "author": {"user": {"login": "GANGANI", "name": "Gangani Chamika"}}, "url": "https://github.com/wso2/product-is/commit/b471590aff7777b2d2ec30d21e5d03df071379f1", "committedDate": "2020-05-15T04:30:35Z", "message": "Refactor class name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyODkzMzU2", "url": "https://github.com/wso2/product-is/pull/8331#pullrequestreview-412893356", "createdAt": "2020-05-15T18:57:14Z", "commit": {"oid": "b471590aff7777b2d2ec30d21e5d03df071379f1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NzQyMDI0", "url": "https://github.com/wso2/product-is/pull/8331#pullrequestreview-486742024", "createdAt": "2020-09-11T11:58:47Z", "commit": {"oid": "b471590aff7777b2d2ec30d21e5d03df071379f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMTo1ODo0N1rOHQb7xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMTo1ODo0N1rOHQb7xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk5NjkzNQ==", "bodyText": "@GANGANI Redundant new line", "url": "https://github.com/wso2/product-is/pull/8331#discussion_r486996935", "createdAt": "2020-09-11T11:58:47Z", "author": {"login": "tharindu-bandara"}, "path": "modules/integration/tests-integration/tests-backend/src/test/java/org/wso2/identity/integration/test/oauth2/OIDCMetadataTest.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.identity.integration.test.oauth2;\n+\n+import org.apache.http.HttpResponse;\n+import org.apache.http.client.HttpClient;\n+import org.apache.http.client.methods.HttpGet;\n+import org.apache.http.impl.client.HttpClientBuilder;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+import org.wso2.identity.integration.common.utils.ISIntegrationTest;\n+import org.wso2.identity.integration.test.utils.DataExtractUtil;\n+\n+import java.io.IOException;\n+\n+public class OIDCMetadataTest extends ISIntegrationTest {\n+\n+    private static final String TOKEN_ENDPOINT_SUPER_TENANT =\n+            \"https://localhost:9853/oauth2/token/.well-known/openid-configuration\";\n+    private static final String TOKEN_ENDPOINT_TENANT =\n+            \"https://localhost:9853/t/wso2.com/oauth2/token/.well-known/openid-configuration\";\n+    private static final String TOKEN_ENDPOINT_WITH_SUPER_TENANT_AS_PATH_PARAM =\n+            \"https://localhost:9853/t/carbon.super/oauth2/token/.well-known/openid-configuration\";\n+    private static final String OIDCDISCOVERY_ENDPOINT_SUPER_TENANT =\n+            \"https://localhost:9853/oauth2/oidcdiscovery/.well-known/openid-configuration\";\n+    private static final String OIDCDISCOVERY_ENDPOINT_TENANT =\n+            \"https://localhost:9853/t/wso2.com/oauth2/oidcdiscovery/.well-known/openid-configuration\";\n+    private static final String OIDCDISCOVERY_ENDPOINT_WITH_SUPER_TENANT_AS_PATH_PARAM =\n+            \"https://localhost:9853/t/carbon.super/oauth2/oidcdiscovery/.well-known/openid-configuration\";\n+    private static final String INTROSPECTION_ENDPOINT = \"https://localhost:9853/oauth2/introspect\";\n+    private static final String CHECK_SESSION_IFRAME = \"https://localhost:9853/oidc/checksession\";\n+    private static final String ISSUER = \"https://localhost:9853/oauth2/token\";\n+    private static final String AUTHORIZATION_ENDPOINT = \"https://localhost:9853/oauth2/authorize\";\n+    private static final String TOKEN_ENDPOINT = \"https://localhost:9853/oauth2/token\";\n+    private static final String END_SESSION_ENDPOINT = \"https://localhost:9853/oidc/logout\";\n+    private static final String REVOCATION_ENDPOINT = \"https://localhost:9853/oauth2/revoke\";\n+    private static final String USERINFO_ENDPOINT =\t\"https://localhost:9853/oauth2/userinfo\";\n+    private static final String JKWS_URI_SUPER_TENANT =\t\"https://localhost:9853/oauth2/jwks\";\n+    private static final String JKWS_URI_TENANT = \"https://localhost:9853/t/wso2.com/oauth2/jwks\";\n+    private static final String REGISTRATION_ENDPOINT_SUPER_TENANT =\n+            \"https://localhost:9853/api/identity/oauth2/dcr/v1.1/register\";\n+    private static final String REGISTRATION_ENDPOINT_TENANT =\n+            \"https://localhost:9853/t/wso2.com/api/identity/oauth2/dcr/v1.1/register\";\n+\n+    @Test(groups = \"wso2.is\", description = \"This test method will test OIDC Metadata endpoints.\")\n+    public void getOIDCMetadata() throws Exception {\n+\n+        testResponseContent(TOKEN_ENDPOINT_SUPER_TENANT);\n+        testResponseContent(TOKEN_ENDPOINT_TENANT);\n+        testResponseContent(TOKEN_ENDPOINT_WITH_SUPER_TENANT_AS_PATH_PARAM);\n+        testResponseContent(OIDCDISCOVERY_ENDPOINT_SUPER_TENANT);\n+        testResponseContent(OIDCDISCOVERY_ENDPOINT_TENANT);\n+        testResponseContent(OIDCDISCOVERY_ENDPOINT_WITH_SUPER_TENANT_AS_PATH_PARAM);\n+    }\n+\n+    private void testResponseContent(String oidcMetadataEndpoint) throws IOException, JSONException {\n+\n+        HttpClient client = HttpClientBuilder.create().build();\n+        HttpResponse httpResponse = sendGetRequest(client, oidcMetadataEndpoint);\n+        String content = DataExtractUtil.getContentData(httpResponse);\n+        Assert.assertNotNull(content, \"Response content is not received\");\n+\n+        JSONObject oidcMetadataEndpoints = new JSONObject(content);\n+        Assert.assertEquals(oidcMetadataEndpoints.getString(\"introspection_endpoint\"),\n+                INTROSPECTION_ENDPOINT, \"Incorrect introspection endpoint\");\n+        Assert.assertEquals(oidcMetadataEndpoints.getString(\"check_session_iframe\"),\n+                CHECK_SESSION_IFRAME, \"Incorrect session iframe\");\n+        Assert.assertEquals(oidcMetadataEndpoints.getString(\"issuer\"),\n+                ISSUER, \"Incorrect issuer\");\n+        Assert.assertEquals(oidcMetadataEndpoints.getString(\"authorization_endpoint\"),\n+                AUTHORIZATION_ENDPOINT, \"Incorrect authorization endpoint\");\n+        Assert.assertEquals(oidcMetadataEndpoints.getString(\"token_endpoint\"),\n+                TOKEN_ENDPOINT, \"Incorrect token_endpoint\");\n+        Assert.assertEquals(oidcMetadataEndpoints.getString(\"end_session_endpoint\"),\n+                END_SESSION_ENDPOINT, \"Incorrect end session endpoint\");\n+        Assert.assertEquals(oidcMetadataEndpoints.getString(\"revocation_endpoint\"),\n+                REVOCATION_ENDPOINT, \"Incorrect revocation endpoint\");\n+        Assert.assertEquals(oidcMetadataEndpoints.getString(\"userinfo_endpoint\"),\n+                USERINFO_ENDPOINT, \"Incorrect userinfo endpoint\");\n+\n+        if (oidcMetadataEndpoint.equals(TOKEN_ENDPOINT_SUPER_TENANT) ||\n+                oidcMetadataEndpoint.equals(OIDCDISCOVERY_ENDPOINT_SUPER_TENANT) ||\n+                oidcMetadataEndpoint.equals(TOKEN_ENDPOINT_WITH_SUPER_TENANT_AS_PATH_PARAM) ||\n+                oidcMetadataEndpoint.equals(OIDCDISCOVERY_ENDPOINT_WITH_SUPER_TENANT_AS_PATH_PARAM)) {\n+            Assert.assertEquals(oidcMetadataEndpoints.getString(\"jwks_uri\"),\n+                    JKWS_URI_SUPER_TENANT, \"Incorrect jwks uri\");\n+            Assert.assertEquals(oidcMetadataEndpoints.getString(\"registration_endpoint\"),\n+                    REGISTRATION_ENDPOINT_SUPER_TENANT, \"Incorrect registration endpoint\");\n+        }\n+\n+        if (oidcMetadataEndpoint.equals(TOKEN_ENDPOINT_TENANT) ||\n+                oidcMetadataEndpoint.equals(OIDCDISCOVERY_ENDPOINT_TENANT)) {\n+            Assert.assertEquals(oidcMetadataEndpoints.getString(\"jwks_uri\"),\n+                    JKWS_URI_TENANT, \"Incorrect jwks uri\");\n+            Assert.assertEquals(oidcMetadataEndpoints.getString(\"registration_endpoint\"),\n+                    REGISTRATION_ENDPOINT_TENANT, \"Incorrect registration endpoint\");\n+        }\n+    }\n+\n+    private HttpResponse sendGetRequest(HttpClient client, String oidcMetadataEndpoint) throws IOException {\n+\n+        HttpGet getRequest = new HttpGet(oidcMetadataEndpoint);\n+        HttpResponse response = client.execute(getRequest);\n+        return response;\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b471590aff7777b2d2ec30d21e5d03df071379f1"}, "originalPosition": 124}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1275, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}