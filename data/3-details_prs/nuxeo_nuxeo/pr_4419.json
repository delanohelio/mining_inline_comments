{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExNjA1Njkx", "number": 4419, "title": "NXP-29759: Make the task endpoint use the UserManagerResolver", "bodyText": "Fix for Jira Issue: https://jira.nuxeo.com/browse/NXP-29759.\nI had to delete the old PR because I did a mistake manipulating the branch but the reviews have been taken into account and have been corrected in this new PR.", "createdAt": "2020-10-28T14:48:40Z", "url": "https://github.com/nuxeo/nuxeo/pull/4419", "merged": true, "mergeCommit": {"oid": "55ddcd5209b8b4e72d13184fde14507a78bf2286"}, "closed": true, "closedAt": "2020-11-17T09:19:34Z", "author": {"login": "charlesboidot"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbFjcnABqjM5Nzc3NzA4Nzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddVxu5AFqTUzMjE0OTk4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "996c0c5cb5450c942538357f28bdb6acbdb25df3", "author": {"user": {"login": "charlesboidot", "name": "Charles Boidot"}}, "url": "https://github.com/nuxeo/nuxeo/commit/996c0c5cb5450c942538357f28bdb6acbdb25df3", "committedDate": "2020-10-28T14:37:35Z", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver"}, "afterCommit": {"oid": "bbac3f47b9155ff1d63441bba1f4c9345ff0fd1e", "author": {"user": {"login": "charlesboidot", "name": "Charles Boidot"}}, "url": "https://github.com/nuxeo/nuxeo/commit/bbac3f47b9155ff1d63441bba1f4c9345ff0fd1e", "committedDate": "2020-11-10T09:00:38Z", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3MDAzMzU2", "url": "https://github.com/nuxeo/nuxeo/pull/4419#pullrequestreview-527003356", "createdAt": "2020-11-10T09:21:38Z", "commit": {"oid": "bbac3f47b9155ff1d63441bba1f4c9345ff0fd1e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwOToyMTozOVrOHwTNxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwOTozMDozNVrOHwTmMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQwODUxOQ==", "bodyText": "Format issue.", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r520408519", "createdAt": "2020-11-10T09:21:39Z", "author": {"login": "kevinleturc"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-rest-api/src/test/java/org/nuxeo/ecm/restapi/server/WorkflowEndpointTest.java", "diffHunk": "@@ -1240,11 +1240,17 @@ public void testTaskWorkflowInfo() throws IOException {\n             JsonNode initiatorNode = taskNode.get(\"workflowInitiator\");\n             assertEquals(\"user\", initiatorNode.get(\"entity-type\").textValue());\n             assertEquals(\"Administrator\", initiatorNode.get(\"id\").textValue());\n-            assertTrue(initiatorNode.get(\"isAdministrator\").booleanValue());\n             JsonNode properties = initiatorNode.get(\"properties\");\n             ArrayNode groups = (ArrayNode) properties.get(\"groups\");\n-            assertEquals(1, groups.size());\n-            assertEquals(\"administrators\", groups.get(0).textValue());\n+            if(initiatorNode.get(\"isPartial\").booleanValue()==false) {\n+                assertTrue(initiatorNode.get(\"isAdministrator\").booleanValue());\n+                assertEquals(1, groups.size());\n+                assertEquals(\"administrators\", groups.get(0).textValue());\n+            }\n+            else {\n+                assertFalse(initiatorNode.get(\"isAdministrator\").booleanValue());\n+                assertTrue(groups.isEmpty());\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbac3f47b9155ff1d63441bba1f4c9345ff0fd1e"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQwOTQzMg==", "bodyText": "Please use ! as it is boolean.", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r520409432", "createdAt": "2020-11-10T09:22:57Z", "author": {"login": "kevinleturc"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-rest-api/src/test/java/org/nuxeo/ecm/restapi/server/WorkflowEndpointTest.java", "diffHunk": "@@ -1240,11 +1240,17 @@ public void testTaskWorkflowInfo() throws IOException {\n             JsonNode initiatorNode = taskNode.get(\"workflowInitiator\");\n             assertEquals(\"user\", initiatorNode.get(\"entity-type\").textValue());\n             assertEquals(\"Administrator\", initiatorNode.get(\"id\").textValue());\n-            assertTrue(initiatorNode.get(\"isAdministrator\").booleanValue());\n             JsonNode properties = initiatorNode.get(\"properties\");\n             ArrayNode groups = (ArrayNode) properties.get(\"groups\");\n-            assertEquals(1, groups.size());\n-            assertEquals(\"administrators\", groups.get(0).textValue());\n+            if(initiatorNode.get(\"isPartial\").booleanValue()==false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbac3f47b9155ff1d63441bba1f4c9345ff0fd1e"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQxMDMzMw==", "bodyText": "Can you move it at the end of field declarations? No need to init it to false it is already the default value.", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r520410333", "createdAt": "2020-11-10T09:24:16Z", "author": {"login": "kevinleturc"}, "path": "modules/platform/nuxeo-platform-usermanager-api/src/main/java/org/nuxeo/ecm/platform/usermanager/NuxeoPrincipalImpl.java", "diffHunk": "@@ -59,6 +59,11 @@\n \n     protected UserConfig config = UserConfig.DEFAULT;\n \n+    /**\n+     * @since 11.4\n+     */\n+    protected boolean isPartial = false;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbac3f47b9155ff1d63441bba1f4c9345ff0fd1e"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQxMjgwMQ==", "bodyText": "Could you move it to its getter?", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r520412801", "createdAt": "2020-11-10T09:27:48Z", "author": {"login": "kevinleturc"}, "path": "modules/core/nuxeo-core-api/src/main/java/org/nuxeo/ecm/core/api/NuxeoPrincipal.java", "diffHunk": "@@ -149,6 +149,11 @@\n      */\n     void setPrincipalId(String principalId);\n \n+    /**\n+     * @since 11.4\n+     */\n+    void setIsPartial(boolean partial);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbac3f47b9155ff1d63441bba1f4c9345ff0fd1e"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQxMzEwOA==", "bodyText": "Missing a @Override no?", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r520413108", "createdAt": "2020-11-10T09:28:18Z", "author": {"login": "kevinleturc"}, "path": "modules/platform/nuxeo-platform-usermanager-api/src/main/java/org/nuxeo/ecm/platform/usermanager/NuxeoPrincipalImpl.java", "diffHunk": "@@ -179,6 +184,13 @@ public void setLastName(String lastName) {\n         dataModel.setData(config.lastNameKey, lastName);\n     }\n \n+    /**\n+     * @since 11.4\n+     */\n+    public void setIsPartial(boolean partial) {\n+        isPartial = partial;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbac3f47b9155ff1d63441bba1f4c9345ff0fd1e"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQxMzIyNA==", "bodyText": "Could you move it before the TransferableClone? Also, could you move its setter close to it?", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r520413224", "createdAt": "2020-11-10T09:28:28Z", "author": {"login": "kevinleturc"}, "path": "modules/platform/nuxeo-platform-usermanager-api/src/main/java/org/nuxeo/ecm/platform/usermanager/NuxeoPrincipalImpl.java", "diffHunk": "@@ -493,4 +505,9 @@ private Object writeReplace() throws ObjectStreamException {\n             return new DataTransferObject(this);\n         }\n     }\n+\n+    @Override\n+    public boolean isPartial() {\n+        return isPartial;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbac3f47b9155ff1d63441bba1f4c9345ff0fd1e"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQxNDU4OQ==", "bodyText": "Can you move it to other is.. fields and keep the same order as the one you use in the NuxoePrincipal interface?", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r520414589", "createdAt": "2020-11-10T09:30:18Z", "author": {"login": "kevinleturc"}, "path": "modules/platform/nuxeo-platform-usermanager-core/src/main/java/org/nuxeo/ecm/platform/usermanager/io/NuxeoPrincipalJsonWriter.java", "diffHunk": "@@ -111,6 +111,7 @@ public NuxeoPrincipalJsonWriter() {\n \n     @Override\n     protected void writeEntityBody(NuxeoPrincipal principal, JsonGenerator jg) throws IOException {\n+        jg.writeBooleanField(\"isPartial\", principal.isPartial());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbac3f47b9155ff1d63441bba1f4c9345ff0fd1e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQxNDc2OQ==", "bodyText": "To remove I think?", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r520414769", "createdAt": "2020-11-10T09:30:35Z", "author": {"login": "kevinleturc"}, "path": "modules/platform/nuxeo-platform-usermanager-core/src/test/java/org/nuxeo/ecm/platform/usermanager/io/NuxeoPrincipalJsonWriterTest.java", "diffHunk": "@@ -50,8 +50,9 @@ public NuxeoPrincipalJsonWriterTest() {\n     public void test() throws Exception {\n         NuxeoPrincipal principal = userManager.getPrincipal(\"Administrator\");\n         JsonAssert json = jsonAssert(principal);\n+        System.out.println(json.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbac3f47b9155ff1d63441bba1f4c9345ff0fd1e"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bbac3f47b9155ff1d63441bba1f4c9345ff0fd1e", "author": {"user": {"login": "charlesboidot", "name": "Charles Boidot"}}, "url": "https://github.com/nuxeo/nuxeo/commit/bbac3f47b9155ff1d63441bba1f4c9345ff0fd1e", "committedDate": "2020-11-10T09:00:38Z", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver"}, "afterCommit": {"oid": "d648975e19fcdcb86d9b845b7c713d3edb5efb62", "author": {"user": {"login": "charlesboidot", "name": "Charles Boidot"}}, "url": "https://github.com/nuxeo/nuxeo/commit/d648975e19fcdcb86d9b845b7c713d3edb5efb62", "committedDate": "2020-11-13T15:01:44Z", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d648975e19fcdcb86d9b845b7c713d3edb5efb62", "author": {"user": {"login": "charlesboidot", "name": "Charles Boidot"}}, "url": "https://github.com/nuxeo/nuxeo/commit/d648975e19fcdcb86d9b845b7c713d3edb5efb62", "committedDate": "2020-11-13T15:01:44Z", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver"}, "afterCommit": {"oid": "281e2ba77df14061a04500ed8c1fa14bc0d8c43c", "author": {"user": {"login": "charlesboidot", "name": "Charles Boidot"}}, "url": "https://github.com/nuxeo/nuxeo/commit/281e2ba77df14061a04500ed8c1fa14bc0d8c43c", "committedDate": "2020-11-13T15:03:58Z", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "281e2ba77df14061a04500ed8c1fa14bc0d8c43c", "author": {"user": {"login": "charlesboidot", "name": "Charles Boidot"}}, "url": "https://github.com/nuxeo/nuxeo/commit/281e2ba77df14061a04500ed8c1fa14bc0d8c43c", "committedDate": "2020-11-13T15:03:58Z", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver"}, "afterCommit": {"oid": "374c733d29dada518e6630f32b37091a2a58f13d", "author": {"user": {"login": "charlesboidot", "name": "Charles Boidot"}}, "url": "https://github.com/nuxeo/nuxeo/commit/374c733d29dada518e6630f32b37091a2a58f13d", "committedDate": "2020-11-13T15:07:57Z", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "374c733d29dada518e6630f32b37091a2a58f13d", "author": {"user": {"login": "charlesboidot", "name": "Charles Boidot"}}, "url": "https://github.com/nuxeo/nuxeo/commit/374c733d29dada518e6630f32b37091a2a58f13d", "committedDate": "2020-11-13T15:07:57Z", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver"}, "afterCommit": {"oid": "c5bccd4c0b8410ba5f37b9fc6ce8da85823a2a53", "author": {"user": {"login": "charlesboidot", "name": "Charles Boidot"}}, "url": "https://github.com/nuxeo/nuxeo/commit/c5bccd4c0b8410ba5f37b9fc6ce8da85823a2a53", "committedDate": "2020-11-13T15:09:12Z", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c5bccd4c0b8410ba5f37b9fc6ce8da85823a2a53", "author": {"user": {"login": "charlesboidot", "name": "Charles Boidot"}}, "url": "https://github.com/nuxeo/nuxeo/commit/c5bccd4c0b8410ba5f37b9fc6ce8da85823a2a53", "committedDate": "2020-11-13T15:09:12Z", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver"}, "afterCommit": {"oid": "cf0c172179c1dffde1d48cbb95294f5dbd8156a4", "author": {"user": {"login": "charlesboidot", "name": "Charles Boidot"}}, "url": "https://github.com/nuxeo/nuxeo/commit/cf0c172179c1dffde1d48cbb95294f5dbd8156a4", "committedDate": "2020-11-13T15:13:08Z", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMTk4NzM5", "url": "https://github.com/nuxeo/nuxeo/pull/4419#pullrequestreview-530198739", "createdAt": "2020-11-13T16:17:02Z", "commit": {"oid": "cf0c172179c1dffde1d48cbb95294f5dbd8156a4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNjoxNzowMlrOHy0tZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNjozMjo1MFrOHy1T_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA1NDQzNw==", "bodyText": "Not needed anymore on master after the module merge (but will be needed in the backport).", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r523054437", "createdAt": "2020-11-13T16:17:02Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/pom.xml", "diffHunk": "@@ -25,6 +25,10 @@\n       <groupId>org.nuxeo.ecm.platform</groupId>\n       <artifactId>nuxeo-platform-usermanager</artifactId>\n     </dependency>\n+    <dependency>\n+      <groupId>org.nuxeo.ecm.platform</groupId>\n+      <artifactId>nuxeo-platform-usermanager-core</artifactId>\n+    </dependency>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf0c172179c1dffde1d48cbb95294f5dbd8156a4"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA1NTUyMw==", "bodyText": "Space before (. Also after the other changes below initiatorNode.get(\"isPartial\") may be null so this must be checked.", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r523055523", "createdAt": "2020-11-13T16:18:56Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-rest-api/src/test/java/org/nuxeo/ecm/restapi/server/WorkflowEndpointTest.java", "diffHunk": "@@ -1239,11 +1239,16 @@ public void testTaskWorkflowInfo() throws IOException {\n             JsonNode initiatorNode = taskNode.get(\"workflowInitiator\");\n             assertEquals(\"user\", initiatorNode.get(\"entity-type\").textValue());\n             assertEquals(\"Administrator\", initiatorNode.get(\"id\").textValue());\n-            assertTrue(initiatorNode.get(\"isAdministrator\").booleanValue());\n             JsonNode properties = initiatorNode.get(\"properties\");\n             ArrayNode groups = (ArrayNode) properties.get(\"groups\");\n-            assertEquals(1, groups.size());\n-            assertEquals(\"administrators\", groups.get(0).textValue());\n+            if(!initiatorNode.get(\"isPartial\").booleanValue()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf0c172179c1dffde1d48cbb95294f5dbd8156a4"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA1NjE5MQ==", "bodyText": "Space before ( and around !=.", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r523056191", "createdAt": "2020-11-13T16:19:47Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-platform-usermanager/src/main/java/org/nuxeo/ecm/platform/usermanager/UserManagerImpl.java", "diffHunk": "@@ -1259,7 +1259,11 @@ protected DocumentModel getUserModel(String userName, DocumentModel context, boo\n         }\n \n         try (Session userDir = dirService.open(userDirectoryName, context)) {\n-            return userDir.getEntry(userName, fetchReferences);\n+            DocumentModel userModel = userDir.getEntry(userName, fetchReferences);\n+            if(userModel!=null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf0c172179c1dffde1d48cbb95294f5dbd8156a4"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA1NzkyOQ==", "bodyText": "Please put \"userHasPartialContent\" in a constant in UserManagerImpl (so, internal for now), and use it also from NuxeoPrincipalJsonWriter.", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r523057929", "createdAt": "2020-11-13T16:22:33Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-platform-usermanager/src/main/java/org/nuxeo/ecm/platform/usermanager/UserManagerImpl.java", "diffHunk": "@@ -1259,7 +1259,11 @@ protected DocumentModel getUserModel(String userName, DocumentModel context, boo\n         }\n \n         try (Session userDir = dirService.open(userDirectoryName, context)) {\n-            return userDir.getEntry(userName, fetchReferences);\n+            DocumentModel userModel = userDir.getEntry(userName, fetchReferences);\n+            if(userModel!=null) {\n+                userModel.putContextData(\"userHasPartialContent\", !fetchReferences);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf0c172179c1dffde1d48cbb95294f5dbd8156a4"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA1ODkwOQ==", "bodyText": "I'd rather we put nothing in the context if the user is \"normal\", so just:\n            if (userModel != null && !fetchReferences) {\n                userModel.putContextData(USER_HAS_PARTIAL_CONTENT, true);\n            }", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r523058909", "createdAt": "2020-11-13T16:24:07Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-platform-usermanager/src/main/java/org/nuxeo/ecm/platform/usermanager/UserManagerImpl.java", "diffHunk": "@@ -1259,7 +1259,11 @@ protected DocumentModel getUserModel(String userName, DocumentModel context, boo\n         }\n \n         try (Session userDir = dirService.open(userDirectoryName, context)) {\n-            return userDir.getEntry(userName, fetchReferences);\n+            DocumentModel userModel = userDir.getEntry(userName, fetchReferences);\n+            if(userModel!=null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf0c172179c1dffde1d48cbb95294f5dbd8156a4"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA2MzY3Nw==", "bodyText": "Let's not write anything if the user is \"normal\".\nAlso the model and the context data are never null.\nFinally let's be more robust about the boolean check, check explicitly for true.\n        Serializable isPartial = principal.getModel().getContextData().get(USER_HAS_PARTIAL_CONTENT);\n        if (Boolean.TRUE.equals(isPartial)) {\n            jg.writeBooleanField(\"isPartial\", true);\n        }", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r523063677", "createdAt": "2020-11-13T16:31:47Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-platform-usermanager/src/main/java/org/nuxeo/ecm/platform/usermanager/io/NuxeoPrincipalJsonWriter.java", "diffHunk": "@@ -111,6 +111,13 @@ public NuxeoPrincipalJsonWriter() {\n \n     @Override\n     protected void writeEntityBody(NuxeoPrincipal principal, JsonGenerator jg) throws IOException {\n+        jg.writeBooleanField(\"isPartial\", false);\n+        if (principal.getModel() != null && principal.getModel().getContextData() != null) {\n+            Serializable isPartial = principal.getModel().getContextData().get(\"userHasPartialContent\");\n+            if (isPartial != null) {\n+                jg.writeBooleanField(\"isPartial\", (boolean) isPartial);\n+            }\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf0c172179c1dffde1d48cbb95294f5dbd8156a4"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA2NDMxOA==", "bodyText": "Will probably be 6 if there's no partial content. It would be good to make sure that in this test class we have a test with and without partial content (and check json.has(\"isPartial\").isTrue() in that case).", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r523064318", "createdAt": "2020-11-13T16:32:50Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-platform-usermanager/src/test/java/org/nuxeo/ecm/platform/usermanager/io/NuxeoPrincipalJsonWriterTest.java", "diffHunk": "@@ -51,7 +51,7 @@ public void test() throws Exception {\n         NuxeoPrincipal principal = userManager.getPrincipal(\"Administrator\");\n         JsonAssert json = jsonAssert(principal);\n         json.isObject();\n-        json.properties(6);\n+        json.properties(7);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf0c172179c1dffde1d48cbb95294f5dbd8156a4"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMjE2MjQ5", "url": "https://github.com/nuxeo/nuxeo/pull/4419#pullrequestreview-530216249", "createdAt": "2020-11-13T16:38:04Z", "commit": {"oid": "cf0c172179c1dffde1d48cbb95294f5dbd8156a4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNjozODowNFrOHy1icQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNjozODowNFrOHy1icQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA2ODAxNw==", "bodyText": "Also @kevinleturc remarked that this should be moved below, with other is* properties.", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r523068017", "createdAt": "2020-11-13T16:38:04Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-platform-usermanager/src/main/java/org/nuxeo/ecm/platform/usermanager/io/NuxeoPrincipalJsonWriter.java", "diffHunk": "@@ -111,6 +111,13 @@ public NuxeoPrincipalJsonWriter() {\n \n     @Override\n     protected void writeEntityBody(NuxeoPrincipal principal, JsonGenerator jg) throws IOException {\n+        jg.writeBooleanField(\"isPartial\", false);\n+        if (principal.getModel() != null && principal.getModel().getContextData() != null) {\n+            Serializable isPartial = principal.getModel().getContextData().get(\"userHasPartialContent\");\n+            if (isPartial != null) {\n+                jg.writeBooleanField(\"isPartial\", (boolean) isPartial);\n+            }\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA2MzY3Nw=="}, "originalCommit": {"oid": "cf0c172179c1dffde1d48cbb95294f5dbd8156a4"}, "originalPosition": 26}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cf0c172179c1dffde1d48cbb95294f5dbd8156a4", "author": {"user": {"login": "charlesboidot", "name": "Charles Boidot"}}, "url": "https://github.com/nuxeo/nuxeo/commit/cf0c172179c1dffde1d48cbb95294f5dbd8156a4", "committedDate": "2020-11-13T15:13:08Z", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver"}, "afterCommit": {"oid": "140d7d82944043cbcbc19a027e68ea10c0065380", "author": {"user": {"login": "charlesboidot", "name": "Charles Boidot"}}, "url": "https://github.com/nuxeo/nuxeo/commit/140d7d82944043cbcbc19a027e68ea10c0065380", "committedDate": "2020-11-16T15:53:25Z", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNDYzNjk2", "url": "https://github.com/nuxeo/nuxeo/pull/4419#pullrequestreview-531463696", "createdAt": "2020-11-16T16:02:00Z", "commit": {"oid": "140d7d82944043cbcbc19a027e68ea10c0065380"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNjowMjowMFrOH0FlmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNjowMjowMFrOH0FlmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM3OTU0NA==", "bodyText": "Format issue.", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r524379544", "createdAt": "2020-11-16T16:02:00Z", "author": {"login": "kevinleturc"}, "path": "modules/platform/nuxeo-platform-usermanager/src/test/java/org/nuxeo/ecm/platform/usermanager/io/NuxeoPrincipalJsonWriterTest.java", "diffHunk": "@@ -88,4 +88,32 @@ public void testSystemUser() throws Exception {\n         exGroup.has(\"url\").isEquals(\"group/administrators\");\n     }\n \n+    @Test\n+    public void testPartialUser() throws Exception {\n+        NuxeoPrincipal principal = userManager.getPrincipal(\"Administrator\");\n+\n+        //Get principal without fetching references\n+        NuxeoPrincipal partialPrincipal = userManager.getPrincipal(principal.getName(),false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "140d7d82944043cbcbc19a027e68ea10c0065380"}, "originalPosition": 9}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "140d7d82944043cbcbc19a027e68ea10c0065380", "author": {"user": {"login": "charlesboidot", "name": "Charles Boidot"}}, "url": "https://github.com/nuxeo/nuxeo/commit/140d7d82944043cbcbc19a027e68ea10c0065380", "committedDate": "2020-11-16T15:53:25Z", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver"}, "afterCommit": {"oid": "9e6c8988e4dee8c78e05af0b75891c76a69bd27b", "author": {"user": {"login": "charlesboidot", "name": "Charles Boidot"}}, "url": "https://github.com/nuxeo/nuxeo/commit/9e6c8988e4dee8c78e05af0b75891c76a69bd27b", "committedDate": "2020-11-16T16:03:09Z", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNDk4MTc1", "url": "https://github.com/nuxeo/nuxeo/pull/4419#pullrequestreview-531498175", "createdAt": "2020-11-16T16:38:05Z", "commit": {"oid": "9e6c8988e4dee8c78e05af0b75891c76a69bd27b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNjozODowNVrOH0HOcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNjo0MDo0NFrOH0HWiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQwNjM4Nw==", "bodyText": "Please put initiatorNode.get(\"isPartial\") in a local variable", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r524406387", "createdAt": "2020-11-16T16:38:05Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-rest-api/src/test/java/org/nuxeo/ecm/restapi/server/WorkflowEndpointTest.java", "diffHunk": "@@ -1239,11 +1239,17 @@ public void testTaskWorkflowInfo() throws IOException {\n             JsonNode initiatorNode = taskNode.get(\"workflowInitiator\");\n             assertEquals(\"user\", initiatorNode.get(\"entity-type\").textValue());\n             assertEquals(\"Administrator\", initiatorNode.get(\"id\").textValue());\n-            assertTrue(initiatorNode.get(\"isAdministrator\").booleanValue());\n             JsonNode properties = initiatorNode.get(\"properties\");\n             ArrayNode groups = (ArrayNode) properties.get(\"groups\");\n-            assertEquals(1, groups.size());\n-            assertEquals(\"administrators\", groups.get(0).textValue());\n+            if (initiatorNode.get(\"isPartial\") != null && initiatorNode.get(\"isPartial\").booleanValue()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e6c8988e4dee8c78e05af0b75891c76a69bd27b"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQwNzgyMQ==", "bodyText": "Please merge the two if statements into one using &&", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r524407821", "createdAt": "2020-11-16T16:39:55Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-platform-usermanager/src/main/java/org/nuxeo/ecm/platform/usermanager/io/NuxeoPrincipalJsonWriter.java", "diffHunk": "@@ -114,6 +114,12 @@ protected void writeEntityBody(NuxeoPrincipal principal, JsonGenerator jg) throw\n         jg.writeStringField(\"id\", principal.getName());\n         writeProperties(jg, principal);\n         writeExtendedGroups(jg, principal);\n+        DocumentModel model = principal.getModel();\n+        if (model != null) {\n+            if (Boolean.TRUE.equals(model.getContextData().get(USER_HAS_PARTIAL_CONTENT))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e6c8988e4dee8c78e05af0b75891c76a69bd27b"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQwODQ1Nw==", "bodyText": "I'd put the  json.properties(7) check before all the json.has checks.", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r524408457", "createdAt": "2020-11-16T16:40:44Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-platform-usermanager/src/test/java/org/nuxeo/ecm/platform/usermanager/io/NuxeoPrincipalJsonWriterTest.java", "diffHunk": "@@ -88,4 +88,32 @@ public void testSystemUser() throws Exception {\n         exGroup.has(\"url\").isEquals(\"group/administrators\");\n     }\n \n+    @Test\n+    public void testPartialUser() throws Exception {\n+        NuxeoPrincipal principal = userManager.getPrincipal(\"Administrator\");\n+\n+        // Get principal without fetching references\n+        NuxeoPrincipal partialPrincipal = userManager.getPrincipal(principal.getName(), false);\n+        JsonAssert json = jsonAssert(partialPrincipal);\n+\n+        // Check the 'isPartial' flag is added\n+        json.has(\"isPartial\").isTrue();\n+        json.properties(7);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e6c8988e4dee8c78e05af0b75891c76a69bd27b"}, "originalPosition": 25}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9e6c8988e4dee8c78e05af0b75891c76a69bd27b", "author": {"user": {"login": "charlesboidot", "name": "Charles Boidot"}}, "url": "https://github.com/nuxeo/nuxeo/commit/9e6c8988e4dee8c78e05af0b75891c76a69bd27b", "committedDate": "2020-11-16T16:03:09Z", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver"}, "afterCommit": {"oid": "04deb106e7931b42aa28f28dcb1701600b0b4593", "author": {"user": {"login": "charlesboidot", "name": "Charles Boidot"}}, "url": "https://github.com/nuxeo/nuxeo/commit/04deb106e7931b42aa28f28dcb1701600b0b4593", "committedDate": "2020-11-16T16:44:20Z", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNTA2NDYw", "url": "https://github.com/nuxeo/nuxeo/pull/4419#pullrequestreview-531506460", "createdAt": "2020-11-16T16:45:59Z", "commit": {"oid": "04deb106e7931b42aa28f28dcb1701600b0b4593"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNTA4MDU3", "url": "https://github.com/nuxeo/nuxeo/pull/4419#pullrequestreview-531508057", "createdAt": "2020-11-16T16:47:38Z", "commit": {"oid": "04deb106e7931b42aa28f28dcb1701600b0b4593"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNTE5NjY2", "url": "https://github.com/nuxeo/nuxeo/pull/4419#pullrequestreview-531519666", "createdAt": "2020-11-16T16:59:56Z", "commit": {"oid": "04deb106e7931b42aa28f28dcb1701600b0b4593"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNjo1OTo1N1rOH0IRAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNzowMjowNFrOH0IXKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQyMzQyNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (model != null && Boolean.TRUE.equals(model.getContextData().get(USER_HAS_PARTIAL_CONTENT))) {\n          \n          \n            \n                    if (model != null && Boolean.TRUE.equals(model.getContextData(USER_HAS_PARTIAL_CONTENT))) {\n          \n      \n    \n    \n  \n\n?", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r524423426", "createdAt": "2020-11-16T16:59:57Z", "author": {"login": "troger"}, "path": "modules/platform/nuxeo-platform-usermanager/src/main/java/org/nuxeo/ecm/platform/usermanager/io/NuxeoPrincipalJsonWriter.java", "diffHunk": "@@ -114,6 +112,10 @@ protected void writeEntityBody(NuxeoPrincipal principal, JsonGenerator jg) throw\n         jg.writeStringField(\"id\", principal.getName());\n         writeProperties(jg, principal);\n         writeExtendedGroups(jg, principal);\n+        DocumentModel model = principal.getModel();\n+        if (model != null && Boolean.TRUE.equals(model.getContextData().get(USER_HAS_PARTIAL_CONTENT))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04deb106e7931b42aa28f28dcb1701600b0b4593"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQyNTAwMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    NuxeoPrincipal principal = userManager.getPrincipal(\"Administrator\");\n          \n          \n            \n            \n          \n          \n            \n                    // Get principal without fetching references\n          \n          \n            \n                    NuxeoPrincipal partialPrincipal = userManager.getPrincipal(principal.getName(), false);\n          \n          \n            \n                    // Get principal without fetching references\n          \n          \n            \n                    NuxeoPrincipal partialPrincipal = userManager.getPrincipal(\"Administrator\", false);\n          \n      \n    \n    \n  \n\n?", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r524425002", "createdAt": "2020-11-16T17:02:04Z", "author": {"login": "troger"}, "path": "modules/platform/nuxeo-platform-usermanager/src/test/java/org/nuxeo/ecm/platform/usermanager/io/NuxeoPrincipalJsonWriterTest.java", "diffHunk": "@@ -88,4 +88,32 @@ public void testSystemUser() throws Exception {\n         exGroup.has(\"url\").isEquals(\"group/administrators\");\n     }\n \n+    @Test\n+    public void testPartialUser() throws Exception {\n+        NuxeoPrincipal principal = userManager.getPrincipal(\"Administrator\");\n+\n+        // Get principal without fetching references\n+        NuxeoPrincipal partialPrincipal = userManager.getPrincipal(principal.getName(), false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04deb106e7931b42aa28f28dcb1701600b0b4593"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81740634b614062a603a08adfa6781a9db2146dd", "author": {"user": {"login": "charlesboidot", "name": "Charles Boidot"}}, "url": "https://github.com/nuxeo/nuxeo/commit/81740634b614062a603a08adfa6781a9db2146dd", "committedDate": "2020-11-16T17:16:00Z", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "04deb106e7931b42aa28f28dcb1701600b0b4593", "author": {"user": {"login": "charlesboidot", "name": "Charles Boidot"}}, "url": "https://github.com/nuxeo/nuxeo/commit/04deb106e7931b42aa28f28dcb1701600b0b4593", "committedDate": "2020-11-16T16:44:20Z", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver"}, "afterCommit": {"oid": "81740634b614062a603a08adfa6781a9db2146dd", "author": {"user": {"login": "charlesboidot", "name": "Charles Boidot"}}, "url": "https://github.com/nuxeo/nuxeo/commit/81740634b614062a603a08adfa6781a9db2146dd", "committedDate": "2020-11-16T17:16:00Z", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNTM2OTg1", "url": "https://github.com/nuxeo/nuxeo/pull/4419#pullrequestreview-531536985", "createdAt": "2020-11-16T17:18:13Z", "commit": {"oid": "81740634b614062a603a08adfa6781a9db2146dd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMTQ5OTg2", "url": "https://github.com/nuxeo/nuxeo/pull/4419#pullrequestreview-532149986", "createdAt": "2020-11-17T09:03:22Z", "commit": {"oid": "81740634b614062a603a08adfa6781a9db2146dd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4945, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}