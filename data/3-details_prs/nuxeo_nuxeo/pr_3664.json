{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyNTk3NDg3", "number": 3664, "title": "improvement-NXP-28255-add-parent-comment-in-notifications", "bodyText": "PR created from https://qa.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-nalkotob/106/", "createdAt": "2020-01-14T11:59:58Z", "url": "https://github.com/nuxeo/nuxeo/pull/3664", "merged": true, "mergeCommit": {"oid": "d67cc1b6131ea7f1e2edb38bf3546eb81546b7d1"}, "closed": true, "closedAt": "2020-02-12T10:02:50Z", "author": {"login": "nuxeojenkins"}, "timelineItems": {"totalCount": 30, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb63z7VABqjI5NTQwNDMyMTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDjUV0gFqTM1NzMxODk4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aa0a9a84ddeafcc8b5fbe0cadf67e0063c70affe", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/aa0a9a84ddeafcc8b5fbe0cadf67e0063c70affe", "committedDate": "2020-01-13T17:38:47Z", "message": "NXP-28255: add parent comment content in notification"}, "afterCommit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/3e2515ba8451b945c0e3262aa08aa59e760a30f7", "committedDate": "2020-01-16T10:43:54Z", "message": "NXP-28255: add parent comment content in notification"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzOTQzMDE2", "url": "https://github.com/nuxeo/nuxeo/pull/3664#pullrequestreview-343943016", "createdAt": "2020-01-16T14:17:47Z", "commit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDoxNzo0N1rOFeaz9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDoxNzo0N1rOFeaz9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ0MDg4Nw==", "bodyText": "No risk of NPE on parentComment here?", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r367440887", "createdAt": "2020-01-16T14:17:47Z", "author": {"login": "ataillefer"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java", "diffHunk": "@@ -133,13 +135,22 @@ public static String getExpectedMailContent(DocumentModel commentDocModel, Docum\n             Event event, String commentEventType) {\n         URL url = CommentUtils.class.getResource(\"/templates/commentNotificationMail.txt\");\n         try {\n-            String content = Files.readString(Paths.get(url.toURI()));\n             var model = Map.of(\"COMMENT_AUTHOR\", commentDocModel.getPropertyValue(COMMENT_AUTHOR), //\n                     \"COMMENT_ACTION\", COMMENT_ADDED.equals(commentEventType) ? \"added\" : \"updated\", //\n                     \"COMMENTED_DOCUMENT\", commentedDocModel.getName(), //\n                     \"COMMENT_DATE\", EVENT_DATE_FORMAT.format(Date.from(Instant.ofEpochMilli(event.getTime()))), //\n                     \"COMMENT_TEXT\", commentDocModel.getPropertyValue(COMMENT_TEXT), //\n                     \"COMMENT_SUBSCRIPTION_NAME\", COMMENT_ADDED.equals(commentEventType) ? \"New\" : \"Updated\");\n+            DocumentModel parentComment = (DocumentModel) event.getContext().getProperties().get(PARENT_COMMENT);\n+            if (COMMENT_DOC_TYPE.equals(parentComment.getType())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzOTQ0NDM3", "url": "https://github.com/nuxeo/nuxeo/pull/3664#pullrequestreview-343944437", "createdAt": "2020-01-16T14:19:43Z", "commit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDoxOTo0NFrOFea4Jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDoxOTo0NFrOFea4Jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ0MTk1OQ==", "bodyText": "Shouldn't this word be part of a sentence?", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r367441959", "createdAt": "2020-01-16T14:19:44Z", "author": {"login": "ataillefer"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/resources/templates/commentReplyNotificationMail.txt", "diffHunk": "@@ -0,0 +1,13 @@\n+\n+(${COMMENT_AUTHOR}) has ${COMMENT_ACTION} a comment on ${COMMENTED_DOCUMENT} at ${COMMENT_DATE}.\n+\n+says:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MDAwMzM5", "url": "https://github.com/nuxeo/nuxeo/pull/3664#pullrequestreview-344000339", "createdAt": "2020-01-16T15:31:30Z", "commit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MDEyMDgz", "url": "https://github.com/nuxeo/nuxeo/pull/3664#pullrequestreview-344012083", "createdAt": "2020-01-16T15:46:16Z", "commit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNTo0NjoxNlrOFeeAUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNTo0NjoxNlrOFeeAUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ5MzIwMw==", "bodyText": "missing line at the end of the file", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r367493203", "createdAt": "2020-01-16T15:46:16Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/resources/templates/quotedComments.ftl", "diffHunk": "@@ -0,0 +1,9 @@\n+<p style=\"margin:0;font-size:13px;\">${htmlEscape(principalAuthor.firstName)} says:</p>\n+<p style=\"margin:0;font-size:13px;\">${comment_text}</p>\n+<br/>\n+<#if parentComment.type == \"Comment\">\n+  <p style=\"margin:0;font-size:13px;\">It is a reply to the following comment:</p>\n+  <p style=\"margin:0;font-size:13px;\">${htmlEscape(parentComment.comment.author)} says:</p>\n+  <p style=\"margin:0;font-size:13px;\">${parentComment.comment.text}</p>\n+  <br/>\n+</#if>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NzE4MzIz", "url": "https://github.com/nuxeo/nuxeo/pull/3664#pullrequestreview-344718323", "createdAt": "2020-01-17T17:05:50Z", "commit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNzowNTo1MFrOFe_fiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNzowNTo1MFrOFe_fiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA0MTg2Nw==", "bodyText": "Map<String, Serializable> modelWithReplyInfos = new HashMap<>(model); to avoid  modelWithReplyInfos.putAll(model);", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r368041867", "createdAt": "2020-01-17T17:05:50Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java", "diffHunk": "@@ -122,13 +135,22 @@ public static String getExpectedMailContent(DocumentModel commentDocModel, Docum\n             Event event, String commentEventType) {\n         URL url = CommentUtils.class.getResource(\"/templates/commentNotificationMail.txt\");\n         try {\n-            String content = Files.readString(Paths.get(url.toURI()));\n             var model = Map.of(\"COMMENT_AUTHOR\", commentDocModel.getPropertyValue(COMMENT_AUTHOR), //\n                     \"COMMENT_ACTION\", COMMENT_ADDED.equals(commentEventType) ? \"added\" : \"updated\", //\n                     \"COMMENTED_DOCUMENT\", commentedDocModel.getName(), //\n                     \"COMMENT_DATE\", EVENT_DATE_FORMAT.format(Date.from(Instant.ofEpochMilli(event.getTime()))), //\n                     \"COMMENT_TEXT\", commentDocModel.getPropertyValue(COMMENT_TEXT), //\n                     \"COMMENT_SUBSCRIPTION_NAME\", COMMENT_ADDED.equals(commentEventType) ? \"New\" : \"Updated\");\n+            DocumentModel parentComment = (DocumentModel) event.getContext().getProperties().get(PARENT_COMMENT);\n+            if (COMMENT_DOC_TYPE.equals(parentComment.getType())) {\n+                url = CommentUtils.class.getResource(\"/templates/commentReplyNotificationMail.txt\");\n+                Map<String, Serializable> modelWithReplyInfos = new HashMap<>();\n+                modelWithReplyInfos.putAll(model);\n+                modelWithReplyInfos.put(\"PARENT_COMMENT_AUTHOR\", parentComment.getPropertyValue(\"comment:author\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "originalPosition": 74}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/3e2515ba8451b945c0e3262aa08aa59e760a30f7", "committedDate": "2020-01-16T10:43:54Z", "message": "NXP-28255: add parent comment content in notification"}, "afterCommit": {"oid": "697a86eb23e4674182e32a70c244ad71e281d2c6", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/697a86eb23e4674182e32a70c244ad71e281d2c6", "committedDate": "2020-01-17T17:19:46Z", "message": "NXP-28255: add parent comment content in notification"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NzI4NTU3", "url": "https://github.com/nuxeo/nuxeo/pull/3664#pullrequestreview-344728557", "createdAt": "2020-01-17T17:24:46Z", "commit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "697a86eb23e4674182e32a70c244ad71e281d2c6", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/697a86eb23e4674182e32a70c244ad71e281d2c6", "committedDate": "2020-01-17T17:19:46Z", "message": "NXP-28255: add parent comment content in notification"}, "afterCommit": {"oid": "2dbe14df0918f89bc97a5071b44ee135cc4a1525", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/2dbe14df0918f89bc97a5071b44ee135cc4a1525", "committedDate": "2020-01-20T07:00:46Z", "message": "NXP-28255: add parent comment content in notification"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2dbe14df0918f89bc97a5071b44ee135cc4a1525", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/2dbe14df0918f89bc97a5071b44ee135cc4a1525", "committedDate": "2020-01-20T07:00:46Z", "message": "NXP-28255: add parent comment content in notification"}, "afterCommit": {"oid": "06ec5ed310a33595613984cfc651d5cee9302a43", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/06ec5ed310a33595613984cfc651d5cee9302a43", "committedDate": "2020-01-20T10:13:19Z", "message": "NXP-28255: add parent comment content in notification"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "06ec5ed310a33595613984cfc651d5cee9302a43", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/06ec5ed310a33595613984cfc651d5cee9302a43", "committedDate": "2020-01-20T10:13:19Z", "message": "NXP-28255: add parent comment content in notification"}, "afterCommit": {"oid": "ab56a1dcf6d2a8433bc4b2c108cb2fe471fe85a1", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/ab56a1dcf6d2a8433bc4b2c108cb2fe471fe85a1", "committedDate": "2020-01-22T16:43:50Z", "message": "NXP-28255: add parent comment content in notification"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab56a1dcf6d2a8433bc4b2c108cb2fe471fe85a1", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/ab56a1dcf6d2a8433bc4b2c108cb2fe471fe85a1", "committedDate": "2020-01-22T16:43:50Z", "message": "NXP-28255: add parent comment content in notification"}, "afterCommit": {"oid": "fc1bf1252f171f23efe4d7c7df0cb7eed065a278", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/fc1bf1252f171f23efe4d7c7df0cb7eed065a278", "committedDate": "2020-01-23T15:02:39Z", "message": "NXP-28255: add parent comment content in notification"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fc1bf1252f171f23efe4d7c7df0cb7eed065a278", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/fc1bf1252f171f23efe4d7c7df0cb7eed065a278", "committedDate": "2020-01-23T15:02:39Z", "message": "NXP-28255: add parent comment content in notification"}, "afterCommit": {"oid": "98502bfddcf3f55c91ec4b9ebd0b752405baf93b", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/98502bfddcf3f55c91ec4b9ebd0b752405baf93b", "committedDate": "2020-01-24T10:05:01Z", "message": "NXP-28255: add parent comment content in notification"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4MDg1NjE4", "url": "https://github.com/nuxeo/nuxeo/pull/3664#pullrequestreview-348085618", "createdAt": "2020-01-24T16:49:25Z", "commit": {"oid": "98502bfddcf3f55c91ec4b9ebd0b752405baf93b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxNjo0OToyNVrOFhj0xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxNjo0OToyNVrOFhj0xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDczNDI3OQ==", "bodyText": "as discussed on F2F, we should checks the annotation type too here and in the quotedComments.ftl is why i proposed too to remove the whole quotedComments.ftl and integrate the whole controle in the base one and only check if parentAuthor / parentText is not empty and then add the its value. in this last point its mainly a proposal and others feedback are welcome", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r370734279", "createdAt": "2020-01-24T16:49:25Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java", "diffHunk": "@@ -131,15 +131,26 @@ public static void checkReceivedMail(List<MailMessage> mails, DocumentModel comm\n \n     public static String getExpectedMailContent(DocumentModel commentDocModel, DocumentModel commentedDocModel,\n             Event event, String commentEventType) {\n-        URL url = CommentUtils.class.getResource(\"/templates/commentNotificationMail.txt\");\n         try {\n-            String content = Files.readString(Paths.get(url.toURI()));\n+            String template = \"commentNotificationMail.txt\";\n+            Serializable parentAuthor = \"\";\n+            Serializable parentText = \"\";\n+            DocumentModel parentComment = (DocumentModel) event.getContext().getProperties().get(PARENT_COMMENT);\n+            if (COMMENT_DOC_TYPE.equals(parentComment.getType())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98502bfddcf3f55c91ec4b9ebd0b752405baf93b"}, "originalPosition": 25}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "98502bfddcf3f55c91ec4b9ebd0b752405baf93b", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/98502bfddcf3f55c91ec4b9ebd0b752405baf93b", "committedDate": "2020-01-24T10:05:01Z", "message": "NXP-28255: add parent comment content in notification"}, "afterCommit": {"oid": "d1f9b491e6165bc9dc79c70ea52aaeca2a2ae90d", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/d1f9b491e6165bc9dc79c70ea52aaeca2a2ae90d", "committedDate": "2020-01-24T16:55:23Z", "message": "NXP-28255: add parent comment content in notification"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d1f9b491e6165bc9dc79c70ea52aaeca2a2ae90d", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/d1f9b491e6165bc9dc79c70ea52aaeca2a2ae90d", "committedDate": "2020-01-24T16:55:23Z", "message": "NXP-28255: add parent comment content in notification"}, "afterCommit": {"oid": "e63b94f9dbb6ca0de34b1d0c96419dfdb0956faa", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/e63b94f9dbb6ca0de34b1d0c96419dfdb0956faa", "committedDate": "2020-01-28T15:06:07Z", "message": "NXP-28255: add parent comment content in notification"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NDU1NzU2", "url": "https://github.com/nuxeo/nuxeo/pull/3664#pullrequestreview-349455756", "createdAt": "2020-01-28T15:16:06Z", "commit": {"oid": "e63b94f9dbb6ca0de34b1d0c96419dfdb0956faa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNToxNjowN1rOFio1Rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNToxNjowN1rOFio1Rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg2NDkwMw==", "bodyText": "should be removed ? or i am wrong", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r371864903", "createdAt": "2020-01-28T15:16:07Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/resources/OSGI-INF/comment-notification-contrib.xml", "diffHunk": "@@ -32,6 +32,7 @@\n     <template name=\"baseComment\" src=\"templates/baseComment.ftl\" />\n     <template name=\"commentAdded\" src=\"templates/commentAdded.ftl\" />\n     <template name=\"commentUpdated\" src=\"templates/commentUpdated.ftl\" />\n+    <template name=\"quotedComments\" src=\"templates/quotedComments.ftl\" />", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e63b94f9dbb6ca0de34b1d0c96419dfdb0956faa"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NDYxMTk4", "url": "https://github.com/nuxeo/nuxeo/pull/3664#pullrequestreview-349461198", "createdAt": "2020-01-28T15:22:25Z", "commit": {"oid": "e63b94f9dbb6ca0de34b1d0c96419dfdb0956faa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNToyMjoyNlrOFipEsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNToyMjoyNlrOFipEsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg2ODg1MA==", "bodyText": "thanks taking into account the fact to remove the quotedComments.ftl ;)", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r371868850", "createdAt": "2020-01-28T15:22:26Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/resources/templates/baseComment.ftl", "diffHunk": "@@ -20,10 +20,16 @@\n                         <#if principalAuthor?? && (principalAuthor.lastName!=\"\" || principalAuthor.firstName!=\"\")>\n                         ${htmlEscape(principalAuthor.firstName)} ${htmlEscape(principalAuthor.lastName)}\n                         </#if>\n-                        (${author}) has ${action} a comment on <a style=\"color:#22aee8;text-decoration:underline;word-wrap:break-word !important;\" href=\"${docUrl}\">${docTitle}</a> at ${dateTime?datetime?string(\"dd/MM/yyyy - HH:mm\")}.</p><br/>\n-                        <p style=\"margin:0;font-size:13px;\">${htmlEscape(principalAuthor.firstName)} says:</p>\n-                        <p style=\"margin:0;font-size:13px;\">${comment_text}</p>\n-                        <br/>\n+                          (${author}) has ${action} a comment on <a style=\"color:#22aee8;text-decoration:underline;word-wrap:break-word !important;\" href=\"${docUrl}\">${docTitle}</a> at ${dateTime?datetime?string(\"dd/MM/yyyy - HH:mm\")}.</p><br/>\n+                          <p style=\"margin:0;font-size:13px;\">${htmlEscape(principalAuthor.firstName)} says:</p>\n+                          <p style=\"margin:0;font-size:13px;\">${comment_text}</p>\n+                          <br/>\n+                          <#if parentComment.type == \"Comment\" || parentComment.type == \"Annotation\">\n+                          <p style=\"margin:0;font-size:13px;\">It is a reply to:</p>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e63b94f9dbb6ca0de34b1d0c96419dfdb0956faa"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NDYyMzUy", "url": "https://github.com/nuxeo/nuxeo/pull/3664#pullrequestreview-349462352", "createdAt": "2020-01-28T15:23:39Z", "commit": {"oid": "e63b94f9dbb6ca0de34b1d0c96419dfdb0956faa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNToyMzozOVrOFipIFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNToyMzozOVrOFipIFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg2OTcxNw==", "bodyText": "you can use instead it the hasSchema if you want as both annotation and comment contains the comment schema\nfor more further  i was think if we put check only here i mean in this method and just rely on the existence of the value in the ftl to avoid making the same thing twice see https://github.com/nuxeo/nuxeo/pull/3664/files#diff-b4cc6f294fb9a7dcb604d5682fb14bcaR27 why if we rely on the existence of Map#PARENT_COMMENT_AUTHOR and Map#PARENT_COMMENT_TEXT to add the section in the ftl", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r371869717", "createdAt": "2020-01-28T15:23:39Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java", "diffHunk": "@@ -131,15 +133,25 @@ public static void checkReceivedMail(List<MailMessage> mails, DocumentModel comm\n \n     public static String getExpectedMailContent(DocumentModel commentDocModel, DocumentModel commentedDocModel,\n             Event event, String commentEventType) {\n-        URL url = CommentUtils.class.getResource(\"/templates/commentNotificationMail.txt\");\n         try {\n-            String content = Files.readString(Paths.get(url.toURI()));\n-            var model = Map.of(\"COMMENT_AUTHOR\", commentDocModel.getPropertyValue(COMMENT_AUTHOR), //\n-                    \"COMMENT_ACTION\", COMMENT_ADDED.equals(commentEventType) ? \"added\" : \"updated\", //\n-                    \"COMMENTED_DOCUMENT\", commentedDocModel.getName(), //\n-                    \"COMMENT_DATE\", EVENT_DATE_FORMAT.format(Date.from(Instant.ofEpochMilli(event.getTime()))), //\n-                    \"COMMENT_TEXT\", commentDocModel.getPropertyValue(COMMENT_TEXT), //\n-                    \"COMMENT_SUBSCRIPTION_NAME\", COMMENT_ADDED.equals(commentEventType) ? \"New\" : \"Updated\");\n+            var model = new HashMap<String, Serializable>();\n+            model.put(\"COMMENT_AUTHOR\", commentDocModel.getPropertyValue(COMMENT_AUTHOR));\n+            model.put(\"COMMENT_ACTION\", COMMENT_ADDED.equals(commentEventType) ? \"added\" : \"updated\");\n+            model.put(\"COMMENTED_DOCUMENT\", commentedDocModel.getName());\n+            model.put(\"COMMENT_DATE\", EVENT_DATE_FORMAT.format(Date.from(Instant.ofEpochMilli(event.getTime()))));\n+            model.put(\"COMMENT_TEXT\", commentDocModel.getPropertyValue(COMMENT_TEXT));\n+            model.put(\"COMMENT_SUBSCRIPTION_NAME\", COMMENT_ADDED.equals(commentEventType) ? \"New\" : \"Updated\");\n+\n+            String template = \"commentNotificationMail.txt\";\n+            DocumentModel parentComment = (DocumentModel) event.getContext().getProperties().get(PARENT_COMMENT);\n+            if (COMMENT_DOC_TYPE.equals(parentComment.getType()) ||\n+                    ANNOTATION_DOC_TYPE.equals(parentComment.getType())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e63b94f9dbb6ca0de34b1d0c96419dfdb0956faa"}, "originalPosition": 52}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e63b94f9dbb6ca0de34b1d0c96419dfdb0956faa", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/e63b94f9dbb6ca0de34b1d0c96419dfdb0956faa", "committedDate": "2020-01-28T15:06:07Z", "message": "NXP-28255: add parent comment content in notification"}, "afterCommit": {"oid": "ed63044f2106292e19e48cd3d6db51ea81d33ad8", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/ed63044f2106292e19e48cd3d6db51ea81d33ad8", "committedDate": "2020-01-28T15:43:08Z", "message": "NXP-28255: add parent comment content in notification"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ed63044f2106292e19e48cd3d6db51ea81d33ad8", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/ed63044f2106292e19e48cd3d6db51ea81d33ad8", "committedDate": "2020-01-28T15:43:08Z", "message": "NXP-28255: add parent comment content in notification"}, "afterCommit": {"oid": "52f0978b519b4cd24a299e778328527ffaaf152c", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/52f0978b519b4cd24a299e778328527ffaaf152c", "committedDate": "2020-01-29T15:28:01Z", "message": "NXP-28255: add parent comment content in notification"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "52f0978b519b4cd24a299e778328527ffaaf152c", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/52f0978b519b4cd24a299e778328527ffaaf152c", "committedDate": "2020-01-29T15:28:01Z", "message": "NXP-28255: add parent comment content in notification"}, "afterCommit": {"oid": "2604170ee107e12d2bd41b1267348ff6c01a6305", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/2604170ee107e12d2bd41b1267348ff6c01a6305", "committedDate": "2020-01-29T15:30:43Z", "message": "NXP-28255: add parent comment content in notification"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNzA1Njkw", "url": "https://github.com/nuxeo/nuxeo/pull/3664#pullrequestreview-350705690", "createdAt": "2020-01-30T10:06:50Z", "commit": {"oid": "2604170ee107e12d2bd41b1267348ff6c01a6305"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNzEzODQ5", "url": "https://github.com/nuxeo/nuxeo/pull/3664#pullrequestreview-350713849", "createdAt": "2020-01-30T10:19:34Z", "commit": {"oid": "2604170ee107e12d2bd41b1267348ff6c01a6305"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2604170ee107e12d2bd41b1267348ff6c01a6305", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/2604170ee107e12d2bd41b1267348ff6c01a6305", "committedDate": "2020-01-29T15:30:43Z", "message": "NXP-28255: add parent comment content in notification"}, "afterCommit": {"oid": "2e3e200762fe472a1f99a47c870a751d353a7c82", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/2e3e200762fe472a1f99a47c870a751d353a7c82", "committedDate": "2020-01-30T10:27:42Z", "message": "NXP-28255: add parent comment content in notification"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "988b687cb828b0e7206ec0fcf07e7e8ed5034c52", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/988b687cb828b0e7206ec0fcf07e7e8ed5034c52", "committedDate": "2020-02-07T10:37:26Z", "message": "NXP-28255: add parent comment content in notification"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2e3e200762fe472a1f99a47c870a751d353a7c82", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/2e3e200762fe472a1f99a47c870a751d353a7c82", "committedDate": "2020-01-30T10:27:42Z", "message": "NXP-28255: add parent comment content in notification"}, "afterCommit": {"oid": "988b687cb828b0e7206ec0fcf07e7e8ed5034c52", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/988b687cb828b0e7206ec0fcf07e7e8ed5034c52", "committedDate": "2020-02-07T10:37:26Z", "message": "NXP-28255: add parent comment content in notification"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MDcwNTEx", "url": "https://github.com/nuxeo/nuxeo/pull/3664#pullrequestreview-355070511", "createdAt": "2020-02-07T10:40:53Z", "commit": {"oid": "988b687cb828b0e7206ec0fcf07e7e8ed5034c52"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxMDo0MDo1M1rOFm5E4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxMDo0MDo1M1rOFm5E4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMyNTM0Nw==", "bodyText": "This features revealed an error in the test after flattening test methods. The first mail was checked instead of the 2nd in the case of autosubscription (so Tree implementation only). Since content was strictly identical, test was successful.\nIn this ticket that doesn't cut it anymore since replies have different template.\nShouldn't affect the backport as it doesn't have the mail tests and checks.", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r376325347", "createdAt": "2020-02-07T10:40:53Z", "author": {"login": "NourNuxeo"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/AbstractTestCommentNotification.java", "diffHunk": "@@ -192,7 +192,7 @@ public void shouldNotifyWithTheRightCommentedDocument() {\n             assertEquals(2, mails.size());\n             String expectedMailContent = getExpectedMailContent(replyDocumentModel, commentedDocumentModel,\n                     expectedEvent);\n-            assertEquals(expectedMailContent, getMailContent(mails.get(0)));\n+            assertEquals(expectedMailContent, getMailContent(mails.get(1)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "988b687cb828b0e7206ec0fcf07e7e8ed5034c52"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2ODQwNTY4", "url": "https://github.com/nuxeo/nuxeo/pull/3664#pullrequestreview-356840568", "createdAt": "2020-02-11T17:14:06Z", "commit": {"oid": "988b687cb828b0e7206ec0fcf07e7e8ed5034c52"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MzE4OTg3", "url": "https://github.com/nuxeo/nuxeo/pull/3664#pullrequestreview-357318987", "createdAt": "2020-02-12T09:56:45Z", "commit": {"oid": "988b687cb828b0e7206ec0fcf07e7e8ed5034c52"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4877, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}