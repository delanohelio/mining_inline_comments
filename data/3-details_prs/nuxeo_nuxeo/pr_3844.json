{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwMzcyOTAy", "number": 3844, "title": "NXP-28504: release when merging on reference branches", "bodyText": "Use only on Jenkinsfile to build PRs and release reference\nbranches.", "createdAt": "2020-03-18T11:14:29Z", "url": "https://github.com/nuxeo/nuxeo/pull/3844", "merged": true, "mergeCommit": {"oid": "b756104a386ed2918dbae780e2890dc15e174115"}, "closed": true, "closedAt": "2020-03-24T08:47:14Z", "author": {"login": "troger"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPc9C9ABqjMxNDg1NDk5ODM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQbLRQgFqTM3OTI3MDUxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d774f192de1777ab6ca199732799342f566be6a3", "author": {"user": {"login": "troger", "name": "Thomas Roger"}}, "url": "https://github.com/nuxeo/nuxeo/commit/d774f192de1777ab6ca199732799342f566be6a3", "committedDate": "2020-03-18T11:13:39Z", "message": "NXP-28504: release when merging on master\n\nUse only on Jenkinsfile to build PRs and release reference\nbranches."}, "afterCommit": {"oid": "3a33e2075a80277f1fce1ce1035d2ba8c17035ee", "author": {"user": {"login": "troger", "name": "Thomas Roger"}}, "url": "https://github.com/nuxeo/nuxeo/commit/3a33e2075a80277f1fce1ce1035d2ba8c17035ee", "committedDate": "2020-03-20T09:18:46Z", "message": "NXP-28504: release when merging on master\n\nUse only on Jenkinsfile to build PRs and release reference\nbranches."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3a33e2075a80277f1fce1ce1035d2ba8c17035ee", "author": {"user": {"login": "troger", "name": "Thomas Roger"}}, "url": "https://github.com/nuxeo/nuxeo/commit/3a33e2075a80277f1fce1ce1035d2ba8c17035ee", "committedDate": "2020-03-20T09:18:46Z", "message": "NXP-28504: release when merging on master\n\nUse only on Jenkinsfile to build PRs and release reference\nbranches."}, "afterCommit": {"oid": "71e2141d6ececd9894af56e14502ebe06bbba5ed", "author": {"user": {"login": "troger", "name": "Thomas Roger"}}, "url": "https://github.com/nuxeo/nuxeo/commit/71e2141d6ececd9894af56e14502ebe06bbba5ed", "committedDate": "2020-03-20T10:26:02Z", "message": "NXP-28504: release when merging on master\n\nUse only on Jenkinsfile to build PRs and release reference\nbranches."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4MzczNzc2", "url": "https://github.com/nuxeo/nuxeo/pull/3844#pullrequestreview-378373776", "createdAt": "2020-03-20T10:34:56Z", "commit": {"oid": "3a33e2075a80277f1fce1ce1035d2ba8c17035ee"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxMDozNTo0M1rOF5OnTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxMDo1Njo0MlrOF5PN0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTU1MjU4OA==", "bodyText": "Then you also release when on reference branches ? The commit message talks about master", "url": "https://github.com/nuxeo/nuxeo/pull/3844#discussion_r395552588", "createdAt": "2020-03-20T10:35:43Z", "author": {"login": "NourNuxeo"}, "path": "Jenkinsfile", "diffHunk": "@@ -40,9 +41,45 @@ void setGitHubBuildStatus(String context, String message, String state) {\n   ])\n }\n \n+String getMavenArgs() {\n+  def args = '-B -nsu'\n+  if (!isPullRequest()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71e2141d6ececd9894af56e14502ebe06bbba5ed"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTU1MzI2Nw==", "bodyText": "could be one lined ?", "url": "https://github.com/nuxeo/nuxeo/pull/3844#discussion_r395553267", "createdAt": "2020-03-20T10:37:08Z", "author": {"login": "NourNuxeo"}, "path": "Jenkinsfile", "diffHunk": "@@ -40,9 +41,45 @@ void setGitHubBuildStatus(String context, String message, String state) {\n   ])\n }\n \n+String getMavenArgs() {\n+  def args = '-B -nsu'\n+  if (!isPullRequest()) {\n+    args += ' -Prelease'\n+  }\n+  return args\n+}\n+\n+def isPullRequest() {\n+  return BRANCH_NAME =~ /PR-.*/\n+}\n+\n String getVersion() {\n+  return isPullRequest() ? getPullRequestVersion() : getReleaseVersion()\n+}\n+\n+String getReleaseVersion() {\n   String nuxeoVersion = readMavenPom().getVersion()\n-  return BRANCH_NAME == 'master' ? nuxeoVersion : \"${BRANCH_NAME}-\" + nuxeoVersion\n+  String noSnapshot = nuxeoVersion.replace(\"-SNAPSHOT\", \"\")\n+  String version = noSnapshot + '.0' // first version ever\n+\n+  // find the latest tag if any\n+  sh \"git fetch origin 'refs/tags/v${noSnapshot}*:refs/tags/v${noSnapshot}*'\"\n+  def tag = sh(returnStdout: true, script: \"git tag --sort=committerdate --list 'v${noSnapshot}*' | tail -1 | tr -d '\\n'\")\n+  if (tag) {\n+    container('maven') {\n+      version = sh(returnStdout: true, script: \"semver bump patch ${tag} | tr -d '\\n'\")\n+    }\n+  }\n+  return version\n+}\n+\n+String getPullRequestVersion() {\n+  String nuxeoVersion = readMavenPom().getVersion()\n+  return \"${BRANCH_NAME}-\" + nuxeoVersion", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71e2141d6ececd9894af56e14502ebe06bbba5ed"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTU2MjQ1MA==", "bodyText": "There are new lines here and there that could be regrouped in a cleanup commit", "url": "https://github.com/nuxeo/nuxeo/pull/3844#discussion_r395562450", "createdAt": "2020-03-20T10:56:42Z", "author": {"login": "NourNuxeo"}, "path": "Jenkinsfile", "diffHunk": "@@ -268,10 +314,33 @@ pipeline {\n           sh \"\"\"\n             mvn ${MAVEN_ARGS} -Pdistrib,docker versions:set -DnewVersion=${VERSION} -DgenerateBackupPoms=false\n             perl -i -pe 's|<nuxeo.platform.version>.*?</nuxeo.platform.version>|<nuxeo.platform.version>${VERSION}</nuxeo.platform.version>|' pom.xml\n+            perl -i -pe 's|org.nuxeo.ecm.product.version=.*|org.nuxeo.ecm.product.version=${VERSION}|' nuxeo-distribution/nuxeo-nxr-server/src/main/resources/templates/nuxeo.defaults\n+          \"\"\"\n+        }\n+      }\n+    }\n+\n+    stage('Git commit') {\n+      when {\n+        not {\n+          branch 'PR-*'\n+        }\n+      }\n+      steps {\n+        container('maven') {\n+          echo \"\"\"\n+          ----------------------------------------\n+          Git commit\n+          ----------------------------------------\n+          \"\"\"\n+          sh \"\"\"\n+            git add .\n+            git commit -m \"Release ${VERSION}\"\n           \"\"\"\n         }\n       }\n     }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71e2141d6ececd9894af56e14502ebe06bbba5ed"}, "originalPosition": 141}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "71e2141d6ececd9894af56e14502ebe06bbba5ed", "author": {"user": {"login": "troger", "name": "Thomas Roger"}}, "url": "https://github.com/nuxeo/nuxeo/commit/71e2141d6ececd9894af56e14502ebe06bbba5ed", "committedDate": "2020-03-20T10:26:02Z", "message": "NXP-28504: release when merging on master\n\nUse only on Jenkinsfile to build PRs and release reference\nbranches."}, "afterCommit": {"oid": "ca7f5d99e573dc36ca8a6a001ba5d132f9e6ba95", "author": {"user": {"login": "troger", "name": "Thomas Roger"}}, "url": "https://github.com/nuxeo/nuxeo/commit/ca7f5d99e573dc36ca8a6a001ba5d132f9e6ba95", "committedDate": "2020-03-20T13:24:51Z", "message": "NXP-28504: release when merging on reference branches\n\nUse only on Jenkinsfile to build PRs and release reference\nbranches."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99e5daa76f80646f563407281b108eebcc208d3e", "author": {"user": {"login": "troger", "name": "Thomas Roger"}}, "url": "https://github.com/nuxeo/nuxeo/commit/99e5daa76f80646f563407281b108eebcc208d3e", "committedDate": "2020-03-20T13:50:50Z", "message": "NXP-28504: release when merging on reference branches\n\nUse only on Jenkinsfile to build PRs and release reference\nbranches."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ca7f5d99e573dc36ca8a6a001ba5d132f9e6ba95", "author": {"user": {"login": "troger", "name": "Thomas Roger"}}, "url": "https://github.com/nuxeo/nuxeo/commit/ca7f5d99e573dc36ca8a6a001ba5d132f9e6ba95", "committedDate": "2020-03-20T13:24:51Z", "message": "NXP-28504: release when merging on reference branches\n\nUse only on Jenkinsfile to build PRs and release reference\nbranches."}, "afterCommit": {"oid": "99e5daa76f80646f563407281b108eebcc208d3e", "author": {"user": {"login": "troger", "name": "Thomas Roger"}}, "url": "https://github.com/nuxeo/nuxeo/commit/99e5daa76f80646f563407281b108eebcc208d3e", "committedDate": "2020-03-20T13:50:50Z", "message": "NXP-28504: release when merging on reference branches\n\nUse only on Jenkinsfile to build PRs and release reference\nbranches."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NTA1Nzkw", "url": "https://github.com/nuxeo/nuxeo/pull/3844#pullrequestreview-378505790", "createdAt": "2020-03-20T13:58:39Z", "commit": {"oid": "99e5daa76f80646f563407281b108eebcc208d3e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NjEwMzk0", "url": "https://github.com/nuxeo/nuxeo/pull/3844#pullrequestreview-378610394", "createdAt": "2020-03-20T15:59:21Z", "commit": {"oid": "99e5daa76f80646f563407281b108eebcc208d3e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5MjcwNTE5", "url": "https://github.com/nuxeo/nuxeo/pull/3844#pullrequestreview-379270519", "createdAt": "2020-03-23T09:48:37Z", "commit": {"oid": "99e5daa76f80646f563407281b108eebcc208d3e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4807, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}