{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5NDgyMjM2", "number": 4544, "title": "NXP-29969: component manager listener", "bodyText": "", "createdAt": "2020-12-14T14:11:42Z", "url": "https://github.com/nuxeo/nuxeo/pull/4544", "merged": true, "mergeCommit": {"oid": "ed3e03283b379313c623a18c3b1859ee8c7c792e"}, "closed": true, "closedAt": "2021-01-12T08:40:22Z", "author": {"login": "atchertchian"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdoZ1KZABqjQxMzcwNTk2Mzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdvHWUDgFqTU2NTM5OTk5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "48cbd6a71c3d31226794f7320c7e2201b90efca7", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/48cbd6a71c3d31226794f7320c7e2201b90efca7", "committedDate": "2020-12-14T14:10:45Z", "message": "mark listeners to be reviewed (WIP)"}, "afterCommit": {"oid": "54030b3d214c43b473ebffada2b93b68826a18cb", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/54030b3d214c43b473ebffada2b93b68826a18cb", "committedDate": "2020-12-21T17:59:37Z", "message": "NXP-29969: adapt components registering component manager listeners"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "54030b3d214c43b473ebffada2b93b68826a18cb", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/54030b3d214c43b473ebffada2b93b68826a18cb", "committedDate": "2020-12-21T17:59:37Z", "message": "NXP-29969: adapt components registering component manager listeners"}, "afterCommit": {"oid": "632df06619e4fa8f7ad6a843809bed25acfc635c", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/632df06619e4fa8f7ad6a843809bed25acfc635c", "committedDate": "2020-12-22T09:38:12Z", "message": "NXP-29969: adapt components registering component manager listeners"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2OTk4NzYx", "url": "https://github.com/nuxeo/nuxeo/pull/4544#pullrequestreview-556998761", "createdAt": "2020-12-22T11:06:15Z", "commit": {"oid": "5d37accf92cfea39967d740d496a46ecd6932fb9"}, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxMTowNjoxNVrOIJ3Vzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxMToxNzoxNlrOIJ3pPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIxNDc5OA==", "bodyText": "Old code but = 0 is redundant. You should probably keep Bogdan's name in the contributors as well.", "url": "https://github.com/nuxeo/nuxeo/pull/4544#discussion_r547214798", "createdAt": "2020-12-22T11:06:15Z", "author": {"login": "efge"}, "path": "modules/runtime/nuxeo-runtime-test/src/test/java/org/nuxeo/runtime/MockEventsInfo.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Anahide Tchertchian\n+ */\n+package org.nuxeo.runtime;\n+\n+/**\n+ * @since 11.5\n+ */\n+public class MockEventsInfo {\n+\n+    public int beforeStop = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d37accf92cfea39967d740d496a46ecd6932fb9"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIxOTc3Mg==", "bodyText": "Maybe change the debug messages?", "url": "https://github.com/nuxeo/nuxeo/pull/4544#discussion_r547219772", "createdAt": "2020-12-22T11:17:16Z", "author": {"login": "efge"}, "path": "modules/runtime/nuxeo-runtime-stream/src/main/java/org/nuxeo/runtime/stream/StreamServiceImpl.java", "diffHunk": "@@ -247,21 +246,18 @@ public void stopProcessors() {\n         processors.clear();\n     }\n \n-    protected class ComponentsLifeCycleListener implements ComponentManager.Listener {\n-        @Override\n-        public void afterStart(ComponentManager mgr, boolean isResume) {\n-            // this is called once all components are started and ready\n-            log.debug(\"afterStart\");\n-            startProcessors();\n-        }\n+    @Override\n+    public void afterRuntimeStart(ComponentManager mgr, boolean isResume) {\n+        // this is called once all components are started and ready\n+        log.debug(\"afterStart\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "632df06619e4fa8f7ad6a843809bed25acfc635c"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3MDQ3NTI1", "url": "https://github.com/nuxeo/nuxeo/pull/4544#pullrequestreview-557047525", "createdAt": "2020-12-22T12:35:30Z", "commit": {"oid": "632df06619e4fa8f7ad6a843809bed25acfc635c"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "632df06619e4fa8f7ad6a843809bed25acfc635c", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/632df06619e4fa8f7ad6a843809bed25acfc635c", "committedDate": "2020-12-22T09:38:12Z", "message": "NXP-29969: adapt components registering component manager listeners"}, "afterCommit": {"oid": "2c4ec2dd611a7ca219958d73c20a1bfb1ffe7210", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/2c4ec2dd611a7ca219958d73c20a1bfb1ffe7210", "committedDate": "2020-12-22T12:44:00Z", "message": "NXP-29969: adapt components registering component manager listeners"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2c4ec2dd611a7ca219958d73c20a1bfb1ffe7210", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/2c4ec2dd611a7ca219958d73c20a1bfb1ffe7210", "committedDate": "2020-12-22T12:44:00Z", "message": "NXP-29969: adapt components registering component manager listeners"}, "afterCommit": {"oid": "c86c17316abd7a52d4491a4a5e58e74d2a0ef884", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/c86c17316abd7a52d4491a4a5e58e74d2a0ef884", "committedDate": "2020-12-22T13:14:02Z", "message": "NXP-29969: adapt components registering component manager listeners"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "96f2f0c81b6114f030be63d3c9b5eba49541e358", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/96f2f0c81b6114f030be63d3c9b5eba49541e358", "committedDate": "2020-12-22T17:04:42Z", "message": "NXP-29969: call listener start methods following start order on components"}, "afterCommit": {"oid": "2c43aecd4ebb153c196f13f7dd6ec85b722e6641", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/2c43aecd4ebb153c196f13f7dd6ec85b722e6641", "committedDate": "2020-12-23T09:12:58Z", "message": "NXP-29969: call listener start methods following start order on components"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3NzY3NDI2", "url": "https://github.com/nuxeo/nuxeo/pull/4544#pullrequestreview-557767426", "createdAt": "2020-12-23T10:04:26Z", "commit": {"oid": "2c43aecd4ebb153c196f13f7dd6ec85b722e6641"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxMDowNDoyNlrOIKfzWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxMDowNDoyNlrOIKfzWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzg3NzcyMA==", "bodyText": "To be consistent I think that stop should use the reverse order.", "url": "https://github.com/nuxeo/nuxeo/pull/4544#discussion_r547877720", "createdAt": "2020-12-23T10:04:26Z", "author": {"login": "efge"}, "path": "modules/runtime/nuxeo-runtime/src/main/java/org/nuxeo/runtime/model/impl/ComponentManagerImpl.java", "diffHunk": "@@ -1283,49 +1293,63 @@ public void remove(ComponentManager.Listener listener) {\n \n         public void beforeActivation() {\n             for (Object listener : listeners.getListeners()) {\n-                ((ComponentManager.Listener) listener).beforeActivation(ComponentManagerImpl.this);\n+                ((ComponentManager.Listener) listener).beforeRuntimeActivation(ComponentManagerImpl.this);\n             }\n         }\n \n         public void afterActivation() {\n             for (Object listener : listeners.getListeners()) {\n-                ((ComponentManager.Listener) listener).afterActivation(ComponentManagerImpl.this);\n+                ((ComponentManager.Listener) listener).afterRuntimeActivation(ComponentManagerImpl.this);\n             }\n         }\n \n         public void beforeDeactivation() {\n             for (Object listener : listeners.getListeners()) {\n-                ((ComponentManager.Listener) listener).beforeDeactivation(ComponentManagerImpl.this);\n+                ((ComponentManager.Listener) listener).beforeRuntimeDeactivation(ComponentManagerImpl.this);\n             }\n         }\n \n         public void afterDeactivation() {\n             for (Object listener : listeners.getListeners()) {\n-                ((ComponentManager.Listener) listener).afterDeactivation(ComponentManagerImpl.this);\n+                ((ComponentManager.Listener) listener).afterRuntimeDeactivation(ComponentManagerImpl.this);\n             }\n         }\n \n+        /**\n+         * Sort listeners to follow start order on components.\n+         *\n+         * @since 11.5\n+         */\n+        protected Stream<ComponentManager.Listener> sortedForStart() {\n+            Stream<ComponentManager.Listener> regularListeners = Arrays.stream(listeners.getListeners())\n+                                                                       .filter(l -> !(l instanceof Component))\n+                                                                       .map(ComponentManager.Listener.class::cast);\n+            Stream<ComponentManager.Listener> componentListeners = Arrays.stream(listeners.getListeners())\n+                                                                         .filter(Component.class::isInstance)\n+                                                                         .map(Component.class::cast)\n+                                                                         .sorted(Comparator.comparingInt(\n+                                                                                 Component::getApplicationStartedOrder))\n+                                                                         .map(ComponentManager.Listener.class::cast);\n+            return Stream.concat(regularListeners, componentListeners);\n+        }\n+\n         public void beforeStart(boolean isResume) {\n-            for (Object listener : listeners.getListeners()) {\n-                ((ComponentManager.Listener) listener).beforeStart(ComponentManagerImpl.this, isResume);\n-            }\n+            sortedForStart().forEach(listener -> listener.beforeRuntimeStart(ComponentManagerImpl.this, isResume));\n         }\n \n         public void afterStart(boolean isResume) {\n-            for (Object listener : listeners.getListeners()) {\n-                ((ComponentManager.Listener) listener).afterStart(ComponentManagerImpl.this, isResume);\n-            }\n+            sortedForStart().forEach(listener -> listener.afterRuntimeStart(ComponentManagerImpl.this, isResume));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c43aecd4ebb153c196f13f7dd6ec85b722e6641"}, "originalPosition": 109}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2c43aecd4ebb153c196f13f7dd6ec85b722e6641", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/2c43aecd4ebb153c196f13f7dd6ec85b722e6641", "committedDate": "2020-12-23T09:12:58Z", "message": "NXP-29969: call listener start methods following start order on components"}, "afterCommit": {"oid": "07009317c32bc733d4ed95cf2d3910241f02b507", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/07009317c32bc733d4ed95cf2d3910241f02b507", "committedDate": "2020-12-23T10:10:23Z", "message": "NXP-29969: call listener start/stop methods following start order on components"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3Nzc0NjA4", "url": "https://github.com/nuxeo/nuxeo/pull/4544#pullrequestreview-557774608", "createdAt": "2020-12-23T10:16:56Z", "commit": {"oid": "07009317c32bc733d4ed95cf2d3910241f02b507"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "07009317c32bc733d4ed95cf2d3910241f02b507", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/07009317c32bc733d4ed95cf2d3910241f02b507", "committedDate": "2020-12-23T10:10:23Z", "message": "NXP-29969: call listener start/stop methods following start order on components"}, "afterCommit": {"oid": "03222b49058495bc8fa66965f849e8239643d7c8", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/03222b49058495bc8fa66965f849e8239643d7c8", "committedDate": "2020-12-23T10:59:51Z", "message": "NXP-29969: call listener start/stop methods following start order on components"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3ODc3MTEz", "url": "https://github.com/nuxeo/nuxeo/pull/4544#pullrequestreview-557877113", "createdAt": "2020-12-23T13:46:36Z", "commit": {"oid": "03222b49058495bc8fa66965f849e8239643d7c8"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e632bb72d6bdb5c71cd540619c681ae6eb0d208", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/9e632bb72d6bdb5c71cd540619c681ae6eb0d208", "committedDate": "2021-01-08T08:21:31Z", "message": "NXP-29969: automatically register as listeners all components that implement the listener interface"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce467e14bc2f1bb6e9c08128936b7149d0c39550", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/ce467e14bc2f1bb6e9c08128936b7149d0c39550", "committedDate": "2021-01-08T08:21:31Z", "message": "NXP-29969: add alternative API for ComponentManager.Listener"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "03222b49058495bc8fa66965f849e8239643d7c8", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/03222b49058495bc8fa66965f849e8239643d7c8", "committedDate": "2020-12-23T10:59:51Z", "message": "NXP-29969: call listener start/stop methods following start order on components"}, "afterCommit": {"oid": "e8f23d44e4faee8ccdcaa5e1123031c50111092e", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/e8f23d44e4faee8ccdcaa5e1123031c50111092e", "committedDate": "2021-01-08T08:21:32Z", "message": "NXP-29969: call listener start/stop methods following start order on components"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2a32a99573b9f30b632d9885ff341850e54c589", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/d2a32a99573b9f30b632d9885ff341850e54c589", "committedDate": "2021-01-08T17:03:50Z", "message": "NXP-29969: adapt components registering component manager listeners"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "278ac779a30e3e8c392232304a0e54758d39f7c7", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/278ac779a30e3e8c392232304a0e54758d39f7c7", "committedDate": "2021-01-08T17:03:50Z", "message": "NXP-29969: call listener start/stop methods following start order on components"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e8f23d44e4faee8ccdcaa5e1123031c50111092e", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/e8f23d44e4faee8ccdcaa5e1123031c50111092e", "committedDate": "2021-01-08T08:21:32Z", "message": "NXP-29969: call listener start/stop methods following start order on components"}, "afterCommit": {"oid": "278ac779a30e3e8c392232304a0e54758d39f7c7", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/278ac779a30e3e8c392232304a0e54758d39f7c7", "committedDate": "2021-01-08T17:03:50Z", "message": "NXP-29969: call listener start/stop methods following start order on components"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY1Mzk5OTk3", "url": "https://github.com/nuxeo/nuxeo/pull/4544#pullrequestreview-565399997", "createdAt": "2021-01-11T14:25:23Z", "commit": {"oid": "278ac779a30e3e8c392232304a0e54758d39f7c7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4917, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}