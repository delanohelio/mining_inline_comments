{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExNjcyNTc1", "number": 4420, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMDowMTo0MVrOE2sFZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMDowNTowM1rOE2sKYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1NzgwODM4OnYy", "diffSide": "RIGHT", "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/main/java/org/nuxeo/ecm/core/storage/sql/S3DirectBatchHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMDowMTo0MVrOHvnH7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMDowMTo0MVrOHvnH7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY4NjEyNw==", "bodyText": "Could you add a Javadoc explaining that it returns the ETag of the resulting blob?", "url": "https://github.com/nuxeo/nuxeo/pull/4420#discussion_r519686127", "createdAt": "2020-11-09T10:01:41Z", "author": {"login": "efge"}, "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/main/java/org/nuxeo/ecm/core/storage/sql/S3DirectBatchHandler.java", "diffHunk": "@@ -339,6 +334,19 @@ public boolean completeUpload(String batchId, String fileIndex, BatchFileInfo fi\n         return true;\n     }\n \n+    protected String doMove(CopyObjectRequest request) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61823cd62fe9f84e2862dc8e804428e2697f3d84"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1NzgyMTE0OnYy", "diffSide": "RIGHT", "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/main/java/org/nuxeo/ecm/core/storage/sql/S3DirectBatchHandler.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMDowNTowM1rOHvnQHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMTo0MToxNVrOHvqv2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY4ODIyMg==", "bodyText": "Should we also catch AmazonS3Exception for this delete and just log a debug, like in the case where doesObjectExist returns true?", "url": "https://github.com/nuxeo/nuxeo/pull/4420#discussion_r519688222", "createdAt": "2020-11-09T10:05:03Z", "author": {"login": "efge"}, "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/main/java/org/nuxeo/ecm/core/storage/sql/S3DirectBatchHandler.java", "diffHunk": "@@ -339,6 +334,19 @@ public boolean completeUpload(String batchId, String fileIndex, BatchFileInfo fi\n         return true;\n     }\n \n+    protected String doMove(CopyObjectRequest request) {\n+        Copy rename = getTransferManager().copy(request);\n+        try {\n+            var copyResult = rename.waitForCopyResult();\n+            return copyResult.getETag();\n+        } catch (InterruptedException e) {\n+            Thread.currentThread().interrupt();\n+            throw new NuxeoException(e);\n+        } finally {\n+            amazonS3.deleteObject(bucket, request.getSourceKey());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61823cd62fe9f84e2862dc8e804428e2697f3d84"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc0MzMzNQ==", "bodyText": "I think so, object deletion shouldn't fail the upload if failing.", "url": "https://github.com/nuxeo/nuxeo/pull/4420#discussion_r519743335", "createdAt": "2020-11-09T11:37:19Z", "author": {"login": "kevinleturc"}, "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/main/java/org/nuxeo/ecm/core/storage/sql/S3DirectBatchHandler.java", "diffHunk": "@@ -339,6 +334,19 @@ public boolean completeUpload(String batchId, String fileIndex, BatchFileInfo fi\n         return true;\n     }\n \n+    protected String doMove(CopyObjectRequest request) {\n+        Copy rename = getTransferManager().copy(request);\n+        try {\n+            var copyResult = rename.waitForCopyResult();\n+            return copyResult.getETag();\n+        } catch (InterruptedException e) {\n+            Thread.currentThread().interrupt();\n+            throw new NuxeoException(e);\n+        } finally {\n+            amazonS3.deleteObject(bucket, request.getSourceKey());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY4ODIyMg=="}, "originalCommit": {"oid": "61823cd62fe9f84e2862dc8e804428e2697f3d84"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc0NTQ5OA==", "bodyText": "I will also try/catch/addSuppressed at this location https://github.com/nuxeo/nuxeo/pull/4420/files#diff-6840572d6cd2147c22a5ea5800d2525059bb39c001a5909d15f0370f9ee506d8R330 to not shallow the original NuxeoException.", "url": "https://github.com/nuxeo/nuxeo/pull/4420#discussion_r519745498", "createdAt": "2020-11-09T11:41:15Z", "author": {"login": "kevinleturc"}, "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/main/java/org/nuxeo/ecm/core/storage/sql/S3DirectBatchHandler.java", "diffHunk": "@@ -339,6 +334,19 @@ public boolean completeUpload(String batchId, String fileIndex, BatchFileInfo fi\n         return true;\n     }\n \n+    protected String doMove(CopyObjectRequest request) {\n+        Copy rename = getTransferManager().copy(request);\n+        try {\n+            var copyResult = rename.waitForCopyResult();\n+            return copyResult.getETag();\n+        } catch (InterruptedException e) {\n+            Thread.currentThread().interrupt();\n+            throw new NuxeoException(e);\n+        } finally {\n+            amazonS3.deleteObject(bucket, request.getSourceKey());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY4ODIyMg=="}, "originalCommit": {"oid": "61823cd62fe9f84e2862dc8e804428e2697f3d84"}, "originalPosition": 94}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4386, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}