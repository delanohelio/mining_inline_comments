{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyNTk3NDg3", "number": 3664, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDoxNzo0N1rODYhGNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxMDo0MDo1M1rODd-ywg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3MDM0Njc2OnYy", "diffSide": "RIGHT", "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDoxNzo0N1rOFeaz9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNToxNzo0MFrOFec-Jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ0MDg4Nw==", "bodyText": "No risk of NPE on parentComment here?", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r367440887", "createdAt": "2020-01-16T14:17:47Z", "author": {"login": "ataillefer"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java", "diffHunk": "@@ -133,13 +135,22 @@ public static String getExpectedMailContent(DocumentModel commentDocModel, Docum\n             Event event, String commentEventType) {\n         URL url = CommentUtils.class.getResource(\"/templates/commentNotificationMail.txt\");\n         try {\n-            String content = Files.readString(Paths.get(url.toURI()));\n             var model = Map.of(\"COMMENT_AUTHOR\", commentDocModel.getPropertyValue(COMMENT_AUTHOR), //\n                     \"COMMENT_ACTION\", COMMENT_ADDED.equals(commentEventType) ? \"added\" : \"updated\", //\n                     \"COMMENTED_DOCUMENT\", commentedDocModel.getName(), //\n                     \"COMMENT_DATE\", EVENT_DATE_FORMAT.format(Date.from(Instant.ofEpochMilli(event.getTime()))), //\n                     \"COMMENT_TEXT\", commentDocModel.getPropertyValue(COMMENT_TEXT), //\n                     \"COMMENT_SUBSCRIPTION_NAME\", COMMENT_ADDED.equals(commentEventType) ? \"New\" : \"Updated\");\n+            DocumentModel parentComment = (DocumentModel) event.getContext().getProperties().get(PARENT_COMMENT);\n+            if (COMMENT_DOC_TYPE.equals(parentComment.getType())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ3NjI2Mw==", "bodyText": "parentComment is not the best name for it. It is the source doc of the event so parentComment can actually be the commented top level document. It is always available: \n  \n    \n      nuxeo/nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/java/org/nuxeo/ecm/platform/comment/impl/AbstractCommentManager.java\n    \n    \n         Line 122\n      in\n      3e2515b\n    \n    \n    \n    \n\n        \n          \n           props.put(CommentConstants.PARENT_COMMENT, commentedDoc); \n        \n    \n  \n\n\nTOP_LEVEL_DOCUMENT is always the top level, when it differs from PARENT_COMMENT then we know the new comment is a reply.", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r367476263", "createdAt": "2020-01-16T15:17:40Z", "author": {"login": "NourNuxeo"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java", "diffHunk": "@@ -133,13 +135,22 @@ public static String getExpectedMailContent(DocumentModel commentDocModel, Docum\n             Event event, String commentEventType) {\n         URL url = CommentUtils.class.getResource(\"/templates/commentNotificationMail.txt\");\n         try {\n-            String content = Files.readString(Paths.get(url.toURI()));\n             var model = Map.of(\"COMMENT_AUTHOR\", commentDocModel.getPropertyValue(COMMENT_AUTHOR), //\n                     \"COMMENT_ACTION\", COMMENT_ADDED.equals(commentEventType) ? \"added\" : \"updated\", //\n                     \"COMMENTED_DOCUMENT\", commentedDocModel.getName(), //\n                     \"COMMENT_DATE\", EVENT_DATE_FORMAT.format(Date.from(Instant.ofEpochMilli(event.getTime()))), //\n                     \"COMMENT_TEXT\", commentDocModel.getPropertyValue(COMMENT_TEXT), //\n                     \"COMMENT_SUBSCRIPTION_NAME\", COMMENT_ADDED.equals(commentEventType) ? \"New\" : \"Updated\");\n+            DocumentModel parentComment = (DocumentModel) event.getContext().getProperties().get(PARENT_COMMENT);\n+            if (COMMENT_DOC_TYPE.equals(parentComment.getType())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ0MDg4Nw=="}, "originalCommit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3MDM1MzY0OnYy", "diffSide": "RIGHT", "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/resources/templates/commentReplyNotificationMail.txt", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDoxOTo0NFrOFea4Jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNTo0ODo0M1rOFeeGuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ0MTk1OQ==", "bodyText": "Shouldn't this word be part of a sentence?", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r367441959", "createdAt": "2020-01-16T14:19:44Z", "author": {"login": "ataillefer"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/resources/templates/commentReplyNotificationMail.txt", "diffHunk": "@@ -0,0 +1,13 @@\n+\n+(${COMMENT_AUTHOR}) has ${COMMENT_ACTION} a comment on ${COMMENTED_DOCUMENT} at ${COMMENT_DATE}.\n+\n+says:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ3OTk3NA==", "bodyText": "This is copied after b3f5a88#diff-d2958c7a23840da67a3967810afb6babR4 which is merged.\nMy real contribution  is lines [6-9]", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r367479974", "createdAt": "2020-01-16T15:24:01Z", "author": {"login": "NourNuxeo"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/resources/templates/commentReplyNotificationMail.txt", "diffHunk": "@@ -0,0 +1,13 @@\n+\n+(${COMMENT_AUTHOR}) has ${COMMENT_ACTION} a comment on ${COMMENTED_DOCUMENT} at ${COMMENT_DATE}.\n+\n+says:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ0MTk1OQ=="}, "originalCommit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ5NDg0MQ==", "bodyText": "to give more context about this, i created this template for test, based on the real content of the mail:\n(Administrator) has added a comment on test at 30/12/2019 - 15:38.\n\n\nsays:\n\nany Comment message\n\n\n\u00bb See all the comments of the document", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r367494841", "createdAt": "2020-01-16T15:48:43Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/resources/templates/commentReplyNotificationMail.txt", "diffHunk": "@@ -0,0 +1,13 @@\n+\n+(${COMMENT_AUTHOR}) has ${COMMENT_ACTION} a comment on ${COMMENTED_DOCUMENT} at ${COMMENT_DATE}.\n+\n+says:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ0MTk1OQ=="}, "originalCommit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3MDY3NjAzOnYy", "diffSide": "RIGHT", "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/resources/templates/quotedComments.ftl", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNTo0NjoxNlrOFeeAUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxMToyNDozOFrOFg65iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ5MzIwMw==", "bodyText": "missing line at the end of the file", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r367493203", "createdAt": "2020-01-16T15:46:16Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/resources/templates/quotedComments.ftl", "diffHunk": "@@ -0,0 +1,9 @@\n+<p style=\"margin:0;font-size:13px;\">${htmlEscape(principalAuthor.firstName)} says:</p>\n+<p style=\"margin:0;font-size:13px;\">${comment_text}</p>\n+<br/>\n+<#if parentComment.type == \"Comment\">\n+  <p style=\"margin:0;font-size:13px;\">It is a reply to the following comment:</p>\n+  <p style=\"margin:0;font-size:13px;\">${htmlEscape(parentComment.comment.author)} says:</p>\n+  <p style=\"margin:0;font-size:13px;\">${parentComment.comment.text}</p>\n+  <br/>\n+</#if>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA2Mzc1NQ==", "bodyText": "there not line at the end :)", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r370063755", "createdAt": "2020-01-23T11:24:38Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/resources/templates/quotedComments.ftl", "diffHunk": "@@ -0,0 +1,9 @@\n+<p style=\"margin:0;font-size:13px;\">${htmlEscape(principalAuthor.firstName)} says:</p>\n+<p style=\"margin:0;font-size:13px;\">${comment_text}</p>\n+<br/>\n+<#if parentComment.type == \"Comment\">\n+  <p style=\"margin:0;font-size:13px;\">It is a reply to the following comment:</p>\n+  <p style=\"margin:0;font-size:13px;\">${htmlEscape(parentComment.comment.author)} says:</p>\n+  <p style=\"margin:0;font-size:13px;\">${parentComment.comment.text}</p>\n+  <br/>\n+</#if>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ5MzIwMw=="}, "originalCommit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDE2ODQ3OnYy", "diffSide": "RIGHT", "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java", "isResolved": true, "comments": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNzowNTo1MFrOFe_fiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMDowMDozOFrOFhYxjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA0MTg2Nw==", "bodyText": "Map<String, Serializable> modelWithReplyInfos = new HashMap<>(model); to avoid  modelWithReplyInfos.putAll(model);", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r368041867", "createdAt": "2020-01-17T17:05:50Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java", "diffHunk": "@@ -122,13 +135,22 @@ public static String getExpectedMailContent(DocumentModel commentDocModel, Docum\n             Event event, String commentEventType) {\n         URL url = CommentUtils.class.getResource(\"/templates/commentNotificationMail.txt\");\n         try {\n-            String content = Files.readString(Paths.get(url.toURI()));\n             var model = Map.of(\"COMMENT_AUTHOR\", commentDocModel.getPropertyValue(COMMENT_AUTHOR), //\n                     \"COMMENT_ACTION\", COMMENT_ADDED.equals(commentEventType) ? \"added\" : \"updated\", //\n                     \"COMMENTED_DOCUMENT\", commentedDocModel.getName(), //\n                     \"COMMENT_DATE\", EVENT_DATE_FORMAT.format(Date.from(Instant.ofEpochMilli(event.getTime()))), //\n                     \"COMMENT_TEXT\", commentDocModel.getPropertyValue(COMMENT_TEXT), //\n                     \"COMMENT_SUBSCRIPTION_NAME\", COMMENT_ADDED.equals(commentEventType) ? \"New\" : \"Updated\");\n+            DocumentModel parentComment = (DocumentModel) event.getContext().getProperties().get(PARENT_COMMENT);\n+            if (COMMENT_DOC_TYPE.equals(parentComment.getType())) {\n+                url = CommentUtils.class.getResource(\"/templates/commentReplyNotificationMail.txt\");\n+                Map<String, Serializable> modelWithReplyInfos = new HashMap<>();\n+                modelWithReplyInfos.putAll(model);\n+                modelWithReplyInfos.put(\"PARENT_COMMENT_AUTHOR\", parentComment.getPropertyValue(\"comment:author\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA0ODY3NA==", "bodyText": "wdyt if we rework the method:\n  public static String getExpectedMailContent(DocumentModel commentDocModel, DocumentModel commentedDocModel,\n            Event event, String commentEventType) {\n        try {\n            Map<String, Object> model = new HashMap<>(\n                    getDefaultModel(commentDocModel, commentedDocModel, event, commentEventType));\n\n            String templateUrl = \"/templates/commentNotificationMail.txt\";\n            DocumentModel parentComment = (DocumentModel) event.getContext().getProperties().get(PARENT_COMMENT);\n            if (COMMENT_DOC_TYPE.equals(parentComment.getType())) {\n                templateUrl = \"/templates/commentReplyNotificationMail.txt\";\n                model.put(\"PARENT_COMMENT_AUTHOR\", parentComment.getPropertyValue(CommentsConstants.COMMENT_AUTHOR));\n                model.put(\"PARENT_COMMENT_TEXT\", parentComment.getPropertyValue(CommentsConstants.COMMENT_TEXT));\n            }\n            String content = Files.readString(Paths.get(CommentUtils.class.getResource(templateUrl).toURI()));\n            return StringUtils.expandVars(content, model);\n        } catch (URISyntaxException | IOException e) {\n            throw new NuxeoException(e);\n        }\n    }\n\n    protected static Map<String, Object> getDefaultModel(DocumentModel commentDocModel, DocumentModel commentedDocModel,\n            Event event, String commentEventType) {\n        return Map.of(\"COMMENT_AUTHOR\", commentDocModel.getPropertyValue(COMMENT_AUTHOR), //\n                \"COMMENT_ACTION\", COMMENT_ADDED.equals(commentEventType) ? \"added\" : \"updated\", //\n                \"COMMENTED_DOCUMENT\", commentedDocModel.getName(), //\n                \"COMMENT_DATE\", EVENT_DATE_FORMAT.format(Date.from(Instant.ofEpochMilli(event.getTime()))), //\n                \"COMMENT_TEXT\", commentDocModel.getPropertyValue(COMMENT_TEXT), //\n                \"COMMENT_SUBSCRIPTION_NAME\", COMMENT_ADDED.equals(commentEventType) ? \"New\" : \"Updated\");\n    }", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r368048674", "createdAt": "2020-01-17T17:22:12Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java", "diffHunk": "@@ -122,13 +135,22 @@ public static String getExpectedMailContent(DocumentModel commentDocModel, Docum\n             Event event, String commentEventType) {\n         URL url = CommentUtils.class.getResource(\"/templates/commentNotificationMail.txt\");\n         try {\n-            String content = Files.readString(Paths.get(url.toURI()));\n             var model = Map.of(\"COMMENT_AUTHOR\", commentDocModel.getPropertyValue(COMMENT_AUTHOR), //\n                     \"COMMENT_ACTION\", COMMENT_ADDED.equals(commentEventType) ? \"added\" : \"updated\", //\n                     \"COMMENTED_DOCUMENT\", commentedDocModel.getName(), //\n                     \"COMMENT_DATE\", EVENT_DATE_FORMAT.format(Date.from(Instant.ofEpochMilli(event.getTime()))), //\n                     \"COMMENT_TEXT\", commentDocModel.getPropertyValue(COMMENT_TEXT), //\n                     \"COMMENT_SUBSCRIPTION_NAME\", COMMENT_ADDED.equals(commentEventType) ? \"New\" : \"Updated\");\n+            DocumentModel parentComment = (DocumentModel) event.getContext().getProperties().get(PARENT_COMMENT);\n+            if (COMMENT_DOC_TYPE.equals(parentComment.getType())) {\n+                url = CommentUtils.class.getResource(\"/templates/commentReplyNotificationMail.txt\");\n+                Map<String, Serializable> modelWithReplyInfos = new HashMap<>();\n+                modelWithReplyInfos.putAll(model);\n+                modelWithReplyInfos.put(\"PARENT_COMMENT_AUTHOR\", parentComment.getPropertyValue(\"comment:author\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA0MTg2Nw=="}, "originalCommit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA0OTYxOA==", "bodyText": "for further i am wondering what if we use the same template \"/templates/commentNotificationMail.txt\"; and just fill in an empty value for PARENT_COMMENT_AUTHOR and PARENT_COMMENT_TEXT in the case where there is no reply this will reduce the code te maintains\nwdyt :)", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r368049618", "createdAt": "2020-01-17T17:24:23Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java", "diffHunk": "@@ -122,13 +135,22 @@ public static String getExpectedMailContent(DocumentModel commentDocModel, Docum\n             Event event, String commentEventType) {\n         URL url = CommentUtils.class.getResource(\"/templates/commentNotificationMail.txt\");\n         try {\n-            String content = Files.readString(Paths.get(url.toURI()));\n             var model = Map.of(\"COMMENT_AUTHOR\", commentDocModel.getPropertyValue(COMMENT_AUTHOR), //\n                     \"COMMENT_ACTION\", COMMENT_ADDED.equals(commentEventType) ? \"added\" : \"updated\", //\n                     \"COMMENTED_DOCUMENT\", commentedDocModel.getName(), //\n                     \"COMMENT_DATE\", EVENT_DATE_FORMAT.format(Date.from(Instant.ofEpochMilli(event.getTime()))), //\n                     \"COMMENT_TEXT\", commentDocModel.getPropertyValue(COMMENT_TEXT), //\n                     \"COMMENT_SUBSCRIPTION_NAME\", COMMENT_ADDED.equals(commentEventType) ? \"New\" : \"Updated\");\n+            DocumentModel parentComment = (DocumentModel) event.getContext().getProperties().get(PARENT_COMMENT);\n+            if (COMMENT_DOC_TYPE.equals(parentComment.getType())) {\n+                url = CommentUtils.class.getResource(\"/templates/commentReplyNotificationMail.txt\");\n+                Map<String, Serializable> modelWithReplyInfos = new HashMap<>();\n+                modelWithReplyInfos.putAll(model);\n+                modelWithReplyInfos.put(\"PARENT_COMMENT_AUTHOR\", parentComment.getPropertyValue(\"comment:author\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA0MTg2Nw=="}, "originalCommit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA2NDY3Ng==", "bodyText": "what about the proposition of reworking this method as i proposed above: extract the default model, avoid re-affecting the object references ...", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r370064676", "createdAt": "2020-01-23T11:26:50Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java", "diffHunk": "@@ -122,13 +135,22 @@ public static String getExpectedMailContent(DocumentModel commentDocModel, Docum\n             Event event, String commentEventType) {\n         URL url = CommentUtils.class.getResource(\"/templates/commentNotificationMail.txt\");\n         try {\n-            String content = Files.readString(Paths.get(url.toURI()));\n             var model = Map.of(\"COMMENT_AUTHOR\", commentDocModel.getPropertyValue(COMMENT_AUTHOR), //\n                     \"COMMENT_ACTION\", COMMENT_ADDED.equals(commentEventType) ? \"added\" : \"updated\", //\n                     \"COMMENTED_DOCUMENT\", commentedDocModel.getName(), //\n                     \"COMMENT_DATE\", EVENT_DATE_FORMAT.format(Date.from(Instant.ofEpochMilli(event.getTime()))), //\n                     \"COMMENT_TEXT\", commentDocModel.getPropertyValue(COMMENT_TEXT), //\n                     \"COMMENT_SUBSCRIPTION_NAME\", COMMENT_ADDED.equals(commentEventType) ? \"New\" : \"Updated\");\n+            DocumentModel parentComment = (DocumentModel) event.getContext().getProperties().get(PARENT_COMMENT);\n+            if (COMMENT_DOC_TYPE.equals(parentComment.getType())) {\n+                url = CommentUtils.class.getResource(\"/templates/commentReplyNotificationMail.txt\");\n+                Map<String, Serializable> modelWithReplyInfos = new HashMap<>();\n+                modelWithReplyInfos.putAll(model);\n+                modelWithReplyInfos.put(\"PARENT_COMMENT_AUTHOR\", parentComment.getPropertyValue(\"comment:author\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA0MTg2Nw=="}, "originalCommit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE2MDMyOA==", "bodyText": "About the template as we discussed F2F there are also additional lines other than the variables so it's easier to have 2 templates.\nAbout the rework I don't think making a single usage method helps here.\nThis implementation always makes an immutable map and rewrites it to a new HashMap via constructor. But in reality on the 192 tests we have, only 1 does need to add infos on the map and thus rewrite it.", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r370160328", "createdAt": "2020-01-23T14:47:30Z", "author": {"login": "NourNuxeo"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java", "diffHunk": "@@ -122,13 +135,22 @@ public static String getExpectedMailContent(DocumentModel commentDocModel, Docum\n             Event event, String commentEventType) {\n         URL url = CommentUtils.class.getResource(\"/templates/commentNotificationMail.txt\");\n         try {\n-            String content = Files.readString(Paths.get(url.toURI()));\n             var model = Map.of(\"COMMENT_AUTHOR\", commentDocModel.getPropertyValue(COMMENT_AUTHOR), //\n                     \"COMMENT_ACTION\", COMMENT_ADDED.equals(commentEventType) ? \"added\" : \"updated\", //\n                     \"COMMENTED_DOCUMENT\", commentedDocModel.getName(), //\n                     \"COMMENT_DATE\", EVENT_DATE_FORMAT.format(Date.from(Instant.ofEpochMilli(event.getTime()))), //\n                     \"COMMENT_TEXT\", commentDocModel.getPropertyValue(COMMENT_TEXT), //\n                     \"COMMENT_SUBSCRIPTION_NAME\", COMMENT_ADDED.equals(commentEventType) ? \"New\" : \"Updated\");\n+            DocumentModel parentComment = (DocumentModel) event.getContext().getProperties().get(PARENT_COMMENT);\n+            if (COMMENT_DOC_TYPE.equals(parentComment.getType())) {\n+                url = CommentUtils.class.getResource(\"/templates/commentReplyNotificationMail.txt\");\n+                Map<String, Serializable> modelWithReplyInfos = new HashMap<>();\n+                modelWithReplyInfos.putAll(model);\n+                modelWithReplyInfos.put(\"PARENT_COMMENT_AUTHOR\", parentComment.getPropertyValue(\"comment:author\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA0MTg2Nw=="}, "originalCommit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE2ODc1MQ==", "bodyText": "i am talking about the second point avoid modification the map reference object, if you don't add the new method getDefault....the new method,\nyou should avoid \n  \n    \n      nuxeo/nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java\n    \n    \n         Line 150\n      in\n      ab56a1d\n    \n    \n    \n    \n\n        \n          \n           model = modelWithReplyInfos;", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r370168751", "createdAt": "2020-01-23T15:00:45Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java", "diffHunk": "@@ -122,13 +135,22 @@ public static String getExpectedMailContent(DocumentModel commentDocModel, Docum\n             Event event, String commentEventType) {\n         URL url = CommentUtils.class.getResource(\"/templates/commentNotificationMail.txt\");\n         try {\n-            String content = Files.readString(Paths.get(url.toURI()));\n             var model = Map.of(\"COMMENT_AUTHOR\", commentDocModel.getPropertyValue(COMMENT_AUTHOR), //\n                     \"COMMENT_ACTION\", COMMENT_ADDED.equals(commentEventType) ? \"added\" : \"updated\", //\n                     \"COMMENTED_DOCUMENT\", commentedDocModel.getName(), //\n                     \"COMMENT_DATE\", EVENT_DATE_FORMAT.format(Date.from(Instant.ofEpochMilli(event.getTime()))), //\n                     \"COMMENT_TEXT\", commentDocModel.getPropertyValue(COMMENT_TEXT), //\n                     \"COMMENT_SUBSCRIPTION_NAME\", COMMENT_ADDED.equals(commentEventType) ? \"New\" : \"Updated\");\n+            DocumentModel parentComment = (DocumentModel) event.getContext().getProperties().get(PARENT_COMMENT);\n+            if (COMMENT_DOC_TYPE.equals(parentComment.getType())) {\n+                url = CommentUtils.class.getResource(\"/templates/commentReplyNotificationMail.txt\");\n+                Map<String, Serializable> modelWithReplyInfos = new HashMap<>();\n+                modelWithReplyInfos.putAll(model);\n+                modelWithReplyInfos.put(\"PARENT_COMMENT_AUTHOR\", parentComment.getPropertyValue(\"comment:author\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA0MTg2Nw=="}, "originalCommit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE4NDMzMw==", "bodyText": "model is a map I create in the same method, it's not an argument or something external.", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r370184333", "createdAt": "2020-01-23T15:25:09Z", "author": {"login": "NourNuxeo"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java", "diffHunk": "@@ -122,13 +135,22 @@ public static String getExpectedMailContent(DocumentModel commentDocModel, Docum\n             Event event, String commentEventType) {\n         URL url = CommentUtils.class.getResource(\"/templates/commentNotificationMail.txt\");\n         try {\n-            String content = Files.readString(Paths.get(url.toURI()));\n             var model = Map.of(\"COMMENT_AUTHOR\", commentDocModel.getPropertyValue(COMMENT_AUTHOR), //\n                     \"COMMENT_ACTION\", COMMENT_ADDED.equals(commentEventType) ? \"added\" : \"updated\", //\n                     \"COMMENTED_DOCUMENT\", commentedDocModel.getName(), //\n                     \"COMMENT_DATE\", EVENT_DATE_FORMAT.format(Date.from(Instant.ofEpochMilli(event.getTime()))), //\n                     \"COMMENT_TEXT\", commentDocModel.getPropertyValue(COMMENT_TEXT), //\n                     \"COMMENT_SUBSCRIPTION_NAME\", COMMENT_ADDED.equals(commentEventType) ? \"New\" : \"Updated\");\n+            DocumentModel parentComment = (DocumentModel) event.getContext().getProperties().get(PARENT_COMMENT);\n+            if (COMMENT_DOC_TYPE.equals(parentComment.getType())) {\n+                url = CommentUtils.class.getResource(\"/templates/commentReplyNotificationMail.txt\");\n+                Map<String, Serializable> modelWithReplyInfos = new HashMap<>();\n+                modelWithReplyInfos.putAll(model);\n+                modelWithReplyInfos.put(\"PARENT_COMMENT_AUTHOR\", parentComment.getPropertyValue(\"comment:author\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA0MTg2Nw=="}, "originalCommit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE5NDE2OA==", "bodyText": "but it is a map and you can avoid re-affectation, once map is enough here, why use two ?", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r370194168", "createdAt": "2020-01-23T15:41:06Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java", "diffHunk": "@@ -122,13 +135,22 @@ public static String getExpectedMailContent(DocumentModel commentDocModel, Docum\n             Event event, String commentEventType) {\n         URL url = CommentUtils.class.getResource(\"/templates/commentNotificationMail.txt\");\n         try {\n-            String content = Files.readString(Paths.get(url.toURI()));\n             var model = Map.of(\"COMMENT_AUTHOR\", commentDocModel.getPropertyValue(COMMENT_AUTHOR), //\n                     \"COMMENT_ACTION\", COMMENT_ADDED.equals(commentEventType) ? \"added\" : \"updated\", //\n                     \"COMMENTED_DOCUMENT\", commentedDocModel.getName(), //\n                     \"COMMENT_DATE\", EVENT_DATE_FORMAT.format(Date.from(Instant.ofEpochMilli(event.getTime()))), //\n                     \"COMMENT_TEXT\", commentDocModel.getPropertyValue(COMMENT_TEXT), //\n                     \"COMMENT_SUBSCRIPTION_NAME\", COMMENT_ADDED.equals(commentEventType) ? \"New\" : \"Updated\");\n+            DocumentModel parentComment = (DocumentModel) event.getContext().getProperties().get(PARENT_COMMENT);\n+            if (COMMENT_DOC_TYPE.equals(parentComment.getType())) {\n+                url = CommentUtils.class.getResource(\"/templates/commentReplyNotificationMail.txt\");\n+                Map<String, Serializable> modelWithReplyInfos = new HashMap<>();\n+                modelWithReplyInfos.putAll(model);\n+                modelWithReplyInfos.put(\"PARENT_COMMENT_AUTHOR\", parentComment.getPropertyValue(\"comment:author\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA0MTg2Nw=="}, "originalCommit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIxNjcyNQ==", "bodyText": "Here you are already constructing 2 maps:\nMap<String, Object> model = new HashMap<>(\n                    getDefaultModel(commentDocModel, commentedDocModel, event, commentEventType));\n\nOne immutable inside getDefaultModel\nOne HashMap that takes that as an argument to rewrite all entries in a mutable map.\nYou do it for every call to getExpectedMailContent\nActually I only do it when doing a reply. if the cost is to reaffect a local variable then it doesn't seem to be a problem to me.", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r370216725", "createdAt": "2020-01-23T16:18:32Z", "author": {"login": "NourNuxeo"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java", "diffHunk": "@@ -122,13 +135,22 @@ public static String getExpectedMailContent(DocumentModel commentDocModel, Docum\n             Event event, String commentEventType) {\n         URL url = CommentUtils.class.getResource(\"/templates/commentNotificationMail.txt\");\n         try {\n-            String content = Files.readString(Paths.get(url.toURI()));\n             var model = Map.of(\"COMMENT_AUTHOR\", commentDocModel.getPropertyValue(COMMENT_AUTHOR), //\n                     \"COMMENT_ACTION\", COMMENT_ADDED.equals(commentEventType) ? \"added\" : \"updated\", //\n                     \"COMMENTED_DOCUMENT\", commentedDocModel.getName(), //\n                     \"COMMENT_DATE\", EVENT_DATE_FORMAT.format(Date.from(Instant.ofEpochMilli(event.getTime()))), //\n                     \"COMMENT_TEXT\", commentDocModel.getPropertyValue(COMMENT_TEXT), //\n                     \"COMMENT_SUBSCRIPTION_NAME\", COMMENT_ADDED.equals(commentEventType) ? \"New\" : \"Updated\");\n+            DocumentModel parentComment = (DocumentModel) event.getContext().getProperties().get(PARENT_COMMENT);\n+            if (COMMENT_DOC_TYPE.equals(parentComment.getType())) {\n+                url = CommentUtils.class.getResource(\"/templates/commentReplyNotificationMail.txt\");\n+                Map<String, Serializable> modelWithReplyInfos = new HashMap<>();\n+                modelWithReplyInfos.putAll(model);\n+                modelWithReplyInfos.put(\"PARENT_COMMENT_AUTHOR\", parentComment.getPropertyValue(\"comment:author\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA0MTg2Nw=="}, "originalCommit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIyNTMyMQ==", "bodyText": "there is no performance deal here and we are in a test context it is not matter, what i don't agree is to re-affect variable when we can use onces from start at until the  end of the method", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r370225321", "createdAt": "2020-01-23T16:32:53Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java", "diffHunk": "@@ -122,13 +135,22 @@ public static String getExpectedMailContent(DocumentModel commentDocModel, Docum\n             Event event, String commentEventType) {\n         URL url = CommentUtils.class.getResource(\"/templates/commentNotificationMail.txt\");\n         try {\n-            String content = Files.readString(Paths.get(url.toURI()));\n             var model = Map.of(\"COMMENT_AUTHOR\", commentDocModel.getPropertyValue(COMMENT_AUTHOR), //\n                     \"COMMENT_ACTION\", COMMENT_ADDED.equals(commentEventType) ? \"added\" : \"updated\", //\n                     \"COMMENTED_DOCUMENT\", commentedDocModel.getName(), //\n                     \"COMMENT_DATE\", EVENT_DATE_FORMAT.format(Date.from(Instant.ofEpochMilli(event.getTime()))), //\n                     \"COMMENT_TEXT\", commentDocModel.getPropertyValue(COMMENT_TEXT), //\n                     \"COMMENT_SUBSCRIPTION_NAME\", COMMENT_ADDED.equals(commentEventType) ? \"New\" : \"Updated\");\n+            DocumentModel parentComment = (DocumentModel) event.getContext().getProperties().get(PARENT_COMMENT);\n+            if (COMMENT_DOC_TYPE.equals(parentComment.getType())) {\n+                url = CommentUtils.class.getResource(\"/templates/commentReplyNotificationMail.txt\");\n+                Map<String, Serializable> modelWithReplyInfos = new HashMap<>();\n+                modelWithReplyInfos.putAll(model);\n+                modelWithReplyInfos.put(\"PARENT_COMMENT_AUTHOR\", parentComment.getPropertyValue(\"comment:author\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA0MTg2Nw=="}, "originalCommit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIzMjIwOA==", "bodyText": "Then let's make a Hashmap from the start rather than a immutable Map. This means dropping the handy Map.of but I think it's solves it all.", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r370232208", "createdAt": "2020-01-23T16:44:49Z", "author": {"login": "NourNuxeo"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java", "diffHunk": "@@ -122,13 +135,22 @@ public static String getExpectedMailContent(DocumentModel commentDocModel, Docum\n             Event event, String commentEventType) {\n         URL url = CommentUtils.class.getResource(\"/templates/commentNotificationMail.txt\");\n         try {\n-            String content = Files.readString(Paths.get(url.toURI()));\n             var model = Map.of(\"COMMENT_AUTHOR\", commentDocModel.getPropertyValue(COMMENT_AUTHOR), //\n                     \"COMMENT_ACTION\", COMMENT_ADDED.equals(commentEventType) ? \"added\" : \"updated\", //\n                     \"COMMENTED_DOCUMENT\", commentedDocModel.getName(), //\n                     \"COMMENT_DATE\", EVENT_DATE_FORMAT.format(Date.from(Instant.ofEpochMilli(event.getTime()))), //\n                     \"COMMENT_TEXT\", commentDocModel.getPropertyValue(COMMENT_TEXT), //\n                     \"COMMENT_SUBSCRIPTION_NAME\", COMMENT_ADDED.equals(commentEventType) ? \"New\" : \"Updated\");\n+            DocumentModel parentComment = (DocumentModel) event.getContext().getProperties().get(PARENT_COMMENT);\n+            if (COMMENT_DOC_TYPE.equals(parentComment.getType())) {\n+                url = CommentUtils.class.getResource(\"/templates/commentReplyNotificationMail.txt\");\n+                Map<String, Serializable> modelWithReplyInfos = new HashMap<>();\n+                modelWithReplyInfos.putAll(model);\n+                modelWithReplyInfos.put(\"PARENT_COMMENT_AUTHOR\", parentComment.getPropertyValue(\"comment:author\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA0MTg2Nw=="}, "originalCommit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUyMTUxNA==", "bodyText": "another proposition\n    public static String getExpectedMailContent(DocumentModel commentDocModel, DocumentModel commentedDocModel,\n            Event event, String commentEventType) {\n        try {\n            String template = \"commentNotificationMail.txt\";\n            Serializable parentAuthor = \"\";\n            Serializable parentText = \"\";\n            DocumentModel parentComment = (DocumentModel) event.getContext().getProperties().get(PARENT_COMMENT);\n            if (COMMENT_DOC_TYPE.equals(parentComment.getType())) {\n                template = \"commentReplyNotificationMail.txt\";\n                parentAuthor = parentComment.getPropertyValue(\"comment:author\");\n                parentText = parentComment.getPropertyValue(\"comment:text\");\n            }\n            // data model\n            var model = Map.of(\"COMMENT_AUTHOR\", commentDocModel.getPropertyValue(COMMENT_AUTHOR), //\n                    \"COMMENT_ACTION\", COMMENT_ADDED.equals(commentEventType) ? \"added\" : \"updated\", //\n                    \"COMMENTED_DOCUMENT\", commentedDocModel.getName(), //\n                    \"COMMENT_DATE\", EVENT_DATE_FORMAT.format(Date.from(Instant.ofEpochMilli(event.getTime()))), //\n                    \"COMMENT_TEXT\", commentDocModel.getPropertyValue(COMMENT_TEXT), //\n                    \"COMMENT_SUBSCRIPTION_NAME\", COMMENT_ADDED.equals(commentEventType) ? \"New\" : \"Updated\", //\n                    \"PARENT_COMMENT_AUTHOR\", parentAuthor, //\n                    \"PARENT_COMMENT_TEXT\", parentText); //\n\n            String content = Files.readString(\n                    Paths.get(CommentUtils.class.getResource(String.format(\"/templates/%s\", template)).toURI()));\n\n            return StringUtils.expandVars(content, model);\n        } catch (URISyntaxException | IOException e) {\n            throw new NuxeoException(e);\n        }\n    }", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r370521514", "createdAt": "2020-01-24T08:41:15Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java", "diffHunk": "@@ -122,13 +135,22 @@ public static String getExpectedMailContent(DocumentModel commentDocModel, Docum\n             Event event, String commentEventType) {\n         URL url = CommentUtils.class.getResource(\"/templates/commentNotificationMail.txt\");\n         try {\n-            String content = Files.readString(Paths.get(url.toURI()));\n             var model = Map.of(\"COMMENT_AUTHOR\", commentDocModel.getPropertyValue(COMMENT_AUTHOR), //\n                     \"COMMENT_ACTION\", COMMENT_ADDED.equals(commentEventType) ? \"added\" : \"updated\", //\n                     \"COMMENTED_DOCUMENT\", commentedDocModel.getName(), //\n                     \"COMMENT_DATE\", EVENT_DATE_FORMAT.format(Date.from(Instant.ofEpochMilli(event.getTime()))), //\n                     \"COMMENT_TEXT\", commentDocModel.getPropertyValue(COMMENT_TEXT), //\n                     \"COMMENT_SUBSCRIPTION_NAME\", COMMENT_ADDED.equals(commentEventType) ? \"New\" : \"Updated\");\n+            DocumentModel parentComment = (DocumentModel) event.getContext().getProperties().get(PARENT_COMMENT);\n+            if (COMMENT_DOC_TYPE.equals(parentComment.getType())) {\n+                url = CommentUtils.class.getResource(\"/templates/commentReplyNotificationMail.txt\");\n+                Map<String, Serializable> modelWithReplyInfos = new HashMap<>();\n+                modelWithReplyInfos.putAll(model);\n+                modelWithReplyInfos.put(\"PARENT_COMMENT_AUTHOR\", parentComment.getPropertyValue(\"comment:author\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA0MTg2Nw=="}, "originalCommit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU1MzIyOQ==", "bodyText": "Yes works fine for me \ud83d\udc4d", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r370553229", "createdAt": "2020-01-24T10:00:38Z", "author": {"login": "NourNuxeo"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java", "diffHunk": "@@ -122,13 +135,22 @@ public static String getExpectedMailContent(DocumentModel commentDocModel, Docum\n             Event event, String commentEventType) {\n         URL url = CommentUtils.class.getResource(\"/templates/commentNotificationMail.txt\");\n         try {\n-            String content = Files.readString(Paths.get(url.toURI()));\n             var model = Map.of(\"COMMENT_AUTHOR\", commentDocModel.getPropertyValue(COMMENT_AUTHOR), //\n                     \"COMMENT_ACTION\", COMMENT_ADDED.equals(commentEventType) ? \"added\" : \"updated\", //\n                     \"COMMENTED_DOCUMENT\", commentedDocModel.getName(), //\n                     \"COMMENT_DATE\", EVENT_DATE_FORMAT.format(Date.from(Instant.ofEpochMilli(event.getTime()))), //\n                     \"COMMENT_TEXT\", commentDocModel.getPropertyValue(COMMENT_TEXT), //\n                     \"COMMENT_SUBSCRIPTION_NAME\", COMMENT_ADDED.equals(commentEventType) ? \"New\" : \"Updated\");\n+            DocumentModel parentComment = (DocumentModel) event.getContext().getProperties().get(PARENT_COMMENT);\n+            if (COMMENT_DOC_TYPE.equals(parentComment.getType())) {\n+                url = CommentUtils.class.getResource(\"/templates/commentReplyNotificationMail.txt\");\n+                Map<String, Serializable> modelWithReplyInfos = new HashMap<>();\n+                modelWithReplyInfos.putAll(model);\n+                modelWithReplyInfos.put(\"PARENT_COMMENT_AUTHOR\", parentComment.getPropertyValue(\"comment:author\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA0MTg2Nw=="}, "originalCommit": {"oid": "3e2515ba8451b945c0e3262aa08aa59e760a30f7"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MTYyNjE1OnYy", "diffSide": "RIGHT", "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxNjo0OToyNVrOFhj0xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNToxOTo0NVrOFio92Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDczNDI3OQ==", "bodyText": "as discussed on F2F, we should checks the annotation type too here and in the quotedComments.ftl is why i proposed too to remove the whole quotedComments.ftl and integrate the whole controle in the base one and only check if parentAuthor / parentText is not empty and then add the its value. in this last point its mainly a proposal and others feedback are welcome", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r370734279", "createdAt": "2020-01-24T16:49:25Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java", "diffHunk": "@@ -131,15 +131,26 @@ public static void checkReceivedMail(List<MailMessage> mails, DocumentModel comm\n \n     public static String getExpectedMailContent(DocumentModel commentDocModel, DocumentModel commentedDocModel,\n             Event event, String commentEventType) {\n-        URL url = CommentUtils.class.getResource(\"/templates/commentNotificationMail.txt\");\n         try {\n-            String content = Files.readString(Paths.get(url.toURI()));\n+            String template = \"commentNotificationMail.txt\";\n+            Serializable parentAuthor = \"\";\n+            Serializable parentText = \"\";\n+            DocumentModel parentComment = (DocumentModel) event.getContext().getProperties().get(PARENT_COMMENT);\n+            if (COMMENT_DOC_TYPE.equals(parentComment.getType())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98502bfddcf3f55c91ec4b9ebd0b752405baf93b"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDczODY2Mg==", "bodyText": "The ftl is done and isolates the part of the quoted comments. That's what templating is handy for.\nIn this case I could spot the ftl check quickly thanks to its isolation rather than looking it up in baseComment.ftl.\nThe job is already done (the comment part is already in its own template). So it costs nothing to keep it as is.", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r370738662", "createdAt": "2020-01-24T16:58:14Z", "author": {"login": "NourNuxeo"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java", "diffHunk": "@@ -131,15 +131,26 @@ public static void checkReceivedMail(List<MailMessage> mails, DocumentModel comm\n \n     public static String getExpectedMailContent(DocumentModel commentDocModel, DocumentModel commentedDocModel,\n             Event event, String commentEventType) {\n-        URL url = CommentUtils.class.getResource(\"/templates/commentNotificationMail.txt\");\n         try {\n-            String content = Files.readString(Paths.get(url.toURI()));\n+            String template = \"commentNotificationMail.txt\";\n+            Serializable parentAuthor = \"\";\n+            Serializable parentText = \"\";\n+            DocumentModel parentComment = (DocumentModel) event.getContext().getProperties().get(PARENT_COMMENT);\n+            if (COMMENT_DOC_TYPE.equals(parentComment.getType())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDczNDI3OQ=="}, "originalCommit": {"oid": "98502bfddcf3f55c91ec4b9ebd0b752405baf93b"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg2NzA5Nw==", "bodyText": "quotedComments.ftl has been dropped", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r371867097", "createdAt": "2020-01-28T15:19:45Z", "author": {"login": "NourNuxeo"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java", "diffHunk": "@@ -131,15 +131,26 @@ public static void checkReceivedMail(List<MailMessage> mails, DocumentModel comm\n \n     public static String getExpectedMailContent(DocumentModel commentDocModel, DocumentModel commentedDocModel,\n             Event event, String commentEventType) {\n-        URL url = CommentUtils.class.getResource(\"/templates/commentNotificationMail.txt\");\n         try {\n-            String content = Files.readString(Paths.get(url.toURI()));\n+            String template = \"commentNotificationMail.txt\";\n+            Serializable parentAuthor = \"\";\n+            Serializable parentText = \"\";\n+            DocumentModel parentComment = (DocumentModel) event.getContext().getProperties().get(PARENT_COMMENT);\n+            if (COMMENT_DOC_TYPE.equals(parentComment.getType())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDczNDI3OQ=="}, "originalCommit": {"oid": "98502bfddcf3f55c91ec4b9ebd0b752405baf93b"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5OTA4ODczOnYy", "diffSide": "RIGHT", "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/resources/OSGI-INF/comment-notification-contrib.xml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNToxNjowN1rOFio1Rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNToxOToyOVrOFio9Kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg2NDkwMw==", "bodyText": "should be removed ? or i am wrong", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r371864903", "createdAt": "2020-01-28T15:16:07Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/resources/OSGI-INF/comment-notification-contrib.xml", "diffHunk": "@@ -32,6 +32,7 @@\n     <template name=\"baseComment\" src=\"templates/baseComment.ftl\" />\n     <template name=\"commentAdded\" src=\"templates/commentAdded.ftl\" />\n     <template name=\"commentUpdated\" src=\"templates/commentUpdated.ftl\" />\n+    <template name=\"quotedComments\" src=\"templates/quotedComments.ftl\" />", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e63b94f9dbb6ca0de34b1d0c96419dfdb0956faa"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg2NjkyMg==", "bodyText": "righto", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r371866922", "createdAt": "2020-01-28T15:19:29Z", "author": {"login": "NourNuxeo"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/resources/OSGI-INF/comment-notification-contrib.xml", "diffHunk": "@@ -32,6 +32,7 @@\n     <template name=\"baseComment\" src=\"templates/baseComment.ftl\" />\n     <template name=\"commentAdded\" src=\"templates/commentAdded.ftl\" />\n     <template name=\"commentUpdated\" src=\"templates/commentUpdated.ftl\" />\n+    <template name=\"quotedComments\" src=\"templates/quotedComments.ftl\" />", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg2NDkwMw=="}, "originalCommit": {"oid": "e63b94f9dbb6ca0de34b1d0c96419dfdb0956faa"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5OTExMjc4OnYy", "diffSide": "RIGHT", "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/resources/templates/baseComment.ftl", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNToyMjoyNlrOFipEsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNToyMjoyNlrOFipEsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg2ODg1MA==", "bodyText": "thanks taking into account the fact to remove the quotedComments.ftl ;)", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r371868850", "createdAt": "2020-01-28T15:22:26Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/resources/templates/baseComment.ftl", "diffHunk": "@@ -20,10 +20,16 @@\n                         <#if principalAuthor?? && (principalAuthor.lastName!=\"\" || principalAuthor.firstName!=\"\")>\n                         ${htmlEscape(principalAuthor.firstName)} ${htmlEscape(principalAuthor.lastName)}\n                         </#if>\n-                        (${author}) has ${action} a comment on <a style=\"color:#22aee8;text-decoration:underline;word-wrap:break-word !important;\" href=\"${docUrl}\">${docTitle}</a> at ${dateTime?datetime?string(\"dd/MM/yyyy - HH:mm\")}.</p><br/>\n-                        <p style=\"margin:0;font-size:13px;\">${htmlEscape(principalAuthor.firstName)} says:</p>\n-                        <p style=\"margin:0;font-size:13px;\">${comment_text}</p>\n-                        <br/>\n+                          (${author}) has ${action} a comment on <a style=\"color:#22aee8;text-decoration:underline;word-wrap:break-word !important;\" href=\"${docUrl}\">${docTitle}</a> at ${dateTime?datetime?string(\"dd/MM/yyyy - HH:mm\")}.</p><br/>\n+                          <p style=\"margin:0;font-size:13px;\">${htmlEscape(principalAuthor.firstName)} says:</p>\n+                          <p style=\"margin:0;font-size:13px;\">${comment_text}</p>\n+                          <br/>\n+                          <#if parentComment.type == \"Comment\" || parentComment.type == \"Annotation\">\n+                          <p style=\"margin:0;font-size:13px;\">It is a reply to:</p>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e63b94f9dbb6ca0de34b1d0c96419dfdb0956faa"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5OTExODI3OnYy", "diffSide": "RIGHT", "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNToyMzozOVrOFipIFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNTo0MjoyMFrOFip4eA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg2OTcxNw==", "bodyText": "you can use instead it the hasSchema if you want as both annotation and comment contains the comment schema\nfor more further  i was think if we put check only here i mean in this method and just rely on the existence of the value in the ftl to avoid making the same thing twice see https://github.com/nuxeo/nuxeo/pull/3664/files#diff-b4cc6f294fb9a7dcb604d5682fb14bcaR27 why if we rely on the existence of Map#PARENT_COMMENT_AUTHOR and Map#PARENT_COMMENT_TEXT to add the section in the ftl", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r371869717", "createdAt": "2020-01-28T15:23:39Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java", "diffHunk": "@@ -131,15 +133,25 @@ public static void checkReceivedMail(List<MailMessage> mails, DocumentModel comm\n \n     public static String getExpectedMailContent(DocumentModel commentDocModel, DocumentModel commentedDocModel,\n             Event event, String commentEventType) {\n-        URL url = CommentUtils.class.getResource(\"/templates/commentNotificationMail.txt\");\n         try {\n-            String content = Files.readString(Paths.get(url.toURI()));\n-            var model = Map.of(\"COMMENT_AUTHOR\", commentDocModel.getPropertyValue(COMMENT_AUTHOR), //\n-                    \"COMMENT_ACTION\", COMMENT_ADDED.equals(commentEventType) ? \"added\" : \"updated\", //\n-                    \"COMMENTED_DOCUMENT\", commentedDocModel.getName(), //\n-                    \"COMMENT_DATE\", EVENT_DATE_FORMAT.format(Date.from(Instant.ofEpochMilli(event.getTime()))), //\n-                    \"COMMENT_TEXT\", commentDocModel.getPropertyValue(COMMENT_TEXT), //\n-                    \"COMMENT_SUBSCRIPTION_NAME\", COMMENT_ADDED.equals(commentEventType) ? \"New\" : \"Updated\");\n+            var model = new HashMap<String, Serializable>();\n+            model.put(\"COMMENT_AUTHOR\", commentDocModel.getPropertyValue(COMMENT_AUTHOR));\n+            model.put(\"COMMENT_ACTION\", COMMENT_ADDED.equals(commentEventType) ? \"added\" : \"updated\");\n+            model.put(\"COMMENTED_DOCUMENT\", commentedDocModel.getName());\n+            model.put(\"COMMENT_DATE\", EVENT_DATE_FORMAT.format(Date.from(Instant.ofEpochMilli(event.getTime()))));\n+            model.put(\"COMMENT_TEXT\", commentDocModel.getPropertyValue(COMMENT_TEXT));\n+            model.put(\"COMMENT_SUBSCRIPTION_NAME\", COMMENT_ADDED.equals(commentEventType) ? \"New\" : \"Updated\");\n+\n+            String template = \"commentNotificationMail.txt\";\n+            DocumentModel parentComment = (DocumentModel) event.getContext().getProperties().get(PARENT_COMMENT);\n+            if (COMMENT_DOC_TYPE.equals(parentComment.getType()) ||\n+                    ANNOTATION_DOC_TYPE.equals(parentComment.getType())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e63b94f9dbb6ca0de34b1d0c96419dfdb0956faa"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg4MjEwNA==", "bodyText": "Map#PARENT_COMMENT_TEXT is not reachable from the ftl\nthe ftl always have the parentComment which might be the top level doc. So I need to check its type there to add the extra text or not", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r371882104", "createdAt": "2020-01-28T15:42:20Z", "author": {"login": "NourNuxeo"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/CommentUtils.java", "diffHunk": "@@ -131,15 +133,25 @@ public static void checkReceivedMail(List<MailMessage> mails, DocumentModel comm\n \n     public static String getExpectedMailContent(DocumentModel commentDocModel, DocumentModel commentedDocModel,\n             Event event, String commentEventType) {\n-        URL url = CommentUtils.class.getResource(\"/templates/commentNotificationMail.txt\");\n         try {\n-            String content = Files.readString(Paths.get(url.toURI()));\n-            var model = Map.of(\"COMMENT_AUTHOR\", commentDocModel.getPropertyValue(COMMENT_AUTHOR), //\n-                    \"COMMENT_ACTION\", COMMENT_ADDED.equals(commentEventType) ? \"added\" : \"updated\", //\n-                    \"COMMENTED_DOCUMENT\", commentedDocModel.getName(), //\n-                    \"COMMENT_DATE\", EVENT_DATE_FORMAT.format(Date.from(Instant.ofEpochMilli(event.getTime()))), //\n-                    \"COMMENT_TEXT\", commentDocModel.getPropertyValue(COMMENT_TEXT), //\n-                    \"COMMENT_SUBSCRIPTION_NAME\", COMMENT_ADDED.equals(commentEventType) ? \"New\" : \"Updated\");\n+            var model = new HashMap<String, Serializable>();\n+            model.put(\"COMMENT_AUTHOR\", commentDocModel.getPropertyValue(COMMENT_AUTHOR));\n+            model.put(\"COMMENT_ACTION\", COMMENT_ADDED.equals(commentEventType) ? \"added\" : \"updated\");\n+            model.put(\"COMMENTED_DOCUMENT\", commentedDocModel.getName());\n+            model.put(\"COMMENT_DATE\", EVENT_DATE_FORMAT.format(Date.from(Instant.ofEpochMilli(event.getTime()))));\n+            model.put(\"COMMENT_TEXT\", commentDocModel.getPropertyValue(COMMENT_TEXT));\n+            model.put(\"COMMENT_SUBSCRIPTION_NAME\", COMMENT_ADDED.equals(commentEventType) ? \"New\" : \"Updated\");\n+\n+            String template = \"commentNotificationMail.txt\";\n+            DocumentModel parentComment = (DocumentModel) event.getContext().getProperties().get(PARENT_COMMENT);\n+            if (COMMENT_DOC_TYPE.equals(parentComment.getType()) ||\n+                    ANNOTATION_DOC_TYPE.equals(parentComment.getType())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg2OTcxNw=="}, "originalCommit": {"oid": "e63b94f9dbb6ca0de34b1d0c96419dfdb0956faa"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyNzY0MDk4OnYy", "diffSide": "RIGHT", "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/AbstractTestCommentNotification.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxMDo0MDo1M1rOFm5E4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxMDo0MDo1M1rOFm5E4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMyNTM0Nw==", "bodyText": "This features revealed an error in the test after flattening test methods. The first mail was checked instead of the 2nd in the case of autosubscription (so Tree implementation only). Since content was strictly identical, test was successful.\nIn this ticket that doesn't cut it anymore since replies have different template.\nShouldn't affect the backport as it doesn't have the mail tests and checks.", "url": "https://github.com/nuxeo/nuxeo/pull/3664#discussion_r376325347", "createdAt": "2020-02-07T10:40:53Z", "author": {"login": "NourNuxeo"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/AbstractTestCommentNotification.java", "diffHunk": "@@ -192,7 +192,7 @@ public void shouldNotifyWithTheRightCommentedDocument() {\n             assertEquals(2, mails.size());\n             String expectedMailContent = getExpectedMailContent(replyDocumentModel, commentedDocumentModel,\n                     expectedEvent);\n-            assertEquals(expectedMailContent, getMailContent(mails.get(0)));\n+            assertEquals(expectedMailContent, getMailContent(mails.get(1)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "988b687cb828b0e7206ec0fcf07e7e8ed5034c52"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4240, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}