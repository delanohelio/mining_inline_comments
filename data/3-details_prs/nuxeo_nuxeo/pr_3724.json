{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxNDU4MTMw", "number": 3724, "title": "fix-NXP-28484-comment-rest-update", "bodyText": "PR created from https://qa.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-kleturc/672/", "createdAt": "2020-02-05T16:10:30Z", "url": "https://github.com/nuxeo/nuxeo/pull/3724", "merged": true, "mergeCommit": {"oid": "5b6f443385862809b206b111dedeb44b0d6ff132"}, "closed": true, "closedAt": "2020-02-19T11:06:53Z", "author": {"login": "nuxeojenkins"}, "timelineItems": {"totalCount": 43, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBYjHYgBqjMwMTA2NDMzMDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcF0YCEgFqTM2MTAxNzQ5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b58d34d4fc2d28bf5a7a90704e3d703e4ec93bd5", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/b58d34d4fc2d28bf5a7a90704e3d703e4ec93bd5", "committedDate": "2020-02-05T11:33:38Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}, "afterCommit": {"oid": "d43f109d6590e887c28080a293836ff26b82b934", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/d43f109d6590e887c28080a293836ff26b82b934", "committedDate": "2020-02-05T16:15:54Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d43f109d6590e887c28080a293836ff26b82b934", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/d43f109d6590e887c28080a293836ff26b82b934", "committedDate": "2020-02-05T16:15:54Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}, "afterCommit": {"oid": "1cda0b9a861f9f03d91ed6bf3b258f3c1596b404", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/1cda0b9a861f9f03d91ed6bf3b258f3c1596b404", "committedDate": "2020-02-06T09:26:24Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1cda0b9a861f9f03d91ed6bf3b258f3c1596b404", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/1cda0b9a861f9f03d91ed6bf3b258f3c1596b404", "committedDate": "2020-02-06T09:26:24Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}, "afterCommit": {"oid": "fd37a93943a6e9162a729a5e990911365234f513", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/fd37a93943a6e9162a729a5e990911365234f513", "committedDate": "2020-02-06T16:38:23Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd37a93943a6e9162a729a5e990911365234f513", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/fd37a93943a6e9162a729a5e990911365234f513", "committedDate": "2020-02-06T16:38:23Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}, "afterCommit": {"oid": "61be093c3382a35eeb08bf6cf99225e6389603b5", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/61be093c3382a35eeb08bf6cf99225e6389603b5", "committedDate": "2020-02-07T10:19:52Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MDc3ODQy", "url": "https://github.com/nuxeo/nuxeo/pull/3724#pullrequestreview-355077842", "createdAt": "2020-02-07T10:54:06Z", "commit": {"oid": "61be093c3382a35eeb08bf6cf99225e6389603b5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxMDo1NDowNlrOFm5bpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxMDo1NDowNlrOFm5bpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMzMTE3NA==", "bodyText": "Is there a reason/preference to use schema check instead a document type, i mean ANNOTATION_DOC_TYPE.equals(doc.getType())", "url": "https://github.com/nuxeo/nuxeo/pull/3724#discussion_r376331174", "createdAt": "2020-02-07T10:54:06Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment-api/src/main/java/org/nuxeo/ecm/platform/comment/api/CommentAdapterFactory.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ *  Contributors:\n+ *      Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+\n+package org.nuxeo.ecm.platform.comment.api;\n+\n+import static org.nuxeo.ecm.platform.comment.api.AnnotationConstants.ANNOTATION_SCHEMA;\n+import static org.nuxeo.ecm.platform.comment.api.CommentConstants.COMMENT_SCHEMA;\n+\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.adapter.DocumentAdapterFactory;\n+\n+/**\n+ * @since 11.1\n+ */\n+public class CommentAdapterFactory implements DocumentAdapterFactory {\n+\n+    @Override\n+    public Comment getAdapter(DocumentModel doc, Class<?> itf) {\n+        if (doc.getDocumentType().hasSchema(ANNOTATION_SCHEMA)) {\n+            return new AnnotationImpl(doc);\n+        } else if (doc.getDocumentType().hasSchema(COMMENT_SCHEMA)) {\n+            return new CommentImpl(doc);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61be093c3382a35eeb08bf6cf99225e6389603b5"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MDgwMTkx", "url": "https://github.com/nuxeo/nuxeo/pull/3724#pullrequestreview-355080191", "createdAt": "2020-02-07T10:58:19Z", "commit": {"oid": "61be093c3382a35eeb08bf6cf99225e6389603b5"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxMDo1ODoxOVrOFm5jBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxMTowMDo0MVrOFm5mrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMzMzA2Mg==", "bodyText": "Worth extracting documentModel.getRef() in a var.", "url": "https://github.com/nuxeo/nuxeo/pull/3724#discussion_r376333062", "createdAt": "2020-02-07T10:58:19Z", "author": {"login": "troger"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/java/org/nuxeo/ecm/platform/comment/impl/AbstractCommentManager.java", "diffHunk": "@@ -95,37 +99,72 @@\n     }\n \n     @Override\n-    public DocumentModel getThreadForComment(DocumentModel comment) {\n-        DocumentRef topLevelDocRef = getTopLevelCommentAncestor(comment.getCoreSession(), comment.getRef());\n-        return comment.getCoreSession().getDocument(topLevelDocRef);\n+    public DocumentRef getTopLevelDocumentRef(CoreSession s, DocumentRef commentRef) {\n+        return CoreInstance.doPrivileged(s, session -> {\n+            if (!session.exists(commentRef)) {\n+                throw new CommentNotFoundException(String.format(\"The comment %s does not exist.\", commentRef));\n+            }\n+\n+            DocumentModel commentDocModel = session.getDocument(commentRef);\n+            DocumentModel documentModel = getTopLevelDocument(session, commentDocModel);\n+\n+            NuxeoPrincipal principal = s.getPrincipal();\n+            if (!session.hasPermission(principal, documentModel.getRef(), SecurityConstants.READ)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61be093c3382a35eeb08bf6cf99225e6389603b5"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMzMzc5NA==", "bodyText": "Shouldn't we use CoreSession session for the argument and s for the privileged session.\n=> Consistency with all other methods in the platform where we use session for the CoreSession arg.", "url": "https://github.com/nuxeo/nuxeo/pull/3724#discussion_r376333794", "createdAt": "2020-02-07T11:00:09Z", "author": {"login": "troger"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/java/org/nuxeo/ecm/platform/comment/impl/AbstractCommentManager.java", "diffHunk": "@@ -95,37 +99,72 @@\n     }\n \n     @Override\n-    public DocumentModel getThreadForComment(DocumentModel comment) {\n-        DocumentRef topLevelDocRef = getTopLevelCommentAncestor(comment.getCoreSession(), comment.getRef());\n-        return comment.getCoreSession().getDocument(topLevelDocRef);\n+    public DocumentRef getTopLevelDocumentRef(CoreSession s, DocumentRef commentRef) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61be093c3382a35eeb08bf6cf99225e6389603b5"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMzMzk5Nw==", "bodyText": "Extract it before the doPrivileged block so that we know directly it's the initial principal?", "url": "https://github.com/nuxeo/nuxeo/pull/3724#discussion_r376333997", "createdAt": "2020-02-07T11:00:41Z", "author": {"login": "troger"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/java/org/nuxeo/ecm/platform/comment/impl/AbstractCommentManager.java", "diffHunk": "@@ -95,37 +99,72 @@\n     }\n \n     @Override\n-    public DocumentModel getThreadForComment(DocumentModel comment) {\n-        DocumentRef topLevelDocRef = getTopLevelCommentAncestor(comment.getCoreSession(), comment.getRef());\n-        return comment.getCoreSession().getDocument(topLevelDocRef);\n+    public DocumentRef getTopLevelDocumentRef(CoreSession s, DocumentRef commentRef) {\n+        return CoreInstance.doPrivileged(s, session -> {\n+            if (!session.exists(commentRef)) {\n+                throw new CommentNotFoundException(String.format(\"The comment %s does not exist.\", commentRef));\n+            }\n+\n+            DocumentModel commentDocModel = session.getDocument(commentRef);\n+            DocumentModel documentModel = getTopLevelDocument(session, commentDocModel);\n+\n+            NuxeoPrincipal principal = s.getPrincipal();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61be093c3382a35eeb08bf6cf99225e6389603b5"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MTgwMDI5", "url": "https://github.com/nuxeo/nuxeo/pull/3724#pullrequestreview-355180029", "createdAt": "2020-02-07T14:10:49Z", "commit": {"oid": "61be093c3382a35eeb08bf6cf99225e6389603b5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxNDoxMDo0OVrOFm-Kmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxNDoxMDo0OVrOFm-Kmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQwODczMQ==", "bodyText": "is this property will be removed in the future, my question is related to fact that in some commit (more in the cleanup one) you use @Deprecated(since = \"11.1\", forRemoval = true)", "url": "https://github.com/nuxeo/nuxeo/pull/3724#discussion_r376408731", "createdAt": "2020-02-07T14:10:49Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment-api/src/main/java/org/nuxeo/ecm/platform/comment/api/CommentImpl.java", "diffHunk": "@@ -20,136 +20,243 @@\n \n package org.nuxeo.ecm.platform.comment.api;\n \n+import static org.nuxeo.common.utils.DateUtils.toCalendar;\n+import static org.nuxeo.common.utils.DateUtils.toInstant;\n+import static org.nuxeo.ecm.platform.comment.api.CommentConstants.COMMENT_ANCESTOR_IDS_PROPERTY;\n+import static org.nuxeo.ecm.platform.comment.api.CommentConstants.COMMENT_AUTHOR_PROPERTY;\n+import static org.nuxeo.ecm.platform.comment.api.CommentConstants.COMMENT_CREATION_DATE_PROPERTY;\n+import static org.nuxeo.ecm.platform.comment.api.CommentConstants.COMMENT_DOC_TYPE;\n+import static org.nuxeo.ecm.platform.comment.api.CommentConstants.COMMENT_MODIFICATION_DATE_PROPERTY;\n+import static org.nuxeo.ecm.platform.comment.api.CommentConstants.COMMENT_PARENT_ID_PROPERTY;\n+import static org.nuxeo.ecm.platform.comment.api.CommentConstants.COMMENT_TEXT_PROPERTY;\n+import static org.nuxeo.ecm.platform.comment.api.ExternalEntityConstants.EXTERNAL_ENTITY_FACET;\n+import static org.nuxeo.ecm.platform.comment.api.ExternalEntityConstants.EXTERNAL_ENTITY_ID_PROPERTY;\n+import static org.nuxeo.ecm.platform.comment.api.ExternalEntityConstants.EXTERNAL_ENTITY_ORIGIN_PROPERTY;\n+import static org.nuxeo.ecm.platform.comment.api.ExternalEntityConstants.EXTERNAL_ENTITY_PROPERTY;\n+\n import java.time.Instant;\n+import java.util.Arrays;\n+import java.util.Calendar;\n import java.util.Collection;\n import java.util.HashSet;\n-import java.util.Objects;\n \n import org.apache.commons.lang3.builder.EqualsBuilder;\n+import org.apache.commons.lang3.builder.ToStringBuilder;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.impl.SimpleDocumentModel;\n \n /**\n  * @since 10.3\n  */\n public class CommentImpl implements Comment, ExternalEntity {\n \n+    /**\n+     * @deprecated since 11.1, not used due to {@link #docModel} usage\n+     */\n+    @Deprecated(since = \"11.1\")\n     protected String id;\n \n+    /**\n+     * @deprecated since 11.1, not used due to {@link #docModel} usage\n+     */\n+    @Deprecated(since = \"11.1\")\n     protected String parentId;\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61be093c3382a35eeb08bf6cf99225e6389603b5"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MTgyNjg4", "url": "https://github.com/nuxeo/nuxeo/pull/3724#pullrequestreview-355182688", "createdAt": "2020-02-07T14:14:53Z", "commit": {"oid": "61be093c3382a35eeb08bf6cf99225e6389603b5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxNDoxNDo1M1rOFm-SKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxNDoxNDo1M1rOFm-SKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQxMDY2Ng==", "bodyText": "i am wondering in the case of backward compatibility where a customer call new CommentImpl ().setId(\"anyId\")  and later in his code c.getId() will be null (java comment on #getId -> // don't fail when docModel is SimpleDocumentModel)", "url": "https://github.com/nuxeo/nuxeo/pull/3724#discussion_r376410666", "createdAt": "2020-02-07T14:14:53Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment-api/src/main/java/org/nuxeo/ecm/platform/comment/api/CommentImpl.java", "diffHunk": "@@ -20,136 +20,243 @@\n \n package org.nuxeo.ecm.platform.comment.api;\n \n+import static org.nuxeo.common.utils.DateUtils.toCalendar;\n+import static org.nuxeo.common.utils.DateUtils.toInstant;\n+import static org.nuxeo.ecm.platform.comment.api.CommentConstants.COMMENT_ANCESTOR_IDS_PROPERTY;\n+import static org.nuxeo.ecm.platform.comment.api.CommentConstants.COMMENT_AUTHOR_PROPERTY;\n+import static org.nuxeo.ecm.platform.comment.api.CommentConstants.COMMENT_CREATION_DATE_PROPERTY;\n+import static org.nuxeo.ecm.platform.comment.api.CommentConstants.COMMENT_DOC_TYPE;\n+import static org.nuxeo.ecm.platform.comment.api.CommentConstants.COMMENT_MODIFICATION_DATE_PROPERTY;\n+import static org.nuxeo.ecm.platform.comment.api.CommentConstants.COMMENT_PARENT_ID_PROPERTY;\n+import static org.nuxeo.ecm.platform.comment.api.CommentConstants.COMMENT_TEXT_PROPERTY;\n+import static org.nuxeo.ecm.platform.comment.api.ExternalEntityConstants.EXTERNAL_ENTITY_FACET;\n+import static org.nuxeo.ecm.platform.comment.api.ExternalEntityConstants.EXTERNAL_ENTITY_ID_PROPERTY;\n+import static org.nuxeo.ecm.platform.comment.api.ExternalEntityConstants.EXTERNAL_ENTITY_ORIGIN_PROPERTY;\n+import static org.nuxeo.ecm.platform.comment.api.ExternalEntityConstants.EXTERNAL_ENTITY_PROPERTY;\n+\n import java.time.Instant;\n+import java.util.Arrays;\n+import java.util.Calendar;\n import java.util.Collection;\n import java.util.HashSet;\n-import java.util.Objects;\n \n import org.apache.commons.lang3.builder.EqualsBuilder;\n+import org.apache.commons.lang3.builder.ToStringBuilder;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.impl.SimpleDocumentModel;\n \n /**\n  * @since 10.3\n  */\n public class CommentImpl implements Comment, ExternalEntity {\n \n+    /**\n+     * @deprecated since 11.1, not used due to {@link #docModel} usage\n+     */\n+    @Deprecated(since = \"11.1\")\n     protected String id;\n \n+    /**\n+     * @deprecated since 11.1, not used due to {@link #docModel} usage\n+     */\n+    @Deprecated(since = \"11.1\")\n     protected String parentId;\n \n+    /**\n+     * @deprecated since 11.1, not used due to {@link #docModel} usage\n+     */\n+    @Deprecated(since = \"11.1\")\n     protected Collection<String> ancestorIds = new HashSet<>();\n \n+    /**\n+     * @deprecated since 11.1, not used due to {@link #docModel} usage\n+     */\n+    @Deprecated(since = \"11.1\")\n     protected String author;\n \n+    /**\n+     * @deprecated since 11.1, not used due to {@link #docModel} usage\n+     */\n+    @Deprecated(since = \"11.1\")\n     protected String text;\n \n+    /**\n+     * @deprecated since 11.1, not used due to {@link #docModel} usage\n+     */\n+    @Deprecated(since = \"11.1\")\n     protected Instant creationDate;\n \n+    /**\n+     * @deprecated since 11.1, not used due to {@link #docModel} usage\n+     */\n+    @Deprecated(since = \"11.1\")\n     protected Instant modificationDate;\n \n+    /**\n+     * @deprecated since 11.1, not used due to {@link #docModel} usage\n+     */\n+    @Deprecated(since = \"11.1\")\n     protected String entityId;\n \n+    /**\n+     * @deprecated since 11.1, not used due to {@link #docModel} usage\n+     */\n+    @Deprecated(since = \"11.1\")\n     protected String origin;\n \n+    /**\n+     * @deprecated since 11.1, not used due to {@link #docModel} usage\n+     */\n+    @Deprecated(since = \"11.1\")\n     protected String entity;\n \n+    /**\n+     * {@link DocumentModel} storing the {@link Comment} metadata.\n+     * \n+     * @since 11.1\n+     */\n+    protected DocumentModel docModel;\n+\n+    /**\n+     * @since 11.1\n+     */\n+    public CommentImpl() {\n+        this(SimpleDocumentModel.ofType(COMMENT_DOC_TYPE));\n+    }\n+\n+    /**\n+     * Constructor for the document adapter factory.\n+     *\n+     * @since 11.1\n+     */\n+    protected CommentImpl(DocumentModel docModel) {\n+        this.docModel = docModel;\n+        this.docModel.detach(true);\n+    }\n+\n     @Override\n     public String getId() {\n-        return id;\n+        try {\n+            return docModel.getId();\n+        } catch (UnsupportedOperationException e) {\n+            // don't fail when docModel is SimpleDocumentModel\n+            return null;\n+        }\n     }\n \n     @Override\n+    @Deprecated(since = \"11.1\")\n     public void setId(String id) {\n-        this.id = id;\n+        // not used", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61be093c3382a35eeb08bf6cf99225e6389603b5"}, "originalPosition": 134}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MjI2NjUw", "url": "https://github.com/nuxeo/nuxeo/pull/3724#pullrequestreview-355226650", "createdAt": "2020-02-07T15:16:24Z", "commit": {"oid": "61be093c3382a35eeb08bf6cf99225e6389603b5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxNToxNjoyNVrOFnAWMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxNToxNjoyNVrOFnAWMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQ0NDQ2NA==", "bodyText": "i think optionalSet(jn, COMMENT_CREATION_DATE_FIELD, s -> comment.setCreationDate(s == null ? null : Instant.parse(s))); can be replaced by optionalSet(jn, COMMENT_CREATION_DATE_FIELD, s -> comment.setCreationDate(Instant.parse(s))); as the optionalSet checks the jn.has(key) which\n public boolean has(String fieldName) {\n        return this.get(fieldName) != null;\n    }\n\nand i am wondering if we can find / replace the method name  it makes us think to the java.util.Optional -> setIfExists, setIfDefined", "url": "https://github.com/nuxeo/nuxeo/pull/3724#discussion_r376444464", "createdAt": "2020-02-07T15:16:25Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/java/org/nuxeo/ecm/platform/comment/impl/CommentJsonReader.java", "diffHunk": "@@ -59,27 +60,23 @@ protected Comment readEntity(JsonNode jn) {\n \n     protected static Comment fillCommentEntity(JsonNode jn, Comment comment) {\n         // don't read id from given JsonNode, if needed it is read from path\n-        comment.setParentId(jn.get(COMMENT_PARENT_ID_FIELD).textValue());\n-        comment.setText(jn.get(COMMENT_TEXT_FIELD).textValue());\n-\n-        JsonNode creationDateNode = jn.get(COMMENT_CREATION_DATE_FIELD);\n-        Instant creationDate = creationDateNode != null && !creationDateNode.isNull()\n-                ? Instant.parse(creationDateNode.textValue())\n-                : null;\n-        comment.setCreationDate(creationDate);\n-\n-        JsonNode modificationDateNode = jn.get(COMMENT_MODIFICATION_DATE_FIELD);\n-        Instant modificationDate = modificationDateNode != null && !modificationDateNode.isNull()\n-                ? Instant.parse(modificationDateNode.textValue())\n-                : null;\n-        comment.setModificationDate(modificationDate);\n-\n-        if (jn.has(EXTERNAL_ENTITY_ID_FIELD)) {\n+        optionalSet(jn, COMMENT_PARENT_ID_FIELD, comment::setParentId);\n+        optionalSet(jn, COMMENT_TEXT_FIELD, comment::setText);\n+        optionalSet(jn, COMMENT_CREATION_DATE_FIELD, s -> comment.setCreationDate(s == null ? null : Instant.parse(s)));\n+        optionalSet(jn, COMMENT_MODIFICATION_DATE_FIELD,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61be093c3382a35eeb08bf6cf99225e6389603b5"}, "originalPosition": 31}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "61be093c3382a35eeb08bf6cf99225e6389603b5", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/61be093c3382a35eeb08bf6cf99225e6389603b5", "committedDate": "2020-02-07T10:19:52Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}, "afterCommit": {"oid": "f5713cd65906b1fcf797a8c664b905f8740ccd8e", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/f5713cd65906b1fcf797a8c664b905f8740ccd8e", "committedDate": "2020-02-07T16:00:54Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f5713cd65906b1fcf797a8c664b905f8740ccd8e", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/f5713cd65906b1fcf797a8c664b905f8740ccd8e", "committedDate": "2020-02-07T16:00:54Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}, "afterCommit": {"oid": "c80f6eafc7905dc8b0dedaa54d37abbd863bcf2c", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/c80f6eafc7905dc8b0dedaa54d37abbd863bcf2c", "committedDate": "2020-02-07T16:01:14Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c80f6eafc7905dc8b0dedaa54d37abbd863bcf2c", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/c80f6eafc7905dc8b0dedaa54d37abbd863bcf2c", "committedDate": "2020-02-07T16:01:14Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}, "afterCommit": {"oid": "3ed64259cc9adc59324d337bee2481532785ae8b", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/3ed64259cc9adc59324d337bee2481532785ae8b", "committedDate": "2020-02-07T16:30:20Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1ODAxMDY0", "url": "https://github.com/nuxeo/nuxeo/pull/3724#pullrequestreview-355801064", "createdAt": "2020-02-10T09:47:39Z", "commit": {"oid": "3ed64259cc9adc59324d337bee2481532785ae8b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwOTo0NzozOVrOFnfmGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwOTo0NzozOVrOFnfmGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk1NjQ0Mw==", "bodyText": "I am wondering if we can call directly the getTopLevelDocument as if i am not wrong do the same things", "url": "https://github.com/nuxeo/nuxeo/pull/3724#discussion_r376956443", "createdAt": "2020-02-10T09:47:39Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/java/org/nuxeo/ecm/platform/comment/impl/CommentManagerImpl.java", "diffHunk": "@@ -139,16 +138,29 @@ public CommentManagerImpl(CommentServiceConfig config) {\n     public DocumentModel createComment(DocumentModel docModel, String comment, String author) {\n         try (CloseableCoreSession session = CoreInstance.openCoreSessionSystem(docModel.getRepositoryName())) {\n             DocumentModel commentDM = session.createDocumentModel(COMMENT_DOC_TYPE);\n-            commentDM.setPropertyValue(CommentsConstants.COMMENT_TEXT, comment);\n-            commentDM.setPropertyValue(CommentsConstants.COMMENT_AUTHOR, author);\n-            commentDM.setPropertyValue(CommentsConstants.COMMENT_CREATION_DATE, Calendar.getInstance());\n+            commentDM.setPropertyValue(COMMENT_TEXT_PROPERTY, comment);\n+            commentDM.setPropertyValue(COMMENT_AUTHOR_PROPERTY, author);\n+            commentDM.setPropertyValue(COMMENT_CREATION_DATE_PROPERTY, Calendar.getInstance());\n             commentDM = internalCreateComment(session, docModel, commentDM, null);\n             session.save();\n \n             return commentDM;\n         }\n     }\n \n+    @Override\n+    public DocumentModel getThreadForComment(DocumentModel comment) throws CommentSecurityException {\n+        List<DocumentModel> threads = getDocumentsForComment(comment);\n+        if (threads.size() > 0) {\n+            DocumentModel thread = threads.get(0);\n+            while (thread.getType().equals(\"Post\") || thread.getType().equals(COMMENT_DOC_TYPE)) {\n+                thread = getThreadForComment(thread);\n+            }\n+            return thread;\n+        }\n+        return null;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ed64259cc9adc59324d337bee2481532785ae8b"}, "originalPosition": 98}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1ODA3NjAz", "url": "https://github.com/nuxeo/nuxeo/pull/3724#pullrequestreview-355807603", "createdAt": "2020-02-10T09:57:07Z", "commit": {"oid": "3ed64259cc9adc59324d337bee2481532785ae8b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwOTo1NzowN1rOFnf7og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwOTo1NzowN1rOFnf7og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk2MTk1NA==", "bodyText": "Is there a reason to remove this version of the thread comment calculation and go back to the recursion once. As discussed initially the idea was to avoid using the recursive algo", "url": "https://github.com/nuxeo/nuxeo/pull/3724#discussion_r376961954", "createdAt": "2020-02-10T09:57:07Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/java/org/nuxeo/ecm/platform/comment/impl/PropertyCommentManager.java", "diffHunk": "@@ -428,37 +442,38 @@ protected String getCommentContainerPath(CoreSession session, String commentedDo\n         });\n     }\n \n+    // former top level document method\n     protected DocumentRef getAncestorRef(CoreSession session, DocumentModel documentModel) {\n-        DocumentModel ancestorComment = getThreadForComment(session, documentModel);\n-        return ancestorComment.getRef();\n+        if (!documentModel.hasSchema(COMMENT_SCHEMA)) {\n+            return documentModel.getRef();\n+        }\n+        // thread is the higher comment in a succession of replies\n+        DocumentModel thread = getThreadForComment(session, documentModel);\n+        return new IdRef((String) thread.getPropertyValue(COMMENT_PARENT_ID_PROPERTY));\n     }\n \n     protected DocumentModel getThreadForComment(CoreSession s, DocumentModel comment) throws CommentSecurityException {\n         NuxeoPrincipal principal = s.getPrincipal();\n         return CoreInstance.doPrivileged(s, session -> {\n-            // Fetch the document in a case where it is not associated to an open session\n-            DocumentModel documentModel = session.getDocument(comment.getRef());\n-            while (documentModel.hasSchema(COMMENT_SCHEMA) || HIDDEN_FOLDER_TYPE.equals(documentModel.getType())) {\n-                documentModel = session.getDocument(\n-                        new IdRef((String) documentModel.getPropertyValue(COMMENT_PARENT_ID)));\n+            DocumentModel thread = comment;\n+            DocumentModel parent = s.getDocument(\n+                    new IdRef((String) thread.getPropertyValue(COMMENT_PARENT_ID_PROPERTY)));\n+            if (parent.hasSchema(COMMENT_SCHEMA)) {\n+                thread = getThreadForComment(parent);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ed64259cc9adc59324d337bee2481532785ae8b"}, "originalPosition": 320}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1ODE4NjY0", "url": "https://github.com/nuxeo/nuxeo/pull/3724#pullrequestreview-355818664", "createdAt": "2020-02-10T10:13:39Z", "commit": {"oid": "3ed64259cc9adc59324d337bee2481532785ae8b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMDoxMzo0MFrOFngduQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMDoxMzo0MFrOFngduQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3MDY4MQ==", "bodyText": "perhaps i am missing something, but if i remember when i did the work on comments, reviews that i had suggests to put session as a parameter in the lambda", "url": "https://github.com/nuxeo/nuxeo/pull/3724#discussion_r376970681", "createdAt": "2020-02-10T10:13:40Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/java/org/nuxeo/ecm/platform/comment/impl/TreeCommentManager.java", "diffHunk": "@@ -107,132 +111,143 @@\n      * Counts how many comments where made by a specific user on a specific document.\n      */\n     protected static final String QUERY_GET_COMMENTS_UUID_BY_COMMENT_ANCESTOR_AND_AUTHOR = //\n-            QUERY_GET_COMMENTS_UUID_BY_COMMENT_ANCESTOR + \" AND \" + COMMENT_AUTHOR + \" = '%s'\";\n-\n-    /** @since 11.1 **/\n-    public static final String COMMENT_RELATED_TEXT_ID = \"commentRelatedTextId_%s\";\n+            QUERY_GET_COMMENTS_UUID_BY_COMMENT_ANCESTOR + \" AND \" + COMMENT_AUTHOR_PROPERTY + \" = '%s'\";\n \n     @Override\n-    public List<DocumentModel> getComments(CoreSession s, DocumentModel docModel) {\n+    public List<DocumentModel> getComments(CoreSession session, DocumentModel docModel) {\n         // Check permissions\n-        checkReadCommentPermissions(s, docModel.getRef());\n-        return CoreInstance.doPrivileged(s, session -> {\n-            PageProvider<DocumentModel> pageProvider = getCommentsPageProvider(session, docModel, null, null, true);\n+        checkReadCommentPermissions(session, docModel.getRef());\n+        return CoreInstance.doPrivileged(session, s -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ed64259cc9adc59324d337bee2481532785ae8b"}, "originalPosition": 91}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1ODI3Mjgz", "url": "https://github.com/nuxeo/nuxeo/pull/3724#pullrequestreview-355827283", "createdAt": "2020-02-10T10:26:48Z", "commit": {"oid": "3ed64259cc9adc59324d337bee2481532785ae8b"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3ed64259cc9adc59324d337bee2481532785ae8b", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/3ed64259cc9adc59324d337bee2481532785ae8b", "committedDate": "2020-02-07T16:30:20Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}, "afterCommit": {"oid": "a5947a7d091bf26b609e4ca718f5d4061e82ae1a", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/a5947a7d091bf26b609e4ca718f5d4061e82ae1a", "committedDate": "2020-02-10T16:27:47Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MDQwMjk5", "url": "https://github.com/nuxeo/nuxeo/pull/3724#pullrequestreview-356040299", "createdAt": "2020-02-10T15:42:14Z", "commit": {"oid": "f09897626983c670011fad2e4d70b7639692c0f8"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxNTo0MjoxNVrOFnq6pw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxNTo0OTozNFrOFnrNbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzE0MTkyNw==", "bodyText": "3 constants are announced in the comment but you only introduce 2. I guess \"schema\" can be removed from the comment or it would be declared like: f098976#diff-405a1bb1a9676b44379522114af2d70fR57 ?", "url": "https://github.com/nuxeo/nuxeo/pull/3724#discussion_r377141927", "createdAt": "2020-02-10T15:42:15Z", "author": {"login": "NourNuxeo"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment-api/src/main/java/org/nuxeo/ecm/platform/comment/api/AnnotationConstants.java", "diffHunk": "@@ -28,13 +28,39 @@ private AnnotationConstants() {\n         // utility class\n     }\n \n+    // --------------------------------------------\n+    // Document type, schema and property constants\n+    // --------------------------------------------\n+\n     public static final String ANNOTATION_DOC_TYPE = \"Annotation\";\n \n     public static final String ANNOTATION_XPATH_PROPERTY = \"annotation:xpath\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f09897626983c670011fad2e4d70b7639692c0f8"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzE0NjM2NA==", "bodyText": "No Javadoc ?", "url": "https://github.com/nuxeo/nuxeo/pull/3724#discussion_r377146364", "createdAt": "2020-02-10T15:49:00Z", "author": {"login": "NourNuxeo"}, "path": "nuxeo-common/src/main/java/org/nuxeo/common/utils/DateUtils.java", "diffHunk": "@@ -131,13 +133,29 @@ public static final DateTimeFormatter robustOfPattern(String pattern) {\n                                              .withZone(ZoneOffset.UTC);\n     }\n \n+    public static Calendar toCalendar(Instant instant) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ed64259cc9adc59324d337bee2481532785ae8b"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzE0NjczMg==", "bodyText": "Same question as for 3ed6425#diff-6320fcbbad5b8f7ec8bccf28b24fb434R136", "url": "https://github.com/nuxeo/nuxeo/pull/3724#discussion_r377146732", "createdAt": "2020-02-10T15:49:34Z", "author": {"login": "NourNuxeo"}, "path": "nuxeo-common/src/main/java/org/nuxeo/common/utils/DateUtils.java", "diffHunk": "@@ -131,13 +133,29 @@ public static final DateTimeFormatter robustOfPattern(String pattern) {\n                                              .withZone(ZoneOffset.UTC);\n     }\n \n+    public static Calendar toCalendar(Instant instant) {\n+        if (instant == null) {\n+            return null;\n+        }\n+        // an Instant is on UTC by definition\n+        var zdt = ZonedDateTime.ofInstant(instant, ZoneOffset.UTC);\n+        return GregorianCalendar.from(zdt);\n+    }\n+\n     public static Date toDate(ZonedDateTime zdt) {\n         if (zdt == null) {\n             return null;\n         }\n         return Date.from(zdt.toInstant());\n     }\n \n+    public static Instant toInstant(Calendar calendar) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ed64259cc9adc59324d337bee2481532785ae8b"}, "originalPosition": 36}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a5947a7d091bf26b609e4ca718f5d4061e82ae1a", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/a5947a7d091bf26b609e4ca718f5d4061e82ae1a", "committedDate": "2020-02-10T16:27:47Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}, "afterCommit": {"oid": "e5ed18f4577dfda69a10b7f43d8f457fdc16d4fe", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/e5ed18f4577dfda69a10b7f43d8f457fdc16d4fe", "committedDate": "2020-02-10T17:22:21Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e5ed18f4577dfda69a10b7f43d8f457fdc16d4fe", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/e5ed18f4577dfda69a10b7f43d8f457fdc16d4fe", "committedDate": "2020-02-10T17:22:21Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}, "afterCommit": {"oid": "1fa4974d89e21e5222cc14a44e590c568ea15d63", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/1fa4974d89e21e5222cc14a44e590c568ea15d63", "committedDate": "2020-02-11T08:21:08Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1fa4974d89e21e5222cc14a44e590c568ea15d63", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/1fa4974d89e21e5222cc14a44e590c568ea15d63", "committedDate": "2020-02-11T08:21:08Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}, "afterCommit": {"oid": "711052031938d42ea85f4b0439225ac2840a6fdd", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/711052031938d42ea85f4b0439225ac2840a6fdd", "committedDate": "2020-02-12T11:42:40Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "711052031938d42ea85f4b0439225ac2840a6fdd", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/711052031938d42ea85f4b0439225ac2840a6fdd", "committedDate": "2020-02-12T11:42:40Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}, "afterCommit": {"oid": "1ae5a88663dbd2f81edd208cbc0ccfa9e9ede781", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/1ae5a88663dbd2f81edd208cbc0ccfa9e9ede781", "committedDate": "2020-02-13T09:55:04Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MTAzNTEz", "url": "https://github.com/nuxeo/nuxeo/pull/3724#pullrequestreview-358103513", "createdAt": "2020-02-13T10:24:35Z", "commit": {"oid": "1ae5a88663dbd2f81edd208cbc0ccfa9e9ede781"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMDoyNzoyMFrOFpOeMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMToyMzozMlrOFpQN_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc3MzA0Mg==", "bodyText": "Maybe I would stick with a sentence starting with a verb like the other methods.", "url": "https://github.com/nuxeo/nuxeo/pull/3724#discussion_r378773042", "createdAt": "2020-02-13T10:27:20Z", "author": {"login": "NourNuxeo"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment-api/src/main/java/org/nuxeo/ecm/platform/comment/api/Comment.java", "diffHunk": "@@ -126,4 +132,10 @@\n      * @param modificationDate the modification date\n      */\n     void setModificationDate(Instant modificationDate);\n+\n+    /**\n+     * @return the document model backing this pojo", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ae5a88663dbd2f81edd208cbc0ccfa9e9ede781"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgwMTY2MQ==", "bodyText": "just realized it was added in the last commit instead of rework constants location", "url": "https://github.com/nuxeo/nuxeo/pull/3724#discussion_r378801661", "createdAt": "2020-02-13T11:23:32Z", "author": {"login": "NourNuxeo"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment-api/src/main/java/org/nuxeo/ecm/platform/comment/api/AnnotationConstants.java", "diffHunk": "@@ -34,14 +34,17 @@ private AnnotationConstants() {\n \n     public static final String ANNOTATION_DOC_TYPE = \"Annotation\";\n \n+    /** @since 11.1 */\n+    public static final String ANNOTATION_SCHEMA = \"annotation\";\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ae5a88663dbd2f81edd208cbc0ccfa9e9ede781"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1ae5a88663dbd2f81edd208cbc0ccfa9e9ede781", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/1ae5a88663dbd2f81edd208cbc0ccfa9e9ede781", "committedDate": "2020-02-13T09:55:04Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}, "afterCommit": {"oid": "da61d9a6c26e50b048512d236794d892c54f43b9", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/da61d9a6c26e50b048512d236794d892c54f43b9", "committedDate": "2020-02-14T10:06:49Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "da61d9a6c26e50b048512d236794d892c54f43b9", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/da61d9a6c26e50b048512d236794d892c54f43b9", "committedDate": "2020-02-14T10:06:49Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}, "afterCommit": {"oid": "45653328f61107929bf34c603f55d318dad387a1", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/45653328f61107929bf34c603f55d318dad387a1", "committedDate": "2020-02-14T10:18:59Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4ODUyMTU0", "url": "https://github.com/nuxeo/nuxeo/pull/3724#pullrequestreview-358852154", "createdAt": "2020-02-14T10:38:52Z", "commit": {"oid": "45653328f61107929bf34c603f55d318dad387a1"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4ODUzMjI2", "url": "https://github.com/nuxeo/nuxeo/pull/3724#pullrequestreview-358853226", "createdAt": "2020-02-14T10:40:42Z", "commit": {"oid": "45653328f61107929bf34c603f55d318dad387a1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxMDo0MDo0MlrOFpydKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxMDo0MDo0MlrOFpydKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM2MjYwMw==", "bodyText": "unused ?", "url": "https://github.com/nuxeo/nuxeo/pull/3724#discussion_r379362603", "createdAt": "2020-02-14T10:40:42Z", "author": {"login": "NourNuxeo"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment-api/src/main/java/org/nuxeo/ecm/platform/comment/api/CommentImpl.java", "diffHunk": "@@ -20,136 +20,243 @@\n \n package org.nuxeo.ecm.platform.comment.api;\n \n+import static org.nuxeo.common.utils.DateUtils.toCalendar;\n+import static org.nuxeo.common.utils.DateUtils.toInstant;\n+import static org.nuxeo.ecm.platform.comment.api.CommentConstants.COMMENT_ANCESTOR_IDS_PROPERTY;\n+import static org.nuxeo.ecm.platform.comment.api.CommentConstants.COMMENT_AUTHOR_PROPERTY;\n+import static org.nuxeo.ecm.platform.comment.api.CommentConstants.COMMENT_CREATION_DATE_PROPERTY;\n+import static org.nuxeo.ecm.platform.comment.api.CommentConstants.COMMENT_DOC_TYPE;\n+import static org.nuxeo.ecm.platform.comment.api.CommentConstants.COMMENT_MODIFICATION_DATE_PROPERTY;\n+import static org.nuxeo.ecm.platform.comment.api.CommentConstants.COMMENT_PARENT_ID_PROPERTY;\n+import static org.nuxeo.ecm.platform.comment.api.CommentConstants.COMMENT_TEXT_PROPERTY;\n+import static org.nuxeo.ecm.platform.comment.api.ExternalEntityConstants.EXTERNAL_ENTITY_FACET;\n+import static org.nuxeo.ecm.platform.comment.api.ExternalEntityConstants.EXTERNAL_ENTITY_ID_PROPERTY;\n+import static org.nuxeo.ecm.platform.comment.api.ExternalEntityConstants.EXTERNAL_ENTITY_ORIGIN_PROPERTY;\n+import static org.nuxeo.ecm.platform.comment.api.ExternalEntityConstants.EXTERNAL_ENTITY_PROPERTY;\n+\n import java.time.Instant;\n+import java.util.Arrays;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45653328f61107929bf34c603f55d318dad387a1"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4ODcxNzMy", "url": "https://github.com/nuxeo/nuxeo/pull/3724#pullrequestreview-358871732", "createdAt": "2020-02-14T11:14:07Z", "commit": {"oid": "7063a72e12dfb6aaf95bee39db115f43202865dc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxMToxNDowN1rOFpzVzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxMToxNDowN1rOFpzVzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM3NzEwMQ==", "bodyText": "this import is unused", "url": "https://github.com/nuxeo/nuxeo/pull/3724#discussion_r379377101", "createdAt": "2020-02-14T11:14:07Z", "author": {"login": "RSalem07"}, "path": "nuxeo-core/nuxeo-core-api/src/main/java/org/nuxeo/ecm/core/api/impl/SimpleDocumentModel.java", "diffHunk": "@@ -23,12 +23,14 @@\n import static org.nuxeo.ecm.core.schema.types.ComplexTypeImpl.canonicalXPath;\n \n import java.io.Serializable;\n+import java.util.Arrays;\n import java.util.Collection;\n import java.util.Collections;\n import java.util.HashMap;\n import java.util.HashSet;\n import java.util.List;\n import java.util.Map;\n+import java.util.Objects;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7063a72e12dfb6aaf95bee39db115f43202865dc"}, "originalPosition": 11}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "45653328f61107929bf34c603f55d318dad387a1", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/45653328f61107929bf34c603f55d318dad387a1", "committedDate": "2020-02-14T10:18:59Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}, "afterCommit": {"oid": "714af584f35e81dfab8c373d0331d9e0bc7b6a9a", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/714af584f35e81dfab8c373d0331d9e0bc7b6a9a", "committedDate": "2020-02-14T12:36:31Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4OTEyNTI1", "url": "https://github.com/nuxeo/nuxeo/pull/3724#pullrequestreview-358912525", "createdAt": "2020-02-14T12:37:57Z", "commit": {"oid": "714af584f35e81dfab8c373d0331d9e0bc7b6a9a"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "714af584f35e81dfab8c373d0331d9e0bc7b6a9a", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/714af584f35e81dfab8c373d0331d9e0bc7b6a9a", "committedDate": "2020-02-14T12:36:31Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}, "afterCommit": {"oid": "ac1d51592a4598e80a47f99b0d7b53948ae291ae", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/ac1d51592a4598e80a47f99b0d7b53948ae291ae", "committedDate": "2020-02-14T12:39:33Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4OTEzOTQ1", "url": "https://github.com/nuxeo/nuxeo/pull/3724#pullrequestreview-358913945", "createdAt": "2020-02-14T12:40:42Z", "commit": {"oid": "ac1d51592a4598e80a47f99b0d7b53948ae291ae"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ac1d51592a4598e80a47f99b0d7b53948ae291ae", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/ac1d51592a4598e80a47f99b0d7b53948ae291ae", "committedDate": "2020-02-14T12:39:33Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}, "afterCommit": {"oid": "f44117796b33eae984623ac4df010afee6a67bc5", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/f44117796b33eae984623ac4df010afee6a67bc5", "committedDate": "2020-02-17T09:32:53Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwOTIzNjY5", "url": "https://github.com/nuxeo/nuxeo/pull/3724#pullrequestreview-360923669", "createdAt": "2020-02-19T08:39:36Z", "commit": {"oid": "f44117796b33eae984623ac4df010afee6a67bc5"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f44117796b33eae984623ac4df010afee6a67bc5", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/f44117796b33eae984623ac4df010afee6a67bc5", "committedDate": "2020-02-17T09:32:53Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}, "afterCommit": {"oid": "20f532ac06a313b209b3606faa7752ef9ef61567", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/20f532ac06a313b209b3606faa7752ef9ef61567", "committedDate": "2020-02-19T09:49:02Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7303375cb49a9c494b9dd509f6f2f537a7fecfbd", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/7303375cb49a9c494b9dd509f6f2f537a7fecfbd", "committedDate": "2020-02-19T10:00:24Z", "message": "NXP-28597: Cleanup / Format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ed86e49bc59777846638944f0feae16cd321758", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/5ed86e49bc59777846638944f0feae16cd321758", "committedDate": "2020-02-19T10:00:27Z", "message": "NXP-28597: Implements facet APIs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0df8fd5ea5434cdaad067e6a7262ecf52f3ebb68", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/0df8fd5ea5434cdaad067e6a7262ecf52f3ebb68", "committedDate": "2020-02-19T10:00:27Z", "message": "NXP-28484: Cleanup / Format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83005bd30360568da961c675f047c15e49057686", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/83005bd30360568da961c675f047c15e49057686", "committedDate": "2020-02-19T10:00:28Z", "message": "NXP-28484: Rework constants location"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f21a483e610db95e664621ce9b25d3b77342f153", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/f21a483e610db95e664621ce9b25d3b77342f153", "committedDate": "2020-02-19T10:00:28Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "20f532ac06a313b209b3606faa7752ef9ef61567", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/20f532ac06a313b209b3606faa7752ef9ef61567", "committedDate": "2020-02-19T09:49:02Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}, "afterCommit": {"oid": "f21a483e610db95e664621ce9b25d3b77342f153", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/f21a483e610db95e664621ce9b25d3b77342f153", "committedDate": "2020-02-19T10:00:28Z", "message": "NXP-28484: Allow to partially update comments/annotations through REST"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwOTgyOTcz", "url": "https://github.com/nuxeo/nuxeo/pull/3724#pullrequestreview-360982973", "createdAt": "2020-02-19T10:06:24Z", "commit": {"oid": "f21a483e610db95e664621ce9b25d3b77342f153"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxMDE3NDk2", "url": "https://github.com/nuxeo/nuxeo/pull/3724#pullrequestreview-361017496", "createdAt": "2020-02-19T10:57:01Z", "commit": {"oid": "f21a483e610db95e664621ce9b25d3b77342f153"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4839, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}