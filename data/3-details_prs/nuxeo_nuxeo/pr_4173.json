{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4MDMwNDg1", "number": 4173, "title": "NXP-29100: Orphaned DocumentRoute listener", "bodyText": "https://jira.nuxeo.com/browse/NXP-29100", "createdAt": "2020-06-22T15:47:38Z", "url": "https://github.com/nuxeo/nuxeo/pull/4173", "merged": true, "mergeCommit": {"oid": "34d4d77222251fd3a9672a00a55a7ad439553611"}, "closed": true, "closedAt": "2020-06-25T13:24:33Z", "author": {"login": "NourNuxeo"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABctzCwzgBqjM0NjkwOTg4OTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuulTzgFqTQzNzQ4Nzg4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "afb106bd251f8b6e933d9a2cccb463a18c189a0b", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/afb106bd251f8b6e933d9a2cccb463a18c189a0b", "committedDate": "2020-06-22T15:46:20Z", "message": "NXP-29100: Orphaned DocumentRoute listener"}, "afterCommit": {"oid": "f16053cabda2d5b27e399159be6fe693a71b7dde", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/f16053cabda2d5b27e399159be6fe693a71b7dde", "committedDate": "2020-06-22T16:00:44Z", "message": "NXP-29100: Orphaned DocumentRoute listener"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NTYxMTcx", "url": "https://github.com/nuxeo/nuxeo/pull/4173#pullrequestreview-435561171", "createdAt": "2020-06-23T08:33:47Z", "commit": {"oid": "f16053cabda2d5b27e399159be6fe693a71b7dde"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwODozMzo0N1rOGne_MA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwODo0NjowM1rOGnfcXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA1NTM0NA==", "bodyText": "Use DocumentRoutingConstants#ATTACHED_DOCUMENTS_PROPERTY_NAME?\nAlso, do we want to sort like in DocumentRoutingServiceImpl#getDocumentRoutesForAttachedDocument?", "url": "https://github.com/nuxeo/nuxeo/pull/4173#discussion_r444055344", "createdAt": "2020-06-23T08:33:47Z", "author": {"login": "ataillefer"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteOrphanedListener.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.routing.core.listener;\n+\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.ROUTING_TASK_DOC_TYPE;\n+\n+import java.util.List;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.IdRef;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventBundle;\n+import org.nuxeo.ecm.core.event.PostCommitEventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.routing.api.DocumentRoute;\n+\n+/**\n+ * Listener that deletes orphan DocumentRoutes.\n+ *\n+ * @since 11.2\n+ */\n+public class DocumentRouteOrphanedListener implements PostCommitEventListener {\n+\n+    protected static final String QUERY_GET_RELATED_DOCUMENT_ROUTES = \"SELECT * FROM \" + DOCUMENT_ROUTE_DOCUMENT_TYPE\n+            + \" WHERE docri:participatingDocuments/* = '%s'\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f16053cabda2d5b27e399159be6fe693a71b7dde"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA2MDA0NQ==", "bodyText": "Is there an alternative to peek? See the Sonar code smell.", "url": "https://github.com/nuxeo/nuxeo/pull/4173#discussion_r444060045", "createdAt": "2020-06-23T08:41:24Z", "author": {"login": "ataillefer"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteOrphanedListener.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.routing.core.listener;\n+\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.ROUTING_TASK_DOC_TYPE;\n+\n+import java.util.List;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.IdRef;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventBundle;\n+import org.nuxeo.ecm.core.event.PostCommitEventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.routing.api.DocumentRoute;\n+\n+/**\n+ * Listener that deletes orphan DocumentRoutes.\n+ *\n+ * @since 11.2\n+ */\n+public class DocumentRouteOrphanedListener implements PostCommitEventListener {\n+\n+    protected static final String QUERY_GET_RELATED_DOCUMENT_ROUTES = \"SELECT * FROM \" + DOCUMENT_ROUTE_DOCUMENT_TYPE\n+            + \" WHERE docri:participatingDocuments/* = '%s'\";\n+\n+    @Override\n+    public void handleEvent(EventBundle events) {\n+        for (Event event : events) {\n+            DocumentEventContext context = (DocumentEventContext) event.getContext();\n+            DocumentModel docModel = context.getSourceDocument();\n+            if (!DOCUMENT_ROUTE_DOCUMENT_TYPE.equals(docModel.getType())\n+                    && !ROUTING_TASK_DOC_TYPE.equals(docModel.getType())) {\n+                deleteOrphanDocumentRoutes(context.getCoreSession(), docModel.getId());\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Removes the given id from DocumentRoutes attached documents list and deletes the DocumentRoutes if they are not\n+     * attached to a document anymore.\n+     */\n+    protected void deleteOrphanDocumentRoutes(CoreSession session, String id) {\n+        String query = String.format(QUERY_GET_RELATED_DOCUMENT_ROUTES, id);\n+        session.query(query)\n+               .stream()\n+               .map(r -> r.getAdapter(DocumentRoute.class))\n+               .peek(r -> r.setAttachedDocuments(removeAttachedDoc(r, id)))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f16053cabda2d5b27e399159be6fe693a71b7dde"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA2MDM0MA==", "bodyText": "Use isEmpty() to check whether the collection is empty or not.", "url": "https://github.com/nuxeo/nuxeo/pull/4173#discussion_r444060340", "createdAt": "2020-06-23T08:41:54Z", "author": {"login": "ataillefer"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteOrphanedListener.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.routing.core.listener;\n+\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.ROUTING_TASK_DOC_TYPE;\n+\n+import java.util.List;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.IdRef;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventBundle;\n+import org.nuxeo.ecm.core.event.PostCommitEventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.routing.api.DocumentRoute;\n+\n+/**\n+ * Listener that deletes orphan DocumentRoutes.\n+ *\n+ * @since 11.2\n+ */\n+public class DocumentRouteOrphanedListener implements PostCommitEventListener {\n+\n+    protected static final String QUERY_GET_RELATED_DOCUMENT_ROUTES = \"SELECT * FROM \" + DOCUMENT_ROUTE_DOCUMENT_TYPE\n+            + \" WHERE docri:participatingDocuments/* = '%s'\";\n+\n+    @Override\n+    public void handleEvent(EventBundle events) {\n+        for (Event event : events) {\n+            DocumentEventContext context = (DocumentEventContext) event.getContext();\n+            DocumentModel docModel = context.getSourceDocument();\n+            if (!DOCUMENT_ROUTE_DOCUMENT_TYPE.equals(docModel.getType())\n+                    && !ROUTING_TASK_DOC_TYPE.equals(docModel.getType())) {\n+                deleteOrphanDocumentRoutes(context.getCoreSession(), docModel.getId());\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Removes the given id from DocumentRoutes attached documents list and deletes the DocumentRoutes if they are not\n+     * attached to a document anymore.\n+     */\n+    protected void deleteOrphanDocumentRoutes(CoreSession session, String id) {\n+        String query = String.format(QUERY_GET_RELATED_DOCUMENT_ROUTES, id);\n+        session.query(query)\n+               .stream()\n+               .map(r -> r.getAdapter(DocumentRoute.class))\n+               .peek(r -> r.setAttachedDocuments(removeAttachedDoc(r, id)))\n+               .peek(r -> session.saveDocument(r.getDocument()))\n+               .filter(r -> r.getAttachedDocuments().size() == 0)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f16053cabda2d5b27e399159be6fe693a71b7dde"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA2MjU1NQ==", "bodyText": "saveDocument is useless if createDocument was called just before and no property was updated", "url": "https://github.com/nuxeo/nuxeo/pull/4173#discussion_r444062555", "createdAt": "2020-06-23T08:45:38Z", "author": {"login": "ataillefer"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/test/java/org/nuxeo/ecm/platform/routing/test/TestDocumentRoutingService.java", "diffHunk": "@@ -384,6 +385,31 @@ public void testOrphanTasksDeletion() {\n         assertFalse(session.exists(task.getRef()));\n     }\n \n+    @Test\n+    public void testOrphanDocumentRoutesDeletion() {\n+        DocumentModel file1 = session.createDocumentModel(\"/\", \"File1\", \"File\");\n+        file1 = session.createDocument(file1);\n+        file1 = session.saveDocument(file1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f16053cabda2d5b27e399159be6fe693a71b7dde"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA2MjgxNA==", "bodyText": "useless", "url": "https://github.com/nuxeo/nuxeo/pull/4173#discussion_r444062814", "createdAt": "2020-06-23T08:46:03Z", "author": {"login": "ataillefer"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/test/java/org/nuxeo/ecm/platform/routing/test/TestDocumentRoutingService.java", "diffHunk": "@@ -384,6 +385,31 @@ public void testOrphanTasksDeletion() {\n         assertFalse(session.exists(task.getRef()));\n     }\n \n+    @Test\n+    public void testOrphanDocumentRoutesDeletion() {\n+        DocumentModel file1 = session.createDocumentModel(\"/\", \"File1\", \"File\");\n+        file1 = session.createDocument(file1);\n+        file1 = session.saveDocument(file1);\n+        DocumentModel file2 = session.createDocumentModel(\"/\", \"File2\", \"File\");\n+        file2 = session.createDocument(file2);\n+        file2 = session.saveDocument(file2);\n+        List<String> docIds = List.of(file1.getId(), file2.getId());\n+        DocumentModel route = session.createDocumentModel(\"/default-domain/workspaces\", \"dummyRoute1\",\n+                DOCUMENT_ROUTE_DOCUMENT_TYPE);\n+        route.setPropertyValue(DocumentRoutingConstants.ATTACHED_DOCUMENTS_PROPERTY_NAME, (Serializable) docIds);\n+        route = session.createDocument(route);\n+        route = session.saveDocument(route);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f16053cabda2d5b27e399159be6fe693a71b7dde"}, "originalPosition": 25}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f16053cabda2d5b27e399159be6fe693a71b7dde", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/f16053cabda2d5b27e399159be6fe693a71b7dde", "committedDate": "2020-06-22T16:00:44Z", "message": "NXP-29100: Orphaned DocumentRoute listener"}, "afterCommit": {"oid": "5ad1b9d19b742fb4bcd21a298878a5ee6a362821", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/5ad1b9d19b742fb4bcd21a298878a5ee6a362821", "committedDate": "2020-06-23T09:27:25Z", "message": "NXP-29100: Orphaned DocumentRoute listener"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5ad1b9d19b742fb4bcd21a298878a5ee6a362821", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/5ad1b9d19b742fb4bcd21a298878a5ee6a362821", "committedDate": "2020-06-23T09:27:25Z", "message": "NXP-29100: Orphaned DocumentRoute listener"}, "afterCommit": {"oid": "cdcd3b2e78545d1ecb33640e25f8ec6ec4051fe5", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/cdcd3b2e78545d1ecb33640e25f8ec6ec4051fe5", "committedDate": "2020-06-23T13:58:51Z", "message": "NXP-29100: Orphaned DocumentRoute listener"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1ODM0Mzc3", "url": "https://github.com/nuxeo/nuxeo/pull/4173#pullrequestreview-435834377", "createdAt": "2020-06-23T14:22:12Z", "commit": {"oid": "cdcd3b2e78545d1ecb33640e25f8ec6ec4051fe5"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNDoyMjoxM1rOGnrp6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNDoyNToxNFrOGnrzVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI2Mjg4OA==", "bodyText": "I would just work with the doc itself and doc#getPropertyValue/doc#setPropertyValue than mixing adapter and session/doc - I find it hardly understandable.", "url": "https://github.com/nuxeo/nuxeo/pull/4173#discussion_r444262888", "createdAt": "2020-06-23T14:22:13Z", "author": {"login": "troger"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteOrphanedListener.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.routing.core.listener;\n+\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.ATTACHED_DOCUMENTS_PROPERTY_NAME;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.ROUTING_TASK_DOC_TYPE;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventBundle;\n+import org.nuxeo.ecm.core.event.PostCommitEventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.routing.api.DocumentRoute;\n+\n+/**\n+ * Listener that deletes orphan DocumentRoutes.\n+ *\n+ * @since 11.2\n+ */\n+public class DocumentRouteOrphanedListener implements PostCommitEventListener {\n+\n+    protected static final String QUERY_GET_RELATED_DOCUMENT_ROUTES = \"SELECT * FROM \" + DOCUMENT_ROUTE_DOCUMENT_TYPE\n+            + \" WHERE \" + ATTACHED_DOCUMENTS_PROPERTY_NAME + \" = '%s' ORDER BY dc:created\";\n+\n+    @Override\n+    public void handleEvent(EventBundle events) {\n+        for (Event event : events) {\n+            DocumentEventContext context = (DocumentEventContext) event.getContext();\n+            DocumentModel docModel = context.getSourceDocument();\n+            if (!DOCUMENT_ROUTE_DOCUMENT_TYPE.equals(docModel.getType())\n+                    && !ROUTING_TASK_DOC_TYPE.equals(docModel.getType())) {\n+                deleteOrphanDocumentRoutes(context.getCoreSession(), docModel.getId());\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Removes the given id from DocumentRoutes attached documents list and deletes the DocumentRoutes if they are not\n+     * attached to a document anymore.\n+     */\n+    protected void deleteOrphanDocumentRoutes(CoreSession session, String id) {\n+        String query = String.format(QUERY_GET_RELATED_DOCUMENT_ROUTES, id);\n+        for (DocumentModel doc : session.query(query)) {\n+            DocumentRoute route = doc.getAdapter(DocumentRoute.class);\n+            var attachedDocuments = route.getAttachedDocuments();\n+            attachedDocuments.remove(id);\n+            if (attachedDocuments.isEmpty()) {\n+                session.removeDocument(doc.getRef());\n+            } else {\n+                route.setAttachedDocuments(attachedDocuments);\n+                session.saveDocument(doc);\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdcd3b2e78545d1ecb33640e25f8ec6ec4051fe5"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI2NTMwMw==", "bodyText": "Why the order?", "url": "https://github.com/nuxeo/nuxeo/pull/4173#discussion_r444265303", "createdAt": "2020-06-23T14:25:14Z", "author": {"login": "troger"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteOrphanedListener.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.routing.core.listener;\n+\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.ATTACHED_DOCUMENTS_PROPERTY_NAME;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.ROUTING_TASK_DOC_TYPE;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventBundle;\n+import org.nuxeo.ecm.core.event.PostCommitEventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.routing.api.DocumentRoute;\n+\n+/**\n+ * Listener that deletes orphan DocumentRoutes.\n+ *\n+ * @since 11.2\n+ */\n+public class DocumentRouteOrphanedListener implements PostCommitEventListener {\n+\n+    protected static final String QUERY_GET_RELATED_DOCUMENT_ROUTES = \"SELECT * FROM \" + DOCUMENT_ROUTE_DOCUMENT_TYPE\n+            + \" WHERE \" + ATTACHED_DOCUMENTS_PROPERTY_NAME + \" = '%s' ORDER BY dc:created\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdcd3b2e78545d1ecb33640e25f8ec6ec4051fe5"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b0d63eb99f35c9dfc901c90588973ad47f27a9e", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/6b0d63eb99f35c9dfc901c90588973ad47f27a9e", "committedDate": "2020-06-23T15:41:10Z", "message": "NXP-29100: Orphaned DocumentRoute listener"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cdcd3b2e78545d1ecb33640e25f8ec6ec4051fe5", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/cdcd3b2e78545d1ecb33640e25f8ec6ec4051fe5", "committedDate": "2020-06-23T13:58:51Z", "message": "NXP-29100: Orphaned DocumentRoute listener"}, "afterCommit": {"oid": "6b0d63eb99f35c9dfc901c90588973ad47f27a9e", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/6b0d63eb99f35c9dfc901c90588973ad47f27a9e", "committedDate": "2020-06-23T15:41:10Z", "message": "NXP-29100: Orphaned DocumentRoute listener"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2NDMzODky", "url": "https://github.com/nuxeo/nuxeo/pull/4173#pullrequestreview-436433892", "createdAt": "2020-06-24T08:29:43Z", "commit": {"oid": "6b0d63eb99f35c9dfc901c90588973ad47f27a9e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NDg3ODgz", "url": "https://github.com/nuxeo/nuxeo/pull/4173#pullrequestreview-437487883", "createdAt": "2020-06-25T13:22:59Z", "commit": {"oid": "6b0d63eb99f35c9dfc901c90588973ad47f27a9e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4716, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}