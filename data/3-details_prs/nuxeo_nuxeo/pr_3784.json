{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc5NTk2NDE1", "number": 3784, "title": "NXP-26690: transactional DBS", "bodyText": "", "createdAt": "2020-02-25T13:53:36Z", "url": "https://github.com/nuxeo/nuxeo/pull/3784", "merged": true, "mergeCommit": {"oid": "bdec40fa3e7f0d32b29432ed2b970dc06af35823"}, "closed": true, "closedAt": "2020-03-24T20:11:16Z", "author": {"login": "efge"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOpwqegBqjMxMzkxNjYzMTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQ3DingFqTM4MDU3OTE5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4c12969d3d9cc8aa6c62b7e434ea219595e4a035", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/4c12969d3d9cc8aa6c62b7e434ea219595e4a035", "committedDate": "2020-02-23T21:37:47Z", "message": "NXP-26690: transactional DBS (WIP)"}, "afterCommit": {"oid": "abcb2681ec82809adbf3f438f34dbf7d5de621b2", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/abcb2681ec82809adbf3f438f34dbf7d5de621b2", "committedDate": "2020-03-17T21:39:53Z", "message": "NXP-26690: transactional DBS (WIP)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "abcb2681ec82809adbf3f438f34dbf7d5de621b2", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/abcb2681ec82809adbf3f438f34dbf7d5de621b2", "committedDate": "2020-03-17T21:39:53Z", "message": "NXP-26690: transactional DBS (WIP)"}, "afterCommit": {"oid": "a57e1b8b7e8f5b4a1bd187977788b02cdb8ffd08", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/a57e1b8b7e8f5b4a1bd187977788b02cdb8ffd08", "committedDate": "2020-03-23T18:48:10Z", "message": "NXP-26690: transactional DBS"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NzQxNzU0", "url": "https://github.com/nuxeo/nuxeo/pull/3784#pullrequestreview-379741754", "createdAt": "2020-03-23T19:14:58Z", "commit": {"oid": "a57e1b8b7e8f5b4a1bd187977788b02cdb8ffd08"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxOToxNDo1OFrOF6UWcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxOToyNjoyOVrOF6UvXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY5NTE1NQ==", "bodyText": "Can we make DBSTransactionState a Closeable?", "url": "https://github.com/nuxeo/nuxeo/pull/3784#discussion_r396695155", "createdAt": "2020-03-23T19:14:58Z", "author": {"login": "kevinleturc"}, "path": "nuxeo-core/nuxeo-core-storage-dbs/src/main/java/org/nuxeo/ecm/core/storage/dbs/DBSTransactionState.java", "diffHunk": "@@ -151,13 +161,24 @@\n \n     protected final Set<String> browsePermissions;\n \n-    public DBSTransactionState(DBSRepository repository, DBSSession session) {\n+    public DBSTransactionState(DBSRepository repository, DBSConnection connection, DBSSession session) {\n         this.repository = repository;\n+        this.connection = connection;\n         this.session = session;\n         SecurityService securityService = Framework.getService(SecurityService.class);\n         browsePermissions = new HashSet<>(Arrays.asList(securityService.getPermissionsToCheck(BROWSE)));\n     }\n \n+    /** @since 11.1 */\n+    public void close() {\n+        connection.close();\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a57e1b8b7e8f5b4a1bd187977788b02cdb8ffd08"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcwMTUzMg==", "bodyText": "I didn't find any other instantiation of DBSTransactionState which makes me think we don't need to change the DBSTransactionState constructor and just do the getConnection into it, wdy?", "url": "https://github.com/nuxeo/nuxeo/pull/3784#discussion_r396701532", "createdAt": "2020-03-23T19:26:29Z", "author": {"login": "kevinleturc"}, "path": "nuxeo-core/nuxeo-core-storage-dbs/src/main/java/org/nuxeo/ecm/core/storage/dbs/DBSSession.java", "diffHunk": "@@ -192,7 +192,9 @@\n \n     public DBSSession(DBSRepository repository) {\n         this.repository = repository;\n-        transaction = new DBSTransactionState(repository, this);\n+        @SuppressWarnings(\"resource\") // connection closed by DBSTransactionState.close\n+        DBSConnection connection = repository.getConnection();\n+        transaction = new DBSTransactionState(repository, connection, this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a57e1b8b7e8f5b4a1bd187977788b02cdb8ffd08"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f9cb9edd49afd50f5f4217e396aa8681fed27f7", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/3f9cb9edd49afd50f5f4217e396aa8681fed27f7", "committedDate": "2020-03-24T15:56:43Z", "message": "NXP-26690: simplify LockManager code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a08ba44557df75e904fa632ebadb4ad560a8dab", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/6a08ba44557df75e904fa632ebadb4ad560a8dab", "committedDate": "2020-03-24T15:56:43Z", "message": "NXP-26690: factor out VCS and DBS invalidators classes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10ca36d2a9b7944f2a8866b765fde8a5404ecb3d", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/10ca36d2a9b7944f2a8866b765fde8a5404ecb3d", "committedDate": "2020-03-24T15:56:43Z", "message": "NXP-26690: copy code before separating repository and connection APIs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b024ecadbc3c46662634bcc84bb1703ae59e896f", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/b024ecadbc3c46662634bcc84bb1703ae59e896f", "committedDate": "2020-03-24T16:02:30Z", "message": "NXP-26690: transactional DBS"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a57e1b8b7e8f5b4a1bd187977788b02cdb8ffd08", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/a57e1b8b7e8f5b4a1bd187977788b02cdb8ffd08", "committedDate": "2020-03-23T18:48:10Z", "message": "NXP-26690: transactional DBS"}, "afterCommit": {"oid": "b024ecadbc3c46662634bcc84bb1703ae59e896f", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/b024ecadbc3c46662634bcc84bb1703ae59e896f", "committedDate": "2020-03-24T16:02:30Z", "message": "NXP-26690: transactional DBS"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNDYxOTEy", "url": "https://github.com/nuxeo/nuxeo/pull/3784#pullrequestreview-380461912", "createdAt": "2020-03-24T16:05:29Z", "commit": {"oid": "b024ecadbc3c46662634bcc84bb1703ae59e896f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNTc5MTk0", "url": "https://github.com/nuxeo/nuxeo/pull/3784#pullrequestreview-380579194", "createdAt": "2020-03-24T18:17:31Z", "commit": {"oid": "b024ecadbc3c46662634bcc84bb1703ae59e896f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4860, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}