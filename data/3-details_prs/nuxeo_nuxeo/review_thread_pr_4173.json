{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4MDMwNDg1", "number": 4173, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwODozMzo0N1rOEH3plg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNDoyNToxNFrOEH_luA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2Njg3MjU0OnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteOrphanedListener.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwODozMzo0N1rOGne_MA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwODozMzo0N1rOGne_MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA1NTM0NA==", "bodyText": "Use DocumentRoutingConstants#ATTACHED_DOCUMENTS_PROPERTY_NAME?\nAlso, do we want to sort like in DocumentRoutingServiceImpl#getDocumentRoutesForAttachedDocument?", "url": "https://github.com/nuxeo/nuxeo/pull/4173#discussion_r444055344", "createdAt": "2020-06-23T08:33:47Z", "author": {"login": "ataillefer"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteOrphanedListener.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.routing.core.listener;\n+\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.ROUTING_TASK_DOC_TYPE;\n+\n+import java.util.List;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.IdRef;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventBundle;\n+import org.nuxeo.ecm.core.event.PostCommitEventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.routing.api.DocumentRoute;\n+\n+/**\n+ * Listener that deletes orphan DocumentRoutes.\n+ *\n+ * @since 11.2\n+ */\n+public class DocumentRouteOrphanedListener implements PostCommitEventListener {\n+\n+    protected static final String QUERY_GET_RELATED_DOCUMENT_ROUTES = \"SELECT * FROM \" + DOCUMENT_ROUTE_DOCUMENT_TYPE\n+            + \" WHERE docri:participatingDocuments/* = '%s'\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f16053cabda2d5b27e399159be6fe693a71b7dde"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2NjkwMDgwOnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteOrphanedListener.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwODo0MToyNFrOGnfRjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMjozODowM1rOGnnMKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA2MDA0NQ==", "bodyText": "Is there an alternative to peek? See the Sonar code smell.", "url": "https://github.com/nuxeo/nuxeo/pull/4173#discussion_r444060045", "createdAt": "2020-06-23T08:41:24Z", "author": {"login": "ataillefer"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteOrphanedListener.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.routing.core.listener;\n+\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.ROUTING_TASK_DOC_TYPE;\n+\n+import java.util.List;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.IdRef;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventBundle;\n+import org.nuxeo.ecm.core.event.PostCommitEventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.routing.api.DocumentRoute;\n+\n+/**\n+ * Listener that deletes orphan DocumentRoutes.\n+ *\n+ * @since 11.2\n+ */\n+public class DocumentRouteOrphanedListener implements PostCommitEventListener {\n+\n+    protected static final String QUERY_GET_RELATED_DOCUMENT_ROUTES = \"SELECT * FROM \" + DOCUMENT_ROUTE_DOCUMENT_TYPE\n+            + \" WHERE docri:participatingDocuments/* = '%s'\";\n+\n+    @Override\n+    public void handleEvent(EventBundle events) {\n+        for (Event event : events) {\n+            DocumentEventContext context = (DocumentEventContext) event.getContext();\n+            DocumentModel docModel = context.getSourceDocument();\n+            if (!DOCUMENT_ROUTE_DOCUMENT_TYPE.equals(docModel.getType())\n+                    && !ROUTING_TASK_DOC_TYPE.equals(docModel.getType())) {\n+                deleteOrphanDocumentRoutes(context.getCoreSession(), docModel.getId());\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Removes the given id from DocumentRoutes attached documents list and deletes the DocumentRoutes if they are not\n+     * attached to a document anymore.\n+     */\n+    protected void deleteOrphanDocumentRoutes(CoreSession session, String id) {\n+        String query = String.format(QUERY_GET_RELATED_DOCUMENT_ROUTES, id);\n+        session.query(query)\n+               .stream()\n+               .map(r -> r.getAdapter(DocumentRoute.class))\n+               .peek(r -> r.setAttachedDocuments(removeAttachedDoc(r, id)))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f16053cabda2d5b27e399159be6fe693a71b7dde"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA3OTU3OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                           .peek(r -> r.setAttachedDocuments(removeAttachedDoc(r, id)))\n          \n          \n            \n                           .map(r -> {\n          \n          \n            \n                               r.setAttachedDocuments(removeAttachedDoc(r, id));\n          \n          \n            \n                               return r;\n          \n          \n            \n                           })", "url": "https://github.com/nuxeo/nuxeo/pull/4173#discussion_r444079578", "createdAt": "2020-06-23T09:12:23Z", "author": {"login": "NourNuxeo"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteOrphanedListener.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.routing.core.listener;\n+\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.ROUTING_TASK_DOC_TYPE;\n+\n+import java.util.List;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.IdRef;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventBundle;\n+import org.nuxeo.ecm.core.event.PostCommitEventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.routing.api.DocumentRoute;\n+\n+/**\n+ * Listener that deletes orphan DocumentRoutes.\n+ *\n+ * @since 11.2\n+ */\n+public class DocumentRouteOrphanedListener implements PostCommitEventListener {\n+\n+    protected static final String QUERY_GET_RELATED_DOCUMENT_ROUTES = \"SELECT * FROM \" + DOCUMENT_ROUTE_DOCUMENT_TYPE\n+            + \" WHERE docri:participatingDocuments/* = '%s'\";\n+\n+    @Override\n+    public void handleEvent(EventBundle events) {\n+        for (Event event : events) {\n+            DocumentEventContext context = (DocumentEventContext) event.getContext();\n+            DocumentModel docModel = context.getSourceDocument();\n+            if (!DOCUMENT_ROUTE_DOCUMENT_TYPE.equals(docModel.getType())\n+                    && !ROUTING_TASK_DOC_TYPE.equals(docModel.getType())) {\n+                deleteOrphanDocumentRoutes(context.getCoreSession(), docModel.getId());\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Removes the given id from DocumentRoutes attached documents list and deletes the DocumentRoutes if they are not\n+     * attached to a document anymore.\n+     */\n+    protected void deleteOrphanDocumentRoutes(CoreSession session, String id) {\n+        String query = String.format(QUERY_GET_RELATED_DOCUMENT_ROUTES, id);\n+        session.query(query)\n+               .stream()\n+               .map(r -> r.getAdapter(DocumentRoute.class))\n+               .peek(r -> r.setAttachedDocuments(removeAttachedDoc(r, id)))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA2MDA0NQ=="}, "originalCommit": {"oid": "f16053cabda2d5b27e399159be6fe693a71b7dde"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE4OTczOA==", "bodyText": "Frankly at this point it would be more readable to write a standard for loop.", "url": "https://github.com/nuxeo/nuxeo/pull/4173#discussion_r444189738", "createdAt": "2020-06-23T12:38:03Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteOrphanedListener.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.routing.core.listener;\n+\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.ROUTING_TASK_DOC_TYPE;\n+\n+import java.util.List;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.IdRef;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventBundle;\n+import org.nuxeo.ecm.core.event.PostCommitEventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.routing.api.DocumentRoute;\n+\n+/**\n+ * Listener that deletes orphan DocumentRoutes.\n+ *\n+ * @since 11.2\n+ */\n+public class DocumentRouteOrphanedListener implements PostCommitEventListener {\n+\n+    protected static final String QUERY_GET_RELATED_DOCUMENT_ROUTES = \"SELECT * FROM \" + DOCUMENT_ROUTE_DOCUMENT_TYPE\n+            + \" WHERE docri:participatingDocuments/* = '%s'\";\n+\n+    @Override\n+    public void handleEvent(EventBundle events) {\n+        for (Event event : events) {\n+            DocumentEventContext context = (DocumentEventContext) event.getContext();\n+            DocumentModel docModel = context.getSourceDocument();\n+            if (!DOCUMENT_ROUTE_DOCUMENT_TYPE.equals(docModel.getType())\n+                    && !ROUTING_TASK_DOC_TYPE.equals(docModel.getType())) {\n+                deleteOrphanDocumentRoutes(context.getCoreSession(), docModel.getId());\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Removes the given id from DocumentRoutes attached documents list and deletes the DocumentRoutes if they are not\n+     * attached to a document anymore.\n+     */\n+    protected void deleteOrphanDocumentRoutes(CoreSession session, String id) {\n+        String query = String.format(QUERY_GET_RELATED_DOCUMENT_ROUTES, id);\n+        session.query(query)\n+               .stream()\n+               .map(r -> r.getAdapter(DocumentRoute.class))\n+               .peek(r -> r.setAttachedDocuments(removeAttachedDoc(r, id)))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA2MDA0NQ=="}, "originalCommit": {"oid": "f16053cabda2d5b27e399159be6fe693a71b7dde"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2NjkwMjUxOnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteOrphanedListener.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwODo0MTo1NFrOGnfStA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwODo0MTo1NFrOGnfStA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA2MDM0MA==", "bodyText": "Use isEmpty() to check whether the collection is empty or not.", "url": "https://github.com/nuxeo/nuxeo/pull/4173#discussion_r444060340", "createdAt": "2020-06-23T08:41:54Z", "author": {"login": "ataillefer"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteOrphanedListener.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.routing.core.listener;\n+\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.ROUTING_TASK_DOC_TYPE;\n+\n+import java.util.List;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.IdRef;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventBundle;\n+import org.nuxeo.ecm.core.event.PostCommitEventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.routing.api.DocumentRoute;\n+\n+/**\n+ * Listener that deletes orphan DocumentRoutes.\n+ *\n+ * @since 11.2\n+ */\n+public class DocumentRouteOrphanedListener implements PostCommitEventListener {\n+\n+    protected static final String QUERY_GET_RELATED_DOCUMENT_ROUTES = \"SELECT * FROM \" + DOCUMENT_ROUTE_DOCUMENT_TYPE\n+            + \" WHERE docri:participatingDocuments/* = '%s'\";\n+\n+    @Override\n+    public void handleEvent(EventBundle events) {\n+        for (Event event : events) {\n+            DocumentEventContext context = (DocumentEventContext) event.getContext();\n+            DocumentModel docModel = context.getSourceDocument();\n+            if (!DOCUMENT_ROUTE_DOCUMENT_TYPE.equals(docModel.getType())\n+                    && !ROUTING_TASK_DOC_TYPE.equals(docModel.getType())) {\n+                deleteOrphanDocumentRoutes(context.getCoreSession(), docModel.getId());\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Removes the given id from DocumentRoutes attached documents list and deletes the DocumentRoutes if they are not\n+     * attached to a document anymore.\n+     */\n+    protected void deleteOrphanDocumentRoutes(CoreSession session, String id) {\n+        String query = String.format(QUERY_GET_RELATED_DOCUMENT_ROUTES, id);\n+        session.query(query)\n+               .stream()\n+               .map(r -> r.getAdapter(DocumentRoute.class))\n+               .peek(r -> r.setAttachedDocuments(removeAttachedDoc(r, id)))\n+               .peek(r -> session.saveDocument(r.getDocument()))\n+               .filter(r -> r.getAttachedDocuments().size() == 0)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f16053cabda2d5b27e399159be6fe693a71b7dde"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2NjkxNTg5OnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/test/java/org/nuxeo/ecm/platform/routing/test/TestDocumentRoutingService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwODo0NTozOFrOGnfbWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwODo0NTozOFrOGnfbWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA2MjU1NQ==", "bodyText": "saveDocument is useless if createDocument was called just before and no property was updated", "url": "https://github.com/nuxeo/nuxeo/pull/4173#discussion_r444062555", "createdAt": "2020-06-23T08:45:38Z", "author": {"login": "ataillefer"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/test/java/org/nuxeo/ecm/platform/routing/test/TestDocumentRoutingService.java", "diffHunk": "@@ -384,6 +385,31 @@ public void testOrphanTasksDeletion() {\n         assertFalse(session.exists(task.getRef()));\n     }\n \n+    @Test\n+    public void testOrphanDocumentRoutesDeletion() {\n+        DocumentModel file1 = session.createDocumentModel(\"/\", \"File1\", \"File\");\n+        file1 = session.createDocument(file1);\n+        file1 = session.saveDocument(file1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f16053cabda2d5b27e399159be6fe693a71b7dde"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2NjkxNzQ5OnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/test/java/org/nuxeo/ecm/platform/routing/test/TestDocumentRoutingService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwODo0NjowM1rOGnfcXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwODo0NjowM1rOGnfcXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA2MjgxNA==", "bodyText": "useless", "url": "https://github.com/nuxeo/nuxeo/pull/4173#discussion_r444062814", "createdAt": "2020-06-23T08:46:03Z", "author": {"login": "ataillefer"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/test/java/org/nuxeo/ecm/platform/routing/test/TestDocumentRoutingService.java", "diffHunk": "@@ -384,6 +385,31 @@ public void testOrphanTasksDeletion() {\n         assertFalse(session.exists(task.getRef()));\n     }\n \n+    @Test\n+    public void testOrphanDocumentRoutesDeletion() {\n+        DocumentModel file1 = session.createDocumentModel(\"/\", \"File1\", \"File\");\n+        file1 = session.createDocument(file1);\n+        file1 = session.saveDocument(file1);\n+        DocumentModel file2 = session.createDocumentModel(\"/\", \"File2\", \"File\");\n+        file2 = session.createDocument(file2);\n+        file2 = session.saveDocument(file2);\n+        List<String> docIds = List.of(file1.getId(), file2.getId());\n+        DocumentModel route = session.createDocumentModel(\"/default-domain/workspaces\", \"dummyRoute1\",\n+                DOCUMENT_ROUTE_DOCUMENT_TYPE);\n+        route.setPropertyValue(DocumentRoutingConstants.ATTACHED_DOCUMENTS_PROPERTY_NAME, (Serializable) docIds);\n+        route = session.createDocument(route);\n+        route = session.saveDocument(route);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f16053cabda2d5b27e399159be6fe693a71b7dde"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2ODE1NzYwOnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteOrphanedListener.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNDoyMjoxM1rOGnrp6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNDo0ODoyNlrOGns7Yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI2Mjg4OA==", "bodyText": "I would just work with the doc itself and doc#getPropertyValue/doc#setPropertyValue than mixing adapter and session/doc - I find it hardly understandable.", "url": "https://github.com/nuxeo/nuxeo/pull/4173#discussion_r444262888", "createdAt": "2020-06-23T14:22:13Z", "author": {"login": "troger"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteOrphanedListener.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.routing.core.listener;\n+\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.ATTACHED_DOCUMENTS_PROPERTY_NAME;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.ROUTING_TASK_DOC_TYPE;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventBundle;\n+import org.nuxeo.ecm.core.event.PostCommitEventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.routing.api.DocumentRoute;\n+\n+/**\n+ * Listener that deletes orphan DocumentRoutes.\n+ *\n+ * @since 11.2\n+ */\n+public class DocumentRouteOrphanedListener implements PostCommitEventListener {\n+\n+    protected static final String QUERY_GET_RELATED_DOCUMENT_ROUTES = \"SELECT * FROM \" + DOCUMENT_ROUTE_DOCUMENT_TYPE\n+            + \" WHERE \" + ATTACHED_DOCUMENTS_PROPERTY_NAME + \" = '%s' ORDER BY dc:created\";\n+\n+    @Override\n+    public void handleEvent(EventBundle events) {\n+        for (Event event : events) {\n+            DocumentEventContext context = (DocumentEventContext) event.getContext();\n+            DocumentModel docModel = context.getSourceDocument();\n+            if (!DOCUMENT_ROUTE_DOCUMENT_TYPE.equals(docModel.getType())\n+                    && !ROUTING_TASK_DOC_TYPE.equals(docModel.getType())) {\n+                deleteOrphanDocumentRoutes(context.getCoreSession(), docModel.getId());\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Removes the given id from DocumentRoutes attached documents list and deletes the DocumentRoutes if they are not\n+     * attached to a document anymore.\n+     */\n+    protected void deleteOrphanDocumentRoutes(CoreSession session, String id) {\n+        String query = String.format(QUERY_GET_RELATED_DOCUMENT_ROUTES, id);\n+        for (DocumentModel doc : session.query(query)) {\n+            DocumentRoute route = doc.getAdapter(DocumentRoute.class);\n+            var attachedDocuments = route.getAttachedDocuments();\n+            attachedDocuments.remove(id);\n+            if (attachedDocuments.isEmpty()) {\n+                session.removeDocument(doc.getRef());\n+            } else {\n+                route.setAttachedDocuments(attachedDocuments);\n+                session.saveDocument(doc);\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdcd3b2e78545d1ecb33640e25f8ec6ec4051fe5"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI4Mzc0Ng==", "bodyText": "Makes it simpler for me as well. I thought it would be more robust to use the adapter.", "url": "https://github.com/nuxeo/nuxeo/pull/4173#discussion_r444283746", "createdAt": "2020-06-23T14:48:26Z", "author": {"login": "NourNuxeo"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteOrphanedListener.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.routing.core.listener;\n+\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.ATTACHED_DOCUMENTS_PROPERTY_NAME;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.ROUTING_TASK_DOC_TYPE;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventBundle;\n+import org.nuxeo.ecm.core.event.PostCommitEventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.routing.api.DocumentRoute;\n+\n+/**\n+ * Listener that deletes orphan DocumentRoutes.\n+ *\n+ * @since 11.2\n+ */\n+public class DocumentRouteOrphanedListener implements PostCommitEventListener {\n+\n+    protected static final String QUERY_GET_RELATED_DOCUMENT_ROUTES = \"SELECT * FROM \" + DOCUMENT_ROUTE_DOCUMENT_TYPE\n+            + \" WHERE \" + ATTACHED_DOCUMENTS_PROPERTY_NAME + \" = '%s' ORDER BY dc:created\";\n+\n+    @Override\n+    public void handleEvent(EventBundle events) {\n+        for (Event event : events) {\n+            DocumentEventContext context = (DocumentEventContext) event.getContext();\n+            DocumentModel docModel = context.getSourceDocument();\n+            if (!DOCUMENT_ROUTE_DOCUMENT_TYPE.equals(docModel.getType())\n+                    && !ROUTING_TASK_DOC_TYPE.equals(docModel.getType())) {\n+                deleteOrphanDocumentRoutes(context.getCoreSession(), docModel.getId());\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Removes the given id from DocumentRoutes attached documents list and deletes the DocumentRoutes if they are not\n+     * attached to a document anymore.\n+     */\n+    protected void deleteOrphanDocumentRoutes(CoreSession session, String id) {\n+        String query = String.format(QUERY_GET_RELATED_DOCUMENT_ROUTES, id);\n+        for (DocumentModel doc : session.query(query)) {\n+            DocumentRoute route = doc.getAdapter(DocumentRoute.class);\n+            var attachedDocuments = route.getAttachedDocuments();\n+            attachedDocuments.remove(id);\n+            if (attachedDocuments.isEmpty()) {\n+                session.removeDocument(doc.getRef());\n+            } else {\n+                route.setAttachedDocuments(attachedDocuments);\n+                session.saveDocument(doc);\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI2Mjg4OA=="}, "originalCommit": {"oid": "cdcd3b2e78545d1ecb33640e25f8ec6ec4051fe5"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2ODE3MzM2OnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteOrphanedListener.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNDoyNToxNFrOGnrzVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNDo1NzoyOFrOGntXMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI2NTMwMw==", "bodyText": "Why the order?", "url": "https://github.com/nuxeo/nuxeo/pull/4173#discussion_r444265303", "createdAt": "2020-06-23T14:25:14Z", "author": {"login": "troger"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteOrphanedListener.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.routing.core.listener;\n+\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.ATTACHED_DOCUMENTS_PROPERTY_NAME;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.ROUTING_TASK_DOC_TYPE;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventBundle;\n+import org.nuxeo.ecm.core.event.PostCommitEventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.routing.api.DocumentRoute;\n+\n+/**\n+ * Listener that deletes orphan DocumentRoutes.\n+ *\n+ * @since 11.2\n+ */\n+public class DocumentRouteOrphanedListener implements PostCommitEventListener {\n+\n+    protected static final String QUERY_GET_RELATED_DOCUMENT_ROUTES = \"SELECT * FROM \" + DOCUMENT_ROUTE_DOCUMENT_TYPE\n+            + \" WHERE \" + ATTACHED_DOCUMENTS_PROPERTY_NAME + \" = '%s' ORDER BY dc:created\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdcd3b2e78545d1ecb33640e25f8ec6ec4051fe5"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI3Nzk3OQ==", "bodyText": "Just saw @ataillefer comment... I'm still not sure we need to add a sort here...", "url": "https://github.com/nuxeo/nuxeo/pull/4173#discussion_r444277979", "createdAt": "2020-06-23T14:41:01Z", "author": {"login": "troger"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteOrphanedListener.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.routing.core.listener;\n+\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.ATTACHED_DOCUMENTS_PROPERTY_NAME;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.ROUTING_TASK_DOC_TYPE;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventBundle;\n+import org.nuxeo.ecm.core.event.PostCommitEventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.routing.api.DocumentRoute;\n+\n+/**\n+ * Listener that deletes orphan DocumentRoutes.\n+ *\n+ * @since 11.2\n+ */\n+public class DocumentRouteOrphanedListener implements PostCommitEventListener {\n+\n+    protected static final String QUERY_GET_RELATED_DOCUMENT_ROUTES = \"SELECT * FROM \" + DOCUMENT_ROUTE_DOCUMENT_TYPE\n+            + \" WHERE \" + ATTACHED_DOCUMENTS_PROPERTY_NAME + \" = '%s' ORDER BY dc:created\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI2NTMwMw=="}, "originalCommit": {"oid": "cdcd3b2e78545d1ecb33640e25f8ec6ec4051fe5"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI4NTc5NA==", "bodyText": "I thought if you delete a parent workflow you don't need to check the subworkflows, but now that I think about it, but even if it was to work we would run into DocumentNotFoundException.", "url": "https://github.com/nuxeo/nuxeo/pull/4173#discussion_r444285794", "createdAt": "2020-06-23T14:51:01Z", "author": {"login": "NourNuxeo"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteOrphanedListener.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.routing.core.listener;\n+\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.ATTACHED_DOCUMENTS_PROPERTY_NAME;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.ROUTING_TASK_DOC_TYPE;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventBundle;\n+import org.nuxeo.ecm.core.event.PostCommitEventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.routing.api.DocumentRoute;\n+\n+/**\n+ * Listener that deletes orphan DocumentRoutes.\n+ *\n+ * @since 11.2\n+ */\n+public class DocumentRouteOrphanedListener implements PostCommitEventListener {\n+\n+    protected static final String QUERY_GET_RELATED_DOCUMENT_ROUTES = \"SELECT * FROM \" + DOCUMENT_ROUTE_DOCUMENT_TYPE\n+            + \" WHERE \" + ATTACHED_DOCUMENTS_PROPERTY_NAME + \" = '%s' ORDER BY dc:created\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI2NTMwMw=="}, "originalCommit": {"oid": "cdcd3b2e78545d1ecb33640e25f8ec6ec4051fe5"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI5MDg2NQ==", "bodyText": "In fact, the sorting clause I was talking about was added for the UI, see NXP-11738 and nuxeo-archives/nuxeo-platform-document-routing@bcfa699, so I think it's indeed not relevant here.", "url": "https://github.com/nuxeo/nuxeo/pull/4173#discussion_r444290865", "createdAt": "2020-06-23T14:57:28Z", "author": {"login": "ataillefer"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteOrphanedListener.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.routing.core.listener;\n+\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.ATTACHED_DOCUMENTS_PROPERTY_NAME;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.ROUTING_TASK_DOC_TYPE;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventBundle;\n+import org.nuxeo.ecm.core.event.PostCommitEventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.routing.api.DocumentRoute;\n+\n+/**\n+ * Listener that deletes orphan DocumentRoutes.\n+ *\n+ * @since 11.2\n+ */\n+public class DocumentRouteOrphanedListener implements PostCommitEventListener {\n+\n+    protected static final String QUERY_GET_RELATED_DOCUMENT_ROUTES = \"SELECT * FROM \" + DOCUMENT_ROUTE_DOCUMENT_TYPE\n+            + \" WHERE \" + ATTACHED_DOCUMENTS_PROPERTY_NAME + \" = '%s' ORDER BY dc:created\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI2NTMwMw=="}, "originalCommit": {"oid": "cdcd3b2e78545d1ecb33640e25f8ec6ec4051fe5"}, "originalPosition": 41}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4136, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}