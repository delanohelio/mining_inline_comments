{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4NDI4NTY1", "number": 3969, "title": "NXP-28869: Add a new API to refresh AWS tokens in the batch handler", "bodyText": "The new API can be used from /upload/{batchId}/refreshToken. It will return new tokens when the batch handler can handle the request, else it will throw an error.\nNote: opening the PR soon to ease discussion.", "createdAt": "2020-04-24T09:10:57Z", "url": "https://github.com/nuxeo/nuxeo/pull/3969", "merged": true, "mergeCommit": {"oid": "25333e680086a019dee4da7335ab37b0118d16fe"}, "closed": true, "closedAt": "2020-04-28T18:35:01Z", "author": {"login": "BoboTiG"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcaJyVLAH2gAyNDA4NDI4NTY1OmM0ODQ4Nzk5NzM1OTMzZmQ5NmY0MGY3OTBkYWQxMzc4ZGJkMDhmNDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABccDfGngFqTQwMTgwODQwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c4848799735933fd96f40f790dad1378dbd08f42", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/c4848799735933fd96f40f790dad1378dbd08f42", "committedDate": "2020-04-22T15:12:14Z", "message": "NXP-28869: Clean-up"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2bfc1cdbeeb08f0f7afc10d280cfcc96a5cfdf31", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/2bfc1cdbeeb08f0f7afc10d280cfcc96a5cfdf31", "committedDate": "2020-04-24T09:08:39Z", "message": "NXP-28869: Add a new API to refresh AWS tokens in the batch handler\n\nThe new API can be used from `/upload/{batchId}/refresh`.\nIt will return new tokens when the batch handler can\nhandle the request, else it will throw an error."}, "afterCommit": {"oid": "a23f0431ff67ea70a85109d0b8052898e4f26efc", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/a23f0431ff67ea70a85109d0b8052898e4f26efc", "committedDate": "2020-04-24T09:12:04Z", "message": "NXP-28869: Add a new API to refresh AWS tokens in the batch handler\n\nThe new API can be used from `/upload/{batchId}/refresh`.\nIt will return new tokens when the batch handler can\nhandle the request, else it will throw an error."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5Nzc4Njg1", "url": "https://github.com/nuxeo/nuxeo/pull/3969#pullrequestreview-399778685", "createdAt": "2020-04-24T09:17:36Z", "commit": {"oid": "a23f0431ff67ea70a85109d0b8052898e4f26efc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQwOToxNzozN1rOGLOf1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQwOToxNzozN1rOGLOf1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQyNTA0NQ==", "bodyText": "body can be removed, right?", "url": "https://github.com/nuxeo/nuxeo/pull/3969#discussion_r414425045", "createdAt": "2020-04-24T09:17:37Z", "author": {"login": "BoboTiG"}, "path": "modules/platform/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java", "diffHunk": "@@ -434,6 +436,28 @@ public Response getBatchExtraInfo(@PathParam(REQUEST_BATCH_ID) String batchId) t\n         return buildResponse(Status.OK, result);\n     }\n \n+    /** @since 11.1 */\n+    @POST\n+    @Path(\"{batchId}/refresh\")\n+    public Response refreshToken(@PathParam(REQUEST_BATCH_ID) String batchId,\n+            String body) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a23f0431ff67ea70a85109d0b8052898e4f26efc"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5ODE1ODQ3", "url": "https://github.com/nuxeo/nuxeo/pull/3969#pullrequestreview-399815847", "createdAt": "2020-04-24T10:10:48Z", "commit": {"oid": "a23f0431ff67ea70a85109d0b8052898e4f26efc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMDoxMDo0OFrOGLQj_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMDoxMDo0OFrOGLQj_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ1ODg3Nw==", "bodyText": "Better to use awaitility instead, see https://github.com/nuxeo/nuxeo/blob/master/modules/platform/nuxeo-platform-tag-service/nuxeo-platform-tag-core/src/test/java/org/nuxeo/ecm/platform/tag/AbstractTestTagService.java#L120 for instance.", "url": "https://github.com/nuxeo/nuxeo/pull/3969#discussion_r414458877", "createdAt": "2020-04-24T10:10:48Z", "author": {"login": "ataillefer"}, "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/test/java/org/nuxeo/ecm/core/storage/sql/TestS3DirectBatchHandler.java", "diffHunk": "@@ -162,6 +164,51 @@ public void test20MB() throws SdkBaseException, InterruptedException {\n         test(\"s3\", 20 * 1024 * 1024);\n     }\n \n+    @Test\n+    @Deploy(\"org.nuxeo.ecm.core.storage.binarymanager.s3.tests:OSGI-INF/test-s3directupload-contrib.xml\")\n+    public void testTokenRenewal() throws SdkBaseException, InterruptedException {\n+        // Test that refreshing tokens actually returns back valid and different tokens.\n+        S3DirectBatchHandler handler = (S3DirectBatchHandler) batchManager.getHandler(\"s3\");\n+        Batch newBatch = handler.newBatch(null);\n+        Batch batch = handler.getBatch(newBatch.getKey());\n+\n+        // Save current details\n+        Map<String, Object> properties = batch.getProperties();\n+        String secretKeyId = (String) properties.get(S3DirectBatchHandler.INFO_AWS_SECRET_KEY_ID);\n+        String secretAccessKey = (String) properties.get(S3DirectBatchHandler.INFO_AWS_SECRET_ACCESS_KEY);\n+        String sessionToken = (String) properties.get(S3DirectBatchHandler.INFO_AWS_SESSION_TOKEN);\n+        Long expiration = (Long) properties.get(S3DirectBatchHandler.INFO_EXPIRATION);\n+\n+        // Wait for some time else the new expiration will not be updated\n+        Thread.sleep(1000); // 1s", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a23f0431ff67ea70a85109d0b8052898e4f26efc"}, "originalPosition": 33}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a23f0431ff67ea70a85109d0b8052898e4f26efc", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/a23f0431ff67ea70a85109d0b8052898e4f26efc", "committedDate": "2020-04-24T09:12:04Z", "message": "NXP-28869: Add a new API to refresh AWS tokens in the batch handler\n\nThe new API can be used from `/upload/{batchId}/refresh`.\nIt will return new tokens when the batch handler can\nhandle the request, else it will throw an error."}, "afterCommit": {"oid": "b94b2c2d7e33605965dbba3f2fcafb2eecf5d307", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/b94b2c2d7e33605965dbba3f2fcafb2eecf5d307", "committedDate": "2020-04-24T13:07:33Z", "message": "NXP-28869: Add a new API to refresh AWS tokens in the batch handler\n\nThe new API can be used from `/upload/{batchId}/refresh`.\nIt will return new tokens when the batch handler can\nhandle the request, else it will throw an error."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b94b2c2d7e33605965dbba3f2fcafb2eecf5d307", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/b94b2c2d7e33605965dbba3f2fcafb2eecf5d307", "committedDate": "2020-04-24T13:07:33Z", "message": "NXP-28869: Add a new API to refresh AWS tokens in the batch handler\n\nThe new API can be used from `/upload/{batchId}/refresh`.\nIt will return new tokens when the batch handler can\nhandle the request, else it will throw an error."}, "afterCommit": {"oid": "b15cd8e72d3825e832080f9b45f29e69e91f4316", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/b15cd8e72d3825e832080f9b45f29e69e91f4316", "committedDate": "2020-04-24T14:09:59Z", "message": "NXP-28869: Add a new API to refresh AWS tokens in the batch handler\n\nThe new API can be used from `/upload/{batchId}/refresh`.\nIt will return new tokens when the batch handler can\nhandle the request, else it will throw an error."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5OTk0NTY4", "url": "https://github.com/nuxeo/nuxeo/pull/3969#pullrequestreview-399994568", "createdAt": "2020-04-24T14:25:30Z", "commit": {"oid": "b15cd8e72d3825e832080f9b45f29e69e91f4316"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNDoyNTozMFrOGLaOyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNDoyNzozM1rOGLaU-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYxNzI5MA==", "bodyText": "You should move this to a default method in the interface as others may have custom batch handlers. Adapt the message of course (the default -> this).", "url": "https://github.com/nuxeo/nuxeo/pull/3969#discussion_r414617290", "createdAt": "2020-04-24T14:25:30Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-automation/nuxeo-automation-server/src/main/java/org/nuxeo/ecm/automation/server/jaxrs/batch/handler/impl/DefaultBatchHandler.java", "diffHunk": "@@ -55,4 +56,9 @@ public boolean completeUpload(String batchId, String fileIndex, BatchFileInfo fi\n                 && Objects.equals(fileEntry.getBlob().getDigest(), fileInfo.getMd5());\n     }\n \n+    @Override\n+    public Map<String, Object> refreshToken(String batchId) {\n+        throw new UnsupportedOperationException(\"Refresh token is not supported for the default batch handler.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b15cd8e72d3825e832080f9b45f29e69e91f4316"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYxODg3Mw==", "bodyText": "I'd call it /refreshToken to be more explicit. \"refresh\" in the context of a batch upload does not immediately evoke the auth token.", "url": "https://github.com/nuxeo/nuxeo/pull/3969#discussion_r414618873", "createdAt": "2020-04-24T14:27:33Z", "author": {"login": "efge"}, "path": "modules/platform/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java", "diffHunk": "@@ -434,6 +436,27 @@ public Response getBatchExtraInfo(@PathParam(REQUEST_BATCH_ID) String batchId) t\n         return buildResponse(Status.OK, result);\n     }\n \n+    /** @since 11.1 */\n+    @POST\n+    @Path(\"{batchId}/refresh\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b15cd8e72d3825e832080f9b45f29e69e91f4316"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d16a2cb33bdf3a817283e4cce992a0751873104", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/1d16a2cb33bdf3a817283e4cce992a0751873104", "committedDate": "2020-04-24T14:51:49Z", "message": "NXP-28869: Add a new API to refresh AWS tokens in the batch handler\n\nThe new API can be used from `/upload/{batchId}/refreshToken`.\nIt will return new tokens when the batch handler can\nhandle the request, else it will throw an error."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b15cd8e72d3825e832080f9b45f29e69e91f4316", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/b15cd8e72d3825e832080f9b45f29e69e91f4316", "committedDate": "2020-04-24T14:09:59Z", "message": "NXP-28869: Add a new API to refresh AWS tokens in the batch handler\n\nThe new API can be used from `/upload/{batchId}/refresh`.\nIt will return new tokens when the batch handler can\nhandle the request, else it will throw an error."}, "afterCommit": {"oid": "1d16a2cb33bdf3a817283e4cce992a0751873104", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/1d16a2cb33bdf3a817283e4cce992a0751873104", "committedDate": "2020-04-24T14:51:49Z", "message": "NXP-28869: Add a new API to refresh AWS tokens in the batch handler\n\nThe new API can be used from `/upload/{batchId}/refreshToken`.\nIt will return new tokens when the batch handler can\nhandle the request, else it will throw an error."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNjgxODgx", "url": "https://github.com/nuxeo/nuxeo/pull/3969#pullrequestreview-400681881", "createdAt": "2020-04-27T07:14:39Z", "commit": {"oid": "1d16a2cb33bdf3a817283e4cce992a0751873104"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwODA2NDE4", "url": "https://github.com/nuxeo/nuxeo/pull/3969#pullrequestreview-400806418", "createdAt": "2020-04-27T10:04:45Z", "commit": {"oid": "1d16a2cb33bdf3a817283e4cce992a0751873104"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxODA4NDAz", "url": "https://github.com/nuxeo/nuxeo/pull/3969#pullrequestreview-401808403", "createdAt": "2020-04-28T12:59:39Z", "commit": {"oid": "1d16a2cb33bdf3a817283e4cce992a0751873104"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4782, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}