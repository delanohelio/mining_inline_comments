{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxMTE3MDM1", "number": 3799, "title": "fix-NXP-28702-abstract-json-enricher-fails-to-stop", "bodyText": "PR created from https://qa.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-nalkotob/138/", "createdAt": "2020-02-27T23:03:34Z", "url": "https://github.com/nuxeo/nuxeo/pull/3799", "merged": true, "mergeCommit": {"oid": "7546a9e011b483601eb661aa33dfab183ab34d85"}, "closed": true, "closedAt": "2020-03-05T14:48:28Z", "author": {"login": "nuxeojenkins"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIsqUDgFqTM2NjI2NzE2MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKslDOgFqTM2OTYyMzk0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MjY3MTYx", "url": "https://github.com/nuxeo/nuxeo/pull/3799#pullrequestreview-366267161", "createdAt": "2020-02-28T09:39:05Z", "commit": {"oid": "c0201024f5f44bfd943b8e81b2652de699bd0624"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwOTozOTowNVrOFvu2Cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwOTozOTowNVrOFvu2Cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU5NDg5MA==", "bodyText": "I'm wondering... what does log error tb produce? If it's what we currently see in the logs (see below), I don't think it's interesting as the output is truncated anyway.\n[TokenBuffer: START_OBJECT, FIELD_NAME(acls), START_ARRAY, START_OBJECT, FIELD_NAME(name), VALUE_STRING, FIELD_NAME(aces), START_ARRAY, START_OBJECT, FIELD_NAME(id), VALUE_STRING, FIELD_NAME(username), START_OBJECT, FIELD_NAME(entity-type), ...", "url": "https://github.com/nuxeo/nuxeo/pull/3799#discussion_r385594890", "createdAt": "2020-02-28T09:39:05Z", "author": {"login": "troger"}, "path": "nuxeo-core/nuxeo-core-io/src/main/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/AbstractJsonEnricher.java", "diffHunk": "@@ -66,19 +68,20 @@ public void write(Enriched<EntityType> enrichable, JsonGenerator jg) {\n             // Write to a temporary output in case of exception during write()\n             tb.writeStartObject();\n             write(tb, enrichable.getEntity());\n+            tb.writeEndObject();\n             tb.flush();\n             // Add the complete, well-formed content to the real output\n             try (JsonParser parser = tb.asParser()) {\n                 parser.nextToken(); // ignoring START_OBJECT\n-                while (parser.nextToken() == JsonToken.FIELD_NAME) {\n+                while (parser.nextToken() == FIELD_NAME) {\n                     jg.copyCurrentStructure(parser);\n                 }\n-                if (parser.currentToken() != null) {\n-                    log.error(\"Enricher {} returned invalid output {}\", name, tb.toString());\n+                if (parser.currentToken() != END_OBJECT) {\n+                    log.error(\"Enricher: {} failed on current token: {}, output: {}\", name, parser.currentToken(), tb);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0201024f5f44bfd943b8e81b2652de699bd0624"}, "originalPosition": 34}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c0201024f5f44bfd943b8e81b2652de699bd0624", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/c0201024f5f44bfd943b8e81b2652de699bd0624", "committedDate": "2020-02-27T18:02:40Z", "message": "NXP-28702: fix json AbstractJsonEnricher parsing"}, "afterCommit": {"oid": "776ac28ab4c0f8b9d012e7f9e5c7f56afe17c5e2", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/776ac28ab4c0f8b9d012e7f9e5c7f56afe17c5e2", "committedDate": "2020-02-28T09:59:54Z", "message": "NXP-28702: fix json AbstractJsonEnricher parsing"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "776ac28ab4c0f8b9d012e7f9e5c7f56afe17c5e2", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/776ac28ab4c0f8b9d012e7f9e5c7f56afe17c5e2", "committedDate": "2020-02-28T09:59:54Z", "message": "NXP-28702: fix json AbstractJsonEnricher parsing"}, "afterCommit": {"oid": "afa43cfd7def5c558bf8a4979e8acca513420618", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/afa43cfd7def5c558bf8a4979e8acca513420618", "committedDate": "2020-02-28T10:39:28Z", "message": "NXP-28702: fix json AbstractJsonEnricher parsing"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "afa43cfd7def5c558bf8a4979e8acca513420618", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/afa43cfd7def5c558bf8a4979e8acca513420618", "committedDate": "2020-02-28T10:39:28Z", "message": "NXP-28702: fix json AbstractJsonEnricher parsing"}, "afterCommit": {"oid": "a24c16fc02da6d2399f685b062a2739f6b50176a", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/a24c16fc02da6d2399f685b062a2739f6b50176a", "committedDate": "2020-02-28T14:39:19Z", "message": "NXP-28702: fix json AbstractJsonEnricher parsing"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a24c16fc02da6d2399f685b062a2739f6b50176a", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/a24c16fc02da6d2399f685b062a2739f6b50176a", "committedDate": "2020-02-28T14:39:19Z", "message": "NXP-28702: fix json AbstractJsonEnricher parsing"}, "afterCommit": {"oid": "9be547fd9b15fdeb7b56baa76713bd31a9ce1091", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/9be547fd9b15fdeb7b56baa76713bd31a9ce1091", "committedDate": "2020-03-02T06:51:14Z", "message": "NXP-28702: fix json AbstractJsonEnricher parsing"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9be547fd9b15fdeb7b56baa76713bd31a9ce1091", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/9be547fd9b15fdeb7b56baa76713bd31a9ce1091", "committedDate": "2020-03-02T06:51:14Z", "message": "NXP-28702: fix json AbstractJsonEnricher parsing"}, "afterCommit": {"oid": "173f4712f23f2272ff7b6a7ecadafeb3bc49e392", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/173f4712f23f2272ff7b6a7ecadafeb3bc49e392", "committedDate": "2020-03-04T14:08:56Z", "message": "NXP-28702: fix json AbstractJsonEnricher parsing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4ODA5NjAy", "url": "https://github.com/nuxeo/nuxeo/pull/3799#pullrequestreview-368809602", "createdAt": "2020-03-04T14:13:40Z", "commit": {"oid": "173f4712f23f2272ff7b6a7ecadafeb3bc49e392"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNDoxMzo0MFrOFxuyzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNDoxMzo0MFrOFxuyzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY5MTIxMw==", "bodyText": "Could you extract the Supplier as a protected method? You'll be able to call it as a lambda with (note this is optional):\n() -> this.safeReadBuffer(tb)\n\nI prefer a method here because it's more readable and have the same number of line than the supplier declaration.\nIMHO, one valid Supplier as variable case is when:\n\nsupplier doesn't use curly brackets\nthe lambda makes the code format ugly", "url": "https://github.com/nuxeo/nuxeo/pull/3799#discussion_r387691213", "createdAt": "2020-03-04T14:13:40Z", "author": {"login": "kevinleturc"}, "path": "nuxeo-core/nuxeo-core-io/src/main/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/AbstractJsonEnricher.java", "diffHunk": "@@ -66,24 +70,33 @@ public void write(Enriched<EntityType> enrichable, JsonGenerator jg) {\n             // Write to a temporary output in case of exception during write()\n             tb.writeStartObject();\n             write(tb, enrichable.getEntity());\n+            tb.writeEndObject();\n             tb.flush();\n             // Add the complete, well-formed content to the real output\n             try (JsonParser parser = tb.asParser()) {\n                 parser.nextToken(); // ignoring START_OBJECT\n-                while (parser.nextToken() == JsonToken.FIELD_NAME) {\n+                while (parser.nextToken() == FIELD_NAME) {\n                     jg.copyCurrentStructure(parser);\n                 }\n-                if (parser.currentToken() != null) {\n-                    log.error(\"Enricher {} returned invalid output {}\", name, tb.toString());\n+                Supplier<String> supplier = () -> {\n+                    try {\n+                        return MAPPER.readTree(tb.asParser());\n+                    } catch (IOException e) {\n+                        return \"malformed content could not be retrieved\";\n+                    }\n+                };\n+                if (parser.currentToken() != END_OBJECT) {\n+                    log.error(\"Enricher: {} failed on current token: {}, output to write: {}\", name::toString,\n+                            parser::currentToken, supplier::get);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "173f4712f23f2272ff7b6a7ecadafeb3bc49e392"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b99538a05bf1267f795ee491a573c3f0bae52220", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/b99538a05bf1267f795ee491a573c3f0bae52220", "committedDate": "2020-03-04T14:30:56Z", "message": "NXP-28702: fix json AbstractJsonEnricher parsing"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "173f4712f23f2272ff7b6a7ecadafeb3bc49e392", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/173f4712f23f2272ff7b6a7ecadafeb3bc49e392", "committedDate": "2020-03-04T14:08:56Z", "message": "NXP-28702: fix json AbstractJsonEnricher parsing"}, "afterCommit": {"oid": "b99538a05bf1267f795ee491a573c3f0bae52220", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/b99538a05bf1267f795ee491a573c3f0bae52220", "committedDate": "2020-03-04T14:30:56Z", "message": "NXP-28702: fix json AbstractJsonEnricher parsing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4ODI2MDYw", "url": "https://github.com/nuxeo/nuxeo/pull/3799#pullrequestreview-368826060", "createdAt": "2020-03-04T14:32:47Z", "commit": {"oid": "b99538a05bf1267f795ee491a573c3f0bae52220"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NjIzOTQx", "url": "https://github.com/nuxeo/nuxeo/pull/3799#pullrequestreview-369623941", "createdAt": "2020-03-05T14:41:37Z", "commit": {"oid": "b99538a05bf1267f795ee491a573c3f0bae52220"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4864, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}