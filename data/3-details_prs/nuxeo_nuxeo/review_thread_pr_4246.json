{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0NDc5MjMw", "number": 4246, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwOTowNDoyN1rOEWI3Kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwOTowNDoyN1rOEWI3Kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNjQ5MzIzOnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-automation/src/test/java/org/nuxeo/ecm/automation/elasticsearch/test/TestElasticsearchAutomationMultiRepo.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwOTowNDoyN1rOG9SWlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwOTowNDoyN1rOG9SWlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkxNzAxMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // nothing indexed because of disable indexing flag\n          \n          \n            \n                    // nothing indexed because of disabled indexing flag", "url": "https://github.com/nuxeo/nuxeo/pull/4246#discussion_r466917013", "createdAt": "2020-08-07T09:04:27Z", "author": {"login": "ataillefer"}, "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-automation/src/test/java/org/nuxeo/ecm/automation/elasticsearch/test/TestElasticsearchAutomationMultiRepo.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Benoit Delbosc\n+ *     Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+package org.nuxeo.ecm.automation.elasticsearch.test;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.automation.AutomationService;\n+import org.nuxeo.ecm.automation.OperationContext;\n+import org.nuxeo.ecm.automation.elasticsearch.ElasticsearchBulkIndexOperation;\n+import org.nuxeo.ecm.core.api.CoreInstance;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.elasticsearch.ElasticSearchConstants;\n+import org.nuxeo.elasticsearch.api.ElasticSearchAdmin;\n+import org.nuxeo.elasticsearch.api.ElasticSearchService;\n+import org.nuxeo.elasticsearch.query.NxQueryBuilder;\n+import org.nuxeo.elasticsearch.test.RepositoryLightElasticSearchFeature;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+import org.nuxeo.runtime.test.runner.TransactionalFeature;\n+\n+@RunWith(FeaturesRunner.class)\n+@Features(RepositoryLightElasticSearchFeature.class)\n+@Deploy(\"org.nuxeo.ecm.automation.core\")\n+@Deploy(\"org.nuxeo.elasticsearch.automation\")\n+@Deploy(\"org.nuxeo.ecm.automation.elasticsearch.test:test-second-repository-contrib.xml\")\n+public class TestElasticsearchAutomationMultiRepo {\n+\n+    @Inject\n+    protected TransactionalFeature txFeature;\n+\n+    @Inject\n+    protected CoreSession defaultSession;\n+\n+    protected CoreSession secondSession;\n+\n+    @Inject\n+    protected ElasticSearchService ess;\n+\n+    @Inject\n+    protected ElasticSearchAdmin esa;\n+\n+    @Inject\n+    protected AutomationService automationService;\n+\n+    @Before\n+    public void init() {\n+        secondSession = CoreInstance.getCoreSession(\"second\");\n+\n+        // reset index\n+        esa.initIndexes(true);\n+        createDocs(defaultSession);\n+        createDocs(secondSession);\n+    }\n+\n+    protected void createDocs(CoreSession session) {\n+        // create 2 docs without indexing them\n+        DocumentModel doc = session.createDocumentModel(\"/\", \"my-folder\", \"Folder\");\n+        doc.setPropertyValue(\"dc:title\", \"A folder\");\n+        doc.putContextData(ElasticSearchConstants.DISABLE_AUTO_INDEXING, Boolean.TRUE);\n+        doc = session.createDocument(doc);\n+\n+        doc = session.createDocumentModel(\"/my-folder/\", \"my-file\", \"File\");\n+        doc.setPropertyValue(\"dc:title\", \"A file\");\n+        doc.putContextData(ElasticSearchConstants.DISABLE_AUTO_INDEXING, Boolean.TRUE);\n+        session.createDocument(doc);\n+\n+        txFeature.nextTransaction();\n+\n+        // nothing indexed because of disable indexing flag", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47f00f94046f720a66a2c388286ac87fab44ee51"}, "originalPosition": 93}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4379, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}