{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEyODYzNjQz", "number": 3994, "title": "Fix nxp 29066 Init of the ACL document root occurs many times [forward port]", "bodyText": "Please review the 10.10 one #3995 before.\nT&P OK MongoDB: https://qa.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-saouana-2/11/\nT&P Ok Default: https://qa.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-saouana/239/", "createdAt": "2020-05-04T10:22:26Z", "url": "https://github.com/nuxeo/nuxeo/pull/3994", "merged": true, "mergeCommit": {"oid": "d6967afe20dbb638b64428448cdc112207dcaa84"}, "closed": true, "closedAt": "2020-05-05T17:27:03Z", "author": {"login": "RSalem07"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcd87v1gFqTQwNDg2ODI1MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABceV1tggFqTQwNTkwMzg5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0ODY4MjUx", "url": "https://github.com/nuxeo/nuxeo/pull/3994#pullrequestreview-404868251", "createdAt": "2020-05-04T10:27:24Z", "commit": {"oid": "92936f2cc04bcf98f1dfadd8b8a6309219f91a09"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxMDoyNzoyNFrOGP6oqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxMDoyOToxOVrOGP6sdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM0MjUwNA==", "bodyText": "Shouldn't it be the opposite? Start with false and if we found one to create set it to true?", "url": "https://github.com/nuxeo/nuxeo/pull/3994#discussion_r419342504", "createdAt": "2020-05-04T10:27:24Z", "author": {"login": "kevinleturc"}, "path": "modules/platform/nuxeo-platform-content-template-manager/src/main/java/org/nuxeo/ecm/platform/content/template/factories/SimpleTemplateBasedRootFactory.java", "diffHunk": "@@ -37,8 +37,10 @@\n     public void createContentStructure(DocumentModel eventDoc) {\n         initSession(eventDoc);\n \n+        boolean initRootAcl = true;\n         for (TemplateItemDescriptor item : template) {\n             if (!shouldCreateDocument(eventDoc.getId(), item.getId(), item.getTypeName())) {\n+                initRootAcl = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92936f2cc04bcf98f1dfadd8b8a6309219f91a09"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM0MzQ3Ng==", "bodyText": "Maybe something like below?\n            if (docState == null) {\n                if (log.isTraceEnabled()) {\n                    log.trace(\"Cannot fetch document with id: \" + id, new Throwable(\"debug stack trace\"));\n                }\n                return;\n            }", "url": "https://github.com/nuxeo/nuxeo/pull/3994#discussion_r419343476", "createdAt": "2020-05-04T10:29:19Z", "author": {"login": "kevinleturc"}, "path": "modules/core/nuxeo-core-storage-dbs/src/main/java/org/nuxeo/ecm/core/storage/dbs/DBSTransactionState.java", "diffHunk": "@@ -641,6 +641,10 @@ public void updateReadACLs(Collection<String> docIds) {\n      */\n     protected void updateDocumentReadAcls(String id) {\n         DBSDocumentState docState = getStateForUpdate(id);\n+        if(docState == null) {\n+            log.trace(\"No document state found for id: \" + id);\n+            return;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92936f2cc04bcf98f1dfadd8b8a6309219f91a09"}, "originalPosition": 7}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "92936f2cc04bcf98f1dfadd8b8a6309219f91a09", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/92936f2cc04bcf98f1dfadd8b8a6309219f91a09", "committedDate": "2020-05-04T10:10:54Z", "message": " NXP-29048: Init only once the root template acl"}, "afterCommit": {"oid": "2e7be2a4eb08fa77760b001faebf06fc2ff356a1", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/2e7be2a4eb08fa77760b001faebf06fc2ff356a1", "committedDate": "2020-05-04T10:37:20Z", "message": " NXP-29048: Init only once the root template acl"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2e7be2a4eb08fa77760b001faebf06fc2ff356a1", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/2e7be2a4eb08fa77760b001faebf06fc2ff356a1", "committedDate": "2020-05-04T10:37:20Z", "message": " NXP-29048: Init only once the root template acl"}, "afterCommit": {"oid": "77b5c119cc5c06c30b709e842a58b7394d102b4a", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/77b5c119cc5c06c30b709e842a58b7394d102b4a", "committedDate": "2020-05-04T14:02:22Z", "message": " NXP-29048: Init only once the root template acl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f24a026617c4533a5e1657e7394b780eaf08968", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/4f24a026617c4533a5e1657e7394b780eaf08968", "committedDate": "2020-05-05T11:39:17Z", "message": "NXP-29066: Init only once the root template acl"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "77b5c119cc5c06c30b709e842a58b7394d102b4a", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/77b5c119cc5c06c30b709e842a58b7394d102b4a", "committedDate": "2020-05-04T14:02:22Z", "message": " NXP-29048: Init only once the root template acl"}, "afterCommit": {"oid": "4f24a026617c4533a5e1657e7394b780eaf08968", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/4f24a026617c4533a5e1657e7394b780eaf08968", "committedDate": "2020-05-05T11:39:17Z", "message": "NXP-29066: Init only once the root template acl"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1ODcxNzE4", "url": "https://github.com/nuxeo/nuxeo/pull/3994#pullrequestreview-405871718", "createdAt": "2020-05-05T14:55:56Z", "commit": {"oid": "4f24a026617c4533a5e1657e7394b780eaf08968"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1OTAzODk1", "url": "https://github.com/nuxeo/nuxeo/pull/3994#pullrequestreview-405903895", "createdAt": "2020-05-05T15:30:29Z", "commit": {"oid": "4f24a026617c4533a5e1657e7394b780eaf08968"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4791, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}