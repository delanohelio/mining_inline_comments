{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5MjY5NTY0", "number": 4358, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNjo0OTozOVrOErROVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNjo1MDoxM1rOErRPdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzODA2NDIzOnYy", "diffSide": "RIGHT", "path": "modules/platform/login/nuxeo-platform-login-keycloak/src/main/java/org/nuxeo/ecm/platform/ui/web/keycloak/KeycloakAuthenticationPlugin.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNjo0OTozOVrOHd8jEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNjo0OTozOVrOHd8jEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE2Mjc3MQ==", "bodyText": "The 10.10 commit has an added empty line after this }, please make sure your commits are not different without a reason.", "url": "https://github.com/nuxeo/nuxeo/pull/4358#discussion_r501162771", "createdAt": "2020-10-07T16:49:39Z", "author": {"login": "efge"}, "path": "modules/platform/login/nuxeo-platform-login-keycloak/src/main/java/org/nuxeo/ecm/platform/ui/web/keycloak/KeycloakAuthenticationPlugin.java", "diffHunk": "@@ -177,9 +177,10 @@ private KeycloakUserInfo getKeycloakUserInfo(AccessToken token) {\n      */\n     private Set<String> getRoles(AccessToken token, String keycloakNuxeoApp) {\n         Set<String> allRoles = new HashSet<>();\n-        Set<String> roles = token.getRealmAccess().getRoles();\n-        if (roles != null) {\n-            allRoles.addAll(roles);\n+\n+        AccessToken.Access realmAccess = token.getRealmAccess();\n+        if (realmAccess != null && realmAccess.getRoles() != null) {\n+            allRoles.addAll(realmAccess.getRoles());\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca27d035c96074ba2f6091b63eeea8ac390f6383"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzODA2NzEwOnYy", "diffSide": "RIGHT", "path": "modules/platform/login/nuxeo-platform-login-keycloak/src/test/java/org/nuxeo/ecm/platform/ui/web/keycloak/TestKeycloakAuthenticationPlugin.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNjo1MDoxM1rOHd8ksw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNjo1MDoxM1rOHd8ksw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE2MzE4Nw==", "bodyText": "The 10.10 commit has a different indent for this line.", "url": "https://github.com/nuxeo/nuxeo/pull/4358#discussion_r501163187", "createdAt": "2020-10-07T16:50:13Z", "author": {"login": "efge"}, "path": "modules/platform/login/nuxeo-platform-login-keycloak/src/test/java/org/nuxeo/ecm/platform/ui/web/keycloak/TestKeycloakAuthenticationPlugin.java", "diffHunk": "@@ -190,4 +190,31 @@ private KeycloakAuthenticationPlugin initPlugin(KeycloakAuthenticationPlugin key\n         return keycloakAuthenticationPlugin;\n     }\n \n+    @Test\n+    public void testKeycloakBearerAuthenticationSucceedingWithNullRealmAcess() throws Exception {\n+        KeycloakAuthenticationPlugin keycloakAuthenticationPlugin = new KeycloakAuthenticationPlugin();\n+        initPlugin(keycloakAuthenticationPlugin);\n+\n+        AccessToken accessToken = new AccessToken();\n+        accessToken.setEmail(\"username@example.com\");\n+        AccessToken.Access realmAccess = new AccessToken.Access();\n+        realmAccess.addRole(\"user\");\n+        accessToken.setRealmAccess(null);\n+        Mockito.when(requestMock.getAttribute(KEYCLOAK_ACCESS_TOKEN)).thenReturn(accessToken);\n+        Mockito.when(authenticatorMock.authenticate()).thenReturn(AuthOutcome.AUTHENTICATED);\n+\n+        Mockito.when(providerMock.provide(any(HttpServletRequest.class), any(HttpServletResponse.class)))\n+               .thenReturn(authenticatorMock);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca27d035c96074ba2f6091b63eeea8ac390f6383"}, "originalPosition": 18}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4325, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}