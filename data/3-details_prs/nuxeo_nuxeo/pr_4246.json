{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0NDc5MjMw", "number": 4246, "title": "Fix NXP-29503 bulk index multi repo", "bodyText": "", "createdAt": "2020-08-07T08:48:11Z", "url": "https://github.com/nuxeo/nuxeo/pull/4246", "merged": true, "mergeCommit": {"oid": "db7b60bc6313a7eedcbcf605c89dd24fee424ed0"}, "closed": true, "closedAt": "2020-08-10T07:28:36Z", "author": {"login": "kevinleturc"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8gYI6AH2gAyNDY0NDc5MjMwOjZhNjY5MDhkNDUyMzNiMWMxMjU3ZGRkYmYwNDZhZjRhMTI0MTU2Y2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8lGWtAFqTQ2MzM0NzgzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6a66908d45233b1c1257dddbf046af4a124156ce", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/6a66908d45233b1c1257dddbf046af4a124156ce", "committedDate": "2020-08-07T08:44:52Z", "message": "NXP-29503: Cleanup / Format"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8731e9af22c6c8dc5083d2b682b3e8c46db4e74d", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/8731e9af22c6c8dc5083d2b682b3e8c46db4e74d", "committedDate": "2020-08-07T08:46:14Z", "message": "NXP-29503: Fix bulk index on multi repository"}, "afterCommit": {"oid": "47f00f94046f720a66a2c388286ac87fab44ee51", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/47f00f94046f720a66a2c388286ac87fab44ee51", "committedDate": "2020-08-07T08:59:21Z", "message": "NXP-29503: Fix bulk index on multi repository"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "47f00f94046f720a66a2c388286ac87fab44ee51", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/47f00f94046f720a66a2c388286ac87fab44ee51", "committedDate": "2020-08-07T08:59:21Z", "message": "NXP-29503: Fix bulk index on multi repository"}, "afterCommit": {"oid": "e2ea7485020ddfe15e52918902a033db33e4f395", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/e2ea7485020ddfe15e52918902a033db33e4f395", "committedDate": "2020-08-07T09:04:34Z", "message": "NXP-29503: Fix bulk index on multi repository"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e2ea7485020ddfe15e52918902a033db33e4f395", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/e2ea7485020ddfe15e52918902a033db33e4f395", "committedDate": "2020-08-07T09:04:34Z", "message": "NXP-29503: Fix bulk index on multi repository"}, "afterCommit": {"oid": "58c78f2846d9fa251f7d71f493479dc39fef4929", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/58c78f2846d9fa251f7d71f493479dc39fef4929", "committedDate": "2020-08-07T09:24:35Z", "message": "NXP-29503: Fix bulk index on multi repository"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMTUzNzY3", "url": "https://github.com/nuxeo/nuxeo/pull/4246#pullrequestreview-463153767", "createdAt": "2020-08-07T09:04:27Z", "commit": {"oid": "47f00f94046f720a66a2c388286ac87fab44ee51"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwOTowNDoyN1rOG9SWlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwOTowNDoyN1rOG9SWlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkxNzAxMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // nothing indexed because of disable indexing flag\n          \n          \n            \n                    // nothing indexed because of disabled indexing flag", "url": "https://github.com/nuxeo/nuxeo/pull/4246#discussion_r466917013", "createdAt": "2020-08-07T09:04:27Z", "author": {"login": "ataillefer"}, "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-automation/src/test/java/org/nuxeo/ecm/automation/elasticsearch/test/TestElasticsearchAutomationMultiRepo.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Benoit Delbosc\n+ *     Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+package org.nuxeo.ecm.automation.elasticsearch.test;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.automation.AutomationService;\n+import org.nuxeo.ecm.automation.OperationContext;\n+import org.nuxeo.ecm.automation.elasticsearch.ElasticsearchBulkIndexOperation;\n+import org.nuxeo.ecm.core.api.CoreInstance;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.elasticsearch.ElasticSearchConstants;\n+import org.nuxeo.elasticsearch.api.ElasticSearchAdmin;\n+import org.nuxeo.elasticsearch.api.ElasticSearchService;\n+import org.nuxeo.elasticsearch.query.NxQueryBuilder;\n+import org.nuxeo.elasticsearch.test.RepositoryLightElasticSearchFeature;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+import org.nuxeo.runtime.test.runner.TransactionalFeature;\n+\n+@RunWith(FeaturesRunner.class)\n+@Features(RepositoryLightElasticSearchFeature.class)\n+@Deploy(\"org.nuxeo.ecm.automation.core\")\n+@Deploy(\"org.nuxeo.elasticsearch.automation\")\n+@Deploy(\"org.nuxeo.ecm.automation.elasticsearch.test:test-second-repository-contrib.xml\")\n+public class TestElasticsearchAutomationMultiRepo {\n+\n+    @Inject\n+    protected TransactionalFeature txFeature;\n+\n+    @Inject\n+    protected CoreSession defaultSession;\n+\n+    protected CoreSession secondSession;\n+\n+    @Inject\n+    protected ElasticSearchService ess;\n+\n+    @Inject\n+    protected ElasticSearchAdmin esa;\n+\n+    @Inject\n+    protected AutomationService automationService;\n+\n+    @Before\n+    public void init() {\n+        secondSession = CoreInstance.getCoreSession(\"second\");\n+\n+        // reset index\n+        esa.initIndexes(true);\n+        createDocs(defaultSession);\n+        createDocs(secondSession);\n+    }\n+\n+    protected void createDocs(CoreSession session) {\n+        // create 2 docs without indexing them\n+        DocumentModel doc = session.createDocumentModel(\"/\", \"my-folder\", \"Folder\");\n+        doc.setPropertyValue(\"dc:title\", \"A folder\");\n+        doc.putContextData(ElasticSearchConstants.DISABLE_AUTO_INDEXING, Boolean.TRUE);\n+        doc = session.createDocument(doc);\n+\n+        doc = session.createDocumentModel(\"/my-folder/\", \"my-file\", \"File\");\n+        doc.setPropertyValue(\"dc:title\", \"A file\");\n+        doc.putContextData(ElasticSearchConstants.DISABLE_AUTO_INDEXING, Boolean.TRUE);\n+        session.createDocument(doc);\n+\n+        txFeature.nextTransaction();\n+\n+        // nothing indexed because of disable indexing flag", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47f00f94046f720a66a2c388286ac87fab44ee51"}, "originalPosition": 93}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "58c78f2846d9fa251f7d71f493479dc39fef4929", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/58c78f2846d9fa251f7d71f493479dc39fef4929", "committedDate": "2020-08-07T09:24:35Z", "message": "NXP-29503: Fix bulk index on multi repository"}, "afterCommit": {"oid": "7bf8b426277248b41d201ec729cbdb4b9681d535", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/7bf8b426277248b41d201ec729cbdb4b9681d535", "committedDate": "2020-08-07T09:56:59Z", "message": "NXP-29503: Fix bulk index on multi repository"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f90d749f67be74f4b9944be5da33f245aab9987e", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/f90d749f67be74f4b9944be5da33f245aab9987e", "committedDate": "2020-08-07T10:04:10Z", "message": "NXP-29503: Fix bulk index on multi repository"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7bf8b426277248b41d201ec729cbdb4b9681d535", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/7bf8b426277248b41d201ec729cbdb4b9681d535", "committedDate": "2020-08-07T09:56:59Z", "message": "NXP-29503: Fix bulk index on multi repository"}, "afterCommit": {"oid": "f90d749f67be74f4b9944be5da33f245aab9987e", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/f90d749f67be74f4b9944be5da33f245aab9987e", "committedDate": "2020-08-07T10:04:10Z", "message": "NXP-29503: Fix bulk index on multi repository"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMTk5MTU3", "url": "https://github.com/nuxeo/nuxeo/pull/4246#pullrequestreview-463199157", "createdAt": "2020-08-07T10:16:07Z", "commit": {"oid": "f90d749f67be74f4b9944be5da33f245aab9987e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMzQ3ODMw", "url": "https://github.com/nuxeo/nuxeo/pull/4246#pullrequestreview-463347830", "createdAt": "2020-08-07T14:14:58Z", "commit": {"oid": "f90d749f67be74f4b9944be5da33f245aab9987e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4995, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}