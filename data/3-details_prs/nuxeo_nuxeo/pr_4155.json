{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0NzM3NDUy", "number": 4155, "title": "fix-NXP-29171-task-update-with-group-assignees", "bodyText": "PR created from https://qa.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-kleturc/720/", "createdAt": "2020-06-15T19:39:27Z", "url": "https://github.com/nuxeo/nuxeo/pull/4155", "merged": true, "mergeCommit": {"oid": "99a447b318d09d358ae7e864c4767858ad05e59a"}, "closed": true, "closedAt": "2020-06-23T15:45:20Z", "author": {"login": "nuxeojenkins"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcrxYIgABqjM0NDc5NTQwNjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuE1V8gFqTQzNTc0MjUzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "91b13e68881ab76bb32158322acc02c4a8f127d2", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/91b13e68881ab76bb32158322acc02c4a8f127d2", "committedDate": "2020-06-15T13:47:46Z", "message": "NXP-29171: Fix fetched properties unmarshalling"}, "afterCommit": {"oid": "398fa04bf3558f1d6f81d7919e116def1b4a28f5", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/398fa04bf3558f1d6f81d7919e116def1b4a28f5", "committedDate": "2020-06-16T08:56:20Z", "message": "NXP-29171: Fix fetched properties unmarshalling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNTYzOTky", "url": "https://github.com/nuxeo/nuxeo/pull/4155#pullrequestreview-432563992", "createdAt": "2020-06-17T16:19:13Z", "commit": {"oid": "398fa04bf3558f1d6f81d7919e116def1b4a28f5"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNjoxOToxM1rOGlNRoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNjoxOToxM1rOGlNRoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY2ODAwMA==", "bodyText": "Can we use e::getMessage instead?", "url": "https://github.com/nuxeo/nuxeo/pull/4155#discussion_r441668000", "createdAt": "2020-06-17T16:19:13Z", "author": {"login": "efge"}, "path": "modules/core/nuxeo-core-io/src/main/java/org/nuxeo/ecm/core/io/marshallers/json/document/DocumentPropertiesJsonReader.java", "diffHunk": "@@ -199,14 +205,17 @@ private Object getScalarPropertyValue(Property property, JsonNode jn, Type type)\n                         return blob.getString();\n                     }\n                 }\n-                log.info(\"Unable to parse the property {}\", property::getXPath);\n-                return null;\n+                throw new MarshallingException(\"Unable to parse the property \" +  property.getXPath());\n             }\n             Object object = null;\n             for (Class<?> clazz : resolver.getManagedClasses()) {\n-                object = readEntity(clazz, clazz, jn);\n-                if (object != null) {\n-                    break;\n+                try {\n+                    object = readEntity(clazz, clazz, jn);\n+                    if (object != null) {\n+                        break;\n+                    }\n+                } catch (Exception e) {\n+                    log.info(\"Unable to read the entity - {}\", e.getMessage(), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "398fa04bf3558f1d6f81d7919e116def1b4a28f5"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNjEyOTY1", "url": "https://github.com/nuxeo/nuxeo/pull/4155#pullrequestreview-432612965", "createdAt": "2020-06-17T17:19:22Z", "commit": {"oid": "398fa04bf3558f1d6f81d7919e116def1b4a28f5"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNzoxOToyMlrOGlPfZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNzoyNTo1OVrOGlPukA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcwNDI5NQ==", "bodyText": "Shouldn't we want to handle InterruptedException and so on here? @efge?\nBut what about just catching IOException in fact?", "url": "https://github.com/nuxeo/nuxeo/pull/4155#discussion_r441704295", "createdAt": "2020-06-17T17:19:22Z", "author": {"login": "troger"}, "path": "modules/core/nuxeo-core-io/src/main/java/org/nuxeo/ecm/core/io/marshallers/json/document/DocumentPropertiesJsonReader.java", "diffHunk": "@@ -200,14 +205,17 @@ private Object getScalarPropertyValue(Property property, JsonNode jn, Type type)\n                         return blob.getString();\n                     }\n                 }\n-                log.info(\"Unable to parse the property {}\", property::getXPath);\n-                return null;\n+                throw new MarshallingException(\"Unable to parse the property \" +  property.getXPath());\n             }\n             Object object = null;\n             for (Class<?> clazz : resolver.getManagedClasses()) {\n-                object = readEntity(clazz, clazz, jn);\n-                if (object != null) {\n-                    break;\n+                try {\n+                    object = readEntity(clazz, clazz, jn);\n+                    if (object != null) {\n+                        break;\n+                    }\n+                } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "398fa04bf3558f1d6f81d7919e116def1b4a28f5"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcwNDUyNA==", "bodyText": "@since.", "url": "https://github.com/nuxeo/nuxeo/pull/4155#discussion_r441704524", "createdAt": "2020-06-17T17:19:46Z", "author": {"login": "troger"}, "path": "modules/core/nuxeo-core-io/src/main/java/org/nuxeo/ecm/core/io/marshallers/json/document/DocumentPropertiesJsonReader.java", "diffHunk": "@@ -93,6 +92,8 @@\n \n     public static final String DEFAULT_SCHEMA_NAME = \"DEFAULT_SCHEMA_NAME\";\n \n+    public static final String FALLBACK_RESOLVER = \"resolver.\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "398fa04bf3558f1d6f81d7919e116def1b4a28f5"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcwNTc0NQ==", "bodyText": "Is this needed?", "url": "https://github.com/nuxeo/nuxeo/pull/4155#discussion_r441705745", "createdAt": "2020-06-17T17:21:56Z", "author": {"login": "troger"}, "path": "modules/platform/nuxeo-platform-directory/nuxeo-platform-directory-types-contrib/src/main/resources/directoryschema/xvocabulary.xsd", "diffHunk": "@@ -3,6 +3,7 @@\n <xs:schema\n     targetNamespace=\"http://www.nuxeo.org/ecm/schemas/xvocabulary\"\n     xmlns:xs=\"http://www.w3.org/2001/XMLSchema\"\n+    xmlns:ref=\"http://www.nuxeo.org/ecm/schemas/core/external-references/\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "398fa04bf3558f1d6f81d7919e116def1b4a28f5"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcwODE3Ng==", "bodyText": "Is there any check we can add to validate that the assignees is administrators?", "url": "https://github.com/nuxeo/nuxeo/pull/4155#discussion_r441708176", "createdAt": "2020-06-17T17:25:59Z", "author": {"login": "troger"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-rest-api/src/test/java/org/nuxeo/ecm/restapi/server/WorkflowEndpointTest.java", "diffHunk": "@@ -1396,6 +1404,45 @@ public void testRejectTaskInSubWorkflow() throws IOException {\n \n     }\n \n+    /*\n+     * NXP-29171\n+     */\n+    @Test\n+    @Deploy(\"org.nuxeo.ecm.platform.restapi.server.routing.test:test-specific-task-request-unmarshalling.xml\")\n+    public void testSpecificTaskRequestWithFetchedGroup() throws IOException {\n+        DocumentModel note = RestServerInit.getNote(0, session);\n+\n+        // create workflow as Administrator\n+        String workflowInstanceId;\n+        try (CloseableClientResponse response = getResponse(RequestType.POST, \"/workflow\",\n+                getCreateAndStartWorkflowBodyContent(\"confirm\", singletonList(note.getId())))) {\n+            assertEquals(Response.Status.CREATED.getStatusCode(), response.getStatus());\n+\n+            JsonNode node = mapper.readTree(response.getEntityInputStream());\n+            workflowInstanceId = node.get(\"id\").textValue();\n+        }\n+\n+        // get tasks for child WF\n+        String taskId;\n+        try (CloseableClientResponse response = getResponse(RequestType.GET,\n+                \"/id/\" + note.getId() + \"/@\" + WorkflowAdapter.NAME + \"/\" + workflowInstanceId + \"/task\")) {\n+            JsonNode node = mapper.readTree(response.getEntityInputStream());\n+            assertEquals(1, node.get(\"entries\").size());\n+            taskId = node.get(\"entries\").get(0).get(\"id\").textValue();\n+        }\n+\n+        NuxeoGroup group = userManager.getGroup(\"administrators\");\n+\n+        String groupJson = MarshallerHelper.objectToJson(group, RenderingContext.CtxBuilder.get());\n+        String body = String.format(\"{\\\"entity-type\\\":\\\"task\\\", \\\"id\\\":\\\"%s\\\", \\\"variables\\\":{\\\"assignees\\\":[%s]}}\",\n+                taskId, groupJson);\n+        // assign it with a fetched entity\n+        try (CloseableClientResponse response = getResponse(RequestType.PUT, \"/task/\" + taskId + \"/confirm\", body)) {\n+            assertEquals(Response.Status.OK.getStatusCode(), response.getStatus());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "398fa04bf3558f1d6f81d7919e116def1b4a28f5"}, "originalPosition": 128}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "398fa04bf3558f1d6f81d7919e116def1b4a28f5", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/398fa04bf3558f1d6f81d7919e116def1b4a28f5", "committedDate": "2020-06-16T08:56:20Z", "message": "NXP-29171: Fix fetched properties unmarshalling"}, "afterCommit": {"oid": "edc03b0aa7c6bcca6f532b0f07baf11d29bd1b09", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/edc03b0aa7c6bcca6f532b0f07baf11d29bd1b09", "committedDate": "2020-06-19T13:40:01Z", "message": "NXP-29171: Fix fetched properties unmarshalling"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "edc03b0aa7c6bcca6f532b0f07baf11d29bd1b09", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/edc03b0aa7c6bcca6f532b0f07baf11d29bd1b09", "committedDate": "2020-06-19T13:40:01Z", "message": "NXP-29171: Fix fetched properties unmarshalling"}, "afterCommit": {"oid": "511b80a6276d800ccfaba516af29989b1ea25035", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/511b80a6276d800ccfaba516af29989b1ea25035", "committedDate": "2020-06-22T09:32:57Z", "message": "NXP-29171: Fix fetched properties unmarshalling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0NzU5NTY1", "url": "https://github.com/nuxeo/nuxeo/pull/4155#pullrequestreview-434759565", "createdAt": "2020-06-22T09:35:22Z", "commit": {"oid": "511b80a6276d800ccfaba516af29989b1ea25035"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0NzU4MTk4", "url": "https://github.com/nuxeo/nuxeo/pull/4155#pullrequestreview-434758198", "createdAt": "2020-06-22T09:33:35Z", "commit": {"oid": "edc03b0aa7c6bcca6f532b0f07baf11d29bd1b09"}, "state": "DISMISSED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwOTozNDowOVrOGm5GCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwOTozNDo0MlrOGm5HTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQzNDUwNA==", "bodyText": "Format commit?", "url": "https://github.com/nuxeo/nuxeo/pull/4155#discussion_r443434504", "createdAt": "2020-06-22T09:34:09Z", "author": {"login": "ataillefer"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-rest-api/src/test/java/org/nuxeo/ecm/restapi/server/WorkflowEndpointTest.java", "diffHunk": "@@ -425,7 +432,7 @@ public void testTerminateTaskPermissions()  throws IOException {\n         try (CloseableClientResponse response = getResponse(RequestType.GET, \"/id/\" + note.getId(), headers)) {\n             JsonNode node = mapper.readTree(response.getEntityInputStream());\n             ArrayNode runnableWorkflowModels = (ArrayNode) node.get(RestConstants.CONTRIBUTOR_CTX_PARAMETERS)\n-                    .get(RunnableWorkflowJsonEnricher.NAME);\n+                                                               .get(RunnableWorkflowJsonEnricher.NAME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "511b80a6276d800ccfaba516af29989b1ea25035"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQzNDYwOA==", "bodyText": "Format commit?", "url": "https://github.com/nuxeo/nuxeo/pull/4155#discussion_r443434608", "createdAt": "2020-06-22T09:34:20Z", "author": {"login": "ataillefer"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-rest-api/src/test/java/org/nuxeo/ecm/restapi/server/WorkflowEndpointTest.java", "diffHunk": "@@ -1099,8 +1106,8 @@ public void testWorkflowCleanUp() throws Exception {\n      */\n     @Test\n     public void testWorkflowCleanUpDisabling() throws Exception {\n-        Framework.getProperties().put(DocumentRoutingWorkflowInstancesCleanup.CLEANUP_WORKFLOW_INSTANCES_PROPERTY,\n-                \"true\");\n+        Framework.getProperties()\n+                 .put(DocumentRoutingWorkflowInstancesCleanup.CLEANUP_WORKFLOW_INSTANCES_PROPERTY, \"true\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "511b80a6276d800ccfaba516af29989b1ea25035"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQzNDgzMQ==", "bodyText": "Format commit?", "url": "https://github.com/nuxeo/nuxeo/pull/4155#discussion_r443434831", "createdAt": "2020-06-22T09:34:42Z", "author": {"login": "ataillefer"}, "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-rest-api/src/test/java/org/nuxeo/ecm/restapi/server/WorkflowEndpointTest.java", "diffHunk": "@@ -1151,9 +1158,10 @@ public void testTaskWithoutWorkflowInstance() throws IOException {\n         DocumentModel note = RestServerInit.getNote(0, session);\n \n         // Create a task not related to a workflow instance\n-        List<Task> tasks = Framework.getService(TaskService.class).createTask(session,\n-                session.getPrincipal(), note, \"testNoWorkflowTask\",\n-                singletonList(\"user:Administrator\"), false, null, null, null, Collections.emptyMap(), null);\n+        List<Task> tasks = Framework.getService(TaskService.class)\n+                                    .createTask(session, session.getPrincipal(), note, \"testNoWorkflowTask\",\n+                                            singletonList(\"user:Administrator\"), false, null, null, null,\n+                                            Collections.emptyMap(), null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "511b80a6276d800ccfaba516af29989b1ea25035"}, "originalPosition": 86}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cee7520c97bae61cc312c3cdab46251268d5b83f", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/cee7520c97bae61cc312c3cdab46251268d5b83f", "committedDate": "2020-06-23T12:26:18Z", "message": "NXP-29171: Cleanup / Format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0a26c05f733a440d8af898ed9cadbeede2efaf0", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/a0a26c05f733a440d8af898ed9cadbeede2efaf0", "committedDate": "2020-06-23T12:26:24Z", "message": "NXP-29171: Fix fetched properties unmarshalling"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "511b80a6276d800ccfaba516af29989b1ea25035", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/511b80a6276d800ccfaba516af29989b1ea25035", "committedDate": "2020-06-22T09:32:57Z", "message": "NXP-29171: Fix fetched properties unmarshalling"}, "afterCommit": {"oid": "a0a26c05f733a440d8af898ed9cadbeede2efaf0", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/a0a26c05f733a440d8af898ed9cadbeede2efaf0", "committedDate": "2020-06-23T12:26:24Z", "message": "NXP-29171: Fix fetched properties unmarshalling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NzMzNTc3", "url": "https://github.com/nuxeo/nuxeo/pull/4155#pullrequestreview-435733577", "createdAt": "2020-06-23T12:33:00Z", "commit": {"oid": "a0a26c05f733a440d8af898ed9cadbeede2efaf0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NzQyNTMw", "url": "https://github.com/nuxeo/nuxeo/pull/4155#pullrequestreview-435742530", "createdAt": "2020-06-23T12:44:29Z", "commit": {"oid": "a0a26c05f733a440d8af898ed9cadbeede2efaf0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4708, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}