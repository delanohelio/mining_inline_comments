{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxNzI5MjMx", "number": 3849, "title": "10.10-HF/fix-NXP-28784-Record-management-Missing-abels-in-the-audit-for-retention-events", "bodyText": "PR created from https://qa2.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-saouana-10.10/107/\nT&P on MongoDB [OK]: https://qa2.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-saouana-10.10/110/\nNew T&P (H2) [OK]: https://qa2.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-saouana-10.10-2/1/\nNew T&P after the review:\nhttps://qa2.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-saouana-10.10-2/", "createdAt": "2020-03-20T20:33:40Z", "url": "https://github.com/nuxeo/nuxeo/pull/3849", "merged": true, "mergeCommit": {"oid": "57bc0784957935b780e779330b575df46c231a31"}, "closed": true, "closedAt": "2020-03-27T17:02:47Z", "author": {"login": "nuxeojenkins"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQaUDFABqjMxNTQxODk0MjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRvXcCAFqTM4Mjc5MTU1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5a1705c76f10d8452f790d315039ecc0bba8c75f", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/5a1705c76f10d8452f790d315039ecc0bba8c75f", "committedDate": "2020-03-20T16:47:21Z", "message": "NXP-28784: Record management - Missing labels in the audit for retention events"}, "afterCommit": {"oid": "ffbf3ae013f98f23704c607b138569a1cd979a9f", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/ffbf3ae013f98f23704c607b138569a1cd979a9f", "committedDate": "2020-03-23T08:48:01Z", "message": "NXP-28784: Record management - Missing labels in the audit for retention events"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NTA3NTQ0", "url": "https://github.com/nuxeo/nuxeo/pull/3849#pullrequestreview-379507544", "createdAt": "2020-03-23T14:54:23Z", "commit": {"oid": "ffbf3ae013f98f23704c607b138569a1cd979a9f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNDo1NDoyNFrOF6JJvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNDo1NDoyNFrOF6JJvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUxMTY3OA==", "bodyText": "Since this will appear on client side, my only concern is the date format that may not match what is expected by the user.\nAlso, for the UI this is just a string to be rendered, no further logic since no further information is provided (e.g. type or format).", "url": "https://github.com/nuxeo/nuxeo/pull/3849#discussion_r396511678", "createdAt": "2020-03-23T14:54:24Z", "author": {"login": "nmpcunha"}, "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/api/AbstractSession.java", "diffHunk": "@@ -2087,18 +2087,17 @@ public void setRetainUntil(DocumentRef docRef, Calendar retainUntil, String comm\n         checkPermission(doc, SET_RETENTION);\n         Map<String, Serializable> options = new HashMap<>();\n         options.put(CoreEventConstants.RETAIN_UNTIL, retainUntil);\n-        String commentStart = retainUntil == null ? null : retainUntil.toInstant().toString();\n-        if (comment == null) {\n-            comment = commentStart;\n-        } else if (commentStart != null) {\n-            comment = commentStart + \" \" + comment;\n-        }\n-        options.put(\"comment\", comment);\n+        options.put(\"comment\", retainUntil == null ? \"\" : retainUntil.toInstant().toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffbf3ae013f98f23704c607b138569a1cd979a9f"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NTM1Njgw", "url": "https://github.com/nuxeo/nuxeo/pull/3849#pullrequestreview-379535680", "createdAt": "2020-03-23T15:23:06Z", "commit": {"oid": "ffbf3ae013f98f23704c607b138569a1cd979a9f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNToyMzowNlrOF6KfDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNToyMzowNlrOF6KfDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUzMzUxOA==", "bodyText": "Cool, this should solve the bug reported on https://jira.nuxeo.com/browse/NXP-28786", "url": "https://github.com/nuxeo/nuxeo/pull/3849#discussion_r396533518", "createdAt": "2020-03-23T15:23:06Z", "author": {"login": "nmpcunha"}, "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/api/AbstractSession.java", "diffHunk": "@@ -2087,18 +2087,17 @@ public void setRetainUntil(DocumentRef docRef, Calendar retainUntil, String comm\n         checkPermission(doc, SET_RETENTION);\n         Map<String, Serializable> options = new HashMap<>();\n         options.put(CoreEventConstants.RETAIN_UNTIL, retainUntil);\n-        String commentStart = retainUntil == null ? null : retainUntil.toInstant().toString();\n-        if (comment == null) {\n-            comment = commentStart;\n-        } else if (commentStart != null) {\n-            comment = commentStart + \" \" + comment;\n-        }\n-        options.put(\"comment\", comment);\n+        options.put(\"comment\", retainUntil == null ? \"\" : retainUntil.toInstant().toString());\n         DocumentModel docModel = readModel(doc);\n-        notifyEvent(DocumentEventTypes.BEFORE_SET_RETENTION, docModel, options, null, null, true, false);\n+        boolean currentIndeterminate = current == null || RETAIN_UNTIL_INDETERMINATE.compareTo(current) == 0;\n+        String beforeRetentionEvent = currentIndeterminate ? DocumentEventTypes.BEFORE_SET_RETENTION\n+                : DocumentEventTypes.BEFORE_EXTEND_RETENTION;\n+        notifyEvent(beforeRetentionEvent, docModel, options, null, null, true, false);\n         doc.setRetainUntil(retainUntil);\n         docModel = readModel(doc);\n-        notifyEvent(DocumentEventTypes.AFTER_SET_RETENTION, docModel, options, null, null, true, false);\n+        String afterRetentionEvent = currentIndeterminate ? DocumentEventTypes.AFTER_SET_RETENTION", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffbf3ae013f98f23704c607b138569a1cd979a9f"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NTM3NDEy", "url": "https://github.com/nuxeo/nuxeo/pull/3849#pullrequestreview-379537412", "createdAt": "2020-03-23T15:24:43Z", "commit": {"oid": "ffbf3ae013f98f23704c607b138569a1cd979a9f"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NjgxMTI4", "url": "https://github.com/nuxeo/nuxeo/pull/3849#pullrequestreview-379681128", "createdAt": "2020-03-23T17:55:37Z", "commit": {"oid": "ffbf3ae013f98f23704c607b138569a1cd979a9f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNzo1NTozN1rOF6RUCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxODowMDoxNFrOF6Rgqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY0NTM4NQ==", "bodyText": "If you do that you lose the comment passed to the setRetainUntil API, which is a problem as I think it was important. I think it's better to keep the comment and let the retention date live in the options map.  @jaubenque?", "url": "https://github.com/nuxeo/nuxeo/pull/3849#discussion_r396645385", "createdAt": "2020-03-23T17:55:37Z", "author": {"login": "efge"}, "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/api/AbstractSession.java", "diffHunk": "@@ -2087,18 +2087,17 @@ public void setRetainUntil(DocumentRef docRef, Calendar retainUntil, String comm\n         checkPermission(doc, SET_RETENTION);\n         Map<String, Serializable> options = new HashMap<>();\n         options.put(CoreEventConstants.RETAIN_UNTIL, retainUntil);\n-        String commentStart = retainUntil == null ? null : retainUntil.toInstant().toString();\n-        if (comment == null) {\n-            comment = commentStart;\n-        } else if (commentStart != null) {\n-            comment = commentStart + \" \" + comment;\n-        }\n-        options.put(\"comment\", comment);\n+        options.put(\"comment\", retainUntil == null ? \"\" : retainUntil.toInstant().toString());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUxMTY3OA=="}, "originalCommit": {"oid": "ffbf3ae013f98f23704c607b138569a1cd979a9f"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY0ODYxOQ==", "bodyText": "In the platform we prefer to not have negations in ternary operators, so comment == null ? \"\" : comment. But actually in this case it would be even better to use the semantically cleaner StringUtils.defaultString(comment)", "url": "https://github.com/nuxeo/nuxeo/pull/3849#discussion_r396648619", "createdAt": "2020-03-23T18:00:14Z", "author": {"login": "efge"}, "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/api/AbstractSession.java", "diffHunk": "@@ -2122,17 +2121,13 @@ public void setLegalHold(DocumentRef docRef, boolean hold, String comment) {\n         DocumentModel docModel = readModel(doc);\n         Map<String, Serializable> options = new HashMap<>();\n         options.put(CoreEventConstants.LEGAL_HOLD, Boolean.valueOf(hold));\n-        String commentStart = Boolean.toString(hold);\n-        if (comment == null) {\n-            comment = commentStart;\n-        } else {\n-            comment = commentStart + \" \" + comment;\n-        }\n-        options.put(\"comment\", comment);\n-        notifyEvent(DocumentEventTypes.BEFORE_SET_LEGAL_HOLD, docModel, options, null, null, true, false);\n+        options.put(\"comment\", comment != null ? comment : \"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffbf3ae013f98f23704c607b138569a1cd979a9f"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxMjk2MTA4", "url": "https://github.com/nuxeo/nuxeo/pull/3849#pullrequestreview-381296108", "createdAt": "2020-03-25T16:01:37Z", "commit": {"oid": "ffbf3ae013f98f23704c607b138569a1cd979a9f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNjowMTozN1rOF7iV6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNjowMTozN1rOF7iV6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk3Mjk3MQ==", "bodyText": "Now that we have two events, you can remove the options.put(CoreEventConstants.LEGAL_HOLD, Boolean.valueOf(hold)) a few lines above, which is useless because it doesn't bring any info.\nAnd remove the constant LEGAL_HOLD and the references to it in the Javadoc.", "url": "https://github.com/nuxeo/nuxeo/pull/3849#discussion_r397972971", "createdAt": "2020-03-25T16:01:37Z", "author": {"login": "efge"}, "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/api/AbstractSession.java", "diffHunk": "@@ -2122,17 +2121,13 @@ public void setLegalHold(DocumentRef docRef, boolean hold, String comment) {\n         DocumentModel docModel = readModel(doc);\n         Map<String, Serializable> options = new HashMap<>();\n         options.put(CoreEventConstants.LEGAL_HOLD, Boolean.valueOf(hold));\n-        String commentStart = Boolean.toString(hold);\n-        if (comment == null) {\n-            comment = commentStart;\n-        } else {\n-            comment = commentStart + \" \" + comment;\n-        }\n-        options.put(\"comment\", comment);\n-        notifyEvent(DocumentEventTypes.BEFORE_SET_LEGAL_HOLD, docModel, options, null, null, true, false);\n+        options.put(\"comment\", comment != null ? comment : \"\");\n+        String beforeLegalHoldEvent = hold ? DocumentEventTypes.BEFORE_SET_LEGAL_HOLD : DocumentEventTypes.BEFORE_REMOVE_LEGAL_HOLD;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffbf3ae013f98f23704c607b138569a1cd979a9f"}, "originalPosition": 40}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ffbf3ae013f98f23704c607b138569a1cd979a9f", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/ffbf3ae013f98f23704c607b138569a1cd979a9f", "committedDate": "2020-03-23T08:48:01Z", "message": "NXP-28784: Record management - Missing labels in the audit for retention events"}, "afterCommit": {"oid": "080cf7168ff14a72ef1f49383c81d93f03553cb5", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/080cf7168ff14a72ef1f49383c81d93f03553cb5", "committedDate": "2020-03-25T16:13:01Z", "message": "NXP-28784: Record management - Missing labels in the audit for retention events"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxMzk0NzQz", "url": "https://github.com/nuxeo/nuxeo/pull/3849#pullrequestreview-381394743", "createdAt": "2020-03-25T17:51:19Z", "commit": {"oid": "46c6f72a65b3a0211789ee616105bef11f955a18"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "46c6f72a65b3a0211789ee616105bef11f955a18", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/46c6f72a65b3a0211789ee616105bef11f955a18", "committedDate": "2020-03-25T17:18:16Z", "message": "NXP-28786: Record management - Expiration date displayed for undeterminate retention"}, "afterCommit": {"oid": "642a7852e819ce1c2b3e11e15409f7e944a15e2b", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/642a7852e819ce1c2b3e11e15409f7e944a15e2b", "committedDate": "2020-03-26T09:20:48Z", "message": "NXP-28786: Record management - Expiration date displayed for undeterminate retention"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMTAyMTU2", "url": "https://github.com/nuxeo/nuxeo/pull/3849#pullrequestreview-382102156", "createdAt": "2020-03-26T15:05:48Z", "commit": {"oid": "642a7852e819ce1c2b3e11e15409f7e944a15e2b"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNjk3OTYw", "url": "https://github.com/nuxeo/nuxeo/pull/3849#pullrequestreview-382697960", "createdAt": "2020-03-27T09:30:05Z", "commit": {"oid": "642a7852e819ce1c2b3e11e15409f7e944a15e2b"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b81b2cf5b71e7d59de0607535870078095b9726", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/7b81b2cf5b71e7d59de0607535870078095b9726", "committedDate": "2020-03-27T11:04:37Z", "message": "NXP-28784: Record management - Missing labels in the audit for retention events"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3cab2e8f57e86b129e0bafeb49683fff1902a510", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/3cab2e8f57e86b129e0bafeb49683fff1902a510", "committedDate": "2020-03-27T11:05:11Z", "message": "NXP-28786: Record management - Expiration date displayed for undeterminate retention"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "642a7852e819ce1c2b3e11e15409f7e944a15e2b", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/642a7852e819ce1c2b3e11e15409f7e944a15e2b", "committedDate": "2020-03-26T09:20:48Z", "message": "NXP-28786: Record management - Expiration date displayed for undeterminate retention"}, "afterCommit": {"oid": "3cab2e8f57e86b129e0bafeb49683fff1902a510", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/3cab2e8f57e86b129e0bafeb49683fff1902a510", "committedDate": "2020-03-27T11:05:11Z", "message": "NXP-28786: Record management - Expiration date displayed for undeterminate retention"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNzY1MzY0", "url": "https://github.com/nuxeo/nuxeo/pull/3849#pullrequestreview-382765364", "createdAt": "2020-03-27T11:10:13Z", "commit": {"oid": "3cab2e8f57e86b129e0bafeb49683fff1902a510"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNzkxNTUw", "url": "https://github.com/nuxeo/nuxeo/pull/3849#pullrequestreview-382791550", "createdAt": "2020-03-27T11:53:56Z", "commit": {"oid": "3cab2e8f57e86b129e0bafeb49683fff1902a510"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4809, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}