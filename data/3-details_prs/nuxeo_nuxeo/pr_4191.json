{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyMDIzMzk4", "number": 4191, "title": "fix-NXP-29325-blob-preview", "bodyText": "PR created from https://qa.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-nsilva/153/", "createdAt": "2020-06-30T13:19:21Z", "url": "https://github.com/nuxeo/nuxeo/pull/4191", "merged": true, "mergeCommit": {"oid": "1ca7a5d8af51cd8755b12a3e23c44bb6b5512846"}, "closed": true, "closedAt": "2020-07-01T15:57:10Z", "author": {"login": "nuxeojenkins"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwWaolgFqTQ0MDA2NTk1Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwr_KGgFqTQ0MDk3NzczNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMDY1OTU2", "url": "https://github.com/nuxeo/nuxeo/pull/4191#pullrequestreview-440065956", "createdAt": "2020-06-30T14:21:06Z", "commit": {"oid": "b982ee55aa03de01db1b1dd54a7de9a8f9cc81f3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNDoyMTowNlrOGq-wtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNDoyMTowNlrOGq-wtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzcyMTY1NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Enrich {@link Blob} json with embed preview link when available.\n          \n          \n            \n             * Enriches {@link Blob} json with embed preview link when available.", "url": "https://github.com/nuxeo/nuxeo/pull/4191#discussion_r447721655", "createdAt": "2020-06-30T14:21:06Z", "author": {"login": "troger"}, "path": "modules/platform/nuxeo-preview-core/src/main/java/org/nuxeo/ecm/platform/preview/io/BlobPreviewJsonEnricher.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nelson Silva <nsilva@nuxeo.com>\n+ */\n+\n+package org.nuxeo.ecm.platform.preview.io;\n+\n+import static org.nuxeo.ecm.core.io.registry.reflect.Instantiations.SINGLETON;\n+import static org.nuxeo.ecm.core.io.registry.reflect.Priorities.REFERENCE;\n+\n+import java.io.IOException;\n+import java.net.URI;\n+\n+import org.nuxeo.ecm.core.api.Blob;\n+import org.nuxeo.ecm.core.api.model.impl.primitives.BlobProperty;\n+import org.nuxeo.ecm.core.blob.BlobManager;\n+import org.nuxeo.ecm.core.blob.ManagedBlob;\n+import org.nuxeo.ecm.core.io.marshallers.json.enrichers.AbstractJsonEnricher;\n+import org.nuxeo.ecm.core.io.registry.reflect.Setup;\n+import org.nuxeo.runtime.api.Framework;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+\n+/**\n+ * Enrich {@link Blob} json with embed preview link when available.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b982ee55aa03de01db1b1dd54a7de9a8f9cc81f3"}, "originalPosition": 39}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b982ee55aa03de01db1b1dd54a7de9a8f9cc81f3", "author": {"user": {"login": "nelsonsilva", "name": "Nelson Silva"}}, "url": "https://github.com/nuxeo/nuxeo/commit/b982ee55aa03de01db1b1dd54a7de9a8f9cc81f3", "committedDate": "2020-06-29T14:30:34Z", "message": "NXP-29325: add managed blob preview enricher"}, "afterCommit": {"oid": "4e47bc78891c4b50af48352dfbfdfe9c08dcdf42", "author": {"user": {"login": "nelsonsilva", "name": "Nelson Silva"}}, "url": "https://github.com/nuxeo/nuxeo/commit/4e47bc78891c4b50af48352dfbfdfe9c08dcdf42", "committedDate": "2020-06-30T16:40:40Z", "message": "NXP-29325: add managed blob preview enricher"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMjI0MTQx", "url": "https://github.com/nuxeo/nuxeo/pull/4191#pullrequestreview-440224141", "createdAt": "2020-06-30T17:12:09Z", "commit": {"oid": "4e47bc78891c4b50af48352dfbfdfe9c08dcdf42"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNzoxMjoxMFrOGrGcyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNzoxNjo1OFrOGrGn-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg0NzYyNw==", "bodyText": "You must use toASCIIString instead of toString here.", "url": "https://github.com/nuxeo/nuxeo/pull/4191#discussion_r447847627", "createdAt": "2020-06-30T17:12:10Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-preview-core/src/main/java/org/nuxeo/ecm/platform/preview/io/BlobPreviewJsonEnricher.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nelson Silva <nsilva@nuxeo.com>\n+ */\n+\n+package org.nuxeo.ecm.platform.preview.io;\n+\n+import static org.nuxeo.ecm.core.io.registry.reflect.Instantiations.SINGLETON;\n+import static org.nuxeo.ecm.core.io.registry.reflect.Priorities.REFERENCE;\n+\n+import java.io.IOException;\n+import java.net.URI;\n+\n+import org.nuxeo.ecm.core.api.Blob;\n+import org.nuxeo.ecm.core.api.model.impl.primitives.BlobProperty;\n+import org.nuxeo.ecm.core.blob.BlobManager;\n+import org.nuxeo.ecm.core.blob.ManagedBlob;\n+import org.nuxeo.ecm.core.io.marshallers.json.enrichers.AbstractJsonEnricher;\n+import org.nuxeo.ecm.core.io.registry.reflect.Setup;\n+import org.nuxeo.runtime.api.Framework;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+\n+/**\n+ * Enriches {@link Blob} json with embed preview link when available.\n+ * <p>\n+ * Enabled when parameter enrichers-blob=preview is present.\n+ * <p>\n+ * Blob format is:\n+ *\n+ * <pre>\n+ * {@code\n+ * {\n+ *  \"name\": \"...\",\n+ *  \"mime-type\": \"...\",\n+ *  ...\n+ *  \"preview\": \"<url>\"\n+ * }\n+ * }\n+ * </pre>\n+ *\n+ * @since 11.2\n+ */\n+@Setup(mode = SINGLETON, priority = REFERENCE)\n+public class BlobPreviewJsonEnricher extends AbstractJsonEnricher<BlobProperty> {\n+\n+    public static final String NAME = \"preview\";\n+\n+    public BlobPreviewJsonEnricher() {\n+        super(NAME);\n+    }\n+\n+    @Override\n+    public void write(JsonGenerator jg, BlobProperty blobProperty) throws IOException {\n+        Blob blob = (Blob) blobProperty.getValue();\n+        if (!(blob instanceof ManagedBlob)) {\n+            return;\n+        }\n+\n+        // if it's a managed blob try to use the embed uri for preview\n+        BlobManager blobManager = Framework.getService(BlobManager.class);\n+        URI uri = blobManager.getURI(blob, BlobManager.UsageHint.EMBED, null);\n+        if (uri != null) {\n+            jg.writeStringField(NAME, uri.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e47bc78891c4b50af48352dfbfdfe9c08dcdf42"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg1MDQ4OA==", "bodyText": "Could you use a real example.com URI to be clearer in the test?", "url": "https://github.com/nuxeo/nuxeo/pull/4191#discussion_r447850488", "createdAt": "2020-06-30T17:16:58Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-preview-core/src/test/java/org/nuxeo/ecm/platform/preview/io/DummyManagedBlobProvider.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nelson Silva <nsilva@nuxeo.com>\n+ */\n+\n+package org.nuxeo.ecm.platform.preview.io;\n+\n+import org.nuxeo.ecm.core.blob.BlobManager;\n+import org.nuxeo.ecm.core.blob.DummyBlobProvider;\n+import org.nuxeo.ecm.core.blob.ManagedBlob;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+\n+/**\n+ * Dummy storage in memory.\n+ */\n+public class DummyManagedBlobProvider extends DummyBlobProvider {\n+    @Override\n+    public URI getURI(ManagedBlob blob, BlobManager.UsageHint usage, HttpServletRequest servletRequest) throws IOException {\n+        URI uri = null;\n+        try {\n+            uri = new URI(usage.name());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e47bc78891c4b50af48352dfbfdfe9c08dcdf42"}, "originalPosition": 39}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4e47bc78891c4b50af48352dfbfdfe9c08dcdf42", "author": {"user": {"login": "nelsonsilva", "name": "Nelson Silva"}}, "url": "https://github.com/nuxeo/nuxeo/commit/4e47bc78891c4b50af48352dfbfdfe9c08dcdf42", "committedDate": "2020-06-30T16:40:40Z", "message": "NXP-29325: add managed blob preview enricher"}, "afterCommit": {"oid": "86bb0a54922575919c4c367be023d12dd659ceb9", "author": {"user": {"login": "nelsonsilva", "name": "Nelson Silva"}}, "url": "https://github.com/nuxeo/nuxeo/commit/86bb0a54922575919c4c367be023d12dd659ceb9", "committedDate": "2020-06-30T21:58:02Z", "message": "NXP-29325: add managed blob preview enricher"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNDE2ODM5", "url": "https://github.com/nuxeo/nuxeo/pull/4191#pullrequestreview-440416839", "createdAt": "2020-06-30T22:00:46Z", "commit": {"oid": "86bb0a54922575919c4c367be023d12dd659ceb9"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNjM0NDAy", "url": "https://github.com/nuxeo/nuxeo/pull/4191#pullrequestreview-440634402", "createdAt": "2020-07-01T08:00:06Z", "commit": {"oid": "86bb0a54922575919c4c367be023d12dd659ceb9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwODowMDowNlrOGrbIFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwODowMDowNlrOGrbIFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE4NjM5MA==", "bodyText": "Don't need this file, just deploy your test contrib with org.nuxeo.ecm.platform.preview:test-dummy-blob-provider.xml", "url": "https://github.com/nuxeo/nuxeo/pull/4191#discussion_r448186390", "createdAt": "2020-07-01T08:00:06Z", "author": {"login": "troger"}, "path": "modules/platform/nuxeo-preview-core/src/test/resources/META-INF/MANIFEST.MF", "diffHunk": "@@ -0,0 +1,4 @@\n+Manifest-Version: 1.0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86bb0a54922575919c4c367be023d12dd659ceb9"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39f1e8a720b6876d30b5c4457422b1ed3661fe9a", "author": {"user": {"login": "nelsonsilva", "name": "Nelson Silva"}}, "url": "https://github.com/nuxeo/nuxeo/commit/39f1e8a720b6876d30b5c4457422b1ed3661fe9a", "committedDate": "2020-07-01T13:14:57Z", "message": "NXP-29325: add managed blob preview enricher"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "86bb0a54922575919c4c367be023d12dd659ceb9", "author": {"user": {"login": "nelsonsilva", "name": "Nelson Silva"}}, "url": "https://github.com/nuxeo/nuxeo/commit/86bb0a54922575919c4c367be023d12dd659ceb9", "committedDate": "2020-06-30T21:58:02Z", "message": "NXP-29325: add managed blob preview enricher"}, "afterCommit": {"oid": "39f1e8a720b6876d30b5c4457422b1ed3661fe9a", "author": {"user": {"login": "nelsonsilva", "name": "Nelson Silva"}}, "url": "https://github.com/nuxeo/nuxeo/commit/39f1e8a720b6876d30b5c4457422b1ed3661fe9a", "committedDate": "2020-07-01T13:14:57Z", "message": "NXP-29325: add managed blob preview enricher"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwODYxNzM5", "url": "https://github.com/nuxeo/nuxeo/pull/4191#pullrequestreview-440861739", "createdAt": "2020-07-01T13:20:16Z", "commit": {"oid": "39f1e8a720b6876d30b5c4457422b1ed3661fe9a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwOTc3NzM0", "url": "https://github.com/nuxeo/nuxeo/pull/4191#pullrequestreview-440977734", "createdAt": "2020-07-01T15:29:21Z", "commit": {"oid": "39f1e8a720b6876d30b5c4457422b1ed3661fe9a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4723, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}