{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4NTA0NTE3", "number": 4040, "title": "NXP-29107: make explorer ftest using new window more robust", "bodyText": "Try to avoid random failure for new tests.\nT&P at https://qa.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-atchertchian-master/217/ passed but did not create a PR because of merging conflict (linked to other changes merged in the meantime).\nLaunched again (without unit tests) at https://qa.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-atchertchian-master/218/ just in case it still catches a random failure.", "createdAt": "2020-05-15T10:20:07Z", "url": "https://github.com/nuxeo/nuxeo/pull/4040", "merged": true, "mergeCommit": {"oid": "8b9897a92318472398315c35c07ec1a066b2823b"}, "closed": true, "closedAt": "2020-05-18T08:29:49Z", "author": {"login": "atchertchian"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchfkwJgFqTQxMjUyODIyNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcibbYTgFqTQxMzM2NzEyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyNTI4MjI2", "url": "https://github.com/nuxeo/nuxeo/pull/4040#pullrequestreview-412528226", "createdAt": "2020-05-15T10:25:48Z", "commit": {"oid": "8f3286998dbbb73daf2daeb1f9f75477aa48dec4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxMDoyNTo0OFrOGV_R1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxMDozMjoyNFrOGV_eTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcxMDAzNw==", "bodyText": "Can't a lambda be used here?", "url": "https://github.com/nuxeo/nuxeo/pull/4040#discussion_r425710037", "createdAt": "2020-05-15T10:25:48Z", "author": {"login": "efge"}, "path": "ftests/nuxeo-platform-explorer-ftests/src/test/java/org/nuxeo/functionaltests/explorer/AbstractExplorerTest.java", "diffHunk": "@@ -196,9 +202,27 @@ protected void storeWindowHandle() {\n     }\n \n     protected void switchToNewWindow() {\n-        for (String winHandle : driver.getWindowHandles()) {\n-            driver.switchTo().window(winHandle);\n+        Wait<WebDriver> wait = Locator.getFluentWait();\n+        wait.until((new Function<WebDriver, Boolean>() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f3286998dbbb73daf2daeb1f9f75477aa48dec4"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcxMDc0Ng==", "bodyText": "Remove debug println", "url": "https://github.com/nuxeo/nuxeo/pull/4040#discussion_r425710746", "createdAt": "2020-05-15T10:27:14Z", "author": {"login": "efge"}, "path": "ftests/nuxeo-platform-explorer-ftests/src/test/java/org/nuxeo/functionaltests/explorer/AbstractExplorerTest.java", "diffHunk": "@@ -196,9 +202,27 @@ protected void storeWindowHandle() {\n     }\n \n     protected void switchToNewWindow() {\n-        for (String winHandle : driver.getWindowHandles()) {\n-            driver.switchTo().window(winHandle);\n+        Wait<WebDriver> wait = Locator.getFluentWait();\n+        wait.until((new Function<WebDriver, Boolean>() {\n+            @Override\n+            public Boolean apply(WebDriver driver) {\n+                try {\n+                    // wait for one more window to be opened\n+                    return driver.getWindowHandles().size() > 1;\n+                } catch (StaleElementReferenceException e) {\n+                    return null;\n+                }\n+            }\n+        }));\n+        // select last handle\n+        String handle = null;\n+        Iterator<String> handleIt = driver.getWindowHandles().iterator();\n+        while (handleIt.hasNext()) {\n+            handle = handleIt.next();\n         }\n+        System.err.println(driver.getWindowHandles());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f3286998dbbb73daf2daeb1f9f75477aa48dec4"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcxMzIyOA==", "bodyText": "You can use\nfor (String h : driver.getWindowHandles()) {\n    handle = h;\n}\n\nOr if you feel fancy\nString handle = driver.getWindowHandles().stream().reduce((prev, next) -> next).orElse(null);", "url": "https://github.com/nuxeo/nuxeo/pull/4040#discussion_r425713228", "createdAt": "2020-05-15T10:32:24Z", "author": {"login": "efge"}, "path": "ftests/nuxeo-platform-explorer-ftests/src/test/java/org/nuxeo/functionaltests/explorer/AbstractExplorerTest.java", "diffHunk": "@@ -196,9 +202,27 @@ protected void storeWindowHandle() {\n     }\n \n     protected void switchToNewWindow() {\n-        for (String winHandle : driver.getWindowHandles()) {\n-            driver.switchTo().window(winHandle);\n+        Wait<WebDriver> wait = Locator.getFluentWait();\n+        wait.until((new Function<WebDriver, Boolean>() {\n+            @Override\n+            public Boolean apply(WebDriver driver) {\n+                try {\n+                    // wait for one more window to be opened\n+                    return driver.getWindowHandles().size() > 1;\n+                } catch (StaleElementReferenceException e) {\n+                    return null;\n+                }\n+            }\n+        }));\n+        // select last handle\n+        String handle = null;\n+        Iterator<String> handleIt = driver.getWindowHandles().iterator();\n+        while (handleIt.hasNext()) {\n+            handle = handleIt.next();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f3286998dbbb73daf2daeb1f9f75477aa48dec4"}, "originalPosition": 42}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8f3286998dbbb73daf2daeb1f9f75477aa48dec4", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/8f3286998dbbb73daf2daeb1f9f75477aa48dec4", "committedDate": "2020-05-15T10:17:57Z", "message": "NXP-29107: make explorer ftest using new window more robust"}, "afterCommit": {"oid": "e3106e77e3f2590b24ebb2d7f2489602d303179b", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/e3106e77e3f2590b24ebb2d7f2489602d303179b", "committedDate": "2020-05-15T10:39:00Z", "message": "NXP-29107: make explorer ftest using new window more robust"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e3106e77e3f2590b24ebb2d7f2489602d303179b", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/e3106e77e3f2590b24ebb2d7f2489602d303179b", "committedDate": "2020-05-15T10:39:00Z", "message": "NXP-29107: make explorer ftest using new window more robust"}, "afterCommit": {"oid": "bde1043bab16ddf980fe3df6bba6b2360ac65dd6", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/bde1043bab16ddf980fe3df6bba6b2360ac65dd6", "committedDate": "2020-05-15T10:40:17Z", "message": "NXP-29107: make explorer ftest using new window more robust"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyNTQ0NjQw", "url": "https://github.com/nuxeo/nuxeo/pull/4040#pullrequestreview-412544640", "createdAt": "2020-05-15T10:53:27Z", "commit": {"oid": "bde1043bab16ddf980fe3df6bba6b2360ac65dd6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxMDo1MzoyN1rOGWAEVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxMDo1NToyOVrOGWAH0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcyMjk2NA==", "bodyText": "Import not needed anymore", "url": "https://github.com/nuxeo/nuxeo/pull/4040#discussion_r425722964", "createdAt": "2020-05-15T10:53:27Z", "author": {"login": "efge"}, "path": "ftests/nuxeo-platform-explorer-ftests/src/test/java/org/nuxeo/functionaltests/explorer/AbstractExplorerTest.java", "diffHunk": "@@ -24,6 +24,7 @@\n import java.io.IOException;\n import java.net.URL;\n import java.nio.charset.StandardCharsets;\n+import java.util.Iterator;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bde1043bab16ddf980fe3df6bba6b2360ac65dd6"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcyMzg1OQ==", "bodyText": "Actually we can't use a lambda as com.google.common.base.Function is not a SAM-type (single abstract method) required for lambda use despite being annotated @FunctionalInterface", "url": "https://github.com/nuxeo/nuxeo/pull/4040#discussion_r425723859", "createdAt": "2020-05-15T10:55:29Z", "author": {"login": "efge"}, "path": "ftests/nuxeo-platform-explorer-ftests/src/test/java/org/nuxeo/functionaltests/explorer/AbstractExplorerTest.java", "diffHunk": "@@ -196,9 +202,27 @@ protected void storeWindowHandle() {\n     }\n \n     protected void switchToNewWindow() {\n-        for (String winHandle : driver.getWindowHandles()) {\n-            driver.switchTo().window(winHandle);\n+        Wait<WebDriver> wait = Locator.getFluentWait();\n+        wait.until((new Function<WebDriver, Boolean>() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcxMDAzNw=="}, "originalCommit": {"oid": "8f3286998dbbb73daf2daeb1f9f75477aa48dec4"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51bbfe6fb2e0dc4d5d326b8a36c51acefd0f3d36", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/51bbfe6fb2e0dc4d5d326b8a36c51acefd0f3d36", "committedDate": "2020-05-15T13:07:49Z", "message": "NXP-29107: make explorer ftest using new window more robust"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bde1043bab16ddf980fe3df6bba6b2360ac65dd6", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/bde1043bab16ddf980fe3df6bba6b2360ac65dd6", "committedDate": "2020-05-15T10:40:17Z", "message": "NXP-29107: make explorer ftest using new window more robust"}, "afterCommit": {"oid": "51bbfe6fb2e0dc4d5d326b8a36c51acefd0f3d36", "author": {"user": {"login": "atchertchian", "name": "Anahide Tchertchian"}}, "url": "https://github.com/nuxeo/nuxeo/commit/51bbfe6fb2e0dc4d5d326b8a36c51acefd0f3d36", "committedDate": "2020-05-15T13:07:49Z", "message": "NXP-29107: make explorer ftest using new window more robust"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMzQ0MzQz", "url": "https://github.com/nuxeo/nuxeo/pull/4040#pullrequestreview-413344343", "createdAt": "2020-05-18T07:44:59Z", "commit": {"oid": "51bbfe6fb2e0dc4d5d326b8a36c51acefd0f3d36"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMzY3MTIz", "url": "https://github.com/nuxeo/nuxeo/pull/4040#pullrequestreview-413367123", "createdAt": "2020-05-18T08:16:51Z", "commit": {"oid": "51bbfe6fb2e0dc4d5d326b8a36c51acefd0f3d36"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4734, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}