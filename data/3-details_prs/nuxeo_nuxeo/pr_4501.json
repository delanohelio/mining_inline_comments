{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwMzkxNDYy", "number": 4501, "title": "NXP-29798: Implement get server info endpoint", "bodyText": "", "createdAt": "2020-12-01T15:37:58Z", "url": "https://github.com/nuxeo/nuxeo/pull/4501", "merged": true, "mergeCommit": {"oid": "fff293245528ed62595a1b7643dbf8e18041f287"}, "closed": true, "closedAt": "2020-12-08T08:53:47Z", "author": {"login": "kevinleturc"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdh7559gFqTU0MjAzMjg1Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdj23TkAFqTU0NjIzMTU2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMDMyODUz", "url": "https://github.com/nuxeo/nuxeo/pull/4501#pullrequestreview-542032853", "createdAt": "2020-12-01T15:44:23Z", "commit": {"oid": "f43244556866257fb32f599e7cec79991e565323"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxNTo0NDoyM1rOH8zH2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxNTo0NDoyM1rOH8zH2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzUxNDIwMQ==", "bodyText": "isClusterEnabled would be useful too I think", "url": "https://github.com/nuxeo/nuxeo/pull/4501#discussion_r533514201", "createdAt": "2020-12-01T15:44:23Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-admin-center/nuxeo-admin-center-core/src/main/java/org/nuxeo/ecm/admin/runtime/ServerInfo.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+\n+package org.nuxeo.ecm.admin.runtime;\n+\n+import static org.nuxeo.common.Environment.DISTRIBUTION_HOTFIX;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_NAME;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_SERVER;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_VERSION;\n+\n+import java.util.Optional;\n+\n+import org.nuxeo.runtime.api.Framework;\n+import org.nuxeo.runtime.cluster.ClusterService;\n+\n+/**\n+ * @since 11.5\n+ */\n+public class ServerInfo {\n+\n+    protected String distributionName;\n+\n+    protected String distributionVersion;\n+\n+    protected String distributionServer;\n+\n+    protected String hotfixVersion;\n+\n+    protected String clusterNodeId;\n+\n+    protected ServerInfo() {\n+    }\n+\n+    public String getDistributionName() {\n+        return distributionName;\n+    }\n+\n+    public String getDistributionVersion() {\n+        return distributionVersion;\n+    }\n+\n+    public String getDistributionServer() {\n+        return distributionServer;\n+    }\n+\n+    public Optional<String> getHotfixVersion() {\n+        return Optional.ofNullable(hotfixVersion);\n+    }\n+\n+    public String getClusterNodeId() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f43244556866257fb32f599e7cec79991e565323"}, "originalPosition": 66}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f43244556866257fb32f599e7cec79991e565323", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/f43244556866257fb32f599e7cec79991e565323", "committedDate": "2020-12-01T15:36:12Z", "message": "NXP-29798: Implement get server info endpoint"}, "afterCommit": {"oid": "cc7edf313098a8312bce8400371fa43ff749deb7", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/cc7edf313098a8312bce8400371fa43ff749deb7", "committedDate": "2020-12-03T08:37:51Z", "message": "NXP-29798: Implement get server info endpoint"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cc7edf313098a8312bce8400371fa43ff749deb7", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/cc7edf313098a8312bce8400371fa43ff749deb7", "committedDate": "2020-12-03T08:37:51Z", "message": "NXP-29798: Implement get server info endpoint"}, "afterCommit": {"oid": "3fa215837bcedec98731d58899e8db1686dcfc1f", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/3fa215837bcedec98731d58899e8db1686dcfc1f", "committedDate": "2020-12-04T15:13:52Z", "message": "NXP-29798: Implement get server info endpoint"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MDk2NjQ4", "url": "https://github.com/nuxeo/nuxeo/pull/4501#pullrequestreview-545096648", "createdAt": "2020-12-04T16:12:30Z", "commit": {"oid": "3fa215837bcedec98731d58899e8db1686dcfc1f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNjoxMjozMFrOH_Xuvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNjoxMjozMFrOH_Xuvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjIxMTEzNQ==", "bodyText": "Can you assert clusterEnabled too?", "url": "https://github.com/nuxeo/nuxeo/pull/4501#discussion_r536211135", "createdAt": "2020-12-04T16:12:30Z", "author": {"login": "efge"}, "path": "modules/platform/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/server/jaxrs/TestServerInfoObject.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+\n+package org.nuxeo.ecm.restapi.server.jaxrs;\n+\n+import static javax.ws.rs.core.MediaType.WILDCARD;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNull;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_HOTFIX;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_NAME;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_SERVER;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_VERSION;\n+import static org.nuxeo.ecm.core.io.registry.MarshallingConstants.ENTITY_FIELD_NAME;\n+\n+import java.io.IOException;\n+\n+import javax.inject.Inject;\n+import javax.servlet.http.HttpServletResponse;\n+\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.core.io.APIVersion;\n+import org.nuxeo.ecm.restapi.jaxrs.io.capabilities.ServerInfoJsonWriter;\n+import org.nuxeo.ecm.restapi.test.RestServerFeature;\n+import org.nuxeo.jaxrs.test.CloseableClientResponse;\n+import org.nuxeo.jaxrs.test.HttpClientTestRule;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+import org.nuxeo.runtime.test.runner.ServletContainerFeature;\n+import org.nuxeo.runtime.test.runner.WithFrameworkProperty;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+/**\n+ * @since 11.5\n+ */\n+@RunWith(FeaturesRunner.class)\n+@Features(RestServerFeature.class)\n+@Deploy(\"org.nuxeo.ecm.platform.restapi.test.test:test-cluster.xml\")\n+public class TestServerInfoObject {\n+\n+    @Inject\n+    protected ServletContainerFeature servletContainerFeature;\n+\n+    protected HttpClientTestRule httpClientRule;\n+\n+    protected ObjectMapper mapper = new ObjectMapper();\n+\n+    protected HttpClientTestRule getRule() {\n+        String url = String.format(\"http://localhost:%d/api/v%d\", servletContainerFeature.getPort(),\n+                APIVersion.latest().toInt());\n+        return new HttpClientTestRule.Builder().url(url).adminCredentials().accept(WILDCARD).build();\n+    }\n+\n+    @Before\n+    public void before() {\n+        httpClientRule = getRule();\n+        httpClientRule.starting();\n+    }\n+\n+    @After\n+    public void after() {\n+        httpClientRule.finished();\n+    }\n+\n+    @Test\n+    @WithFrameworkProperty(name = DISTRIBUTION_NAME, value = DISTRIBUTION_NAME)\n+    @WithFrameworkProperty(name = DISTRIBUTION_VERSION, value = DISTRIBUTION_VERSION)\n+    @WithFrameworkProperty(name = DISTRIBUTION_SERVER, value = DISTRIBUTION_SERVER)\n+    public void testGet() throws IOException {\n+        try (CloseableClientResponse response = httpClientRule.get(\"/server\")) {\n+            assertEquals(HttpServletResponse.SC_OK, response.getStatus());\n+            JsonNode node = mapper.readTree(response.getEntityInputStream());\n+\n+            assertEquals(ServerInfoJsonWriter.ENTITY_TYPE, node.get(ENTITY_FIELD_NAME).asText());\n+            assertEquals(DISTRIBUTION_NAME, node.get(\"distributionName\").asText());\n+            assertEquals(DISTRIBUTION_VERSION, node.get(\"distributionVersion\").asText());\n+            assertEquals(DISTRIBUTION_SERVER, node.get(\"distributionServer\").asText());\n+            assertNull(node.get(\"hotfixVersion\"));\n+            assertEquals(\"123\", node.get(\"clusterNodeId\").asText());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fa215837bcedec98731d58899e8db1686dcfc1f"}, "originalPosition": 100}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d679e15ada6e6965ee5985f1777eb180a39dc00", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/3d679e15ada6e6965ee5985f1777eb180a39dc00", "committedDate": "2020-12-07T09:24:18Z", "message": "NXP-29798: Implement get server info endpoint"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3fa215837bcedec98731d58899e8db1686dcfc1f", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/3fa215837bcedec98731d58899e8db1686dcfc1f", "committedDate": "2020-12-04T15:13:52Z", "message": "NXP-29798: Implement get server info endpoint"}, "afterCommit": {"oid": "3d679e15ada6e6965ee5985f1777eb180a39dc00", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/3d679e15ada6e6965ee5985f1777eb180a39dc00", "committedDate": "2020-12-07T09:24:18Z", "message": "NXP-29798: Implement get server info endpoint"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MTI0OTAx", "url": "https://github.com/nuxeo/nuxeo/pull/4501#pullrequestreview-546124901", "createdAt": "2020-12-07T13:00:17Z", "commit": {"oid": "3d679e15ada6e6965ee5985f1777eb180a39dc00"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MjMxNTYz", "url": "https://github.com/nuxeo/nuxeo/pull/4501#pullrequestreview-546231563", "createdAt": "2020-12-07T14:59:52Z", "commit": {"oid": "3d679e15ada6e6965ee5985f1777eb180a39dc00"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4908, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}