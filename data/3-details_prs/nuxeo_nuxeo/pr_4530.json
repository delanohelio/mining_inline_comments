{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1MDk4ODMw", "number": 4530, "title": "NXP-29798: Implement a Capabilities Service", "bodyText": "", "createdAt": "2020-12-09T11:06:56Z", "url": "https://github.com/nuxeo/nuxeo/pull/4530", "merged": true, "mergeCommit": {"oid": "c2eeeca2757849d2123977f73a71ecd2b1cddf29"}, "closed": true, "closedAt": "2020-12-15T17:15:02Z", "author": {"login": "kevinleturc"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkdCrigFqTU0ODA3NzY3NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdomTaSAFqTU1NjkwMzA1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MDc3Njc0", "url": "https://github.com/nuxeo/nuxeo/pull/4530#pullrequestreview-548077674", "createdAt": "2020-12-09T11:12:50Z", "commit": {"oid": "13869fa58d07a68b7022126aadb6f85be7836157"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMToxMjo1MFrOICPQdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMToxNzo0OFrOICPdUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIxODAzNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    for (var entry : entity.get().entrySet()) {\n          \n          \n            \n                        jg.writeObjectField(entry.getKey(), entry.getValue());\n          \n          \n            \n                    }\n          \n          \n            \n                    entity.get().entrySet().forEach(e -> jg.writeObjectField(e.getKey(), e.getValue());", "url": "https://github.com/nuxeo/nuxeo/pull/4530#discussion_r539218036", "createdAt": "2020-12-09T11:12:50Z", "author": {"login": "efge"}, "path": "modules/platform/rest-api/nuxeo-rest-api-io/src/main/java/org/nuxeo/ecm/restapi/jaxrs/io/capabilities/CapabilitiesJsonWriter.java", "diffHunk": "@@ -19,37 +19,33 @@\n \n package org.nuxeo.ecm.restapi.jaxrs.io.capabilities;\n \n-import static org.nuxeo.common.function.ThrowableConsumer.asConsumer;\n import static org.nuxeo.ecm.core.io.registry.reflect.Instantiations.SINGLETON;\n import static org.nuxeo.ecm.core.io.registry.reflect.Priorities.REFERENCE;\n \n import java.io.IOException;\n \n import org.nuxeo.ecm.core.io.marshallers.json.ExtensibleEntityJsonWriter;\n import org.nuxeo.ecm.core.io.registry.reflect.Setup;\n+import org.nuxeo.runtime.capabilities.Capabilities;\n \n import com.fasterxml.jackson.core.JsonGenerator;\n \n /**\n  * @since 11.5\n  */\n @Setup(mode = SINGLETON, priority = REFERENCE)\n-public class ServerInfoJsonWriter extends ExtensibleEntityJsonWriter<ServerInfo> {\n+public class CapabilitiesJsonWriter extends ExtensibleEntityJsonWriter<Capabilities> {\n \n-    public static final String ENTITY_TYPE = \"server\";\n+    public static final String ENTITY_TYPE = \"capabilities\";\n \n-    public ServerInfoJsonWriter() {\n-        super(ENTITY_TYPE, ServerInfo.class);\n+    public CapabilitiesJsonWriter() {\n+        super(ENTITY_TYPE, Capabilities.class);\n     }\n \n     @Override\n-    protected void writeEntityBody(ServerInfo entity, JsonGenerator jg) throws IOException {\n-        jg.writeStringField(\"distributionName\", entity.getDistributionName());\n-        jg.writeStringField(\"distributionVersion\", entity.getDistributionVersion());\n-        jg.writeStringField(\"distributionServer\", entity.getDistributionServer());\n-        entity.getHotfixVersion().ifPresent(asConsumer(h -> jg.writeStringField(\"hotfixVersion\", h)));\n-        jg.writeBooleanField(\"clusterEnabled\", entity.isClusterEnabled());\n-        jg.writeStringField(\"clusterNodeId\", entity.getClusterNodeId());\n-\n+    protected void writeEntityBody(Capabilities entity, JsonGenerator jg) throws IOException {\n+        for (var entry : entity.get().entrySet()) {\n+            jg.writeObjectField(entry.getKey(), entry.getValue());\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13869fa58d07a68b7022126aadb6f85be7836157"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIxODg3MA==", "bodyText": "Add a bit of Javadoc", "url": "https://github.com/nuxeo/nuxeo/pull/4530#discussion_r539218870", "createdAt": "2020-12-09T11:14:10Z", "author": {"login": "efge"}, "path": "modules/runtime/nuxeo-runtime/src/main/java/org/nuxeo/runtime/capabilities/Capabilities.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+\n+package org.nuxeo.runtime.capabilities;\n+\n+import java.util.Map;\n+\n+/**\n+ * @since 11.5\n+ */\n+public class Capabilities {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13869fa58d07a68b7022126aadb6f85be7836157"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIxOTMxMQ==", "bodyText": "\"a capabilities\" is not grammatical", "url": "https://github.com/nuxeo/nuxeo/pull/4530#discussion_r539219311", "createdAt": "2020-12-09T11:14:43Z", "author": {"login": "efge"}, "path": "modules/runtime/nuxeo-runtime/src/main/java/org/nuxeo/runtime/capabilities/CapabilitiesService.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+\n+package org.nuxeo.runtime.capabilities;\n+\n+import java.util.Map;\n+import java.util.function.Supplier;\n+\n+/**\n+ * Service holding the server capabilities.\n+ *\n+ * @since 11.5\n+ */\n+public interface CapabilitiesService {\n+\n+    /**\n+     * Registers a capabilities.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13869fa58d07a68b7022126aadb6f85be7836157"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIyMTMyOA==", "bodyText": "This probably needs a getApplicationStartedOrder() with a very low value to be sure that all other services requiring it are started afterwards.", "url": "https://github.com/nuxeo/nuxeo/pull/4530#discussion_r539221328", "createdAt": "2020-12-09T11:17:48Z", "author": {"login": "efge"}, "path": "modules/runtime/nuxeo-runtime/src/main/java/org/nuxeo/runtime/capabilities/CapabilitiesServiceImpl.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+\n+package org.nuxeo.runtime.capabilities;\n+\n+import static java.util.stream.Collectors.collectingAndThen;\n+import static java.util.stream.Collectors.toMap;\n+import static org.apache.commons.lang3.StringUtils.isNotBlank;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_HOTFIX;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_NAME;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_SERVER;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_VERSION;\n+\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+import java.util.function.Supplier;\n+\n+import org.nuxeo.runtime.api.Framework;\n+import org.nuxeo.runtime.model.ComponentContext;\n+import org.nuxeo.runtime.model.ComponentManager;\n+import org.nuxeo.runtime.model.DefaultComponent;\n+\n+/**\n+ * @since 11.5\n+ */\n+public class CapabilitiesServiceImpl extends DefaultComponent implements CapabilitiesService {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13869fa58d07a68b7022126aadb6f85be7836157"}, "originalPosition": 43}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "13869fa58d07a68b7022126aadb6f85be7836157", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/13869fa58d07a68b7022126aadb6f85be7836157", "committedDate": "2020-12-09T11:03:05Z", "message": "NXP-29798: Implement a Capabilities Service"}, "afterCommit": {"oid": "c194676a4230f66ded688a0f121bb7c01bac7c38", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/c194676a4230f66ded688a0f121bb7c01bac7c38", "committedDate": "2020-12-09T13:31:16Z", "message": "NXP-29798: Implement a Capabilities Service"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c194676a4230f66ded688a0f121bb7c01bac7c38", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/c194676a4230f66ded688a0f121bb7c01bac7c38", "committedDate": "2020-12-09T13:31:16Z", "message": "NXP-29798: Implement a Capabilities Service"}, "afterCommit": {"oid": "5297e82ddaba7c329146b0d6395d1bb58128bba6", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/5297e82ddaba7c329146b0d6395d1bb58128bba6", "committedDate": "2020-12-09T13:46:40Z", "message": "NXP-29798: Implement a Capabilities Service"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5297e82ddaba7c329146b0d6395d1bb58128bba6", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/5297e82ddaba7c329146b0d6395d1bb58128bba6", "committedDate": "2020-12-09T13:46:40Z", "message": "NXP-29798: Implement a Capabilities Service"}, "afterCommit": {"oid": "82448c9a43dcd90ed1b1b3ab7f894e0e043492af", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/82448c9a43dcd90ed1b1b3ab7f894e0e043492af", "committedDate": "2020-12-09T13:57:21Z", "message": "NXP-29798: Implement a Capabilities Service"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MjA5NjIy", "url": "https://github.com/nuxeo/nuxeo/pull/4530#pullrequestreview-548209622", "createdAt": "2020-12-09T14:00:17Z", "commit": {"oid": "82448c9a43dcd90ed1b1b3ab7f894e0e043492af"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "82448c9a43dcd90ed1b1b3ab7f894e0e043492af", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/82448c9a43dcd90ed1b1b3ab7f894e0e043492af", "committedDate": "2020-12-09T13:57:21Z", "message": "NXP-29798: Implement a Capabilities Service"}, "afterCommit": {"oid": "96360a0d6f0197f8b41d193cede6a3e242e23ff4", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/96360a0d6f0197f8b41d193cede6a3e242e23ff4", "committedDate": "2020-12-11T09:04:55Z", "message": "NXP-29798: Implement a Capabilities Service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c172814b95725da89181eb88a216a8df248a4da", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/1c172814b95725da89181eb88a216a8df248a4da", "committedDate": "2020-12-14T16:18:02Z", "message": "NXP-29798: Implement a Capabilities Service"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "96360a0d6f0197f8b41d193cede6a3e242e23ff4", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/96360a0d6f0197f8b41d193cede6a3e242e23ff4", "committedDate": "2020-12-11T09:04:55Z", "message": "NXP-29798: Implement a Capabilities Service"}, "afterCommit": {"oid": "1c172814b95725da89181eb88a216a8df248a4da", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/1c172814b95725da89181eb88a216a8df248a4da", "committedDate": "2020-12-14T16:18:02Z", "message": "NXP-29798: Implement a Capabilities Service"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMzIxMjcx", "url": "https://github.com/nuxeo/nuxeo/pull/4530#pullrequestreview-552321271", "createdAt": "2020-12-15T10:42:53Z", "commit": {"oid": "1c172814b95725da89181eb88a216a8df248a4da"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNjc3NDgx", "url": "https://github.com/nuxeo/nuxeo/pull/4530#pullrequestreview-552677481", "createdAt": "2020-12-15T17:06:36Z", "commit": {"oid": "1c172814b95725da89181eb88a216a8df248a4da"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2OTAzMDU0", "url": "https://github.com/nuxeo/nuxeo/pull/4530#pullrequestreview-556903054", "createdAt": "2020-12-22T08:31:48Z", "commit": {"oid": "1c172814b95725da89181eb88a216a8df248a4da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwODozMTo0OFrOIJyr8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwODozMTo0OFrOIJyr8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzEzODU0Ng==", "bodyText": "FYI this listener should be uninstalled too: in unit tests i see mutliple instances of this listener being piled up on the component manager (working on #4544)", "url": "https://github.com/nuxeo/nuxeo/pull/4530#discussion_r547138546", "createdAt": "2020-12-22T08:31:48Z", "author": {"login": "atchertchian"}, "path": "modules/runtime/nuxeo-runtime/src/main/java/org/nuxeo/runtime/capabilities/CapabilitiesServiceImpl.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+\n+package org.nuxeo.runtime.capabilities;\n+\n+import static java.util.stream.Collectors.collectingAndThen;\n+import static java.util.stream.Collectors.toMap;\n+import static org.apache.commons.lang3.StringUtils.isNotBlank;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_HOTFIX;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_NAME;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_SERVER;\n+import static org.nuxeo.common.Environment.DISTRIBUTION_VERSION;\n+\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+import java.util.function.Supplier;\n+\n+import org.nuxeo.runtime.api.Framework;\n+import org.nuxeo.runtime.model.ComponentContext;\n+import org.nuxeo.runtime.model.ComponentManager;\n+import org.nuxeo.runtime.model.ComponentStartOrders;\n+import org.nuxeo.runtime.model.DefaultComponent;\n+\n+/**\n+ * @since 11.5\n+ */\n+public class CapabilitiesServiceImpl extends DefaultComponent implements CapabilitiesService {\n+\n+    public static final String CAPABILITY_SERVER = \"server\";\n+\n+    protected final Map<String, Supplier<Map<String, Object>>> capabilitiesSuppliers = new HashMap<>();\n+\n+    @Override\n+    public void activate(ComponentContext context) {\n+        super.activate(context);\n+        new ComponentManager.Listener() {\n+            @Override\n+            public void beforeStart(ComponentManager mgr, boolean isResume) {\n+                capabilitiesSuppliers.clear();\n+            }\n+        }.install();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c172814b95725da89181eb88a216a8df248a4da"}, "originalPosition": 58}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4912, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}