{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4NDI4NTY1", "number": 3969, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQwOToxNzozN1rOD1rYsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNDoyNzozM1rOD1zUiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3NjExOTU0OnYy", "diffSide": "RIGHT", "path": "modules/platform/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQwOToxNzozN1rOGLOf1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMDowNzozNlrOGLQcCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQyNTA0NQ==", "bodyText": "body can be removed, right?", "url": "https://github.com/nuxeo/nuxeo/pull/3969#discussion_r414425045", "createdAt": "2020-04-24T09:17:37Z", "author": {"login": "BoboTiG"}, "path": "modules/platform/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java", "diffHunk": "@@ -434,6 +436,28 @@ public Response getBatchExtraInfo(@PathParam(REQUEST_BATCH_ID) String batchId) t\n         return buildResponse(Status.OK, result);\n     }\n \n+    /** @since 11.1 */\n+    @POST\n+    @Path(\"{batchId}/refresh\")\n+    public Response refreshToken(@PathParam(REQUEST_BATCH_ID) String batchId,\n+            String body) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a23f0431ff67ea70a85109d0b8052898e4f26efc"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ1Njg0Mw==", "bodyText": "unused, yep", "url": "https://github.com/nuxeo/nuxeo/pull/3969#discussion_r414456843", "createdAt": "2020-04-24T10:07:36Z", "author": {"login": "ataillefer"}, "path": "modules/platform/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java", "diffHunk": "@@ -434,6 +436,28 @@ public Response getBatchExtraInfo(@PathParam(REQUEST_BATCH_ID) String batchId) t\n         return buildResponse(Status.OK, result);\n     }\n \n+    /** @since 11.1 */\n+    @POST\n+    @Path(\"{batchId}/refresh\")\n+    public Response refreshToken(@PathParam(REQUEST_BATCH_ID) String batchId,\n+            String body) throws IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQyNTA0NQ=="}, "originalCommit": {"oid": "a23f0431ff67ea70a85109d0b8052898e4f26efc"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3NjM0NTQyOnYy", "diffSide": "RIGHT", "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/test/java/org/nuxeo/ecm/core/storage/sql/TestS3DirectBatchHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMDoxMDo0OFrOGLQj_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMzowODo0N1rOGLW3aQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ1ODg3Nw==", "bodyText": "Better to use awaitility instead, see https://github.com/nuxeo/nuxeo/blob/master/modules/platform/nuxeo-platform-tag-service/nuxeo-platform-tag-core/src/test/java/org/nuxeo/ecm/platform/tag/AbstractTestTagService.java#L120 for instance.", "url": "https://github.com/nuxeo/nuxeo/pull/3969#discussion_r414458877", "createdAt": "2020-04-24T10:10:48Z", "author": {"login": "ataillefer"}, "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/test/java/org/nuxeo/ecm/core/storage/sql/TestS3DirectBatchHandler.java", "diffHunk": "@@ -162,6 +164,51 @@ public void test20MB() throws SdkBaseException, InterruptedException {\n         test(\"s3\", 20 * 1024 * 1024);\n     }\n \n+    @Test\n+    @Deploy(\"org.nuxeo.ecm.core.storage.binarymanager.s3.tests:OSGI-INF/test-s3directupload-contrib.xml\")\n+    public void testTokenRenewal() throws SdkBaseException, InterruptedException {\n+        // Test that refreshing tokens actually returns back valid and different tokens.\n+        S3DirectBatchHandler handler = (S3DirectBatchHandler) batchManager.getHandler(\"s3\");\n+        Batch newBatch = handler.newBatch(null);\n+        Batch batch = handler.getBatch(newBatch.getKey());\n+\n+        // Save current details\n+        Map<String, Object> properties = batch.getProperties();\n+        String secretKeyId = (String) properties.get(S3DirectBatchHandler.INFO_AWS_SECRET_KEY_ID);\n+        String secretAccessKey = (String) properties.get(S3DirectBatchHandler.INFO_AWS_SECRET_ACCESS_KEY);\n+        String sessionToken = (String) properties.get(S3DirectBatchHandler.INFO_AWS_SESSION_TOKEN);\n+        Long expiration = (Long) properties.get(S3DirectBatchHandler.INFO_EXPIRATION);\n+\n+        // Wait for some time else the new expiration will not be updated\n+        Thread.sleep(1000); // 1s", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a23f0431ff67ea70a85109d0b8052898e4f26efc"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU2MjE1Mw==", "bodyText": "I finally removed that logic, it would introduce random failures. The new check is less error prone.", "url": "https://github.com/nuxeo/nuxeo/pull/3969#discussion_r414562153", "createdAt": "2020-04-24T13:08:47Z", "author": {"login": "BoboTiG"}, "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/test/java/org/nuxeo/ecm/core/storage/sql/TestS3DirectBatchHandler.java", "diffHunk": "@@ -162,6 +164,51 @@ public void test20MB() throws SdkBaseException, InterruptedException {\n         test(\"s3\", 20 * 1024 * 1024);\n     }\n \n+    @Test\n+    @Deploy(\"org.nuxeo.ecm.core.storage.binarymanager.s3.tests:OSGI-INF/test-s3directupload-contrib.xml\")\n+    public void testTokenRenewal() throws SdkBaseException, InterruptedException {\n+        // Test that refreshing tokens actually returns back valid and different tokens.\n+        S3DirectBatchHandler handler = (S3DirectBatchHandler) batchManager.getHandler(\"s3\");\n+        Batch newBatch = handler.newBatch(null);\n+        Batch batch = handler.getBatch(newBatch.getKey());\n+\n+        // Save current details\n+        Map<String, Object> properties = batch.getProperties();\n+        String secretKeyId = (String) properties.get(S3DirectBatchHandler.INFO_AWS_SECRET_KEY_ID);\n+        String secretAccessKey = (String) properties.get(S3DirectBatchHandler.INFO_AWS_SECRET_ACCESS_KEY);\n+        String sessionToken = (String) properties.get(S3DirectBatchHandler.INFO_AWS_SESSION_TOKEN);\n+        Long expiration = (Long) properties.get(S3DirectBatchHandler.INFO_EXPIRATION);\n+\n+        // Wait for some time else the new expiration will not be updated\n+        Thread.sleep(1000); // 1s", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ1ODg3Nw=="}, "originalCommit": {"oid": "a23f0431ff67ea70a85109d0b8052898e4f26efc"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3NzQwOTQ2OnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-automation/nuxeo-automation-server/src/main/java/org/nuxeo/ecm/automation/server/jaxrs/batch/handler/impl/DefaultBatchHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNDoyNTozMFrOGLaOyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNDo1Mzo1NVrOGLbj0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYxNzI5MA==", "bodyText": "You should move this to a default method in the interface as others may have custom batch handlers. Adapt the message of course (the default -> this).", "url": "https://github.com/nuxeo/nuxeo/pull/3969#discussion_r414617290", "createdAt": "2020-04-24T14:25:30Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-automation/nuxeo-automation-server/src/main/java/org/nuxeo/ecm/automation/server/jaxrs/batch/handler/impl/DefaultBatchHandler.java", "diffHunk": "@@ -55,4 +56,9 @@ public boolean completeUpload(String batchId, String fileIndex, BatchFileInfo fi\n                 && Objects.equals(fileEntry.getBlob().getDigest(), fileInfo.getMd5());\n     }\n \n+    @Override\n+    public Map<String, Object> refreshToken(String batchId) {\n+        throw new UnsupportedOperationException(\"Refresh token is not supported for the default batch handler.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b15cd8e72d3825e832080f9b45f29e69e91f4316"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYzOTA1OA==", "bodyText": "[For the history of that specific ticket] It has been decided to use default only for backports.", "url": "https://github.com/nuxeo/nuxeo/pull/3969#discussion_r414639058", "createdAt": "2020-04-24T14:53:55Z", "author": {"login": "BoboTiG"}, "path": "modules/platform/nuxeo-automation/nuxeo-automation-server/src/main/java/org/nuxeo/ecm/automation/server/jaxrs/batch/handler/impl/DefaultBatchHandler.java", "diffHunk": "@@ -55,4 +56,9 @@ public boolean completeUpload(String batchId, String fileIndex, BatchFileInfo fi\n                 && Objects.equals(fileEntry.getBlob().getDigest(), fileInfo.getMd5());\n     }\n \n+    @Override\n+    public Map<String, Object> refreshToken(String batchId) {\n+        throw new UnsupportedOperationException(\"Refresh token is not supported for the default batch handler.\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYxNzI5MA=="}, "originalCommit": {"oid": "b15cd8e72d3825e832080f9b45f29e69e91f4316"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3NzQxOTYzOnYy", "diffSide": "RIGHT", "path": "modules/platform/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNDoyNzozM1rOGLaU-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNDoyNzozM1rOGLaU-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYxODg3Mw==", "bodyText": "I'd call it /refreshToken to be more explicit. \"refresh\" in the context of a batch upload does not immediately evoke the auth token.", "url": "https://github.com/nuxeo/nuxeo/pull/3969#discussion_r414618873", "createdAt": "2020-04-24T14:27:33Z", "author": {"login": "efge"}, "path": "modules/platform/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java", "diffHunk": "@@ -434,6 +436,27 @@ public Response getBatchExtraInfo(@PathParam(REQUEST_BATCH_ID) String batchId) t\n         return buildResponse(Status.OK, result);\n     }\n \n+    /** @since 11.1 */\n+    @POST\n+    @Path(\"{batchId}/refresh\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b15cd8e72d3825e832080f9b45f29e69e91f4316"}, "originalPosition": 29}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4183, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}