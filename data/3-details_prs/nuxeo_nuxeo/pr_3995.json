{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEyODc5OTk1", "number": 3995, "title": "Fix nxp 29066 Init of the ACL document root occurs many times", "bodyText": "T&P: https://qa2.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-saouana-10.10/129/\nT&P MongoDB: https://qa2.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-saouana-10.10-2/7/\nContext\nInitially this PR was open to fix  NXP-29048 which is a race condition issue that happens only in the test context. But to fix the problem that was initially introduced by the fix here This new fix allows us to see the problem of the race condition that happens when we add @Deploy on the test (see NXP-29048).\nBut with the new fix the root acl init will occurs each time, which is not the expected behaviour, we should init the acl only once, as it was before the fix. But we should be able to add new entry in the template.\nto recap:\nTo fix the issue introduced by  NXP-28958 on init the acl many times. I created a new   NXP-29066.\nthis fix should also fix the failure test on MongoDB, because now once we @Deploy run it will not reinit the Acl for a second time and it will avoid the race condition that occurs.", "createdAt": "2020-05-04T10:57:20Z", "url": "https://github.com/nuxeo/nuxeo/pull/3995", "merged": true, "mergeCommit": {"oid": "f0be9ca5f6ee3380b07ea749b26d1a1b90c181bb"}, "closed": true, "closedAt": "2020-05-05T15:25:18Z", "author": {"login": "RSalem07"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABceAKhPABqjMzMDAwNzk4MzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABceVUoUgFqTQwNTg3MDEzMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "75200fd33862ca04d9f1ca36f49c4010bedb3ad9", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/75200fd33862ca04d9f1ca36f49c4010bedb3ad9", "committedDate": "2020-05-04T10:55:42Z", "message": " NXP-29048: Init only once the root template acl"}, "afterCommit": {"oid": "c5370d74b88dc462dba6a3819c9318654e65c962", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/c5370d74b88dc462dba6a3819c9318654e65c962", "committedDate": "2020-05-04T14:12:56Z", "message": " NXP-29048: Init only once the root template acl"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MDc2MTA4", "url": "https://github.com/nuxeo/nuxeo/pull/3995#pullrequestreview-405076108", "createdAt": "2020-05-04T15:05:16Z", "commit": {"oid": "c5370d74b88dc462dba6a3819c9318654e65c962"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NDczNzIz", "url": "https://github.com/nuxeo/nuxeo/pull/3995#pullrequestreview-405473723", "createdAt": "2020-05-05T03:28:36Z", "commit": {"oid": "c5370d74b88dc462dba6a3819c9318654e65c962"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c5370d74b88dc462dba6a3819c9318654e65c962", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/c5370d74b88dc462dba6a3819c9318654e65c962", "committedDate": "2020-05-04T14:12:56Z", "message": " NXP-29048: Init only once the root template acl"}, "afterCommit": {"oid": "e40533982b952aa203d1a536725aaf3eaff35fd1", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/e40533982b952aa203d1a536725aaf3eaff35fd1", "committedDate": "2020-05-05T10:26:38Z", "message": "NXP-29048: Init only once the root template acl"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e40533982b952aa203d1a536725aaf3eaff35fd1", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/e40533982b952aa203d1a536725aaf3eaff35fd1", "committedDate": "2020-05-05T10:26:38Z", "message": "NXP-29048: Init only once the root template acl"}, "afterCommit": {"oid": "df678388a19256014a2d284bcd8a6738fed95ffa", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/df678388a19256014a2d284bcd8a6738fed95ffa", "committedDate": "2020-05-05T10:40:21Z", "message": "NXP-29066: Init only once the root template acl"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "df678388a19256014a2d284bcd8a6738fed95ffa", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/df678388a19256014a2d284bcd8a6738fed95ffa", "committedDate": "2020-05-05T10:40:21Z", "message": "NXP-29066: Init only once the root template acl"}, "afterCommit": {"oid": "acb38334b62f0f792535aa94dfb432354c5e8905", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/acb38334b62f0f792535aa94dfb432354c5e8905", "committedDate": "2020-05-05T11:08:31Z", "message": "NXP-29066: Init only once the root template acl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f33dc0fc07265c4c440c81ad5b7fe68c0684401", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/6f33dc0fc07265c4c440c81ad5b7fe68c0684401", "committedDate": "2020-05-05T11:27:50Z", "message": "NXP-29066: Init only once the root template acl"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "acb38334b62f0f792535aa94dfb432354c5e8905", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/acb38334b62f0f792535aa94dfb432354c5e8905", "committedDate": "2020-05-05T11:08:31Z", "message": "NXP-29066: Init only once the root template acl"}, "afterCommit": {"oid": "6f33dc0fc07265c4c440c81ad5b7fe68c0684401", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/6f33dc0fc07265c4c440c81ad5b7fe68c0684401", "committedDate": "2020-05-05T11:27:50Z", "message": "NXP-29066: Init only once the root template acl"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1ODA5NDc2", "url": "https://github.com/nuxeo/nuxeo/pull/3995#pullrequestreview-405809476", "createdAt": "2020-05-05T13:52:48Z", "commit": {"oid": "6f33dc0fc07265c4c440c81ad5b7fe68c0684401"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1ODY3NDQ0", "url": "https://github.com/nuxeo/nuxeo/pull/3995#pullrequestreview-405867444", "createdAt": "2020-05-05T14:51:37Z", "commit": {"oid": "6f33dc0fc07265c4c440c81ad5b7fe68c0684401"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNDo1MTozN1rOGQtOAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNDo1MTozN1rOGQtOAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE3MTI2Ng==", "bodyText": "In the future please use L instead of l for readability. l is very easily confused with 1.", "url": "https://github.com/nuxeo/nuxeo/pull/3995#discussion_r420171266", "createdAt": "2020-05-05T14:51:37Z", "author": {"login": "efge"}, "path": "nuxeo-features/nuxeo-platform-audit/nuxeo-platform-audit-core/src/test/java/org/nuxeo/ecm/platform/audit/TestSimpleTemplateBasedRootAudit.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Salem Aouana\n+ */\n+\n+package org.nuxeo.ecm.platform.audit;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.io.Serializable;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.PathRef;\n+import org.nuxeo.ecm.core.api.security.ACE;\n+import org.nuxeo.ecm.core.api.security.ACL;\n+import org.nuxeo.ecm.core.api.security.ACP;\n+import org.nuxeo.ecm.platform.audit.api.LogEntry;\n+import org.nuxeo.ecm.platform.query.api.PageProvider;\n+import org.nuxeo.ecm.platform.query.api.PageProviderService;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+\n+/**\n+ * The root init acl which happens at\n+ * {@link org.nuxeo.ecm.platform.content.template.factories.SimpleTemplateBasedRootFactory}. Should occur only once, at\n+ * the beginning when we add the first children of the root document.\n+ * <p>\n+ * Deploying a new contribution for a given test method, will call the {@code SimpleTemplateBasedRootFactory} for a\n+ * second time, but as the root documents already contains children, we should not init the acl of the root document.\n+ * \n+ * @since 11.1\n+ */\n+@RunWith(FeaturesRunner.class)\n+@Features(AuditFeature.class)\n+public class TestSimpleTemplateBasedRootAudit {\n+\n+    @Inject\n+    protected CoreSession session;\n+\n+    @Inject\n+    protected PageProviderService pps;\n+\n+    @Test\n+    @Deploy(\"org.nuxeo.ecm.platform.audit.tests:test-add-content-template-contrib.xml\")\n+    public void shouldInitRootAclOnlyOnce() {\n+        DocumentModel root = session.getDocument(new PathRef(\"/\"));\n+        @SuppressWarnings(\"unchecked\")\n+        PageProvider<LogEntry> pp = (PageProvider<LogEntry>) pps.getPageProvider(\"DOCUMENT_HISTORY_PROVIDER\", null, 3l,\n+                0l, new HashMap<String, Serializable>(), root);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f33dc0fc07265c4c440c81ad5b7fe68c0684401"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1ODcwMTMz", "url": "https://github.com/nuxeo/nuxeo/pull/3995#pullrequestreview-405870133", "createdAt": "2020-05-05T14:54:21Z", "commit": {"oid": "6f33dc0fc07265c4c440c81ad5b7fe68c0684401"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4792, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}