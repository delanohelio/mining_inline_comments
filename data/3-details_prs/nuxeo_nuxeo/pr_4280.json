{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1MzA1ODQ2", "number": 4280, "title": "Fix nxp 29596 fail pr build on dev unit tests failure", "bodyText": "", "createdAt": "2020-08-28T09:51:20Z", "url": "https://github.com/nuxeo/nuxeo/pull/4280", "merged": true, "mergeCommit": {"oid": "3da2f4a51fc37a667b9927e81e7262e1d0ef57f0"}, "closed": true, "closedAt": "2020-08-28T15:58:37Z", "author": {"login": "ataillefer"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDRxnJgH2gAyNDc1MzA1ODQ2OjYzZGIxNTdiMTlhNGYwNTBmY2JhYjNjY2VlNjJkNjg0OGU3ZWVhZjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdDVP5tgFqTQ3NzczOTk3NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "63db157b19a4f050fcbab3ccee62d6848e7eeaf5", "author": {"user": {"login": "ataillefer", "name": "Antoine Taillefer"}}, "url": "https://github.com/nuxeo/nuxeo/commit/63db157b19a4f050fcbab3ccee62d6848e7eeaf5", "committedDate": "2020-08-28T09:41:35Z", "message": "NXP-29596: Fix workaround to only fail a PR build if dev unit tests fail\n\nThrowing a new Exception fails with `Scripts not permitted to use new java.lang.Exception java.lang.String java.lang.Throwable.`\nRather than adding this to Jenkins' script approvals, let's use the `error` step. The only difference is that the step avoids printing the stack trace."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "112e0df451c21ea64e9a738d4cdec6ad0cc66cd6", "author": {"user": {"login": "ataillefer", "name": "Antoine Taillefer"}}, "url": "https://github.com/nuxeo/nuxeo/commit/112e0df451c21ea64e9a738d4cdec6ad0cc66cd6", "committedDate": "2020-08-28T09:41:35Z", "message": "NXP-29596: Add logs in case of unit tests failure on a PR build"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3NTk4Nzkx", "url": "https://github.com/nuxeo/nuxeo/pull/4280#pullrequestreview-477598791", "createdAt": "2020-08-28T09:53:11Z", "commit": {"oid": "112e0df451c21ea64e9a738d4cdec6ad0cc66cd6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3NjE5NjA2", "url": "https://github.com/nuxeo/nuxeo/pull/4280#pullrequestreview-477619606", "createdAt": "2020-08-28T10:27:35Z", "commit": {"oid": "112e0df451c21ea64e9a738d4cdec6ad0cc66cd6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3NzM5OTI0", "url": "https://github.com/nuxeo/nuxeo/pull/4280#pullrequestreview-477739924", "createdAt": "2020-08-28T13:44:19Z", "commit": {"oid": "112e0df451c21ea64e9a738d4cdec6ad0cc66cd6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxMzo0NDoyMFrOHJGZwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxMzo0NDoyMFrOHJGZwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTMwNDEzMA==", "bodyText": "https://www.jenkins.io/doc/pipeline/steps/workflow-basic-steps/#error-error-signal\nsais error aborts the build and avoids printing the stack trace. But since you are printing the error message anyway, why not sticking with the one-liner throw?", "url": "https://github.com/nuxeo/nuxeo/pull/4280#discussion_r479304130", "createdAt": "2020-08-28T13:44:20Z", "author": {"login": "NourNuxeo"}, "path": "ci/Jenkinsfiles/build.groovy", "diffHunk": "@@ -295,7 +295,9 @@ def buildUnitTestStage(env) {\n             }\n           } catch(err) {\n             // TODO NXP-29512: workaround to know which env is failing later on\n-            throw new Exception(\"${env}: ${err.message}\", err)\n+            def errorMessage = \"${env}: ${err.message}\"\n+            echo \"Throwing error with message: ${errorMessage}\"\n+            error \"${errorMessage}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "112e0df451c21ea64e9a738d4cdec6ad0cc66cd6"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3NzM5OTc0", "url": "https://github.com/nuxeo/nuxeo/pull/4280#pullrequestreview-477739974", "createdAt": "2020-08-28T13:44:23Z", "commit": {"oid": "112e0df451c21ea64e9a738d4cdec6ad0cc66cd6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxMzo0NDoyM1rOHJGZ7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxMzo0NDoyM1rOHJGZ7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTMwNDE3Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            Waiting for NXP-29512, on a PR, the build continues even if there is a unit test error in other\n          \n          \n            \n                            environments than the dev one.\n          \n          \n            \n                            While waiting for NXP-29512 to be resolved, the build in non-dev environment continues even if there are unit test error.", "url": "https://github.com/nuxeo/nuxeo/pull/4280#discussion_r479304173", "createdAt": "2020-08-28T13:44:23Z", "author": {"login": "NourNuxeo"}, "path": "ci/Jenkinsfiles/build.groovy", "diffHunk": "@@ -536,10 +538,17 @@ pipeline {\n           try {\n             parallel stages\n           } catch (err) {\n-            // TODO NXP-29512: on PR, make the build continue even if there is a test error\n+            // TODO NXP-29512: on a PR, make the build continue even if there is a test error\n             // on other environments than the dev one\n             // to remove when all test environments will be mandatory\n-            if (!isPullRequest() || err.message.startsWith(\"dev:\")) {\n+            def errorMessage = err.message\n+            if (isPullRequest() && !errorMessage.startsWith(\"dev:\")) {\n+              echo \"\"\"\n+                Unit tests error: ${errorMessage}\n+                Waiting for NXP-29512, on a PR, the build continues even if there is a unit test error in other\n+                environments than the dev one.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "112e0df451c21ea64e9a738d4cdec6ad0cc66cd6"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4964, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}