{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczMDE5MjM4", "number": 3735, "title": "Fix nxp 28620 fix comment migration failure", "bodyText": "PR opened manually, i launched twice the T&P (but in Dry Run).\nT&P ->OK -> https://qa.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-saouana/197/\nand a new T&P -> OK -> https://qa.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-saouana/199/\nand the last one before merging:\nhttps://qa.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-saouana/202/", "createdAt": "2020-02-10T09:12:06Z", "url": "https://github.com/nuxeo/nuxeo/pull/3735", "merged": true, "mergeCommit": {"oid": "143aa6ca3ef2debdcb4b109a388fb5de559705ed"}, "closed": true, "closedAt": "2020-02-13T12:15:36Z", "author": {"login": "RSalem07"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcC5sGGgFqTM1NTc4NzA5OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDn-wdAFqTM1NzU0MTE5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1Nzg3MDk5", "url": "https://github.com/nuxeo/nuxeo/pull/3735#pullrequestreview-355787099", "createdAt": "2020-02-10T09:26:41Z", "commit": {"oid": "79267f5373a8ff6849f17e4daad5e056ea497a10"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1Nzk0MzIx", "url": "https://github.com/nuxeo/nuxeo/pull/3735#pullrequestreview-355794321", "createdAt": "2020-02-10T09:37:38Z", "commit": {"oid": "79267f5373a8ff6849f17e4daad5e056ea497a10"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwOTozNzozOFrOFnfQwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwOTozNzozOFrOFnfQwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk1MDk3Ng==", "bodyText": "because its parent. his is for humans", "url": "https://github.com/nuxeo/nuxeo/pull/3735#discussion_r376950976", "createdAt": "2020-02-10T09:37:38Z", "author": {"login": "NourNuxeo"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/java/org/nuxeo/ecm/platform/comment/impl/CommentsMigrator.java", "diffHunk": "@@ -250,6 +250,13 @@ protected void migrateCommentsFromPropertyToSecured(CoreSession session, Comment\n         }\n \n         DocumentRef parentDocRef = new IdRef(parentId);\n+        if (!session.exists(parentDocRef)) {\n+            log.warn(\n+                    \"The comment document model with IdRef: {} cannot be migrated, because his parent: {} cannot be found\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79267f5373a8ff6849f17e4daad5e056ea497a10"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "79267f5373a8ff6849f17e4daad5e056ea497a10", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/79267f5373a8ff6849f17e4daad5e056ea497a10", "committedDate": "2020-02-07T10:23:48Z", "message": "NXP-28620: Fix Comment Migration failure"}, "afterCommit": {"oid": "c85a64bd7174b4f969d77311e774541caec56285", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/c85a64bd7174b4f969d77311e774541caec56285", "committedDate": "2020-02-10T10:48:25Z", "message": "NXP-28620: Fix Comment Migration failure"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2NzI0MDI5", "url": "https://github.com/nuxeo/nuxeo/pull/3735#pullrequestreview-356724029", "createdAt": "2020-02-11T14:56:57Z", "commit": {"oid": "c85a64bd7174b4f969d77311e774541caec56285"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2NzQ5MTg4", "url": "https://github.com/nuxeo/nuxeo/pull/3735#pullrequestreview-356749188", "createdAt": "2020-02-11T15:26:01Z", "commit": {"oid": "c85a64bd7174b4f969d77311e774541caec56285"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNToyNjowMlrOFoNWQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNToyNjowMlrOFoNWQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcwNjA1MQ==", "bodyText": "You assert everything has been caught (the 51 warns) but you don't assert there are only 51 (no duplicates, erronous messages). Maybe that would be overkill ? I leave it to you !", "url": "https://github.com/nuxeo/nuxeo/pull/3735#discussion_r377706051", "createdAt": "2020-02-11T15:26:02Z", "author": {"login": "NourNuxeo"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/TestCommentsMigrator.java", "diffHunk": "@@ -233,6 +236,48 @@ public void testMigrationFromPropertyToSecuredWithCommentsNotCorrectlyFilled() {\n             assertTrue(caughtEventMessages.contains(message));\n             assertTrue(session.exists(new IdRef(docId)));\n         }\n+\n+    }\n+\n+    /**\n+     * Test the migration in the case where the {@code comment:parentId} is not empty, but it doesn't exist.\n+     */\n+    @Test\n+    @LogCaptureFeature.FilterOn(logLevel = \"WARN\")\n+    @Deploy(\"org.nuxeo.ecm.platform.comment.tests:OSGI-INF/disable-removing-comment-children-listener.xml\")\n+    public void testMigrationFromPropertyToSecuredWithRemovedParentComment() {\n+        // NB_COMMENTS_BY_FILE*4 + NB_COMMENT_TO_REPLY_ON_IT*NB_REPLY_BY_COMMENT (5 levels of reply) = 200 + 50\n+        createCommentsAsProperty(false, true);\n+\n+        // Second step of migrate: from 'Property' to 'Secured'\n+        migrateFromPropertyToSecured(new CommentsMigrator(), false, true);\n+        transactionalFeature.nextTransaction();\n+\n+        List<LogEvent> events = logCaptureResult.getCaughtEvents();\n+        assertEquals(NB_COMMENTS_BY_FILE + 1, events.size());\n+\n+        String query = String.format(\"SELECT %s FROM Comment WHERE %s = '%s'\", ECM_UUID, COMMENT_PARENT_ID,\n+                fileToCommentAndRemove.getId());\n+        List<String> unMigratedCommentDocIds = session.queryProjection(query, 0, 0)\n+                                                      .stream()\n+                                                      .map(m -> (String) m.get(ECM_UUID))\n+                                                      .collect(Collectors.toList());\n+\n+        // The comments not migrated should be there but, not under 'fileToCommentAndRemove'\n+        assertEquals(NB_COMMENTS_BY_FILE, unMigratedCommentDocIds.size());\n+        List<String> caughtEventMessages = logCaptureResult.getCaughtEventMessages();\n+\n+        assertTrue(caughtEventMessages.contains(String.format(\n+                \"Some comments have not been migrated, see logs for more information. The folder containing these comments will be renamed to %s\",\n+                UNMIGRATED_COMMENTS_FOLDER_NAME)));\n+\n+        for (String docId : unMigratedCommentDocIds) {\n+            String message = String.format(\n+                    \"The comment document model with IdRef: %s cannot be migrated, because its parent: %s cannot be found\",\n+                    docId, fileToCommentAndRemove.getId());\n+            assertTrue(caughtEventMessages.contains(message));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c85a64bd7174b4f969d77311e774541caec56285"}, "originalPosition": 105}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MzYzNjg1", "url": "https://github.com/nuxeo/nuxeo/pull/3735#pullrequestreview-357363685", "createdAt": "2020-02-12T11:02:26Z", "commit": {"oid": "c85a64bd7174b4f969d77311e774541caec56285"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxMTowMjoyN1rOFoqWlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxMTowMjoyN1rOFoqWlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE4MTI2OA==", "bodyText": "Not sure about this change.", "url": "https://github.com/nuxeo/nuxeo/pull/3735#discussion_r378181268", "createdAt": "2020-02-12T11:02:27Z", "author": {"login": "kevinleturc"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/java/org/nuxeo/ecm/platform/comment/impl/CommentsMigrator.java", "diffHunk": "@@ -215,22 +215,22 @@ protected void migrateSessionPropertyToSecured(CoreSession session, MigrationCon\n \n             session.removeDocuments(documentsToRemove);\n \n-            reportProgress(\"Done Migrating from Property to Secured\", totalOfComments, totalOfComments);\n+            reportProgress(\"Done Migration from Property to Secured\", totalOfComments, totalOfComments);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c85a64bd7174b4f969d77311e774541caec56285"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3207438757649752625f73af4896302f0c7cec90", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/3207438757649752625f73af4896302f0c7cec90", "committedDate": "2020-02-12T13:24:45Z", "message": "NXP-28620: Cleanup / Format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5422a4bdd9792f109f9f2337afdb86562354200b", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/5422a4bdd9792f109f9f2337afdb86562354200b", "committedDate": "2020-02-12T13:24:45Z", "message": "NXP-28620: Fix Comment Migration failure"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c85a64bd7174b4f969d77311e774541caec56285", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/c85a64bd7174b4f969d77311e774541caec56285", "committedDate": "2020-02-10T10:48:25Z", "message": "NXP-28620: Fix Comment Migration failure"}, "afterCommit": {"oid": "5422a4bdd9792f109f9f2337afdb86562354200b", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/5422a4bdd9792f109f9f2337afdb86562354200b", "committedDate": "2020-02-12T13:24:45Z", "message": "NXP-28620: Fix Comment Migration failure"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3NDU4ODM0", "url": "https://github.com/nuxeo/nuxeo/pull/3735#pullrequestreview-357458834", "createdAt": "2020-02-12T13:42:13Z", "commit": {"oid": "5422a4bdd9792f109f9f2337afdb86562354200b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3NTQxMTk0", "url": "https://github.com/nuxeo/nuxeo/pull/3735#pullrequestreview-357541194", "createdAt": "2020-02-12T15:22:42Z", "commit": {"oid": "5422a4bdd9792f109f9f2337afdb86562354200b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4846, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}