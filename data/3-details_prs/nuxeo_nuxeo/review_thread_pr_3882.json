{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2OTg2Mzkz", "number": 3882, "reviewThreads": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNToyNzo0N1rODtlaUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMDowNjoyNFrODvDrdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MTI1NDU5OnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/repository/SnapshotPersister.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNToyNzo0N1rOF_GE4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNTowNTo1OVrOGAZi7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcwNDE2Mw==", "bodyText": "Could be simplified to:\nString id = ei.getId();\ncomps.computeIfPresent(id, (k,v) -> v + 1);\ncomps.computeIfAbsent(id, k -> Integer.valueOf(0));", "url": "https://github.com/nuxeo/nuxeo/pull/3882#discussion_r401704163", "createdAt": "2020-04-01T15:27:47Z", "author": {"login": "kevinleturc"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/repository/SnapshotPersister.java", "diffHunk": "@@ -302,8 +303,16 @@ public void persistComponent(DistributionSnapshot snapshot, ComponentInfo ci, Co\n         for (ExtensionPointInfo epi : ci.getExtensionPoints()) {\n             createExtensionPointDoc(snapshot, session, label, epi, componentDoc);\n         }\n+        Map<String, Integer> comps = new HashMap<String, Integer>();\n         for (ExtensionInfo ei : ci.getExtensions()) {\n-            createContributionDoc(snapshot, session, label, ei, componentDoc);\n+            // handle multiple contributions to the same extension point\n+            String id = ei.getId();\n+            if (comps.containsKey(id)) {\n+                comps.put(id, comps.get(id) + 1);\n+            } else {\n+                comps.put(id, Integer.valueOf(0));\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88eabbeefcad092f239936ed34b6300e0e8cd568"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcyNTEwMQ==", "bodyText": "done, thanks, any suggestion about the similar change in RuntimeSnapshot?", "url": "https://github.com/nuxeo/nuxeo/pull/3882#discussion_r401725101", "createdAt": "2020-04-01T15:55:56Z", "author": {"login": "atchertchian"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/repository/SnapshotPersister.java", "diffHunk": "@@ -302,8 +303,16 @@ public void persistComponent(DistributionSnapshot snapshot, ComponentInfo ci, Co\n         for (ExtensionPointInfo epi : ci.getExtensionPoints()) {\n             createExtensionPointDoc(snapshot, session, label, epi, componentDoc);\n         }\n+        Map<String, Integer> comps = new HashMap<String, Integer>();\n         for (ExtensionInfo ei : ci.getExtensions()) {\n-            createContributionDoc(snapshot, session, label, ei, componentDoc);\n+            // handle multiple contributions to the same extension point\n+            String id = ei.getId();\n+            if (comps.containsKey(id)) {\n+                comps.put(id, comps.get(id) + 1);\n+            } else {\n+                comps.put(id, Integer.valueOf(0));\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcwNDE2Mw=="}, "originalCommit": {"oid": "88eabbeefcad092f239936ed34b6300e0e8cd568"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjMxOTU4Ng==", "bodyText": "Not really as you need to change the id in one of the two cases.", "url": "https://github.com/nuxeo/nuxeo/pull/3882#discussion_r402319586", "createdAt": "2020-04-02T13:38:51Z", "author": {"login": "kevinleturc"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/repository/SnapshotPersister.java", "diffHunk": "@@ -302,8 +303,16 @@ public void persistComponent(DistributionSnapshot snapshot, ComponentInfo ci, Co\n         for (ExtensionPointInfo epi : ci.getExtensionPoints()) {\n             createExtensionPointDoc(snapshot, session, label, epi, componentDoc);\n         }\n+        Map<String, Integer> comps = new HashMap<String, Integer>();\n         for (ExtensionInfo ei : ci.getExtensions()) {\n-            createContributionDoc(snapshot, session, label, ei, componentDoc);\n+            // handle multiple contributions to the same extension point\n+            String id = ei.getId();\n+            if (comps.containsKey(id)) {\n+                comps.put(id, comps.get(id) + 1);\n+            } else {\n+                comps.put(id, Integer.valueOf(0));\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcwNDE2Mw=="}, "originalCommit": {"oid": "88eabbeefcad092f239936ed34b6300e0e8cd568"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA3MTcyNg==", "bodyText": "FYI @kevinleturc see my review for simpler code here", "url": "https://github.com/nuxeo/nuxeo/pull/3882#discussion_r403071726", "createdAt": "2020-04-03T15:05:59Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/repository/SnapshotPersister.java", "diffHunk": "@@ -302,8 +303,16 @@ public void persistComponent(DistributionSnapshot snapshot, ComponentInfo ci, Co\n         for (ExtensionPointInfo epi : ci.getExtensionPoints()) {\n             createExtensionPointDoc(snapshot, session, label, epi, componentDoc);\n         }\n+        Map<String, Integer> comps = new HashMap<String, Integer>();\n         for (ExtensionInfo ei : ci.getExtensions()) {\n-            createContributionDoc(snapshot, session, label, ei, componentDoc);\n+            // handle multiple contributions to the same extension point\n+            String id = ei.getId();\n+            if (comps.containsKey(id)) {\n+                comps.put(id, comps.get(id) + 1);\n+            } else {\n+                comps.put(id, Integer.valueOf(0));\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcwNDE2Mw=="}, "originalCommit": {"oid": "88eabbeefcad092f239936ed34b6300e0e8cd568"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5OTg4ODUwOnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/adapters/ExtensionInfoDocAdapter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNDo0Mzo1N1rOGAYm4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNDo0Mzo1N1rOGAYm4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA1NjM1Mw==", "bodyText": "Integer -> int", "url": "https://github.com/nuxeo/nuxeo/pull/3882#discussion_r403056353", "createdAt": "2020-04-03T14:43:57Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/adapters/ExtensionInfoDocAdapter.java", "diffHunk": "@@ -41,21 +41,27 @@\n \n public class ExtensionInfoDocAdapter extends BaseNuxeoArtifactDocAdapter implements ExtensionInfo {\n \n-    public static ExtensionInfoDocAdapter create(ExtensionInfo xi, CoreSession session, String containerPath) {\n+    public static ExtensionInfoDocAdapter create(ExtensionInfo xi, Integer index, CoreSession session,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e039164f873c719e99abf5b448164c5a2c1a9f32"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5OTg5MTEyOnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/adapters/ExtensionInfoDocAdapter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNDo0NDozMlrOGAYobQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNDo0NDozMlrOGAYobQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA1Njc0OQ==", "bodyText": "\"-\" + index is enough", "url": "https://github.com/nuxeo/nuxeo/pull/3882#discussion_r403056749", "createdAt": "2020-04-03T14:44:32Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/adapters/ExtensionInfoDocAdapter.java", "diffHunk": "@@ -41,21 +41,27 @@\n \n public class ExtensionInfoDocAdapter extends BaseNuxeoArtifactDocAdapter implements ExtensionInfo {\n \n-    public static ExtensionInfoDocAdapter create(ExtensionInfo xi, CoreSession session, String containerPath) {\n+    public static ExtensionInfoDocAdapter create(ExtensionInfo xi, Integer index, CoreSession session,\n+            String containerPath) {\n \n         DocumentModel doc = session.createDocumentModel(TYPE_NAME);\n \n-        String name = computeDocumentName(\"contrib-\" + xi.getId());\n+        String id = xi.getId();\n+        if (index > 0) {\n+            id += \"-\" + String.valueOf(index);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e039164f873c719e99abf5b448164c5a2c1a9f32"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5OTkxNjIzOnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/introspection/RuntimeSnapshot.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNDo1MDozNFrOGAY4SQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNDo1MDozNFrOGAY4SQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA2MDgwOQ==", "bodyText": "You should make the map a Map<String, AtomicInteger> then do\n                 if (comps.containsKey(id)) {\n                     int num = comps.get(id).incrementAndGet();\n                     id += \"-\" + num;\n                 } else {\n                     comps.put(id, new AtomicInteger());\n                 }", "url": "https://github.com/nuxeo/nuxeo/pull/3882#discussion_r403060809", "createdAt": "2020-04-03T14:50:34Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/introspection/RuntimeSnapshot.java", "diffHunk": "@@ -170,8 +170,18 @@ protected void index() {\n                     extensionPoints.put(epi.getId(), epi);\n                 }\n \n+                Map<String, Integer> comps = new HashMap<String, Integer>();\n                 for (ExtensionInfo ei : cInfo.getExtensions()) {\n-                    contributions.put(ei.getId(), ei);\n+                    // handle multiple contributions to the same extension point\n+                    String id = ei.getId();\n+                    if (comps.containsKey(id)) {\n+                        Integer num = comps.get(id);\n+                        comps.put(id, num + 1);\n+                        id += \"-\" + String.valueOf(num + 1);\n+                    } else {\n+                        comps.put(id, Integer.valueOf(0));\n+                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e039164f873c719e99abf5b448164c5a2c1a9f32"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5OTkxODkxOnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/introspection/RuntimeSnapshot.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNDo1MToxMVrOGAY5-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNTo0NToyMFrOGAbJSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA2MTI0MA==", "bodyText": "new HashMap<>() (you should configure your IDE to warn you about this)", "url": "https://github.com/nuxeo/nuxeo/pull/3882#discussion_r403061240", "createdAt": "2020-04-03T14:51:11Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/introspection/RuntimeSnapshot.java", "diffHunk": "@@ -170,8 +170,18 @@ protected void index() {\n                     extensionPoints.put(epi.getId(), epi);\n                 }\n \n+                Map<String, Integer> comps = new HashMap<String, Integer>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e039164f873c719e99abf5b448164c5a2c1a9f32"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA4MjA3OQ==", "bodyText": "thanks, well i did import the eclipse formaters from this repo, are they being updated?", "url": "https://github.com/nuxeo/nuxeo/pull/3882#discussion_r403082079", "createdAt": "2020-04-03T15:21:48Z", "author": {"login": "atchertchian"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/introspection/RuntimeSnapshot.java", "diffHunk": "@@ -170,8 +170,18 @@ protected void index() {\n                     extensionPoints.put(epi.getId(), epi);\n                 }\n \n+                Map<String, Integer> comps = new HashMap<String, Integer>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA2MTI0MA=="}, "originalCommit": {"oid": "e039164f873c719e99abf5b448164c5a2c1a9f32"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA5NzkzMQ==", "bodyText": "found the warn setup (outside of shared confs), please tell if i can setup eclipse to avoid adding these on its own!", "url": "https://github.com/nuxeo/nuxeo/pull/3882#discussion_r403097931", "createdAt": "2020-04-03T15:45:20Z", "author": {"login": "atchertchian"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/introspection/RuntimeSnapshot.java", "diffHunk": "@@ -170,8 +170,18 @@ protected void index() {\n                     extensionPoints.put(epi.getId(), epi);\n                 }\n \n+                Map<String, Integer> comps = new HashMap<String, Integer>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA2MTI0MA=="}, "originalCommit": {"oid": "e039164f873c719e99abf5b448164c5a2c1a9f32"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5OTkzMTE3OnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/introspection/ExtensionInfoImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNDo1Mzo0NFrOGAZBbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNDo1Mzo0NFrOGAZBbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA2MzE0OA==", "bodyText": "Integer -> int", "url": "https://github.com/nuxeo/nuxeo/pull/3882#discussion_r403063148", "createdAt": "2020-04-03T14:53:44Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/introspection/ExtensionInfoImpl.java", "diffHunk": "@@ -56,8 +56,12 @@\n \n     protected Object[] contribution;\n \n-    public ExtensionInfoImpl(ComponentInfoImpl component, String xpoint) {\n-        id = component.getId() + \"--\" + xpoint;\n+    public ExtensionInfoImpl(ComponentInfoImpl component, String xpoint, Integer index) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e039164f873c719e99abf5b448164c5a2c1a9f32"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5OTk0NTEwOnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/introspection/ServerInfo.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNDo1Njo0MFrOGAZJ3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNDo1Njo0MFrOGAZJ3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA2NTMxMA==", "bodyText": "Simplify also, use AtomicInteger in the map then do just:\n                comps.computeIfAbsent(id, k -> new AtomicInteger(-1)).incrementAndGet();\n                ExtensionInfoImpl xtinfo = new ExtensionInfoImpl(component, xt.getExtensionPoint(), comps.get(id).get());\n\n(no need for computeIfPresent with this)", "url": "https://github.com/nuxeo/nuxeo/pull/3882#discussion_r403065310", "createdAt": "2020-04-03T14:56:40Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/introspection/ServerInfo.java", "diffHunk": "@@ -353,8 +353,13 @@ public static ServerInfo build(String name, String version) {\n             }\n \n             if (ri.getExtensions() != null) {\n+                Map<String, Integer> comps = new HashMap<String, Integer>();\n                 for (Extension xt : ri.getExtensions()) {\n-                    ExtensionInfoImpl xtinfo = new ExtensionInfoImpl(component, xt.getExtensionPoint());\n+                    // handle multiple contributions to the same extension point\n+                    String id = xt.getExtensionPoint();\n+                    comps.computeIfPresent(id, (k, v) -> v + 1);\n+                    comps.computeIfAbsent(id, k -> Integer.valueOf(0));\n+                    ExtensionInfoImpl xtinfo = new ExtensionInfoImpl(component, xt.getExtensionPoint(), comps.get(id));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e039164f873c719e99abf5b448164c5a2c1a9f32"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5OTk0ODE4OnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/repository/SnapshotPersister.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNDo1NzoyNVrOGAZL5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNDo1NzoyNVrOGAZL5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA2NTgyOQ==", "bodyText": "Same as above", "url": "https://github.com/nuxeo/nuxeo/pull/3882#discussion_r403065829", "createdAt": "2020-04-03T14:57:25Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/repository/SnapshotPersister.java", "diffHunk": "@@ -305,8 +306,13 @@ public void persistComponent(DistributionSnapshot snapshot, ComponentInfo ci, Co\n         for (ExtensionPointInfo epi : ci.getExtensionPoints()) {\n             createExtensionPointDoc(snapshot, session, label, epi, componentDoc);\n         }\n+        Map<String, Integer> comps = new HashMap<String, Integer>();\n         for (ExtensionInfo ei : ci.getExtensions()) {\n-            createContributionDoc(snapshot, session, label, ei, componentDoc);\n+            // handle multiple contributions to the same extension point\n+            String id = ei.getId();\n+            comps.computeIfPresent(id, (k, v) -> v + 1);\n+            comps.computeIfAbsent(id, k -> Integer.valueOf(0));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e039164f873c719e99abf5b448164c5a2c1a9f32"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5OTk0OTg2OnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/repository/SnapshotPersister.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNDo1Nzo0OVrOGAZM9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNDo1Nzo0OVrOGAZM9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA2NjEwMw==", "bodyText": "Integer -> int", "url": "https://github.com/nuxeo/nuxeo/pull/3882#discussion_r403066103", "createdAt": "2020-04-03T14:57:49Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/repository/SnapshotPersister.java", "diffHunk": "@@ -315,8 +321,8 @@ public void persistComponent(DistributionSnapshot snapshot, ComponentInfo ci, Co\n     }\n \n     protected DocumentModel createContributionDoc(DistributionSnapshot snapshot, CoreSession session, String label,\n-            ExtensionInfo ei, DocumentModel parent) {\n-        return ExtensionInfoDocAdapter.create(ei, session, parent.getPathAsString()).getDoc();\n+            ExtensionInfo ei, Integer index, DocumentModel parent) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e039164f873c719e99abf5b448164c5a2c1a9f32"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5OTk1MTc0OnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-repo/src/test/resources/apidoc-works-test-contrib.xml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNDo1ODoxNlrOGAZOIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNjowMjo1MlrOGAbzgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA2NjQwMw==", "bodyText": "Not sure why you'd need to wrap point=\"queues\"", "url": "https://github.com/nuxeo/nuxeo/pull/3882#discussion_r403066403", "createdAt": "2020-04-03T14:58:16Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-repo/src/test/resources/apidoc-works-test-contrib.xml", "diffHunk": "@@ -1,11 +1,22 @@\n <?xml version=\"1.0\"?>\n <component name=\"org.nuxeo.apidoc.test.works\" version=\"1.0\">\n \n-  <extension target=\"org.nuxeo.ecm.core.work.service\" point=\"queues\">\n+  <extension target=\"org.nuxeo.ecm.core.work.service\"\n+    point=\"queues\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e039164f873c719e99abf5b448164c5a2c1a9f32"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzEwODczOA==", "bodyText": "maybe i fixed the formatter in the meantime (?)", "url": "https://github.com/nuxeo/nuxeo/pull/3882#discussion_r403108738", "createdAt": "2020-04-03T16:02:52Z", "author": {"login": "atchertchian"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-repo/src/test/resources/apidoc-works-test-contrib.xml", "diffHunk": "@@ -1,11 +1,22 @@\n <?xml version=\"1.0\"?>\n <component name=\"org.nuxeo.apidoc.test.works\" version=\"1.0\">\n \n-  <extension target=\"org.nuxeo.ecm.core.work.service\" point=\"queues\">\n+  <extension target=\"org.nuxeo.ecm.core.work.service\"\n+    point=\"queues\">", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA2NjQwMw=="}, "originalCommit": {"oid": "e039164f873c719e99abf5b448164c5a2c1a9f32"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5OTk1NjgxOnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/api/QueryHelper.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNDo1OToxMVrOGAZRHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNDo1OToxMVrOGAZRHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA2NzE2Ng==", "bodyText": "You should make the constant start with a space to avoid + \" \"  in all uses.", "url": "https://github.com/nuxeo/nuxeo/pull/3882#discussion_r403067166", "createdAt": "2020-04-03T14:59:11Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/api/QueryHelper.java", "diffHunk": "@@ -32,6 +32,11 @@ private QueryHelper() {\n \n     public static final String NOT_DELETED = NXQL.ECM_ISTRASHED + \" = 0\";\n \n+    /**\n+     * @since 11.1\n+     */\n+    public static final String ORDER_BY_POS = \"ORDER BY ecm:pos\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f010f40ef424099c27fe078c3a9b1d57f201121"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5OTk2Mjg1OnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-repo/src/test/java/org/nuxeo/apidoc/test/TestSnapshotPersist.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNTowMDozOFrOGAZU7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNTowMDozOFrOGAZU7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA2ODE0MQ==", "bodyText": "Second comment is probably useless, the usage is obvious.", "url": "https://github.com/nuxeo/nuxeo/pull/3882#discussion_r403068141", "createdAt": "2020-04-03T15:00:38Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-repo/src/test/java/org/nuxeo/apidoc/test/TestSnapshotPersist.java", "diffHunk": "@@ -15,169 +15,219 @@\n  *\n  * Contributors:\n  *     Thierry Delprat\n+ *     Anahide Tchertchian\n  */\n package org.nuxeo.apidoc.test;\n \n import static org.junit.Assert.assertEquals;\n import static org.junit.Assert.assertNotNull;\n \n+import java.io.ByteArrayInputStream;\n import java.io.File;\n-import java.io.FileInputStream;\n-import java.io.FileOutputStream;\n import java.io.IOException;\n-import java.io.InputStream;\n-import java.io.OutputStream;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n import java.util.Collections;\n+import java.util.Comparator;\n import java.util.List;\n \n import javax.inject.Inject;\n \n-import org.apache.commons.logging.Log;\n-import org.apache.commons.logging.LogFactory;\n+import org.apache.commons.lang.SystemUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.junit.ComparisonFailure;\n import org.junit.Test;\n import org.junit.runner.RunWith;\n import org.nuxeo.apidoc.api.BundleGroupFlatTree;\n import org.nuxeo.apidoc.api.BundleGroupTreeHelper;\n-import org.nuxeo.apidoc.api.BundleInfo;\n-import org.nuxeo.apidoc.api.ComponentInfo;\n-import org.nuxeo.apidoc.api.ExtensionInfo;\n-import org.nuxeo.apidoc.api.ExtensionPointInfo;\n-import org.nuxeo.apidoc.api.ServiceInfo;\n+import org.nuxeo.apidoc.api.NuxeoArtifact;\n+import org.nuxeo.apidoc.api.OperationInfo;\n import org.nuxeo.apidoc.snapshot.DistributionSnapshot;\n import org.nuxeo.apidoc.snapshot.SnapshotManager;\n+import org.nuxeo.common.utils.FileUtils;\n import org.nuxeo.ecm.core.api.CoreSession;\n-import org.nuxeo.ecm.core.api.DocumentModel;\n-import org.nuxeo.runtime.api.Framework;\n import org.nuxeo.runtime.test.runner.Features;\n import org.nuxeo.runtime.test.runner.FeaturesRunner;\n \n @RunWith(FeaturesRunner.class)\n @Features({ RuntimeSnaphotFeature.class })\n public class TestSnapshotPersist {\n \n-    private static final Log log = LogFactory.getLog(TestSnapshotPersist.class);\n+    // helper for quicker update when running tests locally\n+    // public static final boolean UPDATE_REFERENCE_FILES_ON_FAILURE = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9914c4474a79d963c3f6cfca7ee6ea4204ca7db"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5OTk2OTUxOnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-repo/src/test/java/org/nuxeo/apidoc/test/TestSnapshotPersist.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNTowMjoxMFrOGAZY9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNTowMjoxMFrOGAZY9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA2OTE3Mg==", "bodyText": "Collections.sort(ops, Comparator.comparing(OperationInfo::getId))", "url": "https://github.com/nuxeo/nuxeo/pull/3882#discussion_r403069172", "createdAt": "2020-04-03T15:02:10Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-repo/src/test/java/org/nuxeo/apidoc/test/TestSnapshotPersist.java", "diffHunk": "@@ -15,169 +15,219 @@\n  *\n  * Contributors:\n  *     Thierry Delprat\n+ *     Anahide Tchertchian\n  */\n package org.nuxeo.apidoc.test;\n \n import static org.junit.Assert.assertEquals;\n import static org.junit.Assert.assertNotNull;\n \n+import java.io.ByteArrayInputStream;\n import java.io.File;\n-import java.io.FileInputStream;\n-import java.io.FileOutputStream;\n import java.io.IOException;\n-import java.io.InputStream;\n-import java.io.OutputStream;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n import java.util.Collections;\n+import java.util.Comparator;\n import java.util.List;\n \n import javax.inject.Inject;\n \n-import org.apache.commons.logging.Log;\n-import org.apache.commons.logging.LogFactory;\n+import org.apache.commons.lang.SystemUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.junit.ComparisonFailure;\n import org.junit.Test;\n import org.junit.runner.RunWith;\n import org.nuxeo.apidoc.api.BundleGroupFlatTree;\n import org.nuxeo.apidoc.api.BundleGroupTreeHelper;\n-import org.nuxeo.apidoc.api.BundleInfo;\n-import org.nuxeo.apidoc.api.ComponentInfo;\n-import org.nuxeo.apidoc.api.ExtensionInfo;\n-import org.nuxeo.apidoc.api.ExtensionPointInfo;\n-import org.nuxeo.apidoc.api.ServiceInfo;\n+import org.nuxeo.apidoc.api.NuxeoArtifact;\n+import org.nuxeo.apidoc.api.OperationInfo;\n import org.nuxeo.apidoc.snapshot.DistributionSnapshot;\n import org.nuxeo.apidoc.snapshot.SnapshotManager;\n+import org.nuxeo.common.utils.FileUtils;\n import org.nuxeo.ecm.core.api.CoreSession;\n-import org.nuxeo.ecm.core.api.DocumentModel;\n-import org.nuxeo.runtime.api.Framework;\n import org.nuxeo.runtime.test.runner.Features;\n import org.nuxeo.runtime.test.runner.FeaturesRunner;\n \n @RunWith(FeaturesRunner.class)\n @Features({ RuntimeSnaphotFeature.class })\n public class TestSnapshotPersist {\n \n-    private static final Log log = LogFactory.getLog(TestSnapshotPersist.class);\n+    // helper for quicker update when running tests locally\n+    // public static final boolean UPDATE_REFERENCE_FILES_ON_FAILURE = true;\n+    public static final boolean UPDATE_REFERENCE_FILES_ON_FAILURE = false;\n \n     @Inject\n     protected CoreSession session;\n \n     @Inject\n     protected SnapshotManager snapshotManager;\n \n-    protected String dumpSnapshot(DistributionSnapshot snap) {\n-        StringBuilder sb = new StringBuilder();\n+    @Test\n+    public void testSnapshot() throws IOException {\n+        DistributionSnapshot snapshot = snapshotManager.getRuntimeSnapshot();\n+        checkDistributionSnapshot(snapshot);\n+    }\n \n-        BundleGroupTreeHelper bgth = new BundleGroupTreeHelper(snap);\n+    @Test\n+    public void testPersist() throws IOException {\n+        DistributionSnapshot snapshot = snapshotManager.persistRuntimeSnapshot(session);\n+        assertNotNull(snapshot);\n+        checkDistributionSnapshot(snapshot);\n+\n+        DistributionSnapshot persisted = snapshotManager.getSnapshot(snapshot.getKey(), session);\n+        assertNotNull(persisted);\n+        checkDistributionSnapshot(persisted);\n+    }\n+\n+    protected void checkDistributionSnapshot(DistributionSnapshot snapshot) throws IOException {\n+        checkBundleGroups(snapshot);\n+        checkBundles(snapshot);\n+        checkComponents(snapshot);\n+        checkServices(snapshot);\n+        checkExtensionPoints(snapshot);\n+        checkContributions(snapshot);\n+        checkOperations(snapshot);\n+    }\n+\n+    protected void checkBundleGroups(DistributionSnapshot snapshot) throws IOException {\n+        StringBuilder sb = new StringBuilder();\n+        BundleGroupTreeHelper bgth = new BundleGroupTreeHelper(snapshot);\n         List<BundleGroupFlatTree> tree = bgth.getBundleGroupTree();\n         for (BundleGroupFlatTree info : tree) {\n-            String pad = \" \";\n-            for (int i = 0; i <= info.getLevel(); i++) {\n-                pad += \" \";\n-            }\n-            sb.append(pad)\n-            .append(\"- \")\n-            .append(info.getGroup().getName())\n-            .append(\"(\")\n-            .append(info.getGroup().getId())\n-            .append(\")\");\n-            sb.append(\" *** \");\n-            sb.append(info.getGroup().getHierarchyPath());\n-            sb.append(\"\\n\");\n+            sb.append(String.format(\"%s- %s (%s) *** %s\\n\", //\n+                    StringUtils.repeat(\"  \", info.getLevel()), //\n+                    info.getGroup().getName(), //\n+                    info.getGroup().getId(), //\n+                    info.getGroup().getHierarchyPath()) //\n+            );\n         }\n+        checkContentEquals(\"apidoc_snapshot/bundlegroups.txt\", sb.toString());\n+    }\n \n-        List<String> bids = snap.getBundleIds();\n-        List<String> cids = snap.getComponentIds();\n-        List<String> sids = snap.getServiceIds();\n-        List<String> epids = snap.getExtensionPointIds();\n-        List<String> exids = snap.getContributionIds();\n+    protected String represent(NuxeoArtifact artifact) {\n+        return String.format(\"%s: %s *** %s\\n\", //\n+                artifact.getArtifactType(), //\n+                artifact.getId(), //\n+                artifact.getHierarchyPath() //\n+        );\n+    }\n \n+    protected void checkBundles(DistributionSnapshot snapshot) throws IOException {\n+        List<String> bids = snapshot.getBundleIds();\n         Collections.sort(bids);\n-        Collections.sort(cids);\n-        Collections.sort(sids);\n-        Collections.sort(epids);\n-        Collections.sort(exids);\n \n+        StringBuilder sb = new StringBuilder();\n         for (String bid : bids) {\n-            sb.append(\"bundle : \").append(bid);\n-            BundleInfo bi = snap.getBundle(bid);\n-            sb.append(\" *** \");\n-            sb.append(bi.getHierarchyPath());\n-            sb.append(\"\\n\");\n+            sb.append(represent(snapshot.getBundle(bid)));\n         }\n \n+        checkContentEquals(\"apidoc_snapshot/bundles.txt\", sb.toString());\n+    }\n+\n+    protected void checkComponents(DistributionSnapshot snapshot) throws IOException {\n+        List<String> cids = snapshot.getComponentIds();\n+        Collections.sort(cids);\n+\n+        StringBuilder sb = new StringBuilder();\n         for (String cid : cids) {\n-            sb.append(\"component : \").append(cid);\n-            sb.append(\" *** \");\n-            ComponentInfo ci = snap.getComponent(cid);\n-            sb.append(ci.getHierarchyPath());\n-            sb.append(\"\\n\");\n+            sb.append(represent(snapshot.getComponent(cid)));\n         }\n \n+        checkContentEquals(\"apidoc_snapshot/components.txt\", sb.toString());\n+    }\n+\n+    protected void checkServices(DistributionSnapshot snapshot) throws IOException {\n+        List<String> sids = snapshot.getServiceIds();\n+        Collections.sort(sids);\n+\n+        StringBuilder sb = new StringBuilder();\n         for (String sid : sids) {\n-            sb.append(\"service : \").append(sid);\n-            sb.append(\" *** \");\n-            ServiceInfo si = snap.getService(sid);\n-            sb.append(si.getHierarchyPath());\n-            sb.append(\"\\n\");\n+            sb.append(represent(snapshot.getService(sid)));\n         }\n \n+        checkContentEquals(\"apidoc_snapshot/services.txt\", sb.toString());\n+    }\n+\n+    protected void checkExtensionPoints(DistributionSnapshot snapshot) throws IOException {\n+        List<String> epids = snapshot.getExtensionPointIds();\n+        Collections.sort(epids);\n+\n+        StringBuilder sb = new StringBuilder();\n         for (String epid : epids) {\n-            sb.append(\"extensionPoint : \").append(epid);\n-            sb.append(\" *** \");\n-            ExtensionPointInfo epi = snap.getExtensionPoint(epid);\n-            sb.append(epi.getHierarchyPath());\n-            sb.append(\"\\n\");\n+            sb.append(represent(snapshot.getExtensionPoint(epid)));\n         }\n \n+        checkContentEquals(\"apidoc_snapshot/extensionpoints.txt\", sb.toString());\n+    }\n+\n+    protected void checkContributions(DistributionSnapshot snapshot) throws IOException {\n+        List<String> exids = snapshot.getContributionIds();\n+        Collections.sort(exids);\n+\n+        StringBuilder sb = new StringBuilder();\n         for (String exid : exids) {\n-            sb.append(\"contribution : \").append(exid);\n-            sb.append(\" *** \");\n-            ExtensionInfo exi = snap.getContribution(exid);\n-            sb.append(exi.getHierarchyPath());\n-            sb.append(\"\\n\");\n+            sb.append(represent(snapshot.getContribution(exid)));\n         }\n-        return sb.toString();\n+\n+        checkContentEquals(\"apidoc_snapshot/contributions.txt\", sb.toString());\n     }\n \n-    @Test\n-    public void testPersist() throws Exception {\n-        DistributionSnapshot runtimeSnapshot = snapshotManager.getRuntimeSnapshot();\n-        String rtDump = dumpSnapshot(runtimeSnapshot);\n-\n-        DistributionSnapshot persistent = snapshotManager.persistRuntimeSnapshot(session);\n-        assertNotNull(persistent);\n-\n-        persistent = snapshotManager.getSnapshot(runtimeSnapshot.getKey(), session);\n-        assertNotNull(persistent);\n-\n-        // DocumentModelList docs = session.query(\"select * from NXBundle\");\n-        // for (DocumentModel doc : docs) {\n-        // log.info(\"Bundle : \" + doc.getTitle() + \" --- \" +\n-        // doc.getPathAsString());\n-        // }\n-        String pDump = dumpSnapshot(persistent);\n-\n-        // String[] rtDumpLines = rtDump.trim().split(\"\\n\");\n-        // String[] pDumpLines = pDump.trim().split(\"\\n\");\n-        // assertEquals(rtDumpLines.length, pDumpLines.length);\n-        // for (int i = 0; i < rtDumpLines.length; i++) {\n-        // assertEquals(rtDumpLines[i], pDumpLines[i]);\n-        // }\n-        assertEquals(rtDump, pDump);\n+    protected void checkOperations(DistributionSnapshot snapshot) throws IOException {\n+        List<OperationInfo> ops = snapshot.getOperations();\n+        Collections.sort(ops, new Comparator<OperationInfo>() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9914c4474a79d963c3f6cfca7ee6ea4204ca7db"}, "originalPosition": 261}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5OTk3NzI4OnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-repo/src/test/java/org/nuxeo/apidoc/test/TestSnapshotPersist.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNTowMzo1NlrOGAZdwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNTowMzo1NlrOGAZdwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA3MDQwMg==", "bodyText": "ops.forEach(op -> sb.append(represent(op)))", "url": "https://github.com/nuxeo/nuxeo/pull/3882#discussion_r403070402", "createdAt": "2020-04-03T15:03:56Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-repo/src/test/java/org/nuxeo/apidoc/test/TestSnapshotPersist.java", "diffHunk": "@@ -15,169 +15,219 @@\n  *\n  * Contributors:\n  *     Thierry Delprat\n+ *     Anahide Tchertchian\n  */\n package org.nuxeo.apidoc.test;\n \n import static org.junit.Assert.assertEquals;\n import static org.junit.Assert.assertNotNull;\n \n+import java.io.ByteArrayInputStream;\n import java.io.File;\n-import java.io.FileInputStream;\n-import java.io.FileOutputStream;\n import java.io.IOException;\n-import java.io.InputStream;\n-import java.io.OutputStream;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n import java.util.Collections;\n+import java.util.Comparator;\n import java.util.List;\n \n import javax.inject.Inject;\n \n-import org.apache.commons.logging.Log;\n-import org.apache.commons.logging.LogFactory;\n+import org.apache.commons.lang.SystemUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.junit.ComparisonFailure;\n import org.junit.Test;\n import org.junit.runner.RunWith;\n import org.nuxeo.apidoc.api.BundleGroupFlatTree;\n import org.nuxeo.apidoc.api.BundleGroupTreeHelper;\n-import org.nuxeo.apidoc.api.BundleInfo;\n-import org.nuxeo.apidoc.api.ComponentInfo;\n-import org.nuxeo.apidoc.api.ExtensionInfo;\n-import org.nuxeo.apidoc.api.ExtensionPointInfo;\n-import org.nuxeo.apidoc.api.ServiceInfo;\n+import org.nuxeo.apidoc.api.NuxeoArtifact;\n+import org.nuxeo.apidoc.api.OperationInfo;\n import org.nuxeo.apidoc.snapshot.DistributionSnapshot;\n import org.nuxeo.apidoc.snapshot.SnapshotManager;\n+import org.nuxeo.common.utils.FileUtils;\n import org.nuxeo.ecm.core.api.CoreSession;\n-import org.nuxeo.ecm.core.api.DocumentModel;\n-import org.nuxeo.runtime.api.Framework;\n import org.nuxeo.runtime.test.runner.Features;\n import org.nuxeo.runtime.test.runner.FeaturesRunner;\n \n @RunWith(FeaturesRunner.class)\n @Features({ RuntimeSnaphotFeature.class })\n public class TestSnapshotPersist {\n \n-    private static final Log log = LogFactory.getLog(TestSnapshotPersist.class);\n+    // helper for quicker update when running tests locally\n+    // public static final boolean UPDATE_REFERENCE_FILES_ON_FAILURE = true;\n+    public static final boolean UPDATE_REFERENCE_FILES_ON_FAILURE = false;\n \n     @Inject\n     protected CoreSession session;\n \n     @Inject\n     protected SnapshotManager snapshotManager;\n \n-    protected String dumpSnapshot(DistributionSnapshot snap) {\n-        StringBuilder sb = new StringBuilder();\n+    @Test\n+    public void testSnapshot() throws IOException {\n+        DistributionSnapshot snapshot = snapshotManager.getRuntimeSnapshot();\n+        checkDistributionSnapshot(snapshot);\n+    }\n \n-        BundleGroupTreeHelper bgth = new BundleGroupTreeHelper(snap);\n+    @Test\n+    public void testPersist() throws IOException {\n+        DistributionSnapshot snapshot = snapshotManager.persistRuntimeSnapshot(session);\n+        assertNotNull(snapshot);\n+        checkDistributionSnapshot(snapshot);\n+\n+        DistributionSnapshot persisted = snapshotManager.getSnapshot(snapshot.getKey(), session);\n+        assertNotNull(persisted);\n+        checkDistributionSnapshot(persisted);\n+    }\n+\n+    protected void checkDistributionSnapshot(DistributionSnapshot snapshot) throws IOException {\n+        checkBundleGroups(snapshot);\n+        checkBundles(snapshot);\n+        checkComponents(snapshot);\n+        checkServices(snapshot);\n+        checkExtensionPoints(snapshot);\n+        checkContributions(snapshot);\n+        checkOperations(snapshot);\n+    }\n+\n+    protected void checkBundleGroups(DistributionSnapshot snapshot) throws IOException {\n+        StringBuilder sb = new StringBuilder();\n+        BundleGroupTreeHelper bgth = new BundleGroupTreeHelper(snapshot);\n         List<BundleGroupFlatTree> tree = bgth.getBundleGroupTree();\n         for (BundleGroupFlatTree info : tree) {\n-            String pad = \" \";\n-            for (int i = 0; i <= info.getLevel(); i++) {\n-                pad += \" \";\n-            }\n-            sb.append(pad)\n-            .append(\"- \")\n-            .append(info.getGroup().getName())\n-            .append(\"(\")\n-            .append(info.getGroup().getId())\n-            .append(\")\");\n-            sb.append(\" *** \");\n-            sb.append(info.getGroup().getHierarchyPath());\n-            sb.append(\"\\n\");\n+            sb.append(String.format(\"%s- %s (%s) *** %s\\n\", //\n+                    StringUtils.repeat(\"  \", info.getLevel()), //\n+                    info.getGroup().getName(), //\n+                    info.getGroup().getId(), //\n+                    info.getGroup().getHierarchyPath()) //\n+            );\n         }\n+        checkContentEquals(\"apidoc_snapshot/bundlegroups.txt\", sb.toString());\n+    }\n \n-        List<String> bids = snap.getBundleIds();\n-        List<String> cids = snap.getComponentIds();\n-        List<String> sids = snap.getServiceIds();\n-        List<String> epids = snap.getExtensionPointIds();\n-        List<String> exids = snap.getContributionIds();\n+    protected String represent(NuxeoArtifact artifact) {\n+        return String.format(\"%s: %s *** %s\\n\", //\n+                artifact.getArtifactType(), //\n+                artifact.getId(), //\n+                artifact.getHierarchyPath() //\n+        );\n+    }\n \n+    protected void checkBundles(DistributionSnapshot snapshot) throws IOException {\n+        List<String> bids = snapshot.getBundleIds();\n         Collections.sort(bids);\n-        Collections.sort(cids);\n-        Collections.sort(sids);\n-        Collections.sort(epids);\n-        Collections.sort(exids);\n \n+        StringBuilder sb = new StringBuilder();\n         for (String bid : bids) {\n-            sb.append(\"bundle : \").append(bid);\n-            BundleInfo bi = snap.getBundle(bid);\n-            sb.append(\" *** \");\n-            sb.append(bi.getHierarchyPath());\n-            sb.append(\"\\n\");\n+            sb.append(represent(snapshot.getBundle(bid)));\n         }\n \n+        checkContentEquals(\"apidoc_snapshot/bundles.txt\", sb.toString());\n+    }\n+\n+    protected void checkComponents(DistributionSnapshot snapshot) throws IOException {\n+        List<String> cids = snapshot.getComponentIds();\n+        Collections.sort(cids);\n+\n+        StringBuilder sb = new StringBuilder();\n         for (String cid : cids) {\n-            sb.append(\"component : \").append(cid);\n-            sb.append(\" *** \");\n-            ComponentInfo ci = snap.getComponent(cid);\n-            sb.append(ci.getHierarchyPath());\n-            sb.append(\"\\n\");\n+            sb.append(represent(snapshot.getComponent(cid)));\n         }\n \n+        checkContentEquals(\"apidoc_snapshot/components.txt\", sb.toString());\n+    }\n+\n+    protected void checkServices(DistributionSnapshot snapshot) throws IOException {\n+        List<String> sids = snapshot.getServiceIds();\n+        Collections.sort(sids);\n+\n+        StringBuilder sb = new StringBuilder();\n         for (String sid : sids) {\n-            sb.append(\"service : \").append(sid);\n-            sb.append(\" *** \");\n-            ServiceInfo si = snap.getService(sid);\n-            sb.append(si.getHierarchyPath());\n-            sb.append(\"\\n\");\n+            sb.append(represent(snapshot.getService(sid)));\n         }\n \n+        checkContentEquals(\"apidoc_snapshot/services.txt\", sb.toString());\n+    }\n+\n+    protected void checkExtensionPoints(DistributionSnapshot snapshot) throws IOException {\n+        List<String> epids = snapshot.getExtensionPointIds();\n+        Collections.sort(epids);\n+\n+        StringBuilder sb = new StringBuilder();\n         for (String epid : epids) {\n-            sb.append(\"extensionPoint : \").append(epid);\n-            sb.append(\" *** \");\n-            ExtensionPointInfo epi = snap.getExtensionPoint(epid);\n-            sb.append(epi.getHierarchyPath());\n-            sb.append(\"\\n\");\n+            sb.append(represent(snapshot.getExtensionPoint(epid)));\n         }\n \n+        checkContentEquals(\"apidoc_snapshot/extensionpoints.txt\", sb.toString());\n+    }\n+\n+    protected void checkContributions(DistributionSnapshot snapshot) throws IOException {\n+        List<String> exids = snapshot.getContributionIds();\n+        Collections.sort(exids);\n+\n+        StringBuilder sb = new StringBuilder();\n         for (String exid : exids) {\n-            sb.append(\"contribution : \").append(exid);\n-            sb.append(\" *** \");\n-            ExtensionInfo exi = snap.getContribution(exid);\n-            sb.append(exi.getHierarchyPath());\n-            sb.append(\"\\n\");\n+            sb.append(represent(snapshot.getContribution(exid)));\n         }\n-        return sb.toString();\n+\n+        checkContentEquals(\"apidoc_snapshot/contributions.txt\", sb.toString());\n     }\n \n-    @Test\n-    public void testPersist() throws Exception {\n-        DistributionSnapshot runtimeSnapshot = snapshotManager.getRuntimeSnapshot();\n-        String rtDump = dumpSnapshot(runtimeSnapshot);\n-\n-        DistributionSnapshot persistent = snapshotManager.persistRuntimeSnapshot(session);\n-        assertNotNull(persistent);\n-\n-        persistent = snapshotManager.getSnapshot(runtimeSnapshot.getKey(), session);\n-        assertNotNull(persistent);\n-\n-        // DocumentModelList docs = session.query(\"select * from NXBundle\");\n-        // for (DocumentModel doc : docs) {\n-        // log.info(\"Bundle : \" + doc.getTitle() + \" --- \" +\n-        // doc.getPathAsString());\n-        // }\n-        String pDump = dumpSnapshot(persistent);\n-\n-        // String[] rtDumpLines = rtDump.trim().split(\"\\n\");\n-        // String[] pDumpLines = pDump.trim().split(\"\\n\");\n-        // assertEquals(rtDumpLines.length, pDumpLines.length);\n-        // for (int i = 0; i < rtDumpLines.length; i++) {\n-        // assertEquals(rtDumpLines[i], pDumpLines[i]);\n-        // }\n-        assertEquals(rtDump, pDump);\n+    protected void checkOperations(DistributionSnapshot snapshot) throws IOException {\n+        List<OperationInfo> ops = snapshot.getOperations();\n+        Collections.sort(ops, new Comparator<OperationInfo>() {\n+            @Override\n+            public int compare(OperationInfo arg0, OperationInfo arg1) {\n+                return arg0.getId().compareTo(arg1.getId());\n+            }\n+        });\n \n+        StringBuilder sb = new StringBuilder();\n+        for (OperationInfo op : ops) {\n+            sb.append(represent(op));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9914c4474a79d963c3f6cfca7ee6ea4204ca7db"}, "originalPosition": 270}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwNjY5OTQzOnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-repo/src/test/java/org/nuxeo/apidoc/test/TestExportImport.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMDowNjoyNFrOGBQpMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMDowNjoyNFrOGBQpMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzk3NDQ1MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            @Features({ RuntimeSnaphotFeature.class })\n          \n          \n            \n            @Features(RuntimeSnaphotFeature.class)", "url": "https://github.com/nuxeo/nuxeo/pull/3882#discussion_r403974451", "createdAt": "2020-04-06T10:06:24Z", "author": {"login": "troger"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-repo/src/test/java/org/nuxeo/apidoc/test/TestExportImport.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * (C) Copyright 2006-2016 Nuxeo SA (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Thierry Delprat\n+ */\n+package org.nuxeo.apidoc.test;\n+\n+import static org.junit.Assert.assertNotNull;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.apidoc.snapshot.DistributionSnapshot;\n+import org.nuxeo.apidoc.snapshot.SnapshotManager;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.runtime.api.Framework;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+\n+@RunWith(FeaturesRunner.class)\n+@Features({ RuntimeSnaphotFeature.class })", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3db25078152a1d12a1653ad1cd65518501532c07"}, "originalPosition": 43}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4226, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}