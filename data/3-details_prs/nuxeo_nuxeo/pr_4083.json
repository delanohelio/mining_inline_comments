{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzODczODYx", "number": 4083, "title": "fix-NXP-29157-skip-aggregates-10.10", "bodyText": "PR created from https://qa2.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-nsilva-10.10/16/", "createdAt": "2020-05-27T14:02:08Z", "url": "https://github.com/nuxeo/nuxeo/pull/4083", "merged": true, "mergeCommit": {"oid": "de8f0ef38ce3725d3cd49e13ce1f256d758245fb"}, "closed": true, "closedAt": "2020-06-01T15:19:37Z", "author": {"login": "nuxeojenkins"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcldrlcAFqTQxOTUwNDQzOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnB2dVgFqTQyMTkzNDE2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NTA0NDM5", "url": "https://github.com/nuxeo/nuxeo/pull/4083#pullrequestreview-419504439", "createdAt": "2020-05-27T18:36:08Z", "commit": {"oid": "9cfb0dd0f2528dbefe25ccd7085760f2c1e4dcf6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxODozNjowOFrOGbYHOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxODozNjowOFrOGbYHOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM1OTgwMg==", "bodyText": "This part doesn't seem tested in this PR. This is automation-client so I can understand if it's too complex.\nCan this be \"aggregates\" instead of \"aggregations\" for consistency?", "url": "https://github.com/nuxeo/nuxeo/pull/4083#discussion_r431359802", "createdAt": "2020-05-27T18:36:08Z", "author": {"login": "efge"}, "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-client/src/main/java/org/nuxeo/ecm/automation/client/jaxrs/spi/marshallers/DocumentsMarshaller.java", "diffHunk": "@@ -92,6 +92,8 @@ protected Documents readPaginableDocuments(JsonParser jp) throws IOException {\n                 docs.setCurrentPageIndex(jp.getIntValue());\n             } else if (\"entries\".equals(key)) {\n                 readDocumentEntries(jp, docs);\n+            } else if (\"aggregations\".equals(key)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cfb0dd0f2528dbefe25ccd7085760f2c1e4dcf6"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NTA3MzYx", "url": "https://github.com/nuxeo/nuxeo/pull/4083#pullrequestreview-419507361", "createdAt": "2020-05-27T18:40:17Z", "commit": {"oid": "9cfb0dd0f2528dbefe25ccd7085760f2c1e4dcf6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxODo0MDoxN1rOGbYP0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxODo0MDoxN1rOGbYP0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM2MjAwMA==", "bodyText": "Please add a newline.", "url": "https://github.com/nuxeo/nuxeo/pull/4083#discussion_r431362000", "createdAt": "2020-05-27T18:40:17Z", "author": {"login": "efge"}, "path": "nuxeo-features/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/test/java/org/nuxeo/elasticsearch/test/rest/AutomationESDocumentsTest.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * (C) Copyright 20202 Nuxeo SA (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.nuxeo.elasticsearch.test.rest;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.automation.client.Session;\n+import org.nuxeo.ecm.automation.client.model.PaginableDocuments;\n+import org.nuxeo.ecm.automation.core.util.Properties;\n+import org.nuxeo.ecm.automation.core.operations.services.DocumentPageProviderOperation;\n+import org.nuxeo.ecm.automation.test.EmbeddedAutomationServerFeature;\n+import org.nuxeo.ecm.core.test.annotations.Granularity;\n+import org.nuxeo.ecm.core.test.annotations.RepositoryConfig;\n+import org.nuxeo.ecm.platform.query.api.PageProvider;\n+import org.nuxeo.ecm.restapi.test.RestServerInit;\n+import org.nuxeo.elasticsearch.test.RepositoryElasticSearchFeature;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+\n+/**\n+ * @since 11.1\n+ */\n+@RunWith(FeaturesRunner.class)\n+@Features({EmbeddedAutomationServerFeature.class, RepositoryElasticSearchFeature.class})\n+@Deploy(\"org.nuxeo.elasticsearch.core.test:elasticsearch-test-contrib.xml\")\n+@Deploy(\"org.nuxeo.elasticsearch.core.test:pageprovider-test-contrib.xml\")\n+@Deploy(\"org.nuxeo.elasticsearch.core.test:pageprovider2-test-contrib.xml\")\n+@Deploy(\"org.nuxeo.elasticsearch.core.test:pageprovider2-coretype-test-contrib.xml\")\n+@RepositoryConfig(cleanup = Granularity.METHOD, init = RestServerInit.class)\n+public class AutomationESDocumentsTest {\n+\n+    @Inject\n+    protected Session session;\n+\n+    @Test\n+    public void iCanPerformESQLPageProviderOperationOnRepository() throws Exception {\n+        Properties namedParameters = new Properties();\n+        namedParameters.put(\"defaults:dc_nature_agg\", \"[\\\"article\\\"]\");\n+        PaginableDocuments docs = (PaginableDocuments) session.newRequest(DocumentPageProviderOperation.ID)\n+                .set(\"namedParameters\", namedParameters)\n+                .set(\"providerName\", \"default_search\")\n+                .execute();\n+        assertEquals(docs.getPageSize(), 20);\n+        assertEquals(docs.getResultsCount(), 11);\n+    }\n+\n+    @Test\n+    public void iCanSkipAggregatesOnESQLPageProviderOperationOnRepository() throws Exception {\n+        PaginableDocuments docs = (PaginableDocuments) session.newRequest(DocumentPageProviderOperation.ID)\n+                .set(\"providerName\", \"aggregates_1\")\n+                .execute();\n+        assertTrue(docs.hasAggregates());\n+\n+        docs = (PaginableDocuments) session.newRequest(DocumentPageProviderOperation.ID)\n+                .setHeader(PageProvider.SKIP_AGGREGATES_PROP, \"true\")\n+                .set(\"providerName\", \"aggregates_1\")\n+                .execute();\n+        assertFalse(docs.hasAggregates());\n+    }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cfb0dd0f2528dbefe25ccd7085760f2c1e4dcf6"}, "originalPosition": 80}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9cfb0dd0f2528dbefe25ccd7085760f2c1e4dcf6", "author": {"user": {"login": "nelsonsilva", "name": "Nelson Silva"}}, "url": "https://github.com/nuxeo/nuxeo/commit/9cfb0dd0f2528dbefe25ccd7085760f2c1e4dcf6", "committedDate": "2020-05-27T10:27:18Z", "message": "NXP-29157: allow skipping aggregations with http header"}, "afterCommit": {"oid": "b347f932ae57435a113b5702ffc67fb2f92a3abf", "author": {"user": {"login": "nelsonsilva", "name": "Nelson Silva"}}, "url": "https://github.com/nuxeo/nuxeo/commit/b347f932ae57435a113b5702ffc67fb2f92a3abf", "committedDate": "2020-05-28T08:45:15Z", "message": "NXP-29157: allow skipping aggregations with http header"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b347f932ae57435a113b5702ffc67fb2f92a3abf", "author": {"user": {"login": "nelsonsilva", "name": "Nelson Silva"}}, "url": "https://github.com/nuxeo/nuxeo/commit/b347f932ae57435a113b5702ffc67fb2f92a3abf", "committedDate": "2020-05-28T08:45:15Z", "message": "NXP-29157: allow skipping aggregations with http header"}, "afterCommit": {"oid": "77d38f22d755af5977a4259d9b250532877e36c6", "author": {"user": {"login": "nelsonsilva", "name": "Nelson Silva"}}, "url": "https://github.com/nuxeo/nuxeo/commit/77d38f22d755af5977a4259d9b250532877e36c6", "committedDate": "2020-05-28T08:49:17Z", "message": "NXP-29157: allow skipping aggregations with http header"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "77d38f22d755af5977a4259d9b250532877e36c6", "author": {"user": {"login": "nelsonsilva", "name": "Nelson Silva"}}, "url": "https://github.com/nuxeo/nuxeo/commit/77d38f22d755af5977a4259d9b250532877e36c6", "committedDate": "2020-05-28T08:49:17Z", "message": "NXP-29157: allow skipping aggregations with http header"}, "afterCommit": {"oid": "3e7bc35d4d6e66d721bf8384275d81f4b180e812", "author": {"user": {"login": "nelsonsilva", "name": "Nelson Silva"}}, "url": "https://github.com/nuxeo/nuxeo/commit/3e7bc35d4d6e66d721bf8384275d81f4b180e812", "committedDate": "2020-05-28T08:51:10Z", "message": "NXP-29157: allow skipping aggregations with http header"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5OTA3Mzk1", "url": "https://github.com/nuxeo/nuxeo/pull/4083#pullrequestreview-419907395", "createdAt": "2020-05-28T08:53:46Z", "commit": {"oid": "3e7bc35d4d6e66d721bf8384275d81f4b180e812"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e46baae805c7157f8deffad78a542a2b545025bd", "author": {"user": {"login": "nelsonsilva", "name": "Nelson Silva"}}, "url": "https://github.com/nuxeo/nuxeo/commit/e46baae805c7157f8deffad78a542a2b545025bd", "committedDate": "2020-05-28T09:10:07Z", "message": "NXP-29157: allow skipping aggregations with http header"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3e7bc35d4d6e66d721bf8384275d81f4b180e812", "author": {"user": {"login": "nelsonsilva", "name": "Nelson Silva"}}, "url": "https://github.com/nuxeo/nuxeo/commit/3e7bc35d4d6e66d721bf8384275d81f4b180e812", "committedDate": "2020-05-28T08:51:10Z", "message": "NXP-29157: allow skipping aggregations with http header"}, "afterCommit": {"oid": "e46baae805c7157f8deffad78a542a2b545025bd", "author": {"user": {"login": "nelsonsilva", "name": "Nelson Silva"}}, "url": "https://github.com/nuxeo/nuxeo/commit/e46baae805c7157f8deffad78a542a2b545025bd", "committedDate": "2020-05-28T09:10:07Z", "message": "NXP-29157: allow skipping aggregations with http header"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5OTI1NTEy", "url": "https://github.com/nuxeo/nuxeo/pull/4083#pullrequestreview-419925512", "createdAt": "2020-05-28T09:17:23Z", "commit": {"oid": "e46baae805c7157f8deffad78a542a2b545025bd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxOTM0MTYz", "url": "https://github.com/nuxeo/nuxeo/pull/4083#pullrequestreview-421934163", "createdAt": "2020-06-01T15:18:31Z", "commit": {"oid": "e46baae805c7157f8deffad78a542a2b545025bd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4747, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}