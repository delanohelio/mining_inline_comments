{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzMjUzOTEw", "number": 4382, "title": "Feature NXP-29707 Add support to Google Stackdriver monitoring", "bodyText": "", "createdAt": "2020-10-14T09:56:32Z", "url": "https://github.com/nuxeo/nuxeo/pull/4382", "merged": true, "mergeCommit": {"oid": "5ca569cd05ec66976b719e33097cf247c8bda9f3"}, "closed": true, "closedAt": "2020-10-20T06:58:22Z", "author": {"login": "bdelbosc"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdStl8tgH2gAyNTAzMjUzOTEwOmJmMzk4YWQ1NjIzYTYyNWMyYzc5NjQ5NjgzODNiZDIwOTlmMzQwYjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUEAUEgFqTUxMTc0NjcyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bf398ad5623a625c2c7964968383bd2099f340b7", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/bf398ad5623a625c2c7964968383bd2099f340b7", "committedDate": "2020-10-15T08:35:03Z", "message": "NXP-29707: Upgrade opencensus to latest 0.27.1"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de5841e11ee60618b5474ee252ea256b5821c5ac", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/de5841e11ee60618b5474ee252ea256b5821c5ac", "committedDate": "2020-10-14T09:55:37Z", "message": "NXP-29707: Add metrics and tracing reporters for Stackdriver"}, "afterCommit": {"oid": "8ab0407a0b2fe576497b2e9cf365eab085a5afdd", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/8ab0407a0b2fe576497b2e9cf365eab085a5afdd", "committedDate": "2020-10-16T09:01:47Z", "message": "NXP-29707: Add metrics and tracing reporters for Stackdriver"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwMzUwMDU0", "url": "https://github.com/nuxeo/nuxeo/pull/4382#pullrequestreview-510350054", "createdAt": "2020-10-16T10:33:32Z", "commit": {"oid": "8ab0407a0b2fe576497b2e9cf365eab085a5afdd"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMDozMzozMlrOHi0eog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMDozMzozMlrOHi0eog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI3MzQ0Mg==", "bodyText": "Why not using StringUtils#defaultIfBlank?", "url": "https://github.com/nuxeo/nuxeo/pull/4382#discussion_r506273442", "createdAt": "2020-10-16T10:33:32Z", "author": {"login": "kevinleturc"}, "path": "modules/runtime/nuxeo-runtime-metrics/src/main/java/org/nuxeo/runtime/metrics/reporter/StackdriverTraceReporter.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     bdelbosc\n+ */\n+package org.nuxeo.runtime.metrics.reporter;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.common.utils.DurationUtils;\n+import org.nuxeo.runtime.api.Framework;\n+import org.nuxeo.runtime.metrics.AbstractMetricsReporter;\n+\n+import io.dropwizard.metrics5.MetricAttribute;\n+import io.dropwizard.metrics5.MetricFilter;\n+import io.dropwizard.metrics5.MetricRegistry;\n+import io.opencensus.common.Duration;\n+import io.opencensus.exporter.trace.stackdriver.StackdriverTraceConfiguration;\n+import io.opencensus.exporter.trace.stackdriver.StackdriverTraceExporter;\n+\n+/**\n+ * Reports trace to Google Stackdriver.\n+ *\n+ * @since 11.4\n+ */\n+public class StackdriverTraceReporter extends AbstractMetricsReporter {\n+\n+    private static final Logger log = LogManager.getLogger(StackdriverTraceReporter.class);\n+\n+    public static final String GCP_PROJECT_ID_ENV_PROP = \"GCP_PROJECT_ID\";\n+\n+    public static final String GCP_PROJECT_ID_OPTION_PROP = \"gcpProjectId\";\n+\n+    protected boolean activated;\n+\n+    @Override\n+    public void start(MetricRegistry registry, MetricFilter filter, Set<MetricAttribute> deniedExpansions) {\n+        log.warn(\"Creating Stackdriver trace reporter\");\n+        Duration timeout = Duration.create(\n+                DurationUtils.parsePositive(options.get(TIMEOUT_OPTION), DEFAULT_TIMEOUT).getSeconds(), 0);\n+        String projectId = getGcpProjectId(options);\n+        StackdriverTraceConfiguration configuration = StackdriverTraceConfiguration.builder()\n+                                                                                   .setDeadline(timeout)\n+                                                                                   .setProjectId(projectId)\n+                                                                                   .build();\n+        try {\n+            StackdriverTraceExporter.createAndRegister(configuration);\n+        } catch (IOException e) {\n+            log.error(\"Fail to create a Stackdriver trace reporter\", e);\n+            return;\n+        }\n+        activated = true;\n+        enableTracing();\n+    }\n+\n+    protected static String getGcpProjectId(Map<String, String> options) {\n+        return getFirstValue(options.get(GCP_PROJECT_ID_OPTION_PROP), Framework.getProperty(GCP_PROJECT_ID_ENV_PROP));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ab0407a0b2fe576497b2e9cf365eab085a5afdd"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwMzU0NTI5", "url": "https://github.com/nuxeo/nuxeo/pull/4382#pullrequestreview-510354529", "createdAt": "2020-10-16T10:40:47Z", "commit": {"oid": "8ab0407a0b2fe576497b2e9cf365eab085a5afdd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMDo0MDo0N1rOHi01uA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMDo0NDo1MFrOHi1Bvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI3OTM1Mg==", "bodyText": "warn -> debug", "url": "https://github.com/nuxeo/nuxeo/pull/4382#discussion_r506279352", "createdAt": "2020-10-16T10:40:47Z", "author": {"login": "efge"}, "path": "modules/runtime/nuxeo-runtime-metrics/src/main/java/org/nuxeo/runtime/metrics/reporter/StackdriverReporter.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     bdelbosc\n+ */\n+package org.nuxeo.runtime.metrics.reporter;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.Set;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.common.utils.DurationUtils;\n+import org.nuxeo.runtime.metrics.AbstractMetricsReporter;\n+\n+import io.dropwizard.metrics5.MetricAttribute;\n+import io.dropwizard.metrics5.MetricFilter;\n+import io.dropwizard.metrics5.MetricRegistry;\n+import io.opencensus.common.Duration;\n+import io.opencensus.contrib.dropwizard5.DropWizardMetrics;\n+import io.opencensus.exporter.stats.stackdriver.StackdriverStatsConfiguration;\n+import io.opencensus.exporter.stats.stackdriver.StackdriverStatsExporter;\n+import io.opencensus.metrics.Metrics;\n+\n+/**\n+ * Reports metrics to Google Stackdriver.\n+ *\n+ * @since 11.4\n+ */\n+public class StackdriverReporter extends AbstractMetricsReporter {\n+\n+    private static final Logger log = LogManager.getLogger(StackdriverReporter.class);\n+\n+    protected static final String PREFIX_OPTION = \"prefix\";\n+\n+    protected static final String DEFAULT_PREFIX = \"custom.googleapis.com/nuxeo/\";\n+\n+    protected boolean activated;\n+\n+    @Override\n+    public void start(MetricRegistry registry, MetricFilter filter, Set<MetricAttribute> deniedExpansions) {\n+        log.warn(\"Creating Stackdriver metrics reporter\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ab0407a0b2fe576497b2e9cf365eab085a5afdd"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI3OTc5Ng==", "bodyText": "warn -> debug", "url": "https://github.com/nuxeo/nuxeo/pull/4382#discussion_r506279796", "createdAt": "2020-10-16T10:41:25Z", "author": {"login": "efge"}, "path": "modules/runtime/nuxeo-runtime-metrics/src/main/java/org/nuxeo/runtime/metrics/reporter/StackdriverTraceReporter.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     bdelbosc\n+ */\n+package org.nuxeo.runtime.metrics.reporter;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.common.utils.DurationUtils;\n+import org.nuxeo.runtime.api.Framework;\n+import org.nuxeo.runtime.metrics.AbstractMetricsReporter;\n+\n+import io.dropwizard.metrics5.MetricAttribute;\n+import io.dropwizard.metrics5.MetricFilter;\n+import io.dropwizard.metrics5.MetricRegistry;\n+import io.opencensus.common.Duration;\n+import io.opencensus.exporter.trace.stackdriver.StackdriverTraceConfiguration;\n+import io.opencensus.exporter.trace.stackdriver.StackdriverTraceExporter;\n+\n+/**\n+ * Reports trace to Google Stackdriver.\n+ *\n+ * @since 11.4\n+ */\n+public class StackdriverTraceReporter extends AbstractMetricsReporter {\n+\n+    private static final Logger log = LogManager.getLogger(StackdriverTraceReporter.class);\n+\n+    public static final String GCP_PROJECT_ID_ENV_PROP = \"GCP_PROJECT_ID\";\n+\n+    public static final String GCP_PROJECT_ID_OPTION_PROP = \"gcpProjectId\";\n+\n+    protected boolean activated;\n+\n+    @Override\n+    public void start(MetricRegistry registry, MetricFilter filter, Set<MetricAttribute> deniedExpansions) {\n+        log.warn(\"Creating Stackdriver trace reporter\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ab0407a0b2fe576497b2e9cf365eab085a5afdd"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI4MjQzMA==", "bodyText": "Maybe put exportInterval in a local variable to avoid having 3 lines hyper indented", "url": "https://github.com/nuxeo/nuxeo/pull/4382#discussion_r506282430", "createdAt": "2020-10-16T10:44:50Z", "author": {"login": "efge"}, "path": "modules/runtime/nuxeo-runtime-metrics/src/main/java/org/nuxeo/runtime/metrics/reporter/StackdriverReporter.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     bdelbosc\n+ */\n+package org.nuxeo.runtime.metrics.reporter;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.Set;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.common.utils.DurationUtils;\n+import org.nuxeo.runtime.metrics.AbstractMetricsReporter;\n+\n+import io.dropwizard.metrics5.MetricAttribute;\n+import io.dropwizard.metrics5.MetricFilter;\n+import io.dropwizard.metrics5.MetricRegistry;\n+import io.opencensus.common.Duration;\n+import io.opencensus.contrib.dropwizard5.DropWizardMetrics;\n+import io.opencensus.exporter.stats.stackdriver.StackdriverStatsConfiguration;\n+import io.opencensus.exporter.stats.stackdriver.StackdriverStatsExporter;\n+import io.opencensus.metrics.Metrics;\n+\n+/**\n+ * Reports metrics to Google Stackdriver.\n+ *\n+ * @since 11.4\n+ */\n+public class StackdriverReporter extends AbstractMetricsReporter {\n+\n+    private static final Logger log = LogManager.getLogger(StackdriverReporter.class);\n+\n+    protected static final String PREFIX_OPTION = \"prefix\";\n+\n+    protected static final String DEFAULT_PREFIX = \"custom.googleapis.com/nuxeo/\";\n+\n+    protected boolean activated;\n+\n+    @Override\n+    public void start(MetricRegistry registry, MetricFilter filter, Set<MetricAttribute> deniedExpansions) {\n+        log.warn(\"Creating Stackdriver metrics reporter\");\n+        DropWizardMetrics registries = new DropWizardMetrics(Collections.singletonList(registry), filter);\n+        Metrics.getExportComponent().getMetricProducerManager().add(registries);\n+        Duration timeout = Duration.create(\n+                DurationUtils.parsePositive(options.get(TIMEOUT_OPTION), DEFAULT_TIMEOUT).getSeconds(), 0);\n+        String projectId = StackdriverTraceReporter.getGcpProjectId(options);\n+        String prefix = options.getOrDefault(PREFIX_OPTION, DEFAULT_PREFIX);\n+        StackdriverStatsConfiguration configuration = StackdriverStatsConfiguration.builder()\n+                                                                                   .setDeadline(timeout)\n+                                                                                   .setProjectId(projectId)\n+                                                                                   .setMetricNamePrefix(prefix)\n+                                                                                   .setExportInterval(\n+                                                                                           Duration.fromMillis(\n+                                                                                                   getPollInterval()\n+                                                                                                           * 1000))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ab0407a0b2fe576497b2e9cf365eab085a5afdd"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2509d9dcfbb2f15ea9748356baf51a42dc006f0b", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/2509d9dcfbb2f15ea9748356baf51a42dc006f0b", "committedDate": "2020-10-19T08:05:31Z", "message": "NXP-29707: Add metrics and tracing reporters for Stackdriver"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8ab0407a0b2fe576497b2e9cf365eab085a5afdd", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/8ab0407a0b2fe576497b2e9cf365eab085a5afdd", "committedDate": "2020-10-16T09:01:47Z", "message": "NXP-29707: Add metrics and tracing reporters for Stackdriver"}, "afterCommit": {"oid": "2509d9dcfbb2f15ea9748356baf51a42dc006f0b", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/2509d9dcfbb2f15ea9748356baf51a42dc006f0b", "committedDate": "2020-10-19T08:05:31Z", "message": "NXP-29707: Add metrics and tracing reporters for Stackdriver"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExNTI0MjUx", "url": "https://github.com/nuxeo/nuxeo/pull/4382#pullrequestreview-511524251", "createdAt": "2020-10-19T08:28:41Z", "commit": {"oid": "2509d9dcfbb2f15ea9748356baf51a42dc006f0b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExNzQ2NzI1", "url": "https://github.com/nuxeo/nuxeo/pull/4382#pullrequestreview-511746725", "createdAt": "2020-10-19T13:15:41Z", "commit": {"oid": "2509d9dcfbb2f15ea9748356baf51a42dc006f0b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4935, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}