{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIwNDAwODE3", "number": 4057, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwODo0MDoxOVrOD-Hb7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwODo0MTo1OFrOD-HeVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NDYwMTQxOnYy", "diffSide": "RIGHT", "path": "addons/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3-web-ui/src/main/resources/web/nuxeo.war/ui/nuxeo-s3-direct-upload/nuxeo-s3-direct-upload.html", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwODo0MDoxOVrOGYBOGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwODo0MDoxOVrOGYBOGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzgzOTAwMQ==", "bodyText": "I'll add a catch(cb) before merging this", "url": "https://github.com/nuxeo/nuxeo/pull/4057#discussion_r427839001", "createdAt": "2020-05-20T08:40:19Z", "author": {"login": "nelsonsilva"}, "path": "addons/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3-web-ui/src/main/resources/web/nuxeo.war/ui/nuxeo-s3-direct-upload/nuxeo-s3-direct-upload.html", "diffHunk": "@@ -94,14 +94,29 @@\n     };\n \n     S3Provider.prototype._initCredentials = function(options) {\n+      var credentials = new AWS.Credentials(\n+        options.awsSecretKeyId,\n+        options.awsSecretAccessKey,\n+        options.awsSessionToken,\n+      );\n+      credentials.expireTime = new Date(options.expiration);\n+      credentials.refresh = function(cb) {\n+        this._resource(`upload/${this.batchId}/refreshToken`)\n+          .post()\n+          .then(function(response) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2fc95fea678485167dbde34c1d109210985efdb"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NDYwNzU5OnYy", "diffSide": "RIGHT", "path": "addons/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3-web-ui/src/main/resources/web/nuxeo.war/ui/nuxeo-s3-direct-upload/nuxeo-s3-direct-upload.html", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwODo0MTo1OFrOGYBSYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwODo0MTo1OFrOGYBSYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg0MDA5OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    credentials: new AWS.Credentials(options.awsSecretKeyId, options.awsSecretAccessKey, options.awsSessionToken),\n          \n          \n            \n                    credentials,", "url": "https://github.com/nuxeo/nuxeo/pull/4057#discussion_r427840098", "createdAt": "2020-05-20T08:41:58Z", "author": {"login": "Gabez0r"}, "path": "addons/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3-web-ui/src/main/resources/web/nuxeo.war/ui/nuxeo-s3-direct-upload/nuxeo-s3-direct-upload.html", "diffHunk": "@@ -94,14 +94,29 @@\n     };\n \n     S3Provider.prototype._initCredentials = function(options) {\n+      var credentials = new AWS.Credentials(\n+        options.awsSecretKeyId,\n+        options.awsSecretAccessKey,\n+        options.awsSessionToken,\n+      );\n+      credentials.expireTime = new Date(options.expiration);\n+      credentials.refresh = function(cb) {\n+        this._resource(`upload/${this.batchId}/refreshToken`)\n+          .post()\n+          .then(function(response) {\n+            credentials.accessKeyId = response.awsSecretKeyId;\n+            credentials.secretAccessKey = response.awsSecretAccessKey;\n+            credentials.sessionToken = response.awsSessionToken;\n+            credentials.expireTime = new Date(response.expiration);\n+            cb();\n+          });\n+      }.bind(this);\n       AWS.config.update({\n         credentials: new AWS.Credentials(options.awsSecretKeyId, options.awsSecretAccessKey, options.awsSessionToken),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2fc95fea678485167dbde34c1d109210985efdb"}, "originalPosition": 22}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4129, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}