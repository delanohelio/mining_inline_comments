{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxNDY1MTYx", "number": 3804, "title": "10.10-HF/fix-NXP-28560-catch-enrichers-exceptions", "bodyText": "PR created from https://qa2.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-nalkotob-10.10/135/", "createdAt": "2020-02-28T16:03:58Z", "url": "https://github.com/nuxeo/nuxeo/pull/3804", "merged": true, "mergeCommit": {"oid": "8012bce58cb23324ee9f9011e04c5c380c36d722"}, "closed": true, "closedAt": "2020-03-05T14:48:42Z", "author": {"login": "nuxeojenkins"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcJn5ucgBqjMwODY2MDA2NDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKsmFogFqTM2OTYyNDkwMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "559d08ddb23ac78c54c78370a71a16bb14681162", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/559d08ddb23ac78c54c78370a71a16bb14681162", "committedDate": "2020-02-28T14:43:17Z", "message": "NXP-28560: fix catch AbstractJsonEnrichers Exception"}, "afterCommit": {"oid": "62ba3c509c1be77c16ed477af017c13d15a58773", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/62ba3c509c1be77c16ed477af017c13d15a58773", "committedDate": "2020-03-02T06:40:37Z", "message": "NXP-28560: catch AbstractJsonEnrichers Exception"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "62ba3c509c1be77c16ed477af017c13d15a58773", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/62ba3c509c1be77c16ed477af017c13d15a58773", "committedDate": "2020-03-02T06:40:37Z", "message": "NXP-28560: catch AbstractJsonEnrichers Exception"}, "afterCommit": {"oid": "0759f0122f59312e16ee1bc555ed32fbb0beea62", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/0759f0122f59312e16ee1bc555ed32fbb0beea62", "committedDate": "2020-03-02T06:45:48Z", "message": "NXP-28560: fix catch AbstractJsonEnrichers Exception"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0759f0122f59312e16ee1bc555ed32fbb0beea62", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/0759f0122f59312e16ee1bc555ed32fbb0beea62", "committedDate": "2020-03-02T06:45:48Z", "message": "NXP-28560: fix catch AbstractJsonEnrichers Exception"}, "afterCommit": {"oid": "66473ab7cbc6cd98fe8b29b9eb67bfd8e85886cd", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/66473ab7cbc6cd98fe8b29b9eb67bfd8e85886cd", "committedDate": "2020-03-02T06:48:32Z", "message": "NXP-28560: fix catch AbstractJsonEnrichers Exception"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "66473ab7cbc6cd98fe8b29b9eb67bfd8e85886cd", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/66473ab7cbc6cd98fe8b29b9eb67bfd8e85886cd", "committedDate": "2020-03-02T06:48:32Z", "message": "NXP-28560: fix catch AbstractJsonEnrichers Exception"}, "afterCommit": {"oid": "7fdb322369dfa4b805ea2ae8d4dbf20a3e644c92", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/7fdb322369dfa4b805ea2ae8d4dbf20a3e644c92", "committedDate": "2020-03-02T06:49:09Z", "message": "NXP-28560: fix catch AbstractJsonEnrichers Exception"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7fdb322369dfa4b805ea2ae8d4dbf20a3e644c92", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/7fdb322369dfa4b805ea2ae8d4dbf20a3e644c92", "committedDate": "2020-03-02T06:49:09Z", "message": "NXP-28560: fix catch AbstractJsonEnrichers Exception"}, "afterCommit": {"oid": "c8e5fcd60c923fb71ca854a06708695105e7d854", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/c8e5fcd60c923fb71ca854a06708695105e7d854", "committedDate": "2020-03-02T06:51:39Z", "message": "NXP-28560: fix catch AbstractJsonEnrichers Exception"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c8e5fcd60c923fb71ca854a06708695105e7d854", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/c8e5fcd60c923fb71ca854a06708695105e7d854", "committedDate": "2020-03-02T06:51:39Z", "message": "NXP-28560: fix catch AbstractJsonEnrichers Exception"}, "afterCommit": {"oid": "ce297babe90dce493b971927603e21dcb802d8df", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/ce297babe90dce493b971927603e21dcb802d8df", "committedDate": "2020-03-02T07:32:38Z", "message": "NXP-28560: fix catch AbstractJsonEnrichers Exception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NzA3ODE4", "url": "https://github.com/nuxeo/nuxeo/pull/3804#pullrequestreview-368707818", "createdAt": "2020-03-04T11:39:40Z", "commit": {"oid": "ce297babe90dce493b971927603e21dcb802d8df"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMTozOTo0MFrOFxp9zA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMTozOTo0MFrOFxp9zA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYxMjEwOA==", "bodyText": "Can you try/catch readTree call?", "url": "https://github.com/nuxeo/nuxeo/pull/3804#discussion_r387612108", "createdAt": "2020-03-04T11:39:40Z", "author": {"login": "kevinleturc"}, "path": "nuxeo-core/nuxeo-core-io/src/main/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/AbstractJsonEnricher.java", "diffHunk": "@@ -56,15 +64,30 @@ public final boolean accept(Class<?> clazz, Type genericType, MediaType mediatyp\n \n     @Override\n     public void write(Enriched<EntityType> enrichable, JsonGenerator jg) {\n-        try {\n-            write(jg, enrichable.getEntity());\n+        try (TokenBuffer tb = new TokenBuffer(MAPPER, false)) {\n+            // Write to a temporary output in case of exception during write()\n+            tb.writeStartObject();\n+            write(tb, enrichable.getEntity());\n+            tb.writeEndObject();\n+            tb.flush();\n+            // Add the complete, well-formed content to the real output\n+            try (JsonParser parser = tb.asParser()) {\n+                parser.nextToken(); // ignoring START_OBJECT\n+                while (parser.nextToken() == FIELD_NAME) {\n+                    jg.copyCurrentStructure(parser);\n+                }\n+                if (parser.currentToken() != END_OBJECT) {\n+                    log.error(\"Enricher: {} failed on current token: {}, output to write: {}\", name,\n+                            parser.currentToken(), MAPPER.readTree(tb.asParser()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce297babe90dce493b971927603e21dcb802d8df"}, "originalPosition": 49}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ce297babe90dce493b971927603e21dcb802d8df", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/ce297babe90dce493b971927603e21dcb802d8df", "committedDate": "2020-03-02T07:32:38Z", "message": "NXP-28560: fix catch AbstractJsonEnrichers Exception"}, "afterCommit": {"oid": "9ab000637f7c3fce75739042f705447c5abae363", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/9ab000637f7c3fce75739042f705447c5abae363", "committedDate": "2020-03-04T14:10:31Z", "message": "NXP-28560: fix catch AbstractJsonEnrichers Exception"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9ab000637f7c3fce75739042f705447c5abae363", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/9ab000637f7c3fce75739042f705447c5abae363", "committedDate": "2020-03-04T14:10:31Z", "message": "NXP-28560: fix catch AbstractJsonEnrichers Exception"}, "afterCommit": {"oid": "6cf598fbcafe78538725d9afe119ae742c86fc96", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/6cf598fbcafe78538725d9afe119ae742c86fc96", "committedDate": "2020-03-04T14:31:18Z", "message": "NXP-28560: fix catch AbstractJsonEnrichers Exception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4ODI2NTc2", "url": "https://github.com/nuxeo/nuxeo/pull/3804#pullrequestreview-368826576", "createdAt": "2020-03-04T14:33:21Z", "commit": {"oid": "6cf598fbcafe78538725d9afe119ae742c86fc96"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8999677cef4f76be5eb71cc38c185cdc878a6d3e", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/8999677cef4f76be5eb71cc38c185cdc878a6d3e", "committedDate": "2020-03-04T15:11:03Z", "message": "NXP-28560: fix catch AbstractJsonEnrichers Exception"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6cf598fbcafe78538725d9afe119ae742c86fc96", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/6cf598fbcafe78538725d9afe119ae742c86fc96", "committedDate": "2020-03-04T14:31:18Z", "message": "NXP-28560: fix catch AbstractJsonEnrichers Exception"}, "afterCommit": {"oid": "8999677cef4f76be5eb71cc38c185cdc878a6d3e", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/8999677cef4f76be5eb71cc38c185cdc878a6d3e", "committedDate": "2020-03-04T15:11:03Z", "message": "NXP-28560: fix catch AbstractJsonEnrichers Exception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4ODYzNjY0", "url": "https://github.com/nuxeo/nuxeo/pull/3804#pullrequestreview-368863664", "createdAt": "2020-03-04T15:15:48Z", "commit": {"oid": "8999677cef4f76be5eb71cc38c185cdc878a6d3e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NjI0OTAx", "url": "https://github.com/nuxeo/nuxeo/pull/3804#pullrequestreview-369624901", "createdAt": "2020-03-05T14:42:45Z", "commit": {"oid": "8999677cef4f76be5eb71cc38c185cdc878a6d3e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4867, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}