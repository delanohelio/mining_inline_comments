{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4MTg3MDUy", "number": 3705, "title": "Improvement-NXP-28576-Add-coverage-tests-on-mail-notification", "bodyText": "PR created from https://qa.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-saouana/186/\n2nd T&P -> https://qa.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-saouana/189/ after taking into account the code review", "createdAt": "2020-01-28T19:27:42Z", "url": "https://github.com/nuxeo/nuxeo/pull/3705", "merged": true, "mergeCommit": {"oid": "3ccead21e06e545ead7a399c0bd222d7b981326c"}, "closed": true, "closedAt": "2020-02-06T16:19:03Z", "author": {"login": "nuxeojenkins"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-5UNnAFqTM0OTc1NjMyMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBq8TOgFqTM1NDQ1NjE5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NzU2MzIx", "url": "https://github.com/nuxeo/nuxeo/pull/3705#pullrequestreview-349756321", "createdAt": "2020-01-28T22:40:37Z", "commit": {"oid": "9b5ef7f3014e2611da34c1cdff3836ce92f27670"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMjo0MDozN1rOFi3JaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMjo0NDo0OFrOFi3P-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA5OTQzMg==", "bodyText": "Please write these booleans asserts with an additional mailContent in first argument as the message that will get displayed if the boolean is false, for diagnostic purposes.", "url": "https://github.com/nuxeo/nuxeo/pull/3705#discussion_r372099432", "createdAt": "2020-01-28T22:40:37Z", "author": {"login": "efge"}, "path": "nuxeo-features/nuxeo-platform-notification/nuxeo-platform-notification-core/src/test/java/org/nuxeo/ecm/platform/ec/notification/TestEmailNotification.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *  \n+ * Contributors:\n+ *     Salem Aouana\n+ */\n+\n+package org.nuxeo.ecm.platform.ec.notification;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.NuxeoPrincipal;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventService;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.notification.api.NotificationManager;\n+import org.nuxeo.ecm.platform.test.PlatformFeature;\n+import org.nuxeo.mail.SmtpMailServerFeature;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+import org.nuxeo.runtime.test.runner.TransactionalFeature;\n+\n+import net.htmlparser.jericho.Renderer;\n+import net.htmlparser.jericho.Source;\n+\n+/**\n+ * Test the whole process: from subscribing to a given event until the reception of the mail notification on this event.\n+ *\n+ * @since 11.1\n+ */\n+@RunWith(FeaturesRunner.class)\n+@Features({ PlatformFeature.class, SmtpMailServerFeature.class })\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core.tests:OSGI-INF/notification-event-listener-contrib.xml\")\n+public class TestEmailNotification {\n+\n+    protected static final String DUMMY_NOTIFICATION_NAME = \"DummyNotificationToSendMail\";\n+\n+    protected static final String DUMMY_EVENT_NAME = \"dummyNotificationToSendMail\";\n+\n+    protected static final String DOCUMENT_NAME = \"anyFile\";\n+\n+    protected static final String ANOTHER_DOCUMENT_NAME = \"anyFile2\";\n+\n+    @Inject\n+    protected CoreSession session;\n+\n+    @Inject\n+    protected NotificationManager notificationManager;\n+\n+    @Inject\n+    protected EventService eventService;\n+\n+    @Inject\n+    protected TransactionalFeature transactionalFeature;\n+\n+    @Inject\n+    protected SmtpMailServerFeature.MailsResult emailsResult;\n+\n+    protected DocumentModel domain;\n+\n+    @Before\n+    public void before() {\n+        domain = session.createDocumentModel(\"/\", \"domain\", \"Domain\");\n+        domain = session.createDocument(domain);\n+    }\n+\n+    @Test\n+    public void shouldReceiveNotificationMailWhenSubscribeToMainDocument() {\n+        // create a File document and\n+        DocumentModel documentModel = createDocument(domain, DOCUMENT_NAME);\n+\n+        // subscribe to the dummy notification\n+        addSubscriptions(documentModel);\n+\n+        // fire the dummy event\n+        DocumentEventContext ctx = new DocumentEventContext(session, session.getPrincipal(), documentModel);\n+        Event event = ctx.newEvent(DUMMY_EVENT_NAME);\n+        eventService.fireEvent(event);\n+        transactionalFeature.nextTransaction();\n+\n+        // check the received mail\n+        checkMailContent(documentModel, DOCUMENT_NAME);\n+    }\n+\n+    @Test\n+    public void shouldReceiveNotificationMailWhenSubscribeToParentDocument() {\n+        // create a simple hierarchy (domain <- DOCUMENT_NAME <- ANOTHER_DOCUMENT_NAME)\n+        DocumentModel parentDocModel = createDocument(domain, DOCUMENT_NAME);\n+\n+        // subscribe to the dummy notification on the parent document\n+        addSubscriptions(parentDocModel);\n+\n+        // create a child document\n+        DocumentModel mainDocModel = createDocument(parentDocModel, ANOTHER_DOCUMENT_NAME);\n+\n+        // fire the dummy event on the child document\n+        DocumentEventContext ctx = new DocumentEventContext(session, session.getPrincipal(), mainDocModel);\n+        Event event = ctx.newEvent(DUMMY_EVENT_NAME);\n+        eventService.fireEvent(event);\n+        transactionalFeature.nextTransaction();\n+\n+        // check the received mail\n+        checkMailContent(mainDocModel, ANOTHER_DOCUMENT_NAME);\n+    }\n+\n+    protected void checkMailContent(final DocumentModel documentModel, String documentName) {\n+        assertEquals(1, emailsResult.getMails().size());\n+        SmtpMailServerFeature.MailMessage mailMessage = emailsResult.getMails().get(0);\n+        assertEquals(String.format(\"[Dummy]Notification on the document '%s'\", documentName), mailMessage.getSubject());\n+\n+        // check the mail content (see templates/dummyNotificationToSendMail.ftl)\n+        String mailContent = getMailContent(mailMessage);\n+        // description\n+        assertTrue(mailContent.contains(String.format(\"The document %s is now available.\", documentName)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b5ef7f3014e2611da34c1cdff3836ce92f27670"}, "originalPosition": 139}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA5OTg4OA==", "bodyText": "Why not match the full mail content, maybe with a regexp for the parts that are too random to predict (if any)?", "url": "https://github.com/nuxeo/nuxeo/pull/3705#discussion_r372099888", "createdAt": "2020-01-28T22:41:40Z", "author": {"login": "efge"}, "path": "nuxeo-features/nuxeo-platform-notification/nuxeo-platform-notification-core/src/test/java/org/nuxeo/ecm/platform/ec/notification/TestEmailNotification.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *  \n+ * Contributors:\n+ *     Salem Aouana\n+ */\n+\n+package org.nuxeo.ecm.platform.ec.notification;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.NuxeoPrincipal;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventService;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.notification.api.NotificationManager;\n+import org.nuxeo.ecm.platform.test.PlatformFeature;\n+import org.nuxeo.mail.SmtpMailServerFeature;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+import org.nuxeo.runtime.test.runner.TransactionalFeature;\n+\n+import net.htmlparser.jericho.Renderer;\n+import net.htmlparser.jericho.Source;\n+\n+/**\n+ * Test the whole process: from subscribing to a given event until the reception of the mail notification on this event.\n+ *\n+ * @since 11.1\n+ */\n+@RunWith(FeaturesRunner.class)\n+@Features({ PlatformFeature.class, SmtpMailServerFeature.class })\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core.tests:OSGI-INF/notification-event-listener-contrib.xml\")\n+public class TestEmailNotification {\n+\n+    protected static final String DUMMY_NOTIFICATION_NAME = \"DummyNotificationToSendMail\";\n+\n+    protected static final String DUMMY_EVENT_NAME = \"dummyNotificationToSendMail\";\n+\n+    protected static final String DOCUMENT_NAME = \"anyFile\";\n+\n+    protected static final String ANOTHER_DOCUMENT_NAME = \"anyFile2\";\n+\n+    @Inject\n+    protected CoreSession session;\n+\n+    @Inject\n+    protected NotificationManager notificationManager;\n+\n+    @Inject\n+    protected EventService eventService;\n+\n+    @Inject\n+    protected TransactionalFeature transactionalFeature;\n+\n+    @Inject\n+    protected SmtpMailServerFeature.MailsResult emailsResult;\n+\n+    protected DocumentModel domain;\n+\n+    @Before\n+    public void before() {\n+        domain = session.createDocumentModel(\"/\", \"domain\", \"Domain\");\n+        domain = session.createDocument(domain);\n+    }\n+\n+    @Test\n+    public void shouldReceiveNotificationMailWhenSubscribeToMainDocument() {\n+        // create a File document and\n+        DocumentModel documentModel = createDocument(domain, DOCUMENT_NAME);\n+\n+        // subscribe to the dummy notification\n+        addSubscriptions(documentModel);\n+\n+        // fire the dummy event\n+        DocumentEventContext ctx = new DocumentEventContext(session, session.getPrincipal(), documentModel);\n+        Event event = ctx.newEvent(DUMMY_EVENT_NAME);\n+        eventService.fireEvent(event);\n+        transactionalFeature.nextTransaction();\n+\n+        // check the received mail\n+        checkMailContent(documentModel, DOCUMENT_NAME);\n+    }\n+\n+    @Test\n+    public void shouldReceiveNotificationMailWhenSubscribeToParentDocument() {\n+        // create a simple hierarchy (domain <- DOCUMENT_NAME <- ANOTHER_DOCUMENT_NAME)\n+        DocumentModel parentDocModel = createDocument(domain, DOCUMENT_NAME);\n+\n+        // subscribe to the dummy notification on the parent document\n+        addSubscriptions(parentDocModel);\n+\n+        // create a child document\n+        DocumentModel mainDocModel = createDocument(parentDocModel, ANOTHER_DOCUMENT_NAME);\n+\n+        // fire the dummy event on the child document\n+        DocumentEventContext ctx = new DocumentEventContext(session, session.getPrincipal(), mainDocModel);\n+        Event event = ctx.newEvent(DUMMY_EVENT_NAME);\n+        eventService.fireEvent(event);\n+        transactionalFeature.nextTransaction();\n+\n+        // check the received mail\n+        checkMailContent(mainDocModel, ANOTHER_DOCUMENT_NAME);\n+    }\n+\n+    protected void checkMailContent(final DocumentModel documentModel, String documentName) {\n+        assertEquals(1, emailsResult.getMails().size());\n+        SmtpMailServerFeature.MailMessage mailMessage = emailsResult.getMails().get(0);\n+        assertEquals(String.format(\"[Dummy]Notification on the document '%s'\", documentName), mailMessage.getSubject());\n+\n+        // check the mail content (see templates/dummyNotificationToSendMail.ftl)\n+        String mailContent = getMailContent(mailMessage);\n+        // description\n+        assertTrue(mailContent.contains(String.format(\"The document %s is now available.\", documentName)));\n+        // author\n+        assertTrue(mailContent.contains(session.getPrincipal().getName()));\n+        // location\n+        assertTrue(mailContent.contains(documentModel.getPathAsString()));\n+        // version\n+        assertTrue(mailContent.contains(documentModel.getVersionLabel()));\n+        // state\n+        assertTrue(mailContent.contains(documentModel.getCurrentLifeCycleState()));\n+        // link to the document\n+        assertTrue(mailContent.contains(String.format(\"Consult the document %s\", documentName)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b5ef7f3014e2611da34c1cdff3836ce92f27670"}, "originalPosition": 149}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEwMDIzNg==", "bodyText": "Why this check, can't you assert that we get HTML? There's no variability here, is there?", "url": "https://github.com/nuxeo/nuxeo/pull/3705#discussion_r372100236", "createdAt": "2020-01-28T22:42:39Z", "author": {"login": "efge"}, "path": "nuxeo-features/nuxeo-platform-notification/nuxeo-platform-notification-core/src/test/java/org/nuxeo/ecm/platform/ec/notification/TestEmailNotification.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *  \n+ * Contributors:\n+ *     Salem Aouana\n+ */\n+\n+package org.nuxeo.ecm.platform.ec.notification;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.NuxeoPrincipal;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventService;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.notification.api.NotificationManager;\n+import org.nuxeo.ecm.platform.test.PlatformFeature;\n+import org.nuxeo.mail.SmtpMailServerFeature;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+import org.nuxeo.runtime.test.runner.TransactionalFeature;\n+\n+import net.htmlparser.jericho.Renderer;\n+import net.htmlparser.jericho.Source;\n+\n+/**\n+ * Test the whole process: from subscribing to a given event until the reception of the mail notification on this event.\n+ *\n+ * @since 11.1\n+ */\n+@RunWith(FeaturesRunner.class)\n+@Features({ PlatformFeature.class, SmtpMailServerFeature.class })\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core.tests:OSGI-INF/notification-event-listener-contrib.xml\")\n+public class TestEmailNotification {\n+\n+    protected static final String DUMMY_NOTIFICATION_NAME = \"DummyNotificationToSendMail\";\n+\n+    protected static final String DUMMY_EVENT_NAME = \"dummyNotificationToSendMail\";\n+\n+    protected static final String DOCUMENT_NAME = \"anyFile\";\n+\n+    protected static final String ANOTHER_DOCUMENT_NAME = \"anyFile2\";\n+\n+    @Inject\n+    protected CoreSession session;\n+\n+    @Inject\n+    protected NotificationManager notificationManager;\n+\n+    @Inject\n+    protected EventService eventService;\n+\n+    @Inject\n+    protected TransactionalFeature transactionalFeature;\n+\n+    @Inject\n+    protected SmtpMailServerFeature.MailsResult emailsResult;\n+\n+    protected DocumentModel domain;\n+\n+    @Before\n+    public void before() {\n+        domain = session.createDocumentModel(\"/\", \"domain\", \"Domain\");\n+        domain = session.createDocument(domain);\n+    }\n+\n+    @Test\n+    public void shouldReceiveNotificationMailWhenSubscribeToMainDocument() {\n+        // create a File document and\n+        DocumentModel documentModel = createDocument(domain, DOCUMENT_NAME);\n+\n+        // subscribe to the dummy notification\n+        addSubscriptions(documentModel);\n+\n+        // fire the dummy event\n+        DocumentEventContext ctx = new DocumentEventContext(session, session.getPrincipal(), documentModel);\n+        Event event = ctx.newEvent(DUMMY_EVENT_NAME);\n+        eventService.fireEvent(event);\n+        transactionalFeature.nextTransaction();\n+\n+        // check the received mail\n+        checkMailContent(documentModel, DOCUMENT_NAME);\n+    }\n+\n+    @Test\n+    public void shouldReceiveNotificationMailWhenSubscribeToParentDocument() {\n+        // create a simple hierarchy (domain <- DOCUMENT_NAME <- ANOTHER_DOCUMENT_NAME)\n+        DocumentModel parentDocModel = createDocument(domain, DOCUMENT_NAME);\n+\n+        // subscribe to the dummy notification on the parent document\n+        addSubscriptions(parentDocModel);\n+\n+        // create a child document\n+        DocumentModel mainDocModel = createDocument(parentDocModel, ANOTHER_DOCUMENT_NAME);\n+\n+        // fire the dummy event on the child document\n+        DocumentEventContext ctx = new DocumentEventContext(session, session.getPrincipal(), mainDocModel);\n+        Event event = ctx.newEvent(DUMMY_EVENT_NAME);\n+        eventService.fireEvent(event);\n+        transactionalFeature.nextTransaction();\n+\n+        // check the received mail\n+        checkMailContent(mainDocModel, ANOTHER_DOCUMENT_NAME);\n+    }\n+\n+    protected void checkMailContent(final DocumentModel documentModel, String documentName) {\n+        assertEquals(1, emailsResult.getMails().size());\n+        SmtpMailServerFeature.MailMessage mailMessage = emailsResult.getMails().get(0);\n+        assertEquals(String.format(\"[Dummy]Notification on the document '%s'\", documentName), mailMessage.getSubject());\n+\n+        // check the mail content (see templates/dummyNotificationToSendMail.ftl)\n+        String mailContent = getMailContent(mailMessage);\n+        // description\n+        assertTrue(mailContent.contains(String.format(\"The document %s is now available.\", documentName)));\n+        // author\n+        assertTrue(mailContent.contains(session.getPrincipal().getName()));\n+        // location\n+        assertTrue(mailContent.contains(documentModel.getPathAsString()));\n+        // version\n+        assertTrue(mailContent.contains(documentModel.getVersionLabel()));\n+        // state\n+        assertTrue(mailContent.contains(documentModel.getCurrentLifeCycleState()));\n+        // link to the document\n+        assertTrue(mailContent.contains(String.format(\"Consult the document %s\", documentName)));\n+    }\n+\n+    protected DocumentModel createDocument(DocumentModel parent, String name) {\n+        DocumentModel documentModel = session.createDocumentModel(parent.getPathAsString(), name, \"File\");\n+        return session.createDocument(documentModel);\n+    }\n+\n+    protected void addSubscriptions(DocumentModel documentModel) {\n+        NuxeoPrincipal principal = session.getPrincipal();\n+        String subscriber = NotificationConstants.USER_PREFIX + principal.getName();\n+        notificationManager.addSubscription(subscriber, DUMMY_NOTIFICATION_NAME, documentModel, false, principal,\n+                DUMMY_NOTIFICATION_NAME);\n+    }\n+\n+    protected String getMailContent(SmtpMailServerFeature.MailMessage mailMessage) {\n+        String content = mailMessage.getContent();\n+        if (!mailMessage.getContentType().contains(\"text/html\")) {\n+            return content;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b5ef7f3014e2611da34c1cdff3836ce92f27670"}, "originalPosition": 167}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEwMDQ1Mg==", "bodyText": "You don't need CSS for a dummy email.", "url": "https://github.com/nuxeo/nuxeo/pull/3705#discussion_r372100452", "createdAt": "2020-01-28T22:43:07Z", "author": {"login": "efge"}, "path": "nuxeo-features/nuxeo-platform-notification/nuxeo-platform-notification-core/src/test/resources/templates/dummyNotificationToSendMail.ftl", "diffHunk": "@@ -0,0 +1,110 @@\n+<html>\n+<head>\n+    <style>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b5ef7f3014e2611da34c1cdff3836ce92f27670"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEwMTExMw==", "bodyText": "As it's a dummy you don't need complex formatting, the requested strings could be one after the other.", "url": "https://github.com/nuxeo/nuxeo/pull/3705#discussion_r372101113", "createdAt": "2020-01-28T22:44:48Z", "author": {"login": "efge"}, "path": "nuxeo-features/nuxeo-platform-notification/nuxeo-platform-notification-core/src/test/resources/templates/dummyNotificationToSendMail.ftl", "diffHunk": "@@ -0,0 +1,110 @@\n+<html>\n+<head>\n+    <style>\n+        div {\n+            margin: 0;\n+            padding: 0;\n+            background-color: #e9ecef;\n+            font-family: Arial, sans-serif;\n+            marginheight: 0;\n+            marginwidth: 0;\n+        }\n+\n+        table {\n+            margin: 0;\n+            padding: 0;\n+            border: none;\n+        }\n+\n+        td {\n+            border-collapse: collapse;\n+            margin: 0;\n+            padding: 20px;\n+            border-top: 0;\n+            align-content: center;\n+            vertical-align: top;\n+            border: 1px solid #eee;\n+            color: #000;\n+            font-size: 13px;\n+        }\n+\n+        p {\n+            font-size: 13px;\n+        }\n+\n+        .propertyName {\n+            color: #888;\n+        }\n+\n+        .a {\n+            color: #22aee8;\n+            text-decoration: underline;\n+            word-wrap: break-word !important;\n+        }\n+    </style>\n+</head>\n+<body>\n+<div>\n+    <br/>\n+    <p>The document ${htmlEscape(docTitle)} is now available.</p>\n+    <table>\n+        <tbody>\n+        <tr>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b5ef7f3014e2611da34c1cdff3836ce92f27670"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5ODkxNjQ5", "url": "https://github.com/nuxeo/nuxeo/pull/3705#pullrequestreview-349891649", "createdAt": "2020-01-29T06:53:41Z", "commit": {"oid": "9b5ef7f3014e2611da34c1cdff3836ce92f27670"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNjo1Mzo0MVrOFi-JSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNjo1Mzo0MVrOFi-JSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIxNDA5MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Test the whole process: from subscribing to a given event until the reception of the mail notification on this event.\n          \n          \n            \n             * Tests the whole email notification process: from subscribing to a given event to the reception of the email for this event.", "url": "https://github.com/nuxeo/nuxeo/pull/3705#discussion_r372214091", "createdAt": "2020-01-29T06:53:41Z", "author": {"login": "ataillefer"}, "path": "nuxeo-features/nuxeo-platform-notification/nuxeo-platform-notification-core/src/test/java/org/nuxeo/ecm/platform/ec/notification/TestEmailNotification.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *  \n+ * Contributors:\n+ *     Salem Aouana\n+ */\n+\n+package org.nuxeo.ecm.platform.ec.notification;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.NuxeoPrincipal;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventService;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.notification.api.NotificationManager;\n+import org.nuxeo.ecm.platform.test.PlatformFeature;\n+import org.nuxeo.mail.SmtpMailServerFeature;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+import org.nuxeo.runtime.test.runner.TransactionalFeature;\n+\n+import net.htmlparser.jericho.Renderer;\n+import net.htmlparser.jericho.Source;\n+\n+/**\n+ * Test the whole process: from subscribing to a given event until the reception of the mail notification on this event.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b5ef7f3014e2611da34c1cdff3836ce92f27670"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5ODkyNDUz", "url": "https://github.com/nuxeo/nuxeo/pull/3705#pullrequestreview-349892453", "createdAt": "2020-01-29T06:56:30Z", "commit": {"oid": "9b5ef7f3014e2611da34c1cdff3836ce92f27670"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNjo1NjozMVrOFi-L3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNjo1NjozMVrOFi-L3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIxNDc1MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void shouldReceiveNotificationMailWhenSubscribeToMainDocument() {\n          \n          \n            \n                public void shouldReceiveNotificationMailWhenSubscribeToDocument() {\n          \n      \n    \n    \n  \n\nMain sounds weird, having another  test with \"ParentDocument\" seems enough to distinguish.", "url": "https://github.com/nuxeo/nuxeo/pull/3705#discussion_r372214751", "createdAt": "2020-01-29T06:56:31Z", "author": {"login": "ataillefer"}, "path": "nuxeo-features/nuxeo-platform-notification/nuxeo-platform-notification-core/src/test/java/org/nuxeo/ecm/platform/ec/notification/TestEmailNotification.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *  \n+ * Contributors:\n+ *     Salem Aouana\n+ */\n+\n+package org.nuxeo.ecm.platform.ec.notification;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.NuxeoPrincipal;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventService;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.notification.api.NotificationManager;\n+import org.nuxeo.ecm.platform.test.PlatformFeature;\n+import org.nuxeo.mail.SmtpMailServerFeature;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+import org.nuxeo.runtime.test.runner.TransactionalFeature;\n+\n+import net.htmlparser.jericho.Renderer;\n+import net.htmlparser.jericho.Source;\n+\n+/**\n+ * Test the whole process: from subscribing to a given event until the reception of the mail notification on this event.\n+ *\n+ * @since 11.1\n+ */\n+@RunWith(FeaturesRunner.class)\n+@Features({ PlatformFeature.class, SmtpMailServerFeature.class })\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core.tests:OSGI-INF/notification-event-listener-contrib.xml\")\n+public class TestEmailNotification {\n+\n+    protected static final String DUMMY_NOTIFICATION_NAME = \"DummyNotificationToSendMail\";\n+\n+    protected static final String DUMMY_EVENT_NAME = \"dummyNotificationToSendMail\";\n+\n+    protected static final String DOCUMENT_NAME = \"anyFile\";\n+\n+    protected static final String ANOTHER_DOCUMENT_NAME = \"anyFile2\";\n+\n+    @Inject\n+    protected CoreSession session;\n+\n+    @Inject\n+    protected NotificationManager notificationManager;\n+\n+    @Inject\n+    protected EventService eventService;\n+\n+    @Inject\n+    protected TransactionalFeature transactionalFeature;\n+\n+    @Inject\n+    protected SmtpMailServerFeature.MailsResult emailsResult;\n+\n+    protected DocumentModel domain;\n+\n+    @Before\n+    public void before() {\n+        domain = session.createDocumentModel(\"/\", \"domain\", \"Domain\");\n+        domain = session.createDocument(domain);\n+    }\n+\n+    @Test\n+    public void shouldReceiveNotificationMailWhenSubscribeToMainDocument() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b5ef7f3014e2611da34c1cdff3836ce92f27670"}, "originalPosition": 93}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5ODkyNTUw", "url": "https://github.com/nuxeo/nuxeo/pull/3705#pullrequestreview-349892550", "createdAt": "2020-01-29T06:56:50Z", "commit": {"oid": "9b5ef7f3014e2611da34c1cdff3836ce92f27670"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNjo1Njo1MVrOFi-MKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNjo1Njo1MVrOFi-MKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIxNDgyNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // create a File document and\n          \n          \n            \n                    // create a File document", "url": "https://github.com/nuxeo/nuxeo/pull/3705#discussion_r372214827", "createdAt": "2020-01-29T06:56:51Z", "author": {"login": "ataillefer"}, "path": "nuxeo-features/nuxeo-platform-notification/nuxeo-platform-notification-core/src/test/java/org/nuxeo/ecm/platform/ec/notification/TestEmailNotification.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *  \n+ * Contributors:\n+ *     Salem Aouana\n+ */\n+\n+package org.nuxeo.ecm.platform.ec.notification;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.NuxeoPrincipal;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventService;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.notification.api.NotificationManager;\n+import org.nuxeo.ecm.platform.test.PlatformFeature;\n+import org.nuxeo.mail.SmtpMailServerFeature;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+import org.nuxeo.runtime.test.runner.TransactionalFeature;\n+\n+import net.htmlparser.jericho.Renderer;\n+import net.htmlparser.jericho.Source;\n+\n+/**\n+ * Test the whole process: from subscribing to a given event until the reception of the mail notification on this event.\n+ *\n+ * @since 11.1\n+ */\n+@RunWith(FeaturesRunner.class)\n+@Features({ PlatformFeature.class, SmtpMailServerFeature.class })\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core.tests:OSGI-INF/notification-event-listener-contrib.xml\")\n+public class TestEmailNotification {\n+\n+    protected static final String DUMMY_NOTIFICATION_NAME = \"DummyNotificationToSendMail\";\n+\n+    protected static final String DUMMY_EVENT_NAME = \"dummyNotificationToSendMail\";\n+\n+    protected static final String DOCUMENT_NAME = \"anyFile\";\n+\n+    protected static final String ANOTHER_DOCUMENT_NAME = \"anyFile2\";\n+\n+    @Inject\n+    protected CoreSession session;\n+\n+    @Inject\n+    protected NotificationManager notificationManager;\n+\n+    @Inject\n+    protected EventService eventService;\n+\n+    @Inject\n+    protected TransactionalFeature transactionalFeature;\n+\n+    @Inject\n+    protected SmtpMailServerFeature.MailsResult emailsResult;\n+\n+    protected DocumentModel domain;\n+\n+    @Before\n+    public void before() {\n+        domain = session.createDocumentModel(\"/\", \"domain\", \"Domain\");\n+        domain = session.createDocument(domain);\n+    }\n+\n+    @Test\n+    public void shouldReceiveNotificationMailWhenSubscribeToMainDocument() {\n+        // create a File document and", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b5ef7f3014e2611da34c1cdff3836ce92f27670"}, "originalPosition": 94}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5ODkyOTI2", "url": "https://github.com/nuxeo/nuxeo/pull/3705#pullrequestreview-349892926", "createdAt": "2020-01-29T06:58:05Z", "commit": {"oid": "9b5ef7f3014e2611da34c1cdff3836ce92f27670"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNjo1ODowNVrOFi-NUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNjo1ODowNVrOFi-NUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIxNTEyMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                protected void addSubscriptions(DocumentModel documentModel) {\n          \n          \n            \n                protected void addSubscription(DocumentModel documentModel) {", "url": "https://github.com/nuxeo/nuxeo/pull/3705#discussion_r372215123", "createdAt": "2020-01-29T06:58:05Z", "author": {"login": "ataillefer"}, "path": "nuxeo-features/nuxeo-platform-notification/nuxeo-platform-notification-core/src/test/java/org/nuxeo/ecm/platform/ec/notification/TestEmailNotification.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *  \n+ * Contributors:\n+ *     Salem Aouana\n+ */\n+\n+package org.nuxeo.ecm.platform.ec.notification;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.NuxeoPrincipal;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventService;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.notification.api.NotificationManager;\n+import org.nuxeo.ecm.platform.test.PlatformFeature;\n+import org.nuxeo.mail.SmtpMailServerFeature;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+import org.nuxeo.runtime.test.runner.TransactionalFeature;\n+\n+import net.htmlparser.jericho.Renderer;\n+import net.htmlparser.jericho.Source;\n+\n+/**\n+ * Test the whole process: from subscribing to a given event until the reception of the mail notification on this event.\n+ *\n+ * @since 11.1\n+ */\n+@RunWith(FeaturesRunner.class)\n+@Features({ PlatformFeature.class, SmtpMailServerFeature.class })\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core.tests:OSGI-INF/notification-event-listener-contrib.xml\")\n+public class TestEmailNotification {\n+\n+    protected static final String DUMMY_NOTIFICATION_NAME = \"DummyNotificationToSendMail\";\n+\n+    protected static final String DUMMY_EVENT_NAME = \"dummyNotificationToSendMail\";\n+\n+    protected static final String DOCUMENT_NAME = \"anyFile\";\n+\n+    protected static final String ANOTHER_DOCUMENT_NAME = \"anyFile2\";\n+\n+    @Inject\n+    protected CoreSession session;\n+\n+    @Inject\n+    protected NotificationManager notificationManager;\n+\n+    @Inject\n+    protected EventService eventService;\n+\n+    @Inject\n+    protected TransactionalFeature transactionalFeature;\n+\n+    @Inject\n+    protected SmtpMailServerFeature.MailsResult emailsResult;\n+\n+    protected DocumentModel domain;\n+\n+    @Before\n+    public void before() {\n+        domain = session.createDocumentModel(\"/\", \"domain\", \"Domain\");\n+        domain = session.createDocument(domain);\n+    }\n+\n+    @Test\n+    public void shouldReceiveNotificationMailWhenSubscribeToMainDocument() {\n+        // create a File document and\n+        DocumentModel documentModel = createDocument(domain, DOCUMENT_NAME);\n+\n+        // subscribe to the dummy notification\n+        addSubscriptions(documentModel);\n+\n+        // fire the dummy event\n+        DocumentEventContext ctx = new DocumentEventContext(session, session.getPrincipal(), documentModel);\n+        Event event = ctx.newEvent(DUMMY_EVENT_NAME);\n+        eventService.fireEvent(event);\n+        transactionalFeature.nextTransaction();\n+\n+        // check the received mail\n+        checkMailContent(documentModel, DOCUMENT_NAME);\n+    }\n+\n+    @Test\n+    public void shouldReceiveNotificationMailWhenSubscribeToParentDocument() {\n+        // create a simple hierarchy (domain <- DOCUMENT_NAME <- ANOTHER_DOCUMENT_NAME)\n+        DocumentModel parentDocModel = createDocument(domain, DOCUMENT_NAME);\n+\n+        // subscribe to the dummy notification on the parent document\n+        addSubscriptions(parentDocModel);\n+\n+        // create a child document\n+        DocumentModel mainDocModel = createDocument(parentDocModel, ANOTHER_DOCUMENT_NAME);\n+\n+        // fire the dummy event on the child document\n+        DocumentEventContext ctx = new DocumentEventContext(session, session.getPrincipal(), mainDocModel);\n+        Event event = ctx.newEvent(DUMMY_EVENT_NAME);\n+        eventService.fireEvent(event);\n+        transactionalFeature.nextTransaction();\n+\n+        // check the received mail\n+        checkMailContent(mainDocModel, ANOTHER_DOCUMENT_NAME);\n+    }\n+\n+    protected void checkMailContent(final DocumentModel documentModel, String documentName) {\n+        assertEquals(1, emailsResult.getMails().size());\n+        SmtpMailServerFeature.MailMessage mailMessage = emailsResult.getMails().get(0);\n+        assertEquals(String.format(\"[Dummy]Notification on the document '%s'\", documentName), mailMessage.getSubject());\n+\n+        // check the mail content (see templates/dummyNotificationToSendMail.ftl)\n+        String mailContent = getMailContent(mailMessage);\n+        // description\n+        assertTrue(mailContent.contains(String.format(\"The document %s is now available.\", documentName)));\n+        // author\n+        assertTrue(mailContent.contains(session.getPrincipal().getName()));\n+        // location\n+        assertTrue(mailContent.contains(documentModel.getPathAsString()));\n+        // version\n+        assertTrue(mailContent.contains(documentModel.getVersionLabel()));\n+        // state\n+        assertTrue(mailContent.contains(documentModel.getCurrentLifeCycleState()));\n+        // link to the document\n+        assertTrue(mailContent.contains(String.format(\"Consult the document %s\", documentName)));\n+    }\n+\n+    protected DocumentModel createDocument(DocumentModel parent, String name) {\n+        DocumentModel documentModel = session.createDocumentModel(parent.getPathAsString(), name, \"File\");\n+        return session.createDocument(documentModel);\n+    }\n+\n+    protected void addSubscriptions(DocumentModel documentModel) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b5ef7f3014e2611da34c1cdff3836ce92f27670"}, "originalPosition": 157}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5ODk4NTI2", "url": "https://github.com/nuxeo/nuxeo/pull/3705#pullrequestreview-349898526", "createdAt": "2020-01-29T07:12:11Z", "commit": {"oid": "9b5ef7f3014e2611da34c1cdff3836ce92f27670"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNzoxMjoxMVrOFi-bYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNzoxMjoxMVrOFi-bYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIxODcyMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            <component name=\"org.nuxeo.ecm.core.event.listener.contribution.test\">\n          \n          \n            \n            <component name=\"org.nuxeo.ecm.core.notification.email.test\">", "url": "https://github.com/nuxeo/nuxeo/pull/3705#discussion_r372218723", "createdAt": "2020-01-29T07:12:11Z", "author": {"login": "ataillefer"}, "path": "nuxeo-features/nuxeo-platform-notification/nuxeo-platform-notification-core/src/test/resources/OSGI-INF/notification-event-listener-contrib.xml", "diffHunk": "@@ -0,0 +1,33 @@\n+<?xml version=\"1.0\"?>\n+<component name=\"org.nuxeo.ecm.core.event.listener.contribution.test\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b5ef7f3014e2611da34c1cdff3836ce92f27670"}, "originalPosition": 2}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5OTAwMTgy", "url": "https://github.com/nuxeo/nuxeo/pull/3705#pullrequestreview-349900182", "createdAt": "2020-01-29T07:13:39Z", "commit": {"oid": "9b5ef7f3014e2611da34c1cdff3836ce92f27670"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNzoxMzozOVrOFi-dfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNzoxMzozOVrOFi-dfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIxOTI2Mg==", "bodyText": "Not clear, you're contributing a notification, not a listener.\nI would remove the comment, it's self explanatory.", "url": "https://github.com/nuxeo/nuxeo/pull/3705#discussion_r372219262", "createdAt": "2020-01-29T07:13:39Z", "author": {"login": "ataillefer"}, "path": "nuxeo-features/nuxeo-platform-notification/nuxeo-platform-notification-core/src/test/resources/OSGI-INF/notification-event-listener-contrib.xml", "diffHunk": "@@ -0,0 +1,33 @@\n+<?xml version=\"1.0\"?>\n+<component name=\"org.nuxeo.ecm.core.event.listener.contribution.test\">\n+\n+  <extension target=\"org.nuxeo.ecm.platform.ec.notification.service.NotificationService\"\n+             point=\"generalSettings\">\n+    <settings>\n+      <serverPrefix>http://localhost:8080/nuxeo/</serverPrefix>\n+      <eMailSubjectPrefix>[Dummy]</eMailSubjectPrefix>\n+      <mailSessionJndiName>java:comp/env/Mail</mailSessionJndiName>\n+    </settings>\n+  </extension>\n+\n+  <!-- define the listener that will be responsible for sending the mails -->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b5ef7f3014e2611da34c1cdff3836ce92f27670"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5OTAwOTk5", "url": "https://github.com/nuxeo/nuxeo/pull/3705#pullrequestreview-349900999", "createdAt": "2020-01-29T07:16:07Z", "commit": {"oid": "9b5ef7f3014e2611da34c1cdff3836ce92f27670"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNzoxNjowN1rOFi-itw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNzoxNjowN1rOFi-itw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIyMDU5OQ==", "bodyText": "Maybe remove the default or unneeded values, to make it shorter: enabled, autoSubscribed, label.", "url": "https://github.com/nuxeo/nuxeo/pull/3705#discussion_r372220599", "createdAt": "2020-01-29T07:16:07Z", "author": {"login": "ataillefer"}, "path": "nuxeo-features/nuxeo-platform-notification/nuxeo-platform-notification-core/src/test/resources/OSGI-INF/notification-event-listener-contrib.xml", "diffHunk": "@@ -0,0 +1,33 @@\n+<?xml version=\"1.0\"?>\n+<component name=\"org.nuxeo.ecm.core.event.listener.contribution.test\">\n+\n+  <extension target=\"org.nuxeo.ecm.platform.ec.notification.service.NotificationService\"\n+             point=\"generalSettings\">\n+    <settings>\n+      <serverPrefix>http://localhost:8080/nuxeo/</serverPrefix>\n+      <eMailSubjectPrefix>[Dummy]</eMailSubjectPrefix>\n+      <mailSessionJndiName>java:comp/env/Mail</mailSessionJndiName>\n+    </settings>\n+  </extension>\n+\n+  <!-- define the listener that will be responsible for sending the mails -->\n+  <extension\n+    target=\"org.nuxeo.ecm.platform.ec.notification.service.NotificationService\"\n+    point=\"notifications\">\n+\n+    <notification name=\"DummyNotificationToSendMail\" channel=\"email\" enabled=\"true\" availableIn=\"*\"\n+                  subject=\"Notification on the document '${docTitle}'\"\n+                  autoSubscribed=\"false\" template=\"dummyNotificationToSendMail\"\n+                  label=\"label.document.download\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b5ef7f3014e2611da34c1cdff3836ce92f27670"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5OTAxODQ2", "url": "https://github.com/nuxeo/nuxeo/pull/3705#pullrequestreview-349901846", "createdAt": "2020-01-29T07:18:49Z", "commit": {"oid": "9b5ef7f3014e2611da34c1cdff3836ce92f27670"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNzoxODo0OVrOFi-oUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNzoxODo0OVrOFi-oUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIyMjAzNQ==", "bodyText": "Could be placed right after DocumentModel parentDocModel = createDocument(domain, DOCUMENT_NAME); to clearly match the comment \"create a simple hierarchy (domain <- DOCUMENT_NAME <- ANOTHER_DOCUMENT_NAME)\".", "url": "https://github.com/nuxeo/nuxeo/pull/3705#discussion_r372222035", "createdAt": "2020-01-29T07:18:49Z", "author": {"login": "ataillefer"}, "path": "nuxeo-features/nuxeo-platform-notification/nuxeo-platform-notification-core/src/test/java/org/nuxeo/ecm/platform/ec/notification/TestEmailNotification.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *  \n+ * Contributors:\n+ *     Salem Aouana\n+ */\n+\n+package org.nuxeo.ecm.platform.ec.notification;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.NuxeoPrincipal;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventService;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.notification.api.NotificationManager;\n+import org.nuxeo.ecm.platform.test.PlatformFeature;\n+import org.nuxeo.mail.SmtpMailServerFeature;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+import org.nuxeo.runtime.test.runner.TransactionalFeature;\n+\n+import net.htmlparser.jericho.Renderer;\n+import net.htmlparser.jericho.Source;\n+\n+/**\n+ * Test the whole process: from subscribing to a given event until the reception of the mail notification on this event.\n+ *\n+ * @since 11.1\n+ */\n+@RunWith(FeaturesRunner.class)\n+@Features({ PlatformFeature.class, SmtpMailServerFeature.class })\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core.tests:OSGI-INF/notification-event-listener-contrib.xml\")\n+public class TestEmailNotification {\n+\n+    protected static final String DUMMY_NOTIFICATION_NAME = \"DummyNotificationToSendMail\";\n+\n+    protected static final String DUMMY_EVENT_NAME = \"dummyNotificationToSendMail\";\n+\n+    protected static final String DOCUMENT_NAME = \"anyFile\";\n+\n+    protected static final String ANOTHER_DOCUMENT_NAME = \"anyFile2\";\n+\n+    @Inject\n+    protected CoreSession session;\n+\n+    @Inject\n+    protected NotificationManager notificationManager;\n+\n+    @Inject\n+    protected EventService eventService;\n+\n+    @Inject\n+    protected TransactionalFeature transactionalFeature;\n+\n+    @Inject\n+    protected SmtpMailServerFeature.MailsResult emailsResult;\n+\n+    protected DocumentModel domain;\n+\n+    @Before\n+    public void before() {\n+        domain = session.createDocumentModel(\"/\", \"domain\", \"Domain\");\n+        domain = session.createDocument(domain);\n+    }\n+\n+    @Test\n+    public void shouldReceiveNotificationMailWhenSubscribeToMainDocument() {\n+        // create a File document and\n+        DocumentModel documentModel = createDocument(domain, DOCUMENT_NAME);\n+\n+        // subscribe to the dummy notification\n+        addSubscriptions(documentModel);\n+\n+        // fire the dummy event\n+        DocumentEventContext ctx = new DocumentEventContext(session, session.getPrincipal(), documentModel);\n+        Event event = ctx.newEvent(DUMMY_EVENT_NAME);\n+        eventService.fireEvent(event);\n+        transactionalFeature.nextTransaction();\n+\n+        // check the received mail\n+        checkMailContent(documentModel, DOCUMENT_NAME);\n+    }\n+\n+    @Test\n+    public void shouldReceiveNotificationMailWhenSubscribeToParentDocument() {\n+        // create a simple hierarchy (domain <- DOCUMENT_NAME <- ANOTHER_DOCUMENT_NAME)\n+        DocumentModel parentDocModel = createDocument(domain, DOCUMENT_NAME);\n+\n+        // subscribe to the dummy notification on the parent document\n+        addSubscriptions(parentDocModel);\n+\n+        // create a child document\n+        DocumentModel mainDocModel = createDocument(parentDocModel, ANOTHER_DOCUMENT_NAME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b5ef7f3014e2611da34c1cdff3836ce92f27670"}, "originalPosition": 119}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5OTU1NzY2", "url": "https://github.com/nuxeo/nuxeo/pull/3705#pullrequestreview-349955766", "createdAt": "2020-01-29T09:15:16Z", "commit": {"oid": "9b5ef7f3014e2611da34c1cdff3836ce92f27670"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOToxNToxNlrOFjBQ6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOToxNToxNlrOFjBQ6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI2NTE5NQ==", "bodyText": "No need for final keyword.", "url": "https://github.com/nuxeo/nuxeo/pull/3705#discussion_r372265195", "createdAt": "2020-01-29T09:15:16Z", "author": {"login": "kevinleturc"}, "path": "nuxeo-features/nuxeo-platform-notification/nuxeo-platform-notification-core/src/test/java/org/nuxeo/ecm/platform/ec/notification/TestEmailNotification.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *  \n+ * Contributors:\n+ *     Salem Aouana\n+ */\n+\n+package org.nuxeo.ecm.platform.ec.notification;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.NuxeoPrincipal;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventService;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.notification.api.NotificationManager;\n+import org.nuxeo.ecm.platform.test.PlatformFeature;\n+import org.nuxeo.mail.SmtpMailServerFeature;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+import org.nuxeo.runtime.test.runner.TransactionalFeature;\n+\n+import net.htmlparser.jericho.Renderer;\n+import net.htmlparser.jericho.Source;\n+\n+/**\n+ * Test the whole process: from subscribing to a given event until the reception of the mail notification on this event.\n+ *\n+ * @since 11.1\n+ */\n+@RunWith(FeaturesRunner.class)\n+@Features({ PlatformFeature.class, SmtpMailServerFeature.class })\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core.tests:OSGI-INF/notification-event-listener-contrib.xml\")\n+public class TestEmailNotification {\n+\n+    protected static final String DUMMY_NOTIFICATION_NAME = \"DummyNotificationToSendMail\";\n+\n+    protected static final String DUMMY_EVENT_NAME = \"dummyNotificationToSendMail\";\n+\n+    protected static final String DOCUMENT_NAME = \"anyFile\";\n+\n+    protected static final String ANOTHER_DOCUMENT_NAME = \"anyFile2\";\n+\n+    @Inject\n+    protected CoreSession session;\n+\n+    @Inject\n+    protected NotificationManager notificationManager;\n+\n+    @Inject\n+    protected EventService eventService;\n+\n+    @Inject\n+    protected TransactionalFeature transactionalFeature;\n+\n+    @Inject\n+    protected SmtpMailServerFeature.MailsResult emailsResult;\n+\n+    protected DocumentModel domain;\n+\n+    @Before\n+    public void before() {\n+        domain = session.createDocumentModel(\"/\", \"domain\", \"Domain\");\n+        domain = session.createDocument(domain);\n+    }\n+\n+    @Test\n+    public void shouldReceiveNotificationMailWhenSubscribeToMainDocument() {\n+        // create a File document and\n+        DocumentModel documentModel = createDocument(domain, DOCUMENT_NAME);\n+\n+        // subscribe to the dummy notification\n+        addSubscriptions(documentModel);\n+\n+        // fire the dummy event\n+        DocumentEventContext ctx = new DocumentEventContext(session, session.getPrincipal(), documentModel);\n+        Event event = ctx.newEvent(DUMMY_EVENT_NAME);\n+        eventService.fireEvent(event);\n+        transactionalFeature.nextTransaction();\n+\n+        // check the received mail\n+        checkMailContent(documentModel, DOCUMENT_NAME);\n+    }\n+\n+    @Test\n+    public void shouldReceiveNotificationMailWhenSubscribeToParentDocument() {\n+        // create a simple hierarchy (domain <- DOCUMENT_NAME <- ANOTHER_DOCUMENT_NAME)\n+        DocumentModel parentDocModel = createDocument(domain, DOCUMENT_NAME);\n+\n+        // subscribe to the dummy notification on the parent document\n+        addSubscriptions(parentDocModel);\n+\n+        // create a child document\n+        DocumentModel mainDocModel = createDocument(parentDocModel, ANOTHER_DOCUMENT_NAME);\n+\n+        // fire the dummy event on the child document\n+        DocumentEventContext ctx = new DocumentEventContext(session, session.getPrincipal(), mainDocModel);\n+        Event event = ctx.newEvent(DUMMY_EVENT_NAME);\n+        eventService.fireEvent(event);\n+        transactionalFeature.nextTransaction();\n+\n+        // check the received mail\n+        checkMailContent(mainDocModel, ANOTHER_DOCUMENT_NAME);\n+    }\n+\n+    protected void checkMailContent(final DocumentModel documentModel, String documentName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b5ef7f3014e2611da34c1cdff3836ce92f27670"}, "originalPosition": 131}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9b5ef7f3014e2611da34c1cdff3836ce92f27670", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/9b5ef7f3014e2611da34c1cdff3836ce92f27670", "committedDate": "2020-01-28T14:34:03Z", "message": "NXP-28576: Add test coverage on mail notification"}, "afterCommit": {"oid": "ae4369b1dfaccb0986aac663d69fd95d0984abb4", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/ae4369b1dfaccb0986aac663d69fd95d0984abb4", "committedDate": "2020-01-29T12:39:11Z", "message": "NXP-28576: Add test coverage on mail notification"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMDgwOTkz", "url": "https://github.com/nuxeo/nuxeo/pull/3705#pullrequestreview-350080993", "createdAt": "2020-01-29T12:50:32Z", "commit": {"oid": "ae4369b1dfaccb0986aac663d69fd95d0984abb4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMjo1MDozM1rOFjHQJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMjo1MDozM1rOFjHQJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM2MzMwMA==", "bodyText": "What's the point though? Can't you just compare the HTML strings?", "url": "https://github.com/nuxeo/nuxeo/pull/3705#discussion_r372363300", "createdAt": "2020-01-29T12:50:33Z", "author": {"login": "efge"}, "path": "nuxeo-features/nuxeo-platform-notification/nuxeo-platform-notification-core/src/test/java/org/nuxeo/ecm/platform/ec/notification/TestEmailNotification.java", "diffHunk": "@@ -0,0 +1,198 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Salem Aouana\n+ */\n+\n+package org.nuxeo.ecm.platform.ec.notification;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.text.SimpleDateFormat;\n+import java.time.Instant;\n+import java.util.Date;\n+import java.util.Map;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.common.utils.StringUtils;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.NuxeoException;\n+import org.nuxeo.ecm.core.api.NuxeoPrincipal;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventService;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.notification.api.NotificationManager;\n+import org.nuxeo.ecm.platform.test.PlatformFeature;\n+import org.nuxeo.mail.SmtpMailServerFeature;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+import org.nuxeo.runtime.test.runner.TransactionalFeature;\n+\n+import net.htmlparser.jericho.Renderer;\n+import net.htmlparser.jericho.Source;\n+\n+/**\n+ * Tests the whole email notification process: from subscribing to a given event to the reception of the email for this\n+ * event.\n+ *\n+ * @since 11.1\n+ */\n+@RunWith(FeaturesRunner.class)\n+@Features({ PlatformFeature.class, SmtpMailServerFeature.class })\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core.tests:OSGI-INF/notification-event-listener-contrib.xml\")\n+public class TestEmailNotification {\n+\n+    protected static final String DUMMY_NOTIFICATION_NAME = \"DummyNotificationToSendMail\";\n+\n+    protected static final String DUMMY_EVENT_NAME = \"dummyNotificationToSendMail\";\n+\n+    protected static final String DOCUMENT_NAME = \"anyFile\";\n+\n+    protected static final String ANOTHER_DOCUMENT_NAME = \"anyFile2\";\n+\n+    protected static final SimpleDateFormat EVENT_DATE_FORMAT = new SimpleDateFormat(\"dd/MM/yyyy - HH:mm\");\n+\n+    @Inject\n+    protected CoreSession session;\n+\n+    @Inject\n+    protected NotificationManager notificationManager;\n+\n+    @Inject\n+    protected EventService eventService;\n+\n+    @Inject\n+    protected TransactionalFeature transactionalFeature;\n+\n+    @Inject\n+    protected SmtpMailServerFeature.MailsResult emailsResult;\n+\n+    protected DocumentModel domain;\n+\n+    @Before\n+    public void before() {\n+        domain = session.createDocumentModel(\"/\", \"domain\", \"Domain\");\n+        domain = session.createDocument(domain);\n+    }\n+\n+    @Test\n+    public void shouldReceiveNotificationMailWhenSubscribeToDocument() {\n+        // create a File document\n+        DocumentModel documentModel = createDocument(domain, DOCUMENT_NAME);\n+\n+        // subscribe to the dummy notification\n+        addSubscription(documentModel);\n+\n+        // fire the dummy event\n+        DocumentEventContext ctx = new DocumentEventContext(session, session.getPrincipal(), documentModel);\n+        Event event = ctx.newEvent(DUMMY_EVENT_NAME);\n+        eventService.fireEvent(event);\n+        transactionalFeature.nextTransaction();\n+\n+        // check the received mail\n+        checkMailContent(documentModel, event);\n+    }\n+\n+    @Test\n+    public void shouldReceiveNotificationMailWhenSubscribeToParentDocument() {\n+        DocumentModel parentDocModel = createDocument(domain, DOCUMENT_NAME);\n+\n+        // subscribe to the dummy notification on the parent document\n+        addSubscription(parentDocModel);\n+\n+        // create a simple hierarchy (domain <- DOCUMENT_NAME <- ANOTHER_DOCUMENT_NAME)\n+        DocumentModel mainDocModel = createDocument(parentDocModel, ANOTHER_DOCUMENT_NAME);\n+\n+        // fire the dummy event on the child document\n+        DocumentEventContext ctx = new DocumentEventContext(session, session.getPrincipal(), mainDocModel);\n+        Event event = ctx.newEvent(DUMMY_EVENT_NAME);\n+        eventService.fireEvent(event);\n+        transactionalFeature.nextTransaction();\n+\n+        // check the received mail\n+        checkMailContent(mainDocModel, event);\n+    }\n+\n+    protected void checkMailContent(DocumentModel documentModel, Event event) {\n+        assertEquals(1, emailsResult.getMails().size());\n+        SmtpMailServerFeature.MailMessage mailMessage = emailsResult.getMails().get(0);\n+        // check the subject\n+        assertEquals(String.format(\"[Dummy]Notification on the document '%s'\", documentModel.getTitle()),\n+                mailMessage.getSubject());\n+\n+        // check the text content\n+        String expectedMailContent = getExpectedMailContent(documentModel, event);\n+        assertEquals(expectedMailContent, getMailContent(mailMessage));\n+    }\n+\n+    protected DocumentModel createDocument(DocumentModel parent, String name) {\n+        DocumentModel documentModel = session.createDocumentModel(parent.getPathAsString(), name, \"File\");\n+        return session.createDocument(documentModel);\n+    }\n+\n+    protected void addSubscription(DocumentModel documentModel) {\n+        NuxeoPrincipal principal = session.getPrincipal();\n+        String subscriber = NotificationConstants.USER_PREFIX + principal.getName();\n+        notificationManager.addSubscription(subscriber, DUMMY_NOTIFICATION_NAME, documentModel, false, principal,\n+                DUMMY_NOTIFICATION_NAME);\n+    }\n+\n+    protected String getMailContent(SmtpMailServerFeature.MailMessage mailMessage) {\n+        String content = mailMessage.getContent();\n+        if (!mailMessage.getContentType().contains(\"text/html\")) {\n+            return content;\n+        }\n+\n+        Renderer renderer = new Source(mailMessage.getContent()).getRenderer();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae4369b1dfaccb0986aac663d69fd95d0984abb4"}, "originalPosition": 174}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ae4369b1dfaccb0986aac663d69fd95d0984abb4", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/ae4369b1dfaccb0986aac663d69fd95d0984abb4", "committedDate": "2020-01-29T12:39:11Z", "message": "NXP-28576: Add test coverage on mail notification"}, "afterCommit": {"oid": "0a76e0709885dee193740ada06ee7c580b0ca230", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/0a76e0709885dee193740ada06ee7c580b0ca230", "committedDate": "2020-01-29T13:55:25Z", "message": "NXP-28576: Add test coverage on mail notification"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMTU0MTYz", "url": "https://github.com/nuxeo/nuxeo/pull/3705#pullrequestreview-350154163", "createdAt": "2020-01-29T14:38:21Z", "commit": {"oid": "0a76e0709885dee193740ada06ee7c580b0ca230"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNDozODoyMVrOFjKqJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNDozODoyMVrOFjKqJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQxOTExMQ==", "bodyText": "Maybe put it directly inside the Map.of, as for the other fields?", "url": "https://github.com/nuxeo/nuxeo/pull/3705#discussion_r372419111", "createdAt": "2020-01-29T14:38:21Z", "author": {"login": "ataillefer"}, "path": "nuxeo-features/nuxeo-platform-notification/nuxeo-platform-notification-core/src/test/java/org/nuxeo/ecm/platform/ec/notification/TestEmailNotification.java", "diffHunk": "@@ -0,0 +1,182 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Salem Aouana\n+ */\n+\n+package org.nuxeo.ecm.platform.ec.notification;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.text.SimpleDateFormat;\n+import java.time.Instant;\n+import java.util.Date;\n+import java.util.Map;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.common.utils.StringUtils;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.NuxeoException;\n+import org.nuxeo.ecm.core.api.NuxeoPrincipal;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventService;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.notification.api.NotificationManager;\n+import org.nuxeo.ecm.platform.test.PlatformFeature;\n+import org.nuxeo.mail.SmtpMailServerFeature;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+import org.nuxeo.runtime.test.runner.TransactionalFeature;\n+\n+/**\n+ * Tests the whole email notification process: from subscribing to a given event to the reception of the email for this\n+ * event.\n+ *\n+ * @since 11.1\n+ */\n+@RunWith(FeaturesRunner.class)\n+@Features({ PlatformFeature.class, SmtpMailServerFeature.class })\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core.tests:OSGI-INF/notification-event-listener-contrib.xml\")\n+public class TestEmailNotification {\n+\n+    protected static final String DUMMY_NOTIFICATION_NAME = \"DummyNotificationToSendMail\";\n+\n+    protected static final String DUMMY_EVENT_NAME = \"dummyNotificationToSendMail\";\n+\n+    protected static final String DOCUMENT_NAME = \"anyFile\";\n+\n+    protected static final String ANOTHER_DOCUMENT_NAME = \"anyFile2\";\n+\n+    protected static final SimpleDateFormat EVENT_DATE_FORMAT = new SimpleDateFormat(\"dd/MM/yyyy - HH:mm\");\n+\n+    @Inject\n+    protected CoreSession session;\n+\n+    @Inject\n+    protected NotificationManager notificationManager;\n+\n+    @Inject\n+    protected EventService eventService;\n+\n+    @Inject\n+    protected TransactionalFeature transactionalFeature;\n+\n+    @Inject\n+    protected SmtpMailServerFeature.MailsResult emailsResult;\n+\n+    protected DocumentModel domain;\n+\n+    @Before\n+    public void before() {\n+        domain = session.createDocumentModel(\"/\", \"domain\", \"Domain\");\n+        domain = session.createDocument(domain);\n+    }\n+\n+    @Test\n+    public void shouldReceiveNotificationMailWhenSubscribeToDocument() {\n+        // create a File document\n+        DocumentModel documentModel = createDocument(domain, DOCUMENT_NAME);\n+\n+        // subscribe to the dummy notification\n+        addSubscription(documentModel);\n+\n+        // fire the dummy event\n+        DocumentEventContext ctx = new DocumentEventContext(session, session.getPrincipal(), documentModel);\n+        Event event = ctx.newEvent(DUMMY_EVENT_NAME);\n+        eventService.fireEvent(event);\n+        transactionalFeature.nextTransaction();\n+\n+        // check the received mail\n+        checkMailContent(documentModel, event);\n+    }\n+\n+    @Test\n+    public void shouldReceiveNotificationMailWhenSubscribeToParentDocument() {\n+        DocumentModel parentDocModel = createDocument(domain, DOCUMENT_NAME);\n+\n+        // subscribe to the dummy notification on the parent document\n+        addSubscription(parentDocModel);\n+\n+        // create a simple hierarchy (domain <- DOCUMENT_NAME <- ANOTHER_DOCUMENT_NAME)\n+        DocumentModel mainDocModel = createDocument(parentDocModel, ANOTHER_DOCUMENT_NAME);\n+\n+        // fire the dummy event on the child document\n+        DocumentEventContext ctx = new DocumentEventContext(session, session.getPrincipal(), mainDocModel);\n+        Event event = ctx.newEvent(DUMMY_EVENT_NAME);\n+        eventService.fireEvent(event);\n+        transactionalFeature.nextTransaction();\n+\n+        // check the received mail\n+        checkMailContent(mainDocModel, event);\n+    }\n+\n+    protected void checkMailContent(DocumentModel documentModel, Event event) {\n+        assertEquals(1, emailsResult.getMails().size());\n+        SmtpMailServerFeature.MailMessage mailMessage = emailsResult.getMails().get(0);\n+        // check the subject\n+        assertEquals(String.format(\"[Dummy]Notification on the document '%s'\", documentModel.getTitle()),\n+                mailMessage.getSubject());\n+\n+        // check the text content\n+        String expectedMailContent = getExpectedMailContent(documentModel, event);\n+        assertEquals(expectedMailContent, mailMessage.getContent());\n+    }\n+\n+    protected DocumentModel createDocument(DocumentModel parent, String name) {\n+        DocumentModel documentModel = session.createDocumentModel(parent.getPathAsString(), name, \"File\");\n+        return session.createDocument(documentModel);\n+    }\n+\n+    protected void addSubscription(DocumentModel documentModel) {\n+        NuxeoPrincipal principal = session.getPrincipal();\n+        String subscriber = NotificationConstants.USER_PREFIX + principal.getName();\n+        notificationManager.addSubscription(subscriber, DUMMY_NOTIFICATION_NAME, documentModel, false, principal,\n+                DUMMY_NOTIFICATION_NAME);\n+    }\n+\n+    protected String getExpectedMailContent(DocumentModel documentModel, Event event) {\n+        URL url = TestEmailNotification.class.getResource(\"/templates/dummyExpectedMail.html\");\n+        String author = ((String[]) documentModel.getPropertyValue(\"dc:contributors\"))[0];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a76e0709885dee193740ada06ee7c580b0ca230"}, "originalPosition": 167}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMTY3MDA2", "url": "https://github.com/nuxeo/nuxeo/pull/3705#pullrequestreview-350167006", "createdAt": "2020-01-29T14:54:03Z", "commit": {"oid": "0a76e0709885dee193740ada06ee7c580b0ca230"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0a76e0709885dee193740ada06ee7c580b0ca230", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/0a76e0709885dee193740ada06ee7c580b0ca230", "committedDate": "2020-01-29T13:55:25Z", "message": "NXP-28576: Add test coverage on mail notification"}, "afterCommit": {"oid": "ed4df6babb165544f0399c65829a815479e6c59a", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/ed4df6babb165544f0399c65829a815479e6c59a", "committedDate": "2020-01-30T11:19:52Z", "message": "NXP-28576: Add test coverage on mail notification"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwODM5MzQx", "url": "https://github.com/nuxeo/nuxeo/pull/3705#pullrequestreview-350839341", "createdAt": "2020-01-30T13:56:31Z", "commit": {"oid": "ed4df6babb165544f0399c65829a815479e6c59a"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyMjU5MTA5", "url": "https://github.com/nuxeo/nuxeo/pull/3705#pullrequestreview-352259109", "createdAt": "2020-02-03T13:41:38Z", "commit": {"oid": "ed4df6babb165544f0399c65829a815479e6c59a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMzo0MTozOFrOFkxrVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMzo0NzoyOVrOFkx3DA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDEwNjk2NQ==", "bodyText": "I haven't been conquered by this kind of method.\nWe're having them in more and more test classes, leading me to the question: why don't we want it in the sources for all usage?\nThey can change from one test to another, which doesn't help when reviewing code as we can't be sure that method does the thing we're used to/expect to. Furthermore, I think it's surprising to have code which doesn't use this method in the same test (we can see it in the @Before). Surprising because the method has the same name than the core session one and because it's not coherent with rest of test.\nWhen it comes to use it, we often need to put a comment in front of, in the end we don't benefit from the saved line this method gives.\nFor instance, I would prefer the \"old way\" in the text block below:\n// create a simple hierarchy (domain <- DOCUMENT_NAME <- ANOTHER_DOCUMENT_NAME)\nDocumentModel mainDocModel = createDocument(parentDocModel, ANOTHER_DOCUMENT_NAME);\nDocumentModel mainDocModel = session.createDocumentModel(\"/domain/anyFile\", ANOTHER_DOCUMENT_NAME, \"File\");\nmainDocModel = session.createDocument(parentDocModel);\nI'm in favor of removing this kind of method and doing light and explicit things.\nNote: the example above highlights the fact you're creating a File under another File which is permitted since the comment improvement but I'm not sure this is what we want to do here, we may want to do something closer to reality.", "url": "https://github.com/nuxeo/nuxeo/pull/3705#discussion_r374106965", "createdAt": "2020-02-03T13:41:38Z", "author": {"login": "kevinleturc"}, "path": "nuxeo-features/nuxeo-platform-notification/nuxeo-platform-notification-core/src/test/java/org/nuxeo/ecm/platform/ec/notification/TestEmailNotification.java", "diffHunk": "@@ -0,0 +1,182 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Salem Aouana\n+ */\n+\n+package org.nuxeo.ecm.platform.ec.notification;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.text.SimpleDateFormat;\n+import java.time.Instant;\n+import java.util.Date;\n+import java.util.Map;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.common.utils.StringUtils;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.NuxeoException;\n+import org.nuxeo.ecm.core.api.NuxeoPrincipal;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventService;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.notification.api.NotificationManager;\n+import org.nuxeo.ecm.platform.test.PlatformFeature;\n+import org.nuxeo.mail.SmtpMailServerFeature;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+import org.nuxeo.runtime.test.runner.TransactionalFeature;\n+\n+/**\n+ * Tests the whole email notification process: from subscribing to a given event to the reception of the email for this\n+ * event.\n+ *\n+ * @since 11.1\n+ */\n+@RunWith(FeaturesRunner.class)\n+@Features({ PlatformFeature.class, SmtpMailServerFeature.class })\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core.tests:OSGI-INF/notification-event-listener-contrib.xml\")\n+public class TestEmailNotification {\n+\n+    protected static final String DUMMY_NOTIFICATION_NAME = \"DummyNotificationToSendMail\";\n+\n+    protected static final String DUMMY_EVENT_NAME = \"dummyNotificationToSendMail\";\n+\n+    protected static final String DOCUMENT_NAME = \"anyFile\";\n+\n+    protected static final String ANOTHER_DOCUMENT_NAME = \"anyFile2\";\n+\n+    protected static final SimpleDateFormat EVENT_DATE_FORMAT = new SimpleDateFormat(\"dd/MM/yyyy - HH:mm\");\n+\n+    @Inject\n+    protected CoreSession session;\n+\n+    @Inject\n+    protected NotificationManager notificationManager;\n+\n+    @Inject\n+    protected EventService eventService;\n+\n+    @Inject\n+    protected TransactionalFeature transactionalFeature;\n+\n+    @Inject\n+    protected SmtpMailServerFeature.MailsResult emailsResult;\n+\n+    protected DocumentModel domain;\n+\n+    @Before\n+    public void before() {\n+        domain = session.createDocumentModel(\"/\", \"domain\", \"Domain\");\n+        domain = session.createDocument(domain);\n+    }\n+\n+    @Test\n+    public void shouldReceiveNotificationMailWhenSubscribeToDocument() {\n+        // create a File document\n+        DocumentModel documentModel = createDocument(domain, DOCUMENT_NAME);\n+\n+        // subscribe to the dummy notification\n+        addSubscription(documentModel);\n+\n+        // fire the dummy event\n+        DocumentEventContext ctx = new DocumentEventContext(session, session.getPrincipal(), documentModel);\n+        Event event = ctx.newEvent(DUMMY_EVENT_NAME);\n+        eventService.fireEvent(event);\n+        transactionalFeature.nextTransaction();\n+\n+        // check the received mail\n+        checkMailContent(documentModel, event);\n+    }\n+\n+    @Test\n+    public void shouldReceiveNotificationMailWhenSubscribeToParentDocument() {\n+        DocumentModel parentDocModel = createDocument(domain, DOCUMENT_NAME);\n+\n+        // subscribe to the dummy notification on the parent document\n+        addSubscription(parentDocModel);\n+\n+        // create a simple hierarchy (domain <- DOCUMENT_NAME <- ANOTHER_DOCUMENT_NAME)\n+        DocumentModel mainDocModel = createDocument(parentDocModel, ANOTHER_DOCUMENT_NAME);\n+\n+        // fire the dummy event on the child document\n+        DocumentEventContext ctx = new DocumentEventContext(session, session.getPrincipal(), mainDocModel);\n+        Event event = ctx.newEvent(DUMMY_EVENT_NAME);\n+        eventService.fireEvent(event);\n+        transactionalFeature.nextTransaction();\n+\n+        // check the received mail\n+        checkMailContent(mainDocModel, event);\n+    }\n+\n+    protected void checkMailContent(DocumentModel documentModel, Event event) {\n+        assertEquals(1, emailsResult.getMails().size());\n+        SmtpMailServerFeature.MailMessage mailMessage = emailsResult.getMails().get(0);\n+        // check the subject\n+        assertEquals(String.format(\"[Dummy]Notification on the document '%s'\", documentModel.getTitle()),\n+                mailMessage.getSubject());\n+\n+        // check the text content\n+        String expectedMailContent = getExpectedMailContent(documentModel, event);\n+        assertEquals(expectedMailContent, mailMessage.getContent());\n+    }\n+\n+    protected DocumentModel createDocument(DocumentModel parent, String name) {\n+        DocumentModel documentModel = session.createDocumentModel(parent.getPathAsString(), name, \"File\");\n+        return session.createDocument(documentModel);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed4df6babb165544f0399c65829a815479e6c59a"}, "originalPosition": 156}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDEwOTk2NA==", "bodyText": "Renaming the method addDummySubscription would be more explicit, and the comment could be removed.", "url": "https://github.com/nuxeo/nuxeo/pull/3705#discussion_r374109964", "createdAt": "2020-02-03T13:47:29Z", "author": {"login": "kevinleturc"}, "path": "nuxeo-features/nuxeo-platform-notification/nuxeo-platform-notification-core/src/test/java/org/nuxeo/ecm/platform/ec/notification/TestEmailNotification.java", "diffHunk": "@@ -0,0 +1,182 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Salem Aouana\n+ */\n+\n+package org.nuxeo.ecm.platform.ec.notification;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.text.SimpleDateFormat;\n+import java.time.Instant;\n+import java.util.Date;\n+import java.util.Map;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.common.utils.StringUtils;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.NuxeoException;\n+import org.nuxeo.ecm.core.api.NuxeoPrincipal;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventService;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.notification.api.NotificationManager;\n+import org.nuxeo.ecm.platform.test.PlatformFeature;\n+import org.nuxeo.mail.SmtpMailServerFeature;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+import org.nuxeo.runtime.test.runner.TransactionalFeature;\n+\n+/**\n+ * Tests the whole email notification process: from subscribing to a given event to the reception of the email for this\n+ * event.\n+ *\n+ * @since 11.1\n+ */\n+@RunWith(FeaturesRunner.class)\n+@Features({ PlatformFeature.class, SmtpMailServerFeature.class })\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core.tests:OSGI-INF/notification-event-listener-contrib.xml\")\n+public class TestEmailNotification {\n+\n+    protected static final String DUMMY_NOTIFICATION_NAME = \"DummyNotificationToSendMail\";\n+\n+    protected static final String DUMMY_EVENT_NAME = \"dummyNotificationToSendMail\";\n+\n+    protected static final String DOCUMENT_NAME = \"anyFile\";\n+\n+    protected static final String ANOTHER_DOCUMENT_NAME = \"anyFile2\";\n+\n+    protected static final SimpleDateFormat EVENT_DATE_FORMAT = new SimpleDateFormat(\"dd/MM/yyyy - HH:mm\");\n+\n+    @Inject\n+    protected CoreSession session;\n+\n+    @Inject\n+    protected NotificationManager notificationManager;\n+\n+    @Inject\n+    protected EventService eventService;\n+\n+    @Inject\n+    protected TransactionalFeature transactionalFeature;\n+\n+    @Inject\n+    protected SmtpMailServerFeature.MailsResult emailsResult;\n+\n+    protected DocumentModel domain;\n+\n+    @Before\n+    public void before() {\n+        domain = session.createDocumentModel(\"/\", \"domain\", \"Domain\");\n+        domain = session.createDocument(domain);\n+    }\n+\n+    @Test\n+    public void shouldReceiveNotificationMailWhenSubscribeToDocument() {\n+        // create a File document\n+        DocumentModel documentModel = createDocument(domain, DOCUMENT_NAME);\n+\n+        // subscribe to the dummy notification\n+        addSubscription(documentModel);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed4df6babb165544f0399c65829a815479e6c59a"}, "originalPosition": 109}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ed4df6babb165544f0399c65829a815479e6c59a", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/ed4df6babb165544f0399c65829a815479e6c59a", "committedDate": "2020-01-30T11:19:52Z", "message": "NXP-28576: Add test coverage on mail notification"}, "afterCommit": {"oid": "e417b9bcae1a5f98cec69b30eeb6e2100950cf50", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/e417b9bcae1a5f98cec69b30eeb6e2100950cf50", "committedDate": "2020-02-03T14:27:44Z", "message": "NXP-28576: Add test coverage on mail notification"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyMzAxNDQw", "url": "https://github.com/nuxeo/nuxeo/pull/3705#pullrequestreview-352301440", "createdAt": "2020-02-03T14:40:30Z", "commit": {"oid": "e417b9bcae1a5f98cec69b30eeb6e2100950cf50"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxNDo0MDozMFrOFkznDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxNDo1MzoyN1rOFk0E3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDEzODYzOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    DocumentModel documentModel = session.createDocumentModel(domain.getPathAsString(), DOCUMENT_NAME, \"File\");\n          \n          \n            \n                    DocumentModel documentModel = session.createDocumentModel(\"/domain\", DOCUMENT_NAME, \"File\");", "url": "https://github.com/nuxeo/nuxeo/pull/3705#discussion_r374138638", "createdAt": "2020-02-03T14:40:30Z", "author": {"login": "kevinleturc"}, "path": "nuxeo-features/nuxeo-platform-notification/nuxeo-platform-notification-core/src/test/java/org/nuxeo/ecm/platform/ec/notification/TestEmailNotification.java", "diffHunk": "@@ -0,0 +1,171 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Salem Aouana\n+ */\n+\n+package org.nuxeo.ecm.platform.ec.notification;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.text.SimpleDateFormat;\n+import java.time.Instant;\n+import java.util.Date;\n+import java.util.Map;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.common.utils.StringUtils;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.NuxeoException;\n+import org.nuxeo.ecm.core.api.NuxeoPrincipal;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventService;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.notification.api.NotificationManager;\n+import org.nuxeo.ecm.platform.test.PlatformFeature;\n+import org.nuxeo.mail.SmtpMailServerFeature;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+import org.nuxeo.runtime.test.runner.TransactionalFeature;\n+\n+/**\n+ * Tests the whole email notification process: from subscribing to a given event to the reception of the email for this\n+ * event.\n+ *\n+ * @since 11.1\n+ */\n+@RunWith(FeaturesRunner.class)\n+@Features({ PlatformFeature.class, SmtpMailServerFeature.class })\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core.tests:OSGI-INF/notification-event-listener-contrib.xml\")\n+public class TestEmailNotification {\n+\n+    protected static final String DUMMY_NOTIFICATION_NAME = \"DummyNotificationToSendMail\";\n+\n+    protected static final String DUMMY_EVENT_NAME = \"dummyNotificationToSendMail\";\n+\n+    protected static final String DOCUMENT_NAME = \"anyFile\";\n+\n+    protected static final SimpleDateFormat EVENT_DATE_FORMAT = new SimpleDateFormat(\"dd/MM/yyyy - HH:mm\");\n+\n+    @Inject\n+    protected CoreSession session;\n+\n+    @Inject\n+    protected NotificationManager notificationManager;\n+\n+    @Inject\n+    protected EventService eventService;\n+\n+    @Inject\n+    protected TransactionalFeature transactionalFeature;\n+\n+    @Inject\n+    protected SmtpMailServerFeature.MailsResult emailsResult;\n+\n+    protected DocumentModel domain;\n+\n+    @Before\n+    public void before() {\n+        domain = session.createDocumentModel(\"/\", \"domain\", \"Domain\");\n+        domain = session.createDocument(domain);\n+    }\n+\n+    @Test\n+    public void shouldReceiveNotificationMailWhenSubscribeToDocument() {\n+        DocumentModel documentModel = session.createDocumentModel(domain.getPathAsString(), DOCUMENT_NAME, \"File\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e417b9bcae1a5f98cec69b30eeb6e2100950cf50"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDEzODg5OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    DocumentModel folder = session.createDocumentModel(domain.getPathAsString(), \"anyFolder\", \"Folder\");\n          \n          \n            \n                    DocumentModel folder = session.createDocumentModel(\"/domain\", \"anyFolder\", \"Folder\");", "url": "https://github.com/nuxeo/nuxeo/pull/3705#discussion_r374138899", "createdAt": "2020-02-03T14:40:59Z", "author": {"login": "kevinleturc"}, "path": "nuxeo-features/nuxeo-platform-notification/nuxeo-platform-notification-core/src/test/java/org/nuxeo/ecm/platform/ec/notification/TestEmailNotification.java", "diffHunk": "@@ -0,0 +1,171 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Salem Aouana\n+ */\n+\n+package org.nuxeo.ecm.platform.ec.notification;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.text.SimpleDateFormat;\n+import java.time.Instant;\n+import java.util.Date;\n+import java.util.Map;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.common.utils.StringUtils;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.NuxeoException;\n+import org.nuxeo.ecm.core.api.NuxeoPrincipal;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventService;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.notification.api.NotificationManager;\n+import org.nuxeo.ecm.platform.test.PlatformFeature;\n+import org.nuxeo.mail.SmtpMailServerFeature;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+import org.nuxeo.runtime.test.runner.TransactionalFeature;\n+\n+/**\n+ * Tests the whole email notification process: from subscribing to a given event to the reception of the email for this\n+ * event.\n+ *\n+ * @since 11.1\n+ */\n+@RunWith(FeaturesRunner.class)\n+@Features({ PlatformFeature.class, SmtpMailServerFeature.class })\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core.tests:OSGI-INF/notification-event-listener-contrib.xml\")\n+public class TestEmailNotification {\n+\n+    protected static final String DUMMY_NOTIFICATION_NAME = \"DummyNotificationToSendMail\";\n+\n+    protected static final String DUMMY_EVENT_NAME = \"dummyNotificationToSendMail\";\n+\n+    protected static final String DOCUMENT_NAME = \"anyFile\";\n+\n+    protected static final SimpleDateFormat EVENT_DATE_FORMAT = new SimpleDateFormat(\"dd/MM/yyyy - HH:mm\");\n+\n+    @Inject\n+    protected CoreSession session;\n+\n+    @Inject\n+    protected NotificationManager notificationManager;\n+\n+    @Inject\n+    protected EventService eventService;\n+\n+    @Inject\n+    protected TransactionalFeature transactionalFeature;\n+\n+    @Inject\n+    protected SmtpMailServerFeature.MailsResult emailsResult;\n+\n+    protected DocumentModel domain;\n+\n+    @Before\n+    public void before() {\n+        domain = session.createDocumentModel(\"/\", \"domain\", \"Domain\");\n+        domain = session.createDocument(domain);\n+    }\n+\n+    @Test\n+    public void shouldReceiveNotificationMailWhenSubscribeToDocument() {\n+        DocumentModel documentModel = session.createDocumentModel(domain.getPathAsString(), DOCUMENT_NAME, \"File\");\n+        documentModel = session.createDocument(documentModel);\n+\n+        addDummySubscription(documentModel);\n+\n+        DocumentEventContext ctx = new DocumentEventContext(session, session.getPrincipal(), documentModel);\n+        Event event = ctx.newEvent(DUMMY_EVENT_NAME);\n+        eventService.fireEvent(event);\n+        transactionalFeature.nextTransaction();\n+\n+        checkMailContent(documentModel, event);\n+    }\n+\n+    @Test\n+    public void shouldReceiveNotificationMailWhenSubscribeToParentDocument() {\n+        DocumentModel folder = session.createDocumentModel(domain.getPathAsString(), \"anyFolder\", \"Folder\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e417b9bcae1a5f98cec69b30eeb6e2100950cf50"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE0NjI2OQ==", "bodyText": "Could you remove the comment and replace the createDocumentModel line by a real path which will show us the hierarchy:\n        DocumentModel mainDocModel = session.createDocumentModel(\"/domain/anyFolder\", DOCUMENT_NAME, \"File\");\n        mainDocModel = session.createDocument(mainDocModel);", "url": "https://github.com/nuxeo/nuxeo/pull/3705#discussion_r374146269", "createdAt": "2020-02-03T14:53:27Z", "author": {"login": "kevinleturc"}, "path": "nuxeo-features/nuxeo-platform-notification/nuxeo-platform-notification-core/src/test/java/org/nuxeo/ecm/platform/ec/notification/TestEmailNotification.java", "diffHunk": "@@ -0,0 +1,171 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Salem Aouana\n+ */\n+\n+package org.nuxeo.ecm.platform.ec.notification;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.text.SimpleDateFormat;\n+import java.time.Instant;\n+import java.util.Date;\n+import java.util.Map;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.common.utils.StringUtils;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.NuxeoException;\n+import org.nuxeo.ecm.core.api.NuxeoPrincipal;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventService;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.platform.notification.api.NotificationManager;\n+import org.nuxeo.ecm.platform.test.PlatformFeature;\n+import org.nuxeo.mail.SmtpMailServerFeature;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+import org.nuxeo.runtime.test.runner.TransactionalFeature;\n+\n+/**\n+ * Tests the whole email notification process: from subscribing to a given event to the reception of the email for this\n+ * event.\n+ *\n+ * @since 11.1\n+ */\n+@RunWith(FeaturesRunner.class)\n+@Features({ PlatformFeature.class, SmtpMailServerFeature.class })\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.api\")\n+@Deploy(\"org.nuxeo.ecm.platform.url.core\")\n+@Deploy(\"org.nuxeo.ecm.platform.notification.core.tests:OSGI-INF/notification-event-listener-contrib.xml\")\n+public class TestEmailNotification {\n+\n+    protected static final String DUMMY_NOTIFICATION_NAME = \"DummyNotificationToSendMail\";\n+\n+    protected static final String DUMMY_EVENT_NAME = \"dummyNotificationToSendMail\";\n+\n+    protected static final String DOCUMENT_NAME = \"anyFile\";\n+\n+    protected static final SimpleDateFormat EVENT_DATE_FORMAT = new SimpleDateFormat(\"dd/MM/yyyy - HH:mm\");\n+\n+    @Inject\n+    protected CoreSession session;\n+\n+    @Inject\n+    protected NotificationManager notificationManager;\n+\n+    @Inject\n+    protected EventService eventService;\n+\n+    @Inject\n+    protected TransactionalFeature transactionalFeature;\n+\n+    @Inject\n+    protected SmtpMailServerFeature.MailsResult emailsResult;\n+\n+    protected DocumentModel domain;\n+\n+    @Before\n+    public void before() {\n+        domain = session.createDocumentModel(\"/\", \"domain\", \"Domain\");\n+        domain = session.createDocument(domain);\n+    }\n+\n+    @Test\n+    public void shouldReceiveNotificationMailWhenSubscribeToDocument() {\n+        DocumentModel documentModel = session.createDocumentModel(domain.getPathAsString(), DOCUMENT_NAME, \"File\");\n+        documentModel = session.createDocument(documentModel);\n+\n+        addDummySubscription(documentModel);\n+\n+        DocumentEventContext ctx = new DocumentEventContext(session, session.getPrincipal(), documentModel);\n+        Event event = ctx.newEvent(DUMMY_EVENT_NAME);\n+        eventService.fireEvent(event);\n+        transactionalFeature.nextTransaction();\n+\n+        checkMailContent(documentModel, event);\n+    }\n+\n+    @Test\n+    public void shouldReceiveNotificationMailWhenSubscribeToParentDocument() {\n+        DocumentModel folder = session.createDocumentModel(domain.getPathAsString(), \"anyFolder\", \"Folder\");\n+        folder = session.createDocument(folder);\n+\n+        addDummySubscription(folder);\n+\n+        // create a simple hierarchy (domain <- anyFolder <- DOCUMENT_NAME)\n+        DocumentModel mainDocModel = session.createDocumentModel(folder.getPathAsString(), DOCUMENT_NAME, \"File\");\n+        mainDocModel = session.createDocument(mainDocModel);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e417b9bcae1a5f98cec69b30eeb6e2100950cf50"}, "originalPosition": 125}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f0bb792aeaa810fb0e7cca8e50f8cca50993e8b", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/9f0bb792aeaa810fb0e7cca8e50f8cca50993e8b", "committedDate": "2020-02-03T15:29:19Z", "message": "NXP-28576: Add test coverage on mail notification"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e417b9bcae1a5f98cec69b30eeb6e2100950cf50", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/e417b9bcae1a5f98cec69b30eeb6e2100950cf50", "committedDate": "2020-02-03T14:27:44Z", "message": "NXP-28576: Add test coverage on mail notification"}, "afterCommit": {"oid": "9f0bb792aeaa810fb0e7cca8e50f8cca50993e8b", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/9f0bb792aeaa810fb0e7cca8e50f8cca50993e8b", "committedDate": "2020-02-03T15:29:19Z", "message": "NXP-28576: Add test coverage on mail notification"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyMzQxNzE5", "url": "https://github.com/nuxeo/nuxeo/pull/3705#pullrequestreview-352341719", "createdAt": "2020-02-03T15:31:16Z", "commit": {"oid": "9f0bb792aeaa810fb0e7cca8e50f8cca50993e8b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyOTY2MDQz", "url": "https://github.com/nuxeo/nuxeo/pull/3705#pullrequestreview-352966043", "createdAt": "2020-02-04T13:18:39Z", "commit": {"oid": "9f0bb792aeaa810fb0e7cca8e50f8cca50993e8b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NDU2MTk4", "url": "https://github.com/nuxeo/nuxeo/pull/3705#pullrequestreview-354456198", "createdAt": "2020-02-06T13:41:53Z", "commit": {"oid": "9f0bb792aeaa810fb0e7cca8e50f8cca50993e8b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4890, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}