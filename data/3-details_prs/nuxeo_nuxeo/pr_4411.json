{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4Mzc1MDkw", "number": 4411, "title": "NXP-29791: forbid deletion of the main blob of a document under retention / legal hold", "bodyText": "PR opened for now only on master to get Florent's feedbacks, about the implementation.\nBuild on old infra: https://qa.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-saouana/251/", "createdAt": "2020-10-22T15:24:30Z", "url": "https://github.com/nuxeo/nuxeo/pull/4411", "merged": true, "mergeCommit": {"oid": "7abe73306e9736e910520032a8bb80f680eadc88"}, "closed": true, "closedAt": "2020-11-05T17:25:37Z", "author": {"login": "RSalem07"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVEIImgBqjM5MDk4ODQ4OTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZlZA0gFqTUyNDQ3MDQwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a47091c1488184f01353d68acfaa9c7257146b43", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/a47091c1488184f01353d68acfaa9c7257146b43", "committedDate": "2020-10-22T15:10:02Z", "message": "NXP-29791: make impossible the blob deletion of a document under retention"}, "afterCommit": {"oid": "b65f2dd57707081d3f7451f90dc96ea01e8df7c5", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/b65f2dd57707081d3f7451f90dc96ea01e8df7c5", "committedDate": "2020-10-22T15:57:42Z", "message": "NXP-29791: make impossible the blob deletion of a document under retention"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NTYwMzIy", "url": "https://github.com/nuxeo/nuxeo/pull/4411#pullrequestreview-517560322", "createdAt": "2020-10-27T10:41:07Z", "commit": {"oid": "b65f2dd57707081d3f7451f90dc96ea01e8df7c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMDo0MTowN1rOHo1haA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMDo0MTowN1rOHo1haA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU4MTk5Mg==", "bodyText": "Not sure if I'm seeing this correctly but, would it make sense to just declare key and call setPropertyValue inside the try block?", "url": "https://github.com/nuxeo/nuxeo/pull/4411#discussion_r512581992", "createdAt": "2020-10-27T10:41:07Z", "author": {"login": "nmpcunha"}, "path": "modules/core/nuxeo-core-storage/src/main/java/org/nuxeo/ecm/core/storage/BaseDocument.java", "diffHunk": "@@ -691,17 +691,13 @@ protected void setValueBlob(T state, Blob blob, String xpath) throws PropertyExc\n     }\n \n     protected void setPropertyBlobData(String xpath, String string) {\n+        Blob blob = StringUtils.isNotEmpty(string) ? Blobs.createBlob(string) : null;\n+        DocumentBlobManager blobManager = Framework.getService(DocumentBlobManager.class);\n         String key;\n-        if (string == null) {\n-            key = null;\n-        } else {\n-            Blob blob = Blobs.createBlob(string);\n-            DocumentBlobManager blobManager = Framework.getService(DocumentBlobManager.class);\n-            try {\n-                key = blobManager.writeBlob(blob, this, xpath);\n-            } catch (IOException e) {\n-                throw new PropertyException(\"Cannot write binary for doc: \" + getUUID(), e);\n-            }\n+        try {\n+            key = blobManager.writeBlob(blob, this, xpath);\n+        } catch (IOException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b65f2dd57707081d3f7451f90dc96ea01e8df7c5"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NTY1MjAz", "url": "https://github.com/nuxeo/nuxeo/pull/4411#pullrequestreview-517565203", "createdAt": "2020-10-27T10:44:55Z", "commit": {"oid": "b65f2dd57707081d3f7451f90dc96ea01e8df7c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMDo0NDo1NVrOHo1qpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMDo0NDo1NVrOHo1qpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU4NDM1OA==", "bodyText": "IIRC it is only about file:content, right? Other blobs can be modified if a document is under retention?", "url": "https://github.com/nuxeo/nuxeo/pull/4411#discussion_r512584358", "createdAt": "2020-10-27T10:44:55Z", "author": {"login": "nmpcunha"}, "path": "modules/core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/blob/DocumentBlobManagerComponent.java", "diffHunk": "@@ -182,6 +182,14 @@ protected BlobProvider getBlobProvider(String key, String repositoryName) {\n      */\n     @Override\n     public String writeBlob(Blob blob, Document doc, String xpath) throws IOException {\n+        if (blob == null) {\n+            if (MAIN_BLOB_XPATH.equals(xpath) && doc.isUnderRetentionOrLegalHold()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b65f2dd57707081d3f7451f90dc96ea01e8df7c5"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NTY1NTY2", "url": "https://github.com/nuxeo/nuxeo/pull/4411#pullrequestreview-517565566", "createdAt": "2020-10-27T10:45:11Z", "commit": {"oid": "b65f2dd57707081d3f7451f90dc96ea01e8df7c5"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5NTI5NTUx", "url": "https://github.com/nuxeo/nuxeo/pull/4411#pullrequestreview-519529551", "createdAt": "2020-10-29T10:33:30Z", "commit": {"oid": "b65f2dd57707081d3f7451f90dc96ea01e8df7c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxMDozMzozMVrOHqVqXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxMDozMzozMVrOHqVqXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE1NzE1MA==", "bodyText": "What do you think about adding a new API such as isBlobWriteable which does this check, and maybe the one l. 211(?), in order to avoid to allow null values for blob in this API?", "url": "https://github.com/nuxeo/nuxeo/pull/4411#discussion_r514157150", "createdAt": "2020-10-29T10:33:31Z", "author": {"login": "kevinleturc"}, "path": "modules/core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/blob/DocumentBlobManagerComponent.java", "diffHunk": "@@ -182,6 +182,14 @@ protected BlobProvider getBlobProvider(String key, String repositoryName) {\n      */\n     @Override\n     public String writeBlob(Blob blob, Document doc, String xpath) throws IOException {\n+        if (blob == null) {\n+            if (MAIN_BLOB_XPATH.equals(xpath) && doc.isUnderRetentionOrLegalHold()) {\n+                throw new DocumentSecurityException(\n+                        \"Cannot delete blob from document \" + doc.getUUID() + \", it is under retention / hold\");\n+            }\n+            return null;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b65f2dd57707081d3f7451f90dc96ea01e8df7c5"}, "originalPosition": 10}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b65f2dd57707081d3f7451f90dc96ea01e8df7c5", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/b65f2dd57707081d3f7451f90dc96ea01e8df7c5", "committedDate": "2020-10-22T15:57:42Z", "message": "NXP-29791: make impossible the blob deletion of a document under retention"}, "afterCommit": {"oid": "657ef5c91333cee3e9421cf32a8235f337dbd57d", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/657ef5c91333cee3e9421cf32a8235f337dbd57d", "committedDate": "2020-11-05T16:43:53Z", "message": "NXP-29791: forbid deletion of the main blob of a document under retention / legal hold"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NDM5NDUw", "url": "https://github.com/nuxeo/nuxeo/pull/4411#pullrequestreview-524439450", "createdAt": "2020-11-05T16:27:27Z", "commit": {"oid": "b65f2dd57707081d3f7451f90dc96ea01e8df7c5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjoyNzoyN1rOHuLf1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjozMzo0MFrOHuLx2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE4NDkxNg==", "bodyText": "Testing for \"empty\" is wrong, it's legal too have a blob containing a 0-byte content.\nEven though for now this is used in cases where the difference doesn't really matter (binary fulltext), it's not the case in general.", "url": "https://github.com/nuxeo/nuxeo/pull/4411#discussion_r518184916", "createdAt": "2020-11-05T16:27:27Z", "author": {"login": "efge"}, "path": "modules/core/nuxeo-core-storage/src/main/java/org/nuxeo/ecm/core/storage/BaseDocument.java", "diffHunk": "@@ -691,17 +691,13 @@ protected void setValueBlob(T state, Blob blob, String xpath) throws PropertyExc\n     }\n \n     protected void setPropertyBlobData(String xpath, String string) {\n+        Blob blob = StringUtils.isNotEmpty(string) ? Blobs.createBlob(string) : null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b65f2dd57707081d3f7451f90dc96ea01e8df7c5"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE4Njc0OA==", "bodyText": "It's preferable to have try/catch blocks cover just what's needed and nothing more.", "url": "https://github.com/nuxeo/nuxeo/pull/4411#discussion_r518186748", "createdAt": "2020-11-05T16:29:56Z", "author": {"login": "efge"}, "path": "modules/core/nuxeo-core-storage/src/main/java/org/nuxeo/ecm/core/storage/BaseDocument.java", "diffHunk": "@@ -691,17 +691,13 @@ protected void setValueBlob(T state, Blob blob, String xpath) throws PropertyExc\n     }\n \n     protected void setPropertyBlobData(String xpath, String string) {\n+        Blob blob = StringUtils.isNotEmpty(string) ? Blobs.createBlob(string) : null;\n+        DocumentBlobManager blobManager = Framework.getService(DocumentBlobManager.class);\n         String key;\n-        if (string == null) {\n-            key = null;\n-        } else {\n-            Blob blob = Blobs.createBlob(string);\n-            DocumentBlobManager blobManager = Framework.getService(DocumentBlobManager.class);\n-            try {\n-                key = blobManager.writeBlob(blob, this, xpath);\n-            } catch (IOException e) {\n-                throw new PropertyException(\"Cannot write binary for doc: \" + getUUID(), e);\n-            }\n+        try {\n+            key = blobManager.writeBlob(blob, this, xpath);\n+        } catch (IOException e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU4MTk5Mg=="}, "originalCommit": {"oid": "b65f2dd57707081d3f7451f90dc96ea01e8df7c5"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE4OTUyOQ==", "bodyText": "It's not clear to me on what class you want to add this new API.\nAs it's a detail, let's postpone refactorings and just do a minimal change + backport.", "url": "https://github.com/nuxeo/nuxeo/pull/4411#discussion_r518189529", "createdAt": "2020-11-05T16:33:40Z", "author": {"login": "efge"}, "path": "modules/core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/blob/DocumentBlobManagerComponent.java", "diffHunk": "@@ -182,6 +182,14 @@ protected BlobProvider getBlobProvider(String key, String repositoryName) {\n      */\n     @Override\n     public String writeBlob(Blob blob, Document doc, String xpath) throws IOException {\n+        if (blob == null) {\n+            if (MAIN_BLOB_XPATH.equals(xpath) && doc.isUnderRetentionOrLegalHold()) {\n+                throw new DocumentSecurityException(\n+                        \"Cannot delete blob from document \" + doc.getUUID() + \", it is under retention / hold\");\n+            }\n+            return null;\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE1NzE1MA=="}, "originalCommit": {"oid": "b65f2dd57707081d3f7451f90dc96ea01e8df7c5"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NDU3NTc0", "url": "https://github.com/nuxeo/nuxeo/pull/4411#pullrequestreview-524457574", "createdAt": "2020-11-05T16:45:33Z", "commit": {"oid": "657ef5c91333cee3e9421cf32a8235f337dbd57d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjo0NTozM1rOHuMTmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjo0NTozM1rOHuMTmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE5ODE2OQ==", "bodyText": "I added the Javadoc to.", "url": "https://github.com/nuxeo/nuxeo/pull/4411#discussion_r518198169", "createdAt": "2020-11-05T16:45:33Z", "author": {"login": "efge"}, "path": "modules/core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/blob/DocumentBlobManager.java", "diffHunk": "@@ -60,6 +60,9 @@\n \n     /**\n      * Writes a {@link Blob} to storage and returns its key.\n+     * <p>\n+     * The passed blob may be {@code null}, in which case a {@code null} key is returned after checking that deleting\n+     * this blob is allowed.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "657ef5c91333cee3e9421cf32a8235f337dbd57d"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c18bc19451fbb7fb8a0d58d8a7ed73cad8354fd", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/3c18bc19451fbb7fb8a0d58d8a7ed73cad8354fd", "committedDate": "2020-11-05T16:46:27Z", "message": "NXP-29791: forbid deletion of the main blob of a document under retention / legal hold"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "657ef5c91333cee3e9421cf32a8235f337dbd57d", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/657ef5c91333cee3e9421cf32a8235f337dbd57d", "committedDate": "2020-11-05T16:43:53Z", "message": "NXP-29791: forbid deletion of the main blob of a document under retention / legal hold"}, "afterCommit": {"oid": "3c18bc19451fbb7fb8a0d58d8a7ed73cad8354fd", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/3c18bc19451fbb7fb8a0d58d8a7ed73cad8354fd", "committedDate": "2020-11-05T16:46:27Z", "message": "NXP-29791: forbid deletion of the main blob of a document under retention / legal hold"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NDY1Mjk0", "url": "https://github.com/nuxeo/nuxeo/pull/4411#pullrequestreview-524465294", "createdAt": "2020-11-05T16:53:49Z", "commit": {"oid": "3c18bc19451fbb7fb8a0d58d8a7ed73cad8354fd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NDcwNDAz", "url": "https://github.com/nuxeo/nuxeo/pull/4411#pullrequestreview-524470403", "createdAt": "2020-11-05T16:59:09Z", "commit": {"oid": "3c18bc19451fbb7fb8a0d58d8a7ed73cad8354fd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4943, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}