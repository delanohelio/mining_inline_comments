{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4Mjg5MTk5", "number": 3706, "reviewThreads": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMDoyNToxMlrODbatSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxMzo0Mjo1NFrODb6u6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMDc1NzIyOnYy", "diffSide": "RIGHT", "path": "nuxeo-core/nuxeo-core-io/src/main/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/AbstractJsonEnricher.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMDoyNToxMlrOFi5KuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMDoyNToxMlrOFi5KuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEzMjUzNg==", "bodyText": "We format constants before fields.", "url": "https://github.com/nuxeo/nuxeo/pull/3706#discussion_r372132536", "createdAt": "2020-01-29T00:25:12Z", "author": {"login": "efge"}, "path": "nuxeo-core/nuxeo-core-io/src/main/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/AbstractJsonEnricher.java", "diffHunk": "@@ -37,10 +37,10 @@\n  */\n public abstract class AbstractJsonEnricher<EntityType> extends AbstractJsonWriter<Enriched<EntityType>> {\n \n-    public static final String ENTITY_ENRICHER_NAME = \"_EntityEnricherName\";\n-\n     private final String name;\n \n+    public static final String ENTITY_ENRICHER_NAME = \"_EntityEnricherName\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2224bcc5e6c1e708fad241070a1bd7dc62fb6dc6"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMDc1ODg2OnYy", "diffSide": "RIGHT", "path": "nuxeo-core/nuxeo-core-io/src/main/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/AbstractJsonEnricher.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMDoyNjowNVrOFi5Lug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMDoyNjowNVrOFi5Lug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEzMjc5NA==", "bodyText": "log.error(e, e) otherwise with what you wrote the stacktrace is not logged.\nAlso worth adding a // TODO collect exception and return it to the caller", "url": "https://github.com/nuxeo/nuxeo/pull/3706#discussion_r372132794", "createdAt": "2020-01-29T00:26:05Z", "author": {"login": "efge"}, "path": "nuxeo-core/nuxeo-core-io/src/main/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/AbstractJsonEnricher.java", "diffHunk": "@@ -51,8 +55,12 @@ public boolean accept(Class<?> clazz, Type genericType, MediaType mediatype) {\n     }\n \n     @Override\n-    public void write(Enriched<EntityType> enrichable, JsonGenerator jg) throws IOException {\n-        write(jg, enrichable.getEntity());\n+    public void write(Enriched<EntityType> enrichable, JsonGenerator jg) {\n+        try {\n+            write(jg, enrichable.getEntity());\n+        } catch (IOException e) {\n+            log.error(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ac5af9861f850c8bd10b20a20f557654c7dd6d1"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMDc2MDYxOnYy", "diffSide": "RIGHT", "path": "nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/enrichers/FailingEnricherTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMDoyNzoyMlrOFi5M4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNToxODo1NFrOFi80mQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEzMzA4OA==", "bodyText": "No need for try/catch, the test itself failing is enough (and more informative with respect to the exception).", "url": "https://github.com/nuxeo/nuxeo/pull/3706#discussion_r372133088", "createdAt": "2020-01-29T00:27:22Z", "author": {"login": "efge"}, "path": "nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/enrichers/FailingEnricherTest.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour \"AIR\" AL KOTOB\n+ */\n+\n+package org.nuxeo.ecm.restapi.test.enrichers;\n+\n+import static org.junit.Assert.fail;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.PathRef;\n+import org.nuxeo.ecm.core.io.marshallers.json.AbstractJsonWriterTest;\n+import org.nuxeo.ecm.core.io.marshallers.json.document.DocumentModelJsonWriter;\n+import org.nuxeo.ecm.core.io.registry.context.RenderingContext.CtxBuilder;\n+import org.nuxeo.ecm.core.test.annotations.Granularity;\n+import org.nuxeo.ecm.core.test.annotations.RepositoryConfig;\n+import org.nuxeo.ecm.restapi.test.RestServerFeature;\n+import org.nuxeo.ecm.restapi.test.RestServerInit;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+\n+@RunWith(FeaturesRunner.class)\n+@Features({ RestServerFeature.class })\n+@RepositoryConfig(cleanup = Granularity.METHOD, init = RestServerInit.class)\n+@Deploy(\"org.nuxeo.ecm.platform.restapi.test.test:enrichers-contrib.xml\")\n+public class FailingEnricherTest\n+        extends AbstractJsonWriterTest.External<DocumentModelJsonWriter, DocumentModel> {\n+\n+    public FailingEnricherTest() {\n+        super(DocumentModelJsonWriter.class, DocumentModel.class);\n+    }\n+\n+    @Inject\n+    private CoreSession session;\n+\n+    @Test\n+    public void test() {\n+        DocumentModel root = session.getDocument(new PathRef(\"/\"));\n+        // Use the given URL codec name\n+        try {\n+            jsonAssert(root, CtxBuilder.enrichDoc(\"failingEnricher\").get());\n+        } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ac5af9861f850c8bd10b20a20f557654c7dd6d1"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE5MjQwOQ==", "bodyText": "\ud83d\udc4d I also added a logCatcher as it is requested explicitly to log the error.", "url": "https://github.com/nuxeo/nuxeo/pull/3706#discussion_r372192409", "createdAt": "2020-01-29T05:18:54Z", "author": {"login": "NourNuxeo"}, "path": "nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/enrichers/FailingEnricherTest.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour \"AIR\" AL KOTOB\n+ */\n+\n+package org.nuxeo.ecm.restapi.test.enrichers;\n+\n+import static org.junit.Assert.fail;\n+\n+import javax.inject.Inject;\n+\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.PathRef;\n+import org.nuxeo.ecm.core.io.marshallers.json.AbstractJsonWriterTest;\n+import org.nuxeo.ecm.core.io.marshallers.json.document.DocumentModelJsonWriter;\n+import org.nuxeo.ecm.core.io.registry.context.RenderingContext.CtxBuilder;\n+import org.nuxeo.ecm.core.test.annotations.Granularity;\n+import org.nuxeo.ecm.core.test.annotations.RepositoryConfig;\n+import org.nuxeo.ecm.restapi.test.RestServerFeature;\n+import org.nuxeo.ecm.restapi.test.RestServerInit;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+\n+@RunWith(FeaturesRunner.class)\n+@Features({ RestServerFeature.class })\n+@RepositoryConfig(cleanup = Granularity.METHOD, init = RestServerInit.class)\n+@Deploy(\"org.nuxeo.ecm.platform.restapi.test.test:enrichers-contrib.xml\")\n+public class FailingEnricherTest\n+        extends AbstractJsonWriterTest.External<DocumentModelJsonWriter, DocumentModel> {\n+\n+    public FailingEnricherTest() {\n+        super(DocumentModelJsonWriter.class, DocumentModel.class);\n+    }\n+\n+    @Inject\n+    private CoreSession session;\n+\n+    @Test\n+    public void test() {\n+        DocumentModel root = session.getDocument(new PathRef(\"/\"));\n+        // Use the given URL codec name\n+        try {\n+            jsonAssert(root, CtxBuilder.enrichDoc(\"failingEnricher\").get());\n+        } catch (Exception e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEzMzA4OA=="}, "originalCommit": {"oid": "3ac5af9861f850c8bd10b20a20f557654c7dd6d1"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTcyMjEyOnYy", "diffSide": "RIGHT", "path": "nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/enrichers/FailingEnricherTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTo0NTo0OFrOFjCLbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTo0NTo0OFrOFjCLbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI4MDE3NA==", "bodyText": "protected", "url": "https://github.com/nuxeo/nuxeo/pull/3706#discussion_r372280174", "createdAt": "2020-01-29T09:45:48Z", "author": {"login": "efge"}, "path": "nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/enrichers/FailingEnricherTest.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour \"AIR\" AL KOTOB\n+ */\n+\n+package org.nuxeo.ecm.restapi.test.enrichers;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.logging.log4j.core.LogEvent;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.PathRef;\n+import org.nuxeo.ecm.core.io.marshallers.json.AbstractJsonWriterTest;\n+import org.nuxeo.ecm.core.io.marshallers.json.document.DocumentModelJsonWriter;\n+import org.nuxeo.ecm.core.io.registry.context.RenderingContext.CtxBuilder;\n+import org.nuxeo.ecm.core.test.annotations.Granularity;\n+import org.nuxeo.ecm.core.test.annotations.RepositoryConfig;\n+import org.nuxeo.ecm.restapi.test.RestServerFeature;\n+import org.nuxeo.ecm.restapi.test.RestServerInit;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+import org.nuxeo.runtime.test.runner.LogCaptureFeature;\n+\n+@RunWith(FeaturesRunner.class)\n+@Features({ LogCaptureFeature.class, RestServerFeature.class })\n+@RepositoryConfig(cleanup = Granularity.METHOD, init = RestServerInit.class)\n+@Deploy(\"org.nuxeo.ecm.platform.restapi.test.test:enrichers-contrib.xml\")\n+public class FailingEnricherTest\n+        extends AbstractJsonWriterTest.External<DocumentModelJsonWriter, DocumentModel> {\n+\n+    @Inject\n+    protected LogCaptureFeature.Result logCaptureResult;\n+\n+    public FailingEnricherTest() {\n+        super(DocumentModelJsonWriter.class, DocumentModel.class);\n+    }\n+\n+    @Inject\n+    private CoreSession session;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f49760ab1d2175bb579eeb75706aba76b272a304"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTcyODMxOnYy", "diffSide": "RIGHT", "path": "nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/enrichers/FailingEnricherTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTo0Nzo1MFrOFjCPnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTo0Nzo1MFrOFjCPnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI4MTI0NA==", "bodyText": "session.getRootDocument()", "url": "https://github.com/nuxeo/nuxeo/pull/3706#discussion_r372281244", "createdAt": "2020-01-29T09:47:50Z", "author": {"login": "efge"}, "path": "nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/enrichers/FailingEnricherTest.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour \"AIR\" AL KOTOB\n+ */\n+\n+package org.nuxeo.ecm.restapi.test.enrichers;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.logging.log4j.core.LogEvent;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.PathRef;\n+import org.nuxeo.ecm.core.io.marshallers.json.AbstractJsonWriterTest;\n+import org.nuxeo.ecm.core.io.marshallers.json.document.DocumentModelJsonWriter;\n+import org.nuxeo.ecm.core.io.registry.context.RenderingContext.CtxBuilder;\n+import org.nuxeo.ecm.core.test.annotations.Granularity;\n+import org.nuxeo.ecm.core.test.annotations.RepositoryConfig;\n+import org.nuxeo.ecm.restapi.test.RestServerFeature;\n+import org.nuxeo.ecm.restapi.test.RestServerInit;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+import org.nuxeo.runtime.test.runner.LogCaptureFeature;\n+\n+@RunWith(FeaturesRunner.class)\n+@Features({ LogCaptureFeature.class, RestServerFeature.class })\n+@RepositoryConfig(cleanup = Granularity.METHOD, init = RestServerInit.class)\n+@Deploy(\"org.nuxeo.ecm.platform.restapi.test.test:enrichers-contrib.xml\")\n+public class FailingEnricherTest\n+        extends AbstractJsonWriterTest.External<DocumentModelJsonWriter, DocumentModel> {\n+\n+    @Inject\n+    protected LogCaptureFeature.Result logCaptureResult;\n+\n+    public FailingEnricherTest() {\n+        super(DocumentModelJsonWriter.class, DocumentModel.class);\n+    }\n+\n+    @Inject\n+    private CoreSession session;\n+\n+    @LogCaptureFeature.FilterOn(logLevel = \"ERROR\")\n+    @Test\n+    public void test() throws IOException {\n+        DocumentModel root = session.getDocument(new PathRef(\"/\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f49760ab1d2175bb579eeb75706aba76b272a304"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTc1NjIzOnYy", "diffSide": "RIGHT", "path": "nuxeo-core/nuxeo-core-io/src/main/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/AbstractJsonEnricher.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTo1NjoxNFrOFjChGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMTowNDowNFrOFjEiKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI4NTcyMw==", "bodyText": "What if the enricher throws another exception than IOException? For instance a NuxeoException?\nI think you need to deal with catching Exception and follows https://doc.nuxeo.com/corg/catching-exceptions/#calling-something-declared-as-throws-exception about InterruptedException.\nI don't think catching IOException and NuxeoException only is enough here, WDYT @efge ?", "url": "https://github.com/nuxeo/nuxeo/pull/3706#discussion_r372285723", "createdAt": "2020-01-29T09:56:14Z", "author": {"login": "troger"}, "path": "nuxeo-core/nuxeo-core-io/src/main/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/AbstractJsonEnricher.java", "diffHunk": "@@ -51,8 +55,13 @@ public boolean accept(Class<?> clazz, Type genericType, MediaType mediatype) {\n     }\n \n     @Override\n-    public void write(Enriched<EntityType> enrichable, JsonGenerator jg) throws IOException {\n-        write(jg, enrichable.getEntity());\n+    public void write(Enriched<EntityType> enrichable, JsonGenerator jg) {\n+        try {\n+            write(jg, enrichable.getEntity());\n+        } catch (IOException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f49760ab1d2175bb579eeb75706aba76b272a304"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjMxODc2Mw==", "bodyText": "Yes it's very likely we'll want to catch a more general set of errors. Typically we'll want to catch NuxeoException, NullPointerException, IllegalArgumentException, etc. So yes catch Exception and follow the guidelines to deal with InterruptedException correctly.", "url": "https://github.com/nuxeo/nuxeo/pull/3706#discussion_r372318763", "createdAt": "2020-01-29T11:04:04Z", "author": {"login": "efge"}, "path": "nuxeo-core/nuxeo-core-io/src/main/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/AbstractJsonEnricher.java", "diffHunk": "@@ -51,8 +55,13 @@ public boolean accept(Class<?> clazz, Type genericType, MediaType mediatype) {\n     }\n \n     @Override\n-    public void write(Enriched<EntityType> enrichable, JsonGenerator jg) throws IOException {\n-        write(jg, enrichable.getEntity());\n+    public void write(Enriched<EntityType> enrichable, JsonGenerator jg) {\n+        try {\n+            write(jg, enrichable.getEntity());\n+        } catch (IOException e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI4NTcyMw=="}, "originalCommit": {"oid": "f49760ab1d2175bb579eeb75706aba76b272a304"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTc2NjU0OnYy", "diffSide": "RIGHT", "path": "nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/enrichers/FailingEnricherTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTo1OToyMVrOFjCnkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTo1OToyMVrOFjCnkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI4NzM3Ng==", "bodyText": "Use FailingEnricher.NAME.", "url": "https://github.com/nuxeo/nuxeo/pull/3706#discussion_r372287376", "createdAt": "2020-01-29T09:59:21Z", "author": {"login": "troger"}, "path": "nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/enrichers/FailingEnricherTest.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour \"AIR\" AL KOTOB\n+ */\n+\n+package org.nuxeo.ecm.restapi.test.enrichers;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.logging.log4j.core.LogEvent;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.PathRef;\n+import org.nuxeo.ecm.core.io.marshallers.json.AbstractJsonWriterTest;\n+import org.nuxeo.ecm.core.io.marshallers.json.document.DocumentModelJsonWriter;\n+import org.nuxeo.ecm.core.io.registry.context.RenderingContext.CtxBuilder;\n+import org.nuxeo.ecm.core.test.annotations.Granularity;\n+import org.nuxeo.ecm.core.test.annotations.RepositoryConfig;\n+import org.nuxeo.ecm.restapi.test.RestServerFeature;\n+import org.nuxeo.ecm.restapi.test.RestServerInit;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+import org.nuxeo.runtime.test.runner.LogCaptureFeature;\n+\n+@RunWith(FeaturesRunner.class)\n+@Features({ LogCaptureFeature.class, RestServerFeature.class })\n+@RepositoryConfig(cleanup = Granularity.METHOD, init = RestServerInit.class)\n+@Deploy(\"org.nuxeo.ecm.platform.restapi.test.test:enrichers-contrib.xml\")\n+public class FailingEnricherTest\n+        extends AbstractJsonWriterTest.External<DocumentModelJsonWriter, DocumentModel> {\n+\n+    @Inject\n+    protected LogCaptureFeature.Result logCaptureResult;\n+\n+    public FailingEnricherTest() {\n+        super(DocumentModelJsonWriter.class, DocumentModel.class);\n+    }\n+\n+    @Inject\n+    protected CoreSession session;\n+\n+    @LogCaptureFeature.FilterOn(logLevel = \"ERROR\")\n+    @Test\n+    public void test() throws IOException {\n+        DocumentModel root = session.getRootDocument();\n+        // shouldn't throw\n+        jsonAssert(root, CtxBuilder.enrichDoc(\"failingEnricher\").get());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e11acf0e6cbf9336c495cfa6fe28431aa976ae07"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTc3NDU5OnYy", "diffSide": "RIGHT", "path": "nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/enrichers/FailingEnricherTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMDowMTo1MFrOFjCslA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMDo1NDowOVrOFjEQPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI4ODY2MA==", "bodyText": "This test should go to nuxeo-core-test module with other enricher tests.", "url": "https://github.com/nuxeo/nuxeo/pull/3706#discussion_r372288660", "createdAt": "2020-01-29T10:01:50Z", "author": {"login": "troger"}, "path": "nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/enrichers/FailingEnricherTest.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour \"AIR\" AL KOTOB\n+ */\n+\n+package org.nuxeo.ecm.restapi.test.enrichers;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.logging.log4j.core.LogEvent;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.PathRef;\n+import org.nuxeo.ecm.core.io.marshallers.json.AbstractJsonWriterTest;\n+import org.nuxeo.ecm.core.io.marshallers.json.document.DocumentModelJsonWriter;\n+import org.nuxeo.ecm.core.io.registry.context.RenderingContext.CtxBuilder;\n+import org.nuxeo.ecm.core.test.annotations.Granularity;\n+import org.nuxeo.ecm.core.test.annotations.RepositoryConfig;\n+import org.nuxeo.ecm.restapi.test.RestServerFeature;\n+import org.nuxeo.ecm.restapi.test.RestServerInit;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+import org.nuxeo.runtime.test.runner.LogCaptureFeature;\n+\n+@RunWith(FeaturesRunner.class)\n+@Features({ LogCaptureFeature.class, RestServerFeature.class })\n+@RepositoryConfig(cleanup = Granularity.METHOD, init = RestServerInit.class)\n+@Deploy(\"org.nuxeo.ecm.platform.restapi.test.test:enrichers-contrib.xml\")\n+public class FailingEnricherTest", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e11acf0e6cbf9336c495cfa6fe28431aa976ae07"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjMxNDE3NA==", "bodyText": "Then I'll move the FailingEnricher with it as it is", "url": "https://github.com/nuxeo/nuxeo/pull/3706#discussion_r372314174", "createdAt": "2020-01-29T10:54:09Z", "author": {"login": "NourNuxeo"}, "path": "nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/enrichers/FailingEnricherTest.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour \"AIR\" AL KOTOB\n+ */\n+\n+package org.nuxeo.ecm.restapi.test.enrichers;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.logging.log4j.core.LogEvent;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.PathRef;\n+import org.nuxeo.ecm.core.io.marshallers.json.AbstractJsonWriterTest;\n+import org.nuxeo.ecm.core.io.marshallers.json.document.DocumentModelJsonWriter;\n+import org.nuxeo.ecm.core.io.registry.context.RenderingContext.CtxBuilder;\n+import org.nuxeo.ecm.core.test.annotations.Granularity;\n+import org.nuxeo.ecm.core.test.annotations.RepositoryConfig;\n+import org.nuxeo.ecm.restapi.test.RestServerFeature;\n+import org.nuxeo.ecm.restapi.test.RestServerInit;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+import org.nuxeo.runtime.test.runner.LogCaptureFeature;\n+\n+@RunWith(FeaturesRunner.class)\n+@Features({ LogCaptureFeature.class, RestServerFeature.class })\n+@RepositoryConfig(cleanup = Granularity.METHOD, init = RestServerInit.class)\n+@Deploy(\"org.nuxeo.ecm.platform.restapi.test.test:enrichers-contrib.xml\")\n+public class FailingEnricherTest", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI4ODY2MA=="}, "originalCommit": {"oid": "e11acf0e6cbf9336c495cfa6fe28431aa976ae07"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTgxNjc1OnYy", "diffSide": "RIGHT", "path": "nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/enrichers/FailingEnricher.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMDoxNDo1NFrOFjDGRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMDoxNDo1NFrOFjDGRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI5NTIzOA==", "bodyText": "I would have put a more meaningful message here, such as \"Simulated exception for test purpose\".", "url": "https://github.com/nuxeo/nuxeo/pull/3706#discussion_r372295238", "createdAt": "2020-01-29T10:14:54Z", "author": {"login": "troger"}, "path": "nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/enrichers/FailingEnricher.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+\n+package org.nuxeo.ecm.restapi.test.enrichers;\n+\n+import static org.nuxeo.ecm.core.io.registry.reflect.Instantiations.SINGLETON;\n+import static org.nuxeo.ecm.core.io.registry.reflect.Priorities.REFERENCE;\n+\n+import java.io.IOException;\n+\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.io.marshallers.json.enrichers.AbstractJsonEnricher;\n+import org.nuxeo.ecm.core.io.registry.reflect.Setup;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+\n+@Setup(mode = SINGLETON, priority = REFERENCE)\n+public class FailingEnricher extends AbstractJsonEnricher<DocumentModel> {\n+\n+    public static final String NAME = \"failingEnricher\";\n+\n+    public FailingEnricher() {\n+        super(NAME);\n+    }\n+\n+    @Override\n+    public void write(JsonGenerator jg, DocumentModel enriched) throws IOException {\n+        throw new IOException(\"oh yeah!\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e11acf0e6cbf9336c495cfa6fe28431aa976ae07"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTgxODM5OnYy", "diffSide": "RIGHT", "path": "nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/enrichers/FailingEnricherTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMDoxNToyMVrOFjDHWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMDo0NjoyOFrOFjECNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI5NTUxNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             *     Nour \"AIR\" AL KOTOB\n          \n          \n            \n             *     Nour AL KOTOB\n          \n      \n    \n    \n  \n\n? \ud83d\ude04", "url": "https://github.com/nuxeo/nuxeo/pull/3706#discussion_r372295514", "createdAt": "2020-01-29T10:15:21Z", "author": {"login": "troger"}, "path": "nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/enrichers/FailingEnricherTest.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour \"AIR\" AL KOTOB", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e11acf0e6cbf9336c495cfa6fe28431aa976ae07"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjMxMDU4Mg==", "bodyText": "Grilled \ud83d\ude2c", "url": "https://github.com/nuxeo/nuxeo/pull/3706#discussion_r372310582", "createdAt": "2020-01-29T10:46:28Z", "author": {"login": "NourNuxeo"}, "path": "nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/enrichers/FailingEnricherTest.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour \"AIR\" AL KOTOB", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI5NTUxNA=="}, "originalCommit": {"oid": "e11acf0e6cbf9336c495cfa6fe28431aa976ae07"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMjAwMjk5OnYy", "diffSide": "RIGHT", "path": "nuxeo-core/nuxeo-core-io/src/main/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/AbstractJsonEnricher.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMToxNzoyMVrOFjE4RA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMToyMzo1MVrOFjFCvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjMyNDQyMA==", "bodyText": "If you receive an InterruptedException you must stop processing immediately, so throw new RuntimeException(\"interrupted\", e). Again, please read the doc https://doc.nuxeo.com/corg/catching-exceptions/#calling-something-declared-as-throws-exception", "url": "https://github.com/nuxeo/nuxeo/pull/3706#discussion_r372324420", "createdAt": "2020-01-29T11:17:21Z", "author": {"login": "efge"}, "path": "nuxeo-core/nuxeo-core-io/src/main/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/AbstractJsonEnricher.java", "diffHunk": "@@ -51,8 +55,16 @@ public boolean accept(Class<?> clazz, Type genericType, MediaType mediatype) {\n     }\n \n     @Override\n-    public void write(Enriched<EntityType> enrichable, JsonGenerator jg) throws IOException {\n-        write(jg, enrichable.getEntity());\n+    public void write(Enriched<EntityType> enrichable, JsonGenerator jg) {\n+        try {\n+            write(jg, enrichable.getEntity());\n+        } catch (Exception e) {\n+            if (e instanceof InterruptedException) {\n+                Thread.currentThread().interrupt();\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ccf3bf835ec45a24f3d0b3f3d5d8a71395d3fdc"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjMyNzEwMQ==", "bodyText": "I read it but then we defeat the purpose of the ticket which is for the response not to fail because of an enricher failure.\nAlright ! Thanks for F2F extra explenations", "url": "https://github.com/nuxeo/nuxeo/pull/3706#discussion_r372327101", "createdAt": "2020-01-29T11:23:51Z", "author": {"login": "NourNuxeo"}, "path": "nuxeo-core/nuxeo-core-io/src/main/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/AbstractJsonEnricher.java", "diffHunk": "@@ -51,8 +55,16 @@ public boolean accept(Class<?> clazz, Type genericType, MediaType mediatype) {\n     }\n \n     @Override\n-    public void write(Enriched<EntityType> enrichable, JsonGenerator jg) throws IOException {\n-        write(jg, enrichable.getEntity());\n+    public void write(Enriched<EntityType> enrichable, JsonGenerator jg) {\n+        try {\n+            write(jg, enrichable.getEntity());\n+        } catch (Exception e) {\n+            if (e instanceof InterruptedException) {\n+                Thread.currentThread().interrupt();\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjMyNDQyMA=="}, "originalCommit": {"oid": "7ccf3bf835ec45a24f3d0b3f3d5d8a71395d3fdc"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMjQxMDEwOnYy", "diffSide": "RIGHT", "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/FailingEnricherTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzo0MjozM1rOFjIwdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzo0MjozM1rOFjIwdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM4Nzk1Ng==", "bodyText": "This class seems not formatted correctly.", "url": "https://github.com/nuxeo/nuxeo/pull/3706#discussion_r372387956", "createdAt": "2020-01-29T13:42:33Z", "author": {"login": "troger"}, "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/FailingEnricherTest.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+\n+package org.nuxeo.ecm.core.io.marshallers.json.enrichers;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.logging.log4j.core.LogEvent;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.io.marshallers.json.AbstractJsonWriterTest;\n+import org.nuxeo.ecm.core.io.marshallers.json.document.DocumentModelJsonWriter;\n+import org.nuxeo.ecm.core.io.registry.context.RenderingContext.CtxBuilder;\n+import org.nuxeo.ecm.core.test.CoreFeature;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+import org.nuxeo.runtime.test.runner.LogCaptureFeature;\n+\n+@RunWith(FeaturesRunner.class)\n+@Features({ LogCaptureFeature.class, CoreFeature.class })\n+@Deploy(\"org.nuxeo.ecm.core.test.tests:enrichers-contrib.xml\")\n+public class FailingEnricherTest", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8a4c60f39a3ce9b4d18b3e3bff5dd489d97f4f5"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwNTQxODAwOnYy", "diffSide": "RIGHT", "path": "nuxeo-core/nuxeo-core-io/src/main/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/AbstractJsonEnricher.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxMDoxNToyM1rOFjluxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxNTowMTo0M1rOFjuI0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg2MjY2MQ==", "bodyText": "Thinking of it, I would log it at INFO or DEBUG level. Not sure it's a good idea to fill the server logs with errors when doing calls asking for an enricher that fails.\nLooking at the initial issue NXP-28047, it seems legitimate to me to define a set of enrichers used for all calls of an application, even if they should not be applicable for all calls.\nWDYT @kevinleturc @efge ?", "url": "https://github.com/nuxeo/nuxeo/pull/3706#discussion_r372862661", "createdAt": "2020-01-30T10:15:23Z", "author": {"login": "troger"}, "path": "nuxeo-core/nuxeo-core-io/src/main/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/AbstractJsonEnricher.java", "diffHunk": "@@ -51,8 +55,18 @@ public boolean accept(Class<?> clazz, Type genericType, MediaType mediatype) {\n     }\n \n     @Override\n-    public void write(Enriched<EntityType> enrichable, JsonGenerator jg) throws IOException {\n-        write(jg, enrichable.getEntity());\n+    public void write(Enriched<EntityType> enrichable, JsonGenerator jg) {\n+        try {\n+            write(jg, enrichable.getEntity());\n+        } catch (Exception e) {\n+            if (e instanceof InterruptedException) {\n+                Thread.currentThread().interrupt();\n+                throw new RuntimeException(\"interrupted\", e); // NOSONAR\n+            } else {\n+                // TODO collect exception and return it to the caller\n+                log.error(e, e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0db60b2cd5acb9e4e7ce788f1b55e8d6683441d2"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk0MDQ2Nw==", "bodyText": "But even then these enrichers shouldn't fail with an exception, they should gracefully return nothing. I really don't see a good reason to hide an exception here.", "url": "https://github.com/nuxeo/nuxeo/pull/3706#discussion_r372940467", "createdAt": "2020-01-30T13:16:44Z", "author": {"login": "efge"}, "path": "nuxeo-core/nuxeo-core-io/src/main/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/AbstractJsonEnricher.java", "diffHunk": "@@ -51,8 +55,18 @@ public boolean accept(Class<?> clazz, Type genericType, MediaType mediatype) {\n     }\n \n     @Override\n-    public void write(Enriched<EntityType> enrichable, JsonGenerator jg) throws IOException {\n-        write(jg, enrichable.getEntity());\n+    public void write(Enriched<EntityType> enrichable, JsonGenerator jg) {\n+        try {\n+            write(jg, enrichable.getEntity());\n+        } catch (Exception e) {\n+            if (e instanceof InterruptedException) {\n+                Thread.currentThread().interrupt();\n+                throw new RuntimeException(\"interrupted\", e); // NOSONAR\n+            } else {\n+                // TODO collect exception and return it to the caller\n+                log.error(e, e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg2MjY2MQ=="}, "originalCommit": {"oid": "0db60b2cd5acb9e4e7ce788f1b55e8d6683441d2"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk0MTkyMQ==", "bodyText": "I'm in favor of an info log with a specific message, not the exception, and keep the exception as 2nd argument for the stack.\nAlso, we can have something like this (but overkill IMHO):\nif (log.isInfoEnabled()) {\n    log.info(\"message\", e);\n} else {\n    log.warn(\"message\");\n}", "url": "https://github.com/nuxeo/nuxeo/pull/3706#discussion_r372941921", "createdAt": "2020-01-30T13:19:48Z", "author": {"login": "kevinleturc"}, "path": "nuxeo-core/nuxeo-core-io/src/main/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/AbstractJsonEnricher.java", "diffHunk": "@@ -51,8 +55,18 @@ public boolean accept(Class<?> clazz, Type genericType, MediaType mediatype) {\n     }\n \n     @Override\n-    public void write(Enriched<EntityType> enrichable, JsonGenerator jg) throws IOException {\n-        write(jg, enrichable.getEntity());\n+    public void write(Enriched<EntityType> enrichable, JsonGenerator jg) {\n+        try {\n+            write(jg, enrichable.getEntity());\n+        } catch (Exception e) {\n+            if (e instanceof InterruptedException) {\n+                Thread.currentThread().interrupt();\n+                throw new RuntimeException(\"interrupted\", e); // NOSONAR\n+            } else {\n+                // TODO collect exception and return it to the caller\n+                log.error(e, e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg2MjY2MQ=="}, "originalCommit": {"oid": "0db60b2cd5acb9e4e7ce788f1b55e8d6683441d2"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk1NTU0NQ==", "bodyText": "Since I can't make sure how each writer does handle  failure and some may return exceptions when they should just fail gracefully, log.info seems to be a workaround to make them fail silently if not gracefully.\nAbout the conditional structure, I don't think it is overkill. Because in the case info is not enabled then people might search why enrichment is not done in the requests rather than in the writer. But I went for a simple log.info(\"enrichment failed\", e);", "url": "https://github.com/nuxeo/nuxeo/pull/3706#discussion_r372955545", "createdAt": "2020-01-30T13:46:39Z", "author": {"login": "NourNuxeo"}, "path": "nuxeo-core/nuxeo-core-io/src/main/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/AbstractJsonEnricher.java", "diffHunk": "@@ -51,8 +55,18 @@ public boolean accept(Class<?> clazz, Type genericType, MediaType mediatype) {\n     }\n \n     @Override\n-    public void write(Enriched<EntityType> enrichable, JsonGenerator jg) throws IOException {\n-        write(jg, enrichable.getEntity());\n+    public void write(Enriched<EntityType> enrichable, JsonGenerator jg) {\n+        try {\n+            write(jg, enrichable.getEntity());\n+        } catch (Exception e) {\n+            if (e instanceof InterruptedException) {\n+                Thread.currentThread().interrupt();\n+                throw new RuntimeException(\"interrupted\", e); // NOSONAR\n+            } else {\n+                // TODO collect exception and return it to the caller\n+                log.error(e, e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg2MjY2MQ=="}, "originalCommit": {"oid": "0db60b2cd5acb9e4e7ce788f1b55e8d6683441d2"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk4NDQ2OA==", "bodyText": "There's still not the message in the code \ud83e\udd14did you push?", "url": "https://github.com/nuxeo/nuxeo/pull/3706#discussion_r372984468", "createdAt": "2020-01-30T14:36:20Z", "author": {"login": "kevinleturc"}, "path": "nuxeo-core/nuxeo-core-io/src/main/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/AbstractJsonEnricher.java", "diffHunk": "@@ -51,8 +55,18 @@ public boolean accept(Class<?> clazz, Type genericType, MediaType mediatype) {\n     }\n \n     @Override\n-    public void write(Enriched<EntityType> enrichable, JsonGenerator jg) throws IOException {\n-        write(jg, enrichable.getEntity());\n+    public void write(Enriched<EntityType> enrichable, JsonGenerator jg) {\n+        try {\n+            write(jg, enrichable.getEntity());\n+        } catch (Exception e) {\n+            if (e instanceof InterruptedException) {\n+                Thread.currentThread().interrupt();\n+                throw new RuntimeException(\"interrupted\", e); // NOSONAR\n+            } else {\n+                // TODO collect exception and return it to the caller\n+                log.error(e, e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg2MjY2MQ=="}, "originalCommit": {"oid": "0db60b2cd5acb9e4e7ce788f1b55e8d6683441d2"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzAwMDQwMg==", "bodyText": "I did, but that would override the message in the exception thrown by the writer implementation.\nI found the message thrown by FailingEnricher to be more specific than a static one I would put in the abstract.\nSo I reverted it when complying to #3706 (comment)", "url": "https://github.com/nuxeo/nuxeo/pull/3706#discussion_r373000402", "createdAt": "2020-01-30T15:01:43Z", "author": {"login": "NourNuxeo"}, "path": "nuxeo-core/nuxeo-core-io/src/main/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/AbstractJsonEnricher.java", "diffHunk": "@@ -51,8 +55,18 @@ public boolean accept(Class<?> clazz, Type genericType, MediaType mediatype) {\n     }\n \n     @Override\n-    public void write(Enriched<EntityType> enrichable, JsonGenerator jg) throws IOException {\n-        write(jg, enrichable.getEntity());\n+    public void write(Enriched<EntityType> enrichable, JsonGenerator jg) {\n+        try {\n+            write(jg, enrichable.getEntity());\n+        } catch (Exception e) {\n+            if (e instanceof InterruptedException) {\n+                Thread.currentThread().interrupt();\n+                throw new RuntimeException(\"interrupted\", e); // NOSONAR\n+            } else {\n+                // TODO collect exception and return it to the caller\n+                log.error(e, e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg2MjY2MQ=="}, "originalCommit": {"oid": "0db60b2cd5acb9e4e7ce788f1b55e8d6683441d2"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwNTk4NjgxOnYy", "diffSide": "RIGHT", "path": "nuxeo-core/nuxeo-core-io/src/main/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/AbstractJsonEnricher.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxMzozNzo0M1rOFjrHIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxMzo0ODo1M1rOFjredQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk1MDgxNg==", "bodyText": "You could use this:\norg.nuxeo.common.utils.ExceptionUtils.checkInterrupt(e);\nand get rid of these three lines + if / else.", "url": "https://github.com/nuxeo/nuxeo/pull/3706#discussion_r372950816", "createdAt": "2020-01-30T13:37:43Z", "author": {"login": "kevinleturc"}, "path": "nuxeo-core/nuxeo-core-io/src/main/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/AbstractJsonEnricher.java", "diffHunk": "@@ -51,8 +55,18 @@ public boolean accept(Class<?> clazz, Type genericType, MediaType mediatype) {\n     }\n \n     @Override\n-    public void write(Enriched<EntityType> enrichable, JsonGenerator jg) throws IOException {\n-        write(jg, enrichable.getEntity());\n+    public void write(Enriched<EntityType> enrichable, JsonGenerator jg) {\n+        try {\n+            write(jg, enrichable.getEntity());\n+        } catch (Exception e) {\n+            if (e instanceof InterruptedException) {\n+                Thread.currentThread().interrupt();\n+                throw new RuntimeException(\"interrupted\", e); // NOSONAR", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0db60b2cd5acb9e4e7ce788f1b55e8d6683441d2"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk1Njc4OQ==", "bodyText": "Actually I prefer that we don't call checkInterrupt anymore, as it confuses tools that look for specific InterruptedException management.", "url": "https://github.com/nuxeo/nuxeo/pull/3706#discussion_r372956789", "createdAt": "2020-01-30T13:48:53Z", "author": {"login": "efge"}, "path": "nuxeo-core/nuxeo-core-io/src/main/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/AbstractJsonEnricher.java", "diffHunk": "@@ -51,8 +55,18 @@ public boolean accept(Class<?> clazz, Type genericType, MediaType mediatype) {\n     }\n \n     @Override\n-    public void write(Enriched<EntityType> enrichable, JsonGenerator jg) throws IOException {\n-        write(jg, enrichable.getEntity());\n+    public void write(Enriched<EntityType> enrichable, JsonGenerator jg) {\n+        try {\n+            write(jg, enrichable.getEntity());\n+        } catch (Exception e) {\n+            if (e instanceof InterruptedException) {\n+                Thread.currentThread().interrupt();\n+                throw new RuntimeException(\"interrupted\", e); // NOSONAR", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk1MDgxNg=="}, "originalCommit": {"oid": "0db60b2cd5acb9e4e7ce788f1b55e8d6683441d2"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwNjAwMDEyOnYy", "diffSide": "RIGHT", "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/FailingEnricherTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxMzo0MTo0MFrOFjrPEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxMzo0MTo0MFrOFjrPEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk1Mjg1MQ==", "bodyText": "Could you re-organise the fields, methods and constructor? We're currently having a field, then the constructor then another field.\nFurthermore, for a reading aspect, I would put @Test before @LogCaptureFeature.FilterOn.", "url": "https://github.com/nuxeo/nuxeo/pull/3706#discussion_r372952851", "createdAt": "2020-01-30T13:41:40Z", "author": {"login": "kevinleturc"}, "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/FailingEnricherTest.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+\n+package org.nuxeo.ecm.core.io.marshallers.json.enrichers;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.logging.log4j.core.LogEvent;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.io.marshallers.json.AbstractJsonWriterTest;\n+import org.nuxeo.ecm.core.io.marshallers.json.document.DocumentModelJsonWriter;\n+import org.nuxeo.ecm.core.io.registry.context.RenderingContext.CtxBuilder;\n+import org.nuxeo.ecm.core.test.CoreFeature;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+import org.nuxeo.runtime.test.runner.LogCaptureFeature;\n+\n+@RunWith(FeaturesRunner.class)\n+@Features({ LogCaptureFeature.class, CoreFeature.class })\n+@Deploy(\"org.nuxeo.ecm.core.test.tests:enrichers-contrib.xml\")\n+public class FailingEnricherTest extends AbstractJsonWriterTest.External<DocumentModelJsonWriter, DocumentModel> {\n+\n+    @Inject\n+    protected LogCaptureFeature.Result logCaptureResult;\n+\n+    public FailingEnricherTest() {\n+        super(DocumentModelJsonWriter.class, DocumentModel.class);\n+    }\n+\n+    @Inject\n+    protected CoreSession session;\n+\n+    @LogCaptureFeature.FilterOn(logLevel = \"ERROR\")\n+    @Test\n+    public void test() throws IOException {\n+        DocumentModel root = session.getRootDocument();\n+        // shouldn't throw\n+        jsonAssert(root, CtxBuilder.enrichDoc(FailingEnricher.NAME).get());\n+        List<LogEvent> caughtEvents = logCaptureResult.getCaughtEvents();\n+        // should log an error\n+        assertEquals(1, caughtEvents.size());\n+        assertEquals(\"java.io.IOException: Simulated exception for test purpose\",\n+                caughtEvents.get(0).getMessage().toString());\n+    }\n+\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0db60b2cd5acb9e4e7ce788f1b55e8d6683441d2"}, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwNjAwNDI1OnYy", "diffSide": "RIGHT", "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/FailingEnricherTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxMzo0Mjo1NFrOFjrRow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxMzo0Mjo1NFrOFjrRow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk1MzUwNw==", "bodyText": "Could you use LogCaptureFeature.Result#getCaughtEventMessages for these assertions?", "url": "https://github.com/nuxeo/nuxeo/pull/3706#discussion_r372953507", "createdAt": "2020-01-30T13:42:54Z", "author": {"login": "kevinleturc"}, "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/FailingEnricherTest.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+\n+package org.nuxeo.ecm.core.io.marshallers.json.enrichers;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.logging.log4j.core.LogEvent;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.io.marshallers.json.AbstractJsonWriterTest;\n+import org.nuxeo.ecm.core.io.marshallers.json.document.DocumentModelJsonWriter;\n+import org.nuxeo.ecm.core.io.registry.context.RenderingContext.CtxBuilder;\n+import org.nuxeo.ecm.core.test.CoreFeature;\n+import org.nuxeo.runtime.test.runner.Deploy;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.FeaturesRunner;\n+import org.nuxeo.runtime.test.runner.LogCaptureFeature;\n+\n+@RunWith(FeaturesRunner.class)\n+@Features({ LogCaptureFeature.class, CoreFeature.class })\n+@Deploy(\"org.nuxeo.ecm.core.test.tests:enrichers-contrib.xml\")\n+public class FailingEnricherTest extends AbstractJsonWriterTest.External<DocumentModelJsonWriter, DocumentModel> {\n+\n+    @Inject\n+    protected LogCaptureFeature.Result logCaptureResult;\n+\n+    public FailingEnricherTest() {\n+        super(DocumentModelJsonWriter.class, DocumentModel.class);\n+    }\n+\n+    @Inject\n+    protected CoreSession session;\n+\n+    @LogCaptureFeature.FilterOn(logLevel = \"ERROR\")\n+    @Test\n+    public void test() throws IOException {\n+        DocumentModel root = session.getRootDocument();\n+        // shouldn't throw\n+        jsonAssert(root, CtxBuilder.enrichDoc(FailingEnricher.NAME).get());\n+        List<LogEvent> caughtEvents = logCaptureResult.getCaughtEvents();\n+        // should log an error\n+        assertEquals(1, caughtEvents.size());\n+        assertEquals(\"java.io.IOException: Simulated exception for test purpose\",\n+                caughtEvents.get(0).getMessage().toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0db60b2cd5acb9e4e7ce788f1b55e8d6683441d2"}, "originalPosition": 68}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4295, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}