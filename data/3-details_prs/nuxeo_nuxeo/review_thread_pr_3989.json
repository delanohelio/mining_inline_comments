{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDExNzI3MDEx", "number": 3989, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNzozNDo0NlrOD8W2Cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwODo0Mzo0MVrOD8YX1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NjE1NDM1OnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/adapters/BaseNuxeoArtifactDocAdapter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNzozNDo0NlrOGVPlUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNzozNDo0NlrOGVPlUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkyODU5Mw==", "bodyText": "You can use StandardCharsets instead of guava.", "url": "https://github.com/nuxeo/nuxeo/pull/3989#discussion_r424928593", "createdAt": "2020-05-14T07:34:46Z", "author": {"login": "kevinleturc"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/adapters/BaseNuxeoArtifactDocAdapter.java", "diffHunk": "@@ -18,21 +18,26 @@\n  */\n package org.nuxeo.apidoc.adapters;\n \n+import java.io.IOException;\n import java.util.Collections;\n import java.util.List;\n \n+import org.apache.commons.lang3.StringUtils;\n import org.apache.commons.logging.Log;\n import org.apache.commons.logging.LogFactory;\n import org.nuxeo.apidoc.api.BaseNuxeoArtifact;\n import org.nuxeo.apidoc.api.NuxeoArtifact;\n import org.nuxeo.apidoc.snapshot.DistributionSnapshot;\n import org.nuxeo.common.utils.IdUtils;\n import org.nuxeo.common.utils.Path;\n+import org.nuxeo.ecm.core.api.Blob;\n import org.nuxeo.ecm.core.api.CoreSession;\n import org.nuxeo.ecm.core.api.DocumentModel;\n import org.nuxeo.ecm.core.api.PathRef;\n import org.nuxeo.ecm.core.api.PropertyException;\n \n+import com.google.common.base.Charsets;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f5ab5825048c05fd3205333aa173bdcc82f917b"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NjE3MTk1OnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/adapters/BundleGroupDocAdapter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNzo0MDoxNFrOGVPwQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNzo0MDoxNFrOGVPwQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkzMTM5NA==", "bodyText": "You can use var to declare only once ArrayList (and to avoid implementation type declaration for List).", "url": "https://github.com/nuxeo/nuxeo/pull/3989#discussion_r424931394", "createdAt": "2020-05-14T07:40:14Z", "author": {"login": "kevinleturc"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/adapters/BundleGroupDocAdapter.java", "diffHunk": "@@ -49,6 +53,13 @@ public static BundleGroupDocAdapter create(BundleGroup bundleGroup, CoreSession\n         doc.setPropertyValue(NuxeoArtifact.TITLE_PROPERTY_PATH, bundleGroup.getName());\n         doc.setPropertyValue(PROP_GROUP_NAME, bundleGroup.getName());\n         doc.setPropertyValue(PROP_KEY, bundleGroup.getId());\n+        ArrayList<Map<String, Serializable>> files = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f5ab5825048c05fd3205333aa173bdcc82f917b"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NjIxNDM2OnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/introspection/RuntimeSnapshot.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNzo1MTo1NlrOGVQKjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNzo1MTo1NlrOGVQKjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkzODEyNg==", "bodyText": "LogManager from log4j2 should be used instead.", "url": "https://github.com/nuxeo/nuxeo/pull/3989#discussion_r424938126", "createdAt": "2020-05-14T07:51:56Z", "author": {"login": "kevinleturc"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/introspection/RuntimeSnapshot.java", "diffHunk": "@@ -60,13 +62,16 @@\n import com.fasterxml.jackson.annotation.JsonProperty;\n import com.fasterxml.jackson.core.JsonGenerator;\n import com.fasterxml.jackson.core.JsonParser;\n+import com.fasterxml.jackson.core.PrettyPrinter;\n import com.fasterxml.jackson.databind.DeserializationFeature;\n import com.fasterxml.jackson.databind.ObjectMapper;\n import com.fasterxml.jackson.databind.ObjectReader;\n import com.fasterxml.jackson.databind.ObjectWriter;\n \n public class RuntimeSnapshot extends BaseNuxeoArtifact implements DistributionSnapshot {\n \n+    private static final Log log = LogFactory.getLog(RuntimeSnapshot.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f5ab5825048c05fd3205333aa173bdcc82f917b"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NjI0NDMyOnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-webengine/src/main/java/org/nuxeo/apidoc/browse/OperationWO.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwODowMDoxN1rOGVQdsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwODoxMzoxMlrOGVQ6QQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk0MzAyNA==", "bodyText": "StringUtils.isEmpty can be used.", "url": "https://github.com/nuxeo/nuxeo/pull/3989#discussion_r424943024", "createdAt": "2020-05-14T08:00:17Z", "author": {"login": "kevinleturc"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-webengine/src/main/java/org/nuxeo/apidoc/browse/OperationWO.java", "diffHunk": "@@ -48,44 +50,24 @@ public NuxeoArtifact getNxArtifact() {\n         return getTargetComponentInfo();\n     }\n \n-    protected String[] getInputs(OperationInfo op) {\n-        String[] signature = op.getSignature();\n-        if (signature == null || signature.length == 0) {\n-            return new String[0];\n-        }\n-        String[] result = new String[signature.length / 2];\n-        for (int i = 0, k = 0; i < signature.length; i += 2, k++) {\n-            result[k] = signature[i];\n-        }\n-        return result;\n-    }\n-\n-    protected String[] getOutputs(OperationInfo op) {\n-        String[] signature = op.getSignature();\n-        if (signature == null || signature.length == 0) {\n-            return new String[0];\n+    protected String getSignatureInfo(OperationInfo op, boolean isInput) {\n+        List<String> signature = op.getSignature();\n+        if (signature == null || signature.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f5ab5825048c05fd3205333aa173bdcc82f917b"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk0OTk4Mg==", "bodyText": "even if it's a list?", "url": "https://github.com/nuxeo/nuxeo/pull/3989#discussion_r424949982", "createdAt": "2020-05-14T08:12:36Z", "author": {"login": "atchertchian"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-webengine/src/main/java/org/nuxeo/apidoc/browse/OperationWO.java", "diffHunk": "@@ -48,44 +50,24 @@ public NuxeoArtifact getNxArtifact() {\n         return getTargetComponentInfo();\n     }\n \n-    protected String[] getInputs(OperationInfo op) {\n-        String[] signature = op.getSignature();\n-        if (signature == null || signature.length == 0) {\n-            return new String[0];\n-        }\n-        String[] result = new String[signature.length / 2];\n-        for (int i = 0, k = 0; i < signature.length; i += 2, k++) {\n-            result[k] = signature[i];\n-        }\n-        return result;\n-    }\n-\n-    protected String[] getOutputs(OperationInfo op) {\n-        String[] signature = op.getSignature();\n-        if (signature == null || signature.length == 0) {\n-            return new String[0];\n+    protected String getSignatureInfo(OperationInfo op, boolean isInput) {\n+        List<String> signature = op.getSignature();\n+        if (signature == null || signature.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk0MzAyNA=="}, "originalCommit": {"oid": "7f5ab5825048c05fd3205333aa173bdcc82f917b"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk1MDMzNw==", "bodyText": "Indeed, sorry for noise.", "url": "https://github.com/nuxeo/nuxeo/pull/3989#discussion_r424950337", "createdAt": "2020-05-14T08:13:12Z", "author": {"login": "kevinleturc"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-webengine/src/main/java/org/nuxeo/apidoc/browse/OperationWO.java", "diffHunk": "@@ -48,44 +50,24 @@ public NuxeoArtifact getNxArtifact() {\n         return getTargetComponentInfo();\n     }\n \n-    protected String[] getInputs(OperationInfo op) {\n-        String[] signature = op.getSignature();\n-        if (signature == null || signature.length == 0) {\n-            return new String[0];\n-        }\n-        String[] result = new String[signature.length / 2];\n-        for (int i = 0, k = 0; i < signature.length; i += 2, k++) {\n-            result[k] = signature[i];\n-        }\n-        return result;\n-    }\n-\n-    protected String[] getOutputs(OperationInfo op) {\n-        String[] signature = op.getSignature();\n-        if (signature == null || signature.length == 0) {\n-            return new String[0];\n+    protected String getSignatureInfo(OperationInfo op, boolean isInput) {\n+        List<String> signature = op.getSignature();\n+        if (signature == null || signature.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk0MzAyNA=="}, "originalCommit": {"oid": "7f5ab5825048c05fd3205333aa173bdcc82f917b"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NjI0NzQyOnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-webengine/src/main/java/org/nuxeo/apidoc/browse/OperationWO.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwODowMTowNlrOGVQfnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwODowMTowNlrOGVQfnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk0MzUxNg==", "bodyText": "String.join from JDK can be used.", "url": "https://github.com/nuxeo/nuxeo/pull/3989#discussion_r424943516", "createdAt": "2020-05-14T08:01:06Z", "author": {"login": "kevinleturc"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-webengine/src/main/java/org/nuxeo/apidoc/browse/OperationWO.java", "diffHunk": "@@ -48,44 +50,24 @@ public NuxeoArtifact getNxArtifact() {\n         return getTargetComponentInfo();\n     }\n \n-    protected String[] getInputs(OperationInfo op) {\n-        String[] signature = op.getSignature();\n-        if (signature == null || signature.length == 0) {\n-            return new String[0];\n-        }\n-        String[] result = new String[signature.length / 2];\n-        for (int i = 0, k = 0; i < signature.length; i += 2, k++) {\n-            result[k] = signature[i];\n-        }\n-        return result;\n-    }\n-\n-    protected String[] getOutputs(OperationInfo op) {\n-        String[] signature = op.getSignature();\n-        if (signature == null || signature.length == 0) {\n-            return new String[0];\n+    protected String getSignatureInfo(OperationInfo op, boolean isInput) {\n+        List<String> signature = op.getSignature();\n+        if (signature == null || signature.isEmpty()) {\n+            return \"void\";\n         }\n-        String[] result = new String[signature.length / 2];\n-        for (int i = 1, k = 0; i < signature.length; i += 2, k++) {\n-            result[k] = signature[i];\n+        List<String> result = new ArrayList<>();\n+        for (int i = (isInput ? 0 : 1); i < signature.size(); i += 2) {\n+            result.add(signature.get(i));\n         }\n-        return result;\n+        return StringUtils.join(result, \", \");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f5ab5825048c05fd3205333aa173bdcc82f917b"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NjQwNDcxOnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/introspection/EmbeddedDocExtractor.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwODo0Mzo0MVrOGVSE2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTowNjowMlrOGVS-0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk2OTQzNQ==", "bodyText": "This test seems a bit too optimist; as everything starting by readme matches. Like readme-test.md, readme-sample.ascidoc, etc.", "url": "https://github.com/nuxeo/nuxeo/pull/3989#discussion_r424969435", "createdAt": "2020-05-14T08:43:41Z", "author": {"login": "akervern"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/introspection/EmbeddedDocExtractor.java", "diffHunk": "@@ -18,68 +18,116 @@\n  */\n package org.nuxeo.apidoc.introspection;\n \n+import java.io.File;\n+import java.io.FileInputStream;\n import java.io.IOException;\n import java.io.InputStream;\n import java.nio.charset.StandardCharsets;\n import java.util.Enumeration;\n-import java.util.HashMap;\n-import java.util.Map;\n import java.util.zip.ZipEntry;\n import java.util.zip.ZipFile;\n \n import org.apache.commons.io.IOUtils;\n-import org.nuxeo.apidoc.documentation.DefaultDocumentationType;\n-import org.nuxeo.apidoc.documentation.ResourceDocumentationItem;\n import org.nuxeo.common.utils.Path;\n+import org.nuxeo.ecm.core.api.Blob;\n+import org.nuxeo.ecm.core.api.impl.blob.StringBlob;\n \n public class EmbeddedDocExtractor {\n \n     public static final String DOC_PREFIX = \"doc/\";\n \n     public static final String PARENT_DOC_PREFIX = \"doc-parent/\";\n \n-    public static void extractEmbeddedDoc(ZipFile jarFile, BundleInfoImpl bi) throws IOException {\n+    /**\n+     * Hardcoded parent readme filename for tests.\n+     *\n+     * @since 11.1\n+     */\n+    protected static final String README = \"ReadMe.md\";\n \n-        Enumeration<? extends ZipEntry> entries = jarFile.entries();\n+    /**\n+     * Navigates hierarchy to find target file.\n+     *\n+     * @since 11.1\n+     */\n+    public static File findFile(File jarFile, String subPath) {\n+        File up = new File(jarFile, \"..\");\n+        File file = new File(up, subPath);\n+        if (!file.exists()) {\n+            file = new File(new File(up, \"..\"), subPath);\n+            if (!file.exists()) {\n+                file = null;\n+            }\n+        }\n+        return file;\n+    }\n \n-        Map<String, ResourceDocumentationItem> localDocs = new HashMap<>();\n-        Map<String, ResourceDocumentationItem> parentDocs = new HashMap<>();\n+    public static void extractEmbeddedDoc(ZipFile jarFile, BundleInfoImpl bi) throws IOException {\n+        Enumeration<? extends ZipEntry> entries = jarFile.entries();\n         while (entries.hasMoreElements()) {\n             ZipEntry entry = entries.nextElement();\n-\n-            try (InputStream is = jarFile.getInputStream(entry)) {\n-                if (entry.getName().startsWith(PARENT_DOC_PREFIX) && !entry.isDirectory()) {\n-                    String content = IOUtils.toString(is, StandardCharsets.UTF_8);\n-                    String name = new Path(entry.getName()).lastSegment();\n-                    if (name.length() >= 6 && name.substring(0, 6).equalsIgnoreCase(\"readme\")) {\n-\n-                        ResourceDocumentationItem docItem = new ResourceDocumentationItem(name, content,\n-                                DefaultDocumentationType.DESCRIPTION.toString(), bi);\n-\n-                        parentDocs.put(DefaultDocumentationType.DESCRIPTION.toString(), docItem);\n-                    } else {\n-                        ResourceDocumentationItem docItem = new ResourceDocumentationItem(name, content,\n-                                DefaultDocumentationType.HOW_TO.toString(), bi);\n-                        parentDocs.put(DefaultDocumentationType.HOW_TO.toString(), docItem);\n-                    }\n+            if (entry.isDirectory()) {\n+                continue;\n+            }\n+            int isReadme = isReadme(entry.getName());\n+            if (isReadme > 0) {\n+                Blob content = null;\n+                String name = new Path(entry.getName()).lastSegment();\n+                try (InputStream is = jarFile.getInputStream(entry)) {\n+                    content = getReadme(name, is);\n                 }\n-                if (entry.getName().startsWith(DOC_PREFIX) && !entry.isDirectory()) {\n-                    String content = IOUtils.toString(is, StandardCharsets.UTF_8);\n-                    String name = new Path(entry.getName()).lastSegment();\n-                    if (name.length() >= 6 && name.substring(0, 6).equalsIgnoreCase(\"readme\")) {\n-\n-                        ResourceDocumentationItem docItem = new ResourceDocumentationItem(name, content,\n-                                DefaultDocumentationType.DESCRIPTION.toString(), bi);\n-                        localDocs.put(DefaultDocumentationType.DESCRIPTION.toString(), docItem);\n-                    } else {\n-                        ResourceDocumentationItem docItem = new ResourceDocumentationItem(name, content,\n-                                DefaultDocumentationType.HOW_TO.toString(), bi);\n-                        localDocs.put(DefaultDocumentationType.HOW_TO.toString(), docItem);\n-                    }\n+                if (isReadme == 1) {\n+                    bi.setReadme(content);\n+                } else {\n+                    bi.setParentReadme(content);\n                 }\n             }\n+            if (bi.getReadme() != null && bi.getParentReadme() != null) {\n+                break;\n+            }\n         }\n-        bi.setLiveDoc(localDocs);\n-        bi.setParentLiveDoc(parentDocs);\n     }\n+\n+    /**\n+     * Mimicks extaction of readme file for tests.\n+     *\n+     * @implNote maven is in charge of copying doc files to the target server: this needs to be done here for tests to\n+     *           still take readmes into account in Eclipse for instance.\n+     * @since 11.1\n+     */\n+    public static void extractEmbeddedDoc(File dirFile, BundleInfoImpl bi) throws IOException {\n+        File readme = findFile(dirFile, README);\n+        if (readme != null) {\n+            try (InputStream is = new FileInputStream(readme)) {\n+                bi.setReadme(getReadme(README, is));\n+            }\n+        }\n+        File parentReadme = findFile(new File(dirFile, \"../..\"), README);\n+        if (parentReadme != null) {\n+            try (InputStream is = new FileInputStream(parentReadme)) {\n+                bi.setParentReadme(getReadme(README, is));\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Returns 0 if not a doc, 1 if local doc, 2 if parent doc.\n+     */\n+    protected static int isReadme(String name) {\n+        boolean isDoc = name.startsWith(DOC_PREFIX);\n+        boolean isParentDoc = name.startsWith(PARENT_DOC_PREFIX);\n+        if (isDoc || isParentDoc) {\n+            String filename = new Path(name).lastSegment();\n+            if (filename.length() >= 6 && filename.substring(0, 6).equalsIgnoreCase(\"readme\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8db9ff702916b594b0cd42f7bb580a83dd56e40"}, "originalPosition": 143}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk4NDI3NQ==", "bodyText": "Indeed, i had kept the old logics but i changed it so that it better represents what's extracted.\nNote that in practice \"readme-sample.ascidoc\" would not be retrieved by the maven plugin configuration, though, and that readme-test.md is actually accepted.\nNote also that in practice, here's what we have in the nuxeo repository:\nmodules/runtime/nuxeo-runtime-stream/README.md\nmodules/runtime/nuxeo-stream/README.md\nmodules/runtime/nuxeo-runtime-metrics/README.md\nmodules/core/nuxeo-core-bulk/README.md\nmodules/platform/nuxeo-platform-video/README.md\nmodules/platform/nuxeo-platform-lang-ext/README.md\nmodules/platform/nuxeo-automation/nuxeo-automation-scripting/Readme.md\nmodules/platform/nuxeo-platform-document-routing/nuxeo-routing-default/README.md\nmodules/platform/nuxeo-platform-mail/README.md\nmodules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-seqgen/README.md\nmodules/platform/nuxeo-elasticsearch/README.md\nmodules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-audit/README.md\nmodules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-http-read-only/README.md\nmodules/platform/nuxeo-elasticsearch/scripts/README.md\nmodules/platform/nuxeo-usermapper/README.md\nmodules/platform/nuxeo-template-rendering/nuxeo-template-rendering-xdocreport/ReadMe.md\nmodules/platform/nuxeo-template-rendering/nuxeo-template-rendering-jod/ReadMe.md\nmodules/platform/nuxeo-template-rendering/ReadMe.md\nmodules/platform/nuxeo-template-rendering/nuxeo-template-rendering-sandbox/ReadMe.md\nmodules/platform/nuxeo-template-rendering/nuxeo-template-rendering-jaxrs/ReadMe.md\nmodules/platform/nuxeo-template-rendering/nuxeo-template-rendering-jxls/ReadMe.md\nmodules/platform/nuxeo-template-rendering/nuxeo-template-rendering-api/ReadMe.md\nmodules/platform/nuxeo-template-rendering/nuxeo-template-rendering-core/ReadMe.md\nmodules/platform/nuxeo-template-rendering/nuxeo-template-rendering-deckjs/README.md\nmodules/platform/nuxeo-platform-userworkspace/ReadMe.md\nmodules/platform/nuxeo-signature/README.md\nmodules/platform/nuxeo-scim-server/ReadMe.md\nmodules/platform/nuxeo-fsexporter/README.md\nmodules/platform/nuxeo-liveconnect/nuxeo-liveconnect-google-drive-core/README.md\nmodules/platform/nuxeo-liveconnect/nuxeo-liveconnect-dropbox-core/README.md\nmodules/platform/nuxeo-liveconnect/README.md\nmodules/platform/nuxeo-liveconnect/nuxeo-liveconnect-box-core/README.md\nmodules/platform/nuxeo-platform-pdf-utils/README.md\nmodules/platform/login/nuxeo-platform-login-openid/ReadMe.md\nmodules/platform/login/nuxeo-platform-login-saml2/sample/README.md\nmodules/platform/login/nuxeo-platform-login-saml2/README.md\nmodules/platform/login/nuxeo-platform-login-token/README.md\nmodules/platform/login/nuxeo-platform-login-keycloak/README.md\nmodules/platform/nuxeo-quota/README.md\nmodules/platform/nuxeo-platform-importer/nuxeo-importer-xml-parser/ReadMe.md\nmodules/platform/nuxeo-platform-importer/README.md\nmodules/platform/nuxeo-platform-importer/nuxeo-importer-stream/README.md\nmodules/platform/nuxeo-audit-storage-directory/README.md\nmodules/platform/nuxeo-drive-server/README.md\nmodules/platform/nuxeo-drive-server/nuxeo-drive-bench/README.md\nmodules/platform/nuxeo-apidoc-server/ReadMe.md\nmodules/platform/nuxeo-apidoc-server/nuxeo-apidoc-webengine/ReadMe.md\nmodules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/ReadMe.md\nmodules/platform/nuxeo-jsf-to-web-ui/README.md\nmodules/platform/nuxeo-duoweb-authentication/README.md\nmodules/platform/nuxeo-platform-3d/README.md", "url": "https://github.com/nuxeo/nuxeo/pull/3989#discussion_r424984275", "createdAt": "2020-05-14T09:06:02Z", "author": {"login": "atchertchian"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/introspection/EmbeddedDocExtractor.java", "diffHunk": "@@ -18,68 +18,116 @@\n  */\n package org.nuxeo.apidoc.introspection;\n \n+import java.io.File;\n+import java.io.FileInputStream;\n import java.io.IOException;\n import java.io.InputStream;\n import java.nio.charset.StandardCharsets;\n import java.util.Enumeration;\n-import java.util.HashMap;\n-import java.util.Map;\n import java.util.zip.ZipEntry;\n import java.util.zip.ZipFile;\n \n import org.apache.commons.io.IOUtils;\n-import org.nuxeo.apidoc.documentation.DefaultDocumentationType;\n-import org.nuxeo.apidoc.documentation.ResourceDocumentationItem;\n import org.nuxeo.common.utils.Path;\n+import org.nuxeo.ecm.core.api.Blob;\n+import org.nuxeo.ecm.core.api.impl.blob.StringBlob;\n \n public class EmbeddedDocExtractor {\n \n     public static final String DOC_PREFIX = \"doc/\";\n \n     public static final String PARENT_DOC_PREFIX = \"doc-parent/\";\n \n-    public static void extractEmbeddedDoc(ZipFile jarFile, BundleInfoImpl bi) throws IOException {\n+    /**\n+     * Hardcoded parent readme filename for tests.\n+     *\n+     * @since 11.1\n+     */\n+    protected static final String README = \"ReadMe.md\";\n \n-        Enumeration<? extends ZipEntry> entries = jarFile.entries();\n+    /**\n+     * Navigates hierarchy to find target file.\n+     *\n+     * @since 11.1\n+     */\n+    public static File findFile(File jarFile, String subPath) {\n+        File up = new File(jarFile, \"..\");\n+        File file = new File(up, subPath);\n+        if (!file.exists()) {\n+            file = new File(new File(up, \"..\"), subPath);\n+            if (!file.exists()) {\n+                file = null;\n+            }\n+        }\n+        return file;\n+    }\n \n-        Map<String, ResourceDocumentationItem> localDocs = new HashMap<>();\n-        Map<String, ResourceDocumentationItem> parentDocs = new HashMap<>();\n+    public static void extractEmbeddedDoc(ZipFile jarFile, BundleInfoImpl bi) throws IOException {\n+        Enumeration<? extends ZipEntry> entries = jarFile.entries();\n         while (entries.hasMoreElements()) {\n             ZipEntry entry = entries.nextElement();\n-\n-            try (InputStream is = jarFile.getInputStream(entry)) {\n-                if (entry.getName().startsWith(PARENT_DOC_PREFIX) && !entry.isDirectory()) {\n-                    String content = IOUtils.toString(is, StandardCharsets.UTF_8);\n-                    String name = new Path(entry.getName()).lastSegment();\n-                    if (name.length() >= 6 && name.substring(0, 6).equalsIgnoreCase(\"readme\")) {\n-\n-                        ResourceDocumentationItem docItem = new ResourceDocumentationItem(name, content,\n-                                DefaultDocumentationType.DESCRIPTION.toString(), bi);\n-\n-                        parentDocs.put(DefaultDocumentationType.DESCRIPTION.toString(), docItem);\n-                    } else {\n-                        ResourceDocumentationItem docItem = new ResourceDocumentationItem(name, content,\n-                                DefaultDocumentationType.HOW_TO.toString(), bi);\n-                        parentDocs.put(DefaultDocumentationType.HOW_TO.toString(), docItem);\n-                    }\n+            if (entry.isDirectory()) {\n+                continue;\n+            }\n+            int isReadme = isReadme(entry.getName());\n+            if (isReadme > 0) {\n+                Blob content = null;\n+                String name = new Path(entry.getName()).lastSegment();\n+                try (InputStream is = jarFile.getInputStream(entry)) {\n+                    content = getReadme(name, is);\n                 }\n-                if (entry.getName().startsWith(DOC_PREFIX) && !entry.isDirectory()) {\n-                    String content = IOUtils.toString(is, StandardCharsets.UTF_8);\n-                    String name = new Path(entry.getName()).lastSegment();\n-                    if (name.length() >= 6 && name.substring(0, 6).equalsIgnoreCase(\"readme\")) {\n-\n-                        ResourceDocumentationItem docItem = new ResourceDocumentationItem(name, content,\n-                                DefaultDocumentationType.DESCRIPTION.toString(), bi);\n-                        localDocs.put(DefaultDocumentationType.DESCRIPTION.toString(), docItem);\n-                    } else {\n-                        ResourceDocumentationItem docItem = new ResourceDocumentationItem(name, content,\n-                                DefaultDocumentationType.HOW_TO.toString(), bi);\n-                        localDocs.put(DefaultDocumentationType.HOW_TO.toString(), docItem);\n-                    }\n+                if (isReadme == 1) {\n+                    bi.setReadme(content);\n+                } else {\n+                    bi.setParentReadme(content);\n                 }\n             }\n+            if (bi.getReadme() != null && bi.getParentReadme() != null) {\n+                break;\n+            }\n         }\n-        bi.setLiveDoc(localDocs);\n-        bi.setParentLiveDoc(parentDocs);\n     }\n+\n+    /**\n+     * Mimicks extaction of readme file for tests.\n+     *\n+     * @implNote maven is in charge of copying doc files to the target server: this needs to be done here for tests to\n+     *           still take readmes into account in Eclipse for instance.\n+     * @since 11.1\n+     */\n+    public static void extractEmbeddedDoc(File dirFile, BundleInfoImpl bi) throws IOException {\n+        File readme = findFile(dirFile, README);\n+        if (readme != null) {\n+            try (InputStream is = new FileInputStream(readme)) {\n+                bi.setReadme(getReadme(README, is));\n+            }\n+        }\n+        File parentReadme = findFile(new File(dirFile, \"../..\"), README);\n+        if (parentReadme != null) {\n+            try (InputStream is = new FileInputStream(parentReadme)) {\n+                bi.setParentReadme(getReadme(README, is));\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Returns 0 if not a doc, 1 if local doc, 2 if parent doc.\n+     */\n+    protected static int isReadme(String name) {\n+        boolean isDoc = name.startsWith(DOC_PREFIX);\n+        boolean isParentDoc = name.startsWith(PARENT_DOC_PREFIX);\n+        if (isDoc || isParentDoc) {\n+            String filename = new Path(name).lastSegment();\n+            if (filename.length() >= 6 && filename.substring(0, 6).equalsIgnoreCase(\"readme\")) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk2OTQzNQ=="}, "originalCommit": {"oid": "a8db9ff702916b594b0cd42f7bb580a83dd56e40"}, "originalPosition": 143}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4200, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}