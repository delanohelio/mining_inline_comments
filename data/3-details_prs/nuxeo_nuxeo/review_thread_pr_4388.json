{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0MTk3MjQ5", "number": 4388, "reviewThreads": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOToyNDo0MFrOEvOWvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMToyODozNVrOE4HoMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3OTUzNzI1OnYy", "diffSide": "RIGHT", "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/main/java/org/nuxeo/ecm/automation/core/operations/users/SuggestUserEntries.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOToyNDo0MFrOHkFeWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOToyNDo0MFrOHkFeWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYwMDQ3Mg==", "bodyText": "You should start by checking groups != null before computing the descendant groups, to avoid doing so if the user has no group.", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r507600472", "createdAt": "2020-10-19T09:24:40Z", "author": {"login": "ataillefer"}, "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/main/java/org/nuxeo/ecm/automation/core/operations/users/SuggestUserEntries.java", "diffHunk": "@@ -269,8 +275,20 @@ public Blob run() throws IOException {\n                 user = userManager.getUserModel(userId);\n                 UserAdapter userAdapter = user.getAdapter(UserAdapter.class);\n                 List<String> groups = userAdapter.getGroups();\n-                if (groups != null && groups.contains(groupRestriction)) {\n-                    result.add(obj);\n+                List<String> restrictedGroups = new ArrayList<>();\n+                restrictedGroups.add(groupRestriction);\n+                if (allowSubGroupsRestriction) {\n+                    List<String> subGroups = userManager.getDescendantGroups(groupRestriction);\n+                    for (String subGroup : subGroups) {\n+                        restrictedGroups.add(subGroup);\n+                    }\n+                }\n+\n+                if (groups != null) {\n+                    groups.retainAll(restrictedGroups);\n+                    if (!groups.isEmpty()) {\n+                        result.add(obj);\n+                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12e29667947b7d5ef52ffe5b6756b6c5eae04b06"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3OTU0NTk0OnYy", "diffSide": "RIGHT", "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/main/java/org/nuxeo/ecm/automation/core/operations/users/SuggestUserEntries.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOToyNjo0MlrOHkFjhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOToyNjo0MlrOHkFjhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYwMTc5OQ==", "bodyText": "It sounds like we're only suggesting from the subgroups, not including the restricted group itself.\nMaybe something like \"Include the subgroups when passing a groupRestriction.\"", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r507601799", "createdAt": "2020-10-19T09:26:42Z", "author": {"login": "ataillefer"}, "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/main/java/org/nuxeo/ecm/automation/core/operations/users/SuggestUserEntries.java", "diffHunk": "@@ -143,6 +143,12 @@\n     @Param(name = \"lang\", required = false)\n     protected String lang;\n \n+    /*\n+     * @since 11.4\n+     */\n+    @Param(name = \"allowSubGroupsRestriction\", required = false, description = \"Suggest users from the subgroups specified in the group restriction.\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12e29667947b7d5ef52ffe5b6756b6c5eae04b06"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3OTU0NzU2OnYy", "diffSide": "RIGHT", "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/users/TestSuggestUserEntries.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOToyNzowMVrOHkFkYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOToyNzowMVrOHkFkYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYwMjAxNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    DocumentModel Employees = userManager.getBareGroupModel();\n          \n          \n            \n                    DocumentModel employees = userManager.getBareGroupModel();", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r507602017", "createdAt": "2020-10-19T09:27:01Z", "author": {"login": "ataillefer"}, "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/users/TestSuggestUserEntries.java", "diffHunk": "@@ -276,4 +276,75 @@ public void testMixedEntries() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void testSubGroupEntries() throws Exception {\n+\n+        // create top level group 'employees'\n+        DocumentModel Employees = userManager.getBareGroupModel();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12e29667947b7d5ef52ffe5b6756b6c5eae04b06"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3OTU1MTcwOnYy", "diffSide": "RIGHT", "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/users/TestSuggestUserEntries.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOToyNzo1N1rOHkFmnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOToyNzo1N1rOHkFmnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYwMjU5MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    DocumentModel Developpers = userManager.getBareGroupModel();\n          \n          \n            \n                    DocumentModel developpers = userManager.getBareGroupModel();", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r507602591", "createdAt": "2020-10-19T09:27:57Z", "author": {"login": "ataillefer"}, "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/users/TestSuggestUserEntries.java", "diffHunk": "@@ -276,4 +276,75 @@ public void testMixedEntries() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void testSubGroupEntries() throws Exception {\n+\n+        // create top level group 'employees'\n+        DocumentModel Employees = userManager.getBareGroupModel();\n+        Employees.setPropertyValue(\"group:groupname\", \"Employees\");\n+        Employees.setPropertyValue(\"group:subGroups\", (Serializable) Arrays.asList(\"Developpers\"));\n+\n+        userManager.createGroup(Employees);\n+\n+        // create second level group 'developpers'\n+        DocumentModel Developpers = userManager.getBareGroupModel();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12e29667947b7d5ef52ffe5b6756b6c5eae04b06"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3OTU1ODM2OnYy", "diffSide": "RIGHT", "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/users/TestSuggestUserEntries.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOToyOToyN1rOHkFqgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOToyOToyN1rOHkFqgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYwMzU4NA==", "bodyText": "groupname is an internal id, best to use lowercase: employees, same for all the other groups/subgroups below", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r507603584", "createdAt": "2020-10-19T09:29:27Z", "author": {"login": "ataillefer"}, "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/users/TestSuggestUserEntries.java", "diffHunk": "@@ -276,4 +276,75 @@ public void testMixedEntries() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void testSubGroupEntries() throws Exception {\n+\n+        // create top level group 'employees'\n+        DocumentModel Employees = userManager.getBareGroupModel();\n+        Employees.setPropertyValue(\"group:groupname\", \"Employees\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12e29667947b7d5ef52ffe5b6756b6c5eae04b06"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3OTU3MDc4OnYy", "diffSide": "RIGHT", "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/users/TestSuggestUserEntries.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOTozMjoxOFrOHkFyBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOTozMjoxOFrOHkFyBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYwNTUxMA==", "bodyText": "these 2 lines are unneeded, you can reuse the same map", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r507605510", "createdAt": "2020-10-19T09:32:18Z", "author": {"login": "ataillefer"}, "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/users/TestSuggestUserEntries.java", "diffHunk": "@@ -276,4 +276,75 @@ public void testMixedEntries() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void testSubGroupEntries() throws Exception {\n+\n+        // create top level group 'employees'\n+        DocumentModel Employees = userManager.getBareGroupModel();\n+        Employees.setPropertyValue(\"group:groupname\", \"Employees\");\n+        Employees.setPropertyValue(\"group:subGroups\", (Serializable) Arrays.asList(\"Developpers\"));\n+\n+        userManager.createGroup(Employees);\n+\n+        // create second level group 'developpers'\n+        DocumentModel Developpers = userManager.getBareGroupModel();\n+        Developpers.setPropertyValue(\"group:groupname\", \"Developpers\");\n+        Developpers.setPropertyValue(\"group:parentGroups\", (Serializable) Arrays.asList(\"Employees\"));\n+        Developpers.setPropertyValue(\"group:subGroups\", (Serializable) Arrays.asList(\"Support\"));\n+\n+        userManager.createGroup(Developpers);\n+\n+        // create third level group 'support'\n+        DocumentModel Support = userManager.getBareGroupModel();\n+        Support.setPropertyValue(\"group:groupname\", \"Support\");\n+        Support.setPropertyValue(\"group:parentGroups\", (Serializable) Arrays.asList(\"Developpers\"));\n+\n+        userManager.createGroup(Support);\n+\n+        // create 2 users in each group\n+        for (int i = 0; i < 6; i++) {\n+            DocumentModel user = userManager.getBareUserModel();\n+            user.setPropertyValue(\"user:username\", \"user\" + i);\n+            user.setPropertyValue(\"user:firstName\", \"User\" + i);\n+            user.setPropertyValue(\"user:lastName\", \"Smith\");\n+            user.setPropertyValue(\"user:email\", \"user\" + i + \"@example.com\");\n+            if (i % 3 == 0) {\n+                user.setPropertyValue(\"user:groups\", (Serializable) Arrays.asList(\"Employees\"));\n+            } else if (i % 3 == 1) {\n+                user.setPropertyValue(\"user:groups\", (Serializable) Arrays.asList(\"Developpers\"));\n+            } else {\n+                user.setPropertyValue(\"user:groups\", (Serializable) Arrays.asList(\"Support\"));\n+            }\n+            userManager.createUser(user);\n+        }\n+\n+        try (OperationContext ctx = new OperationContext(session)) {\n+            // By searching employees we should have all the users we created before in the three groups and not only\n+            // those in the Employees group directly, so a total of 6 people\n+            Map<String, String> params = new HashMap<>();\n+            params.put(\"allowSubGroupsRestriction\", \"true\");\n+            params.put(\"groupRestriction\", \"Employees\");\n+            Blob result = (Blob) automationService.run(ctx, SuggestUserEntries.ID, params);\n+            assertNotNull(result);\n+            JsonAssert json = JsonAssert.on(result.getString());\n+            assertEquals(6, json.getNode().size());\n+\n+            params = new HashMap<>();\n+            params.put(\"allowSubGroupsRestriction\", \"true\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12e29667947b7d5ef52ffe5b6756b6c5eae04b06"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3OTU3MTU3OnYy", "diffSide": "RIGHT", "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/users/TestSuggestUserEntries.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOTozMjozMlrOHkFykA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOTozMjozMlrOHkFykA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYwNTY0OA==", "bodyText": "same remark as above", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r507605648", "createdAt": "2020-10-19T09:32:32Z", "author": {"login": "ataillefer"}, "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/users/TestSuggestUserEntries.java", "diffHunk": "@@ -276,4 +276,75 @@ public void testMixedEntries() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void testSubGroupEntries() throws Exception {\n+\n+        // create top level group 'employees'\n+        DocumentModel Employees = userManager.getBareGroupModel();\n+        Employees.setPropertyValue(\"group:groupname\", \"Employees\");\n+        Employees.setPropertyValue(\"group:subGroups\", (Serializable) Arrays.asList(\"Developpers\"));\n+\n+        userManager.createGroup(Employees);\n+\n+        // create second level group 'developpers'\n+        DocumentModel Developpers = userManager.getBareGroupModel();\n+        Developpers.setPropertyValue(\"group:groupname\", \"Developpers\");\n+        Developpers.setPropertyValue(\"group:parentGroups\", (Serializable) Arrays.asList(\"Employees\"));\n+        Developpers.setPropertyValue(\"group:subGroups\", (Serializable) Arrays.asList(\"Support\"));\n+\n+        userManager.createGroup(Developpers);\n+\n+        // create third level group 'support'\n+        DocumentModel Support = userManager.getBareGroupModel();\n+        Support.setPropertyValue(\"group:groupname\", \"Support\");\n+        Support.setPropertyValue(\"group:parentGroups\", (Serializable) Arrays.asList(\"Developpers\"));\n+\n+        userManager.createGroup(Support);\n+\n+        // create 2 users in each group\n+        for (int i = 0; i < 6; i++) {\n+            DocumentModel user = userManager.getBareUserModel();\n+            user.setPropertyValue(\"user:username\", \"user\" + i);\n+            user.setPropertyValue(\"user:firstName\", \"User\" + i);\n+            user.setPropertyValue(\"user:lastName\", \"Smith\");\n+            user.setPropertyValue(\"user:email\", \"user\" + i + \"@example.com\");\n+            if (i % 3 == 0) {\n+                user.setPropertyValue(\"user:groups\", (Serializable) Arrays.asList(\"Employees\"));\n+            } else if (i % 3 == 1) {\n+                user.setPropertyValue(\"user:groups\", (Serializable) Arrays.asList(\"Developpers\"));\n+            } else {\n+                user.setPropertyValue(\"user:groups\", (Serializable) Arrays.asList(\"Support\"));\n+            }\n+            userManager.createUser(user);\n+        }\n+\n+        try (OperationContext ctx = new OperationContext(session)) {\n+            // By searching employees we should have all the users we created before in the three groups and not only\n+            // those in the Employees group directly, so a total of 6 people\n+            Map<String, String> params = new HashMap<>();\n+            params.put(\"allowSubGroupsRestriction\", \"true\");\n+            params.put(\"groupRestriction\", \"Employees\");\n+            Blob result = (Blob) automationService.run(ctx, SuggestUserEntries.ID, params);\n+            assertNotNull(result);\n+            JsonAssert json = JsonAssert.on(result.getString());\n+            assertEquals(6, json.getNode().size());\n+\n+            params = new HashMap<>();\n+            params.put(\"allowSubGroupsRestriction\", \"true\");\n+            params.put(\"groupRestriction\", \"Developpers\");\n+            result = (Blob) automationService.run(ctx, SuggestUserEntries.ID, params);\n+            assertNotNull(result);\n+            json = JsonAssert.on(result.getString());\n+            assertEquals(4, json.getNode().size());\n+\n+            params = new HashMap<>();\n+            params.put(\"allowSubGroupsRestriction\", \"true\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12e29667947b7d5ef52ffe5b6756b6c5eae04b06"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3OTU3NTE0OnYy", "diffSide": "RIGHT", "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/users/TestSuggestUserEntries.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOTozMzoyOVrOHkF00g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOTozMzoyOVrOHkF00g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYwNjIyNg==", "bodyText": "Can you please add a test with params.put(\"allowSubGroupsRestriction\", \"false\"); showing the expected result: 2.", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r507606226", "createdAt": "2020-10-19T09:33:29Z", "author": {"login": "ataillefer"}, "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/users/TestSuggestUserEntries.java", "diffHunk": "@@ -276,4 +276,75 @@ public void testMixedEntries() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void testSubGroupEntries() throws Exception {\n+\n+        // create top level group 'employees'\n+        DocumentModel Employees = userManager.getBareGroupModel();\n+        Employees.setPropertyValue(\"group:groupname\", \"Employees\");\n+        Employees.setPropertyValue(\"group:subGroups\", (Serializable) Arrays.asList(\"Developpers\"));\n+\n+        userManager.createGroup(Employees);\n+\n+        // create second level group 'developpers'\n+        DocumentModel Developpers = userManager.getBareGroupModel();\n+        Developpers.setPropertyValue(\"group:groupname\", \"Developpers\");\n+        Developpers.setPropertyValue(\"group:parentGroups\", (Serializable) Arrays.asList(\"Employees\"));\n+        Developpers.setPropertyValue(\"group:subGroups\", (Serializable) Arrays.asList(\"Support\"));\n+\n+        userManager.createGroup(Developpers);\n+\n+        // create third level group 'support'\n+        DocumentModel Support = userManager.getBareGroupModel();\n+        Support.setPropertyValue(\"group:groupname\", \"Support\");\n+        Support.setPropertyValue(\"group:parentGroups\", (Serializable) Arrays.asList(\"Developpers\"));\n+\n+        userManager.createGroup(Support);\n+\n+        // create 2 users in each group\n+        for (int i = 0; i < 6; i++) {\n+            DocumentModel user = userManager.getBareUserModel();\n+            user.setPropertyValue(\"user:username\", \"user\" + i);\n+            user.setPropertyValue(\"user:firstName\", \"User\" + i);\n+            user.setPropertyValue(\"user:lastName\", \"Smith\");\n+            user.setPropertyValue(\"user:email\", \"user\" + i + \"@example.com\");\n+            if (i % 3 == 0) {\n+                user.setPropertyValue(\"user:groups\", (Serializable) Arrays.asList(\"Employees\"));\n+            } else if (i % 3 == 1) {\n+                user.setPropertyValue(\"user:groups\", (Serializable) Arrays.asList(\"Developpers\"));\n+            } else {\n+                user.setPropertyValue(\"user:groups\", (Serializable) Arrays.asList(\"Support\"));\n+            }\n+            userManager.createUser(user);\n+        }\n+\n+        try (OperationContext ctx = new OperationContext(session)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12e29667947b7d5ef52ffe5b6756b6c5eae04b06"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3OTYzNDg1OnYy", "diffSide": "RIGHT", "path": "nuxeo-services/nuxeo-platform-usermanager-core/src/main/java/org/nuxeo/ecm/platform/usermanager/UserManagerImpl.java", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOTo0ODoxM1rOHkGZeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMToxMDo0M1rOHsACcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYxNTYwOA==", "bodyText": "I can see 2 problems here, take the following group hierarchy (OK it's twisted, but can happen):\n     A\n     |--- B\n     |    |--- A\n     |    |--- C   \n     |--- C\n     |    |--- D\n\nIt seems that with the suggested algorithm, the resulting list will:\n\nInclude A (the parent group, also sub-sub-group), but this is probably not an issue.\nNot include D, C being skipped since already present as a subgroup of B probably an issue.", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r507615608", "createdAt": "2020-10-19T09:48:13Z", "author": {"login": "ataillefer"}, "path": "nuxeo-services/nuxeo-platform-usermanager-core/src/main/java/org/nuxeo/ecm/platform/usermanager/UserManagerImpl.java", "diffHunk": "@@ -1604,6 +1604,24 @@ public GroupConfig getGroupConfig() {\n         return groupConfig;\n     }\n \n+    @Override\n+    public List<String> getDescendantGroups(String groupId){\n+        List<String> descendantGroups = new ArrayList<>();\n+        populateDescendantGroups(groupId, descendantGroups);\n+        return descendantGroups;\n+    }\n+\n+    protected void populateDescendantGroups(String groupId, List<String> descendantGroups) {\n+        NuxeoGroup group = getGroup(groupId);\n+        if (group != null) {\n+            List<String> subGroups = group.getMemberGroups();\n+            subGroups.stream().filter(subGroup -> !descendantGroups.contains(subGroup)).forEach(subGroup -> {\n+                descendantGroups.add(subGroup);\n+                populateDescendantGroups(subGroup, descendantGroups);\n+            });\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12e29667947b7d5ef52ffe5b6756b6c5eae04b06"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzcxMjAzMA==", "bodyText": "One solution could be to remove the duplicate filtering clause and use a HashSet (no duplicates) for the descendant groups.", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r507712030", "createdAt": "2020-10-19T12:38:43Z", "author": {"login": "ataillefer"}, "path": "nuxeo-services/nuxeo-platform-usermanager-core/src/main/java/org/nuxeo/ecm/platform/usermanager/UserManagerImpl.java", "diffHunk": "@@ -1604,6 +1604,24 @@ public GroupConfig getGroupConfig() {\n         return groupConfig;\n     }\n \n+    @Override\n+    public List<String> getDescendantGroups(String groupId){\n+        List<String> descendantGroups = new ArrayList<>();\n+        populateDescendantGroups(groupId, descendantGroups);\n+        return descendantGroups;\n+    }\n+\n+    protected void populateDescendantGroups(String groupId, List<String> descendantGroups) {\n+        NuxeoGroup group = getGroup(groupId);\n+        if (group != null) {\n+            List<String> subGroups = group.getMemberGroups();\n+            subGroups.stream().filter(subGroup -> !descendantGroups.contains(subGroup)).forEach(subGroup -> {\n+                descendantGroups.add(subGroup);\n+                populateDescendantGroups(subGroup, descendantGroups);\n+            });\n+        }\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYxNTYwOA=="}, "originalCommit": {"oid": "12e29667947b7d5ef52ffe5b6756b6c5eae04b06"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc0NTQ4Ng==", "bodyText": "Yes maybe consider an algorithm based on (untested, modulo details):\n    Set<String> descendantGroups = new HashSet<>();\n    Deque<String> todo = new LinkedList<>();\n    todo.add(groupId);\n    while (!todo.isEmpty()) {\n        String id = todo.pop();\n        if (descendantGroups.add(id)) {\n            // recurse\n            NuxeoGroup group = getGroup(id);\n            if (group != null) {\n                todo.addAll(group.getMemberGroups());\n            }\n        }\n    }", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r507745486", "createdAt": "2020-10-19T13:28:12Z", "author": {"login": "efge"}, "path": "nuxeo-services/nuxeo-platform-usermanager-core/src/main/java/org/nuxeo/ecm/platform/usermanager/UserManagerImpl.java", "diffHunk": "@@ -1604,6 +1604,24 @@ public GroupConfig getGroupConfig() {\n         return groupConfig;\n     }\n \n+    @Override\n+    public List<String> getDescendantGroups(String groupId){\n+        List<String> descendantGroups = new ArrayList<>();\n+        populateDescendantGroups(groupId, descendantGroups);\n+        return descendantGroups;\n+    }\n+\n+    protected void populateDescendantGroups(String groupId, List<String> descendantGroups) {\n+        NuxeoGroup group = getGroup(groupId);\n+        if (group != null) {\n+            List<String> subGroups = group.getMemberGroups();\n+            subGroups.stream().filter(subGroup -> !descendantGroups.contains(subGroup)).forEach(subGroup -> {\n+                descendantGroups.add(subGroup);\n+                populateDescendantGroups(subGroup, descendantGroups);\n+            });\n+        }\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYxNTYwOA=="}, "originalCommit": {"oid": "12e29667947b7d5ef52ffe5b6756b6c5eae04b06"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjc3NDEyMQ==", "bodyText": "It seems to me that the actual algorithm works with this configuration...", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r512774121", "createdAt": "2020-10-27T15:08:31Z", "author": {"login": "charlesboidot"}, "path": "nuxeo-services/nuxeo-platform-usermanager-core/src/main/java/org/nuxeo/ecm/platform/usermanager/UserManagerImpl.java", "diffHunk": "@@ -1604,6 +1604,24 @@ public GroupConfig getGroupConfig() {\n         return groupConfig;\n     }\n \n+    @Override\n+    public List<String> getDescendantGroups(String groupId){\n+        List<String> descendantGroups = new ArrayList<>();\n+        populateDescendantGroups(groupId, descendantGroups);\n+        return descendantGroups;\n+    }\n+\n+    protected void populateDescendantGroups(String groupId, List<String> descendantGroups) {\n+        NuxeoGroup group = getGroup(groupId);\n+        if (group != null) {\n+            List<String> subGroups = group.getMemberGroups();\n+            subGroups.stream().filter(subGroup -> !descendantGroups.contains(subGroup)).forEach(subGroup -> {\n+                descendantGroups.add(subGroup);\n+                populateDescendantGroups(subGroup, descendantGroups);\n+            });\n+        }\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYxNTYwOA=="}, "originalCommit": {"oid": "12e29667947b7d5ef52ffe5b6756b6c5eae04b06"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzMyODEwNA==", "bodyText": "OK, then, can you please add a case in the test to show that we don't have the following problem:\n\nNot include D, C being skipped since already present as a subgroup of B probably an issue.", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r513328104", "createdAt": "2020-10-28T10:18:44Z", "author": {"login": "ataillefer"}, "path": "nuxeo-services/nuxeo-platform-usermanager-core/src/main/java/org/nuxeo/ecm/platform/usermanager/UserManagerImpl.java", "diffHunk": "@@ -1604,6 +1604,24 @@ public GroupConfig getGroupConfig() {\n         return groupConfig;\n     }\n \n+    @Override\n+    public List<String> getDescendantGroups(String groupId){\n+        List<String> descendantGroups = new ArrayList<>();\n+        populateDescendantGroups(groupId, descendantGroups);\n+        return descendantGroups;\n+    }\n+\n+    protected void populateDescendantGroups(String groupId, List<String> descendantGroups) {\n+        NuxeoGroup group = getGroup(groupId);\n+        if (group != null) {\n+            List<String> subGroups = group.getMemberGroups();\n+            subGroups.stream().filter(subGroup -> !descendantGroups.contains(subGroup)).forEach(subGroup -> {\n+                descendantGroups.add(subGroup);\n+                populateDescendantGroups(subGroup, descendantGroups);\n+            });\n+        }\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYxNTYwOA=="}, "originalCommit": {"oid": "12e29667947b7d5ef52ffe5b6756b6c5eae04b06"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTkwMDAxOA==", "bodyText": "Thanks, indeed it's working since when the first occurrence of C is added, its descendant groups are computed, thus D \ud83d\udc4d", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r515900018", "createdAt": "2020-11-02T11:10:43Z", "author": {"login": "ataillefer"}, "path": "nuxeo-services/nuxeo-platform-usermanager-core/src/main/java/org/nuxeo/ecm/platform/usermanager/UserManagerImpl.java", "diffHunk": "@@ -1604,6 +1604,24 @@ public GroupConfig getGroupConfig() {\n         return groupConfig;\n     }\n \n+    @Override\n+    public List<String> getDescendantGroups(String groupId){\n+        List<String> descendantGroups = new ArrayList<>();\n+        populateDescendantGroups(groupId, descendantGroups);\n+        return descendantGroups;\n+    }\n+\n+    protected void populateDescendantGroups(String groupId, List<String> descendantGroups) {\n+        NuxeoGroup group = getGroup(groupId);\n+        if (group != null) {\n+            List<String> subGroups = group.getMemberGroups();\n+            subGroups.stream().filter(subGroup -> !descendantGroups.contains(subGroup)).forEach(subGroup -> {\n+                descendantGroups.add(subGroup);\n+                populateDescendantGroups(subGroup, descendantGroups);\n+            });\n+        }\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYxNTYwOA=="}, "originalCommit": {"oid": "12e29667947b7d5ef52ffe5b6756b6c5eae04b06"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4MDQyNjI0OnYy", "diffSide": "RIGHT", "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/main/java/org/nuxeo/ecm/automation/core/operations/users/SuggestUserEntries.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxMzoxODo0NVrOHkN3Mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxMzoxODo0NVrOHkN3Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzczNzkwNw==", "bodyText": "Don't forget to document this new configuration option in the NXP ticket", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r507737907", "createdAt": "2020-10-19T13:18:45Z", "author": {"login": "efge"}, "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/main/java/org/nuxeo/ecm/automation/core/operations/users/SuggestUserEntries.java", "diffHunk": "@@ -143,6 +143,12 @@\n     @Param(name = \"lang\", required = false)\n     protected String lang;\n \n+    /*\n+     * @since 11.4\n+     */\n+    @Param(name = \"allowSubGroupsRestriction\", required = false, description = \"Suggest users from the subgroups specified in the group restriction.\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12e29667947b7d5ef52ffe5b6756b6c5eae04b06"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIzMzExNDE1OnYy", "diffSide": "RIGHT", "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/main/java/org/nuxeo/ecm/automation/core/operations/users/SuggestUserEntries.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMToxMjowOFrOHsAFaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMToxMjowOFrOHsAFaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTkwMDc3OQ==", "bodyText": "I think we can also test if goups is not empty before computing the descendant groups, to avoid computing them uselessly for a user that isn't in any group.", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r515900779", "createdAt": "2020-11-02T11:12:08Z", "author": {"login": "ataillefer"}, "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/main/java/org/nuxeo/ecm/automation/core/operations/users/SuggestUserEntries.java", "diffHunk": "@@ -269,8 +275,20 @@ public Blob run() throws IOException {\n                 user = userManager.getUserModel(userId);\n                 UserAdapter userAdapter = user.getAdapter(UserAdapter.class);\n                 List<String> groups = userAdapter.getGroups();\n-                if (groups != null && groups.contains(groupRestriction)) {\n-                    result.add(obj);\n+                List<String> restrictedGroups = new ArrayList<>();\n+                restrictedGroups.add(groupRestriction);\n+\n+                if (groups != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd2fe96fd112fb21daab3388fbc04d76be812738"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MjM3MDIzOnYy", "diffSide": "RIGHT", "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/main/java/org/nuxeo/ecm/automation/core/operations/users/SuggestUserEntries.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwOTo0MDoyNlrOHxyZfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwOTo0MDoyNlrOHxyZfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk2Nzk5OA==", "bodyText": "The description text is not clear. I suggest \"Whether to take into account subgroups when evaluating groupRestriction\" \u2014\u00a0if I understand correctly.", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r521967998", "createdAt": "2020-11-12T09:40:26Z", "author": {"login": "efge"}, "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/main/java/org/nuxeo/ecm/automation/core/operations/users/SuggestUserEntries.java", "diffHunk": "@@ -143,6 +144,12 @@\n     @Param(name = \"lang\", required = false)\n     protected String lang;\n \n+    /*\n+     * @since 11.4\n+     */\n+    @Param(name = \"allowSubGroupsRestriction\", required = false, description = \"Include the subgroups when passing a groupRestriction.\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abbff664f011cf61e758bce3eea66c493c892aa9"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MjM3ODc0OnYy", "diffSide": "RIGHT", "path": "nuxeo-services/nuxeo-platform-usermanager-api/src/main/java/org/nuxeo/ecm/platform/usermanager/UserManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwOTo0MjoyMlrOHxyegQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwOTo0MjoyMlrOHxyegQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk2OTI4MQ==", "bodyText": "Please put this method just below getAncestorGroups.", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r521969281", "createdAt": "2020-11-12T09:42:22Z", "author": {"login": "efge"}, "path": "nuxeo-services/nuxeo-platform-usermanager-api/src/main/java/org/nuxeo/ecm/platform/usermanager/UserManager.java", "diffHunk": "@@ -463,4 +463,12 @@ default void notifyGroupChanged(String groupName, String eventId) {\n      * @since 9.2\n      */\n     void notifyGroupChanged(String groupName, String eventId, List<String> ancestorGroupNames);\n+\n+    /**\n+     * Returns the descendant groups of the group with the given id.\n+     *\n+     * @since 11.4\n+     */\n+    List<String> getDescendantGroups(String groupId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abbff664f011cf61e758bce3eea66c493c892aa9"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MjM3OTM1OnYy", "diffSide": "RIGHT", "path": "nuxeo-services/nuxeo-platform-usermanager-core/src/main/java/org/nuxeo/ecm/platform/usermanager/FakeUserManagerImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwOTo0MjozNFrOHxye6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwOTo0MjozNFrOHxye6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk2OTM4Ng==", "bodyText": "Please put this method just below getAncestorGroups.", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r521969386", "createdAt": "2020-11-12T09:42:34Z", "author": {"login": "efge"}, "path": "nuxeo-services/nuxeo-platform-usermanager-core/src/main/java/org/nuxeo/ecm/platform/usermanager/FakeUserManagerImpl.java", "diffHunk": "@@ -498,4 +498,9 @@ public void notifyGroupChanged(String groupName, String eventId, List<String> an\n         throw new UnsupportedOperationException();\n     }\n \n+    @Override\n+    public List<String> getDescendantGroups(String groupId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abbff664f011cf61e758bce3eea66c493c892aa9"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MjM4NDc0OnYy", "diffSide": "RIGHT", "path": "nuxeo-services/nuxeo-platform-usermanager-core/src/main/java/org/nuxeo/ecm/platform/usermanager/UserManagerImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwOTo0Mzo1M1rOHxyiQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwOTo0Mzo1M1rOHxyiQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk3MDI0Mg==", "bodyText": "Please put these two methods just below getAncestorGroups (actually below populateAncestorGroups)", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r521970242", "createdAt": "2020-11-12T09:43:53Z", "author": {"login": "efge"}, "path": "nuxeo-services/nuxeo-platform-usermanager-core/src/main/java/org/nuxeo/ecm/platform/usermanager/UserManagerImpl.java", "diffHunk": "@@ -1604,6 +1604,24 @@ public GroupConfig getGroupConfig() {\n         return groupConfig;\n     }\n \n+    @Override\n+    public List<String> getDescendantGroups(String groupId){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abbff664f011cf61e758bce3eea66c493c892aa9"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MjQwOTQ3OnYy", "diffSide": "RIGHT", "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/main/java/org/nuxeo/ecm/automation/core/operations/users/SuggestUserEntries.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwOTo0OTozN1rOHxyxQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwOTo0OTozN1rOHxyxQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk3NDA4MA==", "bodyText": "Remove empty line", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r521974080", "createdAt": "2020-11-12T09:49:37Z", "author": {"login": "efge"}, "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/main/java/org/nuxeo/ecm/automation/core/operations/users/SuggestUserEntries.java", "diffHunk": "@@ -269,8 +276,20 @@ public Blob run() throws IOException {\n                 user = userManager.getUserModel(userId);\n                 UserAdapter userAdapter = user.getAdapter(UserAdapter.class);\n                 List<String> groups = userAdapter.getGroups();\n-                if (groups != null && groups.contains(groupRestriction)) {\n-                    result.add(obj);\n+                List<String> restrictedGroups = new ArrayList<>();\n+                restrictedGroups.add(groupRestriction);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abbff664f011cf61e758bce3eea66c493c892aa9"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MjQxNjIxOnYy", "diffSide": "RIGHT", "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/main/java/org/nuxeo/ecm/automation/core/operations/users/SuggestUserEntries.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwOTo1MTowOVrOHxy1Vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwOTo1MTowOVrOHxy1Vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk3NTEyNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    List<String> subGroups = userManager.getDescendantGroups(groupRestriction);\n          \n          \n            \n                                    for (String subGroup : subGroups) {\n          \n          \n            \n                                        restrictedGroups.add(subGroup);\n          \n          \n            \n                                    }\n          \n          \n            \n                                    restrictedGroups.addAll(userManager.getDescendantGroups(groupRestriction));", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r521975127", "createdAt": "2020-11-12T09:51:09Z", "author": {"login": "efge"}, "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/main/java/org/nuxeo/ecm/automation/core/operations/users/SuggestUserEntries.java", "diffHunk": "@@ -269,8 +276,20 @@ public Blob run() throws IOException {\n                 user = userManager.getUserModel(userId);\n                 UserAdapter userAdapter = user.getAdapter(UserAdapter.class);\n                 List<String> groups = userAdapter.getGroups();\n-                if (groups != null && groups.contains(groupRestriction)) {\n-                    result.add(obj);\n+                List<String> restrictedGroups = new ArrayList<>();\n+                restrictedGroups.add(groupRestriction);\n+\n+                if (CollectionUtils.isNotEmpty(groups)) {\n+                    if (allowSubGroupsRestriction) {\n+                        List<String> subGroups = userManager.getDescendantGroups(groupRestriction);\n+                        for (String subGroup : subGroups) {\n+                            restrictedGroups.add(subGroup);\n+                        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abbff664f011cf61e758bce3eea66c493c892aa9"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MjQ2MzQ4OnYy", "diffSide": "RIGHT", "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/main/java/org/nuxeo/ecm/automation/core/operations/users/SuggestUserEntries.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMDowMjowMVrOHxzSFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMDowMjowMVrOHxzSFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk4MjQ4Ng==", "bodyText": "I'd rather not modify groups as it comes from the adapter and I'm not sure we have enough defensive copies (and actually there's nothing that guarantees that's it's a modifiable list).\nAs the check we want is that the intersection is not empty, I think this works just as well:\nrestrictedGroups.retainAll(groups);\nif (!restrictedGroups.isEmpty()) {\n\nBut of course run the unit tests to make sure.", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r521982486", "createdAt": "2020-11-12T10:02:01Z", "author": {"login": "efge"}, "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/main/java/org/nuxeo/ecm/automation/core/operations/users/SuggestUserEntries.java", "diffHunk": "@@ -269,8 +276,20 @@ public Blob run() throws IOException {\n                 user = userManager.getUserModel(userId);\n                 UserAdapter userAdapter = user.getAdapter(UserAdapter.class);\n                 List<String> groups = userAdapter.getGroups();\n-                if (groups != null && groups.contains(groupRestriction)) {\n-                    result.add(obj);\n+                List<String> restrictedGroups = new ArrayList<>();\n+                restrictedGroups.add(groupRestriction);\n+\n+                if (CollectionUtils.isNotEmpty(groups)) {\n+                    if (allowSubGroupsRestriction) {\n+                        List<String> subGroups = userManager.getDescendantGroups(groupRestriction);\n+                        for (String subGroup : subGroups) {\n+                            restrictedGroups.add(subGroup);\n+                        }\n+                    }\n+                    groups.retainAll(restrictedGroups);\n+                    if (!groups.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abbff664f011cf61e758bce3eea66c493c892aa9"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MjQ3NjM5OnYy", "diffSide": "RIGHT", "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/main/java/org/nuxeo/ecm/automation/core/operations/users/SuggestUserEntries.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMDowNDo1NFrOHxzZ5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMDowNDo1NFrOHxzZ5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk4NDQ4Ng==", "bodyText": "These two lines can be moved further down inside the if", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r521984486", "createdAt": "2020-11-12T10:04:54Z", "author": {"login": "efge"}, "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/main/java/org/nuxeo/ecm/automation/core/operations/users/SuggestUserEntries.java", "diffHunk": "@@ -269,8 +276,20 @@ public Blob run() throws IOException {\n                 user = userManager.getUserModel(userId);\n                 UserAdapter userAdapter = user.getAdapter(UserAdapter.class);\n                 List<String> groups = userAdapter.getGroups();\n-                if (groups != null && groups.contains(groupRestriction)) {\n-                    result.add(obj);\n+                List<String> restrictedGroups = new ArrayList<>();\n+                restrictedGroups.add(groupRestriction);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abbff664f011cf61e758bce3eea66c493c892aa9"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MjQ4NDM5OnYy", "diffSide": "RIGHT", "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/users/TestSuggestUserEntries.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMDowNzowMFrOHxze6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMDowNzowMFrOHxze6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk4NTc2OA==", "bodyText": "One one empty line only (enforced by formatter).", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r521985768", "createdAt": "2020-11-12T10:07:00Z", "author": {"login": "efge"}, "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/users/TestSuggestUserEntries.java", "diffHunk": "@@ -276,4 +276,103 @@ public void testMixedEntries() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void testSubGroupEntries() throws Exception {\n+\n+        //A\n+        //|--- B\n+        //|    |--- A\n+        //|    |--- C\n+        //|--- C\n+        //|    |--- D\n+\n+        // create group 'A'\n+        DocumentModel A = userManager.getBareGroupModel();\n+        A.setPropertyValue(\"group:groupname\", \"A\");\n+        A.setPropertyValue(\"group:subGroups\", (Serializable) Arrays.asList(\"B\", \"C\"));\n+\n+        userManager.createGroup(A);\n+\n+        // create group 'B'\n+        DocumentModel B = userManager.getBareGroupModel();\n+        B.setPropertyValue(\"group:groupname\", \"B\");\n+        B.setPropertyValue(\"group:parentGroups\", (Serializable) Arrays.asList(\"A\"));\n+        B.setPropertyValue(\"group:subGroups\", (Serializable) Arrays.asList(\"C\", \"A\"));\n+\n+        userManager.createGroup(B);\n+\n+        // create group 'C'\n+        DocumentModel C = userManager.getBareGroupModel();\n+        C.setPropertyValue(\"group:groupname\", \"C\");\n+        C.setPropertyValue(\"group:parentGroups\", (Serializable) Arrays.asList(\"B\", \"A\"));\n+        C.setPropertyValue(\"group:subGroups\", (Serializable) Arrays.asList(\"D\"));\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abbff664f011cf61e758bce3eea66c493c892aa9"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MjQ4ODMwOnYy", "diffSide": "RIGHT", "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/users/TestSuggestUserEntries.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMDowNzo1NFrOHxzhOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMDowNzo1NFrOHxzhOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk4NjM2Mw==", "bodyText": "Don't use local variables starting with an uppercase -> a", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r521986363", "createdAt": "2020-11-12T10:07:54Z", "author": {"login": "efge"}, "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/users/TestSuggestUserEntries.java", "diffHunk": "@@ -276,4 +276,103 @@ public void testMixedEntries() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void testSubGroupEntries() throws Exception {\n+\n+        //A\n+        //|--- B\n+        //|    |--- A\n+        //|    |--- C\n+        //|--- C\n+        //|    |--- D\n+\n+        // create group 'A'\n+        DocumentModel A = userManager.getBareGroupModel();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abbff664f011cf61e758bce3eea66c493c892aa9"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MjQ5ODg4OnYy", "diffSide": "RIGHT", "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/users/TestSuggestUserEntries.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMDoxMDoyOFrOHxznrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMDoxMDoyOFrOHxznrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk4ODAxMg==", "bodyText": "Empty line not needed before } in a method.\nOn the other hand we like to have an empty line before the final } of the class...\n\ud83d\ude2c", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r521988012", "createdAt": "2020-11-12T10:10:28Z", "author": {"login": "efge"}, "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/users/TestSuggestUserEntries.java", "diffHunk": "@@ -276,4 +276,103 @@ public void testMixedEntries() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void testSubGroupEntries() throws Exception {\n+\n+        //A\n+        //|--- B\n+        //|    |--- A\n+        //|    |--- C\n+        //|--- C\n+        //|    |--- D\n+\n+        // create group 'A'\n+        DocumentModel A = userManager.getBareGroupModel();\n+        A.setPropertyValue(\"group:groupname\", \"A\");\n+        A.setPropertyValue(\"group:subGroups\", (Serializable) Arrays.asList(\"B\", \"C\"));\n+\n+        userManager.createGroup(A);\n+\n+        // create group 'B'\n+        DocumentModel B = userManager.getBareGroupModel();\n+        B.setPropertyValue(\"group:groupname\", \"B\");\n+        B.setPropertyValue(\"group:parentGroups\", (Serializable) Arrays.asList(\"A\"));\n+        B.setPropertyValue(\"group:subGroups\", (Serializable) Arrays.asList(\"C\", \"A\"));\n+\n+        userManager.createGroup(B);\n+\n+        // create group 'C'\n+        DocumentModel C = userManager.getBareGroupModel();\n+        C.setPropertyValue(\"group:groupname\", \"C\");\n+        C.setPropertyValue(\"group:parentGroups\", (Serializable) Arrays.asList(\"B\", \"A\"));\n+        C.setPropertyValue(\"group:subGroups\", (Serializable) Arrays.asList(\"D\"));\n+\n+\n+        userManager.createGroup(C);\n+\n+         // create group 'D'\n+         DocumentModel D = userManager.getBareGroupModel();\n+         D.setPropertyValue(\"group:groupname\", \"D\");\n+         D.setPropertyValue(\"group:parentGroups\", (Serializable) Arrays.asList(\"C\"));\n+\n+        userManager.createGroup(D);\n+\n+        // create 2 users in each group\n+        for (int i = 0; i < 8; i++) {\n+            DocumentModel user = userManager.getBareUserModel();\n+            user.setPropertyValue(\"user:username\", \"user\" + i);\n+            user.setPropertyValue(\"user:firstName\", \"User\" + i);\n+            user.setPropertyValue(\"user:lastName\", \"Smith\");\n+            user.setPropertyValue(\"user:email\", \"user\" + i + \"@example.com\");\n+            if (i % 4 == 0) {\n+                user.setPropertyValue(\"user:groups\", (Serializable) Arrays.asList(\"A\"));\n+            } else if (i % 4 == 1) {\n+                user.setPropertyValue(\"user:groups\", (Serializable) Arrays.asList(\"B\"));\n+            } else if (i % 4 == 2) {\n+                user.setPropertyValue(\"user:groups\", (Serializable) Arrays.asList(\"C\"));\n+            } else {\n+                user.setPropertyValue(\"user:groups\", (Serializable) Arrays.asList(\"D\"));\n+            }\n+            userManager.createUser(user);\n+        }\n+\n+        try (OperationContext ctx = new OperationContext(session)) {\n+            // By searching A we should have all the users we created before in the three groups and not only\n+            // those in the A group directly, so a total of 8 people\n+            Map<String, String> params = new HashMap<>();\n+            params.put(\"allowSubGroupsRestriction\", \"true\");\n+            params.put(\"groupRestriction\", \"A\");\n+            Blob result = (Blob) automationService.run(ctx, SuggestUserEntries.ID, params);\n+            assertNotNull(result);\n+            JsonAssert json = JsonAssert.on(result.getString());\n+            assertEquals(8, json.getNode().size());\n+\n+            params.put(\"groupRestriction\", \"B\");\n+            result = (Blob) automationService.run(ctx, SuggestUserEntries.ID, params);\n+            assertNotNull(result);\n+            json = JsonAssert.on(result.getString());\n+            assertEquals(8, json.getNode().size());\n+\n+            params.put(\"groupRestriction\", \"C\");\n+            result = (Blob) automationService.run(ctx, SuggestUserEntries.ID, params);\n+            assertNotNull(result);\n+            json = JsonAssert.on(result.getString());\n+            assertEquals(4, json.getNode().size());\n+\n+            params.put(\"groupRestriction\", \"D\");\n+            result = (Blob) automationService.run(ctx, SuggestUserEntries.ID, params);\n+            assertNotNull(result);\n+            json = JsonAssert.on(result.getString());\n+            assertEquals(2, json.getNode().size());\n+\n+            // By searching A we should have only 2 people if we don't filter on the subgroups\n+            params.put(\"allowSubGroupsRestriction\", \"false\");\n+            params.put(\"groupRestriction\", \"A\");\n+            result = (Blob) automationService.run(ctx, SuggestUserEntries.ID, params);\n+            assertNotNull(result);\n+            json = JsonAssert.on(result.getString());\n+            assertEquals(2, json.getNode().size());\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abbff664f011cf61e758bce3eea66c493c892aa9"}, "originalPosition": 100}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MjgwNjkxOnYy", "diffSide": "RIGHT", "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/users/TestSuggestUserEntries.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMToyODozNVrOHx2jaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMTozMjoxM1rOHx2row==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjAzNjA3Mg==", "bodyText": "why remove the schema showing the group hierarchy?", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r522036072", "createdAt": "2020-11-12T11:28:35Z", "author": {"login": "ataillefer"}, "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/users/TestSuggestUserEntries.java", "diffHunk": "@@ -276,4 +276,95 @@ public void testMixedEntries() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void testSubGroupEntries() throws Exception {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d808c457c5fe004d20ef7f9e57c1a26e38f9007c"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjAzNjcwNw==", "bodyText": "I thought it wasn't necessary to understand the test", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r522036707", "createdAt": "2020-11-12T11:29:41Z", "author": {"login": "charlesboidot"}, "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/users/TestSuggestUserEntries.java", "diffHunk": "@@ -276,4 +276,95 @@ public void testMixedEntries() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void testSubGroupEntries() throws Exception {\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjAzNjA3Mg=="}, "originalCommit": {"oid": "d808c457c5fe004d20ef7f9e57c1a26e38f9007c"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjAzODE3OQ==", "bodyText": "OK, not necessary, but nice to have a quick view.\nAs you wish!", "url": "https://github.com/nuxeo/nuxeo/pull/4388#discussion_r522038179", "createdAt": "2020-11-12T11:32:13Z", "author": {"login": "ataillefer"}, "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/users/TestSuggestUserEntries.java", "diffHunk": "@@ -276,4 +276,95 @@ public void testMixedEntries() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void testSubGroupEntries() throws Exception {\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjAzNjA3Mg=="}, "originalCommit": {"oid": "d808c457c5fe004d20ef7f9e57c1a26e38f9007c"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4362, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}