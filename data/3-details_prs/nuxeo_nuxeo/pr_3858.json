{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzMDY5NDc0", "number": 3858, "title": "NXP-28799: remove CoreSession and DocumentModel session id", "bodyText": "Note that several of these commits should be reviewed with the Hide whitespace changes option turned on as there are many indent changes.", "createdAt": "2020-03-24T15:39:45Z", "url": "https://github.com/nuxeo/nuxeo/pull/3858", "merged": true, "mergeCommit": {"oid": "11ef1715adaf9e93b0cdca163be1f1a017dc5199"}, "closed": true, "closedAt": "2020-04-03T15:53:05Z", "author": {"login": "efge"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQ2Mr4ABqjMxNjA3MzA1Njc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcUCNGOgFqTM4NzMzNDQyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "137436268121c81cbd3fd7eabc0fb7b321ffa5ce", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/137436268121c81cbd3fd7eabc0fb7b321ffa5ce", "committedDate": "2020-03-24T15:37:21Z", "message": "NXP-28799: don't use deprecated constructors"}, "afterCommit": {"oid": "324344957992b61bd6dbe39fd29a88097d063254", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/324344957992b61bd6dbe39fd29a88097d063254", "committedDate": "2020-03-24T17:16:39Z", "message": "NXP-28799: remove CoreSession and DocumentModel session id (sid) WIP to squash"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "324344957992b61bd6dbe39fd29a88097d063254", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/324344957992b61bd6dbe39fd29a88097d063254", "committedDate": "2020-03-24T17:16:39Z", "message": "NXP-28799: remove CoreSession and DocumentModel session id (sid) WIP to squash"}, "afterCommit": {"oid": "b3ddfe9dfa980d2bd4bfcf340b50ea388e5e6d6b", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/b3ddfe9dfa980d2bd4bfcf340b50ea388e5e6d6b", "committedDate": "2020-03-25T02:52:39Z", "message": "remove CloseableCoreSession from tests (WIP)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b3ddfe9dfa980d2bd4bfcf340b50ea388e5e6d6b", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/b3ddfe9dfa980d2bd4bfcf340b50ea388e5e6d6b", "committedDate": "2020-03-25T02:52:39Z", "message": "remove CloseableCoreSession from tests (WIP)"}, "afterCommit": {"oid": "18b084c8e0ace39bd73ce55ed7ef9ef94d109463", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/18b084c8e0ace39bd73ce55ed7ef9ef94d109463", "committedDate": "2020-03-25T22:54:50Z", "message": "NXP-28799: remove CloseableCoreSession from tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "18b084c8e0ace39bd73ce55ed7ef9ef94d109463", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/18b084c8e0ace39bd73ce55ed7ef9ef94d109463", "committedDate": "2020-03-25T22:54:50Z", "message": "NXP-28799: remove CloseableCoreSession from tests"}, "afterCommit": {"oid": "3e5d92336d2f544e0dc6732a65f73513c9fd21b4", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/3e5d92336d2f544e0dc6732a65f73513c9fd21b4", "committedDate": "2020-03-26T01:15:56Z", "message": "NXP-28799: remove CloseableCoreSession from tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3e5d92336d2f544e0dc6732a65f73513c9fd21b4", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/3e5d92336d2f544e0dc6732a65f73513c9fd21b4", "committedDate": "2020-03-26T01:15:56Z", "message": "NXP-28799: remove CloseableCoreSession from tests"}, "afterCommit": {"oid": "d09261f66b008135217baa4465381b173a928b48", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/d09261f66b008135217baa4465381b173a928b48", "committedDate": "2020-03-26T15:23:15Z", "message": "NXP-28799: remove usage of CloseableCoreSession"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d09261f66b008135217baa4465381b173a928b48", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/d09261f66b008135217baa4465381b173a928b48", "committedDate": "2020-03-26T15:23:15Z", "message": "NXP-28799: remove usage of CloseableCoreSession"}, "afterCommit": {"oid": "de835ec670be8484bb2ac1631cbe50a901a37f63", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/de835ec670be8484bb2ac1631cbe50a901a37f63", "committedDate": "2020-03-26T22:19:39Z", "message": "NXP-28799: remove usage of CloseableCoreSession"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de835ec670be8484bb2ac1631cbe50a901a37f63", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/de835ec670be8484bb2ac1631cbe50a901a37f63", "committedDate": "2020-03-26T22:19:39Z", "message": "NXP-28799: remove usage of CloseableCoreSession"}, "afterCommit": {"oid": "ea8dc7f33c816229c07f713e100ff82128e76408", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/ea8dc7f33c816229c07f713e100ff82128e76408", "committedDate": "2020-03-27T17:33:06Z", "message": "NXP-28799: remove usage of CloseableCoreSession"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ea8dc7f33c816229c07f713e100ff82128e76408", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/ea8dc7f33c816229c07f713e100ff82128e76408", "committedDate": "2020-03-27T17:33:06Z", "message": "NXP-28799: remove usage of CloseableCoreSession"}, "afterCommit": {"oid": "eb40044bcbf253302ffca1afe4157ac98979a97f", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/eb40044bcbf253302ffca1afe4157ac98979a97f", "committedDate": "2020-03-30T11:06:50Z", "message": "NXP-28799: remove usage of CloseableCoreSession"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzNzgwMzE2", "url": "https://github.com/nuxeo/nuxeo/pull/3858#pullrequestreview-383780316", "createdAt": "2020-03-30T11:56:28Z", "commit": {"oid": "eb40044bcbf253302ffca1afe4157ac98979a97f"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eb40044bcbf253302ffca1afe4157ac98979a97f", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/eb40044bcbf253302ffca1afe4157ac98979a97f", "committedDate": "2020-03-30T11:06:50Z", "message": "NXP-28799: remove usage of CloseableCoreSession"}, "afterCommit": {"oid": "4a0349c9d06d5320d5a6ed3a64140b8a5762bb6a", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/4a0349c9d06d5320d5a6ed3a64140b8a5762bb6a", "committedDate": "2020-03-30T18:20:15Z", "message": "NXP-28799: remove usage of CloseableCoreSession"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NTg0Mjc0", "url": "https://github.com/nuxeo/nuxeo/pull/3858#pullrequestreview-385584274", "createdAt": "2020-04-01T13:28:26Z", "commit": {"oid": "4a0349c9d06d5320d5a6ed3a64140b8a5762bb6a"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxMzoyODoyNlrOF_AmlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNDowMzozMlrOF_CL6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTYxNDQ4NA==", "bodyText": "If it's only for unit tests, shouldn't we move that method to test code, such as CoreFeature or something?\nDoes it make sense?", "url": "https://github.com/nuxeo/nuxeo/pull/3858#discussion_r401614484", "createdAt": "2020-04-01T13:28:26Z", "author": {"login": "troger"}, "path": "modules/core/nuxeo-core-api/src/main/java/org/nuxeo/ecm/core/api/CoreInstance.java", "diffHunk": "@@ -38,97 +38,145 @@\n     private CoreInstance() {\n     }\n \n+    /**\n+     * Gets a {@link CoreSession} for the currently logged-in user.\n+     *\n+     * @param repositoryName the repository name, or {@code null} for the default repository\n+     * @return the session\n+     * @since 11.1\n+     */\n+    public static CoreSession getCoreSession(String repositoryName) {\n+        return getCoreSession(repositoryName, getPrincipal(null));\n+    }\n+\n+    /**\n+     * MUST ONLY BE USED IN UNIT TESTS to get a {@link CoreSession} for the given user.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a0349c9d06d5320d5a6ed3a64140b8a5762bb6a"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTYxODkzMA==", "bodyText": "As the whole interface is deprecated, why removing the method?", "url": "https://github.com/nuxeo/nuxeo/pull/3858#discussion_r401618930", "createdAt": "2020-04-01T13:34:40Z", "author": {"login": "troger"}, "path": "modules/core/nuxeo-core-api/src/main/java/org/nuxeo/ecm/core/api/CloseableCoreSession.java", "diffHunk": "@@ -22,22 +22,18 @@\n  * Closeable Core Session.\n  *\n  * @since 10.1\n+ * @deprecated since 11.1, use just {@link CoreSession} instead\n  */\n+@Deprecated\n public interface CloseableCoreSession extends CoreSession, AutoCloseable {\n \n     /**\n-     * Closes this session.\n+     * Does nothing.\n      *\n      * @since 5.9.3\n+     * @deprecated since 11.1\n      */\n     @Override\n     void close();\n \n-    /**\n-     * Destroys any system resources held by this instance.\n-     * <p>\n-     * Called when the instance is no more needed.\n-     */\n-    void destroy();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a0349c9d06d5320d5a6ed3a64140b8a5762bb6a"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTYxOTY5OA==", "bodyText": "Quick question, we are assuming that there is only one session (id) per user?", "url": "https://github.com/nuxeo/nuxeo/pull/3858#discussion_r401619698", "createdAt": "2020-04-01T13:35:44Z", "author": {"login": "troger"}, "path": "modules/core/nuxeo-core-api/src/main/java/org/nuxeo/ecm/core/api/impl/DocumentModelImpl.java", "diffHunk": "@@ -320,7 +340,12 @@ public String getTitle() {\n \n     @Override\n     public String getSessionId() {\n-        return sid;\n+        return principal == null ? null : repositoryName + \"/\" + principal;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a0349c9d06d5320d5a6ed3a64140b8a5762bb6a"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTYyNTE2Mw==", "bodyText": "Worth adding a comment if there is any need to call getRootDocument?", "url": "https://github.com/nuxeo/nuxeo/pull/3858#discussion_r401625163", "createdAt": "2020-04-01T13:43:12Z", "author": {"login": "troger"}, "path": "modules/core/nuxeo-core-management-jtajca/src/main/java/org/nuxeo/ecm/core/management/jtajca/internal/DefaultMonitorComponent.java", "diffHunk": "@@ -129,9 +129,8 @@ protected void install() {\n      * Make sure we open the repository, to initialize its connection manager.\n      */\n     protected void activateRepository(String repositoryName) {\n-        try (CloseableCoreSession session = CoreInstance.openCoreSessionSystem(repositoryName)) {\n-            // do nothing, just open and close\n-        }\n+        CoreSession session = CoreInstance.getCoreSessionSystem(repositoryName);\n+        session.getRootDocument();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a0349c9d06d5320d5a6ed3a64140b8a5762bb6a"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY0MDQyNQ==", "bodyText": "I'm wondering, won't it be an issue? cc @bdelbosc", "url": "https://github.com/nuxeo/nuxeo/pull/3858#discussion_r401640425", "createdAt": "2020-04-01T14:03:32Z", "author": {"login": "troger"}, "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/main/java/org/nuxeo/elasticsearch/commands/IndexingCommandsStacker.java", "diffHunk": "@@ -212,8 +212,7 @@ protected IndexingCommands getOrCreateCommands(DocumentModel doc) {\n     }\n \n     protected String getDocKey(DocumentModel doc) {\n-        // Don't merge commands with different session, so we work only on attached doc\n-        return doc.getId() + \"#\" + doc.getSessionId();\n+        return doc.getId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a0349c9d06d5320d5a6ed3a64140b8a5762bb6a"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4a0349c9d06d5320d5a6ed3a64140b8a5762bb6a", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/4a0349c9d06d5320d5a6ed3a64140b8a5762bb6a", "committedDate": "2020-03-30T18:20:15Z", "message": "NXP-28799: remove usage of CloseableCoreSession"}, "afterCommit": {"oid": "04a1dd9988de2791f952919661b9ecff46503599", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/04a1dd9988de2791f952919661b9ecff46503599", "committedDate": "2020-04-03T01:21:23Z", "message": "NXP-28799: remove usage of CloseableCoreSession"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7eb8d717dd876f65f6510f126608ca68f673767b", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/7eb8d717dd876f65f6510f126608ca68f673767b", "committedDate": "2020-04-03T14:22:41Z", "message": "NXP-28799: add DocumentModel.getPrincipal"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60b085af3206ad0b411d7cd0b9ea84c5fdffe1eb", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/60b085af3206ad0b411d7cd0b9ea84c5fdffe1eb", "committedDate": "2020-04-03T14:22:41Z", "message": "NXP-28799: remove metrics instance fields"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5a517d9e1f8973c8c8eb660931f0ed723b3d067", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/d5a517d9e1f8973c8c8eb660931f0ed723b3d067", "committedDate": "2020-04-03T14:22:42Z", "message": "NXP-28799: remove CoreSession and DocumentModel session id (sid)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af64605849d03d883a11ddec8b62060c0b17f91f", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/af64605849d03d883a11ddec8b62060c0b17f91f", "committedDate": "2020-04-03T14:22:42Z", "message": "NXP-28799: don't use deprecated constructors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bfa834499fb48bb2e2f8e3bbac5085f29d70ad6", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/6bfa834499fb48bb2e2f8e3bbac5085f29d70ad6", "committedDate": "2020-04-03T14:22:42Z", "message": "NXP-28799: remove usage of CloseableCoreSession"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "04a1dd9988de2791f952919661b9ecff46503599", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/04a1dd9988de2791f952919661b9ecff46503599", "committedDate": "2020-04-03T01:21:23Z", "message": "NXP-28799: remove usage of CloseableCoreSession"}, "afterCommit": {"oid": "6bfa834499fb48bb2e2f8e3bbac5085f29d70ad6", "author": {"user": {"login": "efge", "name": "Florent Guillaume"}}, "url": "https://github.com/nuxeo/nuxeo/commit/6bfa834499fb48bb2e2f8e3bbac5085f29d70ad6", "committedDate": "2020-04-03T14:22:42Z", "message": "NXP-28799: remove usage of CloseableCoreSession"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MzM0NDI5", "url": "https://github.com/nuxeo/nuxeo/pull/3858#pullrequestreview-387334429", "createdAt": "2020-04-03T14:58:41Z", "commit": {"oid": "6bfa834499fb48bb2e2f8e3bbac5085f29d70ad6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4813, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}