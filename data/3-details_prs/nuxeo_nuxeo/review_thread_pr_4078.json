{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzMzg3ODA0", "number": 4078, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwNzo0MTo0NVrOD_-Lww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMjoyOToxOFrOEAfGQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NDA1Njk5OnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/api/BundleGroupExtractor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwNzo0MTo0NVrOGa9JYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwNzo1MDoxMVrOGa9cAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkxNzk4Ng==", "bodyText": "This was < 2 in the original code, is there really a need to change this and do a split if size is 1?", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r430917986", "createdAt": "2020-05-27T07:41:45Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/api/BundleGroupExtractor.java", "diffHunk": "@@ -0,0 +1,190 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Anahide Tchertchian\n+ */\n+package org.nuxeo.apidoc.api;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.LinkedHashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.apidoc.introspection.BundleGroupImpl;\n+import org.nuxeo.apidoc.introspection.BundleInfoImpl;\n+\n+/**\n+ * Introspects maven groupId and artifactId to generate bundle groups for Nuxeo modules.\n+ *\n+ * @since 11.1\n+ */\n+public class BundleGroupExtractor {\n+\n+    private static final Logger log = LogManager.getLogger(BundleGroupExtractor.class);\n+\n+    protected final Map<String, BundleInfo> bundles;\n+\n+    protected final String version;\n+\n+    protected final Map<String, List<String>> mavenGroups = new HashMap<>();\n+\n+    protected final Map<String, List<String>> mavenSubGroups = new HashMap<>();\n+\n+    protected final List<BundleGroup> roots = new ArrayList<>();\n+\n+    protected final Map<String, BundleGroup> groups = new LinkedHashMap<>();\n+\n+    public static final String VIRTUAL_BUNDLE_GROUP = BundleGroup.PREFIX + \"org.nuxeo.misc\";\n+\n+    protected static final List<String> BLACKLIST_SUFFIX = List.of(\"test\", \"tests\");\n+\n+    protected static final List<String> BLACKLIST = List.of(\"org\", \"org.nuxeo\", \"org.nuxeo.ecm\",\n+            \"org.nuxeo.ecm.platform\", \"com\", \"com.nuxeo\");\n+\n+    public BundleGroupExtractor(Map<String, BundleInfo> bundles, String version) {\n+        this.bundles = bundles;\n+        this.version = version;\n+        for (BundleInfo bundle : bundles.values()) {\n+            registerBundle(bundle);\n+        }\n+        generateGroups(version);\n+    }\n+\n+    public List<BundleGroup> getRoots() {\n+        return Collections.unmodifiableList(\n+                roots.stream().sorted(new NuxeoArtifactComparator()).collect(Collectors.toList()));\n+    }\n+\n+    public Map<String, BundleGroup> getGroups() {\n+        return Collections.unmodifiableMap(groups);\n+    }\n+\n+    protected void registerBundle(BundleInfo bundle) {\n+        String groupId = bundle.getGroupId();\n+        if (groupId != null) {\n+            groupId = BundleGroup.PREFIX + groupId;\n+        }\n+        String artifactId = bundle.getArtifactId();\n+        if (groupId == null || artifactId == null) {\n+            groupId = VIRTUAL_BUNDLE_GROUP;\n+            ((BundleInfoImpl) bundle).setGroupId(groupId);\n+        }\n+        if (!mavenGroups.containsKey(groupId)) {\n+            mavenGroups.put(groupId, new ArrayList<String>());\n+        }\n+        mavenGroups.get(groupId).add(bundle.getId());\n+    }\n+\n+    protected void generateGroups(String version) {\n+        // post process bundle groups\n+        List<String> mvnGroupNames = new ArrayList<>();\n+        mvnGroupNames.addAll(mavenGroups.keySet());\n+\n+        for (String mvnGroupName : mvnGroupNames) {\n+            List<String> artifactIds = mavenGroups.get(mvnGroupName);\n+            Collections.sort(artifactIds);\n+            Set<String> subGroups = new LinkedHashSet<>();\n+            for (String id : artifactIds) {\n+                if (id.contains(\".\")) {\n+                    String suffix = id.substring(id.lastIndexOf(\".\") + 1);\n+                    if (BLACKLIST_SUFFIX.contains(suffix.toLowerCase())) {\n+                        continue;\n+                    }\n+                    String grpName = id.substring(0, id.lastIndexOf(\".\"));\n+                    String grp = BundleGroup.PREFIX + grpName;\n+                    if (grp.equals(mvnGroupName) || BLACKLIST.contains(grpName.toLowerCase())) {\n+                        continue;\n+                    }\n+                    subGroups.add(grp);\n+                }\n+            }\n+            if (subGroups.size() < 1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76a883437b4b6b7abaaa17c87cd8eb5c29977680"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkyMjc1Mw==", "bodyText": "I did the extraction in a separate step to show the differences indeed.\nThis change allows to extract a group for \"grp:org.nuxeo.ecm.platform.restapi\" (visible in unit tests) as well a proper restoration of the apidoc group in json legacy tests (with only 2 bundles, apidoc-core and apidoc-repo --> the group would not be extracted in this case).\nOverall the \"< 2\" felt arbitrary to me. I kept 1 instead of 0 because it might not make sense to keep a subgroup for only one bundle.", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r430922753", "createdAt": "2020-05-27T07:50:11Z", "author": {"login": "atchertchian"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/api/BundleGroupExtractor.java", "diffHunk": "@@ -0,0 +1,190 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Anahide Tchertchian\n+ */\n+package org.nuxeo.apidoc.api;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.LinkedHashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.apidoc.introspection.BundleGroupImpl;\n+import org.nuxeo.apidoc.introspection.BundleInfoImpl;\n+\n+/**\n+ * Introspects maven groupId and artifactId to generate bundle groups for Nuxeo modules.\n+ *\n+ * @since 11.1\n+ */\n+public class BundleGroupExtractor {\n+\n+    private static final Logger log = LogManager.getLogger(BundleGroupExtractor.class);\n+\n+    protected final Map<String, BundleInfo> bundles;\n+\n+    protected final String version;\n+\n+    protected final Map<String, List<String>> mavenGroups = new HashMap<>();\n+\n+    protected final Map<String, List<String>> mavenSubGroups = new HashMap<>();\n+\n+    protected final List<BundleGroup> roots = new ArrayList<>();\n+\n+    protected final Map<String, BundleGroup> groups = new LinkedHashMap<>();\n+\n+    public static final String VIRTUAL_BUNDLE_GROUP = BundleGroup.PREFIX + \"org.nuxeo.misc\";\n+\n+    protected static final List<String> BLACKLIST_SUFFIX = List.of(\"test\", \"tests\");\n+\n+    protected static final List<String> BLACKLIST = List.of(\"org\", \"org.nuxeo\", \"org.nuxeo.ecm\",\n+            \"org.nuxeo.ecm.platform\", \"com\", \"com.nuxeo\");\n+\n+    public BundleGroupExtractor(Map<String, BundleInfo> bundles, String version) {\n+        this.bundles = bundles;\n+        this.version = version;\n+        for (BundleInfo bundle : bundles.values()) {\n+            registerBundle(bundle);\n+        }\n+        generateGroups(version);\n+    }\n+\n+    public List<BundleGroup> getRoots() {\n+        return Collections.unmodifiableList(\n+                roots.stream().sorted(new NuxeoArtifactComparator()).collect(Collectors.toList()));\n+    }\n+\n+    public Map<String, BundleGroup> getGroups() {\n+        return Collections.unmodifiableMap(groups);\n+    }\n+\n+    protected void registerBundle(BundleInfo bundle) {\n+        String groupId = bundle.getGroupId();\n+        if (groupId != null) {\n+            groupId = BundleGroup.PREFIX + groupId;\n+        }\n+        String artifactId = bundle.getArtifactId();\n+        if (groupId == null || artifactId == null) {\n+            groupId = VIRTUAL_BUNDLE_GROUP;\n+            ((BundleInfoImpl) bundle).setGroupId(groupId);\n+        }\n+        if (!mavenGroups.containsKey(groupId)) {\n+            mavenGroups.put(groupId, new ArrayList<String>());\n+        }\n+        mavenGroups.get(groupId).add(bundle.getId());\n+    }\n+\n+    protected void generateGroups(String version) {\n+        // post process bundle groups\n+        List<String> mvnGroupNames = new ArrayList<>();\n+        mvnGroupNames.addAll(mavenGroups.keySet());\n+\n+        for (String mvnGroupName : mvnGroupNames) {\n+            List<String> artifactIds = mavenGroups.get(mvnGroupName);\n+            Collections.sort(artifactIds);\n+            Set<String> subGroups = new LinkedHashSet<>();\n+            for (String id : artifactIds) {\n+                if (id.contains(\".\")) {\n+                    String suffix = id.substring(id.lastIndexOf(\".\") + 1);\n+                    if (BLACKLIST_SUFFIX.contains(suffix.toLowerCase())) {\n+                        continue;\n+                    }\n+                    String grpName = id.substring(0, id.lastIndexOf(\".\"));\n+                    String grp = BundleGroup.PREFIX + grpName;\n+                    if (grp.equals(mvnGroupName) || BLACKLIST.contains(grpName.toLowerCase())) {\n+                        continue;\n+                    }\n+                    subGroups.add(grp);\n+                }\n+            }\n+            if (subGroups.size() < 1) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkxNzk4Ng=="}, "originalCommit": {"oid": "76a883437b4b6b7abaaa17c87cd8eb5c29977680"}, "originalPosition": 122}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NDA1OTM3OnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/test/java/org/nuxeo/apidoc/core/test/TestBundleGroupExtractor.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwNzo0MjoyOVrOGa9K-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODoyOTo0MlrOGa-2Jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkxODM5Mg==", "bodyText": "protected static class", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r430918392", "createdAt": "2020-05-27T07:42:29Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/test/java/org/nuxeo/apidoc/core/test/TestBundleGroupExtractor.java", "diffHunk": "@@ -0,0 +1,174 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Anahide Tchertchian\n+ */\n+package org.nuxeo.apidoc.core.test;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.junit.Test;\n+import org.nuxeo.apidoc.api.BundleGroup;\n+import org.nuxeo.apidoc.api.BundleGroupExtractor;\n+import org.nuxeo.apidoc.api.BundleInfo;\n+import org.nuxeo.apidoc.introspection.BundleInfoImpl;\n+\n+/**\n+ * @since 11.1\n+ */\n+public class TestBundleGroupExtractor {\n+\n+    class MockBundle {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76a883437b4b6b7abaaa17c87cd8eb5c29977680"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkyMzM3Mg==", "bodyText": "This did not feel necessary for an inner class in a (very) unit test: can you please elaborate on what it would bring here?", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r430923372", "createdAt": "2020-05-27T07:51:16Z", "author": {"login": "atchertchian"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/test/java/org/nuxeo/apidoc/core/test/TestBundleGroupExtractor.java", "diffHunk": "@@ -0,0 +1,174 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Anahide Tchertchian\n+ */\n+package org.nuxeo.apidoc.core.test;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.junit.Test;\n+import org.nuxeo.apidoc.api.BundleGroup;\n+import org.nuxeo.apidoc.api.BundleGroupExtractor;\n+import org.nuxeo.apidoc.api.BundleInfo;\n+import org.nuxeo.apidoc.introspection.BundleInfoImpl;\n+\n+/**\n+ * @since 11.1\n+ */\n+public class TestBundleGroupExtractor {\n+\n+    class MockBundle {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkxODM5Mg=="}, "originalCommit": {"oid": "76a883437b4b6b7abaaa17c87cd8eb5c29977680"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkzMDY0MQ==", "bodyText": "Just to avoid warnings in tools that consider that the implicit package-private is wrong.", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r430930641", "createdAt": "2020-05-27T08:03:50Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/test/java/org/nuxeo/apidoc/core/test/TestBundleGroupExtractor.java", "diffHunk": "@@ -0,0 +1,174 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Anahide Tchertchian\n+ */\n+package org.nuxeo.apidoc.core.test;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.junit.Test;\n+import org.nuxeo.apidoc.api.BundleGroup;\n+import org.nuxeo.apidoc.api.BundleGroupExtractor;\n+import org.nuxeo.apidoc.api.BundleInfo;\n+import org.nuxeo.apidoc.introspection.BundleInfoImpl;\n+\n+/**\n+ * @since 11.1\n+ */\n+public class TestBundleGroupExtractor {\n+\n+    class MockBundle {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkxODM5Mg=="}, "originalCommit": {"oid": "76a883437b4b6b7abaaa17c87cd8eb5c29977680"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk0NTgzMA==", "bodyText": "Alright \ud83d\udc4d", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r430945830", "createdAt": "2020-05-27T08:29:42Z", "author": {"login": "atchertchian"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/test/java/org/nuxeo/apidoc/core/test/TestBundleGroupExtractor.java", "diffHunk": "@@ -0,0 +1,174 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Anahide Tchertchian\n+ */\n+package org.nuxeo.apidoc.core.test;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.junit.Test;\n+import org.nuxeo.apidoc.api.BundleGroup;\n+import org.nuxeo.apidoc.api.BundleGroupExtractor;\n+import org.nuxeo.apidoc.api.BundleInfo;\n+import org.nuxeo.apidoc.introspection.BundleInfoImpl;\n+\n+/**\n+ * @since 11.1\n+ */\n+public class TestBundleGroupExtractor {\n+\n+    class MockBundle {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkxODM5Mg=="}, "originalCommit": {"oid": "76a883437b4b6b7abaaa17c87cd8eb5c29977680"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NDA2MDM2OnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/test/java/org/nuxeo/apidoc/core/test/TestBundleGroupExtractor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwNzo0Mjo0MlrOGa9Ljw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwNzo0Mjo0MlrOGa9Ljw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkxODU0Mw==", "bodyText": "protected fields", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r430918543", "createdAt": "2020-05-27T07:42:42Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/test/java/org/nuxeo/apidoc/core/test/TestBundleGroupExtractor.java", "diffHunk": "@@ -0,0 +1,174 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Anahide Tchertchian\n+ */\n+package org.nuxeo.apidoc.core.test;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.junit.Test;\n+import org.nuxeo.apidoc.api.BundleGroup;\n+import org.nuxeo.apidoc.api.BundleGroupExtractor;\n+import org.nuxeo.apidoc.api.BundleInfo;\n+import org.nuxeo.apidoc.introspection.BundleInfoImpl;\n+\n+/**\n+ * @since 11.1\n+ */\n+public class TestBundleGroupExtractor {\n+\n+    class MockBundle {\n+\n+        String id;\n+\n+        String groupId;\n+\n+        String artifactId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76a883437b4b6b7abaaa17c87cd8eb5c29977680"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NDEyMDI5OnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/api/BundleGroupExtractor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwNzo1OTo1N1rOGa9yag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODozMDo0N1rOGa-44w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkyODQ5MA==", "bodyText": "You could use computeIfAbsent:\nmavenGroups.computeIfAbsent(groupId, k -> new ArrayList<>()).add(bundle.getId()));", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r430928490", "createdAt": "2020-05-27T07:59:57Z", "author": {"login": "kevinleturc"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/api/BundleGroupExtractor.java", "diffHunk": "@@ -0,0 +1,190 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Anahide Tchertchian\n+ */\n+package org.nuxeo.apidoc.api;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.LinkedHashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.apidoc.introspection.BundleGroupImpl;\n+import org.nuxeo.apidoc.introspection.BundleInfoImpl;\n+\n+/**\n+ * Introspects maven groupId and artifactId to generate bundle groups for Nuxeo modules.\n+ *\n+ * @since 11.1\n+ */\n+public class BundleGroupExtractor {\n+\n+    private static final Logger log = LogManager.getLogger(BundleGroupExtractor.class);\n+\n+    protected final Map<String, BundleInfo> bundles;\n+\n+    protected final String version;\n+\n+    protected final Map<String, List<String>> mavenGroups = new HashMap<>();\n+\n+    protected final Map<String, List<String>> mavenSubGroups = new HashMap<>();\n+\n+    protected final List<BundleGroup> roots = new ArrayList<>();\n+\n+    protected final Map<String, BundleGroup> groups = new LinkedHashMap<>();\n+\n+    public static final String VIRTUAL_BUNDLE_GROUP = BundleGroup.PREFIX + \"org.nuxeo.misc\";\n+\n+    protected static final List<String> BLACKLIST_SUFFIX = List.of(\"test\", \"tests\");\n+\n+    protected static final List<String> BLACKLIST = List.of(\"org\", \"org.nuxeo\", \"org.nuxeo.ecm\",\n+            \"org.nuxeo.ecm.platform\", \"com\", \"com.nuxeo\");\n+\n+    public BundleGroupExtractor(Map<String, BundleInfo> bundles, String version) {\n+        this.bundles = bundles;\n+        this.version = version;\n+        for (BundleInfo bundle : bundles.values()) {\n+            registerBundle(bundle);\n+        }\n+        generateGroups(version);\n+    }\n+\n+    public List<BundleGroup> getRoots() {\n+        return Collections.unmodifiableList(\n+                roots.stream().sorted(new NuxeoArtifactComparator()).collect(Collectors.toList()));\n+    }\n+\n+    public Map<String, BundleGroup> getGroups() {\n+        return Collections.unmodifiableMap(groups);\n+    }\n+\n+    protected void registerBundle(BundleInfo bundle) {\n+        String groupId = bundle.getGroupId();\n+        if (groupId != null) {\n+            groupId = BundleGroup.PREFIX + groupId;\n+        }\n+        String artifactId = bundle.getArtifactId();\n+        if (groupId == null || artifactId == null) {\n+            groupId = VIRTUAL_BUNDLE_GROUP;\n+            ((BundleInfoImpl) bundle).setGroupId(groupId);\n+        }\n+        if (!mavenGroups.containsKey(groupId)) {\n+            mavenGroups.put(groupId, new ArrayList<String>());\n+        }\n+        mavenGroups.get(groupId).add(bundle.getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76a883437b4b6b7abaaa17c87cd8eb5c29977680"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk0NjUzMQ==", "bodyText": "Will do, this is legacy code i did not touch, so please tell if you see any other potential simplifications (i did not bother to review it, i admit, but i do have unit tests for it now!)", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r430946531", "createdAt": "2020-05-27T08:30:47Z", "author": {"login": "atchertchian"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/api/BundleGroupExtractor.java", "diffHunk": "@@ -0,0 +1,190 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Anahide Tchertchian\n+ */\n+package org.nuxeo.apidoc.api;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.LinkedHashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.apidoc.introspection.BundleGroupImpl;\n+import org.nuxeo.apidoc.introspection.BundleInfoImpl;\n+\n+/**\n+ * Introspects maven groupId and artifactId to generate bundle groups for Nuxeo modules.\n+ *\n+ * @since 11.1\n+ */\n+public class BundleGroupExtractor {\n+\n+    private static final Logger log = LogManager.getLogger(BundleGroupExtractor.class);\n+\n+    protected final Map<String, BundleInfo> bundles;\n+\n+    protected final String version;\n+\n+    protected final Map<String, List<String>> mavenGroups = new HashMap<>();\n+\n+    protected final Map<String, List<String>> mavenSubGroups = new HashMap<>();\n+\n+    protected final List<BundleGroup> roots = new ArrayList<>();\n+\n+    protected final Map<String, BundleGroup> groups = new LinkedHashMap<>();\n+\n+    public static final String VIRTUAL_BUNDLE_GROUP = BundleGroup.PREFIX + \"org.nuxeo.misc\";\n+\n+    protected static final List<String> BLACKLIST_SUFFIX = List.of(\"test\", \"tests\");\n+\n+    protected static final List<String> BLACKLIST = List.of(\"org\", \"org.nuxeo\", \"org.nuxeo.ecm\",\n+            \"org.nuxeo.ecm.platform\", \"com\", \"com.nuxeo\");\n+\n+    public BundleGroupExtractor(Map<String, BundleInfo> bundles, String version) {\n+        this.bundles = bundles;\n+        this.version = version;\n+        for (BundleInfo bundle : bundles.values()) {\n+            registerBundle(bundle);\n+        }\n+        generateGroups(version);\n+    }\n+\n+    public List<BundleGroup> getRoots() {\n+        return Collections.unmodifiableList(\n+                roots.stream().sorted(new NuxeoArtifactComparator()).collect(Collectors.toList()));\n+    }\n+\n+    public Map<String, BundleGroup> getGroups() {\n+        return Collections.unmodifiableMap(groups);\n+    }\n+\n+    protected void registerBundle(BundleInfo bundle) {\n+        String groupId = bundle.getGroupId();\n+        if (groupId != null) {\n+            groupId = BundleGroup.PREFIX + groupId;\n+        }\n+        String artifactId = bundle.getArtifactId();\n+        if (groupId == null || artifactId == null) {\n+            groupId = VIRTUAL_BUNDLE_GROUP;\n+            ((BundleInfoImpl) bundle).setGroupId(groupId);\n+        }\n+        if (!mavenGroups.containsKey(groupId)) {\n+            mavenGroups.put(groupId, new ArrayList<String>());\n+        }\n+        mavenGroups.get(groupId).add(bundle.getId());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkyODQ5MA=="}, "originalCommit": {"oid": "76a883437b4b6b7abaaa17c87cd8eb5c29977680"}, "originalPosition": 96}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NDI2NjAwOnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/adapters/BundleGroupDocAdapter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODo0MDozNlrOGa_QOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODo0MDozNlrOGa_QOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk1MjUwNQ==", "bodyText": "Could be\n    return parents.stream()\n                  .map(doc -> doc.getAdapter(BundleGroup.class))\n                  .filter(Objects::nonNull)\n                  .map(BundleGroup::getId)\n                  .collect(Collectors.toList());", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r430952505", "createdAt": "2020-05-27T08:40:36Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/adapters/BundleGroupDocAdapter.java", "diffHunk": "@@ -136,9 +137,23 @@ public String getArtifactType() {\n         return TYPE_NAME;\n     }\n \n+    @Override\n+    public BundleGroup getParentGroup() {\n+        return getCoreSession().getParentDocument(doc.getRef()).getAdapter(BundleGroup.class);\n+    }\n+\n     @Override\n     public List<String> getParentIds() {\n-        throw new UnsupportedOperationException();\n+        List<DocumentModel> parents = getCoreSession().getParentDocuments(doc.getRef());\n+        Collections.reverse(parents);\n+        List<String> res = new ArrayList<>();\n+        for (DocumentModel doc : parents) {\n+            BundleGroup bgroup = doc.getAdapter(BundleGroup.class);\n+            if (bgroup != null) {\n+                res.add(bgroup.getId());\n+            }\n+        }\n+        return res;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76a883437b4b6b7abaaa17c87cd8eb5c29977680"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NDI2ODgxOnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/api/BundleGroupExtractor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODo0MToxOVrOGa_R7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODo0MToxOVrOGa_R7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk1Mjk0Mw==", "bodyText": "Could be bundles.values().forEach(this::registerBundle)", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r430952943", "createdAt": "2020-05-27T08:41:19Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/api/BundleGroupExtractor.java", "diffHunk": "@@ -0,0 +1,190 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Anahide Tchertchian\n+ */\n+package org.nuxeo.apidoc.api;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.LinkedHashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.apidoc.introspection.BundleGroupImpl;\n+import org.nuxeo.apidoc.introspection.BundleInfoImpl;\n+\n+/**\n+ * Introspects maven groupId and artifactId to generate bundle groups for Nuxeo modules.\n+ *\n+ * @since 11.1\n+ */\n+public class BundleGroupExtractor {\n+\n+    private static final Logger log = LogManager.getLogger(BundleGroupExtractor.class);\n+\n+    protected final Map<String, BundleInfo> bundles;\n+\n+    protected final String version;\n+\n+    protected final Map<String, List<String>> mavenGroups = new HashMap<>();\n+\n+    protected final Map<String, List<String>> mavenSubGroups = new HashMap<>();\n+\n+    protected final List<BundleGroup> roots = new ArrayList<>();\n+\n+    protected final Map<String, BundleGroup> groups = new LinkedHashMap<>();\n+\n+    public static final String VIRTUAL_BUNDLE_GROUP = BundleGroup.PREFIX + \"org.nuxeo.misc\";\n+\n+    protected static final List<String> BLACKLIST_SUFFIX = List.of(\"test\", \"tests\");\n+\n+    protected static final List<String> BLACKLIST = List.of(\"org\", \"org.nuxeo\", \"org.nuxeo.ecm\",\n+            \"org.nuxeo.ecm.platform\", \"com\", \"com.nuxeo\");\n+\n+    public BundleGroupExtractor(Map<String, BundleInfo> bundles, String version) {\n+        this.bundles = bundles;\n+        this.version = version;\n+        for (BundleInfo bundle : bundles.values()) {\n+            registerBundle(bundle);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76a883437b4b6b7abaaa17c87cd8eb5c29977680"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NDI3NDgzOnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/api/BundleGroupExtractor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODo0Mjo1NVrOGa_Vug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODo0Mzo0MlrOGa_Xmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk1MzkxNA==", "bodyText": "Could be grpArtifactIds.forEach(artifactIds::remove)", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r430953914", "createdAt": "2020-05-27T08:42:55Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/api/BundleGroupExtractor.java", "diffHunk": "@@ -0,0 +1,190 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Anahide Tchertchian\n+ */\n+package org.nuxeo.apidoc.api;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.LinkedHashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.apidoc.introspection.BundleGroupImpl;\n+import org.nuxeo.apidoc.introspection.BundleInfoImpl;\n+\n+/**\n+ * Introspects maven groupId and artifactId to generate bundle groups for Nuxeo modules.\n+ *\n+ * @since 11.1\n+ */\n+public class BundleGroupExtractor {\n+\n+    private static final Logger log = LogManager.getLogger(BundleGroupExtractor.class);\n+\n+    protected final Map<String, BundleInfo> bundles;\n+\n+    protected final String version;\n+\n+    protected final Map<String, List<String>> mavenGroups = new HashMap<>();\n+\n+    protected final Map<String, List<String>> mavenSubGroups = new HashMap<>();\n+\n+    protected final List<BundleGroup> roots = new ArrayList<>();\n+\n+    protected final Map<String, BundleGroup> groups = new LinkedHashMap<>();\n+\n+    public static final String VIRTUAL_BUNDLE_GROUP = BundleGroup.PREFIX + \"org.nuxeo.misc\";\n+\n+    protected static final List<String> BLACKLIST_SUFFIX = List.of(\"test\", \"tests\");\n+\n+    protected static final List<String> BLACKLIST = List.of(\"org\", \"org.nuxeo\", \"org.nuxeo.ecm\",\n+            \"org.nuxeo.ecm.platform\", \"com\", \"com.nuxeo\");\n+\n+    public BundleGroupExtractor(Map<String, BundleInfo> bundles, String version) {\n+        this.bundles = bundles;\n+        this.version = version;\n+        for (BundleInfo bundle : bundles.values()) {\n+            registerBundle(bundle);\n+        }\n+        generateGroups(version);\n+    }\n+\n+    public List<BundleGroup> getRoots() {\n+        return Collections.unmodifiableList(\n+                roots.stream().sorted(new NuxeoArtifactComparator()).collect(Collectors.toList()));\n+    }\n+\n+    public Map<String, BundleGroup> getGroups() {\n+        return Collections.unmodifiableMap(groups);\n+    }\n+\n+    protected void registerBundle(BundleInfo bundle) {\n+        String groupId = bundle.getGroupId();\n+        if (groupId != null) {\n+            groupId = BundleGroup.PREFIX + groupId;\n+        }\n+        String artifactId = bundle.getArtifactId();\n+        if (groupId == null || artifactId == null) {\n+            groupId = VIRTUAL_BUNDLE_GROUP;\n+            ((BundleInfoImpl) bundle).setGroupId(groupId);\n+        }\n+        if (!mavenGroups.containsKey(groupId)) {\n+            mavenGroups.put(groupId, new ArrayList<String>());\n+        }\n+        mavenGroups.get(groupId).add(bundle.getId());\n+    }\n+\n+    protected void generateGroups(String version) {\n+        // post process bundle groups\n+        List<String> mvnGroupNames = new ArrayList<>();\n+        mvnGroupNames.addAll(mavenGroups.keySet());\n+\n+        for (String mvnGroupName : mvnGroupNames) {\n+            List<String> artifactIds = mavenGroups.get(mvnGroupName);\n+            Collections.sort(artifactIds);\n+            Set<String> subGroups = new LinkedHashSet<>();\n+            for (String id : artifactIds) {\n+                if (id.contains(\".\")) {\n+                    String suffix = id.substring(id.lastIndexOf(\".\") + 1);\n+                    if (BLACKLIST_SUFFIX.contains(suffix.toLowerCase())) {\n+                        continue;\n+                    }\n+                    String grpName = id.substring(0, id.lastIndexOf(\".\"));\n+                    String grp = BundleGroup.PREFIX + grpName;\n+                    if (grp.equals(mvnGroupName) || BLACKLIST.contains(grpName.toLowerCase())) {\n+                        continue;\n+                    }\n+                    subGroups.add(grp);\n+                }\n+            }\n+            if (subGroups.size() < 1) {\n+                // no need to split the maven group into subGroups\n+            } else {\n+                for (String grp : subGroups) {\n+                    List<String> grpArtifactIds = new ArrayList<>();\n+                    for (String aid : artifactIds) {\n+                        if (aid.startsWith(grp) || (BundleGroup.PREFIX + aid).startsWith(grp)) {\n+                            grpArtifactIds.add(aid);\n+                        }\n+                    }\n+                    if (grpArtifactIds.size() > 1) {\n+                        for (String aid : grpArtifactIds) {\n+                            artifactIds.remove(aid);\n+                        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76a883437b4b6b7abaaa17c87cd8eb5c29977680"}, "originalPosition": 135}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk1NDM5NA==", "bodyText": "Actually artifactIds.removeAll(grpArtifactIds) is even better", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r430954394", "createdAt": "2020-05-27T08:43:42Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/api/BundleGroupExtractor.java", "diffHunk": "@@ -0,0 +1,190 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Anahide Tchertchian\n+ */\n+package org.nuxeo.apidoc.api;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.LinkedHashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.apidoc.introspection.BundleGroupImpl;\n+import org.nuxeo.apidoc.introspection.BundleInfoImpl;\n+\n+/**\n+ * Introspects maven groupId and artifactId to generate bundle groups for Nuxeo modules.\n+ *\n+ * @since 11.1\n+ */\n+public class BundleGroupExtractor {\n+\n+    private static final Logger log = LogManager.getLogger(BundleGroupExtractor.class);\n+\n+    protected final Map<String, BundleInfo> bundles;\n+\n+    protected final String version;\n+\n+    protected final Map<String, List<String>> mavenGroups = new HashMap<>();\n+\n+    protected final Map<String, List<String>> mavenSubGroups = new HashMap<>();\n+\n+    protected final List<BundleGroup> roots = new ArrayList<>();\n+\n+    protected final Map<String, BundleGroup> groups = new LinkedHashMap<>();\n+\n+    public static final String VIRTUAL_BUNDLE_GROUP = BundleGroup.PREFIX + \"org.nuxeo.misc\";\n+\n+    protected static final List<String> BLACKLIST_SUFFIX = List.of(\"test\", \"tests\");\n+\n+    protected static final List<String> BLACKLIST = List.of(\"org\", \"org.nuxeo\", \"org.nuxeo.ecm\",\n+            \"org.nuxeo.ecm.platform\", \"com\", \"com.nuxeo\");\n+\n+    public BundleGroupExtractor(Map<String, BundleInfo> bundles, String version) {\n+        this.bundles = bundles;\n+        this.version = version;\n+        for (BundleInfo bundle : bundles.values()) {\n+            registerBundle(bundle);\n+        }\n+        generateGroups(version);\n+    }\n+\n+    public List<BundleGroup> getRoots() {\n+        return Collections.unmodifiableList(\n+                roots.stream().sorted(new NuxeoArtifactComparator()).collect(Collectors.toList()));\n+    }\n+\n+    public Map<String, BundleGroup> getGroups() {\n+        return Collections.unmodifiableMap(groups);\n+    }\n+\n+    protected void registerBundle(BundleInfo bundle) {\n+        String groupId = bundle.getGroupId();\n+        if (groupId != null) {\n+            groupId = BundleGroup.PREFIX + groupId;\n+        }\n+        String artifactId = bundle.getArtifactId();\n+        if (groupId == null || artifactId == null) {\n+            groupId = VIRTUAL_BUNDLE_GROUP;\n+            ((BundleInfoImpl) bundle).setGroupId(groupId);\n+        }\n+        if (!mavenGroups.containsKey(groupId)) {\n+            mavenGroups.put(groupId, new ArrayList<String>());\n+        }\n+        mavenGroups.get(groupId).add(bundle.getId());\n+    }\n+\n+    protected void generateGroups(String version) {\n+        // post process bundle groups\n+        List<String> mvnGroupNames = new ArrayList<>();\n+        mvnGroupNames.addAll(mavenGroups.keySet());\n+\n+        for (String mvnGroupName : mvnGroupNames) {\n+            List<String> artifactIds = mavenGroups.get(mvnGroupName);\n+            Collections.sort(artifactIds);\n+            Set<String> subGroups = new LinkedHashSet<>();\n+            for (String id : artifactIds) {\n+                if (id.contains(\".\")) {\n+                    String suffix = id.substring(id.lastIndexOf(\".\") + 1);\n+                    if (BLACKLIST_SUFFIX.contains(suffix.toLowerCase())) {\n+                        continue;\n+                    }\n+                    String grpName = id.substring(0, id.lastIndexOf(\".\"));\n+                    String grp = BundleGroup.PREFIX + grpName;\n+                    if (grp.equals(mvnGroupName) || BLACKLIST.contains(grpName.toLowerCase())) {\n+                        continue;\n+                    }\n+                    subGroups.add(grp);\n+                }\n+            }\n+            if (subGroups.size() < 1) {\n+                // no need to split the maven group into subGroups\n+            } else {\n+                for (String grp : subGroups) {\n+                    List<String> grpArtifactIds = new ArrayList<>();\n+                    for (String aid : artifactIds) {\n+                        if (aid.startsWith(grp) || (BundleGroup.PREFIX + aid).startsWith(grp)) {\n+                            grpArtifactIds.add(aid);\n+                        }\n+                    }\n+                    if (grpArtifactIds.size() > 1) {\n+                        for (String aid : grpArtifactIds) {\n+                            artifactIds.remove(aid);\n+                        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk1MzkxNA=="}, "originalCommit": {"oid": "76a883437b4b6b7abaaa17c87cd8eb5c29977680"}, "originalPosition": 135}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NDQ3Nzc2OnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-repo/src/test/java/org/nuxeo/apidoc/test/AbstractApidocTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwOTozNjo0NlrOGbBZXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwOTozNjo0NlrOGbBZXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk4NzYxNA==", "bodyText": "should not have pushed this", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r430987614", "createdAt": "2020-05-27T09:36:46Z", "author": {"login": "atchertchian"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-repo/src/test/java/org/nuxeo/apidoc/test/AbstractApidocTest.java", "diffHunk": "@@ -38,7 +38,7 @@\n public abstract class AbstractApidocTest {\n \n     // helper for quicker update when running tests locally\n-    public static final boolean UPDATE_REFERENCE_FILES_ON_FAILURE = false;\n+    public static final boolean UPDATE_REFERENCE_FILES_ON_FAILURE = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abf51fc350847842072da6841d5ded31ea3119e2"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4OTQ0OTYwOnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/adapters/BundleGroupDocAdapter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMjoyOToxOFrOGby1iA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwOToxNzo0MlrOGcVLgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTc5NzY0MA==", "bodyText": "Suggestion:\n        return docs.stream()\n                   .map(doc -> doc.getAdapter(BundleInfo.class))\n                   .filter(Objects::nonNull)\n                   .map(BundleInfo::getId)\n                   .filter(Predicate.isEqual(getId()))\n                   .collect(Collectors.toList());\nThe main difference is that getId is called only once, otherwise it is just style.", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r431797640", "createdAt": "2020-05-28T12:29:18Z", "author": {"login": "kevinleturc"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/adapters/BundleGroupDocAdapter.java", "diffHunk": "@@ -81,16 +85,14 @@ public BundleGroupDocAdapter(DocumentModel doc) {\n \n     @Override\n     public List<String> getBundleIds() {\n-        List<String> bundles = new ArrayList<>();\n-        String query = QueryHelper.select(BundleInfo.TYPE_NAME, doc);\n-        DocumentModelList docs = getCoreSession().query(query + QueryHelper.ORDER_BY_POS);\n-        for (DocumentModel child : docs) {\n-            BundleInfo bi = child.getAdapter(BundleInfo.class);\n-            if (bi != null && !bi.getId().equals(getId())) {\n-                bundles.add(bi.getId());\n-            }\n-        }\n-        return bundles;\n+        String query = QueryHelper.select(BundleInfo.TYPE_NAME, doc, NXQL.ECM_POS);\n+        DocumentModelList docs = getCoreSession().query(query);\n+        return docs.stream()\n+                   .map(doc -> doc.getAdapter(BundleInfo.class))\n+                   .filter(Objects::nonNull)\n+                   .filter(b -> !b.getId().equals(getId()))\n+                   .map(BundleInfo::getId)\n+                   .collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ddde734f6a969ca7eae95182201fbfb276abc1ad"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM2MDMyMA==", "bodyText": "should have actually been\n   .filter(Predicate.not(Predicate.isEqual(getId()))\n(caught by ftests)", "url": "https://github.com/nuxeo/nuxeo/pull/4078#discussion_r432360320", "createdAt": "2020-05-29T09:17:42Z", "author": {"login": "atchertchian"}, "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-core/src/main/java/org/nuxeo/apidoc/adapters/BundleGroupDocAdapter.java", "diffHunk": "@@ -81,16 +85,14 @@ public BundleGroupDocAdapter(DocumentModel doc) {\n \n     @Override\n     public List<String> getBundleIds() {\n-        List<String> bundles = new ArrayList<>();\n-        String query = QueryHelper.select(BundleInfo.TYPE_NAME, doc);\n-        DocumentModelList docs = getCoreSession().query(query + QueryHelper.ORDER_BY_POS);\n-        for (DocumentModel child : docs) {\n-            BundleInfo bi = child.getAdapter(BundleInfo.class);\n-            if (bi != null && !bi.getId().equals(getId())) {\n-                bundles.add(bi.getId());\n-            }\n-        }\n-        return bundles;\n+        String query = QueryHelper.select(BundleInfo.TYPE_NAME, doc, NXQL.ECM_POS);\n+        DocumentModelList docs = getCoreSession().query(query);\n+        return docs.stream()\n+                   .map(doc -> doc.getAdapter(BundleInfo.class))\n+                   .filter(Objects::nonNull)\n+                   .filter(b -> !b.getId().equals(getId()))\n+                   .map(BundleInfo::getId)\n+                   .collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTc5NzY0MA=="}, "originalCommit": {"oid": "ddde734f6a969ca7eae95182201fbfb276abc1ad"}, "originalPosition": 42}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4148, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}