{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5OTk4NTg0", "number": 3650, "title": "Fix nxp 27559 cq random", "bodyText": "Fix NXP-27559 Chronicle Queue random failure in unit tests", "createdAt": "2020-01-07T13:50:06Z", "url": "https://github.com/nuxeo/nuxeo/pull/3650", "merged": true, "mergeCommit": {"oid": "21e979fb6ae463ff35fddf1acdd20adfa4d9235b"}, "closed": true, "closedAt": "2020-09-08T09:48:52Z", "author": {"login": "bdelbosc"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4BKdWgFqTMzOTI0OTAyNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHMokugFqTQ4NTAzNzExNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MjQ5MDI1", "url": "https://github.com/nuxeo/nuxeo/pull/3650#pullrequestreview-339249025", "createdAt": "2020-01-07T13:56:01Z", "commit": {"oid": "80eec1a8e8882540d1a1325c745667bf9cb90f67"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MjU5NDM5", "url": "https://github.com/nuxeo/nuxeo/pull/3650#pullrequestreview-339259439", "createdAt": "2020-01-07T14:13:55Z", "commit": {"oid": "ce77f22f55819c64d3f11a555449ec1c340db971"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f8f53ea6ecae6e3bb1e79aaa4e8f84ab9b3ed25", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/9f8f53ea6ecae6e3bb1e79aaa4e8f84ab9b3ed25", "committedDate": "2020-09-03T12:00:11Z", "message": "NXP-27559: Upgrade CQ to bom 2.17.506"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8a78a059ec81764eac23bb0b909494e05a46f7e", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/d8a78a059ec81764eac23bb0b909494e05a46f7e", "committedDate": "2020-09-03T12:00:12Z", "message": "Revert \"NXP-27559: Ignore Chronicle tests not working on Jenkins X\"\n\nThis reverts commit 9cd903cf7cf6ac9f96e8f84286c1da3603e2e760."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "42f29b423e79087bb8b197eaaeafbf29a8db3a16", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/42f29b423e79087bb8b197eaaeafbf29a8db3a16", "committedDate": "2020-01-08T15:39:16Z", "message": "NXP-27559: Fix testConcurrentFileRetentions\n\nTaking lag before starting the processing and not concurrently"}, "afterCommit": {"oid": "d1ca2036889b52dcbb0a8611da8c796cdcb8ec4d", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/d1ca2036889b52dcbb0a8611da8c796cdcb8ec4d", "committedDate": "2020-09-03T12:05:22Z", "message": "NXP-27559: Fix testConcurrentFileRetentions\n\nTaking lag before starting the processing and not concurrently"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMzc4NTM0", "url": "https://github.com/nuxeo/nuxeo/pull/3650#pullrequestreview-483378534", "createdAt": "2020-09-07T08:57:28Z", "commit": {"oid": "00135d92b2206ad47e7fb90ea4c6f3cffef4a4cc"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNDQwNjg4", "url": "https://github.com/nuxeo/nuxeo/pull/3650#pullrequestreview-483440688", "createdAt": "2020-09-07T10:22:53Z", "commit": {"oid": "036e42cfaaa417592ca4181c5ccc978ac0d88a23"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxMDoyMjo1NFrOHN5zmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxMDoyNjoxNVrOHN56QA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDM0MDYzNA==", "bodyText": "I suggest you use FeaturesRunner.getBuildDirectory() istead of the hardcoded target to make sure that the multi-environment tests are completely isolated.\nSee https://jira.nuxeo.com/browse/NXP-28579 and 7d7a2f9.", "url": "https://github.com/nuxeo/nuxeo/pull/3650#discussion_r484340634", "createdAt": "2020-09-07T10:22:54Z", "author": {"login": "ataillefer"}, "path": "modules/platform/nuxeo-platform-importer/nuxeo-importer-stream/src/test/java/org/nuxeo/importer/stream/tests/importer/TestAutomation.java", "diffHunk": "@@ -62,7 +63,7 @@\n     AutomationService automationService;\n \n     @Rule\n-    public TemporaryFolder folder = new TemporaryFolder();\n+    public TemporaryFolder folder = new TemporaryFolder(new File(\"target\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "036e42cfaaa417592ca4181c5ccc978ac0d88a23"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDM0MjMzNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // border line cases that happens on unit test and where the queue is not yet ready\n          \n          \n            \n                        // border line cases that happens on unit tests and where the queue is not yet ready", "url": "https://github.com/nuxeo/nuxeo/pull/3650#discussion_r484342336", "createdAt": "2020-09-07T10:26:15Z", "author": {"login": "ataillefer"}, "path": "modules/runtime/nuxeo-stream/src/main/java/org/nuxeo/lib/stream/log/chronicle/ChronicleLogOffsetTracker.java", "diffHunk": "@@ -123,9 +122,18 @@ public long readLastCommittedOffset() {\n                     offsetQueue.file().getAbsolutePath(), e.getMessage()));\n             offsetTailer = offsetQueue.createTailer().direction(TailerDirection.BACKWARD).toEnd();\n         }\n-        if (offsetTailer.state() == TailerState.UNINITIALISED) {\n+        switch (offsetTailer.state()) {\n+        case FOUND_CYCLE:\n+            // expected case continue\n+            break;\n+        case UNINITIALISED:\n             // This is a new queue, we are not going to find anything\n             return 0;\n+        default:\n+            // border line cases that happens on unit test and where the queue is not yet ready", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00135d92b2206ad47e7fb90ea4c6f3cffef4a4cc"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60e4b15b312cad541ec6fbea66da416d177d7c2f", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/60e4b15b312cad541ec6fbea66da416d177d7c2f", "committedDate": "2020-09-07T15:01:33Z", "message": "NXP-27559: Use target directory instead of /tmp for CQ files\n\nIn containerized env /tmp is not always mapped to volume resulting in probable\ncq4 corruption when using overlayFS."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dca8213e221ef26fbc5d600f254f8c20836ba5bb", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/dca8213e221ef26fbc5d600f254f8c20836ba5bb", "committedDate": "2020-09-07T15:01:33Z", "message": "NXP-27559: Lazy initialization of the offset CQ\n\nThe offset tracker CQ is now created lazily in the computation runner thread instead\nof the main thread"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "572d7ce85e1afb3eb90bc83758800782d3883332", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/572d7ce85e1afb3eb90bc83758800782d3883332", "committedDate": "2020-09-07T15:01:33Z", "message": "NXP-27559: Fix testConcurrentFileRetentions\n\nTaking lag before starting the processing and not concurrently"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "734173953f8a36748e805330cbaedd9b2fb53d29", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/734173953f8a36748e805330cbaedd9b2fb53d29", "committedDate": "2020-09-07T15:01:33Z", "message": "NXP-27559: Bump to chronicle-bom 2.20.40"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5da5a1489c104a0ef6aa4f5669648bfd1548584f", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/5da5a1489c104a0ef6aa4f5669648bfd1548584f", "committedDate": "2020-09-07T15:01:33Z", "message": "NXP-28619 NXP-27559: Re activate CQ unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89b98898fce100ba960cf73dc65f195a52d65e28", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/89b98898fce100ba960cf73dc65f195a52d65e28", "committedDate": "2020-09-07T15:01:33Z", "message": "NXP-27559: Fix SCQIndexing assertion failure by checking tailer state\n\nSCQIndexing.sequenceForPosition has a failure assertion if the state is BEYOND_START_OF_CYCLE\nwhich happens when the queue is not yet fully created"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "00135d92b2206ad47e7fb90ea4c6f3cffef4a4cc", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/00135d92b2206ad47e7fb90ea4c6f3cffef4a4cc", "committedDate": "2020-09-03T17:49:21Z", "message": "NXP-27559: Fix SCQIndexing assertion failure by checking tailer state\n\nSCQIndexing.sequenceForPosition has a failure assertion if the state is BEYOND_START_OF_CYCLE\nwhich happens when the queue is not yet fully created"}, "afterCommit": {"oid": "89b98898fce100ba960cf73dc65f195a52d65e28", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/89b98898fce100ba960cf73dc65f195a52d65e28", "committedDate": "2020-09-07T15:01:33Z", "message": "NXP-27559: Fix SCQIndexing assertion failure by checking tailer state\n\nSCQIndexing.sequenceForPosition has a failure assertion if the state is BEYOND_START_OF_CYCLE\nwhich happens when the queue is not yet fully created"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNjI3OTkw", "url": "https://github.com/nuxeo/nuxeo/pull/3650#pullrequestreview-483627990", "createdAt": "2020-09-07T15:20:14Z", "commit": {"oid": "89b98898fce100ba960cf73dc65f195a52d65e28"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzODg1NDI2", "url": "https://github.com/nuxeo/nuxeo/pull/3650#pullrequestreview-483885426", "createdAt": "2020-09-08T07:58:07Z", "commit": {"oid": "89b98898fce100ba960cf73dc65f195a52d65e28"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1MDM3MTE2", "url": "https://github.com/nuxeo/nuxeo/pull/3650#pullrequestreview-485037116", "createdAt": "2020-09-09T13:57:47Z", "commit": {"oid": "89b98898fce100ba960cf73dc65f195a52d65e28"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxMzo1Nzo0N1rOHPIseg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxMzo1Nzo0N1rOHPIseg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTYzMzE0Ng==", "bodyText": "@bdelbosc Is there a specific reason why this would be uppercase please?\nIt's been making my eclipse java build fail for not obvious reason...", "url": "https://github.com/nuxeo/nuxeo/pull/3650#discussion_r485633146", "createdAt": "2020-09-09T13:57:47Z", "author": {"login": "atchertchian"}, "path": "pom.xml", "diffHunk": "@@ -4987,7 +4987,7 @@\n       <dependency>\n         <!-- unused dependency, declared to exclude affinity -->\n         <groupId>net.openhft</groupId>\n-        <artifactId>chronicle-threads</artifactId>\n+        <artifactId>chronicle-Threads</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89b98898fce100ba960cf73dc65f195a52d65e28"}, "originalPosition": 16}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4871, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}