{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwODE1NjYx", "number": 3986, "title": "Fix nxp 28709 log silent failure in automation bulk.run action", "bodyText": "setError is called twice.\nThe second call overrides the first one so it is conditioned.\nThere is some logic to reconstitute the whole error message. I would rather have changed setError to take the throwable and do this work than just giving it a string.\nThen no matter how many times we call setError with the same executionId and throwable, we would always get the same resulting message", "createdAt": "2020-04-29T16:19:27Z", "url": "https://github.com/nuxeo/nuxeo/pull/3986", "merged": true, "mergeCommit": {"oid": "39696dfeaa9e9fc89748f275c04cbf6dee1422eb"}, "closed": true, "closedAt": "2020-05-14T14:26:13Z", "author": {"login": "NourNuxeo"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcca9PVgBqjMyODUzOTY1MjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchNlWsgFqTQxMTgwOTI2NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "27a19a232b5603178770d414062b9005116307e2", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/27a19a232b5603178770d414062b9005116307e2", "committedDate": "2020-04-29T16:11:38Z", "message": "NXP-28709: get the right status for failing bulk operations"}, "afterCommit": {"oid": "ed41900008d375f3f5c0fcbc6ac6dafe3899d236", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/ed41900008d375f3f5c0fcbc6ac6dafe3899d236", "committedDate": "2020-04-29T16:20:16Z", "message": "NXP-28709: get the right status for failing bulk operations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ed41900008d375f3f5c0fcbc6ac6dafe3899d236", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/ed41900008d375f3f5c0fcbc6ac6dafe3899d236", "committedDate": "2020-04-29T16:20:16Z", "message": "NXP-28709: get the right status for failing bulk operations"}, "afterCommit": {"oid": "c6afaaf1511f21c960a33a18c8b3813cc0f3294a", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/c6afaaf1511f21c960a33a18c8b3813cc0f3294a", "committedDate": "2020-04-29T19:13:52Z", "message": "NXP-28709: get the right status for failing bulk operations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0ODIwMzQ3", "url": "https://github.com/nuxeo/nuxeo/pull/3986#pullrequestreview-404820347", "createdAt": "2020-05-04T09:11:13Z", "commit": {"oid": "c6afaaf1511f21c960a33a18c8b3813cc0f3294a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQwOToxMToxM1rOGP4S6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQwOToxMToxM1rOGP4S6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMwNDE2OQ==", "bodyText": "So now each normal call to /status costs 2 round trips, one to the transient store to check for an error and one to the kv to get the status.", "url": "https://github.com/nuxeo/nuxeo/pull/3986#discussion_r419304169", "createdAt": "2020-05-04T09:11:13Z", "author": {"login": "bdelbosc"}, "path": "modules/platform/nuxeo-automation/nuxeo-automation-server/src/main/java/org/nuxeo/ecm/automation/server/jaxrs/adapters/AsyncOperationAdapter.java", "diffHunk": "@@ -200,11 +201,11 @@ public OperationException onError(OperationException error) {\n     @GET\n     @Path(\"{executionId}/status\")\n     public Object status(@PathParam(\"executionId\") String executionId) throws IOException, MessagingException {\n+        String error = getError(executionId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c6afaaf1511f21c960a33a18c8b3813cc0f3294a"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c6afaaf1511f21c960a33a18c8b3813cc0f3294a", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/c6afaaf1511f21c960a33a18c8b3813cc0f3294a", "committedDate": "2020-04-29T19:13:52Z", "message": "NXP-28709: get the right status for failing bulk operations"}, "afterCommit": {"oid": "028ad6c66f4120654dfdaec4b0391cde20220e1f", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/028ad6c66f4120654dfdaec4b0391cde20220e1f", "committedDate": "2020-05-04T11:35:04Z", "message": "NXP-28709: get the right status for failing bulk operations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1ODA3ODkw", "url": "https://github.com/nuxeo/nuxeo/pull/3986#pullrequestreview-405807890", "createdAt": "2020-05-05T13:51:11Z", "commit": {"oid": "028ad6c66f4120654dfdaec4b0391cde20220e1f"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1ODU3OTk1", "url": "https://github.com/nuxeo/nuxeo/pull/3986#pullrequestreview-405857995", "createdAt": "2020-05-05T14:42:32Z", "commit": {"oid": "028ad6c66f4120654dfdaec4b0391cde20220e1f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNDo0MjozMlrOGQsxLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNDo0MjozMlrOGQsxLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE2Mzg4NA==", "bodyText": "I would have added a new method setError(String, Throwable) to handle the unwrapException logic (and deprecate the existing setError method probably as it won't be used anymore).", "url": "https://github.com/nuxeo/nuxeo/pull/3986#discussion_r420163884", "createdAt": "2020-05-05T14:42:32Z", "author": {"login": "troger"}, "path": "modules/platform/nuxeo-automation/nuxeo-automation-server/src/main/java/org/nuxeo/ecm/automation/server/jaxrs/adapters/AsyncOperationAdapter.java", "diffHunk": "@@ -164,7 +165,7 @@ public void onOperationExit(Object output) {\n \n             @Override\n             public OperationException onError(OperationException error) {\n-                setError(executionId, error.getMessage());\n+                setError(executionId, ExceptionHelper.unwrapException(error).getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "028ad6c66f4120654dfdaec4b0391cde20220e1f"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "028ad6c66f4120654dfdaec4b0391cde20220e1f", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/028ad6c66f4120654dfdaec4b0391cde20220e1f", "committedDate": "2020-05-04T11:35:04Z", "message": "NXP-28709: get the right status for failing bulk operations"}, "afterCommit": {"oid": "ec8c4cbc95ec8f7349f81f934e681ad112f299a7", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/ec8c4cbc95ec8f7349f81f934e681ad112f299a7", "committedDate": "2020-05-07T16:08:46Z", "message": "NXP-28709: get the right status for failing bulk operations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5Nzg3MzEy", "url": "https://github.com/nuxeo/nuxeo/pull/3986#pullrequestreview-409787312", "createdAt": "2020-05-12T07:54:31Z", "commit": {"oid": "ec8c4cbc95ec8f7349f81f934e681ad112f299a7"}, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwNzo1NDozMlrOGT6dhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwODowMDozNFrOGT6sVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUzMzk1OQ==", "bodyText": "You should add @deprecated since 11.1, because unused and use the deprecated method in the new one as the code is the same.", "url": "https://github.com/nuxeo/nuxeo/pull/3986#discussion_r423533959", "createdAt": "2020-05-12T07:54:32Z", "author": {"login": "kevinleturc"}, "path": "modules/platform/nuxeo-automation/nuxeo-automation-server/src/main/java/org/nuxeo/ecm/automation/server/jaxrs/adapters/AsyncOperationAdapter.java", "diffHunk": "@@ -289,6 +290,13 @@ protected void enterMethod(String executionId, InvokableMethod method) {\n         }\n     }\n \n+    protected void setError(String executionId, Throwable t) {\n+        getTransientStore().putParameter(executionId, TRANSIENT_STORE_ERROR,\n+                ExceptionHelper.unwrapException(t).getMessage());\n+        setCompleted(executionId);\n+    }\n+\n+    @Deprecated\n     protected void setError(String executionId, String error) {\n         getTransientStore().putParameter(executionId, TRANSIENT_STORE_ERROR, error);\n         setCompleted(executionId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec8c4cbc95ec8f7349f81f934e681ad112f299a7"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUzNzc1MA==", "bodyText": "Can we just put \"{}\" without calling the MAPPER? writeValueAsString is used to serialize an object to JSON (or other), here you're giving to it a String. My first thought is: writing a string as string will return the input string. If it's not the case, having the final value in the test will help us to understand what makes it fail and what we want to control/catch.", "url": "https://github.com/nuxeo/nuxeo/pull/3986#discussion_r423537750", "createdAt": "2020-05-12T08:00:34Z", "author": {"login": "kevinleturc"}, "path": "modules/platform/nuxeo-automation/nuxeo-automation-test/src/test/java/org/nuxeo/ecm/automation/server/test/AsyncOperationAdapterTest.java", "diffHunk": "@@ -222,6 +222,19 @@ public void testAsyncBulkAction() throws Exception {\n         assertEquals(\"foo\", getTitle(folder));\n     }\n \n+    @Test\n+    public void testFailingBulkAction() throws Exception {\n+        String result = async.newRequest(BulkRunAction.ID) //\n+                             .set(\"action\", AutomationBulkAction.ACTION_NAME)\n+                             .set(\"query\", \"SELECT * FROM Folder\")\n+                             .set(\"bucketSize\", \"10\")\n+                             .set(\"batchSize\", \"5\")\n+                             .set(\"parameters\", MAPPER.writeValueAsString(\"{}\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec8c4cbc95ec8f7349f81f934e681ad112f299a7"}, "originalPosition": 20}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ec8c4cbc95ec8f7349f81f934e681ad112f299a7", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/ec8c4cbc95ec8f7349f81f934e681ad112f299a7", "committedDate": "2020-05-07T16:08:46Z", "message": "NXP-28709: get the right status for failing bulk operations"}, "afterCommit": {"oid": "946d5b89494f41bc77de50e910650aa94d3a613e", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/946d5b89494f41bc77de50e910650aa94d3a613e", "committedDate": "2020-05-12T09:44:36Z", "message": "NXP-28709: get the right status for failing bulk operations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "321e8c4ca83011e90bea963413439cc67917227c", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/321e8c4ca83011e90bea963413439cc67917227c", "committedDate": "2020-05-12T09:46:16Z", "message": "NXP-28709: get the right status for failing bulk operations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "946d5b89494f41bc77de50e910650aa94d3a613e", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/946d5b89494f41bc77de50e910650aa94d3a613e", "committedDate": "2020-05-12T09:44:36Z", "message": "NXP-28709: get the right status for failing bulk operations"}, "afterCommit": {"oid": "321e8c4ca83011e90bea963413439cc67917227c", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/321e8c4ca83011e90bea963413439cc67917227c", "committedDate": "2020-05-12T09:46:16Z", "message": "NXP-28709: get the right status for failing bulk operations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNzk5NjUy", "url": "https://github.com/nuxeo/nuxeo/pull/3986#pullrequestreview-411799652", "createdAt": "2020-05-14T13:24:46Z", "commit": {"oid": "321e8c4ca83011e90bea963413439cc67917227c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExODA5MjY0", "url": "https://github.com/nuxeo/nuxeo/pull/3986#pullrequestreview-411809264", "createdAt": "2020-05-14T13:35:09Z", "commit": {"oid": "321e8c4ca83011e90bea963413439cc67917227c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4788, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}