{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxNDg1NTkx", "number": 4127, "title": "fix-NXP-29198-stream-position-offset", "bodyText": "PR created from https://qa.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-bdelbosc3/334/", "createdAt": "2020-06-09T01:48:08Z", "url": "https://github.com/nuxeo/nuxeo/pull/4127", "merged": true, "mergeCommit": {"oid": "402a0341e29659fa3a42e09230d40f22f55f0eb7"}, "closed": true, "closedAt": "2020-07-07T12:25:38Z", "author": {"login": "nuxeojenkins"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpgquCAFqTQyNjg5MDY0NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcykql6AFqTQ0MzgyNDg3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2ODkwNjQ0", "url": "https://github.com/nuxeo/nuxeo/pull/4127#pullrequestreview-426890644", "createdAt": "2020-06-09T08:11:43Z", "commit": {"oid": "8617068112d9afc7c5612ad939463eabc79aa9a6"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwODoxMTo0M1rOGg9q8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwODoxOTo0NlrOGg99gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIxODAzMw==", "bodyText": "Any reason it's not written this way?\nreturn \"Name{id='\" + id + \"', urn='\" + urn + \"'}\";", "url": "https://github.com/nuxeo/nuxeo/pull/4127#discussion_r437218033", "createdAt": "2020-06-09T08:11:43Z", "author": {"login": "ataillefer"}, "path": "modules/runtime/nuxeo-stream/src/main/java/org/nuxeo/lib/stream/log/Name.java", "diffHunk": "@@ -115,8 +115,7 @@ public String getUrn() {\n \n     @Override\n     public String toString() {\n-        return \"Name{\" + \"namespace='\" + namespace + '\\'' + \", name='\" + name + '\\'' + \", id='\" + id + '\\'' + \", urn='\"\n-                + urn + '\\'' + '}';\n+        return \"Name{\" + \"id='\" + id + '\\'' + \", urn='\" + urn + '\\'' + '}';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8617068112d9afc7c5612ad939463eabc79aa9a6"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIxOTQzNg==", "bodyText": "It's a single position right? In which case position.", "url": "https://github.com/nuxeo/nuxeo/pull/4127#discussion_r437219436", "createdAt": "2020-06-09T08:14:07Z", "author": {"login": "ataillefer"}, "path": "modules/runtime/nuxeo-stream/src/main/java/org/nuxeo/lib/stream/tools/command/PositionCommand.java", "diffHunk": "@@ -124,6 +126,13 @@ public void updateOptions(Options options) {\n                       .hasArg()\n                       .argName(\"DATE\")\n                       .build());\n+        options.addOption(Option.builder()\n+                                .longOpt(TO_OFFSET_OPT)\n+                                .desc(\"Sets the committed positions to a specific offset.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e029664a0dec10d75673df5c8bd083068acb03d4"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIyMDI1OQ==", "bodyText": "Why? Is it an abnormal behavior?", "url": "https://github.com/nuxeo/nuxeo/pull/4127#discussion_r437220259", "createdAt": "2020-06-09T08:15:32Z", "author": {"login": "ataillefer"}, "path": "modules/runtime/nuxeo-stream/src/main/java/org/nuxeo/lib/stream/tools/command/PositionCommand.java", "diffHunk": "@@ -212,7 +224,7 @@ protected boolean positionAfterDate(LogManager manager, Name group, Name name, i\n                 }\n                 tailer.seek(logOffset);\n                 movedOffset = true;\n-                log.info(String.format(\"# Set log %s, group: %s, to offset %s\", labelFor(name, part), group,\n+                log.warn(String.format(\"# Set log %s, group: %s, to offset %s\", labelFor(name, part), group,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e029664a0dec10d75673df5c8bd083068acb03d4"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIyMjc4Nw==", "bodyText": "Do we want:\nlog.error(\"Interrupted\", e);\n\n?", "url": "https://github.com/nuxeo/nuxeo/pull/4127#discussion_r437222787", "createdAt": "2020-06-09T08:19:46Z", "author": {"login": "ataillefer"}, "path": "modules/runtime/nuxeo-stream/src/main/java/org/nuxeo/lib/stream/tools/command/PositionCommand.java", "diffHunk": "@@ -280,4 +292,38 @@ protected LogOffset searchWatermarkOffset(LogTailer<Record> tailer, long timesta\n         return lastOffset;\n     }\n \n+    protected boolean positionToOffset(LogManager manager, Name group, Name name, int partition, long offset) {\n+        LogLag lag = getLag(manager, group, name, partition);\n+        long pos = lag.lower();\n+        boolean goToStart = false;\n+        if (offset < pos) {\n+            goToStart = true;\n+        } else if (offset == pos) {\n+            log.error(String.format(\"Current offset for group %s on %s is already %d\", group, labelFor(name, partition),\n+                    pos));\n+            return false;\n+        }\n+        try (LogTailer<Externalizable> tailer = manager.createTailer(group, LogPartition.of(name, partition))) {\n+            if (goToStart) {\n+                tailer.toStart();\n+            }\n+            for (;;) {\n+                LogRecord<Externalizable> record = tailer.read(Duration.ofSeconds(1));\n+                if (record == null || record.offset().offset() > offset) {\n+                    log.error(\"No offset found for the specified partition\");\n+                    return false;\n+                }\n+                if (record.offset().offset() == offset) {\n+                    tailer.commit();\n+                    log.warn(String.format(\"# Move group %s on %s from %d to %d\", group, labelFor(name, partition), pos,\n+                            offset));\n+                    return true;\n+                }\n+            }\n+        } catch (InterruptedException e) {\n+            Thread.currentThread().interrupt();\n+            log.error(\"Interrupted\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e029664a0dec10d75673df5c8bd083068acb03d4"}, "originalPosition": 85}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8617068112d9afc7c5612ad939463eabc79aa9a6", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/8617068112d9afc7c5612ad939463eabc79aa9a6", "committedDate": "2020-06-08T13:51:05Z", "message": "NXP-28877: Use a more compact Name rendering\n\nbecause the toString is used on stream.sh tool output"}, "afterCommit": {"oid": "dea8c60a4be83ea178cbd2078784e23b109de16e", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/dea8c60a4be83ea178cbd2078784e23b109de16e", "committedDate": "2020-07-03T15:43:27Z", "message": "NXP-29108: Use an explicit transaction timeout for the bulk scroll computation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dea8c60a4be83ea178cbd2078784e23b109de16e", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/dea8c60a4be83ea178cbd2078784e23b109de16e", "committedDate": "2020-07-03T15:43:27Z", "message": "NXP-29108: Use an explicit transaction timeout for the bulk scroll computation"}, "afterCommit": {"oid": "2e868d44d4b1a12a98fb54b185451dc52e3d4882", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/2e868d44d4b1a12a98fb54b185451dc52e3d4882", "committedDate": "2020-07-06T10:15:39Z", "message": "NXP-29108: Use an explicit transaction timeout for the bulk scroll computation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2e868d44d4b1a12a98fb54b185451dc52e3d4882", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/2e868d44d4b1a12a98fb54b185451dc52e3d4882", "committedDate": "2020-07-06T10:15:39Z", "message": "NXP-29108: Use an explicit transaction timeout for the bulk scroll computation"}, "afterCommit": {"oid": "5bf7ee55ec8bd28b6000ef25edb1d93c8ad83927", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/5bf7ee55ec8bd28b6000ef25edb1d93c8ad83927", "committedDate": "2020-07-06T10:33:43Z", "message": "NXP-29108: Use an explicit transaction timeout for the bulk scroll computation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5bf7ee55ec8bd28b6000ef25edb1d93c8ad83927", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/5bf7ee55ec8bd28b6000ef25edb1d93c8ad83927", "committedDate": "2020-07-06T10:33:43Z", "message": "NXP-29108: Use an explicit transaction timeout for the bulk scroll computation"}, "afterCommit": {"oid": "f5eed83150e6695937fb5e73cfeb5f3adfe6ad9e", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/f5eed83150e6695937fb5e73cfeb5f3adfe6ad9e", "committedDate": "2020-07-06T14:01:23Z", "message": "NXP-29108: Use an explicit transaction timeout for the bulk scroll computation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f5eed83150e6695937fb5e73cfeb5f3adfe6ad9e", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/f5eed83150e6695937fb5e73cfeb5f3adfe6ad9e", "committedDate": "2020-07-06T14:01:23Z", "message": "NXP-29108: Use an explicit transaction timeout for the bulk scroll computation"}, "afterCommit": {"oid": "714761c943c30efb301d38d2cab2fb1c9c210165", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/714761c943c30efb301d38d2cab2fb1c9c210165", "committedDate": "2020-07-06T16:32:19Z", "message": "NXP-29108: Use an explicit transaction timeout for the bulk scroll computation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "714761c943c30efb301d38d2cab2fb1c9c210165", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/714761c943c30efb301d38d2cab2fb1c9c210165", "committedDate": "2020-07-06T16:32:19Z", "message": "NXP-29108: Use an explicit transaction timeout for the bulk scroll computation"}, "afterCommit": {"oid": "91a0ac854c646914fe05cb1a69c8200d638fa015", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/91a0ac854c646914fe05cb1a69c8200d638fa015", "committedDate": "2020-07-07T07:11:16Z", "message": "NXP-29108: Bulk scroller with a long transaction\n\nWe don't want to timeout during a scroll, an explicit long\ntransaction timeout is used."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "91a0ac854c646914fe05cb1a69c8200d638fa015", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/91a0ac854c646914fe05cb1a69c8200d638fa015", "committedDate": "2020-07-07T07:11:16Z", "message": "NXP-29108: Bulk scroller with a long transaction\n\nWe don't want to timeout during a scroll, an explicit long\ntransaction timeout is used."}, "afterCommit": {"oid": "991ab47ba59e5a6794d0555591883381aaf6eadd", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/991ab47ba59e5a6794d0555591883381aaf6eadd", "committedDate": "2020-07-07T07:14:17Z", "message": "NXP-29108: Bulk scroller with a long transaction\n\nWe don't want to timeout during a scroll, an explicit long\ntransaction timeout is used."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "991ab47ba59e5a6794d0555591883381aaf6eadd", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/991ab47ba59e5a6794d0555591883381aaf6eadd", "committedDate": "2020-07-07T07:14:17Z", "message": "NXP-29108: Bulk scroller with a long transaction\n\nWe don't want to timeout during a scroll, an explicit long\ntransaction timeout is used."}, "afterCommit": {"oid": "355ba62dad1d0d6732ba9878f0cd16999f55d16a", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/355ba62dad1d0d6732ba9878f0cd16999f55d16a", "committedDate": "2020-07-07T07:20:32Z", "message": "NXP-29108: Bulk scroller with a long transaction\n\nWe don't want to timeout during a scroll, an explicit long\ntransaction timeout is used."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNjk3NDE1", "url": "https://github.com/nuxeo/nuxeo/pull/4127#pullrequestreview-443697415", "createdAt": "2020-07-07T08:59:42Z", "commit": {"oid": "355ba62dad1d0d6732ba9878f0cd16999f55d16a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwODo1OTo0MlrOGt1bOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwOTowNTowNVrOGt1ncA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcxNDQyNA==", "bodyText": "since and final?", "url": "https://github.com/nuxeo/nuxeo/pull/4127#discussion_r450714424", "createdAt": "2020-07-07T08:59:42Z", "author": {"login": "troger"}, "path": "modules/core/nuxeo-core-bulk/src/main/java/org/nuxeo/ecm/core/bulk/BulkAdminServiceImpl.java", "diffHunk": "@@ -47,11 +47,15 @@\n \n     public static final String BULK_SCROLL_PRODUCE_IMMEDIATE_PROPERTY = \"nuxeo.core.bulk.scroller.produceImmediate\";\n \n-\n     public static final int DEFAULT_SCROLL_SIZE = 100;\n \n     public static final int DEFAULT_SCROLL_KEEP_ALIVE = 60;\n \n+    // @since 11.2\n+    public static final String BULK_SCROLL_TRANSACTION_TIMEOUT_PROPERTY = \"nuxeo.core.bulk.scroller.transactionTimeout\";\n+\n+    public static Duration DEFAULT_SCROLL_TRANSACTION_TIMEOUT = Duration.ofDays(2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "355ba62dad1d0d6732ba9878f0cd16999f55d16a"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcxNzU1Mg==", "bodyText": "since", "url": "https://github.com/nuxeo/nuxeo/pull/4127#discussion_r450717552", "createdAt": "2020-07-07T09:05:05Z", "author": {"login": "troger"}, "path": "modules/runtime/nuxeo-stream/src/main/java/org/nuxeo/lib/stream/tools/command/PositionCommand.java", "diffHunk": "@@ -59,6 +59,8 @@\n \n     public static final String TO_WATERMARK_OPT = \"to-watermark\";\n \n+    public static final String TO_OFFSET_OPT = \"to-offset\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "355ba62dad1d0d6732ba9878f0cd16999f55d16a"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1282d86ec6a72b7b934d9e4901b4e034620ae5f8", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/1282d86ec6a72b7b934d9e4901b4e034620ae5f8", "committedDate": "2020-07-07T10:33:33Z", "message": "NXP-29198: Enable to move a consumer group to a specific offset"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e92a10eca54289bb5fa6f7ab1da174008ce6d0bf", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/e92a10eca54289bb5fa6f7ab1da174008ce6d0bf", "committedDate": "2020-07-07T10:33:33Z", "message": "NXP-29198: Support codec for stream.sh position to-watermark"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0c4b02ae5857141eed47eae4166a90c4bb67f1d", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/f0c4b02ae5857141eed47eae4166a90c4bb67f1d", "committedDate": "2020-07-07T10:33:33Z", "message": "NXP-29198: Add a quiet option to stream.sh lag command\n\nIt is easier to pinpoint consumer groups that lag."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0323b13ed2328a1755213cb8468e8e27a0d7c20e", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/0323b13ed2328a1755213cb8468e8e27a0d7c20e", "committedDate": "2020-07-07T10:33:33Z", "message": "NXP-28877: Use namespace also in tools and unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ed5e11a947bf8ad943dd0ac0e48c7ec74651eab", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/1ed5e11a947bf8ad943dd0ac0e48c7ec74651eab", "committedDate": "2020-07-07T10:33:33Z", "message": "NXP-28877: Use a more compact Name rendering\n\nBecause toString is used on stream.sh tool output."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22464cc688e04e419b00c9327f8607f6bb46d08e", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/22464cc688e04e419b00c9327f8607f6bb46d08e", "committedDate": "2020-07-07T10:33:33Z", "message": "NXP-29108: Bulk scroller with a long transaction\n\nWe don't want to timeout during a scroll, an explicit long\ntransaction timeout is used."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "355ba62dad1d0d6732ba9878f0cd16999f55d16a", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/355ba62dad1d0d6732ba9878f0cd16999f55d16a", "committedDate": "2020-07-07T07:20:32Z", "message": "NXP-29108: Bulk scroller with a long transaction\n\nWe don't want to timeout during a scroll, an explicit long\ntransaction timeout is used."}, "afterCommit": {"oid": "22464cc688e04e419b00c9327f8607f6bb46d08e", "author": {"user": {"login": "bdelbosc", "name": "Benoit Delbosc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/22464cc688e04e419b00c9327f8607f6bb46d08e", "committedDate": "2020-07-07T10:33:33Z", "message": "NXP-29108: Bulk scroller with a long transaction\n\nWe don't want to timeout during a scroll, an explicit long\ntransaction timeout is used."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNzg0NDg2", "url": "https://github.com/nuxeo/nuxeo/pull/4127#pullrequestreview-443784486", "createdAt": "2020-07-07T11:02:09Z", "commit": {"oid": "22464cc688e04e419b00c9327f8607f6bb46d08e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzODI0NTcx", "url": "https://github.com/nuxeo/nuxeo/pull/4127#pullrequestreview-443824571", "createdAt": "2020-07-07T12:05:01Z", "commit": {"oid": "22464cc688e04e419b00c9327f8607f6bb46d08e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzODI0ODcx", "url": "https://github.com/nuxeo/nuxeo/pull/4127#pullrequestreview-443824871", "createdAt": "2020-07-07T12:05:24Z", "commit": {"oid": "22464cc688e04e419b00c9327f8607f6bb46d08e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4703, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}