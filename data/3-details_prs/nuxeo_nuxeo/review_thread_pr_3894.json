{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5ODEwNjU5", "number": 3894, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjowOTo0MlrODvh-WA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwOTo0MDowMFrODv6ijg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTY2Mjk2OnYy", "diffSide": "RIGHT", "path": "modules/core/nuxeo-core/src/main/resources/OSGI-INF/coldstorage-contrib.xml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjowOTo0MlrOGCAdYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjowOTo0MlrOGCAdYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc1Nzg1OA==", "bodyText": "Could you change \"ColdStored\" to \"InColdStorage\"?", "url": "https://github.com/nuxeo/nuxeo/pull/3894#discussion_r404757858", "createdAt": "2020-04-07T12:09:42Z", "author": {"login": "efge"}, "path": "modules/core/nuxeo-core/src/main/resources/OSGI-INF/coldstorage-contrib.xml", "diffHunk": "@@ -14,6 +14,10 @@\n               class=\"org.nuxeo.ecm.core.coldstorage.CheckColdStorageContentAvailabilityListener\">\n       <event>checkColdStorageContentAvailability</event>\n     </listener>\n+    <listener name=\"checkUpdateMainContentColdStored\"\n+              class=\"org.nuxeo.ecm.core.coldstorage.CheckUpdateMainContentColdStored\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "836e91c3b970f2e0ef9b4a6fbf43082a4d471852"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNTQyNzcyOnYy", "diffSide": "RIGHT", "path": "modules/core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/coldstorage/CheckUpdateMainContentInColdStorage.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwODozNTowN1rOGCkuSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwODozNTowN1rOGCkuSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM1MjAxMQ==", "bodyText": "You could use document instead of its id to log more information.", "url": "https://github.com/nuxeo/nuxeo/pull/3894#discussion_r405352011", "createdAt": "2020-04-08T08:35:07Z", "author": {"login": "ataillefer"}, "path": "modules/core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/coldstorage/CheckUpdateMainContentInColdStorage.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *  \n+ * Contributors:\n+ *     Salem Aouana\n+ */\n+\n+package org.nuxeo.ecm.core.coldstorage;\n+\n+import static javax.servlet.http.HttpServletResponse.SC_FORBIDDEN;\n+\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.NuxeoException;\n+import org.nuxeo.ecm.core.api.event.CoreEventConstants;\n+import org.nuxeo.ecm.core.api.model.Property;\n+import org.nuxeo.ecm.core.blob.ColdStorageHelper;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventContext;\n+import org.nuxeo.ecm.core.event.EventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.core.schema.FacetNames;\n+\n+/**\n+ * A synchronous listener that prevents any main content document replacement when it's stored in cold storage.\n+ * \n+ * @since 11.1\n+ */\n+public class CheckUpdateMainContentInColdStorage implements EventListener {\n+\n+    @Override\n+    public void handleEvent(Event event) {\n+        EventContext eventContext = event.getContext();\n+        if (!(eventContext instanceof DocumentEventContext)) {\n+            return;\n+        }\n+\n+        DocumentModel previousDocument = (DocumentModel) eventContext.getProperty(\n+                CoreEventConstants.PREVIOUS_DOCUMENT_MODEL);\n+        if (previousDocument.hasFacet(FacetNames.COLD_STORAGE)) {\n+            if (previousDocument.getPropertyValue(ColdStorageHelper.COLD_STORAGE_CONTENT_PROPERTY) != null) {\n+                DocumentModel document = ((DocumentEventContext) eventContext).getSourceDocument();\n+                Property mainContent = document.getProperty(ColdStorageHelper.FILE_CONTENT_PROPERTY);\n+                if (mainContent.isDirty()) {\n+                    // mark the event to bubble the exception, which results on a TX rollback\n+                    event.markBubbleException();\n+                    throw new NuxeoException(String.format(\n+                            \"The main content of document: %s cannot be updated. It's already in cold storage.\",\n+                            document.getId()), SC_FORBIDDEN);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9128ed424f8002e9f671e0d364072b884ce0a68"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNTQzMzc4OnYy", "diffSide": "RIGHT", "path": "modules/core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwODozNjo0NFrOGCkyIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMToyMToyNlrOGCqr4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM1Mjk5Mw==", "bodyText": "Don't we want to use DocumentModel#refresh now @efge ?", "url": "https://github.com/nuxeo/nuxeo/pull/3894#discussion_r405352993", "createdAt": "2020-04-08T08:36:44Z", "author": {"login": "ataillefer"}, "path": "modules/core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java", "diffHunk": "@@ -244,6 +244,43 @@ public void shouldCheckAvailability() {\n         checkAvailabilityOfDocuments(Arrays.asList(documents.get(1), documents.get(2)), downloadableUntil, 0);\n     }\n \n+    @Test\n+    public void shouldFailUpdateMainContentAlreadyInColdStorage() throws IOException {\n+        // move the main content into the cold storage\n+        DocumentModel documentModel = createFileDocument(DEFAULT_DOC_NAME, true);\n+        moveAndVerifyContent(session, documentModel);\n+\n+        // we cannot update the main content as it is already in cold storage\n+        documentModel = session.getDocument(documentModel.getRef());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9128ed424f8002e9f671e0d364072b884ce0a68"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ0OTY5OA==", "bodyText": "Yes it's shorter and more explicit but no big deal.", "url": "https://github.com/nuxeo/nuxeo/pull/3894#discussion_r405449698", "createdAt": "2020-04-08T11:21:26Z", "author": {"login": "efge"}, "path": "modules/core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java", "diffHunk": "@@ -244,6 +244,43 @@ public void shouldCheckAvailability() {\n         checkAvailabilityOfDocuments(Arrays.asList(documents.get(1), documents.get(2)), downloadableUntil, 0);\n     }\n \n+    @Test\n+    public void shouldFailUpdateMainContentAlreadyInColdStorage() throws IOException {\n+        // move the main content into the cold storage\n+        DocumentModel documentModel = createFileDocument(DEFAULT_DOC_NAME, true);\n+        moveAndVerifyContent(session, documentModel);\n+\n+        // we cannot update the main content as it is already in cold storage\n+        documentModel = session.getDocument(documentModel.getRef());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM1Mjk5Mw=="}, "originalCommit": {"oid": "f9128ed424f8002e9f671e0d364072b884ce0a68"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNTQzNjE0OnYy", "diffSide": "RIGHT", "path": "modules/core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwODozNzoyNlrOGCkzqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwODozNzoyNlrOGCkzqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM1MzM4NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // but we should be able to update the others properties even the attachments\n          \n          \n            \n                    // but we should be able to update the other properties, even the attachments", "url": "https://github.com/nuxeo/nuxeo/pull/3894#discussion_r405353384", "createdAt": "2020-04-08T08:37:26Z", "author": {"login": "ataillefer"}, "path": "modules/core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java", "diffHunk": "@@ -244,6 +244,43 @@ public void shouldCheckAvailability() {\n         checkAvailabilityOfDocuments(Arrays.asList(documents.get(1), documents.get(2)), downloadableUntil, 0);\n     }\n \n+    @Test\n+    public void shouldFailUpdateMainContentAlreadyInColdStorage() throws IOException {\n+        // move the main content into the cold storage\n+        DocumentModel documentModel = createFileDocument(DEFAULT_DOC_NAME, true);\n+        moveAndVerifyContent(session, documentModel);\n+\n+        // we cannot update the main content as it is already in cold storage\n+        documentModel = session.getDocument(documentModel.getRef());\n+        documentModel.setPropertyValue(ColdStorageHelper.FILE_CONTENT_PROPERTY,\n+                (Serializable) Blobs.createBlob(FILE_CONTENT));\n+        try {\n+            session.saveDocument(documentModel);\n+            fail(\"Should fail because a main content document in cold storage cannot be updated.\");\n+        } catch (NuxeoException e) {\n+            assertEquals(SC_FORBIDDEN, e.getStatusCode());\n+            assertEquals(\n+                    String.format(\"The main content of document: %s cannot be updated. It's already in cold storage.\",\n+                            documentModel.getId()),\n+                    e.getMessage());\n+        }\n+\n+        // but we should be able to update the others properties even the attachments", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9128ed424f8002e9f671e0d364072b884ce0a68"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNTQzNzc3OnYy", "diffSide": "RIGHT", "path": "modules/core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwODozNzo1MFrOGCk0pQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwOTowMzowM1rOGCl0gA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM1MzYzNw==", "bodyText": "not necessary I believe", "url": "https://github.com/nuxeo/nuxeo/pull/3894#discussion_r405353637", "createdAt": "2020-04-08T08:37:50Z", "author": {"login": "ataillefer"}, "path": "modules/core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java", "diffHunk": "@@ -244,6 +244,43 @@ public void shouldCheckAvailability() {\n         checkAvailabilityOfDocuments(Arrays.asList(documents.get(1), documents.get(2)), downloadableUntil, 0);\n     }\n \n+    @Test\n+    public void shouldFailUpdateMainContentAlreadyInColdStorage() throws IOException {\n+        // move the main content into the cold storage\n+        DocumentModel documentModel = createFileDocument(DEFAULT_DOC_NAME, true);\n+        moveAndVerifyContent(session, documentModel);\n+\n+        // we cannot update the main content as it is already in cold storage\n+        documentModel = session.getDocument(documentModel.getRef());\n+        documentModel.setPropertyValue(ColdStorageHelper.FILE_CONTENT_PROPERTY,\n+                (Serializable) Blobs.createBlob(FILE_CONTENT));\n+        try {\n+            session.saveDocument(documentModel);\n+            fail(\"Should fail because a main content document in cold storage cannot be updated.\");\n+        } catch (NuxeoException e) {\n+            assertEquals(SC_FORBIDDEN, e.getStatusCode());\n+            assertEquals(\n+                    String.format(\"The main content of document: %s cannot be updated. It's already in cold storage.\",\n+                            documentModel.getId()),\n+                    e.getMessage());\n+        }\n+\n+        // but we should be able to update the others properties even the attachments\n+        documentModel = session.getDocument(documentModel.getRef());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9128ed424f8002e9f671e0d364072b884ce0a68"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM2NzUzOA==", "bodyText": "the reload of the document is needed otherwise my test fail, because before this part of the test I tried to update the blob, if i don't reload it i will find myself with a document contains the new blob.", "url": "https://github.com/nuxeo/nuxeo/pull/3894#discussion_r405367538", "createdAt": "2020-04-08T08:59:26Z", "author": {"login": "RSalem07"}, "path": "modules/core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java", "diffHunk": "@@ -244,6 +244,43 @@ public void shouldCheckAvailability() {\n         checkAvailabilityOfDocuments(Arrays.asList(documents.get(1), documents.get(2)), downloadableUntil, 0);\n     }\n \n+    @Test\n+    public void shouldFailUpdateMainContentAlreadyInColdStorage() throws IOException {\n+        // move the main content into the cold storage\n+        DocumentModel documentModel = createFileDocument(DEFAULT_DOC_NAME, true);\n+        moveAndVerifyContent(session, documentModel);\n+\n+        // we cannot update the main content as it is already in cold storage\n+        documentModel = session.getDocument(documentModel.getRef());\n+        documentModel.setPropertyValue(ColdStorageHelper.FILE_CONTENT_PROPERTY,\n+                (Serializable) Blobs.createBlob(FILE_CONTENT));\n+        try {\n+            session.saveDocument(documentModel);\n+            fail(\"Should fail because a main content document in cold storage cannot be updated.\");\n+        } catch (NuxeoException e) {\n+            assertEquals(SC_FORBIDDEN, e.getStatusCode());\n+            assertEquals(\n+                    String.format(\"The main content of document: %s cannot be updated. It's already in cold storage.\",\n+                            documentModel.getId()),\n+                    e.getMessage());\n+        }\n+\n+        // but we should be able to update the others properties even the attachments\n+        documentModel = session.getDocument(documentModel.getRef());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM1MzYzNw=="}, "originalCommit": {"oid": "f9128ed424f8002e9f671e0d364072b884ce0a68"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM2OTk4NA==", "bodyText": "but we can use refresh instead of the getDocument", "url": "https://github.com/nuxeo/nuxeo/pull/3894#discussion_r405369984", "createdAt": "2020-04-08T09:03:03Z", "author": {"login": "RSalem07"}, "path": "modules/core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java", "diffHunk": "@@ -244,6 +244,43 @@ public void shouldCheckAvailability() {\n         checkAvailabilityOfDocuments(Arrays.asList(documents.get(1), documents.get(2)), downloadableUntil, 0);\n     }\n \n+    @Test\n+    public void shouldFailUpdateMainContentAlreadyInColdStorage() throws IOException {\n+        // move the main content into the cold storage\n+        DocumentModel documentModel = createFileDocument(DEFAULT_DOC_NAME, true);\n+        moveAndVerifyContent(session, documentModel);\n+\n+        // we cannot update the main content as it is already in cold storage\n+        documentModel = session.getDocument(documentModel.getRef());\n+        documentModel.setPropertyValue(ColdStorageHelper.FILE_CONTENT_PROPERTY,\n+                (Serializable) Blobs.createBlob(FILE_CONTENT));\n+        try {\n+            session.saveDocument(documentModel);\n+            fail(\"Should fail because a main content document in cold storage cannot be updated.\");\n+        } catch (NuxeoException e) {\n+            assertEquals(SC_FORBIDDEN, e.getStatusCode());\n+            assertEquals(\n+                    String.format(\"The main content of document: %s cannot be updated. It's already in cold storage.\",\n+                            documentModel.getId()),\n+                    e.getMessage());\n+        }\n+\n+        // but we should be able to update the others properties even the attachments\n+        documentModel = session.getDocument(documentModel.getRef());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM1MzYzNw=="}, "originalCommit": {"oid": "f9128ed424f8002e9f671e0d364072b884ce0a68"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNTQ1MzE5OnYy", "diffSide": "RIGHT", "path": "modules/core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwODo0MTozNlrOGCk-SA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMTo1MDowNFrOGCrk9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM1NjEwNA==", "bodyText": "Could we use CollecitonUtils.isEqualCollection here?", "url": "https://github.com/nuxeo/nuxeo/pull/3894#discussion_r405356104", "createdAt": "2020-04-08T08:41:36Z", "author": {"login": "ataillefer"}, "path": "modules/core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java", "diffHunk": "@@ -244,6 +244,43 @@ public void shouldCheckAvailability() {\n         checkAvailabilityOfDocuments(Arrays.asList(documents.get(1), documents.get(2)), downloadableUntil, 0);\n     }\n \n+    @Test\n+    public void shouldFailUpdateMainContentAlreadyInColdStorage() throws IOException {\n+        // move the main content into the cold storage\n+        DocumentModel documentModel = createFileDocument(DEFAULT_DOC_NAME, true);\n+        moveAndVerifyContent(session, documentModel);\n+\n+        // we cannot update the main content as it is already in cold storage\n+        documentModel = session.getDocument(documentModel.getRef());\n+        documentModel.setPropertyValue(ColdStorageHelper.FILE_CONTENT_PROPERTY,\n+                (Serializable) Blobs.createBlob(FILE_CONTENT));\n+        try {\n+            session.saveDocument(documentModel);\n+            fail(\"Should fail because a main content document in cold storage cannot be updated.\");\n+        } catch (NuxeoException e) {\n+            assertEquals(SC_FORBIDDEN, e.getStatusCode());\n+            assertEquals(\n+                    String.format(\"The main content of document: %s cannot be updated. It's already in cold storage.\",\n+                            documentModel.getId()),\n+                    e.getMessage());\n+        }\n+\n+        // but we should be able to update the others properties even the attachments\n+        documentModel = session.getDocument(documentModel.getRef());\n+        documentModel.setPropertyValue(\"dc:title\", \"I update the title\");\n+        documentModel.setPropertyValue(\"dc:description\", \"I add a description\");\n+        var attachments = List.of(Map.of(\"file\", Blobs.createBlob(\"bar\", \"text/plain\")));\n+        documentModel.setPropertyValue(\"files:files\", (Serializable) attachments);\n+\n+        documentModel = session.saveDocument(documentModel);\n+        assertEquals(\"I update the title\", documentModel.getPropertyValue(\"dc:title\"));\n+        assertEquals(\"I add a description\", documentModel.getPropertyValue(\"dc:description\"));\n+        attachments = (List<Map<String, Blob>>) documentModel.getPropertyValue(\"files:files\");\n+        assertEquals(1, attachments.size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9128ed424f8002e9f671e0d364072b884ce0a68"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM3NDU2OQ==", "bodyText": "yep \ud83d\udc4d and i tried using directly the org.junit.Assert#assertEquals(java.lang.Object, java.lang.Object) and it works fine. if you agree i can use it.", "url": "https://github.com/nuxeo/nuxeo/pull/3894#discussion_r405374569", "createdAt": "2020-04-08T09:09:55Z", "author": {"login": "RSalem07"}, "path": "modules/core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java", "diffHunk": "@@ -244,6 +244,43 @@ public void shouldCheckAvailability() {\n         checkAvailabilityOfDocuments(Arrays.asList(documents.get(1), documents.get(2)), downloadableUntil, 0);\n     }\n \n+    @Test\n+    public void shouldFailUpdateMainContentAlreadyInColdStorage() throws IOException {\n+        // move the main content into the cold storage\n+        DocumentModel documentModel = createFileDocument(DEFAULT_DOC_NAME, true);\n+        moveAndVerifyContent(session, documentModel);\n+\n+        // we cannot update the main content as it is already in cold storage\n+        documentModel = session.getDocument(documentModel.getRef());\n+        documentModel.setPropertyValue(ColdStorageHelper.FILE_CONTENT_PROPERTY,\n+                (Serializable) Blobs.createBlob(FILE_CONTENT));\n+        try {\n+            session.saveDocument(documentModel);\n+            fail(\"Should fail because a main content document in cold storage cannot be updated.\");\n+        } catch (NuxeoException e) {\n+            assertEquals(SC_FORBIDDEN, e.getStatusCode());\n+            assertEquals(\n+                    String.format(\"The main content of document: %s cannot be updated. It's already in cold storage.\",\n+                            documentModel.getId()),\n+                    e.getMessage());\n+        }\n+\n+        // but we should be able to update the others properties even the attachments\n+        documentModel = session.getDocument(documentModel.getRef());\n+        documentModel.setPropertyValue(\"dc:title\", \"I update the title\");\n+        documentModel.setPropertyValue(\"dc:description\", \"I add a description\");\n+        var attachments = List.of(Map.of(\"file\", Blobs.createBlob(\"bar\", \"text/plain\")));\n+        documentModel.setPropertyValue(\"files:files\", (Serializable) attachments);\n+\n+        documentModel = session.saveDocument(documentModel);\n+        assertEquals(\"I update the title\", documentModel.getPropertyValue(\"dc:title\"));\n+        assertEquals(\"I add a description\", documentModel.getPropertyValue(\"dc:description\"));\n+        attachments = (List<Map<String, Blob>>) documentModel.getPropertyValue(\"files:files\");\n+        assertEquals(1, attachments.size());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM1NjEwNA=="}, "originalCommit": {"oid": "f9128ed424f8002e9f671e0d364072b884ce0a68"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM4NDYxNA==", "bodyText": "I would suggest using CollectionUtils otherwise we're relying on the equals method of the asserted object. This could not work as expected, in our case, we probably have an ArrayList which has a correct equals implementation. But we shouldn't leverage it.", "url": "https://github.com/nuxeo/nuxeo/pull/3894#discussion_r405384614", "createdAt": "2020-04-08T09:25:42Z", "author": {"login": "kevinleturc"}, "path": "modules/core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java", "diffHunk": "@@ -244,6 +244,43 @@ public void shouldCheckAvailability() {\n         checkAvailabilityOfDocuments(Arrays.asList(documents.get(1), documents.get(2)), downloadableUntil, 0);\n     }\n \n+    @Test\n+    public void shouldFailUpdateMainContentAlreadyInColdStorage() throws IOException {\n+        // move the main content into the cold storage\n+        DocumentModel documentModel = createFileDocument(DEFAULT_DOC_NAME, true);\n+        moveAndVerifyContent(session, documentModel);\n+\n+        // we cannot update the main content as it is already in cold storage\n+        documentModel = session.getDocument(documentModel.getRef());\n+        documentModel.setPropertyValue(ColdStorageHelper.FILE_CONTENT_PROPERTY,\n+                (Serializable) Blobs.createBlob(FILE_CONTENT));\n+        try {\n+            session.saveDocument(documentModel);\n+            fail(\"Should fail because a main content document in cold storage cannot be updated.\");\n+        } catch (NuxeoException e) {\n+            assertEquals(SC_FORBIDDEN, e.getStatusCode());\n+            assertEquals(\n+                    String.format(\"The main content of document: %s cannot be updated. It's already in cold storage.\",\n+                            documentModel.getId()),\n+                    e.getMessage());\n+        }\n+\n+        // but we should be able to update the others properties even the attachments\n+        documentModel = session.getDocument(documentModel.getRef());\n+        documentModel.setPropertyValue(\"dc:title\", \"I update the title\");\n+        documentModel.setPropertyValue(\"dc:description\", \"I add a description\");\n+        var attachments = List.of(Map.of(\"file\", Blobs.createBlob(\"bar\", \"text/plain\")));\n+        documentModel.setPropertyValue(\"files:files\", (Serializable) attachments);\n+\n+        documentModel = session.saveDocument(documentModel);\n+        assertEquals(\"I update the title\", documentModel.getPropertyValue(\"dc:title\"));\n+        assertEquals(\"I add a description\", documentModel.getPropertyValue(\"dc:description\"));\n+        attachments = (List<Map<String, Blob>>) documentModel.getPropertyValue(\"files:files\");\n+        assertEquals(1, attachments.size());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM1NjEwNA=="}, "originalCommit": {"oid": "f9128ed424f8002e9f671e0d364072b884ce0a68"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ0OTQxNQ==", "bodyText": "For collections I don't see a problem with using assertEquals, their equals method are supposed to do the right thing by definition.", "url": "https://github.com/nuxeo/nuxeo/pull/3894#discussion_r405449415", "createdAt": "2020-04-08T11:20:48Z", "author": {"login": "efge"}, "path": "modules/core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java", "diffHunk": "@@ -244,6 +244,43 @@ public void shouldCheckAvailability() {\n         checkAvailabilityOfDocuments(Arrays.asList(documents.get(1), documents.get(2)), downloadableUntil, 0);\n     }\n \n+    @Test\n+    public void shouldFailUpdateMainContentAlreadyInColdStorage() throws IOException {\n+        // move the main content into the cold storage\n+        DocumentModel documentModel = createFileDocument(DEFAULT_DOC_NAME, true);\n+        moveAndVerifyContent(session, documentModel);\n+\n+        // we cannot update the main content as it is already in cold storage\n+        documentModel = session.getDocument(documentModel.getRef());\n+        documentModel.setPropertyValue(ColdStorageHelper.FILE_CONTENT_PROPERTY,\n+                (Serializable) Blobs.createBlob(FILE_CONTENT));\n+        try {\n+            session.saveDocument(documentModel);\n+            fail(\"Should fail because a main content document in cold storage cannot be updated.\");\n+        } catch (NuxeoException e) {\n+            assertEquals(SC_FORBIDDEN, e.getStatusCode());\n+            assertEquals(\n+                    String.format(\"The main content of document: %s cannot be updated. It's already in cold storage.\",\n+                            documentModel.getId()),\n+                    e.getMessage());\n+        }\n+\n+        // but we should be able to update the others properties even the attachments\n+        documentModel = session.getDocument(documentModel.getRef());\n+        documentModel.setPropertyValue(\"dc:title\", \"I update the title\");\n+        documentModel.setPropertyValue(\"dc:description\", \"I add a description\");\n+        var attachments = List.of(Map.of(\"file\", Blobs.createBlob(\"bar\", \"text/plain\")));\n+        documentModel.setPropertyValue(\"files:files\", (Serializable) attachments);\n+\n+        documentModel = session.saveDocument(documentModel);\n+        assertEquals(\"I update the title\", documentModel.getPropertyValue(\"dc:title\"));\n+        assertEquals(\"I add a description\", documentModel.getPropertyValue(\"dc:description\"));\n+        attachments = (List<Map<String, Blob>>) documentModel.getPropertyValue(\"files:files\");\n+        assertEquals(1, attachments.size());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM1NjEwNA=="}, "originalCommit": {"oid": "f9128ed424f8002e9f671e0d364072b884ce0a68"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ2MzkzMw==", "bodyText": "I agree with you that almost all implementations have a good implementation for equals, but not all. Which forces us to use CollectionUtils if we want a coding convention.", "url": "https://github.com/nuxeo/nuxeo/pull/3894#discussion_r405463933", "createdAt": "2020-04-08T11:49:21Z", "author": {"login": "kevinleturc"}, "path": "modules/core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java", "diffHunk": "@@ -244,6 +244,43 @@ public void shouldCheckAvailability() {\n         checkAvailabilityOfDocuments(Arrays.asList(documents.get(1), documents.get(2)), downloadableUntil, 0);\n     }\n \n+    @Test\n+    public void shouldFailUpdateMainContentAlreadyInColdStorage() throws IOException {\n+        // move the main content into the cold storage\n+        DocumentModel documentModel = createFileDocument(DEFAULT_DOC_NAME, true);\n+        moveAndVerifyContent(session, documentModel);\n+\n+        // we cannot update the main content as it is already in cold storage\n+        documentModel = session.getDocument(documentModel.getRef());\n+        documentModel.setPropertyValue(ColdStorageHelper.FILE_CONTENT_PROPERTY,\n+                (Serializable) Blobs.createBlob(FILE_CONTENT));\n+        try {\n+            session.saveDocument(documentModel);\n+            fail(\"Should fail because a main content document in cold storage cannot be updated.\");\n+        } catch (NuxeoException e) {\n+            assertEquals(SC_FORBIDDEN, e.getStatusCode());\n+            assertEquals(\n+                    String.format(\"The main content of document: %s cannot be updated. It's already in cold storage.\",\n+                            documentModel.getId()),\n+                    e.getMessage());\n+        }\n+\n+        // but we should be able to update the others properties even the attachments\n+        documentModel = session.getDocument(documentModel.getRef());\n+        documentModel.setPropertyValue(\"dc:title\", \"I update the title\");\n+        documentModel.setPropertyValue(\"dc:description\", \"I add a description\");\n+        var attachments = List.of(Map.of(\"file\", Blobs.createBlob(\"bar\", \"text/plain\")));\n+        documentModel.setPropertyValue(\"files:files\", (Serializable) attachments);\n+\n+        documentModel = session.saveDocument(documentModel);\n+        assertEquals(\"I update the title\", documentModel.getPropertyValue(\"dc:title\"));\n+        assertEquals(\"I add a description\", documentModel.getPropertyValue(\"dc:description\"));\n+        attachments = (List<Map<String, Blob>>) documentModel.getPropertyValue(\"files:files\");\n+        assertEquals(1, attachments.size());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM1NjEwNA=="}, "originalCommit": {"oid": "f9128ed424f8002e9f671e0d364072b884ce0a68"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ2NDMxMA==", "bodyText": "I'm happy to discuss this.", "url": "https://github.com/nuxeo/nuxeo/pull/3894#discussion_r405464310", "createdAt": "2020-04-08T11:50:04Z", "author": {"login": "kevinleturc"}, "path": "modules/core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java", "diffHunk": "@@ -244,6 +244,43 @@ public void shouldCheckAvailability() {\n         checkAvailabilityOfDocuments(Arrays.asList(documents.get(1), documents.get(2)), downloadableUntil, 0);\n     }\n \n+    @Test\n+    public void shouldFailUpdateMainContentAlreadyInColdStorage() throws IOException {\n+        // move the main content into the cold storage\n+        DocumentModel documentModel = createFileDocument(DEFAULT_DOC_NAME, true);\n+        moveAndVerifyContent(session, documentModel);\n+\n+        // we cannot update the main content as it is already in cold storage\n+        documentModel = session.getDocument(documentModel.getRef());\n+        documentModel.setPropertyValue(ColdStorageHelper.FILE_CONTENT_PROPERTY,\n+                (Serializable) Blobs.createBlob(FILE_CONTENT));\n+        try {\n+            session.saveDocument(documentModel);\n+            fail(\"Should fail because a main content document in cold storage cannot be updated.\");\n+        } catch (NuxeoException e) {\n+            assertEquals(SC_FORBIDDEN, e.getStatusCode());\n+            assertEquals(\n+                    String.format(\"The main content of document: %s cannot be updated. It's already in cold storage.\",\n+                            documentModel.getId()),\n+                    e.getMessage());\n+        }\n+\n+        // but we should be able to update the others properties even the attachments\n+        documentModel = session.getDocument(documentModel.getRef());\n+        documentModel.setPropertyValue(\"dc:title\", \"I update the title\");\n+        documentModel.setPropertyValue(\"dc:description\", \"I add a description\");\n+        var attachments = List.of(Map.of(\"file\", Blobs.createBlob(\"bar\", \"text/plain\")));\n+        documentModel.setPropertyValue(\"files:files\", (Serializable) attachments);\n+\n+        documentModel = session.saveDocument(documentModel);\n+        assertEquals(\"I update the title\", documentModel.getPropertyValue(\"dc:title\"));\n+        assertEquals(\"I add a description\", documentModel.getPropertyValue(\"dc:description\"));\n+        attachments = (List<Map<String, Blob>>) documentModel.getPropertyValue(\"files:files\");\n+        assertEquals(1, attachments.size());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM1NjEwNA=="}, "originalCommit": {"oid": "f9128ed424f8002e9f671e0d364072b884ce0a68"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNTYzNjQ4OnYy", "diffSide": "RIGHT", "path": "modules/core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/coldstorage/CheckUpdateMainContentInColdStorage.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwOToyNjo0OVrOGCmwfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwOToyNjo0OVrOGCmwfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM4NTM0MQ==", "bodyText": "Those if could be merged.", "url": "https://github.com/nuxeo/nuxeo/pull/3894#discussion_r405385341", "createdAt": "2020-04-08T09:26:49Z", "author": {"login": "troger"}, "path": "modules/core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/coldstorage/CheckUpdateMainContentInColdStorage.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *  \n+ * Contributors:\n+ *     Salem Aouana\n+ */\n+\n+package org.nuxeo.ecm.core.coldstorage;\n+\n+import static javax.servlet.http.HttpServletResponse.SC_FORBIDDEN;\n+\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.NuxeoException;\n+import org.nuxeo.ecm.core.api.event.CoreEventConstants;\n+import org.nuxeo.ecm.core.api.model.Property;\n+import org.nuxeo.ecm.core.blob.ColdStorageHelper;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventContext;\n+import org.nuxeo.ecm.core.event.EventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.core.schema.FacetNames;\n+\n+/**\n+ * A synchronous listener that prevents any main content document replacement when it's stored in cold storage.\n+ * \n+ * @since 11.1\n+ */\n+public class CheckUpdateMainContentInColdStorage implements EventListener {\n+\n+    @Override\n+    public void handleEvent(Event event) {\n+        EventContext eventContext = event.getContext();\n+        if (!(eventContext instanceof DocumentEventContext)) {\n+            return;\n+        }\n+\n+        DocumentModel previousDocument = (DocumentModel) eventContext.getProperty(\n+                CoreEventConstants.PREVIOUS_DOCUMENT_MODEL);\n+        if (previousDocument.hasFacet(FacetNames.COLD_STORAGE)) {\n+            if (previousDocument.getPropertyValue(ColdStorageHelper.COLD_STORAGE_CONTENT_PROPERTY) != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a730be05e395fcea5ab92dfca797081ec20b302"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNTY4NzgyOnYy", "diffSide": "RIGHT", "path": "modules/core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/coldstorage/CheckUpdateMainContentInColdStorage.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwOTo0MDowMFrOGCnRHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwOTo0MDowMFrOGCnRHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM5MzY5NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * A synchronous listener that prevents any main content document replacement when it's stored in cold storage.\n          \n          \n            \n             * A synchronous listener that prevents any document's main content replacement when it's stored in cold storage.\n          \n      \n    \n    \n  \n\nOr just\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * A synchronous listener that prevents any main content document replacement when it's stored in cold storage.\n          \n          \n            \n             * A synchronous listener that prevents any main content replacement when it's stored in cold storage.", "url": "https://github.com/nuxeo/nuxeo/pull/3894#discussion_r405393694", "createdAt": "2020-04-08T09:40:00Z", "author": {"login": "troger"}, "path": "modules/core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/coldstorage/CheckUpdateMainContentInColdStorage.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *  \n+ * Contributors:\n+ *     Salem Aouana\n+ */\n+\n+package org.nuxeo.ecm.core.coldstorage;\n+\n+import static javax.servlet.http.HttpServletResponse.SC_FORBIDDEN;\n+\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.NuxeoException;\n+import org.nuxeo.ecm.core.api.event.CoreEventConstants;\n+import org.nuxeo.ecm.core.api.model.Property;\n+import org.nuxeo.ecm.core.blob.ColdStorageHelper;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventContext;\n+import org.nuxeo.ecm.core.event.EventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+import org.nuxeo.ecm.core.schema.FacetNames;\n+\n+/**\n+ * A synchronous listener that prevents any main content document replacement when it's stored in cold storage.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77d9b81ab84cb759d257eb743bf6d6a913e49522"}, "originalPosition": 36}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4195, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}