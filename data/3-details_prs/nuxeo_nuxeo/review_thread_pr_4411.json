{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4Mzc1MDkw", "number": 4411, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMDo0MTowN1rOEySMqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjo0NTozM1rOE1vrfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMTYyNDA5OnYy", "diffSide": "RIGHT", "path": "modules/core/nuxeo-core-storage/src/main/java/org/nuxeo/ecm/core/storage/BaseDocument.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMDo0MTowN1rOHo1haA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjoyOTo1NlrOHuLm_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU4MTk5Mg==", "bodyText": "Not sure if I'm seeing this correctly but, would it make sense to just declare key and call setPropertyValue inside the try block?", "url": "https://github.com/nuxeo/nuxeo/pull/4411#discussion_r512581992", "createdAt": "2020-10-27T10:41:07Z", "author": {"login": "nmpcunha"}, "path": "modules/core/nuxeo-core-storage/src/main/java/org/nuxeo/ecm/core/storage/BaseDocument.java", "diffHunk": "@@ -691,17 +691,13 @@ protected void setValueBlob(T state, Blob blob, String xpath) throws PropertyExc\n     }\n \n     protected void setPropertyBlobData(String xpath, String string) {\n+        Blob blob = StringUtils.isNotEmpty(string) ? Blobs.createBlob(string) : null;\n+        DocumentBlobManager blobManager = Framework.getService(DocumentBlobManager.class);\n         String key;\n-        if (string == null) {\n-            key = null;\n-        } else {\n-            Blob blob = Blobs.createBlob(string);\n-            DocumentBlobManager blobManager = Framework.getService(DocumentBlobManager.class);\n-            try {\n-                key = blobManager.writeBlob(blob, this, xpath);\n-            } catch (IOException e) {\n-                throw new PropertyException(\"Cannot write binary for doc: \" + getUUID(), e);\n-            }\n+        try {\n+            key = blobManager.writeBlob(blob, this, xpath);\n+        } catch (IOException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b65f2dd57707081d3f7451f90dc96ea01e8df7c5"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE4Njc0OA==", "bodyText": "It's preferable to have try/catch blocks cover just what's needed and nothing more.", "url": "https://github.com/nuxeo/nuxeo/pull/4411#discussion_r518186748", "createdAt": "2020-11-05T16:29:56Z", "author": {"login": "efge"}, "path": "modules/core/nuxeo-core-storage/src/main/java/org/nuxeo/ecm/core/storage/BaseDocument.java", "diffHunk": "@@ -691,17 +691,13 @@ protected void setValueBlob(T state, Blob blob, String xpath) throws PropertyExc\n     }\n \n     protected void setPropertyBlobData(String xpath, String string) {\n+        Blob blob = StringUtils.isNotEmpty(string) ? Blobs.createBlob(string) : null;\n+        DocumentBlobManager blobManager = Framework.getService(DocumentBlobManager.class);\n         String key;\n-        if (string == null) {\n-            key = null;\n-        } else {\n-            Blob blob = Blobs.createBlob(string);\n-            DocumentBlobManager blobManager = Framework.getService(DocumentBlobManager.class);\n-            try {\n-                key = blobManager.writeBlob(blob, this, xpath);\n-            } catch (IOException e) {\n-                throw new PropertyException(\"Cannot write binary for doc: \" + getUUID(), e);\n-            }\n+        try {\n+            key = blobManager.writeBlob(blob, this, xpath);\n+        } catch (IOException e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU4MTk5Mg=="}, "originalCommit": {"oid": "b65f2dd57707081d3f7451f90dc96ea01e8df7c5"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMTYzOTAwOnYy", "diffSide": "RIGHT", "path": "modules/core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/blob/DocumentBlobManagerComponent.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMDo0NDo1NVrOHo1qpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNjoxMjo1NlrOHpEqOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU4NDM1OA==", "bodyText": "IIRC it is only about file:content, right? Other blobs can be modified if a document is under retention?", "url": "https://github.com/nuxeo/nuxeo/pull/4411#discussion_r512584358", "createdAt": "2020-10-27T10:44:55Z", "author": {"login": "nmpcunha"}, "path": "modules/core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/blob/DocumentBlobManagerComponent.java", "diffHunk": "@@ -182,6 +182,14 @@ protected BlobProvider getBlobProvider(String key, String repositoryName) {\n      */\n     @Override\n     public String writeBlob(Blob blob, Document doc, String xpath) throws IOException {\n+        if (blob == null) {\n+            if (MAIN_BLOB_XPATH.equals(xpath) && doc.isUnderRetentionOrLegalHold()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b65f2dd57707081d3f7451f90dc96ea01e8df7c5"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgzMDAwOA==", "bodyText": "Yes, I reused almost the same check, initially I extract it as a variable but some tests failed, and just let copy the same check. And file:content I think so I discussed with Julien (you can find more on Slack on our discussion)", "url": "https://github.com/nuxeo/nuxeo/pull/4411#discussion_r512830008", "createdAt": "2020-10-27T16:12:56Z", "author": {"login": "RSalem07"}, "path": "modules/core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/blob/DocumentBlobManagerComponent.java", "diffHunk": "@@ -182,6 +182,14 @@ protected BlobProvider getBlobProvider(String key, String repositoryName) {\n      */\n     @Override\n     public String writeBlob(Blob blob, Document doc, String xpath) throws IOException {\n+        if (blob == null) {\n+            if (MAIN_BLOB_XPATH.equals(xpath) && doc.isUnderRetentionOrLegalHold()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU4NDM1OA=="}, "originalCommit": {"oid": "b65f2dd57707081d3f7451f90dc96ea01e8df7c5"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMTYxMDE5OnYy", "diffSide": "RIGHT", "path": "modules/core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/blob/DocumentBlobManagerComponent.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxMDozMzozMVrOHqVqXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjozMzo0MFrOHuLx2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE1NzE1MA==", "bodyText": "What do you think about adding a new API such as isBlobWriteable which does this check, and maybe the one l. 211(?), in order to avoid to allow null values for blob in this API?", "url": "https://github.com/nuxeo/nuxeo/pull/4411#discussion_r514157150", "createdAt": "2020-10-29T10:33:31Z", "author": {"login": "kevinleturc"}, "path": "modules/core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/blob/DocumentBlobManagerComponent.java", "diffHunk": "@@ -182,6 +182,14 @@ protected BlobProvider getBlobProvider(String key, String repositoryName) {\n      */\n     @Override\n     public String writeBlob(Blob blob, Document doc, String xpath) throws IOException {\n+        if (blob == null) {\n+            if (MAIN_BLOB_XPATH.equals(xpath) && doc.isUnderRetentionOrLegalHold()) {\n+                throw new DocumentSecurityException(\n+                        \"Cannot delete blob from document \" + doc.getUUID() + \", it is under retention / hold\");\n+            }\n+            return null;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b65f2dd57707081d3f7451f90dc96ea01e8df7c5"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMwMDE1MQ==", "bodyText": "Not sure if I understood and maybe the one l. 211(?), could you please elaborate a little bit?\nRegarding the new API, would it also make sense for the 10.10 backport?\nThanks!", "url": "https://github.com/nuxeo/nuxeo/pull/4411#discussion_r514300151", "createdAt": "2020-10-29T14:26:19Z", "author": {"login": "nmpcunha"}, "path": "modules/core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/blob/DocumentBlobManagerComponent.java", "diffHunk": "@@ -182,6 +182,14 @@ protected BlobProvider getBlobProvider(String key, String repositoryName) {\n      */\n     @Override\n     public String writeBlob(Blob blob, Document doc, String xpath) throws IOException {\n+        if (blob == null) {\n+            if (MAIN_BLOB_XPATH.equals(xpath) && doc.isUnderRetentionOrLegalHold()) {\n+                throw new DocumentSecurityException(\n+                        \"Cannot delete blob from document \" + doc.getUUID() + \", it is under retention / hold\");\n+            }\n+            return null;\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE1NzE1MA=="}, "originalCommit": {"oid": "b65f2dd57707081d3f7451f90dc96ea01e8df7c5"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEwOTY0OA==", "bodyText": "Not sure if I understood and maybe the one l. 211(?), could you please elaborate a little bit?\n\nSure, I was talking about this part of the code \n  \n    \n      nuxeo/modules/core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/blob/DocumentBlobManagerComponent.java\n    \n    \n        Lines 219 to 222\n      in\n      b65f2dd\n    \n    \n    \n    \n\n        \n          \n           if (MAIN_BLOB_XPATH.equals(xpath) && blobProvider.isRecordMode() && doc.isUnderRetentionOrLegalHold()) { \n        \n\n        \n          \n               throw new DocumentSecurityException( \n        \n\n        \n          \n                       \"Cannot change blob from document \" + doc.getUUID() + \", it is under retention / hold\"); \n        \n\n        \n          \n           } \n        \n    \n  \n\n which could leverage\nthe new API.\n\nRegarding the new API, would it also make sense for the 10.10 backport?\n\nIt would make sense for the 10.10 backport if the API has a default implementation.", "url": "https://github.com/nuxeo/nuxeo/pull/4411#discussion_r518109648", "createdAt": "2020-11-05T14:51:12Z", "author": {"login": "kevinleturc"}, "path": "modules/core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/blob/DocumentBlobManagerComponent.java", "diffHunk": "@@ -182,6 +182,14 @@ protected BlobProvider getBlobProvider(String key, String repositoryName) {\n      */\n     @Override\n     public String writeBlob(Blob blob, Document doc, String xpath) throws IOException {\n+        if (blob == null) {\n+            if (MAIN_BLOB_XPATH.equals(xpath) && doc.isUnderRetentionOrLegalHold()) {\n+                throw new DocumentSecurityException(\n+                        \"Cannot delete blob from document \" + doc.getUUID() + \", it is under retention / hold\");\n+            }\n+            return null;\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE1NzE1MA=="}, "originalCommit": {"oid": "b65f2dd57707081d3f7451f90dc96ea01e8df7c5"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE4OTUyOQ==", "bodyText": "It's not clear to me on what class you want to add this new API.\nAs it's a detail, let's postpone refactorings and just do a minimal change + backport.", "url": "https://github.com/nuxeo/nuxeo/pull/4411#discussion_r518189529", "createdAt": "2020-11-05T16:33:40Z", "author": {"login": "efge"}, "path": "modules/core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/blob/DocumentBlobManagerComponent.java", "diffHunk": "@@ -182,6 +182,14 @@ protected BlobProvider getBlobProvider(String key, String repositoryName) {\n      */\n     @Override\n     public String writeBlob(Blob blob, Document doc, String xpath) throws IOException {\n+        if (blob == null) {\n+            if (MAIN_BLOB_XPATH.equals(xpath) && doc.isUnderRetentionOrLegalHold()) {\n+                throw new DocumentSecurityException(\n+                        \"Cannot delete blob from document \" + doc.getUUID() + \", it is under retention / hold\");\n+            }\n+            return null;\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE1NzE1MA=="}, "originalCommit": {"oid": "b65f2dd57707081d3f7451f90dc96ea01e8df7c5"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NzgyOTE3OnYy", "diffSide": "RIGHT", "path": "modules/core/nuxeo-core-storage/src/main/java/org/nuxeo/ecm/core/storage/BaseDocument.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjoyNzoyN1rOHuLf1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjoyNzoyN1rOHuLf1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE4NDkxNg==", "bodyText": "Testing for \"empty\" is wrong, it's legal too have a blob containing a 0-byte content.\nEven though for now this is used in cases where the difference doesn't really matter (binary fulltext), it's not the case in general.", "url": "https://github.com/nuxeo/nuxeo/pull/4411#discussion_r518184916", "createdAt": "2020-11-05T16:27:27Z", "author": {"login": "efge"}, "path": "modules/core/nuxeo-core-storage/src/main/java/org/nuxeo/ecm/core/storage/BaseDocument.java", "diffHunk": "@@ -691,17 +691,13 @@ protected void setValueBlob(T state, Blob blob, String xpath) throws PropertyExc\n     }\n \n     protected void setPropertyBlobData(String xpath, String string) {\n+        Blob blob = StringUtils.isNotEmpty(string) ? Blobs.createBlob(string) : null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b65f2dd57707081d3f7451f90dc96ea01e8df7c5"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NzkxMTY2OnYy", "diffSide": "RIGHT", "path": "modules/core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/blob/DocumentBlobManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjo0NTozM1rOHuMTmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjo0NTozM1rOHuMTmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE5ODE2OQ==", "bodyText": "I added the Javadoc to.", "url": "https://github.com/nuxeo/nuxeo/pull/4411#discussion_r518198169", "createdAt": "2020-11-05T16:45:33Z", "author": {"login": "efge"}, "path": "modules/core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/blob/DocumentBlobManager.java", "diffHunk": "@@ -60,6 +60,9 @@\n \n     /**\n      * Writes a {@link Blob} to storage and returns its key.\n+     * <p>\n+     * The passed blob may be {@code null}, in which case a {@code null} key is returned after checking that deleting\n+     * this blob is allowed.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "657ef5c91333cee3e9421cf32a8235f337dbd57d"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4375, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}