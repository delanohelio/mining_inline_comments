{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExNjcyNTc1", "number": 4420, "title": "NXP-29738: Fix S3 direct upload same file import", "bodyText": "", "createdAt": "2020-10-28T16:19:46Z", "url": "https://github.com/nuxeo/nuxeo/pull/4420", "merged": true, "mergeCommit": {"oid": "e70a72e15453e31b2d327ceadcd1bf5a89f52b77"}, "closed": true, "closedAt": "2020-11-18T08:53:37Z", "author": {"login": "kevinleturc"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdax3ZDgFqTUyNjA5MzQxNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABddaci6gFqTUzMjQxODEyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MDkzNDE2", "url": "https://github.com/nuxeo/nuxeo/pull/4420#pullrequestreview-526093416", "createdAt": "2020-11-09T10:01:41Z", "commit": {"oid": "61823cd62fe9f84e2862dc8e804428e2697f3d84"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMDowMTo0MVrOHvnH7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMDowNTowM1rOHvnQHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY4NjEyNw==", "bodyText": "Could you add a Javadoc explaining that it returns the ETag of the resulting blob?", "url": "https://github.com/nuxeo/nuxeo/pull/4420#discussion_r519686127", "createdAt": "2020-11-09T10:01:41Z", "author": {"login": "efge"}, "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/main/java/org/nuxeo/ecm/core/storage/sql/S3DirectBatchHandler.java", "diffHunk": "@@ -339,6 +334,19 @@ public boolean completeUpload(String batchId, String fileIndex, BatchFileInfo fi\n         return true;\n     }\n \n+    protected String doMove(CopyObjectRequest request) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61823cd62fe9f84e2862dc8e804428e2697f3d84"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY4ODIyMg==", "bodyText": "Should we also catch AmazonS3Exception for this delete and just log a debug, like in the case where doesObjectExist returns true?", "url": "https://github.com/nuxeo/nuxeo/pull/4420#discussion_r519688222", "createdAt": "2020-11-09T10:05:03Z", "author": {"login": "efge"}, "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/main/java/org/nuxeo/ecm/core/storage/sql/S3DirectBatchHandler.java", "diffHunk": "@@ -339,6 +334,19 @@ public boolean completeUpload(String batchId, String fileIndex, BatchFileInfo fi\n         return true;\n     }\n \n+    protected String doMove(CopyObjectRequest request) {\n+        Copy rename = getTransferManager().copy(request);\n+        try {\n+            var copyResult = rename.waitForCopyResult();\n+            return copyResult.getETag();\n+        } catch (InterruptedException e) {\n+            Thread.currentThread().interrupt();\n+            throw new NuxeoException(e);\n+        } finally {\n+            amazonS3.deleteObject(bucket, request.getSourceKey());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61823cd62fe9f84e2862dc8e804428e2697f3d84"}, "originalPosition": 94}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be944fb88b26e684a07aff08d7c54b017afd7159", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/be944fb88b26e684a07aff08d7c54b017afd7159", "committedDate": "2020-11-09T11:26:03Z", "message": "NXP-29738: Cleanup / Format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2e248851e6f2a2078dd94f9e857b652b1010015", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/e2e248851e6f2a2078dd94f9e857b652b1010015", "committedDate": "2020-11-09T11:51:22Z", "message": "NXP-29738: Fix S3 direct upload same file import"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "61823cd62fe9f84e2862dc8e804428e2697f3d84", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/61823cd62fe9f84e2862dc8e804428e2697f3d84", "committedDate": "2020-10-28T16:17:43Z", "message": "NXP-29738: Fix S3 direct upload same file import"}, "afterCommit": {"oid": "e2e248851e6f2a2078dd94f9e857b652b1010015", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/e2e248851e6f2a2078dd94f9e857b652b1010015", "committedDate": "2020-11-09T11:51:22Z", "message": "NXP-29738: Fix S3 direct upload same file import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MTgzMzI0", "url": "https://github.com/nuxeo/nuxeo/pull/4420#pullrequestreview-526183324", "createdAt": "2020-11-09T12:00:37Z", "commit": {"oid": "e2e248851e6f2a2078dd94f9e857b652b1010015"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNDE4MTIw", "url": "https://github.com/nuxeo/nuxeo/pull/4420#pullrequestreview-532418120", "createdAt": "2020-11-17T14:29:45Z", "commit": {"oid": "e2e248851e6f2a2078dd94f9e857b652b1010015"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4946, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}