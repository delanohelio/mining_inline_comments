{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzOTU1OTk3", "number": 3812, "title": "10.10-HF/fix-NXP-28719-Fix-Comment-Migration-failure-due-to-versions", "bodyText": "PR created from https://qa2.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-saouana-10.10/102/\nNew T&P launched after taking  into account the code review (OK): https://qa2.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-troger-10.10/48/\nNew T&P after rebasing on 10.10: https://qa2.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-saouana-10.10/106/", "createdAt": "2020-03-04T23:05:04Z", "url": "https://github.com/nuxeo/nuxeo/pull/3812", "merged": true, "mergeCommit": {"oid": "b4f6f74ef9845772aed48585e2f92bcfaa820975"}, "closed": true, "closedAt": "2020-03-06T20:11:20Z", "author": {"login": "nuxeojenkins"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKn0h-ABqjMxMDAyNzQzNTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcLC0xZAFqTM3MDQ2MTM2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5da158ec39bffc92e03f5333ee26b29443e959c0", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/5da158ec39bffc92e03f5333ee26b29443e959c0", "committedDate": "2020-03-04T17:49:33Z", "message": "NXP-28719: Fix Comment Migration failure due to versions"}, "afterCommit": {"oid": "97b944d861c79837dcddbe0cccec63b89ece0ea1", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/97b944d861c79837dcddbe0cccec63b89ece0ea1", "committedDate": "2020-03-05T09:07:04Z", "message": "NXP-28719: Fix Comment Migration failure due to versions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "97b944d861c79837dcddbe0cccec63b89ece0ea1", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/97b944d861c79837dcddbe0cccec63b89ece0ea1", "committedDate": "2020-03-05T09:07:04Z", "message": "NXP-28719: Fix Comment Migration failure due to versions"}, "afterCommit": {"oid": "34d324216d5ab7679eae0c830f870a5ca4f124b1", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/34d324216d5ab7679eae0c830f870a5ca4f124b1", "committedDate": "2020-03-05T09:11:31Z", "message": "NXP-28719: Fix Comment Migration failure due to versions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "34d324216d5ab7679eae0c830f870a5ca4f124b1", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/34d324216d5ab7679eae0c830f870a5ca4f124b1", "committedDate": "2020-03-05T09:11:31Z", "message": "NXP-28719: Fix Comment Migration failure due to versions"}, "afterCommit": {"oid": "513db85f0f574170ab08fb123f4ee12d97910695", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/513db85f0f574170ab08fb123f4ee12d97910695", "committedDate": "2020-03-05T11:16:44Z", "message": "NXP-28719: Fix Comment Migration failure due to versions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NTA1OTY0", "url": "https://github.com/nuxeo/nuxeo/pull/3812#pullrequestreview-369505964", "createdAt": "2020-03-05T11:51:18Z", "commit": {"oid": "513db85f0f574170ab08fb123f4ee12d97910695"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMTo1MToxOVrOFyQogg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMTo1MToxOVrOFyQogg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI0NTYzNA==", "bodyText": "https://jira.nuxeo.com/browse/NXP-28130 was supposed to fix this but I guess we forgot some cases :(", "url": "https://github.com/nuxeo/nuxeo/pull/3812#discussion_r388245634", "createdAt": "2020-03-05T11:51:19Z", "author": {"login": "efge"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/main/java/org/nuxeo/ecm/platform/comment/impl/CommentsMigrator.java", "diffHunk": "@@ -272,8 +272,11 @@ protected void migrateCommentsFromPropertyToSecured(CoreSession session, TreeCom\n \n         // Strip ACLs\n         ACP acp = session.getACP(commentIdRef);\n-        acp.removeACL(LOCAL_ACL);\n-        session.setACP(commentIdRef, acp, true);\n+        // Case where a comment is on a placeless document which has no acp\n+        if (acp != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "513db85f0f574170ab08fb123f4ee12d97910695"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NTA2MzU3", "url": "https://github.com/nuxeo/nuxeo/pull/3812#pullrequestreview-369506357", "createdAt": "2020-03-05T11:51:59Z", "commit": {"oid": "513db85f0f574170ab08fb123f4ee12d97910695"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMTo1MTo1OVrOFyQpug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMTo1MTo1OVrOFyQpug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI0NTk0Ng==", "bodyText": "Empty line not needed", "url": "https://github.com/nuxeo/nuxeo/pull/3812#discussion_r388245946", "createdAt": "2020-03-05T11:51:59Z", "author": {"login": "efge"}, "path": "nuxeo-features/nuxeo-platform-comment/nuxeo-platform-comment/src/test/java/org/nuxeo/ecm/platform/comment/TestCommentsMigrator.java", "diffHunk": "@@ -517,6 +556,17 @@ protected void migrateFromPropertyToSecured(Migrator migrator, boolean commentsW\n                     \"Migrating comments from Property to Secured: 201/250\", //\n                     \"Migrating comments from Property to Secured: 250/250\", //\n                     \"Done Migrating from Property to Secured: 200/250\"));\n+        } else if (commentsWithPlacelessParent) {\n+            expectedLines.addAll(Arrays.asList( //\n+                    \"Initializing: 0/-1\", //\n+                    \"Migrating comments from Property to Secured: 1/250\", //\n+                    \"Migrating comments from Property to Secured: 51/250\", //\n+                    \"Migrating comments from Property to Secured: 101/250\", //\n+                    \"Migrating comments from Property to Secured: 151/250\", //\n+                    \"Migrating comments from Property to Secured: 201/250\", //\n+                    \"Migrating comments from Property to Secured: 250/250\", //\n+                    \"Done Migrating from Property to Secured: 250/250\"));\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "513db85f0f574170ab08fb123f4ee12d97910695"}, "originalPosition": 122}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5ODA0NDA2", "url": "https://github.com/nuxeo/nuxeo/pull/3812#pullrequestreview-369804406", "createdAt": "2020-03-05T18:19:19Z", "commit": {"oid": "513db85f0f574170ab08fb123f4ee12d97910695"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "513db85f0f574170ab08fb123f4ee12d97910695", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/513db85f0f574170ab08fb123f4ee12d97910695", "committedDate": "2020-03-05T11:16:44Z", "message": "NXP-28719: Fix Comment Migration failure due to versions"}, "afterCommit": {"oid": "472ff9331a45f8b5d6194bc86a02c1df24ad0280", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/472ff9331a45f8b5d6194bc86a02c1df24ad0280", "committedDate": "2020-03-06T10:01:20Z", "message": "NXP-28719: Fix Comment Migration failure due to versions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "472ff9331a45f8b5d6194bc86a02c1df24ad0280", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/472ff9331a45f8b5d6194bc86a02c1df24ad0280", "committedDate": "2020-03-06T10:01:20Z", "message": "NXP-28719: Fix Comment Migration failure due to versions"}, "afterCommit": {"oid": "56086e5b87f93bac0ee5c35e144452f7047730f3", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/56086e5b87f93bac0ee5c35e144452f7047730f3", "committedDate": "2020-03-06T10:37:04Z", "message": "NXP-28719: Fix Comment Migration failure due to versions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da78cca9922dea8b13a1b93be900987f95914a97", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/da78cca9922dea8b13a1b93be900987f95914a97", "committedDate": "2020-03-06T16:09:42Z", "message": "NXP-28731: Create comments on a placeless document must be effective"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c57e5f2e0e84ba322d6bac6eeec7be4ed46003dd", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/c57e5f2e0e84ba322d6bac6eeec7be4ed46003dd", "committedDate": "2020-03-06T16:09:49Z", "message": "NXP-28719: Fix Comment Migration failure due to versions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "56086e5b87f93bac0ee5c35e144452f7047730f3", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/56086e5b87f93bac0ee5c35e144452f7047730f3", "committedDate": "2020-03-06T10:37:04Z", "message": "NXP-28719: Fix Comment Migration failure due to versions"}, "afterCommit": {"oid": "c57e5f2e0e84ba322d6bac6eeec7be4ed46003dd", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/c57e5f2e0e84ba322d6bac6eeec7be4ed46003dd", "committedDate": "2020-03-06T16:09:49Z", "message": "NXP-28719: Fix Comment Migration failure due to versions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNDU2NzU1", "url": "https://github.com/nuxeo/nuxeo/pull/3812#pullrequestreview-370456755", "createdAt": "2020-03-06T16:30:38Z", "commit": {"oid": "c57e5f2e0e84ba322d6bac6eeec7be4ed46003dd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNDYxMzY5", "url": "https://github.com/nuxeo/nuxeo/pull/3812#pullrequestreview-370461369", "createdAt": "2020-03-06T16:36:42Z", "commit": {"oid": "c57e5f2e0e84ba322d6bac6eeec7be4ed46003dd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4799, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}