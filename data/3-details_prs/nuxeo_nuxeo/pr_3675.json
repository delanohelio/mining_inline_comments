{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0MTIwNDY4", "number": 3675, "title": "Fix-NXP-28527-Fix-TestMongoDBIndices.shouldFailWhenCreatingExistingChildNameDocument", "bodyText": "PR created from https://qa.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-saouana/184/", "createdAt": "2020-01-17T12:32:57Z", "url": "https://github.com/nuxeo/nuxeo/pull/3675", "merged": true, "mergeCommit": {"oid": "217c00d77ba0abb7d06ea0f47f0002dde9942bed"}, "closed": true, "closedAt": "2020-01-20T09:59:38Z", "author": {"login": "nuxeojenkins"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb7OXMeAFqTM0NDU2MTU2Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8JkSbAFqTM0NTE5MzM0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NTYxNTYz", "url": "https://github.com/nuxeo/nuxeo/pull/3675#pullrequestreview-344561563", "createdAt": "2020-01-17T13:00:15Z", "commit": {"oid": "2635f1ad7c3810adba803f3a620b831825e40fd5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxMzowMDoxNlrOFe4RGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxMzowMDoxNlrOFe4RGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkyMzQ4MA==", "bodyText": "This is too complex, we don't care about the detailed format of the human-readable message that MongoDB returns. Just check for presence of \"E11000 duplicate key error\" and the folder id, and avoid all this complexity (which looks way too much like white-box testing).", "url": "https://github.com/nuxeo/nuxeo/pull/3675#discussion_r367923480", "createdAt": "2020-01-17T13:00:16Z", "author": {"login": "efge"}, "path": "nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java", "diffHunk": "@@ -83,11 +84,13 @@ public void shouldFailWhenCreatingExistingChildNameDocument() {\n             fail(\"should throw a ConcurrentUpdateException\");\n         } catch (ConcurrentUpdateException cue) {\n             assertEquals(SC_CONFLICT, cue.getStatusCode());\n+            String mongoDBName = Framework.getProperties().getProperty(MONGODB_DBNAME_PROPERTY);\n             assertTrue(\n                     cue.getMessage()\n                        .contains(String.format(\n                                \"E11000 duplicate key error collection: %s.test index: ecm:parentId_1_ecm:name_1 dup key: { : \\\"%s\\\", : \\\"%s\\\" }\",\n-                               DEFAULT_MONGODB_DBNAME, folder.getId(), DOCUMENT_NAME)));\n+                               mongoDBName, folder.getId(), DOCUMENT_NAME)));\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2635f1ad7c3810adba803f3a620b831825e40fd5"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NTg1NjY1", "url": "https://github.com/nuxeo/nuxeo/pull/3675#pullrequestreview-344585665", "createdAt": "2020-01-17T13:45:16Z", "commit": {"oid": "2635f1ad7c3810adba803f3a620b831825e40fd5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxMzo0NToxNlrOFe5Xkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxMzo0NToxNlrOFe5Xkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzk0MTUyMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        String mongoDBName = Framework.getProperties().getProperty(MONGODB_DBNAME_PROPERTY);\n          \n          \n            \n                        String mongoDBName = Framework.getProperty(MONGODB_DBNAME_PROPERTY);\n          \n      \n    \n    \n  \n\nno?", "url": "https://github.com/nuxeo/nuxeo/pull/3675#discussion_r367941523", "createdAt": "2020-01-17T13:45:16Z", "author": {"login": "ataillefer"}, "path": "nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java", "diffHunk": "@@ -83,11 +84,13 @@ public void shouldFailWhenCreatingExistingChildNameDocument() {\n             fail(\"should throw a ConcurrentUpdateException\");\n         } catch (ConcurrentUpdateException cue) {\n             assertEquals(SC_CONFLICT, cue.getStatusCode());\n+            String mongoDBName = Framework.getProperties().getProperty(MONGODB_DBNAME_PROPERTY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2635f1ad7c3810adba803f3a620b831825e40fd5"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2635f1ad7c3810adba803f3a620b831825e40fd5", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/2635f1ad7c3810adba803f3a620b831825e40fd5", "committedDate": "2020-01-16T14:09:41Z", "message": "NXP-28527: Fix TestMongoDBIndices.shouldFailWhenCreatingExistingChildNameDocument"}, "afterCommit": {"oid": "8b1ce84c5e599875b866e8d0ae374816d32dccb3", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/8b1ce84c5e599875b866e8d0ae374816d32dccb3", "committedDate": "2020-01-17T14:16:09Z", "message": "NXP-28527: Fix TestMongoDBIndices.shouldFailWhenCreatingExistingChildNameDocument"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NjA2ODMx", "url": "https://github.com/nuxeo/nuxeo/pull/3675#pullrequestreview-344606831", "createdAt": "2020-01-17T14:19:13Z", "commit": {"oid": "8b1ce84c5e599875b866e8d0ae374816d32dccb3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNDoxOToxM1rOFe6VqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNDoxOToxM1rOFe6VqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzk1NzQxNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        assertTrue(cue.getMessage().contains(String.format(\"%s\", DOCUMENT_NAME)));\n          \n          \n            \n                        assertTrue(cue.getMessage().contains(DOCUMENT_NAME));", "url": "https://github.com/nuxeo/nuxeo/pull/3675#discussion_r367957416", "createdAt": "2020-01-17T14:19:13Z", "author": {"login": "ataillefer"}, "path": "nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java", "diffHunk": "@@ -83,11 +82,9 @@ public void shouldFailWhenCreatingExistingChildNameDocument() {\n             fail(\"should throw a ConcurrentUpdateException\");\n         } catch (ConcurrentUpdateException cue) {\n             assertEquals(SC_CONFLICT, cue.getStatusCode());\n-            assertTrue(\n-                    cue.getMessage()\n-                       .contains(String.format(\n-                               \"E11000 duplicate key error collection: %s.test index: ecm:parentId_1_ecm:name_1 dup key: { : \\\"%s\\\", : \\\"%s\\\" }\",\n-                               DEFAULT_MONGODB_DBNAME, folder.getId(), DOCUMENT_NAME)));\n+            assertTrue(cue.getMessage().contains(\"E11000 duplicate key error collection\"));\n+            assertTrue(cue.getMessage().contains(String.format(\"%s\", DOCUMENT_NAME)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b1ce84c5e599875b866e8d0ae374816d32dccb3"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NjA2MTkx", "url": "https://github.com/nuxeo/nuxeo/pull/3675#pullrequestreview-344606191", "createdAt": "2020-01-17T14:18:19Z", "commit": {"oid": "8b1ce84c5e599875b866e8d0ae374816d32dccb3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNDoxODoxOVrOFe6Tog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNDoxODoxOVrOFe6Tog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzk1Njg5OA==", "bodyText": "Just contains(DOCUMENT_NAME) and contains(folder.getId())\nAlso you could put cue.getMessage() in a local variable.", "url": "https://github.com/nuxeo/nuxeo/pull/3675#discussion_r367956898", "createdAt": "2020-01-17T14:18:19Z", "author": {"login": "efge"}, "path": "nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java", "diffHunk": "@@ -83,11 +82,9 @@ public void shouldFailWhenCreatingExistingChildNameDocument() {\n             fail(\"should throw a ConcurrentUpdateException\");\n         } catch (ConcurrentUpdateException cue) {\n             assertEquals(SC_CONFLICT, cue.getStatusCode());\n-            assertTrue(\n-                    cue.getMessage()\n-                       .contains(String.format(\n-                               \"E11000 duplicate key error collection: %s.test index: ecm:parentId_1_ecm:name_1 dup key: { : \\\"%s\\\", : \\\"%s\\\" }\",\n-                               DEFAULT_MONGODB_DBNAME, folder.getId(), DOCUMENT_NAME)));\n+            assertTrue(cue.getMessage().contains(\"E11000 duplicate key error collection\"));\n+            assertTrue(cue.getMessage().contains(String.format(\"%s\", DOCUMENT_NAME)));\n+            assertTrue(cue.getMessage().contains(String.format(\"%s\", folder.getId())));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b1ce84c5e599875b866e8d0ae374816d32dccb3"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NjA3MDE5", "url": "https://github.com/nuxeo/nuxeo/pull/3675#pullrequestreview-344607019", "createdAt": "2020-01-17T14:19:32Z", "commit": {"oid": "8b1ce84c5e599875b866e8d0ae374816d32dccb3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNDoxOTozMlrOFe6WNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNDoxOTozMlrOFe6WNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzk1NzU1Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        assertTrue(cue.getMessage().contains(String.format(\"%s\", folder.getId())));\n          \n          \n            \n                        assertTrue(cue.getMessage().contains(folder.getId()));", "url": "https://github.com/nuxeo/nuxeo/pull/3675#discussion_r367957557", "createdAt": "2020-01-17T14:19:32Z", "author": {"login": "ataillefer"}, "path": "nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java", "diffHunk": "@@ -83,11 +82,9 @@ public void shouldFailWhenCreatingExistingChildNameDocument() {\n             fail(\"should throw a ConcurrentUpdateException\");\n         } catch (ConcurrentUpdateException cue) {\n             assertEquals(SC_CONFLICT, cue.getStatusCode());\n-            assertTrue(\n-                    cue.getMessage()\n-                       .contains(String.format(\n-                               \"E11000 duplicate key error collection: %s.test index: ecm:parentId_1_ecm:name_1 dup key: { : \\\"%s\\\", : \\\"%s\\\" }\",\n-                               DEFAULT_MONGODB_DBNAME, folder.getId(), DOCUMENT_NAME)));\n+            assertTrue(cue.getMessage().contains(\"E11000 duplicate key error collection\"));\n+            assertTrue(cue.getMessage().contains(String.format(\"%s\", DOCUMENT_NAME)));\n+            assertTrue(cue.getMessage().contains(String.format(\"%s\", folder.getId())));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b1ce84c5e599875b866e8d0ae374816d32dccb3"}, "originalPosition": 19}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8b1ce84c5e599875b866e8d0ae374816d32dccb3", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/8b1ce84c5e599875b866e8d0ae374816d32dccb3", "committedDate": "2020-01-17T14:16:09Z", "message": "NXP-28527: Fix TestMongoDBIndices.shouldFailWhenCreatingExistingChildNameDocument"}, "afterCommit": {"oid": "137540b70c4968a65fd55f8eb1ed8c57959a6707", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/137540b70c4968a65fd55f8eb1ed8c57959a6707", "committedDate": "2020-01-17T14:21:56Z", "message": "NXP-28527: Fix TestMongoDBIndices.shouldFailWhenCreatingExistingChildNameDocument"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NjA5OTUx", "url": "https://github.com/nuxeo/nuxeo/pull/3675#pullrequestreview-344609951", "createdAt": "2020-01-17T14:23:51Z", "commit": {"oid": "137540b70c4968a65fd55f8eb1ed8c57959a6707"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NjIwMjQ0", "url": "https://github.com/nuxeo/nuxeo/pull/3675#pullrequestreview-344620244", "createdAt": "2020-01-17T14:39:02Z", "commit": {"oid": "137540b70c4968a65fd55f8eb1ed8c57959a6707"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNDozOTowMlrOFe68yA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNDozOTowMlrOFe68yA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzk2NzQzMg==", "bodyText": "Sorry, one last change: please put message as the first argument to assertTrue, so that if there's a mismatch we have the full message in the logs.\nassertTrue(message, message.contains(\"E11000 duplicate key error collection\"));\nassertTrue(message, message.contains(DOCUMENT_NAME));\nassertTrue(message, message.contains(folder.getId()));", "url": "https://github.com/nuxeo/nuxeo/pull/3675#discussion_r367967432", "createdAt": "2020-01-17T14:39:02Z", "author": {"login": "efge"}, "path": "nuxeo-core/nuxeo-core-mongodb/src/test/java/org/nuxeo/ecm/core/mongodb/TestMongoDBIndices.java", "diffHunk": "@@ -83,11 +82,10 @@ public void shouldFailWhenCreatingExistingChildNameDocument() {\n             fail(\"should throw a ConcurrentUpdateException\");\n         } catch (ConcurrentUpdateException cue) {\n             assertEquals(SC_CONFLICT, cue.getStatusCode());\n-            assertTrue(\n-                    cue.getMessage()\n-                       .contains(String.format(\n-                               \"E11000 duplicate key error collection: %s.test index: ecm:parentId_1_ecm:name_1 dup key: { : \\\"%s\\\", : \\\"%s\\\" }\",\n-                               DEFAULT_MONGODB_DBNAME, folder.getId(), DOCUMENT_NAME)));\n+            String message = cue.getMessage();\n+            assertTrue(message.contains(\"E11000 duplicate key error collection\"));\n+            assertTrue(message.contains(DOCUMENT_NAME));\n+            assertTrue(message.contains(folder.getId()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "137540b70c4968a65fd55f8eb1ed8c57959a6707"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bd45d1e49dd49b22188de0b52b7b523c41c8d06", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/1bd45d1e49dd49b22188de0b52b7b523c41c8d06", "committedDate": "2020-01-17T14:43:33Z", "message": "NXP-28527: Fix TestMongoDBIndices.shouldFailWhenCreatingExistingChildNameDocument"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "137540b70c4968a65fd55f8eb1ed8c57959a6707", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/137540b70c4968a65fd55f8eb1ed8c57959a6707", "committedDate": "2020-01-17T14:21:56Z", "message": "NXP-28527: Fix TestMongoDBIndices.shouldFailWhenCreatingExistingChildNameDocument"}, "afterCommit": {"oid": "1bd45d1e49dd49b22188de0b52b7b523c41c8d06", "author": {"user": {"login": "RSalem07", "name": "Salem Aouana"}}, "url": "https://github.com/nuxeo/nuxeo/commit/1bd45d1e49dd49b22188de0b52b7b523c41c8d06", "committedDate": "2020-01-17T14:43:33Z", "message": "NXP-28527: Fix TestMongoDBIndices.shouldFailWhenCreatingExistingChildNameDocument"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NjI2MDYx", "url": "https://github.com/nuxeo/nuxeo/pull/3675#pullrequestreview-344626061", "createdAt": "2020-01-17T14:47:32Z", "commit": {"oid": "1bd45d1e49dd49b22188de0b52b7b523c41c8d06"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1MTkzMzQ4", "url": "https://github.com/nuxeo/nuxeo/pull/3675#pullrequestreview-345193348", "createdAt": "2020-01-20T09:59:10Z", "commit": {"oid": "1bd45d1e49dd49b22188de0b52b7b523c41c8d06"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4882, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}