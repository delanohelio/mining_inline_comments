{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5NzY4MDcw", "number": 3893, "title": "Fix NXP-28396 nuxeoctl console hang", "bodyText": "Created as a draft because it remains some logging tuning, can be reviewed.", "createdAt": "2020-04-06T16:40:49Z", "url": "https://github.com/nuxeo/nuxeo/pull/3893", "merged": true, "mergeCommit": {"oid": "bb4d5f332c48c22c8366d7a53b4a42fcac906198"}, "closed": true, "closedAt": "2020-04-15T09:48:44Z", "author": {"login": "kevinleturc"}, "timelineItems": {"totalCount": 28, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVNcX9gBqjMyMDgzOTg3MDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcX07w-gFqTM5MzYxOTc2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "27ee063ccaac62149c0297288402e2dd4420cab8", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/27ee063ccaac62149c0297288402e2dd4420cab8", "committedDate": "2020-04-06T16:39:45Z", "message": "NXP-28396: Rework error handling"}, "afterCommit": {"oid": "7f95da2807720e9eab4b9c7dda04757921584122", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/7f95da2807720e9eab4b9c7dda04757921584122", "committedDate": "2020-04-07T06:37:55Z", "message": "NXP-28396: Rework error handling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MDc4NDE0", "url": "https://github.com/nuxeo/nuxeo/pull/3893#pullrequestreview-389078414", "createdAt": "2020-04-07T12:46:03Z", "commit": {"oid": "fbe1aa978db4977e4e104216afb8f10b2d47637b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjo0NjowM1rOGCByIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjo0NjowM1rOGCByIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc3OTU1NA==", "bodyText": "Though ConfigurationGenerator.NUXEO_DEFAULT_CONF is only used once, what about using static import for consistency with NUXEO_CONF?", "url": "https://github.com/nuxeo/nuxeo/pull/3893#discussion_r404779554", "createdAt": "2020-04-07T12:46:03Z", "author": {"login": "ataillefer"}, "path": "server/nuxeo-launcher/src/main/java/org/nuxeo/launcher/NuxeoLauncher.java", "diffHunk": "@@ -301,59 +267,47 @@\n             + \"The value is stored in {{%s}} by default unless a template name is provided; if so, it is then stored in the template's {{%s}} file.\\n\"\n             + \"If the value is empty (''), then the property is unset.\\n\"\n             + \"This option is implicit if no '--get' or '--get-regexp' option is used and there are exactly two parameters (key value).\",\n-            ConfigurationGenerator.NUXEO_CONF, ConfigurationGenerator.NUXEO_DEFAULT_CONF);\n+            NUXEO_CONF, ConfigurationGenerator.NUXEO_DEFAULT_CONF);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbe1aa978db4977e4e104216afb8f10b2d47637b"}, "originalPosition": 243}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MDkxNTQy", "url": "https://github.com/nuxeo/nuxeo/pull/3893#pullrequestreview-389091542", "createdAt": "2020-04-07T13:01:58Z", "commit": {"oid": "37b30845d21f5c37b09bb06b9d94b557761c0f70"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzowMTo1OFrOGCCbAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzowMTo1OFrOGCCbAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc5MDAxNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Relax the launcher strict option (ie: lenient mode).\n          \n          \n            \n                 * Relaxes the launcher strict option (ie: lenient mode).", "url": "https://github.com/nuxeo/nuxeo/pull/3893#discussion_r404790016", "createdAt": "2020-04-07T13:01:58Z", "author": {"login": "ataillefer"}, "path": "server/nuxeo-launcher/src/main/java/org/nuxeo/launcher/NuxeoLauncher.java", "diffHunk": "@@ -2350,13 +2269,12 @@ protected static void setDebug(String[] loggerNames) {\n     }\n \n     /**\n-     * Sets the launcher strict option.\n+     * Relax the launcher strict option (ie: lenient mode).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37b30845d21f5c37b09bb06b9d94b557761c0f70"}, "originalPosition": 302}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MTA3ODE3", "url": "https://github.com/nuxeo/nuxeo/pull/3893#pullrequestreview-389107817", "createdAt": "2020-04-07T13:20:51Z", "commit": {"oid": "95dbe2ea46e28d527785051f3645ae4855ba1ad3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzoyMDo1MlrOGCDNPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzoyMDo1MlrOGCDNPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgwMjg3Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * @implNote the launcher has a specific log4j configuration check its log4j2.xml\n          \n          \n            \n             * @implNote the launcher has a specific log4j configuration, check its log4j2.xml", "url": "https://github.com/nuxeo/nuxeo/pull/3893#discussion_r404802877", "createdAt": "2020-04-07T13:20:52Z", "author": {"login": "ataillefer"}, "path": "server/nuxeo-launcher/src/main/java/org/nuxeo/launcher/NuxeoLauncher.java", "diffHunk": "@@ -117,15 +121,15 @@\n import org.nuxeo.launcher.process.UnixProcessManager;\n import org.nuxeo.launcher.process.WindowsProcessManager;\n import org.nuxeo.log4j.Log4JHelper;\n-import org.nuxeo.log4j.ThreadedStreamGobbler;\n \n import com.sun.jersey.api.json.JSONConfiguration;\n import com.sun.jersey.json.impl.writer.JsonXmlStreamWriter;\n \n /**\n  * @author jcarsique\n  * @since 5.4.2\n- * @implNote launcher only handles Tomcat and is no more abstract since 11.1\n+ * @implNote since 11.1, launcher only handles Tomcat and is no more abstract\n+ * @implNote the launcher has a specific log4j configuration check its log4j2.xml", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95dbe2ea46e28d527785051f3645ae4855ba1ad3"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MTE3MzYy", "url": "https://github.com/nuxeo/nuxeo/pull/3893#pullrequestreview-389117362", "createdAt": "2020-04-07T13:31:03Z", "commit": {"oid": "95dbe2ea46e28d527785051f3645ae4855ba1ad3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzozMTowM1rOGCDqAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzozMTowM1rOGCDqAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxMDI0Mg==", "bodyText": "exitCode maybe?", "url": "https://github.com/nuxeo/nuxeo/pull/3893#discussion_r404810242", "createdAt": "2020-04-07T13:31:03Z", "author": {"login": "ataillefer"}, "path": "server/nuxeo-launcher/src/main/java/org/nuxeo/launcher/NuxeoLauncherException.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ *  Contributors:\n+ *      Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+\n+package org.nuxeo.launcher;\n+\n+/**\n+ * @since 11.1\n+ */\n+public class NuxeoLauncherException extends RuntimeException {\n+\n+    private final int errorValue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95dbe2ea46e28d527785051f3645ae4855ba1ad3"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MTM1NDE4", "url": "https://github.com/nuxeo/nuxeo/pull/3893#pullrequestreview-389135418", "createdAt": "2020-04-07T13:50:21Z", "commit": {"oid": "95dbe2ea46e28d527785051f3645ae4855ba1ad3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzo1MDoyMVrOGCEhIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzo1MDoyMVrOGCEhIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyNDM1Mw==", "bodyText": "is // NOSONAR try-with-resources really useful?", "url": "https://github.com/nuxeo/nuxeo/pull/3893#discussion_r404824353", "createdAt": "2020-04-07T13:50:21Z", "author": {"login": "ataillefer"}, "path": "server/nuxeo-launcher/src/main/java/org/nuxeo/launcher/NuxeoLauncher.java", "diffHunk": "@@ -1695,131 +1596,235 @@ protected void setConfigProperties() throws ConfigurationException, IOException,\n         log.debug(\"Old values: {}\", oldValues);\n     }\n \n-    /**\n-     * @see #doStartAndWait(boolean)\n-     */\n-    public boolean doStartAndWait() throws PackageException {\n-        boolean started = doStartAndWait(false);\n-        if (started && !quiet) {\n-            log.info(\"Go to {}\", this::getURL);\n-        }\n-        return started;\n-    }\n-\n-    /**\n-     * @see #stop(boolean)\n-     */\n-    public void stop() {\n-        stop(false);\n-    }\n-\n     /**\n      * Call {@link #doStart(boolean)} with false as parameter.\n      *\n      * @see #doStart(boolean)\n      * @return true if the server started successfully\n      */\n-    public boolean doStart() throws PackageException {\n-        boolean started = doStart(false);\n-        if (started && !quiet) {\n-            log.info(\"Go to {}\", this::getURL);\n+    public boolean doStart() {\n+        if (doStart(false).isAlive()) {\n+            if (!quiet) {\n+                log.info(\"Go to {}\", this::getURL);\n+            }\n+            return true;\n         }\n-        return started;\n+        return false;\n     }\n \n     /**\n-     * Whereas {@link #doStart()} considers the server as started when the process is running, {@link #doStartAndWait()}\n-     * waits for effective start by watching the logs\n+     * Whereas {@link #doStart()} considers the server as started when the process is running, this method waits for\n+     * effective start by calling {@link #statusServletClient}.\n      *\n-     * @param logProcessOutput Must process output stream must be logged or not.\n      * @return true if the server started successfully\n      */\n-    public boolean doStartAndWait(boolean logProcessOutput) throws PackageException {\n-        boolean commandSucceeded = false;\n-        if (doStart(logProcessOutput)) {\n-            addShutdownHook();\n-            try {\n-                if (waitForEffectiveStart()) {\n-                    commandSucceeded = true;\n+    public boolean doStartAndWait() {\n+        var nuxeoProcess = doStart(false);\n+        if (nuxeoProcess.isAlive()) {\n+            //noinspection unused\n+            try (var hook = new ShutdownHook(this)) { // NOSONAR try-with-resources", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95dbe2ea46e28d527785051f3645ae4855ba1ad3"}, "originalPosition": 347}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MTM3Njg1", "url": "https://github.com/nuxeo/nuxeo/pull/3893#pullrequestreview-389137685", "createdAt": "2020-04-07T13:52:45Z", "commit": {"oid": "95dbe2ea46e28d527785051f3645ae4855ba1ad3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzo1Mjo0NVrOGCEoHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzo1Mjo0NVrOGCEoHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyNjE0MA==", "bodyText": "This line appears 3 times, don't know if it's interesting to refactor?", "url": "https://github.com/nuxeo/nuxeo/pull/3893#discussion_r404826140", "createdAt": "2020-04-07T13:52:45Z", "author": {"login": "ataillefer"}, "path": "server/nuxeo-launcher/src/main/java/org/nuxeo/launcher/NuxeoLauncher.java", "diffHunk": "@@ -1695,131 +1596,235 @@ protected void setConfigProperties() throws ConfigurationException, IOException,\n         log.debug(\"Old values: {}\", oldValues);\n     }\n \n-    /**\n-     * @see #doStartAndWait(boolean)\n-     */\n-    public boolean doStartAndWait() throws PackageException {\n-        boolean started = doStartAndWait(false);\n-        if (started && !quiet) {\n-            log.info(\"Go to {}\", this::getURL);\n-        }\n-        return started;\n-    }\n-\n-    /**\n-     * @see #stop(boolean)\n-     */\n-    public void stop() {\n-        stop(false);\n-    }\n-\n     /**\n      * Call {@link #doStart(boolean)} with false as parameter.\n      *\n      * @see #doStart(boolean)\n      * @return true if the server started successfully\n      */\n-    public boolean doStart() throws PackageException {\n-        boolean started = doStart(false);\n-        if (started && !quiet) {\n-            log.info(\"Go to {}\", this::getURL);\n+    public boolean doStart() {\n+        if (doStart(false).isAlive()) {\n+            if (!quiet) {\n+                log.info(\"Go to {}\", this::getURL);\n+            }\n+            return true;\n         }\n-        return started;\n+        return false;\n     }\n \n     /**\n-     * Whereas {@link #doStart()} considers the server as started when the process is running, {@link #doStartAndWait()}\n-     * waits for effective start by watching the logs\n+     * Whereas {@link #doStart()} considers the server as started when the process is running, this method waits for\n+     * effective start by calling {@link #statusServletClient}.\n      *\n-     * @param logProcessOutput Must process output stream must be logged or not.\n      * @return true if the server started successfully\n      */\n-    public boolean doStartAndWait(boolean logProcessOutput) throws PackageException {\n-        boolean commandSucceeded = false;\n-        if (doStart(logProcessOutput)) {\n-            addShutdownHook();\n-            try {\n-                if (waitForEffectiveStart()) {\n-                    commandSucceeded = true;\n+    public boolean doStartAndWait() {\n+        var nuxeoProcess = doStart(false);\n+        if (nuxeoProcess.isAlive()) {\n+            //noinspection unused\n+            try (var hook = new ShutdownHook(this)) { // NOSONAR try-with-resources\n+                waitForEffectiveStart(nuxeoProcess);\n+                if (!quiet) {\n+                    log.info(\"Go to {}\", this::getURL);\n                 }\n-                removeShutdownHook();\n+                return true;\n             } catch (InterruptedException e) {\n                 Thread.currentThread().interrupt();\n                 throw new RuntimeException(e);\n             }\n         }\n-        return commandSucceeded;\n+        return false;\n+    }\n+\n+    /**\n+     * @since 11.1\n+     */\n+    public void doConsole() {\n+        var hook = new ShutdownHook(this);\n+        try {\n+            doStart(true).onExit().thenAccept(p -> {\n+                hook.close();\n+                // always error, nuxeo process is not supposed to exit\n+                System.exit(EXIT_CODE_ERROR);\n+            });\n+        } catch (RuntimeException e) {\n+            // for errors in doStart\n+            hook.close();\n+            throw e;\n+        }\n+        if (!quiet) {\n+            log.info(\"Go to {}\", this::getURL);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95dbe2ea46e28d527785051f3645ae4855ba1ad3"}, "originalPosition": 380}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MTM5MDU0", "url": "https://github.com/nuxeo/nuxeo/pull/3893#pullrequestreview-389139054", "createdAt": "2020-04-07T13:54:07Z", "commit": {"oid": "95dbe2ea46e28d527785051f3645ae4855ba1ad3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzo1NDowN1rOGCEsXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzo1NDowN1rOGCEsXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyNzIyOA==", "bodyText": "Here you might want to use try-with-resources or add // NOSONAR.", "url": "https://github.com/nuxeo/nuxeo/pull/3893#discussion_r404827228", "createdAt": "2020-04-07T13:54:07Z", "author": {"login": "ataillefer"}, "path": "server/nuxeo-launcher/src/main/java/org/nuxeo/launcher/NuxeoLauncher.java", "diffHunk": "@@ -1695,131 +1596,235 @@ protected void setConfigProperties() throws ConfigurationException, IOException,\n         log.debug(\"Old values: {}\", oldValues);\n     }\n \n-    /**\n-     * @see #doStartAndWait(boolean)\n-     */\n-    public boolean doStartAndWait() throws PackageException {\n-        boolean started = doStartAndWait(false);\n-        if (started && !quiet) {\n-            log.info(\"Go to {}\", this::getURL);\n-        }\n-        return started;\n-    }\n-\n-    /**\n-     * @see #stop(boolean)\n-     */\n-    public void stop() {\n-        stop(false);\n-    }\n-\n     /**\n      * Call {@link #doStart(boolean)} with false as parameter.\n      *\n      * @see #doStart(boolean)\n      * @return true if the server started successfully\n      */\n-    public boolean doStart() throws PackageException {\n-        boolean started = doStart(false);\n-        if (started && !quiet) {\n-            log.info(\"Go to {}\", this::getURL);\n+    public boolean doStart() {\n+        if (doStart(false).isAlive()) {\n+            if (!quiet) {\n+                log.info(\"Go to {}\", this::getURL);\n+            }\n+            return true;\n         }\n-        return started;\n+        return false;\n     }\n \n     /**\n-     * Whereas {@link #doStart()} considers the server as started when the process is running, {@link #doStartAndWait()}\n-     * waits for effective start by watching the logs\n+     * Whereas {@link #doStart()} considers the server as started when the process is running, this method waits for\n+     * effective start by calling {@link #statusServletClient}.\n      *\n-     * @param logProcessOutput Must process output stream must be logged or not.\n      * @return true if the server started successfully\n      */\n-    public boolean doStartAndWait(boolean logProcessOutput) throws PackageException {\n-        boolean commandSucceeded = false;\n-        if (doStart(logProcessOutput)) {\n-            addShutdownHook();\n-            try {\n-                if (waitForEffectiveStart()) {\n-                    commandSucceeded = true;\n+    public boolean doStartAndWait() {\n+        var nuxeoProcess = doStart(false);\n+        if (nuxeoProcess.isAlive()) {\n+            //noinspection unused\n+            try (var hook = new ShutdownHook(this)) { // NOSONAR try-with-resources\n+                waitForEffectiveStart(nuxeoProcess);\n+                if (!quiet) {\n+                    log.info(\"Go to {}\", this::getURL);\n                 }\n-                removeShutdownHook();\n+                return true;\n             } catch (InterruptedException e) {\n                 Thread.currentThread().interrupt();\n                 throw new RuntimeException(e);\n             }\n         }\n-        return commandSucceeded;\n+        return false;\n+    }\n+\n+    /**\n+     * @since 11.1\n+     */\n+    public void doConsole() {\n+        var hook = new ShutdownHook(this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95dbe2ea46e28d527785051f3645ae4855ba1ad3"}, "originalPosition": 367}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MTQwNjI2", "url": "https://github.com/nuxeo/nuxeo/pull/3893#pullrequestreview-389140626", "createdAt": "2020-04-07T13:55:43Z", "commit": {"oid": "95dbe2ea46e28d527785051f3645ae4855ba1ad3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzo1NTo0M1rOGCExCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzo1NTo0M1rOGCExCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyODQyNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            // always error, nuxeo process is not supposed to exit\n          \n          \n            \n                            // always terminate, nuxeo process is not supposed to exit", "url": "https://github.com/nuxeo/nuxeo/pull/3893#discussion_r404828425", "createdAt": "2020-04-07T13:55:43Z", "author": {"login": "ataillefer"}, "path": "server/nuxeo-launcher/src/main/java/org/nuxeo/launcher/NuxeoLauncher.java", "diffHunk": "@@ -1695,131 +1596,235 @@ protected void setConfigProperties() throws ConfigurationException, IOException,\n         log.debug(\"Old values: {}\", oldValues);\n     }\n \n-    /**\n-     * @see #doStartAndWait(boolean)\n-     */\n-    public boolean doStartAndWait() throws PackageException {\n-        boolean started = doStartAndWait(false);\n-        if (started && !quiet) {\n-            log.info(\"Go to {}\", this::getURL);\n-        }\n-        return started;\n-    }\n-\n-    /**\n-     * @see #stop(boolean)\n-     */\n-    public void stop() {\n-        stop(false);\n-    }\n-\n     /**\n      * Call {@link #doStart(boolean)} with false as parameter.\n      *\n      * @see #doStart(boolean)\n      * @return true if the server started successfully\n      */\n-    public boolean doStart() throws PackageException {\n-        boolean started = doStart(false);\n-        if (started && !quiet) {\n-            log.info(\"Go to {}\", this::getURL);\n+    public boolean doStart() {\n+        if (doStart(false).isAlive()) {\n+            if (!quiet) {\n+                log.info(\"Go to {}\", this::getURL);\n+            }\n+            return true;\n         }\n-        return started;\n+        return false;\n     }\n \n     /**\n-     * Whereas {@link #doStart()} considers the server as started when the process is running, {@link #doStartAndWait()}\n-     * waits for effective start by watching the logs\n+     * Whereas {@link #doStart()} considers the server as started when the process is running, this method waits for\n+     * effective start by calling {@link #statusServletClient}.\n      *\n-     * @param logProcessOutput Must process output stream must be logged or not.\n      * @return true if the server started successfully\n      */\n-    public boolean doStartAndWait(boolean logProcessOutput) throws PackageException {\n-        boolean commandSucceeded = false;\n-        if (doStart(logProcessOutput)) {\n-            addShutdownHook();\n-            try {\n-                if (waitForEffectiveStart()) {\n-                    commandSucceeded = true;\n+    public boolean doStartAndWait() {\n+        var nuxeoProcess = doStart(false);\n+        if (nuxeoProcess.isAlive()) {\n+            //noinspection unused\n+            try (var hook = new ShutdownHook(this)) { // NOSONAR try-with-resources\n+                waitForEffectiveStart(nuxeoProcess);\n+                if (!quiet) {\n+                    log.info(\"Go to {}\", this::getURL);\n                 }\n-                removeShutdownHook();\n+                return true;\n             } catch (InterruptedException e) {\n                 Thread.currentThread().interrupt();\n                 throw new RuntimeException(e);\n             }\n         }\n-        return commandSucceeded;\n+        return false;\n+    }\n+\n+    /**\n+     * @since 11.1\n+     */\n+    public void doConsole() {\n+        var hook = new ShutdownHook(this);\n+        try {\n+            doStart(true).onExit().thenAccept(p -> {\n+                hook.close();\n+                // always error, nuxeo process is not supposed to exit", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95dbe2ea46e28d527785051f3645ae4855ba1ad3"}, "originalPosition": 371}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MTQzMDg0", "url": "https://github.com/nuxeo/nuxeo/pull/3893#pullrequestreview-389143084", "createdAt": "2020-04-07T13:58:09Z", "commit": {"oid": "95dbe2ea46e28d527785051f3645ae4855ba1ad3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzo1ODowOVrOGCE4MA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzo1ODowOVrOGCE4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgzMDI1Ng==", "bodyText": "extra blank line", "url": "https://github.com/nuxeo/nuxeo/pull/3893#discussion_r404830256", "createdAt": "2020-04-07T13:58:09Z", "author": {"login": "ataillefer"}, "path": "server/nuxeo-launcher/src/main/java/org/nuxeo/launcher/NuxeoLauncher.java", "diffHunk": "@@ -1695,131 +1596,235 @@ protected void setConfigProperties() throws ConfigurationException, IOException,\n         log.debug(\"Old values: {}\", oldValues);\n     }\n \n-    /**\n-     * @see #doStartAndWait(boolean)\n-     */\n-    public boolean doStartAndWait() throws PackageException {\n-        boolean started = doStartAndWait(false);\n-        if (started && !quiet) {\n-            log.info(\"Go to {}\", this::getURL);\n-        }\n-        return started;\n-    }\n-\n-    /**\n-     * @see #stop(boolean)\n-     */\n-    public void stop() {\n-        stop(false);\n-    }\n-\n     /**\n      * Call {@link #doStart(boolean)} with false as parameter.\n      *\n      * @see #doStart(boolean)\n      * @return true if the server started successfully\n      */\n-    public boolean doStart() throws PackageException {\n-        boolean started = doStart(false);\n-        if (started && !quiet) {\n-            log.info(\"Go to {}\", this::getURL);\n+    public boolean doStart() {\n+        if (doStart(false).isAlive()) {\n+            if (!quiet) {\n+                log.info(\"Go to {}\", this::getURL);\n+            }\n+            return true;\n         }\n-        return started;\n+        return false;\n     }\n \n     /**\n-     * Whereas {@link #doStart()} considers the server as started when the process is running, {@link #doStartAndWait()}\n-     * waits for effective start by watching the logs\n+     * Whereas {@link #doStart()} considers the server as started when the process is running, this method waits for\n+     * effective start by calling {@link #statusServletClient}.\n      *\n-     * @param logProcessOutput Must process output stream must be logged or not.\n      * @return true if the server started successfully\n      */\n-    public boolean doStartAndWait(boolean logProcessOutput) throws PackageException {\n-        boolean commandSucceeded = false;\n-        if (doStart(logProcessOutput)) {\n-            addShutdownHook();\n-            try {\n-                if (waitForEffectiveStart()) {\n-                    commandSucceeded = true;\n+    public boolean doStartAndWait() {\n+        var nuxeoProcess = doStart(false);\n+        if (nuxeoProcess.isAlive()) {\n+            //noinspection unused\n+            try (var hook = new ShutdownHook(this)) { // NOSONAR try-with-resources\n+                waitForEffectiveStart(nuxeoProcess);\n+                if (!quiet) {\n+                    log.info(\"Go to {}\", this::getURL);\n                 }\n-                removeShutdownHook();\n+                return true;\n             } catch (InterruptedException e) {\n                 Thread.currentThread().interrupt();\n                 throw new RuntimeException(e);\n             }\n         }\n-        return commandSucceeded;\n+        return false;\n+    }\n+\n+    /**\n+     * @since 11.1\n+     */\n+    public void doConsole() {\n+        var hook = new ShutdownHook(this);\n+        try {\n+            doStart(true).onExit().thenAccept(p -> {\n+                hook.close();\n+                // always error, nuxeo process is not supposed to exit\n+                System.exit(EXIT_CODE_ERROR);\n+            });\n+        } catch (RuntimeException e) {\n+            // for errors in doStart\n+            hook.close();\n+            throw e;\n+        }\n+        if (!quiet) {\n+            log.info(\"Go to {}\", this::getURL);\n+        }\n     }\n \n-    protected void removeShutdownHook() {\n+    /**\n+     * Starts the server in background.\n+     *\n+     * @return the nuxeo process\n+     * @throws NuxeoLauncherException if an error occurred\n+     */\n+    protected Process doStart(boolean logProcessOutput) {\n+        errorValue = EXIT_CODE_OK;\n         try {\n-            Runtime.getRuntime().removeShutdownHook(shutdownHook);\n-            log.debug(\"Removed shutdown hook\");\n+            configure();\n+            configurationGenerator.verifyInstallation();\n+\n+            log.debug(\"Check if install in progress...\");\n+            int tries = 0;\n+            while (configurationGenerator.isInstallInProgress()) {\n+                tries++;\n+                if (!getConnectBroker().executePending(configurationGenerator.getInstallFile(), true, true,\n+                        ignoreMissing) || tries > 9) {\n+                    throw new NuxeoLauncherException(String.format(\n+                            \"Start interrupted due to failure on pending actions. You can resume with a new start\"\n+                                    + \" or you can restore the file '%s', optionally using the '--%s' option.\",\n+                            configurationGenerator.getInstallFile().getName(), OPTION_IGNORE_MISSING), EXIT_CODE_ERROR);\n+                }\n+                // reload configuration\n+                configurationGenerator = new ConfigurationGenerator(quiet, debug);\n+                configurationGenerator.init();\n+                configure();\n+                configurationGenerator.verifyInstallation();\n+            }\n+            return start(logProcessOutput);\n+        } catch (ConfigurationException e) {\n+            throw new NuxeoLauncherException(\"Could not run configuration: \" + e.getMessage(), EXIT_CODE_NOT_CONFIGURED,\n+                    e);\n+        } catch (IOException e) {\n+            throw new NuxeoLauncherException(\"Could not start process: \" + e.getMessage(), EXIT_CODE_ERROR, e);\n         } catch (IllegalStateException e) {\n-            // the virtual machine is already in the process of shutting down\n+            // in strict mode assume program is not configured because of http port binding conflict for exit value\n+            throw new NuxeoLauncherException(\"Could not start process: \" + e.getMessage(),\n+                    strict ? EXIT_CODE_NOT_CONFIGURED : EXIT_CODE_ERROR, e);\n         }\n     }\n \n     /**\n-     * @return true if Nuxeo is ready\n+     * Do not directly call this method without a call to {@link #checkNoRunningServer()}\n+     *\n+     * @see #doStart()\n+     * @throws IOException in case of issue with process.\n      */\n-    protected boolean waitForEffectiveStart() throws InterruptedException {\n-        long startTime = new Date().getTime();\n+    protected Process start(boolean logProcessOutput) throws IOException {\n+        // build command to start nuxeo\n+        List<String> startCommand = new ArrayList<>();\n+        startCommand.add(getJavaExecutable().getPath());\n+        startCommand.addAll(getJavaOptsProperty(Function.identity()));\n+        startCommand.add(\"-cp\");\n+        startCommand.add(getClassPath());\n+        startCommand.addAll(getNuxeoProperties());\n+        startCommand.addAll(getServerProperties());\n+        if (strict) {\n+            startCommand.add(\"-Dnuxeo.start.strict=true\");\n+        }\n+\n+        startCommand.add(TomcatConfigurator.STARTUP_CLASS);\n+        startCommand.add(\"start\");\n+        startCommand.addAll(Arrays.asList(params));\n+\n+        // build and start process\n+        ProcessBuilder pb = new ProcessBuilder(getOSCommand(startCommand));\n+        pb.directory(configurationGenerator.getNuxeoHome());\n+        if (logProcessOutput) {\n+            // don't redirect input as we want a graceful shutdown\n+            pb.redirectOutput(ProcessBuilder.Redirect.INHERIT).redirectError(ProcessBuilder.Redirect.INHERIT);\n+        }\n+        log.debug(\"Server command: {}\", pb::command);\n+        Process nuxeoProcess = pb.start();\n+        nuxeoProcess.onExit().thenAccept(p -> {\n+            if (SystemUtils.IS_OS_WINDOWS && configurationGenerator.getNuxeoHome().getPath().contains(\" \")) {\n+                // NXP-17679\n+                log.error(\"The server path must not contain spaces under Windows.\");\n+            }\n+            int exitValue = p.exitValue();\n+            if (exitValue != 0) {\n+                log.error(\"Server stopped with status: {}\", exitValue);\n+            }\n+        });\n+\n+        // get pid and write it to the disk for later use\n+        String pid;\n+        try {\n+            pid = String.valueOf(nuxeoProcess.pid());\n+        } catch (UnsupportedOperationException e) {\n+            log.warn(\"Unable to get process ID from process: {}, please report it to Nuxeo\", nuxeoProcess);\n+            // fallback on process manager\n+            pid = processManager.findPid(processRegex).orElse(null);\n+        }\n+        if (pid == null) {\n+            log.warn(\"Sent server start command but could not get process ID.\");\n+        } else {\n+            log.warn(\"Server started with process ID {}.\", pid);\n+            File pidFile = new File(configurationGenerator.getPidDir(), \"nuxeo.pid\");\n+            try (FileWriter writer = new FileWriter(pidFile)) {\n+                writer.write(pid);\n+            }\n+        }\n+        return nuxeoProcess;\n+    }\n+\n+    protected void waitForEffectiveStart(Process nuxeoProcess) throws InterruptedException {\n         int startMaxWait = Integer.parseInt(\n-                configurationGenerator.getUserConfig().getProperty(START_MAX_WAIT_PARAM, getDefaultMaxWait()));\n+                configurationGenerator.getUserConfig().getProperty(START_MAX_WAIT_PARAM, START_MAX_WAIT_DEFAULT));\n+        var startTime = Instant.now();\n+        var waitUntil = startTime.plusSeconds(startMaxWait);\n         log.debug(\"Will wait for effective start during {} seconds.\", startMaxWait);\n         final StringBuilder startSummary = new StringBuilder();\n-        final String newLine = System.getProperty(\"line.separator\");\n-        boolean isReady = false;\n-        long deltaTime;\n-        // Wait for status servlet ready\n-        do {\n+        // Wait for effective start reported from status servlet\n+        boolean servletAvailable = false;\n+        int n = 0;\n+        while (Instant.now().isBefore(waitUntil) && nuxeoProcess.isAlive()) {\n             try {\n-                isReady = statusServletClient.init();\n-            } catch (SocketTimeoutException e) {\n-                if (!quiet) {\n-                    System.out.print(\".\");\n+                // delay will be 1s 10 times, then 2s 10 times... until reaching maximum of 1min\n+                Thread.sleep(Math.min((n % 10 + 1) * 1000, 60_000));\n+                if (servletAvailable && statusServletClient.isStarted()) {\n+                    if (!quiet) {\n+                        log.info(\".\");\n+                    }\n+                    break;\n+                } else {\n+                    statusServletClient.init();\n+                    servletAvailable = true;\n+                    n = 0;\n                 }\n-            }\n-            deltaTime = (new Date().getTime() - startTime) / 1000;\n-        } while (!isReady && deltaTime < startMaxWait && isRunning());\n-        // Wait for effective start reported from status servlet\n-        do {\n-            isReady = isStarted();\n-            if (!isReady) {\n+            } catch (SocketTimeoutException e) {\n                 if (!quiet) {\n-                    System.out.print(\".\");\n+                    log.info(NO_NEW_LINE, \".\");\n                 }\n-                Thread.sleep(1000);\n             }\n-            deltaTime = (new Date().getTime() - startTime) / 1000;\n-        } while (!isReady && deltaTime < startMaxWait && isRunning());\n-        if (isReady) {\n-            startSummary.append(newLine).append(getStartupSummary());\n-            long duration = (new Date().getTime() - startTime) / 1000;\n-            startSummary.append(String.format(\"Started in %dmin%02ds\", duration / 60, duration % 60));\n-            if (wasStartupFine()) {\n-                if (!quiet) {\n-                    System.out.println(startSummary);\n-                }\n-            } else {\n-                System.err.println(startSummary);\n-                if (strict) {\n-                    errorValue = EXIT_CODE_ERROR;\n-                    log.error(\"Shutting down because of unstarted component in strict mode...\");\n-                    stop();\n-                    return false;\n-                }\n+        }\n+\n+        if (Instant.now().isAfter(waitUntil)) {\n+            throw new NuxeoLauncherException(\"Starting process is taking too long - giving up.\", EXIT_CODE_ERROR);\n+        }\n+        if (!nuxeoProcess.isAlive()) {\n+            // Nuxeo has crashed - try to get its System.out\n+            String logs;\n+            try {\n+                logs = IOUtils.toString(nuxeoProcess.getInputStream(), UTF_8);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95dbe2ea46e28d527785051f3645ae4855ba1ad3"}, "originalPosition": 573}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5OTQ0NjI1", "url": "https://github.com/nuxeo/nuxeo/pull/3893#pullrequestreview-389944625", "createdAt": "2020-04-08T12:53:53Z", "commit": {"oid": "95dbe2ea46e28d527785051f3645ae4855ba1ad3"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMjo1Mzo1M1rOGCt0gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNjoyNjo0OFrOGC3ITg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUwMTA1OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                log.error(\"Error during Framework Listener execution : \" + listener.getClass(), e);\n          \n          \n            \n                                log.error(\"Error during Framework Listener execution: \" + listener.getClass(), e);", "url": "https://github.com/nuxeo/nuxeo/pull/3893#discussion_r405501059", "createdAt": "2020-04-08T12:53:53Z", "author": {"login": "troger"}, "path": "modules/runtime/nuxeo-runtime-osgi/src/main/java/org/nuxeo/osgi/OSGiAdapter.java", "diffHunk": "@@ -223,9 +223,10 @@ public void fireFrameworkEvent(FrameworkEvent event) {\n                 ((FrameworkListener) listener).frameworkEvent(event);\n                 log.debug(\"End execution of \" + listener.getClass() + \" listener\");\n             } catch (RuntimeException e) {\n-                log.error(\"Error during Framework Listener execution : \" + listener.getClass(), e);\n                 if (Boolean.getBoolean(\"nuxeo.start.strict\")) {\n                     throw e;\n+                } else {\n+                    log.error(\"Error during Framework Listener execution : \" + listener.getClass(), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95dbe2ea46e28d527785051f3645ae4855ba1ad3"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUxNTIzMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final  String basename;\n          \n          \n            \n                private final String basename;", "url": "https://github.com/nuxeo/nuxeo/pull/3893#discussion_r405515233", "createdAt": "2020-04-08T13:15:22Z", "author": {"login": "troger"}, "path": "server/nuxeo-launcher/src/main/java/org/nuxeo/launcher/daemon/DaemonThreadFactory.java", "diffHunk": "@@ -34,9 +33,9 @@\n \n     private static final AtomicInteger count = new AtomicInteger(0);\n \n-    private String basename;\n+    private final  String basename;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97145bc9615d9ddf14e97af0189d8b46aadfd0bd"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY1MTIyMA==", "bodyText": "processPattern maybe? To match all the manager constructors?", "url": "https://github.com/nuxeo/nuxeo/pull/3893#discussion_r405651220", "createdAt": "2020-04-08T16:23:25Z", "author": {"login": "troger"}, "path": "server/nuxeo-launcher/src/main/java/org/nuxeo/launcher/process/ProcessManager.java", "diffHunk": "@@ -1,32 +1,83 @@\n-//\n-// JODConverter - Java OpenDocument Converter\n-// Copyright 2009 Art of Solving Ltd\n-// Copyright 2004-2009 Mirko Nasato\n-//\n-// JODConverter is free software: you can redistribute it and/or\n-// modify it under the terms of the GNU Lesser General Public License\n-// as published by the Free Software Foundation, either version 3 of\n-// the License, or (at your option) any later version.\n-//\n-// JODConverter is distributed in the hope that it will be useful,\n-// but WITHOUT ANY WARRANTY; without even the implied warranty of\n-// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n-// Lesser General Public License for more details.\n-//\n-// You should have received a copy of the GNU Lesser General\n-// Public License along with JODConverter.  If not, see\n-// <http://www.gnu.org/licenses/>.\n-//\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ *  Contributors:\n+ *      Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+\n package org.nuxeo.launcher.process;\n \n import java.io.IOException;\n+import java.util.Optional;\n+import java.util.regex.Pattern;\n+\n+import org.apache.commons.lang3.SystemUtils;\n+\n+/**\n+ * @since 11.1\n+ */\n+public class ProcessManager {\n+\n+    protected final Pattern commandPattern;\n \n-public interface ProcessManager {\n+    protected ProcessManager(Pattern commandPattern) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ed143704b81acc8b4c6da23a45763142a965cd3"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY1MzAxNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                protected List<String> execute0(String... command) throws IOException {\n          \n          \n            \n                protected List<String> execute0(String... commands) throws IOException {", "url": "https://github.com/nuxeo/nuxeo/pull/3893#discussion_r405653016", "createdAt": "2020-04-08T16:25:58Z", "author": {"login": "troger"}, "path": "server/nuxeo-launcher/src/main/java/org/nuxeo/launcher/process/UnixProcessManager.java", "diffHunk": "@@ -32,47 +33,52 @@\n  * {@link ProcessManager} implementation for *nix systems. Uses the <tt>ps</tt> and <tt>kill</tt> commands.\n  * <p>\n  * Works for Linux. Works for Solaris too, except that the command line string returned by <tt>ps</tt> there is limited\n- * to 80 characters and this affects {@link #findPid(String)}.\n+ * to 80 characters and this affects {@link #findPid()}.\n  */\n-public class UnixProcessManager implements ProcessManager {\n-\n-    protected static final boolean PID_ENABLED = true;\n+public class UnixProcessManager extends ProcessManager {\n \n     private static final Pattern PS_OUTPUT_LINE = Pattern.compile(\"^\\\\s*(\\\\d+)\\\\s+(.*)$\");\n \n+    protected UnixProcessManager(Pattern processPattern) {\n+        super(processPattern);\n+    }\n+\n     protected String[] psCommand() {\n         return new String[] { \"/bin/ps\", \"-e\", \"-o\", \"pid,args\" };\n     }\n \n     @Override\n-    public String findPid(String regex) throws IOException {\n-        Pattern commandPattern = Pattern.compile(regex);\n-        for (String line : execute(psCommand())) {\n-            Matcher lineMatcher = PS_OUTPUT_LINE.matcher(line);\n+    public Optional<String> findPid() throws IOException {\n+        for (String line : execute0(psCommand())) {\n+            Matcher lineMatcher = lineMatcher(line);\n             if (lineMatcher.matches()) {\n                 String command = lineMatcher.group(2);\n                 Matcher commandMatcher = commandPattern.matcher(command);\n                 if (commandMatcher.find()) {\n-                    return lineMatcher.group(1);\n+                    return Optional.ofNullable(lineMatcher.group(1));\n                 }\n             }\n         }\n-        return null;\n+        return super.findPid();\n+    }\n+\n+    protected Matcher lineMatcher(String line) {\n+        return PS_OUTPUT_LINE.matcher(line);\n     }\n \n     @Override\n-    public void kill(Process process, String pid) throws IOException {\n-        execute(\"/bin/kill\", \"-KILL\", pid);\n+    public void kill(ProcessHandle processHandle) throws IOException {\n+        execute0(\"/bin/kill\", \"-KILL\", String.valueOf(processHandle.pid()));\n     }\n \n-    protected List<String> execute(String... command) throws IOException {\n-        Process process = new ProcessBuilder(command).start();\n-        return IOUtils.readLines(process.getInputStream(), UTF_8);\n+    // non-static method to allow tests to mock it\n+    protected List<String> execute0(String... command) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ed143704b81acc8b4c6da23a45763142a965cd3"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY1MzEzMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                protected static List<String> execute(String... command) throws IOException {\n          \n          \n            \n                protected static List<String> execute(String... commands) throws IOException {", "url": "https://github.com/nuxeo/nuxeo/pull/3893#discussion_r405653132", "createdAt": "2020-04-08T16:26:08Z", "author": {"login": "troger"}, "path": "server/nuxeo-launcher/src/main/java/org/nuxeo/launcher/process/UnixProcessManager.java", "diffHunk": "@@ -32,47 +33,52 @@\n  * {@link ProcessManager} implementation for *nix systems. Uses the <tt>ps</tt> and <tt>kill</tt> commands.\n  * <p>\n  * Works for Linux. Works for Solaris too, except that the command line string returned by <tt>ps</tt> there is limited\n- * to 80 characters and this affects {@link #findPid(String)}.\n+ * to 80 characters and this affects {@link #findPid()}.\n  */\n-public class UnixProcessManager implements ProcessManager {\n-\n-    protected static final boolean PID_ENABLED = true;\n+public class UnixProcessManager extends ProcessManager {\n \n     private static final Pattern PS_OUTPUT_LINE = Pattern.compile(\"^\\\\s*(\\\\d+)\\\\s+(.*)$\");\n \n+    protected UnixProcessManager(Pattern processPattern) {\n+        super(processPattern);\n+    }\n+\n     protected String[] psCommand() {\n         return new String[] { \"/bin/ps\", \"-e\", \"-o\", \"pid,args\" };\n     }\n \n     @Override\n-    public String findPid(String regex) throws IOException {\n-        Pattern commandPattern = Pattern.compile(regex);\n-        for (String line : execute(psCommand())) {\n-            Matcher lineMatcher = PS_OUTPUT_LINE.matcher(line);\n+    public Optional<String> findPid() throws IOException {\n+        for (String line : execute0(psCommand())) {\n+            Matcher lineMatcher = lineMatcher(line);\n             if (lineMatcher.matches()) {\n                 String command = lineMatcher.group(2);\n                 Matcher commandMatcher = commandPattern.matcher(command);\n                 if (commandMatcher.find()) {\n-                    return lineMatcher.group(1);\n+                    return Optional.ofNullable(lineMatcher.group(1));\n                 }\n             }\n         }\n-        return null;\n+        return super.findPid();\n+    }\n+\n+    protected Matcher lineMatcher(String line) {\n+        return PS_OUTPUT_LINE.matcher(line);\n     }\n \n     @Override\n-    public void kill(Process process, String pid) throws IOException {\n-        execute(\"/bin/kill\", \"-KILL\", pid);\n+    public void kill(ProcessHandle processHandle) throws IOException {\n+        execute0(\"/bin/kill\", \"-KILL\", String.valueOf(processHandle.pid()));\n     }\n \n-    protected List<String> execute(String... command) throws IOException {\n-        Process process = new ProcessBuilder(command).start();\n-        return IOUtils.readLines(process.getInputStream(), UTF_8);\n+    // non-static method to allow tests to mock it\n+    protected List<String> execute0(String... command) throws IOException {\n+        return execute(command);\n     }\n \n-    @Override\n-    public boolean canFindPid() {\n-        return PID_ENABLED;\n+    protected static List<String> execute(String... command) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ed143704b81acc8b4c6da23a45763142a965cd3"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY1MzU4Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static List<String> execute(String... command) throws IOException {\n          \n          \n            \n                private static List<String> execute(String... commands) throws IOException {", "url": "https://github.com/nuxeo/nuxeo/pull/3893#discussion_r405653582", "createdAt": "2020-04-08T16:26:48Z", "author": {"login": "troger"}, "path": "server/nuxeo-launcher/src/main/java/org/nuxeo/launcher/process/WindowsProcessManager.java", "diffHunk": "@@ -15,45 +16,36 @@\n  * Requires wmic.exe and taskkill.exe, that should be available at least on Windows XP, Windows Vista, and Windows 7\n  * (except Home versions).\n  */\n-public class WindowsProcessManager implements ProcessManager {\n-\n-    protected static final boolean PID_ENABLED = true;\n+public class WindowsProcessManager extends ProcessManager {\n \n     private static final Pattern PROCESS_GET_LINE = Pattern.compile(\"^(.*?)\\\\s+(\\\\d+)\\\\s*$\");\n \n+    protected WindowsProcessManager(Pattern processPattern) {\n+        super(processPattern);\n+    }\n+\n     @Override\n-    public String findPid(String regex) throws IOException {\n-        Pattern commandPattern = Pattern.compile(regex);\n+    public Optional<String> findPid() throws IOException {\n         for (String line : execute(\"wmic\", \"process\", \"get\", \"CommandLine,ProcessId\")) {\n             Matcher lineMatcher = PROCESS_GET_LINE.matcher(line);\n             if (lineMatcher.matches()) {\n                 String commandLine = lineMatcher.group(1);\n                 String pid = lineMatcher.group(2);\n                 Matcher commandMatcher = commandPattern.matcher(commandLine);\n                 if (commandMatcher.find()) {\n-                    return pid;\n+                    return Optional.of(pid);\n                 }\n             }\n         }\n-        return null;\n+        return super.findPid();\n     }\n \n     @Override\n-    public void kill(Process process, String pid) throws IOException {\n-        execute(\"taskkill\", \"/t\", \"/f\", \"/pid\", pid);\n-    }\n-\n-    public boolean isUsable() {\n-        try {\n-            execute(\"wmic\", \"quit\");\n-            execute(\"taskkill\", \"/?\");\n-            return true;\n-        } catch (IOException ioException) {\n-            return false;\n-        }\n+    public void kill(ProcessHandle processHandle) throws IOException {\n+        execute(\"taskkill\", \"/t\", \"/f\", \"/pid\", String.valueOf(processHandle.pid()));\n     }\n \n-    private List<String> execute(String... command) throws IOException {\n+    private static List<String> execute(String... command) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ed143704b81acc8b4c6da23a45763142a965cd3"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMzI1NDg5", "url": "https://github.com/nuxeo/nuxeo/pull/3893#pullrequestreview-390325489", "createdAt": "2020-04-08T20:56:11Z", "commit": {"oid": "7ed143704b81acc8b4c6da23a45763142a965cd3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMDo1NjoxMVrOGDApyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMDo1NjoxMVrOGDApyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgwOTYwOA==", "bodyText": "Why not return an OptionalLong instead? It would avoid various map / valueOf stages.", "url": "https://github.com/nuxeo/nuxeo/pull/3893#discussion_r405809608", "createdAt": "2020-04-08T20:56:11Z", "author": {"login": "efge"}, "path": "server/nuxeo-launcher/src/main/java/org/nuxeo/launcher/process/ProcessManager.java", "diffHunk": "@@ -1,32 +1,83 @@\n-//\n-// JODConverter - Java OpenDocument Converter\n-// Copyright 2009 Art of Solving Ltd\n-// Copyright 2004-2009 Mirko Nasato\n-//\n-// JODConverter is free software: you can redistribute it and/or\n-// modify it under the terms of the GNU Lesser General Public License\n-// as published by the Free Software Foundation, either version 3 of\n-// the License, or (at your option) any later version.\n-//\n-// JODConverter is distributed in the hope that it will be useful,\n-// but WITHOUT ANY WARRANTY; without even the implied warranty of\n-// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n-// Lesser General Public License for more details.\n-//\n-// You should have received a copy of the GNU Lesser General\n-// Public License along with JODConverter.  If not, see\n-// <http://www.gnu.org/licenses/>.\n-//\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ *  Contributors:\n+ *      Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+\n package org.nuxeo.launcher.process;\n \n import java.io.IOException;\n+import java.util.Optional;\n+import java.util.regex.Pattern;\n+\n+import org.apache.commons.lang3.SystemUtils;\n+\n+/**\n+ * @since 11.1\n+ */\n+public class ProcessManager {\n+\n+    protected final Pattern commandPattern;\n \n-public interface ProcessManager {\n+    protected ProcessManager(Pattern commandPattern) {\n+        this.commandPattern = commandPattern;\n+    }\n \n-    void kill(Process process, String pid) throws IOException;\n+    /**\n+     * Finds the pid associated to the regex used to build this manager.\n+     */\n+    public Optional<String> findPid() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ed143704b81acc8b4c6da23a45763142a965cd3"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMzI3MzEz", "url": "https://github.com/nuxeo/nuxeo/pull/3893#pullrequestreview-390327313", "createdAt": "2020-04-08T20:58:57Z", "commit": {"oid": "7ed143704b81acc8b4c6da23a45763142a965cd3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMDo1ODo1N1rOGDAwHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMDo1ODo1N1rOGDAwHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxMTIyOQ==", "bodyText": "The reordering of the start / waitForEffectiveStart methods makes the diff hard to read.", "url": "https://github.com/nuxeo/nuxeo/pull/3893#discussion_r405811229", "createdAt": "2020-04-08T20:58:57Z", "author": {"login": "efge"}, "path": "server/nuxeo-launcher/src/main/java/org/nuxeo/launcher/NuxeoLauncher.java", "diffHunk": "@@ -1814,131 +1563,232 @@ protected void setConfigProperties() throws ConfigurationException, IOException,\n         log.debug(\"Old values: {}\", oldValues);\n     }\n \n-    /**\n-     * @see #doStartAndWait(boolean)\n-     */\n-    public boolean doStartAndWait() throws PackageException {\n-        boolean started = doStartAndWait(false);\n-        if (started && !quiet) {\n-            log.info(\"Go to {}\", this::getURL);\n-        }\n-        return started;\n-    }\n-\n-    /**\n-     * @see #stop(boolean)\n-     */\n-    public void stop() {\n-        stop(false);\n-    }\n-\n     /**\n      * Call {@link #doStart(boolean)} with false as parameter.\n      *\n      * @see #doStart(boolean)\n      * @return true if the server started successfully\n      */\n-    public boolean doStart() throws PackageException {\n-        boolean started = doStart(false);\n-        if (started && !quiet) {\n-            log.info(\"Go to {}\", this::getURL);\n+    public boolean doStart() {\n+        if (doStart(false).isAlive()) {\n+            if (!quiet) {\n+                log.info(\"Go to {}\", this::getURL);\n+            }\n+            return true;\n         }\n-        return started;\n+        return false;\n     }\n \n     /**\n-     * Whereas {@link #doStart()} considers the server as started when the process is running, {@link #doStartAndWait()}\n-     * waits for effective start by watching the logs\n+     * Whereas {@link #doStart()} considers the server as started when the process is running, this method waits for\n+     * effective start by calling {@link #statusServletClient}.\n      *\n-     * @param logProcessOutput Must process output stream must be logged or not.\n      * @return true if the server started successfully\n      */\n-    public boolean doStartAndWait(boolean logProcessOutput) throws PackageException {\n-        boolean commandSucceeded = false;\n-        if (doStart(logProcessOutput)) {\n-            addShutdownHook();\n-            try {\n-                if (waitForEffectiveStart()) {\n-                    commandSucceeded = true;\n+    public boolean doStartAndWait() {\n+        var nuxeoProcess = doStart(false);\n+        if (nuxeoProcess.isAlive()) {\n+            // noinspection unused\n+            try (var hook = new ShutdownHook(this)) {\n+                waitForEffectiveStart(nuxeoProcess);\n+                if (!quiet) {\n+                    log.info(\"Go to {}\", this::getURL);\n                 }\n-                removeShutdownHook();\n+                return true;\n             } catch (InterruptedException e) {\n                 Thread.currentThread().interrupt();\n                 throw new RuntimeException(e);\n             }\n         }\n-        return commandSucceeded;\n+        return false;\n+    }\n+\n+    /**\n+     * @since 11.1\n+     */\n+    public void doConsole() {\n+        var hook = new ShutdownHook(this); // NOSONAR don't close the hook because doStart is not blocking\n+        try {\n+            doStart(true).onExit().thenAccept(p -> {\n+                hook.close();\n+                // always terminate, nuxeo process is not supposed to exit\n+                System.exit(EXIT_CODE_ERROR);\n+            });\n+        } catch (RuntimeException e) {\n+            // for errors in doStart\n+            hook.close();\n+            throw e;\n+        }\n+        if (!quiet) {\n+            log.info(\"Go to {}\", this::getURL);\n+        }\n     }\n \n-    protected void removeShutdownHook() {\n+    /**\n+     * Starts the server in background.\n+     *\n+     * @return the nuxeo process\n+     * @throws NuxeoLauncherException if an error occurred\n+     */\n+    protected Process doStart(boolean logProcessOutput) {\n         try {\n-            Runtime.getRuntime().removeShutdownHook(shutdownHook);\n-            log.debug(\"Removed shutdown hook\");\n+            configure();\n+            configurationGenerator.verifyInstallation();\n+\n+            log.debug(\"Check if install in progress...\");\n+            int tries = 0;\n+            while (configurationGenerator.isInstallInProgress()) {\n+                tries++;\n+                if (!getConnectBroker().executePending(configurationGenerator.getInstallFile(), true, true,\n+                        ignoreMissing) || tries > 9) {\n+                    throw new NuxeoLauncherException(String.format(\n+                            \"Start interrupted due to failure on pending actions. You can resume with a new start\"\n+                                    + \" or you can restore the file '%s', optionally using the '--%s' option.\",\n+                            configurationGenerator.getInstallFile().getName(), OPTION_IGNORE_MISSING), EXIT_CODE_ERROR);\n+                }\n+                // reload configuration\n+                configurationGenerator = new ConfigurationGenerator(quiet, debug);\n+                configurationGenerator.init();\n+                configure();\n+                configurationGenerator.verifyInstallation();\n+            }\n+            return start(logProcessOutput);\n+        } catch (ConfigurationException e) {\n+            throw new NuxeoLauncherException(\"Could not run configuration: \" + e.getMessage(), EXIT_CODE_NOT_CONFIGURED,\n+                    e);\n+        } catch (IOException e) {\n+            throw new NuxeoLauncherException(\"Could not start process: \" + e.getMessage(), EXIT_CODE_ERROR, e);\n         } catch (IllegalStateException e) {\n-            // the virtual machine is already in the process of shutting down\n+            // in strict mode assume program is not configured because of http port binding conflict for exit value\n+            throw new NuxeoLauncherException(\"Could not start process: \" + e.getMessage(),\n+                    strict ? EXIT_CODE_NOT_CONFIGURED : EXIT_CODE_ERROR, e);\n         }\n     }\n \n     /**\n-     * @return true if Nuxeo is ready\n+     * Do not directly call this method without a call to {@link #checkNoRunningServer()}\n+     *\n+     * @see #doStart()\n+     * @throws IOException in case of issue with process.\n      */\n-    protected boolean waitForEffectiveStart() throws InterruptedException {\n-        long startTime = new Date().getTime();\n+    protected Process start(boolean logProcessOutput) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ed143704b81acc8b4c6da23a45763142a965cd3"}, "originalPosition": 1313}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNjY2NzE1", "url": "https://github.com/nuxeo/nuxeo/pull/3893#pullrequestreview-390666715", "createdAt": "2020-04-09T10:16:40Z", "commit": {"oid": "c747fec234ab08d57ed2ea9fa3198d1ddf1a0e3d"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNjc3ODYz", "url": "https://github.com/nuxeo/nuxeo/pull/3893#pullrequestreview-390677863", "createdAt": "2020-04-09T10:34:15Z", "commit": {"oid": "c747fec234ab08d57ed2ea9fa3198d1ddf1a0e3d"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMzYzMTEz", "url": "https://github.com/nuxeo/nuxeo/pull/3893#pullrequestreview-391363113", "createdAt": "2020-04-10T09:50:05Z", "commit": {"oid": "95dbe2ea46e28d527785051f3645ae4855ba1ad3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwOTo1MDowNVrOGD2Tcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwOTo1MDowNVrOGD2Tcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY4ODYyNg==", "bodyText": "this is weird I don't see where n is incremented and if it is you will never reach 1min (retries will be spaced by 1s, 2s, ... 9s, 10s, then again 1s, ...)", "url": "https://github.com/nuxeo/nuxeo/pull/3893#discussion_r406688626", "createdAt": "2020-04-10T09:50:05Z", "author": {"login": "bdelbosc"}, "path": "server/nuxeo-launcher/src/main/java/org/nuxeo/launcher/NuxeoLauncher.java", "diffHunk": "@@ -1695,131 +1596,235 @@ protected void setConfigProperties() throws ConfigurationException, IOException,\n         log.debug(\"Old values: {}\", oldValues);\n     }\n \n-    /**\n-     * @see #doStartAndWait(boolean)\n-     */\n-    public boolean doStartAndWait() throws PackageException {\n-        boolean started = doStartAndWait(false);\n-        if (started && !quiet) {\n-            log.info(\"Go to {}\", this::getURL);\n-        }\n-        return started;\n-    }\n-\n-    /**\n-     * @see #stop(boolean)\n-     */\n-    public void stop() {\n-        stop(false);\n-    }\n-\n     /**\n      * Call {@link #doStart(boolean)} with false as parameter.\n      *\n      * @see #doStart(boolean)\n      * @return true if the server started successfully\n      */\n-    public boolean doStart() throws PackageException {\n-        boolean started = doStart(false);\n-        if (started && !quiet) {\n-            log.info(\"Go to {}\", this::getURL);\n+    public boolean doStart() {\n+        if (doStart(false).isAlive()) {\n+            if (!quiet) {\n+                log.info(\"Go to {}\", this::getURL);\n+            }\n+            return true;\n         }\n-        return started;\n+        return false;\n     }\n \n     /**\n-     * Whereas {@link #doStart()} considers the server as started when the process is running, {@link #doStartAndWait()}\n-     * waits for effective start by watching the logs\n+     * Whereas {@link #doStart()} considers the server as started when the process is running, this method waits for\n+     * effective start by calling {@link #statusServletClient}.\n      *\n-     * @param logProcessOutput Must process output stream must be logged or not.\n      * @return true if the server started successfully\n      */\n-    public boolean doStartAndWait(boolean logProcessOutput) throws PackageException {\n-        boolean commandSucceeded = false;\n-        if (doStart(logProcessOutput)) {\n-            addShutdownHook();\n-            try {\n-                if (waitForEffectiveStart()) {\n-                    commandSucceeded = true;\n+    public boolean doStartAndWait() {\n+        var nuxeoProcess = doStart(false);\n+        if (nuxeoProcess.isAlive()) {\n+            //noinspection unused\n+            try (var hook = new ShutdownHook(this)) { // NOSONAR try-with-resources\n+                waitForEffectiveStart(nuxeoProcess);\n+                if (!quiet) {\n+                    log.info(\"Go to {}\", this::getURL);\n                 }\n-                removeShutdownHook();\n+                return true;\n             } catch (InterruptedException e) {\n                 Thread.currentThread().interrupt();\n                 throw new RuntimeException(e);\n             }\n         }\n-        return commandSucceeded;\n+        return false;\n+    }\n+\n+    /**\n+     * @since 11.1\n+     */\n+    public void doConsole() {\n+        var hook = new ShutdownHook(this);\n+        try {\n+            doStart(true).onExit().thenAccept(p -> {\n+                hook.close();\n+                // always error, nuxeo process is not supposed to exit\n+                System.exit(EXIT_CODE_ERROR);\n+            });\n+        } catch (RuntimeException e) {\n+            // for errors in doStart\n+            hook.close();\n+            throw e;\n+        }\n+        if (!quiet) {\n+            log.info(\"Go to {}\", this::getURL);\n+        }\n     }\n \n-    protected void removeShutdownHook() {\n+    /**\n+     * Starts the server in background.\n+     *\n+     * @return the nuxeo process\n+     * @throws NuxeoLauncherException if an error occurred\n+     */\n+    protected Process doStart(boolean logProcessOutput) {\n+        errorValue = EXIT_CODE_OK;\n         try {\n-            Runtime.getRuntime().removeShutdownHook(shutdownHook);\n-            log.debug(\"Removed shutdown hook\");\n+            configure();\n+            configurationGenerator.verifyInstallation();\n+\n+            log.debug(\"Check if install in progress...\");\n+            int tries = 0;\n+            while (configurationGenerator.isInstallInProgress()) {\n+                tries++;\n+                if (!getConnectBroker().executePending(configurationGenerator.getInstallFile(), true, true,\n+                        ignoreMissing) || tries > 9) {\n+                    throw new NuxeoLauncherException(String.format(\n+                            \"Start interrupted due to failure on pending actions. You can resume with a new start\"\n+                                    + \" or you can restore the file '%s', optionally using the '--%s' option.\",\n+                            configurationGenerator.getInstallFile().getName(), OPTION_IGNORE_MISSING), EXIT_CODE_ERROR);\n+                }\n+                // reload configuration\n+                configurationGenerator = new ConfigurationGenerator(quiet, debug);\n+                configurationGenerator.init();\n+                configure();\n+                configurationGenerator.verifyInstallation();\n+            }\n+            return start(logProcessOutput);\n+        } catch (ConfigurationException e) {\n+            throw new NuxeoLauncherException(\"Could not run configuration: \" + e.getMessage(), EXIT_CODE_NOT_CONFIGURED,\n+                    e);\n+        } catch (IOException e) {\n+            throw new NuxeoLauncherException(\"Could not start process: \" + e.getMessage(), EXIT_CODE_ERROR, e);\n         } catch (IllegalStateException e) {\n-            // the virtual machine is already in the process of shutting down\n+            // in strict mode assume program is not configured because of http port binding conflict for exit value\n+            throw new NuxeoLauncherException(\"Could not start process: \" + e.getMessage(),\n+                    strict ? EXIT_CODE_NOT_CONFIGURED : EXIT_CODE_ERROR, e);\n         }\n     }\n \n     /**\n-     * @return true if Nuxeo is ready\n+     * Do not directly call this method without a call to {@link #checkNoRunningServer()}\n+     *\n+     * @see #doStart()\n+     * @throws IOException in case of issue with process.\n      */\n-    protected boolean waitForEffectiveStart() throws InterruptedException {\n-        long startTime = new Date().getTime();\n+    protected Process start(boolean logProcessOutput) throws IOException {\n+        // build command to start nuxeo\n+        List<String> startCommand = new ArrayList<>();\n+        startCommand.add(getJavaExecutable().getPath());\n+        startCommand.addAll(getJavaOptsProperty(Function.identity()));\n+        startCommand.add(\"-cp\");\n+        startCommand.add(getClassPath());\n+        startCommand.addAll(getNuxeoProperties());\n+        startCommand.addAll(getServerProperties());\n+        if (strict) {\n+            startCommand.add(\"-Dnuxeo.start.strict=true\");\n+        }\n+\n+        startCommand.add(TomcatConfigurator.STARTUP_CLASS);\n+        startCommand.add(\"start\");\n+        startCommand.addAll(Arrays.asList(params));\n+\n+        // build and start process\n+        ProcessBuilder pb = new ProcessBuilder(getOSCommand(startCommand));\n+        pb.directory(configurationGenerator.getNuxeoHome());\n+        if (logProcessOutput) {\n+            // don't redirect input as we want a graceful shutdown\n+            pb.redirectOutput(ProcessBuilder.Redirect.INHERIT).redirectError(ProcessBuilder.Redirect.INHERIT);\n+        }\n+        log.debug(\"Server command: {}\", pb::command);\n+        Process nuxeoProcess = pb.start();\n+        nuxeoProcess.onExit().thenAccept(p -> {\n+            if (SystemUtils.IS_OS_WINDOWS && configurationGenerator.getNuxeoHome().getPath().contains(\" \")) {\n+                // NXP-17679\n+                log.error(\"The server path must not contain spaces under Windows.\");\n+            }\n+            int exitValue = p.exitValue();\n+            if (exitValue != 0) {\n+                log.error(\"Server stopped with status: {}\", exitValue);\n+            }\n+        });\n+\n+        // get pid and write it to the disk for later use\n+        String pid;\n+        try {\n+            pid = String.valueOf(nuxeoProcess.pid());\n+        } catch (UnsupportedOperationException e) {\n+            log.warn(\"Unable to get process ID from process: {}, please report it to Nuxeo\", nuxeoProcess);\n+            // fallback on process manager\n+            pid = processManager.findPid(processRegex).orElse(null);\n+        }\n+        if (pid == null) {\n+            log.warn(\"Sent server start command but could not get process ID.\");\n+        } else {\n+            log.warn(\"Server started with process ID {}.\", pid);\n+            File pidFile = new File(configurationGenerator.getPidDir(), \"nuxeo.pid\");\n+            try (FileWriter writer = new FileWriter(pidFile)) {\n+                writer.write(pid);\n+            }\n+        }\n+        return nuxeoProcess;\n+    }\n+\n+    protected void waitForEffectiveStart(Process nuxeoProcess) throws InterruptedException {\n         int startMaxWait = Integer.parseInt(\n-                configurationGenerator.getUserConfig().getProperty(START_MAX_WAIT_PARAM, getDefaultMaxWait()));\n+                configurationGenerator.getUserConfig().getProperty(START_MAX_WAIT_PARAM, START_MAX_WAIT_DEFAULT));\n+        var startTime = Instant.now();\n+        var waitUntil = startTime.plusSeconds(startMaxWait);\n         log.debug(\"Will wait for effective start during {} seconds.\", startMaxWait);\n         final StringBuilder startSummary = new StringBuilder();\n-        final String newLine = System.getProperty(\"line.separator\");\n-        boolean isReady = false;\n-        long deltaTime;\n-        // Wait for status servlet ready\n-        do {\n+        // Wait for effective start reported from status servlet\n+        boolean servletAvailable = false;\n+        int n = 0;\n+        while (Instant.now().isBefore(waitUntil) && nuxeoProcess.isAlive()) {\n             try {\n-                isReady = statusServletClient.init();\n-            } catch (SocketTimeoutException e) {\n-                if (!quiet) {\n-                    System.out.print(\".\");\n+                // delay will be 1s 10 times, then 2s 10 times... until reaching maximum of 1min\n+                Thread.sleep(Math.min((n % 10 + 1) * 1000, 60_000));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95dbe2ea46e28d527785051f3645ae4855ba1ad3"}, "originalPosition": 520}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMzY3NjM5", "url": "https://github.com/nuxeo/nuxeo/pull/3893#pullrequestreview-391367639", "createdAt": "2020-04-10T10:01:37Z", "commit": {"oid": "95dbe2ea46e28d527785051f3645ae4855ba1ad3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMDowMTozN1rOGD2ixQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMDowMTozN1rOGD2ixQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY5MjU0OQ==", "bodyText": "If you could remove this trailing \".\" after the PID, it would finally be possible to copy the PID directly with the mouse, this will be a major UX improvement!", "url": "https://github.com/nuxeo/nuxeo/pull/3893#discussion_r406692549", "createdAt": "2020-04-10T10:01:37Z", "author": {"login": "bdelbosc"}, "path": "server/nuxeo-launcher/src/main/java/org/nuxeo/launcher/NuxeoLauncher.java", "diffHunk": "@@ -1695,131 +1596,235 @@ protected void setConfigProperties() throws ConfigurationException, IOException,\n         log.debug(\"Old values: {}\", oldValues);\n     }\n \n-    /**\n-     * @see #doStartAndWait(boolean)\n-     */\n-    public boolean doStartAndWait() throws PackageException {\n-        boolean started = doStartAndWait(false);\n-        if (started && !quiet) {\n-            log.info(\"Go to {}\", this::getURL);\n-        }\n-        return started;\n-    }\n-\n-    /**\n-     * @see #stop(boolean)\n-     */\n-    public void stop() {\n-        stop(false);\n-    }\n-\n     /**\n      * Call {@link #doStart(boolean)} with false as parameter.\n      *\n      * @see #doStart(boolean)\n      * @return true if the server started successfully\n      */\n-    public boolean doStart() throws PackageException {\n-        boolean started = doStart(false);\n-        if (started && !quiet) {\n-            log.info(\"Go to {}\", this::getURL);\n+    public boolean doStart() {\n+        if (doStart(false).isAlive()) {\n+            if (!quiet) {\n+                log.info(\"Go to {}\", this::getURL);\n+            }\n+            return true;\n         }\n-        return started;\n+        return false;\n     }\n \n     /**\n-     * Whereas {@link #doStart()} considers the server as started when the process is running, {@link #doStartAndWait()}\n-     * waits for effective start by watching the logs\n+     * Whereas {@link #doStart()} considers the server as started when the process is running, this method waits for\n+     * effective start by calling {@link #statusServletClient}.\n      *\n-     * @param logProcessOutput Must process output stream must be logged or not.\n      * @return true if the server started successfully\n      */\n-    public boolean doStartAndWait(boolean logProcessOutput) throws PackageException {\n-        boolean commandSucceeded = false;\n-        if (doStart(logProcessOutput)) {\n-            addShutdownHook();\n-            try {\n-                if (waitForEffectiveStart()) {\n-                    commandSucceeded = true;\n+    public boolean doStartAndWait() {\n+        var nuxeoProcess = doStart(false);\n+        if (nuxeoProcess.isAlive()) {\n+            //noinspection unused\n+            try (var hook = new ShutdownHook(this)) { // NOSONAR try-with-resources\n+                waitForEffectiveStart(nuxeoProcess);\n+                if (!quiet) {\n+                    log.info(\"Go to {}\", this::getURL);\n                 }\n-                removeShutdownHook();\n+                return true;\n             } catch (InterruptedException e) {\n                 Thread.currentThread().interrupt();\n                 throw new RuntimeException(e);\n             }\n         }\n-        return commandSucceeded;\n+        return false;\n+    }\n+\n+    /**\n+     * @since 11.1\n+     */\n+    public void doConsole() {\n+        var hook = new ShutdownHook(this);\n+        try {\n+            doStart(true).onExit().thenAccept(p -> {\n+                hook.close();\n+                // always error, nuxeo process is not supposed to exit\n+                System.exit(EXIT_CODE_ERROR);\n+            });\n+        } catch (RuntimeException e) {\n+            // for errors in doStart\n+            hook.close();\n+            throw e;\n+        }\n+        if (!quiet) {\n+            log.info(\"Go to {}\", this::getURL);\n+        }\n     }\n \n-    protected void removeShutdownHook() {\n+    /**\n+     * Starts the server in background.\n+     *\n+     * @return the nuxeo process\n+     * @throws NuxeoLauncherException if an error occurred\n+     */\n+    protected Process doStart(boolean logProcessOutput) {\n+        errorValue = EXIT_CODE_OK;\n         try {\n-            Runtime.getRuntime().removeShutdownHook(shutdownHook);\n-            log.debug(\"Removed shutdown hook\");\n+            configure();\n+            configurationGenerator.verifyInstallation();\n+\n+            log.debug(\"Check if install in progress...\");\n+            int tries = 0;\n+            while (configurationGenerator.isInstallInProgress()) {\n+                tries++;\n+                if (!getConnectBroker().executePending(configurationGenerator.getInstallFile(), true, true,\n+                        ignoreMissing) || tries > 9) {\n+                    throw new NuxeoLauncherException(String.format(\n+                            \"Start interrupted due to failure on pending actions. You can resume with a new start\"\n+                                    + \" or you can restore the file '%s', optionally using the '--%s' option.\",\n+                            configurationGenerator.getInstallFile().getName(), OPTION_IGNORE_MISSING), EXIT_CODE_ERROR);\n+                }\n+                // reload configuration\n+                configurationGenerator = new ConfigurationGenerator(quiet, debug);\n+                configurationGenerator.init();\n+                configure();\n+                configurationGenerator.verifyInstallation();\n+            }\n+            return start(logProcessOutput);\n+        } catch (ConfigurationException e) {\n+            throw new NuxeoLauncherException(\"Could not run configuration: \" + e.getMessage(), EXIT_CODE_NOT_CONFIGURED,\n+                    e);\n+        } catch (IOException e) {\n+            throw new NuxeoLauncherException(\"Could not start process: \" + e.getMessage(), EXIT_CODE_ERROR, e);\n         } catch (IllegalStateException e) {\n-            // the virtual machine is already in the process of shutting down\n+            // in strict mode assume program is not configured because of http port binding conflict for exit value\n+            throw new NuxeoLauncherException(\"Could not start process: \" + e.getMessage(),\n+                    strict ? EXIT_CODE_NOT_CONFIGURED : EXIT_CODE_ERROR, e);\n         }\n     }\n \n     /**\n-     * @return true if Nuxeo is ready\n+     * Do not directly call this method without a call to {@link #checkNoRunningServer()}\n+     *\n+     * @see #doStart()\n+     * @throws IOException in case of issue with process.\n      */\n-    protected boolean waitForEffectiveStart() throws InterruptedException {\n-        long startTime = new Date().getTime();\n+    protected Process start(boolean logProcessOutput) throws IOException {\n+        // build command to start nuxeo\n+        List<String> startCommand = new ArrayList<>();\n+        startCommand.add(getJavaExecutable().getPath());\n+        startCommand.addAll(getJavaOptsProperty(Function.identity()));\n+        startCommand.add(\"-cp\");\n+        startCommand.add(getClassPath());\n+        startCommand.addAll(getNuxeoProperties());\n+        startCommand.addAll(getServerProperties());\n+        if (strict) {\n+            startCommand.add(\"-Dnuxeo.start.strict=true\");\n+        }\n+\n+        startCommand.add(TomcatConfigurator.STARTUP_CLASS);\n+        startCommand.add(\"start\");\n+        startCommand.addAll(Arrays.asList(params));\n+\n+        // build and start process\n+        ProcessBuilder pb = new ProcessBuilder(getOSCommand(startCommand));\n+        pb.directory(configurationGenerator.getNuxeoHome());\n+        if (logProcessOutput) {\n+            // don't redirect input as we want a graceful shutdown\n+            pb.redirectOutput(ProcessBuilder.Redirect.INHERIT).redirectError(ProcessBuilder.Redirect.INHERIT);\n+        }\n+        log.debug(\"Server command: {}\", pb::command);\n+        Process nuxeoProcess = pb.start();\n+        nuxeoProcess.onExit().thenAccept(p -> {\n+            if (SystemUtils.IS_OS_WINDOWS && configurationGenerator.getNuxeoHome().getPath().contains(\" \")) {\n+                // NXP-17679\n+                log.error(\"The server path must not contain spaces under Windows.\");\n+            }\n+            int exitValue = p.exitValue();\n+            if (exitValue != 0) {\n+                log.error(\"Server stopped with status: {}\", exitValue);\n+            }\n+        });\n+\n+        // get pid and write it to the disk for later use\n+        String pid;\n+        try {\n+            pid = String.valueOf(nuxeoProcess.pid());\n+        } catch (UnsupportedOperationException e) {\n+            log.warn(\"Unable to get process ID from process: {}, please report it to Nuxeo\", nuxeoProcess);\n+            // fallback on process manager\n+            pid = processManager.findPid(processRegex).orElse(null);\n+        }\n+        if (pid == null) {\n+            log.warn(\"Sent server start command but could not get process ID.\");\n+        } else {\n+            log.warn(\"Server started with process ID {}.\", pid);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95dbe2ea46e28d527785051f3645ae4855ba1ad3"}, "originalPosition": 488}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c747fec234ab08d57ed2ea9fa3198d1ddf1a0e3d", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/c747fec234ab08d57ed2ea9fa3198d1ddf1a0e3d", "committedDate": "2020-04-09T08:58:55Z", "message": "To fixup process manager rework"}, "afterCommit": {"oid": "4c5bc1397a6ade6193e675467fae503fc69262ee", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/4c5bc1397a6ade6193e675467fae503fc69262ee", "committedDate": "2020-04-10T12:09:23Z", "message": "NXP-28396: Rework error handling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNDIyNTk1", "url": "https://github.com/nuxeo/nuxeo/pull/3893#pullrequestreview-391422595", "createdAt": "2020-04-10T12:43:15Z", "commit": {"oid": "95dbe2ea46e28d527785051f3645ae4855ba1ad3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMjo0NToyN1rOGD5h7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMjo0NToyN1rOGD5h7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc0MTQ4Ng==", "bodyText": "Not sure to understand does this mean that \"nuxeoctl console\" use stdout and stderr except\nwhen SIGINT is received?\nwhat do you mean by \"console output\" is it \"nuxeoctl console\" output or appender console output?\nAlso, Ctrl-C is an interrupt signal not exit signal", "url": "https://github.com/nuxeo/nuxeo/pull/3893#discussion_r406741486", "createdAt": "2020-04-10T12:45:27Z", "author": {"login": "bdelbosc"}, "path": "server/nuxeo-launcher/src/main/resources/log4j2.xml", "diffHunk": "@@ -1,9 +1,30 @@\n <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n-<Configuration>\n+<Configuration shutdownHook=\"disable\">\n+  <!--\n+    Nuxeo Launcher log4j2 configuration file (aka nuxeoctl).\n+    We define two console appenders, one for stdout and one for stderr.\n+    When using nuxeo in console mode and an exit signal is received (ctrl+c), console output becomes the stderr output,\n+    thus the need of two appenders.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a444806a0e563ed64c6bff61a76118be5e921b7"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d2c692da54559046ef22a1f84cf27d478bfed42", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/9d2c692da54559046ef22a1f84cf27d478bfed42", "committedDate": "2020-04-14T11:05:47Z", "message": "NXP-28396: Cleanup / Format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf69d50630406aead2427fb43fbe32a2d645c7ec", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/cf69d50630406aead2427fb43fbe32a2d645c7ec", "committedDate": "2020-04-14T11:05:50Z", "message": "NXP-28396: Remove unused code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b1e926b1b166cde2b3136ee675e532d1058aaec", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/3b1e926b1b166cde2b3136ee675e532d1058aaec", "committedDate": "2020-04-14T11:05:51Z", "message": "NXP-28396: Reorganizer methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96a5cfd0af40cd50337e660db3a15844a107c093", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/96a5cfd0af40cd50337e660db3a15844a107c093", "committedDate": "2020-04-14T11:19:19Z", "message": "NXP-28396: Rework nuxeo start to make nuxeoctl console not blocking"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fcdae8643dc902ac3bc2cfbfdbe327061ed8d90", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/1fcdae8643dc902ac3bc2cfbfdbe327061ed8d90", "committedDate": "2020-04-14T11:19:19Z", "message": "NXP-28396: Rework ProcessManager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01a75d317a902bec4be4c8d62743099ec263e652", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/01a75d317a902bec4be4c8d62743099ec263e652", "committedDate": "2020-04-14T11:19:19Z", "message": "NXP-28396: Rework error handling"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4c5bc1397a6ade6193e675467fae503fc69262ee", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/4c5bc1397a6ade6193e675467fae503fc69262ee", "committedDate": "2020-04-10T12:09:23Z", "message": "NXP-28396: Rework error handling"}, "afterCommit": {"oid": "01a75d317a902bec4be4c8d62743099ec263e652", "author": {"user": {"login": "kevinleturc", "name": "Kevin Leturc"}}, "url": "https://github.com/nuxeo/nuxeo/commit/01a75d317a902bec4be4c8d62743099ec263e652", "committedDate": "2020-04-14T11:19:19Z", "message": "NXP-28396: Rework error handling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzNjE2MTgz", "url": "https://github.com/nuxeo/nuxeo/pull/3893#pullrequestreview-393616183", "createdAt": "2020-04-15T09:41:53Z", "commit": {"oid": "01a75d317a902bec4be4c8d62743099ec263e652"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzNjE5NzY1", "url": "https://github.com/nuxeo/nuxeo/pull/3893#pullrequestreview-393619765", "createdAt": "2020-04-15T09:46:41Z", "commit": {"oid": "01a75d317a902bec4be4c8d62743099ec263e652"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4824, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}