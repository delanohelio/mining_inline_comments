{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwODg5MzU1", "number": 4269, "reviewThreads": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxMzowNDoyOFrOEahJcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMzozMToyNVrOEcEe-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk2MjQxNTIyOnYy", "diffSide": "RIGHT", "path": "modules/runtime/nuxeo-launcher-commons/src/main/java/org/nuxeo/launcher/config/BackingServiceConfigurator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxMzowNDoyOFrOHD_ytg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQwODowNjoxMVrOHEhNMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk1Mjk1MA==", "bodyText": "What about replacing current logger by the Log4j2 one and using the lambda feature?", "url": "https://github.com/nuxeo/nuxeo/pull/4269#discussion_r473952950", "createdAt": "2020-08-20T13:04:28Z", "author": {"login": "kevinleturc"}, "path": "modules/runtime/nuxeo-launcher-commons/src/main/java/org/nuxeo/launcher/config/BackingServiceConfigurator.java", "diffHunk": "@@ -132,31 +132,45 @@ protected RetryPolicy buildRetryPolicy() {\n \n         if (checkers == null) {\n             checkers = new HashSet<>();\n-\n-            for (String template : configurationGenerator.getTemplateList()) {\n+            List<String> items = configurationGenerator.getTemplateList();\n+            // Add backing without template\n+            items.add(\"elasticsearch\");\n+            items.add(\"kafka\");\n+            for (String item : items) {\n                 try {\n-                    File templateDir = configurationGenerator.getTemplateDirectory(template);\n-                    String classPath = getClasspathForTemplate(template);\n+                    log.debug(\"checker: \" + item);\n+                    File templateDir = getTemplateDir(item);\n+                    String classPath = getClasspathForTemplate(item);\n                     String checkClass = configurationGenerator.getUserConfig()\n-                                                              .getProperty(template + PARAM_CHECK_SUFFIX);\n-\n+                                                              .getProperty(item + PARAM_CHECK_SUFFIX);\n                     Optional<URLClassLoader> ucl = getClassLoaderForTemplate(templateDir, classPath);\n                     if (ucl.isPresent()) {\n                         Class<?> klass = Class.forName(checkClass, true, ucl.get());\n+                        if (log.isDebugEnabled()) {\n+                            log.debug(\"Adding checker \" + item + \" with class path: \"\n+                                    + Arrays.toString(ucl.get().getURLs()));\n+                        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c302822fbebc5587839f7e3a764920d319f3b57"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDUwMDQwMg==", "bodyText": "good point added a commit for that", "url": "https://github.com/nuxeo/nuxeo/pull/4269#discussion_r474500402", "createdAt": "2020-08-21T08:06:11Z", "author": {"login": "bdelbosc"}, "path": "modules/runtime/nuxeo-launcher-commons/src/main/java/org/nuxeo/launcher/config/BackingServiceConfigurator.java", "diffHunk": "@@ -132,31 +132,45 @@ protected RetryPolicy buildRetryPolicy() {\n \n         if (checkers == null) {\n             checkers = new HashSet<>();\n-\n-            for (String template : configurationGenerator.getTemplateList()) {\n+            List<String> items = configurationGenerator.getTemplateList();\n+            // Add backing without template\n+            items.add(\"elasticsearch\");\n+            items.add(\"kafka\");\n+            for (String item : items) {\n                 try {\n-                    File templateDir = configurationGenerator.getTemplateDirectory(template);\n-                    String classPath = getClasspathForTemplate(template);\n+                    log.debug(\"checker: \" + item);\n+                    File templateDir = getTemplateDir(item);\n+                    String classPath = getClasspathForTemplate(item);\n                     String checkClass = configurationGenerator.getUserConfig()\n-                                                              .getProperty(template + PARAM_CHECK_SUFFIX);\n-\n+                                                              .getProperty(item + PARAM_CHECK_SUFFIX);\n                     Optional<URLClassLoader> ucl = getClassLoaderForTemplate(templateDir, classPath);\n                     if (ucl.isPresent()) {\n                         Class<?> klass = Class.forName(checkClass, true, ucl.get());\n+                        if (log.isDebugEnabled()) {\n+                            log.debug(\"Adding checker \" + item + \" with class path: \"\n+                                    + Arrays.toString(ucl.get().getURLs()));\n+                        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk1Mjk1MA=="}, "originalCommit": {"oid": "5c302822fbebc5587839f7e3a764920d319f3b57"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3ODUwOTgyOnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/main/java/org/nuxeo/elasticsearch/ElasticSearchChecker.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMjo0OToyN1rOHGWd0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQwOTowMzoxM1rOHHC0BA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQyMTU4NA==", "bodyText": "missing newline", "url": "https://github.com/nuxeo/nuxeo/pull/4269#discussion_r476421584", "createdAt": "2020-08-25T12:49:27Z", "author": {"login": "ataillefer"}, "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/main/java/org/nuxeo/elasticsearch/ElasticSearchChecker.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     bdelbosc\n+ */\n+package org.nuxeo.elasticsearch;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.cluster.health.ClusterHealthStatus;\n+import org.nuxeo.common.xmap.XMap;\n+import org.nuxeo.elasticsearch.api.ESClient;\n+import org.nuxeo.elasticsearch.api.ESClientFactory;\n+import org.nuxeo.elasticsearch.client.ESRestClientFactory;\n+import org.nuxeo.elasticsearch.config.ElasticSearchClientConfig;\n+import org.nuxeo.launcher.config.ConfigurationException;\n+import org.nuxeo.launcher.config.ConfigurationGenerator;\n+import org.nuxeo.launcher.config.backingservices.BackingChecker;\n+\n+/**\n+ * @since 11.3\n+ */\n+public class ElasticSearchChecker implements BackingChecker {\n+    private static final Logger log = LogManager.getLogger(ElasticSearchChecker.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faf79d2c8cd306649700c43e9e9589926ea7b64f"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzEwODQ5OQ==", "bodyText": "are you sure? my editor doesn't do that after a class, looks like common practice on others files", "url": "https://github.com/nuxeo/nuxeo/pull/4269#discussion_r477108499", "createdAt": "2020-08-26T07:59:00Z", "author": {"login": "bdelbosc"}, "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/main/java/org/nuxeo/elasticsearch/ElasticSearchChecker.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     bdelbosc\n+ */\n+package org.nuxeo.elasticsearch;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.cluster.health.ClusterHealthStatus;\n+import org.nuxeo.common.xmap.XMap;\n+import org.nuxeo.elasticsearch.api.ESClient;\n+import org.nuxeo.elasticsearch.api.ESClientFactory;\n+import org.nuxeo.elasticsearch.client.ESRestClientFactory;\n+import org.nuxeo.elasticsearch.config.ElasticSearchClientConfig;\n+import org.nuxeo.launcher.config.ConfigurationException;\n+import org.nuxeo.launcher.config.ConfigurationGenerator;\n+import org.nuxeo.launcher.config.backingservices.BackingChecker;\n+\n+/**\n+ * @since 11.3\n+ */\n+public class ElasticSearchChecker implements BackingChecker {\n+    private static final Logger log = LogManager.getLogger(ElasticSearchChecker.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQyMTU4NA=="}, "originalCommit": {"oid": "faf79d2c8cd306649700c43e9e9589926ea7b64f"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzE0ODE2NA==", "bodyText": "if we want this behavior it needs to be enforced by our formatting rules", "url": "https://github.com/nuxeo/nuxeo/pull/4269#discussion_r477148164", "createdAt": "2020-08-26T09:03:13Z", "author": {"login": "bdelbosc"}, "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/main/java/org/nuxeo/elasticsearch/ElasticSearchChecker.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     bdelbosc\n+ */\n+package org.nuxeo.elasticsearch;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.cluster.health.ClusterHealthStatus;\n+import org.nuxeo.common.xmap.XMap;\n+import org.nuxeo.elasticsearch.api.ESClient;\n+import org.nuxeo.elasticsearch.api.ESClientFactory;\n+import org.nuxeo.elasticsearch.client.ESRestClientFactory;\n+import org.nuxeo.elasticsearch.config.ElasticSearchClientConfig;\n+import org.nuxeo.launcher.config.ConfigurationException;\n+import org.nuxeo.launcher.config.ConfigurationGenerator;\n+import org.nuxeo.launcher.config.backingservices.BackingChecker;\n+\n+/**\n+ * @since 11.3\n+ */\n+public class ElasticSearchChecker implements BackingChecker {\n+    private static final Logger log = LogManager.getLogger(ElasticSearchChecker.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQyMTU4NA=="}, "originalCommit": {"oid": "faf79d2c8cd306649700c43e9e9589926ea7b64f"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3ODUzNjM3OnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/main/java/org/nuxeo/elasticsearch/ElasticSearchChecker.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMjo1NToyNFrOHGWt3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxNDowMjo0NlrOHHNqeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQyNTY5Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (!\"true\".equals(cg.getUserConfig().getProperty(ELASTIC_ENABLED_OPT))) {\n          \n          \n            \n                    if (!Boolean.valueOf(cg.getUserConfig().getProperty(ELASTIC_ENABLED_OPT))) {", "url": "https://github.com/nuxeo/nuxeo/pull/4269#discussion_r476425692", "createdAt": "2020-08-25T12:55:24Z", "author": {"login": "ataillefer"}, "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/main/java/org/nuxeo/elasticsearch/ElasticSearchChecker.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     bdelbosc\n+ */\n+package org.nuxeo.elasticsearch;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.cluster.health.ClusterHealthStatus;\n+import org.nuxeo.common.xmap.XMap;\n+import org.nuxeo.elasticsearch.api.ESClient;\n+import org.nuxeo.elasticsearch.api.ESClientFactory;\n+import org.nuxeo.elasticsearch.client.ESRestClientFactory;\n+import org.nuxeo.elasticsearch.config.ElasticSearchClientConfig;\n+import org.nuxeo.launcher.config.ConfigurationException;\n+import org.nuxeo.launcher.config.ConfigurationGenerator;\n+import org.nuxeo.launcher.config.backingservices.BackingChecker;\n+\n+/**\n+ * @since 11.3\n+ */\n+public class ElasticSearchChecker implements BackingChecker {\n+    private static final Logger log = LogManager.getLogger(ElasticSearchChecker.class);\n+\n+    protected static final String ELASTIC_ENABLED_OPT = \"elasticsearch.enabled\";\n+\n+    protected static final String ELASTIC_REST_CLIENT_OPT = \"elasticsearch.client\";\n+\n+    protected static final String ADDRESS_LIST_OPT = \"addressList\";\n+\n+    protected static final String CONFIG_NAME = \"elasticsearch-config.xml\";\n+\n+    @Override\n+    public boolean accepts(ConfigurationGenerator cg) {\n+        if (!\"true\".equals(cg.getUserConfig().getProperty(ELASTIC_ENABLED_OPT))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faf79d2c8cd306649700c43e9e9589926ea7b64f"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjUzMDg0OA==", "bodyText": "Actually Boolean.valueOf -> Boolean.parseBoolean", "url": "https://github.com/nuxeo/nuxeo/pull/4269#discussion_r476530848", "createdAt": "2020-08-25T15:17:57Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/main/java/org/nuxeo/elasticsearch/ElasticSearchChecker.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     bdelbosc\n+ */\n+package org.nuxeo.elasticsearch;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.cluster.health.ClusterHealthStatus;\n+import org.nuxeo.common.xmap.XMap;\n+import org.nuxeo.elasticsearch.api.ESClient;\n+import org.nuxeo.elasticsearch.api.ESClientFactory;\n+import org.nuxeo.elasticsearch.client.ESRestClientFactory;\n+import org.nuxeo.elasticsearch.config.ElasticSearchClientConfig;\n+import org.nuxeo.launcher.config.ConfigurationException;\n+import org.nuxeo.launcher.config.ConfigurationGenerator;\n+import org.nuxeo.launcher.config.backingservices.BackingChecker;\n+\n+/**\n+ * @since 11.3\n+ */\n+public class ElasticSearchChecker implements BackingChecker {\n+    private static final Logger log = LogManager.getLogger(ElasticSearchChecker.class);\n+\n+    protected static final String ELASTIC_ENABLED_OPT = \"elasticsearch.enabled\";\n+\n+    protected static final String ELASTIC_REST_CLIENT_OPT = \"elasticsearch.client\";\n+\n+    protected static final String ADDRESS_LIST_OPT = \"addressList\";\n+\n+    protected static final String CONFIG_NAME = \"elasticsearch-config.xml\";\n+\n+    @Override\n+    public boolean accepts(ConfigurationGenerator cg) {\n+        if (!\"true\".equals(cg.getUserConfig().getProperty(ELASTIC_ENABLED_OPT))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQyNTY5Mg=="}, "originalCommit": {"oid": "faf79d2c8cd306649700c43e9e9589926ea7b64f"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzEyMDkwNQ==", "bodyText": "Using Boolean.parseBoolean will trigger the checker for value likeTrue or TRUE,\nbut in our template system, the feature will not be activated (only true is taken in account)\nthis will lead to buggy behavior.", "url": "https://github.com/nuxeo/nuxeo/pull/4269#discussion_r477120905", "createdAt": "2020-08-26T08:19:53Z", "author": {"login": "bdelbosc"}, "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/main/java/org/nuxeo/elasticsearch/ElasticSearchChecker.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     bdelbosc\n+ */\n+package org.nuxeo.elasticsearch;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.cluster.health.ClusterHealthStatus;\n+import org.nuxeo.common.xmap.XMap;\n+import org.nuxeo.elasticsearch.api.ESClient;\n+import org.nuxeo.elasticsearch.api.ESClientFactory;\n+import org.nuxeo.elasticsearch.client.ESRestClientFactory;\n+import org.nuxeo.elasticsearch.config.ElasticSearchClientConfig;\n+import org.nuxeo.launcher.config.ConfigurationException;\n+import org.nuxeo.launcher.config.ConfigurationGenerator;\n+import org.nuxeo.launcher.config.backingservices.BackingChecker;\n+\n+/**\n+ * @since 11.3\n+ */\n+public class ElasticSearchChecker implements BackingChecker {\n+    private static final Logger log = LogManager.getLogger(ElasticSearchChecker.class);\n+\n+    protected static final String ELASTIC_ENABLED_OPT = \"elasticsearch.enabled\";\n+\n+    protected static final String ELASTIC_REST_CLIENT_OPT = \"elasticsearch.client\";\n+\n+    protected static final String ADDRESS_LIST_OPT = \"addressList\";\n+\n+    protected static final String CONFIG_NAME = \"elasticsearch-config.xml\";\n+\n+    @Override\n+    public boolean accepts(ConfigurationGenerator cg) {\n+        if (!\"true\".equals(cg.getUserConfig().getProperty(ELASTIC_ENABLED_OPT))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQyNTY5Mg=="}, "originalCommit": {"oid": "faf79d2c8cd306649700c43e9e9589926ea7b64f"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzMyNTk0NQ==", "bodyText": "Worth a comment though, so that others don't refactor the code later in the way we just suggested here...", "url": "https://github.com/nuxeo/nuxeo/pull/4269#discussion_r477325945", "createdAt": "2020-08-26T14:02:46Z", "author": {"login": "efge"}, "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/main/java/org/nuxeo/elasticsearch/ElasticSearchChecker.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     bdelbosc\n+ */\n+package org.nuxeo.elasticsearch;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.cluster.health.ClusterHealthStatus;\n+import org.nuxeo.common.xmap.XMap;\n+import org.nuxeo.elasticsearch.api.ESClient;\n+import org.nuxeo.elasticsearch.api.ESClientFactory;\n+import org.nuxeo.elasticsearch.client.ESRestClientFactory;\n+import org.nuxeo.elasticsearch.config.ElasticSearchClientConfig;\n+import org.nuxeo.launcher.config.ConfigurationException;\n+import org.nuxeo.launcher.config.ConfigurationGenerator;\n+import org.nuxeo.launcher.config.backingservices.BackingChecker;\n+\n+/**\n+ * @since 11.3\n+ */\n+public class ElasticSearchChecker implements BackingChecker {\n+    private static final Logger log = LogManager.getLogger(ElasticSearchChecker.class);\n+\n+    protected static final String ELASTIC_ENABLED_OPT = \"elasticsearch.enabled\";\n+\n+    protected static final String ELASTIC_REST_CLIENT_OPT = \"elasticsearch.client\";\n+\n+    protected static final String ADDRESS_LIST_OPT = \"addressList\";\n+\n+    protected static final String CONFIG_NAME = \"elasticsearch-config.xml\";\n+\n+    @Override\n+    public boolean accepts(ConfigurationGenerator cg) {\n+        if (!\"true\".equals(cg.getUserConfig().getProperty(ELASTIC_ENABLED_OPT))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQyNTY5Mg=="}, "originalCommit": {"oid": "faf79d2c8cd306649700c43e9e9589926ea7b64f"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3ODU0MDk2OnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/main/java/org/nuxeo/elasticsearch/ElasticSearchChecker.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMjo1NjoxMVrOHGWxJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMjo1NjoxMVrOHGWxJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQyNjUzMw==", "bodyText": "ELASTIC_ENABLED_PROPERTY or ELASTIC_ENABLED_PROP?", "url": "https://github.com/nuxeo/nuxeo/pull/4269#discussion_r476426533", "createdAt": "2020-08-25T12:56:11Z", "author": {"login": "ataillefer"}, "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/main/java/org/nuxeo/elasticsearch/ElasticSearchChecker.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     bdelbosc\n+ */\n+package org.nuxeo.elasticsearch;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.cluster.health.ClusterHealthStatus;\n+import org.nuxeo.common.xmap.XMap;\n+import org.nuxeo.elasticsearch.api.ESClient;\n+import org.nuxeo.elasticsearch.api.ESClientFactory;\n+import org.nuxeo.elasticsearch.client.ESRestClientFactory;\n+import org.nuxeo.elasticsearch.config.ElasticSearchClientConfig;\n+import org.nuxeo.launcher.config.ConfigurationException;\n+import org.nuxeo.launcher.config.ConfigurationGenerator;\n+import org.nuxeo.launcher.config.backingservices.BackingChecker;\n+\n+/**\n+ * @since 11.3\n+ */\n+public class ElasticSearchChecker implements BackingChecker {\n+    private static final Logger log = LogManager.getLogger(ElasticSearchChecker.class);\n+\n+    protected static final String ELASTIC_ENABLED_OPT = \"elasticsearch.enabled\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faf79d2c8cd306649700c43e9e9589926ea7b64f"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3ODU1MzU0OnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/main/java/org/nuxeo/elasticsearch/ElasticSearchChecker.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMjo1OToxMVrOHGW5Ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQwODoyNzo1MVrOHHBeLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQyODU3OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (addressList == null || addressList.isEmpty()) {\n          \n          \n            \n                    if (StringUtils.isEmpty(addressList)) {\n          \n      \n    \n    \n  \n\ncommons-lang3 is in the module's dependencies", "url": "https://github.com/nuxeo/nuxeo/pull/4269#discussion_r476428578", "createdAt": "2020-08-25T12:59:11Z", "author": {"login": "ataillefer"}, "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/main/java/org/nuxeo/elasticsearch/ElasticSearchChecker.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     bdelbosc\n+ */\n+package org.nuxeo.elasticsearch;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.cluster.health.ClusterHealthStatus;\n+import org.nuxeo.common.xmap.XMap;\n+import org.nuxeo.elasticsearch.api.ESClient;\n+import org.nuxeo.elasticsearch.api.ESClientFactory;\n+import org.nuxeo.elasticsearch.client.ESRestClientFactory;\n+import org.nuxeo.elasticsearch.config.ElasticSearchClientConfig;\n+import org.nuxeo.launcher.config.ConfigurationException;\n+import org.nuxeo.launcher.config.ConfigurationGenerator;\n+import org.nuxeo.launcher.config.backingservices.BackingChecker;\n+\n+/**\n+ * @since 11.3\n+ */\n+public class ElasticSearchChecker implements BackingChecker {\n+    private static final Logger log = LogManager.getLogger(ElasticSearchChecker.class);\n+\n+    protected static final String ELASTIC_ENABLED_OPT = \"elasticsearch.enabled\";\n+\n+    protected static final String ELASTIC_REST_CLIENT_OPT = \"elasticsearch.client\";\n+\n+    protected static final String ADDRESS_LIST_OPT = \"addressList\";\n+\n+    protected static final String CONFIG_NAME = \"elasticsearch-config.xml\";\n+\n+    @Override\n+    public boolean accepts(ConfigurationGenerator cg) {\n+        if (!\"true\".equals(cg.getUserConfig().getProperty(ELASTIC_ENABLED_OPT))) {\n+            log.debug(\"Checker skipped because elasticsearch is disabled\");\n+            return false;\n+        }\n+        if (!\"RestClient\".equals(cg.getUserConfig().getProperty(ELASTIC_REST_CLIENT_OPT))) {\n+            log.debug(\"Checker skipped because not using a rest client\");\n+            return false;\n+        }\n+        log.debug(\"Checker accepted\");\n+        return true;\n+    }\n+\n+    @Override\n+    public void check(ConfigurationGenerator cg) throws ConfigurationException {\n+        ElasticSearchClientConfig config = getConfig(cg);\n+        String addressList = config.getOption(ADDRESS_LIST_OPT);\n+        if (addressList == null || addressList.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faf79d2c8cd306649700c43e9e9589926ea7b64f"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzEyNjE4OA==", "bodyText": "yes I will do that if there is more than one usage", "url": "https://github.com/nuxeo/nuxeo/pull/4269#discussion_r477126188", "createdAt": "2020-08-26T08:27:51Z", "author": {"login": "bdelbosc"}, "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/main/java/org/nuxeo/elasticsearch/ElasticSearchChecker.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     bdelbosc\n+ */\n+package org.nuxeo.elasticsearch;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.cluster.health.ClusterHealthStatus;\n+import org.nuxeo.common.xmap.XMap;\n+import org.nuxeo.elasticsearch.api.ESClient;\n+import org.nuxeo.elasticsearch.api.ESClientFactory;\n+import org.nuxeo.elasticsearch.client.ESRestClientFactory;\n+import org.nuxeo.elasticsearch.config.ElasticSearchClientConfig;\n+import org.nuxeo.launcher.config.ConfigurationException;\n+import org.nuxeo.launcher.config.ConfigurationGenerator;\n+import org.nuxeo.launcher.config.backingservices.BackingChecker;\n+\n+/**\n+ * @since 11.3\n+ */\n+public class ElasticSearchChecker implements BackingChecker {\n+    private static final Logger log = LogManager.getLogger(ElasticSearchChecker.class);\n+\n+    protected static final String ELASTIC_ENABLED_OPT = \"elasticsearch.enabled\";\n+\n+    protected static final String ELASTIC_REST_CLIENT_OPT = \"elasticsearch.client\";\n+\n+    protected static final String ADDRESS_LIST_OPT = \"addressList\";\n+\n+    protected static final String CONFIG_NAME = \"elasticsearch-config.xml\";\n+\n+    @Override\n+    public boolean accepts(ConfigurationGenerator cg) {\n+        if (!\"true\".equals(cg.getUserConfig().getProperty(ELASTIC_ENABLED_OPT))) {\n+            log.debug(\"Checker skipped because elasticsearch is disabled\");\n+            return false;\n+        }\n+        if (!\"RestClient\".equals(cg.getUserConfig().getProperty(ELASTIC_REST_CLIENT_OPT))) {\n+            log.debug(\"Checker skipped because not using a rest client\");\n+            return false;\n+        }\n+        log.debug(\"Checker accepted\");\n+        return true;\n+    }\n+\n+    @Override\n+    public void check(ConfigurationGenerator cg) throws ConfigurationException {\n+        ElasticSearchClientConfig config = getConfig(cg);\n+        String addressList = config.getOption(ADDRESS_LIST_OPT);\n+        if (addressList == null || addressList.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQyODU3OA=="}, "originalCommit": {"oid": "faf79d2c8cd306649700c43e9e9589926ea7b64f"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3ODU1ODE0OnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/main/java/org/nuxeo/elasticsearch/ElasticSearchChecker.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMzowMDoxOFrOHGW79w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMzowMDoxOFrOHGW79w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQyOTMwMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        log.debug(\"Check elastic config skipped on embedded configuration\");\n          \n          \n            \n                        log.debug(\"Elasticsearch config check skipped on embedded configuration\");", "url": "https://github.com/nuxeo/nuxeo/pull/4269#discussion_r476429303", "createdAt": "2020-08-25T13:00:18Z", "author": {"login": "ataillefer"}, "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/main/java/org/nuxeo/elasticsearch/ElasticSearchChecker.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     bdelbosc\n+ */\n+package org.nuxeo.elasticsearch;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.cluster.health.ClusterHealthStatus;\n+import org.nuxeo.common.xmap.XMap;\n+import org.nuxeo.elasticsearch.api.ESClient;\n+import org.nuxeo.elasticsearch.api.ESClientFactory;\n+import org.nuxeo.elasticsearch.client.ESRestClientFactory;\n+import org.nuxeo.elasticsearch.config.ElasticSearchClientConfig;\n+import org.nuxeo.launcher.config.ConfigurationException;\n+import org.nuxeo.launcher.config.ConfigurationGenerator;\n+import org.nuxeo.launcher.config.backingservices.BackingChecker;\n+\n+/**\n+ * @since 11.3\n+ */\n+public class ElasticSearchChecker implements BackingChecker {\n+    private static final Logger log = LogManager.getLogger(ElasticSearchChecker.class);\n+\n+    protected static final String ELASTIC_ENABLED_OPT = \"elasticsearch.enabled\";\n+\n+    protected static final String ELASTIC_REST_CLIENT_OPT = \"elasticsearch.client\";\n+\n+    protected static final String ADDRESS_LIST_OPT = \"addressList\";\n+\n+    protected static final String CONFIG_NAME = \"elasticsearch-config.xml\";\n+\n+    @Override\n+    public boolean accepts(ConfigurationGenerator cg) {\n+        if (!\"true\".equals(cg.getUserConfig().getProperty(ELASTIC_ENABLED_OPT))) {\n+            log.debug(\"Checker skipped because elasticsearch is disabled\");\n+            return false;\n+        }\n+        if (!\"RestClient\".equals(cg.getUserConfig().getProperty(ELASTIC_REST_CLIENT_OPT))) {\n+            log.debug(\"Checker skipped because not using a rest client\");\n+            return false;\n+        }\n+        log.debug(\"Checker accepted\");\n+        return true;\n+    }\n+\n+    @Override\n+    public void check(ConfigurationGenerator cg) throws ConfigurationException {\n+        ElasticSearchClientConfig config = getConfig(cg);\n+        String addressList = config.getOption(ADDRESS_LIST_OPT);\n+        if (addressList == null || addressList.isEmpty()) {\n+            log.debug(\"Check elastic config skipped on embedded configuration\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faf79d2c8cd306649700c43e9e9589926ea7b64f"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3ODU4NzQyOnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/main/java/org/nuxeo/elasticsearch/ElasticSearchChecker.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMzowNzozOFrOHGXNuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMzowNzozOFrOHGXNuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQzMzg0OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new ConfigurationException(\"Unable to connect to Elasticsearch \" + config.getOption(ADDRESS_LIST_OPT),\n          \n          \n            \n                        throw new ConfigurationException(\"Unable to connect to Elasticsearch: \" + config.getOption(ADDRESS_LIST_OPT),", "url": "https://github.com/nuxeo/nuxeo/pull/4269#discussion_r476433848", "createdAt": "2020-08-25T13:07:38Z", "author": {"login": "ataillefer"}, "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/main/java/org/nuxeo/elasticsearch/ElasticSearchChecker.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     bdelbosc\n+ */\n+package org.nuxeo.elasticsearch;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.cluster.health.ClusterHealthStatus;\n+import org.nuxeo.common.xmap.XMap;\n+import org.nuxeo.elasticsearch.api.ESClient;\n+import org.nuxeo.elasticsearch.api.ESClientFactory;\n+import org.nuxeo.elasticsearch.client.ESRestClientFactory;\n+import org.nuxeo.elasticsearch.config.ElasticSearchClientConfig;\n+import org.nuxeo.launcher.config.ConfigurationException;\n+import org.nuxeo.launcher.config.ConfigurationGenerator;\n+import org.nuxeo.launcher.config.backingservices.BackingChecker;\n+\n+/**\n+ * @since 11.3\n+ */\n+public class ElasticSearchChecker implements BackingChecker {\n+    private static final Logger log = LogManager.getLogger(ElasticSearchChecker.class);\n+\n+    protected static final String ELASTIC_ENABLED_OPT = \"elasticsearch.enabled\";\n+\n+    protected static final String ELASTIC_REST_CLIENT_OPT = \"elasticsearch.client\";\n+\n+    protected static final String ADDRESS_LIST_OPT = \"addressList\";\n+\n+    protected static final String CONFIG_NAME = \"elasticsearch-config.xml\";\n+\n+    @Override\n+    public boolean accepts(ConfigurationGenerator cg) {\n+        if (!\"true\".equals(cg.getUserConfig().getProperty(ELASTIC_ENABLED_OPT))) {\n+            log.debug(\"Checker skipped because elasticsearch is disabled\");\n+            return false;\n+        }\n+        if (!\"RestClient\".equals(cg.getUserConfig().getProperty(ELASTIC_REST_CLIENT_OPT))) {\n+            log.debug(\"Checker skipped because not using a rest client\");\n+            return false;\n+        }\n+        log.debug(\"Checker accepted\");\n+        return true;\n+    }\n+\n+    @Override\n+    public void check(ConfigurationGenerator cg) throws ConfigurationException {\n+        ElasticSearchClientConfig config = getConfig(cg);\n+        String addressList = config.getOption(ADDRESS_LIST_OPT);\n+        if (addressList == null || addressList.isEmpty()) {\n+            log.debug(\"Check elastic config skipped on embedded configuration\");\n+            return;\n+        }\n+        log.debug(\"Check elastic config: {}\", config);\n+        ClusterHealthStatus status = getHealthStatus(config);\n+        switch (status) {\n+        case GREEN:\n+        case YELLOW:\n+            log.debug(\"check is ok, cluster health is {}\", status);\n+            return;\n+        default:\n+            throw new ConfigurationException(\"Elasticsearch cluster is not healthy: \" + status);\n+        }\n+    }\n+\n+    protected ClusterHealthStatus getHealthStatus(ElasticSearchClientConfig config) throws ConfigurationException {\n+        try {\n+            ESClient client = getClient(config);\n+            return client.getHealthStatus(null);\n+        } catch (Exception e) {\n+            throw new ConfigurationException(\"Unable to connect to Elasticsearch \" + config.getOption(ADDRESS_LIST_OPT),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faf79d2c8cd306649700c43e9e9589926ea7b64f"}, "originalPosition": 93}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3ODYxMDk0OnYy", "diffSide": "RIGHT", "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/main/java/org/nuxeo/elasticsearch/ElasticSearchChecker.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMzoxMzowM1rOHGXb8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMzoxMzowM1rOHGXb8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQzNzQ4OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new ConfigurationException(\"Fail to load ElasticSearchClientConfig from \" + file.getAbsolutePath(),\n          \n          \n            \n                        throw new ConfigurationException(\"Failed to load ElasticSearchClientConfig from \" + file.getAbsolutePath(),", "url": "https://github.com/nuxeo/nuxeo/pull/4269#discussion_r476437488", "createdAt": "2020-08-25T13:13:03Z", "author": {"login": "ataillefer"}, "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/main/java/org/nuxeo/elasticsearch/ElasticSearchChecker.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     bdelbosc\n+ */\n+package org.nuxeo.elasticsearch;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.cluster.health.ClusterHealthStatus;\n+import org.nuxeo.common.xmap.XMap;\n+import org.nuxeo.elasticsearch.api.ESClient;\n+import org.nuxeo.elasticsearch.api.ESClientFactory;\n+import org.nuxeo.elasticsearch.client.ESRestClientFactory;\n+import org.nuxeo.elasticsearch.config.ElasticSearchClientConfig;\n+import org.nuxeo.launcher.config.ConfigurationException;\n+import org.nuxeo.launcher.config.ConfigurationGenerator;\n+import org.nuxeo.launcher.config.backingservices.BackingChecker;\n+\n+/**\n+ * @since 11.3\n+ */\n+public class ElasticSearchChecker implements BackingChecker {\n+    private static final Logger log = LogManager.getLogger(ElasticSearchChecker.class);\n+\n+    protected static final String ELASTIC_ENABLED_OPT = \"elasticsearch.enabled\";\n+\n+    protected static final String ELASTIC_REST_CLIENT_OPT = \"elasticsearch.client\";\n+\n+    protected static final String ADDRESS_LIST_OPT = \"addressList\";\n+\n+    protected static final String CONFIG_NAME = \"elasticsearch-config.xml\";\n+\n+    @Override\n+    public boolean accepts(ConfigurationGenerator cg) {\n+        if (!\"true\".equals(cg.getUserConfig().getProperty(ELASTIC_ENABLED_OPT))) {\n+            log.debug(\"Checker skipped because elasticsearch is disabled\");\n+            return false;\n+        }\n+        if (!\"RestClient\".equals(cg.getUserConfig().getProperty(ELASTIC_REST_CLIENT_OPT))) {\n+            log.debug(\"Checker skipped because not using a rest client\");\n+            return false;\n+        }\n+        log.debug(\"Checker accepted\");\n+        return true;\n+    }\n+\n+    @Override\n+    public void check(ConfigurationGenerator cg) throws ConfigurationException {\n+        ElasticSearchClientConfig config = getConfig(cg);\n+        String addressList = config.getOption(ADDRESS_LIST_OPT);\n+        if (addressList == null || addressList.isEmpty()) {\n+            log.debug(\"Check elastic config skipped on embedded configuration\");\n+            return;\n+        }\n+        log.debug(\"Check elastic config: {}\", config);\n+        ClusterHealthStatus status = getHealthStatus(config);\n+        switch (status) {\n+        case GREEN:\n+        case YELLOW:\n+            log.debug(\"check is ok, cluster health is {}\", status);\n+            return;\n+        default:\n+            throw new ConfigurationException(\"Elasticsearch cluster is not healthy: \" + status);\n+        }\n+    }\n+\n+    protected ClusterHealthStatus getHealthStatus(ElasticSearchClientConfig config) throws ConfigurationException {\n+        try {\n+            ESClient client = getClient(config);\n+            return client.getHealthStatus(null);\n+        } catch (Exception e) {\n+            throw new ConfigurationException(\"Unable to connect to Elasticsearch \" + config.getOption(ADDRESS_LIST_OPT),\n+                    e);\n+        }\n+    }\n+\n+    protected ESClient getClient(ElasticSearchClientConfig config) {\n+        ESClientFactory clientFactory = new ESRestClientFactory();\n+        return clientFactory.create(null, config);\n+    }\n+\n+    protected ElasticSearchClientConfig getConfig(ConfigurationGenerator cg) throws ConfigurationException {\n+        File configFile = new File(cg.getConfigDir(), CONFIG_NAME);\n+        if (!configFile.exists()) {\n+            throw new ConfigurationException(\"Cannot find Elasticsearch configuration: \" + CONFIG_NAME);\n+        }\n+        return getDescriptor(configFile);\n+    }\n+\n+    protected ElasticSearchClientConfig getDescriptor(File file) throws ConfigurationException {\n+        XMap xmap = new XMap();\n+        xmap.register(ElasticSearchClientConfig.class);\n+        try {\n+            // avoid XMap to fail when trying to load class value by removing class attribute\n+            String content = Files.readString(file.toPath(), StandardCharsets.UTF_8);\n+            content = content.replace(\"class=\", \"ignore=\");\n+            InputStream inStream = new ByteArrayInputStream(content.getBytes());\n+            Object[] nodes = xmap.loadAll(inStream);\n+            for (Object node : nodes) {\n+                if (node != null) {\n+                    return (ElasticSearchClientConfig) node;\n+                }\n+            }\n+            throw new ConfigurationException(\"No ElasticSearchClientConfig found in \" + file.getAbsolutePath());\n+        } catch (IOException e) {\n+            throw new ConfigurationException(\"Fail to load ElasticSearchClientConfig from \" + file.getAbsolutePath(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faf79d2c8cd306649700c43e9e9589926ea7b64f"}, "originalPosition": 127}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3ODYzMjk2OnYy", "diffSide": "RIGHT", "path": "modules/runtime/nuxeo-runtime-stream/src/main/java/org/nuxeo/runtime/kafka/KafkaChecker.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMzoxODoyM1rOHGXpoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMzoxODoyM1rOHGXpoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ0MDk5Mg==", "bodyText": "missing newline", "url": "https://github.com/nuxeo/nuxeo/pull/4269#discussion_r476440992", "createdAt": "2020-08-25T13:18:23Z", "author": {"login": "ataillefer"}, "path": "modules/runtime/nuxeo-runtime-stream/src/main/java/org/nuxeo/runtime/kafka/KafkaChecker.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     bdelbosc\n+ */\n+package org.nuxeo.runtime.kafka;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.common.xmap.XMap;\n+import org.nuxeo.launcher.config.ConfigurationException;\n+import org.nuxeo.launcher.config.ConfigurationGenerator;\n+import org.nuxeo.launcher.config.backingservices.BackingChecker;\n+import org.nuxeo.lib.stream.log.Name;\n+import org.nuxeo.lib.stream.log.kafka.KafkaLogManager;\n+\n+/**\n+ * @since 11.3\n+ */\n+public class KafkaChecker implements BackingChecker {\n+    private static final Logger log = LogManager.getLogger(KafkaChecker.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c302822fbebc5587839f7e3a764920d319f3b57"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3ODYzNzE1OnYy", "diffSide": "RIGHT", "path": "modules/runtime/nuxeo-runtime-stream/src/main/java/org/nuxeo/runtime/kafka/KafkaChecker.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMzoxOToyMVrOHGXsDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMzoxOToyMVrOHGXsDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ0MTYxMw==", "bodyText": "KAFKA_ENABLED_PROPERTY or KAFKA_ENABLED_PROP?", "url": "https://github.com/nuxeo/nuxeo/pull/4269#discussion_r476441613", "createdAt": "2020-08-25T13:19:21Z", "author": {"login": "ataillefer"}, "path": "modules/runtime/nuxeo-runtime-stream/src/main/java/org/nuxeo/runtime/kafka/KafkaChecker.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     bdelbosc\n+ */\n+package org.nuxeo.runtime.kafka;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.common.xmap.XMap;\n+import org.nuxeo.launcher.config.ConfigurationException;\n+import org.nuxeo.launcher.config.ConfigurationGenerator;\n+import org.nuxeo.launcher.config.backingservices.BackingChecker;\n+import org.nuxeo.lib.stream.log.Name;\n+import org.nuxeo.lib.stream.log.kafka.KafkaLogManager;\n+\n+/**\n+ * @since 11.3\n+ */\n+public class KafkaChecker implements BackingChecker {\n+    private static final Logger log = LogManager.getLogger(KafkaChecker.class);\n+\n+    private static final String KAFKA_ENABLED_OPT = \"kafka.enabled\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c302822fbebc5587839f7e3a764920d319f3b57"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3ODYzODQyOnYy", "diffSide": "RIGHT", "path": "modules/runtime/nuxeo-runtime-stream/src/main/java/org/nuxeo/runtime/kafka/KafkaChecker.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMzoxOTozN1rOHGXswA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMzoxOTozN1rOHGXswA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ0MTc5Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (!\"true\".equals(cg.getUserConfig().getProperty(KAFKA_ENABLED_OPT))) {\n          \n          \n            \n                    if (!Boolean.valueOf(cg.getUserConfig().getProperty(KAFKA_ENABLED_OPT))) {", "url": "https://github.com/nuxeo/nuxeo/pull/4269#discussion_r476441792", "createdAt": "2020-08-25T13:19:37Z", "author": {"login": "ataillefer"}, "path": "modules/runtime/nuxeo-runtime-stream/src/main/java/org/nuxeo/runtime/kafka/KafkaChecker.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     bdelbosc\n+ */\n+package org.nuxeo.runtime.kafka;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.common.xmap.XMap;\n+import org.nuxeo.launcher.config.ConfigurationException;\n+import org.nuxeo.launcher.config.ConfigurationGenerator;\n+import org.nuxeo.launcher.config.backingservices.BackingChecker;\n+import org.nuxeo.lib.stream.log.Name;\n+import org.nuxeo.lib.stream.log.kafka.KafkaLogManager;\n+\n+/**\n+ * @since 11.3\n+ */\n+public class KafkaChecker implements BackingChecker {\n+    private static final Logger log = LogManager.getLogger(KafkaChecker.class);\n+\n+    private static final String KAFKA_ENABLED_OPT = \"kafka.enabled\";\n+\n+    private static final String CONFIG_NAME = \"kafka-config.xml\";\n+\n+    @Override\n+    public boolean accepts(ConfigurationGenerator cg) {\n+        if (!\"true\".equals(cg.getUserConfig().getProperty(KAFKA_ENABLED_OPT))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c302822fbebc5587839f7e3a764920d319f3b57"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3ODY1OTkzOnYy", "diffSide": "RIGHT", "path": "modules/runtime/nuxeo-runtime-stream/src/main/java/org/nuxeo/runtime/kafka/KafkaChecker.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMzoyNDozMlrOHGX5uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMzoyNDozMlrOHGX5uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ0NTExNQ==", "bodyText": "Maybe align with Elasticsearch?\nFailed to load KafkaConfigDescriptor from \" + configFile.getAbsolutePath()", "url": "https://github.com/nuxeo/nuxeo/pull/4269#discussion_r476445115", "createdAt": "2020-08-25T13:24:32Z", "author": {"login": "ataillefer"}, "path": "modules/runtime/nuxeo-runtime-stream/src/main/java/org/nuxeo/runtime/kafka/KafkaChecker.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     bdelbosc\n+ */\n+package org.nuxeo.runtime.kafka;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.common.xmap.XMap;\n+import org.nuxeo.launcher.config.ConfigurationException;\n+import org.nuxeo.launcher.config.ConfigurationGenerator;\n+import org.nuxeo.launcher.config.backingservices.BackingChecker;\n+import org.nuxeo.lib.stream.log.Name;\n+import org.nuxeo.lib.stream.log.kafka.KafkaLogManager;\n+\n+/**\n+ * @since 11.3\n+ */\n+public class KafkaChecker implements BackingChecker {\n+    private static final Logger log = LogManager.getLogger(KafkaChecker.class);\n+\n+    private static final String KAFKA_ENABLED_OPT = \"kafka.enabled\";\n+\n+    private static final String CONFIG_NAME = \"kafka-config.xml\";\n+\n+    @Override\n+    public boolean accepts(ConfigurationGenerator cg) {\n+        if (!\"true\".equals(cg.getUserConfig().getProperty(KAFKA_ENABLED_OPT))) {\n+            log.debug(\"Checker skipped because Kafka is disabled\");\n+            return false;\n+        }\n+        return true;\n+    }\n+\n+    @Override\n+    public void check(ConfigurationGenerator cg) throws ConfigurationException {\n+        KafkaConfigDescriptor config = getConfig(cg);\n+        try (KafkaLogManager manager = new KafkaLogManager(config.topicPrefix, config.producerProperties.properties,\n+                config.consumerProperties.properties)) {\n+            manager.exists(Name.ofUrn(\"input/null\"));\n+        } catch (Exception e) {\n+            throw new ConfigurationException(\"Unable to reach Kafka using: \" + config.producerProperties.properties, e);\n+        }\n+    }\n+\n+    protected KafkaConfigDescriptor getConfig(ConfigurationGenerator cg) throws ConfigurationException {\n+        File configFile = new File(cg.getConfigDir(), CONFIG_NAME);\n+        if (!configFile.exists()) {\n+            throw new ConfigurationException(\"Cannot find Kafka configuration: \" + CONFIG_NAME);\n+        }\n+        XMap xmap = new XMap();\n+        xmap.register(KafkaConfigDescriptor.class);\n+        try (InputStream inStream = new FileInputStream(configFile)) {\n+            Object[] nodes = xmap.loadAll(inStream);\n+            for (Object node : nodes) {\n+                if (node != null) {\n+                    return (KafkaConfigDescriptor) node;\n+                }\n+            }\n+            throw new ConfigurationException(\"No KafkaConfigDescriptor found in \" + configFile.getAbsolutePath());\n+        } catch (IOException e) {\n+            throw new ConfigurationException(\"Unable to load the configuration for KafkaConfigDescriptor\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c302822fbebc5587839f7e3a764920d319f3b57"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3ODY2NjI2OnYy", "diffSide": "RIGHT", "path": "modules/runtime/nuxeo-launcher-commons/src/main/java/org/nuxeo/launcher/config/BackingServiceConfigurator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMzoyNTo1OVrOHGX9lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMzoyNTo1OVrOHGX9lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ0NjEwMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    log.debug(\"Adding checker {} with class path: {}\", () -> item,\n          \n          \n            \n                                    log.debug(\"Adding checker: {} with class path: {}\", () -> item,", "url": "https://github.com/nuxeo/nuxeo/pull/4269#discussion_r476446103", "createdAt": "2020-08-25T13:25:59Z", "author": {"login": "ataillefer"}, "path": "modules/runtime/nuxeo-launcher-commons/src/main/java/org/nuxeo/launcher/config/BackingServiceConfigurator.java", "diffHunk": "@@ -138,22 +138,20 @@ protected RetryPolicy buildRetryPolicy() {\n             items.add(\"kafka\");\n             for (String item : items) {\n                 try {\n-                    log.debug(\"checker: \" + item);\n+                    log.debug(\"checker: {}\", item);\n                     File templateDir = getTemplateDir(item);\n                     String classPath = getClasspathForTemplate(item);\n                     String checkClass = configurationGenerator.getUserConfig()\n                                                               .getProperty(item + PARAM_CHECK_SUFFIX);\n                     Optional<URLClassLoader> ucl = getClassLoaderForTemplate(templateDir, classPath);\n                     if (ucl.isPresent()) {\n                         Class<?> klass = Class.forName(checkClass, true, ucl.get());\n-                        if (log.isDebugEnabled()) {\n-                            log.debug(\"Adding checker \" + item + \" with class path: \"\n-                                    + Arrays.toString(ucl.get().getURLs()));\n-                        }\n+                        log.debug(\"Adding checker {} with class path: {}\", () -> item,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec4231c4b830f1ff78077285f4e5ed7bea637d23"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3ODY5MDUxOnYy", "diffSide": "RIGHT", "path": "modules/runtime/nuxeo-launcher-commons/src/main/java/org/nuxeo/launcher/config/BackingServiceConfigurator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMzozMToyNVrOHGYMtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMzozMToyNVrOHGYMtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ0OTk3NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                log.debug(\"adding url: {}\", file.getPath());\n          \n          \n            \n                                log.debug(\"Adding url: {}\", file.getPath());", "url": "https://github.com/nuxeo/nuxeo/pull/4269#discussion_r476449974", "createdAt": "2020-08-25T13:31:25Z", "author": {"login": "ataillefer"}, "path": "modules/runtime/nuxeo-launcher-commons/src/main/java/org/nuxeo/launcher/config/BackingServiceConfigurator.java", "diffHunk": "@@ -209,7 +207,7 @@ String getClasspathForTemplate(String template) {\n             for (File file : files) {\n                 try {\n                     urlsList.add(new URL(\"jar:file:\" + file.getPath() + \"!/\"));\n-                    log.debug(\"Added \" + file.getPath());\n+                    log.debug(\"adding url: {}\", file.getPath());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec4231c4b830f1ff78077285f4e5ed7bea637d23"}, "originalPosition": 52}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4349, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}