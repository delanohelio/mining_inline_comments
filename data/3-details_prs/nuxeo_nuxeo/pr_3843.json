{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwMzMyMzA1", "number": 3843, "title": "NXP-28600: add WriteColdStorage permission", "bodyText": "\ud83d\udd35 T&P: https://qa.nuxeo.org/jenkins/view/TestAndPush/job/TestAndPush/job/ondemand-testandpush-ncunha/39/", "createdAt": "2020-03-18T09:52:18Z", "url": "https://github.com/nuxeo/nuxeo/pull/3843", "merged": true, "mergeCommit": {"oid": "69f3d6552b318e9734ad199a908df882b6af8890"}, "closed": true, "closedAt": "2020-03-24T09:54:51Z", "author": {"login": "nmpcunha"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcO4rd5gBqjMxNDE4NjI3Njk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQizUnAFqTM3OTcxNzk3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c4130785afbeb8366cebb3e4756fee26af1466d8", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/c4130785afbeb8366cebb3e4756fee26af1466d8", "committedDate": "2020-03-17T18:25:09Z", "message": "NXP-28600: add WriteColdStorage permission"}, "afterCommit": {"oid": "c2b075a5344fe335d6c315aa2efe39831151bd5d", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/c2b075a5344fe335d6c315aa2efe39831151bd5d", "committedDate": "2020-03-18T15:02:53Z", "message": "NXP-28600: add WriteColdStorage permission"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MDU2NDE3", "url": "https://github.com/nuxeo/nuxeo/pull/3843#pullrequestreview-377056417", "createdAt": "2020-03-18T16:54:21Z", "commit": {"oid": "c2b075a5344fe335d6c315aa2efe39831151bd5d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxNjo1NDoyMlrOF4OOEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxNjo1OTo1N1rOF4Oc6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ5NzU1Mg==", "bodyText": "You don't need to check session.getPrincipal().isAdministrator(), as hasPermission already takes administrators into account.", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394497552", "createdAt": "2020-03-18T16:54:22Z", "author": {"login": "efge"}, "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/blob/ColdStorageHelper.java", "diffHunk": "@@ -71,24 +73,27 @@\n \n     /**\n      * Moves the main content associated with the document of the given {@link DocumentRef} to a cold storage.\n+     * The permission {@value org.nuxeo.ecm.core.api.security.SecurityConstants#WRITE_COLD_STORAGE} is required.\n      *\n      * @return the updated document model if the move succeeds\n      * @throws NuxeoException if the main content is already in the cold storage, or if there is no main content\n      *             associated with the given document\n      */\n     public static DocumentModel moveContentToColdStorage(CoreSession session, DocumentRef documentRef) {\n         DocumentModel documentModel = session.getDocument(documentRef);\n+        Serializable mainContent = documentModel.getPropertyValue(FILE_CONTENT_PROPERTY);\n         log.debug(\"Move to cold storage the main content of document: {}\", documentModel);\n \n-        if (documentModel.hasFacet(FacetNames.COLD_STORAGE)\n+        if (!session.getPrincipal().isAdministrator()\n+                && !session.hasPermission(documentRef, SecurityConstants.WRITE_COLD_STORAGE)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2b075a5344fe335d6c315aa2efe39831151bd5d"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ5OTIwNg==", "bodyText": "Please remove the two else that you added, error checks are \"early exit\" cases and can be standalone.\nIt will also make the diff simpler.", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394499206", "createdAt": "2020-03-18T16:56:50Z", "author": {"login": "efge"}, "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/blob/ColdStorageHelper.java", "diffHunk": "@@ -71,24 +73,27 @@\n \n     /**\n      * Moves the main content associated with the document of the given {@link DocumentRef} to a cold storage.\n+     * The permission {@value org.nuxeo.ecm.core.api.security.SecurityConstants#WRITE_COLD_STORAGE} is required.\n      *\n      * @return the updated document model if the move succeeds\n      * @throws NuxeoException if the main content is already in the cold storage, or if there is no main content\n      *             associated with the given document\n      */\n     public static DocumentModel moveContentToColdStorage(CoreSession session, DocumentRef documentRef) {\n         DocumentModel documentModel = session.getDocument(documentRef);\n+        Serializable mainContent = documentModel.getPropertyValue(FILE_CONTENT_PROPERTY);\n         log.debug(\"Move to cold storage the main content of document: {}\", documentModel);\n \n-        if (documentModel.hasFacet(FacetNames.COLD_STORAGE)\n+        if (!session.getPrincipal().isAdministrator()\n+                && !session.hasPermission(documentRef, SecurityConstants.WRITE_COLD_STORAGE)) {\n+            throw new NuxeoException(String.format(\"The document cannot be moved to cold storage\", documentRef),\n+                    SC_FORBIDDEN);\n+        } else if (documentModel.hasFacet(FacetNames.COLD_STORAGE)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2b075a5344fe335d6c315aa2efe39831151bd5d"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUwMDQ3MQ==", "bodyText": "Remove the catch/fail, just let the test method throw the exception if there's a problem.", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394500471", "createdAt": "2020-03-18T16:58:41Z", "author": {"login": "efge"}, "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java", "diffHunk": "@@ -109,6 +119,50 @@ public void shouldMoveToColdStorage() throws IOException {\n         assertEquals(\"dummy\", ((ManagedBlob) content).getProviderId());\n     }\n \n+    @Test\n+    public void shouldMoveToColdStorageWhenUserHaveWriteColdStoragePermission() throws IOException {\n+        DocumentModel documentModel = createFileDocument(DEFAULT_DOC_NAME, true);\n+        ACP acp = documentModel.getACP();\n+        ACL acl = acp.getOrCreateACL();\n+        acl.add(new ACE(\"john\", SecurityConstants.READ, true));\n+        acl.add(new ACE(\"john\", SecurityConstants.WRITE, true));\n+        acl.add(new ACE(\"john\", SecurityConstants.WRITE_COLD_STORAGE, true));\n+        documentModel.setACP(acp, true);\n+\n+        try (CloseableCoreSession userSession = coreFeature.openCoreSession(\"john\")) {\n+            documentModel = ColdStorageHelper.moveContentToColdStorage(userSession, documentModel.getRef());\n+            userSession.saveDocument(documentModel);\n+            transactionalFeature.nextTransaction();\n+            documentModel.refresh();\n+\n+            assertTrue(documentModel.hasFacet(FacetNames.COLD_STORAGE));\n+            assertNull(documentModel.getPropertyValue(ColdStorageHelper.FILE_CONTENT_PROPERTY));\n+\n+            // check if the `coldstorage:coldContent` property contains the original file content\n+            Blob content = (Blob) documentModel.getPropertyValue(ColdStorageHelper.COLD_STORAGE_CONTENT_PROPERTY);\n+            assertNotNull(content);\n+            assertEquals(FILE_CONTENT, content.getString());\n+        } catch (NuxeoException e) {\n+            fail(\"It was not expected a failure while moving document to cold storage since user has the required permissions\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2b075a5344fe335d6c315aa2efe39831151bd5d"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUwMTM1Mg==", "bodyText": "Remove the catch/fail, just let the test method throw the exception if there's a problem.", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394501352", "createdAt": "2020-03-18T16:59:57Z", "author": {"login": "efge"}, "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/coldstorage/MoveToColdStorageTest.java", "diffHunk": "@@ -42,8 +50,44 @@\n     @Inject\n     protected CoreSession session;\n \n+    @Inject\n+    protected CoreFeature coreFeature;\n+\n+    @Test\n+    public void shouldFailWhenUserDoNotHaveWriteColdStoragePermission() throws OperationException, IOException {\n+        DocumentModel documentModel = createFileDocument(session, true);\n+        ACP acp = documentModel.getACP();\n+        ACL acl = acp.getOrCreateACL();\n+        acl.add(new ACE(\"john\", SecurityConstants.READ, true));\n+        documentModel.setACP(acp, true);\n+\n+        try (CloseableCoreSession userSession = coreFeature.openCoreSession(\"john\")) {\n+            moveContentToColdStorage(userSession, documentModel);\n+            fail(\"Should fail because the user does not have permissions to move document to cold storage\");\n+        } catch (NuxeoException e) {\n+            assertEquals(SC_FORBIDDEN, e.getStatusCode());\n+        }\n+    }\n+\n+    @Test\n+    public void shouldSucceedWhenUserHaveWriteColdStoragePermission() throws OperationException, IOException {\n+        DocumentModel documentModel = createFileDocument(session, true);\n+        ACP acp = documentModel.getACP();\n+        ACL acl = acp.getOrCreateACL();\n+        acl.add(new ACE(\"john\", SecurityConstants.READ, true));\n+        acl.add(new ACE(\"john\", SecurityConstants.WRITE, true));\n+        acl.add(new ACE(\"john\", SecurityConstants.WRITE_COLD_STORAGE, true));\n+        documentModel.setACP(acp, true);\n+\n+        try (CloseableCoreSession userSession = coreFeature.openCoreSession(\"john\")) {\n+            moveContentToColdStorage(userSession, documentModel);\n+        } catch (NuxeoException e) {\n+            fail(\"It was not expected an exception while moving document to cold storage since user has the required permissions\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2b075a5344fe335d6c315aa2efe39831151bd5d"}, "originalPosition": 66}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c2b075a5344fe335d6c315aa2efe39831151bd5d", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/c2b075a5344fe335d6c315aa2efe39831151bd5d", "committedDate": "2020-03-18T15:02:53Z", "message": "NXP-28600: add WriteColdStorage permission"}, "afterCommit": {"oid": "bb089880cf30fcf747dff0a2694c2ac559ee3b0f", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/bb089880cf30fcf747dff0a2694c2ac559ee3b0f", "committedDate": "2020-03-18T18:17:53Z", "message": "NXP-28600: add WriteColdStorage permission"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3NTI2ODM1", "url": "https://github.com/nuxeo/nuxeo/pull/3843#pullrequestreview-377526835", "createdAt": "2020-03-19T08:57:11Z", "commit": {"oid": "bb089880cf30fcf747dff0a2694c2ac559ee3b0f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwODo1NzoxMVrOF4lNYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwODo1NzoxMVrOF4lNYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg3NDIxMA==", "bodyText": "Permission needed to move/transfer documents to cold storage. -> can you please rename to include the fact that we transfer the main content of the document instead of move/transfer documents to cold storage. -> the idea is to be consistent with what we did:\nfor example javadoc of the move method on the helper:\nMoves the main content associated with the document of the given {@link DocumentRef} to a cold storage...", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394874210", "createdAt": "2020-03-19T08:57:11Z", "author": {"login": "RSalem07"}, "path": "nuxeo-core/nuxeo-core-api/src/main/java/org/nuxeo/ecm/core/api/security/SecurityConstants.java", "diffHunk": "@@ -132,4 +132,10 @@\n      */\n     String MANAGE_LEGAL_HOLD = \"ManageLegalHold\";\n \n+    /**\n+     * Permission needed to move/transfer documents to cold storage.\n+     *", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb089880cf30fcf747dff0a2694c2ac559ee3b0f"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3NTMwODEy", "url": "https://github.com/nuxeo/nuxeo/pull/3843#pullrequestreview-377530812", "createdAt": "2020-03-19T09:02:47Z", "commit": {"oid": "bb089880cf30fcf747dff0a2694c2ac559ee3b0f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwOTowMjo0N1rOF4lZjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwOTowMjo0N1rOF4lZjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg3NzMyNA==", "bodyText": "can you remove this injection and replace the open of the core session with:\n try (CloseableCoreSession jamesSession = CoreInstance.openCoreSession(doc.getRepositoryName(), \"john\")) { .... }\ncomplete example here", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394877324", "createdAt": "2020-03-19T09:02:47Z", "author": {"login": "RSalem07"}, "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java", "diffHunk": "@@ -88,8 +95,11 @@\n     @Inject\n     protected DownloadService downloadService;\n \n+    @Inject\n+    protected CoreFeature coreFeature;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb089880cf30fcf747dff0a2694c2ac559ee3b0f"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3NTM1MDA5", "url": "https://github.com/nuxeo/nuxeo/pull/3843#pullrequestreview-377535009", "createdAt": "2020-03-19T09:09:07Z", "commit": {"oid": "bb089880cf30fcf747dff0a2694c2ac559ee3b0f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwOTowOTowN1rOF4lmPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwOTowOTowN1rOF4lmPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg4MDU3NA==", "bodyText": "I am wondering if we can keep the methods names shorter as possible ->\nshouldFailWithoutRightPermissions we don't need to explicitly put the permission in the name of the method, which will avoid renaming the method if the permission changes its names in the future", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394880574", "createdAt": "2020-03-19T09:09:07Z", "author": {"login": "RSalem07"}, "path": "nuxeo-features/nuxeo-automation/nuxeo-automation-features/src/test/java/org/nuxeo/ecm/automation/core/operations/coldstorage/MoveToColdStorageTest.java", "diffHunk": "@@ -42,8 +50,42 @@\n     @Inject\n     protected CoreSession session;\n \n+    @Inject\n+    protected CoreFeature coreFeature;\n+\n+    @Test\n+    public void shouldFailWhenUserDoNotHaveWriteColdStoragePermission() throws OperationException, IOException {\n+        DocumentModel documentModel = createFileDocument(session, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb089880cf30fcf747dff0a2694c2ac559ee3b0f"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3NTM4NzIx", "url": "https://github.com/nuxeo/nuxeo/pull/3843#pullrequestreview-377538721", "createdAt": "2020-03-19T09:14:05Z", "commit": {"oid": "bb089880cf30fcf747dff0a2694c2ac559ee3b0f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwOToxNDowNVrOF4lxUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwOToxNDowNVrOF4lxUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg4MzQxMQ==", "bodyText": "I think we can group the tests within the permissions to:\n\nkeep the name shorted\ngroup the tests related to same things on the same tests\n\nas we have a helper method, i think we can use a name:\nshouldMoveToColdStorage which can test with an Admin and after that with a regular user that has the right permission", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394883411", "createdAt": "2020-03-19T09:14:05Z", "author": {"login": "RSalem07"}, "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java", "diffHunk": "@@ -109,6 +119,48 @@ public void shouldMoveToColdStorage() throws IOException {\n         assertEquals(\"dummy\", ((ManagedBlob) content).getProviderId());\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb089880cf30fcf747dff0a2694c2ac559ee3b0f"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3NTQxMzMy", "url": "https://github.com/nuxeo/nuxeo/pull/3843#pullrequestreview-377541332", "createdAt": "2020-03-19T09:17:41Z", "commit": {"oid": "bb089880cf30fcf747dff0a2694c2ac559ee3b0f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwOToxNzo0MVrOF4l5NQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwOToxNzo0MVrOF4l5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg4NTQyOQ==", "bodyText": "I am wondering if we can reduce this part of code and if we do wan reduce code on others parts. For example i was thinking if we can transform the createFileDocument to:\n    protected DocumentModel createFileDocument(CoreSession session, boolean withBlobContent, ACE... aces) {\n        DocumentModel documentModel = session.createDocumentModel(\"/\", \"MyFile\", \"File\");\n        if (withBlobContent) {\n            documentModel.setPropertyValue(ColdStorageHelper.FILE_CONTENT_PROPERTY,\n                    (Serializable) Blobs.createBlob(FILE_CONTENT));\n        }\n        DocumentModel document = session.createDocument(documentModel);\n        if(aces.length > 0) {\n            ACP acp = documentModel.getACP();\n            ACL acl = acp.getOrCreateACL();\n            acl.addAll(List.of(aces));\n            document.setACP(acp, true);\n        }\n        return document;\n    }\n\nand the callers can be:\nDocumentModel documentModel = createFileDocument(session, true, new ACE(\"john\", SecurityConstants.READ, true));\nor\n ACE[] aces = { new ACE(\"john\", SecurityConstants.READ, true), //\n                new ACE(\"john\", SecurityConstants.WRITE, true), //\n                new ACE(\"john\", SecurityConstants.WRITE_COLD_STORAGE, true) };\n\n        DocumentModel documentModel = createFileDocument(session, true, aces);", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394885429", "createdAt": "2020-03-19T09:17:41Z", "author": {"login": "RSalem07"}, "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java", "diffHunk": "@@ -109,6 +119,48 @@ public void shouldMoveToColdStorage() throws IOException {\n         assertEquals(\"dummy\", ((ManagedBlob) content).getProviderId());\n     }\n \n+    @Test\n+    public void shouldMoveToColdStorageWhenUserHaveWriteColdStoragePermission() throws IOException {\n+        DocumentModel documentModel = createFileDocument(DEFAULT_DOC_NAME, true);\n+        ACP acp = documentModel.getACP();\n+        ACL acl = acp.getOrCreateACL();\n+        acl.add(new ACE(\"john\", SecurityConstants.READ, true));\n+        acl.add(new ACE(\"john\", SecurityConstants.WRITE, true));\n+        acl.add(new ACE(\"john\", SecurityConstants.WRITE_COLD_STORAGE, true));\n+        documentModel.setACP(acp, true);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb089880cf30fcf747dff0a2694c2ac559ee3b0f"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3NTQzNDMz", "url": "https://github.com/nuxeo/nuxeo/pull/3843#pullrequestreview-377543433", "createdAt": "2020-03-19T09:20:40Z", "commit": {"oid": "bb089880cf30fcf747dff0a2694c2ac559ee3b0f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwOToyMDo0MFrOF4l_6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwOToyMDo0MFrOF4l_6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg4NzE0Ng==", "bodyText": "can you add <p/> before the new line The permission {@value org.nuxeo.ecm.core.api.security.SecurityConstants#WRITE_COLD_STORAGE} is required. and can you complete the @throws NuxeoException", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r394887146", "createdAt": "2020-03-19T09:20:40Z", "author": {"login": "RSalem07"}, "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/blob/ColdStorageHelper.java", "diffHunk": "@@ -71,6 +73,7 @@\n \n     /**\n      * Moves the main content associated with the document of the given {@link DocumentRef} to a cold storage.\n+     * The permission {@value org.nuxeo.ecm.core.api.security.SecurityConstants#WRITE_COLD_STORAGE} is required.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb089880cf30fcf747dff0a2694c2ac559ee3b0f"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3NTUwMjYy", "url": "https://github.com/nuxeo/nuxeo/pull/3843#pullrequestreview-377550262", "createdAt": "2020-03-19T09:29:46Z", "commit": {"oid": "bb089880cf30fcf747dff0a2694c2ac559ee3b0f"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bb089880cf30fcf747dff0a2694c2ac559ee3b0f", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/bb089880cf30fcf747dff0a2694c2ac559ee3b0f", "committedDate": "2020-03-18T18:17:53Z", "message": "NXP-28600: add WriteColdStorage permission"}, "afterCommit": {"oid": "677c80d586e261c8a53862b2e4f962ddd77e9e7e", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/677c80d586e261c8a53862b2e4f962ddd77e9e7e", "committedDate": "2020-03-19T12:03:16Z", "message": "NXP-28600: add WriteColdStorage permission"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "677c80d586e261c8a53862b2e4f962ddd77e9e7e", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/677c80d586e261c8a53862b2e4f962ddd77e9e7e", "committedDate": "2020-03-19T12:03:16Z", "message": "NXP-28600: add WriteColdStorage permission"}, "afterCommit": {"oid": "068a203b7bea069dbe8463aea5155380b3afb8b4", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/068a203b7bea069dbe8463aea5155380b3afb8b4", "committedDate": "2020-03-19T15:26:58Z", "message": "NXP-28600: add WriteColdStorage permission"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "068a203b7bea069dbe8463aea5155380b3afb8b4", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/068a203b7bea069dbe8463aea5155380b3afb8b4", "committedDate": "2020-03-19T15:26:58Z", "message": "NXP-28600: add WriteColdStorage permission"}, "afterCommit": {"oid": "3cf90f513ca97993390b63a59f5ae10ecd4219ef", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/3cf90f513ca97993390b63a59f5ae10ecd4219ef", "committedDate": "2020-03-20T12:40:23Z", "message": "NXP-28600: add WriteColdStorage permission"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NjU3Nzk2", "url": "https://github.com/nuxeo/nuxeo/pull/3843#pullrequestreview-378657796", "createdAt": "2020-03-20T16:59:22Z", "commit": {"oid": "3cf90f513ca97993390b63a59f5ae10ecd4219ef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNjo1OToyMlrOF5b8Gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNjo1OToyMlrOF5b8Gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc3MDkwNw==", "bodyText": "Can you please add the case where the current user doesn't have the required permission?", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r395770907", "createdAt": "2020-03-20T16:59:22Z", "author": {"login": "ataillefer"}, "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/blob/ColdStorageHelper.java", "diffHunk": "@@ -71,6 +73,8 @@\n \n     /**\n      * Moves the main content associated with the document of the given {@link DocumentRef} to a cold storage.\n+     * <p/>\n+     * The permission {@value org.nuxeo.ecm.core.api.security.SecurityConstants#WRITE_COLD_STORAGE} is required.\n      *\n      * @return the updated document model if the move succeeds\n      * @throws NuxeoException if the main content is already in the cold storage, or if there is no main content", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cf90f513ca97993390b63a59f5ae10ecd4219ef"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NjU5NjIw", "url": "https://github.com/nuxeo/nuxeo/pull/3843#pullrequestreview-378659620", "createdAt": "2020-03-20T17:01:48Z", "commit": {"oid": "3cf90f513ca97993390b63a59f5ae10ecd4219ef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNzowMTo0OFrOF5cBfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNzowMTo0OFrOF5cBfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc3MjI4NQ==", "bodyText": "You could be more precise on the message about the missing required permission.", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r395772285", "createdAt": "2020-03-20T17:01:48Z", "author": {"login": "ataillefer"}, "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/blob/ColdStorageHelper.java", "diffHunk": "@@ -80,6 +84,11 @@ public static DocumentModel moveContentToColdStorage(CoreSession session, Docume\n         DocumentModel documentModel = session.getDocument(documentRef);\n         log.debug(\"Move to cold storage the main content of document: {}\", documentModel);\n \n+        if (!session.hasPermission(documentRef, SecurityConstants.WRITE_COLD_STORAGE)) {\n+            throw new NuxeoException(String.format(\"The document: %s cannot be moved to cold storage\", documentRef),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cf90f513ca97993390b63a59f5ae10ecd4219ef"}, "originalPosition": 30}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3cf90f513ca97993390b63a59f5ae10ecd4219ef", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/3cf90f513ca97993390b63a59f5ae10ecd4219ef", "committedDate": "2020-03-20T12:40:23Z", "message": "NXP-28600: add WriteColdStorage permission"}, "afterCommit": {"oid": "446f62022fda0083108506c40a74971045611e0d", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/446f62022fda0083108506c40a74971045611e0d", "committedDate": "2020-03-23T09:57:03Z", "message": "NXP-28600: add WriteColdStorage permission"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5Mjg2MTA4", "url": "https://github.com/nuxeo/nuxeo/pull/3843#pullrequestreview-379286108", "createdAt": "2020-03-23T10:09:16Z", "commit": {"oid": "446f62022fda0083108506c40a74971045611e0d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxMDowOToxNlrOF5-g1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxMDowOToxNlrOF5-g1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjMzNzM2NA==", "bodyText": "If I'm not mistaken, this second case is for the Administrator user, so:\n\nit doesn't need aces when creating the document\nit deserves a comment above like \"// with administrator user\"", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r396337364", "createdAt": "2020-03-23T10:09:16Z", "author": {"login": "ataillefer"}, "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java", "diffHunk": "@@ -90,23 +97,34 @@\n \n     @Test\n     public void shouldMoveToColdStorage() throws IOException {\n-        DocumentModel documentModel = createFileDocument(DEFAULT_DOC_NAME, true);\n+        // with regular user with \"WriteColdStorage\" permission\n+        ACE[] aces = { new ACE(\"john\", SecurityConstants.READ, true), //\n+                new ACE(\"john\", SecurityConstants.WRITE, true), //\n+                new ACE(\"john\", SecurityConstants.WRITE_COLD_STORAGE, true) };\n+        DocumentModel documentModel = createFileDocument(DEFAULT_DOC_NAME, true, aces);\n+\n+        try (CloseableCoreSession userSession = CoreInstance.openCoreSession(documentModel.getRepositoryName(),\n+                \"john\")) {\n+            moveAndVerifyContent(userSession, documentModel);\n+        }\n \n+        documentModel = createFileDocument(DEFAULT_DOC_NAME, true, aces);\n         // move the blob to cold storage\n-        documentModel = ColdStorageHelper.moveContentToColdStorage(session, documentModel.getRef());\n-        session.saveDocument(documentModel);\n-        transactionalFeature.nextTransaction();\n-        documentModel.refresh();\n-\n-        assertTrue(documentModel.hasFacet(FacetNames.COLD_STORAGE));\n-\n-        assertNull(documentModel.getPropertyValue(ColdStorageHelper.FILE_CONTENT_PROPERTY));\n+        moveAndVerifyContent(session, documentModel);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "446f62022fda0083108506c40a74971045611e0d"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5Mjg5Mjky", "url": "https://github.com/nuxeo/nuxeo/pull/3843#pullrequestreview-379289292", "createdAt": "2020-03-23T10:13:37Z", "commit": {"oid": "446f62022fda0083108506c40a74971045611e0d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxMDoxMzozOFrOF5-rEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxMDoxMzozOFrOF5-rEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjMzOTk4Nw==", "bodyText": "For consistency, since you've renamed the test in MoveToColdStorageTest#shouldFailWithoutRightPermissions, don't you want to have the same name here?", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r396339987", "createdAt": "2020-03-23T10:13:38Z", "author": {"login": "ataillefer"}, "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestColdStorage.java", "diffHunk": "@@ -90,23 +97,34 @@\n \n     @Test\n     public void shouldMoveToColdStorage() throws IOException {\n-        DocumentModel documentModel = createFileDocument(DEFAULT_DOC_NAME, true);\n+        // with regular user with \"WriteColdStorage\" permission\n+        ACE[] aces = { new ACE(\"john\", SecurityConstants.READ, true), //\n+                new ACE(\"john\", SecurityConstants.WRITE, true), //\n+                new ACE(\"john\", SecurityConstants.WRITE_COLD_STORAGE, true) };\n+        DocumentModel documentModel = createFileDocument(DEFAULT_DOC_NAME, true, aces);\n+\n+        try (CloseableCoreSession userSession = CoreInstance.openCoreSession(documentModel.getRepositoryName(),\n+                \"john\")) {\n+            moveAndVerifyContent(userSession, documentModel);\n+        }\n \n+        documentModel = createFileDocument(DEFAULT_DOC_NAME, true, aces);\n         // move the blob to cold storage\n-        documentModel = ColdStorageHelper.moveContentToColdStorage(session, documentModel.getRef());\n-        session.saveDocument(documentModel);\n-        transactionalFeature.nextTransaction();\n-        documentModel.refresh();\n-\n-        assertTrue(documentModel.hasFacet(FacetNames.COLD_STORAGE));\n-\n-        assertNull(documentModel.getPropertyValue(ColdStorageHelper.FILE_CONTENT_PROPERTY));\n+        moveAndVerifyContent(session, documentModel);\n+    }\n \n-        // check if the `coldstorage:coldContent` property contains the original file content\n-        Blob content = (Blob) documentModel.getPropertyValue(ColdStorageHelper.COLD_STORAGE_CONTENT_PROPERTY);\n-        assertNotNull(content);\n-        assertEquals(FILE_CONTENT, content.getString());\n-        assertEquals(\"dummy\", ((ManagedBlob) content).getProviderId());\n+    @Test\n+    public void shouldFailWhenUserDoNotHaveWriteColdStoragePermission() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "446f62022fda0083108506c40a74971045611e0d"}, "originalPosition": 60}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "446f62022fda0083108506c40a74971045611e0d", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/446f62022fda0083108506c40a74971045611e0d", "committedDate": "2020-03-23T09:57:03Z", "message": "NXP-28600: add WriteColdStorage permission"}, "afterCommit": {"oid": "78a55f2746843bbc4aec8dda9922aac82911a3d8", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/78a55f2746843bbc4aec8dda9922aac82911a3d8", "committedDate": "2020-03-23T10:16:32Z", "message": "NXP-28600: add WriteColdStorage permission"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5MzAzNDAy", "url": "https://github.com/nuxeo/nuxeo/pull/3843#pullrequestreview-379303402", "createdAt": "2020-03-23T10:32:22Z", "commit": {"oid": "78a55f2746843bbc4aec8dda9922aac82911a3d8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxMDozMjoyMlrOF5_Wbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxMDozMjoyMlrOF5_Wbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM1MTA4Ng==", "bodyText": "Can you please use a lambda here to avoid systematically fetching the principal?\nsession::getPrincipal, () -> documentModel", "url": "https://github.com/nuxeo/nuxeo/pull/3843#discussion_r396351086", "createdAt": "2020-03-23T10:32:22Z", "author": {"login": "ataillefer"}, "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/blob/ColdStorageHelper.java", "diffHunk": "@@ -80,6 +84,13 @@ public static DocumentModel moveContentToColdStorage(CoreSession session, Docume\n         DocumentModel documentModel = session.getDocument(documentRef);\n         log.debug(\"Move to cold storage the main content of document: {}\", documentModel);\n \n+        if (!session.hasPermission(documentRef, SecurityConstants.WRITE_COLD_STORAGE)) {\n+            log.debug(\"The user {} does not have the right permissions to move the content of document {}\",\n+                    session.getPrincipal(), documentModel);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78a55f2746843bbc4aec8dda9922aac82911a3d8"}, "originalPosition": 31}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "78a55f2746843bbc4aec8dda9922aac82911a3d8", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/78a55f2746843bbc4aec8dda9922aac82911a3d8", "committedDate": "2020-03-23T10:16:32Z", "message": "NXP-28600: add WriteColdStorage permission"}, "afterCommit": {"oid": "fe22d2be00ee85d862f5de0b9e1f785f47d9eede", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/fe22d2be00ee85d862f5de0b9e1f785f47d9eede", "committedDate": "2020-03-23T12:00:04Z", "message": "NXP-28600: add WriteColdStorage permission"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "483ae9cebf109fed6b5b0e21535467d4bd4bec87", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/483ae9cebf109fed6b5b0e21535467d4bd4bec87", "committedDate": "2020-03-23T12:01:48Z", "message": "NXP-28600: add WriteColdStorage permission"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c0a6f5ce9aa2eb3477797b068c920af9711c396f", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/c0a6f5ce9aa2eb3477797b068c920af9711c396f", "committedDate": "2020-03-23T12:01:08Z", "message": "fix"}, "afterCommit": {"oid": "483ae9cebf109fed6b5b0e21535467d4bd4bec87", "author": {"user": null}, "url": "https://github.com/nuxeo/nuxeo/commit/483ae9cebf109fed6b5b0e21535467d4bd4bec87", "committedDate": "2020-03-23T12:01:48Z", "message": "NXP-28600: add WriteColdStorage permission"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5Mzk4MjY5", "url": "https://github.com/nuxeo/nuxeo/pull/3843#pullrequestreview-379398269", "createdAt": "2020-03-23T12:52:18Z", "commit": {"oid": "483ae9cebf109fed6b5b0e21535467d4bd4bec87"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NDI0Nzk2", "url": "https://github.com/nuxeo/nuxeo/pull/3843#pullrequestreview-379424796", "createdAt": "2020-03-23T13:26:12Z", "commit": {"oid": "483ae9cebf109fed6b5b0e21535467d4bd4bec87"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NzE3OTc5", "url": "https://github.com/nuxeo/nuxeo/pull/3843#pullrequestreview-379717979", "createdAt": "2020-03-23T18:41:43Z", "commit": {"oid": "483ae9cebf109fed6b5b0e21535467d4bd4bec87"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4806, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}