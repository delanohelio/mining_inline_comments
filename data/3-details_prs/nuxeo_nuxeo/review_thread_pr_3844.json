{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwMzcyOTAy", "number": 3844, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxMDozNTo0M1rODp0aLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxMDo1Njo0MlrODp0xtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MTc2ODc5OnYy", "diffSide": "RIGHT", "path": "Jenkinsfile", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxMDozNTo0M1rOF5OnTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxMzoyNDo0MFrOF5Tgiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTU1MjU4OA==", "bodyText": "Then you also release when on reference branches ? The commit message talks about master", "url": "https://github.com/nuxeo/nuxeo/pull/3844#discussion_r395552588", "createdAt": "2020-03-20T10:35:43Z", "author": {"login": "NourNuxeo"}, "path": "Jenkinsfile", "diffHunk": "@@ -40,9 +41,45 @@ void setGitHubBuildStatus(String context, String message, String state) {\n   ])\n }\n \n+String getMavenArgs() {\n+  def args = '-B -nsu'\n+  if (!isPullRequest()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71e2141d6ececd9894af56e14502ebe06bbba5ed"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTYzMjc3OQ==", "bodyText": "Yes.", "url": "https://github.com/nuxeo/nuxeo/pull/3844#discussion_r395632779", "createdAt": "2020-03-20T13:24:40Z", "author": {"login": "troger"}, "path": "Jenkinsfile", "diffHunk": "@@ -40,9 +41,45 @@ void setGitHubBuildStatus(String context, String message, String state) {\n   ])\n }\n \n+String getMavenArgs() {\n+  def args = '-B -nsu'\n+  if (!isPullRequest()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTU1MjU4OA=="}, "originalCommit": {"oid": "71e2141d6ececd9894af56e14502ebe06bbba5ed"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MTc3Mjg3OnYy", "diffSide": "RIGHT", "path": "Jenkinsfile", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxMDozNzowOFrOF5Op8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxMDozNzowOFrOF5Op8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTU1MzI2Nw==", "bodyText": "could be one lined ?", "url": "https://github.com/nuxeo/nuxeo/pull/3844#discussion_r395553267", "createdAt": "2020-03-20T10:37:08Z", "author": {"login": "NourNuxeo"}, "path": "Jenkinsfile", "diffHunk": "@@ -40,9 +41,45 @@ void setGitHubBuildStatus(String context, String message, String state) {\n   ])\n }\n \n+String getMavenArgs() {\n+  def args = '-B -nsu'\n+  if (!isPullRequest()) {\n+    args += ' -Prelease'\n+  }\n+  return args\n+}\n+\n+def isPullRequest() {\n+  return BRANCH_NAME =~ /PR-.*/\n+}\n+\n String getVersion() {\n+  return isPullRequest() ? getPullRequestVersion() : getReleaseVersion()\n+}\n+\n+String getReleaseVersion() {\n   String nuxeoVersion = readMavenPom().getVersion()\n-  return BRANCH_NAME == 'master' ? nuxeoVersion : \"${BRANCH_NAME}-\" + nuxeoVersion\n+  String noSnapshot = nuxeoVersion.replace(\"-SNAPSHOT\", \"\")\n+  String version = noSnapshot + '.0' // first version ever\n+\n+  // find the latest tag if any\n+  sh \"git fetch origin 'refs/tags/v${noSnapshot}*:refs/tags/v${noSnapshot}*'\"\n+  def tag = sh(returnStdout: true, script: \"git tag --sort=committerdate --list 'v${noSnapshot}*' | tail -1 | tr -d '\\n'\")\n+  if (tag) {\n+    container('maven') {\n+      version = sh(returnStdout: true, script: \"semver bump patch ${tag} | tr -d '\\n'\")\n+    }\n+  }\n+  return version\n+}\n+\n+String getPullRequestVersion() {\n+  String nuxeoVersion = readMavenPom().getVersion()\n+  return \"${BRANCH_NAME}-\" + nuxeoVersion", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71e2141d6ececd9894af56e14502ebe06bbba5ed"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MTgyOTAyOnYy", "diffSide": "RIGHT", "path": "Jenkinsfile", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxMDo1Njo0MlrOF5PN0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxMzoyNDoyOFrOF5TgFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTU2MjQ1MA==", "bodyText": "There are new lines here and there that could be regrouped in a cleanup commit", "url": "https://github.com/nuxeo/nuxeo/pull/3844#discussion_r395562450", "createdAt": "2020-03-20T10:56:42Z", "author": {"login": "NourNuxeo"}, "path": "Jenkinsfile", "diffHunk": "@@ -268,10 +314,33 @@ pipeline {\n           sh \"\"\"\n             mvn ${MAVEN_ARGS} -Pdistrib,docker versions:set -DnewVersion=${VERSION} -DgenerateBackupPoms=false\n             perl -i -pe 's|<nuxeo.platform.version>.*?</nuxeo.platform.version>|<nuxeo.platform.version>${VERSION}</nuxeo.platform.version>|' pom.xml\n+            perl -i -pe 's|org.nuxeo.ecm.product.version=.*|org.nuxeo.ecm.product.version=${VERSION}|' nuxeo-distribution/nuxeo-nxr-server/src/main/resources/templates/nuxeo.defaults\n+          \"\"\"\n+        }\n+      }\n+    }\n+\n+    stage('Git commit') {\n+      when {\n+        not {\n+          branch 'PR-*'\n+        }\n+      }\n+      steps {\n+        container('maven') {\n+          echo \"\"\"\n+          ----------------------------------------\n+          Git commit\n+          ----------------------------------------\n+          \"\"\"\n+          sh \"\"\"\n+            git add .\n+            git commit -m \"Release ${VERSION}\"\n           \"\"\"\n         }\n       }\n     }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71e2141d6ececd9894af56e14502ebe06bbba5ed"}, "originalPosition": 141}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTYzMjY2MA==", "bodyText": "Looking at the ugly diff generated by git/github, I don't think putting new lines in a separate commit is required.", "url": "https://github.com/nuxeo/nuxeo/pull/3844#discussion_r395632660", "createdAt": "2020-03-20T13:24:28Z", "author": {"login": "troger"}, "path": "Jenkinsfile", "diffHunk": "@@ -268,10 +314,33 @@ pipeline {\n           sh \"\"\"\n             mvn ${MAVEN_ARGS} -Pdistrib,docker versions:set -DnewVersion=${VERSION} -DgenerateBackupPoms=false\n             perl -i -pe 's|<nuxeo.platform.version>.*?</nuxeo.platform.version>|<nuxeo.platform.version>${VERSION}</nuxeo.platform.version>|' pom.xml\n+            perl -i -pe 's|org.nuxeo.ecm.product.version=.*|org.nuxeo.ecm.product.version=${VERSION}|' nuxeo-distribution/nuxeo-nxr-server/src/main/resources/templates/nuxeo.defaults\n+          \"\"\"\n+        }\n+      }\n+    }\n+\n+    stage('Git commit') {\n+      when {\n+        not {\n+          branch 'PR-*'\n+        }\n+      }\n+      steps {\n+        container('maven') {\n+          echo \"\"\"\n+          ----------------------------------------\n+          Git commit\n+          ----------------------------------------\n+          \"\"\"\n+          sh \"\"\"\n+            git add .\n+            git commit -m \"Release ${VERSION}\"\n           \"\"\"\n         }\n       }\n     }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTU2MjQ1MA=="}, "originalCommit": {"oid": "71e2141d6ececd9894af56e14502ebe06bbba5ed"}, "originalPosition": 141}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4188, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}